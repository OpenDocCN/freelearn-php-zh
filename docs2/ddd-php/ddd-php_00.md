# 前言

在 2014 年，经过两年的阅读和工作领域驱动设计后，卡洛斯和克里斯蒂安，作为朋友和同事，前往柏林参加 Vaughn Vernon 的[实施领域驱动设计研讨会](https://idddworkshop.com)。培训非常棒，他们在旅行前头脑中盘旋的所有概念突然变得非常真实。然而，他们是房间里唯一两个 PHP 开发者，房间里满是 Java 和.NET 开发者。

大约在同一时间，[php[tek]](https://tek.phparch.com)，一年一度的 PHP 会议，开启了征稿活动，卡洛斯提交了一篇关于六边形架构的文章。他的演讲被拒绝了，但一个月后，来自[musketeers.me](http://musketeers.me)和[php[architect]](https://www.phparch.com)的 Eli White 联系了他，想知道他是否对为杂志 php[architect]撰写一篇关于六边形架构的文章感兴趣。因此，在 2014 年 6 月，*使用 PHP 的六边形架构*一文得以发表。这篇文章，你可以在附录中找到，是这本书的起源。

在 2014 年底，卡洛斯和克里斯蒂安讨论了扩展文章并分享他们在生产中应用领域驱动设计的所有知识和经验。他们对书籍背后的想法非常兴奋：帮助 PHP 社区从实用角度深入了解领域驱动设计。当时，像丰富领域模型和无框架应用程序这样的概念在 PHP 社区中并不常见。因此，在 2014 年 12 月，GitHub 书籍仓库的第一个提交被推送到。

大约在同一时间，在一个平行宇宙中，Keyvan 共同创立了 Funddy，这是一个基于领域驱动设计和构建块的大众众筹平台。领域驱动设计在探索过程和构建早期初创公司如 Funddy 的建模中证明了自己的有效性。它还帮助处理公司的复杂性，因为其环境和需求不断变化。在与卡洛斯和克里斯蒂安讨论书籍后，Keyvan 自豪地签约成为第三位作者。

我们共同编写了我们开始领域驱动设计时想要的书籍。书中充满了例子、现成的代码、捷径，以及基于我们各自团队的经验，对哪些有效和哪些无效的建议。我们通过其构建块——战术模式——到达了领域驱动设计，这就是为什么这本书主要关于它们。阅读它将帮助你学习它们，编写它们，并实施它们。你还将发现如何使用同步和异步方法集成边界上下文，这将打开你的战略设计世界——尽管后者是你必须自己探索的道路。

这本书深受 Vaughn Vernon（又名*红皮书*）所著的[《实现领域驱动设计》（http://www.amazon.com/Implementing-Domain-Driven-Design-Vaughn-Vernon/dp/0321834577）]和 Eric Evans（又名*蓝皮书*）所著的[《领域驱动设计：软件核心的复杂性处理》（http://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215）]的启发。你应该购买这两本书。你应该仔细阅读它们。你应该喜欢它们。

# 谁应该阅读这本书

如果你是一名 PHP 开发者、架构师或技术领导，我们强烈推荐这本书。它将帮助你成为一名更好的专业人士。它将为你正在开发的应用程序提供一个全新的视角和方法。如果你是初级角色，了解值对象、实体、仓储和领域事件对于未来面对的任何领域建模都很重要。对于普通角色，理解六边形架构的好处以及框架和应用程序之间的边界对于编写在现实世界中更容易维护的代码至关重要（框架迁移、测试等）。对于更高级的读者，探索如何使用领域事件来集成应用程序以及深入研究聚合设计都会很有趣。

虽然领域驱动设计不是关于技术的，但你仍然需要它来发出 HTTP 请求以访问你的领域。在整本书中，我们推荐使用特定的 PHP 框架和库，例如 Symfony、Silex 和 Doctrine。对于一些示例，我们也使用了特定的技术，如 MySQL、RabbitMQ、Redis 和 Elasticsearch。然而，最重要的是背后的概念——这些概念无论使用哪种技术实现都是通用的。

此外，这本书充满了大量的细节和示例，例如如何使用 PHP 正确地设计和实现领域驱动设计的所有构建块——包括值对象、实体、服务、领域事件、聚合、工厂、仓储和应用服务——以及如何解释在领域驱动设计中使用的 PHP 库和框架的主要角色。这本书还教授如何在你的应用程序中应用六边形架构，无论你是否使用开源框架还是自己的框架。最后，它展示了如何使用 REST 框架和消息机制来集成边界上下文。如果你对其中任何主题感兴趣，这本书就是为你准备的。

# DDD 和 PHP 社区

2016 年，Carlos 和 Christian 参加了首届官方领域驱动设计会议[DDD Europe](http://dddeurope.com/)。他们很高兴看到一些 PHP 开源领袖，如 Marco Pivetta（Doctrine）和 Sebastian Bergmann（PHPUnit），参加了会议。

领域驱动设计在会议两年前进入 PHP 社区。然而，仍然缺乏文档和真实的代码示例。为什么？我们认为还没有很多人在生产环境中使用这种类型的做法——即使在其他更成熟的社区中，如 Java。也许这是因为他们的项目复杂性较低，或者也许是因为他们不知道如何做。无论原因如何，这本书是为社区编写的。我们的目标之一是教会你如何编写一个解决你的领域问题的应用程序，而无需与特定的框架或技术耦合。

# 章节总结

本书按章节组织，每章探讨领域驱动设计的独立战术构建块。它还包括领域驱动设计的介绍、如何集成不同的边界上下文或应用程序的信息，以及附录。

# 第一章：开始学习领域驱动设计

领域驱动设计是关于什么的？它在复杂系统中扮演什么角色？是否值得学习和探索？当开发者开始学习时，需要了解哪些主要概念？

# 第二章：架构风格

边界上下文可以以不同的方式实现，并使用不同的方法。然而，两种风格越来越受欢迎，它们是六边形架构和 CQRS + ES。在本章中，我们将看到这两种主要的架构风格，了解它们的主要优势，并发现何时使用它们。

# 第三章：值对象

值对象是丰富建模的基本组成部分。我们将学习它们的属性以及它们为何如此重要。我们将了解如何使用 Doctrine 和自定义 ORM 持久化它们。我们还将展示如何正确验证和单元测试它们。最后，我们将看到测试不可变性的测试用例是什么样的。

# 第四章：实体

实体是领域驱动设计构建块，具有唯一标识和可变性的特性。我们将了解如何创建和验证它们，以及如何使用自定义 ORM 和 Doctrine 正确映射它们。我们还将评估是否使用注解是实体映射的最佳方法，并查看生成标识的不同策略。

# 第五章：领域服务

在本章中，你将了解什么是领域服务以及何时使用它。我们将回顾贫血领域模型和丰富领域模型是什么。最后，我们将处理编写领域服务时的基础设施问题。

# 第六章：领域事件

领域事件是一个优秀的控制反转（IoC）机制。在领域驱动设计中，它们对于异步通信不同的边界上下文、通过最终一致性提高应用程序性能以及解耦应用程序与其基础设施都至关重要。

# 第七章：模块

在如此多的战术构建块中，知道如何在代码中放置它们可能有点困难，尤其是如果你正在处理像 Symfony 这样的框架。我们将回顾如何使用 PHP 命名空间来实现模块。我们还将发现用于组织领域模型代码、应用代码和基础设施代码的不同文件夹层次结构。

# 第八章：聚合

聚合可能是战术领域驱动设计中最困难的部分。我们将探讨处理它们时的关键概念，并了解如何设计它们。我们还将提出一个实际场景，其中在添加业务规则时，两个聚合体合并为一个，并演示其余对象必须如何重构。

# 第九章：工厂

工厂方法和对象帮助我们保持业务不变性，这就是为什么它们在领域驱动设计中如此重要的原因。在这里，我们还将探索工厂和聚合之间的关系。

# 第十章：仓库

仓库对于检索和将实体和聚合添加到集合中至关重要。我们将回顾不同类型的仓库，并学习如何使用 Doctrine、自定义 ORM 和 Redis 来实现它们。

# 第十一章：应用

应用程序是连接外部客户端到你的领域的薄层。在本章中，我们将向你展示如何编写你的应用程序服务，以便它们易于测试并保持薄层。我们还将回顾如何准备请求对象、定义依赖关系以及返回结果。

# 第十二章：集成限界上下文

我们将探索不同的战术方法来沟通限界上下文，并查看实际实现。我们建议使用 REST 进行同步通信，使用 RabbitMQ 进行异步通信的消息是我们的建议。

# 附录：使用 PHP 的六边形架构

这里你可以找到 Carlos 撰写并由 php[architect] 在 2014 年 6 月发表的原文。

# 代码和示例

作者们在 GitHub 上创建了一个名为 [Domain-Driven Design in PHP](https://github.com/dddinphp) 的组织，这里提供了本书中的所有代码示例、额外的代码片段以及一些完整的示例项目。例如，你可以找到 [Last Wishes](https://github.com/dddinphp/last-wishes)，这是一个简单的基于领域驱动设计风格的示例应用，展示了本书中解释的不同示例。此外，你还可以找到我们的 [*CQRS 博客*](https://github.com/dddinphp/blog-cqrs)，以及 [Gamify](https://github.com/dddinphp/last-wishes-gamify)，这是一个添加了游戏化功能的 *Last Wishes* 限界上下文。

最后，如果你在阅读这本书时发现任何问题或修复，或者有建议或评论，你可以在 [DDD in PHP 书籍问题](https://github.com/dddinphp/book-issues) 仓库中创建一个问题。我们按收到的问题进行修复。如果你感兴趣，我们也强烈建议你关注我们的项目并提供反馈。
