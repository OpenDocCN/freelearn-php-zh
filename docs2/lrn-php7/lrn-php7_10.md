# 第九章：构建 REST API

大多数非开发者可能认为创建应用程序意味着为 PC 或 Mac 构建软件、游戏或网页，因为这是他们能看到并使用的。但一旦你加入开发者社区，无论是自己还是专业上，你最终会意识到为没有用户界面的应用程序和工具所做的多少工作。

你是否曾经想过某个人的网站是如何访问你的 Facebook 个人资料的，后来又如何在你的墙上自动发布消息？或者网站是如何在不需要刷新或提交任何表单的情况下发送/接收信息以更新页面内容的？所有这些功能，以及许多其他有趣的功能，都是由于“幕后”工作的应用程序的集成才成为可能的。了解如何使用它们将为创建更有趣和有用的网络应用程序打开大门。

在本章中，你将学习以下内容：

+   API 和 REST API 的介绍及其应用

+   REST API 的基础

+   使用第三方 API

+   REST API 开发者的工具

+   使用 Laravel 设计和编写 REST API

+   测试你的 REST API 的不同方法

# 介绍 API

**API**代表**应用程序程序接口**。其目标是提供一个接口，以便其他程序可以发送命令来触发应用程序内部的某些过程，可能返回一些输出。这个概念可能看起来有点抽象，但实际上，几乎与计算机有关的一切都有 API。让我们看看一些现实生活中的例子：

+   操作系统或 OS，如 Windows 或 Linux，是允许你使用计算机的程序。当你使用计算机上的任何应用程序时，它很可能会以某种方式与操作系统进行通信，例如请求某个文件，向扬声器发送一些音频等。所有这些应用程序与操作系统之间的交互都是由于操作系统提供的 API 才成为可能。这样，应用程序无需直接与硬件交互，这是一个非常繁琐的任务。

+   为了与用户交互，移动应用程序提供了一个 GUI。该界面捕获用户触发的事件，如点击或输入，以便将它们发送到服务器。GUI 使用 API 与服务器通信，就像程序之前解释的那样与操作系统通信。

+   当你创建一个需要显示用户 Twitter 账户推文的网站时，你需要与 Twitter 进行通信。他们提供了一个可以通过 HTTP 访问的 API。一旦认证通过，通过发送正确的 HTTP 请求，你可以更新和/或从他们的应用程序中检索数据。

如您所见，APIs 在不同的地方都有用。一般来说，当您有一个需要外部访问的系统时，您需要为潜在用户提供一个 API。当我们说外部时，我们指的是来自另一个应用程序或库，但也可以是在同一台机器内部。

# 介绍 REST API

REST API 是 API 的一种特定类型。它们使用 HTTP 作为与它们通信的协议，所以您可以想象它们将是 Web 应用程序中最常用的。事实上，它们与您已经构建的网站并没有太大的不同，因为客户端发送 HTTP 请求，服务器以 HTTP 响应回复。这里的区别在于 REST API 大量使用 HTTP 状态码来理解响应的内容，并且不是返回带有 CSS 和 JS 的 HTML 资源，而是使用仅包含信息的 JSON、XML 或其他文档格式，而不是图形用户界面。

让我们举一个例子。一旦认证，Twitter API 允许开发者通过向 `https://api.twitter.com/1.1/statuses/user_timeline.json` 发送 HTTP GET 请求来获取特定用户的推文。对这个请求的响应是一个包含推文 JSON 映射的 HTTP 消息，状态码为 200。我们已经在第二章中提到了状态码，*使用 PHP 的 Web 应用程序*，但我们很快会回顾它们。

REST API 还允许开发者代表用户发布推文。如果您已经在之前的例子中进行了认证，那么您只需要向 `https://api.twitter.com/1.1/statuses/update.json` 发送一个 POST 请求，并在正文中包含适当的 POST 参数，比如您想要推文的文本。尽管这个请求不是 GET 请求，因此您不是请求数据而是发送数据，但这个请求的响应同样很重要。服务器将使用响应的状态码来通知请求者推文是否成功发布，或者如果请求无法理解，发生了内部服务器错误，认证无效，等等。每种情况都有不同的状态码，这在所有应用程序中都是相同的。这使得与不同的 API 通信变得非常容易，因为您不需要每次都学习新的状态码列表。服务器还可以在正文中添加一些额外信息，以便阐明错误发生的原因，但这将取决于应用程序。

您可以想象这些 REST API 是为开发者提供的，以便他们可以将它们集成到他们的应用程序中。它们对用户不友好，但对 HTTP 友好。

# REST API 的基础

尽管 REST API 没有官方标准，但大多数开发者都同意相同的基础。这得益于 HTTP，这是该技术用于通信的协议，确实有一个标准。在本节中，我们将尝试描述 REST API 应该如何工作。

## HTTP 请求方法

我们已经在第二章中介绍了 HTTP 方法的概念，即“使用 PHP 的 Web 应用”。我们解释说，HTTP 方法只是请求的动词，它定义了请求试图执行的动作。当我们使用 HTML 表单时，我们已经定义了这种方法：`form`标签可以有一个可选的属性`method`，这将使表单使用该特定的 HTTP 方法提交。

在使用 REST API 时，您不会使用表单，但您仍然可以指定请求的方法。实际上，两个请求可以针对同一个端点，使用相同的参数、头部信息等，但由于它们的方法不同，因此表现出完全不同的行为，这使得方法成为请求中非常重要的部分。

由于我们非常重视 HTTP 方法来识别请求试图做什么，因此自然需要一系列的方法。到目前为止，我们已经介绍了 GET 和 POST，但实际上有八种不同的方法：GET、POST、PUT、DELETE、OPTIONS、HEAD、TRACE 和 CONNECT。您通常只需要使用其中的四种。让我们详细看看它们。

### GET

当请求使用 GET 方法时，这意味着它正在请求有关某个实体的信息。端点应该包含有关该实体的信息，例如一本书的 ID。GET 也可以用来查询对象列表，可以是全部、过滤或分页的。

当需要时，GET 请求可以添加额外的信息到请求中。例如，如果我们试图检索包含字符串“rings”的所有书籍，或者如果我们想要获取书籍完整列表的第 2 页。如您所知，这些额外信息作为 GET 参数添加到查询字符串中，这是一个由和号(`&`)连接的键值对列表。因此，这意味着请求`http://bookstore.com/books?year=2001&page3`可能是用来获取 2001 年出版书籍列表的第 2 页。

REST API 提供了关于可用端点和参数的详细文档，因此您应该能够轻松地学习如何正确地进行查询。尽管如此，即使这些参数会被记录下来，您也应该期待看到具有直观名称的参数，就像示例中展示的那样。

### POST 和 PUT

POST 是您已经了解的 HTTP 方法的第二种类型。您在表单中使用它，目的是“发布”数据，即尝试更新服务器端的一个资源。当您想要添加或更新一本新书时，您会发送一个包含书籍数据的 POST 请求。

POST 参数的发送格式与 GET 参数类似，但它们不是作为查询字符串的一部分，而是作为请求体的一部分。HTML 表单已经为你做了这件事，但当你需要与 REST API 通信时，你应该知道如何自己完成这个操作。在下一节中，我们将向您展示如何使用除表单之外的工具执行 POST 操作。此外，请注意，您可以将任何数据添加到请求体中；在请求体中发送 JSON 而不是 POST 参数是很常见的。

PUT 方法与 POST 方法非常相似。这也试图在服务器端添加或更新数据，为此，它也在请求体上添加了额外的信息。为什么我们要有两个执行相同操作的不同方法呢？实际上，这两种方法之间有两个主要区别：

+   PUT 请求要么创建一个资源，要么更新它，但受影响的是由端点定义的资源，没有其他。这意味着，如果我们想更新一本书，端点应该声明资源是一本书，并指定它，例如，`http://bookstore.com/books/8734`。另一方面，如果您没有在端点中标识要创建或更新的资源，或者同时影响了其他资源，您应该使用 POST 请求。

+   Idempotent 是一个复杂的词，用来描述一个简单的概念。一个幂等的 HTTP 方法是可以多次调用的，并且结果总是相同的。例如，如果您试图将一本书的标题更新为 "Don Quixote"，您调用它的次数并不重要，结果总是相同的：资源将具有标题 "Don Quixote"。另一方面，非幂等的方法在执行相同的请求时可能会返回不同的结果。一个例子可能是一个增加某些书籍库存的端点。每次您调用它时，库存都会增加更多，因此，结果并不相同。PUT 请求是幂等的，而 POST 请求则不是。

即使考虑到这个解释，滥用 POST 和 PUT 在开发者中仍然是一个相当常见的错误，尤其是在他们缺乏足够的 REST API 开发经验时。由于 HTML 表单只发送 POST 而不是 PUT 的数据，因此第一个更受欢迎。您可能会发现 REST API 中所有更新数据的端点都是 POST，尽管其中一些应该是 PUT。

### DELETE

DELETE HTTP 方法相当直观。当您想要在服务器上删除一个资源时使用它。与 PUT 请求一样，DELETE 端点应该标识要删除的特定资源。一个例子是我们想要从数据库中删除一本书。我们可以向一个类似于 `http://bookstore.com/books/23942` 的端点发送 DELETE 请求。

DELETE 请求仅用于删除资源，并且它们已经由 URL 确定。尽管如此，如果你需要向服务器发送额外的信息，你可以像使用 POST 或 PUT 一样使用请求体。实际上，你始终可以在请求体中发送信息，包括 GET 请求，但这并不意味着这样做是一种好的实践。
