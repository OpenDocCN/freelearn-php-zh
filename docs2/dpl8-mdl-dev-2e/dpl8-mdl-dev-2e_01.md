# 第一章：为 Drupal 8 开发

Drupal 是一个基于 Web 的**内容管理系统**（**CMS**）。虽然它自带功能强大，但它是为开发者设计的。本书的目的是解释 Drupal 可以以多种方式扩展，用于许多目的。为此，我们将使用本书撰写时的最新版本——Drupal 8.7。

在这本书中，我们将涵盖一系列的开发主题。我们将讨论如何创建一个 Drupal 8 模块，随着我们阅读章节，许多概念和技巧将帮助你构建你所需要的内容。目标是不仅解释事物是如何工作的，还要通过一些示例来演示它们。由于没有一本书可以包含一切，我希望在阅读这本书之后，你能够利用我引用的资源以及查看 Drupal 核心代码本身来扩展这些知识。尽管这样的书对于学习任何类型的软件开发都非常有帮助，但如果你真的想进步，你需要应用你所学的知识并亲自探索源代码。只有通过这样做，你才能理解具有许多依赖和层的复杂系统。

本章介绍了开发 Drupal 8 所需的术语、工具和流程。虽然后续章节侧重于代码，但本章侧重于概念。我们将讨论 Drupal 的架构以及你如何在战略位置挂钩 Drupal 以扩展它以完成新任务。

在本章中，我们将涵盖以下主要主题：

+   Drupal 开发的简介

+   Drupal 8 架构

+   Drupal 的主要子系统

+   Drupal 开发工具

在本章结束时，你将了解 Drupal 的架构方面，并准备好开始编写代码。

# Drupal 简介（面向开发者）

Drupal 传统上具有基于 Web 的内容管理系统（CMS）的所有标准功能：

+   访问者可以查看网站上发布的信息，浏览菜单，查看列表和单个页面等

+   用户可以创建账户并留下评论

+   管理员可以管理网站配置并控制用户的权限

+   编辑员可以在内容准备好后创建、预览并发布内容

+   内容可以同步到 RSS，其中新闻阅读器可以在发布时获取新文章

+   通过几个内置主题，甚至可以轻松更改网站的外观和感觉

然而，Drupal 8 在这些方面进行了改进并引入了一些更强大的功能。例如，高级多语言支持、内容审核、布局构建、REST API 以及许多其他功能现在都是自带功能。

# 为 Drupal 8 开发

虽然这些功能很棒，但它们肯定无法满足所有用户的需求。为此，Drupal 的功能可以通过模块、主题和安装配置文件轻松扩展。查看 Drupal 的主网站（[`drupal.org`](http://drupal.org)），您将找到数千个提供新功能的模块和数千个可以改变应用程序或网站外观和感觉的主题。

Drupal 可以通过模块和主题机制灵活扩展和转换的方式，导致许多人声称 Drupal 不仅仅是一个 CMS，而是一个**内容管理框架**（**CMF**），能够根据特定需求和功能要求进行重新配置。这尤其适用于 Drupal 8——这是 Drupal 的最新版本，也是本书的重点，因为在可扩展性方面取得了巨大进步。

判断 Drupal 是否正确地被称为 CMS 或 CMF 超出了我们在这里的目的，但可以肯定的是，Drupal 最巨大的资产是其可扩展性。想要使用目录服务器进行身份验证？有 Drupal 模块可以做到这一点。想要将数据导出到**逗号分隔值**（**CSV**）文件？有多个模块可以做到这一点（取决于您想要导出哪些数据）。对 Facebook 支持、与 Twitter 集成或添加“分享此内容”按钮感兴趣？是的，也有模块可以做到这些——所有这些模块都在 Drupal.org 上提供，由像您这样的开发者提供。

想要将 Drupal 与您编写的用于解决特殊业务需求的定制工具集成？可能没有现成的模块可以做到这一点，但通过一点代码，您可以自己编写。实际上，这正是本书的主题——为您提供知识和工具，以实现您自己的目标。

总结来说，本书的目的是让您尽快熟悉 Drupal 8 模块开发。随着我们逐章推进，我们将介绍您将用于构建自定义 Drupal 站点的 API 和工具，并且不会局限于理论。大多数章节都提供了实际操作、面向实践示例代码，旨在向您展示如何实现我们将要讨论的概念。我们将遵循 Drupal 编码规范，并利用 Drupal 设计模式，以展示在 Drupal 开发环境中编写代码的正确方式。

虽然我当然无法编写满足您需求的精确代码，但我希望这些章节中提到的代码可以作为您更大、更好的应用的基石。

让我们开始一些初步事项，以便更好地理解 Drupal。

# 推动 Drupal 发展的技术

在[Drupal.org](http://Drupal.org)和安装目录中的`INSTALL.txt`文件中都有关于以传统方式安装 Drupal 8 的文档，所以这里我就不详细说明了。然而，我会提到，对于开发者来说，一种更好的安装 Drupal 8 的方式是使用 GitHub 上提供的 Drupal 8 项目的标准 Composer 模板（[`github.com/drupal-composer/drupal-project`](https://github.com/drupal-composer/drupal-project)）。不过，设置网站的说明在那里也得到了很好的覆盖。

相反，让我们来谈谈推动（或需要）Drupal 8 的技术。

# PHP

Drupal 是用 PHP 编程语言编写的。PHP 是一种广泛支持的、多平台和以网络为中心的脚本语言。由于 Drupal 是用 PHP 编写的，因此本书将主要介绍 PHP 代码，尽管会考虑到 Drupal 的标准实践。

非常重要的是要注意，Drupal 8 运行（以及通过 Composer 安装）所需的最小 PHP 版本是 7.1。因此，PHP 5 不再由 Drupal 或整个 PHP 社区支持。在你阅读这本书的时候，你可能会在 PHP 7.3 或至少 7.2 上运行 Drupal。

关于 PHP 的风格，与 Drupal 7 相比，一个非常重要的变化是大量使用面向对象的代码和设计模式。诚然，在 Drupal 8 代码库中仍然存在许多过程式风格的实现方法，但大量使用流行的外部库（如 Symfony 组件）已经推动了 Drupal 代码的整体现代化。因此，如果你想要进行 Drupal 8 开发，至少应该对**面向对象编程**（**OOP**），尤其是 PHP 相关的，有一些基本的了解。

# 数据库和 MySQL

在过去，Drupal 支持两种数据库——MySQL 和 PostgreSQL。Drupal 7 和 8 已经超越了这一点。现在，Drupal 使用的是 PHP 7 标准库中的强大**PHP 数据对象**（**PDO**）库。这个库是一个抽象层，允许开发者支持包括 MySQL、PostgreSQL、SQLite 和 MariaDB 在内的多种数据库。

Drupal 8.7 所需的最小数据库版本如下：

+   MySQL 5.5.3/MariaDB 5.5.20/Percona Server 5.5.8 或更高版本，需要 PDO 和兼容 InnoDB 的主存储引擎

+   PostgreSQL 9.1.2 或更高版本，配合 PDO SQLite 3.7.11 或更高版本

+   SQLite 3.7.11 或更高版本

此外，Drupal 提供了一个强大的数据库 API 以及 SQL 编码规范，这使得与数据库交互变得容易——结合这些，可以让你编写安全且可移植的 SQL。然而，在不同层面上已经做了越来越多的抽象，几乎完全消除了编写 SQL 的需求。但是，我们仍将看到一些示例，以确保你的工具箱不遗漏任何东西，同时也会介绍你可用于查询数据库的所有工具。

# 网络服务器

Apache 长期以来一直是主导的网络服务器，但绝非唯一的服务器。虽然 Drupal 最初是为 Apache 编写的，但许多其他网络服务器（包括 IIS、Lighttpd 和 NGINX）也可以运行 Drupal。

在本书中，我们没有明确涵盖任何关于网络服务器层的部分，主要是因为开发很少需要在这个低级别工作。然而，Drupal 期望网络服务器层进行相当多的处理，包括 URL 重写处理。有关您可以期待的内容的更多信息，您可以查阅相关文档页面[`www.drupal.org/docs/8/system-requirements/web-server`](https://www.drupal.org/docs/8/system-requirements/web-server)。

# HTML、CSS 和 JavaScript

实际上的网络数据格式是带有**层叠样式表**（**CSS**）的 HTML。客户端交互组件是用 JavaScript 编写的。作为 Drupal 开发者，我们将在本书中遇到这三种技术。虽然您不需要成为 JavaScript 忍者就能理解这里的代码，但如果您对这三种技术感到舒适，您将能从本书中获得最大收益。

# Drupal 架构

在上一节中，我们介绍了驱动 Drupal 的技术。然而，它们是如何相互配合的呢？Drupal 代码是如何组织的？在本节中，我们提供了 Drupal 架构的概述，重点关注 Drupal 8。

# Drupal 核心、模块和主题

从建筑学的角度来看，我们可以将 Drupal 分解为三个部分：其核心、模块和主题。

当我们讨论 Drupal 8 的核心时，我们可以有两种解释。一种较为严格的解释认为它是指它所附带的所有代码所覆盖的功能，不包括模块和主题。而更为普遍的解释则认为它是指它所附带的总代码库（即**开箱即用**）。

尽管最普遍的解释是后者（至少因为它区分了其标准安装包含的所有功能与所有其他由贡献的模块和主题提供的功能），但考虑第一种解释也很有趣，即使只是片刻。因为这样做，我们可以从架构上区分基本代码与提供各种功能和布局的模块和主题。这种区分为什么有趣呢？因为在这两者之间的桥梁上发挥作用的是钩子和事件，这也会允许我们注入对我们自己功能的联系。

核心库由属于 Drupal 项目及其从更广泛的 PHP 社区借用的代码组成，Drupal 在开源许可下借用这些代码。这种后一种方法在 Drupal 8 中是新的，并且被许多人视为朝着离开 Drupal 孤岛和拥抱外部库、框架和社区的积极转变。

从本质上讲，核心库提供了 Drupal 中使用的函数和服务。例如，与数据库交互的辅助工具、语言之间的翻译、用户数据清理、构建表单、编码数据和许多此类实用工具都可在 Drupal 的核心库中找到。

模块（包括核心模块和贡献模块）是实际业务逻辑封装的主要地方。如果启用，它们可以提供功能或扩展现有功能。大多数核心模块都是必需的，不能禁用，因为它们在标准 Drupal 安装中的重要性。然而，贡献模块可以根据需要安装和卸载。

主题（包括核心主题和贡献主题）是主题系统的重要组成部分，并由表示层使用。它们提供 HTML 模板，内容和数据可以在其中渲染给用户，以及 CSS 样式甚至一些客户端脚本，以实现一些美观的交互。主题可以扩展其他主题，也可以包含一些 PHP 逻辑来处理在渲染之前的数据。

# 钩子、插件和事件

现在我们已经看到了核心库、模块和主题的作用，让我们简要谈谈钩子和事件，以了解它们是如何相互关联的。

钩子是 Drupal 非常典型的过程式概念，允许 Drupal 核心和模块从其他模块和主题（或暴露它们）收集数据。通过这样做，后者可以提供新的功能或修改现有功能。使用钩子实现返回的内容的责任在于调用钩子的代码。后者需要返回的格式通常在钩子文档中描述。

具体来说，钩子通过扫描已安装的模块和主题，寻找遵循特定命名模式的函数（换句话说，一个*钩子实现*）。在大多数情况下，格式如下—`module_name_hook_name`。此外，还有*alter*钩子，它们在函数名末尾附加了“alter”一词，用于更改传递给钩子实现的引用数据。我们将在本书后面的章节中看到钩子的示例。

有 OOP 背景或对设计模式有深入了解的开发者可能会认识到这与被动观察者模式中捕获的事件处理范例相似。当某个特定事件发生时，Drupal 允许模块有机会对此事件做出响应。

在 Drupal 的早期版本中，钩子（hooks）是王者。是的，我用大写字母写了这句话；我的*Caps Lock*并没有卡住。这是因为它们是向模块中添加或扩展功能的方式。因此，它们是 Drupal 编程最重要的一个方面。然而，在 Drupal 8 中，尽管仍然很重要，但它们让位于新的概念，如插件和事件。

在 Drupal 8 中，我敢说插件是王。许多曾经通过钩子与 Drupal 关联的逻辑现在都通过**插件**（不要与 WordPress 插件混淆）添加进来。Drupal 8 插件是由管理者集中管理的功能块，用于执行特定任务和功能。我们将在本书的后面部分更多地了解插件并提供许多示例。

Drupal 8 引入的第三个扩展点是事件系统。然而，与前面两个不同，这并不是 Drupal 特有的，实际上它是实际的 Symfony `EventDispatcher`组件([`symfony.com/doc/current/components/event_dispatcher.html`](http://symfony.com/doc/current/components/event_dispatcher.html))。事件主要用于 Drupal 中拦截某些动作或流程，以便停止或修改它们。许多过去通过钩子处理的`请求到响应`任务现在通过派发事件来处理，以检查是否有模块对，例如，向用户提供响应感兴趣。

# 服务和依赖注入容器

Drupal 8 的另一个重要的架构元素是 Symfony 依赖注入组件([`symfony.com/doc/current/components/dependency_injection.html`](http://symfony.com/doc/current/components/dependency_injection.html))，具体由服务容器表示。

这个组件是现代 OOP PHP 编程的基石，因此已经成为 Drupal 8 的基础。它允许我们在代码的各个地方创建*服务*，以便处理某些功能（通常是可替换的）任务。此外，它们也可以用作扩展点，因为服务容器能够将具有非常特定职责的服务分组，并自动使用它们。换句话说，仅仅通过定义一个简单的服务，我们就可以提供自己的功能，甚至改变现有的逻辑。

我们将遇到许多服务，我们将在本书的后面部分看到我们如何声明自己的服务。

# 从请求到响应

现在我们已经列出了 Drupal 最重要的架构组件，让我们简要地看看这些组件是如何在处理用户在 Drupal 8 网站上提出的请求时被使用的。为此，我们将分析一个简化的请求示例，看看它在 Drupal 8 网站上的处理方式：

1.  用户在网页浏览器中访问了`http://example.com/node/123` URL。

1.  浏览器联系`example.com`上的 Web 服务器，并请求`/node/123`资源。

1.  Web 服务器识别出请求必须由 PHP 处理，并启动（或联系）一个 PHP 环境来处理请求。

1.  PHP 执行 Drupal 的前端控制器文件(`index.php`)，然后从请求的资源中创建一个新的`Request`对象。

1.  Symfony 的 HTTPKernel 通过派发一系列事件来处理这个请求对象，例如`kernel.request`、`kernel.controller`、`kernel.response`和`kernel.view`。

1.  通过 `kernel.request` 事件识别映射到该请求的路由。

1.  路由控制器被识别，并使用 `kernel.controller` 事件对负责的控制器进行任何修改，以及解决需要传递给它的参数。在我们的情况下，这个路由是通过主实体系统由节点模块注册的，该系统识别实体 ID，加载它，并构建作为响应一部分返回的标记。

1.  如果相应的控制器（或处理器）返回的不是响应对象，则触发 `kernel.view` 事件以检查是否有任何代码可以将它转换成响应对象。在 Drupal 8 中，在大多数情况下，我们通常返回渲染数组，这些数组被转换成响应对象。

1.  一旦创建响应，前端控制器将其返回给浏览器并终止请求。

在这个背景下，作为 Drupal 8 模块开发者，我们大部分时间都在控制器和服务内部，试图弄清楚我们需要返回给页面的内容。然后我们依赖 Drupal 将我们的渲染数组转换成对用户适当的响应，但我们也可以直接返回一个响应。此外，主题系统和块系统也在这里发挥作用，因为我们的内容被包裹在一个块中，这个块被放置在由其他包含块的区域所环绕的区域中。如果现在听起来很复杂，请不要担心；我们将通过示例详细解释所有这些方面，很快就会变得清晰易懂。

# Drupal 的主要子系统

在前面的内容中，我们以鸟瞰的方式了解了 Drupal 的架构。现在，我们将稍微调整我们的视角。我们将遍历 Drupal 8 提供的主要子系统。

# 路由

所有这一切都始于一个路由，不是吗？与 Drupal 8 网站的几乎所有交互都是从用户（或系统）访问某个路径（或资源）开始的。这转化为一个路由，将那个资源映射到一个流程，该流程（希望）返回一个成功的响应，或者至少是一个优雅的失败。

Drupal 8 的路由系统与之前版本相比发生了重大转变。在 Drupal 7 及之前版本中，路由系统是一个非常具有 Drupal 特色的特性（如果你愿意，可以称之为*Drupal 主义*）。我们许多人还记得`hook_menu`是一个每个 Drupal 开发者都必须非常熟悉的钩子。所有这些都已经在 Drupal 8 中被遗弃，转而采用 Symfony 路由组件([http:/](http://symfony.com/doc/current/components/routing.html)[/](http://symfony.com/doc/current/components/routing.html)[symfony.](http://symfony.com/doc/current/components/routing.html)[com/](http://symfony.com/doc/current/components/routing.html)[doc/](http://symfony.com/doc/current/components/routing.html)[current/](http://symfony.com/doc/current/components/routing.html)[components/](http://symfony.com/doc/current/components/routing.html)[routing.](http://symfony.com/doc/current/components/routing.html)[html](http://symfony.com/doc/current/components/routing.html))。此外，既然我提到了`hook_menu`，我还会提到它的其他主要功能也已经在 Drupal 8 中被其他子系统所取代，例如插件。

在第二章，*创建您的第一个模块*中，我们将了解如何定义我们自己的路由并将其映射到将渲染我们页面的控制器。我们将介绍一些更重要的路由选项，并查看我们如何控制对这些路由的访问。

# 实体

逐渐地，实体已经成为在 Drupal 中建模数据和内容的一种非常强大的方式。最著名的实体类型始终是节点，它一直是内容存储和显示的基础。在 Drupal 8 中，整个实体系统已经进行了全面改革，使其他实体类型可能同样重要。它们被推到了前台，并且与其他系统进行了适当的连接。

所有实体类型都可以有多个`bundle`，它们是同一实体类型的不同*变体*，并且可以在它们上具有不同的字段（同时共享一些基本字段）。

Drupal 核心仍然附带节点实体类型，包括在其标准安装配置文件中的几个 bundle，如基本页面和文章。此外，它还附带了一些其他实体类型，如`User`、`Comment`和`File`。然而，在 Drupal 8 中创建自己的实体类型已经比 Drupal 7 更加标准化，在 Drupal 7 中，需要引入贡献模块才能实现这一点。

这些并不是我们在 Drupal 8 中拥有的唯一类型的实体。前面提到的例子都是内容实体类型。然而，Drupal 8 还引入了配置实体类型。前者用于建模内容，但实际上，它们用于任何可以存储在数据库中并且特定于该环境的数据。尽管如此，它们并不用于存储配置。用户和内容是很好的例子，因为它们通常不需要（通常）从一个环境部署到另一个环境。另一方面，后者是可导出的配置项，可能不止一个。例如，内容实体*包*是一个很好的例子，因为对于某种实体类型，可能存在多个包；它们存储了一些可以不同包而不同的元数据和信息，并且需要在所有环境中部署。也就是说，它们是网站正确运行的基础。

在 Drupal 8 中进行开发时，理解实体系统是必不可少的，因为它提供了一种强大的方式来建模自定义数据和内容。节点并不是完成这项工作的唯一工具，在我看来，在之前的 Drupal 版本中，由于缺乏适当的实体架构，它们被过度使用了。

# 字段

现在我们已经了解了实体是什么，让我们来看看数据实际上是如何在这些实体上存储的。

在前面的章节中，我已经提到了某些实体包可以具有各种字段。这意味着每个实体类型包都可以有任意数量的字段来存储数据。此外，每个实体类型本身也可以有用于存储数据的字段。好吧，那么呢？让我们来分解一下。

Drupal 8 中有两种类型的字段——基本字段和可配置字段。前者是在代码中为每种实体类型定义的字段，而后者通常在 UI 中创建和配置，并附加到该实体类型的*包*（并通过配置导出）。

字段也可以有多种类型，这取决于它们存储的数据。您可以拥有字符串（或文本）字段、数字字段、日期字段、电子邮件字段等等。作为开发者，如果现有的字段类型不足以满足我们的数据需求，我们可以创建自己的字段类型。

在这本书中，我们将探讨如何定义特定实体类型上的基本字段，并创建我们自己的字段类型，它有自己的数据输入小部件和输出格式化程序。然后，网站构建者可以在任何实体类型上使用这种字段类型。

# 菜单

任何网站都需要某种形式的导航，对吧？Drupal 不仅维护内容，还提供了有关网站自身组织方式的详细信息。也就是说，它保持了一个内容之间关系结构的结构。

它主要通过菜单子系统来完成这项工作。后者提供了生成、检索和修改描述网站结构的元素的 API。用通俗的话来说，它处理系统的导航菜单。

菜单是分层的，也就是说，它们具有树状结构。一个菜单项可以有多个子项，每个子项也可以有自己的子项，依此类推。这样，我们可以使用菜单系统来将我们的网站结构化为章节和子章节。

在本书中，我们将看到如何以编程方式与菜单和菜单链接一起工作。

# 视图

列出内容和数据一直是内容管理系统所渴望的重要功能；这正是 Drupal 8 中视图所做的事情。而且它做得很好。

如果你以前使用过 Drupal 的早期版本来构建（甚至不一定开发）网站，那么你只需用这个简单的短语就能理解一切——视图现在已经是 Drupal 核心的一部分了。

如果你还没有这样做，视图一直是 Drupal 贡献模块中的基本模块，可能在所有 Drupal 安装（在一定程度上）上都得到了使用，并且是网站构建者和甚至开发者的不可或缺的工具。

视图模块的目的是以允许创建可配置列表的方式暴露数据和内容。它包括过滤器、排序、显示选项以及许多其他功能。作为开发者，我们经常发现需要编写自己的字段或过滤器插件来与视图一起工作，或者从我们的自定义实体或外部数据源中暴露数据。

视图是核心 Drupal 8 模块，与通用架构绑定，用于 Drupal 核心提供的多数列表页面（特别是管理页面）。尽管它是一个非常以网站构建为导向的工具，但在本书中，我们将探讨如何创建插件来扩展其功能，为网站构建者提供更多功能。

# 表单

除非你的网站只有三页和五段文字，否则你很可能需要通过某种形式的表单来捕获用户输入。此外，如果你曾经编写过 PHP 应用程序，你就会知道从安全有效地渲染和处理提交数据的角度来看，表单一直是个头疼的问题。一旦你使用像 Symfony 或 Laravel 这样的 PHP 框架，你就会注意到有一个 API 可以帮你减轻很多负担。

这同样适用于 Drupal 8 及其强大的表单 API。从历史上看，它是在输出自己的表单元素和处理提交值方面的一个很好的抽象。它允许你以面向对象的方式定义自己的表单定义，并以逻辑方式处理验证和提交。其渲染和处理由 Drupal 安全地处理，因此你不必担心任何这些问题。在 Drupal 8 中，主题化表单元素比以前版本要容易得多。

在本书中，我们将遇到一些表单，并了解它们在实际中的工作方式。

# 配置

Drupal 开发者（以及其他流行 CMS 的开发者）的一大烦恼始终是配置的处理和部署方式，从一种环境到另一种环境。Drupal 7 将大部分配置存储在数据库中，因此随着开发进程的推进，开发者不得不想出各种解决方案来提升这一过程。

在 Drupal 8 中，通过引入集中式配置系统，在这方面取得了重大进步。尽管它将所有配置存储在数据库中，但它允许所有配置导出到 YML 文件中（然后重新导入）。因此，从开发角度来看，如果某些功能依赖于配置（例如，一个新的字段），我们将拥有更好的体验。

配置也有两种类型——简单和复杂（我们在*实体*部分提到的配置实体）。两者的区别在于前者始终是单一的。换句话说，只有一个实例。例如，网站名称和电子邮件地址存储在这样一个配置项中。你不会期望需要超过一个实例。然而，在后者的情况下，你会。例如，视图定义就是这样一种配置实体，因为它遵循一定的模式，我们可以有多个视图定义。这说得通吗？

# 插件

插件是 Drupal 8 的新功能，是对一个重要问题的优雅解决方案——封装功能。一开始，你不应该将它们与 WordPress 插件等混淆，后者更像是 Drupal 模块。相反，你应该将插件视为可由中央系统使用和管理的可重用代码组件。通常，当系统以某种方式（插件 A）处理任务时，它允许其他模块提供不同的处理该任务的方式（插件 B 或 C）。

你也可以将插件视为与实体相反：不是用于数据存储，而是用于功能。你创建的不是一种存储的数据类型，而是一种使用的功能类型。这两种通常协同工作，尤其是在以不同方式操作数据时。

他们的工作方式的一个重要方面是它们的可发现性。大多数插件类型（但肯定不是全部）都是通过一种称为*注释*的东西来发现的。注释是一种 DocBlock 注释的形式，借鉴自 Doctrine 库（[`docs.doctrine-project.org/projects/doctrine-common/en/latest/reference/annotations.html`](http://docs.doctrine-project.org/projects/doctrine-common/en/latest/reference/annotations.html)），通过它我们可以用某些元数据来描述类、方法和甚至属性。然后读取这些元数据来确定该项是什么，而不需要实例化该类。在 Drupal 8 中，我们只在类级别使用注释来表示它是一个具有某些特性的插件实现。这就是大多数插件在 Drupal 8 中是如何被发现的。

插件的第二种最常见发现方法是通过 YAML 文件，其中最受欢迎的例子是菜单链接（正如我们将在本书后面看到的那样）。然而，现在你应该知道插件被非常广泛地使用，在这本书中我们将创建相当多的插件。

插件是开发者添加他们自己功能的一个很好的新扩展点，也是 Drupal 8 的一个关键子系统。每个 Drupal 8 开发者都需要熟悉插件系统。

# 主题系统

为特定数据主题化的责任分散在 Drupal 核心、模块和主题本身上。因此，作为一个模块开发者，了解模块和主题都可以主题化数据或内容是很重要的。

在本书中，我们将关注模块级别的方面。我们不会关注样式，但主要与模块内所需的主题定义和模板一起工作。通常，确保模块能够主题化其数据是最佳实践。如果做得正确，主题就可以发挥作用来样式化输出或覆盖主题以完全改变展示方式。

与旧版本相比，Drupal 8 的一大转变是转向开源的 Twig 模板系统 ([https:/](https://twig.sensiolabs.org/)[/](https://twig.sensiolabs.org/)[twig.](https://twig.sensiolabs.org/)[sensiolabs.](https://twig.sensiolabs.org/)[org/](https://twig.sensiolabs.org/))。这使得逻辑与展示的分离更加清晰，使得前端开发者的工作更加容易，更不用说更加安全了。

# 缓存

我将在下面包括的最后一个主要子系统是缓存层。Drupal 8 付出了巨大的努力来提高构建页面和渲染数据的表现力。为此，缓存系统已成为在执行复杂或重量级计算或渲染内容时必须考虑的重要部分。

从模块开发者的角度来看，缓存系统有两个主要支柱。第一个为开发者提供了一个缓存后端来存储复杂数据计算的结果。这些结果可以在后续请求中读取，以避免重新处理该任务的需要。这与当系统中发生变化需要重新计算时发生的缓存失效密切相关。第二个支柱是渲染缓存，它允许开发者用描述何时需要使该输出的缓存失效的元数据包装他们的输出。

我们将在后续的缓存章节中看到这些工具的实际应用。

# 其他子系统

Drupal 8 中还有其他不同重要性的子系统。我选择包括前面提到的那些，因为我认为它们是最重要的，尤其是在模块开发者的视角下。然而，随着我们继续阅读本书，我们肯定会遇到其他系统。

# Drupal 开发工具

Drupal 是一个复杂的平台，从本章提供的窥视中，我们已能看出有许多系统和结构需要跟踪。在本节中，我将提供简化或优化开发过程的工具。

今后，我假设你已经有了自己的 Web 服务器堆栈和自己的 PHP 开发工具。然而，如果你是刚开始，你可能想看看 Acquia Dev Desktop（来自 Acquia [`acquia.com/`](http://acquia.com/)）。它提供了整个应用程序堆栈，让你在 Windows、Linux 或 macOS X 上开始。或者，如果你更加先进一些，你可以考虑 Drupal VM（[`www.drupalvm.com/`](https://www.drupalvm.com/)），这是一个基于 Vagrant 和 Ansible 的本地开发环境，适用于 Drupal。

最后，在我看来，最灵活的开发环境是基于 Docker 的。你可以很容易地从这里开始使用一个预先制作且文档齐全的堆栈：[`github.com/wodby/docker4drupal`](https://github.com/wodby/docker4drupal)。

至于代码编辑器，我个人使用 PhpStorm（正如许多人一样），但你完全可以选择你想要的任何 IDE，因为 Drupal 本身并不需要任何特殊的东西。然而，确实使用某种 IDE，因为它会使你的生活更加容易。

此外，虽然运行 PHP 调试器绝对不是必要的，但你可能会发现运行 Xdebug 或 Zend Debugger 是有用的。我个人强烈推荐 PHP 调试器，不仅因为调试本身，还因为可以理解底层的运行过程。

# 版本控制

任何软件开发都需要通过版本控制的环境进行。到目前为止，Drupal 已经普遍使用 Git。因此，你应该确保你已经在本地安装了 Git，即使只是为了能够检出我们在这本书中编写的代码示例，这些代码示例托管在 GitHub 上。

# Composer

如我之前所提到的，安装 Drupal 8 最好是使用 Composer 模板项目。然而，你也可以直接从 Git 安装，通过检出 [Drupal.org](http://Drupal.org) Git 仓库中的最新标签或提交（[`www.drupal.org/project/drupal/git-instructions`](https://www.drupal.org/project/drupal/git-instructions)）。如果你这样做，你需要通过 Composer 安装其依赖项，而 Drupal 有很多依赖项。

为了达到这个目的，你需要在你的开发环境中安装 Composer，并且对如何使用它有一个基本的了解。

# API 站点和编码标准

编写好的 Drupal 代码需要大量的背景知识。当然，这本书的目的是尽可能提供这些背景知识。然而，自我文档和调研仍然至关重要，Drupal 开发者应该手头上有一些资源。

第一份资源是官方的在线 API 文档。Drupal 中的几乎所有功能都使用内联代码文档进行记录。然后使用 Doxygen 程序提取这些文档并格式化。您可以在[`api.drupal.org`](http://api.drupal.org)在线访问完整的 API 文档。

除了使用 Drupal API，我们还努力遵守 Drupal 的编码规范。软件开发的最佳实践包括保持代码整洁、一致和可读。这其中的一个方面是通过遵循固定标准来消除代码格式的细微差别。

在像 Drupal 这样的平台上，这一点尤为重要，因为数千名开发者都在贡献代码。如果没有编码标准，代码将变成一团糟的样式混合体，宝贵的开发时间将浪费在仅仅解码代码而不是实际工作上。

Drupal 网站有一份关于编码标准的指南，每个 Drupal 开发者都需要熟悉([`www.drupal.org/docs/develop/standards/coding-standards`](https://www.drupal.org/docs/develop/standards/coding-standards))。这不会一夜之间发生；您会随着经验而变得更好，但您也可以配置您的 IDE，例如，标记任何与您的代码格式相关的问题。

对于新接触 Drupal 8 但已有 Drupal 7 经验的开发者来说，第三个资源是变更记录数据库([`www.drupal.org/list-changes/drupal`](https://www.drupal.org/list-changes/drupal))。在这个页面上，您可以找到最重要的 API 和用法变更清单，以及一些实用的解释，这将极大地帮助那些查找某些函数如何变更的 Drupal 7 开发者。

# 开发者（Devel）模块

在您的开发环境中，您可以安装一个名为 Devel([`drupal.org/project/devel`](http://drupal.org/project/devel))的实用模块，它提供了一些旨在帮助开发者创建和调试 Drupal 代码的复杂工具。

以下是这个模块的一些功能：

+   用于将对象和数组输出到格式化 Drupal 输出的函数

+   分析数据库使用和性能的工具

+   用于快速填充测试内容的生成器

# Drush（Drupal 外壳）

有时，在控制台中用一条命令运行一些任务要容易得多。Drush([`drupal.org/project/drush`](http://drupal.org/project/drush))提供了一个命令行 Drupal 界面，可以在控制台中通过几个按键执行任务。

在开发过程中，我们经常需要清除缓存、运行特定任务或将数据部署到远程服务器。Drush 可以帮助完成这些任务。此外，我们还可以编写自己的 Drush 命令来执行各种自定义任务，例如用于 cron 作业的任务。因此，对于任何严肃的 Drupal 开发者来说，安装 Drush 是必须的。

# Drupal 控制台

如果 Drush 是一个存在多年的工具，那么 Drupal Console ([`drupalconsole.com/`](https://drupalconsole.com/)) 项目对于 Drupal 8 来说则是新的。它的目的与 Drush 类似，并且以这种方式补充了它，有时甚至与之重叠。然而，有一点很清楚——它的范围要广泛得多，尤其是在它方便的命令生成样板代码方面，这些代码可能会相当长。

虽然我们在这本书中不会使用这个工具，但建议你在学习 Drupal 8 模块开发并开始快速生成某些代码结构时安装它。但在此前提下，我建议在使用它时要谨慎，实际上要理解它生成的代码实际上做什么。始终努力理解你在做什么，并且永远不要盲目复制粘贴 Stack Overflow 或其他资源中的代码，而不完全了解它的作用。

# 开发者设置

在进行本地开发时，禁用缓存（有时）以加快速度是有益的。Drupal 8 将缓存提升到了一个新的水平，因此许多钩子实现都得到了缓存。为了避免这种情况，我们可以使用一些本地设置来禁用缓存，防止 CSS 和 JavaScript 文件聚合，以及做类似的事情。

这些设置位于安装目录中`/sites`文件夹内的`example.settings.local.php`文件中。为了从中受益，你需要确保它们包含在你的主要`settings.php`文件中（通过复制它们或包含一个类似此文件的方式）。

警告——请务必记住，始终禁用缓存进行开发，你可能会忽略某些在启用缓存时无法正常工作的方面（例如无效化）。因此，请尝试切换这些设置以确保生产环境与开发条件下的工作效果一样好。

# 摘要

本章为开发者概述了 Drupal 8。我们了解了 Drupal 使用的技术。我们审视了 Drupal 的架构。我们简要地浏览了 Drupal 的几个突出子系统。我们还感受到了在处理 Drupal 时应该使用哪些面向开发者的工具。

从下一章开始，我们将开始处理代码。实际上，接下来的每一章都将侧重于与 Drupal 一起工作的实际方面。

在下一章中，我们将使用必选的 Hello World 示例创建我们的第一个 Drupal 8 模块。
