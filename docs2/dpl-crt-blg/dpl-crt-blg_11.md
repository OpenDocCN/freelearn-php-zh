# 附录 A. 部署

那一天终于到来了！到附录结束时，你的网站将上线，现在只存在一些微小的部署问题，阻碍着你实现在线抱负。*实际上并不完全是这样！*我应该明确指出，部署并没有什么特别复杂的地方；只是你需要密切关注许多不同的问题。在这个阶段犯愚蠢的错误可能会对最终产品产生重大影响，因为我们主要在部署一个完全开发的应用程序时处理配置问题。当然，犯错误并不是世界末日，因为我们将会非常彻底地测试一切。

初看之下，部署一个像 Drupal 这样的网站似乎很简单——只需将`drupal`文件夹复制到新服务器上！*或者不是吗？*在确保传输过程中一切顺利的过程中，有许多问题需要考虑。例如，数据库也需要按照开发机器上的样子完全重建——我相信你们中的大多数人已经花费了一些时间来配置一切并填充表格，你们肯定不愿意再次从头开始做所有的事情。除此之外，还有连接参数和一些安全问题需要考虑。

具体来说，附录探讨了如何：

+   为部署做好准备

+   将文件转移到新家

+   设置网站，包括数据库

+   仔细测试一切

抬起头来，我们几乎就要结束了；这并没有那么糟糕，对吧？我无疑会开始我的个人博客——这真的很诱人！

# 准备部署

首先，最重要的是；*你确定你对现在的网站完全满意吗？*虽然部署后对网站进行修改并不是什么大问题，但如果你现在就能完成这些工作，那么没有必要让自己在之后不得不重新编码某些页面或进行设计更改，从而给自己制造麻烦。如果一切就绪，那么我们可以开始准备过程。

准备工作分为三个阶段。不分先后顺序，我们需要确保我们有一个良好、干净、可工作的网站版本，一个良好、干净、可工作的数据库副本，最后，一个良好、干净的文件系统，为托管网站上的文件做好准备。让我们看看这是如何完成的。

## 确保主机已准备好

足够直观的是，你必须确保你有一个足够的主机。我的意思是，你有一个可以在上面创建 MySQL 数据库的主机，并且允许访问文件系统，以及你可能需要的任何其他好东西。为了使你的生活更轻松，有一个 FTP 账户可供使用，以便你可以将文件传输到主机文件系统也是一件好事。通常情况下，你应该能够使用管理员的用户名和密码自动登录到你的 FTP 账户。如果你不确定这一切是什么，那么在你的浏览器中尝试以下 URL（假设你的浏览器支持 FTP）：

`ftp://ftp.your_domain_name.com`

如果你被提示输入密码或者看到了你的主目录内容，那么恭喜你，你有一个 FTP 账户。如果你没有，那么你应该考虑让你的主机给你一个，或者向他们询问如何上传文件。顺便说一句，每次你使用 FTP 账户时，不必每次都提示你的用户名和密码，你可以将它们放在 URL 中，如下所示：

`ftp://username:password@hostname/`

如果你担心安全问题（我指的是：你确实在担心安全问题），那么最好省略密码，只传递用户名，因为否则如果 URL 在不安全的地方被记录，这可能会引起安全问题。记住，这些信息已经以未加密的格式传递。如果你希望安全地完成所有操作，你应该与你的主机讨论如何安全地传输文件。

如果你没有 FTP 账户的访问权限，那么不要慌张！稍后在这个附录中阅读名为 *Transfer the Files* 的部分——仍然可以轻松地将你的文件移动到主机站点。

一旦你确认了有地方可以上传 Drupal 文件，并且有东西可以用来上传，你需要创建一个数据库。天知道这有无数种不同的方法可以做到；所以我们不会在这里详细介绍每一种方法。

查看你的站点管理界面，看看是否有允许你创建和控制你的 MySQL 数据库的部分（你可能发现你的主机提供了我们的好朋友 phpMyAdmin）。例如，演示站点的宿主在 **Databases** 部分有一个 **Manage Mysql** 链接，它提供了一个用于创建数据库的界面。它还提供了 phpMyAdmin 以管理这些数据库：

![确保主机已准备好](img/1800_0A_01.jpg)

点击 **Manage MySQL** 链接会弹出以下页面。一旦你有了数据库，确保你已经记下了它的名字——通常主机会在你选择的名字后面添加一些内容，就像在这个演示站点数据库创建界面中所示：

![确保主机已准备好](img/1800_0A_02.jpg)

如你所见，数据库被命名为 **contechj_contechst**，其中 **contechst** 是我为实时数据库选择的名字，而 **contechj_** 是添加的部分。在我们继续之前，重要的是要注意这个数据库需要一个用户，所以确保它有一个，如下所示：

![确保主机已准备好](img/1800_0A_03.jpg)

在这个例子中，**contechst** 数据库现在有用户 **contechj_david**，有了这个，主机站点基本上已经准备好接收新的 Drupal 网站。记住，这些用户名、密码和数据库名称对于网站的配置都很重要，所以确保你不会忘记任何一个。如果你遇到困难，请向你的主机支持团队寻求帮助；他们就是为此而存在的。

## 准备文件

在进行任何操作之前，您需要在部署之前制作一个站点的主副本。确保您将发送的`drupal`目录的精确版本压缩并存储起来。

### 注意

目前，Drupal 索引页的目标 URL 将类似于[`www.domain_name.com/drupal/`](http://www.domain_name.com/drupal/)。如果您希望它是[`www.domain_name.com/`](http://www.domain_name.com/)，那么您需要不包含父目录地压缩文件，以便文件直接提取到现场网站的`public_html`文件夹中。

当我们谈论这个话题时，您不妨将 Drupal 文件系统彻底清理干净，这样您就不会保存错误的文件。

如果您像我一样，那么您可能在工作过程中创建了所有修改过的文件的备份。对于 Windows 机器来说，这些备份文件以`.bak`结尾，并放置在原始文件的同一文件夹中。在删除任何内容之前，备份您的`drupal`文件夹，以确保安全。然后从`drupal`文件夹中删除所有备份文件。

虽然现在做这件事可能看起来有点过度，但有几个很好的理由。首先，在您的托管文件系统中保留任何类型的未使用文件都是不安全的做法。其次，*为什么要在您不需要的文件中弄乱您全新的安装呢？*您会发现，无论如何，保持一切整洁有序都是一场持续的战斗——所以从您打算开始的地方开始。最后，如果您在开发阶段处理了大量文件，您正在为上传添加很多不必要的尺寸。

### 注意

由于安全原因，您可能需要将`CHANGELOG.txt`文件和`update.php`文件移动到不同的位置——将它们从网站中移除并保存在其他地方，这样黑客就无法获取它们。如果您需要使用`update.php`脚本，那么您可以在那时将其添加回网站。

接下来，打开配置文件`settings.php`，删除用户名和密码。正如您可能推断的那样，当前的数据库名称和密码将更改为您在主机上创建新数据库时设置的名称和密码（如果它们不相同），但转移任何类型的敏感信息都没有意义——尤其是当人们通常更喜欢为各种事情使用相同的用户名和密码时。

完成这些后，您必须等待直到下一部分，然后添加一个额外的文件，您就可以制作一个主副本，压缩您的 Drupal 站点——可以称之为 RTP（发布给公众）或类似的名称，以区分其他版本。

如果你在一个 Linux 盒子上工作，如果你愿意，可以使用**tar**和**gzip**压缩你的文件——这显然有助于上传时间。如果你在 Windows 上开发，那么你可能想确保你的主机可以解压`.zip`文件，因为它们很可能使用 Linux 服务器——不应该有问题。在极不可能的情况下，最好的做法是下载并安装 Windows 上的 gzip 实用程序，可以在[`www.gzip.org/`](http://www.gzip.org/)找到，然后你可以使用它将文件压缩成`.gz`格式。

## 准备数据库

目前为止，数据库可能包含大量用于测试的愚蠢帖子，或者可能包含一些重要的页面。这里没有硬性规定；只是尽量不要传输太多你最终会立即删除的东西。

谈到备份，这确实是本节的主要目的。为了部署数据库，你需要对其进行备份。然后，这个备份文件将被传输到主机网站，并用于在那里创建一个新的数据库。既然你已经有了关于备份所需的所有信息，我们就不需要在这里进一步探讨了。

一旦你创建了整个 Drupal 数据库的备份文件，并将生成的`.sql`文件添加到`drupal`文件夹的某个位置（只要你能再次找到它，任何地方都可以），你现在就可以开始将文件传输到你的主机上了。请注意，一旦你使用了`.sql`文件，就应该从你的网站上将其删除——将其保存在文档根目录之外的地方，以防你需要再次使用它。

# 传输文件

现在，你应该有一个最终、干净的在线商店版本，包括数据库的副本，所有内容都已打包，准备就绪。假设网站中有图像和相当多的数据，你可以确信上传的大小相当大。因此，你需要一个相当快的连接——拨号连接在长时间内可能会有些不稳定，所以甚至可能值得使用朋友的电脑或你的办公室连接将文件发送到主机网站。

到目前为止，最简单的方法是使用主机文件管理器的本地上传功能，通过快速连接上传。如果你可以使用它，只需用它上传存档文件到主机服务器。演示网站有这个功能，如下所示：

![传输文件](img/1800_0A_04.jpg)

注意，ZIP 文件正在上传到`public_html`文件夹，因为这是从该服务器上提供所有网页的文档根目录。

或者，假设你的网站启用了 FTP 账户，你可以尝试使用 FTP 拖放，这和在 Windows 上移动文件完全一样，或者你可以使用 FTP 实用程序。

如果有疑问，只需联系您的托管服务提供商，并询问有关如何传输文件的信息。对于绝大多数网站，其管理界面和文件管理器都易于使用，您将不会遇到上传文件的问题。因此，我们不会浪费时间详细讨论 FTP 工具。只需确保，最终，ZIP 文件出现在您托管服务器的主目录中。记住，一旦使用过，不要在主目录中留下 ZIP 文件夹。

# 设置网站

到这一步，您应该有一个正在工作的数据库，并且知道在您的实时网站上该数据库的用户名和密码。您也已经将存档文件上传到了托管网站。最后，我们终于从在开发机器上工作转移到在实时网站上工作。不过，首先我们需要做的是…

## 设置文件

您需要将存档文件提取到您的`public_html`文件夹中——很可能是您的托管服务提供商会提供这项功能。注意这里显示的列表中的第二个选项：

![设置文件](img/1800_0A_05.jpg)

提取这些文件后，您现在应该已经在托管网站上有了开发机器上文件的副本。通过浏览实时网站来检查这一点。您还应该发现，如果您尝试从网页浏览器浏览其中一个页面，您将不再收到页面找不到错误，而是收到其他类型的错误——很可能是 MySQL 错误，因为我们还没有建立数据库连接：

![设置文件](img/1800_0A_06.jpg)

这是一个好消息，因为它意味着我们可以毫无问题地浏览实时网站上的文件。这里显示的 Drupal 错误信息证实了我们确实正在浏览 Drupal 页面——请注意，之前截图中的错误信息提到了一个不正确的用户名和服务器。这是为了更清楚地演示我们正在浏览 Drupal，但我们还没有进入正确的数据库或配置设置。

## 设置数据库

如果您有权访问托管网站上的 phpMyAdmin，那么请打开它并按照以下步骤操作：

1.  在 phpMyAdmin 主页的左侧面板中，点击您之前安装的数据库名称。（回想一下，对于演示网站，这个名称是`contechj_contechst`)。

1.  在新打开的页面中，点击页面顶部的**SQL**标签。

1.  在**文本文件位置**选项下点击**浏览**。

1.  定位您想要运行数据库的文件，然后点击**Go**。

如果一切按计划进行，您将收到一条消息，告知您数据库修改成功。然后您可以通过 phpMyAdmin 查看数据库是否已获得所需的任何表。

可能存在您的主机系统和您用来创建备份的系统之间的问题。例如，我最初收到了以下错误：

![设置数据库](img/1800_0A_07.jpg)

这是因为 MySQL 的不同版本有时会使用略有不同的语法，在一切顺利运行之前，有必要从`.sql`文件中删除所有的`DEFAULT CHARSET=utf8`语句。

如果你没有访问 phpMyAdmin 的权限，那么你只需要以适合你特定网站的方式安装数据库，使用`.sql`文件。记住，如果你可以访问命令行，你能够从那里运行`.sql`文件——如果不能，那么是时候联系支持团队并了解他们推荐你如何运行你的`.sql`文件内容了。

## 配置网站

数据库设置完成后，回到你实时网站上的`sites/default/`文件夹中的`settings.php`文件，并根据你的系统设置进行修改——务必确保你精确地添加了你的*实时数据库*所需的名称和密码到`$db_url`，以及如果需要的话，实时网站的正确 URL 到`$base_url`。

一旦你适当地设置了配置设置，保存文件，然后尝试浏览一些页面。如果有幸，你将看到的东西大致和开发机器上的一样。

## 访问问题？

尝试登录管理员账户。我怀疑你们中的很多人都会在浏览器告诉你找不到你正在寻找的页面时遇到一些相当讨厌的惊喜。如果这种情况发生，很可能是因为`.htaccess`文件没有被成功迁移到实时网站上：

### 注意

*你必须确保 Drupal 的`.htaccess`文件存在于实时网站上!* Drupal 父文件夹中的`.htaccess`包含对网站健康运行至关重要的指令和信息。确保你直接传输它，或者将其内容剪切并粘贴到实时网站的`.htaccess`文件中。

在实时网站上查看`.htaccess`文件的内容（在 Drupal 父文件夹中，很可能是根据你的设置在文档根目录中），你应该看到类似以下内容：

```php
<IfModule mod_php5.c>
php_value magic_quotes_gpc 0
php_value register_globals 0
php_value session.auto_start 0
</IfModule>
# Reduce the time dynamically generated pages are cache-able.
<IfModule mod_expires.c>
ExpiresByType text/html A1
</IfModule>
# Various rewrite rules.
<IfModule mod_rewrite.c>
RewriteEngine on
# Modify the RewriteBase if you are using Drupal in a subdirectory and
# the rewrite rules are not working properly.
#RewriteBase /drupal
# Rewrite old-style URLs of the form ‘node.php?id=x'.
#RewriteCond %{REQUEST_FILENAME} !-f
#RewriteCond %{REQUEST_FILENAME} !-d
#RewriteCond %{QUERY_STRING} ^id=([^&]+)$
#RewriteRule node.php index.php?q=node/view/%1 [L] ...

```

如果是这样的话，你应该会发现你可以像平常一样浏览实时网站。放心，我们几乎完成了！目前要做的最后一件事是…

# 测试

*在这个例子中测试的目标是什么？* 好吧，从现在到本章结束，我们希望从我们目前的状态过渡到一个完全功能性的网站，更重要的是，一个实时且可操作的网站。为了达到这个目标，我们不仅需要确保从客户的角度看一切按预期工作，还需要确保网站得到适当的实施，并且我们可以无问题地管理它。

为了给你一个可能出现的糟糕情况的例子，看看我第一次尝试在实时网站上做一些管理操作时收到的以下错误信息：

![Testing](img/1800_0A_08.jpg)

*您能立即发现问题吗？* Drupal 抱怨它无法写入应包含在 `C:\apache2triad\temp` 中的 `files` 目录。这种情况并不奇怪，因为在实时网站上，根本不存在 `C:\apache2triad\temp` 目录。事实上，这个完全限定的路径之所以存在，是因为我最初想展示私有下载方法，尽管在这里公共访问文件是合适的。

这意味着我们需要重新输入在开发机器上设置的设置，以反映实时系统的具体要求：

![Testing](img/1800_0A_09.jpg)

假设您已经设置了必要的权限，使得 Drupal 可以在这些文件夹中读写，这个特定问题就解决了。（如果您已经在网站上有了文件，那么您可能需要将它们移动到您在这里指定的目录。）现在，剩下的就是测试管理工具中的所有其他功能，以确保它们能正确工作！

这里有一份检查清单，供您使用，以确保从用户的角度来看，网站运行良好：

### 小贴士

网站检查清单

| **使用至少两种不同的浏览器。** | 一种浏览器可能实现了其他浏览器没有的一些功能——您可能会发现您所依赖的某些功能在您选择的浏览器上工作得很好，但在其他浏览器上则不行。 | ![Testing](img/bracket.jpg) |
| --- | --- | --- |
| **调整浏览器窗口大小以适应各种页面。** | 这有助于确定您是否有未正确设置的 HTML 元素。例如，某些部分可能使用整个页面宽度，而其他部分可能只扩展到一定限制。 | ![Testing](img/bracket.jpg) |
| **从慢速和快速连接访问页面。** | 您可能会发现某些页面在拨号连接上加载非常缓慢。这可能意味着您需要重新考虑图片和页面的大小。 | ![Testing](img/bracket.jpg) |

| **检查所有链接——文本和图片。** | 在部署过程中，由于文件路径等差异，链接经常会出现问题。您应该：

+   检查每个页面上的所有链接和按钮

+   检查块中的所有链接

+   检查大图和小图是否显示得当

+   检查所有广告链接是否正确

| ![Testing](img/bracket.jpg) |
| --- |
| **检查每个页面的外观。** | 非常重要，因为并非所有浏览器都能渲染某些样式表设置。 | ![Testing](img/bracket.jpg) |

| **使用每个页面。** | 这对于确保用户能够：

+   注册账户

+   管理他们的账户

+   根据权限添加内容

+   根据他们的角色正确访问内容

+   利用网站的所有设施

确保以下内容：

+   搜索引擎工作正常

+   正确发送联系邮件

+   隐私政策和使用条款将显示，以及任何重要的版权信息。

| ![Testing](img/bracket.jpg) |
| --- |
| **尝试破坏网站（当然，作为受限用户）。** | 尝试破坏网站（当然，作为受限用户）。确保一切正常工作（如果不是更重要的话），与确保没有任何东西可以随意破坏一样重要。 | ![测试](img/bracket.jpg) |

如果你能在几个浏览器中无问题地完成这个清单上的所有事项，那么你可以合理地确信，当网站上线时它将能够稳定运行。当然，在运营的前几个月里，你需要非常密切地监控它，以确保没有任何严重的问题发生。提供网站管理员的电子邮件地址是让用户在遇到问题时进行投诉的好方法。你与用户之间开放的沟通渠道将有助于培养牢固的联系并提高你网站的质量。

# 摘要

对于像构建一个功能齐全的社区驱动网站这样重要的任务，你需要花费大量时间考虑你的选择，并开发和测试你的网站。由于在实时网站上做这类工作实际上并不可行，你需要使用一台开发机器来帮助你。正因为如此，部署的话题在整个计划中非常重要，因为正是部署将你的最终开发与实时网站联系起来。

本章概述了一个为部署做准备的良好流程。还必须在主机网站上设置一个新的数据库，但这一点相对容易，因为任何好的主机都会通过提供像 phpMyAdmin 这样的工具来简化这项任务。

希望你意识到，对于 Drupal 网站来说，部署过程本身并不特别复杂，因为唯一真正需要完成的是修改`settings.php`文件以反映你新系统的配置。将网站的部署复杂性降低到仅配置一个文件，对于 Drupal 用户来说确实是一个真正的优势。

虽然网站的部署本身相当简单，但已经证明有许多问题需要处理，其中最不重要的是测试。在网站上线之前进行全面的测试套件是至关重要的——因为愚蠢的错误而失去宝贵的用户是任何竞争性网站都不希望看到的。
