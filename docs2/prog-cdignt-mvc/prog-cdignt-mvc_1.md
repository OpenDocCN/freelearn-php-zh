# 第一章. 入门

本章通过审查一些基本的 Web 应用程序示例，涵盖了 CI 开发框架的基本知识和其使用。我们将从一个基本的“你好，世界”示例开始，然后过渡到一个与数据库集成的交互式联系表单。我们将通过逐步方法构建 CI 应用程序。在整个章节中，我们需要记住 CI 开发框架是一个基于 MVC 的开发架构（更多信息，请参阅维基百科定义[`en.wikipedia.org/wiki/Model-view-controller`](http://en.wikipedia.org/wiki/Model-view-controller)）。

本章将主要关注以下主题：

+   CI 项目目录树框架

+   配置（路由和自动加载在本章中介绍，其他问题在第二章*配置和命名约定*中介绍）

+   示例 1：hello world

+   示例 2：向视图传递参数

+   示例 3：模型通过渲染结果到视图进行数据库查询

+   示例 4：交互式联系表单

通过审查这些示例，我们将了解使用 CI 资源的基本知识。我们将首先简要回顾所使用的 CI 资源。然后，我们将审查一个加载静态视图页面的 Web 应用程序代码。接下来，我们将使用模型从数据库检索数据并在视图中显示它。最后，我们将添加一个带有联系表单的视图，通过调用控制器方法将输入保存到数据库中。

# 安装 CodeIgniter

首先，我们需要有一个托管 PHP 服务器（版本 5.3 或更高版本）和一个 MySQL 服务器（最新版本之一），我们知道数据库凭据。建议从 PHP 进行本地数据库访问以简化操作。

注意，服务器将以**CGI**（**通用网关接口**）的方式运行，以便让持续集成（CI）操作。我们可以在我们的 PC 上有一个本地 Web 开发环境，或者一个托管和专用的远程服务器。

一旦我们设置了一个本地 Web 开发环境，我们需要下载 CI 的最新版本，本书撰写时为 2.1.2 版本。下载最新版本的链接是[`codeigniter.com/downloads/`](http://codeigniter.com/downloads/)。现在，如果我们查看 CI 文件夹，我们应该看到以下目录树：

```php
codeigniter/
  index.php
  application/
  cache/
  config/
  controllers/
  core/
  errors/
  helpers/
  hooks/
  language/
  libraries/
  logs/
  models/
  third_party/
  views/
  system/
  core/
  database/
  fonts/
  helpers/
  language/
  libraries/
```

# 文件夹概述

根目录包含`index.php`文件，该文件处理所有 URI 请求。`index.php`文件将使用 CI 核心处理它们，并使用控制器加载的模型、库和助手以及渲染的视图应用我们的应用程序控制器，`license.txt`是 CI 的许可文件。`.htaccess`用于配置 CI 路由并从 URL 中删除`index.php`。JavaScript、CSS 和 HTML 被纳入渲染的 PHP 输出中，它们的使用在第七章*视图*中详细说明。

让我们回顾文件夹及其内容应用。

应用程序目录文件夹是我们主要活动项目编码区域的根目录。这是 CI 开发应用程序项目的核心。

## 必选组件

让我们来看看必选组件。

+   `application/config`：此文件夹包含所有 CI 应用程序配置文件，这些配置文件在第二章*配置和命名约定*中有所介绍。

+   `application/controllers`：此文件夹包含 CI 应用程序项目中所有的应用程序控制器。正如在*前言*中提到的，控制器是 MVC 设计架构中的一个组件，它处理用户的请求并向用户展示数据。CI 中的控制器是一个扩展 CI 控制器基类的类。类方法可以通过适当的 URI 执行或调用。与控制器定义和使用相关的命名约定将在第二章*配置和命名约定*中介绍。

+   `application/views`：此文件夹包含所有视图文件。视图是由用户浏览器执行的 HTML 内容，用于展示和与用户交互。视图可以是网页或 RSS 页面。

以下组件不是必选的，但强烈推荐：

+   `application/models`：此文件夹包含所有项目模型文件。模型是 MVC 设计架构中的组件，负责处理存储在数据库中的数据。CI 中的模型是一个设计用来与数据库中的信息一起工作的 PHP 类。第六章*模型*将详细阐述 CI 模型的概念、定义和用法，并附上几个使用示例。

+   `application/helpers`：此文件夹包含 CI 辅助文件的附加文件。它们可以是第三方文件或由开发者创建。辅助文件是特定类别中独立过程函数的集合。每个辅助函数执行一个特定的任务，不依赖于其他函数。第五章*辅助函数*将详细阐述 CI 辅助函数的概念、定义和用法，并附上几个使用示例。

+   `application/libraries`：此文件夹包含由开发者创建的 CI 应用程序项目中的所有库。从技术上讲，CI 库是一个 PHP 类。库的范围可以是任何项目资源，例如辅助函数、模型、控制器和视图。例如，库可以提供 Facebook 库 API 服务，以简化 Facebook 集成应用程序的代码。第四章*库*将详细阐述 CI 库的概念、定义和用法，并附上几个使用示例。

+   `system`：这是 CodeIgniter 核心目录的根目录。system 文件夹包含在子文件夹中的重要系统组件，例如核心、数据库、辅助程序（内置系统辅助程序）和库（内置系统库）。

    ### 小贴士

    不要编辑这些文件！如果我们不这样做，升级会更容易。

# 示例 1 – Hello World

首先，我们将从一个简单的例子开始，该例子在渲染的网页上显示**Hello World**。这是一个不使用数据库的例子。

URI 将是`http://ourdomain.com/index.php/hello`。

我们可以从路径中删除`index.php`文件以启用更短的 URI；也就是说，`http://ourdomain.com/index.php/hello`。

为了启用这些更短的 URI，我们将按照第二章中描述的配置更改，在`config.php`中的`index_page`设置进行配置。

我们将构建以下两个脚本：

+   控制器类：`application/controllers/hello.php`

+   视图脚本：`application/views/helloview.php`

在这个例子中，我们使用默认配置。有关配置的更多信息，请参阅第二章，*配置和命名约定*。在这个例子中，控制器传递了在视图中显示的参数。

### 小贴士

从控制器传递参数到视图是可选的。

## 控制器文件

这是控制器的代码示例。控制器负责使用如巨标题和消息之类的参数渲染视图。关于控制器类的命名，请参阅第二章，*配置和命名约定*。

```php
<?php 
class Hello extends CI_Controller {
  * Index Page for this controller.
  * Maps to the following URLhttp://example.com/index.php/hello
  - or - http://example.com/index.php/hello/index- or -* since this controller is set as the default controller in config/routes.php, it's displayed at http://example.com/
  * So any other public methods not prefixed with an underscorewill map to /index.php/welcome/<method_name>
  @see http://codeigniter.com/user_guide/general/urls.html
  public function index(){	    
    // Note that $view_params is optional// we can use $this->load->view('helloview');as well.// if the view doesn't use php variables 
    // The $view_params is extracted in the view script to php// variables $key = $value
    // In this example three variables will be generated by CI in the // view page
    // helloview.php variable: $mega_title
    // value: 'Codeigniter - Hello World'		// variable: $title      value: 'Welcome to // Codegniter'// variable: $message    value: 'Hello World'
    $view_params = array(
    'mega_title' => 'Codeigniter - Hello World', 'title'      =>  'Welcome to Codegniter','message'    =>  'Hello World'                              );		
 $this->load->view('helloview', $view_params);		}
	} // closing the class definition
/* End of file welcome.php *//* Location: ./application/controllers/welcome.php */
```

### 小贴士

您可以从您在[`www.packtpub.com`](http://www.packtpub.com)的账户中下载您购买的所有 Packt 书籍的示例代码文件。如果您在其他地方购买了这本书，您可以访问[`www.packtpub.com/support`](http://www.packtpub.com/support)并注册，以便直接将文件通过电子邮件发送给您。

## 视图文件

以下是对应的渲染视图，它使用控制器提供的参数将视图渲染到网页上，并将其返回给用户：

```php
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title><?php echo $mega_title ?></title>
</head>
<body>
  <div id="container">
  <h1><?php echo $title ?></h1>
  <div id="body">
  <p><?php echo $message ?></p>
</div></div>
</body>
</html>
```

# 示例 2 – 将复杂参数传递给视图

在这个例子中，我们将向您展示如何从 CI 控制器传递和使用复杂参数，例如数组和对象数组，以便在 CI 视图中使用。您可以将任意数量的数组作为参数传递给视图；您还可以传递对象，例如查询结果的行。

标准 GET 参数 URI 看起来像这样：`http://ourdomain.com/index.php/example2/more/?a=1&b=2&c=3`。

然而，让我们记住在 CI 中，URI 以这种方式传递：`http://ourdomain.com/index.php/example2/more/1/2/3`。有关更多信息，请参阅第二章，*配置和命名约定*。

观察 URI，我们将构建名为 `more` 的控制器 `example2.php`，并传递三个参数给它。

我们将构建以下两个脚本：

+   控制器类：`application/controllers/example2.php`

+   视图脚本：`application/views/example2more.php`

## 控制器文件

控制器负责使用如大标题和信息等参数渲染视图。

以下是对应的控制器代码示例：

```php
<?php 
class Example2 extends CI_Controller {
  //This function gets parameters and passes them to the view//example2more
  //The example url//http://ourdomain.com/index.php/example2/more/1/2/3
  so $a = 1, $b = 2, $c = 3
  public function more($a, $b, $c)
  {
    // The parameters in $view_params are extracted in the view//example2more.php
    // In this example 2 variables will be generated by CI in the//view page example2more.php
    //variable: $mega_title, value: Codeigniter, Passing//url parameters to view
    variable: $rows, value: array('a' => $a, 'b' => $b, 'c' => $c);
    $rows = array('a' => $a, 'b' => $b, 'c' => $c);
    $view_params = array('mega_title' => 'Codeigniter -  Passing url parameters to view 'rows' => $rows);
 $this->load->view('example2more', $view_params);
    }	}// closing the class definition/* End of file welcome.php
```

## 视图文件

以下是对应的渲染视图：

```php
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title><?php echo $mega_title ?></title>
</head>
<body>
<table>
<tr>
  <td>Key</td>
  <td>Value</td>
</tr>
<?php foreach ($rows as $key => $value): ?>
<tr>
  <td><?php echo $key ; ?></td>
  <td><?php echo $value ; ?></td>
</tr> 
<?php endforeach; ?>
</table>
</body>
</html>
```

# 示例 3 – 模型通过渲染结果到视图执行数据库查询

在本例中，我们将向您展示 CI 控制器如何使用 CI 模型从数据库检索数据并将其渲染到 CI 视图中。

URL 将是`http://ourdomain.com/index.php/user`。

首先，我们必须在配置文件 `application/config/database.php` 中配置数据库设置。

我们应保持默认数据库设置不变，只需更改以下配置参数：

```php
$db['default']['hostname'] = '127.0.0.1';
//In many cases when the hostname's value is 'localhost' theconnection to the database fails.
//Setting the hostname to 127.0.0.1 solves the problem.
$db['default']['username'] = 'dbUser;
$db['default']['password'] = 'dbPassword';
$db['default']['database'] = 'dbDataAbse';
$db['default']['port']     = 'dbPort';
```

模型类将从 `users` 表中检索所有用户详细信息。

有关配置的更多信息，请参阅第二章，*配置和命名约定*。

我们将构建以下三个脚本：

+   控制器类：`application/controllers/user.php`

+   模型文件：`application/model/usermodel.php`

+   视图脚本：`application/views/userview.php`

## 控制器文件

控制器通过模型从数据库检索 `users` 列表，并与其一起渲染视图。

以下是对应的控制器代码示例：

```php
<?php
class User extends CI_Controller {
  function users()
  {
    //Manually loading the database
 $this->load->database();
    //Loading the model class
 $this->load->model('Usermodel');
    $view_params['mega_title'] = 'Model Example';
    //Calling the model to retrieve the users from the database
    $view_params['users']= $this->Usermodel->get_users();
 $this->load->view('userview', $view_params);
  }
}
/* End of file welcome.php */
/* Location: /application/controllers/welcome.php */
```

## 模型文件

以下是对应的模型代码示例。

```php
<?php
class Usermodel extends CI_Model {
  function __construct()
  {
    // Call the Model constructor	parent::__construct();
  }
  //This method retrieves the users list and returns an array of //objects each containing user details
  function get_users()
  {
    //Calling CI's database object's method for generating SQL//queries.
    $query = $this->db->get('users');
    //returns an array of users objects
    return $query->result();
  }
}
```

在本例中，CI 对象数据库的方法被调用以生成和执行 SQL 查询。

请参阅 CI 数据库库[`ellislab.com/codeigniter/user-guide/database/index.html`](http://ellislab.com/codeigniter/user-guide/database/index.html)。

有关模型的信息，请参阅第六章，*模型*。

## 视图文件

本例中的视图显示了从控制器接收的表格内容，其中包含数据库中定义的 `users` 列表。

以下是对应的渲染视图：

```php
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title><?php echo $mega_title ?></title>
</head>
<body>
<table>
<tr>
  <td>ID</td>
  <td>Name</td>
  <td>Email</td>
</tr>
<?php foreach ($users as $user): ?>
<tr>
  <td><?php echo $user->user_id ?></td>
  <td><?php echo $user->user_fname." ".$user->user_lname; ?></td>
  <td><?php echo $user->user_email ; ?></td>
</tr>
<?php endforeach; ?>
</body>
</html>
```

# 示例 4 – 交互式联系表单

本示例展示了如何使用 CI 表单辅助器和 `form_validation` 库编写联系表单。

关于库的更多信息，请参阅第四章，*库*，以及关于辅助器的信息，请参阅第五章，*辅助器*。

CI 控制器使用 `form_validation` 库定义表单验证设置，并渲染一个表单视图，该视图使用 `form_validation` 库设置来对用户提交的数据应用所需的验证。如果成功，CI 控制器将渲染显示成功消息的视图页面；否则，它将渲染包含表单的视图页面，并显示错误消息。

此示例的 URI 为 `http://ourdomain.com/index.php/contact`。

为了执行此示例，我们需要构建以下三个脚本：

+   联系表单控制器类：`application/controllers/contact.php`

+   视图表单脚本：`application/views/contactview.php`

+   查看成功页面脚本：`application/views/contactsuccess.php`

## 控制器文件

控制器创建了一个用于添加和编辑产品的表单。

更多信息，请参阅第七章，*视图*。

以下是对应的控制器代码示例：

```php
<?php
class Contact extends CI_Controller {
  public function index()
  {
    //Loading the form helper
    $this->load->helper('form');
    //Loading the form_validation library
    $this->load->library('form_validation');
    $view_params['form']['attributes'] = array('id' =>'myform');
    //contact name details
    $view_params['form']['contact_name']['label'] = array('text' => 'Your name:', 'for' => 'name');
    $view_params['form']['contact_name']['field']= array('name' => 'contact_name', 'id' => 'contact_name','value'=>isset($_POST['contact_name']) ?
    $_POST['contact_name'] : '',
    'maxlength' => '100', 'size' => '30', 'class' => 'input');
    //contact name details
    $view_params['form']['contact_email']['label'] = array('text' => 'Your email:', 'for' => 'email');
    $view_params['form']['contact_email']['field'] = array('name' => 'contact_email', 'id' => 'contact_email','value'=> isset($_POST['contact_email']) ?
    $_POST['contact_email'] : '',
    'maxlength'   => '100', 'size' => '30', 'class' => 'input');
    //contact message details
    $view_params['form']['contact_message']['label'] = array('text' => 'Your message:', 'for' => 'message');
    $view_params['form']['contact_message']['field'] = array('name' => 'contact_message', 'id' => 'contact_message','value' => isset($_POST['contact_message']) ?
    $_POST['contact_message'] : '',
    'rows' => '10',  'cols' => '100', 'class' => 'input');
    // Setting validation rules
    $config_rules = array(array('field' => 'contact_name','label' => 'Contact Name', 'rules' => 'trim|required'),
    array('field' => 'contact_email', 'label' => 'Contact Email','rules' => 'trim|required|valid_email'));
    $this->form_validation->set_rules($config_rules);
    $this->form_validation->set_rules('contact_message','Contact Message', 'trim|required');
    // Validating the form
    if ($this->form_validation->run() == FALSE)
    // failed 
    {
      for ($index = 0; $index < count($a_fields) $index++);
      {
        $s_field = $a_fields[$index];
        if (form_error($s_field))
        {
          $view_params['form'][$s_field]['field']['class'] .= 'error';
          }
        }
      $this->load->view('contactview', $view_params);
      }
      else // Validation succeeded
      {
      $success_params = array('message'=> 'Success');
      $this->load->view('contactsuccess', $success_params);
      }
    }
  }
/* End of file welcome.php */
/* Location: ./application/controllers/welcome.php */
```

## 视图文件

视图文件显示用于从用户接收数据的联系表单。

以下是对应的渲染表单视图：

```php
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Form Example</title>
</head>
<body>
<?php if (validation_errors()) : ?>
  <?php echo validation_errors() ; ?>
  <?php endif; ?>
<?php echo form_open('contact', $form['attributes']) ; ?>
<table>
<tr>
  <td><?php echo form_label($form['contact_name']['label']['text'],
$form['contact_name']['label']['for']);?> 
  </td> 
  <td><?php echo form_input($form['contact_name']['field']); ?></td>
</tr>
<tr>
  <td><?php echo form_label($form['contact_email']['label']['text'],
$form['contact_email']['label']['for']);?>
  </td> 
  <td><?php echo form_input($form['contact_email']['field']);?>
  </td>
</tr>
<tr>
  <td><?php echo
  form_label($form['contact_message']['label']['text'],
  $form['contact_message']['label']['for']); ?>
  </td> 
  <td><?php echo form_textarea($form['contact_message']['field']);?>
  </td>
</tr>
<tr>
  <td colspan="3"><?php echo form_submit('mysubmit', 'Send'); ?></td>
</tr>
</table>
<?php echo form_close() ; ?>
</body>
</html>
The following is the corresponding rendered success view:
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Contact sent</title>
</head>
<body>
<div id="container">
  <div id="body">
    <p><?php echo $message ?></p>
  </div>
</div>	
</body>
</html>
```

# 摘要

在本章中，我们回顾了 CI 目录树，特别是应用程序文件夹，它是任何 CI 项目的核心和灵魂。在下一章中，我们将回顾配置，例如数据库和命名约定，这些对于 CI 项目至关重要。
