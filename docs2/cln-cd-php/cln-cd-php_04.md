# 4

# 这不仅仅是关于代码

当你想到将 **PHP: Hypertext Preprocessor** （**PHP**）描述为一种编程语言是否有点过于简化？我们必须面对事实：PHP 不仅仅是一种简单的编程语言。它是一个完整的生态系统，拥有庞大的社区、数千名贡献者，并且定期提出和发布新功能。但不仅如此：数百万个库和 **应用程序编程接口** （**API**）都是由于 PHP 而被编写和发布的。甚至许多命令行工具也是完全依靠 PHP 语言开发的。PHP 是一个独立的世界。让我们先看看 PHP 不仅仅是一种编写网站的语言的理由。

这些是我们将在本章中涉及的主题：

+   PHP 作为生态系统

+   选择合适的库

+   关于语义版本控制的一个词

+   稳定性 versus 趋势

# PHP 作为生态系统

这可以从我们共同列出的一些事情中看出：

+   PHP 仍然是 2020 年代初最常用的用于网络应用开发的服务器端语言。当你知道网络应用在我们日常使用中的主导（甚至可以说是压倒性）地位时，这真是一个真正的荣誉！

+   这种语言继续非常强烈地发展，尤其是在近年来。在 PHP 6（从未发布）的开发过程中，它经历了一段低谷，然后从版本 7 开始经历了其受欢迎程度的真正爆炸。PHP 5 和 7 的基准测试在最初发布时简直疯狂。发展势头强劲，新功能被非常频繁地提出。

+   PHP 拥有一个名为 **Composer** 的杰出依赖管理器。简单、开源且效率惊人，它通常被用户认为是市场上最好的依赖管理器，包括所有编程语言在内。尽管这可能是一种主观观点，但我们无法否认它的可靠性。

+   谈到依赖关系，你只需访问 Packagist 网站（Composer 获取依赖的仓库）就能意识到 PHP 拥有异常出色的社区，可以提供如此多的库，每个都比另一个更令人难以置信，其中绝大多数都是免费且无使用限制的。如果你有需求，肯定有一个外部库可以解决你的问题。

+   PHP 扩展是扩展语言的一个真正的金矿。与您使用 Composer 安装的库不同，这些扩展是用 C 语言编写的，并直接插入到 PHP 解释器的源代码中。这使我们能够以令人印象深刻的表现力扩展语言。这也意味着 PHP 的默认安装可以非常精简，几乎不需要任何东西就能工作。然后我们可以根据我们的需求单独安装扩展。这在我们的应用程序必须在资源有限的服务器上运行时尤其有用。

+   世界各地的多个会议都表现出对 PHP 的强烈承诺。同样令人难以置信且享有盛誉的工具，如 Symfony、Drupal 和 Laravel 框架，显示出将语言推向极限的真正愿望。这些框架本身组织国际会议，并被跨国公司（如 Airbnb、Spotify、TheFork 等）使用。据记录，Symfony 在 2022 年仍然是所有开源项目中为框架和文档贡献者数量最多的开源项目之一。

+   PHP 核心的开发至今仍在全速进行，而且比以往任何时候都要活跃。新特性的提案和**评论请求**（**RFCs**）（提出语言变更的第一步）正在以惊人的速度出现，并且被迅速实施。许多贡献者参与了其中，并且也观察到主要贡献者的更新换代。一些较老且重要的贡献者，如知名的 Nikita Popov，正在离开这个项目，而新的贡献者正在加入。社区始终处于不断的活跃状态。

PHP 是一个有着良好声誉的语言。其稳健性和效率使其成为世界上一些最大网站的首选语言。在过去或目前，替代方案已经实施或正在实施的地方，例如 Python（在撰写本文时，大约有 1.2% 的所有网站使用 Python 用于一些 Google 网站），PHP 仍然是主流。显然，许多有吸引力的技术正在兴起，并从 PHP 中夺取市场份额，例如 Node.js 或 C# 和 .NET 框架。PHP 仍然有着光明的未来。知道如何用 PHP 编写网站可以确保您将能够阅读世界上绝大多数现有网站的源代码。

由于所有这些原因，PHP 是一个生态系统。进一步思考……如果 PHP 不仅仅是一种编程语言，如果 PHP 不仅仅是一种代码，那么我们为什么要把清洁代码仅限于代码呢？

清洁代码也可能包含，通过扩展，安装到您的项目中的外部依赖项和库的正确选择。让我们看看为什么您应该明智地选择依赖项，以及如何选择它们以限制风险。

# 选择合适的库

选择合适的第三方库进行安装可能是一项真正的挑战。这是我们每个人都面临过或将来会面临的挑战。原因很简单：没有必要重新发明轮子。我们想要安装外部库的原因通常是一样的。我们有一个具体的问题，我们希望尽可能干净利落地解决它。这里出现了两种情况：

+   我们知道如何解决这个问题，但我们不想在已经存在解决我们问题的工具时重写一切。

+   我们不知道如何解决这个问题，因为我们缺乏理论或实践知识。

那么调用一个外部库来为我们提供非常具体的解决方案是非常有趣的。这里列出的优势是多方面的：

+   开发外部库的人可能已经思考了几天或几周，关于提供解决方案的最佳方式。这甚至可能是他们的日常工作。无论他们在这上面花费了多少时间，通常都比我们允许的冷静和清晰地思考解决方案的时间要多。

+   如果依赖项仍在积极开发中，那么维护工作将由除你之外的其他人负责。这意味着你将定期收到错误修复和新功能，这些都是这些志愿者提供的最宝贵的资产：他们的时间。

+   如果你正在使用的是开源的外部库，那么你将获得额外的益处，如下所述：

    +   源代码对每个人都是可见的。这意味着任何人，比如其他开发者甚至安全研究人员，都可以分析源代码以加强它并修复安全漏洞（或者至少通知作者）。请别误会：开源对安全并没有坏处。事实上，恰恰相反。通过混淆（理解为隐藏诸如源代码之类的信息以确保“安全”）来实现安全是最糟糕的事情。安全必须通过其他手段来实现。没有缺乏证据：世界上使用最广泛的加密和加密算法是众所周知的，它们的运作方式在互联网上有成千上万的解释。这并不损害它们的安全性。

    +   如果开源项目被遗弃，那么可能会出现一些后续行动（称为“分支”）。简单来说，分支就是那些复制了项目源代码并在自己的独立环境中进行开发的人，与原始项目的开发无关。从理论上讲，这可以确保项目的无限寿命。

    +   如果项目的主要维护者没有时间再照顾项目，但开发者希望这样做，由于源代码对所有开放，他们可以这样做。

+   如果你好奇，可以深入研究源代码，了解库是如何解决问题的！

我们可以清楚地看到，选择开源依赖项是不可避免的。如果您想要确保不会突然得到一个不可用的工具，开源正是为您准备的，因为您可以存储源代码的副本，而无需担心。这是选择外部库的第一个绝佳方式。

需要考虑的第二个因素是项目的更新频率。显然，如果一个开源项目已经几个月甚至几年没有更新，那么要小心：它可能已经被遗弃。在这种情况下，这意味着该项目可能不会支持 PHP 的下一个版本，或者不再修复错误和安全漏洞。正如这里所述，有两种简单的方法可以知道一个项目是否仍在维护中：

+   首先，您可以检查库的最后一个版本日期。再次提醒，因为一些项目有（非常）缓慢的发布过程，所以建议将此技术与第二种技术结合起来。

+   这是第二种技术。看看源代码的最后修改时间。这可以非常容易地完成，尤其是如果源代码托管在 GitHub 等网站上。通过浏览文件，您可以查看文件夹或文件的最后修改时间。这可以是一个很好的项目开发动态的指示。

需要考虑的第三个因素是库的文档。您可能想确保项目有最小且足够的文档来设置基础知识。如果没有提供文档，那么可以肯定的是，使用外部库将会是一个系统的痛苦。实际上，所有的代码维护都将变成一场记住项目如何工作的战斗，没有文档来帮助您或分享知识。此外，这也非常与您想要使用的技术的社区密切相关。如果您想要集成的项目使用的人很少，社区相当不活跃，甚至不存在，那么没有人能够以最佳方式帮助您。这可以是一个决定是否在代码中使用此或那个依赖项的有效方法。

第四个因素是库本身依赖的依赖项数量。一般来说，我们更喜欢依赖项很少的库。依赖项越少，需要更新的包就越少，第三方就越少，因此在这些第三方中出现问题的情况就越少。

最后，许多项目在其主页上有**持续集成**（**CI**）徽章。这些徽章让您可以一眼看出测试覆盖率（提醒一下：被测试覆盖的代码比例）、测试数量、最新版本等。显然，选择尽可能多测试和高测试覆盖率的项目来限制更新期间的问题会更好。

# 关于语义版本控制的一番话

说到更新，让我们谈谈版本控制和——特别是——语义版本控制。如果你想要使用的外部库遵循语义版本控制的规则，这可能会对你的开发和更新产生极其积极和令人放心的影响。让我们看看这究竟意味着什么。

## 什么是语义版本控制？

版本控制简单来说就是给源代码的版本加上一个数字。我们都熟悉像`1.0`、`1.5.0`、`2.0.0`这样的版本。语义版本控制为这些数字添加了语义——也就是说，精确的含义。以版本 2.3.15 为例。以下是语义版本控制如何分解这个版本号：

+   “2”表示主版本。主版本可以引入新功能、错误修复，并且——最重要的是——破坏向后兼容性的变更。这一点最为重要。确实，从一个主版本到另一个主版本，方法签名甚至完整的类名都可能发生变化，有些也可能消失。因此，当你迁移到高于当前版本的主版本时，你必须非常小心，并且必须测试一切是否仍然正常工作。通常，发布变更日志提供了你需要进行的更改，以便与新的主版本兼容。

+   “3”表示次版本。与主版本一样，次版本也可以引入新功能和错误修复。主要区别是次版本不能进行破坏向后兼容性的变更。这意味着你可以升级依赖到下一个次版本，以利用所有新功能和错误修复，而无需担心你的代码在升级时会中断。然而，在次版本更新时运行所有测试永远不会多余。你永远不知道。通常，次版本会触发代码弃用消息。这些消息告诉你哪些方法你不再应该使用，因为它们肯定会在下一个主版本中删除。在开发过程中考虑到这些弃用消息，当更新依赖到下一个主版本时，你可以节省很多工作。

+   “15”表示补丁号。补丁只包含错误修复和安全修复。它不包含新功能。你应该考虑*始终*在你的项目中安装依赖项的新补丁。

我们可以看到语义版本控制的优点：宁静、逻辑和一致性。显然还有其他变体，如 Alpha、Beta、发布候选和 Golden Master。但这些比较少见。

## 如何处理语义版本控制

语义版本控制还包括一种特定的标记法，允许你的依赖管理器知道如何安装新版本以及何时更新你的依赖。以 Composer 用于安装依赖项的文件片段为例（这同样适用于许多其他依赖管理器）:

```php
{
    "require": {
        "php": ">=7.3",
        "symfony/dotenv": "3.4.*",
        "symfony/event-dispatcher-contracts": "~1.1",
        "symfony/http-client": "⁴.2.2"
    }
}
```

这个片段描述了四个依赖项：PHP 的最小版本以及三个外部库。这些库具体是什么并不重要。我们在这里可以指出四种定义我们想要接受的依赖项版本的不同方法。让我们看看它们是什么。

观察到的版本的第一种写法是使用`>=`运算符。这个运算符是最容易理解的之一：我们希望接受所有大于或等于指定版本的版本。在这里，我们的应用程序接受所有高于版本 7.3 的 PHP 版本，以及版本 7.3 本身。当然，依赖关系管理器接受其他这样的运算符：`=`, `<`, `>`, 和 `<=`。您也可以组合这些运算符以获得非常精确的版本约束——例如，通过编写`“>=1.2.0 <2.0.0”`。

第二个运算符相当知名，因为它在许多其他上下文中都被使用。它是通配符，表示为`*`。这个符号简单地表示你可以用任何你想要的东西来替换它。在上面的例子中，我们接受依赖项 3.4 版本的补丁版本。这允许它仅从错误修复中受益，而不更新次要版本。这个通配符可以放在版本号中的任何位置。例如，表示`3.*`的记法将受益于主要版本 3 的所有次要版本。

以下记法是使用波浪线运算符，表示为`~`。这个运算符意味着你将只从给定版本的补丁中受益。在例子中，我们将从依赖项版本 1.1 的所有补丁版本中受益（即 1.1.0、1.1.1、1.1.2 等等）。这与通配符运算符非常相似，除了通配符运算符不能放在版本号的任何位置，并且只关注补丁。还值得注意的是，Composer 对波浪线有稍微不同的解释：它还允许次要版本，而不仅仅是补丁。如果你使用 Composer，并且只想从补丁版本中受益而不包括次要版本，你必须使用通配符运算符。

最后，我们将看到的最后一个运算符是撇号运算符，表示为`^`。在上面的例子中，撇号运算符允许所有补丁版本以及主要版本 4 的次要版本（即 4.2.2、4.2.3、4.4.0 等等）。如果你想定义一个依赖项的最小版本，同时接受新的补丁和次要版本，但在更新外部库时自动拒绝主要版本（这可能会带来破坏性变化），这是一个特别好的选择。这就是为什么它是最受欢迎的运算符之一。

可能性是无限的，一旦你掌握了这种表示法，你就可以自信地更新你项目的依赖项。至于良好的实践，接受依赖项的所有新补丁和小版本总是一个明智的想法。你永远不应该在没有条件或更新可能性的情况下将依赖项锁定到非常具体的版本。实际上，如果一个外部库严格遵守语义版本控制，你将不会与现有代码发生冲突。破坏性变化仅限于主要版本。因此，在更新依赖项时，你不应该自动接受主要版本：你可能会不得不调整你的代码以使其正常工作。

# 稳定性 versus 趋势

让我们用关于最新版本的一些话来结束这一章，但也要谈谈流行的外部技术和库。

首先，让我们谈谈外部库的最新版本。当然，我们可能会倾向于使用最新的版本，那些几个小时前刚刚发布的版本。值得记住的是，可能会出现错误，如果这种情况发生，不久的将来可能会发布一个新的补丁版本。或者也可能不会。在这种情况下，错误可能会持续一段时间。因此，编写测试尤为重要。想象一下这种舒适感：你更新了所有依赖项，你运行了你的测试套件，如果所有指示灯都是绿色的（并且你的应用程序得到了适当的测试），你就可以相当确信一切正常。

话虽如此，如果你更新了外部库，任何测试结果变成红色，你将不得不调查原因。在任何情况下，你不应该认为如果你的依赖项得到了很好的固定和约束，或者你只接受补丁和/或小版本，你就不会遇到任何问题。补丁也可能带来错误——你永远不知道。

至于 Alpha 版本，让我们明确一点：这些版本不是为生产应用程序准备的。不同的库对此都很清楚：代码可能会在一天之内发生变化，带来未警告的破坏性变化。简而言之，你必须非常小心。话虽如此，如果你想亲自评估这些版本，库的开发者将非常乐意收到你的反馈。Beta 版本应该更加稳定，不会带来更多的破坏性变化。使用它们时，你仍然必须非常小心。

作为一条一般规则，只有在生产环境中使用最终的、稳定的版本。如果你想为稳定发布的当天做好生产部署的准备，请将 Alpha 和 Beta 版本保留用于开发和测试环境。新特性总是令人兴奋的事情，但它们永远不值得牺牲你应用程序的稳定性。你的用户并不关心你使用的第三方库的新特性：只有稳定性才是最重要的——它就是能正常工作的事实。

现在，让我们来谈谈流行的技术（一个外部的 PHP 库、一个新工具，甚至是一种新的编程语言）。你听到周围的人都谈论某种特定的技术。这种技术像野火一样蔓延，你在互联网的每个角落都能听到关于它的消息，大公司都开始涉足其中，技术会议也都在讨论它。你必须对此类事物保持警惕。即使这些技术的承诺可能令人兴奋且具有革命性，首先考虑的应该是：你的用户。

这种技术是否真的会对你的最终用户产生影响？它真的值得培训并花费数周甚至数月来弄清楚它是如何工作的吗？你必须确信它将对你的项目产生真正的积极影响。你还必须记住，创新技术将拥有一个较小的社区。影响是即时的，正如以下所述：

+   你将不得不培训所有加入你项目的人

+   文档可能并不完整，这可能会使理解变得困难

+   你可能会发现自己独自坐在屏幕前，找不到解决问题的方法：你是这项技术的第一批使用者之一，因此也是第一批面临其遇到的障碍的人

最后，你必须确保项目是健壮的，这样你就不会在没有任何警告的情况下放弃最新的技术。这种情况比你想的更常见，而且（如果不是全部）你的工作可能都白费了。所以，要警惕最新的未经证实的科技，并确保项目的健壮性和严肃性。等待一段时间后再考虑。再次强调，你的用户肯定可以在这项技术成熟之前不使用它（他们甚至可能不知道这项技术）。

# 摘要

将 PHP 限制为编程语言是过于简化的。我们刚刚看到——它是一个真实且充满活力、丰富的生态系统，并且与埋葬其最喜欢的语言相去甚远。围绕 PHP 的发展是无数的，而且近年来，这种语言本身也在以最美好的方式进化。功能的贡献给了它真正的第二次生命，使它至今仍能在服务器端用于 Web 应用的最常用编程语言中占据首位。

所有这一切都离不开外部库数量的激增。你遇到问题；总有一个解决方案。我们很幸运，大多数外部库都是开源的。数千名开发者自愿且免费地提供了他们数小时、数周甚至数年的工作成果。

从这些库中选择一个可能会很困难且具有挑战性。在确保做出正确选择之前，进行实际的研究工作是非常重要的，甚至是强制性的。我们并非对障碍和事件免疫，但这一章节已经为你提供了工具和现成的解决方案来降低风险。最重要的是，不要盲目追求最时尚的技术。如果你想吸引用户并让他们比其他应用更频繁地使用你的应用程序，关键词是“健壮性”和“稳定性”！

我们已经讨论了很多关于别人的工作，但我们不应该忘记自己的成就。当你需要理解你最喜欢的外部库的内部工作原理时，你是如何设法在代码中找到自己的路径，就像你能够轻松地在源代码中找到路径一样？我们回到我们在第一章中提到的话：通过拥有相同的习惯，我们更容易理解彼此。这显然适用于项目的组织、文件的命名、文件夹的结构等等。这正是我们将在下一章中看到的内容。
