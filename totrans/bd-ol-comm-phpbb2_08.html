<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Programming phpBB"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Programming phpBB</h1></div></div></div><p>We’ve learned a lot about installing phpBB, configuring it, and customizing it to suit our community’s needs. It’s now time for the last, most advanced chapter of the book, describing what you need to know in order to program new custom phpBB features.</p><p>PHP programming knowledge and some SQL knowledge are pre-requisites for a good understanding of the chapter, but even if you’re not familiar with PHP, you can still skim through the examples, if only to whet your programming appetite. Who knows, maybe you’ll like what you see and decide to learn some more PHP.</p><p>This chapter is not a comprehensive guide to the phpBB programming experience, but instead will concentrate on the most used phpBB libraries and functions. The chapter starts with a simple "Hello phpBB World" script and slowly moves on to include more complicated examples. At the end of the chapter, you’ll develop an all-new phpBB script called "What’s Up?", which displays the recent topics from all the forums in your board on a single screen, while respecting the user-specific privileges.<a id="id273" class="indexterm"/>
</p><p>In this chapter you will learn about:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating the "Hello phpBB World!" script</li><li class="listitem" style="list-style-type: disc">Working with the database</li><li class="listitem" style="list-style-type: disc">Using phpBB messages</li><li class="listitem" style="list-style-type: disc">phpBBs multi-language system</li><li class="listitem" style="list-style-type: disc">Using phpBB templates</li><li class="listitem" style="list-style-type: disc">User authentication</li><li class="listitem" style="list-style-type: disc">Other handy phpBB functions and coding standards</li><li class="listitem" style="list-style-type: disc">Putting it all together to create a new phpBB add-on script</li></ul></div><div class="section" title="Hello phpBB World!"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec01"/>Hello phpBB World!</h1></div></div></div><p>It’s a tradition when you start learning a new programming language or technology; the first thing you learn to do is how to write a simple application that just displays "Hello World!". Let’s see how to do this in phpBB.<a id="id274" class="indexterm"/>
</p><p>First off, just to give you an idea of what the goal is, here’s the result of executing the Hello World script, displayed in a browser.</p><div class="mediaobject"><img src="graphics/1132_08_01.jpg" alt="Hello phpBB World!"/></div><p>Here’s the code to produce the result in the screenshot above.</p><div class="informalexample"><pre class="programlisting">&lt;?php
// set IN_PHPBB constant and include the initialization script
define(‘IN_PHPBB’, true);
$phpbb_root_path = ‘./’;
include($phpbb_root_path . ‘extension.inc’);
include($phpbb_root_path . ‘common.’.$phpEx);
// Start session management
$userdata = session_pagestart($user_ip, PAGE_INDEX);
init_userprefs($userdata);
// include page header
include($phpbb_root_path . ‘includes/page_header.’.$phpEx);
// say hello!
echo ‘&lt;div align="center"&gt;Hello, phpBB World!&lt;/div&gt;’;
// include page footer
include($phpbb_root_path . ‘includes/page_tail.’.$phpEx);
?&gt;
</pre></div><p>In order to reproduce this on your board, you just need to create a new blank text file named, for example,<code class="literal"> helloBB.php</code>, type the earlier code into the file, save it, and copy it to your board’s root folder. You can then access the newly created script with your preferred browser (if your board is located at<a class="ulink" href="http://www.yourdomain.com/forum"> http://www.yourdomain.com/forum</a>, you can go to<a class="ulink" href="http://www.yourdomain.com/forum/helloBB.php"> http://www.yourdomain.com/forum/helloBB.php</a> to access this script.</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note29"/>Note</h3><p>The source code for this file (and for all the examples in the chapter) can be downloaded from<a class="ulink" href="http://www.packtpub.com"> http://www.packtpub.com</a>.</p></div><p>Before reading the explanations, take a look at the code; take the time to read it and see if you can figure out what’s happening in the script.</p><p>The script is divided into<span class="emphasis"><em> five code blocks</em></span> delimited by empty lines. The actual work of the script is done in the<span class="emphasis"><em> fourth</em></span> block—that’s where the "Hello" is:</p><div class="informalexample"><pre class="programlisting">// say hello!
echo ‘&lt;div align="center"&gt;Hello, phpBB World!&lt;/div&gt;’;
</pre></div><p>The rest of the script is setting up the phpBB environment for the actual work to be performed. Every script that you write should have the same flow, so you can use this script as a prototype for all your future scripts and just replace the "working" part with the functionality you require. This being said, you don’t really need to know what’s happening outside the fourth block but if you’re curious, here’s some more information.</p><p>Here’s what’s happening in the<span class="emphasis"><em> first</em></span> block:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">On the first line, a constant called<code class="literal"> IN_PHPBB</code> is defined. This is a security measure that will be discussed in a bit more detail later in the chapter.</li><li class="listitem">Then the phpBB root directory is defined, which in this case is the current directory since the script is located in the phpBB root.</li><li class="listitem">Then a simple file called<code class="literal"> extension.inc</code> is included. It only defines the extension of the PHP files on the server. Most likely the extension will be<code class="literal"> .php</code>.</li><li class="listitem">In the last line of the first block, a really important file—<code class="literal">common.php</code>—is included. This script is responsible for the most of the phpBB environment setup and configuration. You can look into its source for more details, but just to have a general idea, this script is responsible for initializing the forum configuration, establishing a database connection, and including the other libraries and functions that phpBB cannot do without.</li></ol></div><p>The<span class="emphasis"><em> second</em></span> block of code is responsible for calling two functions that deal with the session data and user preferences. The<span class="emphasis"><em> third</em></span> and the<span class="emphasis"><em> fifth</em></span> blocks are including respectively the header and the footer of the phpBB graphical user interface. The header is everything you see on the screenshot that is<span class="emphasis"><em> before</em></span> the<code class="literal"> Hello, phpBB World!</code> line, and the footer is everything<span class="emphasis"><em> after</em></span> that. If you program a special script, for example a pop-up window script, you may not necessarily need the header and the footer.</p><p>Now that we know the basic structure of a phpBB script, let’s move ahead and retrieve some data from the database.</p></div></div>
<div class="section" title="Working with the Database"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec02"/>Working with the Database</h1></div></div></div><p>The database connectivity in phpBB is an important topic, so it needs special attention. This section gives you some background information about the database abstraction used in phpBB, and some examples of its use to retrieve data from your database.</p><div class="section" title="Database Abstraction"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec01"/>Database Abstraction</h2></div></div></div><p>As you know already, phpBB can work with different databases. To achieve this result without re-coding the whole system, phpBB employs a programming technique called<span class="strong"><strong> database abstraction</strong></span>. This simply means that there are several scripts (classes), specific for each supported database system that in a different way achieve the same result. In this case, the other phpBB scripts don’t need to know anything about the specific database system, they just call the functions (class methods) of the database abstraction class and it does the work on the specific database.<a id="id275" class="indexterm"/>
</p><p>For example, to execute an SQL query on a MySQL database, PHP scripts use the<code class="literal"> mysql_query()</code> function. To do the same on an MS Access database,<code class="literal"> odbc_exec()</code> is used. So, as part of the database abstraction mechanism, phpBB is defining individual classes that work on different database systems: one class for MySQL, one for MS Access, and so on for the other supported RDBMS. The classes have different implementations, but share the same "public interface", meaning all classes have the same set of functions (methods). So when you want to execute an SQL query, all you need to do is use the<code class="literal"> sql_query()</code> method from the phpBB database abstraction layer without having to understand how this method is implemented and what underlying database system is used. Abstracting and concentrating on the more important stuff, while leaving other classes responsible for some details—that’s the beauty of the object-oriented programming!</p><p>In the<code class="literal"> common.php</code> script (which we mentioned earlier) a database connection is established for you and the<code class="literal"> $db</code> variable is defined, containing an object of the appropriate database class. Again, you don’t care what type of database system is used; you only need to know the programming interface of the phpBB abstraction layer. This may sound like we’re going into more trouble learning additional functions and how they work, but this is in fact a good thing, because this way you code once and then reuse your code on any database supported by phpBB.</p><p>One last thing about the database abstraction—the use of standard SQL commands. If you use any SQL commands or functions specific to a particular RDBMS, then be aware that this functionality may not exist in other systems. This shouldn’t be a problem in general, because you don’t just switch between different databases every day, but it’s still something you should know.</p></div><div class="section" title="Database Abstraction Working"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec02"/>Database Abstraction Working</h2></div></div></div><p>Let’s take a look at an example of how the phpBB database abstraction layer works. You’ll create a script that shows a counter of how many words were used on the board forums so far. phpBB has a full text search system that stores all the used words into a database table. So for the purposes of the example, all you need to do is count the number of rows in this table.<a id="id276" class="indexterm"/>
</p><p>To help visualize what you’re aiming at, here’s the result of the script execution:</p><div class="mediaobject"><img src="graphics/1132_08_02.jpg" alt="Database Abstraction Working"/></div><p>Here’s the source code used to achieve it:</p><div class="informalexample"><pre class="programlisting">&lt;?php
// set IN_PHPBB constant and include the initialization script
define(‘IN_PHPBB’, true);
$phpbb_root_path = ‘./’;
include($phpbb_root_path . ‘extension.inc’);
include($phpbb_root_path . ‘common.’.$phpEx);
// Start session management
$userdata = session_pagestart($user_ip, PAGE_INDEX);
init_userprefs($userdata);
// include page header
include($phpbb_root_path . ‘includes/page_header.’.$phpEx);
// the main script work starts here
$sql = "SELECT COUNT(*) FROM " . SEARCH_WORD_TABLE;
$result = $db-&gt;sql_query($sql);
if ( !$result )
{
message_die(GENERAL_ERROR, ‘Cannot execute query’, ‘’, __LINE__, __FILE__, $sql);
}
$row = $db-&gt;sql_fetchrow();
$word_count = $row[0];
echo ‘&lt;div align="center"&gt;Hey, did you know that ‘. $word_count .’ words were used in my board so far!?&lt;/div&gt;’;
// end of the script work
// include page footer
include($phpbb_root_path . ‘includes/page_tail.’.$phpEx);
?&gt;
</pre></div><p>Save this code into a file called<code class="literal"> phpBBdb.php</code> (or get it from the book’s code download), copy the file to your phpBB root, and give it a try in your browser.</p><p>As you can see, this script follows the structure of the previous one, only the "working" part was changed. Let’s discuss this part a bit.</p><p>First we start with a SQL query to be executed.</p><div class="informalexample"><pre class="programlisting">$sql = "SELECT COUNT(*) FROM " . SEARCH_WORD_TABLE;
</pre></div><p>In this query,<code class="literal"> SEARCH_WORD_TABLE</code> is a constant that defines the name of the table that contains the full-text search data. If you remember, during the installation you could specify a table prefix for all the tables in the database. Using constants (such as<code class="literal"> SEARCH_WORD_TABLE, POSTS_TABLE</code>, and so on) instead of hard-coded table names allows phpBB to offer this feature. You can see how all database-related constants (as well as other constants) are defined by looking at the<code class="literal"> includes/constants.php</code> script. By default, the table prefix is<code class="literal"> phpbb_</code>, so after the constant is replaced with its value, the query will look like<code class="literal"> SELECT COUNT(*) FROM phpbb_search_wordlist</code>;.</p><p>Now let’s take a look at the next the next line of code.</p><div class="informalexample"><pre class="programlisting">$result = $db-&gt;sql_query($sql);
</pre></div><p>This line executes the SQL query calling the<code class="literal"> sql_query()</code> method of the instance of the appropriate DB abstraction class (which you didn’t need to worry about).</p><p>This is followed by:</p><div class="informalexample"><pre class="programlisting">if ( !$result )
{
message_die(GENERAL_ERROR, ‘Cannot execute query’, ‘’,
__LINE__, __FILE__, $sql);
}
</pre></div><p>These lines check whether the query was executed successfully. If not, an error message is displayed (you’ll find out more about the messages in a bit). After the query is successfully executed, it’s time to get the results of the execution. (The phpBB abstraction layer offers a variety of ways to do that, which will be discussed later.)</p><div class="informalexample"><pre class="programlisting">$row = $db-&gt;sql_fetchrow();
</pre></div><p>This line gets a row of results as an array and assigns it to a variable called<code class="literal"> $row</code>. In this case, only one row (record), actually only one field, is returned. So<code class="literal"> $row[0]</code> will contain the value that we want. The zero stands for offset zero in the row of returned results.</p><div class="informalexample"><pre class="programlisting">$word_count = $row[0];
</pre></div><p>The last thing left is to display the value using<code class="literal"> echo</code>.</p><div class="informalexample"><pre class="programlisting">echo ‘&lt;div align="center"&gt;Hey, did you know that ‘. $word_count .’ words were used in my board so far!?&lt;/div&gt;’;
</pre></div></div><div class="section" title="Using the phpBB Database Abstraction Layer"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec03"/>Using the phpBB Database Abstraction Layer</h2></div></div></div><p>We mentioned that there are several ways to retrieve data from the result of a query execution, after the query has been executed using<code class="literal"> sql_query()</code>. Let’s see the options.<a id="id277" class="indexterm"/>
</p><div class="section" title="Option 1"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec01"/>Option 1</h3></div></div></div><p>The example here used the<code class="literal"> sql_fetchrow()</code> method. This method returns the results as both enumerated and associative array. The keys of the associative array are the field names in the result set—the same result as above could have been achieved by using:</p><div class="informalexample"><pre class="programlisting">$word_count = $row[‘COUNT(*)’];
</pre></div><p>Clearly, the above is not very typing-friendly. A better option would be to use:</p><div class="informalexample"><pre class="programlisting">$word_count = $row[‘words’];
</pre></div><p>This will work if the query is slightly modified to use<code class="literal"> words</code> as an alias to<code class="literal"> COUNT(*)</code>:
</p><div class="informalexample"><pre class="programlisting">$sql = "SELECT COUNT(*) AS words FROM " . SEARCH_WORD_TABLE;
</pre></div></div><div class="section" title="Option 2"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec02"/>Option 2</h3></div></div></div><p>Another way to get results from an executed query is by using the<code class="literal"> sql_fetchrowset()</code> method. It works like<code class="literal"> sql_fetchrow()</code>, except that it returns the data for all the records matched by a query. If you use<code class="literal"> sql_fetchrow()</code>, you have to call this method in a loop until you reach the end of the result set, while<code class="literal"> sql_fetchrowset()</code> returns all results and you loop through an array of results. The second option is somewhat friendlier, but consumes more memory because it requires copying the result set into the memory as an array. It’s thus not recommended for use with queries that will return huge result sets, but is OK for smaller "everyday" queries.</p><p>To illustrate the difference, you can<code class="literal"> print_r()</code> the results of both functions. From<code class="literal"> sql_fetchrow()</code>, you’ll get something like:</p><div class="informalexample"><pre class="programlisting">Array
(
[0] =&gt; 71
[COUNT(*)] =&gt; 71
)
</pre></div><p>.. and from<code class="literal"> sql_fetchrowset()</code>, you’ll get:</p><div class="informalexample"><pre class="programlisting">Array
(
[0] =&gt; Array
(
[0] =&gt; 71
[COUNT(*)] =&gt; 71
)
)
</pre></div></div><div class="section" title="Option 3"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec03"/>Option 3</h3></div></div></div><p>Another way to get the result from an executed query is by using<code class="literal"> sql_fetchfield()</code>, which returns the result from one field only, and this field is referenced by name. To get the expected result from the previous example, you can use:</p><div class="informalexample"><pre class="programlisting">$word_count = $db-&gt;sql_fetchfield(‘COUNT(*)’);
</pre></div><p>If you don’t know the field name, but know its offset in the result-set row, you can use the<code class="literal"> sql_fieldname()</code> method as follows:</p><div class="informalexample"><pre class="programlisting">$word_count = $db-&gt;sql_fetchfield($db-&gt;sql_fieldname(0));
</pre></div><p>Here again zero is the offset of the field you’re interested in.</p></div></div></div>
<div class="section" title="Using phpBB Messages"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec03"/>Using phpBB Messages</h1></div></div></div><p>In the previous example, you already saw how phpBB messages are used. Now it’s time to take a closer look at those messages and test them in action.</p><p>In order to see a phpBB message in action, you can simply use the previous example, but this time, introduce an invalid command in the SQL string; for example:<a id="id278" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">$sql = "HEY, GO AHEAD AND SELECT COUNT(*) FROM " . SEARCH_WORD_TABLE;
</pre></div><p>If you save the file that you’ve just modified as<code class="literal"> phpBBmessage.php</code> and preview it in your browser, you’ll see an error message caused by the invalid SQL string.</p><div class="mediaobject"><img src="graphics/1132_08_03.jpg" alt="Using phpBB Messages"/></div><p>This message was caused by the following piece of code from the example:</p><div class="informalexample"><pre class="programlisting">if ( !$result )
{
message_die(GENERAL_ERROR, ‘Cannot execute query’, ‘’, __LINE__, __FILE__, $sql);
}
</pre></div><p>Here the<code class="literal"> message_die()</code> function available in phpBB was used. You see all the details of the error because the forum runs in debug mode. When in production (when your forum is live) it’s a good idea to have the debug mode turned off. You can do this by changing a line in the<code class="literal"> constants.php</code> script, located in the<code class="literal"> includes</code> folder. The debug setup code is located at the very top of the<code class="literal"> constants.php</code> script. Make sure the<code class="literal"> DEBUG</code> constant is set to<code class="literal"> 0</code>, as follows:</p><div class="informalexample"><pre class="programlisting">// Debug Level
//define(‘DEBUG’, 1); // Debugging on
define(‘DEBUG’, 0); // Debugging off
</pre></div><p>If the debug mode is disabled, the above message will be much less verbose:</p><div class="mediaobject"><img src="graphics/1132_08_04.jpg" alt="Using phpBB Messages"/></div><p>The<code class="literal"> message_die()</code> phpBB function can be used for purposes other than for error messages. For instance, it can be used to display much nicer results from the database example discussed in the previous section of this chapter (<code class="literal">helloBBdb.php</code>). In this database example, change the line:</p><div class="informalexample"><pre class="programlisting">echo ‘&lt;div align="center"&gt;Hey, did you know that ‘. $word_count .’ words were used in my board so far!?&lt;/div&gt;’;
</pre></div><p>to:</p><div class="informalexample"><pre class="programlisting">message_die(GENERAL_MESSAGE,
‘Hey, did you know that ‘. $word_count .’ words were used in my board so far!?’,
‘Word count’);
</pre></div><p>Save this as<code class="literal"> helloBBmessage2.php</code> and view it in your browser. The result will be:</p><div class="mediaobject"><img src="graphics/1132_08_05.jpg" alt="Using phpBB Messages"/></div><p>Here’s some information about the six function parameters you can use when calling<code class="literal"> message_die()</code>:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Message type</strong></span>: Can be<code class="literal"> GENERAL_MESSAGE, CRITICAL_MESSAGE, GENERAL_ERROR</code>, or<code class="literal"> CRITICAL_ERROR</code>, depending on the severity of the message.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Message text</strong></span>: Can be anything you want to communicate to the user.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Message title</strong></span>: If you dont supply it, a default title will be used based on the message type. In the last example, the title was<span class="strong"><strong> Word count</strong></span>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Error line</strong></span> (for debug mode only): This contains the line in the script where the error occurred. The way to pass this parameter is just to use the<code class="literal"> __LINE__</code> PHP core constant.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Error file</strong></span>: (for debug mode only): This is the filename of the script that caused the error. As with the previous parameter, just use<code class="literal"> __FILE__</code> here.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>SQL</strong></span>: SQL string (if any) related to the error.</li></ul></div><p>Of all the function parameters, only the first (message type) is a required parameter: the rest are optional.</p></div>
<div class="section" title="Using phpBB&#x2019;s Multi-Language System"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec04"/>Using phpBB’s Multi-Language System</h1></div></div></div><p>In the previous examples, a few texts were displayed to the user. The problem with these texts was that they were in English only, and might not be understood by visitors who browse your forums in a language other than English. To offer multi-lingual support your custom scripts, you can make use of phpBB’s multi-language system.</p><p>The language folder of your phpBB installation contains sub-folders for each installed language, like<code class="literal"> lang_english, lang_spanish</code>, etc. These folders have a number of files, but the one you’ll be interested in the most, is called<code class="literal"> lang_main.php</code>. This file contains static texts, defined as elements of an associative array called<code class="literal"> $lang</code>. For example:</p><div class="informalexample"><pre class="programlisting">$lang[‘Guest’] = ‘Guest’;
$lang[‘Post_subject’] = ‘Post subject’;
$lang[‘View_next_topic’] = ‘View next topic’;
</pre></div><p>At the end of this file (before the "That’s<code class="literal"> all, Folks!"</code> comment) you can add your texts as new array elements. In the previous example (<code class="literal">helloBBmessage2.php</code>) two texts were used:<code class="literal"> Word count</code> and<code class="literal"> Hey, did you know that</code>
<span class="emphasis"><em> (number of words here)</em></span>
<code class="literal"> words were used in my board so far!?</code>. You can define them in<code class="literal"> lang_main.php</code> as follows:</p><div class="informalexample"><pre class="programlisting">$lang[‘Word_count_title’] = ‘Word count’;
$lang[‘Word_count_message’] = ‘Hey, did you know that &lt;strong&gt;%d&lt;/strong&gt; words were used in my board so far!?’;
</pre></div><p><code class="literal">%d</code> is used as a placeholder for the actual number of words, and it’s to be replaced in your script. You can use anything as a replaceable placeholder, but phpBB team has adopted the usage of the PHP<code class="literal"> printf()</code> function. For details on how<code class="literal"> printf()</code> and<code class="literal"> sprintf()</code> work, you can consult the PHP manual entries at <a class="ulink" href="http://php.net/printf">http://php.net/printf</a> and <a class="ulink" href="http://php.net/sprintf">http://php.net/sprintf</a>.</p><p>You’ve probably spotted a slight change in the text of the message. Well, just to make the message a bit different and at the same time to test how HTML is supported, the word count value<code class="literal"> %d</code> was enclosed with the <code class="literal">&lt;strong&gt;</code> HTML tags to emphasize the number of words.</p><p>Now that your texts are in the<code class="literal"> lang_main.php</code> file, they will be initialized automatically every time your script is accessed. So you can use them in your script by changing the call to<code class="literal"> message_die()</code> to the following:</p><div class="informalexample"><pre class="programlisting">message_die(GENERAL_MESSAGE,
sprintf($lang[‘Word_count_message’], $word_count),
$lang[‘Word_count_title’]);
</pre></div><p>Here’s a complete listing of the modified script. You can save it as<code class="literal"> helloBBlangs.php</code> and test it on your board. Don’t forget the changes to<code class="literal"> lang_main.php</code> and, if your board uses multiple languages, don’t forget that you need to translate the texts and add them to the<code class="literal"> lang_main.php</code> script in the corresponding languages’ directories.</p><div class="informalexample"><pre class="programlisting">&lt;?php
// set IN_PHPBB constant and include the initialization script
define(‘IN_PHPBB’, true);
$phpbb_root_path = ‘./’;
include($phpbb_root_path . ‘extension.inc’);
include($phpbb_root_path . ‘common.’.$phpEx);
// Start session management
$userdata = session_pagestart($user_ip, PAGE_INDEX);
init_userprefs($userdata);
// include page header
include($phpbb_root_path . ‘includes/page_header.’.$phpEx);
// the main script work starts here
$sql = "SELECT COUNT(*) FROM " . SEARCH_WORD_TABLE;
$result = $db-&gt;sql_query($sql);
if ( !$result )
{
message_die(GENERAL_ERROR, ‘Cannot execute query’, ‘’, __LINE__, __FILE__, $sql);
}
$row = $db-&gt;sql_fetchrow();
$word_count = $row[0];
message_die(GENERAL_MESSAGE,
sprintf($lang[‘Word_count_message’], $word_count),
$lang[‘Word_count_title’]);
// end of the script work
// include page footer
include($phpbb_root_path . ‘includes/page_tail.’.$phpEx);
?&gt;
</pre></div><p>Here’s the result of executing<code class="literal"> helloBBlangs.php</code>:
</p><div class="mediaobject"><img src="graphics/1132_08_06.jpg" alt="Using phpBB’s Multi-Language System"/></div></div>
<div class="section" title="Using phpBB Templates"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec05"/>Using phpBB Templates</h1></div></div></div><p>In the previous examples, there wasn’t much graphical user interface work involved, but normally there will be, if you’re developing new phpBB scripts or extending existing ones. Separating the programming code from the user interface is generally a good programming practice, often referred to as a "separation of logic from presentation". For web applications such as phpBB, this means having the PHP code and logic separated from the HTML code that is used to present the results to the user.</p><p>This is normally achieved by using the so called<span class="strong"><strong> templating systems</strong></span> (templating engines), which consist of two parts:<a id="id279" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Static HTML template files that contain the rules of displaying the content; "rules" mean formatting, layout, and so on</li><li class="listitem" style="list-style-type: disc">PHP logic to "fill-in the blanks" in the HTML templates</li></ul></div><p>Using a templating engine allows for changing the face of a bulletin board completely, by changing the static HTML files only and not dealing with the programming logic, database access, and so on. Creating new templates was discussed in detail in <a class="link" href="ch04.html" title="Chapter 4. Customizing Your Forum">Chapter 4</a>.</p><p>phpBB has its own templating engine, which is discussed here in order to give you a basic understanding on how to use it in your scripts.</p><p>You can find the template library script (<code class="literal">template.php</code>) in the<code class="literal"> includes</code> folder. This file contains the definition (the code) for a class called<code class="literal"> Template</code> and you can see its implementation if you’re interested. For the purposes of coding phpBB scripts, you only need to know how to use the library and not how it’s actually coded (remember, that’s the beauty of the object-oriented coding approach).</p><p>In order to use the template class, an instance (an object) of that class needs to be created. There is such an object created for you as part of the phpBB environment setup. As soon as you include the page header script, a variable called<code class="literal"> $template</code> is initialized and it contains an object of the<code class="literal"> Template</code> class.</p><div class="section" title="A Simple Example"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec04"/>A Simple Example</h2></div></div></div><p>It is time to create a brand new, simple template. Create (or copy from the book code download) the following file (call it<code class="literal"> wordcount.tpl</code> and place it in the<code class="literal"> templates/subSilver</code> directory):<a id="id280" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">&lt;span class="nav"&gt;&lt;a href="{U_INDEX}" class="nav"&gt;{L_INDEX}&lt;/a&gt;&lt;/span&gt;
&lt;div
align="center"
class="gen"
style="border: solid 2px #006699; padding: 10px; margin-top: 5px;"
&gt;
{WORD_COUNT_MESSAGE}
&lt;/div&gt;
</pre></div><p>Before proceeding with the PHP code, take a look at the following screenshot; it shows the result of executing the example.</p><div class="mediaobject"><img src="graphics/1132_08_07.jpg" alt="A Simple Example"/></div><p>The template specified earlier is responsible only for the following part of the screenshot:</p><div class="mediaobject"><img src="graphics/1132_08_08.jpg" alt="A Simple Example"/></div><p>The rest is displayed by the default header and footer.</p><p>Let’s see how to achieve this result. There are three parts to using the templating functionality in your scripts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">First you specify the filename(s) that contain the static HTML, using<code class="literal"> $template-&gt;set_filenames()</code>.</li><li class="listitem" style="list-style-type: disc">Then you use PHP to replace the template variables with data by calling<code class="literal"> $template-&gt;assign_vars()</code> or<code class="literal"> $template-&gt;assign_block_vars()</code>. Having read <a class="link" href="ch04.html" title="Chapter 4. Customizing Your Forum">Chapter 4</a>, youre already familiar with the template variables and their syntax; they are enclosed by curly brackets and capitalized, like<code class="literal"> {I_AM_A_VAR}</code>.</li><li class="listitem" style="list-style-type: disc">Finally you call the<code class="literal"> $template-&gt;pparse()</code> method to display the result.</li></ul></div><p>Here’s the PHP code that uses the<code class="literal"> wordcount.tpl</code> template listed earlier:</p><div class="informalexample"><pre class="programlisting">// assemble the message text
$message_text = sprintf($lang[‘Word_count_message’], $word_count);
// set template file
$template-&gt;set_filenames(array(‘body’ =&gt; ‘wordcount.tpl’));
// assign template variables
$template-&gt;assign_vars(
array(
‘WORD_COUNT_MESSAGE’ =&gt; $message_text,
)
);
// process, parse and display
$template-&gt;pparse(‘body’);
</pre></div><p>There are two more template variables that were displayed in the result but were not assigned values using<code class="literal"> $template-&gt;assign_vars()</code>—<code class="literal">U_INDEX</code> and<code class="literal"> L_INDEX</code>. The reason you don’t need to worry about them is that they were already assigned when the page header was processed. For more information and a full listing of the behind-the-scenes processed variables, open the<code class="literal"> includes/page_header.php</code> script and scroll down to near the bottom of the file where the template variables are assigned.</p><p>To test the example, create a<code class="literal"> helloBBtemplates.php</code> file with the following code and navigate to it in your browser (don’t forget to also copy the<code class="literal"> wordcount.tpl</code> template into the<code class="literal"> templates/subSilver</code> directory):</p><div class="informalexample"><pre class="programlisting">&lt;?php
// set IN_PHPBB constant and include the initialization script
define(‘IN_PHPBB’, true);
$phpbb_root_path = ‘./’;
include($phpbb_root_path . ‘extension.inc’);
include($phpbb_root_path . ‘common.’.$phpEx);
// Start session management
$userdata = session_pagestart($user_ip, PAGE_INDEX);
init_userprefs($userdata);
// include page header
include($phpbb_root_path . ‘includes/page_header.’.$phpEx);
// the main script work starts here
$sql = "SELECT COUNT(*) FROM " . SEARCH_WORD_TABLE;
$result = $db-&gt;sql_query($sql);
if ( !$result )
{
message_die(GENERAL_ERROR, ‘Cannot execute query’, ‘’, __LINE__, __FILE__, $sql);
}
$row = $db-&gt;sql_fetchrow();
$word_count = $row[0];
// assemble the message text
$message_text = sprintf($lang[‘Word_count_message’], $word_count);
// set template file
$template-&gt;set_filenames(array(‘body’ =&gt; ‘wordcount.tpl’));
// assign template variables
$template-&gt;assign_vars(
array(
‘WORD_COUNT_MESSAGE’ =&gt; $message_text,
)
);
// process, parse and display
$template-&gt;pparse(‘body’);
// end of the script work
// include page footer
include($phpbb_root_path . ‘includes/page_tail.’.$phpEx);
?&gt;
</pre></div></div><div class="section" title="Using Loops in phpBB Templates"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec05"/>Using Loops in phpBB Templates</h2></div></div></div><p>Often, assigning static template variables is not enough; you’ll need the ability to perform dynamic assignments like using loops within a template (for example, listing all topics in a forum is performing a loop, listing all replies to a topic is also a loop, and so on). Let’s consider an example to see how you can use loops.</p><p>The example displays the numbers from one to ten. To set up the loop in the template, use the<span class="strong"><strong> block variable</strong></span> syntax.<a id="id281" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">&lt;!-- BEGIN number_loop --&gt;
{number_loop.NUMBER}
&lt;!-- END number_loop --&gt;
</pre></div><p>Here<code class="literal"> number_loop</code> is the name of the block and<code class="literal"> NUMBER</code> is a variable. Note the dotted syntax to refer to a variable within a loop like<code class="literal"> {number_loop.NUMBER}</code>. To make it a bit more interesting and to understand the difference between a variable within a block and outside a block, add another<code class="literal"> {NUMBER}</code> variable, but this time not related to the loop. It will have a constant value during the loop iterations.</p><p>Here’s the listing of the template (save it to a file called<code class="literal"> example2.tpl</code> and place it in<code class="literal"> templates/subSilver)</code>:
</p><div class="informalexample"><pre class="programlisting">&lt;span class="nav"&gt;&lt;a href="{U_INDEX}" class="nav"&gt;{L_INDEX}&lt;/a&gt;&lt;/span&gt;
&lt;div
align="center"
class="gen"
style="border: solid 2px #006699; padding: 10px; margin-top: 5px;"
&gt;
&lt;!-- BEGIN number_loop --&gt;
{NUMBER}{number_loop.NUMBER}
&lt;!-- END number_loop --&gt;
&lt;/div&gt;
</pre></div><p>Here’s the PHP script (<code class="literal">helloBBtemplates2.php</code>) to parse the template:</p><div class="informalexample"><pre class="programlisting">&lt;?php
// set IN_PHPBB constant and include the initialization script
define(‘IN_PHPBB’, true);
$phpbb_root_path = ‘./’;
include($phpbb_root_path . ‘extension.inc’);
include($phpbb_root_path . ‘common.’.$phpEx);
// Start session management
$userdata = session_pagestart($user_ip, PAGE_INDEX);
init_userprefs($userdata);
// include page header
include($phpbb_root_path . ‘includes/page_header.’.$phpEx);
// the main script work starts here
// set template file
$template-&gt;set_filenames(array(‘body’ =&gt; ‘example2.tpl’));
// assign template variables in a loop
for ($i = 1; $i&lt;=10; $i++)
{
$template-&gt;assign_block_vars("number_loop",
array(
‘NUMBER’ =&gt; $i,
)
);
}
// assign a static variable
$template-&gt;assign_vars(
array(
‘NUMBER’ =&gt; ‘#’,
)
);
// process, parse and display
$template-&gt;pparse(‘body’);
// end of the script work
// include page footer
include($phpbb_root_path . ‘includes/page_tail.’.$phpEx);
?&gt;
</pre></div><p>The result of executing<code class="literal"> helloBBtemplates2.php</code> in a browser:</p><div class="mediaobject"><img src="graphics/1132_08_09.jpg" alt="Using Loops in phpBB Templates"/></div></div><div class="section" title="Using Conditions in phpBB Templates"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec06"/>Using Conditions in phpBB Templates</h2></div></div></div><p>Sometimes you’ll want to display data to the user conditionally, depending on some "if" case (a "switch"). To do this using the phpBB templating engine, use the same<span class="strong"><strong> block variables</strong></span> as when working with loops.<a id="id282" class="indexterm"/>
</p><p>The next example is quite similar to the previous one; it lists the numbers from one to ten. But it uses an "if" case for even numbers in order to display them in bold font.</p><p>Here’s the template. Save it as<code class="literal"> example3.tpl</code> in<code class="literal"> templates/subSilver</code>:
</p><div class="informalexample"><pre class="programlisting">&lt;span class="nav"&gt;&lt;a href="{U_INDEX}" class="nav"&gt;{L_INDEX}&lt;/a&gt; &lt;/span&gt;
&lt;div
align="center"
class="gen"
style="border: solid 2px #006699; padding: 10px; margin-top: 5px;"
&gt;
&lt;!-- BEGIN number_loop --&gt;
&lt;!-- BEGIN odd_switch --&gt;
{NUMBER}{number_loop.odd_switch.NUMBER}
&lt;!-- END odd_switch --&gt;
&lt;!-- BEGIN even_switch --&gt;
&lt;strong&gt;{NUMBER}{number_loop.even_switch.NUMBER}&lt;/strong&gt;
&lt;!-- END even_switch --&gt;
&lt;!-- END number_loop --&gt;
&lt;/div&gt;
</pre></div><p>Because you have nested blocks (a switch block within a loop block), when you reference a variable from the inner block, you need to specify both blocks’ names, separated by a dot, like<code class="literal"> {number_loop.odd_switch.NUMBER}</code>. Also note that there is no separate test for the even case—you simply use<code class="literal"> else</code> to introduce an alternative block of code.</p><p>Here is the listing of the PHP script (save it as<code class="literal"> helloBBtemplates3.php</code> in your root phpBB folder):</p><div class="informalexample"><pre class="programlisting">&lt;?php
// set IN_PHPBB constant and include the initialization script
define(‘IN_PHPBB’, true);
$phpbb_root_path = ‘./’;
include($phpbb_root_path . ‘extension.inc’);
include($phpbb_root_path . ‘common.’.$phpEx);
// Start session management
$userdata = session_pagestart($user_ip, PAGE_INDEX);
init_userprefs($userdata);
// include page header
include($phpbb_root_path . ‘includes/page_header.’.$phpEx);
// the main script work starts here
// set template file
$template-&gt;set_filenames(array(‘body’ =&gt; ‘example3.tpl’));
// assign template variables in a loop
for ($i = 0; $i &lt;= 10; $i++)
{
if ( $i % 2 )
{
$template-&gt;assign_block_vars("number_loop.odd_switch",
array(
‘NUMBER’ =&gt; $i,
)
);
} else {
$template-&gt;assign_block_vars("number_loop.even_switch",
array(
‘NUMBER’ =&gt; $i,
)
);
}
}
// assign a static variable
$template-&gt;assign_vars(
array(
‘NUMBER’ =&gt; ‘#’,
)
);
// process, parse and display
$template-&gt;pparse(‘body’);
// end of the script work
// include page footer
include($phpbb_root_path . ‘includes/page_tail.’.$phpEx);
?&gt;
</pre></div><p>Here’s the script in action:</p><div class="mediaobject"><img src="graphics/1132_08_10.jpg" alt="Using Conditions in phpBB Templates"/></div><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note30"/>Note</h3><p>To round off your knowledge on the phpBB templating engine, there is a comprehensive knowledge-base article at <a class="ulink" href="http://www.phpbb.com/kb/article.php?article_id=200">http://www.phpbb.com/kb/article.php?article_id=200</a>.</p></div></div></div>
<div class="section" title="User Authentication"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec06"/>User Authentication</h1></div></div></div><p>When you develop new scripts or extend existing ones, it’s likely that you’ll need a way to verify a user’s privileges (in other words, check if a user is allowed to do or view what your script provides); for example, if you develop a script to display postings from a hidden forum, you’ll need to make sure that only users that are allowed access to this forum can see the postings.</p><p>There is one important user authentication function that is defined in<code class="literal"> includes/auth.php</code>—the <code class="literal">auth()</code> function.</p><p>The<code class="literal"> auth()</code> function returns an associative array that contains information about the privileges that are checked. You can check for individual privileges (permission types), like permission to view, read, post, vote, and so on; you can even check for all permission types at once. You can also check for privileges in a specific forum or in all forums.<a id="id283" class="indexterm"/>
</p><p>There are three required parameters when you use the<code class="literal"> auth()</code> function:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Permission type</strong></span>: The possible values are the constants<code class="literal"> AUTH_VIEW, AUTH_READ, AUTH_POST, AUTH_REPLY, AUTH_EDIT, AUTH_DELETE, AUTH_STICKY, AUTH_ANNOUNCE, AUTH_VOTE, AUTH_POLLCREATE</code>, or (to check for all permission types)<code class="literal"> AUTH_ALL</code>.<a id="id284" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Forum ID</strong></span>: If you want to check for privileges in a specific forum, you specify its ID. To check for permissions in all forums, you use the<code class="literal"> AUTH_LIST_ALL</code> constant.<a id="id285" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>User data</strong></span>: An array of user information. You dont need to worry about this; there is a<code class="literal"> $userdata</code> variable defined at the beginning of every script, in the session management part. So you just need to pass this variable as is.<a id="id286" class="indexterm"/></li></ul></div><p>The<code class="literal"> auth()</code> function returns the results as associative arrays. Let’s look at a few examples of how<code class="literal"> auth()</code> can be used in order to get a better idea of the return values.</p><div class="section" title="Using the Authentication Function"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec07"/>Using the Authentication Function</h2></div></div></div><p>You can use the following code to play around and test how the authentication function works and what types of values it returns. Save this code as<code class="literal"> helloBBauth.php</code> and load it in your browser:<a id="id287" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">&lt;?php
// set IN_PHPBB constant and include the initialization script
define(‘IN_PHPBB’, true);
$phpbb_root_path = ‘./’;
include($phpbb_root_path . ‘extension.inc’);
include($phpbb_root_path . ‘common.’.$phpEx);
// Start session management
$userdata = session_pagestart($user_ip, PAGE_INDEX);
init_userprefs($userdata);
// include page header
include($phpbb_root_path . ‘includes/page_header.’.$phpEx);
// check auth
$user_privileges = auth(AUTH_ALL, AUTH_LIST_ALL, $userdata);
// display the return value
echo ‘&lt;pre&gt;’;
print_r($user_privileges);
echo ‘&lt;/pre&gt;’;
// include page footer
include($phpbb_root_path . ‘includes/page_tail.’.$phpEx);
?&gt;
</pre></div><p>This script contains a call to the<code class="literal"> auth()</code> function and then displays the results of the execution. You can start changing the parameters you pass to the<code class="literal"> auth()</code> function and see how the return values are changed. You can also log in as a normal user, then log in as a moderator or an administrator, and then log out and see how the return values change.</p><p>Let’s say your forum has a forum ID equal to 1, and this forum is set up as a<span class="strong"><strong> registered</strong></span> forum, meaning that in the<span class="strong"><strong> Administration Panel | Forum Admin | Permissions</strong></span>, its permissions were set to<span class="strong"><strong> Registered</strong></span> using<span class="strong"><strong> Simple Mode</strong></span>. This means that a user has to register and log in to be able to post. In this case to check the user privileges you can change the call to the<code class="literal"> auth()</code> function in the previous example to:</p><div class="informalexample"><pre class="programlisting">$user_privileges = auth(AUTH_ALL, 1, $userdata);
</pre></div><p>If you save the modified script as<code class="literal"> helloBBauth2.php</code> and load it in your browser, you’ll see the return value as:</p><div class="informalexample"><pre class="programlisting">Array
(
[auth_view] =&gt; 1
[auth_view_type] =&gt; anonymous users
[auth_read] =&gt; 1
[auth_read_type] =&gt; anonymous users
[auth_post] =&gt; 0
[auth_post_type] =&gt; registered users
[auth_reply] =&gt; 0
[auth_reply_type] =&gt; registered users
[auth_edit] =&gt; 0
[auth_edit_type] =&gt; registered users
[auth_delete] =&gt; 0
[auth_delete_type] =&gt; registered users
[auth_sticky] =&gt; 0
[auth_sticky_type] =&gt; moderators
[auth_announce] =&gt; 0
[auth_announce_type] =&gt; moderators
[auth_vote] =&gt; 0
[auth_vote_type] =&gt; registered users
[auth_pollcreate] =&gt; 0
[auth_pollcreate_type] =&gt; registered users
[auth_mod] =&gt; 0
)
</pre></div><p>This result is displayed when you’re not logged in. You see that only the<code class="literal"> auth_view</code> and<code class="literal"> auth_read</code> indices in the return value are set to<code class="literal"> 1</code>, the rest are<code class="literal"> 0</code>. This means that when you’re not logged in, you only have the privilege to see that this forum exists and to read it.</p><p>Now if you log in as a regular user and visit<code class="literal"> helloBBauth2.php</code> again, you’ll see different return values:</p><div class="informalexample"><pre class="programlisting">Array
(
[auth_view] =&gt; 1
[auth_view_type] =&gt; anonymous users
[auth_read] =&gt; 1
[auth_read_type] =&gt; anonymous users
[auth_post] =&gt; 1
[auth_post_type] =&gt; registered users
[auth_reply] =&gt; 1
[auth_reply_type] =&gt; registered users
[auth_edit] =&gt; 1
[auth_edit_type] =&gt; registered users
[auth_delete] =&gt; 1
[auth_delete_type] =&gt; registered users
[auth_sticky] =&gt; 0
[auth_sticky_type] =&gt; moderators
[auth_announce] =&gt; 0
[auth_announce_type] =&gt; moderators
[auth_vote] =&gt; 1
[auth_vote_type] =&gt; registered users
[auth_pollcreate] =&gt; 1
[auth_pollcreate_type] =&gt; registered users
[auth_mod] =&gt; 0
)
</pre></div><p>As you can see, now the only permission types set to<code class="literal"> 0</code> are<code class="literal"> auth_mod, auth_sticky</code>, and<code class="literal"> auth_announce</code>, because being logged as a regular user, you cannot moderate the forum or post stickies or announcements.</p></div><div class="section" title="Checking for Poll-Creation Privileges"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec08"/>Checking for Poll-Creation Privileges</h2></div></div></div><p>If all these associative array return values are giving you a headache, here’s a friendlier way of displaying results from the calls to the<code class="literal"> auth()</code> function. This example (<code class="literal">helloBBauth3.php</code>) tells you whether you can create polls in the forum with forum ID equal to 1. Test it when you’re logged in and then when you’re logged out.<a id="id288" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">&lt;?php
// set IN_PHPBB constant and include the initialization script
define(‘IN_PHPBB’, true);
$phpbb_root_path = ‘./’;
include($phpbb_root_path . ‘extension.inc’);
include($phpbb_root_path . ‘common.’.$phpEx);
// Start session management
$userdata = session_pagestart($user_ip, PAGE_INDEX);
init_userprefs($userdata);
// include page header
include($phpbb_root_path . ‘includes/page_header.’.$phpEx);
// check auth
$user_privileges = auth(AUTH_POLLCREATE, 1, $userdata);
// display the result of the authentication
$message = ‘’;
if ( $user_privileges[‘auth_pollcreate’] == 1 )
{
$message = ‘Great news! You can create polls in forum id #1!’;
} else {
$message = ‘When you login, you\’ll be able to create polls in forum id #1.’;
}
message_die(GENERAL_MESSAGE, $message, ‘Auth test’);
// include page footer
include($phpbb_root_path . ‘includes/page_tail.’.$phpEx);
?&gt;
</pre></div><p>If you’re logged in when you visit<code class="literal"> helloBBauth3.php</code>, you’ll see the following message:</p><div class="mediaobject"><img src="graphics/1132_08_11.jpg" alt="Checking for Poll-Creation Privileges"/></div><p>When you log out and come to the same page again, you’ll see a changed message:</p><div class="mediaobject"><img src="graphics/1132_08_11.jpg" alt="Checking for Poll-Creation Privileges"/></div><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note31"/>Note</h3><p>Some code comments that serve as documentation on how the<code class="literal"> auth()</code> function can be used; you can find these code comments before the function definition, at the top of the<code class="literal"> includes/auth.php</code> file in your phpBB installation.</p></div><p>This section describes some other phpBB functions that may come in handy. The functions listed are of two types: general functions (mostly contained in<code class="literal"> includes/functions.php</code>), and posting-related functions that deal with processing BB code and smilies (these functions are defined in<code class="literal"> includes/bbcode.php</code>). At the end of this section, there are some phpBB-specific coding guidelines and standards.</p></div><div class="section" title="Miscellaneous Functions"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec09"/>Miscellaneous Functions</h2></div></div></div><p>These are some general-purpose functions that are shipped with phpBB.</p><div class="section" title="Getting Board Statistics"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec04"/>Getting Board Statistics</h3></div></div></div><p>Use this function to retrieve some board statistics data:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>get_db_stat($mode)</strong></span>
</pre></div><p>The type of data this function returns depends of the parameter passed to it. This function can take only one of four pre-defined strings as a parameter. Here are the parameters, along with the returned values from the function (the last two options will give the stats for all forums, including hidden ones):</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">usercount</code>: When this parameter is passed, the function will return the total number of registered users.</li><li class="listitem" style="list-style-type: disc"><code class="literal">newestuser</code>: When this is passed, the function will return an array with keys<code class="literal"> username</code> and<code class="literal"> user_id</code> containing the most recent registered user.</li><li class="listitem" style="list-style-type: disc"><code class="literal">postcount</code>: This will give you the total number of posts.</li><li class="listitem" style="list-style-type: disc"><code class="literal">topiccount</code>: This will give you the total number of topics created in your forums.</li></ul></div><p>Here’s an example usage of this function:</p><div class="informalexample"><pre class="programlisting">&lt;?php
// set IN_PHPBB constant and include the initialization script
define(‘IN_PHPBB’, true);
$phpbb_root_path = ‘./’;
include($phpbb_root_path . ‘extension.inc’);
include($phpbb_root_path . ‘common.’.$phpEx);
// Start session management
$userdata = session_pagestart($user_ip, PAGE_INDEX);
init_userprefs($userdata);
// include page header
include($phpbb_root_path . ‘includes/page_header.’.$phpEx);
// the main script work starts here
$newest_user = <span class="strong"><strong>get_db_stat("newestuser");</strong></span>
message_die(
GENERAL_MESSAGE,
‘My board has ‘
<span class="strong"><strong>. get_db_stat("usercount")</strong></span> . ‘ users, ‘
<span class="strong"><strong>. get_db_stat("postcount")</strong></span> . ‘ postings and ‘
. get_db_stat("topiccount") . ‘ topics. ‘
. ‘Say \’Hi\’ to the newest member - ‘
. $newest_user[‘username’] . ‘!’,
‘Board stats - get_db_stats() demo’
);
// include page footer
include($phpbb_root_path . ‘includes/page_tail.’.$phpEx);
?&gt;
</pre></div><p>The output:</p><div class="mediaobject"><img src="graphics/1132_08_12.jpg" alt="Getting Board Statistics"/></div></div><div class="section" title="Retrieving User Information"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec05"/>Retrieving User Information</h3></div></div></div><p>Use this function for an array of information about a user:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>get_userdata($user, $force_str = false)</strong></span>
</pre></div><p>It will return all the fields from the user’s entry in the database table as an array with both associative and enumerated values.</p><p>Try the following piece of code into a script:</p><div class="informalexample"><pre class="programlisting">echo ‘&lt;pre&gt;’;
print_r(get_userdata(2));
echo ‘&lt;/pre&gt;’;
</pre></div><p>This will display an array that starts like the following:</p><div class="informalexample"><pre class="programlisting">Array
(
[0] =&gt; 2
[user_id] =&gt; 2
[1] =&gt; 1
[user_active] =&gt; 1
[2] =&gt; Administrator
[username] =&gt; Administrator
[3] =&gt; 2236c39cda27b2c5535ce82f3a1e28e0
[user_password] =&gt; 2236c39cda27b2c5535ce82f3a1e28e0
[4] =&gt; 1104479522
[user_session_time] =&gt; 1104479522
. . .
)
</pre></div><p>Replace the<code class="literal"> 2</code> in the function call with any user ID or username you like. This function can take either a numeric ID or a username as a string.</p><p>If you pass the second parameter with value<code class="literal"> TRUE</code>, the first parameter should be a<span class="emphasis"><em> username</em></span>, and not an<span class="emphasis"><em> ID</em></span>.</p></div><div class="section" title="Encoding and Decoding IP Addresses"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec06"/>Encoding and Decoding IP Addresses</h3></div></div></div><p>phpBB encodes all IP addresses it stores into the database.<code class="literal"> encode_ip()</code> and<code class="literal"> decode_ip()</code> are the two functions that serve this purpose. The first one takes a properly formatted IP address like<code class="literal"> 127.0.0.1</code> and returns an encoded representation of it. The second function takes an encoded string and returns the original IP address.</p><p>You can try these functions by using the following code:</p><div class="informalexample"><pre class="programlisting">// the main script work starts here
$ip = $_SERVER[‘REMOTE_ADDR’];
$encoded = encode_ip($ip);
$decoded = decode_ip($encoded);
message_die(
GENERAL_MESSAGE,
‘I know you, your IP address is ‘ . $ip
. ‘. This is encoded as ‘ . $encoded
. ‘ and decoded back as ‘ . $decoded,
‘Encode/decode IP demo’
);
</pre></div><p>This will result in something like:</p><div class="mediaobject"><img src="graphics/1132_08_13.jpg" alt="Encoding and Decoding IP Addresses"/></div><p>You can find the script to display this output in the book’s code download, named<code class="literal"> misc_encode_decode_ip.php</code>.</p></div><div class="section" title="Displaying Dates"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec07"/>Displaying Dates</h3></div></div></div><p>You can use the following phpBB function to display a formatted date:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>create_date($format, $unix_timestamp, $timezone)</strong></span>
</pre></div><p>It’s not only a wrapper around the<code class="literal"> gmdate</code> PHP function (see <a class="ulink" href="http://php.net/gmdate">http://php.net/gmdate</a> for details), but also takes care of translating the date (months and weekdays) and takes account of the user’s time zone and date format preferences set in the profile page.</p><p>A sample usage of the function would be to print the current date and time, using the user’s preferred format and time zone. You can do that by using:</p><div class="informalexample"><pre class="programlisting">create_date($board_config[‘default_dateformat’], time(), $board_config[‘board_timezone’])
</pre></div><p>This will return a string like:<span class="strong"><strong> Mon Mar 14, 2005 8:56 am</strong></span>.</p><p>The book’s code download has a script called<code class="literal"> misc_create_date.php</code>, which shows how to use this function. You can also see the function used in the custom "What’s Up" script at the end of the chapter.</p></div><div class="section" title="Getting a List of Censored Words"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec08"/>Getting a List of Censored Words</h3></div></div></div><p>The following function retrieves the list of censored words and their replacement words:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>obtain_word_list(&amp;$original_words, &amp;$replacement_words)</strong></span>
</pre></div><p>The function accepts two parameters passed by reference. This basically means that you pass two empty arrays to this function and it populates these arrays with values.</p><p>We can use the word censoring as follows:</p><div class="informalexample"><pre class="programlisting">// the text to be filtered
$some_text = "I may contain naughty words.";
// empty arrays
$orig_word = $replacement_word = array();
// get the word lists
obtain_word_list($orig_word, $replacement_word);
// apply filters if there are ones
if ( !empty($orig_word) )
{
$some_text = preg_replace($orig_word, $replacement_word, $post_text);
// now $some_text is filtered
}
</pre></div><p>Don’t forget to use this functionality to filter not only post texts, but also topic titles, poll questions and answers, and anything else where you feel the need.</p></div><div class="section" title="Preserving the Session in the Hyperlinks"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec09"/>Preserving the Session in the Hyperlinks</h3></div></div></div><p>The following function helps you preserve the user session by passing the session identifier in the URL for users that have their cookies disabled:<a id="id289" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>append_sid($url, $non_html_amp = false)</strong></span>
</pre></div><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note32"/>Note</h3><p>You need to call this function every time you create a link to other pages in the forum, otherwise you’ll lose the session ID of the user’s visit and phpBB will create a new session for every page visited.</p></div><p>The second parameter of the function is optional; if it’s<code class="literal"> true</code>, the function will use "&amp;" and not the correct HTML value "&amp;amp;" when constructing URL’s parameters.</p><p>Example usage:</p><div class="informalexample"><pre class="programlisting">$url = ‘viewtopic.php?t=12’;
$url = append_sid($url);
</pre></div><p>Be careful if you use "#" (named anchors) in your URL; you need to add them<span class="emphasis"><em> after</em></span> the call to<code class="literal"> append_sid()</code> or otherwise the session ID will not be passed correctly.</p><p>Here’s the incorrect way of doing it:</p><div class="informalexample"><pre class="programlisting">$url = ‘viewtopic.php?p=21#21’;
$url = append_sid($url);
</pre></div><p>And the correct way:</p><div class="informalexample"><pre class="programlisting">$url = ‘viewtopic.php?p=21’;
$url = append_sid($url) . ‘#21’;
</pre></div><p>If you’re interested in more details of the implementation of this function, look into the source file<code class="literal"> includes/sessions.php</code>.</p></div><div class="section" title="IN_PHPBB"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec10"/>IN_PHPBB</h3></div></div></div><p>
<code class="literal">IN_PHPBB</code> is a constant, not a function. It was mentioned earlier and you have probably noticed that it’s defined at the top of every script.</p><p>This is a security measure that doesn’t allow include scripts to be accessed directly via a browser. In every include script, phpBB checks (and your script should too) if<code class="literal"> IN_PHPBB</code> is defined. If it is not, this means somebody was trying to access the include scripts directly in the browser. They’ll get an error message saying<span class="strong"><strong> Hack attempt</strong></span> and won’t be allowed to proceed further.</p></div></div><div class="section" title="Postings-Related Functions"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec10"/>Postings-Related Functions</h2></div></div></div><p>The following functions help you out when displaying a posting text.</p><div class="section" title="Create Links Automatically"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec11"/>Create Links Automatically</h3></div></div></div><p>The following function will take any text and will make clickable all the strings that look like URLs or e-mails:<a id="id290" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>make_clickable($text)</strong></span>
</pre></div><p>An example:</p><div class="informalexample"><pre class="programlisting">$text = "Visit Packt at www.packtpub.com today";
$text = make_clickable($text);
echo $text;
</pre></div><p>This snippet will output the following HTML:</p><div class="informalexample"><pre class="programlisting">Visit Packt at &lt;a href="http://www.packtpub.com" target="_blank"&gt;www.packtpub.com&lt;/a&gt; today.
</pre></div></div><div class="section" title="Processing Smilies"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec12"/>Processing Smilies</h3></div></div></div><p>The<code class="literal"> smilies_pass($text)</code> function will replace all the smilie codes in a text with the HTML code for the corresponding image tags. See the following section for an example.<a id="id291" class="indexterm"/>
</p></div><div class="section" title="Displaying a Posting Body"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec13"/>Displaying a Posting Body</h3></div></div></div><p>In order to properly display a posting text you need to:<a id="id292" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Parse the BB code and convert it into HTML code</li><li class="listitem" style="list-style-type: disc">Replace smilies</li><li class="listitem" style="list-style-type: disc">Make links clickable</li><li class="listitem" style="list-style-type: disc">Replace filtered words</li><li class="listitem" style="list-style-type: disc">Convert new lines to HTML breaks</li></ul></div><p>Look at the following example (it assumes that you have an array called<code class="literal"> $row</code> that contains a database record from the posting texts table). Note that you need the<span class="strong"><strong> BB Code UID</strong></span>, which is the key to transforming BB code into HTML.</p><div class="informalexample"><pre class="programlisting">// start
$post_text = $row[‘post_text’];
// BB code
$post_text = bbencode_second_pass($post_text, $row[‘bbcode_uid’]);
// smilies
$post_text = smilies_pass($post_text);
// clickable links
$post_text = make_clickable($post_text);
// naughty words
$orig_word = $replacement_word = array();
obtain_word_list($orig_word, $replacement_word);
if ( !empty($orig_word) )
{
$post_text = preg_replace($orig_word, $replacement_word, $post_text);
}
$post_text = nl2br($post_text);
</pre></div><p>Note that in order for this piece of code to work, you need to include the<code class="literal"> includes/bbcode.php</code> file in your script. This is normally done in the beginning of the script, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?php
define(‘IN_PHPBB’, true);
$phpbb_root_path = ‘./’;
include($phpbb_root_path . ‘extension.inc’);
include($phpbb_root_path . ‘common.’.$phpEx);
<span class="strong"><strong>include($phpbb_root_path . ‘includes/bbcode.’.$phpEx);</strong></span>
</pre></div></div></div><div class="section" title="Coding Guidelines"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec11"/>Coding Guidelines</h2></div></div></div><p>Coding standards and guidelines are always a good thing to have and follow. So it’s a good idea to familiarize yourself with the phpBB coding standards and code your extensions following those standards. It’s not mandatory (your code will still run even it does not adhere to the standards), but following pre-set standards can improve the maintainability of the code that you write. According to Sun Microsystems, "80% of the lifetime cost of a piece of software goes to maintenance" (source:<span class="emphasis"><em> Code Conventions for the Java Programming Language</em></span> at <a class="ulink" href="http://java.sun.com/docs/codeconv/">http://java.sun.com/docs/codeconv/</a>) and maintenance is much easier when coding conventions are employed. This is true even if you are the maintainer of your own code.<a id="id293" class="indexterm"/>
</p><p>The idea behind using code conventions is to minimize the individual "handwriting" of a programmer, unifying how functions and variables are named, how code is indented, etc. When all programmers working on a project use the same style, one can easily read code written by another, because it looks consistent with the way you would have written it.</p><p>You can find the current phpBB coding standards and guidelines in the phpBB.com development area at <a class="ulink" href="http://area51.phpbb.com">http://area51.phpbb.com/</a>.</p></div></div>
<div class="section" title="Recent Postings MOD"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec07"/>Recent Postings MOD</h1></div></div></div><p>This final section of the chapter is about creating a custom phpBB script called "Recent Postings" (or "What’s Up") MOD. This script uses the techniques discussed earlier in this chapter and is designed to wrap up your knowledge on phpBB programming and the use of templates.<a id="id294" class="indexterm"/>
</p><div class="section" title="The Challenge"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec12"/>The Challenge</h2></div></div></div><p>The script we’re about to create will list the 15 most recent postings in all forums of the board. It can be very useful for you and the other forum junkies to have an overview page of what’s happening in the board, without having to browse each forum individually. The same goes for moderators and administrators, the people that need to be up to speed with everything that’s going on in the board.<a id="id295" class="indexterm"/>
</p><p>The recent postings listing will respect user privileges, meaning that if a user doesn’t have read access to a certain forum, the postings from this forum won’t be present in the listing when viewed by this user.</p><p>To give you a more visual idea, here is a screenshot of the script in action:<a id="id296" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/1132_08_15.jpg" alt="The Challenge"/></div><p>If users with moderator privileges in a certain forum are logged in and are viewing this page, they’ll have a link to the moderator control panel for this forum, as shown:</p><div class="mediaobject"><img src="graphics/1132_08_16.jpg" alt="The Challenge"/></div><p>There are two icons after the username in the right column. Clicking the first one takes the user to the posting, located in the<span class="strong"><strong> View topic</strong></span> page (<code class="literal">viewtopic.php</code>). Clicking the second one doesn’t load a new page, but expands the area below the posting title and shows the posting here in the same screen, with the BB code and the smilies processed properly. This is shown on the next illustration.</p><div class="mediaobject"><img src="graphics/1132_08_17.jpg" alt="The Challenge"/></div><p>Clicking the same icon again (once a posting is expanded) collapses the additional area and hides the posting.</p><p>This is a convenient way to read the latest 15 posting in all forums, without leaving the page. To keep it simple, this script is not introducing new texts or graphics.</p><p>The Recent Postings MOD you’re about to create consists of a PHP script and a template file. The PHP script is named<code class="literal"> whatsup.php</code> and is hosted in the phpBB root, so if your board is installed in<a class="ulink" href="http://www.yourdomain.com/forum/"> http://www.yourdomain.com/forum/</a>, the scripts will be accessible at<a class="ulink" href="http://www.yourdomain.com/forum/whatsup.php"> http://www.yourdomain.com/forum/whatsup.php</a>.</p></div><div class="section" title="The Template"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec13"/>The Template</h2></div></div></div><p>The template for the script is named<code class="literal"> whatsup.tpl</code> and is located in<code class="literal"> templates/subSilver</code> directory. Here’s its listing:<a id="id297" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">&lt;span class="nav"&gt;&lt;a href="{U_INDEX}" class="nav"&gt;{L_INDEX}&lt;/a&gt;&lt;/span&gt;
&lt;table width="100%" cellpadding="5" cellspacing="1" border="0" class="forumline"&gt;
&lt;tr&gt;
&lt;th class="thCornerL" height="25" nowrap="nowrap"&gt;&amp;nbsp;{FORUM}&amp;nbsp;&lt;/th&gt;
&lt;th width="50" class="thTop" nowrap="nowrap"&gt;&amp;nbsp;{TOPIC}&amp;nbsp;&lt;/th&gt;
&lt;th class="thCornerR" nowrap="nowrap"&gt;&amp;nbsp;{POSTER}&amp;nbsp;&lt;/th&gt;
&lt;/tr&gt;
&lt;!-- BEGIN row --&gt;
&lt;tr&gt;
&lt;td valign="top" class="row1"&gt;
&lt;span class="forumlink"&gt;
&lt;a class="forumlink" href="{row.U_FORUM}"&gt;{row.FORUM_NAME}&lt;/a&gt;
&lt;/span&gt;
&lt;!-- BEGIN is_mod_switch --&gt;
&lt;span class="name"&gt;
&lt;br /&gt;
&lt;a href="{row.is_mod_switch.U_FORUM_MODCP}"&gt;{row.is_mod_switch.L_MOD}&lt;/a&gt;
&lt;/span&gt;
&lt;!-- END is_mod_switch --&gt;
&lt;/td&gt;
&lt;td valign="top" class="row2"&gt;
&lt;span class="topictitle"&gt;
{row.TOPIC_TYPE} &lt;a class="topictitle" href="{row.U_TOPIC}"&gt;{row.TOPIC_TITLE}&lt;/a&gt;
&lt;/span&gt;
&lt;br /&gt;
&lt;span class="gensmall"&gt;{row.GOTO_PAGE}&lt;/span&gt;
&lt;/td&gt;
&lt;td valign="top" class="row1"&gt;
&lt;span class="name"&gt;&lt;a href="{row.U_POSTER}"&gt;{row.POSTER}&lt;/a&gt; {row.IMG_LATEST_POST}
&lt;a href="#" onclick="javascript: document.getElementById(‘{row.POST_ID}’).style.display = (document.getElementById(‘{row.POST_ID}’).style.display == ‘none’) ? ‘’ : ‘none’;"&gt;
{row.IMG_VIEW_POST}&lt;/a&gt;
&lt;/span&gt;
&lt;br /&gt;
&lt;span class="postdetails"&gt;{row.POST_DATE_TIME}&lt;/span&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr id="{row.POST_ID}" style="display:none"&gt;
&lt;td colspan="3" class="row1"&gt;
&lt;div class="postbody" style="padding: 10px;"&gt;
{row.POST_TEXT}
&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;!-- END row --&gt;
&lt;/table&gt;
</pre></div><p>There’s nothing too specific for the template, it contains a table with three columns for <span class="strong"><strong>Forum</strong></span>, <span class="strong"><strong>Topic</strong></span>, and <span class="strong"><strong>Author</strong></span> respectively. A loop block encloses two table rows (<code class="literal">&lt;tr&gt; ... &lt;/tr&gt;</code>); the first one is the row that contains the forum name, the topic and the author information and links. The second one contains the posting. It’s hidden by default (having <code class="literal">style="display:none"</code>) and gets shown/hidden on user request by a JavaScript linked to the second small icon (<span class="inlinemediaobject"><img src="graphics/1132_08_18.jpg" alt="The Template"/></span>).</p><p>There is also one nested block within the<code class="literal"> row</code> block. It’s called<code class="literal"> is_mod_switch</code> and serves the purpose of handling an "if" case. The case is if the user has moderator privileges in the forum currently being listed. If yes, the link to the moderator control panel is displayed. This portion of the template is listed here:</p><div class="informalexample"><pre class="programlisting">&lt;!-- BEGIN is_mod_switch --&gt;
&lt;span class="name"&gt;
&lt;br /&gt;
&lt;a href="{row.is_mod_switch.U_FORUM_MODCP}"&gt;{row.is_mod_switch .L_MOD}&lt;/a&gt;
&lt;/span&gt;
&lt;!-- END is_mod_switch --&gt;
</pre></div></div><div class="section" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec14"/>The Code</h2></div></div></div><p>Now let’s take a look at<code class="literal"> whatsup.php</code>. The implementation starts like all other scripts discussed in the chapter, with a small difference: an additional file,<code class="literal"> bbcode.php</code>, is included. It contains the necessary functions to work with the BBCode and the smilies:<a id="id298" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">&lt;?php
define(‘IN_PHPBB’, true);
$phpbb_root_path = ‘./’;
include($phpbb_root_path . ‘extension.inc’);
include($phpbb_root_path . ‘common.’.$phpEx);
<span class="strong"><strong>include($phpbb_root_path . ‘includes/bbcode.’.$phpEx);</strong></span>
</pre></div><p>After including the required files comes the session management, which is similar to all the other scripts in this chapter:</p><div class="informalexample"><pre class="programlisting">// Start session management
$userdata = session_pagestart($user_ip, PAGE_INDEX);
init_userprefs($userdata);
</pre></div><p>Then comes the user authorization and privileges check:</p><div class="informalexample"><pre class="programlisting">// Start auth check
$user_can_read = array();
$user_can_read = auth(AUTH_READ, AUTH_LIST_ALL, $userdata);
</pre></div><p>This check verifies the user’s read privileges for all the board’s forums. Right after this there is a loop through the results of the authorization, so that an array of forum IDs is compiled. The array contains the IDs of the forums the user is allowed to read:</p><div class="informalexample"><pre class="programlisting">$allowed_forum_ids = array();
foreach ( $user_can_read AS $forum_id =&gt; $privileges )
{
if ( !empty($privileges[‘auth_read’]) )
{
$allowed_forum_ids[] = $forum_id;
}
}
</pre></div><p>After the privileges are checked, we need some data from the database, for which we need to execute an SQL string. It is quite long as it joins five tables in order to retrieve the required information. The logic of the query is as follows:<a id="id299" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The most recent 15 entries from the<span class="strong"><strong> postings</strong></span> table are selected. The way to get the most recent is to sort descending on the posting auto-increment ID.</li><li class="listitem" style="list-style-type: disc">Based on the topic ID from the postings table, the<span class="strong"><strong> topics</strong></span> table is joined to retrieve topic data such as title and topic type.</li><li class="listitem" style="list-style-type: disc">Based on the forum ID from the postings table, the<span class="strong"><strong> forums</strong></span> table is joined to retrieve forum data such as the name, and also to filter the allowed forums using the<code class="literal"> $allowed_forum_ids</code> array that was already compiled.</li><li class="listitem" style="list-style-type: disc">Based on the post ID from the postings table, the<span class="strong"><strong> posting texts</strong></span> table is joined in order to retrieve the posting body.</li><li class="listitem" style="list-style-type: disc">Finally based on the user ID from the postings table, the<span class="strong"><strong> users</strong></span> table is joined as it contains the username of the poster, which is displayed in the listing.<div class="informalexample"><pre class="programlisting">// start SQL string
$sql = ‘ SELECT t.topic_title, t.topic_id, t.topic_replies, t.topic_type, t.topic_vote, p.post_id, p.post_time, pt.post_text, pt.bbcode_uid, f.forum_name, f.forum_id, u.username, u.user_id ‘;
$sql .= ‘ FROM ‘ . POSTS_TABLE . ‘ AS p ‘;
$sql .= ‘ LEFT JOIN ‘ . TOPICS_TABLE . ‘ AS t ON p.topic_id = t.topic_id ‘;
$sql .= ‘ LEFT JOIN ‘ . FORUMS_TABLE . ‘ AS f ON t.forum_id = f.forum_id ‘;
$sql .= ‘ LEFT JOIN ‘ . POSTS_TEXT_TABLE . ‘ AS pt ON p.post_id = pt.post_id ‘;
$sql .= ‘ LEFT JOIN ‘ . USERS_TABLE . ‘ AS u ON p.poster_id = u.user_id ‘;
$sql .= ‘ WHERE ‘;
$sql .= ‘ f.forum_id IN (‘. implode(‘,’, $allowed_forum_ids) .’)’;
$sql .= ‘ ORDER BY p.post_time DESC ‘;
$sql .= ‘ LIMIT 0, 15’;
// end SQL string
</pre></div></li></ul></div><p>After the SQL query is assembled, it’s executed:</p><div class="informalexample"><pre class="programlisting">// execute query
$result = $db-&gt;sql_query($sql);
if ( !$result )
{
// check for errors while executing the query
message_die(GENERAL_ERROR, ‘Cannot obtain latest post listing’, ‘’,
__LINE__, __FILE__, $sql);
}
</pre></div><p>After successful query execution, it’s time to loop through the results and replace some template variables. Before the loop, we retrieve the list of censored words and their replacements. Remember that the filters were set up in the Admin panel.</p><div class="informalexample"><pre class="programlisting">// censored list
$orig_word = $replacement_word = array();
obtain_word_list($orig_word, $replacement_word);
</pre></div><p>The results loop starts:</p><div class="informalexample"><pre class="programlisting">// The loop through the results
while( $row = $db-&gt;sql_fetchrow($result) ) {
</pre></div><p>The first thing to do in the loop is to compile the "go to" links. These are the links like the ones shown in the following illustration.</p><div class="mediaobject"><img src="graphics/1132_08_19.jpg" alt="The Code"/></div><p>The code to retrieve these types of links is borrowed from a phpBB core script (<code class="literal">search.php</code>) without modifications—a good example of how you can learn from the phpBB application.</p><p>Next follows a check for some topic attributes—is this topic a sticky or an announcement and does it contain a poll? A<code class="literal"> $topic_type</code> variable is assigned a value; this variable’s value will be displayed before the topic name.</p><div class="informalexample"><pre class="programlisting">// check for topic type - announcement or sticky and/or poll
switch ( $row[‘topic_type’] )
{
case POST_ANNOUNCE:
$topic_type = $lang[‘Topic_Announcement’] . " ";
break;
case POST_STICKY:
$topic_type = $lang[‘Topic_Sticky’] . " ";
default:
$topic_type = ‘’;
}
if ( $row[‘topic_vote’] )
{
$topic_type .= $lang[‘Topic_Poll’];
}
// end topic type check
</pre></div><p>Next the parsing of the posting body follows. It consists of processing the BB code, replacing the smilies codes with images, replacing any filtered words, and making clickable all strings that look like links or e-mail addresses:</p><div class="informalexample"><pre class="programlisting">// parse BBcode, smilies, filters, make links clickable
$post_text = $row[‘post_text’];
$post_text = bbencode_second_pass($post_text, $row[‘bbcode_uid’]);
$post_text = smilies_pass($post_text);
$post_text = make_clickable($post_text);
if ( count($orig_word) )
{
$post_text = preg_replace($orig_word, $replacement_word, $post_text);
$topic_title = preg_replace($orig_word, $replacement_word, $row[‘topic_title’]);
}
$post_text = nl2br($post_text);
</pre></div><p>At this point, all the data is retrieved and processed/compiled as necessary. It’s now time to display it. So this is where the assignment of template variables within the<code class="literal"> row</code> template block starts:</p><div class="informalexample"><pre class="programlisting">// assign row block variables
$template-&gt;assign_block_vars("row",
array(
‘U_FORUM’ =&gt; append_sid(‘viewforum.’.$phpEx . "?f=" .
$row[‘forum_id’]),
‘FORUM_NAME’ =&gt; $row[‘forum_name’],
‘U_TOPIC’ =&gt; append_sid(‘viewtopic.’.$phpEx . "?t=" .
$row[‘topic_id’]),
‘TOPIC_TYPE’ =&gt; (empty($topic_type)) ? "" : "&lt;strong&gt;" .
$topic_type . "&lt;/strong&gt;",
‘TOPIC_TITLE’ =&gt; $topic_title,
‘GOTO_PAGE’ =&gt; $goto_page,
‘POSTER’ =&gt; $row[‘username’],
‘U_POSTER’ =&gt; append_sid(‘profile.’.$phpEx . "?mode=viewprofile&amp;amp;u=" . $row[‘user_id’]),
‘IMG_LATEST_POST’ =&gt; ‘&lt;a href="’ . append_sid("viewtopic.$phpEx?p=" . $row[‘post_id’]) . "#" . $row[‘post_id’] . ‘"&gt;&lt;img src="’ . $images[‘icon_latest_reply’] . ‘" border="0" /&gt;&lt;/a&gt; ‘,
‘IMG_VIEW_POST’ =&gt; ‘&lt;img src="’ . $images[‘icon_minipost’] . ‘" border="0" /&gt;’,
‘POST_DATE_TIME’ =&gt; create_date($board_config[‘default_dateformat’], $row[‘post_time’], $board_config[‘board_timezone’]),
‘POST_TEXT’ =&gt; $post_text,
‘POST_ID’ =&gt; $row[‘post_id’],
)
);
</pre></div><p>What you may find interesting in this piece of code is the use of the phpBB functions<code class="literal"> append_sid()</code> (for keeping the session ID in hyperlinks) and<code class="literal"> create_date()</code> (for formatting the date). Their usage was already described earlier in the<span class="emphasis"><em> Tips and Tricks</em></span> section of this chapter, but here you can see them in action.</p><p>Next is the<code class="literal"> is_mod_switch</code>, providing moderators with a link to the forum’s moderator control panel:</p><div class="informalexample"><pre class="programlisting">// process is_mod_switch block
if ( !empty($user_can_read[$row[‘forum_id’]][‘auth_mod’]) )
{
$template-&gt;assign_block_vars("row.is_mod_switch",
array(
‘U_FORUM_MODCP’ =&gt; ‘modcp.’.$phpEx . "?f=" . $row[‘forum_id’] . "&amp;amp;sid=" . $userdata[‘session_id’],
‘L_MOD’ =&gt; $lang[‘Mod_CP’],
)
);
}
</pre></div><p>The loop through the results is now completed. All that remains to be done is:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Include the page header</li><li class="listitem" style="list-style-type: disc">Assign the template file</li><li class="listitem" style="list-style-type: disc">Assign some global template variables ("global" meaning "outside the<code class="literal"> row</code> loop")</li><li class="listitem" style="list-style-type: disc">Parse and output the compiled template</li><li class="listitem" style="list-style-type: disc">Include the page footer (tail)</li></ul></div><p>Here is how it’s done:</p><div class="informalexample"><pre class="programlisting">// header, body and footer
include($phpbb_root_path . ‘includes/page_header.’.$phpEx);
$template-&gt;set_filenames(array(
‘body’ =&gt; ‘whatsup.tpl’)
);
$template-&gt;assign_vars(
array(
‘FORUM’ =&gt; $lang[‘Forum’],
‘TOPIC’ =&gt; $lang[‘Topic’],
‘POSTER’ =&gt; $lang[‘Author’],
)
);
$template-&gt;pparse(‘body’);
include($phpbb_root_path . ‘includes/page_tail.’.$phpEx);
</pre></div><p>And... that’s it! This is how a completely new phpBB script is built from scratch. The following is the complete source code listing for the new phpBB feature, the<code class="literal"> whatsup.php</code> script (included in the code download). Copy this to your board’s root and you’re done! And don’t forget:<code class="literal"> whatsup.tpl</code> should be copied to<code class="literal"> templates/subSilver</code>.<a id="id300" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">&lt;?php
define(‘IN_PHPBB’, true);
$phpbb_root_path = ‘./’;
include($phpbb_root_path . ‘extension.inc’);
include($phpbb_root_path . ‘common.’.$phpEx);
include($phpbb_root_path . ‘includes/bbcode.’.$phpEx);
// Start session management
$userdata = session_pagestart($user_ip, PAGE_INDEX);
init_userprefs($userdata);
// Start auth check
$user_can_read = array();
$user_can_read = auth(AUTH_READ, AUTH_LIST_ALL, $userdata);
$allowed_forum_ids = array();
foreach ($user_can_read AS $forum_id =&gt; $privileges)
{
if ( !empty($privileges[‘auth_read’]) )
{
$allowed_forum_ids[] = $forum_id;
}
}
// end auth check
// start SQL string
$sql = ‘ SELECT t.topic_title, t.topic_id, t.topic_replies, t.topic_type, t.topic_vote, p.post_id, p.post_time, pt.post_text, pt.bbcode_uid, f.forum_name, f.forum_id, u.username, u.user_id ‘;
$sql .= ‘ FROM ‘ . POSTS_TABLE . ‘ AS p ‘;
$sql .= ‘ LEFT JOIN ‘ . TOPICS_TABLE . ‘ AS t ON p.topic_id = t.topic_id ‘;
$sql .= ‘ LEFT JOIN ‘ . FORUMS_TABLE . ‘ AS f ON t.forum_id = f.forum_id ‘;
$sql .= ‘ LEFT JOIN ‘ . POSTS_TEXT_TABLE . ‘ AS pt ON p.post_id = pt.post_id ‘;
$sql .= ‘ LEFT JOIN ‘ . USERS_TABLE . ‘ AS u ON p.poster_id = u.user_id ‘;
$sql .= ‘ WHERE ‘;
$sql .= ‘ f.forum_id IN (‘. implode(‘,’, $allowed_forum_ids) .’)’;
$sql .= ‘ ORDER BY p.post_id DESC ‘;
$sql .= ‘ LIMIT 0, 15’;
// end SQL string
// execute query
$result = $db-&gt;sql_query($sql);
if ( !$result )
{
// check for errors while executing the query
message_die(GENERAL_ERROR, ‘Cannot obtain latest post listing’, ‘’, __LINE__, __FILE__, $sql);
}
// censored list
$orig_word = $replacement_word = array();
obtain_word_list($orig_word, $replacement_word);
// The loop through the results
while( $row = $db-&gt;sql_fetchrow($result) )
{
// goto page list
$replies = $row[‘topic_replies’];
$topic_id = $row[‘topic_id’];
// reuse from the search page
if ( ( $replies + 1 ) &gt; $board_config[‘posts_per_page’] )
{
$total_pages = ceil( ( $replies + 1 ) / $board_config[‘posts_per_page’] );
$goto_page = ‘ [ &lt;img src="’ . $images[‘icon_gotopost’] . ‘" alt="’ . $lang[‘Goto_page’] . ‘" title="’ . $lang[‘Goto_page’] . ‘" /&gt;’ . $lang[‘Goto_page’] . ‘: ‘;
$times = 1;
for($j = 0; $j &lt; $replies + 1; $j += $board_config[‘posts_per_page’])
{
$goto_page .= ‘&lt;a href="’ . append_sid("viewtopic.$phpEx?" . POST_TOPIC_URL . "=" . $topic_id . "&amp;amp;start=$j") . ‘"&gt;’ . $times . ‘&lt;/a&gt;’;
if ( $times == 1 &amp;&amp; $total_pages &gt; 4 )
{
$goto_page .= ‘ ... ‘;
$times = $total_pages - 3;
$j += ( $total_pages - 4 ) * $board_config[‘posts_per_page’];
}
else if ( $times &lt; $total_pages )
{
$goto_page .= ‘, ‘;
}
$times++;
}
$goto_page .= ‘ ] ‘;
}
else
{
$goto_page = ‘’;
}
// goto page list ends
// check for topic type - announcement or sticky and/or poll
switch ( $row[‘topic_type’] )
{
case POST_ANNOUNCE:
$topic_type = $lang[‘Topic_Announcement’] . " ";
break;
case POST_STICKY:
$topic_type = $lang[‘Topic_Sticky’] . " ";
default:
$topic_type = ‘’;
}
if ( $row[‘topic_vote’] )
{
$topic_type .= $lang[‘Topic_Poll’];
}
// end topic type check
// parse BBcode, smilies, filters, make links clickable
$post_text = $row[‘post_text’];
$post_text = bbencode_second_pass($post_text, $row[‘bbcode_uid’]);
$post_text = smilies_pass($post_text);
$post_text = make_clickable($post_text);
if ( count($orig_word) )
{
$post_text = preg_replace($orig_word, $replacement_word, $post_text);
$topic_title = preg_replace($orig_word, $replacement_word, $row[‘topic_title’]);
}
$post_text = nl2br($post_text);
// assign row block variables
$template-&gt;assign_block_vars("row",
array(
‘U_FORUM’ =&gt; append_sid(‘viewforum.’.$phpEx . "?f=" . $row[‘forum_id’]),
‘FORUM_NAME’ =&gt; $row[‘forum_name’],
‘U_TOPIC’ =&gt; append_sid(‘viewtopic.’.$phpEx . "?t=" . $row[‘topic_id’]),
‘TOPIC_TYPE’ =&gt; (empty($topic_type)) ? "" : "&lt;strong&gt;" . $topic_type . "&lt;/strong&gt;",
‘TOPIC_TITLE’ =&gt; $topic_title,
‘GOTO_PAGE’ =&gt; $goto_page,
‘POSTER’ =&gt; $row[‘username’],
‘U_POSTER’ =&gt; append_sid(‘profile.’.$phpEx . "?mode=viewprofile&amp;amp;u=" . $row[‘user_id’]),
‘IMG_LATEST_POST’ =&gt; ‘&lt;a href="’ . append_sid("viewtopic.$phpEx?p=" . $row[‘post_id’]) . "#" . $row[‘post_id’] . ‘"&gt;&lt;img src="’ . $images[‘icon_latest_reply’] . ‘" border="0" /&gt;&lt;/a&gt; ‘,
‘IMG_VIEW_POST’ =&gt; ‘&lt;img src="’ . $images[‘icon_minipost’] . ‘" border="0" /&gt;’,
‘POST_DATE_TIME’ =&gt; create_date($board_config[‘default_dateformat’], $row[‘post_time’], $board_config[‘board_timezone’]),
‘POST_TEXT’ =&gt; $post_text,
‘POST_ID’ =&gt; $row[‘post_id’],
)
);
// process is_mod_switch block
if ( !empty($user_can_read[$row[‘forum_id’]][‘auth_mod’]) )
{
$template-&gt;assign_block_vars("row.is_mod_switch",
array(
‘U_FORUM_MODCP’ =&gt; ‘modcp.’.$phpEx . "?f=" . $row[‘forum_id’] . "&amp;amp;sid=" . $userdata[‘session_id’],
‘L_MOD’ =&gt; $lang[‘Mod_CP’],
)
);
}
}
// header, body and footer
include($phpbb_root_path . ‘includes/page_header.’.$phpEx);
$template-&gt;set_filenames(array(
‘body’ =&gt; ‘whatsup.tpl’)
);
$template-&gt;assign_vars(
array(
‘FORUM’ =&gt; $lang[‘Forum’],
‘TOPIC’ =&gt; $lang[‘Topic’],
‘POSTER’ =&gt; $lang[‘Author’],
)
);
$template-&gt;pparse(‘body’);
include($phpbb_root_path . ‘includes/page_tail.’.$phpEx);
?&gt;
</pre></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec08"/>Summary</h1></div></div></div><p>This last chapter introduced you to the new and exciting world of phpBB programming. The chapter described in detail how to use different phpBB functions, how to use the phpBB database abstraction layer, the phpBB templating engine, and how to properly parse and display postings. Now you have the basic knowledge to start coding your own extensions to the phpBB core features. A number of examples were given, which are all available in the book’s code download.</p><p>It’s a good idea to start experimenting with the examples; tweak them a bit, and see how the results change. By doing so, you’ll get a better understanding of how the different functions work, and probably some ideas will start taking shape as to how you can customize and extend the phpBB functionality. Happy phpBB-ing!</p></div></body></html>