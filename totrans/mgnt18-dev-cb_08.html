<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Event Handlers and Cronjobs"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Event Handlers and Cronjobs</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Understanding Magento event types</li><li class="listitem" style="list-style-type: disc">Creating your own event</li><li class="listitem" style="list-style-type: disc">Adding an event listener</li><li class="listitem" style="list-style-type: disc">Introducing cronjobs</li><li class="listitem" style="list-style-type: disc">Creating a new cronjob</li><li class="listitem" style="list-style-type: disc">Testing your new cronjob</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec59"/>Introduction</h1></div></div></div><p>In the e-commerce flow of Magento, there are a lot of events that happen when a visitor buys something from your shop. He or she adds a product to the shopping cart, selects a payment method, logs in, and so on.</p><p>Magento dispatches these events and you have the possibility to hook in to an event to do your stuff. It's like hooking in to a click event in JavaScript.</p><p>The Observer design pattern is used to implement the event handling system. An event happens in the installation, and the configuration will call the right function from an observer class to execute.</p><p>The cronjob system in Magento<a id="id390" class="indexterm"/> is built on the same design pattern. Cronjobs are configured in the configuration. When the cron runs, Magento will check the timeframes and execute the jobs that match the configuration.</p></div></div>
<div class="section" title="Understanding Magento event types"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec60"/>Understanding Magento event types</h1></div></div></div><p>Working with event listeners is better than rewriting a core class. When analyzing a process, it is good to think about how you can<a id="id391" class="indexterm"/> do it and if it is possible to work with the Magento events.</p><p>Before we can do that, we have to see which events are available, when they are dispatched, and which parameters are sent with the event.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec152"/>Getting ready</h2></div></div></div><p>In this recipe, we will explore how <a id="id392" class="indexterm"/>the Magento event system works. We will use the Magento log system to debug a core class to see which events are available and when they are dispatched.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec153"/>How to do it...</h2></div></div></div><p>Follow the ensuing instructions to see the event system in action:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">When debugging something, it is recommended that you enable Magento logging. You can do this by configuring it in the backend. Navigate to <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Advanced</strong></span> | <span class="strong"><strong>Developer</strong></span>. Configure the <span class="strong"><strong>Enabled</strong></span> parameter as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_08_01.jpg" alt="How to do it..."/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip30"/>Tip</h3><p>You can also run the wiz command <code class="literal">wiz devel-logging yes</code> in your command-line tool to enable logging.</p></div></div></li><li class="listitem">Magento events are dispatched with the <a id="id393" class="indexterm"/><code class="literal">Mage::dispatchEvent()</code> function. To debug this function, we have to edit it. The <code class="literal">Mage::dispatchEvent()</code> function will call the <code class="literal">dispatchEvent()</code> function in the <code class="literal">app/code/core/Mage/Core/Model/App.php</code> file. To edit this file, we have to copy the file<a id="id394" class="indexterm"/> into the <code class="literal">app/code/local/Mage/Core/Model</code> folder. If this folder doesn't exist, create it and copy the file.</li><li class="listitem">In that file, search for the <code class="literal">dispatchEvent()</code> function<a id="id395" class="indexterm"/>. In the first line of that function, add <code class="literal">Mage::log($eventName);</code> to print the event name in the logfile. The beginning of that function will look like the following code snippet:<div class="informalexample"><pre class="programlisting">public function dispatchEvent($eventName, $args)
{
<span class="strong"><strong>  Mage::log($eventName);</strong></span>
  foreach ($this-&gt;_events as $area=&gt;$events) {
    if (!isset($events[$eventName])) {
      $eventConfig = $this-&gt;getConfig()-
      &gt;getEventConfig($area, $eventName);
      if (!$eventConfig) {
        $this-&gt;_events[$area][$eventName] = false;
        continue;
      }
      $observers = array();
      foreach ($eventConfig-&gt;observers-&gt;children() as 
      $obsName=&gt;$obsConfig) {
            ...</pre></div></li><li class="listitem">Clear the cache and reload the page in the frontend.</li><li class="listitem">Have a look at the <code class="literal">var/log/system.log</code> file. By using the <code class="literal">tail -f</code> command, you can see the changes of the file live. In the command line, go to the directory of your Magento installation and run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>tail -f var/log/system.log</strong></span>
</pre></div><p>This will give you the following output:</p><div class="mediaobject"><img src="graphics/3329OS_08_02.jpg" alt="How to do it..."/></div></li><li class="listitem">When reloading a new page, you will <a id="id396" class="indexterm"/>see that a lot of events are printed in the logfile of Magento.</li><li class="listitem">Enough debugging for now. It is time to remove the file <code class="literal">app/code/local/Mage/Core/Model/App.php</code>.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec154"/>How it works...</h2></div></div></div><p>The first thing we did was enable the Magento log. This is recommended for development environments because all the debug messages are printed in the file <code class="literal">var/log/system.log</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip31"/>Tip</h3><p>PHP warnings and notices are also printed in this file, so it is recommended to have a look at it when developing.</p></div></div><p>To print a debug message, we used the <code class="literal">Mage::log()</code> function. The first parameter of this function is the message you want to debug. If the parameter is an object or array, Magento will print a dump of the variable in the logfile.</p><p>The second parameter is the log level. When this is not specified, the error level <code class="literal">DEBUG</code> is used. This parameter requires a numeric value. These values are set in the <code class="literal">const</code> variables of the <code class="literal">Zend_Log </code>class<a id="id397" class="indexterm"/>, which are the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Zend_Log::EMERG</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Zend_Log::ALERT</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Zend_Log::CRIT</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Zend_Log::ERR</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Zend_Log::WARN</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Zend_Log::NOTICE</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Zend_Log::INFO</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Zend_Log::DEBUG</code></li></ul></div><p>With the third parameter, you can configure a file in the <code class="literal">var/log</code> folder where the log message needs to be printed. When this parameter is empty, the default file <code class="literal">system.log</code> is used.</p><p>The fourth and last parameter is a Boolean<a id="id398" class="indexterm"/> value where you can force to always print a log message (even if the Magento logging is set to off).</p><p>When using the <code class="literal">Mage::log()</code> function<a id="id399" class="indexterm"/>, you will print the debug data without changing the output of the PHP process.</p><p>For every request in Magento, many events are dispatched. So, there are many ways to integrate and execute custom code in the Magento process.</p><p>Working with events is better than rewriting a core class of Magento. When you rewrite a core class, it is possible that your code will become incompatible while upgrading Magento or installing third-party modules.</p><p>When you work with events, you will create an extension on Magento instead of creating a modification when you rewrite a core class.</p><p>So, it is good to think about the way you want to execute custom code in Magento.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec155"/>See also</h2></div></div></div><p>A full list of the Magento events can be found at: <a class="ulink" href="http://www.magentocommerce.com/wiki/5_-_modules_and_development/reference/magento_events">http://www.magentocommerce.com/wiki/5_-_modules_and_development/reference/magento_events</a>.</p><p>Make sure that this list is not complete when you are working with custom modules because they can have their own events.</p></div></div>
<div class="section" title="Creating your own event"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec61"/>Creating your own event</h1></div></div></div><p>When we want to create our own event, we <a id="id400" class="indexterm"/>have to dispatch it with a custom name. In this recipe, we will learn how events are dispatched and what we can do with parameters that we will forward.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec156"/>Getting ready</h2></div></div></div><p>We will create our own event that is fired when a visitor opens the<a id="id401" class="indexterm"/> <code class="literal">helloAction()</code> function of the <code class="literal">Packt_Helloworld</code> module. In this recipe, we will build further on the <code class="literal">Packt_Helloworld</code> module that is created in <a class="link" href="ch04.html" title="Chapter 4. Creating a Module">Chapter 4</a>, <span class="emphasis"><em>Creating a Module</em></span>, <a class="link" href="ch06.html" title="Chapter 6. Databases and Modules">Chapter 6</a>, <span class="emphasis"><em>Databases and Modules</em></span>, and <a class="link" href="ch07.html" title="Chapter 7. Magento Backend">Chapter 7</a>, <span class="emphasis"><em>Magento Backend</em></span>. If you want, you can install the start files.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec157"/>How to do it...</h2></div></div></div><p>The following steps describe how<a id="id402" class="indexterm"/> we can dispatch our own event.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">IndexController</code> of the <code class="literal">Packt_Helloworld</code> module. In this controller, there is a <a id="id403" class="indexterm"/><code class="literal">helloAction()</code> function where we will work to dispatch the event.</li><li class="listitem">To dispatch an event, the <code class="literal">Mage::dispatchEvent()</code> function<a id="id404" class="indexterm"/> is used. When we change the code of the <code class="literal">helloAction()</code> function to the following code, we will dispatch an event called <code class="literal">helloworld_register_visit</code>:<div class="informalexample"><pre class="programlisting">public function helloAction()
{
  $this-&gt;loadLayout();
  Mage::dispatchEvent('helloworld_register_visit');

  $this-&gt;renderLayout();
}</pre></div></li><li class="listitem">Every time the page is reloaded, the event is dispatched. Because there is no listener added, nothing will happen. To test that the code works, you have to debug the <a id="id405" class="indexterm"/><code class="literal">Mage_Core_Model_App::dispatchEvent()</code> function like we did in the previous recipe. You can find this function in the file <code class="literal">app/code/core/Mage/Core/Model/App.php</code>.</li><li class="listitem">The second thing we will do is add two parameters to the event. For example, we will send a product and a category to the event. We will use the second parameter to send the parameters. This parameter accepts a key value array with the objects. The following code shows how to send parameters to the event:<div class="informalexample"><pre class="programlisting">public function helloAction()
{
  $this-&gt;loadLayout();

  $parameters = array(
    'product' =&gt; Mage::getModel('catalog/product')-
    &gt;load(<span class="strong"><strong>166</strong></span>),
    'category' =&gt; Mage::getModel('catalog/category')-
    &gt;load(<span class="strong"><strong>10</strong></span>),
  );

  Mage::dispatchEvent('helloworld_register_visit', 
  $parameters);

  $this-&gt;renderLayout();
}</pre></div></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip32"/>Tip</h3><p>Make sure the product and category ID exists in your webshop. If not, you can use another ID that exists in your webshop.</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec158"/>How it works...</h2></div></div></div><p>The <code class="literal">Mage::dispatchEvent()</code> function fires an event in Magento. When this function is called, Magento will look into the <a id="id406" class="indexterm"/>configuration and execute the matching event observer functions, also known as observers in the Magento world.</p><p>You can use the <code class="literal">Mage::dispatchEvent()</code> function in every context you want, so it's to you to decide where you want to place it if needed.</p></div></div>
<div class="section" title="Adding an event observer"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec62"/>Adding an event observer</h1></div></div></div><p>An event listener (observer) is used when you want to hook in to an event. In the previous recipe, we fired an event. In this recipe, we will catch events and look at how we can execute custom code when the event<a id="id407" class="indexterm"/> occurs in the website.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec159"/>Getting ready</h2></div></div></div><p>For this recipe, we will add two event observers. The first one will catch the event that we created in the previous recipe. The second event listener (observer) will hook into the "add to cart" action of a product.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec160"/>How to do it...</h2></div></div></div><p>The following steps describe what<a id="id408" class="indexterm"/> you can do with event observers:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To listen to the <a id="id409" class="indexterm"/><code class="literal">helloworld_register_edit</code> event, we have to add configuration to the <code class="literal">config.xml</code> file of the <code class="literal">Packt_Helloworld</code> module. Add the following code in this file under the <code class="literal">&lt;global&gt;</code> tag:<div class="informalexample"><pre class="programlisting">&lt;events&gt;
  &lt;helloworld_register_visit&gt;
    &lt;observers&gt;
      &lt;register_visit&gt;
        &lt;type&gt;singleton&lt;/type&gt;
        &lt;class&gt;helloworld/observer&lt;/class&gt;
        &lt;method&gt;registerVisit&lt;/method&gt;
      &lt;/register_visit&gt;
    &lt;/observers&gt;
  &lt;/helloworld_register_visit&gt;
&lt;/events&gt;</pre></div></li><li class="listitem">We just configured an observer that fires the <a id="id410" class="indexterm"/><code class="literal">registerVisit()</code> function of the <code class="literal">helloworld/observer</code> class. We <a id="id411" class="indexterm"/>have to create the <code class="literal">Packt_Helloworld_Model_Observer</code> class. <a id="id412" class="indexterm"/>Create the file <code class="literal">app/code/local/Packt/Helloworld/Model/Observer.php</code> with the following content:<div class="informalexample"><pre class="programlisting">&lt;?php
class Packt_Helloworld_Model_Observer
{
  public function registerVisit (Varien_Event_Observer
  $observer)
  {
    Mage::log('Registered');
  }
}</pre></div></li><li class="listitem">We can test the event observer by firing the event. The event is fired on the page <code class="literal">http://magento-dev.local/helloworld/index/hello</code>. Navigate to this file and check the debug messages in the Magento logfile (<code class="literal">var/log/system.log</code>).</li><li class="listitem">The observer function prints a debug message in the Magento logfile. Let's look at the parameters that we send with the event. These parameters are sent in the <code class="literal">$observer</code> object in the function. To get the product and the category, change the <code class="literal">registerVisit()</code> action<a id="id413" class="indexterm"/> to the following code to debug the product and category:<div class="informalexample"><pre class="programlisting">public function registerVisit ($observer)
{
  $product = $observer-&gt;getProduct();
  $category = $observer-&gt;getCategory();

  Mage::log($product-&gt;debug());
  Mage::log($category-&gt;debug());
}</pre></div></li><li class="listitem">For the next part, we will hook in to the "add to cart" event. When a user adds a product to the cart, we have to check that the quantity is odd. If not, we have to show an error message that the product can't be added to the cart.</li><li class="listitem">To do that, we have to create an event listener (observer) for the event <code class="literal">checkout_cart_product_add_after</code>. We do this by adding the following code in the <code class="literal">config.xml</code> file of the <code class="literal">Packt_Helloworld</code> module. Paste the following code under the <code class="literal">&lt;events&gt;</code> tag:<div class="informalexample"><pre class="programlisting">&lt;checkout_cart_product_add_after&gt;
  &lt;observers&gt;
    &lt;check_cart_qty&gt;
      &lt;type&gt;singleton&lt;/type&gt;
      &lt;class&gt;helloworld/observer&lt;/class&gt;
      &lt;method&gt;checkCartQty&lt;/method&gt;
    &lt;/check_cart_qty&gt;
  &lt;/observers&gt;
&lt;/checkout_cart_product_add_after&gt;</pre></div></li><li class="listitem">This will call the <code class="literal">checkCartQty()</code> function<a id="id414" class="indexterm"/> in the observer<a id="id415" class="indexterm"/> class. The following code will display a notice message when the event is fired:<div class="informalexample"><pre class="programlisting">public function checkCartQty ($observer)
{
  Mage::getSingleton('checkout/session')-
  &gt;addNotice('Product add event fired');
}</pre></div></li><li class="listitem">Clear your cache and add a product to the cart. The message will appear in the cart page when a product is added, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_08_03.jpg" alt="How to do it..."/></div></li><li class="listitem">Now, we have to add the following code to check if the quantity is odd or even. This code gets the quantity from the observer and adds a check for even or odd:<div class="informalexample"><pre class="programlisting">public function checkCartQty ($observer)
{
  if ($observer-&gt;getProduct()-&gt;getQty() % 2 == 0) {
    //Even
  } else {
    //Odd
  }
}</pre></div></li><li class="listitem">When the quantity is even, we have to show a notice. When the quantity is odd, we have to cancel the "add to cart" operation and display a message. We can do this by throwing an exception. In <a id="id416" class="indexterm"/>an event observer, we can never use return values. To work correctly, the check function will look like the following code:<div class="informalexample"><pre class="programlisting">public function checkCartQty (Varien_Event_Object $observer)
{
  if ($observer-&gt;getProduct()-&gt;getQty() % 2 == 0) {
    //Even
    Mage::getSingleton('checkout/session')-&gt;addNotice('Even
    quantity added');
  } else {
    //Odd
    Mage::throwException('Quantity is odd. It needs to be
    even');
  }
}</pre></div></li><li class="listitem">Clear the cache and add a product to the cart with an even and odd quantity. You will see that the odd quantity will result in an error message.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec161"/>How it works...</h2></div></div></div><p>Event listeners (observers) are <a id="id417" class="indexterm"/>always configured in the <code class="literal">config.xml</code> file. When we look at the configuration, every tag has its own purpose:</p><div class="informalexample"><pre class="programlisting">&lt;events&gt;
  &lt;helloworld_register_visit&gt;
    &lt;observers&gt;
      &lt;register_visit&gt;
        &lt;type&gt;singleton&lt;/type&gt;
        &lt;class&gt;helloworld/observer&lt;/class&gt;
        &lt;method&gt;registerVisit&lt;/method&gt;
      &lt;/register_visit&gt;
    &lt;/observers&gt;
  &lt;/helloworld_register_visit&gt;
&lt;/events&gt;</pre></div><p>The <code class="literal">&lt;events&gt;</code> tag<a id="id418" class="indexterm"/> is the root to define events in it. The <code class="literal">&lt;events&gt;</code> tag can be configured under the <code class="literal">&lt;global&gt;</code>, <code class="literal">&lt;frontend&gt;</code>, or <code class="literal">&lt;admin&gt;</code> tags depending on the scope of the event that needs to be executed.</p><p>Under the <code class="literal">&lt;events&gt;</code> tag, we find the <code class="literal">&lt;helloworld_register_visit&gt;</code> tag<a id="id419" class="indexterm"/>. The name of the tag is the name of the event that will be observed. The observers are defined in the child tags.</p><p>Under the <code class="literal">&lt;helloworld_register_visit&gt;</code> tag<a id="id420" class="indexterm"/>, you see an <code class="literal">&lt;observers&gt;</code> subtag. In this tag, all the observers are declared.</p><p>In this recipe, we have a <code class="literal">register_visit</code> observer. The observers that are declared under the <code class="literal">&lt;observers&gt;</code> tag needs to have a unique name. When using an existing name, you will overwrite the configuration of an <code class="literal">existing</code> observer.</p><p>The observer tag (<code class="literal">register_visit</code>) has the following subtags:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;type&gt;</code>: This is the design pattern to<a id="id421" class="indexterm"/> call the class, mostly as <code class="literal">singleton</code> or <code class="literal">model</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;class&gt;</code>: This is the Magento <a id="id422" class="indexterm"/>path to the class</li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;method&gt;</code>: This is the method to be<a id="id423" class="indexterm"/> executed</li></ul></div><p>The previous event will execute the configured <a id="id424" class="indexterm"/>class and function when the event is fired with the <a id="id425" class="indexterm"/>
<code class="literal">dispatchEvent()</code> function.</p><p>To every observer function, an <code class="literal">$observer</code> object is passed. This variable is an instance of the <code class="literal">Varien_Event_Observer</code> class. This class extends the <code class="literal">Varien_Object</code> class<a id="id426" class="indexterm"/> and it contains some extra event-related functions.</p><p>The return parameters of the event observer functions will be ignored. When working with an event observer, you have to look at the context where the <code class="literal">Mage::dispatchEvent()</code> function<a id="id427" class="indexterm"/> is placed.</p><p>Sometimes, it is placed in a <code class="literal">try-catch</code> structure like the <code class="literal">checkout_cart_product_add_after</code> event<a id="id428" class="indexterm"/> in this recipe. In other cases, you can change the values of the passed objects like the <code class="literal">model_save_before</code> event<a id="id429" class="indexterm"/> does.</p></div></div>
<div class="section" title="Introducing cronjobs"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec63"/>Introducing cronjobs</h1></div></div></div><p>Cronjobs or scheduled tasks<a id="id430" class="indexterm"/> are background processes that keep your Magento webshop running. Some examples of cronjobs are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Sending newsletters</li><li class="listitem" style="list-style-type: disc">Recalculating catalog <a id="id431" class="indexterm"/>promotion rules for the next day</li><li class="listitem" style="list-style-type: disc">Cleaning visitor logs</li><li class="listitem" style="list-style-type: disc">Sending product stock and price alert mails</li><li class="listitem" style="list-style-type: disc">Updating currency rates</li></ul></div><p>If cronjobs are not configured on the server, you will see issues with your webshop after a period of time.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec162"/>Getting ready</h2></div></div></div><p>In this recipe, we will learn how to configure cronjobs on the server and verify that they are working. Make an SSH connection to your server and prepare yourselves to perform some server configurations.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec163"/>How to do it...</h2></div></div></div><p>The following steps describe how you have to configure the cronjobs on your server:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Practically, we have to configure <a id="id432" class="indexterm"/>cronjobs every five minutes. For that to happen, the following command is executed:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>/bin/sh /var/www/packt/magento-dev/cron.sh</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip33"/>Tip</h3><p>To avoid permission problems, you have to run this command as the user that apache uses to serve the HTTP requests. In our setup, this user is <code class="literal">www-data</code>.</p></div></div></li><li class="listitem">When you execute the previous command, the cronjob table in the database is updated with the recent cronjobs. In the <code class="literal">cron_schedule</code> table, you can see the queue for the next 30 minutes. Run the following command in your database client to see the content of the table:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>SELECT * from CRON_SCHEDULE;</strong></span>
</pre></div><p>This query gives you the following output:</p><div class="mediaobject"><img src="graphics/3329OS_08_04.jpg" alt="How to do it..."/></div></li><li class="listitem">In the <code class="literal">scheduled_at</code> column, you see when the cronjob is planned to run. When running the <code class="literal">cron.sh</code> script after <a id="id433" class="indexterm"/>the <code class="literal">scheduled_at</code> time, we have to run the query again. This will give the following output:<div class="mediaobject"><img src="graphics/3329OS_08_05.jpg" alt="How to do it..."/></div></li><li class="listitem">To run a cronjob, we have to use the crontab file on the Linux server. To configure it, we have to switch to the <code class="literal">www-data</code> user. We can do this by running the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo su www-data</strong></span>
</pre></div></li><li class="listitem">Next, we have to configure the cronjob. We can do this by running the <code class="literal">crontab -e</code> command. <a id="id434" class="indexterm"/>This will open a file where we have to put the content shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_08_06.jpg" alt="How to do it..."/></div></li><li class="listitem">Save the file and the cronjob will run every five minutes.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec164"/>How it works...</h2></div></div></div><p>The Magento cron script is called the <code class="literal">cron.sh</code> file in the Magento root folder. This will execute the <code class="literal">cron.php</code> file over <span class="strong"><strong>Command Line Interface</strong></span> (<span class="strong"><strong>CLI</strong></span>).<a id="id435" class="indexterm"/> In this <code class="literal">cron.php</code> file, the Magento application is started and the cron process is initialized.</p><p>When the cron process is initialized, Magento will<a id="id436" class="indexterm"/> look at the <code class="literal">cron_schedule</code> table. Every scheduled cronjob with the <code class="literal">scheduled_at</code> field in the past will be executed. When a job starts, the <code class="literal">executed_at</code> field will be updated to the current timestamp.</p><p>When a job is finished, the <code class="literal">finished_at</code> field is updated with the current timestamp. Also, the status will be updated. When the status is an error, the message field will be updated with the error.</p><p>When the process is finished, Magento will create a queue for the next 30 minutes. Based on the configuration files, Magento knows which cronjob has to be scheduled each time.</p></div></div>
<div class="section" title="Creating a new cronjob"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec64"/>Creating a new cronjob</h1></div></div></div><p>The cronjobs are defined in the <code class="literal">config.xml</code> files of the Magento modules. Like every configuration in these files, the cronjob configuration is easy to extend in our own module. In this recipe, we will learn how to create extra cronjobs for the Magento installation.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec165"/>Getting ready</h2></div></div></div><p>The workflow to execute a cronjob is mostly the same as working with events. We have to configure an observer function in the <code class="literal">config.xml</code> file that will be executed when the cronjob is executed.</p><p>In the <code class="literal">Packt_Helloworld</code> module, we will create a cronjob that will save some data in the database.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec166"/>How to do it...</h2></div></div></div><p>Follow the ensuing steps to see which<a id="id437" class="indexterm"/> configuration is needed to configure an extra cronjob:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We have to create a crontab configuration in the <code class="literal">config.xml</code> file. The following configuration will do that. Paste this under the <code class="literal">&lt;config&gt;</code> tag of the file <code class="literal">app/code/local/Packt/Helloworld/etc/config.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;crontab&gt;
  &lt;jobs&gt;
    &lt;helloworld_check_subscriptions&gt;
      &lt;schedule&gt;
        &lt;cron_expr&gt;* 10 * * *&lt;/cron_expr&gt;
      &lt;/schedule&gt;
      &lt;run&gt;
        &lt;model&gt;helloworld/observer::checkSubscriptions
        &lt;/model&gt;
      &lt;/run&gt;
    &lt;/helloworld_check_subscriptions&gt;
  &lt;/jobs&gt;
&lt;/crontab&gt;</pre></div></li><li class="listitem">Clear the cache and verify that the configuration is working by running the following command in your terminal:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>wiz config-get crontab/jobs</strong></span>
</pre></div><p>This command gives you a list of all the configured cronjobs in the configuration.</p><p>If the <code class="literal">helloworld_check_subscriptions</code> code is under the list, it means that the configuration is working.</p></li><li class="listitem">When the configuration is OK, we <a id="id438" class="indexterm"/>have to create the observer function. In the <code class="literal">run</code>/<code class="literal">model</code> tag, we will call the <code class="literal">cronListener()</code> action in the class <code class="literal">Packt_Helloworld_Model_Observer</code>. Create the class if it is not there and add the<a id="id439" class="indexterm"/> <code class="literal">checkSubscriptions()</code> function in it. The function will look like the following code:<div class="informalexample"><pre class="programlisting">public function checkSubscriptions()
{
  $subscription = Mage::getModel('helloworld/subscription');
  $subscription-&gt;setFirstname('Cron');
  $subscription-&gt;setLastname('Job');
  $subscription-&gt;setEmail('cron.job@example.com');
  $subscription-&gt;setMessage('Created by cronjob');

  $subscription-&gt;save();
}</pre></div><p>This will save a <code class="literal">subscription</code> entity in the <code class="literal">subscriptions</code> table when the cron is executed.</p></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec167"/>How it works...</h2></div></div></div><p>When you look at the cronjob configuration, the first XML tag you see is the cronjob code. This has to be unique across all the modules. If it exists, you will overwrite the settings of an existing standard cronjob.</p><p>A good practice is to start the cronjob code with the name that you used to register the models of your module (<code class="literal">helloworld</code>, <code class="literal">catalog</code>, and so on). This code is followed with the action you want to do.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip34"/>Tip</h3><p>A cronjob code is always in small letters. Spaces are replaced by an underscore. </p></div></div><p>One level deeper, you see the <code class="literal">&lt;schedule&gt;</code> and <code class="literal">&lt;run&gt;</code> tags.</p><p>In the <code class="literal">&lt;schedule&gt;</code> tag, we can configure the interval of the cronjob. This configuration contains five parameters which represent the following configurations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Minute</li><li class="listitem" style="list-style-type: disc">Hour</li><li class="listitem" style="list-style-type: disc">Day</li><li class="listitem" style="list-style-type: disc">Month</li><li class="listitem" style="list-style-type: disc">Year</li></ul></div><p>A configuration such as <code class="literal">0 10 * * *</code> will run every day at 10:00 a.m. This means every weekday, every month, every day, at hour<a id="id440" class="indexterm"/> 10 and minute 0.</p><p>The <code class="literal">&lt;run&gt;</code> tag<a id="id441" class="indexterm"/> just initializes the observer class and function to call when a cron needs to be executed. It is not possible to send parameters to that function.</p></div></div>
<div class="section" title="Testing your new cronjob"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec65"/>Testing your new cronjob</h1></div></div></div><p>When you are developing a new cronjob, it is not so easy to test it. You will not wait until the cron will be executed because you will lose a lot of time to do it.</p><p>On <span class="strong"><strong>Magento Connect</strong></span>,<a id="id442" class="indexterm"/> there is a module that makes the testing of a cronjob easy. This module allows you to run a cronjob from<a id="id443" class="indexterm"/> the backend or command line.</p><p>It also adds a view to the backend that is a graphical representation of the <code class="literal">cron_schedule</code> table.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec168"/>Getting ready</h2></div></div></div><p>We will install a module from Magento Connect on our Magento installation. More information of the module can be found at: <a class="ulink" href="http://www.magentocommerce.com/magento-connect/aoe-scheduler.html">http://www.magentocommerce.com/magento-connect/aoe-scheduler.html</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec169"/>How to do it...</h2></div></div></div><p>The following steps describe the workflow of the module to test cronjobs:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the module by getting the extension key from Magento Connect. Be sure to take the key for <span class="strong"><strong>Magento Connect 2.0</strong></span> as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_08_07.jpg" alt="How to do it..."/></div></li><li class="listitem">Paste the extension key in Magento Connect Manager. Navigate to <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Magento Connect</strong></span> | <span class="strong"><strong>Magento Connect Manager</strong></span>, paste the extension key, and click on the <a id="id444" class="indexterm"/><span class="strong"><strong>Install</strong></span> button as shown in<a id="id445" class="indexterm"/> the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_08_08.jpg" alt="How to do it..."/></div></li><li class="listitem">When you proceed, Magento Connect Manager will install the module to the installation.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip35"/>Tip</h3><p>It is possible that Magento Connect Manager fails to install the module. If it does, you can use the website <a class="ulink" href="http://freegento.com/ddl-magento-extension.php">http://freegento.com/ddl-magento-extension.php</a> to download a ready-to-paste format of the module.</p></div></div></li><li class="listitem">When you return to the admin, you will see that there is a menu item added under the <span class="strong"><strong>System</strong></span> section. When you navigate to <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Scheduler</strong></span> | <span class="strong"><strong>Schedule Configuration</strong></span>, you<a id="id446" class="indexterm"/> will see a list of all available cronjobs.</li><li class="listitem">To run a cronjob, you have to select one in the grid. After that, select <span class="strong"><strong>Run now</strong></span> in the drop-down above the grid and click on <span class="strong"><strong>Submit</strong></span>. This will directly run your cronjob.</li><li class="listitem">When you navigate to <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Scheduler</strong></span> | <span class="strong"><strong>Timeline View</strong></span>, you will see the information about the cronjob in the timeline as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_08_09.jpg" alt="How to do it..."/></div></li><li class="listitem">In the <code class="literal">shell</code> folder of the Magento root, the module adds a shell script to test the cronjobs by command line. This is the <code class="literal">scheduler.php</code> file, which has the following options:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">action (<code class="literal">runNow</code> or <code class="literal">scheduleNow</code>)</li><li class="listitem" style="list-style-type: disc">code (the cronjob code)</li></ul></div></li><li class="listitem">To run our cronjob by command line, the command looks like the following when you are in the Magento root folder:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php shell/scheduler.php -action runNow -code cronjob_code</strong></span>
</pre></div></li><li class="listitem">The previous command directly runs the cronjob. When you want to schedule the cronjob with the current timestamp (so it will be executed when the next cron runs), we have to use the <code class="literal">scheduleNow</code> action. With this option, the command looks like the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php shell/scheduler.php -action scheduleNow -code cronjob_code</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec170"/>How it works...</h2></div></div></div><p>The <code class="literal">Aoe_Scheduler</code> module adds an<a id="id447" class="indexterm"/> interface to the backend to simplify the process to test a cronjob. It is just a graphical interface on the <code class="literal">cron_schedule</code> table.</p><p>When you are working with cronjobs in your module, this module is recommended and saves a lot of time.</p><p>The shell script is added to test the cronjobs over the command line. Make sure when you run a cronjob over PHP CLI or you run it in the browser, other PHP settings are used. An Apache request uses the Apache php.ini settings and the command-line PHP uses the PHP CLI settings.</p></div></div></body></html>