<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer422">
<h1 class="chapter-number" id="_idParaDest-289" lang="en-GB"><a id="_idTextAnchor289"/>15</h1>
<h1 id="_idParaDest-290" lang="en-GB"><a id="_idTextAnchor290"/>Optimizing Moodle Performance</h1>
<p lang="en-GB">The performance of web-based systems is a critical issue, and it is the key responsibility of an administrator to configure, monitor, and fine-tune the LMS for maximum speed. While Moodle has the potential to scale to tens of thousands of simultaneous users, good performance management is required to guarantee <span class="No-Break" lang="">adequate scalability.</span></p>
<p lang="en-GB">After providing an overview of the subject, we will cover the most relevant topics related to Moodle’s performance <span class="No-Break" lang="">and optimization:</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Optimizing Moodle feature performance</strong>: We will look at performance issues in Moodle functions and Moodle activities. Optimizing their performance is often a trade-off between improved speed and potentially reduced functionality, which <span class="No-Break" lang="">is discussed.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Moodle Universal Cache (MUC)</strong>: We cover the different elements of the powerful MUC, namely cache types, cache stores, and cache definitions. We will then run you through some MUC performance testing and various <span class="No-Break" lang="">caching options.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Optimizing Moodle system performance</strong>: A range of system-related performance settings are dealt with, namely session handling, cron management and scheduled tasks, configuring global search, and setting <span class="No-Break" lang="">system paths.</span></li>
</ul>
<p lang="en-GB">We will conclude the chapter with a short Moodle performance profiling and <span class="No-Break" lang="">monitoring section.</span></p>
<h1 id="_idParaDest-291" lang="en-GB"><a id="_idTextAnchor291"/>Understanding Moodle performance</h1>
<p lang="en-GB">Web applications in<a id="_idIndexMarker1411"/> general, and Moodle in particular, have very distinct application layers consisting of an operating system, web server, database server, and an application developed in a programming language. Each layer has its idiosyncrasies when it comes to optimization. We will exclusively focus on the <em class="italic" lang="">application layer</em>, which is the focus of this book, as shown in the <span class="No-Break" lang="">following diagram:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer396">
<img alt="Figure 15.1 – Moodle performance " height="834" src="image/Figure_15.01_B18779.jpg" width="1038"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.1 – Moodle performance</p>
<p lang="en-GB">The following<a id="_idIndexMarker1412"/> areas are <em class="italic" lang="">NOT</em> dealt with in any detail, and it is necessary to refer to the respective documentation with regard to performance and <span class="No-Break" lang="">optimization issues:</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Operating system performance</strong>: The choice of operating system and configuration <a id="_idIndexMarker1413"/>will significantly impact how Moodle performs. In principle, Linux or any other Unix derivative performs better than any other operating system. PHP applications, such as Moodle, run significantly slower in a Windows environment than on Linux. Some aspects of this were covered in <a href="B18779_01.xhtml#_idTextAnchor020"><span class="No-Break" lang=""><em class="italic" lang="">Chapter 1</em></span></a>, <em class="italic" lang="">Installing Moodle</em>, when we dealt with the installation <span class="No-Break" lang="">of Moodle.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Database performance</strong>: The database is a major bottleneck since it requires disk access, which is slower than memory access. Entire books and conferences have been <a id="_idIndexMarker1414"/>dedicated to database optimization, with indexing, caching, buffering, querying, and connection handling as the primary candidates for discussion. The two techniques that significantly impact database performance are enabling query caching and increasing buffer sizes. You should consider running the database on a dedicated server or a cluster. The former is relatively straightforward: once set up, all you need to do is to change the <strong class="source-inline" lang="">$CFG-&gt;dbhost</strong> entry in <strong class="source-inline" lang="">config.php</strong> from <strong class="source-inline" lang="">localhost</strong> to the IP address of your database. The latter is significantly more complex and requires strong database <span class="No-Break" lang="">administration skills.</span></li>
</ul>
<p lang="en-GB">There is also much debate about which database is best suited for Moodle. While the open source camp is divided between MySQL, MariaDB, and PostgreSQL, corporates are split between MS SQL Server and Oracle. Whichever your choice of system, a well-set-up and tuned database will always perform better than one used with out-of-the-box settings—“The best database system is the one <span class="No-Break" lang="">you know.”</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Web server performance</strong>: Each <a id="_idIndexMarker1415"/>web server (Apache, <strong class="bold" lang="">Internet Information Services</strong> (<strong class="bold" lang="">IIS</strong>), nginx, and so on) offers<a id="_idIndexMarker1416"/> an array of optimization settings that include memory handling, caching, process management, and other <span class="No-Break" lang="">minor tweaks.</span></li>
<li lang="en-GB"><strong class="bold" lang="">PHP performance</strong>: There<a id="_idIndexMarker1417"/> are several ways in which PHP can be forced to execute code significantly faster. The key to doing this is using a PHP accelerator in combination with good memory management and caching techniques. Moodle supports <strong class="bold" lang="">Zend OPcache</strong>, which is precompiled by default. Zend OPcache speeds up PHP execution by opcode caching and optimization. It stores precompiled script byte code in shared memory. You can check whether OPcache is working correctly by going to <strong class="bold" lang="">Site administration</strong> |<strong class="bold" lang=""> Server</strong> | <strong class="bold" lang="">Environment</strong>, as illustrated in the <span class="No-Break" lang="">following screenshot:</span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer397">
<img alt="Figure 15.2 – Zend OPcache check " height="553" src="image/Figure_15.02_B18779.jpg" width="1632"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.2 – Zend OPcache check</p>
<p lang="en-GB">Your <strong class="source-inline" lang="">php.ini</strong> file is likely to<a id="_idIndexMarker1418"/> contain the following<a id="_idIndexMarker1419"/> entries (for details, refer <span class="No-Break" lang="">to </span><a href="http://docs.moodle.org/en/OPcache"><span class="No-Break" lang="">docs.moodle.org/en/OPcache</span></a><span class="No-Break" lang="">):</span></p>
<p class="source-code" lang="en-GB">[OPcache]</p>
<p class="source-code" lang="en-GB">  opcache.enable = 1</p>
<p class="source-code" lang="en-GB">  opcache.memory_consumption=128</p>
<p class="source-code" lang="en-GB">  opcache.interned_strings_buffer=8</p>
<p class="source-code" lang="en-GB">  opcache.max_accelerated_files=8000</p>
<p class="source-code" lang="en-GB">  opcache.revalidate_freq=60</p>
<p class="source-code" lang="en-GB">  opcache.fast_shutdown=1</p>
<p class="source-code" lang="en-GB">  opcache.enable_cli=1</p>
<p class="source-code" lang="en-GB">; Required for Moodle</p>
<p class="source-code" lang="en-GB">opcache.use_cwd = 1</p>
<p class="source-code" lang="en-GB">opcache.validate_timestamps = 1</p>
<p class="source-code" lang="en-GB">opcache.save_comments = 1</p>
<p class="source-code" lang="en-GB">opcache.enable_file_override = 0</p>
<p lang="en-GB">There is a handy plugin available at <a href="http://moodle.org/plugins/tool_opcache">moodle.org/plugins/tool_opcache</a>, adding a PHP OPcache management GUI to Moodle, a CLI tool to reset PHP OPcache, and a Nagios check for <span class="No-Break" lang="">PHP OPcache.</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Hardware performance</strong>: We already mentioned in <a href="B18779_01.xhtml#_idTextAnchor020"><span class="No-Break" lang=""><em class="italic" lang="">Chapter 1</em></span></a>, <em class="italic" lang="">Installing Moodle</em>, that there<a id="_idIndexMarker1420"/> is no one-size-fits-all approach to the ideal hardware setup. For single-server systems, the key is RAM: the more, the better. It’s as simple as that. Once the level of concurrency increases above a certain level, it is inevitable to use multiple web servers in a <span class="No-Break" lang="">load-balanced environment.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Network performance</strong>: Networks<a id="_idIndexMarker1421"/> are the backbone of most IT infrastructures and thus a potential performance bottleneck. Your topology, software, and hardware must be configured correctly to ensure a well-performing network without typical issues such as <span class="No-Break" lang="">packet losses.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Content performance</strong>: The<a id="_idIndexMarker1422"/> content that is created and uploaded by your course creators or home page designers will have an impact on the performance of your system. While you cannot dictate which learning sources are added to Moodle, you might want to recommend two main strategies to reduce the load content has on your system: First, the content volume in courses and the home page should be kept to a manageable size, avoiding the infamous <em class="italic" lang="">scroll of death</em>. Second, content should be optimized, especially office docs (for instance, PDFs instead of Word files), images (resolution and color depth), and audio/video (sample rate <span class="No-Break" lang="">and resolution).</span></li>
</ul>
<p lang="en-GB">While all the preceding criteria apply, some elements can be changed on the fly. For example, during exam week, you might consider increasing the memory available for Moodle, while during the summer break, you can reduce the number of servers to carry out maintenance. More sophisticated setups let you specify load and usage thresholds, which dynamically trigger <span class="No-Break" lang="">resource allocation.</span></p>
<p lang="en-GB">For each area mentioned, profile tools, monitoring systems, benchmarks, and stress tests are available to help you gauge which performance bottlenecks are present and whether they have been reduced after optimization has been <span class="No-Break" lang="">carried out.</span></p>
<p lang="en-GB">An entire area has been dedicated to performance and optimization in the Moodle docs. You can find most of the relevant information and links to relevant sites <span class="No-Break" lang="">at </span><a href="http://docs.moodle.org/en/Performance"><span class="No-Break" lang="">docs.moodle.org/en/Performance</span></a><span class="No-Break" lang="">.</span></p>
<p lang="en-GB">You should remember that Moodle’s performance cannot be viewed independently. For example, improving security comes at a price in terms of performance reduction; running your entire site over HTTPS is highly recommended, but it slows down certain operations. Some typical trade-offs are shown in the seesaw <span class="No-Break" lang="">depicted here:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer398">
<img alt="Figure 15.3 – Performance versus the rest of the world " height="469" src="image/Figure_15.03_B18779.jpg" width="865"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.3 – Performance versus the rest of the world</p>
<p lang="en-GB">Another trade-off you will face regularly is performance versus functionality, where certain features harm how speedily your system performs. Moodle comes with an elementary performance report (<strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Reports</strong> | <strong class="bold" lang="">Performance overview</strong>), showing some of <span class="No-Break" lang="">those trade-offs.</span></p>
<p lang="en-GB">We will kick off the list of performance optimizations by looking at some of those Moodle features that can be optimized but will impact some or all of <span class="No-Break" lang="">your users.</span></p>
<h1 id="_idParaDest-292" lang="en-GB"><a id="_idTextAnchor292"/>Optimizing Moodle feature performance</h1>
<p lang="en-GB">The title of this<a id="_idIndexMarker1423"/> section is slightly misleading because optimizing Moodle features effectively means limiting its functionality. Suggestions in this section have a positive impact on performance but a potentially negative impact on user functionality. While some features might be dispensable (for instance, statistics), others should be non-negotiable, such <span class="No-Break" lang="">as backups.</span></p>
<p lang="en-GB">We have grouped Moodle features in the performance optimization context into Moodle functions and <span class="No-Break" lang="">Moodle activities.</span></p>
<h2 id="_idParaDest-293" lang="en-GB"><a id="_idTextAnchor293"/>Optimizing Moodle functions</h2>
<p lang="en-GB">In this <a id="_idIndexMarker1424"/>subsection, we have collected some Moodle<a id="_idIndexMarker1425"/> tools that impact the performance of your LMS. Most of the following functions have been dealt with elsewhere in this book, and we provide links to the <span class="No-Break" lang="">respective chapters:</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Course backups</strong>: As<a id="_idIndexMarker1426"/> you will learn in the next chapter, course backups hurt performance during execution, especially on larger systems. If possible, schedule the backup procedure when the load on the overall system is low. If you turn off site-wide course backups and use system-level backups instead, you reduce performance problems but lose the ability to recover individual items. A compromise is to include only essential data and leave out less relevant information, such as log files. All this will be dealt with in <a href="B18779_16.xhtml#_idTextAnchor308"><span class="No-Break" lang=""><em class="italic" lang="">Chapter 16</em></span></a>, <em class="italic" lang="">Avoiding Sleepless Nights – Moodle Backup </em><span class="No-Break" lang=""><em class="italic" lang="">and Restore</em></span><span class="No-Break" lang="">.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Log files</strong>: In <a href="B18779_12.xhtml#_idTextAnchor233"><span class="No-Break" lang=""><em class="italic" lang="">Chapter 12</em></span></a>, <em class="italic" lang="">Gaining Insights through Moodle Reporting and Analytics</em>, we<a id="_idIndexMarker1427"/> looked at Moodle logging, reporting, and analytics. Keeping track of user behavior can potentially harm your server performance, as logs must be created and kept up to date. The recommended approach is only to log data that will be analyzed and reported on. Three parameters determine the volume of logs: the number of log stores, the number of fields stored, and the time logs are <span class="No-Break" lang="">being kept.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Statistics</strong>: If <a id="_idIndexMarker1428"/>you have enabled the statistics functionality, be aware that it is likely to have a profound impact on the performance of your system whenever statistical information is updated. Go back to the <em class="italic" lang="">Gathering statistics</em> section in <a href="B18779_12.xhtml#_idTextAnchor233"><span class="No-Break" lang=""><em class="italic" lang="">Chapter 12</em></span></a>, <em class="italic" lang="">Gaining Insights through Moodle Reporting and Analytics</em>, and ensure that the configuration has minimum impact on <span class="No-Break" lang="">your system.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Home page courses</strong>: The <a id="_idIndexMarker1429"/>home page is likely to be accessed frequently by all users. On sites with many courses, displaying all of them every time the home page is called is unlikely to be a pleasant user experience. You can limit the <strong class="bold" lang="">Maximum number of courses</strong> and <strong class="bold" lang="">Maximum category depth</strong> parameters by going to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">General</strong> | <strong class="bold" lang="">Site home</strong> | <strong class="bold" lang="">Site </strong><span class="No-Break" lang=""><strong class="bold" lang="">home settings</strong></span><span class="No-Break" lang="">.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Roles and users</strong>: We<a id="_idIndexMarker1430"/> dedicated an entire chapter to roles (<a href="B18779_06.xhtml#_idTextAnchor116"><span class="No-Break" lang=""><em class="italic" lang="">Chapter 6</em></span></a>,<em class="italic" lang=""> Managing Permissions, Roles, and Capabilities</em>). The robust flexibility of Moodle’s roles system comes at a price, which is a minor drop in performance if a lot of lookups <a id="_idIndexMarker1431"/>are required in the context hierarchy (avoid global roles) and the override mechanism is <span class="No-Break" lang="">applied frequently.</span></li>
<li lang="en-GB"><strong class="bold" lang="">User selector</strong>: The<a id="_idIndexMarker1432"/> user selector is displayed in various places throughout Moodle. If you experience speed problems in courses with a large number of users, adjust the <strong class="bold" lang="">Maximum number of users per page</strong> settings by navigating to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Users</strong> | <strong class="bold" lang="">Permissions</strong> | <span class="No-Break" lang=""><strong class="bold" lang="">User policies</strong></span><span class="No-Break" lang="">.</span></li>
</ul>
<p lang="en-GB">Next up are Moodle activities, which offer some performance <span class="No-Break" lang="">tweaking settings.</span></p>
<h2 id="_idParaDest-294" lang="en-GB"><a id="_idTextAnchor294"/>Optimizing Moodle activities</h2>
<p lang="en-GB">While<a id="_idIndexMarker1433"/> optimizing Moodle activities will positively impact performance, they should only be implemented if the loss of functionality is acceptable to your users. The following are some modules that can <span class="No-Break" lang="">be tweaked:</span></p>
<ul>
<li lang="en-GB"><span class="No-Break" lang=""><strong class="bold" lang="">Gradebook optimization</strong></span></li>
</ul>
<p lang="en-GB">Due to <a id="_idIndexMarker1434"/>the complexity of the gradebook, some settings in the <strong class="bold" lang="">Grades</strong> menu will impact performance. In general, when more aggregation and other calculations have to be carried out, the population of the gradebook data store becomes slow. For example, the <strong class="bold" lang="">Aggregate including subcategories</strong> parameter in <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Grades</strong> | <strong class="bold" lang="">Grade category settings</strong> will add minor overhead to <span class="No-Break" lang="">calculating grades.</span></p>
<p lang="en-GB">A second gradebook-related <a id="_idIndexMarker1435"/>area that impacts performance is the gradebook history, which forces Moodle to keep track of any changes in grades. Go to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Server</strong> | <strong class="bold" lang="">Cleanup</strong>, and you will see two gradebook history settings at <span class="No-Break" lang="">the bottom:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer399">
<img alt="Figure 15.4 – Gradebook history settings " height="510" src="image/Figure_15.04_B18779.jpg" width="1384"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.4 – Gradebook history settings</p>
<p lang="en-GB">The<a id="_idIndexMarker1436"/> gradebook history is turned on by default, and values are kept forever. You can either turn the facility off entirely or limit the time you wish to keep the <span class="No-Break" lang="">grade entries.</span></p>
<p lang="en-GB">You will find more details on the gradebook in the <em class="italic" lang="">Configuring grades and the gradebook</em> section of <a href="B18779_09.xhtml#_idTextAnchor181"><span class="No-Break" lang=""><em class="italic" lang="">Chapter 9</em></span></a>, <em class="italic" lang="">Configuring </em><span class="No-Break" lang=""><em class="italic" lang="">Educational Features</em></span><span class="No-Break" lang="">.</span></p>
<ul>
<li lang="en-GB"><span class="No-Break" lang=""><strong class="bold" lang="">Chat optimization</strong></span></li>
</ul>
<p lang="en-GB">By default, Moodle<a id="_idIndexMarker1437"/> chat uses the <strong class="bold" lang="">AJAX</strong> method, which, like the <strong class="bold" lang="">Normal </strong>method, contacts all participating clients regularly. The upside of both approaches is that they require no configuration and work on any system; the downside is that they have a significant performance impact on the server, especially when the chat activity is used regularly. A solution is to use the <strong class="bold" lang="">Chat server</strong> daemon, which ensures a scalable chat environment. However, the daemon, a small system-level program that runs in the background, has to be installed on the operating system level and only works on Unix (check your administration guide for how to <span class="No-Break" lang="">do this).</span></p>
<p lang="en-GB">To <a id="_idIndexMarker1438"/>change the chat method Moodle uses and to configure some performance parameters, go to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Plugins</strong> | <strong class="bold" lang="">Activity modules</strong> |<strong class="bold" lang=""> Chat</strong>. We dealt with these in the <em class="italic" lang="">Synchronous communication</em> section of <a href="B18779_10.xhtml#_idTextAnchor204"><span class="No-Break" lang=""><em class="italic" lang="">Chapter 10</em></span></a>, <em class="italic" lang="">Configuring </em><span class="No-Break" lang=""><em class="italic" lang="">Technical Features</em></span><span class="No-Break" lang="">.</span></p>
<p lang="en-GB">The following table lists the performance-related settings and the methods to which <span class="No-Break" lang="">they apply:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer400">
<img alt="Figure 15.5 – Chat performance settings " height="547" src="image/Figure_15.05_B18779.jpg" width="1385"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.5 – Chat performance settings</p>
<ul>
<li lang="en-GB"><span class="No-Break" lang=""><strong class="bold" lang="">Forum optimization</strong></span></li>
</ul>
<p lang="en-GB">On <a id="_idIndexMarker1439"/>systems with large forums, tracking unread posts can slow down the activity. Though the impact is relatively minor, the tracking can be turned off by going to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Plugins</strong> | <strong class="bold" lang="">Activity modules</strong> | <strong class="bold" lang="">Forum</strong>, where you will find the <strong class="bold" lang="">Track unread posts</strong> and <strong class="bold" lang="">Allow forced read </strong><span class="No-Break" lang=""><strong class="bold" lang="">tracking</strong></span><span class="No-Break" lang=""> parameters.</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Moodle’s </strong><span class="No-Break" lang=""><strong class="bold" lang="">filter settings</strong></span></li>
</ul>
<p lang="en-GB">We focused on <a id="_idIndexMarker1440"/>filter functionality when we looked at the feature in <a href="B18779_09.xhtml#_idTextAnchor181"><span class="No-Break" lang=""><em class="italic" lang="">Chapter 9</em></span></a>,<em class="italic" lang=""> Configuring Educational Features</em>. Now, let’s look at filters again, highlighting some performance issues. The following is a list ordered by priority when setting up filters by going to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Plugins</strong> | <strong class="bold" lang="">Filters</strong> |<strong class="bold" lang=""> </strong><span class="No-Break" lang=""><strong class="bold" lang="">Manage filters</strong></span><span class="No-Break" lang="">:</span></p>
<ol>
<li lang="en-GB">Activate all the filters that course creators need but not more than those. Too many active Moodle filters affect the server load, especially on lower-end systems. The number of active filters will increase the time it takes to scan each page since filters are applied sequentially, not <span class="No-Break" lang="">in parallel.</span></li>
<li lang="en-GB">Configure as many active filters as possible using the <strong class="bold" lang="">Off, but available</strong> setting. They can then be activated locally at any course or <span class="No-Break" lang="">activity level.</span></li>
<li lang="en-GB">Place the filters used most often (usually multimedia plugins) at the top of the list, as filters are applied on a <span class="No-Break" lang="">first-come-first-serve basis.</span></li>
<li lang="en-GB">Caching is applied to pages that use text filters, a topic discussed later in the <em class="italic" lang="">MUC</em> section. Additionally, you should optimize the generic filter settings in <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Plugins</strong> | <strong class="bold" lang="">Filters</strong> | <strong class="bold" lang="">Common filter settings</strong>: only turn on <strong class="bold" lang="">Filter uploaded files</strong> if required. Also, change <strong class="bold" lang="">Filter match once per page</strong>, <strong class="bold" lang="">Filter match once per text</strong>, and <strong class="bold" lang="">Filter navigation within system context</strong> to <strong class="bold" lang="">On</strong> if the resulting behaviors are acceptable. We have discussed these parameters in the <em class="italic" lang="">Configuring filters</em> section of <a href="B18779_09.xhtml#_idTextAnchor181"><span class="No-Break" lang=""><em class="italic" lang="">Chapter 9</em></span></a>, <em class="italic" lang="">Configuring </em><span class="No-Break" lang=""><em class="italic" lang="">Educational Features</em></span><span class="No-Break" lang="">.</span></li>
</ol>
<p lang="en-GB">There are other minor tweaks in Moodle activities and modules—for example, timeout values—and you’ll need to adjust those when and if you encounter any <span class="No-Break" lang="">performance issues.</span></p>
<p lang="en-GB">A bigger problem than feature performance is scalability, caused by concurrent users. We will spend the rest of the chapter dealing with this issue, starting with exploring the <span class="No-Break" lang="">powerful MUC.</span></p>
<h1 id="_idParaDest-295" lang="en-GB"><a id="_idTextAnchor295"/>Moodle Universal Cache (MUC)</h1>
<p lang="en-GB">Caching<a id="_idIndexMarker1441"/> stores frequently accessed data in transient storage and expedites its access using a cached copy instead of prefetched (from disk) or recomputed (in <span class="No-Break" lang="">memory) data.</span></p>
<p class="callout-heading" lang="en-GB">Note</p>
<p class="callout" lang="en-GB">Caching has proven to be one of the most efficient performance optimization techniques, and Moodle is <span class="No-Break" lang="">no exception.</span></p>
<p lang="en-GB">Moodle contains a powerful caching framework called MUC, which allows certain functions to take advantage of different <a id="_idIndexMarker1442"/>configured caching <span class="No-Break" lang="">services (</span><a href="http://docs.moodle.org/en/Caching"><span class="No-Break" lang="">docs.moodle.org/en/Caching</span></a><span class="No-Break" lang="">).</span></p>
<h2 id="_idParaDest-296" lang="en-GB"><a id="_idTextAnchor296"/>Understanding MUC</h2>
<p lang="en-GB">Before we look at how MUC works, let’s explore some basic concepts: cache types (modes), cache stores, and cache definitions. The following diagram shows all three concepts and how they work together <span class="No-Break" lang="">in MUC:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer401">
<img alt="Figure 15.6 – Moodle Universal Cache " height="1220" src="image/Figure_15.06_B18779.jpg" width="1385"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.6 – Moodle Universal Cache</p>
<p lang="en-GB">Moodle <a id="_idIndexMarker1443"/>has nearly 100 cache definitions—for example, fetching of language strings, config settings, or processed CSS. Cache definitions are mapped onto cache stores, which act as connectors to the cache backend for different cache types. This all will make more sense by the end of <span class="No-Break" lang="">this section.</span></p>
<p lang="en-GB">Let’s go through each component, starting with <span class="No-Break" lang="">cache types.</span></p>
<h3 lang="en-GB">Cache types</h3>
<p lang="en-GB">There are <a id="_idIndexMarker1444"/>three different <strong class="bold" lang="">cache types</strong> in Moodle, often referred to as <span class="No-Break" lang="">cache modes:</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Application cache</strong>: The <a id="_idIndexMarker1445"/>application cache <a id="_idIndexMarker1446"/>deals with Moodle-specific operations—for example, caching of language strings or configuration settings. This is the most commonly used cache as it has the highest impact on <span class="No-Break" lang="">Moodle performance.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Session cache</strong>: This<a id="_idIndexMarker1447"/> is basically the same as <a id="_idIndexMarker1448"/>your PHP session cache. It is only used in very few scenarios; we do not need to cover this in <span class="No-Break" lang="">further detail.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Request cache</strong>: As<a id="_idIndexMarker1449"/> the name suggests, this type <a id="_idIndexMarker1450"/>of caching is only stored for the lifetime of a request and allows developers to optimize code. Again, this is not a cache type we, as administrators, must <span class="No-Break" lang="">worry about.</span></li>
</ul>
<p lang="en-GB">Here’s an overview of the different <span class="No-Break" lang="">cache types:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer402">
<img alt="Figure 15.7 – Cache types (modes) " height="437" src="image/Figure_15.07_B18779.jpg" width="1385"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.7 – Cache types (modes)</p>
<p lang="en-GB">The last entry in <span class="No-Break" lang=""><em class="italic" lang="">Figure 15</em></span><em class="italic" lang="">.7</em> describes the default cache stores. What these are and why they are critical in Moodle are covered in the <span class="No-Break" lang="">following subsection.</span></p>
<h3 lang="en-GB">Cache stores</h3>
<p lang="en-GB">In Moodle, cache stores <a id="_idIndexMarker1451"/>are plugins that talk to <span class="No-Break" lang="">MUC’s backend.</span></p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">A <strong class="bold" lang="">cache store</strong> connects Moodle to physical storage, where the cached data <span class="No-Break" lang="">gets stored.</span></p>
<p lang="en-GB">As <a id="_idIndexMarker1452"/>mentioned previously, the default cache stores are in the form of a filesystem (for application caches), a PHP session (session caches), and memory (request caches). For most setups, these are sufficient, but for larger sites, it is beneficial to consider a dedicated application <span class="No-Break" lang="">cache store.</span></p>
<p lang="en-GB">Moodle ships with the following four application cache store plugins (the descriptions have mostly been taken from their respective websites, not some <span class="No-Break" lang="">techie buzzword-bingo):</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">APC user cache (APCu)</strong>: The alternative PHP cache is an in-memory key-value store <span class="No-Break" lang="">for PHP</span></li>
<li lang="en-GB"><strong class="bold" lang="">Memcached</strong>: An in-memory key-value store for small chunks of data from results of database calls, API calls, or <span class="No-Break" lang="">page rendering</span></li>
<li lang="en-GB"><strong class="bold" lang="">MongoDB</strong>: A NoSQL database system that can be configured to run like an <span class="No-Break" lang="">in-memory database</span></li>
<li lang="en-GB"><strong class="bold" lang="">Redis</strong>: An in-memory data structure store, used as a distributed, in-memory, key-value database, cache, and message broker, with <span class="No-Break" lang="">optional durability.</span></li>
</ul>
<p lang="en-GB">Plugins for other cache backends can be found <a id="_idIndexMarker1453"/>in the <strong class="bold" lang="">Cache Stores</strong> section <span class="No-Break" lang="">at </span><a href="http://moodle.org/plugins/?q=type:cachestore"><span class="No-Break" lang="">moodle.org/plugins/?q=type:cachestore</span></a><span class="No-Break" lang="">.</span></p>
<p lang="en-GB">All the supported cache stores can be found at <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Plugins</strong> |<strong class="bold" lang=""> Caching</strong> | <strong class="bold" lang="">Configuration</strong>. On our system, all cache stores have been installed and configured at the system level except APCu, hence the ticks in the <strong class="bold" lang="">Ready</strong> column. The <strong class="bold" lang="">Supports</strong> column indicates which features are supported by the cache store; the options are <strong class="bold" lang="">ttl</strong> (time-to-live), <strong class="bold" lang="">data guarantee</strong>, <strong class="bold" lang="">key awareness</strong>, <strong class="bold" lang="">multiple identifiers</strong>, and <strong class="bold" lang="">searching by key</strong>, as illustrated in the <span class="No-Break" lang="">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer403">
<img alt="Figure 15.8 – Cache stores " height="1262" src="image/Figure_15.08_B18779.jpg" width="1646"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.8 – Cache stores</p>
<p lang="en-GB">For each<a id="_idIndexMarker1454"/> configured cache type, you can add instances via the<a id="_idIndexMarker1455"/> respective link in the <strong class="bold" lang="">Actions</strong> column. Each cache store has different settings, depending on the cache backend’s supported features. Here are the<a id="_idIndexMarker1456"/> parameters of the popular <strong class="bold" lang="">Memcached</strong> store, which are documented <span class="No-Break" lang="">at </span><a href="http://docs.moodle.org/en/Caching#Memcached"><span class="No-Break" lang="">docs.moodle.org/en/Caching#Memcached</span></a><span class="No-Break" lang="">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer404">
<img alt="Figure 15.9 – Adding Memcached cache store " height="939" src="image/Figure_15.09_B18779.jpg" width="1384"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.9 – Adding Memcached cache store</p>
<p lang="en-GB">Once you have set up your cache store and cache instance(s), you must add <strong class="bold" lang="">store mappings</strong>, which<a id="_idIndexMarker1457"/> are part of the cache definitions we will <span class="No-Break" lang="">cover next.</span></p>
<h3 lang="en-GB">Cache definitions</h3>
<p lang="en-GB">Different <a id="_idIndexMarker1458"/>features in Moodle support caching. Years ago, there was a single monolithic cache that was either harnessed by a feature or wasn’t. Now, via MUC, each feature is represented via <strong class="bold" lang="">cache definitions</strong>, which<a id="_idIndexMarker1459"/> can be configured individually. At the time of writing, over 90 cache definitions are available, and it is expected that this number will increase with each version. For each definition, the following information <span class="No-Break" lang="">is available:</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Definition</strong>: Name of the feature that is <span class="No-Break" lang="">being cached.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Mode</strong>: Cache types (<strong class="bold" lang="">Application</strong>, <strong class="bold" lang="">Session</strong>, <span class="No-Break" lang="">or </span><span class="No-Break" lang=""><strong class="bold" lang="">Request</strong></span><span class="No-Break" lang="">).</span></li>
<li lang="en-GB"><strong class="bold" lang="">Component</strong>: The Moodle component that the definition belongs to (<strong class="bold" lang="">core</strong> <span class="No-Break" lang="">or module).</span></li>
<li lang="en-GB"><strong class="bold" lang="">Area</strong>: The section the feature belongs to—only relevant <span class="No-Break" lang="">to developers.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Store mappings</strong>: If no customization has taken place, this will be the default cache store of the cache mode; otherwise, the newly <span class="No-Break" lang="">set value.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Sharing</strong>: By default, this will be <strong class="bold" lang="">Site identifier</strong>. When modified, the possible values are <strong class="bold" lang="">Everyone</strong>, <strong class="bold" lang="">Version</strong>, and <strong class="bold" lang="">Custom key</strong> (see next <span class="No-Break" lang="">bullet list).</span></li>
<li lang="en-GB"><strong class="bold" lang="">Can use local store</strong>: Only relevant on <span class="No-Break" lang="">multi-server systems.</span></li>
</ul>
<p lang="en-GB">In the <strong class="bold" lang="">Actions</strong> column, you have <strong class="bold" lang="">Edit mappings</strong> and <strong class="bold" lang="">Edit sharing</strong> options, as well as a <strong class="bold" lang="">Purge</strong> option<a id="_idIndexMarker1460"/> to purge the cache for this <span class="No-Break" lang="">specific definition.</span></p>
<p lang="en-GB"><strong class="bold" lang="">Edit </strong><strong class="bold" lang=""><a id="_idIndexMarker1461"/></strong><strong class="bold" lang="">mappings</strong> lets you specify which cache store is being used as the primary store and, for some definitions, as the final store. This is where you specify which store is used for a particular feature (<span class="No-Break" lang="">cache definition).</span></p>
<p lang="en-GB">By default, each cache definition is shared across the instance of the site. However, there are scenarios where you might want to change this to any of the following <span class="No-Break" lang="">sharing options:</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Everyone</strong>: Every user in <span class="No-Break" lang="">the system.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Site with the same ID</strong>: If you run a single version of Moodle on a single server, this is identical to the preceding point. If you run Moodle on a multi-server setup, all systems will <span class="No-Break" lang="">be included.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Sites running the same version</strong>: If you run multiple Moodle instances from one <strong class="source-inline" lang="">wwwroot</strong>, only sites with identical version numbers will <span class="No-Break" lang="">be included.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Custom key</strong>: If you run multiple Moodle instances from one <strong class="source-inline" lang="">wwwroot</strong>, you can group them via a custom key. For example, you might want to cache all the instances of one country in <span class="No-Break" lang="">one store.</span></li>
</ul>
<p lang="en-GB">To clear the<a id="_idIndexMarker1462"/> cache of a specific definition, simply select the <strong class="bold" lang="">Purge</strong> option. The following screenshot shows some cache definitions and the <span class="No-Break" lang="">described values:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer405">
<img alt="Figure 15.10 – Cache definitions and mappings " height="489" src="image/Figure_15.10_B18779.jpg" width="1387"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.10 – Cache definitions and mappings</p>
<p lang="en-GB">There<a id="_idIndexMarker1463"/> are two more elements on the <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Plugins</strong> | <strong class="bold" lang="">Caching </strong>| <strong class="bold" lang="">Configuration</strong> page we haven’t <span class="No-Break" lang="">covered yet:</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Summary of cache lock instances</strong>: There are different locking mechanisms in shared environments, caches being no exception. By default, Moodle ships with a default file locking mechanism, and it would be possible to install additional lock instances. However, at the time of print, no such plugins are present for Moodle 4.x <span class="No-Break" lang="">at </span><a href="http://moodle.org/plugins"><span class="No-Break" lang="">moodle.org/plugins</span></a><span class="No-Break" lang="">.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Stores used when no mapping is present</strong>: You can specify which default mappings will be used for which <span class="No-Break" lang="">cache type.</span></li>
</ul>
<p lang="en-GB">Now that we have covered all the relevant concepts of MUC, let’s look at the items to consider when optimizing your <span class="No-Break" lang="">Moodle site.</span></p>
<h2 id="_idParaDest-297" lang="en-GB"><a id="_idTextAnchor297"/>Configuring and testing MUC</h2>
<p lang="en-GB">We <a id="_idIndexMarker1464"/>have already explored the complexity of MUC. While this provides enormous flexibility in terms of granular optimization, it makes it impossible to come up with a one-size-fits-all configuration. Somebody in the Moodle community once compared the MUC control panel with a big mixing desk at a concert: it gives you a lot of knobs to play with, but unless you know what each of them does and how they work together, you are unlikely to get <span class="No-Break" lang="">good results.</span></p>
<p lang="en-GB">Several factors <a id="_idIndexMarker1465"/>impact the configuration <span class="No-Break" lang="">of MUC:</span></p>
<ul>
<li lang="en-GB">Usage of the system (volume, diversity, functions, <span class="No-Break" lang="">and type)</span></li>
<li lang="en-GB">Underlying infrastructure (single server, multiple servers, virtualization, and <span class="No-Break" lang="">so on)</span></li>
<li lang="en-GB">Types of cache <span class="No-Break" lang="">stores used</span></li>
</ul>
<p lang="en-GB">In particular, when talking about the usage of the system, it is almost impossible to quantify this since it’s constantly changing. During the summer break, there will be minimal usage; during exam time, the load on the system is likely to rise, and <span class="No-Break" lang="">so on.</span></p>
<p lang="en-GB">Performance optimization is an ongoing exercise that is accompanied by regular performance testing. Moodle provides a basic performance test for different cache types (<strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Plugins</strong> | <strong class="bold" lang="">Caches</strong> | <strong class="bold" lang="">Test performance</strong>). Here is an example where you can see the results of 100,000 unique requests; the file cache is significantly slower than the session cache, a behavior that is <span class="No-Break" lang="">not unexpected:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer406">
<img alt="Figure 15.11 – Cache store performance testing " height="939" src="image/Figure_15.11_B18779.jpg" width="1385"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.11 – Cache store performance testing</p>
<p lang="en-GB">While it is <a id="_idIndexMarker1466"/>nice to have a built-in performance test tool in Moodle, it has two significant shortcomings: first, some plugins are classed as <strong class="bold" lang="">Untestable</strong>, for instance, <strong class="bold" lang="">Redis</strong> and <strong class="bold" lang="">Memcached</strong>; second, the test runs only mimic some unique requests but do not mirror their behavior if users are on your system. To overcome these drawbacks, proper profiling and monitoring are required, which will be dealt with at the end of <span class="No-Break" lang="">this chapter.</span></p>
<p lang="en-GB">There are several caching-related settings spread across the administration area, which you should tailor to <span class="No-Break" lang="">your requirements:</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Language caching</strong>: We<a id="_idIndexMarker1467"/> dealt with<a id="_idIndexMarker1468"/> localization in detail in <a href="B18779_10.xhtml#_idTextAnchor204"><span class="No-Break" lang=""><em class="italic" lang="">Chapter 10</em></span></a>, <em class="italic" lang="">Configuring Technical Features</em>, where we covered the configuration of Moodle’s ability to handle multiple languages. In addition to keeping the number of languages to a minimum, language caching should <span class="No-Break" lang="">be utilized.</span></li>
</ul>
<p lang="en-GB">Language<a id="_idIndexMarker1469"/> packs<a id="_idIndexMarker1470"/> are cached to speed up the retrieval of language strings. You will find the <strong class="bold" lang="">Cache language menu</strong> and <strong class="bold" lang="">Cache all language strings</strong> parameters by going to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Languages</strong> | <strong class="bold" lang="">Language settings</strong>. Unless you modify a language pack, it is highly recommended that you leave both settings enabled as they cache all the language strings rather than load <span class="No-Break" lang="">them dynamically.</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Theme caching</strong>: Moodle<a id="_idIndexMarker1471"/> caches the<a id="_idIndexMarker1472"/> images and style sheets of themes either locally in a web browser or on a server. Unless you are in the process of designing or modifying a theme, which you shouldn’t be doing on a live system anyway, the <strong class="bold" lang="">Theme designer mode</strong> setting, at <strong class="bold" lang="">Site administration</strong> |<strong class="bold" lang=""> Appearance</strong> | <strong class="bold" lang="">Themes</strong> | <strong class="bold" lang="">Theme settings</strong>, should <span class="No-Break" lang="">remain off.</span></li>
</ul>
<p lang="en-GB">You can clear the theme cache using the <strong class="bold" lang="">Clear theme caches</strong> button by going to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Appearance</strong> | <strong class="bold" lang="">Themes</strong> | <span class="No-Break" lang=""><strong class="bold" lang="">Theme selector</strong></span><span class="No-Break" lang="">.</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">JavaScript caching</strong>: Moodle<a id="_idIndexMarker1473"/> makes<a id="_idIndexMarker1474"/> use of JavaScript and AJAX. The <strong class="bold" lang="">Cache JavaScript</strong> setting at <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Appearance</strong> | <strong class="bold" lang="">AJAX and Javascript</strong> should be kept on unless you are a developer. The same applies to <strong class="bold" lang="">YUI Combo loading</strong> on the <span class="No-Break" lang="">same page.</span></li>
<li lang="en-GB"><strong class="bold" lang="">RSS caching</strong>: RSS feeds<a id="_idIndexMarker1475"/> are cached locally. You<a id="_idIndexMarker1476"/> can modify the time after the cache is refreshed by changing the <strong class="bold" lang="">Timeout</strong> parameter at <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Plugins</strong> | <strong class="bold" lang="">Blocks </strong>| <strong class="bold" lang="">Remote </strong><span class="No-Break" lang=""><strong class="bold" lang="">RSS feeds</strong></span><span class="No-Break" lang="">.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Networking caching</strong>: Moodle <a id="_idIndexMarker1477"/>uses cURL to<a id="_idIndexMarker1478"/> fetch data from remote sites. The <strong class="bold" lang="">cURL cache TTL</strong> setting can be modified by going to <strong class="bold" lang="">Site administration</strong> |<strong class="bold" lang=""> Server</strong> | <strong class="bold" lang="">Performance</strong>. The larger the time-to-live value, the better the performance. More on networking in <a href="B18779_19.xhtml#_idTextAnchor344"><span class="No-Break" lang=""><em class="italic" lang="">Chapter 19</em></span></a>, <em class="italic" lang="">Setting Up </em><span class="No-Break" lang=""><em class="italic" lang="">Moodle Networking</em></span><span class="No-Break" lang="">.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Repository caching</strong>: When <a id="_idIndexMarker1479"/>browsing <a id="_idIndexMarker1480"/>external repositories, such as Nextcloud or Google Drive, the file listing is kept in a local cache. The amount of time the listing is kept can be changed via the <strong class="bold" lang="">Cache expire</strong> parameter by going to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Plugins</strong> | <strong class="bold" lang="">Repositories</strong> | <strong class="bold" lang="">Common repository settings</strong>. We covered repositories in <a href="B18779_10.xhtml#_idTextAnchor204"><span class="No-Break" lang=""><em class="italic" lang="">Chapter 10</em></span></a>, <em class="italic" lang="">Configuring </em><span class="No-Break" lang=""><em class="italic" lang="">Technical Features</em></span><span class="No-Break" lang="">.</span></li>
</ul>
<p lang="en-GB">You can purge all these caches in a single operation by pressing the <strong class="bold" lang="">Purge all caches</strong> button when you navigate to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Development</strong> | <strong class="bold" lang="">Purge caches</strong>. Effectively, this clears out all the defined cache stores—for instance, the directories in <strong class="source-inline" lang="">$CFG-&gt;dataroot/cache</strong> for the file cache. While this feature is more relevant to developers, it is recommended after installing updates or when your system behaves oddly. You can see an illustration of this in the <span class="No-Break" lang="">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer407">
<img alt="Figure 15.12 – Purging caches " height="706" src="image/Figure_15.12_B18779.jpg" width="1469"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.12 – Purging caches</p>
<p lang="en-GB">There is also<a id="_idIndexMarker1481"/> a CLI script to purge caches: <span class="No-Break" lang=""><strong class="source-inline" lang="">php admin/cli/purge_caches.php</strong></span><span class="No-Break" lang="">.</span></p>
<p lang="en-GB">Once you have set up cache stores and configured all available caching options correctly, you should then move on to check that performance-related system settings have been <span class="No-Break" lang="">configured properly.</span></p>
<h1 id="_idParaDest-298" lang="en-GB"><a id="_idTextAnchor298"/>Optimizing Moodle system performance</h1>
<p lang="en-GB">In this<a id="_idIndexMarker1482"/> section, we have grouped settings that potentially impact performance without compromising any Moodle features. The topics covered are session handling, cron management and scheduled tasks, global search, and <span class="No-Break" lang="">system paths.</span></p>
<h2 id="_idParaDest-299" lang="en-GB"><a id="_idTextAnchor299"/>Handling sessions</h2>
<p lang="en-GB">A session is initiated<a id="_idIndexMarker1483"/> for each user that authenticates against Moodle, which also applies to guests. There are several well-explained settings relevant in a performance optimization context, which can be found by going to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Server</strong> |<strong class="bold" lang=""> </strong><span class="No-Break" lang=""><strong class="bold" lang="">Session handling</strong></span><span class="No-Break" lang="">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer408">
<img alt="Figure 15.13 – Session handling " height="1215" src="image/Figure_15.13_B18779.jpg" width="1373"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.13 – Session handling</p>
<p lang="en-GB">Moodle<a id="_idIndexMarker1484"/> manages sessions and cookies very well. However, when problems occur, it is sometimes necessary to intervene manually. This should be done locally in the web browser if a specific user experiences issues (clear cache and cookies) or on the server if the problem affects multiple users. The latter is done by clearing the <strong class="source-inline" lang="">mdl_sessions</strong> table if sessions are stored in the database or emptying the <strong class="source-inline" lang="">$CFG-&gt;dataroot/sessions</strong> directory if the sessions are stored in files. Bear in mind that all logged-in users will be <span class="No-Break" lang="">logged out.</span></p>
<p lang="en-GB">You can also<a id="_idIndexMarker1485"/> kill all user sessions via a CLI script that performs the preceding steps via a single command: <span class="No-Break" lang=""><strong class="source-inline" lang="">php admin/cli/kill_all_sessions.php</strong></span><span class="No-Break" lang="">.</span></p>
<p lang="en-GB">Cleaning up old sessions is done in the background by a so-called scheduled task. Cron management and scheduled tasks are the topics of the <span class="No-Break" lang="">following subsection.</span></p>
<h2 id="_idParaDest-300" lang="en-GB"><a id="_idTextAnchor300"/>Managing cron and scheduled tasks</h2>
<p lang="en-GB">Moodle <a id="_idIndexMarker1486"/>performs a significant number of background tasks <a id="_idIndexMarker1487"/>regularly. The system script that performs these tasks is known as a <strong class="bold" lang="">cron script</strong> and is executed by the <span class="No-Break" lang=""><strong class="bold" lang="">cron process</strong></span><span class="No-Break" lang="">.</span></p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">The Moodle cron script runs different tasks at differently <span class="No-Break" lang="">scheduled intervals.</span></p>
<p lang="en-GB">The following diagram illustrates when scheduled tasks are executed <span class="No-Break" lang="">in Moodle:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer409">
<img alt="Figure 15.14 – Scheduled tasks and the cron process " height="771" src="image/Figure_15.14_B18779.jpg" width="1387"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.14 – Scheduled tasks and the cron process</p>
<p lang="en-GB">Cron is a <a id="_idIndexMarker1488"/>system process that triggers Moodle’s cron script, which determines which tasks are executed at a particular <span class="No-Break" lang="">time slot.</span></p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">The cron process should run <span class="No-Break" lang="">every minute.</span></p>
<p lang="en-GB">Moodle comes with<a id="_idIndexMarker1489"/> a task scheduler (<strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Server</strong> | <strong class="bold" lang="">Scheduled tasks</strong>) that lets you precisely configure which routine job runs when and how often. The following screenshot shows some selected tasks (I hope your eyesight is better <span class="No-Break" lang="">than mine):</span></p>
<div>
<div class="IMG---Figure" id="_idContainer410">
<img alt="Figure 15.15 – Scheduled tasks " height="705" src="image/Figure_15.15_B18779.jpg" width="1385"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.15 – Scheduled tasks</p>
<p lang="en-GB">The following<a id="_idIndexMarker1490"/> information is provided for each <span class="No-Break" lang="">scheduled task:</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Name</strong>: Name and internal location of <span class="No-Break" lang="">the task</span></li>
<li lang="en-GB"><strong class="bold" lang="">Component</strong>: Moodle component that triggers <span class="No-Break" lang="">the task</span></li>
<li lang="en-GB"><strong class="bold" lang="">Logs</strong>: Details on each task execution, including duration and <span class="No-Break" lang="">database reads/writes</span></li>
<li lang="en-GB"><strong class="bold" lang="">Last run</strong>: Date and time of the previous task execution <span class="No-Break" lang="">or </span><span class="No-Break" lang=""><strong class="bold" lang="">Never</strong></span></li>
<li lang="en-GB"><strong class="bold" lang="">Next run</strong>: Date and time of subsequent task execution <span class="No-Break" lang="">or </span><span class="No-Break" lang=""><strong class="bold" lang="">ASAP</strong></span></li>
<li lang="en-GB"><strong class="bold" lang="">Minute</strong>, <strong class="bold" lang="">Hour</strong>, <strong class="bold" lang="">Day</strong>, <strong class="bold" lang="">Day of week</strong>, <strong class="bold" lang="">Month</strong>: Schedule information in Unix <span class="No-Break" lang="">cron format:</span><ul><li lang="en-GB"><strong class="bold" lang="">*</strong>: every minute, hour, day, day of the week, <span class="No-Break" lang="">and month</span></li><li lang="en-GB"><strong class="bold" lang="">*/x</strong>: every <em class="italic" lang="">x</em> minutes, hours, and <span class="No-Break" lang="">so on</span></li><li lang="en-GB"><strong class="bold" lang="">x-y</strong>: every minute between <em class="italic" lang="">x</em> and <em class="italic" lang="">y</em> past the hour or every hour, between <em class="italic" lang="">x</em> <span class="No-Break" lang="">and </span><span class="No-Break" lang=""><em class="italic" lang="">y</em></span></li><li lang="en-GB"><strong class="bold" lang="">0</strong> = Sunday, <strong class="bold" lang="">1</strong> = Monday, and <span class="No-Break" lang="">so on</span></li></ul></li>
<li lang="en-GB"><strong class="bold" lang="">Fail delay</strong>: Number of seconds to wait before reattempting a <span class="No-Break" lang="">failed task</span></li>
<li lang="en-GB"><strong class="bold" lang="">Default</strong>: Specifies whether the task has <span class="No-Break" lang="">been modified</span></li>
</ul>
<p lang="en-GB">You must<a id="_idIndexMarker1491"/> select the configuration icon in the <strong class="bold" lang="">Edit</strong> column if you wish to change the schedule for any tasks. As an example, we have picked the <strong class="bold" lang="">Check for updates</strong> task, which is executed at 10:48 every day, every month, and every day of <span class="No-Break" lang="">the week:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer411">
<img alt="Figure 15.16 – Editing task schedule " height="829" src="image/Figure_15.16_B18779.jpg" width="683"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.16 – Editing task schedule</p>
<p lang="en-GB">In addition to the already covered scheduling settings, you can pause a task (<strong class="bold" lang="">Disabled</strong>) and revert the original settings (<strong class="bold" lang="">Reset task schedule to defaults</strong>). The default settings have been set with performance in mind. However, you might want to fine-tune these, considering any idiosyncrasies in <span class="No-Break" lang="">your setup.</span></p>
<p lang="en-GB">There are <a id="_idIndexMarker1492"/>some things worth mentioning when dealing with scheduled tasks and the <span class="No-Break" lang="">cron process:</span></p>
<ul>
<li lang="en-GB">Tasks can be kicked off manually using the <strong class="bold" lang="">Run now</strong> option. For this action to appear underneath each enabled task, the <strong class="bold" lang="">Allow ‘Run now’ for scheduled tasks</strong> option in <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">General</strong> | <strong class="bold" lang="">Security</strong> | <strong class="bold" lang="">Site security settings</strong> must be set, and <strong class="bold" lang="">Path to PHP CLI</strong> in <strong class="bold" lang="">Site administration</strong> |<strong class="bold" lang=""> Server</strong> | <strong class="bold" lang="">System paths</strong> has to be <span class="No-Break" lang="">configured correctly.</span></li>
<li lang="en-GB">Multiple tasks can run in parallel. The concurrency limits for scheduled and ad hoc tasks can be configured at <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Server</strong> | <strong class="bold" lang="">Tasks</strong> | <span class="No-Break" lang=""><strong class="bold" lang="">Task processing</strong></span><span class="No-Break" lang="">.</span></li>
<li lang="en-GB">A cron run can take longer than the specified time between two executions, and the new tasks will be queued and executed at the next run if this is the case. The task lifetime before the task is freed can also be scheduled, and ad hoc tasks can be configured at <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Server</strong> | <strong class="bold" lang="">Tasks</strong> | <span class="No-Break" lang=""><strong class="bold" lang="">Task processing</strong></span><span class="No-Break" lang="">:</span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer412">
<img alt="Figure 15.17 – Task processing settings " height="855" src="image/Figure_15.17_B18779.jpg" width="1384"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.17 – Task processing settings</p>
<p lang="en-GB">To view <a id="_idIndexMarker1493"/>which tasks are running, go to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Server</strong> | <strong class="bold" lang="">Tasks</strong> |<strong class="bold" lang=""> Tasks running</strong> <strong class="bold" lang="">now</strong>. Any processes in progress will be listed, including the time the process has <span class="No-Break" lang="">already run.</span></p>
<p lang="en-GB">Details of each task are logged in Moodle and can be viewed at <strong class="bold" lang="">Site administration</strong> |<strong class="bold" lang=""> Server</strong> | <strong class="bold" lang="">Tasks</strong> | <strong class="bold" lang="">Task log</strong>. Via the report filters, you can drill down to processes that have taken a long time or tasks that have failed to complete. The settings at <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Server</strong> | <strong class="bold" lang="">Tasks</strong> | <strong class="bold" lang="">Task log configuration</strong> let you reduce the number of log entries that are written to the <span class="No-Break" lang="">log table:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer413">
<img alt="Figure 15.18 – Task log configuration " height="592" src="image/Figure_15.18_B18779.jpg" width="1042"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.18 – Task log configuration</p>
<p lang="en-GB">We have <a id="_idIndexMarker1494"/>already covered this as part of the installation, but it is worth reiterating that the method by which you call the Moodle cron job can have a significant impact on your system performance, especially on larger installations. If the <strong class="source-inline" lang="">cron.php</strong> script is invoked over HTTP (either using <strong class="source-inline" lang="">wget</strong> or <strong class="source-inline" lang="">curl</strong>), more memory is used than calling directly via the php –<span class="No-Break" lang="">f command.</span></p>
<p lang="en-GB">Moodle’s memory management has proven to be very efficient. However, there are scenarios when extra memory is required to execute complex PHP scripts, and cron is a candidate for such a complex script. To increase the memory limit, change the <strong class="bold" lang="">Extra PHP memory limit</strong> setting by going to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Server</strong> |<strong class="bold" lang=""> </strong><span class="No-Break" lang=""><strong class="bold" lang="">Performance</strong></span><span class="No-Break" lang="">.</span></p>
<p lang="en-GB">An operation that relies heavily on scheduled tasks and that potentially has a significant impact on system performance is global search, which we are configuring in the <span class="No-Break" lang="">following subsection.</span></p>
<h2 id="_idParaDest-301" lang="en-GB"><a id="_idTextAnchor301"/>Configuring global search</h2>
<p lang="en-GB">Moodle <a id="_idIndexMarker1495"/>comes with a powerful global search facility, supporting different content types, content areas, access permissions, and pluggable <span class="No-Break" lang="">search engines.</span></p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">Global search lets users search everywhere in Moodle they <span class="No-Break" lang="">have access.</span></p>
<p lang="en-GB">The following diagram is a simplified illustration of how global search works <span class="No-Break" lang="">in Moodle:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer414">
<img alt="Figure 15.19 – Moodle global search " height="476" src="image/Figure_15.19_B18779.jpg" width="1386"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.19 – Moodle global search</p>
<p lang="en-GB">The <strong class="bold" lang="">indexing</strong> process (top) is triggered by a scheduled task, during which any <strong class="bold" lang="">content and metadata</strong> created, updated, or deleted since the last run is sent to the search engine. The search engine never requests anything from Moodle; there is no content crawling. Moodle global search can be limited to <strong class="bold" lang="">search areas</strong>, such as assignment activity information, text block content, or received messages. The search engine processes the received data and stores it in <span class="No-Break" lang="">its index.</span></p>
<p lang="en-GB">The <strong class="bold" lang="">searching</strong> process (bottom) is initiated by a user keying in a search word or phrase. The query is sent to the search engine alongside the user’s access permissions, which are taken into account by the <strong class="bold" lang="">querying</strong> mechanism in the search engine. This last point is critical to ensure that users are only presented with results they have access to. The results are returned to Moodle and displayed to <span class="No-Break" lang="">the user.</span></p>
<p lang="en-GB">Moodle ships with one internal and one external search <span class="No-Break" lang="">engine plugin:</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Simple search</strong>: A built-in search engine supporting basic <span class="No-Break" lang="">search operations.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Solr</strong>: According to <a href="http://solr.apache.org">solr.apache.org</a>, “<em class="italic" lang="">Apache Solr is the popular, blazing-fast, open source enterprise search platform built on Apache Lucene</em>.” <strong class="bold" lang="">Solr</strong> supports file searches and advanced search operations, such as Boolean operators, wildcards, prefixing, proximity searches, <span class="No-Break" lang="">and boosting.</span></li>
</ul>
<p lang="en-GB">You will<a id="_idIndexMarker1496"/> find additional search engine plugins at <a href="http://moodle.org/plugins/?q=type:search">moodle.org/plugins/?q=type:search</a>, for example, <strong class="bold" lang="">Elastic</strong> or <span class="No-Break" lang=""><strong class="bold" lang="">Azure Search</strong></span><span class="No-Break" lang="">.</span></p>
<p lang="en-GB">To manage global search, go to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Plugins</strong> | <strong class="bold" lang="">Search</strong> | <strong class="bold" lang="">Manage global search</strong>, where you should see a table of setup steps to <span class="No-Break" lang="">go through:</span></p>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><img alt="Figure 15.20 – Moodle global search setup" height="1088" src="image/Figure_15.20_B18779.png" width="1079"/></p>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.20 – Moodle global search setup</p>
<p lang="en-GB">Let’s go<a id="_idIndexMarker1497"/> through the six actions step <span class="No-Break" lang="">by step:</span></p>
<ol>
<li lang="en-GB"><strong class="bold" lang="">Select search engine</strong>: The options are <strong class="bold" lang="">Simple search</strong> and <strong class="bold" lang="">Solr</strong> unless you have installed third-party search <span class="No-Break" lang="">engine plugins.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Enable search areas</strong>: Search areas are content groups that are indexed separately. By default, global search indexes all search areas; however, you can enable and disable individual search areas in <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Plugins</strong> |<strong class="bold" lang=""> Search</strong> | <strong class="bold" lang="">Search areas</strong>. By disabling a search area, you improve search speed but exclude its content <a id="_idIndexMarker1498"/>from appearing in search results. You might choose to disable the <strong class="bold" lang="">User</strong> search area to exclude links to user profiles from <span class="No-Break" lang="">global search.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Setup search engine</strong>: Simple search does not need any configuration; <span class="No-Break" lang="">others do.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Index data</strong>: Indexing is triggered by the <strong class="bold" lang="">Global search indexing</strong> scheduled task. Alternatively, there are multiple indexing actions in <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Plugins</strong> | <strong class="bold" lang="">Search</strong> | <strong class="bold" lang="">Search areas</strong>, namely updating, reindexing, and deleting the entire index or indices of an individual <span class="No-Break" lang="">search area.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Enable global search</strong>: You enable global search in <strong class="bold" lang="">Site administration</strong> |<strong class="bold" lang=""> General</strong> | <strong class="bold" lang="">Advanced features</strong>. Before enabling the feature, you should first configure global search and index the site contents. Otherwise, searches can return <span class="No-Break" lang="">incomplete results.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Used for site home course search</strong>: If enabled, search results will include course information visible to users, even if they don’t have access to the <span class="No-Break" lang="">course content.</span></li>
</ol>
<p lang="en-GB">You will find the last setting underneath the list of setup steps among various configuration options dealing with search options, search scopes (for instance, only courses the users are enrolled in), and display preferences. These settings are well explained onscreen, so we are not repeating <span class="No-Break" lang="">them here.</span></p>
<p lang="en-GB">Some more parameters are grouped under <strong class="bold" lang="">Search management</strong> at the bottom of the global search configuration screen. These options are helpful when making changes on sites with extensive search indexes that take a long time <span class="No-Break" lang="">to rebuild.</span></p>
<p lang="en-GB">Since the <strong class="bold" lang="">Solr</strong> plugin ships with Moodle, here are some pointers that will help you use the powerful search engine as part of <span class="No-Break" lang="">your setup:</span></p>
<ul>
<li lang="en-GB">Solr must be installed separately, either on the same or on a <span class="No-Break" lang="">dedicated server.</span></li>
<li lang="en-GB">Solr configuration in Moodle is located in <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Plugins</strong> |<strong class="bold" lang=""> Search</strong> | <strong class="bold" lang="">Solr</strong>. There are three groups of parameters: configuration (Solr host information and <strong class="bold" lang="">SSL</strong> support), file indexing, and query-only <span class="No-Break" lang="">alternate settings.</span></li>
<li lang="en-GB">Solr installation<a id="_idIndexMarker1499"/> and configuration in Moodle have been well documented <span class="No-Break" lang="">at </span><a href="http://docs.moodle.org/en/Global_search"><span class="No-Break" lang="">docs.moodle.org/en/Global_search</span></a><span class="No-Break" lang="">.</span></li>
</ul>
<p lang="en-GB">The last configuration options in the system performance section are system paths, which we will set in the <span class="No-Break" lang="">following subsection.</span></p>
<h2 id="_idParaDest-302" lang="en-GB"><a id="_idTextAnchor302"/>Setting system paths</h2>
<p lang="en-GB">An <a id="_idIndexMarker1500"/>operation that Moodle performs regularly is the listing of directories. The operation can either be run using Moodle’s internal routine coded in PHP or a native version of the function provided by the host operating system. The latter approach is significantly faster since it reduces the load on your server, but it is only supported in <span class="No-Break" lang="">Unix environments.</span></p>
<p lang="en-GB">You can specify the path for the <strong class="source-inline" lang="">du</strong> command by navigating to <strong class="bold" lang="">Site administration</strong> |<strong class="bold" lang=""> Server</strong> | <strong class="bold" lang="">System paths</strong>, as shown in the following screenshot. On most systems, the location of the executable is <strong class="source-inline" lang="">/usr/bin/du</strong>. Once specified correctly, this will accelerate the displaying of the directory content, especially if it contains <span class="No-Break" lang="">many files:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer416">
<img alt="Figure 15.21 – System paths" height="457" src="image/Figure_15.21_B18779.jpg" width="1554"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.21 – System paths</p>
<p lang="en-GB">This concludes the section on system performance. To ensure that any optimization leads to better performance and user experiences, you need to profile and monitor your Moodle system, which we will deal with in the last section of <span class="No-Break" lang="">the chapter.</span></p>
<h1 id="_idParaDest-303" lang="en-GB"><a id="_idTextAnchor303"/>Moodle performance profiling and monitoring</h1>
<p lang="en-GB">When you <a id="_idIndexMarker1501"/>set up your Moodle system, you can take some initial <a id="_idIndexMarker1502"/>precautions to optimize the performance of your LMS. However, the real test is when Moodle is in full operation—that is, when the system is under load (“There is no test <span class="No-Break" lang="">like production!”).</span></p>
<p lang="en-GB">We will be looking at Moodle’s built-in profiling tools to let you monitor your Moodle system regularly. While application monitoring cannot be seen as a standalone exercise, we won’t be dealing with system profiling since this is beyond the scope of <span class="No-Break" lang="">this book.</span></p>
<p lang="en-GB">We will cover three supported tools: <strong class="bold" lang="">Performance info</strong>, Tideways, <span class="No-Break" lang="">and JMeter.</span></p>
<h2 id="_idParaDest-304" lang="en-GB"><a id="_idTextAnchor304"/>Performance info</h2>
<p lang="en-GB">Moodle <a id="_idIndexMarker1503"/>provides <a id="_idIndexMarker1504"/>some basic profiling information you can activate in <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Development</strong> | <strong class="bold" lang="">Debugging</strong>, where you have to enable the <strong class="bold" lang="">Performance info</strong> option. This feature displays the execution time, RAM usage, the number of files in use, CPU usage and load, session size, and various filter and caching measures (less information will be shown on a <span class="No-Break" lang="">Windows-based installation).</span></p>
<p lang="en-GB"><strong class="bold" lang="">Performance info</strong> further displays information on the caches used on the particular page. For each cache, <strong class="bold" lang="">hits</strong>, <strong class="bold" lang="">misses</strong>, and <strong class="bold" lang="">sets</strong> are shown. The caches are highlighted using traffic light colors: red uses up the most, orange some, and green (or no color) uses up the least resources. These signals are rather good indicators to identify potential <span class="No-Break" lang="">performance issues.</span></p>
<p lang="en-GB">The data will be displayed in the footer of Moodle as long as the theme in use supports it—for <span class="No-Break" lang="">instance, </span><span class="No-Break" lang=""><strong class="bold" lang="">Boost</strong></span><span class="No-Break" lang="">.</span></p>
<p lang="en-GB">You can see an overview of <strong class="bold" lang="">Performance info</strong> in the <span class="No-Break" lang="">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer417">
<img alt="Figure 15.22 – Performance info " height="1501" src="image/Figure_15.22_B18779.jpg" width="1374"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.22 – Performance info</p>
<p lang="en-GB"><strong class="bold" lang="">Performance info</strong> provides<a id="_idIndexMarker1505"/> data on the overall Moodle <a id="_idIndexMarker1506"/>system and its cache items. If you require more in-depth information, Tideways profiling might <span class="No-Break" lang="">be helpful.</span></p>
<h2 id="_idParaDest-305" lang="en-GB"><a id="_idTextAnchor305"/>Tideways profiling</h2>
<p lang="en-GB">Moodle supports <a id="_idIndexMarker1507"/>profiling at the PHP level. While<a id="_idIndexMarker1508"/> this is mainly targeted at developers, it may be helpful for you to identify bottlenecks in your system. Internal profiling is built on top of <strong class="bold" lang="">Tideways</strong>, a replacement for <strong class="bold" lang="">XHProf</strong>, which allows the profiling of PHP pages at a relatively low <span class="No-Break" lang="">performance cost.</span></p>
<p lang="en-GB">Once you have installed the <strong class="source-inline" lang="">php-tideways</strong> and <strong class="source-inline" lang="">php-graphviz</strong> PHP extensions, you will see a new menu item when you navigate to <strong class="bold" lang="">Site administration</strong> |<strong class="bold" lang=""> Development</strong> | <span class="No-Break" lang=""><strong class="bold" lang="">Profiling</strong></span><span class="No-Break" lang="">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer418">
<img alt="Figure 15.23 – Profiling configuration " height="626" src="image/Figure_15.23_B18779.jpg" width="1543"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.23 – Profiling configuration</p>
<p lang="en-GB">The profiler can be configured to run automatically (set the <strong class="bold" lang="">Automatic profiling</strong> frequency to any value except 0, and specify URLs in the <strong class="bold" lang="">Profile these</strong> field) or manually. The latter can be <strong class="bold" lang="">Selective</strong> (you have to initiate the profiling) or <strong class="bold" lang="">Continuous</strong> (once it starts, you have to <span class="No-Break" lang="">stop it).</span></p>
<p lang="en-GB">As soon as profiling has been enabled, yet another menu item will appear when you go to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Development</strong> | <strong class="bold" lang="">Profiling runs</strong>, which lists summary information on <a id="_idIndexMarker1509"/>all the profile runs that have <span class="No-Break" lang="">been executed:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer419">
<img alt="Figure 15.24 – Profiling runs " height="572" src="image/Figure_15.24_B18779.jpg" width="1389"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.24 – Profiling runs</p>
<p lang="en-GB">When you<a id="_idIndexMarker1510"/> click on the URL or date of a single run, you can mark the run as a reference and provide a comment. You can also view its profiling details, where each function call’s execution times and memory usage are shown in tabular form. From this table, you can view a call graph. However, this requires dot to be installed (part of the Graphviz package) and <strong class="bold" lang="">Path to dot</strong> to be specified at <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Server</strong> |<strong class="bold" lang=""> System paths</strong>. The result is a scary-looking graph showing each function call’s order, dependencies, <span class="No-Break" lang="">and details.</span></p>
<p lang="en-GB">The general strategy when dealing with profiling is to identify the functions that take the longest to execute, tweak your setup, and check whether the time has been reduced. The difficulty in doing this is ensuring that the test runs occur under the same or, at least, very similar conditions. You can find<a id="_idIndexMarker1511"/> more information on PHP profiling <span class="No-Break" lang="">at </span><a href="http://docs.moodle.org/dev/Profiling_PHP"><span class="No-Break" lang="">docs.moodle.org/dev/Profiling_PHP</span></a><span class="No-Break" lang="">.</span></p>
<p lang="en-GB">Tideways helps identify issues at the PHP level. Another external profiling tool supported by Moodle is JMeter, as briefly covered in the <span class="No-Break" lang="">following subsection.</span></p>
<h2 id="_idParaDest-306" lang="en-GB"><a id="_idTextAnchor306"/>JMeter support</h2>
<p lang="en-GB"><strong class="bold" lang="">Apache JMeter</strong> is another<a id="_idIndexMarker1512"/> tool aimed at developers <a id="_idIndexMarker1513"/>but potentially helpful when locating Moodle bottlenecks. To create a test plan file, set <strong class="bold" lang="">Debug messages</strong> to <strong class="bold" lang="">DEVELOPER</strong> at <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Development</strong> | <strong class="bold" lang="">Debugging</strong>, and go to <strong class="bold" lang="">Site administration</strong> | <strong class="bold" lang="">Development</strong> | <strong class="bold" lang="">Make JMeter test plan</strong>. You need to follow the instructions shown in the following screenshot before a test plan can <span class="No-Break" lang="">be created:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer420">
<img alt="Figure 15.25 – Creating JMeter test plans " height="1105" src="image/Figure_15.25_B18779.jpg" width="1377"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.25 – Creating JMeter test plans</p>
<p lang="en-GB">The outcome of the performance test run over a Moodle course is a file in JMX format that can then <a id="_idIndexMarker1514"/>be loaded and analyzed in the JMeter tool, which you need to <span class="No-Break" lang="">install separately.</span></p>
<p lang="en-GB">Moodle comes with an unsupported tool that lets you generate random course data, which is helpful in the context of creating JMeter test plans. You have to call the script manually at <strong class="source-inline" lang="">&lt;yoursite&gt;/admin/tool/generator</strong>, where you can simulate having hundreds of courses with various levels and types of activities. You can see an overview of <span class="No-Break" lang="">this here:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer421">
<img alt="Figure 15.26 – Creating JMeter test plans " height="1260" src="image/Figure_15.26_B18779.jpg" width="1608"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.26 – Creating JMeter test plans</p>
<p lang="en-GB">You <a id="_idIndexMarker1515"/>can select <strong class="bold" lang="">Size of course</strong> as well as <strong class="bold" lang="">Course short name</strong>, <strong class="bold" lang="">Course full name</strong>, and <strong class="bold" lang="">Course summary</strong> options. Beware that the generation of large courses may take hours and significantly negatively impacts your system performance. Do not perform this operation in <span class="No-Break" lang="">production environments.</span></p>
<p lang="en-GB">Now that you have been armed with some profiling and monitoring tools, you can tweak the settings as described throughout the chapter. Take a look at what impact, positive or negative, they have on the performance of your <span class="No-Break" lang="">Moodle system.</span></p>
<h1 id="_idParaDest-307" lang="en-GB"><a id="_idTextAnchor307"/>Summary</h1>
<p lang="en-GB">You learned how to optimize and monitor Moodle’s performance in this chapter. We first provided an overview of Moodle performance and briefly mentioned optimizing hardware, networks, databases, web servers, and course content. The key Moodle performance topics have been grouped into the <span class="No-Break" lang="">following sections:</span></p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Moodle feature performance</strong>: We covered performance issues in Moodle functions and <span class="No-Break" lang="">Moodle activities.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Moodle Universal Cache</strong>: We dealt with the powerful MUC and configured cache types, cache stores, and cache definitions before testing MUC performance and activating various <span class="No-Break" lang="">caching options.</span></li>
<li lang="en-GB"><strong class="bold" lang="">Moodle system performance</strong>: We optimized session handling, cron management and scheduled tasks, global search, and <span class="No-Break" lang="">system paths.</span></li>
</ul>
<p lang="en-GB">The chapter was concluded with a short Moodle performance profiling and <span class="No-Break" lang="">monitoring section.</span></p>
<p lang="en-GB">As you have probably gathered from the chapter, optimization is not always straightforward. It depends on various circumstances, such as the system that Moodle is running on, the hardware it utilizes, the network, the number of concurrent users logged in to the system, the types of activities carried out, and so on. While basic optimization is usually straightforward, fine-tuning is a bit of an art in itself. A lot of trial and error (that is, profiling) will be required to achieve the ideal setup for your <span class="No-Break" lang="">Moodle system.</span></p>
<p lang="en-GB">Now that your system is ready to perform to its maximum potential, let’s ensure that you have a professional backup and recovery strategy in place, which is covered in the <span class="No-Break" lang="">next chapter.</span></p>
</div>
</div></body></html>