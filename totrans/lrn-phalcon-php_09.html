<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;The Frontend Module"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. The Frontend Module</h1></div></div></div><p>Developing the frontend can be a difficult job. You have to take into consideration a variety of aspects, such as <span class="strong"><strong>User Experience</strong></span> (<span class="strong"><strong>UX</strong></span>), <span class="strong"><strong>Search Engine Optimization</strong></span> (<span class="strong"><strong>SEO</strong></span>), browser compatibility, mobile responsiveness, and so on. We are going to focus on creating a minimal layout and implementing Elasticsearch. We will also use MongoDB to create some logs for articles. Step by step, we are going to cover the following topics in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The frontend layout and basic functionality</li><li class="listitem" style="list-style-type: disc">Implementing Elasticsearch</li><li class="listitem" style="list-style-type: disc">Implementing MongoDB</li></ul></div><div class="section" title="The Frontend layout and basic functionality"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec54"/>The Frontend layout and basic functionality</h1></div></div></div><p>We are going to use a simple <a id="id545" class="indexterm"/>layout for our frontend module. Switch to the <code class="literal">modules/Frontend/Views/Default/common</code> folder and create the <code class="literal">footer.volt</code>, <code class="literal">paginator.volt</code>, and <code class="literal">navbar.volt</code> files with the following content.</p><div class="section" title="footer.volt"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec78"/>footer.volt</h2></div></div></div><p>The <code class="literal">footer.volt</code> file<a id="id546" class="indexterm"/> does not<a id="id547" class="indexterm"/> contain too much information, but in future, you will want to add more information for sure, such as links, partners, analytics scripts, and so on:</p><div class="informalexample"><pre class="programlisting">&lt;footer class="lp-footer"&gt;
    &lt;p&gt;Learning Phalcon&lt;/p&gt;
    &lt;p&gt;
        &lt;a href="#"&gt;Back to top&lt;/a&gt;
    &lt;/p&gt;
&lt;/footer&gt;</pre></div></div><div class="section" title="paginator.volt"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec79"/>paginator.volt</h2></div></div></div><p>The <code class="literal">paginator.volt</code> file<a id="id548" class="indexterm"/> contains two simple links: <span class="strong"><strong>Previous</strong></span> <a id="id549" class="indexterm"/>and <span class="strong"><strong>Next</strong></span>. You can modify these and create a more complex paginator if you wish:</p><div class="informalexample"><pre class="programlisting">&lt;nav&gt;
  &lt;ul class="pager"&gt;
    &lt;li&gt;&lt;a href="?p={{ records['before'] }}"&gt;Previous&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href="?p={{ records['next'] }}"&gt;Next&lt;/a&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;</pre></div></div><div class="section" title="navbar.volt"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec80"/>navbar.volt</h2></div></div></div><p>The <code class="literal">navbar.volt</code> file<a id="id550" class="indexterm"/> contains a link to our home page and all the <a id="id551" class="indexterm"/>categories available. We will assign categories to the view later in this chapter.</p><p>The code is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;div class="lp-masthead"&gt;
  &lt;div class="container"&gt;
    &lt;nav class="lp-nav"&gt;
      &lt;a class="lp-nav-item active" href="{{ url('') }}"&gt;Home&lt;/a&gt;
      {% for category in categories['items'] %}
      &lt;a class="lp-nav-item" href="{{ url('categories/' ~ category['category_translations'][0]['category_translation_slug']) }}"&gt;{{ category['category_translations'][0]['category_translation_name']}}&lt;/a&gt;
      {% endfor %}
    &lt;/nav&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div></div><div class="section" title="layout.volt"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec81"/>layout.volt</h2></div></div></div><p>Let's move on to <code class="literal">layout.volt</code>. There is<a id="id552" class="indexterm"/> already a file located in<a id="id553" class="indexterm"/> the <code class="literal">modules/Frontend/Views/Default/</code> folder. We created it in <a class="link" href="ch02.html" title="Chapter 2. Setting Up the MVC Structure and the Environment for Our Project">Chapter 2</a>, <span class="emphasis"><em>Setting Up the MVC Structure and the Environment for Our Project</em></span>. Clear its contents and add the following:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
&lt;meta charset="utf-8"&gt;
&lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
&lt;title&gt;{% block pageTitle %}Learning Phalcon{% endblock %}&lt;/title&gt;

{{ stylesheetLink('../assets/default/bower_components/bootstrap/dist/css/bootstrap.min.css') }}
{{ stylesheetLink('../assets/default/css/lp.css') }}

&lt;!--[if lt IE 9]&gt;
  &lt;script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"&gt;
&lt;/script&gt;
  &lt;script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"&gt;
&lt;/script&gt;
&lt;![endif]--&gt;
&lt;/head&gt;
&lt;body&gt;
  {% block navbar %}
    {% include 'common/navbar.volt' %}
  {% endblock %}

  &lt;div class="container"&gt;
    &lt;div class="lp-header"&gt;
      &lt;h1 class="lp-title"&gt;Learning Phalcon&lt;/h1&gt;
      &lt;p class="lead lp-description"&gt;The fastest PHP Framework&lt;/p&gt;
    &lt;/div&gt;

    &lt;div class="row"&gt;
      &lt;div class="col-sm-12 lp-main"&gt;
        {% block body %}

        {% endblock %}
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  {% block footer %}
    {% include 'common/footer.volt' %}
  {% endblock %}

  {{ javascriptInclude("../assets/default/bower_components/jquery/dist/jquery.min.js") }}
  {{ javascriptInclude("../assets/default/bower_components/bootstrap/dist/js/bootstrap.min.js") }}
  {{ javascriptInclude("../assets/default/js/lp.js") }}
  {% block javascripts %} {% endblock %}
&lt;/body&gt;
&lt;/html&gt;</pre></div><p>Notice that here we <a id="id554" class="indexterm"/>are using the <code class="literal">javascriptInclude()</code> and <code class="literal">stylesheetLink()</code> methods, which are available by default in Volt. If you<a id="id555" class="indexterm"/> want, you can use the assets manager as we did for the Backoffice module. We also need a simple CSS file. You should already have a file named <code class="literal">lp.css</code> in the <code class="literal">public/assets/default/css/</code> folder. Clear its content and add this:</p><div class="informalexample"><pre class="programlisting">@import url(http://fonts.googleapis.com/css?family=News+Cycle:400,700);

body { font-family: "News Cycle"; color: #555; }

h1, .h1, h2, .h2, h3, .h3, h4, .h4, h5, .h5, h6, .h6 {
    margin-top: 0; font-family: "News Cycle"; font-weight: normal; color: #333;
}

.container {
    width: 720px;
}

.lp-masthead { background-color: #356aa0; -webkit-box-shadow: inset 0 -2px 5px rgba(0, 0, 0, .1); box-shadow: inset 0 -2px 5px rgba(0, 0, 0, .1); }
.lp-nav-item { position: relative; display: inline-block; padding: 10px; font-weight: 500; color: #cdddeb; }

.lp-nav-item:hover,
.lp-nav-item:focus {
    color: #fff; text-decoration: none;
}

.lp-nav .active       { color: #fff; }
.lp-nav .active:after { position: absolute; bottom: 0; left: 50%; width: 0; height: 0; margin-left: -5px; vertical-align: middle; content: " "; border-right: 5px solid transparent; border-bottom: 5px solid; border-left: 5px solid transparent; }
.lp-header            { padding-top: 20px; padding-bottom: 20px; }

.lp-title       { margin-top: 30px; margin-bottom: 0; font-size: 30px; font-weight: normal; }
.lp-description { font-size: 16px; color: #999; }

.lp-main            { font-size: 13px; line-height: 1.5; }

.pager           { margin-bottom: 60px; text-align: left; }
.pager&gt;li&gt;a      { width: 140px; padding: 10px 20px; text-align: center; border-radius: 30px; }

.lp-post       { margin-bottom: 60px; }
.lp-post-title { margin-bottom: 5px; font-size: 40px; }
.lp-post-meta  { margin-bottom: 20px; color: #999; }

.lp-footer              { padding: 40px 0; color: #999; text-align: center; background-color: #f9f9f9; border-top: 1px solid #e5e5e5; }
.lp-footer p:last-child { margin-bottom: 0; }</pre></div></div></div></div>
<div class="section" title="Modifying BaseController.php"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec55"/>Modifying BaseController.php</h1></div></div></div><p>Now, we should <a id="id556" class="indexterm"/>modify <code class="literal">BaseController.php</code> from the <code class="literal">Frontend</code> module to extend the core module and to assign categories globally to our views upon each request. Open <code class="literal">modules/Frontend/Controllers/BaseController.php</code>, clear its contents, and append this code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Frontend\Controllers;

class BaseController extends \App\Core\Controllers\BaseController
{
    public function afterExecuteRoute()
    {
        $this-&gt;view-&gt;categories = $this-&gt;apiGet('categories');
    }
}</pre></div><p>We don't actually have a home page (but we can add one anytime we want), so we are going to forward the request to <code class="literal">ArticlesController</code>. Open <code class="literal">modules/Frontend/Controllers/IndexController.php</code>, remove <code class="literal">indexAction()</code>, and append the following code:</p><div class="informalexample"><pre class="programlisting">  public function indexAction()
  {
      return $this-&gt;dispatcher-&gt;forward([
    'controller' =&gt; 'article',
    'action' =&gt; 'list'
      ]);
  }</pre></div><p>The last step is to create the <code class="literal">listAction()</code> method and the view for the articles. First, create a new file named <code class="literal">list.item.volt</code> in the <code class="literal">modules/Frontend/Views/Default/article/common/</code> folder with this content:</p><div class="informalexample"><pre class="programlisting">{% for record in records['items'] %}
{% if (record['article_is_published'] == 1) %}
&lt;div class="lp-post"&gt;
  &lt;h2 class="lp-post-title"&gt;{{ record['article_translations'][0]
  ['article_translation_short_title'] }}&lt;/h2&gt;
  &lt;p class="lp-post-meta"&gt;
  {{ record['article_created_at']|date("d M Y") }} by
    &lt;a href="#"&gt;
  {{ record['article_author']['user_first_name']}}
  {{ record['article_author']['user_last_name']}}
    &lt;/a&gt;&lt;/p&gt;
  &lt;p&gt;
  {{ record['article_translations'][0]
  ['article_translation_long_title'] }}
  &lt;a href="{{ url('article/' ~ record['article_translations'][0]
    ['article_translation_slug']) }}"&gt;Read more&lt;/a&gt;
  &lt;/p&gt;
&lt;/div&gt;
{% endif %}
{% endfor %}</pre></div><p>We also need to <a id="id557" class="indexterm"/>modify the layout from <code class="literal">modules/Frontend/Views/Default/article/list.volt</code>. Open this file, clear its content, and append this code:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
    {% include 'article/common/list.item' with {'records':records} %}
    {% if records['total_items'] &gt; 2 %}
    {% include 'common/paginator' with {'records':records} %}
    {% endif %}
{% endblock %}</pre></div><p>You can see that we show <code class="literal">paginator</code> only if we have more than two records (you can change this whenever you want). This is related to the <code class="literal">$limit</code> parameter from the <code class="literal">listAction()</code> method of <code class="literal">ArticleController</code>. Open <code class="literal">modules/Frontend/Controllers/ArticleController.php</code>, and append the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Frontend\Controllers;

class ArticleController extends BaseController{
  public function listAction() {
    $page = $this-&gt;request-&gt;getQuery('p', 'int', 1);

    try {
      $records = $this-&gt;apiGet('articles',['p' =&gt; $page, 'limit' =&gt; 2]);
      $this-&gt;view-&gt;records = $records;
    } catch (\Exception $e) {
      $this-&gt;flash-&gt;error($e-&gt;getMessage());
    }
  }
}</pre></div><p>Basically, we are<a id="id558" class="indexterm"/> done with this part. You can now open <code class="literal">http://www.learning-phalcon.localhost/</code>, and you should see something similar to this screenshot:</p><div class="mediaobject"><img src="graphics/B03522_09_02.jpg" alt="Modifying BaseController.php"/></div><p>Next, we will<a id="id559" class="indexterm"/> make a few changes to the articles controller in order to get an article by its slug. Personally, I like to keep things separated as much as possible, in case I need to implement complex logic in the future. We will create a new method in the API (<code class="literal">ArticlesController</code>) named <code class="literal">getBySlugAction()</code>. A slug is a friendly URL used for SEO (<span class="strong"><strong>Search Engine Optimization</strong></span>) purposes. Open <code class="literal">modules/Api/Controllers/ArticlesController.php</code> and append the following code:</p><div class="informalexample"><pre class="programlisting">public function getBySlugAction($slug) {
  try {
    $manager = $this-&gt;getDI()-&gt;get('core_article_manager');

    $st_output = $manager-&gt;restGet([
      'article_translation_slug = :article_translation_slug:',
      'bind' =&gt; [
        'article_translation_slug' =&gt; $slug,
      ],
    ]);

    return $this-&gt;render($st_output);
  } catch (\Exception $e) {
    return $this-&gt;render([
      'code' =&gt; $e-&gt;getCode(),
      'message' =&gt; $e-&gt;getMessage(),
    ], $e-&gt;getCode());
  }
}</pre></div><p>This method is <a id="id560" class="indexterm"/>similar to <code class="literal">getAction()</code>. We are searching by slug, therefore we will need to modify the <code class="literal">find()</code> method from <code class="literal">ArticleManager.php</code>. Our new <code class="literal">find()</code> method will look like this:</p><div class="informalexample"><pre class="programlisting">public function find($parameters = null) {
  if (isset($parameters['bind']['article_translation_slug'])) {
    $translation = ArticleTranslation::findFirst($parameters);
    if ($translation-&gt;count() !== 1) {
      return [$translation-&gt;getArticle()-&gt;toArray()];
    } else {
      throw new \Exception('Article not found', 404);
    }
  } elseif (isset($parameters['bind']['category_translation_slug'])) {
      $category_translation = CategoryTranslation::findFirst($parameters);
      if ($category_translation-&gt;count() !== 1) {
        return $category_translation-&gt;getCategory()-&gt;getArticles();
      } else {
        throw new \Exception('Article not found', 404);
      }
  } else {
    return Article::find($parameters);
  }
}</pre></div><p>We check whether the <code class="literal">article_translation_slug</code> parameter is set. If it is set, instead of calling the <code class="literal">Article::find()</code> method, we call <code class="literal">ArticleTranslation::findFirst()</code>. If we get results, we return the object as an array. We apply the same logic when we need to retrieve an article from a certain category. This code will not work unless we also modify the <code class="literal">restGet()</code> method from <code class="literal">BaseManager.php</code>. Our current <code class="literal">restGet()</code> method contains the following line:</p><div class="informalexample"><pre class="programlisting">$result = $objects-&gt;filter(function ($object) {
  return $object-&gt;toArray();
});</pre></div><p>Replace this line with the following code:</p><div class="informalexample"><pre class="programlisting">if (is_array($objects)) {
  $result = $objects;
} else {
  $result = $objects-&gt;filter(function ($object) {
    return $object-&gt;toArray();
  });
}</pre></div><p>This modified <a id="id561" class="indexterm"/>code checks whether the result from <code class="literal">$this-&gt;find()</code> is an array. If it is, we don't need to filter anything. Now, we switch to <code class="literal">modules/Frontend/Controllers/ArticleController.php</code> and add a new method. It will get an article by its slug:</p><div class="informalexample"><pre class="programlisting">public function readAction($slug) {
  try {
    $records = $this-&gt;apiGet("articles/slug/$slug");

    $this-&gt;view-&gt;records = $records;
  } catch (\Exception $e) {
    $this-&gt;flash-&gt;error($e-&gt;getMessage());
  }
}</pre></div><p>We are missing the routing information. We need to add routing for both the <code class="literal">Api</code> and <code class="literal">Frontend</code> modules. In <code class="literal">modules/Api/Config/routing.php</code> (the article group), add this line:</p><div class="informalexample"><pre class="programlisting">$articles-&gt;addGet('/slug/{slug}', ['action' =&gt; 'getBySlug']);</pre></div><p>Then in <code class="literal">modules/Frontend/Config/routing.php</code>, replace the last routing line with the following code:</p><div class="informalexample"><pre class="programlisting">$router-&gt;add('#^/articles/([a-zA-Z0-9\-]+)[/]{0,1}$#', array(
  'module' =&gt; 'frontend',
  'controller' =&gt; 'article',
  'action' =&gt; 'read',
  'slug' =&gt; 1,
));</pre></div><div class="section" title="The Article item template"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec82"/>The Article item template</h2></div></div></div><p>We also need a <a id="id562" class="indexterm"/>template for reading an article. Switch to <code class="literal">modules/Frontend/Views/Default/article/common/</code>, create a new file, name it <code class="literal">item.volt</code>, and add the following code:</p><div class="informalexample"><pre class="programlisting">{% for record in records['items'] %}
{% if (record['article_is_published'] == 1) %}
&lt;div class="lp-post"&gt;
  &lt;h2 class="lp-post-title"&gt;{{ record['article_translations'][0]
  ['article_translation_short_title'] }}&lt;/h2&gt;
  &lt;p class="lp-post-meta"&gt;{{ record['article_created_at']|date(
    "d M Y") }} by &lt;a href="#"&gt;
    {{ record['article_author']['user_first_name']}}
    {{ record['article_author']['user_last_name'] }}&lt;/a&gt;&lt;/p&gt;
  &lt;p&gt;
  &lt;strong&gt;{{ record['article_translations'][0]
  ['article_translation_long_title'] }}&lt;/strong&gt;
  &lt;/p&gt;
  &lt;p&gt;
    {{ record['article_translations'][0]
    ['article_translation_description'] }}
  &lt;/p&gt;
&lt;/div&gt;
{% endif %}
{% endfor %}</pre></div><p>The template for <code class="literal">readAction()</code> (<code class="literal">modules/Frontend/Views/Default/article/read.volt</code>) should have this code:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
{% include 'article/common/item' with {'records':records} %}
{% endblock %}</pre></div><p>This is it! You can now access <code class="literal">http://www.learning-phalcon.localhost/</code>. Click on the <span class="strong"><strong>Read more</strong></span> link and you should see a result similar to this:</p><div class="mediaobject"><img src="graphics/B03522_09_03.jpg" alt="The Article item template"/></div></div><div class="section" title="Retrieving articles from a category"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec83"/>Retrieving articles from a category</h2></div></div></div><p>We are missing the <a id="id563" class="indexterm"/>implementation of retrieving articles from a category (the top bar navigation). We need to do this by following these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add routing information for the <code class="literal">Api</code> module to <code class="literal">modules/Api/Config/routing.php</code>:<div class="informalexample"><pre class="programlisting">$articles-&gt;addGet('/category/{slug}', ['action' =&gt; 'getByCategorySlug']);</pre></div></li><li class="listitem">Create a new method called <code class="literal">getByCategorySlugAction()</code> in <code class="literal">modules/Api/Controllers/ArticlesController.php</code>:<div class="informalexample"><pre class="programlisting">public function getByCategorySlugAction($slug) {
  try {
    $manager = $this-&gt;getDI()-&gt;get('core_article_manager');

    $st_output = $manager-&gt;restGet([
      'category_translation_slug = :category_translation_slug:',
        'bind' =&gt; [
          'category_translation_slug' =&gt; $slug,
        ],
    ]);

    return $this-&gt;render($st_output);
  } catch (\Exception $e) {
    return $this-&gt;render([
      'code' =&gt; $e-&gt;getCode(),
      'message' =&gt; $e-&gt;getMessage(),
    ], $e-&gt;getCode());
  }
}</pre></div></li><li class="listitem">Add<a id="id564" class="indexterm"/> routing information for the Frontend module to <code class="literal">modules/Frontend/Config/routing.php</code>:<div class="informalexample"><pre class="programlisting">$router-&gt;add('#^/categories/([a-zA-Z0-9\-]+)[/]{0,1}$#', array(
    'module' =&gt; 'frontend',
    'controller' =&gt; 'article',
    'action' =&gt; 'categories',
    'slug' =&gt; 1,
));</pre></div></li><li class="listitem">Create a new method, <code class="literal">categoriesAction()</code>, in <code class="literal">modules/Frontend/Controllers/ArticleController.php</code>:<div class="informalexample"><pre class="programlisting">public function categoriesAction($slug) {
  $this-&gt;view-&gt;pick('article/list');

  try {
    $records = $this-&gt;apiGet("articles/category/$slug");

            $this-&gt;view-&gt;records = $records;
        } catch (\Exception $e) {
            $this-&gt;flash-&gt;error($e-&gt;getMessage());
        }
    }</pre></div></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip23"/>Tip</h3><p>Note that we are picking the articles and list view in <code class="literal">categoriesAction()</code> because there is no point in duplicating the code; it is the same code as that for listing articles.</p></div></div><p>Now we have a<a id="id565" class="indexterm"/> minimal, functional frontend. We can navigate through the articles, get articles from a category, and read an article. We will not go further with this because things can get too complex. In this chapter, we will only add a feature and improve speed by indexing articles in Elasticsearch.</p><p>If you want to practice more, you can implement a simple search form to search for articles by title or implement a profile page for authors.</p></div></div>
<div class="section" title="Implementing ElasticSearch"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec56"/>Implementing ElasticSearch</h1></div></div></div><p>What is <span class="strong"><strong>Elasticsearch</strong></span> (<span class="strong"><strong>ES</strong></span>)? The short answer is: it's a<a id="id566" class="indexterm"/> search server. According to Wikipedia, this is the complete definition:</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>Elasticsearch is a search server based on Lucene. It provides a distributed, multitenant-capable full-text search engine with a RESTful web interface and schema-free JSON documents. Elasticsearch is developed in Java and is released as open source under the terms of the Apache License. Elasticsearch is the second most popular enterprise search engine.</em></span></p></blockquote></div><p>If you need full-text search, real-time analytics of structured data, or a combination of the two, Elasticsearch is a very powerful tool, fit for you. All the big players use it. We will use ES in front of MySQL to store and search for articles. In this way we will reduce the traffic to MySQL and avoid querying it too often. We are not going to discuss ES in detail, so please spend a few minutes reading about its basic operation at <a class="ulink" href="http://www.elastic.co/guide/">http://www.elastic.co/guide/</a>.</p><div class="section" title="Installing ElasticSearch"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec84"/>Installing ElasticSearch</h2></div></div></div><p>There is an APT<a id="id567" class="indexterm"/> repository available for download. We will perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a terminal and type the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ wget -qO - https://packages.elasticsearch.org/GPG-KEY-elasticsearch | sudo apt-key add -</strong></span>
<span class="strong"><strong>$ sudo add-apt-repository "deb http://packages.elasticsearch.org/elasticsearch/1.4/debian stable main"</strong></span>
<span class="strong"><strong>$ sudo apt-get update &amp;&amp; sudo apt-get install elasticsearch</strong></span>
</pre></div></li><li class="listitem">After installation, you can configure the repository to start during boot-up by executing this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo update-rc.d elasticsearch defaults 95 10</strong></span>
</pre></div><p>The command used to start the service is as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo service elasticsearch start</strong></span>
</pre></div><p>The command used to test whether it is running is the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ curl -X GET http://localhost:9200/</strong></span>
</pre></div><p>You should get a JSON response similar to this:</p><div class="informalexample"><pre class="programlisting">{
  "status" : 200,
  "name" : "Lord Pumpkin",
  "cluster_name" : "elasticsearch",
  "version" : {
    "number" : "1.4.4",
    "build_hash" : "c88f77ffc81301dfa9dfd81ca2232f09588bd512",
    "build_timestamp" : "2015-02-19T13:05:36Z",
    "build_snapshot" : false,
    "lucene_version" : "4.10.3"
  },
  "tagline" : "You Know, for Search"
}</pre></div></li><li class="listitem">We will <a id="id568" class="indexterm"/>need a client library to work with. Fortunately, there is one available. In the terminal, we switch to the root folder of our project and type this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php composer.phar require "elasticsearch/elasticsearch":"1.3.3"</strong></span>
</pre></div></li></ol></div><p>This will install the PHP client but also a lot of dependencies. It might take a while, so don't worry about it. Next, we will set up this client in our project. If you have no experience with ES, please spend <a id="id569" class="indexterm"/>10 minutes reading the documents for the PHP client at <a class="ulink" href="http://www.elastic.co/guide/en/elasticsearch/client/php-api/current/index.html">http://www.elastic.co/guide/en/elasticsearch/client/php-api/current/index.html</a>.</p></div><div class="section" title="Enabling a client in DI"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec85"/>Enabling a client in DI</h2></div></div></div><p>Before using the<a id="id570" class="indexterm"/> ES client, we need to enable it in DI. Open <code class="literal">config/services.php</code> and add the following code:</p><div class="informalexample"><pre class="programlisting">$di['elastic'] = function() {
    return new \Elasticsearch\Client();
};</pre></div></div><div class="section" title="Indexing (storing) documents"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec86"/>Indexing (storing) documents</h2></div></div></div><p>If we want to index documents, we <a id="id571" class="indexterm"/>will need to add some methods to our manager. Also, we will have to make some modifications for data types. First, we will create a common method to paginate array results. Open <code class="literal">modules/Core/Managers/ArticleManager.php</code> and append the following code:</p><div class="informalexample"><pre class="programlisting">protected function paginate($data, $limit, $page)
{
    $paginator = new \Phalcon\Paginator\Adapter\NativeArray(
      array(
          "data" =&gt; $data,
          "limit"=&gt; $show,
          "page" =&gt; $page
      )
    );

    $items = $paginator-&gt;getPaginate();

    if ($items-&gt;total_items &gt; 0) {
      return $items;
    }

    return false;
}</pre></div><p>We create a method that should normalize the data before we send it to the ES index:</p><div class="informalexample"><pre class="programlisting">protected function esNormalize($article) {
  $body = json_decode(json_encode($article-&gt;toArray(),
    JSON_NUMERIC_CHECK), true);
  $body['article_created_at'] = str_replace(' ', 'T', 
  $body['article_created_at']);
  if ($body['article_updated_at'] != '') {
    $body['article_updated_at'] = str_replace(' ', 'T', 
    $body['article_updated_at']);
  } else {
    $body['article_updated_at'] = $body['article_created_at'];
  }
  return $body;
}</pre></div><p>The <code class="literal">json_encode</code> and <code class="literal">json_decode</code> methods are used to force the conversion of string values that contain only numbers to numeric/integer values. We also replace the empty space between the date<a id="id572" class="indexterm"/> and time from MySQL with <code class="literal">T</code>. This ISO format is auto-recognized by ES as a date and it will then set the field type accordingly. We also force the <code class="literal">article_updated_at</code> field to get a valid date value. If we don't do this, we will not be able to search for an article between certain intervals of time. Next, we will create a method in the same manager that will index the article in ES. Append this code in the manager:</p><div class="informalexample"><pre class="programlisting">public function esIndex($article) {
  $elastic_manager = $this-&gt;getDI()-&gt;get('elastic');

  $params          = array();
  $params['index'] = 'learningphalcon';
  $params['type']  = 'article';
  $params['id']    = 'article-' . $article-&gt;getId();
  $params['body']  = $this-&gt;esNormalize($article);

  $elastic_manager-&gt;index($params);

  return true;
}</pre></div><p>Whenever we index data, ES expects a certain format. This format is represented in the <code class="literal">esIndex()</code> method. To compare the parameters with a MySQL structure, you can think about something like this:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">index</code>: The database name</li><li class="listitem" style="list-style-type: disc"><code class="literal">type</code>: The table name</li><li class="listitem" style="list-style-type: disc"><code class="literal">id</code>: The ID (primary key)</li><li class="listitem" style="list-style-type: disc"><code class="literal">body</code>: A field named body from a table that contains a JSON-encoded database</li></ul></div><p>The <code class="literal">esIndex()</code> method always returns true, but we must be careful and always use <code class="literal">try {},catch() {}</code> because <code class="literal">esindex()</code> can throw exceptions. If an article already exists in the ES index, it will be updated. Let's create a simple task that will retrieve all the articles from MySQL and index them into ES. Open <code class="literal">modules/Task/ArticlesTask.php</code> and append this code:</p><div class="informalexample"><pre class="programlisting">public function esindexAction() {
  $article_manager = $this-&gt;getDI()-&gt;get('core_article_manager');

  foreach ($article_manager-&gt;find() as $article) {
    try {
      $article_manager-&gt;esindex($article);
      $this-&gt;consoleLog("Article {$article-&gt;getId()} has been indexed");
    } catch (\Exception $e) {
      $this-&gt;consoleLog("Article {$article-&gt;getId()} has not been indexed. Reason: {$e-&gt;getMessage()}", "red");
    }
  }
}</pre></div><p>Make sure that <a id="id573" class="indexterm"/>you have some articles in the database. If not, navigate to Backoffice and add some. Then open a terminal, switch to the root folder of your project, and execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php modules/cli.php article esindex</strong></span>
</pre></div><p>You should see an output similar to this:</p><div class="mediaobject"><img src="graphics/B03522_09_01.jpg" alt="Indexing (storing) documents"/></div><p>At this point, we have articles indexed in ES. Each time we update, add, or delete an article from MySQL, we have to reflect this action in ES. We are already doing this when we add an article. Let's implement it for updates and deletions.</p><p>We don't need to create a special method to update articles in ES. It is enough to submit the index of the same article. ES will find it by ID and update it automatically. All we need to do is implement the functionality as we did for <code class="literal">createAction()</code>.</p><p>Let's follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"> Open <code class="literal">modules/Backoffice/Controllers/ArticleController.php</code>.</li><li class="listitem">Go to the <code class="literal">updateAction()</code> method:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$this-&gt;persistent-&gt;set('es_add_to_index_id', $object_id);</strong></span>
</pre></div></li><li class="listitem">Append the preceding code right after the following line:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$this-&gt;flashSession-&gt;success('Object was updated successfully');</strong></span>
</pre></div></li><li class="listitem">We need to modify the <code class="literal">editAction()</code> method. Remove the current method and replace it with this one:<div class="informalexample"><pre class="programlisting">public function editAction($id) {
  $manager = $this-&gt;getDI()-&gt;
    get('core_article_manager');
  $object = $manager-&gt;findFirstById($id);
  if (!$object) {
    $this-&gt;flashSession-&gt;error('Object not found');
    return $this-&gt;response-&gt;redirect('article/list');
  }
  if ($es_add_to_index_id = $this-&gt;persistent-&gt;
    get('es_add_to_index_id')) {
    $article = $manager-&gt;findFirstByid(
      $es_add_to_index_id);
      try {
        $manager-&gt;esindex($article);
      } catch (\Exception $e) {
        $this-&gt;flash-&gt;error("Article was not added to ES 
          index");
      }
    }

    $this-&gt;persistent-&gt;set('id', $id);
    $this-&gt;view-&gt;form = $manager-&gt;getForm(
      $object,['edit' =&gt; true]);
}</pre></div></li></ol></div><p>This is all we need to do when updating an article. From now on, whenever you make changes, those changes will<a id="id574" class="indexterm"/> be reflected in ES. When we delete an article from MySQL, we will have to delete it from ES too. Let's create a simple delete method in <code class="literal">ArticleManager.php</code>:</p><div class="informalexample"><pre class="programlisting">    public function esdelete($article_id)
    {
        $elastic_manager = $this-&gt;getDI()-&gt;get('elastic');

        $params['index'] = 'learningphalcon';
        $params['type']  = 'article';
        $params['id']  = 'article-'.(int)$article_id;

        try {
            $elastic_manager-&gt;delete($params);
        } catch (\Exception $e) {

        }
    }</pre></div><p>As you can see, all<a id="id575" class="indexterm"/> that we need to do is provide three keys: <code class="literal">index</code>, <code class="literal">type</code>, and <code class="literal">id</code>. Then we call the <code class="literal">delete()</code> method, and if it is found, the article is removed. The last step is to call <code class="literal">esdelete()</code> when we delete an article. Open <code class="literal">modules/Backoffice/Controllers/ArticleController.php</code> again, go to <code class="literal">deleteAction()</code>, and append the <code class="literal">$manager-&gt;esdelete($id);</code> line right after <code class="literal">$manager-&gt;delete($id);</code>. Now, when we remove articles from MySQL, they will be removed from ES too.</p><p>We will not go further into ES. You should spend some time and implement a search form to retrieve articles from ES. As a tip, here is a simple way to search ES articles by category slug:</p><div class="informalexample"><pre class="programlisting">    public function elasticSearchByCategorySlug($categorySlug, $show, $page, $limit)
    {
        $elastic_manager = $this-&gt;getDI()-&gt;get('elastic');
        $params['index'] = 'learningphalcon';
        $params['type']  = 'article';

        $params['body']['from'] = 0;
        $params['body']['size'] = $limit;

        $params['body']['query']['bool']['must'] = array(
            array('match' =&gt; array('category_translation_slug' =&gt; $categorySlug))
        );

        $params['body']['sort'] = [
            'post_id' =&gt; ['order' =&gt; 'desc']
        ];

        $queryResponse = $elastic_manager-&gt;search($params);

        foreach ($queryResponse['hits']['hits'] as $hit) {
            $tmp['items'][] = $hit['_source'];
        }

        return $this-&gt;paginate($tmp['items'], $show, $page);
    }</pre></div></div></div>
<div class="section" title="Implementing MongoDB"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec57"/>Implementing MongoDB</h1></div></div></div><p>In this section, we will implement a <a id="id576" class="indexterm"/>simple log for articles. Of course, you can have your entire website running on Mongo. It is incredibly fast, but personally, I don't like to use it for big projects because Mongo can be very greedy with space. In order to get an overall idea, in the past, I had to index prices for nearly 5,000 properties (apartments, villas, and houses) for 4 years and the size requirement was approximately 50 GB. At my current workplace, we have migrated SMS logs to Mongo and we have nearly 3 million SMS logs for about 20 GB of space. For a relatively small website, MongoDB is perfect, or if you know that space won't be an issue, just go for it.</p><p>We will not cover<a id="id577" class="indexterm"/> Mongo in this section, but there will an example that shows how to implement it using Phalcon. If you have no idea about Mongo, spare some time and read the basics at <a class="ulink" href="http://docs.mongodb.org/manual/">http://docs.mongodb.org/manual/</a>.</p><p>That being said, let's start implementing the logs. What are we going to log? Article IDs, user IP addresses, user agents, and timestamps. From this, you will be able to show the number of times an article was read and also generate simple reports.</p><div class="section" title="Mongo models"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec87"/>Mongo models</h2></div></div></div><p>Switch to<a id="id578" class="indexterm"/> <code class="literal">modules/Core/Models</code> and create a new folder named Mongo. In this new folder, create two new files with the following code.</p><div class="section" title="modules/Core/Models/Mongo/BaseCollection.php"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec15"/>modules/Core/Models/Mongo/BaseCollection.php</h3></div></div></div><p>The <code class="literal">modules/Core/Models/Mongo/BaseCollection.php</code> file is a simple base class that <a id="id579" class="indexterm"/>extends <code class="literal">\Phalcon\Mvc\Collection</code>. You can use it in the future to add common logic as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models\Mongo;

class BaseCollection extends \Phalcon\Mvc\Collection
{
}</pre></div></div><div class="section" title="modules/Core/Models/Mongo/ArticleLog.php"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec16"/>modules/Core/Models/Mongo/ArticleLog.php</h3></div></div></div><p>This class is the model for our <code class="literal">article_log</code> collection <a id="id580" class="indexterm"/>and has two important methods: <code class="literal">log()</code> and <code class="literal">countVisits()</code>. We are going to use them to log article visits and count them:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models\Mongo;

class ArticleLog extends BaseCollection
{
    public $article_id;

    public $client_ip;

    public $user_agent;

    public $timestamp;

    public function getSource()
    {
        return 'article_log';
    }

    public function log($article_id, \Phalcon\Http\Request $request)
    {
        $log = new self();
        $log-&gt;article_id = (int) $article_id;
        $log-&gt;client_ip  = $request-&gt;getClientAddress();
        $log-&gt;user_agent = $request-&gt;getUserAgent();
        $log-&gt;timestamp  = time();

        $log-&gt;save();
    }

    public function countVisits($article_id, $unique = false)
    {
        if (false === $unique) {
            return $this-&gt;count(array(
                array(
                    "article_id" =&gt; $article_id
                )
            ));
        } else {
            $result = $this-&gt;getConnection()-&gt;command(
                array(
                    'distinct' =&gt; 'article_log',
                    'key' =&gt; 'client_ip',
                    'query' =&gt; ['article_id' =&gt; $article_id],
                )
            );

            return count($result['values']);
        }
    }

    public function columnMap()
    {
        return [
            'article_id' =&gt; 'article_id',
            'client_ip'  =&gt; 'client_ip',
            'user_agent' =&gt; 'user_agent',
            'timestamp'  =&gt; 'timestamp',
        ];
    }
}</pre></div><p>The <code class="literal">log()</code> method is <a id="id581" class="indexterm"/>pretty much straightforward. We assign values to variables and save the information in the <code class="literal">article_log</code> collection. The <code class="literal">countVisits()</code> method expects two parameters: <code class="literal">$article_id</code> and <code class="literal">$unique</code>. If we don't want to show the number of unique visits, this parameter must be set to <code class="literal">false</code> (the default value), and we can simply query the collection using the built-in <code class="literal">count()</code> method. If we need to show only the unique visits (unique by IP address), then we execute the <code class="literal">command()</code> action, which is available in MongoClient (Phalcon does not have this method implemented).</p><p>Let's switch to <code class="literal">ArticleManager.php</code> from the Core module and add these two methods so that we can call them from DI:</p><div class="informalexample"><pre class="programlisting">    public function mongoLog($article_id, \Phalcon\Http\Request $request)
    {
        $log = new ArticleLog();
        $log-&gt;log($article_id, $request);
    }

    public function countVisits($article_id, $unique = false)
    {
        $alog = new ArticleLog();
        return $alog-&gt;countVisits($article_id, $unique);
    }</pre></div><p>Now, we will modify the <code class="literal">readAction()</code> method from <code class="literal">ArticleController.php</code> (Frontend module). Remove the current one and append this code:</p><div class="informalexample"><pre class="programlisting">public function readAction($slug){
  try {
    $records = $this-&gt;apiGet("articles/slug/$slug");
    $manager = $this-&gt;getDI()-&gt;get(
      'core_article_manager');
    $total_views = $manager-&gt;countVisits(
      $records['items'][0]['id']);
    $manager-&gt;mongoLog($records['items'][0]['id'],
      $this-&gt;request);
    $this-&gt;view-&gt;records = $records;
    $this-&gt;view-&gt;total_views = $total_views;
  } catch (\Exception $e) {
    $this-&gt;flash-&gt;error($e-&gt;getMessage());
  }
}</pre></div><p>Notice the line that contains <code class="literal">$total_views = $manager-&gt;countVisits($records['items'][0]['id']);</code>—we are not providing the<code class="literal"> $unique</code> parameter. This means that by default, we will not show unique visits. If you want to show them, append <code class="literal">true</code> like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$total_views = $manager-&gt;countVisits($records['items'][0]['id'], true);</strong></span>
</pre></div><p>The final step consists of<a id="id582" class="indexterm"/> making small modifications to our templates. Open <code class="literal">modules/Frontend/Views/Default/article/read.volt</code> and append the <code class="literal">total_views</code> parameter to <code class="literal">include</code>:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
    {% include 'article/common/item' with {'records':records, 'total_views' : total_views} %}
{% endblock %}</pre></div><p>Then, open <code class="literal">modules/Frontend/Views/Default/article/common/item.volt</code>, clear its contents, and append this code:</p><div class="informalexample"><pre class="programlisting">{% for record in records['items'] %}
{% if (record['article_is_published'] == 1) %}
&lt;div class="lp-post"&gt;
  &lt;h2 class="lp-post-title"&gt;
    {{ record['article_translations'][0]
      ['article_translation_short_title'] }}&lt;/h2&gt;
  &lt;p class="lp-post-meta"&gt;
    {{ record['article_created_at']|date("d M Y") }}
    by &lt;a href="#"&gt;
    {{record['article_author']['user_first_name'] }}
    {{ record['article_author']['user_last_name'] }}&lt;/a&gt;
    {% if dispatcher.getActionName() == 'read') %}
    &lt;span class="pull-right glyphicon glyphicon-eye-open"&gt;
    {{ total_views }}
    &lt;/span&gt;
    {% endif %}
  &lt;/p&gt;
  &lt;p&gt;
    &lt;strong&gt;{{ record['article_translations'][0]
    ['article_translation_long_title'] }}&lt;/strong&gt;
  &lt;/p&gt;
  &lt;p&gt;
    {{ record['article_translations'][0]
      ['article_translation_description'] }}
  &lt;/p&gt;
&lt;/div&gt;
{% endif %}
{% endfor %}</pre></div><p>The difference between the old <code class="literal">item.volt</code> file and new one is the code under <code class="literal">{% if dispatcher.getActionName() == 'read') %}</code>. We show the number of visits only in <code class="literal">readAction()</code>.</p><p>That's all about <a id="id583" class="indexterm"/>MongoDB and Phalcon. The functionality of Phalcon's ODM is similar to the ORM functionality, but it is not so advanced. You might find yourself in situations where you will be forced to use MongoClient from PHP. You can read more about the <a id="id584" class="indexterm"/>ODM at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/odm.html">http://docs.phalconphp.com/en/latest/reference/odm.html</a>.</p></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec58"/>Summary</h1></div></div></div><p>In this chapter, you learned a few new things about ElasticSearch and MongoDB. We created a simple Frontend module, and we now have a simple, fully functional website.</p><p>In the next and final chapter, we will discuss things that we didn't cover in previous chapters, such as uploading images and the annotation router.</p></div></body></html>