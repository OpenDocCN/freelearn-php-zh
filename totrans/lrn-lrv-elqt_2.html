<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Building the Database with the Schema Builder Class"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Building the Database with the Schema Builder Class</h1></div></div></div><p>Hey hero!</p><p>Our development environment is now ready. No more worries, and a whole new world awaits: the hero left his home. Little by little, step by step, he is going forward toward the goal. The hero knows what is really important: to stay grounded. Having a good foundation helps. No big differences for an application: a well-designed database for your project is always the best start.</p><p>Starting from this important assumption, the question naturally arises: is there a way, with Laravel, to deal with the design of a database before using it, maybe in a smart way that you can easily manage? The answer is, as you can imagine, yes.</p><p>In this chapter, we will look at the Schema Builder class. A very important class that lets you design your entire database without writing a single SQL line! Quite impressive if you think about it, considering that it is quite possible that you will build your entire application on a SQL database without using SQL! We will analyze everything you can do with the class: creating, dropping, and updating a table; adding, removing, and renaming columns. Also, we will look at indexing in many ways: not only simple indexes but also unique indexes and foreign keys. Also, we are going to look at some methods that the Schema class provides in order to have a real and total control over everything. Sometimes, you will need to be sure about what exists in your database!</p><p>After all this stuff, it is not be over yet. In fact, we will explore the world of <span class="strong"><strong>migrations</strong></span>, which is something Laravel uses to do versioning of your database. Combining the power of the Schema class with the <span class="strong"><strong>migrations system</strong></span> will give you great power over your data design. Also, it will be very easy to share your application with another new member of your team! You know that versioning is always the best choice.</p><p>An important note before going forward: even if the Schema Builder class and migrations system are not tightly related to Eloquent, they easily create a database with a structure that fits perfectly for the Eloquent standards and conventions. Also, the Schema Builder and migrations system are a part of the<a id="id36" class="indexterm"/> <code class="literal">illuminate/database</code> (<a class="ulink" href="https://github.com/illuminate/database">https://github.com/illuminate/database</a>) package; yes, the same package from Eloquent! Let's go.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The Schema Builder class</li><li class="listitem" style="list-style-type: disc">Database versioning with the migrations system</li></ul></div><div class="section" title="The Schema Builder class"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec15"/>The Schema Builder class</h1></div></div></div><p>The Schema Builder class<a id="id37" class="indexterm"/> is a tool that provides you with a <span class="emphasis"><em>database agnostic</em></span> way to deal with your database design. The term <span class="emphasis"><em>database agnostic</em></span> means that you will never have to worry about what database you are using: the only important thing is to use the right driver, as we saw before in the configuration part of the first chapter. So, if you think of switching your database system from SQLite to MySQL or SQL Server, don't worry: you will always have your structure ready to be used.</p><p>In the first part of this chapter, we will use some simple routes. All you have to do is to add them to the <code class="literal">app/routes.php</code> file.</p><div class="section" title="Working with tables"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec14"/>Working with tables</h2></div></div></div><p>Let's start<a id="id38" class="indexterm"/> with the very, very basic phenomena. The following is the <code class="literal">Schema::create()</code> method that you can use to create a new table in your database:</p><div class="mediaobject"><img src="graphics/3634_02_01.jpg" alt="Working with tables"/></div><p>The <code class="literal">create()</code> method<a id="id39" class="indexterm"/> accepts two parameters: the first method is the name of the table you want to create, and the second method is a closure where we will specify all the table fields. To be more precise, the closure parameter is a Blueprint object.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip03"/>Tip</h3><p>When possible, I like to use type-hinting for a better code readability.</p></div></div><p>So, you may<a id="id40" class="indexterm"/> read something like this:</p><div class="informalexample"><pre class="programlisting">Schema::create('users', function(Blueprint $table)
{
$table-&gt;increments('id');
});</pre></div><p>Don't worry, it's the same.</p><p>You will also be able to rename a table: in this case, just use the <code class="literal">rename()</code> method.</p><div class="informalexample"><pre class="programlisting">Schema::rename($previousName, $newName);</pre></div><p>Finally, what about dropping a table? The method <code class="literal">drop()</code> is here for you.</p><div class="informalexample"><pre class="programlisting">  Schema::drop($tableName);</pre></div><p>There is also a similar method, <code class="literal">dropIfExists()</code>, with the same syntax.</p><div class="informalexample"><pre class="programlisting">  Schema::dropIfExists($tableName);</pre></div><p>As the awesomely expressive name suggests, the method drops the table only if it exists in the database.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip04"/>Tip</h3><p>I often use this method instead of the simple <code class="literal">drop()</code> method.</p></div></div><p>Remember that if you want to check if a table exists, you can use the <code class="literal">hasTable()</code> method, as follows:</p><div class="informalexample"><pre class="programlisting">  if (Schema::hasTable('books')) 
  { 
    // the table "books" exists...
  }</pre></div><p>Now, let's take a look at how you can work with table columns.</p></div><div class="section" title="Working with columns"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec15"/>Working with columns</h2></div></div></div><p>Working<a id="id41" class="indexterm"/> with columns is quite easy. First of all, let's see how to create new columns while adding a new table to the database.</p><p>As I told you before, we will use the <code class="literal">$table</code> parameter of <code class="literal">Schema::create()</code>.</p><div class="informalexample"><pre class="programlisting">  Schema::create('books', function(Blueprint $table)
  {
      $table-&gt;increments('id');

      $table-&gt;string('title');

      $table-&gt;integer('pages_count');
      $table-&gt;decimal('price', 5, 2);
      
      $table-&gt;text('description');

      $table-&gt;timestamps();
  });</pre></div><p>The <code class="literal">Blueprint $table</code> object<a id="id42" class="indexterm"/> has many methods, which are related to the creation of a single <a id="id43" class="indexterm"/>new column. You can easily see that all the methods' names represent a specific type of column. For example, <code class="literal">string</code> is the equivalent of <code class="literal">VARCHAR</code> on MySQL, and <code class="literal">integer</code> is the equivalent of <code class="literal">INT</code>.</p><p>There are also some utility methods: if you take a look at the very first code line of the closure, you will read an <code class="literal">increments()</code> method. Nothing complex, however, it just creates an <code class="literal">id</code> integer field (also setting it as a primary key) with <code class="literal">autoincrement</code>.</p><p>Finally, you can see the <code class="literal">timestamps()</code> method in the last line. The Schema Builder class also has methods that are related to some Eloquent functionalities. In this case, the <code class="literal">timestamps()</code> method automatically creates two <code class="literal">DATETIME</code> equivalent fields, named <code class="literal">created_at</code> and <code class="literal">updated_at</code>. They can be quite useful if you want to track the time of insert and last update operations.</p><p>Now, why don't we make some tests, before going further?</p><p>It's a matter of seconds: just create a new <code class="literal">GET</code> route in the <code class="literal">app/routes.php</code> file and add that <code class="literal">Schema::create()</code> method we saw like this:</p><div class="informalexample"><pre class="programlisting">  // remember this "use" directive!
  use Illuminate\Database\Schema\Blueprint;

  Route::get('create_books_table', function(){

    Schema::create('books', function(Blueprint $table)
    {
        $table-&gt;increments('id');

        $table-&gt;string('title', 30);

        $table-&gt;integer('pages_count');
        $table-&gt;decimal('price', 5, 2);

        $table-&gt;text('description');

        $table-&gt;timestamps();
    });

  });</pre></div><p>We will create a table named <code class="literal">books</code> on our database. This table will have seven columns:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <a id="id44" class="indexterm"/>unique, primary key <code class="literal">id</code> as an integer</li><li class="listitem" style="list-style-type: disc">The <a id="id45" class="indexterm"/><code class="literal">title</code> column as a string (with 30 characters maximum)</li><li class="listitem" style="list-style-type: disc">The <a id="id46" class="indexterm"/><code class="literal">pages_count</code> integer column</li><li class="listitem" style="list-style-type: disc">The <a id="id47" class="indexterm"/><code class="literal">price</code> decimal column</li><li class="listitem" style="list-style-type: disc">The <a id="id48" class="indexterm"/><code class="literal">description</code> text column</li><li class="listitem" style="list-style-type: disc">The<a id="id49" class="indexterm"/> <code class="literal">created_at</code> and <a id="id50" class="indexterm"/><code class="literal">updated_at</code> columns, created by the <code class="literal">timestamps()</code> method</li></ul></div><p>Let's navigate <a id="id51" class="indexterm"/>to the <code class="literal">/create_books_table</code> URL and then open your Adminer (or whatever tool you like to deal with your database) to verify if everything went well.</p><p>This is the result!</p><div class="mediaobject"><img src="graphics/3634_02_02.jpg" alt="Working with columns"/></div><p>Good job! Let's take a look at the structure.</p><div class="mediaobject"><img src="graphics/3634_02_03.jpg" alt="Working with columns"/></div><p>Perfect. Exactly <a id="id52" class="indexterm"/>what we wanted—without a single SQL line!</p><p>Note that as we had done before for tables, we can also check if a specific column exists with<a id="id53" class="indexterm"/> the <code class="literal">hasColumn()</code> method:</p><div class="informalexample"><pre class="programlisting">  if (Schema::hasColumn('books', 'title')) 
  { 
    // the column "title" in the "books" table exists...
  }</pre></div></div><div class="section" title="Columns' methods reference"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec16"/>Columns' methods reference</h2></div></div></div><p>Here's a <a id="id54" class="indexterm"/>quick reference for all the methods you can use on the Blueprint <code class="literal">$table</code> instance:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Method</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;bigIncrements('id');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Incrementing ID using a <span class="emphasis"><em>big integer</em></span> equivalent</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;bigInteger('votes');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">BIGINT</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;binary('data');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">BLOB</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;boolean('confirmed');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">BOOLEAN</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;char('name', 4);</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">CHAR</code> equivalent with the length</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;date('created_at');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">DATE</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;dateTime('created_at');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">DATETIME</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;decimal('amount', 5, 2);</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">DECIMAL</code> equivalent with a precision and scale</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;double('column', 15, 8);</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">DOUBLE</code> equivalent with precision, 15 digits in total and 8 after the decimal point</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;enum('choices', ['foo', 'bar']);</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">ENUM</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;float('amount');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">FLOAT</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;increments('id');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Incrementing <code class="literal">ID</code> to the table (primary key)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;integer('votes');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">INTEGER</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;json('options');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">JSON</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;longText('description');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">LONGTEXT</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;mediumInteger('numbers');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">MEDIUMINT</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;mediumText('description');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">MEDIUMTEXT</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;nullableTimestamps();</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Same as <code class="literal">timestamps()</code>, except the fact that this allows NULLs</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;smallInteger('votes');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">SMALLINT</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;tinyInteger('numbers');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TINYINT</code> equivalent to the table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;string('email');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">VARCHAR</code> equivalent column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;string('name', 100);</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">VARCHAR</code> equivalent <a id="id55" class="indexterm"/>with the length of a string</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$table-&gt;text('description');</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TEXT</code> equivalent to the table</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note13"/>Note</h3><p>You can also find the complete reference in the <a id="id56" class="indexterm"/>Laravel official documentation, at the <a class="ulink" href="http://laravel.com/docs/5.0/schema#adding-columns">http://laravel.com/docs/5.0/schema#adding-columns</a> page.</p></div></div></div><div class="section" title="Other $table object methods"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec17"/>Other $table object methods</h2></div></div></div><p>If you <a id="id57" class="indexterm"/>take a look at the methods reference in the Laravel documentation, you will probably see some more than in the list you just saw.</p><p>The first methods reference is:</p><div class="informalexample"><pre class="programlisting">  $table-&gt;timestamps();</pre></div><p>I already used this in the example. It creates the table timestamps <code class="literal">created_at</code> and <code class="literal">updated_at</code> columns, which are really useful if you want to track chronological information about the creation or update of a specific record.</p><p>Eloquent also manages timestamps columns automatically, so you don't have to worry about them in your code.</p><p>Another important (and really similar) method is as follows:</p><div class="informalexample"><pre class="programlisting">  $table-&gt;softDeletes();</pre></div><p>It is used to add a <code class="literal">deleted_at</code> column to the desired table.</p><p>Sometimes, in your applications, it is really useful to keep some information even if you don't want to show it to the final user. Think about an e-commerce orders' history: the customer can choose to clean his history but you can't allow him/her to physically delete records!</p><p>The soft delete system solves this problem by adding a <code class="literal">deleted_at</code> column to a table in order to keep track of the delete date of a record.</p><p>Eloquent handles this system automatically, so you will be able to show a clean history to your customer and a complete list of orders to the shop administrator.</p><p>Next, you can see this:</p><div class="informalexample"><pre class="programlisting">  $table-&gt;rememberToken();</pre></div><p>This method adds a <code class="literal">remember_token</code> column.</p><p>The Laravel authentication system uses this token (a simple <code class="literal">VARCHAR 100</code>) to track the user status. It is used when you click on a <span class="strong"><strong>Remember Me</strong></span> checkbox in the login page of your application.</p><p>There are also <a id="id58" class="indexterm"/>some methods you can chain after some table columns' definitions.</p><p>If you want to make a numeric column unsigned, use the following:</p><div class="informalexample"><pre class="programlisting">  $table-&gt;integer('my_column')-&gt;unsigned();</pre></div><p>Of course, you can use it with every numeric field (float, decimal, and so on).</p><p>You can also specify if a column is nullable with <code class="literal">nullable()</code>:</p><div class="informalexample"><pre class="programlisting">  $table-&gt;string('my_column')-&gt;nullable();</pre></div><p>If you want to specify a default value, you can use the following:</p><div class="informalexample"><pre class="programlisting">  $table-&gt;string('my_column')-&gt;default('my_default_value');</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip05"/>Tip</h3><p>Sometimes, you will need to use <code class="literal">BIGINT</code> or equivalent for your primary keys. If this is the case, use <code class="literal">bigIncrements()</code> instead of <code class="literal">increments()</code> (that uses <code class="literal">INT</code> or equivalent).</p></div></div></div><div class="section" title="Updating tables and columns"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec18"/>Updating tables and columns</h2></div></div></div><p>What? Yeah, I <a id="id59" class="indexterm"/>know what you are thinking—what if I have to add a book named The Awesome Super Life of the Marvelous Francesco Malatesta? It's a 60-character-long name!</p><p>Things change, so our database will have to change too. In a simple way, though. You will use the <code class="literal">table</code> method to update an existing one.</p><p>Here you can see an example:</p><div class="informalexample"><pre class="programlisting">  Schema::table('table_name', function(Blueprint $table)
  {
    // update operations here...
  });</pre></div><p>So, let's make a little update. Create a new route in our routes file and name it <code class="literal">update_books_table</code>:</p><div class="informalexample"><pre class="programlisting">  Route::get('update_books_table', function(){

      Schema::table('books', function(Blueprint $table)
      {
          $table-&gt;string('title', 250)-&gt;change();
      });

  });</pre></div><p>Note that we<a id="id60" class="indexterm"/> used the <code class="literal">change()</code> method right after the <code class="literal">string()</code> method. You will use <code class="literal">change()</code> on changing a column. If you simply want to add a new column to an existing table, just use this as usual:</p><div class="informalexample"><pre class="programlisting">  $table-&gt;string('title', 250);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note14"/>Note</h3><p>You will need the <code class="literal">doctrine/dbal</code> package to change columns. To obtain it, just add the <code class="literal">doctrine/dbal</code> to your <code class="literal">composer.json</code> file: 2.5.0 dependency.</p><p>Then, type <code class="literal">composer update</code> in your terminal and you are good to go.</p></div></div><p>Browse to the new URL and update the table. Now you will be able to add my awesome biography to your library in the future. Be proud of it.</p></div><div class="section" title="Indexes and foreign keys"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec19"/>Indexes and foreign keys</h2></div></div></div><p>Let's take another step forward. Let's imagine that we are upgrading our application and we want to add the<a id="id61" class="indexterm"/> possibility to store book authors and related data. Also, we will give the possibility to the user to search a book by its title.</p><p>We would have to do a couple of the following things:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Create the <code class="literal">authors</code> table to store authors' data</li><li class="listitem" style="list-style-type: disc">Update the <code class="literal">books</code> table to insert an external foreign key and an index to the <code class="literal">title</code> column</li></ul></div><p>You already know how to update an existing table but what about indexing columns and creating foreign keys?</p><p>Adding indexes<a id="id62" class="indexterm"/> is quite easy with the Schema Builder. There are some expressive methods you can use.</p><p>First of all, you can create a primary key with the <code class="literal">primary()</code> method. The parameter is the field you want to index.</p><div class="informalexample"><pre class="programlisting">  $table-&gt;primary('id');</pre></div><p>If you need, you can specify an array of columns as a single index.</p><div class="informalexample"><pre class="programlisting">  $table-&gt;primary(['first_name', 'last_name', 'document_number']);</pre></div><p>The method <code class="literal">unique()</code> is used to create a unique key:</p><div class="informalexample"><pre class="programlisting">  $table-&gt;unique('email');</pre></div><p>Finally, if <a id="id63" class="indexterm"/>you want to add a simple index, you can use the <code class="literal">index()</code> method!</p><div class="informalexample"><pre class="programlisting">  $table-&gt;index('title');</pre></div><p>You can also <a id="id64" class="indexterm"/>add a foreign key, if you need. In the following example, we are referencing the <code class="literal">author_id</code> column (on a hypothetical books table, maybe) to the <code class="literal">id</code> column in the <code class="literal">authors</code> table.</p><div class="informalexample"><pre class="programlisting">  $table-&gt;foreign('author_id')-&gt;references('id')-&gt;on('authors');</pre></div><p>Specifying <code class="literal">onDelete</code> and <code class="literal">onUpdate</code> constraint operations is not a problem.</p><div class="informalexample"><pre class="programlisting">  $table-&gt;foreign('author_id')
      -&gt;references('id')
      -&gt;on('authors')
      -&gt;onDelete('cascade');</pre></div><p>If you don't need your indexes anymore, you can easily drop them:</p><div class="informalexample"><pre class="programlisting">  $table-&gt;dropPrimary('authors_id_primary');
  $table-&gt;dropUnique('authors_email_unique');
  $table-&gt;dropIndex('books_title_index');
  $table-&gt;dropForeign('books_author_id_foreign');</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note15"/>Note</h3><p>The convention used to create an index name is <code class="literal">table-name_column-name_index-type</code>.</p></div></div><p>Alright, now that you have a good overview of indexes with the Schema Builder class, let's add the new functionality to our example.</p><p>Create a new <code class="literal">GET</code> route. This time it is named <code class="literal">update_books_table_2</code>.</p><div class="informalexample"><pre class="programlisting">  Route::get('update_books_table_2', function(){

      // creating the authors table...
      Schema::create('authors', function(Blueprint $table)
      {
          $table-&gt;increments('id');

          $table-&gt;string('first_name');
          $table-&gt;string('last_name');

          $table-&gt;timestamps();
      });

      Schema::table('books', function(Blueprint $table)
      {
          // creating the index on the title column...
          $table-&gt;index('title');

          // creating the foreign key...
          $table-&gt;integer('author_id')-&gt;unsigned();
          $table-&gt;foreign('author_id')-&gt;references('id')-&gt;on('authors');
      });

  });</pre></div><p>That's all! Let's <a id="id65" class="indexterm"/>verify <a id="id66" class="indexterm"/>all with Adminer, as we did before:</p><div class="mediaobject"><img src="graphics/3634_02_04.jpg" alt="Indexes and foreign keys"/></div><p>Yeah! It worked.</p></div></div></div>
<div class="section" title="Database versioning with the migrations system"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec16"/>Database versioning with the migrations system</h1></div></div></div><p>Until this point, we worked <a id="id67" class="indexterm"/>with the Schema class using some simple routes. Quite easy, but it's not a very good practice. You know: the single responsibility principle is not just a bedtime story.</p><p>Also, it's not just about the code: the database too should have a fully functional version control system in order to keep track of all the updates and facilitate a new member in your team.</p><p>Well, the migrations system is here to help. You can see it as a version control system for your database, which is made up of many files. Every single one of these files is a class with the two methods: <code class="literal">up()</code> and <code class="literal">down()</code>. In the <code class="literal">up()</code> method, you will put all of your database construction logic. In the <code class="literal">down()</code> method, instead, you will put anything related to <span class="emphasis"><em>rolling back</em></span> what you did in the <code class="literal">up()</code> method.</p><div class="section" title="Creating migrations"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec20"/>Creating migrations</h2></div></div></div><p>Let's make<a id="id68" class="indexterm"/> the first basic example. We already have the <code class="literal">books</code> and <code class="literal">authors</code> tables. Imagine that we want to gather data about our books' publishers.</p><p>We will have to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Create a new table called <code class="literal">publishers</code>, with at least the name of the publisher</li><li class="listitem" style="list-style-type: disc">Create a new foreign key <code class="literal">publisher_id</code> in <code class="literal">books</code></li></ul></div><p>Let's make it with a migration file! Open your terminal and type the following:</p><div class="informalexample"><pre class="programlisting">  php artisan make:migration publishers_update</pre></div><p>Wait for a few seconds and then go to the <code class="literal">database/migrations</code> folder. You will find a file named like this:</p><div class="informalexample"><pre class="programlisting">  2015_03_06_105131_publishers_update.php</pre></div><p>Open it. This class already has empty <code class="literal">up()</code> and <code class="literal">down()</code> methods:</p><div class="informalexample"><pre class="programlisting">  &lt;?php

    use Illuminate\Database\Schema\Blueprint;
    use Illuminate\Database\Migrations\Migration;

    class PublishersUpdate extends Migration {

      public function up()
      {
      //
    }

      public function down()
      {
        //
      }

    }</pre></div><p>Now, fill them<a id="id69" class="indexterm"/> with some Schema Builder instructions, like this.</p><div class="informalexample"><pre class="programlisting">  &lt;?php

    use Illuminate\Database\Schema\Blueprint;
    use Illuminate\Database\Migrations\Migration;

    class PublishersUpdate extends Migration {

      public function up()
      {
        Schema::create('publishers', function(Blueprint $table)
        {
          $table-&gt;increments('id');

          $table-&gt;string('name');

          $table-&gt;timestamps();
        });

        Schema::table('books', function(Blueprint $table)
        {
          $table-&gt;integer('publisher_id')-&gt;unsigned();
          $table-&gt;foreign('publisher_id')-&gt;references('id')-&gt;on('publishers');
        });
      }

      public function down()
      {
        Schema::table('books', function(Blueprint $table)
        {
          $table-&gt;dropForeign('books_publisher_id_foreign');
          $table-&gt;dropColumn('publisher_id');
        });

        Schema::drop('publishers');
      }

    } </pre></div><p>Quite linear: what <a id="id70" class="indexterm"/>we do in <code class="literal">up()</code> we undo in <code class="literal">down()</code>. Of course, in the reverse order. Remember, it's a <span class="emphasis"><em>mirror</em></span> operation!</p><p>Now, it's time to run your migrations. All you have to do is run <code class="literal">php artisan migrate</code>; it loads all the migration classes and executes their <code class="literal">up()</code> method. In this way, you can build your database accordingly to your files. The execution order is decided by the file name. The file we just created is named <code class="literal">2015_03_06_105131_publishers_update.php</code>.</p><p>This means that this file was created on March 6, 2015 at 10:51:31. As you can easily imagine, all the migrations will be executed in a chronological order. To make things clearer, delete the two <code class="literal">2014_10_12_000000_create_users_table.php</code> and <code class="literal">2014_10_12_100000_create_password_resets_table.php</code>. We won't need them.</p><p>Return to your terminal and type:</p><div class="informalexample"><pre class="programlisting">  php artisan migrate</pre></div><p>Wait for a few seconds and you will get an output really similar to the following:</p><div class="informalexample"><pre class="programlisting">  Migration table created successfully.
  Migrated: 2015_03_06_105131_publishers_update</pre></div><p>Now, return to your database. The update was done successfully, but we have another new table: the <code class="literal">migrations</code> table. Laravel uses this table to keep track of every update to the database. So, if you make another update to your application (with another new migration) and you run again the <code class="literal">php artisan migrate</code> command, you will execute only the new migrations and not the old ones. Exactly, version control, as I mentioned before.</p></div><div class="section" title="Rolling back migrations"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec21"/>Rolling back migrations</h2></div></div></div><p>Let's<a id="id71" class="indexterm"/> try this <span class="emphasis"><em>rollback</em></span> thing right now. In your terminal, type</p><div class="informalexample"><pre class="programlisting">  php artisan migrate:rollback</pre></div><p>Then, go back to your database: no more <code class="literal">publishers</code> table and no more related foreign key! Cool!</p><p>Got it? Good. Now, type this again:</p><div class="informalexample"><pre class="programlisting">  php artisan migrate</pre></div><p>Let's go forward.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip06"/>Tip</h3><p>You could get a <code class="literal">class not found</code> error while executing the <code class="literal">php artisan migrate</code> command.</p><p>Don't worry, just type <code class="literal">composer dump-autoload</code> in your terminal and try again! Even the best, sometimes, make mistakes.</p></div></div></div><div class="section" title="More examples, more migrations"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec22"/>More examples, more migrations</h2></div></div></div><p>Now, what about another example?</p><p>Let's imagine<a id="id72" class="indexterm"/> another feature. Alright, I have an idea: imagine that you want to specify some tags for every book you store with your application. This time you will have two things to do:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Create a new <code class="literal">tags</code> table to store tags.</li><li class="listitem" style="list-style-type: disc">Create a new <code class="literal">book_tag</code> table, as we are going to represent a many-to-many relationship. In this table, you will find the <code class="literal">book_id</code> and <code class="literal">tag_id</code>.</li></ul></div><p>First of all, create a new migration. Open your terminal and type:</p><div class="informalexample"><pre class="programlisting">  php artisan make:migration tags_update</pre></div><p>Also, update the file as the following:</p><div class="informalexample"><pre class="programlisting">  &lt;?php

    use Illuminate\Database\Schema\Blueprint;
    use Illuminate\Database\Migrations\Migration;

    class TagsUpdate extends Migration {

      /**
       * Run the migrations.
       *
       * @return void
       */
      public function up()
      {
        Schema::create('tags', function(Blueprint $table)
        {
          $table-&gt;increments('id');

          $table-&gt;string('name');

          $table-&gt;timestamps();
        });

        Schema::create('book_tag', function(Blueprint $table)
        {
          $table-&gt;increments('id');

          $table-&gt;integer('book_id')-&gt;unsigned();
          $table-&gt;integer('tag_id')-&gt;unsigned();

          $table-&gt;foreign('book_id')-&gt;references('id')-&gt;on('books');
          $table-&gt;foreign('tag_id')-&gt;references('id')-&gt;on('tags');
        });
      }

      /**
       * Reverse the migrations.
       *
       * @return void
       */
      public function down()
      {
        Schema::drop('book_tag');
        Schema::drop('tags');
      }

    }</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note16"/>Note</h3><p>I like to write in the <code class="literal">up()</code> and <code class="literal">down()</code> methods at the <span class="emphasis"><em>same time</em></span>. In that example you just saw, I put in <code class="literal">up()</code> the <code class="literal">create</code> method for <code class="literal">tags</code>. Then, I passed to the <code class="literal">down()</code> method and added the <code class="literal">drop('tags')</code> method call. Then, I went back to <code class="literal">up()</code> and added the <code class="literal">book_tag</code> table, and I finally went to <code class="literal">down()</code> again to drop the <code class="literal">book_tag</code> table.</p><p>Working in this way helps me reduce distraction errors.</p></div></div><p>Now, open the <a id="id73" class="indexterm"/>terminal and type:</p><div class="informalexample"><pre class="programlisting">  php artisan migrate</pre></div><p>Go to your database. Open the <code class="literal">migrations</code> table to see what happened:</p><div class="mediaobject"><img src="graphics/3634_02_05.jpg" alt="More examples, more migrations"/></div><p>We have two<a id="id74" class="indexterm"/> different batches here. The first batch (<span class="emphasis"><em>1</em></span>) is related to the publisher's update. The second batch (<span class="emphasis"><em>2</em></span>) is related to the tags system update.</p><p>Why am I telling this to you? Who cares?</p><p>Well, when you type <code class="literal">php artisan migrate:rollback</code> in your terminal, the migrations system searches for the last batch and rolls it back. Not every batch, just the last batch. This means that the first <code class="literal">rollback</code> command will undo everything related to the tags system. If you type it again, the migrations system will also undo everything about the publisher's update.</p><p>With the batch number, you can know how many iterations you did on your database. However, there is another important thing you need to know: regarding our example, if you roll back two times and then migrate again, both migration files will be grouped under batch 1.</p><p>Also, you can roll back everything with this:</p><div class="informalexample"><pre class="programlisting">  php artisan migrate:reset</pre></div><p>You can roll back and migrate everything again with this:</p><div class="informalexample"><pre class="programlisting">  php artisan migrate:refresh</pre></div><p>Finally, you will get a list of all the migrated/rolled back migrations with this:</p><div class="informalexample"><pre class="programlisting">  php artisan migrate:status</pre></div><p>That's all! With this last command, we are also done with migrations.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Summary</h1></div></div></div><p>Finally, the hero leaves his home. After the training and obtaining the right foundations, he is really ready to go.</p><p>Remember that the Schema Builder class and migrations system are not just about building your DB. In this chapter, you learned how to improve your database design method in a smarter way without the need for a single SQL line. Also, by using migrations, you are not going to need anymore to download database dumps or, in some <span class="emphasis"><em>extreme</em></span> way, install any extra tool to deal with it.</p><p>Everything is done with the <code class="literal">artisan migrate</code> commands. However, as I already told you, this was just a <span class="emphasis"><em>sample</em></span>. The real thing is arriving.</p><p>In the next chapter, we will go deeply and straight into the most important and <span class="emphasis"><em>atomic</em></span> Eloquent component: the model.</p><p>Are you ready, hero?</p></div></body></html>