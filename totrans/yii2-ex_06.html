<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Using a Grid for Data and Relations"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Using a Grid for Data and Relations</h1></div></div></div><p>We will cover the following topics in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">DataProvider for grids</li><li class="listitem" style="list-style-type: disc">Using grids</li><li class="listitem" style="list-style-type: disc">Custom columns in grids:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For example: displaying a reservations list by clicking on a customer grid row</li></ul></div></li><li class="listitem" style="list-style-type: disc">Filters in GridView</li><li class="listitem" style="list-style-type: disc">Displaying and filtering ActiveRecord relational data in a grid's column</li><li class="listitem" style="list-style-type: disc">Summarizing the footer row in a grid:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For example: extending GridView to customize the footer row in a grid</li></ul></div></li><li class="listitem" style="list-style-type: disc">Multiple grids on one page:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For example: managing reservations and room grids in the same view</li></ul></div></li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec43"/>Introduction</h1></div></div></div><p>In the previous chapter, you learned how to get data from databases. Now it is time to use a fundamental widget provided by <a id="id280" class="indexterm"/>framework: GridView. The first topic we'll cover is data input format expected by a grid. Then we will analyze the default implementation of a grid and proceed to look at customizations to display the relationship between data. Finally, you will learn to extend the grid base class to display everything we need in a grid layout.</p></div></div>
<div class="section" title="DataProvider for grids"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec44"/>DataProvider for grids</h1></div></div></div><p>GridView<a id="id281" class="indexterm"/> is the widget <a id="id282" class="indexterm"/>provided by Yii2 to display data in a grid layout.</p><p>This widget requires that data used as an input source is an extension of the abstract class <code class="literal">yii\data\BaseDataProvider</code>.</p><p>To deal with a data source, DataProvider supplies some additional actions to handle pagination and sorting.</p><p>
<code class="literal">BaseDataProvider</code> has a method named <code class="literal">getModels()</code> that returns a list of items for the current page. This means that we could also use DataProvider to paginate data from a source and display it as we need to.</p><p>By default, the framework has three core classes that extend <code class="literal">yii\data\BaseDataProvider</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">yii\data\ActiveDataProvider</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">yii\data\ArrayDataProvider</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">yii\data\SqlDataProvider</code></li></ul></div><p>The first one, <code class="literal">ActiveDataProvider</code>, uses a <code class="literal">yii\db\Query</code> instance from ActiveRecord as a data source. The parameter array is passed to the constructor and the <code class="literal">yii\db\Query</code> object is filled out in the <code class="literal">query</code> attribute:</p><div class="informalexample"><pre class="programlisting">// build an ActiveDataProvider with an empty query and a pagination with 35 items for page
$provider = new \yii\data\ActiveDataProvider([
    'query' =&gt; Room::find(),
    'pagination' =&gt; [
        'pageSize' =&gt; 35,
    ],
]);

// get all rooms in current page
$rooms = $provider-&gt;getModels();</pre></div><p>
<code class="literal">ActiveDataProvider</code> is the most used DataProvider, since it depends directly on ActiveRecord, the best way to interact with databases.</p><p>The second point, <code class="literal">ArrayDataProvider</code>, uses an array of items that can be sorted or paginated as a data source. This provider is employed when data can not be represented with ActiveRecord, for example, when they are taken from another data source, such as a JSON REST service or RSS feed.</p><p>The primary difference between <code class="literal">ActiveDataProvider</code> is that all data should be immediately passed to a construct:</p><div class="informalexample"><pre class="programlisting">// build an ArrayDataProvider with an empty query and a pagination with 40 items for page
$provider = new \yii\data\ArrayDataProvider([
    'allModels' =&gt; Room::find()-&gt;all(),
    'pagination' =&gt; [
        'pageSize' =&gt; 40,
    ],
]);

// get all rooms in current page
$rooms = $provider-&gt;getModels();</pre></div><p>In this snippet, we <a id="id283" class="indexterm"/>took data from an ActiveRecord to show the differences between <code class="literal">ActiveDataProvider</code> and <code class="literal">ArrayDataProvider</code>. For this last provider, all the modes should be passed to the constructor.</p><p>So, if the <code class="literal">Room</code> table has 10,000 records, with <code class="literal">ActiveDataProvider</code> 35 items at a time will be loaded, while through <code class="literal">ArrayDataProvider</code> they will be loaded all from scratch (with big performance issues).</p><p>The last one, <code class="literal">SqlDataProvider</code>, uses a SQL query as a data source. If we create pagination with this provider, we will need to also pass the <code class="literal">totalCount</code> attribute to the constructor to inform DataProvider how many records the SQL query should return:</p><div class="informalexample"><pre class="programlisting">// return total items count for this sql query
$itemsCount = \Yii::$app-&gt;db-&gt;createCommand('SELECT COUNT(*) FROM room')-&gt;queryScalar();

// build a SqlDataProvider with a pagination with 10 items for page

$dataProvider = new \yii\data\SqlDataProvider([
    'sql' =&gt; 'SELECT * FROM room',
    'totalCount' =&gt; $itemsCount,
    'pagination' =&gt; [
            'pageSize' =&gt; 10,
    ],
]);

// get the user records in the current page
$models = $dataProvider-&gt;getModels();</pre></div></div>
<div class="section" title="Using a grid"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec45"/>Using a grid</h1></div></div></div><p>Now that we know how to <a id="id284" class="indexterm"/>get a data input source to pass to GridView, let's look at how to implement it. Minimal implementation of GridView requires two attributes for an array passed to a constructor: <code class="literal">dataProvider</code> and <code class="literal">columns</code>. The first parameter, <code class="literal">dataProvider</code>, is the one we want to use in order to manipulate the data.</p><p>The second parameter, <code class="literal">columns</code>, represents the columns of the table to be displayed, for example:</p><div class="informalexample"><pre class="programlisting">&lt;?= \yii\grid\GridView::widget([
    'dataProvider' =&gt; $dataProvider,
    'columns' =&gt; [
      'id',
      'floor',
      'room_number',
       'available_from:datetime',
       'price_per_day:currency',
    ],
]) ?&gt;</pre></div><p>This code will <a id="id285" class="indexterm"/>display a table with data from <code class="literal">$dataProvider</code> and five columns: <code class="literal">id</code>, <code class="literal">floor</code>, <code class="literal">room_number</code>, <code class="literal">available_from</code>, and <code class="literal">price_per_day</code>; the last two columns are formatted firstly using<code class="literal"> datetime</code> and secondly using <code class="literal">currency</code>. Colons are used to specify the formatter to be applied to the column data.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note38"/>Note</h3><p>The aspect of the table can be customized with many attributes and by default, the table layout is rendered using Bootstrap.</p></div></div><p>Columns in the grid table can be identified using strings, but in general they are configured in terms of <code class="literal">yii\grid\Column</code> classes.</p></div>
<div class="section" title="Custom columns in a grid"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec46"/>Custom columns in a grid</h1></div></div></div><p>As mentioned in the<a id="id286" class="indexterm"/> previous paragraph, the <code class="literal">columns</code> property of the <a id="id287" class="indexterm"/>GridView widget is mainly filled with strings.</p><p>When we need to apply a specific format, such as currency or date/time, we can append this specification to the column name with a colon and the type used for formatting, as <code class="literal">currency</code> or <code class="literal">datetime</code>.</p><p>But the most general form of a GridView column is an object of the <code class="literal">yii\grid\Column</code> class, derived by the <code class="literal">yii\grid\DataColumn</code> class.</p><p>A GridView column extended by the <code class="literal">yii\grid\Column</code> class is rendered using an array with the following keys:</p><div class="informalexample"><pre class="programlisting">        [
// can be omitted, as it is the default
'class' =&gt; 'yii\grid\DataColumn',

        'attribute',    // name of model attribute
        'format',         // format use to display data
        'header',        // header of column
        'footer',        // footer of column
        'visible',        // flag to set visibility
        'content'         // callback to print data
        ],</pre></div><p>There are also other <a id="id288" class="indexterm"/>parameters but these ones are the most<a id="id289" class="indexterm"/> used.</p><div class="section" title="Example – displaying a reservations list by clicking on a customer grid row"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec30"/>Example – displaying a reservations list by clicking on a customer grid row</h2></div></div></div><p>We are now ready to <a id="id290" class="indexterm"/>create a customer grid that contains a reference to the linked reservation list in every row. First of all, make sure that the structure and the data for the customer and reservation tables is the following:</p><div class="informalexample"><pre class="programlisting">--
-- Structure of Table `customer`
--

CREATE TABLE IF NOT EXISTS `customer` (
  `id` int(11) NOT NULL PRIMARY KEY AUTO_INCREMENT,
  `name` varchar(50) NOT NULL,
  `surname` varchar(50) NOT NULL,
  `phone_number` varchar(50) DEFAULT NULL,
  PRIMARY KEY (`id`)
);

--
-- Data Dump of Table `customer`
--

INSERT INTO `customer` (`id`, `name`, `surname`, `phone_number`) VALUES
(1, 'James', 'Foo', '+39-12345678'),
(2, 'Bar', 'Johnson', '+47-98438923');

--
-- Structure of Table `reservation`
--

CREATE TABLE IF NOT EXISTS `reservation` (
  `id` int(11) NOT NULL PRIMARY KEY AUTO_INCREMENT,
  `room_id` int(11) NOT NULL,
  `customer_id` int(11) NOT NULL,
  `price_per_day` decimal(20,2) NOT NULL,
  `date_from` date NOT NULL,
  `date_to` date NOT NULL,
  `reservation_date` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `room_id` (`room_id`),
  KEY `customer_id` (`customer_id`)
);

--
-- Data Dump of table `reservation`
--

INSERT INTO `reservation` (`id`, `room_id`, `customer_id`, `price_per_day`, `date_from`, `date_to`, `reservation_date`) VALUES
(1, 2, 1, 90.00, '2015-04-01', '2015-05-06', '2015-05-24 22:45:37'),
(2, 2, 1, 48.00, '2019-08-27', '2019-08-31', '2015-05-24 22:45:37'),
(3, 1, 2, 105.00, '2015-09-24', '2015-10-06', '2015-06-03 00:21:14');</pre></div><p>Create a new controller<a id="id291" class="indexterm"/> named <code class="literal">CustomersController</code> in <code class="literal">basic/controllers/CustomersController.php</code> with the <code class="literal">actionGrid</code> action to display a list in the grid view:</p><div class="informalexample"><pre class="programlisting">&lt;?php

namespace app\controllers;

use Yii;
use yii\web\Controller;
use app\models\Customer;
use yii\data\ActiveDataProvider;

class CustomersController extends Controller
{
    public function actionGrid()
    {
        $query = Customer::find();
        
        $dataProvider = new ActiveDataProvider([
            'query' =&gt; $query,
            'pagination' =&gt; [
                'pageSize' =&gt; 10,
            ],
        ]);
        
        return $this-&gt;render('grid', [ 'dataProvider' =&gt; $dataProvider ]);
        
    }
}</pre></div><p>This action <code class="literal">actionGrid</code> simply creates a data provider with all the data from the customer (unfiltered) and <a id="id292" class="indexterm"/>with a pagination that displays ten items on a page. Finally, render the grid view.</p><p>This is the content of the grid view in <code class="literal">basic/views/customers/grid.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
use yii\grid\GridView;
use yii\helpers\Html;
?&gt;

&lt;h2&gt;Customers&lt;/h2&gt;

&lt;?= GridView::widget([
    'dataProvider' =&gt; $dataProvider,
    'columns' =&gt; [
        'id',
        'name',
        'surname',
        'phone_number',
        
        [
            'header' =&gt; 'Reservations',
            'content' =&gt; function ($model, $key, $index, $column) {
                return Html::a('Reservations', ['reservations/grid', 'Reservation[customer_id]' =&gt; $model-&gt;id]);
            }
        ],
        
        [
            'class' =&gt; 'yii\grid\ActionColumn',
            'template' =&gt; '{delete}',
            'header' =&gt; 'Actions',
        ],        
    ],
]) ?&gt;</pre></div><p>The last two columns require particular explanation.</p><p>The penultimate one, <code class="literal">Reservation</code>, displays a link to give you access to the list of all customer reservations. We have put <code class="literal">Reservations</code> as the header and filled the <code class="literal">content</code> property with dynamic data passed from the callback function, which returns an HTML link to the <code class="literal">reservations/index</code> route with a parameter indicating <code class="literal">customer_id</code> selected.</p><p>The last column headed <code class="literal">Actions</code> displays the ActionColumn with the single action <code class="literal">delete</code> to remove the selected record.</p><p>Point your browser to <code class="literal">http://hostname/basic/customers/grid</code> and you should have the following output:</p><div class="mediaobject"><img src="graphics/B04656_06_01.jpg" alt="Example – displaying a reservations list by clicking on a customer grid row"/><div class="caption"><p>The Customers grid using the GridView widget</p></div></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note39"/>Note</h3><p>The language used in GridView is configured in <code class="literal">basic/config/web.php</code> with the <code class="literal">language</code> property. This property has a global effect on every core widget.</p></div></div><p>We can complete <a id="id293" class="indexterm"/>this example by just putting a counter near the <code class="literal">Reservations</code> link to indicate the number of reservations for each customer.</p><p>For this purpose, we need to add a new relation named <code class="literal">getReservationsCount</code> to the Customer model in <code class="literal">basic/models/Customer.php</code>, which returns the number of reservations linked to the customer:</p><div class="informalexample"><pre class="programlisting">    public function getReservationsCount()
    {
      return $this-&gt;hasMany(\app\models\Reservation::className(), ['customer_id' =&gt; 'id'])-&gt;count();
    }</pre></div><p>Now we can modify the penultimate column with:</p><div class="informalexample"><pre class="programlisting">        [
            'header' =&gt; 'Reservations',
            'content' =&gt; function ($model, $key, $index, $column) {
                $title = sprintf('Reservations (%d)', $model-&gt;reservationsCount);
                return Html::a($title, ['reservations/grid', 'Reservation[customer_id]' =&gt; $model-&gt;id]);
            }
        ],</pre></div><p>If we refresh our browser now, we will see near the <code class="literal">Reservations</code> anchor link, the correct number of reservations for that customer appears.</p><p>This example<a id="id294" class="indexterm"/> represents the complete reservations list displayed when a user clicks on the link <code class="literal">Reservations</code>.</p><p>Create <code class="literal">ReservationsController</code> as a new file in <code class="literal">basic/controllers/ReservationsController.php</code> with an action <code class="literal">grid</code> and the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php

namespace app\controllers;

use Yii;
use yii\web\Controller;
use app\models\Reservation;
use yii\data\ActiveDataProvider;

class ReservationsController extends Controller
{
    public function actionGrid()
    {
        $query = Reservation::find();
        
        if(isset($_GET['Reservation']))
        {
            $query-&gt;andFilterWhere([
                'customer_id' =&gt; isset($_GET['Reservation']['customer_id'])?$_GET['Reservation']['customer_id']:null,
            ]);
        }
        
        $dataProvider = new ActiveDataProvider([
            'query' =&gt; $query,
            'pagination' =&gt; [
                'pageSize' =&gt; 10,
            ],
        ]);
        
        return $this-&gt;render('grid', [ 'dataProvider' =&gt; $dataProvider ]);
        
    }
}</pre></div><p>In this controller, we <a id="id295" class="indexterm"/>applied an <code class="literal">andFilterWhere</code> condition to query whether <code class="literal">$_GET['Reservation']</code> is set. The <code class="literal">andFilterWhere()</code>method will apply a filter passed as a parameter only if the condition is not empty. So if<code class="literal"> $_GET['Reservation']['customer_id']</code> is not set, the <code class="literal">andFilterWhere()</code> condition parameter will have a null value and will not be appended to any other query condition.</p></div></div>
<div class="section" title="Filters in GridView"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec47"/>Filters in GridView</h1></div></div></div><p>GridView has a core <a id="id296" class="indexterm"/>feature of being able to simplify filter rows just by putting an additional row below the header row.</p><p>Filters are mainly text input but in general they can be any type of control and we can customize them as much as we want.</p><p>Filters can be activated by filling out the GridView widget property <code class="literal">filterModel</code> with an instance of the model class and automatically a new row will be created below the header, containing working text inputs.</p><p>Filter text inputs have a name attribute filled with the model class name, which includes the field name. In this way, we will pass data to a controller, including everything in a single array; a variable that can easily be used to populate a search model massively.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note40"/>Note</h3><p>Automatic text input filters are created only for attributes that belong to at least one rule in the <code class="literal">rules()</code> method of <code class="literal">ActiveDataProvider</code>; otherwise it is enough that attributes belong to the <code class="literal">safe</code> validator.</p></div></div><p>Let's create an example with the reservations grid.</p><p>We will fill out the <code class="literal">filterModel</code> property to apply filters to GridView, for example:</p><div class="informalexample"><pre class="programlisting">&lt;?= \yii\grid\GridView::widget([
    ...
    'filterModel' =&gt; $searchModel,
    ...        
?&gt;</pre></div><p>Here, <code class="literal">$searchModel</code> is an instance of the <code class="literal">Reservation</code> model class that we will pass to the view from the grid <a id="id297" class="indexterm"/>action of <code class="literal">ReservationsController</code>.</p><p>Now let's create <code class="literal">actionGrid()</code> in <code class="literal">ReservationsController</code> in <code class="literal">basic/controllers/ReservationsController.php</code>:</p><div class="informalexample"><pre class="programlisting">    &lt;?php

public function actionGrid()
    {
        $query = \app\models\Reservation::find();

        $searchModel = new \app\models\Reservation();
        if(isset($_GET['Reservation']))
        {
            $searchModel-&gt;load( \Yii::$app-&gt;request-&gt;get() );
            
            $query-&gt;andFilterWhere([
                'id' =&gt; $searchModel-&gt;id,
                'customer_id' =&gt; $searchModel-&gt;customer_id,
                'room_id' =&gt; $searchModel-&gt;room_id,
                'price_per_day' =&gt; $searchModel-&gt;price_per_day,
            ]);
        }
        
        $dataProvider = new \yii\data\ActiveDataProvider([
            'query' =&gt; $query,
            'pagination' =&gt; [
                'pageSize' =&gt; 10,
            ],
        ]);
        
        
        return $this-&gt;render('grid', [ 'dataProvider' =&gt; $dataProvider, 'searchModel' =&gt; $searchModel ]);
        
    }</pre></div><p>The <code class="literal">$searchModel</code> instance is filled with the content of <code class="literal">$_GET['Reservation']</code>, in line:</p><div class="informalexample"><pre class="programlisting">            $searchModel-&gt;load( Yii::$app-&gt;request-&gt;get() );</pre></div><p>Then, <code class="literal">$query</code> is updated with the content of non-null attributes.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note41"/>Note</h3><p>Remember that the ActiveRecord's <code class="literal">load()</code> method will get values from the array enclosed in the model class name, applied as the key to the array passed as the first function parameter.</p></div></div><p>Browse to <code class="literal">http://hostname/basic/reservations/grid</code> and type <code class="literal">2</code> in the <span class="strong"><strong>Room ID</strong></span> column<a id="id298" class="indexterm"/> filter (the second column). This should be the output:</p><div class="mediaobject"><img src="graphics/B04656_06_02.jpg" alt="Filters in GridView"/><div class="caption"><p>Using filters in the GridView widget</p></div></div><p>We can also choose to customize the way we render a filter. Imagine using the <span class="strong"><strong>Room ID</strong></span> column filter as a drop-down list instead of an input textbox.</p><p>We only need to fill out the <code class="literal">filter</code> property of <span class="strong"><strong>Room ID</strong></span> with <code class="literal">dropDownList</code>. It is advisable to use the <code class="literal">Html</code> helper class to render <code class="literal">dropDownList</code> using the <code class="literal">activeDropDownList()</code> method. The <code class="literal">active</code> prefix stands for ActiveRecord. This method <code class="literal">dropDownList()</code> requires three parameters: the model class, the attribute of the model class, and finally an array key-value where <code class="literal">key</code> is the value attribute of the <code class="literal">&lt;option&gt;</code> tag and <code class="literal">value</code> is the text of the <code class="literal">&lt;option&gt;</code> tag.</p><p>We will use <code class="literal">yii\helpers\ArrayHelper</code> to create the array key-value, where the key is the <code class="literal">id</code> attribute of the model and the value is the return value of a callback function.</p><p>This is how the file in <code class="literal">basic/views/reservations/grid.php</code> changes:</p><div class="informalexample"><pre class="programlisting">&lt;?php
$roomsFilterData = yii\helpers\ArrayHelper::map( app\models\Room::find()-&gt;all(), 'id', function($model, $defaultValue) {
    return sprintf('Floor: %d - Number: %d', $model-&gt;floor, $model-&gt;room_number);
});
?&gt;

&lt;?= \yii\grid\GridView::widget([
    'dataProvider' =&gt; $dataProvider,
    'filterModel' =&gt; $searchModel,
    'columns' =&gt; [
        'id',
         
        [
            'header' =&gt; 'Room',
            'filter' =&gt; \Html::activeDropDownList($searchModel, 'room_id', $roomsFilterData, ['prompt' =&gt; '--- all']),
            'content' =&gt; function($model) {
                return $model-&gt;room-&gt;floor;
            }
        ],</pre></div><p>This is the <a id="id299" class="indexterm"/>expected output:</p><div class="mediaobject"><img src="graphics/B04656_06_03.jpg" alt="Filters in GridView"/><div class="caption"><p>GridView with the dropdown list filter</p></div></div></div>
<div class="section" title="Displaying and filtering ActiveRecord relational data in a grid's column"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec48"/>Displaying and filtering ActiveRecord relational data in a grid's column</h1></div></div></div><p>Let's now focus on<a id="id300" class="indexterm"/> relational data in GridView, a common topic that is easily solved by itself.</p><p>Think about the reservations grid, which has two relational fields: <code class="literal">room_id</code> and <code class="literal">customer_id</code>, referring respectively to room and customer tables. What if we want to immediately display the customer's surname, or room number?</p><p>At this point, our goal is to display relational data, for example, the customer's surname instead of <code class="literal">customer_id</code> in GridView. Fields that refer to related data are expressed with the <code class="literal">relation</code> attribute.</p><p>In the reservation grid view, <code class="literal">customer</code> is the relation to get a related customer and <code class="literal">surname</code> is the field to keep.</p><p>Therefore, to display the customer's surname, it is enough to insert this column (as a string) in the reservations grid view:</p><div class="informalexample"><pre class="programlisting">    'customer.surname'</pre></div><p>This is equivalent to:</p><div class="informalexample"><pre class="programlisting">    [
        'attribute' =&gt; 'customer.surname'
    ]</pre></div><p>A column <a id="id301" class="indexterm"/>named <code class="literal">surname</code> will be displayed. If we want to change column name to <code class="literal">Customer</code>, we use this:</p><div class="informalexample"><pre class="programlisting">    [
        'header' =&gt; 'Customer',
        'attribute' =&gt; 'customer.surname'
    ]</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note42"/>Note</h3><p>We could use custom properties to get data, for example, <code class="literal">getnameAndSurname</code> to get the personal details of a specific customer.</p><p>Insert a new property in the <code class="literal">Customer</code> model:</p><div class="informalexample"><pre class="programlisting">public function getNameAndSurname() {
     return $this-&gt;name.' '.$this-&gt;surname;
}</pre></div><p>Then this will be the column in the GridView:</p><div class="informalexample"><pre class="programlisting">     [
        'header' =&gt; 'Customer',
        'attribute' =&gt; 'customer.nameAndSurname'
    ]</pre></div></div></div><p>We now want to filter the <code class="literal">Customer</code> column. Since the <code class="literal">customer.surname</code> attribute is not in the <code class="literal">rules()</code> method of the <code class="literal">Reservation</code> model, we need to extend this class to handle extra attributes.</p><p>So, create a new class named <code class="literal">ReservationSearch</code> in <code class="literal">basic/models/ReservationSearch.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php

class ReservationSearch extends app\models\Reservation
{
    public function attributes()
    {
        // add related fields to searchable attributes
        return array_merge(parent::attributes(), ['customer.surname']);
    }
    
    public function rules()
    {
        // add related rules to searchable attributes
        return array_merge(parent::rules(),[ ['customer.surname', 'safe'] ]);
    }    
    
}</pre></div><p>This extension<a id="id302" class="indexterm"/> simply adds a new attribute and a new rule attached to this attribute. The name of the attribute is <code class="literal">customer.surname</code>.</p><p>We now have to change the <code class="literal">actionGrid()</code> action in <code class="literal">ReservationsController</code> to make a connection to the <code class="literal">customer</code> table that permits us to filter based on the customer's surname.</p><p>This is the content of <code class="literal">actionGrid()</code> of <code class="literal">ReservationsController</code> in <code class="literal">basic/controllers/ReservationsController.php</code>:</p><div class="informalexample"><pre class="programlisting">    public function actionGrid()
    {
        $query = \app\models\Reservation::find();

        $searchModel = new \app\models\ReservationSearch();
        if(isset($_GET['ReservationSearch']))
        {
            $searchModel-&gt;load( \Yii::$app-&gt;request-&gt;get() );
            
            $query-&gt;joinWith(['customer']);
            $query-&gt;andFilterWhere(
                ['LIKE', 'customer.surname', $searchModel-&gt;getAttribute('customer.surname')]
            );
            
            $query-&gt;andFilterWhere([
                'id' =&gt; $searchModel-&gt;id,
                'customer_id' =&gt; $searchModel-&gt;customer_id,
                'room_id' =&gt; $searchModel-&gt;room_id,
                'price_per_day' =&gt; $searchModel-&gt;price_per_day,
            
            ]);
        }
        
        $dataProvider = new \yii\data\ActiveDataProvider([
            'query' =&gt; $query,
            'pagination' =&gt; [
                'pageSize' =&gt; 10,
            ],
        ]);
        
        
        return $this-&gt;render('grid', [ 'dataProvider' =&gt; $dataProvider, 'searchModel' =&gt; $searchModel ]);
        
    }</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note44"/>Note</h3><p>Be careful to ensure that <code class="literal">$searchModel</code> is instanced from the <code class="literal">ReservationSearch</code> class, as much as <code class="literal">$_GET</code>, parameter used to get data is instanced from <code class="literal">ReservationSearch</code> instead of <code class="literal">Reservation</code> (because it has changed class).</p></div></div><p>Filtering an action<a id="id303" class="indexterm"/> on the customer's surname in <code class="literal">actionGrid()</code> is made using these lines of code:</p><div class="informalexample"><pre class="programlisting">            $query-&gt;joinWith(['customer']);
            $query-&gt;andFilterWhere(
                ['LIKE', 'customer.surname', $searchModel-&gt;getAttribute('customer.surname')]
            );</pre></div><p>We make a join and if the <code class="literal">customer.surname</code> attribute is not null, then there will be a new filter. Browse to <code class="literal">http://hostname/basic/reservations/grid</code> and type <code class="literal">Fo</code> in the <span class="strong"><strong>Customer</strong></span> column filter. You should see this:</p><div class="mediaobject"><img src="graphics/B04656_06_04.jpg" alt="Displaying and filtering ActiveRecord relational data in a grid's column"/><div class="caption"><p>Filtering using relational data</p></div></div></div>
<div class="section" title="A summarized footer row in a grid"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec49"/>A summarized footer row in a grid</h1></div></div></div><p>One feature of GridView is that it shows<a id="id304" class="indexterm"/> summarized or statistical data, usually as a footer row or first row, to get the data immediately (instead of scrolling down the page to the bottom of the grid).</p><p>A column of the GridView widget has an attribute named <code class="literal">footer</code> to identify the last row of the current pagination. A value filled in this attribute will be placed in the last row of the grid.</p><p>By default, showing the footer is disabled; to enable the footer, it is enough to set  the attribute <code class="literal">showFooter</code> of GridView to <code class="literal">true</code>. Then, we need to insert data in the 'footer' attribute of the column that we want to show.</p><p>For example, we want to display the average price per day of rooms.</p><p>Add this code at the top of the grid view in <code class="literal">basic/views/reservations/grid.php</code> to calculate the average of price per day:</p><div class="informalexample"><pre class="programlisting">&lt;?php
use yii\grid\GridView;
use yii\helpers\Html;
?&gt;

&lt;h2&gt;Reservations&lt;/h2&gt;

&lt;?php 
$sumOfPricesPerDay = 0;
$averagePricePerDay = 0;

if(count($dataProvider-&gt;getModels()) &gt; 0)
{
    foreach($dataProvider-&gt;getModels() as $m) $sumOfPricesPerDay += $m-&gt;price_per_day;
    $averagePricePerDay = $sumOfPricesPerDay / sizeof($dataProvider-&gt;getModels());
}  
?&gt;

&lt;?php 
$roomsFilterData = yii\helpers\ArrayHelper::map( app\models\Room::find()-&gt;all(), 'id', function($model, $defaultValue) {
    return sprintf('Floor: %d - Number: %d', $model-&gt;floor, $model-&gt;room_number);
});
?&gt;

&lt;?= app\components\GridViewReservation::widget([
    'dataProvider' =&gt; $dataProvider,
    'filterModel' =&gt; $searchModel,
    'showFooter' =&gt; true,
    'columns' =&gt; [
        'id',
        
        [
            'header' =&gt; 'Room',
            'filter' =&gt; Html::activeDropDownList($searchModel, 'room_id', $roomsFilterData, ['prompt' =&gt; '--- all']),
            'content' =&gt; function($model) {
                return $model-&gt;room-&gt;floor;
            }
        ],

        [
            'header' =&gt; 'Customer',
            'attribute' =&gt; 'customer.surname',
        ],
        
        [
            'attribute' =&gt; 'price_per_day',
            'footer' =&gt; Yii::$app-&gt;formatter-&gt;asCurrency($resultQueryAveragePricePerDay, 'EUR')
        ],
        
        'date_from',
        'date_to',
        
        [
            'class' =&gt; 'yii\grid\ActionColumn',
            'template' =&gt; '{delete}',
            'header' =&gt; 'Actions',
        ],        
    ],
]) ?&gt;</pre></div><p>Be careful! In this<a id="id305" class="indexterm"/> example, <code class="literal">count</code> is made using the models of the current pagination. If the grid is composed of more pages, it will only show the average value for the current page!</p><p>This count can consider all records (also filtered ones), making the calculation based not only on the models <a id="id306" class="indexterm"/>of the current pagination but also on the result of a query. Add the average count in <code class="literal">actionGrid()</code> of <code class="literal">ReservationsController</code>:</p><div class="informalexample"><pre class="programlisting">    public function actionGrid()
    {
        $query = \app\models\Reservation::find();

        $searchModel = new \app\models\ReservationSearch();
        if(isset($_GET['ReservationSearch']))
        {
            $searchModel-&gt;load( \Yii::$app-&gt;request-&gt;get() );
            
            $query-&gt;joinWith(['customer']);
            $query-&gt;andFilterWhere(
                ['LIKE', 'customer.surname', $searchModel-&gt;getAttribute('customer.surname')]
            );
            
            $query-&gt;andFilterWhere([
                'id' =&gt; $searchModel-&gt;id,
                'customer_id' =&gt; $searchModel-&gt;customer_id,
                'room_id' =&gt; $searchModel-&gt;room_id,
                'price_per_day' =&gt; $searchModel-&gt;price_per_day,
            
            ]);
            
        }
        $resultQueryAveragePricePerDay = $query-&gt;average('price_per_day');

        $dataProvider = new \yii\data\ActiveDataProvider([
            'query' =&gt; $query,
            'pagination' =&gt; [
                'pageSize' =&gt; 10,
            ],
        ]);
        
        return $this-&gt;render('grid', [ 'dataProvider' =&gt; $dataProvider, 'searchModel' =&gt; $searchModel, 'resultQueryAveragePricePerDay' =&gt; $resultQueryAveragePricePerDay ]);
        
    }</pre></div><p>The average is<a id="id307" class="indexterm"/> calculated from the <code class="literal">average()</code> method of the <code class="literal">$query</code> object (so the filter will be considered, if it is filled out) and passed to the view, so the code at the top of the view to execute calculation is no longer needed because we have correctly moved it to the Controller action.</p><p>Then change the <code class="literal">footer</code> content of the <code class="literal">price_per_day</code> column:</p><div class="informalexample"><pre class="programlisting">        [
            'attribute' =&gt; 'price_per_day',
            'footer' =&gt; sprintf('Average: %0.2f', $resultQueryAveragePricePerDay)
        ],</pre></div><p>Now the average count will be independent of pagination.</p><div class="section" title="Example – extending GridView to customize the footer row in a grid"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec31"/>Example – extending GridView to customize the footer row in a grid</h2></div></div></div><p>In a highly customized <a id="id308" class="indexterm"/>GridView, it is required to <a id="id309" class="indexterm"/>show data in positions not handled by default by GridView, or it is required to apply specific changes (such as merging a column).</p><p>In either of these cases and when it is impossible to create the desired output with attributes of GridView, it will be necessary to subclass the GridView widget.</p><p>The GridView widget has specific methods to render different parts of it: <code class="literal">renderTableBody()</code>, <code class="literal">renderTableFooter()</code>, <code class="literal">renderTableHeader()</code>, <code class="literal">renderTableRow()</code>, and so on.</p><p>Think about the previous example. Now, we also want to gather the first three columns in the footer to display the <code class="literal">Average</code> label, the unique value in the <code class="literal">price_per_day</code> column, and the last four columns with an empty space.</p><p>Create a new component that extends the <code class="literal">yii\grid\GridView</code> widget in <code class="literal">basic/components/GridViewReservation.php</code> with this content:</p><div class="informalexample"><pre class="programlisting">&lt;?php

namespace app\components;

use Yii;
use yii\web\Controller;
use yii\grid\GridView;

class GridViewReservation extends GridView
{
    public function renderTableFooter()
    {
        // Search column for 'price_per_day'
        $columnPricePerDay = null;
        foreach($this-&gt;columns as $column)
        {
            if(get_class($column) == 'yii\grid\DataColumn')
            {
                if($column-&gt;attribute == 'price_per_day') $columnPricePerDay = $column;
            }
        }
        
        $html = '&lt;tfoot&gt;&lt;tr&gt;';
        $html .= '&lt;td colspan="3"&gt;&lt;b&gt;Average:&lt;/b&gt;&lt;/td&gt;';
        $html .= $columnPricePerDay-&gt;renderFooterCell();
        $html .= '&lt;td colspan="4"&gt;&lt;i&gt;this space is intentionally empty&lt;/i&gt;&lt;/td&gt;';
        $html .= '&lt;/tr&gt;&lt;/tfoot&gt;';
        
        
        return $html;
    }
}</pre></div><p>This component<a id="id310" class="indexterm"/> just extends <code class="literal">yii\grid\GridView</code> and <a id="id311" class="indexterm"/>overrides the <code class="literal">renderTableFooter()</code> method to make the required customization (mainly merging cells). The only logic in this code is to find the <code class="literal">price_per_day</code> column, cycling the array of columns given by <code class="literal">$this-&gt;columns</code>, where <code class="literal">$this</code> refers to the GridView object.</p></div></div>
<div class="section" title="Multiple grids on one page"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec50"/>Multiple grids on one page</h1></div></div></div><p>Every Yii2 widget <a id="id312" class="indexterm"/>has so much encapsulated in it that using multiple GridView widgets is a simple activity that involves making few changes.</p><p>The only parameters indeed that are not customizable with the DataProvider model class are <code class="literal">pageParam</code> and <code class="literal">sortParam</code>, which define the current page index and the parameters used to order a grid.</p><p>Suppose, for example, that we have two GridViews filled with two different data providers, <code class="literal">$firstDataProvider</code> and <code class="literal">$secondDataProvider</code>.</p><p>In the controller, we will set the <code class="literal">pageParam</code> and <code class="literal">sortParam</code> parameters of each DataProvider:</p><div class="informalexample"><pre class="programlisting">$firstDataProvider-&gt;pagination-&gt;pageParam = 'first-dp-page';
$firstDataProvider-&gt;sort-&gt;sortParam = 'first-dp-sort';

$secondDataProvider-&gt;pagination-&gt;pageParam = 'second-dp-page';
$secondDataProvider-&gt;sort-&gt;sortParam = 'second-dp-sort';</pre></div><p>If we miss these <a id="id313" class="indexterm"/>definitions when changing a page or sorting a column, this action will also affect the other GridView in the same page because we have not distinguished the two grid view parameters.</p><div class="section" title="Example: managing the reservations and rooms grids in the same view"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec32"/>Example: managing the reservations and rooms grids in the same view</h2></div></div></div><p>The purpose of this<a id="id314" class="indexterm"/> example is to display both the reservations and rooms grids in the same page completely independent from each other.</p><p>In <code class="literal">ReservationsController</code> in <code class="literal">basic/controllers/ReservationsController.php</code>, create a new action named <code class="literal">actionMultipleGrid()</code> with the following content:</p><div class="informalexample"><pre class="programlisting">    public function actionMultipleGrid()
    {
        /**
         * Reservations
         */
        $reservationsQuery = \app\models\Reservation::find();
        $reservationsSearchModel = new \app\models\ReservationSearch();
        
        if(isset($_GET['ReservationSearch']))
        {
            $reservationsSearchModel-&gt;load( \Yii::$app-&gt;request-&gt;get() );
            
            $reservationsQuery-&gt;joinWith(['customer']);
            $reservationsQuery-&gt;andFilterWhere(
                ['LIKE', 'customer.surname', $reservationsSearchModel-&gt;getAttribute('customer.surname')]
            );
            
            $reservationsQuery-&gt;andFilterWhere([
                'id' =&gt; $reservationsSearchModel-&gt;id,
                'customer_id' =&gt; $reservationsSearchModel-&gt;customer_id,
                'room_id' =&gt; $reservationsSearchModel-&gt;room_id,
                'price_per_day' =&gt; $reservationsSearchModel-&gt;price_per_day,
            
            ]);
        }
        
        $reservationsDataProvider = new \yii\data\ActiveDataProvider([
            'query' =&gt; $reservationsQuery,
            'sort' =&gt; [
                'sortParam' =&gt; 'reservations-sort-param',
            ],
            'pagination' =&gt; [
                'pageSize' =&gt; 10,
                'pageParam' =&gt; 'reservations-page-param'
            ],
        ]);        
        
        
        /**
         * Rooms
         */
        $roomsQuery = \app\models\Room::find();
        $roomsSearchModel = new \app\models\Room();
        
        if(isset($_GET['Room']))
        {
            $roomsSearchModel-&gt;load( \Yii::$app-&gt;request-&gt;get() );
            
            $roomsQuery-&gt;andFilterWhere([
                'id' =&gt; $roomsSearchModel-&gt;id,
                'floor' =&gt; $roomsSearchModel-&gt;floor,
                'room_number' =&gt; $roomsSearchModel-&gt;room_number,
                'has_conditioner' =&gt; $roomsSearchModel-&gt;has_conditioner,
                'has_phone' =&gt; $roomsSearchModel-&gt;has_conditioner,
                'has_tv' =&gt; $roomsSearchModel-&gt;has_conditioner,
                'available_from' =&gt; $roomsSearchModel-&gt;has_conditioner,
            
            ]);
        }
        
        $roomsDataProvider = new \yii\data\ActiveDataProvider([
            'query' =&gt; $roomsQuery,
            'sort' =&gt; [
                'sortParam' =&gt; 'rooms-sort-param',
            ],
            'pagination' =&gt; [
                'pageSize' =&gt; 10,
                'pageParam' =&gt; 'rooms-page-param'
            ],
        ]);        
        
        return $this-&gt;render('multipleGrid', [
            'reservationsDataProvider' =&gt; $reservationsDataProvider, 'reservationsSearchModel' =&gt; $reservationsSearchModel,
            'roomsDataProvider' =&gt; $roomsDataProvider, 'roomsSearchModel' =&gt; $roomsSearchModel,
        ]);
        
    }</pre></div><p>We have detached the<a id="id315" class="indexterm"/> reservations declaration from the rooms declaration in order to clearly distinguish each from the other. Be careful to ensure that you defined <code class="literal">sortparam</code> and <code class="literal">pageparam</code> for either of the DataProvider.</p><p>Now we create a new view in <code class="literal">basic/views/reservations/multipleGrid.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
use yii\grid\GridView;
use yii\helpers\Html;
?&gt;

&lt;h2&gt;Reservations&lt;/h2&gt;
&lt;?= GridView::widget([
    'dataProvider' =&gt; $reservationsDataProvider,
    'filterModel' =&gt; $reservationsSearchModel,
    'columns' =&gt; [
        'id',
        'room_id',
        'attribute' =&gt; 'customer.surname',
        'price_per_day',
        'date_from',
        'date_to'
    ],
]) ?&gt;

&lt;h2&gt;Rooms&lt;/h2&gt;
&lt;?= GridView::widget([
    'dataProvider' =&gt; $roomsDataProvider,
    'filterModel' =&gt; $roomsSearchModel,
    'columns' =&gt; [
        'id',
        'floor',
        'room_number',        
        'has_conditioner:boolean',
        'has_phone:boolean',
        'has_tv:boolean',
        'available_from',
    ],
]) ?&gt;</pre></div><p>The two grids are <a id="id316" class="indexterm"/>completely independent and we can now order or change a page without interfering with other grids.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec51"/>Summary</h1></div></div></div><p>In this chapter, we presented the GridView widget to display data, directly or relational. A fundamental topic when discussing GridView is DataProvider, which is a way to provide data to GridView. You learned how to get DataProvider from ActiveRecord, an array, or SQL, based on the available source.</p><p>After the first simple implementation of GridView, you comprehended the customization in a column and displayed the relational data coming from other tables, using an extension of the model class to add extra features as new attributes. Next, we illustrated how to filter data in GridView to select only specific rows.</p><p>Just before the end of the chapter, you saw how to show, summarize, and customize a footer and more in the GridView by subclassing the core widget <code class="literal">yii\grid\GridView</code>. Finally, the last topic concerned the use of more than one grid in the same page, with a special focus on the few changes that need to occur in order to avoid them interfering with each other.</p><p>In the next chapter, you will learn to customize the user interface with CSS, JavaScript, widgets, and tools such as Gii that are directly provided from the framework.</p></div></body></html>