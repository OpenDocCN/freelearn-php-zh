<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Creating a Module"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Creating a Module</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating files</li><li class="listitem" style="list-style-type: disc">Registering blocks, helpers, and models</li><li class="listitem" style="list-style-type: disc">Adding a new page</li><li class="listitem" style="list-style-type: disc">Adding a layout file</li><li class="listitem" style="list-style-type: disc">Adding a translation file</li><li class="listitem" style="list-style-type: disc">Adding a block of new products</li><li class="listitem" style="list-style-type: disc">Rewriting a core class</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec30"/>Introduction</h1></div></div></div><p>When you take a look into the core code of Magento, you will see the modular architecture. Every concept is stored in a module. Magento is the combination of all the core modules. The advantage of a modular architecture is its extendibility. It is easy to add modules that extend or rewrite the core.</p><p>In this chapter, we will create a module using the most important things you need to know to extend Magento with a simple module.</p></div></div>
<div class="section" title="Creating files"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec31"/>Creating files</h1></div></div></div><p>When you want to create a module, the first step is to create the files and folders to register the module. At the end of this recipe, we will have a module that is registered but does not have functionality.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec71"/>Getting ready</h2></div></div></div><p>Open your IDE and navigate to the <code class="literal">app/code/local</code> folder. If the local folder is not there, create the <code class="literal">app/code/local</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec72"/>How to do it...</h2></div></div></div><p>In the following steps, we will create the files required<a id="id155" class="indexterm"/> to register a Magento module.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the module in <code class="literal">app/code/local</code> by creating the following folders:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">app/code/local/Packt</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">app/code/local/Packt/Helloworld</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">app/code/local/Packt/Helloworld/etc</code></li></ul></div><p>
<code class="literal">Packt</code> is the namespace of the module and <code class="literal">Helloworld</code> is the name of the module.</p></li><li class="listitem">Register the module by creating the <code class="literal">Packt_Helloworld.xml</code> file in the <code class="literal">app/etc/modules</code> folder. Add the following content in this file:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;config&gt;
  &lt;modules&gt;
    &lt;Packt_Helloworld&gt;
      &lt;active&gt;true&lt;/active&gt;
      &lt;codePool&gt;local&lt;/codePool&gt;
    &lt;/Packt_Helloworld&gt;
  &lt;/modules&gt;
&lt;/config&gt;</pre></div></li><li class="listitem">Create the main configuration file <code class="literal">config.xml</code> in the <code class="literal">etc</code> folder of the module. Add the following content in the file:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;config&gt;
  &lt;modules&gt;
    &lt;Packt_Helloworld&gt;
      &lt;version&gt;0.0.1&lt;/version&gt;
    &lt;/Packt_Helloworld&gt;
  &lt;/modules&gt;
&lt;/config&gt;</pre></div></li><li class="listitem">Check the registration of the module by going to the backend. Go to <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Advanced</strong></span> and check whether the module is present in the list. Make sure that you have cleared the Magento caches.</li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip17"/>Tip</h3><p>When running the command <code class="literal">wiz module-list</code> in your command line, you will see a list of all the modules, including the version, code pool, and more. You can find more information about the <a id="id156" class="indexterm"/>Wiz command-line tool in the <span class="emphasis"><em>Configuring the development tools</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Getting Started with Magento">Chapter 1</a>, <span class="emphasis"><em>Getting Started with Magento</em></span>.</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec73"/>How it works...</h2></div></div></div><p>Magento has three code pools. They are listed as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Core</strong></span>: The core pool<a id="id157" class="indexterm"/> contains the modules and classes of the Magento code. It is not recommended to change files in this directory because this will be overwritten <a id="id158" class="indexterm"/>when Magento is upgraded.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Community</strong></span>: The community pool is for the Magento modules that are delivered by the community. They are mostly<a id="id159" class="indexterm"/> the free modules<a id="id160" class="indexterm"/> that you can download from Magento Connect.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Local</strong></span>: The local pool is for the custom <a id="id161" class="indexterm"/>modules such as the one we have<a id="id162" class="indexterm"/> created in this recipe.</li></ul></div><p>The first pool where Magento will search for the code is the local code pool. Next, it will look in the community code pool, and at last it will look in the core code pool.</p></div></div>
<div class="section" title="Registering blocks, helpers, and models"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec32"/>Registering blocks, helpers, and models</h1></div></div></div><p>When we want to perform operations on our module, we have to use blocks, models, and helpers. In this recipe we will register these object types with the right class prefix.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec74"/>Getting ready</h2></div></div></div><p>Open the <code class="literal">config.xml</code> file of the <code class="literal">Packt_Helloworld</code> module. This file is located at <code class="literal">app/code/local/Packt/Helloworld/etc/config.xml</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec75"/>How to do it...</h2></div></div></div><p>In the following steps, we will add configuration to<a id="id163" class="indexterm"/> the module to register the blocks, helpers, <a id="id164" class="indexterm"/>and models:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Register the blocks by adding<a id="id165" class="indexterm"/> the following configuration in the <code class="literal">config.xml</code> file. Add the following XML code as a child of the <code class="literal">&lt;config&gt;</code> tag:<div class="informalexample"><pre class="programlisting">&lt;global&gt;
  &lt;blocks&gt;
    &lt;helloworld&gt;
      &lt;class&gt;Packt_Helloworld_Block&lt;/class&gt;
    &lt;/helloworld&gt;
  &lt;/blocks&gt;
&lt;/global&gt;</pre></div></li><li class="listitem">Create the <code class="literal">app/code/local/Packt/Helloworld/Block</code> folder.</li><li class="listitem">Repeat step 1 and step 2 to register<a id="id166" class="indexterm"/> the helpers and models. Your <a id="id167" class="indexterm"/>global tag will look similar to the code shown as follows:<div class="informalexample"><pre class="programlisting">&lt;global&gt;
  &lt;blocks&gt;
    &lt;helloworld&gt;
      &lt;class&gt;Packt_Helloworld_Block&lt;/class&gt;
    &lt;/helloworld&gt;
  &lt;/blocks&gt;
  &lt;helpers&gt;
    &lt;helloworld&gt;
      &lt;class&gt;Packt_Helloworld_Helper&lt;/class&gt;
    &lt;/helloworld&gt;
  &lt;/helpers&gt;
  &lt;models&gt;
    &lt;helloworld&gt;
      &lt;class&gt;Packt_Helloworld_Model&lt;/class&gt;
    &lt;/helloworld&gt;
  &lt;/models&gt;
&lt;/global&gt;</pre></div></li><li class="listitem">Create the <code class="literal">app/code/local/Packt/Helloworld/Helper</code> and <code class="literal">app/code/local/Packt/Helloworld/Model</code> folders.</li><li class="listitem">Create the helper class of the module by adding the following content to the <code class="literal">app/code/local/Packt/Helloworld/Helper/Data.php</code> file:<div class="informalexample"><pre class="programlisting">&lt;?php
class Packt_Helloworld_Helper_Data extends Mage_Core_Helper_Abstract
{
  
}</pre></div><p>A helper class always extends from the core helper to use the functions declared in this class.</p></li><li class="listitem">Test your configuration with the Wiz command-line tool by running the following command:<div class="informalexample"><pre class="programlisting">wiz devel-models</pre></div><p>You will see your registered models available in the Magento installation.</p></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip18"/>Tip</h3><p>When you change something in a <a id="id168" class="indexterm"/>configuration XML file, make sure that you clear the Magento caches before testing your configuration. Otherwise, the changes will have no effect because the old configuration is cached.</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec76"/>How it works...</h2></div></div></div><p>When these objects are registered, we can create<a id="id169" class="indexterm"/> classes in the <code class="literal">Block</code>, <code class="literal">Helper</code>, and <code class="literal">Model</code> folder. The classnames in these objects need to adhere to the following naming convention; otherwise, they can't be found:</p><p>
<code class="literal">&lt;Vendor Namespace&gt;_&lt;Modulename&gt;_&lt;Objectype&gt;_&lt;Classname&gt;</code>
</p><p>Every folder name starting with <code class="literal">app/code/&lt;codepool&gt;</code> is used in the classname separated by an underscore. The last part is the name of the file. Every folder or file in the <code class="literal">Model</code>, <code class="literal">Block</code>, and <code class="literal">Helper</code> folder starts with a capital letter.</p><p>Our helper class is located in <code class="literal">app/code/local/Packt/Helloworld/Helper</code>, so the classname is <code class="literal">Packt_Helloworld_Helper_Data</code>.</p><p>To load a model, we have to use the <code class="literal">Mage::getModel()</code> function.<a id="id170" class="indexterm"/> In the first parameter, we have to specify the classname, which is different from the real classname. To specify the <code class="literal">Packt_Helloworld_Model_Sample</code> class, we have to use <code class="literal">Mage::getModel('helloworld/sample')</code> to get an instance of this model.</p><p>We have registered our model as <code class="literal">helloworld</code>. The name of the model in the <code class="literal">Model</code> folder is <code class="literal">sample</code>. When you take a look at the <code class="literal">getModel()</code> function<a id="id171" class="indexterm"/> discussed previously, you see that the words <code class="literal">helloworld</code> and <code class="literal">sample</code> are in the argument of that function.</p><p>The same syntax is used to get helpers and blocks. For helpers, we have to use the <code class="literal">Mage::helper()</code> function. <a id="id172" class="indexterm"/>For blocks, this syntax is used in the layout XML files or when we use the core functions to work with blocks.</p></div></div>
<div class="section" title="Adding a new page"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec33"/>Adding a new page</h1></div></div></div><p>Now, we will do something visible with <a id="id173" class="indexterm"/>our module. We are going to add a page to our Magento shop, which we can use for several purposes.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec77"/>Getting ready</h2></div></div></div><p>We have to add some configuration in the <code class="literal">config.xml</code> file and we will also create a controller file.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec78"/>How to do it...</h2></div></div></div><p>In the following steps, we will add an extra page to the Magento installation by adding extra configurations in the <code class="literal">Packt_Helloworld</code> module:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open your IDE and navigate to the <code class="literal">module</code> folder.</li><li class="listitem">Add the following configuration as a child of the <code class="literal">config</code> tag in the <code class="literal">config.xml</code> file of the module:<div class="informalexample"><pre class="programlisting">&lt;frontend&gt;
  &lt;routers&gt;
    &lt;helloworld&gt;
      &lt;use&gt;standard&lt;/use&gt;
      &lt;args&gt;
        &lt;module&gt;Packt_Helloworld&lt;/module&gt;
        &lt;frontName&gt;helloworld&lt;/frontName&gt;
      &lt;/args&gt;
    &lt;/helloworld&gt;
  &lt;/routers&gt;
&lt;/frontend&gt;</pre></div></li><li class="listitem">To create the controller file, we will create an <code class="literal">IndexController.php</code> file in <code class="literal">folder app/code/local/Packt/Helloworld/controllers/</code>.</li><li class="listitem">Add the following content in this controller file. This will create two actions in the <code class="literal">IndexController</code> class<a id="id174" class="indexterm"/>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Packt_Helloworld_IndexController extends Mage_Core_Controller_Front_Action
{
  public function indexAction() 
  {
    
  }
  public function helloAction()
  {
    echo 'Action hello in Helloworld IndexController';
  }
}</pre></div></li><li class="listitem">Clear the cache and test the controller<a id="id175" class="indexterm"/> that is available at the following locations:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/helloworld/index/hello</code>, for the <code class="literal">helloAction</code> function</li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/helloworld</code>, for the <code class="literal">indexAction</code> function</li></ul></div><p>The <code class="literal">helloAction()</code> function<a id="id176" class="indexterm"/> will display the string that we have set in the <code class="literal">echo</code> statement. The <code class="literal">indexAction()</code> function<a id="id177" class="indexterm"/> is a blank page, because we have no more code in this action.</p></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec79"/>How it works...</h2></div></div></div><p>The syntax of a Magento controller is shown as follows:</p><p>
<code class="literal">&lt;modulename or frontname&gt;/&lt;controllerName&gt;/&lt;actionName&gt;</code>
</p><p>In our case, module name and front <a id="id178" class="indexterm"/>name is <code class="literal">helloworld</code>, the controller name is <code class="literal">index</code>, and the action name is <code class="literal">hello</code>, so we get <code class="literal">/helloworld/index/hello</code>.</p><p>Magento recognizes the controller files when a classname ends with the word <code class="literal">Controller</code>. This is the reason why the name of the class is <code class="literal">IndexController</code>.</p><p>The same rule applies for controller actions. The function's name needs to end with the word <code class="literal">Action</code>. The part that precedes <code class="literal">Action</code> is the name of the action. A function called <code class="literal">helloAction()</code> results in the <code class="literal">hello</code> part of the URL.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip19"/>Tip</h3><p>While writing names of controllers and actions, make sure you keep a track on the capital letters of the class and function names. If you miss some capital letters, your code will not work.</p></div></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec80"/>There's more…</h2></div></div></div><p>When we test the controller action, we will see a blank page. This is not wrong because there is no logic added in the controller action.</p><p>If we want to see the frontend of the shop, we have to use the following code:</p><div class="informalexample"><pre class="programlisting">$this-&gt;loadLayout();
$this-&gt;renderLayout();</pre></div><p>This will start the layout system that will load the layout instructions. It is not always recommended to load the frontend as done in a POST<a id="id179" class="indexterm"/> action where you want to process the post and continue to the next page.</p></div></div>
<div class="section" title="Adding a layout file"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec34"/>Adding a layout file</h1></div></div></div><p>In this recipe, we will customize the frontend of <a id="id180" class="indexterm"/>our previously created page with a custom layout XML file.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec81"/>Getting ready</h2></div></div></div><p>For adding a layout file, we have to add some configuration in the <code class="literal">config.xml</code> file of the module and a layout XML file as well.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec82"/>How to do it...</h2></div></div></div><p>In the following steps, we will learn how to add a layout file to the Magento module.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following configuration to your <code class="literal">config.xml</code> file to initialize the layout XML file. Add it as a child of the <code class="literal">&lt;frontend&gt;</code> tag:<div class="informalexample"><pre class="programlisting">&lt;layout&gt;
  &lt;updates&gt;
    &lt;helloworld&gt;
      &lt;file&gt;helloworld.xml&lt;/file&gt;
    &lt;/helloworld&gt;
  &lt;/updates&gt;
&lt;/layout&gt;</pre></div></li><li class="listitem">Create the <code class="literal">helloworld.xml</code> file in your theme layout folder in the <code class="literal">app/design/frontend/&lt;package&gt;/&lt;theme&gt;/layout/helloworld.xml</code> directory.</li><li class="listitem">In the <code class="literal">helloworld.xml</code> file, add the following content to test if the file is loaded:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;layout&gt;
  &lt;default&gt;
    &lt;remove name="header" /&gt;
  &lt;/default&gt;
&lt;/layout&gt;</pre></div></li><li class="listitem">Reload a page in the frontend. The previous configuration will remove the header from every page in the frontend.</li><li class="listitem">Remove the content from the <code class="literal">&lt;default&gt;</code> tag and create the <code class="literal">helloworld_index_hello</code> handle<a id="id181" class="indexterm"/> in the layout XML file. You can do this by adding the following XML code as a child of the <code class="literal">&lt;layout&gt;</code> tag:<div class="informalexample"><pre class="programlisting">&lt;helloworld_index_hello&gt;
  
&lt;/helloworld_index_hello&gt;</pre></div></li><li class="listitem">For this page, we will configure the <code class="literal">2columns-right</code> layout. To do this, add the following configuration in the layout XML file as child of the <code class="literal">helloworld_index_hello</code> handle:<div class="informalexample"><pre class="programlisting">&lt;helloworld_index_hello&gt;
  &lt;reference name="root"&gt;
    &lt;action method="setTemplate"&gt;
      &lt;template&gt;page/2columns-right.phtml&lt;/template&gt;
    &lt;/action&gt;
  &lt;/reference&gt;
&lt;/helloworld_index_hello&gt;</pre></div></li><li class="listitem">Add the following code in the <code class="literal">helloAction()</code> function<a id="id182" class="indexterm"/> of the controller to start the layout system:<div class="informalexample"><pre class="programlisting">$this-&gt;loadLayout();
$this-&gt;renderLayout();</pre></div></li><li class="listitem">Clear the Magento cache and navigate to the <code class="literal">http://magento-dev.local/helloworld/index/hello</code> page. You will see a page with a column towards the right-hand side.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec83"/>How it works...</h2></div></div></div><p>If you only place a <code class="literal">layout.xml</code> file in the <code class="literal">app/design/frontend/&lt;package&gt;/&lt;theme&gt;/layout</code> folder, it will not be loaded in Magento. To do this, we have to configure it in the <code class="literal">config.xml</code> file of our module as we have done in this recipe.</p><p>The layout XML file (<code class="literal">helloworld.xml</code>) works in the same way as all other layout files work, as described in <a class="link" href="ch02.html" title="Chapter 2. Theming">Chapter 2</a>, <span class="emphasis"><em>Theming</em></span>.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec84"/>There's more…</h2></div></div></div><p>Adding a custom layout XML file adds a lot of possibilities for extending your installation. Copying an XML file to your theme and changing the required settings is the easiest way. However, if you want, add a custom layout file and manipulate the blocks in that file.</p><p>The purpose of this method is to avoid double <a id="id183" class="indexterm"/>coding. A good reference of this way of modular theming can be found at <a class="ulink" href="http://www.classyllama.com/development/magento-development/the-better-way-to-modify-magento-layout">http://www.classyllama.com/development/magento-development/the-better-way-to-modify-magento-layout</a>.</p></div></div>
<div class="section" title="Adding a translation file"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec35"/>Adding a translation file</h1></div></div></div><p>In Magento, you can run a store in multiple languages so that your module is translatable to the configured languages. In<a id="id184" class="indexterm"/> this recipe, we will add a custom translate CSV file to our module where we can place the custom strings if needed.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec85"/>Getting ready</h2></div></div></div><p>For this recipe, we have to add some configuration in the <code class="literal">config.xml</code> file of our module. Also, we have to create a translate CSV file in the <code class="literal">locale</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec86"/>How to do it...</h2></div></div></div><p>In the following steps, we will add configuration to the module so that we can translate the interface to multiple languages:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following configuration as a child of the <code class="literal">&lt;frontend&gt;</code> tag in the <code class="literal">config.xml</code> file of the <code class="literal">helloworld</code> module. This will initialize an extra <code class="literal">translate</code> file to the installation:<div class="informalexample"><pre class="programlisting">&lt;translate&gt;
  &lt;modules&gt;
    &lt;Packt_Helloworld&gt;
      &lt;files&gt;
        &lt;default&gt;Packt_Helloworld.csv&lt;/default&gt;
      &lt;/files&gt;
    &lt;/Packt_Helloworld&gt;
  &lt;/modules&gt;
&lt;/translate&gt;</pre></div></li><li class="listitem">We just configured our module to use the <code class="literal">Packt_Helloworld.csv</code> file. Create this file in the <code class="literal">app/locale/en_US</code> folder.</li><li class="listitem">Create a test translation in the controller. Add the following line in the <code class="literal">indexAction()</code> function of <code class="literal">IndexController</code>:<div class="informalexample"><pre class="programlisting">echo $this-&gt;__('Test translation packt');</pre></div></li><li class="listitem">Go to the appropriate page (<code class="literal">http://magento-dev.local/helloworld</code>). You will see that <span class="strong"><strong>Test translation packt</strong></span> is printed<a id="id185" class="indexterm"/> as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_04_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Add the following content in the <code class="literal">Packt_Helloworld.csv</code> file:<div class="informalexample"><pre class="programlisting">"Test translation packt","Packt translation to test"</pre></div></li><li class="listitem">Clear the cache and reload the page. You will see that the output is changed to <span class="strong"><strong>Packt translation to test</strong></span> as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="graphics/3329OS_04_02.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec87"/>How it works...</h2></div></div></div><p>Now, we will discuss the behavior of the translation function in Magento.</p><p>When calling the <code class="literal">__('translate string')</code> function, Magento will search for a translated string in the following resources:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">core_translate translate.csv</code> file in the database table, present in the <code class="literal">app/design/frontend/&lt;package&gt;/&lt;theme&gt;/locale</code> folder</li><li class="listitem" style="list-style-type: disc">Translate files located in <code class="literal">app/locale/&lt;language&gt;</code></li></ul></div><p>If no matching string is found for the<a id="id186" class="indexterm"/> current language, Magento will return the string that is present in the first parameter of the <code class="literal">translate</code> function.</p><p>If a string is found in a resource, Magento won't search further for that string. That means that a string that is in the <code class="literal">core_translate</code> table and the <code class="literal">translate.csv</code> file will be loaded from the database.</p><p>The <code class="literal">translate</code> function<a id="id187" class="indexterm"/> is mostly called on the current object by using <code class="literal">$this-&gt;__()</code>, but this always refers to the <code class="literal">helper</code> function of that object. If <code class="literal">$this-&gt;__()</code> doesn't work (mostly when you are in a class that doesn't extend the abstract block, helper, or model), you have to call the <code class="literal">translate</code> function directly from the module's <code class="literal">helper</code> class as shown in the following code:</p><div class="informalexample"><pre class="programlisting">Mage::helper('&lt;module name&gt;')-&gt;__('…')</pre></div></div></div>
<div class="section" title="Adding a block of new products"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec36"/>Adding a block of new products</h1></div></div></div><p>The module is now prepared for the real work. In the previous recipes, we prepared the module with the most common features. In this recipe, we will add a block of new products in our previously created page.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec88"/>Getting ready</h2></div></div></div><p>To create a custom block, we have to<a id="id188" class="indexterm"/> create a <code class="literal">Block</code> class in the <code class="literal">Block</code> folder of the <code class="literal">Packt_Helloworld</code> module, a layout instruction to add the block to our page, and a <code class="literal">phtml</code> template in our theme to style the HTML output of the block.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec89"/>How to do it...</h2></div></div></div><p>The following steps describe how to add a block with new products to the frontend:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">block</code> class in <code class="literal">app/code/local/Packt/Helloworld/Block</code>. The name of the class is <code class="literal">Newproducts</code>, so we have to create a <code class="literal">Newproducts.php</code> file in this folder.</li><li class="listitem">Add the following content in the file. This will create a class that extends the <code class="literal">Mage_Core_Block_Template</code><a id="id189" class="indexterm"/> class. This class will output a template if specified:<div class="informalexample"><pre class="programlisting">&lt;?php
class Packt_Helloworld_Block_Newproducts extends Mage_Core_Block_Template
{
  
}</pre></div></li><li class="listitem">Add the template to your<a id="id190" class="indexterm"/> theme <code class="literal">template</code> folder. This is in the <code class="literal">app/design/frontend/&lt;package&gt;/&lt;theme&gt;/template/helloworld</code> folder. Create the <code class="literal">newproducts.phtml</code> file in this folder.</li><li class="listitem">Add some HTML content such as <code class="literal">&lt;h2&gt;New Products&lt;/h2&gt;</code> in this file.</li><li class="listitem">Create a block in the <code class="literal">helloworld.xml</code> layout file by adding the following XML code in the <code class="literal">helloworld_index_hello</code> handle:<div class="informalexample"><pre class="programlisting">&lt;reference name="content"&gt;
  &lt;block type="helloworld/newproducts" name="block_newproducts" template="helloworld/newproducts.phtml" /&gt;
&lt;/reference&gt;</pre></div></li><li class="listitem">Clear the cache and go to the <code class="literal">http://magento-dev.local/helloworld/index/hello</code> page. You will see the <span class="strong"><strong>New Products</strong></span> title in the content of the site.</li><li class="listitem">Create the <code class="literal">getProducts()</code> function<a id="id191" class="indexterm"/> in the <code class="literal">block</code> class. This function will return the five latest products from the shop. The code for the <code class="literal">getProducts()</code>function will look as follows:<div class="informalexample"><pre class="programlisting">public function getProducts() 
{
  $products = Mage::getModel('catalog/product')-&gt;getCollection()
    -&gt;addAttributeToSelect('*')
    -&gt;setOrder('created_at')
    -&gt;setPageSize(5);

  return $products;
}</pre></div><p>In this function, we will  fire a query on the product collection. We sort it by date and limit the result to <code class="literal">5</code> so that we get the latest five products.</p></li><li class="listitem">Call the <code class="literal">getProducts()</code> function<a id="id192" class="indexterm"/> in the template and loop through the products to print them in a list. The template code is as follows:<div class="informalexample"><pre class="programlisting">&lt;h2&gt;New Products&lt;/h2&gt;
&lt;ul&gt;
&lt;?php foreach ($this-&gt;getProducts() as $_product): ?&gt;
  &lt;li&gt;&lt;?php echo $_product-&gt;getName() ?&gt;&lt;/li&gt;
&lt;?php endforeach; ?&gt;
&lt;/ul&gt;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec90"/>How it works...</h2></div></div></div><p>What we have done in this recipe is a basic extension of the standard Magento. We have created a custom block. This block is placed on a custom page created by the module.</p><p>In this block, there is a function that returns the five most recent products and a query is fired to get these products. This is not<a id="id193" class="indexterm"/> done by SQL, but by using the Magento collections.</p><p>The purpose of using this is to get an easy interface to return the right entities. Since a product is not stored in one database table, this saves you from programming of a very complex SQL query.</p></div></div>
<div class="section" title="Rewriting a core class"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec37"/>Rewriting a core class</h1></div></div></div><p>In some cases, you want to change something about the standard behavior of Magento. When you see some code in a core class that you want to change, you have to follow this recipe.</p><p>As it is not recommended to do changes in core files, we can rewrite the path of a class to a custom one that is a parent<a id="id194" class="indexterm"/> over the original class.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec91"/>Getting ready</h2></div></div></div><p>In this recipe, we will rewrite the core product model to a custom class in our module.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec92"/>How to do it...</h2></div></div></div><p>In the following steps, we will change the output of the <code class="literal">getName()</code> function of a product:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">getName()</code> function is called on the product detail page. Navigate to this page and open the <code class="literal">catalog/product/view.phtml</code> template.</li><li class="listitem">When you search for <code class="literal">getName()</code> in the template, you see that this is done on the <code class="literal">$_product</code> variable. To know the class of this variable, you can debug this with <code class="literal">echo get_class($_product)</code>.</li><li class="listitem">The output of this function returns the <code class="literal">Mage_Catalog_Model_Product</code> class. To rewrite this, we <a id="id195" class="indexterm"/>have to create an empty class in our <code class="literal">module</code> folder that extends the original one. Create a <code class="literal">Product.php</code> file in the <code class="literal">app/code/local/Packt/Helloworld/Model/Catalog/</code> folder.</li><li class="listitem">Paste the following code in that file:<div class="informalexample"><pre class="programlisting">&lt;?php

class Packt_Helloworld_Model_Catalog_Product extends Mage_Catalog_Model_Product {
  
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip20"/>Tip</h3><p>When rewriting a class, the best practice is to follow the folder structure of the original class in your module. In the <code class="literal">model</code> folder of the <code class="literal">Packt_Helloworld</code> module, we start with a <code class="literal">Catalog</code> folder (refers to the <code class="literal">Catalog</code> module). In this folder, you see the same file structure as in the original module.</p></div></div></li><li class="listitem">When you clear the cache and reload the frontend, you will see that the output of the <code class="literal">get_class</code> function<a id="id196" class="indexterm"/> doesn't change. This is because we didn't add the rewrite configuration in the <code class="literal">config.xml</code> file. Open the <code class="literal">config.xml</code> file and paste the following code as a child of the <code class="literal">&lt;models&gt;</code> tag:<div class="informalexample"><pre class="programlisting">&lt;catalog&gt;
  &lt;rewrite&gt;
    &lt;product&gt;Packt_Helloworld_Model_Catalog_Product&lt;/product&gt;
  &lt;/rewrite&gt;
&lt;/catalog&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip21"/>Tip</h3><p>When you want to rewrite a <code class="literal">block</code> class, you have to paste a similar configuration as a child of the <code class="literal">&lt;blocks&gt;</code> tag. Similarly, for <code class="literal">helper</code>, paste the configuration under the <code class="literal">&lt;helpers&gt;</code> tag.</p></div></div></li><li class="listitem">Clear the cache and reload the product page. You will see that the output of the <code class="literal">get_class</code> function<a id="id197" class="indexterm"/> is changed to the class we have just created.</li><li class="listitem">When the new class is loaded, it is just a case of overwriting the function you want to change in this file. When we want to change the <code class="literal">getName()</code> function<a id="id198" class="indexterm"/>, we have to add the old function in this class and change some behavior. When you paste the following code in the class, the name of the product will change:<div class="informalexample"><pre class="programlisting">public function getName()
{
  return 'Packt ' . $this-&gt;_getData('name');
}</pre></div></li><li class="listitem">Reload the product page and you will see that the name of the product starts with <span class="strong"><strong>Packt</strong></span>.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec93"/>How it works...</h2></div></div></div><p>The best practice is that you <a id="id199" class="indexterm"/>don't rewrite a core class because changing the standard behavior of Magento could break the application in some cases. A more stable method is working with event handlers that are described in <a class="link" href="ch08.html" title="Chapter 8. Event Handlers and Cronjobs">Chapter 8</a>, <span class="emphasis"><em>Event Handlers and Cronjobs</em></span>.</p><p>Unfortunately, in some cases it isn't possible to work with events. So, you need to rewrite a core class. In this case, you have to do it as described in this recipe:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Create an empty class that extends the original ones</li><li class="listitem" style="list-style-type: disc">Paste the function in the class that you want to change</li><li class="listitem" style="list-style-type: disc">Add the configuration in the <code class="literal">config.xml</code> file of your module to rewrite the core class</li></ul></div><p>When the rewrite is added in the <code class="literal">config.xml</code> class<a id="id200" class="indexterm"/>, Magento will recognize the rewrite when the class is called with the Magento functions. For a model, this is the <code class="literal">Mage::getModel()</code> function <a id="id201" class="indexterm"/>where the first argument is the path to the model.</p><p>When calling a class directly in the code as <code class="literal">$product = new Mage_Catalog_Model_Product()</code>, the rewrite will not work because an instance is returned from the <code class="literal">Mage_Catalog_Model_Product</code> class<a id="id202" class="indexterm"/>.</p></div></div></body></html>