<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Discovering What's Nearby"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Discovering What's Nearby</h1></div></div></div><p>When developing an application, we are often presented with the geolocation data for a particular point of interest. Whether it's a business location or a job that the end user is applying to, knowing what's around that particular location can provide immediate value to the user when making a decision about that location. For example, a user may want to know what restaurants are near a particular location or what public services or public transportation options are near a particular job the user is interested in. With the help of third-party location APIs, we can inform the user what is near a given point of interest. For our second application, we develop a web application that shows the user what is near a<a id="id116" class="indexterm"/> particular point of <a id="id117" class="indexterm"/>interest using information from the Google Places API. In this chapter, we also cover how to integrate third-party libraries into our application and how to improve the performance of our application with caching.</p><div class="section" title="Describing the project"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec16"/>Describing the project</h1></div></div></div><p>As with<a id="id118" class="indexterm"/> our tasks application that was outlined in <a class="link" href="ch01.html" title="Chapter 1. A Task-management Application">Chapter 1</a>, <span class="emphasis"><em>A Task-management Application</em></span>, we begin the development by getting a high-level overview of what the project will do and how our application will behave.</p><div class="section" title="Searching nearby locations"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec23"/>Searching nearby locations</h2></div></div></div><p>The core component of this application is its ability to find other locations near an existing<a id="id119" class="indexterm"/> location. The easiest way to find this information is to take advantage of a third-party API. For this application, we'll be using the Google Places API, a web API that can provide nearby locations from given latitude and longitude coordinates.</p></div><div class="section" title="Showing locations"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec24"/>Showing locations</h2></div></div></div><p>Rather <a id="id120" class="indexterm"/>than simply telling our users what locations are near a given point of interest, we can enhance user experience by showing them the points of interest and nearby locations on a map. Many different mapping sources exist to show a map. For this application, we'll take advantage of another Google API, the Google Maps API.</p></div><div class="section" title="Storing locations"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec25"/>Storing locations</h2></div></div></div><p>To show<a id="id121" class="indexterm"/> the user the locations that are available for them to search nearby, we need to store these locations first. For storing these locations, we'll need a database that we can store imported locations into. Like our tasks application that we developed in <a class="link" href="ch01.html" title="Chapter 1. A Task-management Application">Chapter 1</a>, <span class="emphasis"><em>A Task-management Application</em></span>, we'll use SQLite as our primary database again.</p></div><div class="section" title="Importing locations"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec26"/>Importing locations</h2></div></div></div><p>Finally, we're going to need a command-line tool to import locations from a data feed. To accomplish<a id="id122" class="indexterm"/> this, we're going to create a console task that can be run from the command line. This task will fetch information from the provided JSON feed and import it into our database. By making this a command-line task, we can automate and schedule the import via scheduled tasks on Windows or a Unix crontab.</p></div></div></div>
<div class="section" title="Designing the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Designing the database</h1></div></div></div><p>With the <a id="id123" class="indexterm"/>core components of our application <a id="id124" class="indexterm"/>identified, we can now get started with developing the database. Let's start with creating our <code class="literal">locations</code> table.</p><div class="section" title="Locations"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec27"/>Locations</h2></div></div></div><p>When<a id="id125" class="indexterm"/> developing applications that import data from an external source, you can often take advantage of the structure of the external feed to determine what your own database tables should look like. Provided with the chapter resources at <code class="literal">protected/data/</code> is a file called <code class="literal">parks.json</code> that serves as our external data source. Since the data in this feed is consistent, let's take a look at a single item in the feed:</p><div class="informalexample"><pre class="programlisting">{
   "name" : "Cancer Survivors' Garden",
   "lat" : "41.884242",
   "long" : "-87.617404",
   "city" : "Chicago",
   "state" : "IL"
}</pre></div><p>A single <a id="id126" class="indexterm"/>element in our data feed is composed of the name of the location, its latitude and longitude coordinates, and the city and state of the location. To make things simple, we can represent each of these attributes as a <code class="literal">TEXT</code> attribute in our table. Once we have added an <code class="literal">ID</code> column and <code class="literal">created</code> and <code class="literal">updated</code> columns, our <code class="literal">locations</code> table will look as follows:</p><div class="informalexample"><pre class="programlisting">ID INTEGER PRIMARY KEY
name TEXT
lat TEXT
long TEXT
city TEXT
state TEXT
created INTEGER
updated INTEGER</pre></div></div></div>
<div class="section" title="Initializing the project"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Initializing the project</h1></div></div></div><p>As we <a id="id127" class="indexterm"/>did in our tasks project, we begin the development by creating a few folders in our application web root:</p><div class="informalexample"><pre class="programlisting">nearby/
   assets/
   js/
   protected/
      commands/
      config/
      controllers/
      data/
      extensions/
      migrations/
      models/
      runtime/
      views/</pre></div><p>In this application, we added two new folders, <code class="literal">commands</code> and <code class="literal">extensions</code>. The <code class="literal">commands</code> folder is a special folder in Yii that <code class="literal">yiic</code> will reference when running console commands. The <code class="literal">extensions</code> folder is a special folder in Yii, where Yii extensions or third-party classes can be placed.</p><p>Next, let's go ahead and add our Yii Bootstrap file, <code class="literal">index.php</code>, to the root of our application. We <a id="id128" class="indexterm"/>need to be sure to change the Yii path to the location on the system:</p><div class="informalexample"><pre class="programlisting">&lt;?php

// change the following paths if necessary
$yii='/path/to/yii/framework/yii.php';
$config=dirname(__FILE__).'/protected/config/main.php';

error_reporting(E_ALL);
ini_set('display_errors', '1');
// remove the following lines when in production mode
defined('YII_DEBUG') or define('YII_DEBUG',true);
// specify how many levels of call stack should be shown in each log message
defined('YII_TRACE_LEVEL') or define('YII_TRACE_LEVEL',3);

require_once($yii);
Yii::createWebApplication($config)-&gt;run();</pre></div><p>Now, let's create our <code class="literal">yiic.php</code> file within our <code class="literal">protected</code> folder that will run both our migrations and console commands. Once again, we need to be sure to adjust the path to the Yii framework in the <code class="literal">require</code> statement:</p><div class="informalexample"><pre class="programlisting">&lt;?php

// change the following paths if necessary
$config=dirname(__FILE__).'/config/main.php';

$config = require($config);

require_once('/path/to//yii/framework/yiic.php');</pre></div><div class="section" title="Creating the configuration file"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec28"/>Creating the configuration file</h2></div></div></div><p>Next, we <a id="id129" class="indexterm"/>need to create the configuration file that our Yii application will use. Let's add the following to <code class="literal">protected/config/main.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
return array(
   'basePath'=&gt;dirname(__FILE__).DIRECTORY_SEPARATOR.'..',
   'name'=&gt;'Places Nearby',
   'import'=&gt;array(
        'application.models.*',
   ),
   'components'=&gt;array(
        'db'=&gt;array(
            'connectionString' =&gt; 'sqlite:'.dirname(__FILE__).'/../data/locations.db',
      ),
        'urlManager'=&gt;array(
            'urlFormat'=&gt;'path',
            'showScriptName'=&gt;false,
            'rules'=&gt;array(
            '&lt;controller:\w+&gt;/&lt;id:\d+&gt;'=&gt;'&lt;controller&gt;/view', '&lt;controller:\w+&gt;/&lt;action:\w+&gt;/&lt;id:\d+&gt;'=&gt;'&lt;controller&gt;/&lt;action&gt;','&lt;controller:\w+&gt;/&lt;action:\w+&gt;'=&gt;'&lt;controller&gt;/&lt;action&gt;',
            ),
        )
    )
);</pre></div><p>In comparison to the configuration file we made in <a class="link" href="ch01.html" title="Chapter 1. A Task-management Application">Chapter 1</a>, <span class="emphasis"><em>A Task-management Application</em></span>, the only parts of the file that were changed are the location of the database file for SQLite to use and the name of the application.</p></div><div class="section" title="Retrieving the sample data"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec29"/>Retrieving the sample data</h2></div></div></div><p>Provided <a id="id130" class="indexterm"/>with the chapter resources within the <code class="literal">protected/data</code> folder is a file called <code class="literal">parks.json</code>; it contains the sample data that we will use for our application. Let's go ahead and grab this file from the project resources and add it to the <code class="literal">protected/data</code> folder.</p></div></div>
<div class="section" title="Creating the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec19"/>Creating the database</h1></div></div></div><p>To create<a id="id131" class="indexterm"/> the database, we again use migrations. From the command line, let's navigate to the project root and create the migration using <code class="literal">yiic</code>:</p><div class="informalexample"><pre class="programlisting">$ php protected/yiic.php migrate create locations</pre></div><p>After confirming the creation, we open up the new migration file in <code class="literal">protected/migrations</code> and replace the <code class="literal">contents up()</code> method with the following:</p><div class="informalexample"><pre class="programlisting">return $this-&gt;createTable('locations', array(
   'id' =&gt; 'INTEGER PRIMARY KEY',
   'name' =&gt; 'TEXT',
   'lat' =&gt; 'TEXT',
   'long' =&gt; 'TEXT',
   'city' =&gt; 'TEXT',
   'state' =&gt; 'TEXT',
   'created' =&gt; 'INTEGER',
   'updated' =&gt; 'INTEGER'
));</pre></div><p>Then, we replace the contents of the <code class="literal">down()</code> method with the following:</p><div class="informalexample"><pre class="programlisting">return $this-&gt;dropTable('locations');</pre></div><p>From the command line, let's now apply the new migration:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php protected/yiic.php migrate up</strong></span>
</pre></div></div>
<div class="section" title="Creating the locations model"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec20"/>Creating the locations model</h1></div></div></div><p>To interact <a id="id132" class="indexterm"/>with our data, we need to create a model that once again references our new database table. Using the instructions outlined in <a class="link" href="ch01.html" title="Chapter 1. A Task-management Application">Chapter 1</a>, <span class="emphasis"><em>A Task-management Application</em></span>, we enable the <code class="literal">Gii</code> module and create a new model called Location to interact with the <code class="literal">locations</code> table in our database.</p><p>Once created, we add a <code class="literal">beforeSave()</code> method to the generated file (<code class="literal">protected/modules/Location.php</code>) to automatically set the created and updated time:</p><div class="informalexample"><pre class="programlisting">public function beforeSave()
{
   if ($this-&gt;isNewRecord)
      $this-&gt;created = time();

   $this-&gt;updated = time();

   return parent::beforeSave();
}</pre></div><p>Then, we modify the <code class="literal">rules()</code> method:</p><div class="informalexample"><pre class="programlisting">public function rules()
{
    return array(
        array('created, updated', 'numerical', 'integerOnly'=&gt;true),
        array('name, lat, long, city, state', 'required'),
        array('title, data', 'safe'),
        array('name, lat, long, city, state, created, updated', 'safe', 'on'=&gt;'search'),
    );
}</pre></div></div>
<div class="section" title="Importing the data feed"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec21"/>Importing the data feed</h1></div></div></div><p>Before<a id="id133" class="indexterm"/> creating the frontend controllers to display our data, we need to create a tool to import our data feed. To create this tool, we create a class in our commands directory that extends <code class="literal">CConsoleCommand</code>; this will enable us to import data from the command line and automate it if we so choose.</p><p>To begin, we need to create a new class called <code class="literal">ImportLocationsCommand</code> inside of our <code class="literal">commands</code> directory at <code class="literal">/protected</code> that extends <code class="literal">CConsoleCommand</code>. The filename inside the commands directory should be <code class="literal">ImportLocationscommand.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class ImportLocationsCommand extends CConsoleCommand {}</pre></div><p>Next, we add a method to handle the retrieval of the data we want to import. To provide the greatest amount of flexibility, we create two methods: the first will fetch the data from our external data source and the second will actually import the data into our database.</p><p>In a real-world application, the first method that we build might fetch the data from a web resource via CURL. Alternatively, the data might be uploaded and provided to us via FTP. Since our data is stored locally, however, our method will simply fetch the contents of the file:</p><div class="informalexample"><pre class="programlisting">private function getData()
{
   $file = __DIR__ . '/../data/parks.json';
   return CJSON::decode(file_get_contents($file));
}</pre></div><p>By moving this functionality into its own method, we can easily change this method in future to fetch this data from another location, without having to change other parts of our code.</p><p>Next, we <a id="id134" class="indexterm"/>create a new method called <code class="literal">actionImportLocations()</code> that will perform the import:</p><div class="informalexample"><pre class="programlisting">public function actionImportLocations() {}</pre></div><p>For simplicity, we assume that our <code class="literal">getData()</code> method will always return valid data to this method. Inside the method, we add the following:</p><div class="informalexample"><pre class="programlisting">echo "Loading Data...\n";
$data = $this-&gt;getData();</pre></div><p>An important consideration when importing data is to make sure that we don't accidentally create duplicate data within our application. There are several ways to handle this.</p><p>The easiest way to handle this edge case is to simply truncate the database table and perform a fresh import. While this type of import is incredibly simple, with larger datasets, it could cause our application not to function properly while the import is running.</p><p>A more reliable method would be to import this data into a temporary database table and then delete the active table and rename the temporary one to the active table's name. In addition to ensuring that we don't have duplicate data, this method also ensures that if we have a problem importing the data, we can simply abort the import with an error and not worry about having a corrupted database. Additionally, this method should also reduce the downtime associated with importing the raw data.</p><p>The most complex way of importing the data would be to compare your existing database with the data from the feed and import only the difference between the two. While significantly more complex, this method can reduce the overhead needed to retrieve the data, and when put in combination with the previous method, should reduce almost all of the downtime associated with an import.</p><p>To keep things simple, we're going to opt for the first method, which we can easily implement, as follows. First, we're going to truncate the existing data in our database:</p><div class="informalexample"><pre class="programlisting">echo "Truncating old data...\n";
Location::model()-&gt;deleteAll();</pre></div><p>Since our database matches our data feed, we'll simply iterate through the results and import them row by row:</p><div class="informalexample"><pre class="programlisting">echo "Importing Data...\n";
foreach($data as $id=&gt;$content)
{
   $model = new Location;
   $model-&gt;attributes = $content;
   $model-&gt;save();
}</pre></div><p>From the <a id="id135" class="indexterm"/>command line, we can now import our data by running the <code class="literal">importlocations</code> command we just created. Running command-line tasks takes the following format:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php protected/yiic.php &lt;command_name&gt; &lt;action_name&gt;</strong></span>
</pre></div><p>In our case, the full command looks as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php protected/yiic.php importlocations importlocations</strong></span>
</pre></div><p>If the import went well, we will see the debug output that we added to the command without any errors:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php protected/yiic.php importlocations importlocations</strong></span>
<span class="strong"><strong>Loading Data...</strong></span>
<span class="strong"><strong>Truncating old data...</strong></span>
<span class="strong"><strong>Importing Data...</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note03"/>Note</h3><p>You can read<a id="id136" class="indexterm"/> more about <code class="literal">CConsoleCommand</code> from the official guide at <a class="ulink" href="http://www.yiiframework.com/doc/guide/1.1/en/topics.console">http://www.yiiframework.com/doc/guide/1.1/en/topics.console</a> or from the Yii class reference at <a class="ulink" href="http://www.yiiframework.com/doc/api/1.1/CConsoleCommand">http://www.yiiframework.com/doc/api/1.1/CConsoleCommand</a>.</p></div></div></div>
<div class="section" title="Google APIs"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec22"/>Google APIs</h1></div></div></div><p>Before<a id="id137" class="indexterm"/> we begin work at the frontend of our application, we need to create an API key to interact with Google Maps and the Google Places API.</p><div class="section" title="Enabling Google APIs"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec30"/>Enabling Google APIs</h2></div></div></div><p>To enable<a id="id138" class="indexterm"/> the Google APIs our project is using, open up a web browser <a id="id139" class="indexterm"/>and navigate to the Google API Console located at <a class="ulink" href="https://console.developers.google.com/project">https://console.developers.google.com/project</a>. Once we have logged in to a Google account, we click on the <span class="strong"><strong>Create Project</strong></span> button and fill out the form with a unique project name and project ID, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7734OS_02_01.jpg" alt="Enabling Google APIs"/></div><p>Once the project has been created, we navigate to the newly created project and click on the <span class="strong"><strong>APIs &amp; auth</strong></span> link in the sidebar. From the list of APIs, we toggle both <span class="strong"><strong>Google Maps JavaScript API v3</strong></span> and <span class="strong"><strong>Places API</strong></span> to <span class="strong"><strong>ON</strong></span>, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7734OS_02_02.jpg" alt="Enabling Google APIs"/></div></div><div class="section" title="Generating an API key"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec31"/>Generating an API key</h2></div></div></div><p>With both <a id="id140" class="indexterm"/>APIs enabled for the project, we click on <a id="id141" class="indexterm"/>the <span class="strong"><strong>Credentials</strong></span> link in the sidebar. From this menu, we can create a new API key for our application to use. Once on this page, we are presented with two options, either an OAuth Client ID or a Public API key. Click on <span class="strong"><strong>Create new Key</strong></span> under <span class="strong"><strong>Public API access</strong></span>, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7734OS_02_03.jpg" alt="Generating an API key"/></div><p>Then, from <a id="id142" class="indexterm"/>the next menu select <span class="strong"><strong>Server key</strong></span>, which will <a id="id143" class="indexterm"/>generate a new client API key for us to use in our application:</p><div class="mediaobject"><img src="graphics/7734OS_02_04.jpg" alt="Generating an API key"/></div><p>Once<a id="id144" class="indexterm"/> the <a id="id145" class="indexterm"/>page reloads, we copy the full API key to our clipboard.</p></div><div class="section" title="Storing the API key"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec32"/>Storing the API key</h2></div></div></div><p>Next, we<a id="id146" class="indexterm"/> need to store our API in our application so that we<a id="id147" class="indexterm"/> can use it. Fortunately, Yii provides a setting for static parameters in <code class="literal">protected/config/main.php</code> called <code class="literal">params</code> that we can store our API key in. Let's add the following as a root element to our configuration file and replace <code class="literal">&lt;your_api_key_here&gt;</code> with the actual API key:</p><div class="informalexample"><pre class="programlisting">'params' =&gt; array(
   'PlacesApi' =&gt; array(
        'apiKey' =&gt; '&lt;your_api_key_here&gt;'
   )
)</pre></div><p>This data is then available as an array through <code class="literal">Yii::app()-&gt;params</code>, which we can query against, as follows:</p><div class="informalexample"><pre class="programlisting">$apiKey = Yii::app()-&gt;params['PlacesApi']['apiKey'];</pre></div></div></div>
<div class="section" title="Creating the presentation layer"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec23"/>Creating the presentation layer</h1></div></div></div><p>Now, we're<a id="id148" class="indexterm"/> ready to start displaying <a id="id149" class="indexterm"/>content. To get started, we create a new controller called <code class="literal">SiteController.php</code> in the <code class="literal">protected/controllers</code> directory that contains the following:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class SiteController extends CController
{
   public function actionIndex()
   {
        $this-&gt;render('index');
   }
}</pre></div><p>Next, let's create our main layout in <code class="literal">protected/views/layouts/main.php</code>. For simplicity, we're once again going to use the jQuery and Twitter Bootstrap styles from publicly available CDNs, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
   &lt;head&gt;
        &lt;title&gt;&lt;?php echo CHtml::encode(Yii::app()-&gt;name); ?&gt;&lt;/title&gt;

        &lt;?php Yii::app()-&gt;clientScript
                   -&gt;registerMetaTag('text/html; charset=UTF-8', 'Content-Type')
                   -&gt;registerCssFile( '//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css' )
                   -&gt;registerScriptFile( 'https://code.jquery.com/jquery.js' )
                   -&gt;registerScriptFile( '//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js')
                   -&gt;registerScriptFile( 'https://maps.googleapis.com/maps/api/js?sensor=false&amp;key=' . Yii::app()-&gt;params['PlacesApi']['apiKey']);
        ?&gt;
   &lt;/head&gt;
   &lt;body&gt;
        &lt;div class="row"&gt;
            &lt;div class="container"&gt;
                &lt;nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="navigation"&gt;
                    &lt;div class="navbar-header"&gt;
                         &lt;a class="navbar-brand" href="/"&gt;&lt;?php echo CHtml::encode(Yii::app()-&gt;name); ?&gt;&lt;/a&gt;
                    &lt;/div&gt;
                &lt;/nav&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="row" style="margin-top: 100px;"&gt;
             &lt;div class="container"&gt;
                &lt;?php echo $content; ?&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre></div><p>Since our<a id="id150" class="indexterm"/> application will have only <a id="id151" class="indexterm"/>one page, we will register the Google Maps JavaScript API directly in our layout, as shown in the preceding code. Note that when we registered this JavaScript file, we included our Google API key, which we added to the <code class="literal">params</code> section of our configuration file:</p><div class="informalexample"><pre class="programlisting">-&gt;registerScriptFile( 'https://maps.googleapis.com/maps/api/js?sensor=false&amp;key=' . Yii::app()-&gt;params['PlacesApi']['apiKey']);</pre></div><p>Next, let's create a simple view file for our <code class="literal">site/index</code> action in <code class="literal">protected/views/sites/index.php</code> to hold our maps container:</p><div class="informalexample"><pre class="programlisting">&lt;div class="col-xs-12 col-sm-9"&gt;
   &lt;div id="map-canvas" style="width: 100%; min-height: 500px"&gt;&lt;/div&gt;
&lt;/div&gt;</pre></div><div class="section" title="Interacting with the Google Maps JavaScript API"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec33"/>Interacting with the Google Maps JavaScript API</h2></div></div></div><p>Since<a id="id152" class="indexterm"/> Google Maps is <a id="id153" class="indexterm"/>a JavaScript API, we need to write<a id="id154" class="indexterm"/> some JavaScript code to interact with it.</p><p>To begin, create a <a id="id155" class="indexterm"/>new file in <code class="literal">/js</code> called <code class="literal">Main.js</code>. This JavaScript file will store all of our JavaScript methods to create and interact with Google Maps. The utility functions we create here will make interacting with the map easier later on.</p><p>Before we start writing any JavaScript, we need to load our JavaScript file from our layout. To do this, we can register a new script from <code class="literal">CClientScript</code> by adding the following to our call to <code class="literal">CClientScript</code> in our <code class="literal">main.php</code> file at <code class="literal">protected/views/layouts</code>:</p><div class="informalexample"><pre class="programlisting">-&gt;registerScriptFile(Yii::app()-&gt;baseUrl .'/js/Main.js');</pre></div><p>Now <a id="id156" class="indexterm"/>that our <a id="id157" class="indexterm"/>JavaScript file will be loaded, we open up <a id="id158" class="indexterm"/>our <code class="literal">Main.js</code> file and create a new JavaScript object called <code class="literal">Main</code>:</p><div class="informalexample"><pre class="programlisting">var Main = {}</pre></div><p>Within this object, we need to create three properties: a property to store the Google Maps object, a property to store any options Google Maps may require, and a property to store any marker we add to the map:</p><div class="informalexample"><pre class="programlisting">map : null,
mapOptions : {},
markers : [],</pre></div><p>Next, we create a function that will actually load the Google Maps object. This function will need to handle two separate loading cases.</p><p>The first case this function will need to handle is the loading of Google Maps without any map markers. In this situation, we assume the user has arrived at the page for the first time and has not selected the point of interest that they want to see nearby locations for. The second case this function will need to handle is the initialization of the map with a given point of interest centered and focused on.</p><p>To handle these two cases, our function will accept a latitude and longitude location. If the latitude and longitude positions are given to the method, we will center the map on that location. If they are not provided, we will center the map on a zoomed-out location of where our data generally lies, which in this case is the downtown Chicago area:</p><div class="informalexample"><pre class="programlisting">loadMap : function(lat, lng) {
zoom = 16;
    if (lat == undefined &amp;&amp; lng == undefined)
    {
        // Lat long of downtown Chicago area
        lat = "41.878114";
        lng = "-87.629798";
        zoom = 13;
    }
}</pre></div><p>Then, within the same function, we're going to set our map options and load the map in the placeholder that we set in our <code class="literal">index.php</code> file at <code class="literal">protected/views/site</code>:</p><div class="informalexample"><pre class="programlisting">Main.mapOptions = {
   zoom: zoom,
   center: new google.maps.LatLng(lat, lng),
};

Main.map = new google.maps.Map(document.getElementById("map-canvas"), Main.mapOptions);</pre></div><p>So<a id="id159" class="indexterm"/> that <a id="id160" class="indexterm"/>we can see our map in action, we add the following to our <code class="literal">index.php</code> file at <code class="literal">protected/views/site</code> and refresh the page:</p><div class="informalexample"><pre class="programlisting">&lt;?php $cs-&gt;registerScript('loadMap', "Main.loadMap();"); ?&gt;</pre></div><p>Once the page loads, we should see the Google Maps object displayed, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7734OS_02_05.jpg" alt="Interacting with the Google Maps JavaScript API"/></div><p>After verifying that our map has loaded, let's head back to our <code class="literal">Main.js</code> file and add a few more utility functions.</p><p>First, let's add a simple wrapper to create the Google Maps latitude and longitude coordinates. This method will help ensure that our Google Maps object loads when we <a id="id161" class="indexterm"/>want <a id="id162" class="indexterm"/>to interact with it:</p><div class="informalexample"><pre class="programlisting">createLocation : function(lat,lng) {
   return new google.maps.LatLng(lat,lng);
},</pre></div><p>Secondly, let's create a function to add map markers. This function will need to display two types of markers, the first being the selected point of interest and the second being the nearby points of interest:</p><div class="informalexample"><pre class="programlisting">addMarker : function(position, title, icon) {
   if (icon == true)
   {
        var pinColor = "2F76EE"; // a random blue color that i picked
        var icon = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&amp;chld=%E2%80%A2|" + pinColor,
                     new google.maps.Size(21, 34),
                     new google.maps.Point(0,0),
                     new google.maps.Point(10, 34));
    }
}</pre></div><p>Within the function, we create a new <code class="literal">marker</code> object:</p><div class="informalexample"><pre class="programlisting">var marker = new google.maps.Marker({
position: position,
   title: title,
   icon: icon
});</pre></div><p>Then, we push this <code class="literal">marker</code> object onto the map:</p><div class="informalexample"><pre class="programlisting">Main.markers.push(marker);</pre></div><p>Then, we add the <code class="literal">marker</code> object to the <code class="literal">markers</code> variable that we defined earlier. This allows us to clear the map if we want to make our application more dynamic:</p><div class="informalexample"><pre class="programlisting">marker.setMap(Main.map);</pre></div><p>Finally, let's create a function that will clear the map. This function will iterate through all <a id="id163" class="indexterm"/>of the <a id="id164" class="indexterm"/>markers in the <code class="literal">markers</code> variable that we defined earlier and remove the map marker we set with <code class="literal">addMarker()</code>:</p><div class="informalexample"><pre class="programlisting">clearMarkers : function() {
   $(Main.markers).each(function() {
        this.setMap(null);
   });

   Main.markers = [];
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>More<a id="id165" class="indexterm"/> information on how to interact with the Google Maps JavaScript API v3 is located at <a class="ulink" href="https://developers.google.com/maps/documentation/javascript/tutorial">https://developers.google.com/maps/documentation/javascript/tutorial</a>.</p></div></div></div><div class="section" title="Searching nearby locations"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec34"/>Searching nearby locations</h2></div></div></div><p>To search <a id="id166" class="indexterm"/>nearby locations, we're going to take advantage of the Google Places API. Rather than <a id="id167" class="indexterm"/>implementing the API documentation ourselves, as outlined in <a class="ulink" href="https://developers.google.com/places/documentation/">https://developers.google.com/places/documentation/</a>, we're going to take advantage of an open source wrapper for the API located at <a class="ulink" href="https://github.com/joshtronic/php-googleplaces">https://github.com/joshtronic/php-googleplaces</a>.</p><p>To take advantage of this wrapper, we download the repository to our <code class="literal">extensions</code> folder, which should look as follows, once we have downloaded the repository:</p><div class="informalexample"><pre class="programlisting">protected/
   extensions/
        GooglePlaces.php</pre></div><p>With the wrapper downloaded, we reopen <code class="literal">SiteController.php</code> and create a new private method called <code class="literal">getPlaces()</code>, which takes a location from our database as an argument:</p><div class="informalexample"><pre class="programlisting">private function getPlaces($location) {}</pre></div><p>To make Yii aware of this class, we need to first import it using <code class="literal">Yii::import()</code>. This method is preferred over a <code class="literal">require</code> or <code class="literal">include</code> statement because it both registers the class with Yii's autoloader and only loads the class once if we use it multiple times. Since this<a id="id168" class="indexterm"/> class wasn't autoloaded in our configuration file, we need to manually import it here:</p><div class="informalexample"><pre class="programlisting">Yii::import('ext.GooglePlaces');</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note05"/>Note</h3><p>How does Yii know that <code class="literal">ext.GooglePlaces</code> represents <code class="literal">protected/extensions/GooglePlaces.php</code>? Yii uses path aliases to easily identify where files and folders are located within our application root. This enables us to easily reference these files and folders without having to specify an absolute path. You can read more about path aliases at <a class="ulink" href="http://www.yiiframework.com/doc/guide/1.1/en/basics.namespace">http://www.yiiframework.com/doc/guide/1.1/en/basics.namespace</a>.</p></div></div><p>Next, we instantiate the class with the API key that we created earlier:</p><div class="informalexample"><pre class="programlisting">$places = new GooglePlaces(Yii::app()-&gt;params['PlacesApi']['apiKey']);</pre></div><p>Then, we specify the radius and location that we want to search around:</p><div class="informalexample"><pre class="programlisting">$places-&gt;radius = 200;
$places-&gt;location = array($location-&gt;lat, $location-&gt;long);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note06"/>Note</h3><p>In a densely populated area with many different shops, it's safe to assume that we'd find several results within a 200-meter radius. In a less densely populated area, it would be wise to adjust our radius to something much larger to find nearby results better.</p></div></div><p>Then, we <a id="id169" class="indexterm"/>search for nearby locations:</p><div class="informalexample"><pre class="programlisting">return $places-&gt;search();</pre></div><p>With a method in place to perform the search, we now need to update our <code class="literal">index</code> action to call our new method. To do this, we assume that the client is going to specify which location they want to search around by selecting a location from a drop-down list and sending us the unique ID we created for the record when we imported it. Within <code class="literal">SiteController.php</code>, we add the following action:</p><div class="informalexample"><pre class="programlisting">public function actionIndex()
{
   $location = $places = array();

   if (isset($_GET['id']))
   {
        $location = Location::model()-&gt;findByPk($_GET['id']);
        $places = $this-&gt;getPlaces($location);
   }

   $this-&gt;render('index', array('location' =&gt; $location, 'places' =&gt; $places));
}</pre></div></div><div class="section" title="Selecting a location"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec35"/>Selecting a location</h2></div></div></div><p>Now <a id="id170" class="indexterm"/>that our controller can search nearby locations, we need to update our view, <code class="literal">protected/views/site/index.php</code>, with a form to allow the user to select a location they're inserted in:</p><div class="informalexample"><pre class="programlisting">&lt;div class="col-xs-6 col-sm-3 sidebar-offcanvas"&gt;
   &lt;h3&gt;Locations&lt;/h3&gt;
   &lt;hr /&gt;
   &lt;form role="form"&gt;
        &lt;div class="form-group"&gt;
            &lt;?php $selected = array('options' =&gt; array(isset($_GET['id']) ? $_GET['id'] : NULL =&gt; array('selected' =&gt; true))); ?&gt;
            <span class="strong"><strong>&lt;?php echo CHtml::dropDownList('id', array(), CHtml::listData(Location::model()-&gt;findAll(),'id','name'), CMap::mergeArray($selected, array('empty' =&gt; 'Select a Location'))); ?&gt;</strong></span>
        &lt;/div&gt;
        &lt;button type="submit" class="pull-right btn btn-primary"&gt;Search&lt;/button&gt;
    &lt;/form&gt;
    &lt;div class="clearfix"&gt;&lt;/div&gt;
&lt;/div&gt;</pre></div><p>In the previous code sample, we used <code class="literal">CHtml::listData()</code> to simultaneously retrieve a list of locations<a id="id171" class="indexterm"/> from our database and populate the drop-down menu with the appropriate ID name pairs to be displayed. Using <code class="literal">CHtml::listData()</code>, we can ensure that our data is fetched and displayed dynamically based on what we have in our database.</p></div><div class="section" title="Showing locations on a map"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec36"/>Showing locations on a map</h2></div></div></div><p>While <a id="id172" class="indexterm"/>our form is functional, we still need to update our view to actually display the locations on the map. This is where we use the JavaScript code we created earlier. Before the closing <code class="literal">&lt;/div&gt;</code> tag of our sidebar, let's load <code class="literal">CClientScript</code> to dynamically register the JavaScript with Yii:</p><div class="informalexample"><pre class="programlisting">&lt;?php $cs = Yii::app()-&gt;getClientScript(); ?&gt;</pre></div><p>Now, there are two cases we need to handle. In the first case, the user has arrived at our site for the first time and simply needs to be shown the map. In the second case, we need to show a map that is centered around our point of interest. Since our <code class="literal">$places['results']</code> array will be empty in the first case, we can express this as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?php 
if (!empty($places['results']))
{
$cs-&gt;registerScript('loadMap', "Main.loadMap({$location-&gt;lat}, {$location-&gt;long});");

   // Center the map with the origin marker
   $lat = $location-&gt;lat;
   $long = $location-&gt;long;
   $name = $location-&gt;name;
   $cs-&gt;registerScript('origin', "
        Main.addMarker(
            Main.createLocation('{$lat}', '{$long}'),
            \"{$name}\",
            true
        );
    ");
}
else
{
$cs-&gt;registerScript('loadMap', "Main.loadMap();");
}</pre></div><p>Let's <a id="id173" class="indexterm"/>reload the page and try it out. If a location is selected, a blue marker will indicate the position on the map. Otherwise, no marker will be shown.</p><p>Next, we need to add the nearby locations to the map. To do this, we simply iterate through the <code class="literal">$places['results']</code> array and register a unique script that will place a marker on the map. For added clarity for the end user, we also add the item as a text entry in the sidebar:</p><div class="informalexample"><pre class="programlisting">&lt;hr /&gt;
&lt;h3&gt;What's Nearby?&lt;/h3&gt;
&lt;ul&gt;
   &lt;?php foreach ($places['results'] as $place): ?&gt;
        &lt;li&gt;&lt;?php echo $place['name']; ?&gt;&lt;/li&gt;
        &lt;?php
            // Add the nearby POI's
            $lat = $place['geometry']['location']['lat'];
            $long = $place['geometry']['location']['lng'];
            $name = $place['name'];
            $icon = $place['icon'];
            $cs-&gt;registerScript('loadMarker-' . $place['id'], "
                Main.addMarker(
                    Main.createLocation('{$lat}', '{$long}'),
                  \"{$name}\"
                     );
            ");
            ?&gt;
        &lt;?php endforeach; ?&gt;
&lt;/ul&gt;</pre></div><p>With <a id="id174" class="indexterm"/>everything in place, we can now search our <code class="literal">locations</code> database and see nearby locations displayed on the map:</p><div class="mediaobject"><img src="graphics/7734OS_02_06.jpg" alt="Showing locations on a map"/></div></div><div class="section" title="Optimizing the performance with caching"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec37"/>Optimizing the performance with caching</h2></div></div></div><p>As<a id="id175" class="indexterm"/> is <a id="id176" class="indexterm"/>often the case with third-party APIs, the Google Places API is a paid-for resource that comes with a daily courtesy limit (currently at 1,000 requests per day), which means that every time a user makes a request to our application, we're paying for it.</p><p>However, since the likelihood of a new point of interest being created within the next few hours, days, or even weeks is pretty small, we can cache this data locally rather than making a request to Google each time the page is requested. Doing this will not only save us money, but it will also speed up our application since this data can be retrieved from a local resource rather than a third-party one.</p><p>To do this, we first need to enable a cache in our configuration file. There are several different caches available for use in Yii, including file-based caches, memcache-based caching, and a Redis cache. For this application, we'll keep things simple and use file-based caching. To enable the cache, we add the following to the components section of our configuration file:</p><div class="informalexample"><pre class="programlisting">'cache' =&gt; array(
   'class' =&gt; 'CFileCache'
),</pre></div><p>With the cache enabled, we start using it within our application. Let's open up <code class="literal">SiteController.php</code> and replace the <code class="literal">getPlaces()</code> method with the following:</p><div class="informalexample"><pre class="programlisting">private function getPlaces(&amp;$location)
{
   // Generate a hash
   $hash = md5($location-&gt;lat . '-' . $location-&gt;long);

   // Retrieve data from the cache
   $cache = Yii::app()-&gt;cache-&gt;get($hash);

   // If we don't have any cached data, perform a search
   // against the API
   if ($cache === false)
   {
        Yii::import('ext.GooglePlaces');
        $places = new GooglePlaces(Yii::app()-&gt;params['PlacesApi']['apiKey']);
        $places-&gt;radius = 200;
        $places-&gt;location = array($location-&gt;lat, $location-&gt;long);
        $cache = $places-&gt;search();
        // And store the result in the cache
Yii::app()-&gt;cache-&gt;set($hash, $cache);
    }

    return $cache;
}</pre></div><p>Let's walk through what we just did. First, we're going to generate a unique hash that we'll store our hashes against. To do this, we're going to store the latitude and longitude of any <a id="id177" class="indexterm"/>given location as an <code class="literal">md5</code> hash, which should provide sufficient search space for us<a id="id178" class="indexterm"/> to store our results:</p><div class="informalexample"><pre class="programlisting">$hash = md5($location-&gt;lat . '-' . $location-&gt;long);</pre></div><p>Next, we're going to retrieve the cache result from the cache. In the event that data is not returned, this method will return false:</p><div class="informalexample"><pre class="programlisting">$cache = Yii::app()-&gt;cache-&gt;get($hash);</pre></div><p>If we don't have any value presently stored in the cache, we'll perform a search against the API:</p><div class="informalexample"><pre class="programlisting">if ($cache === false) {}</pre></div><p>After retrieving the results from the API, we then store it against the <code class="literal">md5</code> hash that we generated earlier:</p><div class="informalexample"><pre class="programlisting">$cache = $places-&gt;search();
Yii::app()-&gt;cache-&gt;set($hash, $cache);</pre></div><p>Finally, we return the data:</p><div class="informalexample"><pre class="programlisting">return $cache;</pre></div><p>By adding this cache, our application should perform much better when multiple users are searching against it, and we reduce the risk of hitting our daily API limit. If we do need to upgrade our application to one that needs more requests, we can be confident that we're only paying for what we absolutely need, rather than for each request.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec24"/>Summary</h1></div></div></div><p>Throughout this chapter, we covered a lot of ground. We went over how to integrate console commands into our application with <code class="literal">CConsoleCommand</code> as well as how to import data into our database from an external source. We also went over how to integrate with two popular Google APIs: Google Maps and the Google Places API. Additionally, we covered caching the responses of these APIs. Finally, we went over importing third-party code into our application.</p><p>In this chapter and in <a class="link" href="ch01.html" title="Chapter 1. A Task-management Application">Chapter 1</a>, <span class="emphasis"><em>A Task-management Application</em></span>, we went over almost all the basic components of building a Yii application. In the next chapter, we will create a scheduling application that will automatically remind the user of events before they occur'. We'll also expand on all of the topics we covered so far to build and work with more complex topics. Before continuing, be sure to take a look at all the classes we referenced in this chapter, in the official Yii documentation, so that you can better understand them.</p></div></body></html>