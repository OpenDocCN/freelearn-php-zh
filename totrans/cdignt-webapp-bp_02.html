<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;A URL Shortener"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. A URL Shortener</h1></div></div></div><p>There are quite a few URL shorteners out there on the Internet; however, there's always room for a little fun and sometimes people or companies require their own solutions rather than just using an external provider. The project in this chapter covers just that—developing a URL shortener in CodeIgniter that can be used by anyone.</p><p>To make this app, we'll need to do a few things: we'll create two controllers, one to create a shortened URL and one to redirect a shortened URL to its actual location on the Web.</p><p>We'll create language files to store text, creating a foundation for multiple language support should you wish to implement it.</p><p>We will also make amends to the <code class="literal">config/routes.php</code> file—this is to ensure that the shortened URL is as short as it can be.</p><p>However, this app, along with all the others in this book, relies on the basic setup we did in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>; although you can take large sections of the code and drop it into pretty much any app you may already have, bear in mind that the setup we did in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources,</em></span> acts as a foundation for this chapter.</p><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Design and wireframes</li><li class="listitem" style="list-style-type: disc">Creating the database</li><li class="listitem" style="list-style-type: disc">Adjusting the <code class="literal">routes.php</code> file</li><li class="listitem" style="list-style-type: disc">Creating the model</li><li class="listitem" style="list-style-type: disc">Creating the views</li><li class="listitem" style="list-style-type: disc">Creating the controllers</li><li class="listitem" style="list-style-type: disc">Putting it all together</li></ul></div><p>So without further ado, let's get on with it.</p><div class="section" title="Design and wireframes"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec19"/>Design and wireframes</h1></div></div></div><p>Before <a id="id39" class="indexterm"/>we start building, we should always take a look at what we plan to build.</p><p>Firstly, a<a id="id40" class="indexterm"/> brief description of our intent: we plan to build an app that will display a simple form to the user. The user will be encouraged to enter a URL into the form and submit that form.</p><p>A unique code will be generated and associated with the URL entered by the user. This URL and unique code will be saved to a database.</p><p>A new URL will be shown to the user containing the unique code we just generated. That unique code will be appended to the URL of the app we're building. Should the user (or anyone else) click on that link, the app will look up the unique code in the database. If the unique code exists, it will redirect the user to the original URL associated with that unique code.</p><p>So, let's take a look at some wireframes to help us understand what this might look like on screen:</p><div class="mediaobject"><img src="graphics/7093OS_02_01.jpg" alt="Design and wireframes"/></div><p>This is the first page that the user will see. The user is invited to enter a URL into the textbox and hit the <span class="strong"><strong>Go</strong></span> button.</p><p>The page<a id="id41" class="indexterm"/> will be submitted and code will be generated. Both this code<a id="id42" class="indexterm"/> and the original URL will be saved to the database. The user will then see the new URL we've just created for them. They can copy that URL to their clipboard (for pasting into an e-mail and so on) or click on it there and then if they wish. This is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7093OS_02_02.jpg" alt="Design and wireframes"/></div><div class="section" title="File overview"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec13"/>File overview</h2></div></div></div><p>We're <a id="id43" class="indexterm"/>going to create six files for this application, as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/urls_model.php</code>: This file provides access<a id="id44" class="indexterm"/> to the database and allows us to create the <code class="literal">url_code</code>, save the record to the database, and also retrieve the original URL from the database.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/create/create.php</code>: This file provides <a id="id45" class="indexterm"/>us with our interface, the user facing form, and any messages needed to inform the user of their actions or the system's actions.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/nav/top_nav.php</code>: This file provides a <a id="id46" class="indexterm"/>navigation bar at the top of the page.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/create.php</code>: This file<a id="id47" class="indexterm"/> performs<a id="id48" class="indexterm"/> validation checks on the URL inputted by the user, calls any helpers, and so on.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/go.php</code>: This file provides support for <a id="id49" class="indexterm"/>shortened URLs. It gets the unique code parameter from the URI (first segment), sends it to the <code class="literal">Urls_model,</code> and redirects the user to the associated <code class="literal">url_address</code> if it exists.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/language/english/en_admin_lang.php</code>: This file<a id="id50" class="indexterm"/> provides language support for the application.</li></ul></div><p>The file structure of the preceding six files is as follows:</p><div class="informalexample"><pre class="programlisting">application/
├── controllers/
│   ├── create.php
│   ├── go.php
├── models/
│   ├── urls_model.php
├── views/create/
│   ├── create.php
├── views/nav/
│   ├── top_nav.php
├── language/english/
    ├── en_admin_lang.php</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip02"/>Tip</h3><p>
<span class="strong"><strong>Downloading the example code</strong></span>
</p><p>You can download the example code files from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a> for all the Packt Publishing books you have purchased. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div></div></div></div>
<div class="section" title="Creating the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec20"/>Creating the database</h1></div></div></div><p>Okay, you<a id="id51" class="indexterm"/> should have already set up CodeIgniter and Bootstrap as described in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>. If not, then you should know that the code in this chapter is specifically built with the setup from <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources,</em></span> in mind. However, it's not the end of the world—the code can easily be applied to other situations.</p><p>Firstly, we'll build the database. Copy out the following MySQL code into your database:</p><div class="informalexample"><pre class="programlisting">CREATE DATABASE `urls`;
USE `urls`;

CREATE TABLE `urls` (
  `url_id` int(11) NOT NULL AUTO_INCREMENT,
  `url_code` varchar(10) NOT NULL,
  `url_address` text NOT NULL,
  `url_created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`url_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip03"/>Tip</h3><p>You<a id="id52" class="indexterm"/> don't have to call the database <code class="literal">urls</code> if you don't want to. Feel free to rename to something else if you wish; just be sure to update the <code class="literal">config/database.php</code> file accordingly.</p></div></div><p>Let's take a look at what each item in the database means:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Elements</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">url_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id53" class="indexterm"/>is the primary key.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">url_code</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id54" class="indexterm"/>contains the unique code generated by the <code class="literal">save_url()</code> function of <code class="literal">urls_model.php</code>. This is the code that is appended to the shortened URL.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">url_address</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id55" class="indexterm"/> is the actual URL the user entered in the form in the <code class="literal">create.php</code> view file. It will be the URL that the user is redirected to.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">url_created_at</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id56" class="indexterm"/>is the MySQL timestamp created when the record was added. It is necessary so that we have an idea of when a record was created; also, it gives us a method of clearing old records from the database using a cron script should you wish.</p>
</td></tr></tbody></table></div><p>We'll also need to make amends to the <code class="literal">config/database.php</code> file—namely setting the database access details, username password, and so on.</p><p>Open the <code class="literal">config/database.php</code> file and find the following lines:</p><div class="informalexample"><pre class="programlisting">$db['default']['hostname'] = 'localhost';
$db['default']['username'] = 'your username';
$db['default']['password'] = 'your password';
$db['default']['database'] = 'urls';</pre></div><p>Edit the values in the preceding lines. Ensure you substitute those values with the ones that are more specific to your setup and situation—so enter your username, password, and so on.</p></div>
<div class="section" title="Adjusting the routes.php file"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec21"/>Adjusting the routes.php file</h1></div></div></div><p>We want<a id="id57" class="indexterm"/> short URLs—in fact the shorter the better. The user clicking on a URL would be better served if the URL were as short as possible; for that reason, it would be a good idea if we removed certain things from the URL to make it shorter—for example, the controller name and function name. We will use CodeIgniter's routing functionality to achieve this. This can be done as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">config/routes.php</code> file for editing and find the following lines (near the bottom of the file):<div class="informalexample"><pre class="programlisting">$route['default_controller'] = "welcome";
$route['404_override'] = '';</pre></div></li><li class="listitem">Firstly, we need to change the default controller. Initially, in a CodeIgniter application, the default controller is set to <code class="literal">welcome</code>. However, we don't need that; instead we want the default controller to be <code class="literal">create</code>. So, consider the following line:<div class="informalexample"><pre class="programlisting">$route['default_controller'] = "welcome";</pre></div><p>Replace it with the following code:</p><div class="informalexample"><pre class="programlisting">$route['default_controller'] = "create";</pre></div></li><li class="listitem">We will also need to set up a route rule for the <code class="literal">go</code> controller. We will need to remove the controller and function names (usually the first and second parameters in the URI). The following are two lines of code (highlighted in bold); add these two lines below the <code class="literal">404_override</code> route, so that the file now looks like the following:<div class="informalexample"><pre class="programlisting">$route['default_controller'] = "create";
$route['404_override'] = '';

<span class="strong"><strong>$route['create'] = "create/index";</strong></span>
<span class="strong"><strong>$route['(:any)'] = "go/index";</strong></span>
</pre></div></li></ol></div><p>Now, the eagle-eyed among you will have looked at that last line and seen the <code class="literal">(:any)</code> type; some of you may have wondered what all that was about.</p><p>CodeIgniter supports a simple type of regex that makes routing for unknown URLs much easier. The <code class="literal">(:any)</code> type says to CodeIgniter that any URI pattern not otherwise defined (we're also defining <code class="literal">create</code>) is to be routed to <code class="literal">go/index</code>.</p></div>
<div class="section" title="Creating the model"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec22"/>Creating the model</h1></div></div></div><p>The <code class="literal">Urls_model</code> contains <a id="id58" class="indexterm"/>three functions; obviously it contains our <code class="literal">__construct()</code> function but we're not focusing on that at the moment as it's not doing anything except referencing its parent.</p><p>Instead, let's<a id="id59" class="indexterm"/> look at the two functions <code class="literal">save_url()</code> and <code class="literal">fetch_url()</code>. As <a id="id60" class="indexterm"/>their names suggest, one saves information to the database and the other fetches information from it. For now, let's go and create the code and we'll discuss in detail what each function does later: Create the <code class="literal">urls_model.php</code> model file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Urls_model extends CI_Model {
  function __construct() {
    parent::__construct();
  }

  function save_url($data) {
    /*
    Let's see if the unique code already exists in 
    the database.  If it does exist then make a new 
    one and we'll check if that exists too.  
    Keep making new ones until it's unique.  
    When we make one that's unique, use it for our url 
    */
    do {
      $url_code = random_string('alnum', 8); 

      $this-&gt;db-&gt;where('url_code = ', $url_code);
      $this-&gt;db-&gt;from('urls');
      $num = $this-&gt;db-&gt;count_all_results();
    } while ($num &gt;= 1);

    $query = "INSERT INTO `urls` (`url_code`, `url_address`) VALUES (?,?) ";
    $result = $this-&gt;db-&gt;query($query, array($url_code, $data['url_address']));

    if ($result) {
      return $url_code;
    } else {
      return false;
    }
  }

  function fetch_url($url_code) {
    $query = "SELECT * FROM `urls` WHERE `url_code` = ? ";
    $result = $this-&gt;db-&gt;query($query, array($url_code));
    if ($result) {
      return $result;
    } else {
      return false;
    }
  }
}</pre></div><p>Let's take <a id="id61" class="indexterm"/>a look at <code class="literal">save_url()</code>. Notice the PHP construct <code class="literal">do...while</code>; it looks something like the following:</p><div class="informalexample"><pre class="programlisting">do {
// something
} while ('…a condition is not met');</pre></div><p>So that means <span class="emphasis"><em>do something while a condition is not met</em></span>.</p><p>Now, with that in mind, think about our problem. We have to associate the URL that the user has entered in the form with a unique value. We will use this unique value to represent the real URL.</p><p>Now there's no point using a sequential number (1, 2, 3, … 1000) as our unique value as someone can come along and iterate up through the numbers and get access to everyone's URLs. This may not be such a dreadful security risk as presumably all pages are accessible from the Internet anyway, but it's still not a good idea. So the unique value must not only be unique, it must be random and not easily guessed by passersby. Also, this unique value must only exist once in the database.</p><p>To ensure this, we will have to check if the unique value already exists and, if it does exist, make a new unique code and check in the database again.</p><p>So, let's look at the <code class="literal">do while</code> construct in the <code class="literal">save_url()</code> function in a bit more detail. The following is the code:</p><div class="informalexample"><pre class="programlisting">do {
            $url_code = random_string('alnum', 8); 

            $this-&gt;db-&gt;where('url_code = ', $url_code);
            $this-&gt;db-&gt;from('urls');
            $num = $this-&gt;db-&gt;count_all_results();
        } while ($num&gt;= 1);</pre></div><p>We use CodeIgniter's <code class="literal">String</code> helper and its <code class="literal">random_string()</code> function (make sure you include the <code class="literal">String</code> helper using <code class="literal">$this-&gt;load-&gt;helper('string');</code> in your controllers' constructor). The <code class="literal">random_string()</code> function<a id="id62" class="indexterm"/> will create (as the name suggests) a random string of characters that we will use for our unique code.</p><p>In this case, we're asking <code class="literal">random_string()</code> to give us a string of characters made up of numbers and uppercase and lowercase letters; that string should be no more that 8 digits in length.</p><p>We then<a id="id63" class="indexterm"/> look into the database to see if the code <code class="literal">random_string()</code> has made for us already exists. We'll use the <code class="literal">$this-&gt;db-&gt;count_all_results();</code> CodeIgniter function to count up the number of matching results.</p><p>If the unique string already exists, then the number returned by <code class="literal">$this-&gt;db-&gt;count_all_results();</code> will be equal to <code class="literal">1</code> (as it already exists). If this happens, we will loop back to the beginning of the <code class="literal">do while</code> construct and start again by generating a new code.</p><p>We keep doing this until we find a code that does not exist in the database. When we do, we break out of the <code class="literal">do while</code> loop and save that unique code, along with the original URL to the database.</p><p>Now let's look at <code class="literal">fetch_url()</code>. We want to see if there is a record in the database that corresponds to the <code class="literal">$url_code</code> entered by the user (in this case, they have clicked on a URL). The <code class="literal">fetch_url()</code> function<a id="id64" class="indexterm"/> accepts <code class="literal">$url_code</code> as a function argument passed to it by the controller and looks for it in the database. If it is found, the entire record (table row) is returned to the controller; if not, it returns false. The controller handles the false result accordingly (it displays an error).</p></div>
<div class="section" title="Creating views"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec23"/>Creating views</h1></div></div></div><p>We're going<a id="id65" class="indexterm"/> to create two view files in this section, as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/views/create/create.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/views/nav/top_nav.php</code></li></ul></div><p>Don't forget that the navigation file (<code class="literal">views/nav/top_nav.php</code>) is unique to each chapter in this book.</p><div class="section" title="Creating the view file–views/create/create.php"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec14"/>Creating the view file–views/create/create.php</h2></div></div></div><p>The <a id="id66" class="indexterm"/>
<code class="literal">create.php</code> file is the view file that the user creating the <a id="id67" class="indexterm"/>shortened URL will see; it contains the HTML form <a id="id68" class="indexterm"/>the user will enter the original URL into and any interactive elements such as error or success messages.</p><p>Create the <code class="literal">create/create.php</code> view file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">      &lt;div class="page-header"&gt;
        &lt;h1&gt;&lt;?php echo $this-&gt;lang-&gt;line('system_system_name'); ?&gt;&lt;/h1&gt;
      &lt;/div&gt;

      &lt;p&gt;&lt;?php echo $this-&gt;lang-&gt;line('encode_instruction_1'); ?&gt;&lt;/p&gt;

      &lt;?php if (validation_errors()) : ?&gt;
        &lt;?php echo validation_errors(); ?&gt;
      &lt;?php endif ; ?&gt;

      &lt;?php if ($success_fail == 'success') : ?&gt;
        &lt;div class="alert alert-success"&gt;
          &lt;strong&gt;&lt;?php echo $this-&gt;lang-&gt;line('common_form_elements_success_notifty'); ?&gt;&lt;/strong&gt; &lt;?php echo $this-&gt;lang-&gt;line('encode_encode_now_success'); ?&gt; 
        &lt;/div&gt;
      &lt;?php endif ; ?&gt;

      &lt;?php if ($success_fail == 'fail') : ?&gt;
        &lt;div class="alert alert-danger"&gt;
          &lt;strong&gt;&lt;?php echo $this-&gt;lang-&gt;line('common_form_elements_error_notifty'); ?&gt; &lt;/strong&gt; &lt;?php echo $this-&gt;lang-&gt;line('encode_encode_now_error'); ?&gt; 
        &lt;/div&gt;
      &lt;?php endif ; ?&gt;

      &lt;?php echo form_open('create') ; ?&gt;
        &lt;div class="row"&gt;
          &lt;div class="col-lg-12"&gt;
            &lt;div class="input-group"&gt;
              &lt;input type="text" class="form-control" name="url_address" placeholder="&lt;?php echo $this-&gt;lang-&gt;line('encode_type_url_here'); ?&gt;"&gt;
              &lt;span class="input-group-btn"&gt;
                &lt;button class="btn btn-default" type="submit"&gt;&lt;?php echo $this-&gt;lang-&gt;line('encode_encode_now'); ?&gt;&lt;/button&gt;
              &lt;/span&gt;
            &lt;/div&gt;&lt;!-- /input-group --&gt;
          &lt;/div&gt;&lt;!-- /.col-lg-6 --&gt;
        &lt;/div&gt;&lt;!-- /.row --&gt;
      &lt;?php echo form_close() ; ?&gt;

      &lt;br /&gt;

      &lt;?php if ($encoded_url == true) : ?&gt;
        &lt;div class="alert alert-info"&gt;
          &lt;strong&gt;&lt;?php echo $this-&gt;lang-&gt;line('encode_encoded_url'); ?&gt; &lt;/strong&gt; 
          &lt;?php echo anchor($encoded_url, $encoded_url) ; ?&gt;
        &lt;/div&gt;
      &lt;?php endif ; ?&gt;</pre></div></div><div class="section" title="Creating the view file–views/nav/top_nav.php"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec15"/>Creating the view file–views/nav/top_nav.php</h2></div></div></div><p>Each project<a id="id69" class="indexterm"/> in this book has its own navigation bar at the <a id="id70" class="indexterm"/>top of the page. This chapter is no exception although the actual <a id="id71" class="indexterm"/>navigation options for this project<a id="id72" class="indexterm"/> are limited—mostly because the app we're building only really does one thing. So create the <code class="literal">nav/top_nav.php</code> view file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;!-- Fixed navbar --&gt;
&lt;div class="navbarnavbar-inverse navbar-fixed-top" role="navigation"&gt;
&lt;div class="container"&gt;
&lt;div class="navbar-header"&gt;
&lt;button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"&gt;
&lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;
&lt;span class="icon-bar"&gt;&lt;/span&gt;
&lt;span class="icon-bar"&gt;&lt;/span&gt;
&lt;span class="icon-bar"&gt;&lt;/span&gt;
&lt;/button&gt;
&lt;a class="navbar-brand" href="#"&gt;&lt;?php echo $this-&gt;lang-&gt;line('system_system_name'); ?&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;div class="navbar-collapse collapse"&gt;
&lt;ul class="navnavbar-nav"&gt;
&lt;li class="active"&gt;&lt;?php echo anchor('create', 'Create') ; ?&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;&lt;!--/.navbar-collapse --&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;div class="container theme-showcase" role="main"&gt;</pre></div></div></div>
<div class="section" title="Creating controllers"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec24"/>Creating controllers</h1></div></div></div><p>There<a id="id73" class="indexterm"/> are two controllers in this project. The first one <code class="literal">create</code> is responsible for displaying the initial form to the user and validating the input. The second one <code class="literal">go</code> will redirect the user to the original URL.</p><p>Don't forget that the controllers extend the <code class="literal">core/MY_Controller.php</code> file and inherit the helpers loaded there.</p><div class="section" title="Creating the controller file–controllers/create.php"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec16"/>Creating the controller file–controllers/create.php</h2></div></div></div><p>The <code class="literal">create</code> controller in this project is responsible for the initial contact with the user; that is to <a id="id74" class="indexterm"/>say, it loads the view file <code class="literal">views/create.php</code> (that displays the form to the user) and processes the input—validation and more. We'll look at it in a second, but first let's create the controller:</p><p>Create the <a id="id75" class="indexterm"/>controller file <code class="literal">create.php</code> and <a id="id76" class="indexterm"/>add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Create extends MY_Controller {
function __construct() {
        parent::__construct();
            $this-&gt;load-&gt;helper('string');
            $this-&gt;load-&gt;library('form_validation');
            $this-&gt;form_validation-&gt;set_error_delimiters('&lt;div class="alert alert-danger"&gt;', '&lt;/div&gt;');
        }

public function index() {
        $this-&gt;form_validation-&gt;set_rules('url_address', $this-&gt;lang-&gt;line('create_url_address'), 'required|min_length[1]|max_length[1000]|trim');

if ($this-&gt;form_validation-&gt;run() == FALSE) {
            // Set initial values for the view
            $page_data = array('success_fail'   =&gt; null,
                               'encoded_url'    =&gt; false);

            $this-&gt;load-&gt;view('common/header');
            $this-&gt;load-&gt;view('nav/top_nav');
            $this-&gt;load-&gt;view('create/create', $page_data);
            $this-&gt;load-&gt;view('common/footer');
        } else {
            // Begin to build data to be passed to database
            $data = array(
                'url_address' =&gt; $this-&gt;input-&gt;post('url_address'),
            );

            $this-&gt;load-&gt;model('Urls_model');
if ($res = $this-&gt;Urls_model-&gt;save_url($data)) {
                $page_data['success_fail'] = 'success'; 
                $page_data['encoded_url'] = $res; 
            } else {
                // Some sort of error, set to display error message
                $page_data['success_fail'] = 'fail'; 
            }

            // Build link which will be displayed to the user
            $page_data['encoded_url'] = base_url() . '/' . $res;

            $this-&gt;load-&gt;view('common/header');
            $this-&gt;load-&gt;view('nav/top_nav');
            $this-&gt;load-&gt;view('create/create', $page_data);
            $this-&gt;load-&gt;view('common/footer');
        }
    }
}</pre></div><p>So, the <a id="id77" class="indexterm"/>
<code class="literal">create</code> controller does the following things for us:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Form<a id="id78" class="indexterm"/> validation, where it <a id="id79" class="indexterm"/>checks to see if the input is what we expect</li><li class="listitem" style="list-style-type: disc">Packaging up the <code class="literal">url_address</code> ready for the <code class="literal">Urls_model</code></li><li class="listitem" style="list-style-type: disc">Handling any error and success messages</li></ul></div><p>Let's go through the controller by taking a look at what happens when the controller is loaded. As we're using CodeIgniter's form validation processes, you'll be aware that <code class="literal">($this-&gt;form_validation-&gt;run() == FALSE)</code> will trigger the view files to be displayed, as shown here:</p><div class="informalexample"><pre class="programlisting">if ($this-&gt;form_validation-&gt;run() == FALSE) {
     // Set initial values for the view
<span class="strong"><strong>$page_data = array('success_fail'   =&gt; null,</strong></span>
                   <span class="strong"><strong>'encoded_url'    =&gt; false);</strong></span>

     $this-&gt;load-&gt;view('common/header');
     $this-&gt;load-&gt;view('nav/top_nav');
     $this-&gt;load-&gt;view('create/create', <span class="strong"><strong>$page_data</strong></span>);
     $this-&gt;load-&gt;view('common/footer');
} else {
    ...</pre></div><p>Before we display the view files, we set some variable values for the view file <code class="literal">create/create.php</code>. These values govern how the success and error messages are displayed. These <a id="id80" class="indexterm"/>are stored in the <code class="literal">$page_data</code> array (see the bold text in the preceding code).</p><p>Assuming<a id="id81" class="indexterm"/> there were no errors from the<a id="id82" class="indexterm"/> form validation, we grab the <code class="literal">url_address</code> from the post array and package it into an array, as follows:</p><div class="informalexample"><pre class="programlisting">$data = array(
   'url_address' =&gt; $this-&gt;input-&gt;post('url_address'),
);</pre></div><p>We then load the <code class="literal">Urls_model</code> and send the <code class="literal">$data</code> array to the<code class="literal"> save_url()</code>function of <code class="literal">Urls_model</code>:</p><div class="informalexample"><pre class="programlisting">$this-&gt;load-&gt;model('Urls_model');
if ($res = $this-&gt;Urls_model-&gt;save_url($data)) {
  $page_data['success_fail'] = 'success'; 
  $page_data['encoded_url'] = $res; 
} else {
  $page_data['success_fail'] = 'fail'; 
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>I have removed the comments to make it more legible for this explanation.</p></div></div><p>When successful, the model will return the <code class="literal">url_code</code> that we store in <code class="literal">$page_data['encoded_url']</code>.</p><p>This is then passed the <code class="literal">create/create.php</code> view file, which will display a success message to the user and their now shortened URL.</p></div><div class="section" title="Creating the controller file–controllers/go.php"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec17"/>Creating the controller file–controllers/go.php</h2></div></div></div><p>The <code class="literal">go</code> controller<a id="id83" class="indexterm"/> is the other end of the <a id="id84" class="indexterm"/>process. That is to say, the <code class="literal">create.php</code> controller creates the shortened URL and saves it to the database, and the <code class="literal">go.php</code> controller is responsible for taking a URL, finding the <code class="literal">$url_code</code> in the <code class="literal">uri</code> segments, looking in the database to see if it exists, and, if so, redirecting the user to the actual web address associated<a id="id85" class="indexterm"/> with it. Sounds simple, and in truth it is.</p><p>Create the <code class="literal">go.php</code> controller file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Go extends MY_Controller {
function __construct() {
        parent::__construct();
            $this-&gt;load-&gt;helper('string');
        }

public function index() {
if (!$this-&gt;uri-&gt;segment(1)) {
redirect (base_url());
        } else {
            $url_code = $this-&gt;uri-&gt;segment(1);
            $this-&gt;load-&gt;model('Urls_model');
            $query = $this-&gt;Urls_model-&gt;fetch_url($url_code);

if ($query-&gt;num_rows() == 1) {
foreach ($query-&gt;result() as $row) {
                    $url_address = $row-&gt;url_address;
                }

redirect (prep_url($url_address));
            } else {
                $page_data = array('success_fail'   =&gt; null,
                                   'encoded_url'    =&gt; false);

                $this-&gt;load-&gt;view('common/header');
                $this-&gt;load-&gt;view('nav/top_nav');
                $this-&gt;load-&gt;view('create/create', $page_data);
                $this-&gt;load-&gt;view('common/footer');
            }
        }
    }
}</pre></div><p>The <code class="literal">go</code> controller really only gets going <span class="emphasis"><em>after</em></span> the following lines:</p><div class="informalexample"><pre class="programlisting">if (!$this-&gt;uri-&gt;segment(1)) {
redirect (base_url());
        } else {
         ...</pre></div><p>The<a id="id86" class="indexterm"/> preceding lines<a id="id87" class="indexterm"/> check to see if there is a 1st segment in the URL. Normally, the first and second segments are taken up by the controller and function name (as the order in<a id="id88" class="indexterm"/> the URL usually goes controller/function/parameter). However, as we want the URL to be short (or at least that's the idea), we're taking our unique code from the first parameter. Think of it as shifting what would normally be in the third parameter to the left. So, two levels higher up means that what was in the third segment is now at the first.</p><p>How do we do this? How do we have a parameter (our unique code) as the 1st parameter instead of the controller name? Where did the controller and function names go and why does it still work when they're removed?</p><p>We alter the <code class="literal">routes.php</code> file, of course; this is explained earlier in this chapter.</p><p>Anyway, let's return to our code. If there is no item in the URL, then there isn't really anything for this controller to do. Thus, we'll redirect the user to the <code class="literal">base_url()</code> function, which <a id="id89" class="indexterm"/>will load the default controller (set as <code class="literal">autoload.php</code>); in this case, the default controller is the <code class="literal">create.php</code> file.</p><p>Now, assuming that there <span class="emphasis"><em>was</em></span> a 1st parameter, we'll move on to the next part of the controller, the bit that works out the <code class="literal">$url_code</code>, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">$url_code = $this-&gt;uri-&gt;segment(1);
$this-&gt;load-&gt;model('Urls_model');
$query = $this-&gt;Urls_model-&gt;fetch_url($url_code);

if ($query-&gt;num_rows() == 1) {
foreach ($query-&gt;result() as $row) {
   $url_address = $row-&gt;url_address;
      }

  redirect (prep_url($url_address));
} else {
  ...</pre></div><p>Take a look at the preceding code. We grab the 1st <code class="literal">uri</code> segment and assign it to the <code class="literal">$url_code</code> variable. We need to check if this code exists in the database, so we load the <code class="literal">Urls_model</code> and call the <code class="literal">fetch_url()</code> function of <code class="literal">Urls_model</code>, passing to it <code class="literal">$url_code</code>.</p><p>The <code class="literal">fetch_url()</code> method<a id="id90" class="indexterm"/> will look in the database for a record corresponding to the value in <code class="literal">$url_code</code>. If nothing is found, it'll return <code class="literal">false,</code> causing the controller to load the <code class="literal">create/create.php</code> view.</p><p>However, if a record is found, <code class="literal">fetch_url()</code> returns the Active Record object. We now loop over the object, picking out the <code class="literal">url_address</code>, and storing it as the local variable <code class="literal">$url_address</code>, as shown here:</p><div class="informalexample"><pre class="programlisting">   foreach ($query-&gt;result() as $row) {
   $url_address = $row-&gt;url_address;
      }</pre></div><p>Now, we have the original URL in the <code class="literal">$url_address</code> variable. We simply pass this directly to the <code class="literal">redirect()</code>CodeIgniter function, which will, as the name suggests, redirect the user to the original URL.</p><p>Notice<a id="id91" class="indexterm"/> the use of the <code class="literal">prep_url()</code> CodeIgniter <a id="id92" class="indexterm"/>function from within the <code class="literal">redirect()</code> function. This can be done as follows:</p><div class="informalexample"><pre class="programlisting">redirect (prep_url($url_address)); </pre></div><p>The <code class="literal">prep_url()</code> function<a id="id93" class="indexterm"/> will ensure that there is <code class="literal">http://</code> at the beginning of the URL, if it does not already have it</p></div></div>
<div class="section" title="Creating the language file"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec25"/>Creating the language file</h1></div></div></div><p>Taking<a id="id94" class="indexterm"/> text out of the HTML or storing text in other files such as controllers can make maintaining applications or adding multiple languages a nightmare. Keeping languages in a separate dedicated file is always a good idea. With that in mind, we will create a language file for this app.</p><p>Create the language file <code class="literal">en_admin_lang.php</code> and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

// General
$lang['system_system_name'] = "URLs a Swinger";

// Encode
$lang['encode_instruction_1']= "Enter a URL in the text box below and we'll shorten it";
$lang['encode_encode_now']= "Shorten Now";
$lang['encode_encode_now_success']= "Your URL was successfully shortened - check it out below";
$lang['encode_encode_now_error']= "We could not shorten your url, see below for why";
$lang['encode_type_url_here']= "Write the URL here";
$lang['create_url_address'] = "Write the URL here";
$lang['encode_encoded_url']= "Hey look at this, your shortenedurl is:";</pre></div></div>
<div class="section" title="Putting it all together"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec26"/>Putting it all together</h1></div></div></div><p>Now that we have made all the amendments to configuration files, created the database, and created all the files necessary for the app to work (controllers, models, views, and so on) let's run through a few scenarios briefly, just to make sure we know how the app functions.</p><div class="section" title="Creating a shortened URL"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec18"/>Creating a shortened URL</h2></div></div></div><p>Let's<a id="id95" class="indexterm"/> consider an example where Lucy visits the URL Shortener app and the <code class="literal">create</code> controller is called by CodeIgniter, displaying the <code class="literal">create/create.php</code> view file. The following is the sequence of events:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Lucy enters a URL in the text input and clicks on <span class="strong"><strong>Shorten Now</strong></span>.</li><li class="listitem">Upon submitting the form, the controller validates the URL. The URL is successfully validated and the validation returns no errors.</li><li class="listitem">The URL entered by Lucy is then sent to the <code class="literal">save_url()</code>function of <code class="literal">Urls_model</code> that creates a unique code. The <code class="literal">save_url()</code> function uses the PHP<a id="id96" class="indexterm"/> construct <code class="literal">do while</code> and an Active Record database query to create a unique code that doesn't already exist in the database.</li><li class="listitem">Once a code has been created that doesn't already exist, it is saved to the database along with a MySQL timestamp.</li><li class="listitem">The app then displays a success message to Lucy, informing her that the URL was saved correctly. It also displays the URL for her to either click on or (more likely) copy-and-paste elsewhere.</li></ol></div></div><div class="section" title="Retrieving a URL"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec19"/>Retrieving a URL</h2></div></div></div><p>Let's consider<a id="id97" class="indexterm"/> an example where Jessica receives an e-mail from Lucy containing the shortened URL. The following is the sequence of events:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Jessica opens the e-mail and clicks on the URL in that e-mail.</li><li class="listitem">Her computer opens a browser and takes her to our app. As the <code class="literal">create</code> controller is not the 1st <code class="literal">uri</code> segment, the <code class="literal">go</code> controller is run (we set this in the <code class="literal">routes.php</code> file).</li><li class="listitem">The <code class="literal">go</code> controller<a id="id98" class="indexterm"/> loads the <code class="literal">Urls_model,</code> passing it the <code class="literal">url_code</code> (that was in the first segment of <code class="literal">uri</code>). The <code class="literal">fetch_url()</code> function of <code class="literal">Urls_model</code> looks in the database for the code and, if found, it returns the actual web address associated with that code to the <code class="literal">go</code> controller.</li><li class="listitem">The <code class="literal">go</code> controller redirects the browser to the URL supplied by the model.</li><li class="listitem">Jessica is happy as she can look at the cute cat video Lucy sent her! Awww!</li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec27"/>Summary</h1></div></div></div><p>So there you are! We've got ourselves a fairly good URL shortener application. It's certainly not feature-rich or the most advanced, but it works and is ready to be expanded upon should you wish. Perhaps you could add user accounts or payment for advanced features?</p><p>It currently uses Twitter Bootstrap for the frontend so it probably could do with an individual face-lift, a different style, look and feel, but it's currently user-friendly and responsive to mobile devices.</p><p>In the next chapter, we will create a discussion forum, allowing someone to create a discussion and then letting people comment and reply.</p><p>A simple admin moderation system will be provided to help prevent any untoward shenanigans such as naked pictures of celebrities or signals intelligence being posted up, or something like that—unless of course you're into that sort of thing, in which case I hear that the Ecuadorian embassy in London do a terribly good lunch; you might get fed up of it after a few months, though!</p></div></body></html>