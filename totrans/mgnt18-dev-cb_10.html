<html><head></head><body><div class="chapter" title="Chapter&#xA0;10.&#xA0;Creating a Product Slider Widget"><div class="titlepage"><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Creating a Product Slider Widget</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating an empty module</li><li class="listitem" style="list-style-type: disc">Registering helpers and blocks</li><li class="listitem" style="list-style-type: disc">Creating a widget configuration file</li><li class="listitem" style="list-style-type: disc">Creating a block and the template files</li><li class="listitem" style="list-style-type: disc">Creating a custom configuration parameter</li><li class="listitem" style="list-style-type: disc">Finalizing the theming</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec71"/>Introduction</h1></div></div></div><p>Magento widgets <a id="id492" class="indexterm"/>are graphical interfaces to configure blocks in the frontend. For every widget, there is a configuration page available where you can set the required values for that widget.</p><p>When the configuration is done, you can configure the layout instructions to show the widget at several places in the frontend.</p><p>In this recipe, we will create a new module where we will create our own widget. We will create a product slider with the products of a category that we can configure in the widget.</p><p>When we have performed the required configuration for the widget, we will finish the representation in the frontend. We will create a product list that we will style with a jQuery slider script.</p></div></div>
<div class="section" title="Creating an empty module"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec72"/>Creating an empty module</h1></div></div></div><p>As we did in the previous chapter and fully explained in <a class="link" href="ch04.html" title="Chapter 4. Creating a Module">Chapter 4</a>, <span class="emphasis"><em>Creating a Module</em></span>, we will create the required files to create an empty module that we will extend with widget configurations in further chapters.</p><p>We will start with an <a id="id493" class="indexterm"/>empty Magento module that we will create in this recipe. We will create all the required files to initialize a new module that can be used for the creation of a widget.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec181"/>Getting ready</h2></div></div></div><p>Open your code editor and prepare yourselves to create a new module called <code class="literal">Packt_Productslider</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec182"/>How to do it...</h2></div></div></div><p>When you perform the <a id="id494" class="indexterm"/>following steps, you will create an empty <code class="literal">Packt_Productslider</code> module:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the following folders for the module:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">app/code/local/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">app/code/local/Packt/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">app/code/local/Packt/Productslider/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">app/code/local/Packt/Productslider/etc</code></li></ul></div></li><li class="listitem">Create the module file <code class="literal">Packt_Productslider.xml</code> in the <code class="literal">modules</code> folder under <code class="literal">app/etc</code>.</li><li class="listitem">Paste the following code into it:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;config&gt;
  &lt;modules&gt;
    &lt;Packt_Productslider&gt;
      &lt;active&gt;true&lt;/active&gt;
      &lt;codePool&gt;local&lt;/codePool&gt;
      &lt;depends&gt;
        &lt;Mage_Widget /&gt;
      &lt;/depends&gt;
    &lt;/Packt_Productslider&gt;
  &lt;/modules&gt;
&lt;/config&gt;</pre></div></li><li class="listitem">Create the configuration file for the module. This is the <code class="literal">config.xml</code> file that is located in the <code class="literal">etc</code> folder under <code class="literal">app/code/local/Packt/Productslider</code>.</li><li class="listitem">Add the following content to the file:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;config&gt;
  &lt;modules&gt;
    &lt;Packt_Productslider&gt;
      &lt;version&gt;0.0.1&lt;/version&gt;
    &lt;/Packt_Productslider&gt;
  &lt;/modules&gt;
&lt;/config&gt;</pre></div></li><li class="listitem">Clear the cache and check whether the module is installed. You can do this by navigating to the configuration page, <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Advanced</strong></span> | <span class="strong"><strong>Advanced</strong></span>, and <a id="id495" class="indexterm"/>checking whether the module is on the list. Alternatively, you can run the command <code class="literal">wiz module-list</code> in the command line.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec183"/>How it works...</h2></div></div></div><p>We just created a new module with the name <code class="literal">Packt_Productslider</code>. This module is a custom module, so we configured it in the local code pool.</p><p>Practically, this module does nothing, but we will extend it in the next recipes.</p></div></div>
<div class="section" title="Registering helpers and blocks"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec73"/>Registering helpers and blocks</h1></div></div></div><p>The widget module we will create uses a custom block. For translating strings in the block and in different configurations, we need to configure a helper class.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec184"/>Getting ready</h2></div></div></div><p>We will initialize blocks and helpers, and we will create the default helper for our module, just like we did in <a class="link" href="ch04.html" title="Chapter 4. Creating a Module">Chapter 4</a>, <span class="emphasis"><em>Creating a Module</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec185"/>How to do it...</h2></div></div></div><p>The following steps <a id="id496" class="indexterm"/>describe how to configure helpers and<a id="id497" class="indexterm"/> blocks for a new module.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the following folders:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">app/code/local/Packt/Productslider/Block</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">app/code/local/Packt/Productslider/Helper</code></li></ul></div></li><li class="listitem">In the <code class="literal">config.xml</code> file of the module, add the following configuration under the <code class="literal">&lt;config&gt;</code> tag:<div class="informalexample"><pre class="programlisting">&lt;global&gt;
  &lt;blocks&gt;
    &lt;productslider&gt;
      &lt;class&gt;Packt_Productslider_Block&lt;/class&gt;
    &lt;/productslider&gt;
  &lt;/blocks&gt;
  &lt;helpers&gt;
    &lt;productslider&gt;
      &lt;class&gt;Packt_Productslider_Helper&lt;/class&gt;
    &lt;/productslider&gt;
  &lt;/helpers&gt;
&lt;/global&gt;</pre></div></li><li class="listitem">Create the <code class="literal">Data.php</code> file under <code class="literal">app/code/local/Packt/Productslider/Helper</code> and paste the following content into it:<div class="informalexample"><pre class="programlisting">&lt;?php
class Packt_Productslider_Helper_Data extends Mage_Core_Helper_Abstract
{
    
}</pre></div></li><li class="listitem">Clear the cache, and your <a id="id498" class="indexterm"/>blocks and helpers will be registered.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec186"/>How it works...</h2></div></div></div><p>In the previous code, we initialized <a id="id499" class="indexterm"/>blocks and helpers with the name <code class="literal">productslider</code>. With this configuration, it is possible to use block names such as <code class="literal">productslider/block_name</code>.</p><p>The helpers are also registered under the name <code class="literal">productslider</code>. We created a default helper, which we can call with the function <code class="literal">Mage::helper('productslider')</code>.</p></div></div>
<div class="section" title="Creating a widget configuration file"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec74"/>Creating a widget configuration file</h1></div></div></div><p>In this recipe, we will configure a new widget type. We have to create a new configuration file where we will initialize the following things for the widget type:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Name of <a id="id500" class="indexterm"/>the widget (in the backend)</li><li class="listitem" style="list-style-type: disc">Widget configuration parameters</li><li class="listitem" style="list-style-type: disc">Widget block type</li><li class="listitem" style="list-style-type: disc">Widget templates (<code class="literal">.phtml</code> files)</li></ul></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec187"/>Getting ready</h2></div></div></div><p>To test the widget<a id="id501" class="indexterm"/> configuration, we can navigate to the <span class="strong"><strong>Widgets</strong></span> page under <span class="strong"><strong>CMS</strong></span> in the backend to manage the widget instances.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec188"/>How to do it...</h2></div></div></div><p>Perform the following steps to<a id="id502" class="indexterm"/> create a <code class="literal">widget.xml</code> configuration file.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the file <code class="literal">app/code/local/Packt/Productslider/etc/widget.xml</code>.</li><li class="listitem">Add the following code to this file:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;widgets&gt;
  &lt;category_product_slider type="catalog/product_list"&gt;
    &lt;name&gt;Category product slider&lt;/name&gt;
    &lt;description&gt;Displays the products for a given category
    in a slider widget&lt;/description&gt;
  &lt;/category_product_slider&gt;
&lt;/widgets&gt;</pre></div></li><li class="listitem">Clear your cache and check whether the configuration works.</li><li class="listitem">At the backend, navigate to <span class="strong"><strong>CMS</strong></span> | <span class="strong"><strong>Widgets</strong></span>, click on the <span class="strong"><strong>Add New Widget Instance</strong></span> button<a id="id503" class="indexterm"/>, and confirm that the widget is in the list, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_10_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Configure the widget for your frontend theme and go to the next page.</li><li class="listitem">You are now on the widget configuration page. In the <span class="strong"><strong>Widget Options</strong></span> tab, we will create our<a id="id504" class="indexterm"/> own widget parameters.</li><li class="listitem">To create a title field that we will use in the block, we have to create a <code class="literal">parameters</code> tag as shown in the following code. Paste this under the <code class="literal">&lt;category_product_slider&gt;</code> tag.<div class="informalexample"><pre class="programlisting">&lt;parameters&gt;
    &lt;title&gt;
        &lt;label&gt;Title (frontend)&lt;/label&gt;
        &lt;type&gt;text&lt;/type&gt;
        &lt;required&gt;1&lt;/required&gt;
        &lt;visible&gt;1&lt;/visible&gt;
    &lt;/title&gt;
&lt;/parameters&gt;</pre></div></li><li class="listitem">Clear the cache, reload the backend page, and go to the <span class="strong"><strong>Widget Options</strong></span> tab<a id="id505" class="indexterm"/>. You will see that there is a title field available, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_10_02.jpg" alt="How to do it..."/></div></li><li class="listitem">To show all the products of a category, we have to create a configuration where we can select a <a id="id506" class="indexterm"/>category. We will create a text field where we can paste the right category ID. To configure the field, add the following code under the <code class="literal">&lt;parameters&gt;</code> tag<a id="id507" class="indexterm"/>:<div class="informalexample"><pre class="programlisting">&lt;category_id&gt;
  &lt;label&gt;Category ID&lt;/label&gt;
  &lt;type&gt;text&lt;/type&gt;
  &lt;required&gt;1&lt;/required&gt;
  &lt;sort_order&gt;20&lt;/sort_order&gt;
  &lt;visible&gt;1&lt;/visible&gt;
&lt;/category_id&gt;</pre></div></li><li class="listitem">Clear the cache and reload the page again. You will see that a second textbox is added to the configuration form.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec189"/>How it works...</h2></div></div></div><p>The <code class="literal">widget.xml</code> file is used to define widgets in the Magento installation. All widget types in Magento are defined under the <code class="literal">&lt;widgets&gt;</code> configuration tag.</p><p>Under this tag, we defined a new widget called <code class="literal">category_product_slider</code>. In this tag, we used the <code class="literal">type</code>
<a id="id508" class="indexterm"/> attribute to define the <code class="literal">Block</code> class that the widget will refer to. In this case, it is <code class="literal">catalog/product_list</code>. This is the block that is used to render the category product list or the grid.</p><p>Under the<a id="id509" class="indexterm"/> <code class="literal">&lt;category_product_slider&gt;</code> tag, we have used the following configuration tags:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">name</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">description</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">parameters</code></li></ul></div><p>The <code class="literal">name</code> tag<a id="id510" class="indexterm"/> is used for the widget type name that is used in the dropdown when creating a widget.</p><p>The <code class="literal">description</code> tag<a id="id511" class="indexterm"/> is for information. It is not shown in the frontend or backend. It is only used for providing information for the widget.</p><p>In the <code class="literal">parameters</code> tag<a id="id512" class="indexterm"/>, we <a id="id513" class="indexterm"/>define the configuration parameters for the widget. In our case, these are <code class="literal">name</code> and <code class="literal">category_id</code>.</p><p>Our fields are just text fields, but we can also make use of other input fields such as dropdowns and checkboxes. When working with dropdown or multiselect fields, we can define a source model with the <code class="literal">&lt;source_model&gt;</code> tag.</p></div></div>
<div class="section" title="Creating a block and the template files"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec75"/>Creating a block and the template files</h1></div></div></div><p>In the previous chapters, we learned how we can configure the widget. Now it is time to show the widget.</p><p>We will create a<a id="id514" class="indexterm"/> custom block where we will write a query that returns the products for the given category, and we will set up a configuration to use two template files on the widget configuration page.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec190"/>Getting ready</h2></div></div></div><p>We will work further to create our own widget instance. Open the <code class="literal">widget.xml</code> file that we created in the previous recipe.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec191"/>How to do it...</h2></div></div></div><p>The following steps<a id="id515" class="indexterm"/> describe how we configure a custom block with custom templates for the widget instance.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we will create a block class that extends the <code class="literal">Mage_Catalog_Block_Product_List</code> class<a id="id516" class="indexterm"/>. We do this because the behavior of that class is what we need for our widget.</li><li class="listitem">Create the <code class="literal">List.php</code> file under <code class="literal">app/code/local/Packt/Productslider/Block/Catalog/Product</code>.</li><li class="listitem">Add the following content to that file to initialize the class and the functions that we will configure:<div class="informalexample"><pre class="programlisting">&lt;?php
class Packt_Productslider_Block_Catalog_Product_List
extends Mage_Catalog_Block_Product_List
implements Mage_Widget_Block_Interface
{
  protected function _beforeToHtml()
  {
    parent::_beforeToHtml();
  }
  
  protected function _prepareLayout()
  {
    parent::_prepareLayout();
  }
}</pre></div></li><li class="listitem">Configure the block that uses the class we previously created. We do this by changing the <code class="literal">type</code> attribute in the <code class="literal">&lt;category_product_slider&gt;</code> tag. Change the attribute to <code class="literal">productslider/catalog_product_list</code>.</li><li class="listitem">When the block class<a id="id517" class="indexterm"/> is created, it is time to create templates for the block. In this widget, we will use two templates. The first template comprises the image, title, and price of the<a id="id518" class="indexterm"/> products. The second template only shows the image and the <span class="strong"><strong>Add To Cart</strong></span> button<a id="id519" class="indexterm"/>.</li><li class="listitem">Create the templates in the<code class="literal"> category-product-slider</code> folder under <code class="literal">app/design/frontend/base/default/template/productslider</code>.</li><li class="listitem">Create the folder and add the following files to this folder:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">list.phtml</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">teaser.phtml</code></li></ul></div></li><li class="listitem">In the <code class="literal">list.phtml</code> file, add the following content:<div class="informalexample"><pre class="programlisting">&lt;div class="block"&gt;
  &lt;div class="block-title"&gt;
    &lt;h2&gt;&lt;?php echo $this-&gt;getTitle() ?&gt;&lt;/h2&gt;
  &lt;/div&gt;
  &lt;div class="block-content"&gt;
    &lt;p&gt;Test of the list.phtml template&lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">In the <code class="literal">teaser.phtml</code> file, add the following content:<div class="informalexample"><pre class="programlisting">&lt;div class="block"&gt;
  &lt;div class="block-title"&gt;
    &lt;h2&gt;&lt;?php echo $this-&gt;getTitle() ?&gt;&lt;/h2&gt;
  &lt;/div&gt;
  &lt;div class="block-content"&gt;
    &lt;p&gt;Teasers template&lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Configure the widget configuration page so that you can choose your template. We can do this by adding the following as a child of the <code class="literal">&lt;parameters&gt;</code> tag:<div class="informalexample"><pre class="programlisting">&lt;template&gt;
  &lt;label&gt;Frontend template&lt;/label&gt;
  &lt;type&gt;select&lt;/type&gt;
  &lt;values&gt;
    &lt;list translate="label"&gt;
      &lt;value&gt;productslider/category-product-
      slider/list.phtml&lt;/value&gt;
      &lt;label&gt;List template&lt;/label&gt;
    &lt;/list&gt;
    &lt;teaser translate="label"&gt;
      &lt;value&gt;productslider/category-product-
      slider/teaser.phtml&lt;/value&gt;
      &lt;label&gt;Teaser template&lt;/label&gt;
    &lt;/teaser&gt;
  &lt;/values&gt;
  &lt;sort_order&gt;30&lt;/sort_order&gt;
  &lt;visible&gt;1&lt;/visible&gt;
&lt;/template&gt;</pre></div></li><li class="listitem">Clear the cache and go to the widget configuration page. When you click on <span class="strong"><strong>Add Layout Update</strong></span>, you can<a id="id520" class="indexterm"/> select the page where the widget will<a id="id521" class="indexterm"/> display. The last dropdown is the template you can use for the widget, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_10_03.jpg" alt="How to do it..."/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip37"/>Tip</h3><p>Make sure you choose the right theme to configure the widget. We will use the default / default theme to configure the widget, so make sure your shop is using the same theme.</p></div></div></li><li class="listitem">Complete the form to <a id="id522" class="indexterm"/>place a widget instance on the home page.</li><li class="listitem">When you clear<a id="id523" class="indexterm"/> the cache, the widget will appear on the home page with the content of the chosen template file.</li><li class="listitem">When you enable developer hints, you will see that our previously created custom block is used as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_10_04.jpg" alt="How to do it..."/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip38"/>Tip</h3><p>You can <a id="id524" class="indexterm"/>enable developer hints in the backend by navigating to the<span class="strong"><strong> </strong></span><a id="id525" class="indexterm"/>
<span class="strong"><strong>Developer</strong></span> page under <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Advanced</strong></span> in the <span class="strong"><strong>Debug</strong></span> section. Be sure to configure it on the website or store a view scope.</p><p>You can also run the wiz command <code class="literal">wiz devel-showhints yes</code> to enable the hints.</p></div></div></li><li class="listitem">The last thing we<a id="id526" class="indexterm"/> will do is to create a loop that shows the name of the products. Add the following code to the <code class="literal">list.phtml</code> file:<div class="informalexample"><pre class="programlisting">&lt;?php $_productCollection = $this-&gt;getLoadedProductCollection() ?&gt;
&lt;div class="block"&gt;
  &lt;div class="block-title"&gt;
    &lt;h2&gt;&lt;?php echo $this-&gt;getTitle() ?&gt;&lt;/h2&gt;
  &lt;/div&gt;
  &lt;div class="block-content"&gt;
    &lt;p&gt;&lt;?php echo $this-&gt;__('Category ID: %s',
    $this-&gt;getCategoryId()) ?&gt;&lt;/p&gt;
    &lt;ul&gt;
    &lt;?php foreach ($_productCollection as $_product): ?&gt;
    &lt;li&gt;&lt;?php echo $_product-&gt;getName() ?&gt;&lt;/li&gt;
    &lt;?php endforeach; ?&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Configure the widget to use the right template and a valid category ID. After that, reload the<a id="id527" class="indexterm"/> frontend, and you will see something like the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_10_05.jpg" alt="How to do it..."/></div></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip39"/>Tip</h3><p>You can find the<a id="id528" class="indexterm"/> category ID while navigating to a category in the backend. Navigate to <span class="strong"><strong>Catalog</strong></span> | <span class="strong"><strong>Manage Categories</strong></span>, select any category, and you will see the ID near the name.</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec192"/>How it works...</h2></div></div></div><p>We created a custom block class for the widget. By configuring the <code class="literal">type</code> attribute of the widget, all instances of this widget will use a block of the type <code class="literal">productslider/catalog_product_list</code>.</p><p>When we have a look at this class, we see that the class will extend the <code class="literal">Mage_Catalog_Block_Product_List</code> class,<a id="id529" class="indexterm"/> which is the block that is used to render product lists for a category. We use this class so we can use the standard functions instead of writing our own.</p><p>The next thing we did was to make it possible to choose two templates for the widgets. This is done by configuring the <code class="literal">&lt;template&gt;</code> parameter on the widget.</p><p>The template is configured in the <span class="strong"><strong>Layout Update</strong></span> section of the widget configuration page. This form is a graphical implementation of the layout XML configuration in the template files.</p><p>When we save the widget, Magento will create a layout update in the database for the widget. This layout update is stored in the table <code class="literal">core_layout_update</code>.</p><p>When we look at the<a id="id530" class="indexterm"/> template file, we see the <code class="literal">$this-&gt;getTitle()</code> function is<a id="id531" class="indexterm"/> used to fill the title tag of the block. This function will output the data that is set for the <code class="literal">title</code> parameter on the block.</p><p>In the configuration, we created a <code class="literal">&lt;title&gt;</code> configuration which will do a <code class="literal">setData('title')</code> on the background when the block is created.</p><p>The second<a id="id532" class="indexterm"/> configuration parameter is the <code class="literal">&lt;category_id&gt;</code> field. When the category ID is set on this block, the <code class="literal">$this-&gt;getLoadedProductCollection()</code> function<a id="id533" class="indexterm"/> will return the products of the given category ID, which is just the thing we need for this case.</p></div></div>
<div class="section" title="Creating a custom configuration parameter"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec76"/>Creating a custom configuration parameter</h1></div></div></div><p>The widget is created. It shows up in the frontend and the right products are shown for the given category ID.</p><p>To configure the category ID, we have to copy it from the category page and paste it in the textbox. For better usability, we will create a custom widget in the configuration field where we can select a category from a pop-up window.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec193"/>Getting ready</h2></div></div></div><p>To prepare yourselves, look at how <a id="id534" class="indexterm"/>you can configure the category for the <span class="strong"><strong>Catalog Category Link</strong></span> widget in the backend. We will configure the same pop-up window for the widget that we created in previous recipes.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec194"/>How to do it...</h2></div></div></div><p>Perform the following steps to<a id="id535" class="indexterm"/> and you can create a custom configuration parameter:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">When we look at the <span class="strong"><strong>Catalog Category Link</strong></span> widget<a id="id536" class="indexterm"/>, we see that they use a custom widget to select the category—we will do the same for our module.</li><li class="listitem">In the <code class="literal">widget.xml</code> file, replace the <code class="literal">&lt;category_id&gt;</code> configuration parameter with the following code:<div class="informalexample"><pre class="programlisting">&lt;category_id&gt;
  &lt;label&gt;Category&lt;/label&gt;
  &lt;type&gt;label&lt;/type&gt;
  &lt;helper_block&gt;
    
&lt;type&gt;adminhtml/catalog_category_widget_chooser&lt;/type&gt;
    &lt;data&gt;
      &lt;button translate="open"&gt;
        &lt;open&gt;Select Category...&lt;/open&gt;
      &lt;/button&gt;
    &lt;/data&gt;
  &lt;/helper_block&gt;
  &lt;required&gt;1&lt;/required&gt;
  &lt;sort_order&gt;20&lt;/sort_order&gt;
  &lt;visible&gt;1&lt;/visible&gt;
&lt;/category_id&gt;</pre></div></li><li class="listitem">Clear the cache <a id="id537" class="indexterm"/>and reload the widget configuration page. You will see something like the following screenshot when you click on the configuration parameter button:<div class="mediaobject"><img src="graphics/3329OS_10_06.jpg" alt="How to do it..."/></div></li><li class="listitem">When you select a category, save the widget, clear the cache, and reload the home page, and you will see that the widget shows the wrong products.</li><li class="listitem">When you inspect the <span class="strong"><strong>Select Category …</strong></span> button<a id="id538" class="indexterm"/> and navigate to the hidden field that is some elements above, you will see that the value is similar to <code class="literal">category/&lt;category_id&gt;</code>.</li><li class="listitem">The widget requires the category ID, that is, the number after the slash. We now have the category path that is used to generate URLs. To fix this problem, we can perform the following:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Get the ID from the path with string functions</li><li class="listitem" style="list-style-type: disc">Make sure a proper ID is set in the widget configuration page</li></ul></div></li><li class="listitem">We will adapt the second method because it is the most stable way.</li><li class="listitem">To fix the issue,<a id="id539" class="indexterm"/> we have to update some code in the category widget chooser that is shown in the widget configuration page. We will create a new class that extends the current widget chooser. We will add the class to the <code class="literal">Widget</code> folder under <code class="literal">app/code/local/Packt/Productslider/Block/Adminhtml/Category</code>.</li><li class="listitem">In this folder, create a file called <code class="literal">Chooser.php</code> with the following content:<div class="informalexample"><pre class="programlisting">&lt;?php
class Packt_Productslider_Block_Adminhtml_Catalog_Category_Widget_Chooser extends Mage_Adminhtml_Block_Catalog_Category_Widget_Chooser
{
    /**
     * Block construction
     * Defines tree template and init tree params
     */
    
  public function prepareElementHtml(Varien_Data_Form_Element_Abstract $element)
  {
    $uniqId = Mage::helper('core')-&gt;uniqHash($element-
    &gt;getId());
    $sourceUrl = $this-&gt;getUrl('adminhtml/
    productslider_catalog_category_widget/chooser',
    array('uniq_id' =&gt; $uniqId, 'use_massaction' =&gt;
    false));

    $chooser = $this-&gt;getLayout()-
    &gt;createBlock('widget/adminhtml_widget_chooser')
      -&gt;setElement($element)
      -&gt;setTranslationHelper($this-&gt;getTranslationHelper())
      -&gt;setConfig($this-&gt;getConfig())
      -&gt;setFieldsetId($this-&gt;getFieldsetId())
      -&gt;setSourceUrl($sourceUrl)
      -&gt;setUniqId($uniqId);

    if ($element-&gt;getValue()) {
      $categoryId = $element-&gt;getValue();
           
      if ($categoryId) {
        $label = Mage::getSingleton('catalog/
        category')-&gt;load($categoryId)-&gt;getName();
        $chooser-&gt;setLabel($label);
      }
    }

    $element-&gt;setData('after_element_html',
    $chooser-&gt;toHtml());
    return $element;
  }
  
  public function getNodeClickListener()
  {
    if ($this-&gt;getData('node_click_listener')) {
      return $this-&gt;getData('node_click_listener');
    }
    if ($this-&gt;getUseMassaction()) {
      $js = '
        function (node, e) {
          if (node.ui.toggleCheck) {
            node.ui.toggleCheck(true);
          }
        }
      ';
    } else {
      $chooserJsObject = $this-&gt;getId();
      $js = '
        function (node, e) {
          '.$chooserJsObject.'.setElementValue
          (node.attributes.id);
          '.$chooserJsObject.'.setElementLabel(node.text);
          '.$chooserJsObject.'.close();
        }
      ';
    }
    return $js;
  }
}</pre></div></li><li class="listitem">In the previous step, we created a new block class to handle the return value of the chosen category.<a id="id540" class="indexterm"/> In this step, we will configure the configuration page to use the new block. In the <code class="literal">widget.xml</code> file of the module, change the tag <code class="literal">parameters/category_id/helper_block/type</code> from <code class="literal">adminhtml/catalog_category_widget_chooser</code> to <code class="literal">productslider/adminhtml_catalog_category_widget_chooser</code>. The <code class="literal">widget.xml</code> file will now appear as follows:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;widgets&gt;
  &lt;category_product_slider
  type="productslider/catalog_product_list"&gt;
    &lt;name&gt;Category product slider&lt;/name&gt;
    &lt;description&gt;Displays the products for a given category
    in a slider widget&lt;/description&gt;
    &lt;parameters&gt;
      &lt;title&gt;
        &lt;label&gt;Title (frontend)&lt;/label&gt;
        &lt;type&gt;text&lt;/type&gt;
        &lt;required&gt;1&lt;/required&gt;
        &lt;sort_order&gt;10&lt;/sort_order&gt;
        &lt;visible&gt;1&lt;/visible&gt;
      &lt;/title&gt;
      &lt;category_id&gt;
        &lt;label&gt;Category&lt;/label&gt;
        &lt;type&gt;label&lt;/type&gt;
        &lt;helper_block&gt;
          &lt;type&gt;productslider/adminhtml_catalog_category_
          widget_chooser&lt;/type&gt;
          &lt;data&gt;
            &lt;button translate="open"&gt;
              &lt;open&gt;Select Category...&lt;/open&gt;
            &lt;/button&gt;
          &lt;/data&gt;
        &lt;/helper_block&gt;
        &lt;required&gt;1&lt;/required&gt;
        &lt;sort_order&gt;20&lt;/sort_order&gt;
        &lt;visible&gt;1&lt;/visible&gt;
      &lt;/category_id&gt;
      &lt;template&gt;
        &lt;label&gt;Frontend template&lt;/label&gt;
        &lt;type&gt;select&lt;/type&gt;
        &lt;values&gt;
          &lt;list translate="label"&gt;
            &lt;value&gt;productslider/category-product-
            slider/list.phtml&lt;/value&gt;
            &lt;label&gt;List template&lt;/label&gt;
          &lt;/list&gt;
          &lt;teaser translate="label"&gt;
            &lt;value&gt;productslider/category-product-
slider/teaser.phtml&lt;/value&gt;
            &lt;label&gt;Teaser template&lt;/label&gt;
          &lt;/teaser&gt;
        &lt;/values&gt;
        &lt;sort_order&gt;30&lt;/sort_order&gt;
        &lt;visible&gt;1&lt;/visible&gt;
      &lt;/template&gt;
    &lt;/parameters&gt;
  &lt;/category_product_slider&gt;
&lt;/widgets&gt;</pre></div></li><li class="listitem">We need a custom controller action to handle the AJAX call of the pop-up window. To initialize admin controllers for the module, add the following code to the <code class="literal">config.xml</code> file<a id="id541" class="indexterm"/> of the module. Paste it as a child of the <code class="literal">&lt;config&gt;</code> tag:<div class="informalexample"><pre class="programlisting">&lt;admin&gt;
  &lt;routers&gt;
    &lt;adminhtml&gt;
      &lt;args&gt;
        &lt;modules&gt;
          &lt;productslider before="Mage_Adminhtml"&gt;
          Packt_Productslider_Adminhtml&lt;/productslider&gt;
        &lt;/modules&gt;
      &lt;/args&gt;
    &lt;/adminhtml&gt;
  &lt;/routers&gt;
&lt;/admin&gt;</pre></div></li><li class="listitem">In the <code class="literal">Category</code> folder under <code class="literal">app/code/local/Packt/Productslider/Adminhtml/Productslider/Catalog</code>, create a <code class="literal">WidgetController.php</code> file with the following content in it:<div class="informalexample"><pre class="programlisting">&lt;?php
require_once('Mage/Adminhtml/controllers/Catalog/Category/WidgetController.php');

class Packt_Productslider_Adminhtml_Productslider_Catalog_Category_WidgetController extends Mage_Adminhtml_Catalog_Category_WidgetController
{
  protected function _getCategoryTreeBlock()
  {
    return $this-&gt;getLayout()-&gt;createBlock('productslider/
    adminhtml_catalog_category_widget_chooser', '', array(
      'id' =&gt; $this-&gt;getRequest()-&gt;getParam('uniq_id'),
      'use_massaction' =&gt; $this-&gt;getRequest()
      -&gt;getParam('use_massaction', false)
    ));
  }
}</pre></div></li><li class="listitem">Clear the cache and<a id="id542" class="indexterm"/> load the configuration page. Select a category in the pop-up window and inspect the hidden field as we did in step 5. You will see that the category ID is set as a number instead of a path.</li><li class="listitem">Save the widget, clear the cache, and reload the home page. You will see that the right products of the configured category are shown.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec195"/>How it works...</h2></div></div></div><p>In this recipe, we created a<a id="id543" class="indexterm"/> custom configuration parameter. We did this for a better user experience.</p><p>First, we configured an existing configuration widget to show a category pop-up window when clicking on the field. This was not so difficult because the only workload is to configure the right settings in the <code class="literal">widget.xml</code> file.</p><p>But this widget was not exactly what we were looking for. The frontend representation was OK, but in the background, a wrongly formatted category ID was returned.</p><p>To solve this, we created a custom configuration field that extends the previous configuration field. We only changed the required things to format the right output.</p><p>Because the widget is working with an AJAX call, we had to create a custom controller that extends the standard one to show the right block. In that controller, we included the relative path of the parent controller because this class is not in the autoloader of Magento.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec196"/>There's more…</h2></div></div></div><p>We configured the widget parameter in this recipe to show how to create a custom HTML output for a configuration field.</p><p>Technically, you can do the most impossible things with a configuration field; however, the only thing you need to know is that you have to set the configuration value in an input field that has<a id="id544" class="indexterm"/> the naming convention: <code class="literal">&lt;input name="parameter[&lt;parameter_name&gt;]" /&gt;</code>.</p><p>Replace the <code class="literal">&lt;parameter_name&gt;</code> tag<a id="id545" class="indexterm"/> with the name of your custom parameter and the form will handle your configuration parameter just as it handles all the others.</p></div></div>
<div class="section" title="Finalizing the theming"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec77"/>Finalizing the theming</h1></div></div></div><p>The widget we made in the frontend does not invite us to buy some products. It is just a list with the names of the products from a category.</p><p>In this recipe, we will finalize the theming of the widget. We will create an HTML output that shows an image, name, and price of the given products.</p><p>With a jQuery plugin, we will convert the HTML output to a slider so we can scroll through the products.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec197"/>Getting ready</h2></div></div></div><p>Search for a good jQuery carousel on the Internet. In this recipe, we will use <a class="ulink" href="http://caroufredsel.dev7studios.com/">http://caroufredsel.dev7studios.com/</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec198"/>How to do it...</h2></div></div></div><p>The following <a id="id546" class="indexterm"/>steps describe the last set of actions to complete the widget:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's generate a good HTML that is usable for the jQuery plugin. Add the following code to the <code class="literal">list.phtml</code> template:<div class="informalexample"><pre class="programlisting">&lt;?php $_productCollection = $this-&gt;getLoadedProductCollection() ?&gt;
&lt;div class="block-image-slider"&gt;
  &lt;div class="block-title"&gt;
    &lt;h2&gt;&lt;?php echo $this-&gt;getTitle() ?&gt;&lt;/h2&gt;
  &lt;/div&gt;
  &lt;div class="productslider-container"&gt;
    &lt;div id="productslider-&lt;?php echo $this-
    &gt;getCategoryId() ?&gt;"&gt;
      &lt;?php foreach ($_productCollection as $_product): ?&gt;
      &lt;div class="slider-item"&gt;
        &lt;a href="&lt;?php echo $_product-&gt;getProductUrl() ?&gt;"
        title="&lt;?php echo $this-&gt;stripTags($this-&gt;
        getImageLabel($_product, 'small_image'), 
        null, true)      ?&gt;" class="carousel-image"&gt;
        &lt;img src="&lt;?php echo $this-&gt;helper('catalog/image')
        -&gt;init($_product,'small_image')-&gt;resize(250); ?&gt;"
        width="250" height="250" alt="&lt;?php echo $this-
        &gt;stripTags($this-&gt;getImageLabel($_product, 
        'small_image'), null, true) ?&gt;" /&gt;&lt;/a&gt;
        &lt;div class="slider-item-content"&gt;
          &lt;p&gt;
            &lt;?php echo $_product-&gt;getName() ?&gt;
          &lt;/p&gt;
          &lt;?php echo $this-&gt;getPriceHtml($_product) ?&gt;
         &lt;/div&gt;
         &lt;/div&gt;
      &lt;?php endforeach; ?&gt;
    &lt;/div&gt;
    &lt;div class="productslider-controls"&gt;
      &lt;a id="btn-prev-&lt;?php echo $this-&gt;getCategoryId() ?&gt;"
      class="btn-prev" href="#"&gt;&amp;lt;&lt;/a&gt;
      &lt;a id="btn-next-&lt;?php echo $this-&gt;getCategoryId() ?&gt;"
      class="btn-next" href="#"&gt;&amp;gt;&lt;/a&gt;
      &lt;div id="pager-&lt;?php echo $this-&gt;getCategoryId() ?&gt;"
      class="pager"&gt;&lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Create a CSS file to set<a id="id547" class="indexterm"/> the required styling. Add a <code class="literal">productslider.css</code> file to the <code class="literal">css</code> folder under <code class="literal">skin/frontend/base/default</code> with the following content:<div class="informalexample"><pre class="programlisting">.productslider-container {width:700px;background-color:#DDD;}

.productslider-container .slider-item {width:250px;padding:20px;margin:20px;background-color:#BBB;float:left;clear:none;}

.productslider-container .productslider-controls {overflow:hidden;}
.productslider-container .productslider-controls .btn-prev {float:left;}
.productslider-container .productslider-controls .btn-next {float:right;}
.productslider-container .productslider-controls .pager {text-align: center;}
.productslider-container .productslider-controls .pager a {margin:0 10px;}</pre></div></li><li class="listitem">Add the CSS file<a id="id548" class="indexterm"/> to the Magento head by adding the following code. With this code, the CSS file is only added when the widget is configured on a page. <code class="literal">app/code/local/Packt/Productslider/Block/Catalog/Product/List.php</code> in the <code class="literal">_prepareLayout()</code> function:<div class="informalexample"><pre class="programlisting">protected function _prepareLayout()
{
  $this-&gt;getLayout()-&gt;getBlock('head')-&gt;addCss('css/productslider.css');

  parent::_prepareLayout();
}</pre></div></li><li class="listitem">Save all the files, clear the cache, and reload the frontend. You will see a styled output that we can use to convert to a slider.</li><li class="listitem">The next step is to add a jQuery carousel script to the product list. We will use the script <a class="ulink" href="http://caroufredsel.dev7studios.com/">http://caroufredsel.dev7studios.com/</a>.</li><li class="listitem">Download the source files, unzip it, and paste the folder and content to the folder <code class="literal">skin/frontend/base/default/js</code>.</li><li class="listitem">Link the CSS and JavaScript files by updating the <code class="literal">_prepareLayout()</code> function in the <code class="literal">app/code/local/Packt/Productslider/Block/Catalog/Product/List.php</code> file. Replace the function with the following code:<div class="informalexample"><pre class="programlisting">protected function _prepareLayout()
{
  $this-&gt;getLayout()-&gt;getBlock('head')-&gt;addCss('css/productslider.css');

  $this-&gt;getLayout()-&gt;getBlock('head')-&gt;addItem('skin_js',
  'js/carouFredSel-6.2.1/jquery.carouFredSel-6.2.1-
  packed.js');

  parent::_prepareLayout();
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip40"/>Tip</h3><p>Make sure jQuery is enabled in your theme. You can find instructions on it in <a class="link" href="ch02.html" title="Chapter 2. Theming">Chapter 2</a>, <span class="emphasis"><em>Theming</em></span>.</p></div></div></li><li class="listitem">The last step is to initialize<a id="id549" class="indexterm"/> the script for the product list element. Add the following JavaScript code at the bottom of the <code class="literal">list.phtml</code> template:<div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript"&gt;

jQuery(document).ready(function(){
  jQuery("#productslider-&lt;?php echo $this-&gt;
  getCategoryId() ?&gt;").carouFredSel({
    width: '100%',
    prev: '#btn-prev-&lt;?php echo $this-&gt;getCategoryId() ?&gt;',
    next: '#btn-next-&lt;?php echo $this-&gt;getCategoryId() ?&gt;',
    pagination: '#pager-&lt;?php echo $this-&gt;
    getCategoryId() ?&gt;'
  });
});
 
&lt;/script&gt;</pre></div></li><li class="listitem">Clear the cache and reload the frontend. You're done and the output will be as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="graphics/3329OS_10_07.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec199"/>How it works...</h2></div></div></div><p>In the initial steps, we created a good HTML output for the template. This output generates a scaled<a id="id550" class="indexterm"/> image, title, and price for every product in the loop.</p><p>To theme the HTML output, we used a CSS file that will only be included when a widget is configured for the given page. The <a id="id551" class="indexterm"/>function <code class="literal">_prepareLayout()</code> is called when all blocks are initialized. In this function, we add a CSS file and later a JavaScript file to the head of the website.</p><p>To show the product slider with animations, we added some JavaScript code that adds the slider to the product list.</p></div></div></body></html>