- en: Chapter 4. Database Architecture, Models, and CLI Applications
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Now that we know the basics of Phalcon's ORM and ODM, we can create the database
    architecture and most of the models needed for our project. We will also create
    some CLI tasks in order to help us work faster. Because there is a large amount
    of code, when referring to some of the parts in [Chapter 1](ch01.html "Chapter 1. Getting
    Started with Phalcon"), *Getting Started with Phalcon*, I will use the abbreviation
    **CSC** (**check source code**).
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: 'We will cover the following topics in the chapter:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: The database architecture
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Models
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: CLI applications
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The database architecture
  id: totrans-6
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The main goal of this book is to learn by example and we are achieving this
    by developing an online news/magazine website. We will assume the following tables
    as mandatory:'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
- en: '`User`'
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`UserGroup`'
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`UserProfile`'
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`Article`'
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`ArticleCategory`'
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`ArticleTranslation`'
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`ArticleCategoryArticle`'
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`Hashtag`'
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`ArticleHashtagArticle`'
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: These are basic tables, and we will add a few more in the later chapters. I
    like to use singular terms as part of the naming convention, but it's a matter
    of choice. To work faster, I recommend tools such as PhpMyAdmin or MySQL Workbench.
    Let's start with the first table.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
- en: The User table
  id: totrans-18
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The `User` table will hold basic information about a user:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-20
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: The `group_id` and `profile_id` fields will have a relation to the `UserGroup`
    and `UserProfile` tables. After we have created these tables, we will also create
    the relations.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
- en: The UserGroup table
  id: totrans-22
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The `UserGroup` table will hold information about user groups, and each user
    will be part of one of the available groups. We are not going to use one-to-many
    relationship between users and groups, but if you need them, feel free to implement
    them:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: The UserProfile table
  id: totrans-25
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '`UserProfile` is useful if you want a profile for the user. We are going to
    hold information about the user''s location and date of birth:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-27
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'For simplicity, the user location field will be free text, not a location based
    on coordinates. Now that we have all the user tables, let''s create the relations/constraints
    between them:'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-29
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Finally, your database structure should look like what is shown in the following
    screenshot:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
- en: '![The UserProfile table](img/B03522_04_01.jpg)'
  id: totrans-31
  prefs: []
  type: TYPE_IMG
- en: Models
  id: totrans-32
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Now that we have the user architecture, before we continue with the rest of
    the database, let's create the models and a simple CLI task to register a new
    user.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
- en: If you have already installed the Phalcon Developer Tools, you can use them
    to generate models, or you can manually create them. You can also find them in
    the source code for this chapter.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  id: totrans-35
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Using the model generator will not create relations between tables. You have
    to manually create them.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
- en: All our models will extend the `Base` models created in the previous chapter.
    Next, I will show you a few lines of code containing the important parts of the
    models, excluding the getters, setters, and protected variables.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: The User model
  id: totrans-38
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The `User` model will be located under the `App\Core\Models` namespace in the
    `apps/Core/Models/` directory:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: The `initialize()` method acts like a constructor, so here we will put most
    of the code that we need to execute when the model is loaded.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
- en: In the preceding example, we created relations between the models in the `initialize()`
    method. We have already talked about relations, but you can always read more on
    the official website at [http://docs.phalconphp.com/en/latest/reference/models.html#relationships-between-models](http://docs.phalconphp.com/en/latest/reference/models.html#relationships-between-models).
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
- en: The model contains two other methods for quick access (`find` and `findFirst`).
    Remember that Phalcon's ORM supports calls using magic methods, for example, if
    you want to find a user by ID, you can use `findFirstById()`; if you want to find
    the first user by e-mail, you can use `findFirstByEmail()`; and so on.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: The `find()` and `findFirst()` methods are automatically created if you generate
    the model using the Phalcon Developer Tools.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
- en: The UserGroup model
  id: totrans-45
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '`UserGroup` will be located under the `App\Core\Models` namespace in the `apps/Core/Models/`
    directory:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: This model has a 1-n relationship with users, which means that when you invoke
    `$group->users`, the command will return the names of all the users assigned to
    the `users` group.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
- en: The UserProfile model
  id: totrans-49
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The `UserProfile` model will be located under the `App\Core\Models` namespace
    in the `apps/Core/Models/` directory:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: The `UserProfile` model has a 1-1 relationship with the user, which means that
    a profile is tightly coupled to a single user.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
- en: 'We''re all set. Let''s take a look at our `modules\Core\Models` directory structure.
    It should look like this:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
- en: '![The UserProfile model](img/B03522_04_02.jpg)'
  id: totrans-54
  prefs: []
  type: TYPE_IMG
- en: '`Article.php` is in the list because we created it in the previous chapter.
    We can now go forward and create a CLI task to register a new user.'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
- en: In general, you develop CLI applications to be used within cron jobs, to create
    utilities, and so on. We are going to develop a few tasks in this book for different
    situations. One of them is for registering a new user via command line.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
- en: Registering a new user
  id: totrans-57
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Create a new directory named `Task` in the `modules\` folder:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Go to the `Task` directory, create a new file named `BaseTask.php`, and append
    the following content to it:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Note
  id: totrans-62
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: I wrote the content of this file a few years ago to "prettify" my command-line
    scripts a bit. If you are not happy with it, please feel free to remove it or
    change it.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, we are going to need a bootstrap for our CLI application, but before
    we do that, we need to install some dependencies. Assuming that you have installed
    Composer ([http://getcomposer.org](http://getcomposer.org)), edit `composer.json`
    and add this content:'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Update Composer by using the following command:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Go back to the `modules\` folder and create a new file named `cli.php`.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
- en: 'We will try to split and explain the contents of the following code:'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-70
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'In these first lines, we include the autoloader generated by Composer and make
    use of Phalcon''s DI and CLI and the `Extractor` helper, which will be needed
    to parse annotation comments for the methods:'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-72
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'The preceding class constructor will set up the DI for us and load the configuration
    files needed to run the tasks. It will also read any argument assigned to a task:'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-74
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'We use the `readTask` method to read the annotation from each task and to list
    the tasks available in our application. By executing `$` `php` `modules/cli.php`
    in your terminal, you will understand the purpose of this method better:'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  id: totrans-76
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'Finally, we need to initialize our newly created class. We do this with the
    help of the next few lines:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: …
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
- en: 'We need to register the new task folder. Open the `config/loader.php` file
    and add this content:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-81
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'We''re now ready to create our first task. Let''s create a test task just to
    be sure that our code is working. Go to the `modules/Task/` folder and create
    a new file named `UserTask.php` with the following content:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Execute the task from your project root folder:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-85
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'You should see something similar to the following screenshot:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
- en: '![Registering a new user](img/B03522_04_03.jpg)'
  id: totrans-87
  prefs: []
  type: TYPE_IMG
- en: So far, we have the database structure and the models for the `user*` tables.
    We also have a working CLI application and a dummy test task. We can move forward
    with the user task.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
- en: Next, we are going to develop a user registration process that can be accessed
    from a CLI. The first thing we need to do is implement a registration method in
    our manager. This manager does not exist yet, but we will create it in `modules/Core/Managers/`,
    where `ArticleManager.php` resides (from the previous chapter).
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
- en: 'Go to `modules/Core/Managers/` and create a new file named `UserManager.php`
    with the following content:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-91
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: Tip
  id: totrans-92
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Note that we are using the security service to hash the user's password. The
    `hash` method uses the bcrypt algorithm.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
- en: 'After this, we need to register the newly created manager. To do this, open
    the service file located at `config/service.php` and add the following content:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-95
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'Now we can implement the user creation task. Open `modules/Task/UserTask.php`
    and append the following content:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'In the first two lines of the `createAction()` method, we just make a simple
    validation of parameters and ask the developer for a confirmation of the input.
    You can now execute the task:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'But you will get an error similar to the one shown in this screenshot:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
- en: '![Registering a new user](img/B03522_04_04.jpg)'
  id: totrans-101
  prefs: []
  type: TYPE_IMG
- en: The `user_created_at` `is` `required` exception is thrown, because in our `create()`
    method from the user manager, we didn't add this field—and we are not going to
    add it. Instead, we are going to use Phalcon's "timestampable" behavior.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
- en: 'Open the `User` model (`modules/Core/Models/User.php`) and add the following
    code to the `initialize()` method:'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  id: totrans-104
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: Note
  id: totrans-105
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Add this behavior to all the models where we are using `*_created_at` and `*_updated_at`.
    Also, don't forget to make use of `use` `\Phalcon\Mvc\Model\Behavior\Timestampable;`.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
- en: 'Now, you can execute the user creation task again. If everything goes OK, you
    should see something similar to the following screenshot:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
- en: '![Registering a new user](img/B03522_04_05.jpg)'
  id: totrans-108
  prefs: []
  type: TYPE_IMG
- en: 'We now have a functional CLI application for a user and a user manager, but
    the user has no profile and no group. We will modify the `create()` method from
    the user manager to be able to assign groups and create a profile. Because the
    `user_group` table is empty, we need to insert some data:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'Here, we created a new group named `User`. This will be the default group.
    Next, we will modify the `create()` method from the user manager to be able to
    assign an existing group to a user. The new `create()` method will look like this:'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  id: totrans-112
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'We also need to create the `findFirstGroupByName()` method. Append the following
    content to the `UserManager.php` file:'
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  id: totrans-114
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: Before we run the `user create` task again, we need to ensure data integrity,
    avoiding duplicate e-mails. Because of the database structure, we are not allowed
    to insert duplicate records (the `email` column is unique), and the `create()`
    method will throw a SQL exception similar to `SQLSTATE[23000]:` `Integrity` `constraint`
    `violation:` `1062` `Duplicate` `entry` `'john.doe@john.tld'` `for` `key` `'idx_email'`.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
- en: 'To avoid this, we will make use of the built-in validators. In this case, we
    will implement two of them: a uniqueness validator and an e-mail validator, both
    for the `user_email` column. We achieve this by adding the following code to the
    user model in the `modules/Core/Models/User.php` file:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Now that we have a validator, we can be sure that an e-mail has the correct
    format and it does exist in our database. Let''s execute the same task to see
    what happens:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  id: totrans-119
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'If you did everything well, you should see a response similar to the one presented
    in the following screenshot:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
- en: '![Registering a new user](img/B03522_04_12.jpg)'
  id: totrans-121
  prefs: []
  type: TYPE_IMG
- en: 'Now, execute the task again by changing the e-mail address and checking whether
    the group ID has been assigned to the new user. Let''s call it `me@me.com`:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  id: totrans-123
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'If you get a response similar to the one shown in the following screenshot,
    it means that you have done a great job!:'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
- en: '![Registering a new user](img/B03522_04_06.jpg)'
  id: totrans-125
  prefs: []
  type: TYPE_IMG
- en: Tip
  id: totrans-126
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: You can read more about validating data integrity at [http://docs.phalconphp.com/en/latest/reference/models.html#validating-data-integrity](http://docs.phalconphp.com/en/latest/reference/models.html#validating-data-integrity).
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
- en: Creating a user profile
  id: totrans-128
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'What we need to do next is repeat almost the same process to create a user
    profile. The final `create()` method in `UserManager.php` should look like this:'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  id: totrans-130
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'To avoid code repetition, we will create a `save()` method in the `BaseManager`
    file. Open `modules/Core/Managers/BaseManager.php` and append the following code:'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  id: totrans-132
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'One last change we need to make is in the `UserTask.php` file. Open it and
    update the `createAction()` method by replacing the `$user` `=` `$manager->create`
    `…` block of code with the following code:'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE32]'
  id: totrans-134
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: 'We can try to execute the task again and test whether the new user has been
    created and a profile has also been created:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE33]'
  id: totrans-136
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'You should see something like this:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating a user profile](img/B03522_04_07.jpg)'
  id: totrans-138
  prefs: []
  type: TYPE_IMG
- en: 'If you check out the records in the database, you should get a profile linked
    to the user, as follows:'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating a user profile](img/B03522_04_08.jpg)'
  id: totrans-140
  prefs: []
  type: TYPE_IMG
- en: 'Remember that when you create or update a record using the ORM, it is not mandatory
    to use the setters. Phalcon has a method named `assign()` that accepts the `key`
    `=>` `value` array, where the key is the column name as defined in the table structure,
    for example, our `create()` method can also look like this:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE34]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'We are ready to go further with this project by creating the rest of our database
    structure. Let''s start with the `Article` table. First, drop the existing table
    from your database, and then create a new one:'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE35]'
  id: totrans-144
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: For simplicity, an article will be assigned to a user through the `article_user_id`
    column.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-146
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: If you want to implement more complex things, such as "blameable" behavior,
    you can read an interesting article here [http://blog.phalconphp.com/post/47652831003/tutorial-creating-a-blameable-behavior-with](http://blog.phalconphp.com/post/47652831003/tutorial-creating-a-blameable-behavior-with).
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
- en: 'As you can see, we eliminated all the text fields from the `article` table.
    This is because we are going to create another table named `article_translation`.
    In this way, we will be able to create multilingual articles/website content.
    The `article_translation` table is as follows:'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE36]'
  id: totrans-149
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'The `article_lang` column will accept the two-letter ISO code for languages
    (ISO 639-1). Any news item, blog, or magazine has two major factors: **categories**
    and **hashtags/keywords**. We are going to create many-to-many relationship between
    articles and categories and between articles and hashtags. First, let''s create
    the tables:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  id: totrans-151
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: '[PRE38]'
  id: totrans-152
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: Tip
  id: totrans-153
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: If you check out the code from incubator ([https://github.com/phalcon/incubator/tree/master/Library/Phalcon/Mvc/Model/Behavior](https://github.com/phalcon/incubator/tree/master/Library/Phalcon/Mvc/Model/Behavior)),
    you will see that there is a nice solution for a nested set, if you ever need
    to implement it.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
- en: 'Because we will use a many-to-many relationship, we need to create an intermediate
    table between articles and categories:'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE39]'
  id: totrans-156
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: Having made these tables, let's create the models and the managers. The Article
    model already exists; remove it and create a new one with the new getters and
    setters. The next code samples will not contain the getters and setters, so you
    have to create them manually or check out the source code for this chapter.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
- en: The Category model
  id: totrans-158
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The `Category` model can be seen with the `modules/Core/Models/Category.php`
    file. The following code contains an important method—`initialize()`. Here, we
    create a relation between models and add certain kinds of behavior for the date
    and time fields:'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE40]'
  id: totrans-160
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: The Category translation model
  id: totrans-161
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The Category translation model makes use of `\Phalcon\Utils\Slug` to generate
    slugs. It uses the `Uniqueness` validator to ensure the uniqueness of the newly
    generated slug. This verification is made by interrogating the database:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE41]'
  id: totrans-163
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: We make use of `\Phalcon\Utils\Slug` to generate slugs for `category`. The same
    applies to the Article translation model.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
- en: The Article translation model
  id: totrans-165
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'This model, like the Category translation model, is validating the slug field
    to be unique and makes use of `\Phalcon\Utils\Slug` to generate a slug. This model
    is defined as follows. We''ll be referencing the model from the `modules/Core/Models/ArticleTranslation.php`
    file:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE42]'
  id: totrans-167
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: The Article model
  id: totrans-168
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The Article model is similar to the Category model, with the difference being
    in the relations and the names of the fields. We''ll be referencing the model
    from the `modules/Core/Models/Article.php` file:'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  id: totrans-170
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: The Article-Category-Article model
  id: totrans-171
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The Article-Category-Article model is an intermediate table and model used
    in a many-to-many relationship between articles and categories. We''ll be referencing
    this model from the `modules/Core/Models/Article.php` file:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: 'The final relations between articles and categories are presented here:'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
- en: '![The Article-Category-Article model](img/B03522_04_09.jpg)'
  id: totrans-175
  prefs: []
  type: TYPE_IMG
- en: We have the models. Now, let's continue by creating the managers and a simple
    task to create an article. The article manager already exists, but we are going
    to change the `create()` method. Before this, we will need to write the category
    manager with a `create()` method and enable it.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
- en: 'Create a file named `CategoryManager.php` in `modules/Core/Managers/` and add
    this content:'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE45]'
  id: totrans-178
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: 'We will also need to register the new manager. Open `config/service.php` and
    add the following code:'
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE46]'
  id: totrans-180
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: 'The `$default_data` array is meant to always remember the structure of the
    input that we need to use. We can test everything now by creating a task. Let''s
    name it the `Article` task. Create the new file in `modules/Tasks/ArticleTask.php`
    and add this code:'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE47]'
  id: totrans-182
  prefs: []
  type: TYPE_PRE
  zh: '[PRE47]'
- en: 'This task will create a new category and generate a slug for it. Execute this
    task:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE48]'
  id: totrans-184
  prefs: []
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'You should see something similar to the following screenshot:'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
- en: '![The Article-Category-Article model](img/B03522_04_10.jpg)'
  id: totrans-186
  prefs: []
  type: TYPE_IMG
- en: 'We have pretty much everything we need to create a new article. Let''s go back
    to our `ArticleManager.php` file and replace the existing `create()` method with
    this one:'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE49]'
  id: totrans-188
  prefs: []
  type: TYPE_PRE
  zh: '[PRE49]'
- en: 'The `createAction()` method from `ArticleTask.php`, which will enable us to
    create the new article, is given as follows:'
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE50]'
  id: totrans-190
  prefs: []
  type: TYPE_PRE
  zh: '[PRE50]'
- en: 'Pay attention to this code:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE51]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE51]'
- en: In this case, I have assigned a user ID that I already have in the database.
    Check your database and add the specific user ID. Normally, this will be the ID
    of the authenticated user.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
- en: 'You can now run the task and you should see something similar to the next screenshot:'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 您现在可以运行任务，应该会看到类似于下一张截图的内容：
- en: '[PRE52]'
  id: totrans-195
  prefs: []
  type: TYPE_PRE
  zh: '[PRE52]'
- en: '![The Article-Category-Article model](img/B03522_04_11.jpg)'
  id: totrans-196
  prefs: []
  type: TYPE_IMG
  zh: '![文章-类别-文章模型](img/B03522_04_11.jpg)'
- en: The newly created article does not have any category assigned to it.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 新创建的文章尚未分配任何类别。
- en: We will close this chapter with a small summary, and you will learn more about
    models when we develop the API module. In the meantime, I recommend that you try
    and develop the `hashtag` and `article_hashtag_article` tables, tasks, and models.
    There is no point in writing about this here, because it's the same thing as we
    did for categories (only the names have been changed). Also, you have it in the
    source code of this chapter.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将用一个小总结来结束这一章，当我们在开发API模块时，您将了解更多关于模型的知识。在此期间，我建议您尝试开发`hashtag`和`article_hashtag_article`表、任务和模型。在这里写关于这一点没有意义，因为这和我们对类别所做的是同一件事（只是名称有所改变）。此外，您可以在本章的源代码中找到它。
- en: Tip
  id: totrans-199
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 小贴士
- en: As always, please spare some time to read the official documentation at [http://docs.phalconphp.com/en/latest/reference/models.html](http://docs.phalconphp.com/en/latest/reference/models.html),
    where you can learn more about working with models.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 和往常一样，请抽出一些时间阅读官方文档，网址为[http://docs.phalconphp.com/en/latest/reference/models.html](http://docs.phalconphp.com/en/latest/reference/models.html)，在那里您可以了解更多关于如何使用模型的信息。
- en: Summary
  id: totrans-201
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, we created the database structure for our project, and you
    learned how to create a CLI application. We created models and managers and saw
    how relations between tables work. You also learned about model behavior ("timestampable"),
    model validations, and the storage of related records.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们为我们的项目创建了数据库结构，您学习了如何创建CLI应用程序。我们创建了模型和管理器，并了解了表之间的关系是如何工作的。您还了解了模型行为（“可时间戳化”）、模型验证以及相关记录的存储。
- en: The next chapter will be about developing an API module, and we will have the
    chance to discover more techniques of working with models, searching for data,
    authenticating users, and much more.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 下一章将介绍开发API模块，我们将有机会发现更多与模型工作、搜索数据、验证用户等相关的技术。
