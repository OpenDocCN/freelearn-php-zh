<html><head></head><body><div class="chapter" title="Chapter&#xA0;11.&#xA0;MongoDB"><div class="titlepage"><div><div><h1 class="title"><a id="ch11"/>Chapter 11. MongoDB</h1></div></div></div><p>In this chapter, we will first compare traditional relational databases with so-called <span class="strong"><strong>NoSQL databases</strong></span> and quickly introduce <span class="strong"><strong>MongoDB</strong></span>, a <span class="strong"><strong>document database</strong></span>. You will learn what it is, how to get and install it, and how to create a database to insert documents. Then, you will learn how to interface with it using PHP as the language.</p><div class="section" title="Relational database management systems"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec76"/>Relational database management systems</h1></div></div></div><p>In <a class="link" href="ch06.html" title="Chapter 6. PHP and MySQL">Chapter 6</a>, <span class="emphasis"><em>PHP and MySQL</em></span>, we introduced the MySQL database and how to interface with it using the PHP language. That was not really the language to talk to the database. We used PHP to compose query strings that are lines of code in another language, native to the database <span class="strong"><strong>SQL</strong></span>. It is <a id="id729" class="indexterm"/>used to query the database, to extract data from it, replace it, or insert it. We mentioned that SQL is one of those very few languages that has been around for many years and is expected to stick around for many more. It is used for many different databases, open source or commercial, small or<a id="id730" class="indexterm"/> large, that we collectively call <span class="strong"><strong>relational database management systems</strong></span> (<span class="strong"><strong>RDBMS</strong></span>).</p><p>A relational database uses tables. The columns represent the type of data stored in it, the rows the data itself. You could have a table with customer data containing fields like <span class="emphasis"><em>name</em></span>, <span class="emphasis"><em>firstname</em></span>, <span class="emphasis"><em>address</em></span>, <span class="emphasis"><em>zipcode</em></span>, <span class="emphasis"><em>city</em></span>, <span class="emphasis"><em>telephone</em></span>, <span class="emphasis"><em>accountnr</em></span>, and so on. All tables contain indexes that can be used in other tables to show how they are related. The values of the indexes themselves should never change. So, if a customer changes the address, the address needs to be changed in the customer table, and only in the customer table, as in all other tables, the customer will be referenced by his or her <code class="literal">customer_id</code>. This is a good thing, but as your data becomes more complex, so will the number of tables.</p><p>My experience with this is that, as soon as a record needs to contain two things of the same kind, like when someone has two addresses, you feel you need to create another table.</p><p>Queries to access data that you need to compose the HTML of a webpage and that is spread across many tables can become quite complex, one INNER JOIN after another. Once the need arises to add a table or to add a column to an existing table, you will also have to change your code.</p><p>It is a common practice in projects that use RDBMS to first define the tables of your database, and then start <a id="id731" class="indexterm"/>writing your code. The definition of your tables is put in a schema or diagram. So, each time a table needs to be added or changed, so does your schema.</p><p>In summary, as your database grows and your data becomes more complex, a lot of overhead can be created: adding tables or columns, writing complex queries, or constantly changing the schema of your database. Wouldn't it be nice to be able to use a different kind of database, where each record contains all the information you need, and nothing else? Yes, it would.</p></div></div>
<div class="section" title="NoSQL databases"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec77"/>NoSQL databases</h1></div></div></div><p>In recent years, several new database technologies emerged that are not RDBMS. Most, if not all of them, tried to solve<a id="id732" class="indexterm"/> a particular problem (instead of wanting to be a generic solution for everybody). They are collectively called NoSQL databases. The NoSQL part can be interpreted<a id="id733" class="indexterm"/> in two ways: <span class="strong"><strong>NO SQL</strong></span>, meaning no query language available, or <span class="strong"><strong>Not Only SQL</strong></span>, meaning<a id="id734" class="indexterm"/> the technology supports more than just SQL. NoSQL databases have become quite popular in web development.</p><p>There are several types. The group of NoSQL databases that is of interest to us are so-called document databases. What is stored in the database are documents. A document in this context is not, let's say, a Word or PDF document, but a JSON object. Document databases provide the ability to query on any field in the document, so they are, for sure, Not Only SQL databases.</p><p>What we are doing here is the reverse of what is going on with RDBMS. Every record, or document, will contain all the information we want in it, and nothing else. If an item needs to be added to a document that was never used before, we simply add it. There is no need to change a schema or a table. If a record now needs two things of the same kind, we do things the JSON way: we use an array instead of a single object.</p><p>Surprisingly enough, those databases perform and scale very well, even with thousands of documents. The NoSQL database we have chosen for our projects, and for this book, is MongoDB. It appears to be the one that has the most features, is the most widely adopted—the <span class="emphasis"><em>New York Times</em></span> uses it!—and scales and performs well.</p></div>
<div class="section" title="MongoDB"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec78"/>MongoDB</h1></div></div></div><p>With MongoDB, we just replace MySQL with a document database that can be a better solution for our projects <a id="id735" class="indexterm"/>and has JSON as the common denominator. MongoDB uses collections and documents. So, that makes it more suitable for, for example, an online bookstore application.</p><p>As a document in MongoDB is a JSON object, to transfer data to it from PHP is as simple as storing the data in a PHP array. No more multiple tables and inner joins required. We will explain how to get to MongoDB, create a database, and add and update documents. We will do so from within a PHP program, as well as the MongoDB shell.</p><div class="section" title="Installing MongoDB"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec124"/>Installing MongoDB</h2></div></div></div><p>Obtaining and installing MongoDB depends on the platform you are using. Go to <a class="ulink" href="http://www.mongodb.org">www.mongodb.org</a> for the software and the documentation. This will get you basically two programs. The<a id="id736" class="indexterm"/> first one is<a id="id737" class="indexterm"/> <span class="strong"><strong>mongod</strong></span> (known as the <span class="strong"><strong>MongoDB daemon</strong></span>), a program that needs to be up and<a id="id738" class="indexterm"/> running all the time, just like a MySQL server would. The second one is simply called <span class="strong"><strong>mongo</strong></span><a id="id739" class="indexterm"/> and it is <span class="strong"><strong>the </strong></span><a id="id740" class="indexterm"/>
<span class="strong"><strong>MongoDB shell</strong></span>. It is a command interpreter that lets you create databases, collections, and documents, and modify them. I like to think of it as<a id="id741" class="indexterm"/> <span class="strong"><strong>phpMyAdmin</strong></span> for MongoDB.</p><p>If you want to access and manipulate your MongoDB database from within a program, you will also need to download and install a driver for MongoDB for the programming language of your choice. So, for PHP, we will need a PHP driver for MongoDB. Drivers can be built from source, but there is also binary available from distributions that change all the time. So, use your favorite search engine and look for a PHP driver for MongoDB. At the time of writing, there was one at <code class="literal">php.net/manual/en/book.mongo.php</code>.</p></div><div class="section" title="The MongoDB shell"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec125"/>The MongoDB shell</h2></div></div></div><p>Once you have all these<a id="id742" class="indexterm"/> things installed, it is time to start filling up a database with documents. In MySQL, we started by first creating all our tables, maybe initially on a piece of paper, and then for real by using phpMyAdmin. In MongoDB, we use the MongoDB shell<a id="id743" class="indexterm"/> to populate our database for the first time. However, there is no need to create tables. We simply add documents. As they say in French: <span class="emphasis"><em>simple comme bonjour</em></span>.</p><p>In order to do so, we make the distinction between databases, collections, and documents. Every instance of MongoDB can contain one or more databases. Although you can do everything with a single database, it is recommended that you use separate databases where appropriate, for example, one for each project.</p><p>Although you could put all your documents into a database, just like that, it is better to organize them as several collections. Compared to RDBMS, documents are the equivalent of<a id="id744" class="indexterm"/> table rows, and collections are the counterpart of tables.</p><p>In the remainder of this section, we will walk you through using the MongoDB shell to do basic <span class="strong"><strong>Create, Read, Update, and Delete</strong></span> (<span class="strong"><strong>CRUD</strong></span>) operations. For more detailed and advanced operations, consult the excellent MongoDB <a id="id745" class="indexterm"/>documentation at <a class="ulink" href="http://mongodb.org">mongodb.org</a> or some of the books available on the subject.</p><p>To start the MongoDB shell, simply type <code class="literal">mongo</code> in the command line. You will see something similar to:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>MongoDB shell version: 2.6.6</strong></span>
<span class="strong"><strong>connecting to: test</strong></span>
<span class="strong"><strong>&gt;</strong></span>
</pre></div><p>You are now talking to the command interpreter, which basically reads JavaScript code. By default, mongoDB will connect to a database called <code class="literal">test</code>. The <code class="literal">&gt;</code> symbol is your command prompt. Just to show that it works, let's promptly change it:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>&gt; prompt="mongoDB "</strong></span>
<span class="strong"><strong>mongoDB</strong></span>
</pre></div><div class="section" title="Creating databases, collections, and documents"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec62"/>Creating databases, collections, and documents</h3></div></div></div><p>We have changed <a id="id746" class="indexterm"/>our command prompt to the string mongoDB. Let's connect to <a id="id747" class="indexterm"/>a different database:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mongoDB   use california</strong></span>
</pre></div><p>You have now switched to a<a id="id748" class="indexterm"/> database called <code class="literal">california</code>. You think I forgot something and I am telling you I did not, I just want to keep the suspense going here. Now, let's add a document to a collection <code class="literal">people</code>. Simply type:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mongoDB db.people.insert( {</strong></span>
<span class="strong"><strong> "name":"Adams",</strong></span>
<span class="strong"><strong> "first":"Ansel",</strong></span>
<span class="strong"><strong> "profession":"photographer",</strong></span>
<span class="strong"><strong> "born":"San Francisco"</strong></span>
<span class="strong"><strong>  });</strong></span>
</pre></div><p>Let's find out whether something really happened here. There is a method to find all the documents in a collection, unsurprisingly, called <code class="literal">find()</code>:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mongoDB db.people.find()</strong></span>

<span class="strong"><strong>{ "_id" : ObjectId("54ad4336227ad31227c3902d"), "name" : "Adams", "first" : "Ansel", "profession" : "photographer", "born" : "San Francisco" }</strong></span>
</pre></div><p>Oh my goodness, we now have created a database called <code class="literal">california</code>, and in it, a collection <code class="literal">people</code>, and inside it, our first document. All of this just happens; if the database or collection does not exist yet, MongoDB will<a id="id749" class="indexterm"/> create them. Unlike in MySQL, there is no need for any SQL to create the database nor table ahead of time or to<a id="id750" class="indexterm"/> specify data types.</p><p>If you type the following<a id="id751" class="indexterm"/> two commands, you will indeed see that they now exist:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mongoDB show dbs</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>california</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>mongoDB show collections</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>people</strong></span>
<span class="strong"><strong>...</strong></span>
</pre></div><p>There is an alternate to find, which gives a nicer output, called <code class="literal">findOne()</code>:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mongoDB db.people.findOne()</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "_id" : ObjectId("54ad4336227ad31227c3902d"),</strong></span>
<span class="strong"><strong>  "name" : "Adams",</strong></span>
<span class="strong"><strong>  "first" : "Ansel",</strong></span>
<span class="strong"><strong>  "profession" : "photographer",</strong></span>
<span class="strong"><strong>  "born" : "San Francisco"</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>Of course, there is only one thing to find, but as the number of documents increases, we want to be more specific, so we could say things like:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mongoDB db.people.findOne({"first" : "Ansel"})</strong></span>
</pre></div><p>This is beginning to look very much like a query, because it is one! You may have noticed a key named <code class="literal">"_id"</code> and a very long value. Let's spend a few lines on this.</p><div class="section" title="_id and ObjectIds"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec20"/>_id and ObjectIds</h4></div></div></div><p>Every document stored in MongoDB<a id="id752" class="indexterm"/> must have an <code class="literal">"_id"</code> key. It can be any type, but it<a id="id753" class="indexterm"/> defaults to <code class="literal">ObjectId</code>. In a single collection, every document must have a unique value for <code class="literal">"_id"</code>, which ensures that every document in a collection can be<a id="id754" class="indexterm"/> uniquely identified. ObjectId use 12 bytes of storage. As stated previously, if there is no <code class="literal">"_id"</code> key present when a document is inserted, one will <a id="id755" class="indexterm"/>be automatically added to the inserted document.</p></div><div class="section" title="Loading scripts"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec21"/>Loading scripts</h4></div></div></div><p>The mongoDB shell interprets <a id="id756" class="indexterm"/>JavaScript and also has built-in functions. Some things <a id="id757" class="indexterm"/>you are used to will not work, such as <code class="literal">alert()</code>, because it is a method of the Windows object, and that is only available when you are running in a browser.</p><p>A very useful function is<a id="id758" class="indexterm"/> <code class="literal">load()</code>. You can prepare all your commands ahead of time and store them in a file. Create a folder for your project, go to it, and store the following, which is very close to one of our JSON examples from the previous chapter, in a file <code class="literal">californiapeople.js</code>:</p><div class="informalexample"><pre class="programlisting">db.people.insert({
    "name":"Adams",
     "first":"Ansel",
     "profession":"photographer",
     "born":"San Francisco"

  });

db.people.insert({  "name":"Muir",
     "first":"John",
     "profession":"naturalist",
     "born":"Scotland"

  });
db.people.insert(   {
    "name":"Schwarzenegger",
     "first":"Arnold",
     "profession":"governator",
     "born":"Germany"

  });
db.people.insert( {
    "name":"Rowell",
     "first":"Galen",
     "profession":"photographer",
     "born":"Oakland CA"

  });
db.people.insert(   {
    "name":"Wellens",
     "first":"Paul",
     "profession":"author",
     "born":"Belgium"

  });</pre></div><p>Then, issue the<a id="id759" class="indexterm"/> following command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mongoDB      load("californiapeople.js")</strong></span>
</pre></div><p>This will insert five more documents into the <code class="literal">people</code> collection. To verify it, type:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mongoDB db.people.find()</strong></span>
</pre></div><p>The result will look similar to this:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>{ "_id" : ObjectId("54ad4336227ad31227c3902d"), "name" : "Adams", "first" : "Ansel", "profession" : "photographer", "born" : "San Francisco" }</strong></span>
<span class="strong"><strong>{ "_id" : ObjectId("54ad46f6812ce43efb530a07"), "name" : "Adams", "first" : "Ansel", "profession" : "photographer", "born" : "San Francisco" }</strong></span>
<span class="strong"><strong>{ "_id" : ObjectId("54ad46f6812ce43efb530a08"), "name" : "Muir", "first" : "John", "profession" : "naturalist", "born" : "Scotland" }</strong></span>
<span class="strong"><strong>{ "_id" : ObjectId("54ad46f6812ce43efb530a09"), "name" : "Schwarzenegger", "first" : "Arnold", "profession" : "governator", "born" : "Germany" }</strong></span>
<span class="strong"><strong>{ "_id" : ObjectId("54ad46f6812ce43efb530a0a"), "name" : "Rowell", "first" : "Galen", "profession" : "photographer", "born" : "Oakland CA" }</strong></span>
<span class="strong"><strong>{ "_id" : ObjectId("54ad46f6812ce43efb530a0b"), "name" : "Wellens", "first" : "Paul", "profession" : "author", "born" : "Belgium" }</strong></span>
</pre></div></div><div class="section" title="Removing documents"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec22"/>Removing documents</h4></div></div></div><p>Notice that there are <a id="id760" class="indexterm"/>now two documents containing <code class="literal">Ansel Adams</code>, clearly distinct by its <code class="literal">"_id"</code>. But, we only need one, so it is time to remove one. This is done using the<a id="id761" class="indexterm"/> <code class="literal">remove()</code> function. Beware, if you do not specify an argument in the following command, all documents in the collection would be removed and once documents are removed, they cannot be restored:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mongoDB db.people.remove( { "_id" : ObjectId("54ad46f6812ce43efb530a07" )} )</strong></span>
</pre></div></div><div class="section" title="Updating documents"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec23"/>Updating documents</h4></div></div></div><p>Our final CRUD operation is update. In this example, we add a key:value pair to the document that has the<a id="id762" class="indexterm"/> information relating to the late nature photographer and rock climber Galen Rowell. In this case, we set a value for the field <code class="literal">"died"</code>.</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>db.people.update ({"name" : "Rowell"}, { "$set": {"died" : "Bishop"}})</strong></span>
</pre></div><p>
<code class="literal">$set</code> is an example of a<a id="id763" class="indexterm"/> <span class="strong"><strong>modifier</strong></span>. It allows us to specify how we want to change the document. In the previous example, the value of the field <code class="literal">"died"</code> would have been updated or created if it did not yet exist.</p><p>Some of the other modifiers are <code class="literal">$unset</code>, to remove a field, <code class="literal">$inc</code> and <code class="literal">$dec</code> to increment and decrement a field, and <code class="literal">$push</code> and <code class="literal">$pull</code> to add an element to an array or remove it:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mongoDB db.people.findOne({"name" : "Rowell"})</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "_id" : ObjectId("54ad46f6812ce43efb530a0a"),</strong></span>
<span class="strong"><strong>  "name" : "Rowell",</strong></span>
<span class="strong"><strong>  "first" : "Galen",</strong></span>
<span class="strong"><strong>  "profession" : "photographer",</strong></span>
<span class="strong"><strong>  "born" : "Oakland CA",</strong></span>
<span class="strong"><strong>  "died" : "Bishop"</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div></div><div class="section" title="MongoDB data types"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec24"/>MongoDB data types</h4></div></div></div><p>In MongoDB, we do not have to specify data types ahead of time. You just use them, and by now, you should have<a id="id764" class="indexterm"/> recognized, from our examples, the same data types that make up a JSON object. However, in MongoDB we have a few extras.</p></div><div class="section" title="Basic data types"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec25"/>Basic data types</h4></div></div></div><p>We can use the same basic<a id="id765" class="indexterm"/> data types as in JSON: <code class="literal">null</code>, <code class="literal">true</code>, <code class="literal">false</code>, <code class="literal">string</code>, <code class="literal">number</code>, and <code class="literal">array</code>.</p></div><div class="section" title="Dates"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec26"/>Dates</h4></div></div></div><p>Dates are always<a id="id766" class="indexterm"/> hard to deal with, not only in life but also in databases. Fortunately, MongoDB supports the JavaScript <code class="literal">Date()</code> class, giving us a data type when using dates. Dates are stored as the number of milliseconds that have elapsed since the epoch and do not contain any information on the time zone. Of course, if you like, you could store the time zone as a separate key:value pair:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>{ "today" : new Date() }</strong></span>
</pre></div><p>In MySQL, the equivalent of the previous code would be to use <code class="literal">NOW()</code>. If you issue a <code class="literal">find()</code> on the document <a id="id767" class="indexterm"/>where you added <code class="literal">"today"</code>, you will see something like:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>"today" : ISODate("2015-01-14T08:37:17.086Z")</strong></span>
</pre></div></div><div class="section" title="Embedded documents"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec27"/>Embedded documents</h4></div></div></div><p>The value of a field in a document <a id="id768" class="indexterm"/>can also be an entire document. We<a id="id769" class="indexterm"/> called these <span class="strong"><strong>embedded documents</strong></span>.</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>{ "key" : { "name":"Schwarzenegger","first":"Arnold",</strong></span>
<span class="strong"><strong>"profession":"governator" } }</strong></span>
</pre></div></div></div><div class="section" title="One more example"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec63"/>One more example</h3></div></div></div><p>Let's finish this section on the MongoDB shell with one more example. Let's take our <code class="literal">practical.json</code> file <a id="id770" class="indexterm"/>from <a class="link" href="ch10.html" title="Chapter 10. XML and JSON">Chapter 10</a>, <span class="emphasis"><em>XML and JSON</em></span>, and the JSON object it contains. By simply surrounding it with <code class="literal">db.junelake.insert()</code>, we can turn it into a MongoDB command:</p><div class="informalexample"><pre class="programlisting">db.junelake.insert ({
  "photocollection": {
    "title": "June Lake",
    "overview": "The June Lake Loop begins  ...",
    "photo": [
      {
        "scaption": "June Lake in the Fall",
        "caption": "June Lake and Carson Peak in the fall",
        "story": "Each time that unfortunate day  ...",
        "smallimg": "imagessmall/junelakefall.jpg",
        "largeimg": "imagespng/junelakeinthefall.png"
      },
      {
        "scaption": "Aspen by Silver Lake",
        "caption": "Aspen trees by Silver Lake",
        "story": "In 1998, I hit the right week of the ...",
        "smallimg": "imagessmall/silverlakeaspenfall98.jpg",
        "largeimg": "imagespng/silverlakeaspenfall98.png"
      },
      {
        "scaption": "Gull Lake in the Fall",
        "caption": "Gull Lake in the Fall - Happy fishermen !",
        "story": "If you take the north shore road around ...",
        "smallimg": "imagessmall/gulllake648.jpg",
        "largeimg": "imageslarge/gulllake648.jpg"
      },
      {
        "scaption": "Silver Lake",
        "caption": "Silver Lake - June Lake Loop",
        "story": "Any time of the year, there ...",
        "smallimg": "imagessmall/silver2.jpg",
        "largeimg": "imagespng/silver2.png"
      }
    ]
  }
});</pre></div><p>Once executed, either by typing it in or storing it in a file first, and then<a id="id771" class="indexterm"/> using the <code class="literal">load()</code> function, we have <a id="id772" class="indexterm"/>now inserted a document into the <code class="literal">junelake</code> collection of our gallery database. We can even access it as a JSON object and walk through it:</p><div class="informalexample"><pre class="programlisting">var json = db.junelake.findOne()

print (json.photocollection.title)
June Lake</pre></div><p>We can use the<a id="id773" class="indexterm"/> <code class="literal">print()</code> function to display those values. We can even go through a loop, as we did in <a class="link" href="ch10.html" title="Chapter 10. XML and JSON">Chapter 10</a>, <span class="emphasis"><em>XML and JSON</em></span>. That is why I picked the name <code class="literal">json</code> as my variable name, where we had <code class="literal">json</code> as the variable that contained what our Ajax call returned:</p><div class="informalexample"><pre class="programlisting">for (var i in json.photocollection.photo) {
print(json.photocollection.photo[i].scaption) }
This will produce the following output:
June Lake in the Fall
Aspen by Silver Lake
Gull Lake in the Fall
Silver Lake</pre></div><p>So, we might as well, now that we can get JSON straight out of our MongoDB database, use the exact same JavaScript code to generate an HTML page of our photo gallery, right? Wrong! Our database resides on a server and is also the server where we execute the MongoDB shell (even if it is on our developer machine, it still has the role of a server).</p><p>In order for that JavaScript code generating our HTML to be useful, it has to be executed on the client and interpreted by a different JavaScript interpreter than the MonoDB shell - the one that we have been using since the beginning of this book: <span class="emphasis"><em>the browser</em></span>.</p><p>To paraphrase a famous line out of a James Bond movie: <span class="emphasis"><em>JSON, how the hell are we going to get this data over here?</em></span> Well, this will have to happen the same way like before. We will use an Ajax call to execute code on the server to extract data from our database, this time a MongoDB database, and then process that data on the client side to generate our HTML.</p><p>Up to this point, the only programming language we know we can use on the server side is PHP, so we need a<a id="id774" class="indexterm"/> way to access our MongoDB database using PHP.</p></div></div><div class="section" title="MongoDB and PHP"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec126"/>MongoDB and PHP</h2></div></div></div><p>We will dive right into it. We finished the previous section by inserting documents into the database containing<a id="id775" class="indexterm"/> the data we need for our photo gallery page. Then<a id="id776" class="indexterm"/> we discovered that we could not use it right away. However, we can, if we have the PHP driver installed and the mongo extension specified in our <code class="literal">php.ini</code> file, we can access our MongoDB database from a PHP program on the server. It can be extremely short.</p><div class="section" title="Getting our gallery data"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec64"/>Getting our gallery data</h3></div></div></div><p>This is all it takes:</p><div class="informalexample"><pre class="programlisting">&lt;?php
 $connection = new Mongo();
 $db = $connection-&gt;gallery;
 $junelake = $db-&gt;junelake;
 $gallery = $junelake-&gt;findone();
 $jsongallery =  json_encode($gallery);
 echo $jsongallery;
?&gt;</pre></div><p>Thanks to the driver, we have access to a<a id="id777" class="indexterm"/> <code class="literal">Mongo()</code> class. On the first line, we make a connection to MongoDB, on the second, we select the database we want to use, and on the third, we <a id="id778" class="indexterm"/>specify the collection we are dealing with.</p><p>Next, we use the<a id="id779" class="indexterm"/> <code class="literal">findone()</code> method, which we recognize from the previous section. As PHP does not know about JSON objects, this is going to return something else: an array. Now, remember that there is<a id="id780" class="indexterm"/> a PHP function that converts an array to JSON: <code class="literal">json_encode()</code>. There it is. Just <code class="literal">echo</code> it for the Ajax call to catch it and do the rest of the job on the client side. Here are the other pieces. I have not repeated the CSS file here.</p><p>This is the HTML file:</p><div class="informalexample"><pre class="programlisting">&lt;!doctype html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
&lt;meta charset="utf-8" /&gt;
&lt;title&gt;June Lake Gallery&lt;/title&gt;
&lt;link href="styles/practical.css" rel="stylesheet" type="text/css" media="screen"/&gt;
&lt;/head&gt;
&lt;script src="./js/jquery-1.10.1.js"&gt;&lt;/script&gt;
&lt;body&gt;
&lt;div id="mysite"&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;script src="./js/practicalmongo.js"&gt;&lt;/script&gt;</pre></div><p>This is the<a id="id781" class="indexterm"/> JavaScript<a id="id782" class="indexterm"/> file:</p><div class="informalexample"><pre class="programlisting">$(document).ready (function () {
$.post( "mongogallery.php", function( json ) {

var html = '&lt;div id="overview"&gt;&lt;h1&gt;' + json.photocollection.title + '&lt;/h1&gt;';
html += '&lt;p&gt;' + json.photocollection.overview + '&lt;/p&gt;&lt;/div&gt;';
html += '&lt;div id="gallery"&gt;';

for (var i in json.photocollection.photo)
{
html += '&lt;div class="storybook"&gt;&lt;div class="smallmat"&gt;&lt;div class="simage"&gt;&lt;a href="';
var scaption = json.photocollection.photo[i].scaption;
var caption = json.photocollection.photo[i].caption;
var largeimg = json.photocollection.photo[i].largeimg;
var smallimg = json.photocollection.photo[i].smallimg;
var story = json.photocollection.photo[i].story;
html += largeimg;
html += '"&gt;&lt;img class="sphoto" src="';
html += smallimg;
html += '" title="';
html +=  caption;
html += '"&gt;&lt;/img&gt;&lt;/a&gt;&lt;/div&gt;&lt;div class="scaption"&gt;';
html +=  scaption;
html += '&lt;/div&gt;&lt;/div&gt;&lt;div class="story"&gt;';
html +=  story;
html +=  '&lt;/div&gt;&lt;/div&gt;';
}
html += '&lt;/div&gt;';
$('#mysite').html(html);
}, "json");
});</pre></div><p>We used the <code class="literal">.post()</code> jQuery method<a id="id783" class="indexterm"/> to execute our PHP script on the server and collect the JSON data. Notice the extra <code class="literal">"json"</code> argument in the <code class="literal">.post()</code> statement. It is very important as it tells the Ajax call to expect the data to be in the JSON format, and to not attempt to process<a id="id784" class="indexterm"/> it as HTML. If you forget this part, strange things will happen, or worse, nothing<a id="id785" class="indexterm"/> at all.</p></div><div class="section" title="CRUD operations with MongoDB and PHP"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec65"/>CRUD operations with MongoDB and PHP</h3></div></div></div><p>We conclude this chapter with an<a id="id786" class="indexterm"/> overview on how to perform some of the basic CRUD operations using PHP and MongoDB.</p><p>As we have mentioned, PHP does not support JSON objects, so we have to use arrays. In the previous example, we<a id="id787" class="indexterm"/> fetched data from the database, so we did not even have to look at the array, we just converted it to JSON. The only disappointing part may be that as we are dealing with a document database that contains JSON objects, we grab data, it shows up as arrays, and we have to convert it back to JSON. That does not appear to be very efficient, but if you already know PHP, it is easy to write.</p><p>We will discuss a JSON all the way (JavaScript all the way too) alternative in the final chapter of this book.</p><div class="section" title="Insert documents"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec28"/>Insert documents</h4></div></div></div><p>Let's add another famous <a id="id788" class="indexterm"/>California person to our <code class="literal">people</code> collection in the <code class="literal">california</code> database. Those of you familiar with Venice Beach know who I am talking about. He is the guy with a turban on rollerblades, skating up and down the boardwalk. He has not changed in 30 years, except that he is now selling T-shirts instead of cassette tapes.</p><p>It is very much the same as the <code class="literal">insert()</code> in the MongoDB shell, except our <span class="emphasis"><em>key:value</em></span> pairs are now <span class="emphasis"><em>key=&gt;value</em></span> pairs as part of an associative array:</p><div class="informalexample"><pre class="programlisting">&lt;?php
 $connection = new Mongo();
 $db = $connection-&gt;california;
 $people = $db-&gt;people;
 $californiadude = array(
'first' =&gt; 'Harry', 'name' =&gt; 'Perry', 'address' =&gt; 'Boardwalk', 'city' =&gt; 'Venice', 'state' =&gt; 'CA','zip' =&gt; '90291', 'song' =&gt; 'Invaders from another Planet'
);
$people-&gt;insert($californiadude);
?&gt;</pre></div></div><div class="section" title="Update documents"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec29"/>Update documents</h4></div></div></div><p>Let's update our document<a id="id789" class="indexterm"/> by adding one more key:value pair:</p><div class="informalexample"><pre class="programlisting">$people-&gt;update(array('name' =&gt; 'Perry'),
array('$set' =&gt; array('vehicle' =&gt; 'rollerblades')));</pre></div><p>So far, we could have used double quotes instead of single quotes in our examples, but for the <code class="literal">$set</code> modifier we can only use single quotes, because, as you know, <code class="literal">$</code> has a special meaning in PHP—without the single quotes, <code class="literal">$set</code> would have been interpreted as a PHP variable.</p></div><div class="section" title="Queries with conditions"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec30"/>Queries with conditions</h4></div></div></div><p>Just as we<a id="id790" class="indexterm"/> did with the shell, we can use the<a id="id791" class="indexterm"/> <code class="literal">findone()</code> function to query a document:</p><div class="informalexample"><pre class="programlisting">$result = $people-&gt;findone(array('name' =&gt; 'Perry'));
print_r($result);  // in case we want to check our insert was succesful.</pre></div><p>Once again, an array is used instead of a key:value pair. But we can make these queries more complex. Several keywords exist that can be use to refine our query. Here is one more example:</p><div class="informalexample"><pre class="programlisting">$result = $people-&gt;findone(array('first' =&gt; 'John' , 'age' =&gt; array ( '$gt' =&gt; 50)));
// look for all people named John that are over 50. This is just an example. Nothing will
// be returned.</pre></div><p>
<code class="literal">findone()</code> only gives us one document back and does so as an associative array, like in our very first example. If we use <code class="literal">find()</code>, the data of several documents is returned. In the shell we had a nice little output, defaulting to the first 20 documents, but, here, using PHP, we will be given what is called a<a id="id792" class="indexterm"/> MongoDB <span class="strong"><strong>cursor</strong></span>.</p></div><div class="section" title="MongoDB cursor object"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec31"/>MongoDB cursor object</h4></div></div></div><p>The MongoDB <code class="literal">db.collection.find()</code> returns all documents as an iterable object, or cursor. In PHP, <code class="literal">find()</code> returns all documents with all their data, which is probably not what you want. But, as <a id="id793" class="indexterm"/>we do not have too much data at this point, here is one way to get it all and walk or iterate through it in PHP:</p><div class="informalexample"><pre class="programlisting">&lt;?php
 $connection = new Mongo();
 $db = $connection-&gt;california;
 $people = $db-&gt;people;
$cursor = $people-&gt;find();
foreach ($cursor as $document)
{
    echo $document['name'];  // we could do more of course
}
?&gt;</pre></div><p>In the example, <code class="literal">$cursor</code> is an object of the MongoDB cursor class. Several methods are available for this class, giving you alternate ways to iterate through your cursor. If you want to turn the cursor into an array, you can<a id="id794" class="indexterm"/> use the <code class="literal">iterator_to_array()</code> function.</p><p>In the example, we iterate through <code class="literal">$cursor</code> using a <code class="literal">foreach()</code> loop, giving us access to each document as an array to do with it whatever we want. What we did was <code class="literal">echo</code> the name.</p><p>To conclude, we'll show you how to refine our query. Imagine you want to perform the same query, which in SQL would look like:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>SELECT first, last FROM people WHERE age &gt; 50 LIMIT 10;</strong></span>
</pre></div><p>In MongoDB PHP lingo, this would be:</p><div class="informalexample"><pre class="programlisting">$cursor =          // the variable that will contain the cursor we can iterate through
$people-&gt;find(  // our collection, equivalent to a table
array('age' =&gt; array ('$gt '=&gt; 50 ),  // criteria for our query
array ('name' =&gt; 1, 'first' =&gt; 1, '_id' =&gt; 0 ))
 // MongoDB calls this a projection:  which fields we want
)-&gt;limit(10);                         // cursor modifier</pre></div><p>This should, by now, look pretty straightforward to you. The cursor modifier part allows you to limit or influence the data that is returned, for example, there is a <span class="strong"><strong>sort</strong></span> modifier.</p><p>The <code class="literal">projection</code> array allows you to specify which fields you are interested in. By default, the value of <code class="literal">id</code> is<a id="id795" class="indexterm"/> always returned, so if you do not need it, add <code class="literal">_id =&gt; 0</code> to your projection array.</p></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec79"/>Summary</h1></div></div></div><p>In this chapter, you learned about MongoDB, a document database that is very popular amongst NoSQL databases. Documents stored in the database are basically nothing more than JSON objects. They can be grouped in collections, the equivalent of tables in RDBMS.</p><p>Using the MongoDB shell, we can populate databases and collections from the command line. From within web applications, we can access a MongoDB database on the server using PHP. This is really easy because JSON objects can be written as associative arrays.</p><p>In the last few chapters, there was a lot of sample code and I promised you a textbook so you can learn away from the computer. In the next chapter, there will be a lot more reading to do.</p><p>The newest trends in web development are being discussed, triggered by the totally different way people are using the Web compared to just a couple of years ago. We are going to focus a little more on how your website looks and a little less on how it works.</p></div></body></html>