<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Learning Phalcon's ORM and ODM"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Learning Phalcon's ORM and ODM</h1></div></div></div><p>Now that you have learned a little bit about Phalcon's internals and we have our project structure, we can move forward to a more serious thing—databases. In this chapter, we will cover these topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The main differences between SQL and NoSQL databases</li><li class="listitem" style="list-style-type: disc">Learning how to connect to a database</li><li class="listitem" style="list-style-type: disc">ORM/ODM CRUD operations (create, read, update, and delete) and transactions</li><li class="listitem" style="list-style-type: disc">Understanding the drawbacks of an ORM in general, and how we can improve performance using caching methods</li></ul></div><div class="section" title="The main differences between SQL and NoSQL databases"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec21"/>The main differences between SQL and NoSQL databases</h1></div></div></div><p>MySQL is good! It is a powerful <a id="id171" class="indexterm"/>RDBMS with a big market share, supported<a id="id172" class="indexterm"/> by a large community. It is open source (though enterprise flavors exist), and almost every PHP application uses it as the main database system.</p><p>But once in a while, you will notice that MySQL isn't good enough for your needs. Maybe you have heard people talk about MongoDB, CouchDB, Cassandra, and so on. We will use MongoDB in our project, so I am going to talk about it.</p><p>In general, you will use a NoSQL system, such as MongoDB, when you want to develop real-time analytics, cache, and logs; store big data, such as comments or likes; and handle many other situations.</p><p>A few of the differences between a SQL and NoSQL database are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">NoSQL is <span class="emphasis"><em>not</em></span> relational</li><li class="listitem" style="list-style-type: disc">NoSQL is not reliable; or better said, it is not safe to use in a complex system, because it does not support transactions</li><li class="listitem" style="list-style-type: disc">A relational database requires a structure with defined attributes to hold the data, but a NoSQL database usually allows free-flow operations</li></ul></div><p>Later in our project, we <a id="id173" class="indexterm"/>will use MongoDB mainly for<a id="id174" class="indexterm"/> logging and comments. We have already installed MongoDB in the first chapter.</p><p>Let's look at a few usage examples:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>SQL</p>
</th><th style="text-align: left" valign="bottom">
<p>MongoDB</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">SELECT a,b FROM users</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">$db-&gt;users-&gt;find([], ["a" =&gt; 1, "b" =&gt; 1]);</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">SELECT * FROM users WHERE age=33</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">$db-&gt;users-&gt;find(["age" =&gt; 33]);</code></p>
</td></tr></tbody></table></div><p>On the official PHP website, you can check out the full <a id="id175" class="indexterm"/>SQL-to-MongoDB mapping chart (<a class="ulink" href="http://php.net/manual/ro/mongo.sqltomongo.php">http://php.net/manual/ro/mongo.sqltomongo.php</a>).</p></div></div>
<div class="section" title="Connecting to the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec22"/>Connecting to the database</h1></div></div></div><p>In the previous chapter, we <a id="id176" class="indexterm"/>added a global configuration file and configuration files per module. In order to be able to connect to a database, we need to add some lines to our configuration file first.</p><p>Let's recall our directory structure:</p><div class="mediaobject"><img src="graphics/B03522_03_06.jpg" alt="Connecting to the database"/></div><p>In order to connect to a database, we <a id="id177" class="indexterm"/>need to create it. Create a database named <code class="literal">learning_phalcon</code>. You can do this quickly with the help of the following command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ mysql -u YOURUSERNAME -p -e 'create database learning_phalcon;'</strong></span>
</pre></div><p>Open the global configuration file (<code class="literal">config/config.php</code>), and add these lines:</p><div class="informalexample"><pre class="programlisting">    'database' =&gt; array(
        'adapter'  =&gt; 'Mysql',
        'host'     =&gt; 'localhost',
        'username' =&gt; 'Input your username here',
        'password' =&gt; 'Input your password here',
        'dbname'   =&gt; 'learning_phalcon',
    ),</pre></div><p>Now that we have the configuration parameters for our database, we must create a service. Open the global services file (<code class="literal">config</code>/<code class="literal">service.php</code>) and add the following lines:</p><div class="informalexample"><pre class="programlisting">$di['db'] = function () use ($config) {

    return new \Phalcon\Db\Adapter\Pdo\Mysql(array(
        "host" =&gt; $config-&gt;database-&gt;host,
        "username" =&gt; $config-&gt;database-&gt;username,
        "password" =&gt; $config-&gt;database-&gt;password,
        "dbname" =&gt; $config-&gt;database-&gt;dbname,
        "options" =&gt; array(
            \PDO::MYSQL_ATTR_INIT_COMMAND =&gt; "SET NAMES 'UTF8'",
            \PDO::ATTR_CASE =&gt; \PDO::CASE_LOWER,
            \PDO::MYSQL_ATTR_USE_BUFFERED_QUERY =&gt; true,
            \PDO::ATTR_PERSISTENT =&gt; true
        )
    ));
};</pre></div><p>We can now save and close <a id="id178" class="indexterm"/>this file. Next, we are going to create a table named <code class="literal">article</code> in our database, and we'll insert one sample record into this table:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>USE learning_phalcon;</strong></span>

<span class="strong"><strong>CREATE TABLE IF NOT EXISTS `article` (</strong></span>
<span class="strong"><strong>`id` int(11) NOT NULL AUTO_INCREMENT,</strong></span>
<span class="strong"><strong>`article_short_title` varchar(255) COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>`article_long_title` varchar(255) COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>`article_slug` varchar(255) COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>`article_description` text COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>PRIMARY KEY (`id`),</strong></span>
<span class="strong"><strong>KEY `id` (`id`)</strong></span>
<span class="strong"><strong>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci AUTO_INCREMENT=1 ;</strong></span>

<span class="strong"><strong>INSERT INTO `learning_phalcon`.`article` (</strong></span>
<span class="strong"><strong>`id` ,</strong></span>
<span class="strong"><strong>`article_short_title` ,</strong></span>
<span class="strong"><strong>`article_long_title` ,</strong></span>
<span class="strong"><strong>`article_slug` ,</strong></span>
<span class="strong"><strong>`article_description`</strong></span>
<span class="strong"><strong>)</strong></span>
<span class="strong"><strong>VALUES (</strong></span>
<span class="strong"><strong>NULL ,  'Test article short title',  'Test article long title',  'test-article-short-title',  'Test article description'</strong></span>
<span class="strong"><strong>);</strong></span>
</pre></div><p>To test the database<a id="id179" class="indexterm"/> connection, we will use our <code class="literal">Frontend</code> and <code class="literal">Core</code> modules. In the <code class="literal">Core</code> module, we are going to create a model for the article table. Based on the previous chapter, the directory structure of the <code class="literal">Frontend</code> module should look like this:</p><div class="mediaobject"><img src="graphics/B03522_03_07.jpg" alt="Connecting to the database"/></div><p>For the <code class="literal">Core</code> module, the structure should look like this:</p><div class="mediaobject"><img src="graphics/B03522_03_08.jpg" alt="Connecting to the database"/></div><p>We will create the model for the <code class="literal">article</code> table in a new folder, named <code class="literal">Models</code>. Create the <code class="literal">Models</code> directory in <code class="literal">modules</code>/<code class="literal">Core</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd modules/Core</strong></span>
<span class="strong"><strong>$ mkdir Models</strong></span>
</pre></div><p>In the <code class="literal">Models</code> directory, create<a id="id180" class="indexterm"/> two new files: <code class="literal">Base.php</code> and <code class="literal">Article.php</code>. We'll now look at these files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The content of <code class="literal">Base.php</code> is as follows:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models;

class Base extends \Phalcon\Mvc\Model
{

}</pre></div></li><li class="listitem" style="list-style-type: disc">The content of <code class="literal">Article.php</code> is this:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models;

class Article extends \Phalcon\Mvc\Model
{
    protected $id;
    protected $article_short_title;
    protected $article_long_title;
    protected $article_slug;
    protected $article_description;

    public function setId($id)
    {
        $this-&gt;id = $id;
        return $this;
    }

    public function setArticleShortTitle($article_short_title)
    {
        $this-&gt;article_short_title = $article_short_title;
        return $this;
    }

    public function setArticleLongTitle($article_long_title)
    {
        $this-&gt;article_long_title = $article_long_title;
        return $this;
    }

    public function setArticleSlug($article_slug)
    {
        $this-&gt;article_slug = $article_slug;
        return $this;
    }

    public function setArticleDescription($article_description)
    {
        $this-&gt;article_description = $article_description;
        return $this;
    }

    public function getId()
    {
        return $this-&gt;id;
    }

    public function getArticleShortTitle()
    {
        return $this-&gt;article_short_title;
    }

    public function getArticleLongTitle()
    {
        return $this-&gt;article_long_title;
    }

    public function getArticleSlug()
    {
        return $this-&gt;article_slug;
    }

    public function getArticleDescription()
    {
        return $this-&gt;article_description;
    }
}</pre></div></li></ul></div><p>Personally, I like to work<a id="id181" class="indexterm"/> in the cleanest manner possible. We are going to use an intermediate file—a manager—to handle all of the heavy logic. This means that you are not going to use the models in the controller, and you are not going to alter the models by adding queries or other kind of data. The models should be as clean as possible. On the other hand, some people prefer to move the heavy logic to models. It's your choice, but in this book we are going to use managers. This being said, let's create the manager for the article:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to modules/Core/ and create a folder named Managers:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd modules/Core/</strong></span>
<span class="strong"><strong>$ mkdir Managers</strong></span>
</pre></div></li><li class="listitem">Create two new<a id="id182" class="indexterm"/> files named <code class="literal">BaseManager.php</code> and <code class="literal">ArticleManager.php</code>, and add the following content:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">BaseManager.php</code> file will be placed under <code class="literal">modules/Core/Managers/</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Managers;

class BaseManager extends \Phalcon\Mvc\User\Module
{
}</pre></div></li><li class="listitem" style="list-style-type: disc">The <code class="literal">ArticleManager.php</code> file will be placed under <code class="literal">modules/Core/Managers/</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Managers;

use App\Core\Models\Article;

class Article extends Base
{
    public function find($parameters = null)
    {
        return Article::find($parameters);
    }
}</pre></div></li></ul></div></li></ol></div><p>The new directory structure of the <code class="literal">Core</code> module should now look like this:</p><div class="mediaobject"><img src="graphics/B03522_03_09.jpg" alt="Connecting to the database"/></div><p>All good so far! Let's try to <a id="id183" class="indexterm"/>make use of this manager to list the records from our <code class="literal">Article</code> table. For that, we need to declare it as a service first. To do so, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the global services file (<code class="literal">config/service.php</code>), and add the following content:<div class="informalexample"><pre class="programlisting">$di['core_article_manager'] = function() {
    return new App\Core\Managers\ArticleManager();
};</pre></div><p>We will use the <code class="literal">frontend</code> module to carry out this test.</p></li><li class="listitem">Navigate to the <code class="literal">Frontend</code> directory, edit the <code class="literal">modules/Frontend/Config/routing.php</code> file, and add this content:<div class="informalexample"><pre class="programlisting">$router-&gt;add('#^/articles[/]{0,1}$#', array(
    'module' =&gt; 'frontend',
    'controller' =&gt; 'article',
    'action' =&gt; 'list'
));

$router-&gt;add('#^/articles/([a-zA-Z0-9\-]+)[/]{0,1}$#', array(
    'module' =&gt; 'frontend',
    'controller' =&gt; 'article',
    'action' =&gt; 'read',
    'slug' =&gt; 1
));</pre></div><p>The first routing pattern will point any <a id="id184" class="indexterm"/>request made at <code class="literal">http://www.learning-phalcon.localhost/articles</code> to the <code class="literal">frontend</code> module, the <code class="literal">article</code> controller, and the <code class="literal">listAction</code> action.</p><p>The second pattern will point to a different action within the article controller, named <code class="literal">readAction</code> and will pass the slug parameter to this action.</p></li><li class="listitem">Next, we will <a id="id185" class="indexterm"/>create the <code class="literal">article</code> controller and the template. Navigate to <code class="literal">modules/Frontend/Controllers</code>, and create a file named <code class="literal">ArticleController.php</code> with the following content:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Frontend\Controllers;

class ArticleController extends BaseController
{
    public function listAction()
    {
        $article_manager = $this-&gt;getDI()-&gt;get('core_article_manager');
        $this-&gt;view-&gt;articles = $article_manager-&gt;find();
    }
}</pre></div><p>In <code class="literal">listAction</code>, we get the <code class="literal">article</code> manager from DI, and assign the result of the <code class="literal">find()</code> method to a view variable named <code class="literal">articles</code>.</p></li><li class="listitem">Now let's create a template for this action. Navigate to <code class="literal">modules/Frontend/Views/Default</code>, and create a new directory named <code class="literal">article</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd modules/Frontend/Views/Default</strong></span>
<span class="strong"><strong>$ mkdir article</strong></span>
</pre></div></li><li class="listitem">In the <code class="literal">article</code> folder, create a file named <code class="literal">list.volt</code> and add the following content to it:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>{% extends 'layout.volt' %}</strong></span>
<span class="strong"><strong>{% block body %}</strong></span>
<span class="strong"><strong>    &lt;ul&gt;</strong></span>
<span class="strong"><strong>    {% for article in articles %}</strong></span>
<span class="strong"><strong>        &lt;li&gt;&lt;a href="{{ url('article/' ~ article.getArticleSlug()) }}"&gt;{{ article.getArticleShortTitle() }}&lt;/a&gt;&lt;/li&gt;</strong></span>
<span class="strong"><strong>    {% endfor %}</strong></span>
<span class="strong"><strong>    &lt;/ul&gt;</strong></span>
<span class="strong"><strong>{% endblock %}</strong></span>
</pre></div></li></ol></div><p>The <code class="literal">Frontend</code> directory structure should look like this:</p><div class="mediaobject"><img src="graphics/B03522_03_10.jpg" alt="Connecting to the database"/></div><p>If you did everything by the <a id="id186" class="indexterm"/>book, you're<a id="id187" class="indexterm"/> all set. You can now go to <code class="literal">http://www.learning-phalcon.localhost/articles</code>, and you should be able to see our test article as shown here:</p><div class="mediaobject"><img src="graphics/B03522_03_01.jpg" alt="Connecting to the database"/></div><p>Great job! You are now connected to the database, and you have the first model and manager. We will continue this chapter with data manipulation, validations, and simple queries over MySQL and MongoDB.</p></div>
<div class="section" title="ORM/ODM operations (create, update, delete, transactions, and validations)"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec23"/>ORM/ODM operations (create, update, delete, transactions, and validations)</h1></div></div></div><p>Before we continue, let's<a id="id188" class="indexterm"/> make our article table a little more complex, by adding a few columns. We will add three more columns: <code class="literal">is_published</code>, <code class="literal">created_at</code>, and <code class="literal">updated_at</code>.</p><p>The <code class="literal">is_published</code> field will be a Boolean type (in MySQL, it will have a value of 0 or 1), and the <code class="literal">created_at</code> and <code class="literal">updated_at</code> fields will have the <code class="literal">datetime</code> type. They will hold information about when our article was created and when it was updated. You can alter the <code class="literal">article</code> table and add these fields using the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ALTER TABLE `article` ADD `is_published` BOOLEAN NOT NULL DEFAULT FALSE ,</strong></span>
<span class="strong"><strong>ADD `created_at` DATETIME NOT NULL ,</strong></span>
<span class="strong"><strong>ADD `updated_at` DATETIME NULL DEFAULT NULL ;</strong></span>
</pre></div><p>We also need to make modifications to our <code class="literal">Article</code> model and add the getters and setters for these new fields. Open the <code class="literal">modules/Core/Models/Article.php</code> file and add the following content:</p><div class="informalexample"><pre class="programlisting">    protected $is_published;
    protected $created_at;
    protected $updated_at;

    public function setIsPublished($is_published)
    {
        $this-&gt;is_published = $is_published;
        return $this;
    }

    public function setCreatedAt($created_at)
    {
        $this-&gt;created_at = $created_at;
        return $this;
    }

    public function setUpdatedAt($updated_at)
    {
        $this-&gt;updated_at = $updated_at;
        return $this;
    }

    public function getIsPublished()
    {
        return $this-&gt;is_published;
    }

    public function getCreatedAt()
    {
        return $this-&gt;created_at;
    }

    public function getUpdatedAt()
    {
        return $this-&gt;created_at;
    }</pre></div><p>Since most of the CRUD <a id="id189" class="indexterm"/>actions that we will use will be handled by the <code class="literal">Backoffice</code> module, we are going to set up this module as we did with the Frontend. The actual development of this module will be done later in the book. For now, we will enable a quick and simple CRUD operation for the <code class="literal">Article</code> table.</p><p>Let's review our <code class="literal">Backoffice</code> directory structure. At this point, you should have the following structure:</p><div class="mediaobject"><img src="graphics/B03522_03_11.jpg" alt="ORM/ODM operations (create, update, delete, transactions, and validations)"/></div><p>For this to be functional, we will need to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Add routing information</li><li class="listitem" style="list-style-type: disc">Create the controller and the actions</li><li class="listitem" style="list-style-type: disc">Create the views</li></ul></div><div class="section" title="Adding the routing information"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec21"/>Adding the routing information</h2></div></div></div><p>Edit the <code class="literal">config/routing.php</code> global <a id="id190" class="indexterm"/>routing file by adding the following content:</p><div class="informalexample"><pre class="programlisting">foreach ($modules as $moduleName =&gt; $module){
    if ($default_module == $moduleName) {
    continue;
}

$moduleRouting = __DIR__.'/../modules/'.ucfirst($moduleName).'/Config/routing.php';
    include $moduleRouting;
}</pre></div><p>Delete (or overwrite) the routing file from the <code class="literal">Backoffice</code> module <code class="literal">modules/Backoffice</code>/<code class="literal">Config/routing.php</code>, and add a new one with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$router-&gt;add('#^/backoffice(|/)$#', array(
    'module' =&gt; 'backoffice',
    'controller' =&gt; 'index',
    'action' =&gt; 'index',
));

$router-&gt;add('#^/backoffice/([a-zA-Z0-9\_]+)[/]{0,1}$#', array(
    'module' =&gt; 'backoffice',
    'controller' =&gt; 1,
));

$router-&gt;add('#^/backoffice[/]{0,1}([a-zA-Z0-9\_]+)/([a-zA-Z0-9\_]+)(/.*)*$#', array(
    'module' =&gt; 'backoffice',
    'controller' =&gt; 1,
    'action' =&gt; 2,
    'params' =&gt; 3,
));</pre></div></div><div class="section" title="Creating the controller and the actions"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec22"/>Creating the controller and the actions</h2></div></div></div><p>Navigate to <code class="literal">modules/Backoffice/Controllers/</code>, and <a id="id191" class="indexterm"/>create a new file <a id="id192" class="indexterm"/>named <code class="literal">ArticleController.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Backoffice\Controllers;

class ArticleController extends BaseController
{
    public function indexAction()
    {
      return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'list']);
    }

    public function listAction()
    {
        $article_manager      = $this-&gt;getDI()-&gt;get('core_article_manager');
        $this-&gt;view-&gt;articles = $article_manager-&gt;find();
    }
}</pre></div></div><div class="section" title="Creating the views"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec23"/>Creating the views</h2></div></div></div><p>Copy the views from <code class="literal">Frontend</code>. We <a id="id193" class="indexterm"/>will adapt them for our Backoffice module in <a class="link" href="ch07.html" title="Chapter 7. The Backoffice Module (Part 1)">Chapter 7</a>, <span class="emphasis"><em>The Backoffice Module (Part 1)</em></span>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd modules/Backoffice</strong></span>
<span class="strong"><strong>$ cp -r ../Frontend/Views .</strong></span>
</pre></div><p>Now let's modify the views a bit so that we can have a nice <code class="literal">Backoffice</code> module. Go to <code class="literal">modules/Backoffice/Views/</code>, open the <code class="literal">layout.volt</code> file, and make the following change.</p><p>Look for this line:</p><div class="informalexample"><pre class="programlisting">&lt;title&gt;{% block pageTitle %}Learning Phalcon{% endblock %}&lt;/title&gt;</pre></div><p>Replace it with the following line:</p><div class="informalexample"><pre class="programlisting">&lt;title&gt;{% block pageTitle %}Backoffice - Learning Phalcon{% endblock %}&lt;/title&gt;</pre></div><p>Create a new file named <code class="literal">lp.backoffice.css</code> in <code class="literal">public/assets/default/css/</code>, and add the following content to it:</p><div class="informalexample"><pre class="programlisting">body              { padding-top: 50px; }
.sub-header       { padding-bottom: 10px; border-bottom: 1px solid #eee; }
.navbar-fixed-top { border: 0; }
.sidebar          { display: none; }

@media (min-width: 768px) {
  .sidebar {position: fixed;top: 51px;bottom: 0;left: 0;z-index: 1000;display: block;padding: 20px;overflow-x: hidden;overflow-y: auto;background-color: #f5f5f5;border-right: 1px solid #eee;}
}

.nav-sidebar          { margin-right: -21px; margin-bottom: 20px; margin-left: -20px; }
.nav-sidebar &gt; li &gt; a { padding-right: 20px; padding-left: 20px; }
.nav-sidebar &gt; .active &gt; a,
.nav-sidebar &gt; .active &gt; a:hover,
.nav-sidebar &gt; .active &gt; a:focus { color: #fff; background-color: #428bca; }

.main { padding: 20px; }
@media (min-width: 768px) {
  .main { padding-right: 40px; padding-left: 40px; }
}
.main .page-header { margin-top: 0; }</pre></div><p>Then we include the <a id="id194" class="indexterm"/>preceding file in our <code class="literal">layout.volt</code> file. We do this by looking for this line:</p><div class="informalexample"><pre class="programlisting">{{ stylesheetLink('../assets/default/css/lp.css') }}</pre></div><p>We replace it with the following line:</p><div class="informalexample"><pre class="programlisting">{{ stylesheetLink('../assets/default/css/lp.backoffice.css') }}</pre></div><p>In the same <code class="literal">layout.volt</code> file, remove the following code snippet:</p><div class="informalexample"><pre class="programlisting">{% block body %}
&lt;h1&gt;I did it !&lt;/h1&gt;
{% endblock %}</pre></div><p>Add the following content between the <code class="literal">&lt;body&gt;</code> and <code class="literal">&lt;/body&gt;</code> tags:</p><div class="informalexample"><pre class="programlisting">    &lt;nav class="navbar navbar-inverse navbar-fixed-top" role="navigation"&gt;
      &lt;div class="container-fluid"&gt;
        &lt;div class="navbar-header"&gt;
          &lt;button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"&gt;
            &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
          &lt;/button&gt;
          &lt;a class="navbar-brand" href="#"&gt;Learning Phalcon&lt;/a&gt;
        &lt;/div&gt;
        &lt;div id="navbar" class="navbar-collapse collapse"&gt;
          &lt;ul class="nav navbar-nav navbar-right"&gt;
            &lt;li&gt;&lt;a href="#"&gt;Sign out&lt;/a&gt;&lt;/li&gt;
          &lt;/ul&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/nav&gt;

    &lt;div class="container-fluid"&gt;
      &lt;div class="row"&gt;
        &lt;div class="col-sm-3 col-md-2 sidebar"&gt;
          &lt;ul class="nav nav-sidebar"&gt;
            &lt;li class="active"&gt;&lt;a href="{{ url('article/list') }}"&gt;Articles &lt;span class="sr-only"&gt;(current)&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href="#"&gt;Other menu item&lt;/a&gt;&lt;/li&gt;
          &lt;/ul&gt;
        &lt;/div&gt;
        &lt;div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main"&gt;
          {% block body %}
          &lt;h1 class="page-header"&gt;Dashboard&lt;/h1&gt;
          &lt;h2 class="sub-header"&gt;Section title&lt;/h2&gt;
          &lt;div class="table-responsive"&gt;

          &lt;/div&gt;
          {% endblock %}
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;</pre></div><p>We are done editing our<a id="id195" class="indexterm"/> layout.volt file, but we need to make one more change. Open <code class="literal">modules/Backoffice/Views/Default/article/list.volt</code>, and replace its content with the following code:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %} {% block body %}
&lt;h1 class="page-header"&gt;Articles&lt;/h1&gt;
&lt;h2 class="sub-header"&gt;List&lt;/h2&gt;
&lt;div class="table-responsive"&gt;

    &lt;table class="table table-striped"&gt;
        &lt;thead&gt;
            &lt;tr&gt;
                &lt;th&gt;#&lt;/th&gt;
                &lt;th&gt;Title&lt;/th&gt;
                &lt;th&gt;Is published&lt;/th&gt;
                &lt;th&gt;Created at&lt;/th&gt;
                &lt;th&gt;Updated at&lt;/th&gt;
                &lt;th&gt;Options&lt;/th&gt;
            &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;
        {% for article in articles %}
            &lt;tr&gt;
                &lt;td&gt;{{ article.getId() }}&lt;/td&gt;
                &lt;td&gt;{{ article.getArticleShortTitle() }}&lt;/td&gt;
                &lt;td&gt;{{ article.getIsPublished() }}&lt;/td&gt;
                &lt;td&gt;{{ article.getCreatedAt() }}&lt;/td&gt;
                &lt;td&gt;{{ article.getUpdatedAt() }}&lt;/td&gt;
                &lt;td&gt;
                    &lt;a href="{{ url('article/edit/' ~ article.getId()) }}"&gt;Edit&lt;/a&gt; |
                    &lt;a href="{{ url('article/delete/' ~ article.getId()) }}"&gt;Delete&lt;/a&gt; |
                &lt;/td&gt;
            &lt;/tr&gt;
        {% endfor %}
        &lt;/tbody&gt;
    &lt;/table&gt;

&lt;/div&gt;
{% endblock %}</pre></div><p>After all of these changes, the<a id="id196" class="indexterm"/> new directory structure should look like what is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_03_12.jpg" alt="Creating the views"/></div><p>Let's <a id="id197" class="indexterm"/>open <code class="literal">http://www.learning-phalcon.localhost/backoffice/article/list</code> in a browser. If everything goes well, you should be able to see the new <code class="literal">Backoffice</code> layout and our test article in a list exactly like this:</p><div class="mediaobject"><img src="graphics/B03522_03_02.jpg" alt="Creating the views"/></div><p>Now that we have a UI, you <a id="id198" class="indexterm"/>can start learning about Phalcon's ORM. You need to know that Phalcon provides three ways of working with databases:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using ORM</li><li class="listitem" style="list-style-type: disc">Using PHQL</li><li class="listitem" style="list-style-type: disc">Using raw SQL</li></ul></div><p>We will learn about all of these in this chapter. Let's start with ORM.</p></div></div>
<div class="section" title="CRUD operations using ORM"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec24"/>CRUD operations using ORM</h1></div></div></div><p>By using the ORM, there is <a id="id199" class="indexterm"/>virtually no need to write any SQL in your code. Everything is OOP, and it is using the models to perform operations. The first, and the most basic, operation is retrieving data. In the old days, you would do this:</p><div class="informalexample"><pre class="programlisting">$result = mysql_query("SELECT * FROM article");</pre></div><p>The class that our models are extending is \<code class="literal">Phalcon\Mvc\Mode</code>l. This  class has some very useful methods built in, such as <code class="literal">find()</code>, <code class="literal">findFirst()</code>, <code class="literal">count()</code>, <code class="literal">sum()</code>, <code class="literal">maximum()</code>, <code class="literal">minimum()</code>, <code class="literal">average()</code>, <code class="literal">save()</code>, <code class="literal">create()</code>, <code class="literal">update()</code>, and <code class="literal">delete()</code>.</p><div class="section" title="CRUD – reading data"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec24"/>CRUD – reading data</h2></div></div></div><p>We have already used the <code class="literal">find()</code> method in our <code class="literal">article</code> manager when calling <code class="literal">Article::find()</code>. By default, this <a id="id200" class="indexterm"/>method will return all the records from the <code class="literal">article</code> table, sorting them in a natural order. It also accepts an array with parameters. The following code examples will explain this:</p><div class="informalexample"><pre class="programlisting">$article_slug = "test-article-short-title";

$result = Article::find(
    [
        "article_slug = :article_slug:",
        "bind" =&gt; ["article_slug" =&gt; $article_slug]
        "order" =&gt; "created_at DESC",
        "limit" =&gt; 1
    ]
);</pre></div><p>In the preceding example, we are searching for records that contain the <code class="literal">test-article-short-title</code> article slug. We bind the data order by the <code class="literal">created_at</code> field in a descending order, and limit the number of rows returned to one. The first key of the parameters array should always be the condition. Binding parameters is good practice in order to avoid SQL injections. I recommend that you always use it.</p><p>The result of <code class="literal">Article::find()</code> is an array of objects. This means that if we need to iterate between the results, we can do it like this:</p><div class="informalexample"><pre class="programlisting">foreach ($result as $article) {
    echo $article-&gt;getTitle();
}</pre></div><p>Let's add two new records to our <code class="literal">article</code> table, so that you can see live what it is happening:</p><div class="informalexample"><pre class="programlisting">INSERT INTO  `learning_phalcon`.`article` (`id` ,`article_short_title` ,`article_long_title` ,`article_slug` ,`article_description` ,`is_published` ,`created_at` ,`updated_at`)
VALUES (NULL ,  'Test article short title 2',  'Test article long title 2',  'test-article-short-title-2',  'Test article description 2',  '0',  '2014-12-14 05:13:26', NULL);

INSERT INTO  `learning_phalcon`.`article` (`id` ,`article_short_title` ,`article_long_title` ,`article_slug` ,`article_description` ,`is_published` ,`created_at` ,`updated_at`)
VALUES (NULL ,  'Test article short title 3',  'Test article long title 3',  'test-article-short-title-3',  'Test article description 3',  '0',  '2014-12-14 05:13:26', NULL);</pre></div><p>If you<a id="id201" class="indexterm"/> access <code class="literal">http://www.learning-phalcon.localhost/backoffice/article/list</code> now, you should be able to see the new records, as shown in this screenshot:</p><div class="mediaobject"><img src="graphics/B03522_03_03.jpg" alt="CRUD – reading data"/></div><p>Next, we are going to<a id="id202" class="indexterm"/> make some sorting tests. For reference, the default order shown in the preceding screenshot is a natural one, and the IDs are 1, 2, and 3. Keep this in mind, because we will refer to these IDs in the next few lines.</p><p>Open the <code class="literal">article</code> controller <code class="literal">modules/Backoffice/Controllers/ArticleController.php</code>, and then remove the following line:</p><div class="informalexample"><pre class="programlisting">$this-&gt;view-&gt;articles = $article_manager-&gt;find();</pre></div><p>Now add the following line, which will order the articles by creation date in descending order:</p><div class="informalexample"><pre class="programlisting">$articles = $article_manager-&gt;find([
   'order' =&gt; 'created_at DESC'
]);
$this-&gt;view-&gt;articles = $articles;</pre></div><p>If you refresh <a id="id203" class="indexterm"/>the page at <code class="literal">http://www.learning-phalcon.localhost/backoffice/article/list</code>, you will see that the records are ordered differently. The order that you should see is this: 3, 2, and 1.</p><p>Feel free to practice and try to order by different columns and by adding limits.</p><p>Another useful method is <code class="literal">findFirst()</code>. This method accepts the same parameters as <code class="literal">find()</code>, except that the result will be an instance of the <code class="literal">Article</code> model; this means that you don't need to iterate between records:</p><div class="informalexample"><pre class="programlisting">$article = Article::findFirst();
echo $article-&gt;getTitle();</pre></div><p>Some of the helpful methods are the magic methods, <code class="literal">findBy*()</code> and <code class="literal">findFirstBy*()</code>. For example, if you need<a id="id204" class="indexterm"/> to search articles by slug, you can do it like this with these magic methods:</p><div class="informalexample"><pre class="programlisting">$articles = Article::findByArticleSlug('test-article-short-title');
foreach ($articles as $article) {
    echo $article-&gt;getId();
}

$article = Article:;findFirstByArticleSlug('test-article-short-title');
echo $article-&gt;getId();</pre></div></div><div class="section" title="CRUD – creating data"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec25"/>CRUD – creating data</h2></div></div></div><p>Creating data with <a id="id205" class="indexterm"/>the help of ORM is easier than it sounds. We are going to make use of the model. Remember what I told you—that I like to keep the models as clean as possible. This is why most of the time, we will create and make use of managers. Open the <code class="literal">article</code> manager in <code class="literal">modules/Core/Managers/ArticleManager.php</code>, and add the following code:</p><div class="informalexample"><pre class="programlisting">    public function create($data)
    {
        $article = new Article();
        $article-&gt;setArticleShortTitle($data['article_short_title']);
        $article-&gt;setArticleLongTitle($data['article_long_title']);
        $article-&gt;setArticleDescription($data['article_description']);
        $article-&gt;setArticleSlug($data['article_slug']);
        $article-&gt;setIsPublished(0);
        $article-&gt;setCreatedAt(new \Phalcon\Db\RawValue('NOW()'));

        if (false === $article-&gt;create()) {
            foreach ($article-&gt;getMessages() as $message) {
                $error[] = (string) $message;
            }
            throw new \Exception(json_encode($error));
        }
        return $article;
    }</pre></div><p>Next, we will add a dummy <code class="literal">createAction</code> method to our controller. Open <code class="literal">modules/Backoffice/Controllers/ArticleController.php</code>, and add the following content:</p><div class="informalexample"><pre class="programlisting">    public function createAction()
{
  $this-&gt;view-&gt;disable();
  $article_manager = $this-&gt;getDI()-&gt;get('core_article_manager');

        try {
            $article = $article_manager-&gt;create([]);
            echo $article-&gt;getArticleShortTitle(), " was created.";
        } catch (\Exception $e) {
            echo $e-&gt;getMessage();
        }
    }</pre></div><p>Upon accessing <code class="literal">http://www.learning-phalcon.localhost/backoffice/article/create</code>, you <a id="id206" class="indexterm"/>will see <a id="id207" class="indexterm"/>some errors, similar to the ones shown in this screenshot:</p><div class="mediaobject"><img src="graphics/B03522_03_04.jpg" alt="CRUD – creating data"/></div><p>This is perfectly normal, since <a id="id208" class="indexterm"/>we didn't pass any parameters to our <code class="literal">create()</code> method. Modify the <code class="literal">createAction</code> method by adding these parameters to the create method:</p><div class="informalexample"><pre class="programlisting">$article = $article_manager-&gt;create([
    'article_short_title' =&gt; 'Test article short title 5',
    'article_long_title' =&gt; 'Test article long title 5',
    'article_description' =&gt; 'Test article description 5',
    'article_slug' =&gt; 'test-article-short-title-5'
]);</pre></div><p>If we refresh the page at <code class="literal">http://www.learning-phalcon.localhost/backoffice/article/create</code>, we should <a id="id209" class="indexterm"/>see a success message similar to what is shown here:</p><div class="mediaobject"><img src="graphics/B03522_03_05.jpg" alt="CRUD – creating data"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>Each time you refresh this page, a new <a id="id210" class="indexterm"/>record will be inserted into the database. You can access <code class="literal">http://www.learning-phalcon.localhost/backoffice/article/list</code> to see the new records.</p></div></div><p>Let's quickly <a id="id211" class="indexterm"/>analyze the <code class="literal">create()</code> method:</p><p>We instantiate the <code class="literal">Article</code> model and assign values to it using the setters that we wrote for it. Then, we call the built-in <code class="literal">create()</code> method to create the data. If there are any errors, we read them and throw an exception with those errors (JSON-encoded), otherwise we return the newly created object.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip11"/>Tip</h3><p>You can also use the <code class="literal">save()</code> method instead of <code class="literal">create()</code>.</p></div></div><p>If you have a big table (tens of columns), you might want to use the built-in <code class="literal">assign()</code> method when you create the object, instead of assigning it via setters for each column. You can do this using a key-value array, where the keys are the names of the columns, like this for example:</p><div class="informalexample"><pre class="programlisting">$article = $article_manager-&gt;create([
    'article_short_title' =&gt; 'Test article short title 5',
    'article_long_title' =&gt; 'Test article long title 5',
    'article_description' =&gt; 'Test article description 5',
    'article_slug' =&gt; 'test-article-short-title-5'
]);

// create() method from manager:

$article = new Article();
$article-&gt;assign($data);
$article-&gt;create();</pre></div><p>You might wonder what's with <code class="literal">\Phalcon\Db\RawValue('NOW()')</code> assigned to <code class="literal">created_at</code>. Well, whenever you need to assign database-driver-specific / driver built-in data, you will need to use <code class="literal">\Phalcon\Db\RawValue()</code>.</p><p>In our example, we are using it to call the <code class="literal">NOW()</code> MySQL function, which returns the current date and time. If you are working with date-sensitive data, I recommend that you use the PHP date and not rely on any database timestamp.</p></div><div class="section" title="CRUD – updating data"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec26"/>CRUD – updating data</h2></div></div></div><p>Updating data is as easy as<a id="id212" class="indexterm"/> creating it. The only thing that we need to do is find the record that we want to update. Open the <code class="literal">article</code> manager and add the following code:</p><div class="informalexample"><pre class="programlisting">    public function update($id, $data)
    {
        $article = Article::findFirstById($id);

        if (!$article) {
            throw new \Exception('Article not found', 404);
        }

        $article-&gt;setArticleShortTitle($data['article_short_title']);
        $article-&gt;setUpdatedAt(new \Phalcon\Db\RawValue('NOW()'));

        if (false === $article-&gt;update()) {
            foreach ($article-&gt;getMessages() as $message) {
                $error[] = (string) $message;
            }
            throw new \Exception(json_encode($error));
        }
        return $article;
    }</pre></div><p>As you can see, we are passing a new variable, <code class="literal">$id</code>, to the <code class="literal">update</code> method and searching for an article that has its ID equal to the value of the <code class="literal">$id</code> variable. For the sake of an example, this method will update only the article title and the <code class="literal">updated_at</code> field for now.</p><p>Next, we will create a new dummy method as we did for the article, <code class="literal">create</code>. Open <code class="literal">modules/Backoffice/Controllers/ArticleController.php</code> and add the following code:</p><div class="informalexample"><pre class="programlisting">    public function updateAction($id)
    {
        $this-&gt;view-&gt;disable();

        $article_manager = $this-&gt;getDI()-&gt;get('core_article_manager');

        try {
            $article = $article_manager-&gt;update($id, [
                'article_short_title' =&gt; 'Modified article 1'
            ]);
            echo $article-&gt;getId(), " was updated.";
        } catch (\Exception $e) {
            echo $e-&gt;getMessage();
        }
    }</pre></div><p>If you access <code class="literal">http://www.learning-phalcon.localhost/backoffice/article/update/1</code> now, you<a id="id213" class="indexterm"/> should be able to see the <span class="strong"><strong>1 was updated.</strong></span> response. Going back to the article list, you will see the new title, and the <span class="strong"><strong>Updated</strong></span> column will have a new value.</p></div><div class="section" title="CRUD – deleting data"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec27"/>CRUD – deleting data</h2></div></div></div><p>Deleting data is easier, since we don't <a id="id214" class="indexterm"/>need to do more than calling the built-in <code class="literal">delete() </code>method. Open the <code class="literal">article</code> manager, and add the following code:</p><div class="informalexample"><pre class="programlisting">    public function delete($id)
    {
        $article = Article::findFirstById($id);

        if (!$article) {
            throw new \Exception('Article not found', 404);
        }

        if (false === $article-&gt;delete()) {
            foreach ($article-&gt;getMessages() as $message) {
                $error[] = (string) $message;
            }
            throw new \Exception(json_encode($error));
        }

        return true;
    }</pre></div><p>We will once again create a dummy method to delete records. Open <code class="literal">modules/Backoffice/Controllers/ArticleControllers.php</code>, and add the following code:</p><div class="informalexample"><pre class="programlisting">    public function deleteAction($id)
{
  $this-&gt;view-&gt;disable();
  $article_manager = $this-&gt;getDI()-&gt;get('core_article_manager');

        try {
            $article_manager-&gt;delete($id);
            echo "Article was deleted.";
        } catch (\Exception $e) {
            echo $e-&gt;getMessage();
        }
    }</pre></div><p>To test this, simply <a id="id215" class="indexterm"/>access <code class="literal">http://www.learning-phalcon.localhost/backoffice/article/delete/1</code>. If everything went well, you should see the <span class="strong"><strong>Article was deleted.</strong></span> message. Going back to, article list, you won't be able to see the article with ID <code class="literal">1</code> anymore.</p><p>These are the four basic <a id="id216" class="indexterm"/>methods: create, read, update, and delete. Later in this book, we will use these methods a lot.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip12"/>Tip</h3><p>If you need/want to, you can use the Phalcon Developer Tools to generate CRUD automatically. Check out <a class="ulink" href="https://github.com/phalcon/phalcon-devtools">https://github.com/phalcon/phalcon-devtools</a> for more information.</p></div></div></div></div>
<div class="section" title="Using PHQL"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec25"/>Using PHQL</h1></div></div></div><p>Personally, I am not a fan of <a id="id217" class="indexterm"/>PHQL. I prefer using ORM or Raw queries. But if you are going to feel comfortable with it, feel free to use it. PHQL is quite similar to writing raw SQL queries. The main difference is that you will need to pass a model instead of a table name, and use a models manager service or directly call the <code class="literal">\Phalcon\Mvc\Model\Query</code> class. Here is a method similar to the built-in <code class="literal">find()</code> method:</p><div class="informalexample"><pre class="programlisting">public function find()
{
    $query = new \Phalcon\Mvc\Model\Query("SELECT * FROM App\Core\Models\Article", $this-&gt;getDI());
    $articles = $query-&gt;execute();
return $articles;
}</pre></div><p>To use the models manager, we need to inject this new service. Open the global services file, <code class="literal">config/service.php</code>, and add the following code:</p><div class="informalexample"><pre class="programlisting">$di['modelsManager'] = function () {
    return new \Phalcon\Mvc\Model\Manager();
};</pre></div><p>Now let's rewrite the <code class="literal">find()</code> method by making use of the <code class="literal">modelsManager</code> service:</p><div class="informalexample"><pre class="programlisting">public function find()
{
    $query = $this-&gt;modelsManager-&gt;createQuery("SELECT * FROM App\Core\Models\Article");
    $articles = $query-&gt;execute();

    return $articles;
}</pre></div><p>If we need to bind<a id="id218" class="indexterm"/> parameters, the method can look like this one:</p><div class="informalexample"><pre class="programlisting">public function find()
{
    $query = $this-&gt;modelsManager-&gt;createQuery("SELECT * FROM App\Core\Models\Article WHERE id = :id:");
    $articles = $query-&gt;execute(array(
        'id' =&gt; 2
    ));
    return $articles;
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>We are not going to use PHQL<a id="id219" class="indexterm"/> at all in our project. If you are interested in it, you can find more information in the official documentation at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/phql.html">http://docs.phalconphp.com/en/latest/reference/phql.html</a>.</p></div></div></div>
<div class="section" title="Using raw SQL"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec26"/>Using raw SQL</h1></div></div></div><p>Sometimes, using <a id="id220" class="indexterm"/>raw SQL is the only way of performing complex queries. Let's see what a raw SQL will look like for a custom <code class="literal">find()</code> method and a custom <code class="literal">update()</code> method :</p><div class="informalexample"><pre class="programlisting">&lt;?php

use Phalcon\Mvc\Model\Resultset\Simple as Resultset;

class Article extends Base
{
    public static function rawFind()
    {

        $sql     = "SELECT * FROM robots WHERE id &gt; 0";
        $article = new self();

        return new Resultset(null, $article, $article-&gt;getReadConnection()-&gt;query($sql));
    }

    public static function rawUpdate()
    {
        $sql = "UPDATE article SET is_published = 1";
        $this-&gt;getReadConnection()-&gt;execute($sql);
    }
}</pre></div><p>As you can see, the <code class="literal">rawFind()</code> method returns an instance of <code class="literal">\Phalcon\Mvc\Model\Resultset\Simple</code>. The <code class="literal">rawUpdate()</code> method just executes the query (in this example, we will mark all the articles as published). You might have noticed the <code class="literal">getReadConnection()</code> method. This method is very useful when you need to iterate over a large <a id="id221" class="indexterm"/>amount of data or if, for example, you use a master-slave connection. As an example, consider the following code snippet:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class Article extends Base
{
    public function initialize()
    {
        $this-&gt;setReadConnectionService('a_slave_db_connection_service'); // By default is 'db'
        $this-&gt;setWriteConnectionService('db');
    }
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>Working with models might be a complex thing. We cannot cover everything in this book, but we will work with many common techniques to achieve this part of our project. Please spare a little time and read more about working with models<a id="id222" class="indexterm"/> at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/models.html">http://docs.phalconphp.com/en/latest/reference/models.html</a>.</p></div></div></div>
<div class="section" title="Database transactions"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec27"/>Database transactions</h1></div></div></div><p>If you need to perform <a id="id223" class="indexterm"/>multiple database operations, then in most cases you need to ensure that every operation is successful, for the sake of data integrity. A good database architecture in not always enough to solve potential integrity issues. This is the case where you should use transactions. Let's take as an example a virtual wallet that can be represented as shown in the next few tables.</p><p>The <code class="literal">User</code> table looks like the following:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>ID</p>
</th><th style="text-align: left" valign="bottom">
<p>NAME</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>1</p>
</td><td style="text-align: left" valign="top">
<p>John Doe</p>
</td></tr></tbody></table></div><p>The <code class="literal">Wallet</code> table looks like this:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>ID</p>
</th><th style="text-align: left" valign="bottom">
<p>USER_ID</p>
</th><th style="text-align: left" valign="bottom">
<p>BALANCE</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>1</p>
</td><td style="text-align: left" valign="top">
<p>1</p>
</td><td style="text-align: left" valign="top">
<p>5000</p>
</td></tr></tbody></table></div><p>The <code class="literal">Wallet transactions</code> table looks like the following:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>ID</p>
</th><th style="text-align: left" valign="bottom">
<p>WALLET_ID</p>
</th><th style="text-align: left" valign="bottom">
<p>AMOUNT</p>
</th><th style="text-align: left" valign="bottom">
<p>DESCRIPTION</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>1</p>
</td><td style="text-align: left" valign="top">
<p>1</p>
</td><td style="text-align: left" valign="top">
<p>5000</p>
</td><td style="text-align: left" valign="top">
<p>Bonus credit</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>2</p>
</td><td style="text-align: left" valign="top">
<p>1</p>
</td><td style="text-align: left" valign="top">
<p>-1800</p>
</td><td style="text-align: left" valign="top">
<p>Apple store</p>
</td></tr></tbody></table></div><p>How can we create a new user, credit their wallet, and then debit it as the result of a purchase action? This can be achieved in three ways using transactions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Manual transactions</li><li class="listitem" style="list-style-type: disc">Implicit transactions</li><li class="listitem" style="list-style-type: disc">Isolated transactions</li></ul></div><div class="section" title="A manual transactions example"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec28"/>A manual transactions example</h2></div></div></div><p>Manual transactions are useful <a id="id224" class="indexterm"/>when we<a id="id225" class="indexterm"/> are using only one connection and the transactions are not very complex. For example, if any error occurs during an update operation, we can roll back the changes without affecting the data integrity:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class UserController extends Phalcon\Mvc\Controller
{
    public function saveAction()
    {
        $this-&gt;db-&gt;begin();

        $user = new User();
        $user-&gt;name = "John Doe";

        if (false === $user-&gt;save() {
            $this-&gt;db-&gt;rollback();
            return;
        }

        $wallet = new Wallet();
        $wallet-&gt;user_id = $user-&gt;id;
        $wallet-&gt;balance = 0;

        if (false === $wallet-&gt;save()) {
            $this-&gt;db-&gt;rollback();
            return;
        }

        $walletTransaction = new WalletTransaction();
        $walletTransaction-&gt;wallet_id = $wallet-&gt;id;
        $walletTransaction-&gt;amount = 5000;
        $walletTransaction-&gt;description = 'Bonus credit';

        if (false === $walletTransaction1-&gt;save()) {
            $this-&gt;db-&gt;rollback();
            return;
        }

        $walletTransaction1 = new WalletTransaction();
        $walletTransaction1-&gt;wallet_id = $wallet-&gt;id;
        $walletTransaction1-&gt;amount = -1800;
        $walletTransaction1-&gt;description = 'Apple store';

        if (false === $walletTransaction1-&gt;save()) {
            $this-&gt;db-&gt;rollback();
            return;
        }

        $this-&gt;db-&gt;commit();
    }
}</pre></div></div><div class="section" title="An implicit transactions example"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec29"/>An implicit transactions example</h2></div></div></div><p>Implicit transactions are very <a id="id226" class="indexterm"/>useful <a id="id227" class="indexterm"/>when we need to perform operations on related tables / exiting relationships:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class UserController extends Phalcon\Mvc\Controller
{
    public function saveAction()
    {
        $walletTransactions[0] = new WalletTransaction();
        $walletTransactions[0]-&gt;wallet_id = $wallet-&gt;id;
        $walletTransactions[0]-&gt;amount = 5000;
        $walletTransactions[0]-&gt;description = 'Bonus credit';


        $walletTransactions[1] = new WalletTransaction();
        $walletTransactions[1]-&gt;wallet_id = $wallet-&gt;id;
        $walletTransactions[1]-&gt;amount = -1800;
        $walletTransactions[1]-&gt;description = 'Apple store';

        $wallet = new Wallet();
        $wallet-&gt;user_id = $user-&gt;id;
        $wallet-&gt;balance = 0;
        $wallet-&gt;transactions = $walletTransactions;

        $user = new User();
        $user-&gt;name = "John Doe";
        $user-&gt;wallet = $wallet;
    }
}</pre></div></div><div class="section" title="An isolated transactions example"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec30"/>An isolated transactions example</h2></div></div></div><p>Isolated transactions are<a id="id228" class="indexterm"/> always executed <a id="id229" class="indexterm"/>in a separate connection, and they require a transaction manager:</p><div class="informalexample"><pre class="programlisting">&lt;?php

use Phalcon\Mvc\Model\Transaction\Manager as TxManager,
    Phalcon\Mvc\Model\Transaction\Failed as TxFailed;

class UserController extends Phalcon\Mvc\Controller
{
    public function saveAction()
    {
      try {
    $manager     = new TxManager();
    $transaction = $manager-&gt;get();


    $user = new User();
    $user-&gt;setTransaction($transaction);
    $user-&gt;name = "John Doe";

    if ($user-&gt;save() == false) {
        $transaction-&gt;rollback("Cannot save user");
    }

    $wallet = new Wallet();
    $wallet-&gt;setTransaction($transaction);
    $wallet-&gt;user_id = $user-&gt;id;
    $wallet-&gt;balance = 0;

    if ($wallet-&gt;save() == false) {
        $transaction-&gt;rollback("Cannot save wallet");
    }

    $walletTransaction = new WalletTransaction();
    $walletTransaction-&gt;setTransaction($transaction);;
    $walletTransaction-&gt;wallet_id = $wallet-&gt;id;
    $walletTransaction-&gt;amount = 5000;
    $walletTransaction-&gt;description = 'Bonus credit';

    if ($walletTransaction1-&gt;save() == false) {
        $transaction-&gt;rollback("Cannot create transaction");
    }

    $walletTransaction1 = new WalletTransaction();
    $walletTransaction1-&gt;setTransaction($transaction);
    $walletTransaction1-&gt;wallet_id = $wallet-&gt;id;
    $walletTransaction1-&gt;amount = -1800;
    $walletTransaction1-&gt;description = 'Apple store';

    if ($walletTransaction1-&gt;save() == false) {
        $transaction-&gt;rollback("Cannot create transaction");
    }

    $transaction-&gt;commit();

      } catch(TxFailed $e) {
    echo "Error: ", $e-&gt;getMessage();
      }
}</pre></div></div></div>
<div class="section" title="ODM/MongoDB"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec28"/>ODM/MongoDB</h1></div></div></div><p>We will not discuss ODM too<a id="id230" class="indexterm"/> much. It mostly supports the same actions as ORM. CRUD operations can be done in the same way as we did with ORM. Of course, we can't use transactions here, since <a id="id231" class="indexterm"/>MongoDB is not a transactional database.</p><p>Another important thing is that we need to declare the variables as public, not protected, as we did with the article model. This is the case in Phalcon version 1.3.4, but maybe in version 2.0, things will change.</p><p>A big difference is in the parameters that we pass to a <code class="literal">find()</code> method. Suppose we used something like the following code for ORM:</p><div class="informalexample"><pre class="programlisting">Article::find([
    'article_slug' =&gt; 'test-article-title'
]);</pre></div><p>For the ODM, we need to do it like this:</p><div class="informalexample"><pre class="programlisting">Article::find([
    [
        'article_slug' =&gt; 'test-article-title'
    ]
]);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>Please read <a id="id232" class="indexterm"/>more about these<a id="id233" class="indexterm"/> differences at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/odm.html">http://docs.phalconphp.com/en/latest/reference/odm.html</a> and <a class="ulink" href="http://php.net/manual/ro/mongo.sqltomongo.php">http://php.net/manual/ro/mongo.sqltomongo.php</a>.</p></div></div><p>Because we will be using MongoDB later, for now, we will just set up the connection. Open the <code class="literal">config/services.php</code> global services file, and add the following code:</p><div class="informalexample"><pre class="programlisting">$di['mongo'] = function() {
    $mongo = new MongoClient();
    return $mongo-&gt;selectDB("bitpress");
};

$di['collectionManager'] = function(){
    return new Phalcon\Mvc\Collection\Manager();
};</pre></div></div>
<div class="section" title="ORM &#x2013; drawbacks and caching"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec29"/>ORM – drawbacks and caching</h1></div></div></div><p>If you are developing a <a id="id234" class="indexterm"/>small-to-medium project, or if you are working with a big team <a id="id235" class="indexterm"/>of developers (more than three), using an ORM—in general—is a good idea. This is because firstly, it forces you to follow some rules, and secondly, the development will be much faster.</p><p>Let's take as an example the <code class="literal">SELECT * FROM article</code> query . Using a raw query, the MySQL log will return you this:</p><div class="informalexample"><pre class="programlisting">141214 23:35:53    572 Connect  root@localhost on
      572 Query  select @@version_comment limit 1
      572 Query  SELECT DATABASE()
      572 Init DB  learning_phalcon
      572 Query  SELECT * FROM article
      572 Quit</pre></div><p>By using the ORM and the <code class="literal">find()</code> method, your MySQL log will look like the following:</p><div class="informalexample"><pre class="programlisting">141214 23:37:26    490 Query  SELECT IF(COUNT(*)&gt;0, 1 , 0) FROM `INFORMATION_SCHEMA`.`TABLES` WHERE `TABLE_NAME`='article'
      490 Query  DESCRIBE `article`
      490 Query  SELECT `article`.`id`, `article`.`article_short_title`, `article`.`article_long_title`, `article`.`article_slug`, `article`.`article_description`, `article`.`is_published`, `article`.`created_at`, `article`.`updated_at` FROM `article` ORDER BY `article`.`created_at` DESC</pre></div><p>The ORM first checks <a id="id236" class="indexterm"/>whether the table exists. Then it executes the <code class="literal">describe</code> operation of the table, and after that, it executes the query we need. I am not saying that the <a id="id237" class="indexterm"/>ORM's logic is not right. I am just trying to point out the number of operations needed to finish a job. Things are quite messy when you have relations across multiple tables, and you can end up with hundreds of queries returning data for just 10 records.</p><p>To avoid querying the database server every time, we can use the automatic caching method. Phalcon accepts a parameter named <code class="literal">cache</code>, which can be passed in the <code class="literal">find()</code> method. To enable the cache, we need a <code class="literal">modelsCache</code> service. Open the <code class="literal">config/services.php</code> global services file and add the following code:</p><div class="informalexample"><pre class="programlisting">$di['modelsCache'] = $di['cache'];</pre></div><p>Now let's modify the <code class="literal">listAction</code> function from <code class="literal">modules/Backoffice/Controllers/ArticleController.php</code> by adding a cache key. The final function is as follows:</p><div class="informalexample"><pre class="programlisting">public function listAction() {
    $article_manager = $this-&gt;getDI()-&gt;get('core_article_manager');

    $articles = $article_manager-&gt;find([
        'order' =&gt; 'created_at DESC',
        'cache' =&gt; [
            'key' =&gt; 'articles',
            'lifetime' =&gt; 3600
        ]
    ]);

    $this-&gt;view-&gt;articles = $articles;
}</pre></div><p>The cache key contains two parts: <code class="literal">key</code> is the key name, and <code class="literal">lifetime</code> represents the time in seconds. That's it! For the next hour, your database will not be queried again. This is a simple example, and I recommend that you pay attention to what kind of data are you caching and for how long. Also, invalidating the cache can become a complex and very hard job. We will work on<a id="id238" class="indexterm"/> caching in the upcoming chapters, where you will be able to see more interesting things.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip13"/>Tip</h3><p>As always, please take some time to read the official documentation at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/models-cache.html">http://docs.phalconphp.com/en/latest/reference/models-cache.html</a>, so that you can learn more about caching data.</p></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec30"/>Summary</h1></div></div></div><p>In this chapter, you learned about ORM and ODM in general and how to use the main built-in methods to perform CRUD operations. You also learned about database transactions and ORM caching, and how to use PHQL or raw SQL queries.</p><p>In the next chapter, we will start developing our database architecture, and you will learn more about ORM. We will create forms and implement validations. We will also develop a CLI application to help us test our code faster.</p></div></body></html>