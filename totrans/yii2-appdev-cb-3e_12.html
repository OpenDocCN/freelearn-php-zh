<html><head></head><body><div class="chapter" id="3IE3G1-ae331331bc644dc9b658d3634f0748da" title="Chapter&#xA0;12.&#xA0;Debugging, Logging, and Error Handling"><div class="titlepage"><div><div><h1 class="title"><a id="ch12"/>Chapter 12. Debugging, Logging, and Error Handling</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Using different log routes</li><li class="listitem">Analyzing the Yii error stack trace</li><li class="listitem">Logging and using the context information</li><li class="listitem">Displaying custom errors</li><li class="listitem">Custom panel for debug extension</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec114"/>Introduction</h1></div></div></div><p>It is not possible to create a bug-free application if it is relatively complex, so developers have to detect errors and deal with them as fast as possible. Yii has a good set of utility features to handle logging and handling errors. Moreover, in the debug mode, Yii gives you a stack trace if there is an error. Using it, you can fix errors faster.</p><p>In this chapter, we will review logging, analyzing the exception stack trace, and implementing our own error handler.</p></div></div>
<div class="section" title="Using different log routes"><div class="titlepage" id="3JCK22-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch12lvl1sec115"/>Using different log routes</h1></div></div></div><p>Logging <a class="indexterm" id="id926"/>is the key to understanding what your application actually does when you have no chance to debug it. Believe it or not, even if you are 100% sure that the application will behave as expected, in production, it can do many things you were not aware of. This is OK, as no one can be aware of everything. Therefore, if we are expecting unusual behavior, we need to know about it as soon as possible and have enough details to reproduce it. This is where logging comes in handy.</p><p>Yii allows a developer not only to log messages but also to handle them differently depending on the message level and category. You can, for example, write a message to the database, send an e-mail, or just show it in the browser.</p><p>In this <a class="indexterm" id="id927"/>recipe, we will handle log messages in a wise manner: the most important message will be sent through an e-mail, less important messages will be saved in files A and B, and the profiling will be routed to Firebug. Additionally, in a development mode, all messages and profiling information will be displayed on the screen.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec407"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application by using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec408"/>How to do it...</h2></div></div></div><p>Carry out the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Configure logging using <code class="literal">config/web.php</code>:<div class="informalexample"><pre class="programlisting">'components' =&gt; [
    'log' =&gt; [
        'traceLevel' =&gt; 0,
        'targets' =&gt; [
            [
                'class' =&gt; 'yii\log\EmailTarget',
                'categories' =&gt; ['example'],
                'levels' =&gt; ['error'],
                'message' =&gt; [
                    'from' =&gt; ['log@example.com'],
                    'to' =&gt; ['developer1@example.com', 'developer2@example.com'],
                    'subject' =&gt; 'Log message',
                ],
            ],
            [
                'class' =&gt; 'yii\log\FileTarget',
                'levels' =&gt; ['error'],
                'logFile' =&gt; '@runtime/logs/error.log',
            ],
            [
                'class' =&gt; 'yii\log\FileTarget',
                'levels' =&gt; ['warning'],
                'logFile' =&gt; '@runtime/logs/warning.log',
            ],
            [
                'class' =&gt; 'yii\log\FileTarget',
                'levels' =&gt; ['info'],
                'logFile' =&gt; '@runtime/logs/info.log',
            ],
        ],
    ],

    'db' =&gt; require(__DIR__ . '/db.php'),
],</pre></div></li><li class="listitem">Now, we <a class="indexterm" id="id928"/>will produce a few log messages in <code class="literal">protected/controllers/LogController.php</code> as follows:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\controllers;

use yii\web\Controller;
use Yii;

class LogController extends Controller
{
    public function actionIndex()
    {
        Yii::trace('example trace message', 'example');
        Yii::info('info', 'example');
        Yii::error('error', 'example');
        Yii::trace('trace', 'example');
        Yii::warning('warning','example');

        Yii::beginProfile('preg_replace', 'example');
        for($i=0;$i&lt;10000;$i++){
            preg_replace('~^[ a-z]+~', '', 'test it');
        }
        Yii::endProfile('preg_replace', 'example');

        return $this-&gt;render('index');
    }
}</pre></div><p>and view views/log/index.php:</p><div class="informalexample"><pre class="programlisting">&lt;div class="log-index"&gt;
    &lt;h1&gt;Log&lt;/h1&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Now run the preceding action multiple times. On the screen, you should see the <code class="literal">Log</code> heading and a debug panel with the log messages number:<div class="mediaobject"><img alt="How to do it..." src="../Images/image00465.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">If <a class="indexterm" id="id929"/>you click on <span class="strong"><strong>17</strong></span>, you will see a web log similar to the one shown in the following screenshot:<div class="mediaobject"><img alt="How to do it..." src="../Images/image00389.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">A log contains all the messages we have logged along with stack traces, timestamps, levels, and categories.</li><li class="listitem">Now open the <span class="strong"><strong>Profiling</strong></span> page. You should see profiler messages, as shown in the following screenshot:<div class="mediaobject"><img alt="How to do it..." src="../Images/image00467.jpeg"/></div><p style="clear:both; height: 1em;"> </p><p>Profiling <a class="indexterm" id="id930"/>info displays the total executing duration of own code block.</p></li><li class="listitem">As we just changed the log file names and not the paths, you should look in <code class="literal">runtime/logs</code> to find log files named <code class="literal">error.log</code>, <code class="literal">warning.log</code>, and <code class="literal">info.log</code>.</li><li class="listitem">Inside, you will find the following messages:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2016-03-06 07:28:35 [127.0.0.1][-][-][error][example] error</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>2016-03-06 07:28:35 [127.0.0.1][-][-][warning][example] warning</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>2016-03-06 07:28:35 [127.0.0.1][-][-][info][example] inf</strong></span>
<span class="strong"><strong>o</strong></span>
</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec409"/>How it works...</h2></div></div></div><p>When one logs a message using <code class="literal">Yii::erorr</code>, <code class="literal">Yii::warning</code>, <code class="literal">Yii::info</code>, or <code class="literal">Yii::trace</code>, Yii passes it to the log router.</p><p>Depending on how it is configured, it passes messages to one or many targets, for example, e-mailing errors, writing debug information in file A, and writing warning information in file B.</p><p>The object of the <code class="literal">yii\log\Dispatcher</code> class is typically attached to an application component named log. Therefore, in order to configure it, we should set its properties in the configuration file components section. The only configurable property there is targets that contains an array of log routes and their configurations.</p><p>We have defined four log routes. Let's review them as follows:</p><div class="informalexample"><pre class="programlisting">[
    'class' =&gt; 'yii\log\EmailTarget',
    'categories' =&gt; ['example'],
    'levels' =&gt; ['error'],
    // 'mailer' =&gt; 'mailer',
    'message' =&gt; [
        'from' =&gt; ['log@example.com'],
        'to' =&gt; ['developer1@example.com', 'developer2@example.com'],
        'subject' =&gt; 'Log error,
    ],
],</pre></div><p>
<code class="literal">EmailTarget</code> sends log messages through an e-mail via the <code class="literal">Yii::$app-&gt;mailer</code> component by default. We limit category to example and level to error. An e-mail will be sent from <code class="literal">log@example.com</code> to two developers and the subject will be <code class="literal">Log error</code>:</p><div class="informalexample"><pre class="programlisting">[
    'class' =&gt; 'yii\log\FileTarget',
    'levels' =&gt; [warning],
    'logFile' =&gt; '@runtime/logs/warning.log',
],</pre></div><p>
<code class="literal">FileTarget</code> appends error messages to a specified file. We limit the message level to warning and <a class="indexterm" id="id931"/>use a file named <code class="literal">warning.log</code>. We do the same for info-level messages by using a file named <code class="literal">Info.log</code>.</p><p>Also, we can use <code class="literal">yii\log\SyslogTarget</code> to write messages into the <code class="literal">Unix /var/log/syslog</code> system file and <code class="literal">yii\log\DbTarget</code> to write logs into the database. For the second one, you must apply their migrations:</p><div class="informalexample"><pre class="programlisting">./yii migrate --migrationPath=@yii/log/migrations/</pre></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec410"/>There's more…</h2></div></div></div><p>There are more interesting things about Yii logging, which are covered in the following subsections.</p><div class="section" title="Yii::trace versus Yii::getLogger()-&gt;log"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec82"/>Yii::trace versus Yii::getLogger()-&gt;log</h3></div></div></div><p>
<code class="literal">Yii::trace</code> is <a class="indexterm" id="id932"/>a simple wrapper around <a class="indexterm" id="id933"/>
<code class="literal">Yii::log</code>:</p><div class="informalexample"><pre class="programlisting">public static function trace($message, $category = 'application')
{
    if (YII_DEBUG) {
        static::getLogger()-&gt;log($message, Logger::LEVEL_TRACE, $category);
    }
}</pre></div><p>Therefore, <code class="literal">Yii::trace</code> logs <a class="indexterm" id="id934"/>a message <a class="indexterm" id="id935"/>with a trace level, if Yii is in the <code class="literal">debug</code> mode.</p></div><div class="section" title="Yii::beginProfile and Yii::endProfile"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec83"/>Yii::beginProfile and Yii::endProfile</h3></div></div></div><p>These <a class="indexterm" id="id936"/>methods are used to measure the execution time of some part of the application's code. In our <code class="literal">LogController</code>, we measured 10,000 executions of <code class="literal">preg_replace</code> as follows:</p><div class="informalexample"><pre class="programlisting">Yii::beginProfile('preg_replace', 'example');
for($i=0;$i&lt;10000;$i++){
    preg_replace('~^[ a-z]+~', '', 'test it');
}
Yii::endProfile('preg_replace', 'example');</pre></div><p>
<code class="literal">Yii::beginProfile</code> marks the beginning of a code block for profiling. We must set a unique token <a class="indexterm" id="id937"/>for every code block and optionally specify a category:</p><div class="informalexample"><pre class="programlisting">public static function beginProfile($token, $category = 'application') { … }</pre></div><p>
<code class="literal">Yii::endProfile</code> has to be matched with a previous call to <code class="literal">beginProfile</code> with the same category name:</p><div class="informalexample"><pre class="programlisting">public static function endProfile($token, $category = 'application') { … }</pre></div><p>The <code class="literal">begin-</code> and <code class="literal">end-</code> calls must also be properly nested.</p></div><div class="section" title="Log messages immediately"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec84"/>Log messages immediately</h3></div></div></div><p>By default, Yii keeps all log messages in memory until the application is terminated. That's done for performance reasons and generally works fine.</p><p>However, if <a class="indexterm" id="id938"/>there is a console application with long running duration, log messages will not be written immediately. To make sure your messages will be logged at any moment, you can flush them explicitly using <code class="literal">Yii::$app-&gt;getLogger()&gt;flush(true)</code> or change <code class="literal">flushInterval</code> and <code class="literal">exportInterval</code> for your console application configuration:</p><div class="informalexample"><pre class="programlisting">'components' =&gt; ['log' =&gt; ['flushInterval' =&gt; 1,'targets' =&gt; [['class' =&gt; 'yii\log\FileTarget','exportInterval' =&gt; 1,],],    ],
],</pre></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec411"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">In <a class="indexterm" id="id939"/>order <a class="indexterm" id="id940"/>to learn more about logging, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-runtime-logging.html">http://www.yiiframework.com/doc-2.0/guide-runtime-logging.html</a></li><li class="listitem">The <span class="emphasis"><em>Logging and using the context information</em></span> recipe</li></ul></div></div></div>
<div class="section" id="3KB4K1-ae331331bc644dc9b658d3634f0748da" title="Analyzing the Yii error stack trace"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec116"/>Analyzing the Yii error stack trace</h1></div></div></div><p>When <a class="indexterm" id="id941"/>an error occurs, Yii can display the error stack trace along with the error. A stack trace is especially helpful when we need to know what really caused an error rather than just the fact that an error occurred.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec412"/>Getting ready</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new <code class="literal">yii2-app-basic</code> application by using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</li><li class="listitem">Configure a database and import the following migration:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\db\Migration;
class m160308_093234_create_article_table extends Migration
{
    public function up()
    {
        $this-&gt;createTable('{{%article}}', [
            'id' =&gt; $this-&gt;primaryKey(),
            'alias' =&gt; $this-&gt;string()-&gt;notNull(),
            'title' =&gt; $this-&gt;string()-&gt;notNull(),
            'text' =&gt; $this-&gt;text()-&gt;notNull(),
        ]);
    }

    public function down()
    {
        $this-&gt;dropTable('{{%article}}');
    }
}</pre></div></li><li class="listitem">Generate an <code class="literal">Article</code> model using Yii.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec413"/>How to do it...</h2></div></div></div><p>Carry <a class="indexterm" id="id942"/>out the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Now we will need to create some code to work with. Create <code class="literal">protected/controllers/ErrorController.php</code> as follows:<div class="informalexample"><pre class="programlisting">&lt;?php

namespace app\controllers;

use app\models\Article;
use yii\web\Controller;

class ErrorController extends Controller
{
    public function actionIndex()
    {
        $article = $this-&gt;findModel('php');

        return $article-&gt;title;
    }

    private function findModel($alias)
    {
        return Article::findOne(['allas' =&gt; $alias]);
    }
}</pre></div></li><li class="listitem">After running the preceding action, we should get the following error:<div class="mediaobject"><img alt="How to do it..." src="../Images/image00450.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Moreover, the stack trace shows the following error:<div class="mediaobject"><img alt="How to do it..." src="../Images/image00470.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec414"/>How it works...</h2></div></div></div><p>From the <a class="indexterm" id="id943"/>error message, we know that we have no alias column in the database, but we have used it somewhere in the code. In our case, it is very simple to find it just by searching all the project files, but in a large project, a column can be stored in a variable. Moreover, we have everything to fix an error without leaving the screen where the stack trace is displayed. We just need to read it carefully.</p><p>The stack trace displays a chain of calls in the reversed order starting with the one that caused an error. Generally, we don't need to read the whole trace to get what is going on. The framework code itself is tested well, so the probability of error is less. That is why Yii displays the application trace entries expanded and the framework trace entries collapsed.</p><p>Therefore, we take the first expanded section and look for alias. After finding it, we can immediately <a class="indexterm" id="id944"/>tell that it is used in <code class="literal">ErrorController.ph</code>
<code class="literal">p</code> on line 19.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec415"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">In <a class="indexterm" id="id945"/>order <a class="indexterm" id="id946"/>to learn more about error handling, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-runtime-handling-errors.html">http://www.yiiframework.com/doc-2.0/guide-runtime-handling-errors.html</a></li><li class="listitem">The <span class="emphasis"><em>Logging and using the context information</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Logging and using the context information"><div class="titlepage" id="3L9L62-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch12lvl1sec117"/>Logging and using the context information</h1></div></div></div><p>Sometimes <a class="indexterm" id="id947"/>a log message is not enough to fix an error. For example, if you are following best practices and developing and testing an application with all possible <a class="indexterm" id="id948"/>errors reported, you can get an error message. However, without the execution context, it is only telling you that there was an error and it is not clear what actually caused it.</p><p>For our example, we will use a very simple and poorly coded action that just echoes <code class="literal">Hello, &lt;username&gt;!</code> where the <code class="literal">username</code> is taken directly from <code class="literal">$_GET</code>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec416"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application by using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guidestart-installation.html">http://www.yiiframework.com/doc-2.0/guidestart-installation.html</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec417"/>How to do it...</h2></div></div></div><p>Carry out the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we will need a controller to work with. Therefore, create <code class="literal">protected/controllers/LogController.php</code> as follows:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\controllers;

use yii\web\Controller;

class LogController extends Controller
{
    public function actionIndex()
    {
        return 'Hello, ' . $_GET['username'];
    }
}</pre></div></li><li class="listitem">Now, if <a class="indexterm" id="id949"/>we run the index action, we will get the error <a class="indexterm" id="id950"/>message, <code class="literal">Undefined index: username</code>. Let's configure the logger to write this kind of error to a file:<div class="informalexample"><pre class="programlisting">config/web.php:

'components'=&gt;array(
    ...
    'log' =&gt; [
        'targets' =&gt; [
            [
                'class' =&gt; 'yii\log\FileTarget',
                'levels' =&gt; ['error'],
                'logFile' =&gt; '@runtime/logs/errors.log',
            ],
        ],
    ],
],</pre></div></li><li class="listitem">Run the index action again and check <code class="literal">runtime/logs/errors.log</code>. There should be log information like the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>2016-03-06 09:27:09 [127.0.0.1][-][-][error][yii\base\ErrorException:8] exception 'yii\base\ErrorException' with message 'Undefined index: username' in /controllers/LogController.php:11</strong></span>
<span class="strong"><strong>Stack trace:</strong></span>
<span class="strong"><strong>#0 /yii2/base/InlineAction.php(55): ::call_user_func_array()</strong></span>
<span class="strong"><strong>#1 /yii2/base/Controller.php(151): yii\base\InlineAction-&gt;runWithParams()</strong></span>
<span class="strong"><strong>#2 /yii2/base/Module.php(455): yii\base\Controller-&gt;runAction()</strong></span>
<span class="strong"><strong>#3 /yii2/web/Application.php(84): yii\base\Module-&gt;runAction()</strong></span>
<span class="strong"><strong>#4 /yii2/base/Application.php(375): yii\web\Application-&gt;handleRequest()</strong></span>
<span class="strong"><strong>#5 /web/index.php(12): yii\base\Application-&gt;run()</strong></span>
<span class="strong"><strong>#6 {main}</strong></span>
<span class="strong"><strong>2016-03-06 09:27:09 [127.0.0.1][-][-][info][application] $_GET = [</strong></span>
<span class="strong"><strong>    'r' =&gt; 'log/index'</strong></span>
<span class="strong"><strong>]</strong></span>

<span class="strong"><strong>$_COOKIE = [</strong></span>
<span class="strong"><strong>    '_csrf' =&gt; 'ca689043348e...a69ea:2:{i:0;s:...\"DSS...KJ\";}'</strong></span>
<span class="strong"><strong>    'PHPSESSID' =&gt; '30584oqhat4ek8b0hrqsapsbf4'</strong></span>
<span class="strong"><strong>]</strong></span>

<span class="strong"><strong>$_SERVER = [</strong></span>
<span class="strong"><strong>    'USER' =&gt; 'www-data'</strong></span>
<span class="strong"><strong>    'HOME' =&gt; '/var/www'</strong></span>
<span class="strong"><strong>    'FCGI_ROLE' =&gt; 'RESPONDER'</strong></span>
<span class="strong"><strong>    'QUERY_STRING' =&gt; 'r=log/index'</strong></span>
<span class="strong"><strong>    ...</strong></span>
<span class="strong"><strong>    'PHP_SELF' =&gt; '/index.php'</strong></span>
<span class="strong"><strong>    'REQUEST_TIME_FLOAT' =&gt; 1459934829.3067</strong></span>
<span class="strong"><strong>    'REQUEST_TIME' =&gt; 1459934829</strong></span>
<span class="strong"><strong>]</strong></span>
</pre></div></li><li class="listitem">Now <a class="indexterm" id="id951"/>we can give our application to a testing team and check the errors log from time to time. By default, error report log contain values from <a class="indexterm" id="id952"/>all the <code class="literal">$_GET</code>, <code class="literal">$_POST</code>, <code class="literal">$_FILES</code>, <code class="literal">$_COOKIE</code>, <code class="literal">$_SESSION</code>, and <code class="literal">$_SERVER</code> variables. If you do not want to display all values, you can specify a custom variable list:<div class="informalexample"><pre class="programlisting">'log' =&gt; [
    'targets' =&gt; [
        [
            'class' =&gt; 'yii\log\FileTarget',
            'levels' =&gt; ['error'],
            'logVars' =&gt; ['_GET', '_POST'],
            'logFile' =&gt; '@runtime/logs/errors.log',
        ],
    ],
],</pre></div></li><li class="listitem">In this case, the report will contain only the <code class="literal">$_GET</code> and <code class="literal">$_POST</code> arrays:<div class="informalexample"><pre class="programlisting">...
2016-04-06 09:49:08 [127.0.0.1][-][-][info][application] $_GET = [ 'r' =&gt; 'log/index'
]</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec418"/>How it works...</h2></div></div></div><p>Yii adds <a class="indexterm" id="id953"/>complete information about the execution context and environment <a class="indexterm" id="id954"/>in the case of logging error messages. If we are logging a message manually, then we probably know what information we need, so we can set some target options to write only what we really need:</p><div class="informalexample"><pre class="programlisting">'log' =&gt; [
    'targets' =&gt; [
        [
            'class' =&gt; 'yii\log\FileTarget',
            'levels' =&gt; ['error'],
            'logVars' =&gt; ['_GET', '_POST'],
            'logFile' =&gt; '@runtime/logs/errors.log',
        ],
    ],
],</pre></div><p>The <a class="indexterm" id="id955"/>preceding code will log errors to a file named errors. Additionally <a class="indexterm" id="id956"/>to a message itself, it will log contents of the <code class="literal">$_GET</code> or <code class="literal">$_POST</code> variables if they are not empty.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec419"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">In order <a class="indexterm" id="id957"/>to learn <a class="indexterm" id="id958"/>more about log filters and context information, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-runtime-logging.html">http://www.yiiframework.com/doc-2.0/guide-runtime-logging.html</a></li><li class="listitem">The <span class="emphasis"><em>Using different log routes</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Displaying custom errors"><div class="titlepage" id="3M85O2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch12lvl1sec118"/>Displaying custom errors</h1></div></div></div><p>In Yii, the <a class="indexterm" id="id959"/>error handling is very flexible, so you can create your own error handler for errors of a specific type. In this recipe, we will handle a 404 not found error in a smart way. We will show a custom 404 page that will suggest the content based on what was entered in the address bar.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec420"/>Getting ready</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new <code class="literal">yii2-app-basic</code> application by using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</li><li class="listitem">Add the fail action to your <code class="literal">SiteController</code>:<div class="informalexample"><pre class="programlisting">class SiteController extends Controller
{
    // …

    public function actionFail()
    {
        throw new ServerErrorHttpException('Error message example.');
    }
}</pre></div></li><li class="listitem">Add the <code class="literal">web/.htaccess</code> file with the following content:<div class="informalexample"><pre class="programlisting">RewriteEngine on
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . index.php</pre></div></li><li class="listitem">Configure <a class="indexterm" id="id960"/>pretty URLs for the <code class="literal">urlManager</code> component in your <code class="literal">config/web.php</code> file:<div class="informalexample"><pre class="programlisting">'components' =&gt; [
    // …
    'urlManager' =&gt; [
        'enablePrettyUrl' =&gt; true,
            'showScriptName' =&gt; false,
        ],
],</pre></div></li><li class="listitem">Check that framework displays the <code class="literal">Not found</code> exception for URLs that are not existing:<div class="mediaobject"><img alt="Getting ready" src="../Images/image00526.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Also, check that the framework displays the <code class="literal">Internal Server Error</code> exception for our <code class="literal">actionFail</code>:<div class="mediaobject"><img alt="Getting ready" src="../Images/image00472.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Now <a class="indexterm" id="id961"/>we want to create a custom page for the <code class="literal">Not</code><code class="literal"> Found</code> page. Let's start it.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec421"/>How to do it...</h2></div></div></div><p>Now we need to change the <code class="literal">Not Found</code> page content, but leave it as it is for other error types. In order to achieve this, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">SiteController</code> class and look for the <code class="literal">actions()</code> method:<div class="informalexample"><pre class="programlisting">class SiteController extends Controller
{
    // ...
    public function actions()
    {
        return [
            'error' =&gt; [
                'class' =&gt; 'yii\web\ErrorAction',
            ],
            'captcha' =&gt; [
                'class' =&gt; 'yii\captcha\CaptchaAction',
                'fixedVerifyCode' =&gt; YII_ENV_TEST ? 'testme' : null,
            ],
        ];
    }
    // ...
}</pre></div></li><li class="listitem">Remove the default <code class="literal">error</code> section and leave <code class="literal">actions()</code> as follows:<div class="informalexample"><pre class="programlisting">class SiteController extends Controller
{
    // ...
    public function actions()
    {
        return [
            'captcha' =&gt; [
                'class' =&gt; 'yii\captcha\CaptchaAction',
                'fixedVerifyCode' =&gt; YII_ENV_TEST ? 'testme' : null,
            ],
        ];
    }
    // ...
}</pre></div></li><li class="listitem">Add <a class="indexterm" id="id962"/>the own <code class="literal">actionError()</code> method:<div class="informalexample"><pre class="programlisting">class SiteController extends Controller
{
    // ...
    public function actionError()
    {
        
    }
}</pre></div></li><li class="listitem">Open the original <code class="literal">\yii\web\ErrorAction</code> class and copy its action content into our <code class="literal">actionError()</code> and customize it for the render custom <code class="literal">error-404</code> view for the <code class="literal">Not Found</code> error with the <code class="literal">404</code> code:<div class="informalexample"><pre class="programlisting">// ...
use yii\base\Exception;
use yii\base\UserException;

class SiteController extends Controller
{
    // ...
    public function actionError()
    {
        if (($exception = Yii::$app-&gt;getErrorHandler()-&gt;exception)== null) {
            $exception = new HttpException(404, Yii::t('yii', 'Page not found.'));
        }

        if ($exception instanceof HttpException) {
            $code = $exception-&gt;statusCode;
        } else {
            $code = $exception-&gt;getCode();
        }
        if ($exception instanceof Exception) {
            $name = $exception-&gt;getName();
        } else {
            $name = Yii::t('yii', 'Error');
        }
        if ($code) {
            $name .= " (#$code)";
        }

        if ($exception instanceof UserException) {
            $message = $exception-&gt;getMessage();
        } else {
            $message = Yii::t('yii', 'An internal server error occurred.');
        }

        if (Yii::$app-&gt;getRequest()-&gt;getIsAjax()) {
            return "$name: $message";
        } else {
            if ($code == 404) {
                return $this-&gt;render('error-404');
            } else {
                return $this-&gt;render('error', [
                    'name' =&gt; $name,
                    'message' =&gt; $message,
                    'exception' =&gt; $exception,
                ]);
            }
        }
    }

}</pre></div></li><li class="listitem">Add the <code class="literal">views/site/error-404.php</code> view file with a custom message:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;

/* @var $this yii\web\View */

$this-&gt;title = 'Not Found!'
?&gt;
&lt;div class="site-error-404"&gt;
    
    &lt;h1&gt;Oops!&lt;/h1&gt;
    
    &lt;p&gt;Sorry, but requested page not found.&lt;/p&gt;

    &lt;p&gt;
        Please follow to &lt;?= Html::a('index page', ['site/index'])?&gt;
        to continue reading. Thank you.
    &lt;/p&gt;

&lt;/div&gt;</pre></div></li><li class="listitem">That <a class="indexterm" id="id963"/>is it. Now try to follow to the non-existing URL and see our content from the <code class="literal">error-404.php</code> view:<div class="mediaobject"><img alt="How to do it..." src="../Images/image00423.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">However, for a fail action we must see the default content from the <code class="literal">error.php</code> file:<div class="mediaobject"><img alt="How to do it..." src="../Images/image00474.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec422"/>How it works...</h2></div></div></div><p>By default, in the <code class="literal">yii2-app-basic</code> application, we configure <code class="literal">errorAction</code> for the <code class="literal">errorHandler</code> component in our configuration file <code class="literal">config/web.php</code> as <code class="literal">site/error</code>. It means that the <a class="indexterm" id="id964"/>framework will use this route for displaying every handled exception:</p><div class="informalexample"><pre class="programlisting">'components' =&gt; [
    'errorHandler' =&gt; [
        'errorAction' =&gt; 'site/error',
    ],
],</pre></div><p>In the <code class="literal">SiteController</code> class, we use the built-in standalone <code class="literal">yii\web\ErrorAction </code>class, which renders the so-called <code class="literal">error.php</code> view:</p><div class="informalexample"><pre class="programlisting">class SiteController extends Controller
{
    // ...
    public function actions()
    {
        return [
            'error' =&gt; [
                'class' =&gt; 'yii\web\ErrorAction',
            ],
            'captcha' =&gt; [
                'class' =&gt; 'yii\captcha\CaptchaAction',
                'fixedVerifyCode' =&gt; YII_ENV_TEST ? 'testme' : null,
            ],
        ];
    }
    // ...
}</pre></div><p>If we want to override its implementation, we can replace it in an inline <code class="literal">actionError()</code> method <a class="indexterm" id="id965"/>with our own custom content.</p><p>In this recipe, we add our own <code class="literal">if</code> statement for rendering a specific view on the base of error code:</p><div class="informalexample"><pre class="programlisting">if ($code == 404) {
    return $this-&gt;render('error-404');
} else {
    return $this-&gt;render('error', [
        'name' =&gt; $name,
        'message' =&gt; $message,
        'exception' =&gt; $exception,
    ]);
}</pre></div><p>Also, we can use a custom design for the <code class="literal">Not Found</code> page.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec423"/>See also</h2></div></div></div><p>In order <a class="indexterm" id="id966"/>to learn more about handling errors in Yii, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-runtime-handling-errors.html">http://www.yiiframework.com/doc-2.0/guide-runtime-handling-errors.html</a>.</p></div></div>
<div class="section" title="Custom panel for debug extension"><div class="titlepage" id="3N6MA2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch12lvl1sec119"/>Custom panel for debug extension</h1></div></div></div><p>The <code class="literal">Yii2-debug</code> extension is a powerful tool for debugging own code, analyzing request information <a class="indexterm" id="id967"/>or database queries, and so on. Therefore, you can add your own panel for any custom report.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec424"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application by using the Composer package manager as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guidestart-installation.html">http://www.yiiframework.com/doc-2.0/guidestart-installation.html</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec425"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">panels</code> directory on the root path of your site.</li><li class="listitem">Add a new <code class="literal">UserPanel</code> class:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\panels;

use yii\debug\Panel;
use Yii;

class UserPanel extends Panel
{
    public function getName()
    {
        return 'User';
    }

    public function getSummary()
    {
        return Yii::$app-&gt;view-&gt;render('@app/panels/views/summary', ['panel' =&gt; $this]);
    }

    public function getDetail()
    {
        return Yii::$app-&gt;view-&gt;render('@app/panels/views/detail', ['panel' =&gt; $this]);
    }

    public function save()
    {
        $user = Yii::$app-&gt;user;

        return !$user-&gt;isGuest ? [
            'id' =&gt; $user-&gt;id,
            'username' =&gt; $user-&gt;identity-&gt;username,
        ] : null;
    }
}</pre></div></li><li class="listitem">Create <a class="indexterm" id="id968"/>the <code class="literal">panels/view/summary.php</code> view with the following code:<div class="informalexample"><pre class="programlisting">&lt;?php
/* @var $panel app\panels\UserPanel */
use yii\helpers\Html;
?&gt;
&lt;div class="yii-debug-toolbar__block"&gt;
    &lt;?php if (!empty($panel-&gt;data)): ?&gt;
        &lt;a href="&lt;?= $panel-&gt;getUrl() ?&gt;"&gt;
            User
            &lt;span class="yii-debug-toolbar__label yii-debug-toolbar__label_info"&gt;
                &lt;?= Html::encode($panel-&gt;data['username']) ?&gt;
            &lt;/span&gt;
        &lt;/a&gt;
    &lt;?php else: ?&gt;
        &lt;a href="&lt;?= $panel-&gt;getUrl() ?&gt;"&gt;Guest session&lt;/a&gt;
    &lt;?php endif; ?&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Add <a class="indexterm" id="id969"/>the <code class="literal">panels/view/detail.php</code> view with the following code:<div class="informalexample"><pre class="programlisting">&lt;?php
/* @var $panel app\panels\UserPanel */
use yii\widgets\DetailView;
?&gt;
&lt;h1&gt;User profile&lt;/h1&gt;
&lt;?php if (!empty($panel-&gt;data)): ?&gt;
    &lt;?= DetailView::widget([
        'model' =&gt; $panel-&gt;data,
        'attributes' =&gt; [
            'id',
            'username',
        ]
    ]) ?&gt;
&lt;?php else: ?&gt;
    &lt;p&gt;Guest session.&lt;/p&gt;
&lt;?php endif;?&gt;</pre></div></li><li class="listitem">Turn on your toolbar in the <code class="literal">config/web.php</code> configuration file:<div class="informalexample"><pre class="programlisting">if (YII_ENV_DEV) {
    $config['bootstrap'][] = 'debug';
    $config['modules']['debug'] = [
        'class' =&gt; 'yii\debug\Module',
        'panels' =&gt; [
            'views' =&gt; ['class' =&gt; 'app\panels\UserPanel'],
        ],
    ];
    $config['bootstrap'][] = 'gii';
    $config['modules']['gii'] = 'yii\gii\Module';
}</pre></div></li><li class="listitem">Reload the <code class="literal">index</code> page and look for the <span class="strong"><strong>Guest Session</strong></span> cell at the end of the debug panel:<div class="mediaobject"><img alt="How to do it..." src="../Images/image00496.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Log <a class="indexterm" id="id970"/>in to your site with the <code class="literal">admin</code> username and the <code class="literal">admin</code> password. In a success case, you must see your username in the main menu:<div class="mediaobject"><img alt="How to do it..." src="../Images/image00477.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Observe the debug panel again. Right now, you will see the <code class="literal">admin</code> username:<div class="mediaobject"><img alt="How to do it..." src="../Images/image00398.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">You can click on the username in the debug panel and see the detailed user information:<div class="mediaobject"><img alt="How to do it..." src="../Images/image00481.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec426"/>How it works...</h2></div></div></div><p>To <a class="indexterm" id="id971"/>create our own panel for the <code class="literal">yii2-debug</code> module, we need to extend the <code class="literal">yii\debug\Panel</code> class and override its template methods:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">getName()</code>: The label for menu item on debug detail page</li><li class="listitem"><code class="literal">getSummary()</code>: The debug panel cell code</li><li class="listitem"><code class="literal">getDetail()</code>: The detail page view code</li><li class="listitem"><code class="literal">save()</code>: Your information which will be saved in debug storage and load back into the <code class="literal">$panel-&gt;data</code> field</li></ul></div><p>Your object can store any debug data and display it on the summary block of panel and on the detail page.</p><p>In our example, we store user information:</p><div class="informalexample"><pre class="programlisting">public function save()
{
    $user = Yii::$app-&gt;user;
    return !$user-&gt;isGuest ? [
        'id' =&gt; $user-&gt;id,
        'username' =&gt; $user-&gt;identity-&gt;username,
    ] : null;
}</pre></div><p>Display it on summary and detail pages from the <code class="literal">$panel-&gt;data</code> field.</p><div class="section" title="Handling events"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec85"/>Handling events</h3></div></div></div><p>You <a class="indexterm" id="id972"/>can subscribe to any events of application or any <a class="indexterm" id="id973"/>component in the <code class="literal">init()</code> method. For example, the built-in <code class="literal">yii\debug\panels\MailPanel</code> panel collects and stores all sent messages:</p><div class="informalexample"><pre class="programlisting">class MailPanel extends Panel
{
    private $_messages = [];

    public function init()
    {
        parent::init();
        Event::on(
            BaseMailer::className(),
            BaseMailer::EVENT_AFTER_SEND,
            function ($event) {
                $message = $event-&gt;message;
                $messageData = [
                    // ...
                ];
                $this-&gt;_messages[] = $messageData;
            }
        );
    }

    // …

    public function save()
    {
        return $this-&gt;_messages;
    }
}</pre></div><p>Also, it displays a grid with the list of stored messages on our own detail page.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec427"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">In order <a class="indexterm" id="id974"/>to learn more about <code class="literal">yii2-debug</code> extension, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/ext-debug-index.html">http://www.yiiframework.com/doc-2.0/ext-debug-index.html</a></li><li class="listitem">For <a class="indexterm" id="id975"/>more information about creating a views counter panel, refer to <a class="ulink" href="https://github.com/yiisoft/yii2-debug/blob/master/docs/guide/topics-creating-your-own-panels.md">https://github.com/yiisoft/yii2-debug/blob/master/docs/guide/topics-creating-your-own-panels.md</a></li></ul></div></div></div></body></html>