<html><head></head><body><div class="chapter" title="Chapter&#xA0;11.&#xA0;Utility Classes and Tools"><div class="titlepage"><div><div><h1 class="title"><a id="ch11"/>Chapter 11. Utility Classes and Tools</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Working with the Set class</li><li class="listitem" style="list-style-type: disc">Manipulating strings with the String class</li><li class="listitem" style="list-style-type: disc">Sending an e-mail</li><li class="listitem" style="list-style-type: disc">Detecting file types with MagicDb</li><li class="listitem" style="list-style-type: disc">Throwing and handling exceptions</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec01"/>Introduction</h1></div></div></div><p>This chapter introduces a set of utility classes and helpful techniques that improve the architecture of a CakePHP application.</p><p>The first recipe shows how to work with a CakePHP class that optimizes the manipulation of arrays. The second recipe shows how to manipulate strings with CakePHP's<span class="strong"><strong> String</strong></span> class. The third recipe shows how to send an email using the<code class="literal"> Email</code> component. The fourth recipe shows how to use the<code class="literal"> MagicDb</code> class to detect the type of a file.</p></div></div>
<div class="section" title="Working with the Set class"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec02"/>Working with the Set class</h1></div></div></div><p>One of the most debated decisions CakePHP has ever made was returning arrays as a result of a model<code class="literal"> find</code> operation. While ORM purists may argue that each returned item should be an instance of a model class, arrays prove themselves very useful, fast, and flexible for manipulating characteristics that can be impossible to achieve with a pure object approach.<a id="id403" class="indexterm"/>
</p><p>The<code class="literal"> Set</code> class was introduced to give the developer even more power when dealing with array based data structures. With a simple method call, we can manipulate an array with ease, avoiding us the pain of having to build long and complex code blocks.<a id="id405" class="indexterm"/>
</p><p>This recipe shows how to use some of the most useful methods this class provides, while introducing other available methods that may be useful under different scenarios.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec01"/>Getting ready</h2></div></div></div><p>To go through this recipe, we need some data to work with. Create the following tables, and populate them with data, by issuing these SQL statements:<a id="id406" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `students`(
`id` INT UNSIGNED AUTO_INCREMENT NOT NULL,
`name` VARCHAR(255) NOT NULL,
PRIMARY KEY(`id`)
);
CREATE TABLE `categories`(
`id` INT UNSIGNED AUTO_INCREMENT NOT NULL,
`name` VARCHAR(255) NOT NULL,
PRIMARY KEY(`id`)
);
CREATE TABLE `exams`(
`id` INT UNSIGNED AUTO_INCREMENT NOT NULL,
`category_id` INT UNSIGNED NOT NULL,
`name` VARCHAR(255) NOT NULL,
PRIMARY KEY(`id`),
FOREIGN KEY `exams__categories`(`category_id`) REFERENCES `categories`(`id`)
);
CREATE TABLE `grades`(
`id` INT UNSIGNED AUTO_INCREMENT NOT NULL,
`student_id` INT UNSIGNED NOT NULL,
`exam_id` INT UNSIGNED NOT NULL,
`grade` FLOAT UNSIGNED NOT NULL,
PRIMARY KEY(`id`),
FOREIGN KEY `grades__students`(`student_id`) REFERENCES `students`(`id`),
FOREIGN KEY `grades__exams`(`exam_id`) REFERENCES `exams`(`id`)
);
INSERT INTO `students`(`id`, `name`) VALUES
(1, 'John Doe'),
(2, 'Jane Doe');
INSERT INTO `categories`(`id`, `name`) VALUES
(1, 'Programming Language'),
(2, 'Databases');
INSERT INTO `exams`(`id`, `category_id`, `name`) VALUES
(1, 1, 'PHP 5.3'),
(2, 1, 'C++'),
(3, 1, 'Haskell'),
(4, 2, 'MySQL'),
(5, 2, 'MongoDB');
INSERT INTO `grades`(`student_id`, `exam_id`, `grade`) VALUES
(1, 1, 10),
(1, 2, 8),
(1, 3, 7.5),
(1, 4, 9),
(1, 5, 6),
(2, 1, 7),
(2, 2, 9.5),
(2, 3, 6),
(2, 4, 10),
(2, 5, 9);
</pre></div><p>Create a controller in a file named<code class="literal"> exams_controller.php</code> and place it in your<code class="literal"> app/controllers</code> folder, with the following contents:<a id="id407" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">&lt;?php
class ExamsController extends AppController {
public function index() {
}
}
?&gt;
</pre></div><p>Create a file named<code class="literal"> exam.php</code> and place it in your<code class="literal"> app/models</code> folder, with the following contents:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class Exam extends AppModel {
public $belongsTo = array('Category');
public $hasMany = array('Grade');
}
?&gt;
</pre></div><p>Create a file named<code class="literal"> grade.php</code> and place it in your<code class="literal"> app/models</code> folder, with the following contents:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class Grade extends AppModel {
public $belongsTo = array(
'Exam',
'Student'
);
}
?&gt;
</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec02"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Edit your<code class="literal"> app/controllers/exams_controller.php</code> file and insert the following contents in its<code class="literal"> index()</code> method:<a id="id408" class="indexterm"/><div class="informalexample"><pre class="programlisting">$gradeValues = Set::extract(
$this-&gt;Exam-&gt;find('all'),
'/Grade/grade'
);
$average = array_sum($gradeValues) / count($gradeValues);
$categories = $this-&gt;Exam-&gt;Category-&gt;find('all');
$mappedCategories = Set::combine(
$categories,
'/Category/id',
'/Category/name'
);
$gradeRows = $this-&gt;Exam-&gt;Grade-&gt;find('all', array(
'recursive' =&gt; 2
));
$grades = Set::format(
$gradeRows,
'%s got a %-.1f in %s (%s)',
array(
'/Student/name',
'/Grade/grade',
'/Exam/name',
'/Exam/Category/name'
)
);
$categories = Set::map($categories);
$this-&gt;set(compact('average', 'grades', 'categories'));
</pre></div></li><li class="listitem">Create a folder named<code class="literal"> exams</code> and place it in your<code class="literal"> app/views</code> folder. Create a file named<code class="literal"> index.ctp</code> and place it in your<code class="literal"> app/views/exams</code> folder, with the following contents:<div class="informalexample"><pre class="programlisting">&lt;h2&gt;Average: &lt;strong&gt;&lt;?php echo $average; ?&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;?php foreach($grades as $string) { ?&gt;
&lt;li&gt;&lt;?php echo $string; ?&gt;&lt;/li&gt;
&lt;?php } ?&gt;
&lt;/ul&gt;
&lt;h2&gt;Categories:&lt;/h2&gt;
&lt;ul&gt;
&lt;?php foreach($categories as $category) { ?&gt;
&lt;li&gt;&lt;?php echo $category-&gt;id; ?&gt;: &lt;?php echo $category-&gt;name; ?&gt;&lt;/li&gt;
&lt;?php } ?&gt;
&lt;/ul&gt;
</pre></div></li></ol></div><p>If you now browse to <code class="literal">http://localhost/exams</code>, you should see the average grade for all exams, a detailed list of what each student got on each exam, and the list of all categories, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/1926_11_01.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec03"/>How it works...</h2></div></div></div><p>We start by using the<code class="literal"> Set::extract()</code> method to extract information out of the result obtained after fetching all rows from the<code class="literal"> Exam</code> model. The information we are interested in retrieving is the list of all grades. The<code class="literal"> extract()</code> method takes up to three arguments:<a id="id409" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">path</code>: An X-Path 2.0-compatible expression that shows the path to the information that should be extracted.<a id="id410" class="indexterm"/><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note36"/>Note</h3><p>The<code class="literal"> Set</code> class supports only a subset of the X-Path 2.0 specification. Expressions such as<code class="literal"> //</code>, which are valid in X-Path, are not available in<code class="literal"> Set</code>. Continue reading this recipe to learn what expressions are supported.</p></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">data</code>: The array data structure from which to extract the information.<a id="id411" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">options</code>: These are optional settings. At the time of this writing, only the option<code class="literal"> flatten</code> (a boolean) is available. Setting it to<code class="literal"> false</code> will return the extracted field as part of the resulting structure. Defaults to<code class="literal"> true</code>.<a id="id412" class="indexterm"/></li></ul></div><p>The<code class="literal"> path</code> argument offers a flexible approach when defining what information we are interested in. To further understand its syntax, consider the data structure that results from fetching all<code class="literal"> Exam</code> records, together with their<code class="literal"> Category</code> information, and all associated<code class="literal"> Grade</code> records:</p><div class="informalexample"><pre class="programlisting">$data = $this-&gt;Exam-&gt;find('all');
</pre></div><p>In X-Path 2.0, the path is an expression separated by the forward slash (/), while each part in that expression represents a subpath (CakePHP's<code class="literal"> Set::extract()</code> method also enforces a starting slash.) Therefore, the expression<code class="literal"> /children</code> refers to a path that includes only elements named<code class="literal"> children</code>, while the expression<code class="literal"> /children/grandchildren</code> will select items named<code class="literal"> grandchildren</code> that are descendents of items named<code class="literal"> children</code>. When we refer to the name of an item, we are referring to the key in the array structure.</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note37"/>Note</h3><p>More information about X-Path 2.0 can be obtained at <a class="ulink" href="http://www.w3.org/TR/xpath20">http://www.w3.org/TR/xpath20</a>.</p></div><p>If we intended to grab only the<code class="literal"> Exam</code> fields (thus discarding the information regarding<code class="literal"> Category</code> and<code class="literal"> Grade)</code>, we would use the following:</p><div class="informalexample"><pre class="programlisting">Set::extract('/Exam', $data);
</pre></div><p>This would return an array of elements, each element indexed by<code class="literal"> Exam</code>, and having as its value all the fields for the<code class="literal"> Exam</code> key. If we were only interested in the<code class="literal"> name</code> field, we would add another subpath to the expression:</p><div class="informalexample"><pre class="programlisting">Set::extract('/Exam/name', $data);
</pre></div><p>We can also further limit a path by adding conditional expressions. A conditional expression filters the elements (using the<code class="literal"> Set::matches()</code> method), by applying one of the typical comparison operators (<code class="literal">&lt;, &lt;=, &gt;, &gt;=, =, !=</code>) to each element that matches the path. To obtain all<code class="literal"> Grade</code> records where the value of the<code class="literal"> grade</code> field is less than<code class="literal"> 8</code>, we would use the following expression (notice how the conditional expression is applied to a subpath and is surrounded with brackets):<a id="id413" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">Set::extract('/Grade[grade&lt;8]', $data);
</pre></div><p>Instead of a comparison operator, we can use position expressions, which can be any of the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">:first</code>: Refers to the first matching element.</li><li class="listitem" style="list-style-type: disc"><code class="literal">:last</code>: Refers to the last matching element.</li><li class="listitem" style="list-style-type: disc"><code class="literal">number</code>: Refers to the element located in the position indicated by number, where<code class="literal"> number</code> is a number greater than or equal to<code class="literal"> 1</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">start:end</code>: Refers to all elements starting at position<code class="literal"> start</code>, and ending at position<code class="literal"> end</code>. Both<code class="literal"> start</code> and<code class="literal"> end</code> are numbers greater than, or equal to,<code class="literal"> 1</code>.</li></ul></div><p>To filter the data set so that only the second and third elements of all<code class="literal"> Grade</code> records are returned, using the subset of records where<code class="literal"> grade</code> is greater than or equal to<code class="literal"> 8</code>, and obtaining only the value for the<code class="literal"> grade</code> field, we would do:</p><div class="informalexample"><pre class="programlisting">Set::extract('/Grade[grade&gt;=8]/grade[2:3]', $data);
</pre></div><p>Going back to the recipe, we started by extracting only the value of the<code class="literal"> grade</code> field for each<code class="literal"> Grade</code> record. This<code class="literal"> Set::extract()</code> call returns an array of<code class="literal"> grade</code> values, so we can then use PHP's<code class="literal"> array_sum()</code> and<code class="literal"> count()</code> functions to calculate the average grading.</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note38"/>Note</h3><p>A handful of examples of the<code class="literal"> Set::extract()</code> method, and other<code class="literal"> Set</code> methods, can be obtained from its test case. Look into your CakePHP core folder for the<code class="literal"> tests/cases/libs/set.test.php</code> file and go through the different test cases.</p></div><p>We then use the<code class="literal"> Set::combine()</code> method. This method takes up to four arguments:<a id="id414" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">data</code>: The array data structure on which to operate.<a id="id415" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">path1</code>: The X-Path 2.0 path used to fetch the keys of the resulting array.<a id="id416" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">path2</code>: The X-Path 2.0 path used to fetch the values of the resulting array. If not specified, the values will be set to<code class="literal"> null</code>.<a id="id417" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">groupPath</code>: The X-Path 2.0 path to use when looking to group the resulting items so each item is a subitem of the corresponding group.<a id="id418" class="indexterm"/></li></ul></div><p>Using the<code class="literal"> /Category/id</code> expression as keys and<code class="literal"> /Category/name</code> as values, we obtain an indexed array, where the keys are the<code class="literal"> Category</code> IDs, and the values their respective<code class="literal"> Category</code> names.</p><p>The<code class="literal"> groupPath</code> argument can serve useful in many scenarios. Consider the need of obtaining the grades for all exams for a particular student, grouped by the category of the exam. Using the following:</p><div class="informalexample"><pre class="programlisting">$records = $this-&gt;Exam-&gt;Grade-&gt;find('all', array(
'conditions' =&gt; array('Student.id' =&gt; 1),
'recursive' =&gt; 2
));
$data = Set::combine(
$records,
'/Exam/name',
'/Grade/grade',
'/Exam/Category/name'
);
</pre></div><p>We would obtain what we need in an easy to navigate array:</p><div class="informalexample"><pre class="programlisting">array(
'Programming Language' =&gt; array(
'PHP 5.3' =&gt; '10',
'C++' =&gt; '8',
'Haskell' =&gt; '7.5'
),
'Databases' =&gt; array(
'MySQL' =&gt; '9',
'MongoDB' =&gt; '6'
)
)
</pre></div><p>The recipe continues by fetching all grades, and then using the<code class="literal"> Set::format()</code> method to obtain a list of formatted strings. This method takes three arguments:<a id="id419" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">data</code>: The data to format.<a id="id420" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">format</code>: The<code class="literal"> sprintf()-based</code> string that contains the format to use.<a id="id421" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">keys</code>: The array of X-Path 2.0 paths to use when replacing the<code class="literal"> sprintf()</code> conversion specifications included in<code class="literal"> format</code>.<a id="id422" class="indexterm"/><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note39"/>Note</h3><p>To learn more about the<code class="literal"> sprintf()</code> based conversion specifications see <a class="ulink" href="http://php.net/sprintf">http://php.net/sprintf</a>.</p></div></li></ul></div><p>
<code class="literal">Set::format()</code> applies the<code class="literal"> format</code> string to each item in the<code class="literal"> data</code> array, and returns an array of formatted strings. In the recipe we used the string<code class="literal"> %s</code> got<code class="literal"> a %-.1f in %s (%s)</code>. This string contains four conversion specifications: a string, a floating number (which we are forcing to only include one decimal digit), and two other strings. This means that our keys argument should contain four paths. Each of those paths will be used, in sequence to replace their corresponding conversion specification.</p><p>The recipe ends by using the<code class="literal"> Set::map()</code> method, which can be useful if you want to deal with objects, rather than arrays. This method takes two optional arguments:<a id="id423" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">class</code>: The class name to be used when creating an instance of an object. This argument is normally used to specify the data, and the<code class="literal"> tmp</code> argument is used to specify the class name.<a id="id424" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">tmp</code>: If the first argument is an array, then this argument behaves as the<code class="literal"> class</code> argument. Otherwise it is safely ignored.<a id="id425" class="indexterm"/></li></ul></div><p>Simply calling this method with the data to convert will convert that data to a set of generic object instances, recursively. If the<code class="literal"> class</code> argument is used, then the class name specified in that argument will be used when creating the respective object instances.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec04"/>There's more...</h2></div></div></div><p>The usefulness of the<code class="literal"> Set</code> class does not end here. There are several other methods that were not covered in this recipe, but can help us when developing our CakePHP applications. Some of these methods are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">merge()</code>: Acts as a combination of two PHP methods:<code class="literal"> array_merge()</code> and<code class="literal"> array_merge_recursive()</code>, allowing the proper merging of arrays when the same key exists in at least two of the arguments, and they are themselves arrays. In this case, it performs another<code class="literal"> Set::merge()</code> on those elements.<a id="id426" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">filter()</code>: Filter empty elements out of an array, leaving in real values that evaluate to empty (<code class="literal">0</code>, and<code class="literal">'0'</code>)<a id="id427" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">pushDiff()</code>: Pushes the differences from one array to another, inserting the nonexistent keys from the second argument to the first, recursively.<a id="id428" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">numeric()</code>: Determines if the elements in the array contain only numeric values.<a id="id429" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">diff()</code>: Computes and returns the different elements between two arrays.<a id="id430" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">reverse()</code>: Converts an object into an array. This method can be seen as the opposite of the<code class="literal"> Set::map()</code> method.<a id="id431" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">sort()</code>: Sorts an array by the value specified in an X-Path 2.0 compatible path.<a id="id432" class="indexterm"/></li></ul></div></div></div>
<div class="section" title="Manipulating strings with the String class"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec03"/>Manipulating strings with the String class</h1></div></div></div><p>String manipulation is probably one of PHP's biggest strengths, as it offers a handful of functions to perform a variety of operations. Even when almost every need can be fulfilled by using PHP's core methods, some forms of string manipulation may prove troublesome.<a id="id433" class="indexterm"/>
</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note40"/>Note</h3><p>To find out more about some of PHP's core string methods see <a class="ulink" href="http://php.net/manual/en/ref.strings.php">http://php.net/manual/en/ref.strings.php</a>.</p></div><p>CakePHP offers a utility class named<code class="literal"> String</code> to help us deal with strings. This recipe introduces the class and its few, yet useful set of methods.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec05"/>Getting ready</h2></div></div></div><p>We need a controller to use as placeholder for our code. Create a file named<code class="literal"> examples_controller.php</code> and place it in your<code class="literal"> app/controllers</code> folder, with the following contents:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class ExamplesController extends AppController {
public $uses = null;
public function index() {
$this-&gt;_stop();
}
?&gt;
</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec06"/>How to do it...</h2></div></div></div><p>Edit the<code class="literal"> app/controllers/examples_controller.php</code> file and add the following at the beginning of the<code class="literal"> index()</code> method:<a id="id434" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">$lines = array(
'"Doe, Jane", jane.doe@email.com',
'"Doe, John", john.doe@email.com'
);
foreach($lines as $i =&gt; $line) {
$line = String::tokenize($line, ',', '"', '"');
</pre></div><div class="informalexample"><pre class="programlisting">$line = array_combine(array('name', 'email'), $line);
foreach($line as $field =&gt; $value) {
$line[$field] = preg_replace('/^"(.+)"$/', '\\1', $value);
}
$line['id'] = String::uuid();
$lines[$i] = $line;
}
foreach($lines as $line) {
echo String::insert('[:id] Hello :name! Your email is\\: :email', $line) . '&lt;br /&gt;';
}
</pre></div><p>If you now browse to <code class="literal">http://localhost/examples</code> you should see a text output similar to the following:</p><p>
<span class="strong"><strong>[4d403ee1-6bbc-48c6-a8cc-786894a56bba] Hello Doe, Jane! Your email is: jane.doe@email.com</strong></span>
</p><p>
<span class="strong"><strong>[4d403ee1-9e84-487f-95cf-786894a56bba] Hello Doe, John! Your email is: john.doe@email.com</strong></span>
</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec07"/>How it works...</h2></div></div></div><p>The<code class="literal"> String</code> class offers the following methods for string manipulation:<a id="id435" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">cleanInsert()</code>: Cleans a string generated via the<code class="literal"> String::insert()</code> method.<a id="id436" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">insert()</code>: Replaces variable placeholders in a string with a set of values.<a id="id437" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">tokenize()</code>: Separates a string into parts using a given separator, and ignoring the separator instances that appear between the specified bound strings.<a id="id438" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">uuid()</code>: Returns a random UUID string.<a id="id439" class="indexterm"/></li></ul></div><p>This recipe starts by defining an array of two strings, each of them following a format similar to what we would find on a CSV (comma-separated values) file. For each of those lines, we use the<code class="literal"> String::tokenize()</code> method to separate the CSV line into a set of values. This method takes up to four arguments:<a id="id440" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">data</code>: The string to separate.<a id="id441" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">separator</code>: The token that separates the string. Defaults to<code class="literal"/>,.<a id="id442" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">leftBound</code>: The boundary string that indicates the start of an area where<code class="literal"> separator</code> characters should be ignored. Defaults to<code class="literal"> (</code>.<a id="id443" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">rightBound</code>: Similar to<code class="literal"> leftBound</code>, but marks the end of that area. Defaults to<code class="literal"> )</code>.<a id="id444" class="indexterm"/></li></ul></div><p>We tell<code class="literal"> String::tokenize()</code> to separate each line taking into account that any expression enclosed between quotes can include the separator character, in which case it should be ignored. We then use PHP's<code class="literal"> array_combine()</code> function so that each line becomes an associative array, indexed by field name and having as its values the corresponding field value.</p><p>As the string returned by the<code class="literal"> String::tokenize()</code> method includes the boundary strings defined in the<code class="literal"> leftBound</code> and<code class="literal"> rightBound</code> arguments if they were part of the original string, we proceed to remove them from each line.</p><p>We then add a random UUID string as the value for each line's<code class="literal"> id</code> field, using the<code class="literal"> String::uuid()</code> method. This string will be unique to each line, and should never repeat itself, even across separate requests.<a id="id445" class="indexterm"/>
</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note41"/>Note</h3><p>More information about UUIDs can be obtained at <a class="ulink" href="http://en.wikipedia.org/wiki/Universally_unique_identifier">http://en.wikipedia.org/wiki/Universally_unique_identifier</a>.</p></div><p>Finally, we go through each line and output a dynamically generated string through the<code class="literal"> String::insert()</code> method. This method takes up to three arguments:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">str</code>: String that contains the variable placeholders that should be replaced.<a id="id446" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">data</code>: Associative array in the form<code class="literal"> variable =&gt; value</code>, used to replace the variable placeholders with their respective value.<a id="id447" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">options</code>: Set of options to define how the method should behave. Available options:<a id="id448" class="indexterm"/><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">before</code>: String that indicates the start of a variable placeholder. Defaults to<code class="literal"> </code>:.<a id="id449" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">after</code>: String that indicates the end of a variable placeholder. Defaults to<code class="literal"> null</code>, which means a placeholder starts with the string defined in<code class="literal"> before</code>, and end where the word ends.<a id="id450" class="indexterm"/></li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">escape</code>: Character to use when looking to escape the string used in the<code class="literal"> before</code> option. Defaults to<code class="literal"> \</code>.<a id="id451" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">format</code>: Regular expression used to find variable placeholders.<a id="id452" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">clean</code>: If specified, it will clean the replaced string through the<code class="literal"> String::cleanInsert()</code> method. Defaults to<code class="literal"> false</code>, which means no cleaning is done.<a id="id453" class="indexterm"/></li></ul></div><p>In our example, we use the string<code class="literal"> [:id] Hello :name! Your email is\\: :email</code>. This string contains three variable placeholders:<code class="literal"> :id, :name</code>, and<code class="literal"> :email</code>. Each of those get replaced by the respective value in the associative array that is passed as the second argument to the<code class="literal"> String::insert()</code> method.</p></div></div>
<div class="section" title="Sending an e-mail"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec04"/>Sending an e-mail</h1></div></div></div><p>If there is one task we can hardly avoid when building web applications it is sending out e-mails. It is such a basic need that CakePHP provides us with a ready-to-go component that can send e-mails, either through SMTP, or using PHP's<code class="literal"> mail()</code> function.</p><p>In this recipe we will learn how to use the<code class="literal"> Email</code> component to send out e-mails through SMTP using a Google Mail account, and how to use e-mail layouts to proper render the e-mails.<a id="id454" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec08"/>Getting ready</h2></div></div></div><p>We only need some place to put our code, and that place will be a model-less controller. Create a file named<code class="literal"> emails_controller.php</code> and place it in your<code class="literal"> app/controllers</code> folder, with the following contents:<a id="id455" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">class EmailsController extends AppController {
public $uses = null;
public function index() {
$this-&gt;_stop();
}
}
</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec09"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Edit your<code class="literal"> app/controllers/emails_controller.php</code> and add the following property to the<code class="literal"> EmailsController</code> class (right below the<code class="literal"> uses</code> property declaration), replacing the<code class="literal"> username</code> and<code class="literal"> password</code> settings highlighted with your Google Mail account, and password:<div class="informalexample"><pre class="programlisting">public $components = array(
'Email' =&gt; array(
'delivery' =&gt; 'smtp',
'smtpOptions' =&gt; array(
'host' =&gt; 'ssl://smtp.gmail.com',
'port' =&gt; 465,
<span class="strong"><strong>'username' =&gt; 'email@gmail.com',
'password' =&gt; 'password'</strong></span>
)
)
);
</pre></div></li><li class="listitem">While still editing the controller, add the following code to its<code class="literal"> index()</code> method, right above the call to the<code class="literal"> _stop()</code> method (replace the<code class="literal"> to</code> property highlighted with the e-mail address where you wish to receive the test e-mail):<div class="informalexample"><pre class="programlisting">$this-&gt;Email-&gt;to = 'Destination &lt;email@gmail.com&gt;';
$this-&gt;Email-&gt;subject = 'Testing the Email component';
$sent = $this-&gt;Email-&gt;send('Hello world!');
if (!$sent) {
echo 'ERROR: ' . $this-&gt;Email-&gt;smtpError . '&lt;br /&gt;';
} else {
echo 'Email sent!';
}
</pre></div></li><li class="listitem">If you now browse to <code class="literal">http://localhost/emails</code>, you should see the message<span class="strong"><strong> Email sent!</strong></span>, and you should then receive the test e-mail message in your inbox, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/1926_11_02.jpg" alt="How to do it..."/></div><p>Let us now continue by sending an HTML e-mail, using layouts and templates.</p></li><li class="listitem">Make the following changes to the<code class="literal"> index()</code> method in your<code class="literal"> app/controllers/emails_controller.php</code> file (remember to change the highlighted<code class="literal"> to</code> property to your desired destination e-mail):<a id="id456" class="indexterm"/><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$this-&gt;set(array(
'name' =&gt; 'Mariano Iglesias',
'url' =&gt; Router::url('/', true)
));
$this-&gt;Email-&gt;to = 'Destination &lt;email@gmail.com&gt;';</strong></span>
$this-&gt;Email-&gt;subject = 'Testing the Email component';
<span class="strong"><strong>$this-&gt;Email-&gt;sendAs = 'both';
$this-&gt;Email-&gt;template = 'test';</strong></span>
$sent = $this-&gt;Email-&gt;send();
if (!$sent) {
echo 'ERROR: ' . $this-&gt;Email-&gt;smtpError . '&lt;br /&gt;';
} else {
echo 'Email sent!';
}
</pre></div></li><li class="listitem">Create a file named<code class="literal"> default.ctp</code> and place it in your<code class="literal"> app/views/layouts/email/html</code> folder with the following contents:<a id="id457" class="indexterm"/><div class="informalexample"><pre class="programlisting">&lt;html&gt;
&lt;head&gt;&lt;title&gt;&lt;?php echo $title_for_layout;?&gt;&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;?php echo $content_for_layout; ?&gt;
&lt;p&gt;&lt;small&gt;This email was sent on: &lt;?php echo date('F d, Y H:i'); ?&gt;&lt;/small&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div></li><li class="listitem">Create a file named<code class="literal"> default.ctp</code> and place it in your<code class="literal"> app/views/layouts/email/text</code> folder with the following contents:<div class="informalexample"><pre class="programlisting">&lt;?php echo $content_for_layout; ?&gt;
This email was sent on: &lt;?php echo date('F d, Y H:i'); ?&gt;
</pre></div></li><li class="listitem">Create a file named<code class="literal"> test.ctp</code> and place it in your<code class="literal"> app/views/elements/email/html</code> folder, with the following contents:<div class="informalexample"><pre class="programlisting">&lt;p&gt;Hello &lt;?php echo $name; ?&gt;!&lt;/p&gt;
&lt;p&gt;This is a test email from &lt;?php echo $this-&gt;Html-&gt;link('My Test Application', $url); ?&gt;&lt;/p&gt;
</pre></div></li><li class="listitem">Create a file named<code class="literal"> test.ctp</code> and place it in your<code class="literal"> app/views/elements/email/text</code> folder, with the following contents:<div class="informalexample"><pre class="programlisting">Hello &lt;?php echo $name; ?&gt;!
This is a test email from My Test Application: &lt;?php echo $url; ?&gt;
</pre></div></li></ol></div><p>If you now browse to <code class="literal">http://localhost/emails</code> you should see the message<span class="strong"><strong> Email sent!</strong></span>, and you should then receive the test e-mail message in your inbox in HTML format, and with a link to your web application.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec10"/>How it works...</h2></div></div></div><p>We start by adding the<code class="literal"> Email</code> component to our controller's list of components. While adding it, we set the settings required to specify the type of delivery we wish to use. The connection settings available in the<code class="literal"> Email</code> component are:<a id="id458" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">delivery</code>: It is the type of delivery to use, and can be either:<code class="literal"> mail</code> (uses PHP's<code class="literal"> mail()</code> function),<code class="literal"> smtp</code> (uses SMTP, and requires proper configuration of the<code class="literal"> smtpOptions</code> setting), and<code class="literal"> debug</code> (which tells the<code class="literal"> Email</code> component to avoid sending the e-mail, and instead create a session flash message with the message contents.)<a id="id459" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">smtpOptions</code>: If delivery is set to<code class="literal"> smtp</code>, it defines an array of settings to specify the type of SMTP connection to attempt. Available settings for this setting are:<a id="id460" class="indexterm"/><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">protocol</code>: Protocol to use when connecting. Defaults to<code class="literal"> smtp</code>.<a id="id461" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">host</code>: SMTP host to connect to. Defaults to<code class="literal"> localhost</code>.<a id="id462" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">port</code>: Port to use when connecting to<code class="literal"> host</code>. Defaults to<code class="literal"> 25</code>.<a id="id463" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">username</code>: Username.<a id="id464" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">password</code>: Password to use.<a id="id465" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">client</code>: What is the client connecting to the SMTP server. Defaults to the<code class="literal"> HTTP_HOST</code> environment variable.<a id="id466" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">timeout</code>: How many seconds to wait until the attempt to reach the server times out. Defaults to<code class="literal"> 30</code>.<a id="id467" class="indexterm"/></li></ul></div></li></ul></div><p>We set delivery to<code class="literal"> smtp</code>, and set the<code class="literal"> smtpOptions</code> to what is required when attempting to send e-mails through Google Mail's SMTP server. Once the<code class="literal"> Email</code> component is added to the controller and properly configured, we are ready to build and send e-mails.</p><p>The controller's<code class="literal"> index()</code> method builds the e-mail by setting some properties. The<code class="literal"> Email</code> component takes most of its configuration through public properties, some of which are:<a id="id468" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">to</code>: Destination, in the form:<code class="literal"> name &lt;email&gt;</code>, where<code class="literal"> email</code> is a valid e-mail address. It can also simply be an email address.<a id="id469" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">from</code>: E-mail address that is sending the e-mail. This property uses the same format as the<code class="literal"> to</code> property. Notice that if you use Google Mail's SMTP, only the name part of this setting will be used (as the e-mail address will be set to your Google Mail e-mail address.)<a id="id470" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">replyTo</code>: Email address to which responses should be sent to. Same format as the<code class="literal"> to</code> property.<a id="id471" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">return</code>: E-mail address to send any delivery errors, sent by the remote mail server. Same format as the<code class="literal"> to</code> property.<a id="id472" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">readReceipt</code>: An e-mail address (using the same format as the<code class="literal"> to</code> property) to where to send read receipt e-mails. Defaults to none.<a id="id473" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">cc</code>: An array containing the e-mail address to where to send copies of this e-mail. Each e-mail address should be specified using the same format as the<code class="literal"> to</code> property.<a id="id474" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">bcc</code>: An array containing e-mail address to send blind copies of this e-mail. Each e-mail address should be specified using the same format as the<code class="literal"> to</code> property.<a id="id475" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">subject</code>: Subject for the e-mail.<a id="id476" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">headers</code>: An array containing additional headers to send with the e-mail; each of those headers will be prefixed with<code class="literal"> X-</code> as per<code class="literal"> RFC 2822</code>.<a id="id477" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">attachments</code>: An array if paths to files that should be attached to the e-mail.<a id="id478" class="indexterm"/></li></ul></div><p>Using the<code class="literal"> to</code> and<code class="literal"> subject</code> property we specify the destination and subject of the e-mail. We did not have to define the<code class="literal"> from</code> property since Google Mail uses the account specified when connecting to the SMTP server.</p><p>We then issue a call to the<code class="literal"> send()</code> method, passing the body of the e-mail as its argument, and based on its boolean response we inform if the e-mail was successfully sent or if it failed, in which case we use the<code class="literal"> smtpError</code> property to show the error.</p><p>The next part of the recipe uses templates and layouts to properly build the e-mail in two formats: HTML, and text, and uses replacement variables to show the flexibility of the e-mail component. E-mail layouts and templates are no different than controller layouts and views, as they inherit the controller properties (such as its replacement variables, and available helpers.)<a id="id479" class="indexterm"/>
</p><p>E-mail layouts wrap the contents of e-mail templates, by means of their<code class="literal"> content_for_layout</code> variable, just as controllers layouts do. There are two types of email layouts: HTML layouts, stored in<code class="literal"> app/views/layouts/email/html</code>, and text layouts, stored in<code class="literal"> app/views/layouts/email/text</code>. Similarly, you can define templates for HTML emails by storing them in the folder<code class="literal"> app/views/elements/emails/html</code>, and text email templates in<code class="literal"> app/views/elements/emails/text</code>.</p><p>We set the layout of the e-mail through the<code class="literal"> layout</code> property of the<code class="literal"> Email</code> component. If no layout is set, the default is used. Therefore, we start by creating the HTML layout in the file<code class="literal"> app/views/layouts/email/html/default.ctp</code>, and the text layout in<code class="literal"> app/views/layouts/email/text/default.ctp</code>.</p><p>We create two versions of the same template, called<code class="literal"> test</code>: its HTML version is stored in<code class="literal"> app/views/elements/email/html/test.ctp</code>, and its text version in<code class="literal"> app/views/elements/email/html/test.ctp</code>.</p><p>The recipe continues by modifying the<code class="literal"> index()</code> action. We start by defining two replacement variables:<code class="literal"> name</code> and<code class="literal"> url</code>, which are used in the<code class="literal"> test</code> template. We then use the<code class="literal"> sendAs</code> property of the<code class="literal"> Email</code> component to say we are sending an HTML and text friendly e-mail. This property can be set to:<code class="literal"> html</code>, to send HTML only e-mails;<code class="literal"> text</code>, to send text only e-mails; and<code class="literal"> both</code>, to send emails that support HTML and text e-mail clients.</p><p>We use the<code class="literal"> template</code> property of the<code class="literal"> Email</code> component to specify that we wish to use our<code class="literal"> test</code> template, and we finalize with a call to the<code class="literal"> send()</code> method to send out the e-mail.<a id="id480" class="indexterm"/>
</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec11"/>There's more...</h2></div></div></div><p>A common mistake that web application developers make is sending out e-mails as part of a controller action that is triggered by the visitor. Strictly speaking, e-mail sending is a non-interactive task, and as such should not be tied to the user browsing experience.</p><p>It is therefore recommended that the email sending task be performed in a non-interactive manner, which in CakePHP terms means from the console, also known as shell.</p><p>To exemplify this solution, consider a subscription website, where users enter their information (including their e-mail address), and, as a result, the application sends out a confirmation e-mail. Instead of sending the e-mail as part of the controller action that is triggered from the submission form, we may set a database field that shows that those users have not yet been sent out the confirmation e-mail, and then have a CakePHP shell periodically check for users that need their confirmation e-mails, sending out those e-mails from the shell.</p><p>This means that we find ourselves needing to be able to send e-mails from the shell, a topic covered in the recipe<span class="emphasis"><em> Sending e-mails from shells</em></span> in <a class="link" href="ch08.html" title="Chapter 8. Working with Shells">Chapter 8</a>,</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec12"/>See also</h2></div></div></div><p>
<span class="emphasis"><em>Sending e-mails from shells</em></span> in <a class="link" href="ch08.html" title="Chapter 8. Working with Shells">Chapter 8</a>, <span class="emphasis"><em>Working with Shells</em></span>.</p></div></div>
<div class="section" title="Detecting file types with MagicDb"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec05"/>Detecting file types with MagicDb</h1></div></div></div><p>When handling file uploads, it is often important to determine the type of file being uploaded. While some files may be easily recognizable based on their contents, others may prove to be hard to identify.<a id="id481" class="indexterm"/>
</p><p>
<code class="literal">MagicDb</code> is a file database that consists of specifications for several file formats. This recipe shows us how to use this database, through CakePHP's<code class="literal"> MagicDb</code> class, to properly identify files uploaded by our users.<a id="id482" class="indexterm"/>
</p><p>The license for the<code class="literal"> MagicDb</code> database file allows its use only on open source or freely available software. If you wish to identify files on commercial applications, you will have to find a different approach.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec13"/>Getting ready</h2></div></div></div><p>As we will be working on files uploaded by our users, we need to build a form to upload files. We will store these uploads in a table, so create this table with the following SQL statement:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `uploads`(
`id` INT UNSIGNED AUTO_INCREMENT NOT NULL,
`file` VARCHAR(255) NOT NULL,
`mime` VARCHAR(255) default NULL,
`description` TEXT default NULL,
PRIMARY KEY(`id`)
);
</pre></div><p>Create a file named<code class="literal"> uploads_controller.php</code> and place it in your<code class="literal"> app/controllers</code> folder, with the following contents:</p><div class="informalexample"><pre class="programlisting">class UploadsController extends AppController {
public function add() {
if (!empty($this-&gt;data)) {
$this-&gt;Upload-&gt;create();
if ($this-&gt;Upload-&gt;save($this-&gt;data)) {
$this-&gt;Session-&gt;setFlash('File succesfully uploaded');
$this-&gt;redirect(array('action'=&gt;'view', $this-&gt;Upload-&gt;id));
} else {
$this-&gt;Session-&gt;setFlash('Please correct the errors marked below');
}
}
}
}
</pre></div><p>Create a folder named<code class="literal"> uploads</code> in your<code class="literal"> app/views</code> folder. Create the view for the<code class="literal"> add()</code> method in a file named<code class="literal"> add.ctp</code> and place it in your<code class="literal"> app/views/uploads</code> folder, with the following contents:<a id="id483" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">&lt;?php
echo $this-&gt;Form-&gt;create('Upload', array('type'=&gt;'file'));
echo $this-&gt;Form-&gt;inputs(array(
'file' =&gt; array('type'=&gt;'file')
));
echo $this-&gt;Form-&gt;end('Upload');
?&gt;
</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec14"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download the latest MagicDb database file from <a class="ulink" href="http://www.magicdb.org/magic.db">http://www.magicdb.org/magic.db</a> and place it in your<code class="literal"> app/vendors</code> folder. You should now have a file named<code class="literal"> magic.db</code> in your<code class="literal"> app/vendors</code> folder.<a id="id484" class="indexterm"/></li><li class="listitem">Edit your<code class="literal"> app/controllers/uploads_controller.php</code> file and add the following methods right below the<code class="literal"> add()</code> method:<div class="informalexample"><pre class="programlisting">public function view($id) {
$upload = $this-&gt;Upload-&gt;find('first', array(
'conditions' =&gt; array('Upload.id' =&gt; $id)
));
if (empty($upload)) {
$this-&gt;cakeError('error404');
}
$this-&gt;set(compact('upload'));
}
public function download($id) {
$upload = $this-&gt;Upload-&gt;find('first', array(
'conditions' =&gt; array('Upload.id' =&gt; $id)
));
if (empty($upload)) {
$this-&gt;cakeError('error404');
}
$path = TMP . $upload['Upload']['file'];
header('Content-type: '.$upload['Upload']['mime']);
readfile($path);
$this-&gt;_stop();
}
</pre></div></li><li class="listitem">Create the view for the<code class="literal"> view()</code> method in a file named<code class="literal"> view.ctp</code> and place it in your<code class="literal"> app/views/uploads</code> folder with the following contents:<div class="informalexample"><pre class="programlisting">&lt;h2&gt;&lt;?php echo $upload['Upload']['file']; ?&gt;&lt;/h2&gt;
&lt;p&gt;
&lt;strong&gt;File&lt;/strong&gt;: &lt;?php echo $upload['Upload']['file']; ?&gt;&lt;br /&gt;
&lt;strong&gt;MIME Type&lt;/strong&gt;: &lt;?php echo $upload['Upload']['mime']; ?&gt;&lt;br /&gt;
&lt;strong&gt;Description&lt;/strong&gt;: &lt;?php echo $upload['Upload']['description']; ?&gt;
&lt;/p&gt;
&lt;br /&gt;
&lt;p&gt;
&lt;?php if (strpos($upload['Upload']['mime'], 'image/') === 0) { ?&gt;
&lt;?php echo $this-&gt;Html-&gt;image(array('action'=&gt;'download', $upload['Upload']['id']), array('height'=&gt;200)); ?&gt;
&lt;?php } else { ?&gt;
&lt;?php echo $this-&gt;Html-&gt;link('Download', array('action'=&gt;'download', $upload['Upload']['id'])); ?&gt;
&lt;?php } ?&gt;
&lt;/p&gt;
</pre></div></li><li class="listitem">Create the model in a file named<code class="literal"> upload.php</code> and place it in your<code class="literal"> app/models</code> folder with the following contents:<a id="id485" class="indexterm"/><div class="informalexample"><pre class="programlisting">&lt;?php
class Upload extends AppModel {
protected $magicDb;
protected function getMagicDb() {
if (!isset($this-&gt;magicDb)) {
App::import('Core', 'MagicDb');
$magicDb = new MagicDb();
if (!$magicDb-&gt;read(APP . 'vendors' . DS . 'magic.db')) {
return null;
}
$this-&gt;magicDb = $magicDb;
}
return $this-&gt;magicDb;
}
}
?&gt;
</pre></div></li><li class="listitem">While still editing your<code class="literal"> app/models/upload.php</code> file, add the following method to the<code class="literal"> Upload</code> class:<div class="informalexample"><pre class="programlisting">public function beforeValidate($options = array()) {
$result = parent::beforeValidate($options);
$data = $this-&gt;data[$this-&gt;alias];
if (!empty($data['file'])) {
if (
empty($data['file']) ||
!is_array($data['file']) ||
empty($data['file']['tmp_name']) ||
!is_uploaded_file($data['file']['tmp_name'])
) {
$this-&gt;invalidate('file', 'No file uploaded');
return false;
}
$magicDb = $this-&gt;getMagicDb();
if (!isset($magicDb)) {
$this-&gt;invalidate('file', 'Can\'t get instance of MagicDb');
return false;
}
$path = TMP . $data['file']['name'];
if (!move_uploaded_file($data['file']['tmp_name'], $path)) {
$this-&gt;invalidate('file', 'Could not move uploaded file');
return false;
}
$data['file'] = basename($path);
unset($data['mime']);
$analysis = $magicDb-&gt;analyze($path);
if (!empty($analysis)) {
$analysis = $analysis[0];
if (preg_match('/^\[.+?;ext=[^;]+;mime=([^;]+);.*?\](.*)$/i', $analysis[3], $match)) {
$data['mime'] = $match[1];
if (empty($data['description'])) {
$data['description'] = $match[2];
}
}
}
if (empty($data['mime'])) {
$this-&gt;invalidate('Can\'t recognize file '.$data['file']);
return false;
}
$this-&gt;data[$this-&gt;alias] = $data;
} else {
$this-&gt;invalidate('file', 'This field is required');
return false;
}
return $result;
}
</pre></div></li></ol></div><p>If you now browse to <code class="literal">http://localhost/uploads/add</code>, you will see a form where you can select a file, and then click the button<span class="strong"><strong> Upload</strong></span>. Doing so with a GIF image will produce a result similar to what shown in the following screenshot:<a id="id486" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/1926_11_03.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec15"/>How it works...</h2></div></div></div><p>The recipe starts by downloading the<code class="literal"> MagicDb</code> file and placing it into the<code class="literal"> app/vendors</code> directory. This file is a text file; containing blocks of identifier file signatures, and for each of these file signature definitions, their respective mime type, and description.</p><p>Next, we create the<code class="literal"> view()</code> and<code class="literal"> download()</code> controller actions. Both of them are very similar, except that the<code class="literal"> download()</code> action uses the field<code class="literal"> mime</code> to set the<code class="literal"> Content-type</code> header, thus properly informing the client browser the type of data being sent.</p><p>The<code class="literal"> download()</code> action simply sends the contents of the file by using PHP's<code class="literal"> readfile()</code> function, then calling the<code class="literal"> _stop()</code> method (available to all CakePHP classes that descend from<code class="literal"> Object)</code> to stop execution. The<code class="literal"> view()</code> action, on the other hand, requires a view, which prints out the<code class="literal"> Upload</code> record information, showing an image if the file is indeed an image, or showing a link to download the file, in any other case.</p><p>The<code class="literal"> Upload</code> model defines two methods:<code class="literal"> beforeValidate()</code>, and<code class="literal"> getMagicDb()</code>. The second method creates an instance of the<code class="literal"> MagicDb</code> class provided by CakePHP, populating it with the contents from the<code class="literal"> magic.db</code> file that was saved in the<code class="literal"> app/vendors</code> directory.<a id="id487" class="indexterm"/>
</p><p>The validation callback<code class="literal"> beforeValidate()</code> starts by making sure that a proper file was uploaded. If so, it moves the uploaded file to the application's temporary directory, and then uses the<code class="literal"> analyze()</code> method of the<code class="literal"> MagicDb</code> class to obtain the file information.</p><p>This method will return an empty array if the file was not identified, or a set of file identifications that match the file. These file identifications are themselves arrays, containing information that is defined in the<code class="literal"> magic.db</code> file. The fourth element out of this array contains the information we are looking for: a string that includes the file extension, the mime type, and the file type description.</p><p>We extract this information, and we set it so it is saved together with the filename. If the file was not identified, we invalidate the<code class="literal"> file</code> field.</p></div></div>
<div class="section" title="Throwing and handling exceptions"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec06"/>Throwing and handling exceptions</h1></div></div></div><p>CakePHP 1.3 still offers support for PHP4, yet most CakePHP applications are built exclusively for PHP5. Therefore, it is only expected that our applications use language features only available in PHP5, such as exceptions.<a id="id488" class="indexterm"/>
</p><p>However, there is no built-in support in CakePHP to handle exceptions. This recipe shows us how to create a base exception class that can be used throughout our application, and how to properly recover the application workflow after an exception is thrown.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec16"/>Getting ready</h2></div></div></div><p>We need a basic application skeleton to work with. Follow the entire recipe<span class="emphasis"><em> Detecting file types with MagicDb</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec17"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Edit your<code class="literal"> app/controllers/uploads_controller.php</code> file and change the<code class="literal"> view()</code> and<code class="literal"> download()</code> methods, so that where it reads:<a id="id489" class="indexterm"/><div class="informalexample"><pre class="programlisting">$this-&gt;cakeError('error404');
</pre></div><p>It now reads:
</p><div class="informalexample"><pre class="programlisting">throw new AppException('Upload '.$id.' not found');
</pre></div></li><li class="listitem">Create a file named<code class="literal"> app_exception.php</code> and place it in your<code class="literal"> app/</code> folder, with the following contents:<div class="informalexample"><pre class="programlisting">&lt;?php
class AppException extends Exception {
public function getInfo() {
return array(
'message' =&gt; $this-&gt;getMessage(),
'trace' =&gt; $this-&gt;getStackTrace(),
'url' =&gt; Router::url(null, true),
'method' =&gt; env('REQUEST_METHOD'),
'referer' =&gt; env('HTTP_REFERER'),
'POST' =&gt; $_POST,
'GET' =&gt; $_GET,
'SESSION' =&gt; $_SESSION
);
}
public function getStackTrace($array = true, $count = 5) {
if ($array) {
$trace = $this-&gt;getTrace();
if (!empty($count)) {
$trace = array_slice($trace, 0, $count);
}
foreach($trace as $i =&gt; $row) {
$location = '';
if (!empty($row['class'])) {
$location .= $row['class'] . $row['type'] . $row['function'] . '()';
}
$file = !empty($row['file']) ? str_replace(ROOT.DS, '', $row['file']) : '';
if (!empty($file)) {
if (!empty($location)) {
$location .= ' (' . $file . '@' . $row['line'] . ')';
} else {
$location .= $file . '@' . $row['line'];
}
}
$trace[$i]['location'] = $location;
unset($trace[$i]['args']);
}
return $trace;
}
return $this-&gt;getTraceAsString();
}
}
?&gt;
</pre></div></li><li class="listitem">Create a file named<code class="literal"> exception_handler.php</code> and place it in your<code class="literal"> app/libs</code> folder, with the following contents:<a id="id490" class="indexterm"/><div class="informalexample"><pre class="programlisting">&lt;?php
App::import(array('type'=&gt;'File', 'name'=&gt;'AppException', 'file'=&gt;APP.'app_exception.php'));
App::import('Core', 'Controller');
class ExceptionHandler extends Object {
public static function handleException($exception) {
self::getInstance();
self::logException($exception);
self::renderException($exception);
self::_stop();
}
}
</pre></div></li><li class="listitem">While still editing your<code class="literal"> app/libs/exception_handler.php</code> file, add the following methods to the<code class="literal"> ExceptionHandler</code> class:<div class="informalexample"><pre class="programlisting">public function renderException($exception) {
$Dispatcher = new Dispatcher();
$Controller = new Controller();
$Controller-&gt;params = array(
'controller' =&gt; 'exceptions',
'action' =&gt; 'exception'
);
$Controller-&gt;viewPath = 'exceptions';
if (file_exists(VIEWS.'layouts'.DS.'exception.ctp')) {
$Controller-&gt;layout = 'exception';
}
$Controller-&gt;base = $Dispatcher-&gt;baseUrl();
$Controller-&gt;webroot = $Dispatcher-&gt;webroot;
$Controller-&gt;set(compact('exception'));
$View = new View($Controller);
if (!file_exists(VIEWS.'exceptions'.DS.'view.ctp')) {
if (Configure::read('debug') &gt; 0) {
echo '&lt;strong&gt;Exception&lt;/strong&gt;: ';
echo $exception-&gt;getMessage();
echo '&lt;pre&gt;';
echo $exception-&gt;getStackTrace(false);
echo '&lt;/pre&gt;';
return;
}
return $Controller-&gt;redirect(null, 500);
}
echo $View-&gt;render('view');
}
public function logException($exception) {
$trace = $exception-&gt;getStackTrace();
$message = get_class($exception) . ' thrown in ' . $trace[0]['location'];
$message .= ': ' . $exception-&gt;getMessage();
if (is_a($exception, instanceof AppException)) {
$message .= ' | DEBUG: ' . json_encodevar_export($exception-&gt;getInfo(), true); }
self::log($message, LOG_ERROR);
}
</pre></div></li><li class="listitem">Add the following at the end of your<code class="literal"> app/config/bootstrap.php</code> file (right above the closing PHP tag):<div class="informalexample"><pre class="programlisting">App::import('Lib', 'ExceptionHandler');
set_exception_handler(array('ExceptionHandler', 'handleException'));
</pre></div></li><li class="listitem">Create a folder named<code class="literal"> exceptions</code> in your<code class="literal"> app/views</code> folder. Create a file named<code class="literal"> view.ctp</code> and place it in your<code class="literal"> app/views/exceptions</code> folder, with the following contents:<div class="informalexample"><pre class="programlisting">&lt;h2&gt;&lt;?php echo $exception-&gt;getMessage(); ?&gt;&lt;/h2&gt;
&lt;?php if (Configure::read('debug') &gt; 0) { ?&gt;
&lt;ol&gt;
&lt;?php foreach($exception-&gt;getStackTrace() as $trace) { ?&gt;
&lt;li&gt;&lt;?php echo $trace['location']; ?&gt;&lt;/li&gt;
&lt;?php } ?&gt;
&lt;/ol&gt;
&lt;?php if (is_a($exception, 'AppException')) { ?&gt;
&lt;?php debug(array_diff_key($exception-&gt;getInfo(), array('message'=&gt;null, 'trace'=&gt;null))); ?&gt;
&lt;?php } ?&gt;
&lt;?php } else { ?&gt;
&lt;p&gt;An error has been found. It has been logged, and will soon be fixed.&lt;/p&gt;
&lt;?php } ?&gt;
</pre></div></li></ol></div><p>If you now force an error by browsing to <code class="literal">http://localhost/uploads/view/xx</code>, you will see a page describing the exception, its stack trace, and including relevant information, such as the URL, any POST or GET parameters, and session information, as shown in the following screenshot:<a id="id491" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/1926_11_04.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec18"/>How it works...</h2></div></div></div><p>We start by using exceptions in our<code class="literal"> UploadsController</code> class, instead of using CakePHP's<code class="literal"> cakeError()</code> method, whenever an<code class="literal"> Upload</code> record is not found. These exceptions are actually instances of<code class="literal"> AppException</code>, but we could have as well created custom exceptions that inherit from<code class="literal"> AppException</code>.<a id="id492" class="indexterm"/>
</p><p>The<code class="literal"> AppException</code> class provides us with a base class from where to extend our application exceptions. This class offers us more contextual information through its<code class="literal"> getInfo()</code> method. This information includes not only the exception message and the stack trace (which is simplified by removing the arguments, and limiting the number of items), but also the URL, method, any POST or GET data, and session information, details that can become valuable when working out the exception.</p><p>We still have to add the ability to handle any exceptions that are thrown. For that purpose, we create the<code class="literal"> ExceptionHandler</code> class. Through the code added to the<code class="literal"> app/config/bootstrap.php</code> file, which uses PHP's<code class="literal"> set_exception_handler()</code> function, we tell PHP that whenever an exception is thrown and not caught anywhere, the static<code class="literal"> handleException()</code> method of the<code class="literal"> ExceptionHandler</code> class is to be executed.</p><p>This method logs the exception, using the<code class="literal"> logException()</code> method, and renders a friendly page by calling the<code class="literal"> renderException()</code> method. This rendering is performed by creating a dummy controller as an instance of<code class="literal"> Controller</code>, using this controller to render the view<code class="literal"> app/views/exceptions.ctp</code> (optionally using a layout named<code class="literal"> exception.ctp</code> if one is available in<code class="literal"> app/views/exceptions</code>), and setting the view variable<code class="literal"> exception</code> to the exception being handled.</p><p>This view shows a simple message if the debug level is set to<code class="literal"> 0</code>, or a thorough description of the stack trace and any context information that may be relevant.</p></div></div></body></html>