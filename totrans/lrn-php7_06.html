<html><head></head><body>
<div class="book" title="Keys and constraints">
<div class="book" title="Indexes"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec78" class="calibre1"/>Indexes</h2></div></div></div><p class="calibre8">Indexes, which are a <a id="id417" class="calibre1"/>synonym for keys, are fields that do not need any special behavior as do the rest of the keys but they are important enough in our queries. So, we will ask MySQL to do some work with them in order to perform better when querying by this field. Do you remember when adding a foreign key that MySQL added extra keys to the table? Those were indexes too.</p><p class="calibre8">Think about how the application will use the database. We want to show the catalog of books to our customers, but we cannot show all of them at once for sure. The customer will want to filter the results, and one of the most common ways of filtering is by specifying the title of the book that they are looking for. From this, we can extract that the title will be used to filter books quite often, so we want to add an index to this field. Let's add the index via the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; ALTER TABLE book ADD INDEX (title);</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 0 rows affected (0.01 sec)</strong></span>
<span class="strong"><strong class="calibre2">Records: 0  Duplicates: 0  Warnings: 0</strong></span>
</pre></div><p class="calibre8">Remember that all other keys also provide indexing. IDs of books, customers and sales, ISBNs, and e-mails are already indexed, so there is no need to add another index here. Also, try not to add indexes to every single field as in doing so you will be <a id="id418" class="calibre1"/>
<span class="strong"><strong class="calibre2">overindexing</strong></span>, which would make some types of queries even slower than if they were <a id="id419" class="calibre1"/>without indexes!</p></div></div>
<div class="book" title="Inserting data" id="1DOR01-edcc22b134104d5db0bf3aa086c86851"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec42" class="calibre1"/>Inserting data</h1></div></div></div><p class="calibre8">We have created the <a id="id420" class="calibre1"/>perfect tables to hold our data, but so far they are empty. It is time that we populate them. We delayed this moment as altering tables with data is more difficult than when they are empty.</p><p class="calibre8">In order to insert this data, we will use the <code class="email">INSERT INTO</code> command. This command will take the name of the table, the fields that you want to populate, and the data for each field. Note that you can choose not to specify the value for a field, and there are different reasons to do this, which are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The field has a default value, and we are happy using it for this specific row</li><li class="listitem">Even though the field does not have an explicit default value, the field can take null values; so, by not specifying the field, MySQL will automatically insert a null here</li><li class="listitem">The field is a primary key and is autoincremental, and we want to let MySQL take the next ID for us</li></ul></div><p class="calibre8">There are different reasons that can cause an <code class="email">INSERT INTO</code> command to fail:</p><div class="book"><ul class="itemizedlist"><li class="listitem">If you do not specify the value of a field and MySQL cannot provide a valid default value</li><li class="listitem">If the value provided is not of the type of the field and MySQL fails to find a valid conversion</li><li class="listitem">If you specify that you want to set the value for a field but you fail to provide a value</li><li class="listitem">If you provide a foreign key with an ID but the ID does not exist in the referenced table</li></ul></div><p class="calibre8">Let's take a look at how to add rows. Let's start with our <code class="email">customer</code> table, adding one <code class="email">basic</code> and one <code class="email">premium</code>, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; INSERT INTO customer (firstname, surname, email, type)</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; VALUES ("Han", "Solo", "han@tatooine.com", "premium");</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 1 row affected (0.00 sec)</strong></span>

<span class="strong"><strong class="calibre2">mysql&gt; INSERT INTO customer (firstname, surname, email, type)</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; VALUES ("James", "Kirk", "enter@prise", "basic");</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 1 row affected (0.00 sec)</strong></span>
</pre></div><p class="calibre8">Note that MySQL shows you some return information; in this case, it shows that there was one row affected, which is the row that we inserted. We did not provide an ID, so MySQL just added the next ones in the list. As it is the first time that we are adding data, MySQL used the IDs 1 and 2.</p><p class="calibre8">Let's try to trick MySQL and add another customer, repeating the e-mail address field that we set as unique in the previous section:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; INSERT INTO customer (firstname, surname, email, type)</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; VALUES ("Mr", "Spock", "enter@prise", "basic");</strong></span>
<span class="strong"><strong class="calibre2">ERROR 1062 (23000): Duplicate entry 'enter@prise' for key 'email'</strong></span>
</pre></div><p class="calibre8">An error is returned <a id="id421" class="calibre1"/>with an error code and an error message, and the row was not inserted, of course. The error message usually contains enough information in order to understand the issue and how to fix it. If this is not the case, we can always try to search on the Internet using the error code and note what either the official documentation or other users have to say about it.</p><p class="calibre8">In case you need to introduce multiple rows to the same table and they contain the same fields, there is a shorter version of the command, in which you can specify the fields and then provide the groups of values for each row. Let's take a look at how to use it when adding books to our <code class="email">book</code> table, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; INSERT INTO book (isbn,title,author,stock,price) VALUES</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ("9780882339726","1984","George Orwell",12,7.50),</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ("9789724621081","1Q84","Haruki Murakami",9,9.75),</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ("9780736692427","Animal Farm","George Orwell",8,3.50),</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ("9780307350169","Dracula","Bram Stoker",30,10.15),</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ("9780753179246","19 minutes","Jodi Picoult",0,10);</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 5 rows affected (0.01 sec)</strong></span>
<span class="strong"><strong class="calibre2">Records: 5  Duplicates: 0  Warnings: 0</strong></span>
</pre></div><p class="calibre8">As with customers, we will not specify the ID and let MySQL choose the appropriate one. Note also that now the amount of affected rows is <code class="email">5</code> as we inserted five rows.</p><p class="calibre8">How can we take advantage of the explicit defaults that we defined in our tables? Well, we can do this in the same way as we did with the primary keys: do not specify them in the fields list or in the values list, and MySQL will just use the default value. For example, we defined a default value of <code class="email">1</code> for our <code class="email">book.stock</code> field, which is a useful notation for the <code class="email">book</code> table and the <code class="email">stock</code> field. Let's add another row using this default, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; INSERT INTO book (isbn,title,author,price) VALUES</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ("9781416500360", "Odyssey", "Homer", 4.23);</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 1 row affected (0.00 sec)</strong></span>
</pre></div><p class="calibre8">Now that we have books and customers, let's add some historic data about customers borrowing books. For <a id="id422" class="calibre1"/>this, use the numeric IDs from <code class="email">book</code> and <code class="email">customer</code>, as in the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; INSERT INTO borrowed_books(book_id,customer_id,start,end)</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; VALUES</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; (1, 1, "2014-12-12", "2014-12-28"),</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; (4, 1, "2015-01-10", "2015-01-13"),</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; (4, 2, "2015-02-01", "2015-02-10"),</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; (1, 2, "2015-03-12", NULL);</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 3 rows affected (0.00 sec)</strong></span>
<span class="strong"><strong class="calibre2">Records: 3  Duplicates: 0  Warnings: 0</strong></span>
</pre></div></div>
<div class="book" title="Querying data"><div class="book" id="1ENBI2-edcc22b134104d5db0bf3aa086c86851"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec43" class="calibre1"/>Querying data</h1></div></div></div><p class="calibre8">It took quite a lot of<a id="id423" class="calibre1"/> time, but we are finally in the most exciting—and useful—section related to databases: querying data. Querying data refers to asking MySQL to return rows from the specified table and optionally filtering these results by a set of rules. You can also choose to get specific fields instead of the whole row. In order to query data, we will use the <code class="email">SELECT</code> command, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SELECT firstname, surname, type FROM customer;</strong></span>
<span class="strong"><strong class="calibre2">+-----------+---------+---------+</strong></span>
<span class="strong"><strong class="calibre2">| firstname | surname | type    |</strong></span>
<span class="strong"><strong class="calibre2">+-----------+---------+---------+</strong></span>
<span class="strong"><strong class="calibre2">| Han       | Solo    | premium |</strong></span>
<span class="strong"><strong class="calibre2">| James     | Kirk    | basic   |</strong></span>
<span class="strong"><strong class="calibre2">+-----------+---------+---------+</strong></span>
<span class="strong"><strong class="calibre2">2 rows in set (0.00 sec)</strong></span>
</pre></div><p class="calibre8">One of the simplest ways to query data is to specify the fields of interest after <code class="email">SELECT</code> and specify the table with the <code class="email">FROM</code> keyword. As we did not add any filters—mostly known as conditions—to the query, we got all the rows there. Sometimes, this is the desired behavior, but the most common thing to do is to add conditions to the query to retrieve only the rows that we need. Use the <code class="email">WHERE</code> keyword to achieve this.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SELECT firstname, surname, type FROM customer</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; WHERE id = 1;</strong></span>
<span class="strong"><strong class="calibre2">+-----------+---------+---------+</strong></span>
<span class="strong"><strong class="calibre2">| firstname | surname | type    |</strong></span>
<span class="strong"><strong class="calibre2">+-----------+---------+---------+</strong></span>
<span class="strong"><strong class="calibre2">| Han       | Solo    | premium |</strong></span>
<span class="strong"><strong class="calibre2">+-----------+---------+---------+</strong></span>
<span class="strong"><strong class="calibre2">1 row in set (0.00 sec)</strong></span>
</pre></div><p class="calibre8">Adding conditions is very similar to when we created Boolean expressions in PHP. We will specify the name of the field, an operator, and a value, and MySQL will retrieve only the rows that return <code class="email">true</code> to this expression. In this case, we asked for the customers that had the ID 1, and MySQL returned one row: the one that had an ID of exactly 1.</p><p class="calibre8">A common query <a id="id424" class="calibre1"/>would be to get the books that start with some text. We cannot construct this expression with any comparison operand that you know, such as <code class="email">=</code> and <code class="email">&lt;</code> or <code class="email">&gt;</code>, since we want to match only a part of the string. For this, MySQL has the <code class="email">LIKE</code> operator, which takes a string that can contain wildcards. A wildcard is a character that represents a rule, matching any number of characters that follows the rule. For example, the <code class="email">%</code> wildcard represents any number of characters, so using the <code class="email">1%</code> string would match any string that starts with 1 and is followed by any number or characters, matching strings such as <code class="email">1984</code> or <code class="email">1Q84</code>. Let's consider the following example:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SELECT title, author, price FROM book</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; WHERE title LIKE "1%";</strong></span>
<span class="strong"><strong class="calibre2">+------------+-----------------+-------+</strong></span>
<span class="strong"><strong class="calibre2">| title      | author          | price |</strong></span>
<span class="strong"><strong class="calibre2">+------------+-----------------+-------+</strong></span>
<span class="strong"><strong class="calibre2">| 1984       | George Orwell   |   7.5 |</strong></span>
<span class="strong"><strong class="calibre2">| 1Q84       | Haruki Murakami |  9.75 |</strong></span>
<span class="strong"><strong class="calibre2">| 19 minutes | Jodi Picoult    |    10 |</strong></span>
<span class="strong"><strong class="calibre2">+------------+-----------------+-------+</strong></span>
<span class="strong"><strong class="calibre2">3 rows in set (0.00 sec)</strong></span>
</pre></div><p class="calibre8">We asked for all the books whose title starts with <code class="email">1</code>, and we got three rows. You can imagine how useful this operator is, especially when we implement a search utility in our application.</p><p class="calibre8">As in PHP, MySQL also allows you to add logical operators—that is, operators that take operands and perform a logical operation, returning Boolean values as a result. The most common logical operators are, as in PHP, <code class="email">AND</code> and <code class="email">OR</code>. <code class="email">AND</code> returns <code class="email">true</code> if both the expressions are <code class="email">true</code> and <code class="email">OR</code> returns <code class="email">true</code> if either of the operands is <code class="email">true</code>. Let's consider an example, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SELECT title, author, price FROM book</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; WHERE title LIKE "1%" AND stock &gt; 0;</strong></span>
<span class="strong"><strong class="calibre2">+------------+-----------------+-------+</strong></span>
<span class="strong"><strong class="calibre2">| title      | author          | price |</strong></span>
<span class="strong"><strong class="calibre2">+------------+-----------------+-------+</strong></span>
<span class="strong"><strong class="calibre2">| 1984       | George Orwell   |   7.5 |</strong></span>
<span class="strong"><strong class="calibre2">| 1Q84       | Haruki Murakami |  9.75 |</strong></span>
<span class="strong"><strong class="calibre2">+------------+-----------------+-------+</strong></span>
<span class="strong"><strong class="calibre2">2 rows in set (0.00 sec)</strong></span>
</pre></div><p class="calibre8">This example is very similar to the previous one, but we added an extra condition. We asked for all titles starting with <code class="email">1</code> and whether there is stock available. This is why one of the books does not show as it does not satisfy both conditions. You can add as many conditions as you need with logical operators but bear in mind that <code class="email">AND</code> operators take precedence over <code class="email">OR</code>. If you want to change this precedence, you can always wrap expressions with a parenthesis, as in PHP.</p><p class="calibre8">So far, we have<a id="id425" class="calibre1"/> retrieved specific fields when querying for data, but we could ask for all the fields in a given table. To do this, we will just use the <code class="email">*</code> wildcard in <code class="email">SELECT</code>. Let's select all the fields for the customers via the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SELECT * FROM customer \G</strong></span>
<span class="strong"><strong class="calibre2">*************************** 1. row ***************************</strong></span>
<span class="strong"><strong class="calibre2">       id: 1</strong></span>
<span class="strong"><strong class="calibre2">firstname: Han</strong></span>
<span class="strong"><strong class="calibre2">  surname: Solo</strong></span>
<span class="strong"><strong class="calibre2">    email: han@tatooine.com</strong></span>
<span class="strong"><strong class="calibre2">     type: premium</strong></span>
<span class="strong"><strong class="calibre2">*************************** 2. row ***************************</strong></span>
<span class="strong"><strong class="calibre2">       id: 2</strong></span>
<span class="strong"><strong class="calibre2">firstname: James</strong></span>
<span class="strong"><strong class="calibre2">  surname: Kirk</strong></span>
<span class="strong"><strong class="calibre2">    email: enter@prise</strong></span>
<span class="strong"><strong class="calibre2">     type: basic</strong></span>
<span class="strong"><strong class="calibre2">2 rows in set (0.00 sec)</strong></span>
</pre></div><p class="calibre8">You can retrieve more information than just fields. For example, you can use <code class="email">COUNT</code> to retrieve the amount of rows that satisfy the given conditions instead of retrieving all the columns. This way is faster than retrieving all the columns and then counting them because you save time in reducing the size of the response. Let's consider how it would look:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SELECT COUNT(*) FROM borrowed_books</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; WHERE customer_id = 1 AND end IS NOT NULL;</strong></span>
<span class="strong"><strong class="calibre2">+----------+</strong></span>
<span class="strong"><strong class="calibre2">| COUNT(*) |</strong></span>
<span class="strong"><strong class="calibre2">+----------+</strong></span>
<span class="strong"><strong class="calibre2">|        1 |</strong></span>
<span class="strong"><strong class="calibre2">+----------+</strong></span>
<span class="strong"><strong class="calibre2">1 row in set (0.00 sec)</strong></span>
</pre></div><p class="calibre8">As you can note, the response says <code class="email">1</code>, which means that there is only one borrowed book that satisfies the conditions. However, check the conditions; you will note that we used another familiar logical operator: <code class="email">NOT</code>. <code class="email">NOT</code> negates the expression, as <code class="email">!</code> does in PHP. Note also that we do not use the equal sign to compare with null values. In MySQL, you have to use <code class="email">IS</code> instead of the equals sign in order to compare with <code class="email">NULL</code>. So, the second condition would be satisfied when a borrowed book has an end date that is not null.</p><p class="calibre8">Let's finish this<a id="id426" class="calibre1"/> section by adding two more features when querying data. The first one is the ability to specify in what order the rows should be returned. To do this, just use the keyword <code class="email">ORDER BY</code> followed by the name of the field that you want to order by. You could also specify whether you want to order in ascending mode, which is by default, or in the descending mode, which can be done by appending <code class="email">DESC</code>. The other feature is the ability to limit the amount of rows to return using <code class="email">LIMIT</code> and the amount of rows to retrieve. Now, run the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SELECT id, title, author, isbn FROM book</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ORDER BY title LIMIT 4;</strong></span>
<span class="strong"><strong class="calibre2">+----+-------------+-----------------+---------------+</strong></span>
<span class="strong"><strong class="calibre2">| id | title       | author          | isbn          |</strong></span>
<span class="strong"><strong class="calibre2">+----+-------------+-----------------+---------------+</strong></span>
<span class="strong"><strong class="calibre2">|  5 | 19 minutes  | Jodi Picoult    | 9780753179246 |</strong></span>
<span class="strong"><strong class="calibre2">|  1 | 1984        | George Orwell   | 9780882339726 |</strong></span>
<span class="strong"><strong class="calibre2">|  2 | 1Q84        | Haruki Murakami | 9789724621081 |</strong></span>
<span class="strong"><strong class="calibre2">|  3 | Animal Farm | George Orwell   | 9780736692427 |</strong></span>
<span class="strong"><strong class="calibre2">+----+-------------+-----------------+---------------+</strong></span>
<span class="strong"><strong class="calibre2">4 rows in set (0.00 sec)</strong></span>
</pre></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Using PDO"><div class="book" id="1FLS42-edcc22b134104d5db0bf3aa086c86851"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec44" class="calibre1"/>Using PDO</h1></div></div></div><p class="calibre8">So far, we have<a id="id427" class="calibre1"/> worked with MySQL, and you already have a good idea of what you can do with it. However, connecting to the client and performing queries manually is not our goal. What we want to achieve is that our application can take advantage of the database in an automatic way. In order to do this, we will use a set of classes that comes with PHP and allows you to connect to the database and perform queries from the code.</p><p class="calibre8">
<span class="strong"><strong class="calibre2">PHP Data Objects</strong></span> (<span class="strong"><strong class="calibre2">PDO</strong></span>) is the class that connects to the database and allows you to interact with it. This is the popular way to work with databases for PHP developers, even though there are other ways that we will not discuss here. PDO allows you to work with different database systems, so you are not tied to MySQL only. In the following sections, we will consider how to connect to a database, insert data, and retrieve it using this class.</p></div>

<div class="book" title="Using PDO">
<div class="book" title="Connecting to the database"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec79" class="calibre1"/>Connecting to the database</h2></div></div></div><p class="calibre8">In order to connect<a id="id428" class="calibre1"/> to the database, it is good practice to keep the credentials—that is, the user and password—separated from the code in a configuration file. We already have this file as <code class="email">config/app.json</code> from when we worked with the <code class="email">Config</code> class. Let's add the correct credentials for our database. If you have the configuration by default, the configuration file should look similar to this:</p><div class="informalexample"><pre class="programlisting">{
  "db": {
    "user": "root",
    "password": ""
  }
}</pre></div><p class="calibre8">Developers usually specify other information related to the connection, such as the host, port, or name of the database. This will depend on how your application is installed, whether MySQL is running on a different server, and so on, and it is up to you how much information you want to keep on your code and in your configuration files.</p><p class="calibre8">In order to connect to the <a id="id429" class="calibre1"/>database, we need to instantiate an object from the <code class="email">PDO</code> class. The constructor of this class expects three arguments: <span class="strong"><strong class="calibre2">Data Source Name</strong></span> (<span class="strong"><strong class="calibre2">DSN</strong></span>), which<a id="id430" class="calibre1"/> is a string that represents the type of database to use; the name of the user; and the password. We already have the username and password from the <code class="email">Config</code> class, but we still need to build DSN.</p><p class="calibre8">One of the formats for MySQL databases is <code class="email">&lt;database type&gt;:host=&lt;host&gt;;dbname=&lt;schema name&gt;</code>. As our database system is MySQL, it runs on the same server, and the schema name is <code class="email">bookstore</code>, DSN will be <code class="email">mysql:host=127.0.0.1;dbname=bookstore</code>. Let's take a look at how we will put everything together:</p><div class="informalexample"><pre class="programlisting">$dbConfig = Config::getInstance()-&gt;get('db');
<span class="strong"><strong class="calibre2">$db = new PDO(</strong></span>
<span class="strong"><strong class="calibre2">    'mysql:host=127.0.0.1;dbname=bookstore',</strong></span>
<span class="strong"><strong class="calibre2">    $dbConfig['user'],</strong></span>
<span class="strong"><strong class="calibre2">    $dbConfig['password']</strong></span>
<span class="strong"><strong class="calibre2">);</strong></span>
$db-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);</pre></div><p class="calibre8">Note also that we will invoke the <code class="email">setAttribute</code> method from the <code class="email">PDO</code> instance. This method allows you to set some options to the connection; in this case, it sets the format of the results coming from MySQL. This option forces MySQL to return the arrays whose keys are the names of the fields, which is way more useful than the default one, returning numeric keys based on the order of the fields. Setting this option now will affect all the queries performed with the <code class="email">$db</code> instance, rather than setting the option each time we perform a query.</p></div></div>

<div class="book" title="Using PDO">
<div class="book" title="Performing queries"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec80" class="calibre1"/>Performing queries</h2></div></div></div><p class="calibre8">The easiest way to retrieve <a id="id431" class="calibre1"/>data from your database is to use the <code class="email">query</code> method. This method accepts the query as a string and returns a list of rows as arrays. Let's consider an example: write the following after the initialization of the database connection—for example, in the <code class="email">init.php</code> file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">$rows = $db-&gt;query('SELECT * FROM book ORDER BY title');</strong></span>
foreach ($rows as $row) {
    var_dump($row);
}</pre></div><p class="calibre8">This query tries to get all the books in the database, ordering them by the title. This could be the content of a function such as <code class="email">getAllBooks</code>, which is used when we display our catalog. Each row is an array that contains all the fields as keys and the data as values.</p><p class="calibre8">If you run the application on your browser, you will get the following result:</p><div class="mediaobject"><img src="../images/00027.jpeg" alt="Performing queries" class="calibre9"/></div><p class="calibre10"> </p><p class="calibre8">The <code class="email">query</code> function is <a id="id432" class="calibre1"/>useful when we want to retrieve data, but in order to execute queries that insert rows, PDO provides the <code class="email">exec</code> function. This function also expects the first parameter as a string, defining the query to execute, but it returns a Boolean specifying whether the execution was successful or not. A good example would be to try to insert books. Type the following:</p><div class="informalexample"><pre class="programlisting">$query = &lt;&lt;&lt;SQL
INSERT INTO book (isbn, title, author, price)
VALUES ("9788187981954", "Peter Pan", "J. M. Barrie", 2.34)
SQL;
<span class="strong"><strong class="calibre2">$result = $db-&gt;exec($query);</strong></span>
var_dump($result); // true</pre></div><p class="calibre8">This code also uses a new way of representing strings: heredoc. We will enclose the string between <code class="email">&lt;&lt;&lt;SQL</code> and <code class="email">SQL;</code>, both in different lines, instead of quotes. The benefit of this is the ability to write strings in multiple lines with tabulations or any other blank space, and PHP will respect it. We can construct queries that are easy to read rather than writing them on a single line or having to concatenate the different strings. Note that <code class="email">SQL</code> is a token to <a id="id433" class="calibre1"/>represent the start and end of the string, but you could use any text that you consider.</p><p class="calibre8">The first time you run the application with this code, the query will be executed successfully, and thus, the result will be the Boolean <code class="email">true</code>. However, if you run it again, it will return <code class="email">false</code> as the ISBN that we inserted is the same but we set its restriction to be unique.</p><p class="calibre8">It is useful to know that a query failed, but it is better if we know why. The <code class="email">PDO</code> instance has the <code class="email">errorInfo</code> method that returns an array with the information of the last error. The key <code class="email">2</code> contains the description, so it is probably the one that we will use more often. Update the previous code with the following:</p><div class="informalexample"><pre class="programlisting">$query = &lt;&lt;&lt;SQL
INSERT INTO book (isbn, title, author, price)
VALUES ("9788187981954", "Peter Pan", "J. M. Barrie", 2.34)
SQL;
$result = $db-&gt;exec($query); 
var_dump($result); // false
<span class="strong"><strong class="calibre2">$error = $db-&gt;errorInfo()[2];</strong></span>
var_dump($error); // Duplicate entry '9788187981954' for key 'isbn'</pre></div><p class="calibre8">The result is that the query failed because the ISBN entry was duplicated. Now, we can build more meaningful error messages for our customers or just for debugging purposes.</p></div></div>

<div class="book" title="Using PDO">
<div class="book" title="Prepared statements"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec81" class="calibre1"/>Prepared statements</h2></div></div></div><p class="calibre8">The previous two functions are very<a id="id434" class="calibre1"/> useful when you need to run quick queries that are <a id="id435" class="calibre1"/>always the same. However, in the second example you might note that the string of the query is not very useful as it always inserts the same book. Although it is true that you could just replace the values by variables, it is not good practice as these variables usually come from the user side and can contain malicious code. It is always better to first sanitize these values.</p><p class="calibre8">PDO provides the ability to prepare a statement—that is, a query that is parameterized. You can specify parameters for the fields that will change in the query and then assign values to these parameters. Let's consider first an example, as follows:</p><div class="informalexample"><pre class="programlisting">$query = 'SELECT * FROM book WHERE author = :author';
<span class="strong"><strong class="calibre2">$statement = $db-&gt;prepare($query);</strong></span>
<span class="strong"><strong class="calibre2">$statement-&gt;bindValue('author', 'George Orwell');</strong></span>
<span class="strong"><strong class="calibre2">$statement-&gt;execute();</strong></span>
<span class="strong"><strong class="calibre2">$rows = $statement-&gt;fetchAll();</strong></span>
var_dump($rows);</pre></div><p class="calibre8">The query is a <a id="id436" class="calibre1"/>normal one except that it has <code class="email">:author</code> instead of the string <a id="id437" class="calibre1"/>of the author that we want to find. This is a parameter, and we will identify them using the prefix <code class="email">:</code>. The <code class="email">prepare</code> method gets the query as an argument and returns a <code class="email">PDOStatement</code> instance. This class contains several methods to bind values, execute statements, fetch results, and more. In this piece of code, we use only three of them, as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">bindValue</code>: This takes two arguments: the name of the parameter as described in the query and the value to assign. If you provide a parameter name that is not in the query, this will throw an exception.</li><li class="listitem"><code class="email">execute</code>: This will send the query to MySQL with the replacement of the parameters by the provided values. If there is any parameter that is not assigned to a value, the method will throw an exception. As its brother <code class="email">exec</code>, <code class="email">execute</code> will return a Boolean, specifying whether the query was executed successfully or not.</li><li class="listitem"><code class="email">fetchAll</code>: This will retrieve the data from MySQL in case it was a <code class="email">SELECT</code> query. As a query, <code class="email">fetchAll</code> will return a list of all rows as arrays.</li></ul></div><p class="calibre8">If you try this code, you will note that the result is very similar to when using <code class="email">query</code>; however, this time, the code is much more dynamic as you can reuse it for any author that you need.</p><div class="mediaobject"><img src="../images/00028.jpeg" alt="Prepared statements" class="calibre9"/></div><p class="calibre10"> </p><p class="calibre8">There is another way to<a id="id438" class="calibre1"/> bind values to parameters of a query than using<a id="id439" class="calibre1"/> the <code class="email">bindValue</code> method. You could prepare an array where the key is the name of the parameter and the value is the value you want to assign to it, and then you can send it as the first argument of the <code class="email">execute</code> method. This way is quite useful as usually you already have this array prepared and do not need to call <code class="email">bindValue</code> several times with its content. Add this code in order to test it:</p><div class="informalexample"><pre class="programlisting">$query = &lt;&lt;&lt;SQL
INSERT INTO book (isbn, title, author, price)
VALUES (:isbn, :title, :author, :price)
SQL;
$statement = $db-&gt;prepare($query);
$params = [
    'isbn' =&gt; '9781412108614',
    'title' =&gt; 'Iliad',
    'author' =&gt; 'Homer',
    'price' =&gt; 9.25
];
<span class="strong"><strong class="calibre2">$statement-&gt;execute($params);</strong></span>
<span class="strong"><strong class="calibre2">echo $db-&gt;lastInsertId(); // 8</strong></span>
</pre></div><p class="calibre8">In this last example, we<a id="id440" class="calibre1"/> created a new book with almost all the parameters, but we did not specify the ID, which is the desired behavior as we want MySQL to choose a valid one for us. However, what happens if you want to know the ID of the inserted row? Well, you could query MySQL for the book with the same ISBN and the returned<a id="id441" class="calibre1"/> row would contain the ID, but this seems like a lot of work. Instead, PDO has the <code class="email">lastInsertId</code> method, which returns the last ID inserted by a primary key, saving us from one extra query.</p></div></div>
<div class="book" title="Joining tables"><div class="book" id="1GKCM2-edcc22b134104d5db0bf3aa086c86851"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec45" class="calibre1"/>Joining tables</h1></div></div></div><p class="calibre8">Even though <a id="id442" class="calibre1"/>querying MySQL is quite fast, especially if it is in the same server as our PHP application, we should try to reduce the number of queries that we will execute to improve the performance of our application. So far, we have queried data from just one table, but this is rarely the case. Imagine that you want to retrieve information about borrowed books: the table contains only IDs and dates, so if you query it, you will not get very meaningful data, right? One approach would be to query the data in <code class="email">borrowed_books</code>, and based on the returning IDs, query the <code class="email">book</code> and <code class="email">customer</code> tables by filtering by the IDs we are interested in. However, this approach consists of at least three queries to MySQL and a lot of work with arrays in PHP. It seems as though there should be a better option!</p><p class="calibre8">In SQL, you can execute<a id="id443" class="calibre1"/> <span class="strong"><strong class="calibre2">join queries</strong></span>. A join query is a query that joins two or more tables through a common field and, thus, allows you to retrieve data from these tables, reducing the amount of queries needed. Of course, the performance of a join query is not as good as the performance of a normal query, but if you have the correct keys and relationships defined, this option is way better than querying separately.</p><p class="calibre8">In order to join tables, you need to link them using a common field. Foreign keys are very useful in this matter as you know that both the fields are the same. Let's take a look at how we would query for all the important info related to the borrowed books:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SELECT CONCAT(c.firstname, ' ', c.surname) AS name,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt;     b.title,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt;     b.author,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt;     DATE_FORMAT(bb.start, '%d-%m-%y') AS start,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt;     DATE_FORMAT(bb.end, '%d-%m-%y') AS end</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; FROM borrowed_books bb</strong></span>
<span class="strong"><strong class="calibre2">    -&gt;     LEFT JOIN customer c ON bb.customer_id = c.id</strong></span>
<span class="strong"><strong class="calibre2">    -&gt;     LEFT JOIN book b ON b.id = bb.book_id</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; WHERE bb.start &gt;= "2015-01-01";</strong></span>
<span class="strong"><strong class="calibre2">+------------+---------+---------------+----------+----------+</strong></span>
<span class="strong"><strong class="calibre2">| name       | title   | author        | start    | end      |</strong></span>
<span class="strong"><strong class="calibre2">+------------+---------+---------------+----------+----------+</strong></span>
<span class="strong"><strong class="calibre2">| Han Solo   | Dracula | Bram Stoker   | 10-01-15 | 13-01-15 |</strong></span>
<span class="strong"><strong class="calibre2">| James Kirk | Dracula | Bram Stoker   | 01-02-15 | 10-02-15 |</strong></span>
<span class="strong"><strong class="calibre2">| James Kirk | 1984    | George Orwell | 12-03-15 | NULL     |</strong></span>
<span class="strong"><strong class="calibre2">+------------+---------+---------------+----------+----------+</strong></span>
<span class="strong"><strong class="calibre2">3 rows in set (0.00 sec)</strong></span>
</pre></div><p class="calibre8">There are several new concepts introduced in this last query. Especially with joining queries, as we joined the fields of different tables, it might occur that two tables have the same field name, and MySQL needs us to differentiate them. The way we will differentiate two fields of two different tables is by prepending the name of the table. Imagine that we want to differentiate the ID of a customer from the ID of the book; we should use them as <code class="email">customer.id</code> and <code class="email">book.id</code>. However, writing the name of the table each time would make our queries endless.</p><p class="calibre8">MySQL has the ability to add an alias to a table by just writing next to the table's real name, as we did in <code class="email">borrowed_books</code> (<code class="email">bb</code>), <code class="email">customer</code> (<code class="email">c</code>) or <code class="email">book</code> (<code class="email">b</code>). Once you add an alias, you can use it to reference this table, allowing us to write things such as <code class="email">bb.customer_id</code> instead of <code class="email">borrowed_books.customer_id</code>. It is also good practice to write the table of the field even if the field is not duplicated anywhere else as joining tables makes it a bit confusing to know where each field comes from.</p><p class="calibre8">When joining tables, you<a id="id444" class="calibre1"/> need to write them in the <code class="email">FROM</code> clause using <code class="email">LEFT JOIN</code>, followed by the name of the table, an optional alias, and the fields that connect both tables. There are different joining types, but let's focus on the most useful for our purposes. <span class="strong"><strong class="calibre2">Left joins</strong></span>
<a id="id445" class="calibre1"/> take each row from the first table—the one on the left-hand side of the definition—and search for the equivalent field in the right-hand side table. Once it finds it, it will concatenate both rows as if they were one. For example, when joining <code class="email">borrowed_books</code> with <code class="email">customer</code> for each <code class="email">borrowed_books</code> row, MySQL will search for an ID in <code class="email">customer</code> that matches the current <code class="email">customer_id</code>, and then it will add all the information of this row in our current row in <code class="email">borrowed_books</code> as if they were only one big table. As <code class="email">customer_id</code> is a foreign key, we are certain that there will always be a customer to match.</p><p class="calibre8">You can join several tables, and MySQL will just resolve them from left to right; that is, it will first join the two first tables as one, then try to join this resulting one with the third table, and so on. This is, in fact, what we did in our example: we first joined <code class="email">borrowed_books</code> with <code class="email">customer</code> and then joined these two with <code class="email">book</code>.</p><p class="calibre8">As you can note, there are also aliases for fields. Sometimes, we do more than just getting a field; an example was when we got how many rows a query matched with <code class="email">COUNT(*)</code>. However, the title of the column when retrieving this information was also <code class="email">COUNT(*)</code>, which is not always useful. At other times, we used two tables with colliding field names, and it makes everything confusing. When this happens, just add an alias to the field in the same way we did with table names; <code class="email">AS</code> is optional, but it helps to understand what you are doing.</p><p class="calibre8">Let's move now to the usage of dates in this query. On one hand, we will use <code class="email">DATE_FORMAT</code> for the first time. It accepts the date/time/datetime value and the string with the format. In this case, we used <code class="email">%d-%m-%y</code>, which means day-month-year, but we could use <code class="email">%h-%i-%s</code> to specify hours-minutes-seconds or any other combination.</p><p class="calibre8">Note also how we compared<a id="id446" class="calibre1"/> dates in the <code class="email">WHERE</code> clause. Given two dates or time values of the same type, you can use the comparison operators as if they were numbers. In this case, we will do <code class="email">bb.start &gt;= "2015-01-01"</code>, which will give us the borrowed books from January 1, 2015, onward.</p><p class="calibre8">The final thing to note about this complex query is the use of the <code class="email">CONCAT</code> function. Instead of returning two fields, one for the name and one for the surname, we want to get the full name. To do this, we will concatenate the fields using this function, sending as many strings as we want as arguments of the function and getting back the concatenated string. As you can see, you can send both fields and strings enclosed by single quotes.</p><p class="calibre8">Well, if you fully understood this query, you should feel satisfied with yourself; this was the most complex query we will see in this chapter. We hope you can get a sense of how powerful a database system can be and that from now on, you will try to process the data as much as you can on the database side instead of the PHP side. If you set the correct indexes, it will perform better.</p></div>
<div class="book" title="Grouping queries" id="1HIT81-edcc22b134104d5db0bf3aa086c86851"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec46" class="calibre1"/>Grouping queries</h1></div></div></div><p class="calibre8">The last<a id="id447" class="calibre1"/> feature that we will discuss about querying is the <code class="email">GROUP BY</code> clause. This clause allows you to group rows of the same table with a common field. For example, let's say we want to know how many books each author has in just one query. Try the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SELECT</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; author,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; COUNT(*) AS amount,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; GROUP_CONCAT(title SEPARATOR ', ') AS titles</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; FROM book</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; GROUP BY author</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ORDER BY amount DESC, author;</strong></span>
<span class="strong"><strong class="calibre2">+-----------------+--------+-------------------+</strong></span>
<span class="strong"><strong class="calibre2">| author          | amount | titles            |</strong></span>
<span class="strong"><strong class="calibre2">+-----------------+--------+-------------------+</strong></span>
<span class="strong"><strong class="calibre2">| George Orwell   |      2 | 1984, Animal Farm |</strong></span>
<span class="strong"><strong class="calibre2">| Homer           |      2 | Odyssey, Iliad    |</strong></span>
<span class="strong"><strong class="calibre2">| Bram Stoker     |      1 | Dracula           |</strong></span>
<span class="strong"><strong class="calibre2">| Haruki Murakami |      1 | 1Q84              |</strong></span>
<span class="strong"><strong class="calibre2">| J. M. Barrie    |      1 | Peter Pan         |</strong></span>
<span class="strong"><strong class="calibre2">| Jodi Picoult    |      1 | 19 minutes        |</strong></span>
<span class="strong"><strong class="calibre2">+-----------------+--------+-------------------+</strong></span>
<span class="strong"><strong class="calibre2">5 rows in set (0.00 sec)</strong></span>
</pre></div><p class="calibre8">The <code class="email">GROUP BY</code> clause, always after the <code class="email">WHERE</code> clause, gets a field—or many, separated by a coma—and treats all the rows with the same value for this field, as though they were just one. Thus, selecting by author will group all the rows that contain the same author. The feature might not seem very useful, but there are several functions in MySQL that take advantage of it. In this example:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">COUNT(*)</code> is used in queries with <code class="email">GROUP BY</code> and shows how many rows this field groups. In this case, we will use it to know how many books each author has. In fact, it always works like this; however, for queries without <code class="email">GROUP BY</code>, MySQL treats the whole set of rows as one group.</li><li class="listitem"><code class="email">GROUP_CONCAT</code> is similar <a id="id448" class="calibre1"/>to <code class="email">CONCAT</code>, which we discussed earlier. The only difference is that this time the function will concatenate the fields of all the rows of a group. If you do not specify <code class="email">SEPARATOR</code>, MySQL will use a single coma. However, in our case, we needed a coma and a space to make it readable, so we added <code class="email">SEPARATOR ', '</code> at the end. Note that you can add as many things to concatenate as you need in <code class="email">CONCAT</code>, the separator will just separate the concatenations by rows.</li></ul></div><p class="calibre8">Even though it is not about grouping, note the <code class="email">ORDER</code> clause that we added. We ordered by two fields instead of one. This means that MySQL will order all the rows by the <code class="email">amount</code> field; note that this is an alias, but you can use it here as well. Then, MySQL will order each group of rows with the same <code class="email">amount</code> value by the <code class="email">title</code> field.</p><p class="calibre8">There is one last thing to remember as we already presented all the important clauses that a <code class="email">SELECT</code> query can contain: MySQL expects the clauses of the query to be always in the same order. If you write the same query but change this order, you will get an error. The order is as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1"><code class="email">SELECT</code></li><li class="listitem" value="2"><code class="email">FROM</code></li><li class="listitem" value="3"><code class="email">WHERE</code></li><li class="listitem" value="4"><code class="email">GROUP BY</code></li><li class="listitem" value="5"><code class="email">ORDER BY</code></li></ol><div class="calibre13"/></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Updating and deleting data"><div class="book" id="1IHDQ2-edcc22b134104d5db0bf3aa086c86851"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec47" class="calibre1"/>Updating and deleting data</h1></div></div></div><p class="calibre8">We already <a id="id449" class="calibre1"/>know quite a lot about inserting and retrieving data, but if applications could only do this, they would be quite static. Editing this data as we need is what makes an application dynamic and what gives to the user some value. In MySQL, and in most database systems, you have two commands to change data: <code class="email">UPDATE</code> and <code class="email">DELETE</code>. Let's discuss them in detail.</p></div>

<div class="book" title="Updating and deleting data">
<div class="book" title="Updating data"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec82" class="calibre1"/>Updating data</h2></div></div></div><p class="calibre8">When updating data in MySQL, the most important thing is to have a unique reference of the row that you want to update. For this, primary keys are very useful; however, if you have a table with no primary keys, which should not be the case most of the time, you can still update the rows based on other fields. Other than the reference, you will need the new value and, of course, the table name and field to update. Let's take a look at a very simple example:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; UPDATE book SET price = 12.75 WHERE id = 2;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 1 row affected (0.00 sec)</strong></span>
<span class="strong"><strong class="calibre2">Rows matched: 1  Changed: 1  Warnings: 0</strong></span>
</pre></div><p class="calibre8">In this <code class="email">UPDATE</code> <a id="id450" class="calibre1"/>query, we set the price of the book with the ID 2 to <code class="email">12.75</code>. The <code class="email">SET</code> clause does not need to specify only one change; you can specify several changes on the same row as soon as you separate them by commas—for example, <code class="email">SET price = 12.75, stock = 14</code>. Also, note the <code class="email">WHERE</code> clause, in which we specify which rows we want to change. MySQL gets all the rows of this table based on these conditions as though it were a <code class="email">SELECT</code> query and apply the change to this set of rows.</p><p class="calibre8">What MySQL will return is very important: the number of rows matched and the number of rows changed. The first one is the number of rows that match the conditions in the <code class="email">WHERE</code> clause. The second one specifies the amount of rows that can be changed. There are different reasons not to change a row—for example when the row already has the same value. To see this, let's run the same query again:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; UPDATE book SET price = 12.75 WHERE id = 2;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 0 rows affected (0.00 sec)</strong></span>
<span class="strong"><strong class="calibre2">Rows matched: 1  Changed: 0  Warnings: 0</strong></span>
</pre></div><p class="calibre8">The same row now says that there was <code class="email">1</code> row matched, as expected, but <code class="email">0</code> rows were changed. The reason is that we already set the price of this book to <code class="email">12.75</code>, so MySQL does not need to do anything about this now.</p><p class="calibre8">As mentioned before, the <code class="email">WHERE</code> clause is the most important bit in this query. Way too many times, we find developers that run a priori innocent <code class="email">UPDATE</code> queries end up changing the whole table because they miss the <code class="email">WHERE</code> clause; thus, MySQL matches the whole table as valid rows to update. This is usually not the intention of the developer, and it is something not very pleasant, so try to make sure you always provide a valid set of conditions. It is good practice to first write down the <code class="email">SELECT</code> query that returns the rows you need to edit, and once you are sure that the conditions match the desired set of rows, you can write the <code class="email">UPDATE</code> query.</p><p class="calibre8">However, sometimes, affecting multiple rows is the intended scenario. Imagine that we are going through tough times and need to increase the price of all our books. We decide that we want to increase the price by 16%, which is the same as the current price times 1.16. We can run the following query to perform these changes:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; UPDATE book SET price = price * 1.16;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 8 rows affected (0.00 sec)</strong></span>
<span class="strong"><strong class="calibre2">Rows matched: 8  Changed: 8  Warnings: 0</strong></span>
</pre></div><p class="calibre8">This query does not contain any <code class="email">WHERE</code> clause as we want to match all our books. Also note that the <code class="email">SET</code> clause uses the <code class="email">price</code> field to get the current value for the price, which is perfectly valid. Finally, note the number of rows matched and changed, which is <code class="email">8</code>—the whole set of rows for this table.</p><p class="calibre8">To finish with this<a id="id451" class="calibre1"/> subsection, let's consider how we can use <code class="email">UPDATE</code> queries from PHP through PDO. One very common scenario is when we want to add copies of the already existing books to our inventory. Given a book ID and an optional amount of books—by default, this value will be 1—we will increase the stock value of this book by these many copies. Write this function in your <code class="email">init.php</code> file:</p><div class="informalexample"><pre class="programlisting">function addBook(int $id, int $amount = 1): void {
    $db = new PDO(
        'mysql:host=127.0.0.1;dbname=bookstore',
        'root',
        ''
    );

    $query = 'UPDATE book SET stock = stock + :n WHERE id = :id';
    $statement = $db-&gt;prepare($query);
    $statement-&gt;bindValue('id', $id);
    $statement-&gt;bindValue('n', $amount);

    if (!$statement-&gt;execute()) {
        throw new Exception($statement-&gt;errorInfo()[2]);
    }
}</pre></div><p class="calibre8">There are two arguments: <code class="email">$id</code> and <code class="email">$amount</code>. The first one will always be mandatory, whereas the second one can be omitted, and the default value will be 1. The function first prepares a query similar to the first one of this section, in which we increased the amount of stock of a given book, then binds both parameters to the statement, and finally executes the query. If something happens and <code class="email">execute</code> returns <code class="email">false</code>, we will throw an exception with the content of the error message from MySQL.</p><p class="calibre8">This function is very useful when we either buy more stock or a customer returns a book. We could even use it to remove books by providing a negative value to <code class="email">$amount</code>, but this is very bad practice. The reason is that even if we forced the stock field to be unsigned, setting it to a negative value will not trigger any error, only a warning. MySQL will not set the row to a negative value, but the <code class="email">execute</code> invocation will return <code class="email">true</code>, and we will not know about it. It is better to just create a second method, <code class="email">removeBook</code>, and verify first that the <a id="id452" class="calibre1"/>amount of books to remove is lower than or equal to the current stock.</p></div></div>

<div class="book" title="Updating and deleting data">
<div class="book" title="Foreign key behaviors"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec83" class="calibre1"/>Foreign key behaviors</h2></div></div></div><p class="calibre8">One tricky thing to <a id="id453" class="calibre1"/>manage when updating or deleting rows is when the row that we update is part of a foreign key somewhere else. For example, our <code class="email">borrowed_books</code> table contains the IDs of customers and books, and as you already know, MySQL enforces that these IDs are always valid and exist on these respective tables. What would happen, then, if we changed the ID of the book itself on the <code class="email">book</code> table? Or even worse, what would happen if we removed one of the books from <code class="email">book</code>, and there is a row in <code class="email">borrowed_books</code> that references this ID?</p><p class="calibre8">MySQL allows you to set the desired reaction when one of these scenarios takes place. It has to be defined when adding the foreign key; so, in our case, we will need to first remove the existing ones and then add them again. To remove or drop a key, you need to know the name of this key, which we can find using the <code class="email">SHOW CREATE TABLE</code> command, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SHOW CREATE TABLE borrowed_books \G</strong></span>
<span class="strong"><strong class="calibre2">*************************** 1. row ***************************</strong></span>
<span class="strong"><strong class="calibre2">       Table: borrowed_books</strong></span>
<span class="strong"><strong class="calibre2">Create Table: CREATE TABLE `borrowed_books` (</strong></span>
<span class="strong"><strong class="calibre2">  `book_id` int(10) unsigned NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">  `customer_id` int(10) unsigned NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">  `start` datetime NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">  `end` datetime DEFAULT NULL,</strong></span>
<span class="strong"><strong class="calibre2">  KEY `book_id` (`book_id`),</strong></span>
<span class="strong"><strong class="calibre2">  KEY `customer_id` (`customer_id`),</strong></span>
<span class="strong"><strong class="calibre2">  CONSTRAINT `borrowed_books_ibfk_1` FOREIGN KEY (`book_id`) REFERENCES `book` (`id`),</strong></span>
<span class="strong"><strong class="calibre2">  CONSTRAINT `borrowed_books_ibfk_2` FOREIGN KEY (`customer_id`) REFERENCES `customer` (`id`)</strong></span>
<span class="strong"><strong class="calibre2">) ENGINE=InnoDB DEFAULT CHARSET=latin1</strong></span>
<span class="strong"><strong class="calibre2">1 row in set (0.00 sec)</strong></span>
</pre></div><p class="calibre8">The two foreign keys that we want to remove are <code class="email">borrowed_books_ibfk_1</code> and <code class="email">borrowed_books_ibfk_2</code>. Let's remove them using the <code class="email">ALTER TABLE</code> command, as we did before:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; ALTER TABLE borrowed_books</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; DROP FOREIGN KEY borrowed_books_ibfk_1;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 4 rows affected (0.02 sec)</strong></span>
<span class="strong"><strong class="calibre2">Records: 4  Duplicates: 0  Warnings: 0</strong></span>

<span class="strong"><strong class="calibre2">mysql&gt; ALTER TABLE borrowed_books</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; DROP FOREIGN KEY borrowed_books_ibfk_2;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 4 rows affected (0.01 sec)</strong></span>
<span class="strong"><strong class="calibre2">Records: 4  Duplicates: 0  Warnings: 0</strong></span>
</pre></div><p class="calibre8">Now, we need to<a id="id454" class="calibre1"/> add the foreign keys again. The format of the command will be the same as when we added them, but appending the new desired behavior. In our case, if we remove a customer or book from our tables, we want to remove the rows referencing these books and customers from <code class="email">borrowed_books</code>; so, we need to use the <code class="email">CASCADE</code> option. Let's consider what they would look like:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; ALTER TABLE borrowed_books</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ADD FOREIGN KEY (book_id) REFERENCES book (id)</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ON DELETE CASCADE ON UPDATE CASCADE,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ADD FOREIGN KEY (customer_id) REFERENCES customer (id)</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ON DELETE CASCADE ON UPDATE CASCADE;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 4 rows affected (0.01 sec)</strong></span>
<span class="strong"><strong class="calibre2">Records: 4  Duplicates: 0  Warnings: 0</strong></span>
</pre></div><p class="calibre8">Note that we can define the <code class="email">CASCADE</code> behavior for both actions: when updating and when deleting rows. There are other options instead of <code class="email">CASCADE</code>—for example <code class="email">SET NULL</code>, which sets the foreign keys columns to <code class="email">NULL</code> and allows the original row to be deleted, or the default one, <code class="email">RESTRICT</code>, which rejects the update/delete commands.</p></div></div>

<div class="book" title="Updating and deleting data">
<div class="book" title="Deleting data"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec84" class="calibre1"/>Deleting data</h2></div></div></div><p class="calibre8">Deleting data is<a id="id455" class="calibre1"/> almost the same as updating it. You need to provide a <code class="email">WHERE</code> clause that will match the rows that you want to delete. Also, as with when updating data, it is highly recommended to first build the <code class="email">SELECT</code> query that will retrieve the rows that you want to delete before performing the <code class="email">DELETE</code> command. Do not think that you are wasting time with this methodology; as the saying goes, measure twice, cut once. Not always is it possible to recover data after deleting rows!</p><p class="calibre8">Let's try to delete a book by observing how the <code class="email">CASCADE</code> option we set earlier behaves. For this, let's first query for the existing borrowed books list via the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SELECT book_id, customer_id FROM borrowed_books;</strong></span>
<span class="strong"><strong class="calibre2">+---------+-------------+</strong></span>
<span class="strong"><strong class="calibre2">| book_id | customer_id |</strong></span>
<span class="strong"><strong class="calibre2">+---------+-------------+</strong></span>
<span class="strong"><strong class="calibre2">|       1 |           1 |</strong></span>
<span class="strong"><strong class="calibre2">|       4 |           1 |</strong></span>
<span class="strong"><strong class="calibre2">|       4 |           2 |</strong></span>
<span class="strong"><strong class="calibre2">|       1 |           2 |</strong></span>
<span class="strong"><strong class="calibre2">+---------+-------------+</strong></span>
<span class="strong"><strong class="calibre2">4 rows in set (0.00 sec)</strong></span>
</pre></div><p class="calibre8">There are two different books, <code class="email">1</code> and <code class="email">4</code>, with each of them borrowed twice. Let's try to delete the book with the ID 4. First, build a query such as <code class="email">SELECT * FROM book WHERE id = 4</code> to make sure that the condition in the <code class="email">WHERE</code> clause is the appropriate one. Once you are sure, perform the following query:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; DELETE FROM book WHERE id = 4;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 1 row affected (0.02 sec)</strong></span>
</pre></div><p class="calibre8">As you can note, we only specified the <code class="email">DELETE FROM</code> command followed by the name of the table and the <code class="email">WHERE</code> clause. MySQL tells us that there was <code class="email">1</code> row affected, which makes sense, given the previous <code class="email">SELECT</code> statement we made.</p><p class="calibre8">If we go back to<a id="id456" class="calibre1"/> our <code class="email">borrowed_books</code> table and query for the existing ones, we will note that all the rows referencing the book with the ID 4 are gone. This is because when deleting them from the <code class="email">book</code> table, MySQL noticed the foreign key reference, checked what it needed to do while deleting—in this case, <code class="email">CASCADE</code>—and deleted also the rows in <code class="email">borrowed_books</code>. Take a look at the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SELECT book_id, customer_id FROM borrowed_books;</strong></span>
<span class="strong"><strong class="calibre2">+---------+-------------+</strong></span>
<span class="strong"><strong class="calibre2">| book_id | customer_id |</strong></span>
<span class="strong"><strong class="calibre2">+---------+-------------+</strong></span>
<span class="strong"><strong class="calibre2">|       1 |           1 |</strong></span>
<span class="strong"><strong class="calibre2">|       1 |           2 |</strong></span>
<span class="strong"><strong class="calibre2">+---------+-------------+</strong></span>
<span class="strong"><strong class="calibre2">2 rows in set (0.00 sec)</strong></span>
</pre></div></div></div>
<div class="book" title="Working with transactions" id="1JFUC1-edcc22b134104d5db0bf3aa086c86851"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec48" class="calibre1"/>Working with transactions</h1></div></div></div><p class="calibre8">In the previous <a id="id457" class="calibre1"/>section, we reiterated how important it is to make sure that an update or delete query contain the desirable matching set of rows. Even though this will always apply, there is a way to revert the changes that you just made, which is working with <span class="strong"><strong class="calibre2">transactions</strong></span>.</p><p class="calibre8">A transaction is a state where MySQL keeps track of all the changes that you make in your data in order to be able to revert all of them if needed. You need to explicitly start a transaction, and before you close the connection to the server, you need to commit your changes. This means that MySQL does not really perform these changes until you tell it to do so. If during a transaction you want to revert the changes, you should roll back instead of making a commit.</p><p class="calibre8">PDO allows<a id="id458" class="calibre1"/> you to do this with three functions:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">beginTransaction</code>: This <a id="id459" class="calibre1"/>will start the transaction.</li><li class="listitem"><code class="email">commit</code>: This will <a id="id460" class="calibre1"/>commit your changes. Keep in mind that if you do not commit and the PHP script finishes or you close the connection explicitly, MySQL will reject all the changes you made during this transaction.</li><li class="listitem"><code class="email">rollBack</code>: This <a id="id461" class="calibre1"/>will roll back all the changes that were made during this transaction.</li></ul></div><p class="calibre8">One possible use of transactions in your application is when you need to perform multiple queries and all of them have to be successful and the whole set of queries should not be performed otherwise. This would be the case when adding a sale into the database. Remember that our sales are stored in two tables: one for the sale itself and one for the list of books related to this sale. When adding a new one, you need to make sure that all the books are added to this database; otherwise, the sale will be corrupted. What you should do is execute all the queries, checking for their returning values. If any of them returns <code class="email">false</code>, the whole sale should be rolled back.</p><p class="calibre8">Let's create an <code class="email">addSale</code> function in your <code class="email">init.php</code> file in order to emulate this behavior. The content should be as follows:</p><div class="informalexample"><pre class="programlisting">function addSale(int $userId, array $bookIds): void {
    $db = new PDO(
        'mysql:host=127.0.0.1;dbname=bookstore',
        'root',
        ''
    );

<span class="strong"><strong class="calibre2">    $db-&gt;beginTransaction();</strong></span>
    try {
        $query = 'INSERT INTO sale (customer_id, date) '
            . 'VALUES(:id, NOW())';
        $statement = $db-&gt;prepare($query);
        if (!$statement-&gt;execute(['id' =&gt; $userId])) {
            throw new Exception($statement-&gt;errorInfo()[2]);
        }
        $saleId = $db-&gt;lastInsertId();

        $query = 'INSERT INTO sale_book (book_id, sale_id) '
            . 'VALUES(:book, :sale)';
        $statement = $db-&gt;prepare($query);
        $statement-&gt;bindValue('sale', $saleId);
        foreach ($bookIds as $bookId) {
            $statement-&gt;bindValue('book', $bookId);
            if (!$statement-&gt;execute()) {
                throw new Exception($statement-&gt;errorInfo()[2]);
            }
        }

<span class="strong"><strong class="calibre2">        $db-&gt;commit();</strong></span>
    } catch (Exception $e) {
<span class="strong"><strong class="calibre2">        $db-&gt;rollBack();</strong></span>
        throw $e;
    }
}</pre></div><p class="calibre8">This<a id="id462" class="calibre1"/> function is quite complex. It gets as arguments the ID of the customer and the list of books as we assume that the date of the sale is the current date. The first thing we will do is connect to the database, instantiating the <code class="email">PDO</code> class. Right after this, we will begin our transaction, which will last only during the course of this function. Once we begin the transaction, we will open a <code class="email">try…catch</code> block that will enclose the rest of the code of the function. The reason is that if we throw an exception, the <code class="email">catch</code> block will capture it, rolling back the transaction and propagating the exception. The code inside the <code class="email">try</code> block just adds first the sale and then iterates the list of books, inserting them into the database too. At all times, we will check the response of the <code class="email">execute</code> function, and if it's <code class="email">false</code>, we will throw an exception with the information of the error.</p><p class="calibre8">Let's try to use this function. Write the following code that tries to add a sale for three books; however, one of them does not exist, which is the one with the ID 200:</p><div class="informalexample"><pre class="programlisting">try {
    addSale(1, [1, 2, 200]);
} catch (Exception $e) {
    echo 'Error adding sale: ' . $e-&gt;getMessage();
}</pre></div><p class="calibre8">This code will echo the error message, complaining about the nonexistent book. If you check in MySQL, there will be no rows in the <code class="email">sales</code> table as the function rolled back when the exception was thrown.</p><p class="calibre8">Finally, let's try the following code instead. This one will add three valid books so that the queries are always successful and the <code class="email">try</code> block can go until the end, where we will commit the changes:</p><div class="informalexample"><pre class="programlisting">try {
    addSale(1, [1, 2, 3]);
} catch (Exception $e) {
    echo 'Error adding sale: ' . $e-&gt;getMessage();
}</pre></div><p class="calibre8">Test it, and <a id="id463" class="calibre1"/>you will see how there is no message printed on your browser. Then, go to your database to make sure that there is a new <code class="email">sales</code> row and there are three books linked to it.</p></div>
<div class="book" title="Summary" id="1KEEU1-edcc22b134104d5db0bf3aa086c86851"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec49" class="calibre1"/>Summary</h1></div></div></div><p class="calibre8">In this chapter, we learned the importance of databases and how to use them from our web application: from setting up the connection using PDO and creating and fetching data on demand to constructing more complex queries that fulfill our needs. With all of this, our application looks way more useful now than when it was completely static.</p><p class="calibre8">In the next chapter, we will discover how to apply the most important design patterns for web applications through <span class="strong"><strong class="calibre2">Model View Controller</strong></span> (<span class="strong"><strong class="calibre2">MVC</strong></span>). You will gain a sense of clarity in your code when you organize your application in this way.</p></div></body></html>