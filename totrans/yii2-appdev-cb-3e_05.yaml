- en: Chapter 5. Security
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, we will cover the following topics:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: Authentication
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using controller filters
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Preventing XSS
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Preventing SQL injections
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Preventing CSRF
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using RBAC
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Encrypting/Decrypting data
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Introduction
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Security is a crucial part of any web application.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: In this chapter, you will learn how to keep your application secure according
    to the general web application security principle "filter input, escape output".
    We will cover topics such as creating your own controller filters, preventing
    XSS, CSRF, and SQL injections, escaping output, and using role-based access control.
    To know security best practices refer to [http://www.yiiframework.com/doc-2.0/guide-security-best-practices.html#avoiding-debug-info-and-tools-at-production](http://www.yiiframework.com/doc-2.0/guide-security-best-practices.html#avoiding-debug-info-and-tools-at-production).
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: Authentication
  id: totrans-12
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Most web applications provide a way for users to log in or reset their forgotten
    passwords. In Yii2, we don't have this opportunity by default. For a `basic` application
    template, Yii provides only two test users by default, which are statically described
    in the `User` model. So, we have to implement special code to be able to enable
    user login from the database.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-14
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Create a new application by using the Composer package manager, as described
    in the official guide at [http://www.yiiframework.com/doc-2.0/guide-start-installation.html](http://www.yiiframework.com/doc-2.0/guide-start-installation.html).
  id: totrans-15
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'In the component section of your config, add:'
  id: totrans-16
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-17
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Create a `User` table. Create a migration by entering the following command:'
  id: totrans-18
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-19
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Update the just created migration with the following code:'
  id: totrans-20
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-21
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Update the existing `models/User` model with the following code:'
  id: totrans-22
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-23
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Create a migration, which will add a test user. Use the following command:'
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-25
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Update the just created migration with the following code:'
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-27
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Install all migrations with the following command:'
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-29
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: How to do it...
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Now, follow the URL `site/login` action and enter `admin`/`admin` as your credentials:![How
    to do it...](img/image00386.jpeg)
  id: totrans-31
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Congratulations! If you have completed these steps, you should able to log in.
  id: totrans-32
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-33
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: First, we created a migration for the user table. Apart from our ID and username,
    our table contains special fields such as `auth_key` (the main use of this is
    to authenticate the user by cookie), `password_hash` (for security reasons we
    won't store the password as it is and will store only the password hash), and
    `password_reset_token` (used when we need to reset the user's password).
  id: totrans-34
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The result after installation and `create_test_user` migration should look like
    the following screenshot:![How it works...](img/image00399.jpeg)
  id: totrans-35
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We've also added special methods to the `User` model and changed the inheritance
    to `class User extends ActiveRecord implements IdentityInterface` because we need
    to be able to find users in the database.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
- en: You also can copy the `User` model from an advanced app at [https://github.com/yiisoft/yii2-app-advanced/blob/master/common/models/User.php](https://github.com/yiisoft/yii2-app-advanced/blob/master/common/models/User.php).
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: See also
  id: totrans-38
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: For further information, refer to [http://www.yiiframework.com/doc-2.0/guide-security-authentication.html](http://www.yiiframework.com/doc-2.0/guide-security-authentication.html)
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
- en: Using controller filters
  id: totrans-40
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In many cases, we need to filter the incoming data or perform some actions based
    on the data. For example, with custom filters, we can filter visitors by IP, force
    users to use HTTPS, or redirect the user to an installation page prior to using
    the application.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
- en: In Yii2, filters are essentially a special kind of behavior, so using filters
    is the same as using behaviors.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
- en: 'Yii has a lot of built-in usable filters, which include:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: Core
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Custom
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Authentication
  id: totrans-46
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Content Negotiator
  id: totrans-47
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: HttpCache
  id: totrans-48
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: PageCache
  id: totrans-49
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: RateLimiter
  id: totrans-50
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Verb
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Cors
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'In this recipe, we will implement the following:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
- en: Limiting access to the controller action to authorized users only
  id: totrans-54
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Limiting access to the controller action to specified IPs
  id: totrans-55
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Limiting access to specific user roles
  id: totrans-56
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-57
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Create a new application by using the Composer package manager, as described
    in the official guide at [http://www.yiiframework.com/doc-2.0/guide-start-installation.html](http://www.yiiframework.com/doc-2.0/guide-start-installation.html).
  id: totrans-58
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create `app/components/AccessRule.php`:'
  id: totrans-59
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-60
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Create `app/controllers/AccessController.php` as follows:'
  id: totrans-61
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-62
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Modify the `User` class as follows:'
  id: totrans-63
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-64
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE9]'
- en: How to do it...
  id: totrans-65
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'To use `AccessControl`, declare it in the `behaviors()` method of your controller
    class. We do this as follows:'
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-67
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Now try to run controller actions using Internet Explorer and other browsers
    by using both the `admin` and `demo` usernames.
  id: totrans-68
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-69
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We will start with limiting access to the controller action to authorized users
    only. See the following code in the `rules` array:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Each array here is an access rule. You can either use `allow=true` or `allow=false`
    for a deny rule. For each rule, there are several parameters.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
- en: By default, Yii does not deny everything, so consider adding `['allow' => false]`
    to the end of your rules list if you need maximum security.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
- en: In our rule, we use two parameters. The first is the actions parameter, which
    takes an array of actions to which the rule will be applied. The second is the
    roles parameter, which takes an array of user roles to determine the users this
    rule applies to.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
- en: 'Yii2''s built in Access Control supports only two roles by default: guest (not
    logged in), represented by `?`, and authenticated, represented by `@`.'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
- en: With simple access controls, we can just limit access to specific pages or controller
    actions based on the login state. If users are not logged in when they visit these
    pages, Yii will redirect them to the login page.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
- en: Rules are executed one by one, starting from the top, until one matches. If
    nothing matches, then the action is treated as allowed.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
- en: 'The next task is to limit access to specific IPs. In this case, the following
    two access rules are involved:'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-79
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: The first rule allows access to the IP action from a list of IPs specified.
    In our case, we are using a loopback address, which always points to our own computer.
    Try changing it to `127.0.0.2`, for example, to see how it works when the address
    does not match. The second rule denies everything, including all other IPs.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, we limit access to one specific user role, as follows:'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-82
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: The preceding rule allows a user with a role equal to `admin` to run the user
    action. Therefore, if you log in as `admin`, it will let you in, but if you log
    in as `demo`, it will not.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
- en: '![How it works...](img/image00453.jpeg)'
  id: totrans-84
  prefs: []
  type: TYPE_IMG
- en: We have overridden the standard `AccessRule` class on our own, which is located
    in the `components/AccessRule.php` file. Inside our `AccessRule` class, we have
    overridden the `matchRole` method on our own, where we get and check the current
    user role and match it with roles from our rules.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
- en: 'Finally, we need to deny access to a specific browser. For this recipe, we
    are denying only Internet Explorer 9\. The rule itself is put on top, so it executes
    first, as follows:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  id: totrans-87
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: The detection technique that we are using is not very reliable, as MSIE is contained
    in many other user agent strings. For a list of possible user agent strings, you
    can refer to [http://www.useragentstring.com/](http://www.useragentstring.com/).
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
- en: In the preceding code, we used another filter rule property named `'matchCallback'`.
    This property will apply only when functions which are described in this property
    return `true`.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
- en: Our function checks if the user agent string contains MSIE 9.0 sting. Depending
    on your requirements, you can specify any PHP code.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
- en: See also
  id: totrans-91
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In order to learn more about access control and filters, refer to the following:'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
- en: '[http://www.yiiframework.com/doc-2.0/guide-structure-filters.html](http://www.yiiframework.com/doc-2.0/guide-structure-filters.html)'
  id: totrans-93
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[http://www.yiiframework.com/doc-2.0/yii-filters-accesscontrol.html](http://www.yiiframework.com/doc-2.0/yii-filters-accesscontrol.html)'
  id: totrans-94
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[http://www.yiiframework.com/doc-2.0/yii-filters-accessrule.html](http://www.yiiframework.com/doc-2.0/yii-filters-accessrule.html)'
  id: totrans-95
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[https://github.com/yiisoft/yii2/blob/master/docs/guide/structure-filters.md](https://github.com/yiisoft/yii2/blob/master/docs/guide/structure-filters.md)'
  id: totrans-96
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[http://www.yiiframework.com/doc-2.0/guide-security-authorization.html#access-control-filter](http://www.yiiframework.com/doc-2.0/guide-security-authorization.html#access-control-filter)'
  id: totrans-97
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The *Using RBAC* recipe
  id: totrans-98
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Preventing XSS
  id: totrans-99
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: XSS stands for cross-site scripting and is a type of vulnerability that allows
    one to inject a client-side script (typically JavaScript) in a page viewed by
    other users. Considering the power of client-side scripting, this can lead to
    very serious consequences such as bypassing security checks, getting other user's
    credentials, or data leaks.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
- en: In this recipe, we will see how to prevent XSS by escaping the output with both
    `\yii\helpers\Html` and `\yii\helpers\HtmlPurifier`.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个菜谱中，我们将看到如何通过使用 `\yii\helpers\Html` 和 `\yii\helpers\HtmlPurifier` 转义输出来防止
    XSS。
- en: Getting ready
  id: totrans-102
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备中
- en: Create a new application by using the Composer package manager, as described
    in the official guide at [http://www.yiiframework.com/doc-2.0/guide-start-installation.html](http://www.yiiframework.com/doc-2.0/guide-start-installation.html).
  id: totrans-103
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按照官方指南使用 Composer 包管理器创建一个新应用，官方指南链接为 [http://www.yiiframework.com/doc-2.0/guide-start-installation.html](http://www.yiiframework.com/doc-2.0/guide-start-installation.html)。
- en: 'Create `controllers/XssController.php`:'
  id: totrans-104
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建 `controllers/XssController.php`：
- en: '[PRE15]'
  id: totrans-105
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Normally, it will be used as `/xss/simple?username=Administrator`. However,
    as the main security principle *filter input, escape output* was not taken into
    account, malicious users will be able to use it in the following way:'
  id: totrans-106
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通常，它将被用作 `/xss/simple?username=Administrator`。然而，由于没有考虑到主要的安全原则 *过滤输入，转义输出*，恶意用户将能够以下这种方式使用它：
- en: '[PRE16]'
  id: totrans-107
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: The previous code will result in a script execution, as shown in the following
    screenshot:![Getting ready](img/image00421.jpeg)
  id: totrans-108
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 之前的代码将导致脚本执行，如下截图所示：![准备中](img/image00421.jpeg)
- en: How to do it...
  id: totrans-109
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Carry out the following steps:'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 执行以下步骤：
- en: 'In order to prevent the XSS alert shown in the previous screenshot, we need
    to escape the data before passing it to the browser. We do this as follows:'
  id: totrans-111
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为了防止之前截图中的 XSS 警告，我们需要在传递给浏览器之前转义数据。我们这样做如下：
- en: '[PRE17]'
  id: totrans-112
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE17]'
- en: Now instead of an alert, we will get properly escaped HTML, as shown in the
    following screenshot:![How to do it...](img/image00435.jpeg)
  id: totrans-113
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，我们将得到正确转义的 HTML，如下截图所示：![如何操作...](img/image00435.jpeg)
- en: 'Therefore, the basic rule is to always escape all dynamic data. For example,
    we should do the same for a link name:'
  id: totrans-114
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 因此，基本规则是始终转义所有动态数据。例如，我们也应该对链接名称做同样的处理：
- en: '[PRE18]'
  id: totrans-115
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'That''s it. You have a page that is free from XSS. Now, what if we want to
    allow some HTML to pass? We cannot use `\yii\helpers\Html::encode` anymore because
    it will render HTML as just a code and we need the actual representation. Fortunately,
    there is a tool bundled with Yii that allows you to filter the malicious HTML.
    It is named `HTML Purifier` and can be used in the following way:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 就这样。你有一个没有 XSS 的页面。现在，如果我们想允许一些 HTML 通过，我们不能再使用 `\yii\helpers\Html::encode`，因为它会将
    HTML 渲染为代码，而我们需要实际的表示。幸运的是，Yii 中有一个工具可以用来过滤恶意 HTML。它被称为 `HTML Purifier`，可以使用以下方式：
- en: '[PRE19]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'Now if we access the HTML action using a URL such as `/xss/index?username=<i>username</i>!<script>alert(''XSS'')</script>`,
    HTML Purifier will remove the malicious part and we will get the following result:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 现在如果我们通过类似 `/xss/index?username=<i>username</i>!<script>alert('XSS')</script>`
    的 URL 访问 HTML 动作，HTML Purifier 将移除恶意部分，我们得到以下结果：
- en: '![How to do it...](img/image00446.jpeg)'
  id: totrans-119
  prefs: []
  type: TYPE_IMG
  zh: '![如何操作...](img/image00446.jpeg)'
- en: How it works...
  id: totrans-120
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: 'Internally, `\yii\helpers\Html::encode` looks like the following:'
  id: totrans-121
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在内部，`\yii\helpers\Html::encode` 看起来如下：
- en: '[PRE20]'
  id: totrans-122
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE20]'
- en: So basically, we use PHP's internal `htmlspecialchars` function, which is pretty
    secure if one does not forget to pass the correct charset in the third argument.
  id: totrans-123
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 因此，基本上，我们使用 PHP 的内部 `htmlspecialchars` 函数，如果不会忘记在第三个参数中传递正确的字符集，它相当安全。
- en: '`\yii\helpers\HtmlPurifier` uses the HTML Purifier library, which is the most
    advanced solution out there to prevent XSS inside of HTML. We have used its default
    configuration, which is okay for most user-entered content.'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: '`\yii\helpers\HtmlPurifier` 使用 HTML Purifier 库，这是目前最先进的解决方案，用于防止 HTML 中的 XSS。我们使用了它的默认配置，这对于大多数用户输入的内容来说是足够的。'
- en: There's more…
  id: totrans-125
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: There are more things to know about XSS and HTML Purifier; they are discussed
    in the following section.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 关于 XSS 和 HTML Purifier 有更多需要了解的内容；它们将在以下部分中讨论。
- en: XSS types
  id: totrans-127
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: XSS 类型
- en: 'There are two main types of XSS injections, which are as follows:'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: XSS 注入主要有两种类型，具体如下：
- en: Non-persistent
  id: totrans-129
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 非持久性
- en: Persistent
  id: totrans-130
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 持久性
- en: The first type is the one we have used in the recipe and is the most common
    XSS type; it can be found in most insecure web applications. Data passed by the
    user or through a URL is not stored anywhere, so the injected script will be executed
    only once and only for the user who entered it. Still, it is not as secure as
    it looks. Malicious users can include XSS in a link to another website and their
    core will be executed when another user follows the link.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
- en: The second type is much more serious, as the data entered by a malicious user
    is stored in the database and is shown to many, if not all, website users. Using
    this type of XSS, malicious users can literally destroy your website by commanding
    all users to delete all data to which they have access.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
- en: See also
  id: totrans-133
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In order to learn more about XSS and how to deal with it, refer to the following
    resources:'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
- en: '[http://htmlpurifier.org/docs](http://htmlpurifier.org/docs)'
  id: totrans-135
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[http://ha.ckers.org/xss.html](http://ha.ckers.org/xss.html)'
  id: totrans-136
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[http://shiflett.org/blog/2007/may/character-encoding-and-xss](http://shiflett.org/blog/2007/may/character-encoding-and-xss)'
  id: totrans-137
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Preventing SQL injections
  id: totrans-138
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: SQL injection is a type of code injection that uses vulnerability at the database
    level and allows you to execute arbitrary SQL, allowing malicious users to carry
    out actions such as deleting data or raising their privileges.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
- en: In this recipe, we will see examples of vulnerable code and fix them.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-141
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Create a new application by using the Composer package manager, as described
    in the official guide at [http://www.yiiframework.com/doc-2.0/guide-start-installation.html](http://www.yiiframework.com/doc-2.0/guide-start-installation.html).
  id: totrans-142
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Execute the following SQL:'
  id: totrans-143
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-144
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Generate a `User` model using Gii.
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-146
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'First, we will implement a simple action that checks whether the username and
    password that came from a URL are correct. Create `app/controllers/SqlController.php`:'
  id: totrans-147
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-148
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE22]'
- en: Let's try to access it using the `/sql/simple?username=test&password=test` URL.
    As we are unaware of both the username and password, it will, as expected, print
    **Failure**.
  id: totrans-149
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Now try `/sql/simple?username=%27+or+%271%27%3D%271%27%3B+--&password=whatever`.
    This time, it lets us in, even though we still don''t know anything about the
    actual credentials. The decoded part of `usernamevalue` looks like the following:'
  id: totrans-150
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE23]'
  id: totrans-151
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE23]'
- en: Close the quote so that the syntax stays correct. Add `OR '1'='1',` which makes
    the condition always true. Use `; --` to end the query and comment the rest.
  id: totrans-152
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'As no escaping was done, the whole query executed was:'
  id: totrans-153
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE24]'
  id: totrans-154
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'The best way to fix this is to use a prepared statement, as follows:'
  id: totrans-155
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE25]'
  id: totrans-156
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'Now check `/sql/prepared` with the same malicious parameters. This time everything
    was fine and we received the **Failure** message. The same principle applies to
    ActiveRecord. The only difference here is that AR uses other syntax:'
  id: totrans-157
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE26]'
  id: totrans-158
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'In the previous code, we used the `username` and `password` parameters like
    an array key with a value style. If we had written the previous code by using
    only the first argument, it would be vulnerable:'
  id: totrans-159
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE27]'
  id: totrans-160
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'If used properly, prepared statements can save you from all types of SQL injections.
    Still, there are some common problems:'
  id: totrans-161
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: You can only bind one value to a single parameter, so if you want to query `WHERE
    IN(1, 2, 3, 4)`, you will have to create and bind four parameters.
  id: totrans-162
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Prepared statements cannot be used for table names, column names, and other
    keywords.
  id: totrans-163
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'When using `ActiveRecord`, the first problem can be solved by adding `where`,
    as follows:'
  id: totrans-164
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE28]'
  id: totrans-165
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'The second problem can be solved in multiple ways. The first way is to rely
    on active record and PDO quoting:'
  id: totrans-166
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE29]'
  id: totrans-167
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'But the most secure way is to use the whitelist approach, as follows:'
  id: totrans-168
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE30]'
  id: totrans-169
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE30]'
- en: How it works...
  id: totrans-170
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The main goal when preventing SQL injection is to properly filter the input.
    In all cases except table names, we have used prepared statements—a feature supported
    by most relational database servers. They allows you to build statements once
    and then use them multiple times, and they provide a safe way of binding parameter
    values.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
- en: 'In Yii, you can use prepared statements for both Active Record and DAO. When
    using DAO, it can be achieved by using either `bindValue` or `bindParam`. The
    latter is useful when we want to execute multiple queries of the same type while
    varying parameter values:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: Most Active Record methods accept parameters. To be safe, you should use these
    instead of just passing the raw data in.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
- en: As for quoting table names, columns, and other keywords, you can either rely
    on Active Record or use the whitelist approach.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
- en: See also
  id: totrans-176
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In order to learn more about SQL injections and working with databases through
    Yii, refer to the following:'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
- en: '[http://www.slideshare.net/billkarwin/sql-injection-myths-and-fallacies](http://www.slideshare.net/billkarwin/sql-injection-myths-and-fallacies)'
  id: totrans-178
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[http://www.yiiframework.com/doc-2.0/yii-db-connection.html](http://www.yiiframework.com/doc-2.0/yii-db-connection.html)'
  id: totrans-179
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[http://www.yiiframework.com/doc-2.0/yii-db-command.html](http://www.yiiframework.com/doc-2.0/yii-db-command.html)'
  id: totrans-180
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[http://www.yiiframework.com/doc-2.0/guide-security-best-practices.html#avoiding-sql-injections](http://www.yiiframework.com/doc-2.0/guide-security-best-practices.html#avoiding-sql-injections)'
  id: totrans-181
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The *Getting data from a database* recipe in [Chapter 3](part0039.xhtml#1565U1-ae331331bc644dc9b658d3634f0748da
    "Chapter 3. ActiveRecord, Model, and Database"), *ActiveRecord, Model, and Database*
  id: totrans-182
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Preventing CSRF
  id: totrans-183
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: CSRF is an abbreviation for cross-site request forgery, where a malicious user
    tricks the user's browser into silently performing an HTTP request to the website
    when the user is logged in.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
- en: 'An example of such an attack is inserting an invisible image tag with `src`
    pointing to `http://example.com/site/logout`. Even if the `image` tag is inserted
    in another website, you will be immediately logged out from `example.com`. The
    consequences of CSRF can be very serious: destroying website data, preventing
    all website users from logging in, exposing private data, and so on.'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
- en: 'Some facts about CSRF:'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
- en: As CSRF should be performed by the victim user's browser, the attacker cannot
    normally change the HTTP headers sent. However, there are both browser and Flash
    plugin vulnerabilities that exist which allow users to spoof headers, so we should
    not rely on these.
  id: totrans-187
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The attacker should pass the same parameters and values as the user would normally.
  id: totrans-188
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Considering these, a good method of dealing with CSRF is by passing and checking
    a unique token during form submissions and, additionally, using GET according
    to the HTTP specification.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
- en: Yii includes built-in token generation and token checking. Additionally, it
    can automate inserting a token into the HTML forms.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
- en: 'In order to avoid CSRF, you should always:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
- en: Follow, HTTP specification, that is, `GET` should not change its application
    state
  id: totrans-192
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Keep Yii CSRF protection enabled
  id: totrans-193
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: In this recipe, we will see how to make sure our application is CSRF-resistant.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-195
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Create a new application by using the Composer package manager, as described
    in the official guide at [http://www.yiiframework.com/doc-2.0/guide-start-installation.html](http://www.yiiframework.com/doc-2.0/guide-start-installation.html).
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-197
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In order to turn ON the anti-CSRF protection, we should add `config/main.php`
    as follows:'
  id: totrans-198
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE32]'
  id: totrans-199
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE32]'
- en: The option `enableCsrfValidation` defaults to `true`. When CSRF validation is
    enabled, forms submitted to a Yii web application must originate from the same
    application. If not, a `400 HTTP exception` will be raised.
  id: totrans-200
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note that this feature requires that the user client accepts cookies.
  id: totrans-201
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'After configuring the application, you should use `ActiveForm::beginForm` and
    `CHtml::endForm` instead of HTML form tags in view with `ActiveForm`:'
  id: totrans-202
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE33]'
  id: totrans-203
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'OR manually:'
  id: totrans-204
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE34]'
  id: totrans-205
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'In the first case, Yii automatically adds a hidden token field, as follows:'
  id: totrans-206
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE35]'
  id: totrans-207
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE35]'
- en: If you save this form as HTML and try submitting it, you will get a message
    like the one shown in the following screenshot instead of regular data processing:![How
    to do it...](img/image00464.jpeg)
  id: totrans-208
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-209
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Internally, during form rendering, we have code like this:'
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE36]'
  id: totrans-211
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: In the previous code, `getCsrfToken()` generates a unique token value and writes
    it to a cookie. Then, on subsequent requests, both the cookie and `POST` values
    are compared. If they don't match, an error message is shown instead of usual
    data processing.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
- en: If you need to perform a `POST` request but don't want to build a form using
    `CHtml`, then you can pass a parameter with a name from `Yii::app()->request->csrfParam`
    and a value from `Yii::$app->request->getCsrfToken()`.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
- en: There's more...
  id: totrans-214
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Lets have a look at some more features.
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
- en: Disabling CSRF-tokens for all actions
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
- en: If you have a problem with `enableCsrfValidation` you can switch it off.
  id: totrans-217
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'To disable CSRF, add this code to your controller:'
  id: totrans-218
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE37]'
  id: totrans-219
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE37]'
- en: Disabling CSRF-tokens for a specific action
  id: totrans-220
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '[PRE38]'
  id: totrans-221
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: CSRF validation for Ajax-calls
  id: totrans-222
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'When the `enableCsrfValidation` option is enabled in the main layout, add `csrfMetaTags`:'
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE39]'
  id: totrans-224
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: Additionally [rename]
  id: totrans-225
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: If your application requires a very high security level, such as a bank account
    management system, extra measures can be taken.
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
- en: 'First, you can turn off the remember me feature using `config/main.php,` as
    follows:'
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE40]'
  id: totrans-228
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: Note that this will not work if the `enabledSession` option is `true`.
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
- en: 'Then, you can lower the session timeout, as follows:'
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE41]'
  id: totrans-231
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: This sets the number of seconds after which data will be seen as *garbage* and
    cleaned up.
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
- en: Of course, these measures will make the user experience worse, but they will
    add an additional level of security.
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
- en: Using GET and POST properly
  id: totrans-234
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: HTTP insists on not using `GET` operations that change data or state. Sticking
    to this rule is good practice. It will not prevent all types of CSRF, but it will
    at least implement some injections, such as `<img src=, pointless>`.
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
- en: See also
  id: totrans-236
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In order to learn more about SQL injections and working with databases through
    Yii, refer to the following URLs:'
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
- en: '[http://en.wikipedia.org/wiki/Cross-site_request_forgery](http://en.wikipedia.org/wiki/Cross-site_request_forgery)'
  id: totrans-238
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[http://www.yiiframework.com/doc-2.0/guide-security-best-practices.html#avoiding-csrf](http://www.yiiframework.com/doc-2.0/guide-security-best-practices.html#avoiding-csrf)'
  id: totrans-239
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[http://www.yiiframework.com/doc-2.0/yii-web-request.html#$enableCsrfValidation-detail](http://www.yiiframework.com/doc-2.0/yii-web-request.html#%24enableCsrfValidation-detail)'
  id: totrans-240
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The *Preventing XSS* recipe.
  id: totrans-241
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using RBAC
  id: totrans-242
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '**Role-Based Access Control** (**RBAC**) provides simple yet powerful centralized
    access control. It is the most powerful access control method available in Yii.
    It is described in the guide, but since it is rather complex and powerful, it
    is not as easy to understand without getting under the hood a little.'
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
- en: In this recipe, we will take the roles hierarchy from the definitive guide,
    import it, and explain what is happening internally.
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-245
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Create a new application by using the Composer package manager, as described
    in the official guide at [http://www.yiiframework.com/doc-2.0/guide-start-installation.html](http://www.yiiframework.com/doc-2.0/guide-start-installation.html).
  id: totrans-246
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Create a MySQL database and configure it.
  id: totrans-247
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Configure the `authManager` component in your `config/main.php` and `config/console.php`
    as follows:'
  id: totrans-248
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE42]'
  id: totrans-249
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE42]'
- en: 'Run the migration:'
  id: totrans-250
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE43]'
  id: totrans-251
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE43]'
- en: How to do it...
  id: totrans-252
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Carry out the following steps:'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
- en: 'Create the access rule `rbac/AuthorRule.php`:'
  id: totrans-254
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE44]'
  id: totrans-255
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE44]'
- en: 'Create a console command, `command/RbacController.php`, to `init` the RBAC
    rules command:'
  id: totrans-256
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE45]'
  id: totrans-257
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE45]'
- en: 'That''s it. Run it in the console:'
  id: totrans-258
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE46]'
  id: totrans-259
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE46]'
- en: 'Create `controllers/RbacController.php` as follows:'
  id: totrans-260
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE47]'
  id: totrans-261
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE47]'
- en: Now run `rbac/test` once to check access to all the created permissions of the
    RBAC hierarchy:![How to do it...](img/image00468.jpeg)
  id: totrans-262
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Then, try to log in as `demo` (the password is `demo`) and run `rbac/test` again:![How
    to do it...](img/image00494.jpeg)
  id: totrans-263
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Then, try to log in as `admin` (the password is `admin`) and run `rbac/test`
    again:![How to do it...](img/image00473.jpeg)
  id: totrans-264
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Log in as `demo` user and run `rbac/delete`:![How to do it...](img/image00475.jpeg)
  id: totrans-265
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Log in as `admin` and run `rbac/delete`:![How to do it...](img/image00536.jpeg)
  id: totrans-266
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works…
  id: totrans-267
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Yii implements a general hierarchical RBAC following the `NIST RBAC` model.
    It provides RBAC functionality through the `authManagerapplication` component.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
- en: 'The RBAC hierarchy is a directed acyclic graph, that is, a set of nodes and
    their directed connections or edges. There are three types of node available:
    roles, permissions, and rules.'
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
- en: A role represents a collection of permissions (for example creating posts and
    updating posts). A role may be assigned to one or multiple users. To check if
    a user has a specified permission, we may check whether the user is assigned with
    a role that contains that permission.
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
- en: Both roles and permissions can be organized in a hierarchy. In particular, a
    role may consist of other roles or permissions, and a permission may consist of
    other permissions. Yii implements a partial-order hierarchy, which includes the
    more special `tree` hierarchy. While a role can contain a permission, it is not
    true vice versa.
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
- en: 'For testing permissions, we have created two actions. The first action, `test`,
    contains checkers for created permissions and roles. The second action is `delete`,
    which is limited through the access filter. The rule for the access filter contains
    the following code:'
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE48]'
  id: totrans-273
  prefs: []
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'This means that we are allowing all users who have the `deletePost` permission
    to run the `deletePost` action. Yii starts checking with the `deletePost` permission.
    Besides the fact that the access rule element is named as `roles`, you can specify
    an RBAC hierarchy node be it a role, rule, or permission. Checking for `updatePost`
    is complex:'
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE49]'
  id: totrans-275
  prefs: []
  type: TYPE_PRE
  zh: '[PRE49]'
- en: We use a second parameter to pass a post (in our case, we have simulated it
    with `stdClass`). If a user is logged in as `demo`, then to get access we need
    to go from `updatePost` to author. If you're lucky, you only have to go through
    `updatePost`, `updateOwnPost`, and author.
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
- en: As `updateOwnPost` has a rule defined, it will be run with a parameter passed
    to `checkAccess`. If the result is true, then access will be granted. As Yii does
    not know what the shortest way is, it tries to check all possibilities until it
    is successful, or no alternatives are left.
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
- en: There's more…
  id: totrans-278
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: There are some useful tricks that will help you to use RBAC efficiently, which
    are discussed in the following subsections.
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
- en: Keeping hierarchy simple and efficient
  id: totrans-280
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Follow these recommendations where possible to maximize the performance and
    reduce hierarchy complexity:'
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
- en: Avoid attaching multiple roles to a single user
  id: totrans-282
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Don't connect nodes of the same type; so, for example, avoid connecting one
    task to another
  id: totrans-283
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Naming RBAC nodes
  id: totrans-284
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'A complex hierarchy becomes difficult to understand without using some kind
    of naming convention. One possible convention that helps to limit confusion is
    as follows:'
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE50]'
  id: totrans-286
  prefs: []
  type: TYPE_PRE
  zh: '[PRE50]'
- en: Where `own` is used when the rule determines an ability to modify an element
    only if the current user is the owner of the element and the `group` is just a
    namespace. The `entity` is the name of the entity we are working with and `action`
    is the action that we are performing.
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
- en: For example, if we need to create a rule that determines whether the user can
    delete a blog post, we will name it `blog_post_delete`. If the rule determines
    whether a user can edit his or her own blog comment, the name will be `blog_own_comment_edit`.
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
- en: See also
  id: totrans-289
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In order to learn more about SQL injections and working with databases through
    Yii, refer to the following:'
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
- en: '[http://csrc.nist.gov/rbac/sandhu-ferraiolo-kuhn-00.pdf](http://csrc.nist.gov/rbac/sandhu-ferraiolo-kuhn-00.pdf)'
  id: totrans-291
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[http://en.wikipedia.org/wiki/Role-based_access_control](http://en.wikipedia.org/wiki/Role-based_access_control)'
  id: totrans-292
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[http://en.wikipedia.org/wiki/Directed_acyclic_graph](http://en.wikipedia.org/wiki/Directed_acyclic_graph)'
  id: totrans-293
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[http://www.yiiframework.com/doc-2.0/guide-security-authorization.html#role-based-access-control-rbac](http://www.yiiframework.com/doc-2.0/guide-security-authorization.html#role-based-access-control-rbac)'
  id: totrans-294
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The *Using controller filters* recipe
  id: totrans-295
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Encrypting/Decrypting data
  id: totrans-296
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The Yii2 framework contains a special security component that provides a set
    of methods for handling common security-related tasks. The `\yii\base\Security`
    class requires the `OpenSSL` PHP extension instead of `mcrypt`.
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-298
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Create a new application by using the Composer package manager, as described
    in the official guide at [http://www.yiiframework.com/doc-2.0/guide-start-installation.html](http://www.yiiframework.com/doc-2.0/guide-start-installation.html).
  id: totrans-299
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Set up the database connection and create a table named `order`, as follows:'
  id: totrans-300
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE51]'
  id: totrans-301
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE51]'
- en: Generate an `Order` model using Gii.
  id: totrans-302
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-303
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Add an additional key parameter to `config/params.php`, as follows:'
  id: totrans-304
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE52]'
  id: totrans-305
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE52]'
- en: 'Add the `behaviors` and `helper` properties to the `Order` model as follows:'
  id: totrans-306
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE53]'
  id: totrans-307
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE53]'
- en: 'Add `controllers/CryptoController.php`:'
  id: totrans-308
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE54]'
  id: totrans-309
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE54]'
- en: Run `crypto/test` and you will get the following:![How to do it...](img/image00482.jpeg)
  id: totrans-310
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: To view raw data, run `crypto/raw`:![How to do it...](img/image00484.jpeg)
  id: totrans-311
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-312
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Firstly, we have added the `AttributeBehavior,` which automatically processes
    our data when certain events happen. Our certain events are `ActiveRecord::EVENT_AFTER_INSERT,
    ActiveRecord::EVENT_AFTER_UPDATE` and `ActiveRecord::EVENT_AFTER_FIND`.
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
- en: 'During insert and update events, we decrypt our data with a special method:
    `Yii::$app->security->encryptByKey();`. This method uses HKDF and a random salt
    to decrypt our data before saving it to the database. After getting data from
    the database, we can also use the `ActiveRecord::EVENT_AFTER_FIND` method to decrypt
    our data. In this case, we also use the special Yii2 method `Yii::$app->security->encryptByKey();`.This
    method accepts two params: encrypted data and key.'
  id: totrans-314
  prefs: []
  type: TYPE_NORMAL
- en: There's more…
  id: totrans-315
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Besides data encryption and data decryption, a secure component also provides
    key derivation using standard algorithms, data tampering prevention, and password
    validation.
  id: totrans-316
  prefs: []
  type: TYPE_NORMAL
- en: Working with passwords
  id: totrans-317
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Verifying a password:'
  id: totrans-318
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE55]'
  id: totrans-319
  prefs: []
  type: TYPE_PRE
  zh: '[PRE55]'
- en: See also
  id: totrans-320
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In order to learn more about SQL injections and working with databases through
    Yii, refer to [http://www.yiiframework.com/doc-2.0/guide-security-passwords.html](http://www.yiiframework.com/doc-2.0/guide-security-passwords.html)
  id: totrans-321
  prefs: []
  type: TYPE_NORMAL
