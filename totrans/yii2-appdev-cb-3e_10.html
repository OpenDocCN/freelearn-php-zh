<html><head></head><body><div class="chapter" id="352RK1-ae331331bc644dc9b658d3634f0748da" title="Chapter&#xA0;10.&#xA0;Deployment"><div class="titlepage"><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Deployment</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Changing the Yii directory layout</li><li class="listitem">Moving an application webroot</li><li class="listitem">Changing an advanced application template</li><li class="listitem">Moving configuration parts into separate files</li><li class="listitem">Using multiple configurations to simplify the deployment</li><li class="listitem">Implementing and executing cron jobs</li><li class="listitem">Maintenance mode</li><li class="listitem">Deployment tools</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec100"/>Introduction</h1></div></div></div><p>In this chapter, we will cover various tips that are especially useful during application deployment; these tips will also come in handy when developing an application in a team or when you just want to make your development environment more comfortable.</p></div></div>
<div class="section" title="Changing the Yii directory layout"><div class="titlepage" id="361C62-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch10lvl1sec101"/>Changing the Yii directory layout</h1></div></div></div><p>By default, we have the Basic and Advanced Yii2 application skeletons with different directory <a class="indexterm" id="id748"/>structures. But these structures are not dogmatic, and we can customize them if required.</p><p>For example, we can move the runtime directory out of the project.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec359"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> <a class="indexterm" id="id749"/>application by using the Composer the package manager, as <a class="indexterm" id="id750"/>described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guidestart-installation.html">http://www.yiiframework.com/doc-2.0/guidestart-installation.html</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec360"/>How to do it...</h2></div></div></div><div class="section" title="Changing the location of the runtime directory"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec45"/>Changing the location of the runtime directory</h3></div></div></div><p>Open <code class="literal">config/web.php</code> and <code class="literal">config/console.php</code> and define <a class="indexterm" id="id751"/>the <code class="literal">runtimePath</code> parameter:</p><div class="informalexample"><pre class="programlisting">$config = [
    'id' =&gt; 'basic',
    'basePath' =&gt; dirname(__DIR__),
    'bootstrap' =&gt; ['log'],
    'runtimePath' =&gt; '/tmp/runtime',
    'components' =&gt; [
        // ...
    ],
]</pre></div><p>Move the runtime  directory to the new location.</p></div><div class="section" title="Changing the location of the vendor directory"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec46"/>Changing the location of the vendor directory</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">config/web.php</code> and <code class="literal">config/console.php</code> and <a class="indexterm" id="id752"/>define the <code class="literal">vendorPath</code> parameter:<div class="informalexample"><pre class="programlisting">$config = [
    'id' =&gt; 'basic',
    'basePath' =&gt; dirname(__DIR__),
    'bootstrap' =&gt; ['log'],
    'vendorPath' =&gt; dirname(__DIR__), '/../vendor,
    'components' =&gt; [
        // ...
    ],
]</pre></div></li><li class="listitem">Move the <code class="literal">vendor</code> directory with the <code class="literal">composer.json</code> and <code class="literal">composer.lock</code> files to the new location.</li><li class="listitem">Open the <code class="literal">web/index.php</code> and <code class="literal">yii</code> files and find these rows:<div class="informalexample"><pre class="programlisting">require(__DIR__ . '/../vendor/autoload.php');
require(__DIR__ . '/../vendor/yiisoft/yii2/Yii.php');</pre></div></li><li class="listitem">Change the including paths.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="Changing the location of the controllers"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec47"/>Changing the location of the controllers</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Rename the <code class="literal">commands</code> directory to <code class="literal">console</code>.</li><li class="listitem">Change the <a class="indexterm" id="id753"/>namespace of <code class="literal">app\commands\HelloController</code> to <code class="literal">app\console\HelloController</code>.</li><li class="listitem">Open <code class="literal">config/console.php</code> and redefine the <code class="literal">controllerNamespace</code> parameter:<div class="informalexample"><pre class="programlisting">$config = [
    'id' =&gt; 'basic-console',
    'basePath' =&gt; dirname(__DIR__),
    'bootstrap' =&gt; ['log'],
    'controllerNamespace' =&gt; 'app\console,
    'components' =&gt; [
        // ...
    ],
]</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="Changing the locations of the views directory"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec48"/>Changing the locations of the views directory</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">config/web.php</code> and <a class="indexterm" id="id754"/>define <code class="literal">viewPath</code> parameter:<div class="informalexample"><pre class="programlisting">$config = [
    'id' =&gt; 'basic',
    'basePath' =&gt; dirname(__DIR__),
    'bootstrap' =&gt; ['log'],
    'viewPath' =&gt; '@app/myviews',
    'components' =&gt; [
        // ...
    ],
]</pre></div></li><li class="listitem">Rename your <code class="literal">views</code> directory.</li></ol><div style="height:10px; width: 1px"/></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec361"/>How it works...</h2></div></div></div><p>In the <code class="literal">yii\base\Application::preInit</code> method our application defines <code class="literal">basePath</code>, <code class="literal">runtimePath</code>, and <code class="literal">vendorPath</code> parameters.</p><p>By default, these values lead to the root application directory, <code class="literal">runtime</code> and <code class="literal">vendor</code> path in the root respectively.</p><p>For example, you can <a class="indexterm" id="id755"/>redefine <code class="literal">vendorPath</code> if you want to share the vendor directory with some instances of the same projects. But take care of the package's versions compatibility.</p><p>The <code class="literal">yii\base\Application</code> class extends <code class="literal">yii\base\Module</code>, which contains the <code class="literal">controllerNamespace</code> and <code class="literal">viewPath</code> parameters. The first one allows you to change the base namespace of the application and modules. It is helpful if you want to provide frontend and backend controllers in the same module directory. Just change the <code class="literal">controllers</code> directory to frontend and backend or create subdirectories and configure your frontend and backend applications:</p><div class="informalexample"><pre class="programlisting">return [
    'id' =&gt; 'app-frontend',
    'basePath' =&gt; dirname(__DIR__),
    'controllerNamespace' =&gt; frontend\controllers',
    'bootstrap' =&gt; ['log'],
    'modules' =&gt; [
        'user' =&gt; [
            'my\user\Module',
            'controllerNamespace' =&gt; 'my\user\controllers\frontend',
        ]
    ],
    // ...
]
return [
    'id' =&gt; 'app-backend',
    'basePath' =&gt; dirname(__DIR__),
    'controllerNamespace' =&gt; 'backend\controllers',
    'bootstrap' =&gt; ['log'],
    'modules' =&gt; [
        'user' =&gt; [
            'my\user\Module',
            'controllerNamespace' =&gt; 'my\user\controllers\backend',
        ]
    ],
    // ...
]</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec362"/>See also</h2></div></div></div><p>In order to learn more <a class="indexterm" id="id756"/>about application structures, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-structure-applications.html">http://www.yiiframework.com/doc-2.0/guide-structure-applications.html</a>.</p></div></div>
<div class="section" id="36VSO1-ae331331bc644dc9b658d3634f0748da" title="Moving an application webroot"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec102"/>Moving an application webroot</h1></div></div></div><p>By default, Yii2 <a class="indexterm" id="id757"/>applications work from the <code class="literal">web</code> directory for your site's entry script. But shared hosting environments are often quite limited when it comes to the configuration and directory structure. You cannot change the working directory for your site. Most servers provide only the <code class="literal">public_html</code> directory for your site entry scripts.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec363"/>Getting ready</h2></div></div></div><p>Create <a class="indexterm" id="id758"/>a new <code class="literal">yii2-app-basic</code> application by using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guidestart-installation.html">http://www.yiiframework.com/doc-2.0/guidestart-installation.html</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec364"/>How to do it...</h2></div></div></div><p>Let's discuss the ways to move an application webroot.</p><div class="section" title="Placing files in the root"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec49"/>Placing files in the root</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Upload the <a class="indexterm" id="id759"/>application files into your hosting.</li><li class="listitem">Rename the <code class="literal">web</code> directory to <code class="literal">public_html</code>.</li><li class="listitem">Check that the site works correctly.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="Placing files in a subdirectory"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec50"/>Placing files in a subdirectory</h3></div></div></div><p>A hosting user <a class="indexterm" id="id760"/>directory may contain other files and folders. Here's how you can move files to a subdirectory:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">application</code> and <code class="literal">public_html</code> directories.</li><li class="listitem">Move the application files to the <code class="literal">application</code> directory.</li><li class="listitem">Move the content of the <code class="literal">application/web</code> directory to <code class="literal">public_html</code>.</li><li class="listitem">Open the <code class="literal">public_html/index.php</code> file and change the include paths:<div class="informalexample"><pre class="programlisting">require(__DIR__ . '/../application/vendor/autoload.php');
require(__DIR__ . '/../application/vendor/yiisoft/yii2/Yii.php');</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec365"/>How it works...</h2></div></div></div><p>The Yii2 application <a class="indexterm" id="id761"/>automatically sets the <code class="literal">@web</code> and <code class="literal">@webroot</code> alias paths on the base of the entry script location. Therefore we can easily move or rename a <code class="literal">web</code> directory without changing the application configurations.</p><p>For <code class="literal">yii2-app-advanced</code>, you can <a class="indexterm" id="id762"/>move the <code class="literal">web</code> directory content from <code class="literal">backend</code> to a subdirectory, such as <code class="literal">admin</code>:</p><div class="informalexample"><pre class="programlisting">public_html
    index.php
    ...
    admin
        index.php
        ...       
backend
common
console
frontend
...</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec366"/>See also</h2></div></div></div><p>To get more information <a class="indexterm" id="id763"/>on installing Yii on a shared hosting environment, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-tutorial-shared-hosting.html">http://www.yiiframework.com/doc-2.0/guide-tutorial-shared-hosting.html</a>.</p></div></div>
<div class="section" id="37UDA1-ae331331bc644dc9b658d3634f0748da" title="Changing an advanced application template"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec103"/>Changing an advanced application template</h1></div></div></div><p>By default, Yii2's Advanced template has <code class="literal">console</code>, <code class="literal">frontend</code>, and <code class="literal">backend</code> applications. However, in <a class="indexterm" id="id764"/>your specific case, you can rename the existing ones and create your own applications. For example you can add the <code class="literal">api</code> application if you develop an API for your site.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec367"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-advanced</code> project by using the Composer package manager, as described in the official guide at <a class="ulink" href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-installation.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-installation.md</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec368"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Copy the <code class="literal">backend</code> directory content to a new <code class="literal">api</code> directory in the root of your application.</li><li class="listitem">Open the <code class="literal">api/config/main.php</code> file and change the <code class="literal">controllerNamespace</code> option value:<div class="informalexample"><pre class="programlisting">return [
    'id' =&gt; 'app-manager',
    'basePath' =&gt; dirname(__DIR__),
    'controllerNamespace' =&gt; 
    'api\controllers',
    // ....
]</pre></div></li><li class="listitem">Open <code class="literal">api/assets/AppAsset.php</code> and <code class="literal">api/controllers/SiteController.php</code> and change the namespaces from <code class="literal">backend</code> to <code class="literal">api</code> like this:<div class="informalexample"><pre class="programlisting">namespaces api\assets;
namespaces api\controllers;</pre></div></li><li class="listitem">Open the <code class="literal">api/views/layouts/main.php</code> file and find the following row:<div class="informalexample"><pre class="programlisting">use backend\assets\AppAsset;</pre></div><p>Change it to this:</p><div class="informalexample"><pre class="programlisting">use api\assets\AppAsset;</pre></div></li><li class="listitem">Open <code class="literal">common/config/bootstrap.php</code> and <a class="indexterm" id="id765"/>add the <code class="literal">@api</code> alias for the new application:<div class="informalexample"><pre class="programlisting">&lt;?php
Yii::setAlias('@common', dirname(__DIR__));
Yii::setAlias('@frontend', dirname(dirname(__DIR__)) . '/frontend');
Yii::setAlias('@backend', dirname(dirname(__DIR__)) . '/backend');
Yii::setAlias('@console', dirname(dirname(__DIR__)) . '/console');
Yii::setAlias('@api', dirname(dirname(__DIR__)) . '/api);</pre></div></li><li class="listitem">Open the <code class="literal">environments</code> directory, and in the <code class="literal">dev</code> and <code class="literal">prod</code> subdirectories make the <code class="literal">api</code> directories copies of <code class="literal">backend</code>.</li><li class="listitem">Open the <code class="literal">environments/index.php</code> file and add rows for the <code class="literal">api</code> application:<div class="informalexample"><pre class="programlisting">return [
    'Development' =&gt; [
        'path' =&gt; 'dev',
        'setWritable' =&gt; [
            'backend/runtime',
            'backend/web/assets',
            'frontend/runtime',
            'frontend/web/assets',
            'api/runtime',
            'api/web/assets',
        ],
        'setExecutable' =&gt; [
            'yii',
            'tests/codeception/bin/yii',
        ],
        'setCookieValidationKey' =&gt; [
            'backend/config/main-local.php',
            'frontend/config/main-local.php',
            'api/config/main-local.php',
        ],
    ],
    'Production' =&gt; [
        'path' =&gt; 'prod',
        'setWritable' =&gt; [
            'backend/runtime',
            'backend/web/assets',
            'frontend/runtime',
            'frontend/web/assets',
            'api/runtime',
            'api/web/assets',
        ],
        'setExecutable' =&gt; [
            'yii',
        ],
        'setCookieValidationKey' =&gt; [
            'backend/config/main-local.php',
            'frontend/config/main-local.php',
            'api/config/main-local.php',
        ],
    ],
];</pre></div></li></ol><div style="height:10px; width: 1px"/></div><p>Now you have the <code class="literal">console</code>, <code class="literal">frontend</code>, <code class="literal">backend</code>, and <code class="literal">api</code> applications.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec369"/>How it works...</h2></div></div></div><p>The Advanced application <a class="indexterm" id="id766"/>template is a set of applications with custom aliases, such as <code class="literal">@frontend</code>, <code class="literal">@backend</code>, <code class="literal">@common</code>, and <code class="literal">@console</code> and corresponding namespaces instead of the simple <code class="literal">@app</code> alias for the <code class="literal">Basic</code> template.</p><p>You can easily add, remove, or rename this applications (with their aliases and namespaces) if needed.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec370"/>See also</h2></div></div></div><p>For getting more <a class="indexterm" id="id767"/>information about the usage of application directory structures refer to <a class="ulink" href="https://github.com/yiisoft/yii2-app-advanced/tree/master/docs/guide">https://github.com/yiisoft/yii2-app-advanced/tree/master/docs/guide</a>.</p></div></div>
<div class="section" id="38STS1-ae331331bc644dc9b658d3634f0748da" title="Moving configuration parts into separate files"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec104"/>Moving configuration parts into separate files</h1></div></div></div><p>In the basic application template we have separated web and console configuration files. And usually we set <a class="indexterm" id="id768"/>some application components in the both the configuration files.</p><p>Moreover, when we develop a big application, we may face some inconvenience. For example, if we need to adjust some settings, we would most probably end up repeating the changes in both the web application config and console application config.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec371"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application by using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guidestart-installation.html">http://www.yiiframework.com/doc-2.0/guidestart-installation.html</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec372"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">config/web.php</code> file and add the <code class="literal">urlManager</code> section to the components configuration:<div class="informalexample"><pre class="programlisting">'components' =&gt; [
    // ...
    'db' =&gt; require(__DIR__ . '/db.php'),
    'urlManager' =&gt; [
        'class' =&gt; 'yii\web\UrlManager',
        'enablePrettyUrl' =&gt; true,
        'showScriptName' =&gt; false,
        'rules' =&gt; [
            '' =&gt; 'site/index',
            '&lt;_c:[\w\-]+&gt;/&lt;id:\d+&gt;' =&gt; '&lt;_c&gt;/view',
            '&lt;_c:[\w\-]+/&lt;_a:[\w\-]+&gt;&gt;/&lt;id:\d+&gt;' =&gt; '&lt;_c&gt;/&lt;_a&gt;',
            '&lt;_c:[\w\-]+&gt;' =&gt; 
            '&lt;_c&gt;/index',
        ],
    ],
],</pre></div></li><li class="listitem">Create the <code class="literal">config/urlRules.php</code> file and move rules array into it:<div class="informalexample"><pre class="programlisting">&lt;?php
return [
    '' =&gt; 'site/index',
    '&lt;_c:[\w\-]+&gt;/&lt;id:\d+&gt;' =&gt; '&lt;_c&gt;/view',
    '&lt;_c:[\w\-]+/&lt;_a:[\w\-]+&gt;&gt;/&lt;id:\d+&gt;' =&gt; '&lt;_c&gt;/&lt;_a&gt;',
    '&lt;_c:[\w\-]+&gt;' =&gt; '&lt;_c&gt;/index',
];</pre></div></li><li class="listitem">Replace the rule array <a class="indexterm" id="id769"/>with the file that requires this:<div class="informalexample"><pre class="programlisting">'urlManager' =&gt; [
    'class' =&gt; 'yii\web\UrlManager',
    'enablePrettyUrl' =&gt; true,
    'showScriptName' =&gt; false,
    'rules' =&gt; require(__DIR__ .  '/urlRules.php'),
],</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec373"/>How it works...</h2></div></div></div><p>The preceding technique relies on the fact that Yii configuration files are native PHP files with arrays:</p><div class="informalexample"><pre class="programlisting">&lt;?php
return [...];</pre></div><p>Let's look at the <code class="literal">require</code> construct:</p><div class="informalexample"><pre class="programlisting">'rules' =&gt; require(__DIR__ . '/urlRules.php'),</pre></div><p>When we use this, it reads the file specified, and, if there is a <code class="literal">return</code> statement inside this file, it returns a value.</p><p>Therefore, moving a part out of the main configuration file into a separate file requires creating a separate file, moving the <a class="indexterm" id="id770"/>configuration part into it right after the <code class="literal">return</code> statement, and using <code class="literal">require</code> in the main configuration file.</p><p>If separate applications (in our example, these are web applications and console applications) require some common configuration parts, then we can use <code class="literal">require</code> to move them into a separate file.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec374"/>See also</h2></div></div></div><p>In order to learn more <a class="indexterm" id="id771"/>about PHP <a class="indexterm" id="id772"/>
<code class="literal">require</code> and <code class="literal">include</code> statements, refer to the following URLs:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><a class="ulink" href="http://php.net/manual/en/function.require.php">http://php.net/manual/en/function.require.php</a></li><li class="listitem"><a class="ulink" href="http://php.net/manual/en/function.include.php">http://php.net/manual/en/function.include.php</a></li></ul></div></div></div>
<div class="section" title="Using multiple configurations to simplify the deployment"><div class="titlepage" id="39REE2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch10lvl1sec105"/>Using multiple configurations to simplify the deployment</h1></div></div></div><p>The Advanced application <a class="indexterm" id="id773"/>template <a class="indexterm" id="id774"/>uses different configuration files for each of its applications:</p><div class="informalexample"><pre class="programlisting">common
    config
        main.php
        main-local.php
        params.php
        params-local.php
console
    config
        main.php
        main-local.php
        params.php
        params-local.php
backend
    config
        main.php
        main-local.php
        params.php
        params-local.php
frontend
    config
        main.php
        main-local.php
        params.php
        params-local.php</pre></div><p>Each entry <code class="literal">web/index.php</code> script merges own set of configuration files:</p><div class="informalexample"><pre class="programlisting">$config = yii\helpers\ArrayHelper::merge(
    require(__DIR__ . '/../../common/config/main.php'),
    require(__DIR__ . '/../../common/config/main-local.php'),
    require(__DIR__ . '/../config/main.php'),
    require(__DIR__ . '/../config/main-local.php')
);
$application = new yii\web\Application($config);
$application-&gt;run();</pre></div><p>Each <code class="literal">config/main.php</code> file merges parameters:</p><div class="informalexample"><pre class="programlisting">&lt;?php
$params = array_merge(
    require(__DIR__ . '/../../common/config/params.php'),
    require(__DIR__ . '/../../common/config/params-local.php'),
    require(__DIR__ . '/params.php'),
    require(__DIR__ . '/params-local.php')
);
return [
    // ... 
    'params' =&gt; $params,
];</pre></div><p>This system allows you to configure both <a class="indexterm" id="id775"/>common and specific application properties and components of our applications. And <a class="indexterm" id="id776"/>we can store default configuration files on the version control system and ignore all the <code class="literal">*-local.php</code> files.</p><p>All local files templates are prepared in the <code class="literal">environments</code> directory. When you run <code class="literal">php init</code> in your console and choose a needle environment, this initialization script makes copies of the corresponded files and places them into target folders.</p><p>But the Basic application template does not contain an agile configuration system and provides only the following files:</p><div class="informalexample"><pre class="programlisting">config
    console.php
    web.php
    db.php
    params.php</pre></div><p>Let's try to add an advanced configuration system to the <code class="literal">yii2-app</code>
<code class="literal">-basic</code> application template.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec375"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application by using <a class="indexterm" id="id777"/>the Composer <a class="indexterm" id="id778"/>package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guidestart-installation.html">http://www.yiiframework.com/doc-2.0/guidestart-installation.html</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec376"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">config/common.php</code> file:<div class="informalexample"><pre class="programlisting">&lt;?php
$params = array_merge(
    require(__DIR__ . '/params.php'),
    require(__DIR__ . '/params-local.php')
);
return [
    'basePath' =&gt; dirname(__DIR__),
    'components' =&gt; [
        'cache' =&gt; [
            'class' =&gt; 'yii\caching\FileCache',
        ],
        'mailer' =&gt; [
            'class' =&gt; 'yii\swiftmailer\Mailer',
        ],
        'db' =&gt; [],
    ],
    'params' =&gt; $params,
];</pre></div></li><li class="listitem">Create the <code class="literal">config/common-local</code> file:<div class="informalexample"><pre class="programlisting">&lt;?php
return [
    'components' =&gt; [
        'db' =&gt; [
            'class' =&gt; 'yii\db\Connection',
            'dsn' =&gt; 'mysql:host=localhost;dbname=yii2basic',
            'username' =&gt; 'root',
            'password' =&gt; '',
            'charset' =&gt; 'utf8',
        ],
        'mailer' =&gt; [
            'useFileTransport' =&gt; true,
        ],
    ],
];</pre></div></li><li class="listitem">Remove the <code class="literal">config/db.php</code> file.</li><li class="listitem">Remove repetitive code from <code class="literal">config/console.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
Yii::setAlias('@tests', dirname(__DIR__) . '/tests');
return [
    'id' =&gt; 'basic-console',
    'bootstrap' =&gt; ['log', 'gii'],
    'controllerNamespace' =&gt; 'app\commands',
    'modules' =&gt; [
        'gii' =&gt; 'yii\gii\Module',
    ],
    'components' =&gt; [
        'log' =&gt; [
            'targets' =&gt; [
                [
                    'class' =&gt; 'yii\log\FileTarget',
                    'levels' =&gt; ['error', 'warning'],
                ],
            ],
        ],
    ],
];</pre></div></li><li class="listitem">Create the <code class="literal">config/console-local.php</code> file <a class="indexterm" id="id779"/>with <a class="indexterm" id="id780"/>an empty array:<div class="informalexample"><pre class="programlisting">&lt;?php
return [
];</pre></div></li><li class="listitem">Change the <code class="literal">config/web.php</code> file:<div class="informalexample"><pre class="programlisting">$config = [
    'id' =&gt; 'basic',
    'bootstrap' =&gt; ['log'],
    'components' =&gt; [
        'user' =&gt; [
            'identityClass' =&gt; 'app\models\User',
            'enableAutoLogin' =&gt; true,
        ],
        'errorHandler' =&gt; [
            'errorAction' =&gt; 'site/error',
        ],
        'log' =&gt; [
            'traceLevel' =&gt; YII_DEBUG ? 3 : 0,
            'targets' =&gt; [
                [
                    'class' =&gt; 'yii\log\FileTarget',
                    'levels' =&gt; ['error', 'warning'],
                ],
            ],
        ],
    ],
];
if (YII_ENV_DEV) {
    // configuration adjustments for 'dev' environment
    $config['bootstrap'][] = 'debug';
    $config['modules']['debug'] = 'yii\debug\Module';

    $config['bootstrap'][] = 'gii';
    $config['modules']['gii'] = 'yii\gii\Module';
}
return $config;</pre></div></li><li class="listitem">Move <a class="indexterm" id="id781"/>the <code class="literal">request</code> configuration<a class="indexterm" id="id782"/> into <code class="literal">config/web-local.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
return [
    'components' =&gt; [
        'request' =&gt; [
            'cookieValidationKey' =&gt; 'TRk9G1La5kvLFwqMEQTp6PmC1NHdjtkq',
        ],
    ],
];</pre></div></li><li class="listitem">Remove the e-mail ID from <code class="literal">config/params.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
return [
    'adminEmail' =&gt; '',
];</pre></div></li><li class="listitem">Paste <a class="indexterm" id="id783"/>the ID into <code class="literal">config/params-local.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
return [
    'adminEmail' =&gt; 'admin@example.com',
];  </pre></div></li><li class="listitem">Remove the <code class="literal">dsn</code> string <a class="indexterm" id="id784"/>from <code class="literal">tests/codeception/config/config.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
/**
 * Application configuration shared by all test types
 */
return [
    'controllerMap' =&gt; [
        // ...
    ],
    'components' =&gt; [
        'db' =&gt; [
            'dsn' =&gt; '',
        ],
        'mailer' =&gt; [
            'useFileTransport' =&gt; true,
        ],
        'urlManager' =&gt; [
            'showScriptName' =&gt; true,
        ],
    ],
];</pre></div></li><li class="listitem">Put the string into a new <code class="literal">tests/codeception/config/config-local.php</code> file:<div class="informalexample"><pre class="programlisting">&lt;?php
return [
    'components' =&gt; [
        'db' =&gt; [
            'dsn' =&gt; 'mysql:host=localhost;dbname=yii2_basic_tests',
        ],
    ],
];</pre></div></li><li class="listitem">Add configuration <a class="indexterm" id="id785"/>merging <a class="indexterm" id="id786"/>to the <code class="literal">web/index.php</code> file:<div class="informalexample"><pre class="programlisting">$config = yii\helpers\ArrayHelper::merge(
    require(__DIR__ . '/../config/common.php'),
    require(__DIR__ . '/../config/common-local.php'),
    require(__DIR__ . '/../config/web.php'),
    require(__DIR__ . '/../config/web-local.php')
);</pre></div></li><li class="listitem">Add configuration merging to the console entry script, <code class="literal">yii</code>:<div class="informalexample"><pre class="programlisting">$config = yii\helpers\ArrayHelper::merge(
    require(__DIR__ . '/config/common.php'),
    require(__DIR__ . '/config/common-local.php'),
    require(__DIR__ . '/config/console.php'),
    require(__DIR__ . '/config/console-local.php')
);</pre></div></li><li class="listitem">Add configuration merging to the testing configurations of the unit, functional, and acceptance tests from <code class="literal">tests/codeception/config</code>:<div class="informalexample"><pre class="programlisting">return yii\helpers\ArrayHelper::merge(
    require(__DIR__ . '/../../../config/common.php'),
    require(__DIR__ . '/../../../config/common-local.php'),
    require(__DIR__ . '/../../../config/web.php'),
    require(__DIR__ . '/../../../config/web-local.php'),
    require(__DIR__ . '/config.php'),
    require(__DIR__ . '/config-local.php'),
    [
        // ...
    ]
);</pre></div></li><li class="listitem">Add configuration merging to the testing environment console's entry script, <code class="literal">tests/codeception/bin/yii</code>:<div class="informalexample"><pre class="programlisting">$config = yii\helpers\ArrayHelper::merge(
    require(YII_APP_BASE_PATH . '/config/common.php'),
    require(YII_APP_BASE_PATH . '/config/common-local.php'),
    require(YII_APP_BASE_PATH . '/config/console.php'),
    require(YII_APP_BASE_PATH . '/config/console-local.php'),
    require(__DIR__ . '/../config/config.php'),
    require(__DIR__ . '/../config/config-local.php')
);</pre></div></li><li class="listitem">As a result, you <a class="indexterm" id="id787"/>must get the <a class="indexterm" id="id788"/>following content in your configuration directory:<div class="informalexample"><pre class="programlisting">config
    common.php
    common-local.php
    console.php
    console-local.php
    web.php
    web-local.php
    params.php
    params-local.php</pre></div></li><li class="listitem">After all, you can add a new <code class="literal">.gitignore</code> file with this content into your <code class="literal">config</code> and <code class="literal">tests/codeception/config</code> directories so you can ignore local configuration files by the Git version control system:<div class="informalexample"><pre class="programlisting">/*-local.php</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec377"/>How it works...</h2></div></div></div><p>You can store common application components configuration in the <code class="literal">config/common.php</code> file and also set specific configurations for web and console applications. You can put your<a class="indexterm" id="id789"/> temporary and secure configuration data into the <code class="literal">*-local.php</code> files.</p><p>Also, you can copy the initialization shell script from <code class="literal">yii2-app-advanced</code>.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new <code class="literal">environments</code> directory and copy your templates into it:<div class="informalexample"><pre class="programlisting">environments
    dev
        config
            common-local.php
            console-local.php
            web-local.php
            params-local.php
        web
            index.php
            index-test.php
        tests
            codeception
                config
                    config.php
                    config-local.php
        yii
    prod
        config
            common-local.php
            console-local.php
            web-local.php
            params-local.php
        web
            index.php
        yii</pre></div></li><li class="listitem">Create the <code class="literal">environments/index.php</code> file <a class="indexterm" id="id790"/>with this code:<div class="informalexample"><pre class="programlisting">&lt;?php
return [
    'Development' =&gt; [
        'path' =&gt; 'dev',
        'setWritable' =&gt; [
            'runtime',
            'web/assets',
        ],
        'setExecutable' =&gt; [
            'yii',
            'tests/codeception/bin/yii',
        ],
        'setCookieValidationKey' =&gt; [
            'config/web-local.php',
        ],
    ],
    'Production' =&gt; [
        'path' =&gt; 'prod',
        'setWritable' =&gt; [
            'runtime',
            'web/assets',
        ],
        'setExecutable' =&gt; [
            'yii',
        ],
        'setCookieValidationKey' =&gt; [
            'config/web-local.php',
        ],
    ],
];</pre></div></li><li class="listitem">Remove <a class="indexterm" id="id791"/>the default <code class="literal">Installer::postCreateProject</code> configuration <a class="indexterm" id="id792"/>from your <code class="literal">composer.json</code>:<div class="informalexample"><pre class="programlisting">"extra": {
    "asset-installer-paths": {
        "npm-asset-library": "vendor/npm",
        "bower-asset-library": "vendor/bower"
    }
}</pre></div></li><li class="listitem">Copy the <code class="literal">init</code> and <code class="literal">init.bat</code> scripts from <a class="indexterm" id="id793"/>the Advanced template, <a class="ulink" href="https://github.com/yiisoft/yii2-app-advanced">https://github.com/yiisoft/yii2-app-advanced</a> and you can run the initialization process using the command <code class="literal">php init</code> after the cloning of the project from the repository.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec378"/>See also</h2></div></div></div><p>For more <a class="indexterm" id="id794"/>information about application configurations refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-concept-configurations.html">http://www.yiiframework.com/doc-2.0/guide-concept-configurations.html</a>.</p></div></div>
<div class="section" title="Implementing and executing cron jobs"><div class="titlepage" id="3APV02-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch10lvl1sec106"/>Implementing and executing cron jobs</h1></div></div></div><p>Sometimes, an <a class="indexterm" id="id795"/>application requires some background tasks, such as regenerating a site map or refreshing <a class="indexterm" id="id796"/>statistics. A common way to implement this is by using cron jobs. When using Yii, there is a way to use a command to run as a job.</p><p>In this recipe, we will see how to implement both. For our recipe, we will implement writing the current timestamp into a <code class="literal">t</code>
<code class="literal">imestamp.txt</code> file under the protected directory.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec379"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application by using the Composer, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-startinstallation.html">http://www.yiiframework.com/doc-2.0/guide-startinstallation.html</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec380"/>How to do it...</h2></div></div></div><div class="section" title="Running the Hello command"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec51"/>Running the Hello command</h3></div></div></div><p>Let us<a class="indexterm" id="id797"/> try to run <code class="literal">app\commands\HelloController::actionIndex</code> as a shell command:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\commands;
use yii\console\Controller;

/**
 * This command echoes the first argument that you have entered.
 */
class HelloController extends Controller
{
    /**
    * This command echoes what you have entered as the message.
    * @param string $message the message to be echoed.
    */
    public function actionIndex($message = 'hello world')
    {
        echo $message . "\n";
    }
}</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the shell in your application directory and execute this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php yii</strong></span>
</pre></div><p>Alternatively, you also can call the following and ensure that the shell works:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./yii</strong></span>
</pre></div></li><li class="listitem">Type the following command for the display <code class="literal">hello</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./yii help hello</strong></span>
</pre></div></li><li class="listitem">The framework must <a class="indexterm" id="id798"/>display some information:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>DESCRIPTION</strong></span>
<span class="strong"><strong>This command echoes what you have entered as the message.</strong></span>

<span class="strong"><strong>USAGE</strong></span>
<span class="strong"><strong>yii hello [message] [...options...]</strong></span>
<span class="strong"><strong>- message: string (defaults to 'hello world')</strong></span>
<span class="strong"><strong>  the message to be echoed.</strong></span>
</pre></div></li><li class="listitem">Run the default command action:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./yii hello</strong></span>
</pre></div><p>Alternatively, run the concrete <code class="literal">index</code> action:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./yii hello/index</strong></span>
</pre></div></li><li class="listitem">You must now see the default phrase:<div class="informalexample"><pre class="programlisting">Hello world</pre></div></li><li class="listitem">Run the command with any parameter and see the response:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./yii hello 'Bond, James Bond'</strong></span>
</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="Creating your own command"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec52"/>Creating your own command</h3></div></div></div><p>You also can <a class="indexterm" id="id799"/>create your own console controllers. For example, create a <code class="literal">commands/CronController.php</code> file with the sample code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\commands;

use yii\console\Controller;
use yii\helpers\Console;
use Yii;

/**
* Console crontab actions
*/
class CronController extends Controller
{
    /**
    * Regenerates timestamp
    */
    public function actionTimestamp()
    {
        file_put_contents(Yii::getAlias('@app/timestamp.txt'), time());
        $this-&gt;stdout('Done!', Console::FG_GREEN, Console::BOLD);
        $this-&gt;stdout(PHP_EOL);
    }
}</pre></div><p>After all is done, <a class="indexterm" id="id800"/>run the command in a shell:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./yii cron/timestamp</strong></span>
</pre></div><p>Then, check the response text and the existence of a new file, namely <code class="literal">timestamp.txt</code>.</p></div><div class="section" title="Setting the cron schedule"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec53"/>Setting the cron schedule</h3></div></div></div><p>Create <code class="literal">/etc/cron.d/myapp</code> on your <a class="indexterm" id="id801"/>Linux server and add the following row to run our command at every midnight:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>0 0 </strong></span>
<span class="strong"><strong>* * * www-data /path/to/yii cron/timestamp &gt;/dev/null</strong></span>
</pre></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec381"/>How it works...</h2></div></div></div><p>A console command is defined as a controller class that extends from <code class="literal">yii\console\Controller</code>. In the controller class, you define one or more actions that correspond to the <a class="indexterm" id="id802"/>subcommands of the controller. Within each action, <a class="indexterm" id="id803"/>you write code that implements the appropriate tasks for that particular sub-command.</p><p>When running a command, you need to specify the route to the controller action. For example, the route <code class="literal">migrate/create</code> invokes the sub-command that corresponds to the <code class="literal">MigrateController::actionCreate()</code> action method. If a route offered during the execution does not contain an action ID, the default action will be executed (as with a web controller).</p><p>Take care that your <a class="indexterm" id="id804"/>console controllers are placed in the directory defined <a class="indexterm" id="id805"/>in the <code class="literal">c</code>
<code class="literal">ontrollerNamespace</code> option in your <code class="literal">web/console.php</code> config.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec382"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">For getting more <a class="indexterm" id="id806"/>information about Yii2 console commands, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-tutorial-console.html">http://www.yiiframework.com/doc-2.0/guide-tutorial-console.html</a></li><li class="listitem">In order to <a class="indexterm" id="id807"/>learn more about the Cron daemon, refer to <a class="ulink" href="https://en.wikipedia.org/wiki/Cron">https://en.wikipedia.org/wiki/Cron</a></li><li class="listitem">The <span class="emphasis"><em>Changing the Yii directory layout</em></span> recipe for <code class="literal">controllerNamespace</code></li></ul></div></div></div>
<div class="section" id="3BOFI1-ae331331bc644dc9b658d3634f0748da" title="Maintenance mode"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec107"/>Maintenance mode</h1></div></div></div><p>Sometimes, there is a need to fine tune some application settings or restore a database from a backup. When <a class="indexterm" id="id808"/>working on tasks such as these, it is not desirable to allow everyone to use the application because it can lead to losing the recent user messages or showing the application implementation details.</p><p>In this recipe, we will see how to show everyone except the developer a maintenance message.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec383"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application by using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guidestart-installation.html">http://www.yiiframework.com/doc-2.0/guidestart-installation.html</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec384"/>How to do it...</h2></div></div></div><p>Carry out the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we need to create <code class="literal">protected/controllers/MaintenanceController.php</code>. We do this as follows:<div class="informalexample"><pre class="programlisting">class MaintenanceController extends Controller
{
    public function actionIndex()
    {
        $this-&gt;renderPartial("index");
    }
}</pre></div></li><li class="listitem">Then we create a view named <code class="literal">views/maintenance/index.php</code>, as follows:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;
?&gt;
&lt;!doctype html&gt;
&lt;head&gt;
    &lt;meta charset="utf-8" /&gt;
    &lt;title&gt;&lt;?php echo 
    Html::encode(Yii::$app-&gt;name)?&gt;is under maintenance&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;&lt;?php echo CHtml::encode(Yii::$app-&gt;name)?&gt;is under maintenance&lt;/h1&gt;
    &lt;p&gt;We'll be back soon. If we aren't back for too long,please drop a message to &lt;?php echo Yii::$app-&gt;params['adminEmail']?&gt;.&lt;/p&gt;
    &lt;p&gt;Meanwhile, it's a good time to get a cup of coffee,to read a book or to check email.&lt;/p&gt;
&lt;/body&gt;</pre></div></li><li class="listitem">Now we need to add a<a class="indexterm" id="id809"/> single line of code to <code class="literal">config/web.php</code>, as follows:<div class="informalexample"><pre class="programlisting">$config = [
    'catchAll' =&gt; file_exists(dirname(__DIR__) .'/.maintenance') 
    &amp;&amp; !(isset($_COOKIE['secret']) &amp;&amp; $_COOKIE['secret']=="password") ?
    ['maintenance/index'] : null,
    // …
]</pre></div></li><li class="listitem">Now in order to go into the maintenance mode, you need to create a file named <code class="literal">.maintenance</code> in your site directory. After you do this, you should see this page.</li></ol><div style="height:10px; width: 1px"/></div><p>In order to get it back to normal, you just need to delete it. To view the website in the maintenance mode, you can create a cookie named <code class="literal">secret</code> with its value equal to <code class="literal">password</code>.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec385"/>How it works...</h2></div></div></div><p>A Yii web application offers a way to intercept all the possible requests and route these to a single controller action. You can do this by setting <code class="literal">yii\web\Application::catchAll</code> to an array containing the application route as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>'catchAll' =&gt; ['maintenance/index'],</strong></span>
</pre></div><p>The maintenance controller itself is nothing special; it just renders a view with some text.</p><p>We need an easy way to turn the maintenance mode on and off. As the application config is a regular PHP file, we can achieve it with a simple check to confirm the file exists, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>file_exists(dirname(__DIR__) . '/.maintenance')</strong></span>
</pre></div><p>In addition, we check for the cookie <a class="indexterm" id="id810"/>value to be able to override the maintenance mode. We do this as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>!</strong></span>
<span class="strong"><strong>(isset($_COOKIE['secret']) &amp;&amp; $_COOKIE['secret']=="password")</strong></span>
</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec386"/>See also</h2></div></div></div><p>In order to learn more about <a class="indexterm" id="id811"/>how to catch all the requests in a Yii application and check the production ready solution for maintenance, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/yii-web-application.html#%24catchAll-detail">http://www.yiiframework.com/doc-2.0/yii-web-application.html#$catchAll-detail</a>.</p></div></div>
<div class="section" title="Deployment tools"><div class="titlepage" id="3CN042-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch10lvl1sec108"/>Deployment tools</h1></div></div></div><p>If you are using a version control system such as Git, for your project's code and pushing releases into remote repository, you can use Git to deploy code to your production server via the <code class="literal">git pull</code> shell command instead of uploading files manually. Also, you can write <a class="indexterm" id="id812"/>your own shell script to pull new repository commits, update vendors, apply migrations, and do more things.</p><p>However, there are many tools available for automating the deployment process. In this recipe, we consider the tool named Deployer.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec387"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application by using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guidestart-installation.html">http://www.yiiframework.com/doc-2.0/guidestart-installation.html</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec388"/>How to do it...</h2></div></div></div><p>If you have a shared remote repository, you can use it for deployment source.</p><div class="section" title="Step 1 - Preparing the remote host"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec54"/>Step 1 - Preparing the remote host</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to your remote <a class="indexterm" id="id813"/>host and install Composer and <code class="literal">asset-plugin</code> too:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>global require 'fxp/composer-asset-plugin:~1.1.1'</strong></span>
</pre></div></li><li class="listitem">Generate the SSH key via <code class="literal">ssh-keygen</code>.</li><li class="listitem">Add the <code class="literal">~/.ssh/id_rsa.pub</code> file content into deployment the SSH keys page of your repository settings on GitHub, Bitbucket, or other repositories storage.</li><li class="listitem">Try to clone your repository manually:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>git clone git@github.com:user/repo.git</strong></span>
</pre></div></li><li class="listitem">Add the Github address and the list of known hosts if the system asks you to do it.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="Step 2 - Preparing the localhost"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec55"/>Step 2 - Preparing the localhost</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install <code class="literal">deploy.phar</code> globally <a class="indexterm" id="id814"/>on your local host:<div class="informalexample"><pre class="programlisting">sudo wget http://deployer.org/deployer.phar
sudo mv deployer.phar /usr/local/bin/dep
sudo chmod +x /usr/local/bin/dep</pre></div></li><li class="listitem">Add the <code class="literal">deploy.php</code> file with the deployment configuration:<div class="informalexample"><pre class="programlisting">&lt;?php
require 'recipe/yii2-app-basic.php';

set('shared_files', [
    'config/db.php',
    'config/params.php',
    'web/index.php',
    'yii',
]);

server('prod', 'site.com', 22) // SSH access to remote server
    -&gt;user('user')
    // -&gt;password(password) // uncomment for authentication by password
    // -&gt;identityFile()               // uncomment for authentication by SSH key
    -&gt;stage('production')
    -&gt;env('deploy_path', '/var/www/project');

set('repository', 'git@github.com:user/repo.git');</pre></div></li><li class="listitem">Try to prepare remote project directories structure:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>dep deploy:prepare prod</strong></span>
</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="Step 3 - Adding remote configuration"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec56"/>Step 3 - Adding remote configuration</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the server's <code class="literal">/var/www/project</code> directory. It has <a class="indexterm" id="id815"/>two subdirectories after the initialization:<div class="informalexample"><pre class="programlisting">project
├── releases
└── shared</pre></div></li><li class="listitem">Create original files with private configurations in a <code class="literal">shared</code> directory like this:<div class="informalexample"><pre class="programlisting">project
├── releases
└── shared
        ├── config
        │       ├── db.php
        │       └── params.php
        ├── web
        │       └── index.php
        └── yii</pre></div></li></ol><div style="height:10px; width: 1px"/></div><p>The Deployer tool will include these files in every release subdirectory via symbolic links.</p><p>Specify your private configuration in <code class="literal">share/config/db.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
return [
    'class' =&gt; 'yii\db\Connection',
    dsn' =&gt; 'mysql:host=localhost;dbname=catalog',
    'username' =&gt; 'root',
    'password' =&gt; 'root',
    'charset' =&gt; 'utf8',
];</pre></div><p>Also, specify it in <code class="literal">share/config/params.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
return [
    'adminEmail' =&gt; 'admin@example.com',
];</pre></div><p>Set the content of <code class="literal">share/web/index.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
defined('YII_DEBUG') or define('YII_DEBUG', false);
defined('YII_ENV') or define('YII_ENV', 'prod');

$dir = dirname($_SERVER['SCRIPT_FILENAME']);

require($dir . '/../vendor/autoload.php');
require($dir . '/../vendor/yiisoft/yii2/Yii.php');

$config = require($dir . '/../config/web.php');

(new yii\web\Application($config))-&gt;run();</pre></div><p>Also, set the content of the <code class="literal">share/yii</code> file:</p><div class="informalexample"><pre class="programlisting">#!/usr/bin/env php
&lt;?php
defined('YII_DEBUG') or define('YII_DEBUG', false);
defined('YII_ENV') or define('YII_ENV', 'prod');

$dir = dirname($_SERVER['SCRIPT_FILENAME']);

require($dir . '/vendor/autoload.php');
require($dir . '/vendor/yiisoft/yii2/Yii.php');

$config = require($dir. '/config/console.php');

$application = new yii\console\Application($config);
$exitCode = $application-&gt;run();
exit($exitCode);</pre></div><div class="note" title="Note"><h3 class="title"><a id="note24"/>Note</h3><p>
<span class="strong"><strong>Note</strong></span>: We deliberately use the <code class="literal">dirname($_SERVER['SCRIPT_FILENAME'])</code> code instead of the original <code class="literal">__DIR__</code> constant because <code class="literal">__DIR__</code> will return incorrect value when the file is included via symbolic link.</p><p>Note: If you use the <code class="literal">yii2-app-advanced</code> template you can redeclare only the <code class="literal">config/main-local.php</code> and <code class="literal">config/params-local.php</code> files of every (backend, frontend, console, and common) because <code class="literal">web/index.php</code> and <code class="literal">yii</code> files will be created automatically by the <code class="literal">init</code> command.</p></div></div><div class="section" title="Step 4 - Trying to deploy"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec57"/>Step 4 - Trying to deploy</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Come back to the <a class="indexterm" id="id816"/>localhost with the <code class="literal">deploy.php</code> file and run the deploy command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>dep deploy prod</strong></span>
</pre></div></li><li class="listitem">If successful, you will see the deployment report:<div class="mediaobject"><img alt="Step 4 - Trying to deploy" src="../Images/image00469.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Deployer created a new release subdirectory on your remote server and added symlinks from your project to the shared items and from the <code class="literal">current</code> directory to the current release:<div class="informalexample"><pre class="programlisting">project
├── current -&gt; releases/20160412140556
├── releases
│    └── 20160412140556
│        ├── ...
│        ├── runtime -&gt; /../../shared/runtime
│        ├── web
│        ├── vendor
│        ├── ...
│        └── yii -&gt; /../../shared/yii
└── shared
   ├── config
   │   ├── db.php
   │   └── params.php
   ├── runtime
   ├── web
   │   └── index.php
   └── yii</pre></div></li><li class="listitem">After all is done, you <a class="indexterm" id="id817"/>must set up the <code class="literal">DocumentRoot</code> of your server in <code class="literal">project/current/web</code> directory.</li><li class="listitem">If something goes wrong during the deployment process you can roll back to the previous working release:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>dep rollback prod</strong></span>
</pre></div><p>The <code class="literal">current</code> directory will lead to your previous release files.</p></li></ol><div style="height:10px; width: 1px"/></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec389"/>How it works...</h2></div></div></div><p>Most of the deployment tools do the same tasks:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Create a new release subdirectory</li><li class="listitem">Clone repository <a class="indexterm" id="id818"/>files</li><li class="listitem">Make symlinks from the project to shared directories and to local configuration files</li><li class="listitem">Install Composer packages</li><li class="listitem">Apply project migrations</li><li class="listitem">Switch the symlink from the server's <code class="literal">DocumentRoot</code> path to the current release directory</li></ul></div><p>The Deployer tool has predefined recipes for popular frameworks. You can extend any existing recipe or write a new one for your specific case.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec390"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">For more information <a class="indexterm" id="id819"/>about Deployer, refer to <a class="ulink" href="http://deployer.org/docs">http://deployer.org/docs</a></li><li class="listitem">And about <a class="indexterm" id="id820"/>creating SSH keys refer to <a class="ulink" href="https://git-scm.com/book/en/v2/Git-on-the-Server-Generating-Your-SSH-Public-Key">https://git-scm.com/book/en/v2/Git-on-the-Server-Generating-Your-SSH-Public-Key</a></li></ul></div></div></div></body></html>