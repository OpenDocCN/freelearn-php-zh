<html><head></head><body>
<div id="_idContainer025">
<h1 class="chapter-number" id="_idParaDest-41"><a id="_idTextAnchor048"/><span class="koboSpan" id="kobo.1.1">3</span></h1>
<h1 id="_idParaDest-42"><a id="_idTextAnchor049"/><span class="koboSpan" id="kobo.2.1">Configuring the Swoole Application Server</span></h1>
<p><span class="koboSpan" id="kobo.3.1">With Laravel Octane, instead of RoadRunner, you can use another type of application server. </span><span class="koboSpan" id="kobo.3.2">In addition to RoadRunner, we can configure and use Swoole. </span><span class="koboSpan" id="kobo.3.3">Both tools allow you to implement an application server. </span><span class="koboSpan" id="kobo.3.4">Obviously, there are differentiating elements between the two tools, and sometimes deciding which one to use can </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">be difficult.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">As we saw, RoadRunner is a separate executable, which means that its installation, as seen in </span><a href="B17728_02.xhtml#_idTextAnchor036"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.6.1">Chapter 2</span></em></span></a><span class="koboSpan" id="kobo.7.1">, </span><em class="italic"><span class="koboSpan" id="kobo.8.1">Configuring the RoadRunner Application Server</span></em><span class="koboSpan" id="kobo.9.1">, is quite simple and does not affect the heart of the PHP engine. </span><span class="koboSpan" id="kobo.9.2">This means that in all probability, it has no side effects on other tools that work in the heart of the engine. </span><span class="koboSpan" id="kobo.9.3">These tools (such as Xdebug) are typically diagnostic, monitoring, and </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">debugging tools.</span></span></p>
<p><span class="koboSpan" id="kobo.11.1">The advice I would like to give is that, in the process of analysis and selection of the application server, evaluate the various other tools that may be useful in the development process (such as Xdebug) and evaluate their compatibility </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">with Swoole.</span></span></p>
<p><span class="koboSpan" id="kobo.13.1">Despite there being a greater complexity in the management of Swoole, Swoole offers benefits such as additional and advanced features, such as the management of an in-memory cache (benefits on performance), Swoole Table, which is a data store for sharing information between different processes (and facilitates information sharing and better cooperation between processes), and the ability to start asynchronous functions and processes at a specific interval (thus enabling asynchronous and parallel execution </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">of functions).</span></span></p>
<p><span class="koboSpan" id="kobo.15.1">In the chapter, we will see how to install and configure Swoole with Laravel Octane and how to best use the specific features provided by Swoole. </span><span class="koboSpan" id="kobo.15.2">In this chapter, we will explore features of Swoole such as executing concurrent tasks, executing interval tasks, using the highly performant cache and storage mechanisms provided by Swoole, and accessing metrics about the usage of workers. </span><span class="koboSpan" id="kobo.15.3">All these features are available via Octane thanks to the Swoole </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">application server.</span></span></p>
<p><span class="koboSpan" id="kobo.17.1">In particular, we will cover </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.19.1">Setting up Laravel Octane with Swoole using </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">Laravel Sail</span></span></li>
<li><span class="koboSpan" id="kobo.21.1">Installing </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">Open Swoole</span></span></li>
<li><span class="koboSpan" id="kobo.23.1">Exploring </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">Swoole features</span></span></li>
</ul>
<h1 id="_idParaDest-43"><a id="_idTextAnchor050"/><span class="koboSpan" id="kobo.25.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.26.1">This chapter will cover the Swoole and Open Swoole application server setup (installation </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">and configuration).</span></span></p>
<p><span class="koboSpan" id="kobo.28.1">Unlike what we did for RoadRunner, in this</span><a id="_idIndexMarker157"/><span class="koboSpan" id="kobo.29.1"> case, we have to install a </span><strong class="bold"><span class="koboSpan" id="kobo.30.1">PHP Extension Community Library</span></strong><span class="koboSpan" id="kobo.31.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.32.1">PECL</span></strong><span class="koboSpan" id="kobo.33.1">) extension to allow PHP to be able to operate </span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">with Swoole.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.35.1">What is PECL?</span></p>
<p class="callout"><span class="koboSpan" id="kobo.36.1">PECL is the repository for PHP extensions. </span><span class="koboSpan" id="kobo.36.2">The PECL extensions are written in C language and have to be compiled to be used with the </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">PHP engine.</span></span></p>
<p><span class="koboSpan" id="kobo.38.1">Because of the complexity of installing the PECL module with all the dependencies required by the compilation, configuration, and setup of the PHP extension, we are going to use a container approach – so instead of installing all the necessary tools for compiling the PHP extension on our personal operating system, we will </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">use </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.40.1">Docker</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.42.1">This allows us to have a running operating system (container) hosted within our real operating system. </span><span class="koboSpan" id="kobo.42.2">The purpose of having an isolated operating system in a container is to contain everything you need for the PHP </span><span class="No-Break"><span class="koboSpan" id="kobo.43.1">development environment.</span></span></p>
<p><span class="koboSpan" id="kobo.44.1">This means that if we install dependencies and tools, we will do it within an isolated environment without affecting our real </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">operating system.</span></span></p>
<p><span class="koboSpan" id="kobo.46.1">In the previous chapter, we did not use this approach as the requirements were simpler. </span><span class="koboSpan" id="kobo.46.2">However, many people use the container method for every development environment, even the </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">simplest ones.</span></span></p>
<p><span class="koboSpan" id="kobo.48.1">As the development environment begins to require additional dependencies, it may become unmanageable. </span><span class="koboSpan" id="kobo.48.2">It could become especially unmanageable in the case of evolution: try to think of the simultaneous management of several versions of PHP, which may require additional versions of dependencies. </span><span class="koboSpan" id="kobo.48.3">To isolate and limit all this within a consistent </span><a id="_idIndexMarker158"/><span class="koboSpan" id="kobo.49.1">environment, it is recommended to use a container approach. </span><span class="koboSpan" id="kobo.49.2">To do this, the installation of </span><strong class="bold"><span class="koboSpan" id="kobo.50.1">Docker Desktop</span></strong><span class="koboSpan" id="kobo.51.1"> (</span><a href="https://www.docker.com/products/docker-desktop/"><span class="koboSpan" id="kobo.52.1">https://www.docker.com/products/docker-desktop/</span></a><span class="koboSpan" id="kobo.53.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">is suggested.</span></span></p>
<p><span class="koboSpan" id="kobo.55.1">Once we have installed Docker Desktop, we will configure a specific image for PHP with the extensions </span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">we need.</span></span></p>
<p><span class="koboSpan" id="kobo.57.1">All these new packages that we are going to install will be stored within this image. </span><span class="koboSpan" id="kobo.57.2">When we delete the development environment, simply delete the image used. </span><span class="koboSpan" id="kobo.57.3">The only tool installed on our operating system will be </span><span class="No-Break"><span class="koboSpan" id="kobo.58.1">Docker Desktop.</span></span></p>
<p><span class="koboSpan" id="kobo.59.1">So, to install Docker Desktop, simply download and proceed with the installation wizard specific to your operating system. </span><span class="koboSpan" id="kobo.59.2">In the case of macOS, please refer to the type of reference chip (Intel </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">or Apple).</span></span></p>
<p><span class="koboSpan" id="kobo.61.1">If you do not have a thorough knowledge of Docker, do not worry – we are going to use another powerful tool in the Laravel ecosystem: </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.62.1">Laravel Sail</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.64.1">Laravel Sail is a command-line interface that exposes commands for managing Docker, specifically for Laravel. </span><span class="koboSpan" id="kobo.64.2">Laravel Sail simplifies the use and configuration of Docker images, allowing the developer to focus on </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">the code.</span></span></p>
<p><span class="koboSpan" id="kobo.66.1">We are going to use Laravel Sail commands for the creation of a development environment, but under the hood, they will result in Docker commands and ready-to-use </span><span class="No-Break"><span class="koboSpan" id="kobo.67.1">Docker configurations.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.68.1">Source code</span></p>
<p class="callout"><span class="koboSpan" id="kobo.69.1">You can find the source code of the examples used in this chapter in the official GitHub repository of this </span><span class="No-Break"><span class="koboSpan" id="kobo.70.1">book: </span></span><a href="https://github.com/PacktPublishing/High-Performance-with-Laravel-Octane/tree/main/octane-ch03"><span class="No-Break"><span class="koboSpan" id="kobo.71.1">https://github.com/PacktPublishing/High-Performance-with-Laravel-Octane/tree/main/octane-ch03</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.72.1">.</span></span></p>
<h1 id="_idParaDest-44"><a id="_idTextAnchor051"/><span class="koboSpan" id="kobo.73.1">Setting up Laravel Octane with Swoole using Laravel Sail</span></h1>
<p><span class="koboSpan" id="kobo.74.1">In order to have an</span><a id="_idIndexMarker159"/><span class="koboSpan" id="kobo.75.1"> environment up and running with </span><a id="_idIndexMarker160"/><span class="koboSpan" id="kobo.76.1">Swoole as the application server and using a Docker container, you have to follow </span><span class="No-Break"><span class="koboSpan" id="kobo.77.1">some steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.78.1">Set up </span><span class="No-Break"><span class="koboSpan" id="kobo.79.1">Laravel Sail</span></span></li>
<li><span class="koboSpan" id="kobo.80.1">Install </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">Laravel Octane</span></span></li>
<li><span class="koboSpan" id="kobo.82.1">Set up Laravel Octane </span><span class="No-Break"><span class="koboSpan" id="kobo.83.1">and Swoole</span></span></li>
</ol>
<h2 id="_idParaDest-45"><a id="_idTextAnchor052"/><span class="koboSpan" id="kobo.84.1">Setting up Laravel Sail</span></h2>
<p><span class="koboSpan" id="kobo.85.1">First, create </span><a id="_idIndexMarker161"/><span class="koboSpan" id="kobo.86.1">your </span><span class="No-Break"><span class="koboSpan" id="kobo.87.1">Laravel application:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.88.1">
laravel new octane-ch03
cd octane-ch03</span></pre>
<p><span class="koboSpan" id="kobo.89.1">Or, if you already have your Laravel application you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.90.1">composer show</span></strong><span class="koboSpan" id="kobo.91.1"> command to check whether Laravel Sail is installed. </span><span class="koboSpan" id="kobo.91.2">This command also shows you some additional information about </span><span class="No-Break"><span class="koboSpan" id="kobo.92.1">the package:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.93.1">
composer show laravel/sail</span></pre>
<p><span class="koboSpan" id="kobo.94.1">If Laravel Sail is not installed, run </span><strong class="source-inline"><span class="koboSpan" id="kobo.95.1">composer require </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.96.1">laravel/sail --dev</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.97.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.98.1">Once you have Sail installed, you have to create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.99.1">docker-compose.yml</span></strong><span class="koboSpan" id="kobo.100.1"> file. </span><span class="koboSpan" id="kobo.100.2">To create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.101.1">docker-compose.yml</span></strong><span class="koboSpan" id="kobo.102.1"> file, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.103.1">sail</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.104.1">command, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.105.1">sail:install</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.107.1">
php artisan sail:install</span></pre>
<p><span class="koboSpan" id="kobo.108.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.109.1">sail:install</span></strong><span class="koboSpan" id="kobo.110.1"> command will create Docker files for you. </span><span class="koboSpan" id="kobo.110.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">sail:install</span></strong><span class="koboSpan" id="kobo.112.1"> process will ask you which service you want to enable. </span><span class="koboSpan" id="kobo.112.2">Just to start, you can select the default </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">item (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.114.1">mysql</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.115.1">):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer020">
<span class="koboSpan" id="kobo.116.1"><img alt="Figure 3.1 – The Laravel Sail services" src="image/Figure_3.1_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.117.1">Figure 3.1 – The Laravel Sail services</span></p>
<p><span class="koboSpan" id="kobo.118.1">Answer the questions in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.119.1">sail:install</span></strong><span class="koboSpan" id="kobo.120.1"> command to determine which services to include. </span><span class="koboSpan" id="kobo.120.2">The Sail configuration for Docker starts from a set of ready-to-use templates (stubs), and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.121.1">sail:install</span></strong><span class="koboSpan" id="kobo.122.1"> command includes the necessary ones. </span><span class="koboSpan" id="kobo.122.2">If you are curious about which </span><a id="_idIndexMarker162"/><span class="koboSpan" id="kobo.123.1">templates are included and how they are implemented, look </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">here: </span></span><a href="https://github.com/laravel/sail/tree/1.x/stubs"><span class="No-Break"><span class="koboSpan" id="kobo.125.1">https://github.com/laravel/sail/tree/1.x/stubs</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.126.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.127.1">If you take a look at the templates, you will see that they make use of environment variables such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.128.1">${APP_PORT:-80}</span></strong><span class="koboSpan" id="kobo.129.1">. </span><span class="koboSpan" id="kobo.129.2">This means that you can control the configuration through environment variables, which are configurable through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.130.1">.env</span></strong><span class="koboSpan" id="kobo.131.1"> file. </span><span class="koboSpan" id="kobo.131.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.132.1">.env</span></strong><span class="koboSpan" id="kobo.133.1"> file is automatically generated by the installation of Laravel. </span><span class="koboSpan" id="kobo.133.2">If for some reason the </span><strong class="source-inline"><span class="koboSpan" id="kobo.134.1">.env</span></strong><span class="koboSpan" id="kobo.135.1"> file is not present, you can copy the </span><strong class="source-inline"><span class="koboSpan" id="kobo.136.1">.env</span></strong><span class="koboSpan" id="kobo.137.1"> file from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.138.1">.env.example</span></strong><span class="koboSpan" id="kobo.139.1"> file (for example, when you clone an existent repository that uses Laravel Octane, probably the </span><strong class="source-inline"><span class="koboSpan" id="kobo.140.1">.env</span></strong><span class="koboSpan" id="kobo.141.1"> file is included in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.142.1">.gitignore</span></strong><span class="koboSpan" id="kobo.143.1"> file). </span><span class="koboSpan" id="kobo.143.2">In the example, if you want to customize the port where the web server receives the request (</span><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">APP_PORT</span></strong><span class="koboSpan" id="kobo.145.1">), simply add the parameter to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.147.1">env</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.148.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.149.1">
APP_PORT=81</span></pre>
<p><span class="koboSpan" id="kobo.150.1">In this case, the web server that will serve your Laravel application will do so via port </span><strong class="source-inline"><span class="koboSpan" id="kobo.151.1">81</span></strong><span class="koboSpan" id="kobo.152.1">. </span><span class="koboSpan" id="kobo.152.2">The default is </span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">80</span></strong><span class="koboSpan" id="kobo.154.1"> as seen </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.156.1">${APP_PORT:-80}</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.157.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.158.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.159.1">The examples in the </span><em class="italic"><span class="koboSpan" id="kobo.160.1">Using Swoole features</span></em><span class="koboSpan" id="kobo.161.1"> section will use Laravel Sail with </span><strong class="source-inline"><span class="koboSpan" id="kobo.162.1">APP_PORT</span></strong><span class="koboSpan" id="kobo.163.1"> set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.164.1">81</span></strong><span class="koboSpan" id="kobo.165.1">, so all examples will refer to the </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">host </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.167.1">http://127.0.0.1:81</span></strong></span></p>
<p><span class="koboSpan" id="kobo.168.1">If you have made this change to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.169.1">.env</span></strong><span class="koboSpan" id="kobo.170.1"> file, you can now launch the command from your Laravel </span><span class="No-Break"><span class="koboSpan" id="kobo.171.1">project directory:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.172.1">
./vendor/bin/sail up</span></pre>
<p><span class="koboSpan" id="kobo.173.1">This will start the</span><a id="_idIndexMarker163"/><span class="koboSpan" id="kobo.174.1"> Docker container. </span><span class="koboSpan" id="kobo.174.2">The first time, the execution may take some time (a few minutes) because the preconfigured images with nginx, PHP, and MySQL will </span><span class="No-Break"><span class="koboSpan" id="kobo.175.1">be downloaded.</span></span></p>
<p><span class="koboSpan" id="kobo.176.1">Once the execution of the command is complete, you can visit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.177.1">http://127.0.0.1:81</span></strong><span class="koboSpan" id="kobo.178.1"> page and see your Laravel </span><span class="No-Break"><span class="koboSpan" id="kobo.179.1">welcome page:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer021">
<span class="koboSpan" id="kobo.180.1"><img alt="Figure 3.2 – Laravel welcome page" src="image/Figure_3.2_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.181.1">Figure 3.2 – Laravel welcome page</span></p>
<p><span class="koboSpan" id="kobo.182.1">The main difference with this container approach is that the tools used to render the page (nginx, PHP) are included in the Docker image and not in your main operating system. </span><span class="koboSpan" id="kobo.182.2">With this method, you may not even have the PHP and nginx engine on your main operating system. </span><span class="koboSpan" id="kobo.182.3">The Laravel Sail configuration instructs Docker to use the container for PHP and all the needed tools, and points to your local source code (the root of your Laravel project) on your </span><span class="No-Break"><span class="koboSpan" id="kobo.183.1">local filesystem.</span></span></p>
<p><span class="koboSpan" id="kobo.184.1">Now that we have</span><a id="_idIndexMarker164"/><span class="koboSpan" id="kobo.185.1"> Laravel Sail installed with your Laravel application, we have to add Laravel Octane stuff to use the Swoole package already included in the Laravel image provided </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">by Sail.</span></span></p>
<p><span class="koboSpan" id="kobo.187.1">Let’s begin by installing </span><span class="No-Break"><span class="koboSpan" id="kobo.188.1">Laravel Octane.</span></span></p>
<h2 id="_idParaDest-46"><a id="_idTextAnchor053"/><span class="koboSpan" id="kobo.189.1">Installing Laravel Octane</span></h2>
<p><span class="koboSpan" id="kobo.190.1">We are going to install Laravel </span><a id="_idIndexMarker165"/><span class="koboSpan" id="kobo.191.1">Octane through the container provided by </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">Laravel Sail.</span></span></p>
<p><span class="koboSpan" id="kobo.193.1">So while </span><strong class="source-inline"><span class="koboSpan" id="kobo.194.1">sail up</span></strong><span class="koboSpan" id="kobo.195.1"> is still running (is running as a server), launch </span><strong class="source-inline"><span class="koboSpan" id="kobo.196.1">composer require</span></strong><span class="koboSpan" id="kobo.197.1"> with the Octane package. </span><span class="koboSpan" id="kobo.197.2">Launching the command with </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">sail</span></strong><span class="koboSpan" id="kobo.199.1"> will execute your command inside </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">your container:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.201.1">
./vendor/bin/sail composer require laravel/octane</span></pre>
<h2 id="_idParaDest-47"><a id="_idTextAnchor054"/><span class="koboSpan" id="kobo.202.1">Setting up Laravel Octane and Swoole</span></h2>
<p><span class="koboSpan" id="kobo.203.1">In order to adjust the </span><a id="_idIndexMarker166"/><span class="koboSpan" id="kobo.204.1">command that launches the server, you have to publish Laravel Sail files with the </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.206.1">
./vendor/bin/sail artisan sail:publish</span></pre>
<p><span class="koboSpan" id="kobo.207.1">This command will copy the </span><a id="_idIndexMarker167"/><span class="koboSpan" id="kobo.208.1">Docker configuration files from the package in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.209.1">docker</span></strong><span class="koboSpan" id="kobo.210.1"> directory in the root </span><span class="No-Break"><span class="koboSpan" id="kobo.211.1">project directory.</span></span></p>
<p><span class="koboSpan" id="kobo.212.1">It creates a </span><strong class="source-inline"><span class="koboSpan" id="kobo.213.1">docker</span></strong><span class="koboSpan" id="kobo.214.1"> directory. </span><span class="koboSpan" id="kobo.214.2">Inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.215.1">docker</span></strong><span class="koboSpan" id="kobo.216.1"> directory, more than one directory is created, one for each PHP version: </span><strong class="source-inline"><span class="koboSpan" id="kobo.217.1">7.4</span></strong><span class="koboSpan" id="kobo.218.1">, </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.219.1">8.0</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.220.1">, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">8.1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.223.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.224.1">docker/8.1</span></strong><span class="koboSpan" id="kobo.225.1"> directory, you have </span><span class="No-Break"><span class="koboSpan" id="kobo.226.1">the following:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.227.1">A Dockerfile.</span></span></li>
<li><span class="koboSpan" id="kobo.228.1">The </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.229.1">php.ini</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.230.1"> file.</span></span></li>
<li><span class="koboSpan" id="kobo.231.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">start-container</span></strong><span class="koboSpan" id="kobo.233.1"> script used to launch the container. </span><span class="koboSpan" id="kobo.233.2">This script refers to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.234.1">supervisor.conf</span></strong><span class="koboSpan" id="kobo.235.1"> file with the </span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">bootstrap configuration.</span></span></li>
<li><span class="koboSpan" id="kobo.237.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">supervisor.conf</span></strong><span class="koboSpan" id="kobo.239.1"> file with the configuration of the </span><span class="No-Break"><span class="koboSpan" id="kobo.240.1">supervisor script.</span></span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer022">
<span class="koboSpan" id="kobo.241.1"><img alt="Figure 3.3 – The Docker configuration files (after sail:publish execution)" src="image/Figure_3.3_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.242.1">Figure 3.3 – The Docker configuration files (after sail:publish execution)</span></p>
<p><span class="koboSpan" id="kobo.243.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.244.1">supervisord.conf</span></strong><span class="koboSpan" id="kobo.245.1"> file is important because it includes the bootstrap command of the web server</span><a id="_idIndexMarker168"/><span class="koboSpan" id="kobo.246.1"> of the container. </span><span class="koboSpan" id="kobo.246.2">By default, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">supervisord.conf</span></strong><span class="koboSpan" id="kobo.248.1"> file contains the </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">command </span></span><span class="No-Break"><a id="_idIndexMarker169"/></span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">directive:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.251.1">
command=/usr/bin/php -d variables_order=EGPCS /var/www/html/artisan serve --host=0.0.0.0 --port=80</span></pre>
<p><span class="koboSpan" id="kobo.252.1">Now, we have Laravel Octane, so instead of using the classic </span><strong class="source-inline"><span class="koboSpan" id="kobo.253.1">artisan serve</span></strong><span class="koboSpan" id="kobo.254.1">, we have to change it and use </span><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">artisan octane:start</span></strong><span class="koboSpan" id="kobo.256.1">; so, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">docker/supervisor.conf</span></strong><span class="koboSpan" id="kobo.258.1"> file, you have to adjust the </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">command line:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.260.1">
command=/usr/bin/php -d variables_order=EGPCS /var/www/html/artisan octane:start --server=swoole --host=0.0.0.0 --port=80</span></pre>
<p><span class="koboSpan" id="kobo.261.1">If you look, you will see that with </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">artisan octane:start</span></strong><span class="koboSpan" id="kobo.263.1">, the Swoole server with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">--server=swoole</span></strong><span class="koboSpan" id="kobo.265.1"> parameter is </span><span class="No-Break"><span class="koboSpan" id="kobo.266.1">also defined.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.267.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.268.1">If you are confused by ports </span><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">80</span></strong><span class="koboSpan" id="kobo.270.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">81</span></strong><span class="koboSpan" id="kobo.272.1">, just to clarify: the application server inside the container will listen internally to port </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">80</span></strong><span class="koboSpan" id="kobo.274.1">. </span><span class="koboSpan" id="kobo.274.2">With </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">APP_PORT=81</span></strong><span class="koboSpan" id="kobo.276.1">, we are instructing Docker to map the external connections from port </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">81</span></strong><span class="koboSpan" id="kobo.278.1"> to internal </span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">port </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.280.1">80</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.281.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.282.1">When you change some</span><a id="_idIndexMarker170"/><span class="koboSpan" id="kobo.283.1"> Docker configuration files, you have to rebuild the image in </span><a id="_idIndexMarker171"/><span class="koboSpan" id="kobo.284.1">order for the container to use the changed files. </span><span class="koboSpan" id="kobo.284.2">To rebuild the image, use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">build</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.286.1"> option:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.287.1">
./vendor/bin/sail build --no-cache</span></pre>
<p><span class="koboSpan" id="kobo.288.1">This command takes a while to be completed, but once it is completed, you can execute the </span><strong class="source-inline"><span class="koboSpan" id="kobo.289.1">sail </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">up</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.291.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.292.1">
./vendor/bin/sail up</span></pre>
<p><span class="koboSpan" id="kobo.293.1">When Octane is ready, you will see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">INFO  Server </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.295.1">running…</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.296.1"> message:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer023">
<span class="koboSpan" id="kobo.297.1"><img alt="Figure 3.4 – The Octane server is running" src="image/Figure_3.4_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.298.1">Figure 3.4 – The Octane server is running</span></p>
<p><span class="koboSpan" id="kobo.299.1">If you open your browser, you can access </span><strong class="source-inline"><span class="koboSpan" id="kobo.300.1">http://localhost:81</span></strong><span class="koboSpan" id="kobo.301.1">. </span><span class="koboSpan" id="kobo.301.2">The message in your console says that the server is listening to port </span><strong class="source-inline"><span class="koboSpan" id="kobo.302.1">80</span></strong><span class="koboSpan" id="kobo.303.1">, but as we previously mentioned, the process wherein the server is listening to port </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">80</span></strong><span class="koboSpan" id="kobo.305.1"> is the internal process inside the Docker container. </span><span class="koboSpan" id="kobo.305.2">The processes external to the Docker container (your browser) have to refer to the exposed port (</span><strong class="source-inline"><span class="koboSpan" id="kobo.306.1">81</span></strong><span class="koboSpan" id="kobo.307.1"> according to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">APP_PORT</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.309.1"> configuration).</span></span></p>
<p><span class="koboSpan" id="kobo.310.1">In your browser, you will see the default welcome Laravel page. </span><span class="koboSpan" id="kobo.310.2">You can tell that this page is served by Octane and Swoole from the HTTP server header from the response. </span><span class="koboSpan" id="kobo.310.3">A way to see this is to launch the </span><strong class="source-inline"><span class="koboSpan" id="kobo.311.1">curl</span></strong><span class="koboSpan" id="kobo.312.1"> command with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">-I</span></strong><span class="koboSpan" id="kobo.314.1"> option to show the header, and filter the header needed with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.315.1">grep</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.316.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.317.1">
curl -I 127.0.0.1:81 -s | grep ^Server</span></pre>
<p><span class="koboSpan" id="kobo.318.1">The output will be </span><a id="_idIndexMarker172"/><span class="No-Break"><span class="koboSpan" id="kobo.319.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.320.1">
Server: swoole-http-server</span></pre>
<p><span class="koboSpan" id="kobo.321.1">This means that the </span><a id="_idIndexMarker173"/><span class="koboSpan" id="kobo.322.1">Laravel application is served by Octane and the Swoole </span><span class="No-Break"><span class="koboSpan" id="kobo.323.1">application server.</span></span></p>
<p><span class="koboSpan" id="kobo.324.1">So, we can start to use some Swoole functionalities – but before that, let us install </span><span class="No-Break"><span class="koboSpan" id="kobo.325.1">Open Swoole.</span></span></p>
<h1 id="_idParaDest-48"><a id="_idTextAnchor055"/><span class="koboSpan" id="kobo.326.1">Installing Open Swoole</span></h1>
<p><span class="koboSpan" id="kobo.327.1">Laravel Sail uses by default an image</span><a id="_idIndexMarker174"/><span class="koboSpan" id="kobo.328.1"> with PHP that includes Swoole modules. </span><span class="koboSpan" id="kobo.328.2">Swoole is distributed as a PECL module and you can find it here: </span><a href="https://pecl.php.net/package/swoole"><span class="koboSpan" id="kobo.329.1">https://pecl.php.net/package/swoole</span></a><span class="koboSpan" id="kobo.330.1">. </span><span class="koboSpan" id="kobo.330.2">The sources</span><a id="_idIndexMarker175"/><span class="koboSpan" id="kobo.331.1"> are </span><span class="No-Break"><span class="koboSpan" id="kobo.332.1">here: </span></span><a href="https://github.com/swoole/swoole-src"><span class="No-Break"><span class="koboSpan" id="kobo.333.1">https://github.com/swoole/swoole-src</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.334.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.335.1">Some developers forked the source of Swoole, creating the Open Swoole project to address </span><span class="No-Break"><span class="koboSpan" id="kobo.336.1">security concerns.</span></span></p>
<p><span class="koboSpan" id="kobo.337.1">The reason for the fork is reported </span><span class="No-Break"><span class="koboSpan" id="kobo.338.1">here: </span></span><a href="https://news-web.php.net/php.pecl.dev/17446"><span class="No-Break"><span class="koboSpan" id="kobo.339.1">https://news-web.php.net/php.pecl.dev/17446</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.340.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.341.1">So, if you want to use Swoole as the engine for Laravel Octane, you could decide to use the Open Swoole implementation. </span><span class="koboSpan" id="kobo.341.2">If you want to use Open Swoole, the installation and the configuration are the same as Swoole; Open Swoole is also distributed as a </span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">PECL module.</span></span></p>
<p><span class="koboSpan" id="kobo.343.1">Laravel Octane </span><span class="No-Break"><span class="koboSpan" id="kobo.344.1">supports both.</span></span></p>
<p><span class="koboSpan" id="kobo.345.1">For demonstration purposes, I will install Open Swoole for a new Laravel project directly in the operating system (</span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">no Docker):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.347.1">
# installing new Laravel application
laravel new octane-ch03-openswoole
# entering into the new directory
cd octane-ch03-openswoole
# installing Pecl module
pecl install openswoole
# installing Octane package
composer require laravel/octane
# installing Laravel Octane files
php artisan octane:install
# launching the OpenSwoole server
php artisan octane:start</span></pre>
<p><span class="koboSpan" id="kobo.348.1">To check that the HTTP response is created by the Open Swoole server, in another terminal session, launch the following </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.349.1">curl</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.350.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.351.1">
curl -I 127.0.0.1:8000 -s | grep ^Server</span></pre>
<p><span class="koboSpan" id="kobo.352.1">Here’s </span><span class="No-Break"><span class="koboSpan" id="kobo.353.1">the output:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.354.1">
Server: OpenSwoole 4.11.1</span></pre>
<p><span class="koboSpan" id="kobo.355.1">So, Open Swoole is a fork </span><a id="_idIndexMarker176"/><span class="koboSpan" id="kobo.356.1">of the Swoole project. </span><span class="koboSpan" id="kobo.356.2">We will refer to it as Swoole; you can decide which you want to install. </span><span class="koboSpan" id="kobo.356.3">The features discussed in the </span><em class="italic"><span class="koboSpan" id="kobo.357.1">Exploring Swoole features</span></em><span class="koboSpan" id="kobo.358.1"> section are supported both by Swoole and </span><span class="No-Break"><span class="koboSpan" id="kobo.359.1">Open Swoole.</span></span></p>
<p><span class="koboSpan" id="kobo.360.1">Before exploring the Swoole features, we should install one more package that improves the </span><span class="No-Break"><span class="koboSpan" id="kobo.361.1">developer experience.</span></span></p>
<h1 id="_idParaDest-49"><a id="_idTextAnchor056"/><span class="koboSpan" id="kobo.362.1">Before editing the code</span></h1>
<p><span class="koboSpan" id="kobo.363.1">We are going to use Swoole functionalities, implementing some example code. </span><span class="koboSpan" id="kobo.363.2">When you change (or edit) your code and Laravel Octane has already loaded the worker, you have to reload the worker. </span><span class="koboSpan" id="kobo.363.3">Manually, you can use an </span><a id="_idIndexMarker177"/><span class="koboSpan" id="kobo.364.1">Octane command. </span><span class="koboSpan" id="kobo.364.2">If you are using Laravel Sail (so Docker), you have to run the command in the container. </span><span class="koboSpan" id="kobo.364.3">The command is </span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.366.1">
php artisan octane:reload --server=swoole</span></pre>
<p><span class="koboSpan" id="kobo.367.1">If you are running in a container, you have to use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">sail</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.369.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.370.1">
vendor/bin/sail php artisan octane:reload --server=swoole</span></pre>
<p><span class="koboSpan" id="kobo.371.1">If you want to avoid manually reloading workers every time you edit or change your code and you want that Octane watches automatically the file changes, you have to do </span><span class="No-Break"><span class="koboSpan" id="kobo.372.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.373.1">Install the </span><strong class="bold"><span class="koboSpan" id="kobo.374.1">chokidar</span></strong><span class="koboSpan" id="kobo.375.1"> node package </span><a id="_idIndexMarker178"/><span class="koboSpan" id="kobo.376.1">used by Octane in </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">watch</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.378.1"> mode</span></span></li>
<li><span class="koboSpan" id="kobo.379.1">Change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">supervisord</span></strong><span class="koboSpan" id="kobo.381.1"> configuration file in order to launch Octane with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.382.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">watch</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.384.1"> option</span></span></li>
<li><span class="koboSpan" id="kobo.385.1">Rebuild the image to reflect </span><span class="No-Break"><span class="koboSpan" id="kobo.386.1">the changes</span></span></li>
<li><span class="koboSpan" id="kobo.387.1">Execute </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.388.1">Sail</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.389.1"> again</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.390.1">So, first, let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.391.1">install </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">chokidar</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.393.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.394.1">
npm install --save-dev chokidar</span></pre>
<p><span class="koboSpan" id="kobo.395.1">In </span><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">docker/8.1/supervisord.conf</span></strong><span class="koboSpan" id="kobo.397.1">, add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.398.1">--watch</span></strong><span class="koboSpan" id="kobo.399.1"> option to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.400.1">octane:start</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.401.1">command directive:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.402.1">
command=/usr/bin/php -d variables_order=EGPCS /var/www/html/artisan octane:start --server=swoole --host=0.0.0.0 --port=80 </span><strong class="bold"><span class="koboSpan" id="kobo.403.1">--watch</span></strong></pre>
<p><span class="koboSpan" id="kobo.404.1">Then, rebuild the Docker image to be sure that the update to the configuration takes effect and then launch the Laravel </span><span class="No-Break"><span class="koboSpan" id="kobo.405.1">Sail service:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.406.1">
vendor/bin/sail build
vendor/bin/sail up</span></pre>
<p><span class="koboSpan" id="kobo.407.1">Now, when you edit the </span><a id="_idIndexMarker179"/><span class="koboSpan" id="kobo.408.1">code (in the PHP files of your Laravel application), the workers will be automatically reloaded. </span><span class="koboSpan" id="kobo.408.2">In the output messages of Octane, you will see </span><span class="No-Break"><span class="koboSpan" id="kobo.409.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.410.1">
INFO  Application change detected. </span><span class="koboSpan" id="kobo.410.2">Restarting workers…</span></pre>
<p><span class="koboSpan" id="kobo.411.1">Now that we have the auto-reload functionality, we can explore the </span><span class="No-Break"><span class="koboSpan" id="kobo.412.1">Swoole features.</span></span></p>
<h1 id="_idParaDest-50"><a id="_idTextAnchor057"/><span class="koboSpan" id="kobo.413.1">Exploring Swoole features</span></h1>
<p><span class="koboSpan" id="kobo.414.1">Swoole has a lot of</span><a id="_idIndexMarker180"/><span class="koboSpan" id="kobo.415.1"> features that we can use in the Laravel Octane application in order to improve the performance and speed of our application. </span><span class="koboSpan" id="kobo.415.2">In this chapter, we are going to explore these functionalities and then in the subsequent chapters, we will use these functionalities. </span><span class="koboSpan" id="kobo.415.3">The Swoole functionalities that we are going to explore are </span><span class="No-Break"><span class="koboSpan" id="kobo.416.1">as follows:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.417.1">Concurrent tasks</span></span></li>
<li><span class="koboSpan" id="kobo.418.1">Interval </span><span class="No-Break"><span class="koboSpan" id="kobo.419.1">command execution</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.420.1">Caching</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.421.1">Tables</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.422.1">Metrics</span></span></li>
</ul>
<h2 id="_idParaDest-51"><a id="_idTextAnchor058"/><span class="koboSpan" id="kobo.423.1">Concurrent tasks</span></h2>
<p><span class="koboSpan" id="kobo.424.1">With Swoole, it is possible to</span><a id="_idIndexMarker181"/><span class="koboSpan" id="kobo.425.1"> execute multiple tasks in parallel. </span><span class="koboSpan" id="kobo.425.2">To demonstrate this, we are going to implement two functions whose execution takes </span><span class="No-Break"><span class="koboSpan" id="kobo.426.1">some time.</span></span></p>
<p><span class="koboSpan" id="kobo.427.1">To simulate the fact that these two functions are time-consuming, we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.428.1">sleep()</span></strong><span class="koboSpan" id="kobo.429.1"> function, which suspends execution for a certain number </span><span class="No-Break"><span class="koboSpan" id="kobo.430.1">of seconds.</span></span></p>
<p><span class="koboSpan" id="kobo.431.1">These two functions return strings: the first one returns “</span><strong class="source-inline"><span class="koboSpan" id="kobo.432.1">Hello</span></strong><span class="koboSpan" id="kobo.433.1">” and the second one </span><span class="No-Break"><span class="koboSpan" id="kobo.434.1">returns “</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.435.1">World</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.436.1">”.</span></span></p>
<p><span class="koboSpan" id="kobo.437.1">We are going to set the execution time to 2 seconds, via the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.438.1">sleep()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.439.1"> function.</span></span></p>
<p><span class="koboSpan" id="kobo.440.1">In a classic scenario of sequential execution of the two functions, the total time taken would be 4 seconds plus a millesimal due </span><span class="No-Break"><span class="koboSpan" id="kobo.441.1">to overheads.</span></span></p>
<p><span class="koboSpan" id="kobo.442.1">We are going to track the execution time using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">hrtime()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.444.1"> function.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.445.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.446.1">When you need to track the execution time of a series of instructions, the use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.447.1">hrtime()</span></strong><span class="koboSpan" id="kobo.448.1"> is recommended since it is a function that returns monotonic timestamps. </span><span class="koboSpan" id="kobo.448.2">A monotonic timestamp is a time calculated based on a reference point (thus relative) and is not affected by system date changes such as automatic clock adjustments (NTP or Daylight Savings </span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">Time updates).</span></span></p>
<p><span class="koboSpan" id="kobo.450.1">We are also going to use two anonymous functions because this will come in handy in the second example (the example with concurrent execution) to be able to make an </span><span class="No-Break"><span class="koboSpan" id="kobo.451.1">easier comparison.</span></span></p>
<p><span class="koboSpan" id="kobo.452.1">Another consideration, before we take a look at the code, we are going to implement the examples directly in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.453.1">routes/web.php</span></strong><span class="koboSpan" id="kobo.454.1"> file for simplicity and focus on the example code. </span><span class="koboSpan" id="kobo.454.2">You can</span><a id="_idIndexMarker182"/><span class="koboSpan" id="kobo.455.1"> use that code, especially </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">Octane::concurrently()</span></strong><span class="koboSpan" id="kobo.457.1"> in your controllers or other parts of your </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">Laravel application.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.459.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.460.1">For access to these examples, we are going to use the configuration with Laravel Sail and Swoole, with </span><strong class="source-inline"><span class="koboSpan" id="kobo.461.1">APP_PORT</span></strong><span class="koboSpan" id="kobo.462.1"> set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">81</span></strong><span class="koboSpan" id="kobo.464.1">. </span><span class="koboSpan" id="kobo.464.2">If you are going to use your local Open Swoole installation, refer to </span><strong class="source-inline"><span class="koboSpan" id="kobo.465.1">127.0.0.1:8000</span></strong><span class="koboSpan" id="kobo.466.1"> instead </span><span class="No-Break"><span class="koboSpan" id="kobo.467.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.468.1">127.0.0.1:81</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.469.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.470.1">The example shows the </span><span class="No-Break"><span class="koboSpan" id="kobo.471.1">sequential execution:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.472.1">
Route::get('/serial-task', function () {
    $start = hrtime(true);
    [$fn1, $fn2] = [
        function () {
            sleep(2);
            return 'Hello';
        },
        function () {
            sleep(2);
            return 'World';
        },
    ];
    $result1 = $fn1();
    $result2 = $fn2();
    $end = hrtime(true);
    return "{$result1} {$result2} in ".($end - $start) /
      1000000000 .' </span><span class="koboSpan" id="kobo.472.2">seconds';
});</span></pre>
<p><span class="koboSpan" id="kobo.473.1">If you access the </span><strong class="source-inline"><span class="koboSpan" id="kobo.474.1">http://127.0.0.1:81/serial-task</span></strong><span class="koboSpan" id="kobo.475.1">page with your browser, you should see this output on </span><span class="No-Break"><span class="koboSpan" id="kobo.476.1">your page:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.477.1">
Hello World in 4.001601125 seconds</span></pre>
<p><span class="koboSpan" id="kobo.478.1">The two functions are executed</span><a id="_idIndexMarker183"/><span class="koboSpan" id="kobo.479.1"> sequentially, which means that the execution time is the sum of the execution time of the first function and that of the </span><span class="No-Break"><span class="koboSpan" id="kobo.480.1">second function.</span></span></p>
<p><span class="koboSpan" id="kobo.481.1">If you call the two functions with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.482.1">Octane::concurrently()</span></strong><span class="koboSpan" id="kobo.483.1"> method (passing your functions as an array of </span><strong class="source-inline"><span class="koboSpan" id="kobo.484.1">Closure</span></strong><span class="koboSpan" id="kobo.485.1">), you can execute the functions </span><span class="No-Break"><span class="koboSpan" id="kobo.486.1">in parallel:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.487.1">
use Laravel\Octane\Facades\Octane;
Route::get('/concurrent-task', function () {
    $start = hrtime(true);
    [$result1, $result2] = Octane::concurrently([
        function () {
            sleep(2);
            return 'Hello';
        },
        function () {
            sleep(2);
            return 'World';
        },
    ]);
    $end = hrtime(true);
    return "{$result1} {$result2} in ".($end - $start) /
      1000000000 .' </span><span class="koboSpan" id="kobo.487.2">seconds';
});</span></pre>
<p><span class="koboSpan" id="kobo.488.1">If you open your browser to </span><strong class="source-inline"><span class="koboSpan" id="kobo.489.1">http://127.0.0.1:81/concurrent-task</span></strong><span class="koboSpan" id="kobo.490.1">, you will see the </span><span class="No-Break"><span class="koboSpan" id="kobo.491.1">following message:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.492.1">
Hello World in 2.035140709 seconds</span></pre>
<p><span class="koboSpan" id="kobo.493.1">Another thing to note is that for concurrent functions, the execution time depends on what happens inside the function. </span><span class="koboSpan" id="kobo.493.2">For example, if you want to execute two or more functions in parallel that take an unpredictable amount of time because they depend on third-party factors such </span><a id="_idIndexMarker184"/><span class="koboSpan" id="kobo.494.1">as the response time of web services or the workload of a database, or when a huge file is being parsed, you probably can’t make any assumptions about the order of the execution or the </span><span class="No-Break"><span class="koboSpan" id="kobo.495.1">duration time.</span></span></p>
<p><span class="koboSpan" id="kobo.496.1">In the next example, we have two simple functions: the first one takes more time to be executed, so even though it is the first function, it is completed after the second one. </span><span class="koboSpan" id="kobo.496.2">This is obvious for people who are used to working with parallel tasks but probably is less obvious for people who are used to using a strong synchronous language (such as PHP without Swoole or other tools that add </span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">asynchronous functionalities):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.498.1">
use Laravel\Octane\Facades\Octane;
Route::get('/who-is-the-first', function () {
    $start = hrtime(true);
    [$result1, $result2] = Octane::concurrently([
        function () {
            sleep(2);
            Log::info('Concurrent function: First');
            return 'Hello';
        },
        function () {
            sleep(1);
            Log::info('Concurrent function: Second');
            return 'World';
        },
    ]);
    $end = hrtime(true);
    return "{$result1} {$result2} in ".($end - $start) /
      1000000000 .' </span><span class="koboSpan" id="kobo.498.2">seconds';
});</span></pre>
<p><span class="koboSpan" id="kobo.499.1">The result is to print the second </span><a id="_idIndexMarker185"/><span class="koboSpan" id="kobo.500.1">statement in the log file before the first one. </span><span class="koboSpan" id="kobo.500.2">If you take a look at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.501.1">storage/logs/laravel.log</span></strong><span class="koboSpan" id="kobo.502.1"> file, you will see </span><span class="No-Break"><span class="koboSpan" id="kobo.503.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.504.1">
local.INFO: Concurrent function: Second
local.INFO: Concurrent function: First</span></pre>
<p><span class="koboSpan" id="kobo.505.1">It means that the execution of the functions called by </span><strong class="source-inline"><span class="koboSpan" id="kobo.506.1">Octane::concurrently</span></strong><span class="koboSpan" id="kobo.507.1"> start more or less at the same time, but the exact moment they are completed, the execution, depends on the time needed by the execution of </span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">the function.</span></span></p>
<p><span class="koboSpan" id="kobo.509.1">Why is this important to keep </span><span class="No-Break"><span class="koboSpan" id="kobo.510.1">in mind?</span></span></p>
<p><span class="koboSpan" id="kobo.511.1">Because everything might be okay if the two functions are totally independent of each other. </span><span class="koboSpan" id="kobo.511.2">On the other hand, if the functions operate using the same resources (reading and writing to the same database table, for example), we need to consider the dependencies between the two operations. </span><span class="koboSpan" id="kobo.511.3">For example, one function might alter the data in the table, while the other function might read it. </span><span class="koboSpan" id="kobo.511.4">The time at which the data is read is relevant: think about whether the data is read before it is written or whether it is read after it is written. </span><span class="koboSpan" id="kobo.511.5">In this case, we might have two totally </span><span class="No-Break"><span class="koboSpan" id="kobo.512.1">different behaviors.</span></span></p>
<p><span class="koboSpan" id="kobo.513.1">Regardless, we will go more deeply into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.514.1">concurrently</span></strong><span class="koboSpan" id="kobo.515.1"> method in the next chapter, where we will use Octane in a</span><a id="_idIndexMarker186"/><span class="koboSpan" id="kobo.516.1"> more real-life scenario – for example, using </span><strong class="source-inline"><span class="koboSpan" id="kobo.517.1">concurrently</span></strong><span class="koboSpan" id="kobo.518.1"> to retrieve data from multiple database queries and multiple </span><span class="No-Break"><span class="koboSpan" id="kobo.519.1">API calls.</span></span></p>
<h2 id="_idParaDest-52"><a id="_idTextAnchor059"/><span class="koboSpan" id="kobo.520.1">Interval command execution</span></h2>
<p><span class="koboSpan" id="kobo.521.1">Sometimes, you have to </span><a id="_idIndexMarker187"/><span class="koboSpan" id="kobo.522.1">execute a function every X second(s). </span><span class="koboSpan" id="kobo.522.2">For example, you want to execute a function every 10 seconds. </span><span class="koboSpan" id="kobo.522.3">With Swoole, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">Octane::tick()</span></strong><span class="koboSpan" id="kobo.524.1"> function, where you can provide a name (as the first parameter) and the function defining a </span><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">Closure</span></strong><span class="koboSpan" id="kobo.526.1"> as the </span><span class="No-Break"><span class="koboSpan" id="kobo.527.1">second parameter.</span></span></p>
<p><span class="koboSpan" id="kobo.528.1">The best place to call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">tick()</span></strong><span class="koboSpan" id="kobo.530.1"> function is in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.531.1">boot()</span></strong><span class="koboSpan" id="kobo.532.1"> method of one of your service providers. </span><span class="koboSpan" id="kobo.532.2">Typically, I use the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.533.1">AppServiceProvider</span></strong><span class="koboSpan" id="kobo.534.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">app/Providers</span></strong><span class="koboSpan" id="kobo.536.1"> directory, already created for you when you set up a new Laravel application (with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.537.1">laravel new</span></strong><span class="koboSpan" id="kobo.538.1"> command, </span><span class="No-Break"><span class="koboSpan" id="kobo.539.1">for example).</span></span></p>
<p><span class="koboSpan" id="kobo.540.1">In </span><strong class="source-inline"><span class="koboSpan" id="kobo.541.1">app/Providers/AppServiceProvider.php</span></strong><span class="koboSpan" id="kobo.542.1">, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">boot()</span></strong><span class="koboSpan" id="kobo.544.1"> method, call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.545.1">Octane::tick()</span></strong><span class="koboSpan" id="kobo.546.1"> function with a very simple feature that logs a message with the timestamp. </span><span class="koboSpan" id="kobo.546.2">The log message will be tracked in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.547.1">storage/logs/laravel.log</span></strong><span class="koboSpan" id="kobo.548.1"> file unless you have some special configuration in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.549.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.550.1">env</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.551.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.552.1">
    public function boot()
    {
        Octane::tick('simple-ticker', fn () =&gt;
        Log::info('OCTANE TICK.', ['timestamp' =&gt; now()]))
        -&gt;seconds(10)
        -&gt;immediate();
    }</span></pre>
<p><span class="koboSpan" id="kobo.553.1">In the preceding code snippet, we are using </span><strong class="source-inline"><span class="koboSpan" id="kobo.554.1">Octane</span></strong><span class="koboSpan" id="kobo.555.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.556.1">Log</span></strong><span class="koboSpan" id="kobo.557.1"> classes, so remember to include them at the top of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.558.1">AppServiceProvider.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.559.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.560.1">
use Laravel\Octane\Facades\Octane;
use Illuminate\Support\Facades\Log;</span></pre>
<p><span class="koboSpan" id="kobo.561.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.562.1">Octane::tick()</span></strong><span class="koboSpan" id="kobo.563.1"> method returns the </span><strong class="source-inline"><span class="koboSpan" id="kobo.564.1">InvokeTickCallable</span></strong><span class="koboSpan" id="kobo.565.1"> object that implements a </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">few methods:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">__invoke()</span></strong><span class="koboSpan" id="kobo.568.1">: A special method used for invoking the </span><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">tick()</span></strong><span class="koboSpan" id="kobo.570.1"> listener; it is the method responsible for executing the function passed as the second parameter to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.571.1">tick()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.572.1"> method.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">seconds()</span></strong><span class="koboSpan" id="kobo.574.1">: A method for indicating how often the listener should be automatically invoked (via the </span><strong class="source-inline"><span class="koboSpan" id="kobo.575.1">__invoke()</span></strong><span class="koboSpan" id="kobo.576.1"> method). </span><span class="koboSpan" id="kobo.576.2">It accepts an integer parameter </span><span class="No-Break"><span class="koboSpan" id="kobo.577.1">in seconds.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.578.1">immediate()</span></strong><span class="koboSpan" id="kobo.579.1">: A method indicating that</span><a id="_idIndexMarker188"/><span class="koboSpan" id="kobo.580.1"> the listener should be invoked on the first tick (so, as soon </span><span class="No-Break"><span class="koboSpan" id="kobo.581.1">as possible).</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.582.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.583.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.584.1">tick()</span></strong><span class="koboSpan" id="kobo.585.1"> method from the application service is called when you start the </span><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">octane:start</span></strong><span class="koboSpan" id="kobo.587.1"> command. </span><span class="koboSpan" id="kobo.587.2">If you are using Laravel Sail, the application service is loaded and booted when you run </span><strong class="source-inline"><span class="koboSpan" id="kobo.588.1">sail up</span></strong><span class="koboSpan" id="kobo.589.1">, just because at the end, Sail launches </span><strong class="source-inline"><span class="koboSpan" id="kobo.590.1">supervisord</span></strong><span class="koboSpan" id="kobo.591.1"> and the configuration of </span><strong class="source-inline"><span class="koboSpan" id="kobo.592.1">supervisord</span></strong><span class="koboSpan" id="kobo.593.1"> has the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">octane:start</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.595.1"> command.</span></span></p>
<p><span class="koboSpan" id="kobo.596.1">Once Octane is started in </span><strong class="source-inline"><span class="koboSpan" id="kobo.597.1">storage/logs/laravel.log</span></strong><span class="koboSpan" id="kobo.598.1">, you can see the message logged by the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.599.1">tick()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.600.1"> function:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.601.1">
[2022-07-29 08:23:11] local.INFO: OCTANE TICK. </span><span class="koboSpan" id="kobo.601.2">{"timestamp":"2022-07-29 08:23:11"}
[2022-07-29 08:23:22] local.INFO: OCTANE TICK. </span><span class="koboSpan" id="kobo.601.3">{"timestamp":"2022-07-29 08:23:21"}
[2022-07-29 08:23:31] local.INFO: OCTANE TICK. </span><span class="koboSpan" id="kobo.601.4">{"timestamp":"2022-07-29 08:23:31"} [2022-07-26 20:45:19] local.INFO: OCTANE TICK. </span><span class="koboSpan" id="kobo.601.5">{"timestamp":"2022-07-26 20:45:19"}</span></pre>
<p><span class="koboSpan" id="kobo.602.1">In the snippet here, the Laravel log shows us the execution of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.603.1">tick()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.604.1"> method.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.605.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.606.1">For displaying the log in real time, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.607.1">tail -f</span></strong><span class="koboSpan" id="kobo.608.1"> command – for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">tail -</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.610.1">f storage/logs/laravel.log</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">.</span></span></p>
<h2 id="_idParaDest-53"><a id="_idTextAnchor060"/><span class="koboSpan" id="kobo.612.1">Caching</span></h2>
<p><span class="koboSpan" id="kobo.613.1">Managing a caching mechanism to </span><a id="_idIndexMarker189"/><span class="koboSpan" id="kobo.614.1">momentarily save some data in a system based on workers, where each worker has its own memory space, might not be </span><span class="No-Break"><span class="koboSpan" id="kobo.615.1">so straightforward.</span></span></p>
<p><span class="koboSpan" id="kobo.616.1">Laravel Octane provides a mechanism to non-permanently save data shared between different workers. </span><span class="koboSpan" id="kobo.616.2">This means that if a worker needs to store a value and make it available to subsequent executions by other workers, it is possible to do so through the cache mechanism. </span><span class="koboSpan" id="kobo.616.3">The caching mechanism in Laravel Octane is implemented through Swoole Table, which we will see in </span><span class="No-Break"><span class="koboSpan" id="kobo.617.1">detail later.</span></span></p>
<p><span class="koboSpan" id="kobo.618.1">In this specific case, we are going to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.619.1">Cache</span></strong><span class="koboSpan" id="kobo.620.1"> class exposed directly by Laravel. </span><span class="koboSpan" id="kobo.620.2">Laravel’s caching mechanism allows us to use different drivers, such as, for example, databases (MySQL, Postgresql, or SQLite), Memcache, Redis, or other drivers. </span><span class="koboSpan" id="kobo.620.3">Because we installed Laravel Octane and used Swoole, we can use a new Octane-specific driver. </span><span class="koboSpan" id="kobo.620.4">If we wanted to use Laravel’s caching mechanism, we would use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.621.1">Cache</span></strong><span class="koboSpan" id="kobo.622.1"> class with the classic </span><strong class="source-inline"><span class="koboSpan" id="kobo.623.1">store</span></strong><span class="koboSpan" id="kobo.624.1"> method to store a value. </span><span class="koboSpan" id="kobo.624.2">In the example, we are going to store a key called </span><strong class="source-inline"><span class="koboSpan" id="kobo.625.1">last-random-number</span></strong><span class="koboSpan" id="kobo.626.1"> in the Octane driver, to which we are going to associate a random number. </span><span class="koboSpan" id="kobo.626.2">In the example, we’re going to call the function responsible to store the value in the cache via the Octane tick seen earlier with an interval set to 10 seconds. </span><span class="koboSpan" id="kobo.626.3">We will see that every 10 seconds, a new cached value is generated with a random number. </span><span class="koboSpan" id="kobo.626.4">We are also going to implement a new route, </span><strong class="source-inline"><span class="koboSpan" id="kobo.627.1">/get-number</span></strong><span class="koboSpan" id="kobo.628.1">, where we are going to read this value and display it on a </span><span class="No-Break"><span class="koboSpan" id="kobo.629.1">web page.</span></span></p>
<p><span class="koboSpan" id="kobo.630.1">To obtain the Cache instance with the Octane provider you can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.631.1">Cache::store('octane')</span></strong><span class="koboSpan" id="kobo.632.1">. </span><span class="koboSpan" id="kobo.632.2">Once you have the instance, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.633.1">put()</span></strong><span class="koboSpan" id="kobo.634.1"> method to store the </span><span class="No-Break"><span class="koboSpan" id="kobo.635.1">new value.</span></span></p>
<p><span class="koboSpan" id="kobo.636.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.637.1">app/Providers/AppServiceProvider.php</span></strong><span class="koboSpan" id="kobo.638.1"> file, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.639.1">boot()</span></strong><span class="koboSpan" id="kobo.640.1"> method, add </span><span class="No-Break"><span class="koboSpan" id="kobo.641.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.642.1">
        Octane::tick('cache-last-random-number',
            function () {
                $number = rand(1, 1000);
                Cache::store('octane')-&gt;put(
                       'last-random-number', $number);
                Log::info("New number in cache: ${number}",
                         ['timestamp' =&gt; now()]);
                return;
            }
        )
        -&gt;seconds(10)
        -&gt;immediate();</span></pre>
<p><span class="koboSpan" id="kobo.643.1">Be sure that you include the right classes at the beginning of your file. </span><span class="koboSpan" id="kobo.643.2">The classes needed by this code snippet are</span><a id="_idIndexMarker190"/> <span class="No-Break"><span class="koboSpan" id="kobo.644.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.645.1">
use Illuminate\Support\Facades\Cache;
use Laravel\Octane\Facades\Octane;
use Illuminate\Support\Facades\Log;</span></pre>
<p><span class="koboSpan" id="kobo.646.1">If you want to check, you can see the log messages printed by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.647.1">tick()</span></strong><span class="koboSpan" id="kobo.648.1"> function in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.649.1">storage/logs/laravel.log</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.650.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.651.1">Now, we can create a new route in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.652.1">routes/web.php</span></strong><span class="koboSpan" id="kobo.653.1"> file, where we get the value (</span><strong class="source-inline"><span class="koboSpan" id="kobo.654.1">last-random-number</span></strong><span class="koboSpan" id="kobo.655.1">) from </span><span class="No-Break"><span class="koboSpan" id="kobo.656.1">the cache:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.657.1">
use Illuminate\Support\Facades\Cache;
Route::get('/get-random-number', function () {
    $number = Cache::store('octane')-&gt;get(
      'last-random-number', 0);
    return $number;
});</span></pre>
<p><span class="koboSpan" id="kobo.658.1">If you open your browser and you go to your </span><strong class="source-inline"><span class="koboSpan" id="kobo.659.1">/get-random-number</span></strong><span class="koboSpan" id="kobo.660.1"> path (in my case, </span><strong class="source-inline"><span class="koboSpan" id="kobo.661.1">http://127.0.0.1:81/get-random-number</span></strong><span class="koboSpan" id="kobo.662.1"> because I’m using Laravel Sail and I set </span><strong class="source-inline"><span class="koboSpan" id="kobo.663.1">APP_PORT=81</span></strong><span class="koboSpan" id="kobo.664.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.665.1">.env</span></strong><span class="koboSpan" id="kobo.666.1"> file), you can see the random number. </span><span class="koboSpan" id="kobo.666.2">If you refresh the page, you will see the same number for 10 seconds, or in general for the interval time set with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">tick()</span></strong><span class="koboSpan" id="kobo.668.1"> function (in the service </span><span class="No-Break"><span class="koboSpan" id="kobo.669.1">provider file).</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.670.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.671.1">The storage in the Octane cache is not permanent; it is volatile. </span><span class="koboSpan" id="kobo.671.2">This means that you can lose the values every time the server </span><span class="No-Break"><span class="koboSpan" id="kobo.672.1">is restarted.</span></span></p>
<p><span class="koboSpan" id="kobo.673.1">With the Octane cache, we have</span><a id="_idIndexMarker191"/><span class="koboSpan" id="kobo.674.1"> also some other nice methods, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.675.1">increment</span></strong><span class="koboSpan" id="kobo.676.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.677.1">decrement</span></strong><span class="koboSpan" id="kobo.678.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.679.1">for example:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.680.1">
Route::get('/increment-number', function () {
    $number =
      Cache::store('octane')-&gt;increment('my-number');
    return $number;
});
Route::get('/decrement-number', function () {
    $number =
      Cache::store('octane')-&gt;decrement('my-number');
    return $number;
});
Route::get('/get-number', function () {
    $number = Cache::store('octane')-&gt;get('my-number', 0);
    return $number;
});</span></pre>
<p><span class="koboSpan" id="kobo.681.1">Now, open your browser and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.682.1">/increment-number</span></strong><span class="koboSpan" id="kobo.683.1"> path load multiple times and then </span><strong class="source-inline"><span class="koboSpan" id="kobo.684.1">load /get-number</span></strong><span class="koboSpan" id="kobo.685.1">; you will see the </span><span class="No-Break"><span class="koboSpan" id="kobo.686.1">incremented value.</span></span></p>
<p><span class="koboSpan" id="kobo.687.1">Other useful functions for managing multiple values are </span><strong class="source-inline"><span class="koboSpan" id="kobo.688.1">putMany()</span></strong><span class="koboSpan" id="kobo.689.1">, which saves an array of items, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.690.1">many()</span></strong><span class="koboSpan" id="kobo.691.1">, which retrieves more items at </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">a time:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.693.1">
Route::get('/save-many', function () {
    Cache::store('octane')-&gt;putMany([
        'my-number' =&gt; 42,
        'my-string' =&gt; 'Hello World!',
        'my-array' =&gt; ['Kiwi', 'Strawberry', 'Lemon'],
    ]);
    return "Items saved!";
});
Route::get('/get-many', function () {
    $array = Cache::store('octane')-&gt;many([
        'my-number',
        'my-string',
        'my-array',
    ]);
    return $array;
});</span></pre>
<p><span class="koboSpan" id="kobo.694.1">If you open your browser first at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.695.1">/save-many</span></strong><span class="koboSpan" id="kobo.696.1"> path and then at </span><strong class="source-inline"><span class="koboSpan" id="kobo.697.1">/get-many</span></strong><span class="koboSpan" id="kobo.698.1">, you will see the following on </span><a id="_idIndexMarker192"/><span class="No-Break"><span class="koboSpan" id="kobo.699.1">the page:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.700.1">
{"my-number":42,"my-string":"Hello World!","my-array":["Kiwi","Strawberry","Lemon"]}</span></pre>
<p><span class="koboSpan" id="kobo.701.1">If you saved a value as an item of an array with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.702.1">putMany()</span></strong><span class="koboSpan" id="kobo.703.1"> method, you can retrieve it as a single item using the array key as the </span><span class="No-Break"><span class="koboSpan" id="kobo.704.1">cache key:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.705.1">
Route::get('/get-one-from-many/{key?}', function ($key = "my-number") {
    return Cache::store('octane')-&gt;get($key);
});</span></pre>
<p><span class="koboSpan" id="kobo.706.1">If you open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.707.1">/get-one-from-many/my-string</span></strong><span class="koboSpan" id="kobo.708.1"> page, you will see </span><span class="No-Break"><span class="koboSpan" id="kobo.709.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.710.1">
Hello World!</span></pre>
<p><span class="koboSpan" id="kobo.711.1">This means that the value with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.712.1">"my-string"</span></strong><span class="koboSpan" id="kobo.713.1"> key is retrieved from </span><span class="No-Break"><span class="koboSpan" id="kobo.714.1">the cache.</span></span></p>
<p><span class="koboSpan" id="kobo.715.1">In the end, we are using the Laravel cached mechanism with Swoole as the </span><span class="No-Break"><span class="koboSpan" id="kobo.716.1">backend provider.</span></span></p>
<p><span class="koboSpan" id="kobo.717.1">Why should we use Swoole as a backend cache provider? </span><span class="koboSpan" id="kobo.717.2">What advantages does it have over other providers such as databases, for example? </span><span class="koboSpan" id="kobo.717.3">The way Swoole is made, we have seen that performance is</span><a id="_idIndexMarker193"/><span class="koboSpan" id="kobo.718.1"> certainly one of its main values. </span><span class="koboSpan" id="kobo.718.2">Using this kind of cache allows us to share information between workers in a very efficient way. </span><span class="koboSpan" id="kobo.718.3">Swoole’s official documentation reports that it supports a read-write rate of 2 million </span><span class="No-Break"><span class="koboSpan" id="kobo.719.1">per second.</span></span></p>
<p><span class="koboSpan" id="kobo.720.1">The Laravel Octane cache is implemented via Swoole Table. </span><span class="koboSpan" id="kobo.720.2">In the next section, we will look at </span><span class="No-Break"><span class="koboSpan" id="kobo.721.1">Swoole Table.</span></span></p>
<h2 id="_idParaDest-54"><a id="_idTextAnchor061"/><span class="koboSpan" id="kobo.722.1">Swoole Table</span></h2>
<p><span class="koboSpan" id="kobo.723.1">If you want to share data</span><a id="_idIndexMarker194"/><span class="koboSpan" id="kobo.724.1"> across workers in a more structured way than a cache, you can use Swoole Table. </span><span class="koboSpan" id="kobo.724.2">As already mentioned, the Octane cache uses Swoole Table, so let me explain a bit more about </span><span class="No-Break"><span class="koboSpan" id="kobo.725.1">Swoole Table.</span></span></p>
<p><span class="koboSpan" id="kobo.726.1">First, if you want to use Swoole Table, you must define the structure of the table. </span><span class="koboSpan" id="kobo.726.2">The structure is defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.727.1">config/octane.php</span></strong><span class="koboSpan" id="kobo.728.1"> file in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.729.1">tables</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.730.1"> section.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer024">
<span class="koboSpan" id="kobo.731.1"><img alt="Figure 3.5 – The configuration of a table in a config/octane.php file" src="image/Figure_3.5_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.732.1">Figure 3.5 – The configuration of a table in a config/octane.php file</span></p>
<p><span class="koboSpan" id="kobo.733.1">By default, when you execute the </span><strong class="source-inline"><span class="koboSpan" id="kobo.734.1">octane:install</span></strong><span class="koboSpan" id="kobo.735.1"> command, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.736.1">config/octane.php</span></strong><span class="koboSpan" id="kobo.737.1"> file is created for you, and a table is already defined: a table named </span><strong class="source-inline"><span class="koboSpan" id="kobo.738.1">example</span></strong><span class="koboSpan" id="kobo.739.1"> with a maximum of 1,000 rows (</span><strong class="source-inline"><span class="koboSpan" id="kobo.740.1">example:1000</span></strong><span class="koboSpan" id="kobo.741.1">) with 2 fields. </span><span class="koboSpan" id="kobo.741.2">The first one is called </span><strong class="source-inline"><span class="koboSpan" id="kobo.742.1">name</span></strong><span class="koboSpan" id="kobo.743.1"> and is a</span><a id="_idIndexMarker195"/><span class="koboSpan" id="kobo.744.1"> string with a maximum of 500 characters, and the second field is called </span><strong class="source-inline"><span class="koboSpan" id="kobo.745.1">votes</span></strong><span class="koboSpan" id="kobo.746.1"> and the type is an </span><span class="No-Break"><span class="koboSpan" id="kobo.747.1">integer (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.748.1">int</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.749.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.750.1">In the same way, you can configure your table. </span><span class="koboSpan" id="kobo.750.2">The field types are </span><span class="No-Break"><span class="koboSpan" id="kobo.751.1">as follows:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.752.1">int</span></strong><span class="koboSpan" id="kobo.753.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.754.1">For integers</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.755.1">float</span></strong><span class="koboSpan" id="kobo.756.1">: For </span><span class="No-Break"><span class="koboSpan" id="kobo.757.1">floating-point numbers</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.758.1">string</span></strong><span class="koboSpan" id="kobo.759.1">: For strings; you can define the max number </span><span class="No-Break"><span class="koboSpan" id="kobo.760.1">of characters</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.761.1">Once you have defined the table in the config file, you can set the values of </span><span class="No-Break"><span class="koboSpan" id="kobo.762.1">the table.</span></span></p>
<p><span class="koboSpan" id="kobo.763.1">For example, I’m going to create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.764.1">my-table</span></strong><span class="koboSpan" id="kobo.765.1"> table of max 100 rows with some fields. </span><span class="koboSpan" id="kobo.765.2">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.766.1">config/octane.php</span></strong><span class="koboSpan" id="kobo.767.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.768.1">tables</span></strong><span class="koboSpan" id="kobo.769.1"> section, we are going to create </span><span class="No-Break"><span class="koboSpan" id="kobo.770.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.771.1">A table named </span><strong class="source-inline"><span class="koboSpan" id="kobo.772.1">my-table</span></strong><span class="koboSpan" id="kobo.773.1"> with a maximum of </span><span class="No-Break"><span class="koboSpan" id="kobo.774.1">100 rows</span></span></li>
<li><span class="koboSpan" id="kobo.775.1">A UUID field with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.776.1">string</span></strong><span class="koboSpan" id="kobo.777.1"> type (maximum of </span><span class="No-Break"><span class="koboSpan" id="kobo.778.1">36 characters)</span></span></li>
<li><span class="koboSpan" id="kobo.779.1">A name field with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.780.1">string</span></strong><span class="koboSpan" id="kobo.781.1"> type (maximum of </span><span class="No-Break"><span class="koboSpan" id="kobo.782.1">1000 characters)</span></span></li>
<li><span class="koboSpan" id="kobo.783.1">An age field with an </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.784.1">int</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.785.1"> type</span></span></li>
<li><span class="koboSpan" id="kobo.786.1">A value field with a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.787.1">float</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.788.1"> type</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.789.1">Therefore, the configuration is </span><span class="No-Break"><span class="koboSpan" id="kobo.790.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.791.1">
        'my-table:100' =&gt; [
            'uuid' =&gt; 'string:36',
            'name' =&gt; 'string:1000',
            'age' =&gt; 'int',
            'value' =&gt; 'float',
        ],</span></pre>
<p><span class="koboSpan" id="kobo.792.1">When the server starts, Octane </span><a id="_idIndexMarker196"/><span class="koboSpan" id="kobo.793.1">will create the table in memory </span><span class="No-Break"><span class="koboSpan" id="kobo.794.1">for us.</span></span></p>
<p><span class="koboSpan" id="kobo.795.1">Now, we are going to create two routes: the first one is for seeding the table with some </span><em class="italic"><span class="koboSpan" id="kobo.796.1">fake</span></em><span class="koboSpan" id="kobo.797.1"> data, and the second one is for retrieving and showing information from </span><span class="No-Break"><span class="koboSpan" id="kobo.798.1">the table.</span></span></p>
<p><span class="koboSpan" id="kobo.799.1">The first route, </span><strong class="source-inline"><span class="koboSpan" id="kobo.800.1">/table-create</span></strong><span class="koboSpan" id="kobo.801.1">, will do </span><span class="No-Break"><span class="koboSpan" id="kobo.802.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.803.1">Obtain the table instance for </span><strong class="source-inline"><span class="koboSpan" id="kobo.804.1">my-table</span></strong><span class="koboSpan" id="kobo.805.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.806.1">my-table</span></strong><span class="koboSpan" id="kobo.807.1"> is the table configured </span><span class="No-Break"><span class="koboSpan" id="kobo.808.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.809.1">config/octane.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.810.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.811.1">Create 90 rows, filling fields for </span><strong class="source-inline"><span class="koboSpan" id="kobo.812.1">uuid</span></strong><span class="koboSpan" id="kobo.813.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.814.1">name</span></strong><span class="koboSpan" id="kobo.815.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.816.1">age</span></strong><span class="koboSpan" id="kobo.817.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.818.1">value</span></strong><span class="koboSpan" id="kobo.819.1">. </span><span class="koboSpan" id="kobo.819.2">For filling the values, we are going to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.820.1">fake()</span></strong><span class="koboSpan" id="kobo.821.1"> helper. </span><span class="koboSpan" id="kobo.821.2">This helper allows you to generate random values for UUIDs, names, integer numbers, decimal numbers, and </span><span class="No-Break"><span class="koboSpan" id="kobo.822.1">so on.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.823.1">The code in </span><strong class="source-inline"><span class="koboSpan" id="kobo.824.1">routes/web.php</span></strong><span class="koboSpan" id="kobo.825.1"> is </span><span class="No-Break"><span class="koboSpan" id="kobo.826.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.827.1">
Route::get('/table-create', function () {
    // Getting the table instance
    $table = Octane::table('my-table');
    // looping 1..90 creating rows with fake() helper
    for ($i=1; $i &lt;= 90; $i++) {
        $table-&gt;set($i,
        [
            'uuid' =&gt; fake()-&gt;uuid(),
            'name' =&gt; fake()-&gt;name(),
            'age' =&gt; fake()-&gt;numberBetween(18, 99),
            'value' =&gt; fake()-&gt;randomFloat(2, 0, 1000)
        ]);
    }
    return "Table created!";
});</span></pre>
<p><span class="koboSpan" id="kobo.828.1">The snippet creates the table once the </span><strong class="source-inline"><span class="koboSpan" id="kobo.829.1">/table-create</span></strong><span class="koboSpan" id="kobo.830.1"> URL </span><span class="No-Break"><span class="koboSpan" id="kobo.831.1">is called.</span></span></p>
<p><span class="koboSpan" id="kobo.832.1">If you open </span><strong class="source-inline"><span class="koboSpan" id="kobo.833.1">http://127.0.0.1:81/table-create</span></strong><span class="koboSpan" id="kobo.834.1">, you will see a table is created with </span><span class="No-Break"><span class="koboSpan" id="kobo.835.1">some rows.</span></span></p>
<p><span class="koboSpan" id="kobo.836.1">On your page, it’s possible</span><a id="_idIndexMarker197"/><span class="koboSpan" id="kobo.837.1"> that you have an error such as </span><span class="No-Break"><span class="koboSpan" id="kobo.838.1">this one:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.839.1">
Swoole\Table::set(): failed to set('91'), unable to allocate memory</span></pre>
<p><span class="koboSpan" id="kobo.840.1">Be sure that the size of the table in the configuration file is greater than the number of rows that you are creating. </span><span class="koboSpan" id="kobo.840.2">When we work with a database table, we don’t have to set the maximum number of rows; in this case, with this kind of table (in a memory table shared across the workers), we have to be aware of the number </span><span class="No-Break"><span class="koboSpan" id="kobo.841.1">of rows.</span></span></p>
<p><span class="koboSpan" id="kobo.842.1">Once everything is fine, you will see </span><strong class="bold"><span class="koboSpan" id="kobo.843.1">Table created!</span></strong><span class="koboSpan" id="kobo.844.1"> on your web page. </span><span class="koboSpan" id="kobo.844.2">This means that the rows were created in the </span><span class="No-Break"><span class="koboSpan" id="kobo.845.1">right way.</span></span></p>
<p><span class="koboSpan" id="kobo.846.1">To verify this, we are going to create a new route, </span><strong class="source-inline"><span class="koboSpan" id="kobo.847.1">/table-get</span></strong><span class="koboSpan" id="kobo.848.1">, where we do </span><span class="No-Break"><span class="koboSpan" id="kobo.849.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.850.1">Obtain the table instance for </span><strong class="source-inline"><span class="koboSpan" id="kobo.851.1">my-table</span></strong><span class="koboSpan" id="kobo.852.1"> (the same table we used </span><span class="No-Break"><span class="koboSpan" id="kobo.853.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.854.1">/table-create</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.855.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.856.1">Get the rows with </span><span class="No-Break"><span class="koboSpan" id="kobo.857.1">index 1</span></span></li>
<li><span class="koboSpan" id="kobo.858.1">Return the row (associative array, where the items are the fields of the row with </span><strong class="source-inline"><span class="koboSpan" id="kobo.859.1">uuid</span></strong><span class="koboSpan" id="kobo.860.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.861.1">name</span></strong><span class="koboSpan" id="kobo.862.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.863.1">age</span></strong><span class="koboSpan" id="kobo.864.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.865.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.866.1">value</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.867.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.868.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.869.1">routes/web.php</span></strong><span class="koboSpan" id="kobo.870.1"> file, define</span><a id="_idIndexMarker198"/><span class="koboSpan" id="kobo.871.1"> the </span><span class="No-Break"><span class="koboSpan" id="kobo.872.1">new route:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.873.1">
Route::get('/table-get', function () {
    $table = Octane::table('my-table');
    $row = $table-&gt;get(1);
    return $row;
});</span></pre>
<p><span class="koboSpan" id="kobo.874.1">Opening </span><strong class="source-inline"><span class="koboSpan" id="kobo.875.1">https://127.0.0.1:81/table-get</span></strong><span class="koboSpan" id="kobo.876.1"> (after opening </span><strong class="source-inline"><span class="koboSpan" id="kobo.877.1">/table-create</span></strong><span class="koboSpan" id="kobo.878.1"> because you have to create rows before accessing them), you should see something such as </span><span class="No-Break"><span class="koboSpan" id="kobo.879.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.880.1">
{"uuid":"6e7c7eb6-9ecf-3cf8-8de9-5034f4c44ab5","name":"Hugh Larson IV","age":81,"value":945.67}</span></pre>
<p><span class="koboSpan" id="kobo.881.1">You will see something different in terms of content because rows were generated using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.882.1">fake()</span></strong><span class="koboSpan" id="kobo.883.1"> helper, but you will see something similar in terms </span><span class="No-Break"><span class="koboSpan" id="kobo.884.1">of structure.</span></span></p>
<p><span class="koboSpan" id="kobo.885.1">You can also walk through Swoole Table using </span><strong class="source-inline"><span class="koboSpan" id="kobo.886.1">foreach()</span></strong><span class="koboSpan" id="kobo.887.1">, and you can also use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.888.1">count()</span></strong><span class="koboSpan" id="kobo.889.1"> function (for counting elements of a table) on the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.890.1">Table</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.891.1"> object:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.892.1">
Route::get('/table-get-all', function () {
    $table = Octane::table('my-table');
    $rows=[];
    foreach ($table as $key =&gt; $value) {
        $rows[$key] = $table-&gt;get($key);
    }
    // adding as first row the table rows count
    $rows[0] = count($table);
    return $rows;
});</span></pre>
<p><span class="koboSpan" id="kobo.893.1">In the preceding example, for counting rows, you can see that in the end, we can access the Swoole object and use the</span><a id="_idIndexMarker199"/><span class="koboSpan" id="kobo.894.1"> functions and methods implemented by it. </span><span class="koboSpan" id="kobo.894.2">Another example of using a Swoole object is accessing the server object, as in the next section for </span><span class="No-Break"><span class="koboSpan" id="kobo.895.1">retrieving metrics.</span></span></p>
<h2 id="_idParaDest-55"><a id="_idTextAnchor062"/><span class="koboSpan" id="kobo.896.1">Metrics</span></h2>
<p><span class="koboSpan" id="kobo.897.1">Swoole offers a method to</span><a id="_idIndexMarker200"/><span class="koboSpan" id="kobo.898.1"> retrieve some metrics about the resource usage of the application server and the workers. </span><span class="koboSpan" id="kobo.898.2">This is useful if you want to track the usage of some aspect – for example, the time, the number of requests served, the active connections, the memory usage, the number of tasks, and so on. </span><span class="koboSpan" id="kobo.898.3">To retrieve metrics, first of all, you have to access the Swoole class instance. </span><span class="koboSpan" id="kobo.898.4">Thanks to the service container provided by Laravel, you can resolve and access objects from the container. </span><span class="koboSpan" id="kobo.898.5">The Swoole server object is </span><em class="italic"><span class="koboSpan" id="kobo.899.1">stored</span></em><span class="koboSpan" id="kobo.900.1"> in the container by Octane so, via </span><strong class="source-inline"><span class="koboSpan" id="kobo.901.1">App::make</span></strong><span class="koboSpan" id="kobo.902.1">, you can access the Swoole server class instance. </span><span class="koboSpan" id="kobo.902.2">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.903.1">routes/web.php</span></strong><span class="koboSpan" id="kobo.904.1"> file, you can create a new route where you can do </span><span class="No-Break"><span class="koboSpan" id="kobo.905.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.906.1">You can retrieve the Swoole server </span><span class="No-Break"><span class="koboSpan" id="kobo.907.1">via </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.908.1">App::make</span></strong></span></li>
<li><span class="koboSpan" id="kobo.909.1">Once you can access the object, you can use their methods, such as, for </span><span class="No-Break"><span class="koboSpan" id="kobo.910.1">example, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.911.1">stats</span></strong></span></li>
<li><span class="koboSpan" id="kobo.912.1">The Swoole server </span><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">Stats</span></strong><span class="koboSpan" id="kobo.914.1"> object is returned as </span><span class="No-Break"><span class="koboSpan" id="kobo.915.1">a response:</span></span></li>
</ul>
<pre class="source-code"><span class="koboSpan" id="kobo.916.1">
use Illuminate\Support\Facades\App;
Route::get('/metrics', function () {
    $server = App::make(Swoole\Http\Server::class);
    return $server-&gt;stats();
});</span></pre>
<p><span class="koboSpan" id="kobo.917.1">On the new </span><strong class="source-inline"><span class="koboSpan" id="kobo.918.1">/metrics</span></strong><span class="koboSpan" id="kobo.919.1"> page, you can </span><a id="_idIndexMarker201"/><span class="koboSpan" id="kobo.920.1">see all the metrics provided by the </span><span class="No-Break"><span class="koboSpan" id="kobo.921.1">Swoole server.</span></span></p>
<p><span class="koboSpan" id="kobo.922.1">For all methods, you can see directly the server documentation provided by </span><span class="No-Break"><span class="koboSpan" id="kobo.923.1">Swoole: </span></span><a href="https://openswoole.com/docs/modules/swoole-server-stats"><span class="No-Break"><span class="koboSpan" id="kobo.924.1">https://openswoole.com/docs/modules/swoole-server-stats</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.925.1">.</span></span></p>
<h1 id="_idParaDest-56"><a id="_idTextAnchor063"/><span class="koboSpan" id="kobo.926.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.927.1">In this chapter, we looked at how to install and configure an environment with Swoole. </span><span class="koboSpan" id="kobo.927.2">Then, we also analyzed the various functionalities exposed by this </span><span class="No-Break"><span class="koboSpan" id="kobo.928.1">application server.</span></span></p>
<p><span class="koboSpan" id="kobo.929.1">We walked through the functionalities with simple examples so that we could focus on the individual features. </span><span class="koboSpan" id="kobo.929.2">In the next chapter, we will look at using Laravel Octane with an application server in a more </span><span class="No-Break"><span class="koboSpan" id="kobo.930.1">real-world context.</span></span></p>
</div>
<div>
<div class="Content" id="_idContainer026">
</div>
</div>


<div class="Content" id="_idContainer027">
<h1 id="_idParaDest-57"><a id="_idTextAnchor064"/><span class="koboSpan" id="kobo.1.1">Part 3: Laravel Octane – a Complete Tour</span></h1>
<p><span class="koboSpan" id="kobo.2.1">The goal of this part is to show practical examples of how to best use the features provided by Laravel Octane and the Swoole application server, especially for optimized data access. </span><span class="koboSpan" id="kobo.2.2">Examples of data query management with caching and parallel queries are shown in </span><span class="No-Break"><span class="koboSpan" id="kobo.3.1">this part.</span></span></p>
<p><span class="koboSpan" id="kobo.4.1">This part comprises the </span><span class="No-Break"><span class="koboSpan" id="kobo.5.1">following chapters:</span></span></p>
<ul>
<li><a href="B17728_04.xhtml#_idTextAnchor065"><em class="italic"><span class="koboSpan" id="kobo.6.1">Chapter 4</span></em></a><span class="koboSpan" id="kobo.7.1">, </span><em class="italic"><span class="koboSpan" id="kobo.8.1">Building a Laravel Octane Application</span></em></li>
<li><a href="B17728_05.xhtml#_idTextAnchor093"><em class="italic"><span class="koboSpan" id="kobo.9.1">Chapter 5</span></em></a><span class="koboSpan" id="kobo.10.1">, </span><em class="italic"><span class="koboSpan" id="kobo.11.1">Reducing Latency and Managing Data with an Asynchronous Approach</span></em></li>
</ul>
</div>
<div>
<div id="_idContainer028">
</div>
</div>
<div>
<div id="_idContainer029">
</div>
</div>
</body></html>