<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Working with Blocks"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Working with Blocks</h1></div></div></div><p>In this chapter we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating a custom block type</li><li class="listitem" style="list-style-type: disc">Using block controller callback functions</li><li class="listitem" style="list-style-type: disc">Sending variables from the controller to the view</li><li class="listitem" style="list-style-type: disc">Adding items to the page header and footer from the block controller</li><li class="listitem" style="list-style-type: disc">Creating custom block templates</li><li class="listitem" style="list-style-type: disc">Including JavaScript in block forms</li><li class="listitem" style="list-style-type: disc">Including JavaScript in the block view</li><li class="listitem" style="list-style-type: disc">Including CSS in the block view</li><li class="listitem" style="list-style-type: disc">Loading a block type by its handle</li><li class="listitem" style="list-style-type: disc">Adding a block to a page</li><li class="listitem" style="list-style-type: disc">Getting the blocks from an area</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec40"/>Introduction</h1></div></div></div><p>Blocks in concrete5 are small, modular <a id="id123" class="indexterm"/>pieces of visual presentation, which can add virtually any type of content to your website. Blocks can contain text content, HTML code, images, videos, an interactive map, or anything else you could think of. When you edit content on your concrete5 website, you are editing an instance of the content block type. Blocks get added to pages in special areas that get specified in theme layouts. concrete5 comes with a wide variety of different block types out of the box, and it is easy to create your own custom block types, enabling you to add unlimited potential to your website.</p><p>In this chapter, we will create a custom block type from scratch. This block type will just display some text that the user can edit through the <span class="strong"><strong>CMS</strong></span> interface, and will serve as a basic "Hello World" example.</p></div></div>
<div class="section" title="Creating a custom block type"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec41"/>Creating a custom block type</h1></div></div></div><p>Creating block types is a great <a id="id124" class="indexterm"/>way to add custom functionality to a website. This is the preferred way to add things like calendars, dealer locators, or any other type of content that is visible and repeatable on the frontend of the website.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec119"/>Getting ready</h2></div></div></div><p>The code for this recipe is available to download from the book's website for free. We are going to create a fully functioning block type that will display content on our website.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec120"/>How to do it...</h2></div></div></div><p>The steps for creating a custom block type are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, you will need to create a directory in your website's root <code class="literal">/blocks</code> directory. The name of the directory should be underscored and will be used to refer to the block throughout the code. In this case, we will create a new directory called <code class="literal">/hello_world</code>.<div class="mediaobject"><img src="graphics/4548OS_02_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Once you have created the <code class="literal">hello_world</code> directory, you will need to create the following files:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">controller.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">db.xml</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">form.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">add.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">edit.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">view.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">view.css</code></li></ul></div></li><li class="listitem">Now, we will add code to each of the files. First, we need to set up the <code class="literal">controller</code> file. The <a id="id125" class="indexterm"/><code class="literal">controller</code> file is what powers the block. Since this is a very basic block, our <a id="id126" class="indexterm"/>controller only will contain information to tell concrete5 some details about our block, such as its name and description.</li><li class="listitem">Add the following code to <code class="literal">controller.php</code>:<div class="informalexample"><pre class="programlisting">class HelloWorldBlockController extends BlockController {
  protected $btTable = "btHelloWorld";
  protected $btInterfaceWidth = "300";
  protected $btInterfaceHeight = "300";
  public function getBlockTypeName() {
    return t('Hello World');
  }
  public function getBlockTypeDescription() {
    return t('A basic Hello World block type!');
  }
}</pre></div></li><li class="listitem">Notice that the class name is <code class="literal">HelloWorldBlockController</code>. concrete5 conventions dictate that you should name your block controllers with the same name as the <code class="literal">block</code> directory in camel case (for example: CamelCase) form, and followed by <code class="literal">BlockController</code>. The <a id="id127" class="indexterm"/><code class="literal">btTable</code> class variable is important, as it tells concrete5 what database table should be used for this block. It is important that this table doesn't already exist in the database, so it's a good idea to give it a name of <code class="literal">bt</code> (short for "block type") plus the camel cased version of the block name.</li><li class="listitem">Now that the controller is set up, we need to set up the <code class="literal">db.xml</code> file. This file is based off of the <a id="id128" class="indexterm"/>ADOXMLS format, which is documented at <a class="ulink" href="http://phplens.com/lens/adodb/docs-datadict.htm#xmlschema">http://phplens.com/lens/adodb/docs-datadict.htm#xmlschema</a>. This XML file will tell concrete5 which database tables and fields should be created for this new block type (and which tables and fields should get updated when your block type gets updated).</li><li class="listitem">Add the following XML code to your <code class="literal">db.xml</code> file:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;schema version="0.3"&gt;
  &lt;table name="btHelloWorld"&gt;
    &lt;field name="bID" type="I"&gt;
      &lt;key /&gt;
      &lt;unsigned /&gt;
    &lt;/field&gt;
      &lt;field name="title" type="C" size="255"&gt;
      &lt;default value="" /&gt;
    &lt;/field&gt;
      &lt;field name="content" type="X2"&gt;
      &lt;default value="" /&gt;
    &lt;/field&gt;
  &lt;/table&gt;
&lt;/schema&gt;</pre></div></li><li class="listitem">concrete5 blocks typically have both an <code class="literal">add.php</code> and <code class="literal">edit.php</code> file, both of which often do the same thing: show the form containing the block's settings. Since we don't want to repeat <a id="id129" class="indexterm"/>code, we will enter our form HTML in a third file, <code class="literal">form.php</code>, and include that file in both <code class="literal">add.php</code> and <code class="literal">edit.php</code>.<div class="informalexample"><pre class="programlisting">&lt;?php 
  $form = Loader::helper('form');
?&gt;
&lt;div&gt;
  &lt;label for="title"&gt;Title&lt;/label&gt;
  &lt;?php echo $form-&gt;text('title', $title); ?&gt;
&lt;/div&gt;
&lt;div&gt;
  &lt;label for="content"&gt;Content&lt;/label&gt;
  &lt;?php echo $form-&gt;textarea('content', $content); ?&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Once that is all set, add this line of code to both <code class="literal">add.php</code> and <code class="literal">edit.php</code> to have this HTML code appear when users add and edit the block:<div class="informalexample"><pre class="programlisting">&lt;?php include('form.php') ?&gt;</pre></div></li><li class="listitem">Add the following HTML to your <code class="literal">view.php</code> file:<div class="informalexample"><pre class="programlisting">&lt;h1&gt;&lt;?php echo $title ?&gt;&lt;/h1&gt;
&lt;div class="content"&gt;
   &lt;?php echo $content ?&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Finally, for a little visual appeal, add the following code to <code class="literal">view.css</code>:<div class="informalexample"><pre class="programlisting">content {
  background: #eee;
  padding: 20px;
  margin: 20px 0;
  border-radius: 10px;
}</pre></div></li><li class="listitem">Now all of the files have been filled with the code to make our Hello World block function. Now we need to install this block in concrete5 so we can add it to our pages.</li><li class="listitem">To install the new block, you <a id="id130" class="indexterm"/>will need to sign into your concrete5 website and navigate to <code class="literal">/dashboard/blocks/types/</code>. If you happen to get a PHP fatal error here, clear your concrete5 cache by visiting <code class="literal">/dashboard/system/optimization/clear_cache</code> (it is always a good idea to disable the cache while developing in concrete5).</li><li class="listitem">At the top of the <span class="strong"><strong>Block Types</strong></span> screen, you should see your <span class="strong"><strong>Hello World</strong></span> block, ready to install. Click on the <span class="strong"><strong>Install</strong></span> button.<div class="mediaobject"><img src="graphics/4548OS_02_03.jpg" alt="How to do it..."/></div></li><li class="listitem">Now the block is installed and ready to add to your site!</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec121"/>How it works...</h2></div></div></div><p>Let's go through the code that we just wrote, step-by-step.</p><p>In <code class="literal">controller.php</code>, there are a few protected variables at the top of the class. The <code class="literal">$btTable</code> variable tells concrete5 <a id="id131" class="indexterm"/>which <a id="id132" class="indexterm"/>table in the database holds the data for this block type. The <code class="literal">$btInterfaceWidth</code> and <code class="literal">$btInterfaceHeight</code> variables <a id="id133" class="indexterm"/>determine the initial size of the dialog window that appears when users add your block to a page on their site.</p><p>We put the block's description and name in special <code class="literal">getter</code> functions for one reason, to potentially support for translations down the road. It's best practice to wrap any strings that appear in concrete5 in the global <a id="id134" class="indexterm"/>
<code class="literal">t()</code> function.</p><p>The <code class="literal">db.xml</code> file tells concrete5 what database tables should be created when this block gets installed. This file uses the ADOXMLS format to generate tables and fields. In this file, we are telling concrete5 to create a table called <code class="literal">btHelloWorld</code>. That table should contain three fields, an <code class="literal">ID</code> field, the <code class="literal">title</code> field, and the <code class="literal">content</code> field. The names of these fields should be noted, because concrete5 will require them to match up with the names of the fields in the HTML form.</p><p>In <code class="literal">form.php</code>, we are setting up the settings form that users will fill out to save the block's content. We are using the Form Helper to generate the HTML for the various fields. Notice how we are able to use <a id="id135" class="indexterm"/>the <a id="id136" class="indexterm"/>
<code class="literal">$title</code> and <code class="literal">$content</code> variables without them being declared yet. concrete5 automatically exposes those variables to the form whenever the block is added or edited. We then include this form in the <code class="literal">add.php</code> and <code class="literal">edit.php</code> files.</p><p>The <code class="literal">view.php</code> file is a template file that contains the HTML that the end users will see on the website. We are just wrapping the title in an <code class="literal">&lt;h1&gt;</code> tag and the content in a <code class="literal">&lt;div&gt;</code> with a class of <code class="literal">.content</code>.</p><p>concrete5 will automatically include <code class="literal">view.css</code> (and <code class="literal">view.js</code>, if it happens to exist) if they are present in your block's directory. <a id="id137" class="indexterm"/>Also, if you include an <code class="literal">auto.js</code> file, it will automatically be included when the block is in edit mode. We added some basic styling to the <code class="literal">.content</code> class and concrete5 takes care of adding this CSS file to your site's <code class="literal">&lt;head&gt;</code> tag.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec122"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Sending variables from the controller to the view</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding items to the page header and footer from the block controller</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Including CSS in the block view</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Including JavaScript in the block view</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Using block controller callback functions"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec42"/>Using block controller callback functions</h1></div></div></div><p>The block controller class <a id="id138" class="indexterm"/>contains a couple of special functions that get automatically called at different points throughout the page load process. You can look into these callbacks to power different functionalities of your block type.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec123"/>Getting ready</h2></div></div></div><p>To get started, you will need a block type created and installed. See the previous recipe for a lesson on creating a custom block type. We will be adding some methods to <code class="literal">controller.php</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec124"/>How to do it...</h2></div></div></div><p>The steps for using block <a id="id139" class="indexterm"/>controller callback functions are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open your block's <code class="literal">controller.php</code> file.</li><li class="listitem">Add a new function called <code class="literal">on_start()</code>:<div class="informalexample"><pre class="programlisting">public function on_start() {
}</pre></div></li><li class="listitem">Write a <code class="literal">die</code> statement that will get fired when the controller is loaded.<div class="informalexample"><pre class="programlisting">die('hello world');</pre></div></li><li class="listitem">Refresh any page containing the block type. The page should stop rendering before it is complete with your debug message.</li><li class="listitem">Be sure to remove the <code class="literal">die</code> statement, otherwise your block won't work anymore!</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec125"/>How it works...</h2></div></div></div><p>concrete5 will call the various callback functions at different points during the page load process. The <code class="literal">on_start()</code> function <a id="id140" class="indexterm"/>is the first to get called. It is a good place to put things that you want to happen before the block is rendered.</p><p>The next function that gets called depends on how you are interacting with the block. If you are just viewing it on a page, the <a id="id141" class="indexterm"/>
<code class="literal">view()</code> function gets called. If you are adding or editing the block, <a id="id142" class="indexterm"/>then the <code class="literal">add()</code> or <code class="literal">edit()</code> functions will get called as appropriate. These functions are a <a id="id143" class="indexterm"/>good place to send variables to the view, which we will show how <a id="id144" class="indexterm"/>to do in the <a id="id145" class="indexterm"/>next recipe. The <code class="literal">save()</code> and <code class="literal">delete()</code> functions also get called automatically at this point, if the block is performing either of those functions.</p><p>After that, concrete5 will call the <a id="id146" class="indexterm"/>
<code class="literal">on_before_render()</code> function. This is a good time to add items to the page header and footer, since it is before concrete5 renders the HTML for the page. We will be doing this later on in the chapter.</p><p>Finally, the <code class="literal">on_page_view()</code> <a id="id147" class="indexterm"/>function is called. This is actually run once the page is being rendered, so it is the last place where you have the code executed in your block controller. This is helpful when adding HTML items to the page.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec126"/>There's more...</h2></div></div></div><p>The following functions can be added to your controller class and they will get called automatically at different points throughout the block's loading process.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">on_start</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">on_before_render</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">view</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">add</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">edit</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">on_page_view</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">save</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">delete</code></li></ul></div><p>For a complete list of the callback <a id="id148" class="indexterm"/>functions available, check out the source for the block controller library, located in <code class="literal">/concrete/core/libraries/block_controller.php</code>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec127"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Sending variables from the controller to the view</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding items to the page header and footer from the block controller</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Sending variables from the controller to the view"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec43"/>Sending variables from the controller to the view</h1></div></div></div><p>A common task in MVC <a id="id149" class="indexterm"/>programming is the concept of setting variables from a controller to a view. In concrete5, blocks follow the <a id="id150" class="indexterm"/>same principles. Fortunately, setting variables to the view is quite easy.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec128"/>Getting ready</h2></div></div></div><p>This recipe will use the block type that was created in the first recipe of this chapter. Feel free to adapt this code to work in any block controller, though.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec129"/>How to do it...</h2></div></div></div><p>In your block's controller, use the <code class="literal">set()</code> function of the <code class="literal">controller</code> class to send a variable and a value to the view. Note that the view doesn't necessarily have to be the <code class="literal">view.php</code> template of your block. You can send variables to <code class="literal">add.php</code> and <code class="literal">edit.php</code> as well. In this recipe, we will send a <a id="id151" class="indexterm"/>variable to <code class="literal">view.php</code>. The steps are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open your block's <code class="literal">controller.php</code> file.</li><li class="listitem">Add a function called <code class="literal">view()</code> if it doesn't already exist:<div class="informalexample"><pre class="programlisting">public function view() {
}</pre></div></li><li class="listitem">Set a variable called <code class="literal">name</code> to the view.<div class="informalexample"><pre class="programlisting">$this-&gt;set('name', 'John Doe');</pre></div></li><li class="listitem">Open <code class="literal">view.php</code> <a id="id152" class="indexterm"/>in your block's directory.</li><li class="listitem">Output the value of the name variable.<div class="informalexample"><pre class="programlisting">&lt;div class="content"&gt;
  &lt;?php echo $name ?&gt;
&lt;/div&gt;</pre></div></li></ol></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec130"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using block controller callback functions</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Adding items to the page header and footer from the block controller"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec44"/>Adding items to the page header and footer from the block controller</h1></div></div></div><p>An important <a id="id153" class="indexterm"/>part of <a id="id154" class="indexterm"/>block development is being able to add JavaScript and CSS files to the page in the appropriate places. Consider a block that is using a jQuery <a id="id155" class="indexterm"/>plugin to <a id="id156" class="indexterm"/>create a slideshow widget. You will need to include the plugin's <a id="id157" class="indexterm"/>JavaScript and <a id="id158" class="indexterm"/>CSS files in order for it to work.</p><p>In this recipe, we will add a CSS <code class="literal">&lt;link&gt;</code> tag to the page's <code class="literal">&lt;head&gt;</code> element, and a JavaScript <code class="literal">&lt;script&gt;</code> tag to bottom of the page (just before the closing <code class="literal">&lt;/body&gt;</code> tag).</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec131"/>Getting ready</h2></div></div></div><p>This recipe will continue working with the block that was created in the first recipe of this chapter. If you need to download a copy of that block, it is included with the code samples from this book's website.</p><p>This recipe also makes a reference to a CSS file and a JavaScript file. Those files are available for download in the code on this book's website as well.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec132"/>How to do it...</h2></div></div></div><p>The steps for adding <a id="id159" class="indexterm"/>items to the <a id="id160" class="indexterm"/>page header and footer from the block controller are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open your block's <code class="literal">controller.php</code> file.</li><li class="listitem">Create a CSS file in <code class="literal">/css</code> called <code class="literal">test.css</code>.</li><li class="listitem">Set a rule to change the background color of the site to black.<div class="informalexample"><pre class="programlisting">body {
  background: #000 !important;
}</pre></div></li><li class="listitem">Create a JavaScript <a id="id161" class="indexterm"/>file in <code class="literal">/js</code> called <code class="literal">test.js</code>.</li><li class="listitem">Create an alert <a id="id162" class="indexterm"/>message in the JavaScript file.<div class="informalexample"><pre class="programlisting">alert('Hello!');</pre></div></li><li class="listitem">In <code class="literal">controller.php</code>, <a id="id163" class="indexterm"/>create a new function called <code class="literal">on_page_view()</code>.<div class="informalexample"><pre class="programlisting">public function on_page_view() {
}</pre></div></li><li class="listitem">Load the HTML helper:<div class="informalexample"><pre class="programlisting">$html = Loader::helper('html');</pre></div></li><li class="listitem">Add a CSS file to the <a id="id164" class="indexterm"/>page header:<div class="informalexample"><pre class="programlisting">$this-&gt;addHeaderItem($html-&gt;css('testing.css'));</pre></div></li><li class="listitem">Add a JavaScript file to the page footer:<div class="informalexample"><pre class="programlisting">$this-&gt;addFooterItem($html-&gt;javascript('test.js'));</pre></div></li><li class="listitem">Visit a page on your site that contains this block. You should see your JavaScript alert as well as a black background.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec133"/>How it works...</h2></div></div></div><p>As mentioned in the <span class="emphasis"><em>Using block controller callback function</em></span> recipe, the ideal place to add items to the header (the page's <code class="literal">&lt;head&gt;</code> tag) and footer (just before the closing <code class="literal">&lt;/body&gt;</code> tag) is the <code class="literal">on_before_render()</code> <a id="id165" class="indexterm"/>callback function. The <code class="literal">addHeaderItem</code> and <code class="literal">addFooterItem</code> functions are used to <a id="id166" class="indexterm"/>place strings of text in those positions of the web document. Rather than type out <code class="literal">&lt;script&gt;</code> and <code class="literal">&lt;link&gt;</code> tags in our PHP, we will use the built-in HTML helper to generate those <a id="id167" class="indexterm"/>strings. The files <a id="id168" class="indexterm"/>should be located in the site's root <code class="literal">/css</code> and <code class="literal">/js</code> directories.</p><p>Since it is typically best <a id="id169" class="indexterm"/>practice for CSS files to get loaded first and for JavaScript files to get loaded last, we place each <a id="id170" class="indexterm"/>of those <a id="id171" class="indexterm"/>items in the areas of the page that make the most sense.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec134"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="link" href="ch04.html" title="Chapter 4. Using the Core Helpers">Chapter 4</a>, <span class="emphasis"><em>Using the Core Helpers</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using block controller callback functions</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Creating custom block templates"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec45"/>Creating custom block templates</h1></div></div></div><p>All blocks come with a default view template, <code class="literal">view.php</code>. concrete5 also supports alternative templates, which <a id="id172" class="indexterm"/>users can enable through the concrete5 interface. You can also enable these alternative templates through your custom PHP code.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec135"/>Getting ready</h2></div></div></div><p>You will need a block type created and installed already. In this recipe, we are going to add a template to the block type that we created at the beginning of the chapter.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec136"/>How to do it...</h2></div></div></div><p>The steps for creating custom block templates are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open your block's directory.</li><li class="listitem">Create a new directory in your block's directory called <code class="literal">templates/</code>.</li><li class="listitem">Create a file called <code class="literal">no_title.php</code> in <code class="literal">templates/</code>.</li><li class="listitem">Add the following HTML code to <code class="literal">no_title.php</code>:<div class="informalexample"><pre class="programlisting">&lt;div class="content"&gt;
  &lt;?php echo $content ?&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Activate the template by visiting a page that contains this block.</li><li class="listitem">Enter edit mode on the page and click on the block.<div class="informalexample"><pre class="programlisting">Click on "Custom Template".</pre></div><div class="mediaobject"><img src="graphics/4548OS_02_04.jpg" alt="How to do it..."/></div></li><li class="listitem">Choose "No Title" and save your changes.</li></ol></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec137"/>There's more...</h2></div></div></div><p>You can specify alternative templates right from the block controller, so you can automatically render a different template depending on certain settings, conditions, or just about anything you can think of. <a id="id173" class="indexterm"/>Simply use the <code class="literal">render()</code> <a id="id174" class="indexterm"/>function in a callback that gets called before the view is rendered.</p><div class="informalexample"><pre class="programlisting">public function view() {
  $this-&gt;render('templates/no_title');
}</pre></div><p>This will use the <code class="literal">no_title.php</code> file instead of <code class="literal">view.php</code> to render the block. Notice that adding the <code class="literal">.php</code> file extension is not required. Just like the block's regular <code class="literal">view.php</code> file, developers can include <code class="literal">view.css</code> and <code class="literal">view.js</code> files in their template directories to have those files automatically included on the page.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec138"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using block controller callback functions</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a custom block type</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Including JavaScript in block forms"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec46"/>Including JavaScript in block forms</h1></div></div></div><p>When adding or editing blocks, it is <a id="id175" class="indexterm"/>often desired to include more advanced functionality in the form of client-side JavaScript. concrete5 makes it extremely easy to <a id="id176" class="indexterm"/>automatically add a JavaScript file to a block's editor form.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec139"/>Getting ready</h2></div></div></div><p>We will be working with the block that was created in the first recipe of this chapter. If you need to catch up, feel free to download the code from this book's website.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec140"/>How to do it...</h2></div></div></div><p>The steps for including JavaScript in block forms are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open your block's directory.</li><li class="listitem">Create a new file called <code class="literal">auto.js</code>.</li><li class="listitem">Add a basic alert function to <code class="literal">auto.js</code>:<div class="informalexample"><pre class="programlisting">alert('Hello!');</pre></div></li><li class="listitem">Visit a page that contains your block.</li><li class="listitem">Enter edit mode and edit the block.</li><li class="listitem">You should see your alert message appear as shown in the following screenshot:<div class="mediaobject"><img src="graphics/4548OS_02_06.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec141"/>How it works...</h2></div></div></div><p>concrete5 automatically looks for the <code class="literal">auto.js</code> file when it enters add or edit mode on a block. Developers can use this to <a id="id177" class="indexterm"/>their <a id="id178" class="indexterm"/>advantage to contain special client-side functionality for the block's edit mode.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec142"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Including JavaScript in the block view</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Including CSS in the block view</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Including JavaScript in the block view"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec47"/>Including JavaScript in the block view</h1></div></div></div><p>In addition to being able to <a id="id179" class="indexterm"/>include JavaScript in the block's add and edit forms, developers can also automatically include a JavaScript file when the block is viewed <a id="id180" class="indexterm"/>on the frontend. In this recipe, we will create a simple JavaScript file that will create an alert whenever the block is viewed.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec143"/>Getting ready</h2></div></div></div><p>We will continue working with the block that was created in the first recipe of this chapter.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec144"/>How to do it...</h2></div></div></div><p>The steps for including JavaScript in the block view are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open your block's directory.</li><li class="listitem">Create a new file called <code class="literal">view.js</code>.</li><li class="listitem">Add an alert to <code class="literal">view.js</code>:<div class="informalexample"><pre class="programlisting">alert('This is the view!');</pre></div></li><li class="listitem">Visit the page containing your block.</li><li class="listitem">You should see the new alert appear.<div class="mediaobject"><img src="graphics/4548OS_02_07.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec145"/>How it works...</h2></div></div></div><p>Much like the <code class="literal">auto.js</code> file discussed in the previous recipe, concrete5 will automatically include the <code class="literal">view.js</code> file if it exists. <a id="id181" class="indexterm"/>This allows developers to easily embed jQuery plugins or other client-side logic <a id="id182" class="indexterm"/>into their blocks very easily.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec146"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Including JavaScript in block forms</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Including CSS in the block view</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Including CSS in the block view"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec48"/>Including CSS in the block view</h1></div></div></div><p>Developers and designers <a id="id183" class="indexterm"/>working on custom concrete5 block types can have a CSS file automatically included. In this recipe, we will automatically include a CSS file <a id="id184" class="indexterm"/>that will change our background to black.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec147"/>Getting ready</h2></div></div></div><p>We are still working with the block that was created earlier in the chapter. Please make sure that block exists, or adapt this recipe to suit your own concrete5 environment.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec148"/>How to do it...</h2></div></div></div><p>The steps for including CSS in the block view are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open your block's directory.</li><li class="listitem">Create a new file called <code class="literal">view.css</code>, if it doesn't exist.</li><li class="listitem">Add a rule to change the background color of the site to black:<div class="informalexample"><pre class="programlisting">body {
  background: #000 !important;
}</pre></div></li><li class="listitem">Visit the page containing your block.</li><li class="listitem">The background should now be black!</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec149"/>How it works...</h2></div></div></div><p>Just like it does with JavaScript, <a id="id185" class="indexterm"/>concrete5 will automatically include <code class="literal">view.css</code> in the <a id="id186" class="indexterm"/>page's header if it exists in your block directory. This is a great way to save some time with styles that only apply to your block.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec150"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Including JavaScript in block forms</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Including JavaScript in the block view</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Loading a block type by its handle"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec49"/>Loading a block type by its handle</h1></div></div></div><p>Block types are objects in <a id="id187" class="indexterm"/>concrete5 just like most things. This means that they have IDs in the database, as well as human-readable handles. In this recipe, we will load the instance of the block type that we created in the first recipe of this chapter.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec151"/>Getting ready</h2></div></div></div><p>We will need a place to run some <a id="id188" class="indexterm"/>arbitrary code. We will rely on <code class="literal">/config/site_post.php</code> once again to execute some random code. This recipe also assumes that a block with a handle of <code class="literal">hello_world</code> exists in your concrete5 site. Feel free to adjust that handle as needed.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec152"/>How to do it...</h2></div></div></div><p>The steps for loading a block type by its handle are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/config/site_post.php</code> in your preferred code editor.</li><li class="listitem">Define the handle of the block to load:<div class="informalexample"><pre class="programlisting">$handle = 'hello_world';</pre></div></li><li class="listitem">Load the block by its handle:<div class="informalexample"><pre class="programlisting">$block = BlockType::getByHandle($handle);</pre></div></li><li class="listitem">Dump the contents of the block to make sure it loaded correctly:<div class="informalexample"><pre class="programlisting">print_r($block);
exit;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec153"/>How it works...</h2></div></div></div><p>concrete5 will simply query the database <a id="id189" class="indexterm"/>for you when a handle is provided. It will then return a <code class="literal">BlockType</code> object that contains <a id="id190" class="indexterm"/>several methods and properties that can be useful in development.</p></div></div>
<div class="section" title="Adding a block to a page"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec50"/>Adding a block to a page</h1></div></div></div><p>Users can use the intuitive <a id="id191" class="indexterm"/>concrete5 interface to add blocks to the various areas of pages <a id="id192" class="indexterm"/>on the website. You can also programmatically add blocks to pages using the concrete5 API.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec154"/>Getting ready</h2></div></div></div><p>The code in this chapter can be run anywhere that you would like to create a block. To keep things simple, we are going to use the <code class="literal">/config/site_post.php</code> file to run some arbitrary code.</p><p>This example assumes that a page with a path of <code class="literal">/about</code> exists on your concrete5 site. Feel free to create that page, or adapt this recipe to suit your needs. Also, this recipe assumes that <code class="literal">/about</code> has a content area called <code class="literal">content</code>. Again, adapt according to your own website's configuration.</p><p>We will be using the block that was created at the beginning of this chapter.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec155"/>How to do it...</h2></div></div></div><p>The steps for adding a block to a page are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/config/site_post.php</code> in your code editor.</li><li class="listitem">Load the page that you would like to add a block to:<div class="informalexample"><pre class="programlisting">$page = Page::getByPath('/about');</pre></div></li><li class="listitem">Load the block by its handle:<div class="informalexample"><pre class="programlisting">$block = BlockType::getByHandle('hello_world');</pre></div></li><li class="listitem">Define the data that will be sent to the block:<div class="informalexample"><pre class="programlisting">$data = array(
  'title' =&gt; 'An Exciting Title',
  'content' =&gt; 'This is the content!'
);</pre></div></li><li class="listitem">Add the block to the page's content area:<div class="informalexample"><pre class="programlisting"> $page-&gt;addBlock($block, 'content', $data);</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec156"/>How it works...</h2></div></div></div><p>First you need to get the target page. In this recipe, we get it by its path, but you can use this function on any <code class="literal">Page</code> object. Next, we need to load the block type that we are adding. In this case, we are using the one that <a id="id193" class="indexterm"/>was created earlier in the chapter. The block type handle is the same as the directory name for the block.</p><p>We are using the <code class="literal">$data</code> variable to pass <a id="id194" class="indexterm"/>in the block's configuration options. If there are no options, you will need to pass in an empty array, as concrete5 does not allow that parameter to be blank. Finally, you will need to know the name of the content area; in this case, the content area is called "content".</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec157"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a custom block type</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Loading a block type by its handle</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Getting a page by its path</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Pages and Page Types">Chapter 1</a>, <span class="emphasis"><em>Pages and Page Types</em></span></li></ul></div></div></div>
<div class="section" title="Getting the blocks from an area"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec51"/>Getting the blocks from an area</h1></div></div></div><p>concrete5 pages can have several different areas where blocks can be added. Developers can programmatically get an <a id="id195" class="indexterm"/>array of all of the block objects in an area. In this recipe, we <a id="id196" class="indexterm"/>will load a page and get a list of all of the blocks in its main content area.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec158"/>Getting ready</h2></div></div></div><p>We will be using <code class="literal">/config/site_post.php</code> to run some arbitrary code here. You can place this code wherever you find appropriate, though.</p><p>This example assumes the presence of a page with a path of <code class="literal">/about</code>, and with a content area called <code class="literal">content</code>. Make the necessary adjustments in the code as needed.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec159"/>How to do it...</h2></div></div></div><p>The steps for getting the blocks from an area are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/config/site_post.php</code> in your code editor.</li><li class="listitem">Load the page by its path:<div class="informalexample"><pre class="programlisting">$page = Page::getByPath('/about');</pre></div></li><li class="listitem">Get the array of blocks in the page's content area.<div class="informalexample"><pre class="programlisting">$blocks = $page-&gt;getBlocks('content');</pre></div></li><li class="listitem">Loop through the array, printing each block's handle.<div class="informalexample"><pre class="programlisting">foreach ($blocks as $block) {
  echo $block-&gt;getBlockTypeHandle().'&lt;br /&gt;';
}</pre></div></li><li class="listitem">Exit the process.<div class="informalexample"><pre class="programlisting">exit;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec160"/>How it works...</h2></div></div></div><p>concrete5 will return an array of block <a id="id197" class="indexterm"/>objects for every block that is contained within a <a id="id198" class="indexterm"/>content area. Developers can then loop through this array to manipulate or read the block objects.</p></div></div></body></html>