<html><head></head><body><div class="chapter" id="2I0GC1-ae331331bc644dc9b658d3634f0748da" title="Chapter&#xA0;8.&#xA0;Extending Yii"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Extending Yii</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Creating helpers</li><li class="listitem">Creating model behaviors</li><li class="listitem">Creating components</li><li class="listitem">Creating reusable controller actions</li><li class="listitem">Creating reusable controllers</li><li class="listitem">Creating a widget</li><li class="listitem">Creating CLI commands</li><li class="listitem">Creating filters</li><li class="listitem">Creating modules</li><li class="listitem">Creating a custom view renderer</li><li class="listitem">Creating a multilanguage application</li><li class="listitem">Making extensions distribution-ready</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec80"/>Introduction</h1></div></div></div><p>In this chapter, we will show you not only how to implement your own Yii extension, but also how to make your extension reusable and useful for the community. In addition, we will focus on many things you should do in order to make your extension as efficient as possible.</p></div></div>
<div class="section" id="2IV0U1-ae331331bc644dc9b658d3634f0748da" title="Creating helpers"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec81"/>Creating helpers</h1></div></div></div><p>There are a lot of <a class="indexterm" id="id550"/>built-in framework helpers such as <code class="literal">StringHelper</code> in the <code class="literal">yii\helpers</code> namespace. These contain sets of helpful static methods for manipulating strings, files, arrays, and other subjects.</p><p>In many cases, for additional behavior you can create a own helper and put any static function into one. For example, we implement the number helper in this recipe.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec282"/>Getting ready</h2></div></div></div><p>Create a <a class="indexterm" id="id551"/>new <code class="literal">yii2-app-basic</code> application using the composer package manager as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec283"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">helpers</code> directory in <a class="indexterm" id="id552"/>your project and write the <code class="literal">NumberHelper</code> class:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\helpers;

class NumberHelper
{
    public static function format($value, $decimal = 2)
    {
        return number_format($value, $decimal, '.', ',');
    }
}</pre></div></li><li class="listitem">Add the <code class="literal">actionNumbers</code> method to <code class="literal">SiteController</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
...
class SiteController extends Controller
{
    …

    public function actionNumbers()
    {
        return $this-&gt;render('numbers', ['value' =&gt; 18878334526.3]);
    }
}</pre></div></li><li class="listitem">Add the <code class="literal">views/site/numbers.php</code> view:<div class="informalexample"><pre class="programlisting">&lt;?php
use app\helpers\NumberHelper;
use yii\helpers\Html;

/* @var $this yii\web\View */
/* @var $value float */

$this-&gt;title = 'Numbers';
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;
?&gt;
&lt;div class="site-numbers"&gt;
    &lt;h1&gt;&lt;?= Html::encode($this-&gt;title) ?&gt;&lt;/h1&gt;

    &lt;p&gt;
        Raw number:&lt;br /&gt;
        &lt;b&gt;&lt;?= $value ?&gt;&lt;/b&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Formatted number:&lt;br /&gt;
        &lt;b&gt;&lt;?= NumberHelper::format($value) ?&gt;&lt;/b&gt;
    &lt;/p&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Open the action. You <a class="indexterm" id="id553"/>should see the following result:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00443.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>In other cases, you can specify another count of decimal numbers. Observe the following example:</p><div class="informalexample"><pre class="programlisting">NumberHelper::format($value, 3)</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec284"/>How it works…</h2></div></div></div><p>Any helper in Yii2 is just a set of functions, implemented as static methods in the corresponding classes.</p><p>You can use a helper for <a class="indexterm" id="id554"/>implementing any different formats of output, for manipulations with values of any variables, and for other cases.</p><div class="note" title="Note"><h3 class="title"><a id="note13"/>Note</h3><p>Usually, static helpers are lightweight clean functions with a small count of arguments. Avoid putting your business logic and other complicated manipulations into helpers. Use widgets or other components instead of helpers in other cases.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec285"/>See also</h2></div></div></div><p>For more information <a class="indexterm" id="id555"/>about helpers, refer to:</p><p>
<a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-helper-overview.html">http://www.yiiframework.com/doc-2.0/guide-helper-overview.html</a>.</p><p>For examples of <a class="indexterm" id="id556"/>built-in helpers, refer to sources in the <code class="literal">helpers</code> directory of framework. For the framework, refer to:</p><p>
<a class="ulink" href="https://github.com/yiisoft/yii2/tree/master/framework/helpers">https://github.com/yiisoft/yii2/tree/master/framework/helpers</a>.</p></div></div>
<div class="section" title="Creating model behaviors"><div class="titlepage" id="2JTHG2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch08lvl1sec82"/>Creating model behaviors</h1></div></div></div><p>There are many similar solutions in today's web applications. Leading products such as Google's Gmail are<a class="indexterm" id="id557"/> defining nice UI patterns. One of these is soft delete. Instead of a permanent deletion with tons of confirmations, Gmail allows us to immediately mark messages as deleted and then easily undo it. The same behavior can be applied to any object such as blog posts, comments, and so on.</p><p>Let's create a behavior that will allow marking models as deleted, restoring models, selecting not yet deleted models, deleted models, and all models. In this recipe, we'll follow a test-driven development approach to plan the behavior and test if the implementation is correct.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec286"/>Getting ready</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new <code class="literal">yii2-app-basic</code> application using the composer as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</li><li class="listitem">Create two databases for working and for tests.</li><li class="listitem">Configure Yii to use the first database in your primary application in <code class="literal">config/db.php</code>. Make sure the test application uses the second database in <code class="literal">tests/codeception/config/config.php</code>.</li><li class="listitem">Create a new migration:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\db\Migration;

class m160427_103115_create_post_table extends Migration
{
    public function up()
    {
        $this-&gt;createTable('{{%post}}', [
            'id' =&gt; $this-&gt;primaryKey(),
            'title' =&gt; $this-&gt;string()-&gt;notNull(),
            'content_markdown' =&gt; $this-&gt;text(),
            'content_html' =&gt; $this-&gt;text(),
        ]);
    }

    public function down()
    {
        $this-&gt;dropTable('{{%post}}');
    }
}</pre></div></li><li class="listitem">Apply the migration <a class="indexterm" id="id558"/>to both the working and test databases:<div class="informalexample"><pre class="programlisting">./yii migrate
tests/codeception/bin/yii migrate</pre></div></li><li class="listitem">Create the <code class="literal">Post</code> model:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\models;

use app\behaviors\MarkdownBehavior;
use yii\db\ActiveRecord;

/**
 * @property integer $id
 * @property string $title
 * @property string $content_markdown
 * @property string $content_html
 */
class Post extends ActiveRecord
{
    public static function tableName()
    {
        return '{{%post}}';
    }

    public function rules()
    {
        return [
            [['title'], 'required'],
            [['content_markdown'], 'string'],
            [['title'], 'string', 'max' =&gt; 255],
        ];
    }
}</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec287"/>How to do it…</h2></div></div></div><p>Let's prepare a test <a class="indexterm" id="id559"/>environment first starting with defining fixtures for the <code class="literal">Post</code> model. Create the <code class="literal">tests/codeception/unit/fixtures/PostFixture.php</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\tests\codeception\unit\fixtures;

use yii\test\ActiveFixture;

class PostFixture extends ActiveFixture
{
    public $modelClass = 'app\models\Post';
    public $dataFile = '@tests/codeception/unit/fixtures/data/post.php';
}</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add a fixture data file to <code class="literal">tests/codeception/unit/fixtures/data/post.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
return [
    [
        'id' =&gt; 1,
        'title' =&gt; 'Post 1',
        'content_markdown' =&gt; 'Stored *markdown* text 1',
        'content_html' =&gt; "&lt;p&gt;Stored &lt;em&gt;markdown&lt;/em&gt; text 1&lt;/p&gt;\n",
    ],
];</pre></div></li><li class="listitem">Then, we need to create a test case, <code class="literal">tests/codeception/unit/MarkdownBehaviorTest.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\tests\codeception\unit;

use app\models\Post;
use app\tests\codeception\unit\fixtures\PostFixture;
use yii\codeception\DbTestCase;

class MarkdownBehaviorTest extends DbTestCase
{
    public function testNewModelSave()
    {
        $post = new Post();
        $post-&gt;title = 'Title';
        $post-&gt;content_markdown = 'New *markdown* text';

        $this-&gt;assertTrue($post-&gt;save());
        $this-&gt;assertEquals("&lt;p&gt;New &lt;em&gt;markdown&lt;/em&gt; text&lt;/p&gt;\n", $post-&gt;content_html);
    }

    public function testExistingModelSave()
    {
        $post = Post::findOne(1);

        $post-&gt;content_markdown = 'Other *markdown* text';
        $this-&gt;assertTrue($post-&gt;save());

        $this-&gt;assertEquals("&lt;p&gt;Other &lt;em&gt;markdown&lt;/em&gt; text&lt;/p&gt;\n", $post-&gt;content_html);
    }

    public function fixtures()
    {
        return [
            'posts' =&gt; [
                'class' =&gt; PostFixture::className(),
            ]
        ];
    }
}</pre></div></li><li class="listitem">Run the unit <a class="indexterm" id="id560"/>tests:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>codecept run unit MarkdownBehaviorTest</strong></span>
<span class="strong"><strong>Ensure that tests has not passed:</strong></span>
<span class="strong"><strong>Codeception PHP Testing Framework v2.0.9</strong></span>
<span class="strong"><strong>Powered by PHPUnit 4.8.27 by Sebastian Bergmann and contributors.</strong></span>

<span class="strong"><strong>Unit Tests (2) ---------------------------------------------------------------------------</strong></span>
<span class="strong"><strong>Trying to test ... MarkdownBehaviorTest::testNewModelSave             Error</strong></span>
<span class="strong"><strong>Trying to test ... MarkdownBehaviorTest::testExistingModelSave        Error</strong></span>
<span class="strong"><strong>---------------------------------------------------------------------------</strong></span>

<span class="strong"><strong>Time: 289 ms, Memory: 16.75MB</strong></span>
</pre></div></li><li class="listitem">Now we need <a class="indexterm" id="id561"/>to implement behavior, attach it to the model, and make sure the test passes. Create a new directory, <code class="literal">behaviors</code>. Under this directory, create a <code class="literal">MarkdownBehavior</code> class:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\behaviors;

use yii\base\Behavior;
use yii\base\Event;
use yii\base\InvalidConfigException;
use yii\db\ActiveRecord;
use yii\helpers\Markdown;

class MarkdownBehavior extends Behavior
{
    public $sourceAttribute;
    public $targetAttribute;

    public function init()
    {
        if (empty($this-&gt;sourceAttribute) || empty($this-&gt;targetAttribute)) {
            throw new InvalidConfigException('Source and target must be set.');
        }
        parent::init();
    }

    public function events()
    {
        return [
            ActiveRecord::EVENT_BEFORE_INSERT =&gt; 'onBeforeSave',
            ActiveRecord::EVENT_BEFORE_UPDATE =&gt; 'onBeforeSave',
        ];
    }

    public function onBeforeSave(Event $event)
    {
        if ($this-&gt;owner-&gt;isAttributeChanged($this-&gt;sourceAttribute)) {
            $this-&gt;processContent();
        }
    }

    private function processContent()
    {
        $model = $this-&gt;owner;
        $source = $model-&gt;{$this-&gt;sourceAttribute};
        $model-&gt;{$this-&gt;targetAttribute} = Markdown::process($source);
    }
}</pre></div></li><li class="listitem">Let's attach the <a class="indexterm" id="id562"/>behavior to the Post model:<div class="informalexample"><pre class="programlisting">class Post extends ActiveRecord
{
    ...

    public function behaviors()
    {
        return [
            'markdown' =&gt; [
                'class' =&gt; MarkdownBehavior::className(),
                'sourceAttribute' =&gt; 'content_markdown',
                'targetAttribute' =&gt; 'content_html',
            ],
        ];
    }
}</pre></div></li><li class="listitem">Run the test and make sure it passes:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Codeception PHP Testing Framework v2.0.9</strong></span>
<span class="strong"><strong>Powered by PHPUnit 4.8.27 by Sebastian Bergmann and contributors.</strong></span>

<span class="strong"><strong>Unit Tests (2) ---------------------------------------------------------------------------</strong></span>
<span class="strong"><strong>Trying to test ... MarkdownBehaviorTest::testNewModelSave             Ok</strong></span>
<span class="strong"><strong>Trying to test ... MarkdownBehaviorTest::testExistingModelSave        Ok</strong></span>
<span class="strong"><strong>---------------------------------------------------------------------------</strong></span>

<span class="strong"><strong>Time: 329 ms, Memory: 17.00MB</strong></span>
</pre></div></li><li class="listitem">That's it. We've created a reusable behavior and can use it for all future projects by just connecting it to a model.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec288"/>How it works…</h2></div></div></div><p>Let's start with the test <a class="indexterm" id="id563"/>case. Since we want to use a set of models, we are defining fixtures. A fixture set is put into the "database" each time the test method is executed.</p><p>We prepare unit tests for specifying how the behavior must work:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">First, we are testing a processing of a new model content. The behavior must convert the Markdown text from the source attribute to HTML and store the second one to the target attribute.</li><li class="listitem">Second, we are testing to update the content of the existing model. After changing the Markdown content and saving the model, we must get the updated HTML content.</li></ul></div><p>Now let's move to the interesting implementation details. In behavior, we can add our own methods, which will be mixed into the model that the behavior is attached to. Also, we can subscribe to the owner component events. We are using it to add an own listener:</p><div class="informalexample"><pre class="programlisting">public function events()
{
    return [
        ActiveRecord::EVENT_BEFORE_INSERT =&gt; 'onBeforeSave',
        ActiveRecord::EVENT_BEFORE_UPDATE =&gt; 'onBeforeSave',
    ];
}</pre></div><p>Now we can implement this listener:</p><div class="informalexample"><pre class="programlisting">public function onBeforeSave(Event $event)
{
    if ($this-&gt;owner-&gt;isAttributeChanged($this-&gt;sourceAttribute))
    {
        $this-&gt;processContent();
    }
}</pre></div><p>In all the methods, we can use the <code class="literal">owner</code> property to get the object the behavior is attached to. In general, we can attach any behavior to our models, controllers, applications, and other components that <a class="indexterm" id="id564"/>extend the <code class="literal">yii\base\Component</code> class. Also, we can attach one behavior repeatedly to the model for processing different attributes:</p><div class="informalexample"><pre class="programlisting">class Post extends ActiveRecord
{
    ...

    public function behaviors()
    {
        return [
            [
                'class' =&gt; MarkdownBehavior::className(),
                'sourceAttribute' =&gt; 'description_markdown',
                'targetAttribute' =&gt; 'description_html',
            ],
            [
                'class' =&gt; MarkdownBehavior::className(),
                'sourceAttribute' =&gt; 'content_markdown',
                'targetAttribute' =&gt; 'content_html',
            ],
        ];
    }
}</pre></div><p>Besides, we can extend the <code class="literal">yii\base\AttributeBehavior</code> class like <code class="literal">yii\behaviors\TimestampBehavior</code> for updating specified attributes for any events.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec289"/>See also</h2></div></div></div><p>To learn more about <a class="indexterm" id="id565"/>behaviors and <a class="indexterm" id="id566"/>events, refer to the following pages:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-concept-behaviors.html">http://www.yiiframework.com/doc-2.0/guide-concept-behaviors.html</a></li><li class="listitem"><a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-concept-events.html">http://www.yiiframework.com/doc-2.0/guide-concept-events.html</a></li></ul></div><p>For more information <a class="indexterm" id="id567"/>about the Markdown syntax, refer to <a class="ulink" href="http://daringfireball.net/projects/markdown/">http://daringfireball.net/projects/markdown/</a>.</p><p>Also, refer to the <span class="emphasis"><em>Making extensions distribution-ready</em></span> recipe of this chapter.</p></div></div>
<div class="section" title="Creating components"><div class="titlepage" id="2KS222-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch08lvl1sec83"/>Creating components</h1></div></div></div><p>If you have some code that <a class="indexterm" id="id568"/>looks like it can be reused but you don't know if it's a behavior, widget, or something else, most probably it's a component. A component should be inherited from the <code class="literal">yii\base\Component</code> class. Later on, the component can be attached to the application and configured using the <code class="literal">components</code> section of the configuration file. That's the main advantage compared with using just a plain PHP class. Additionally, we are getting behavior, event, getter, and setter support.</p><p>For our example, we'll implement a simple Exchange application component that will be able to get currency <a class="indexterm" id="id569"/>rates from the <a class="ulink" href="http://fixer.io">http://fixer.io</a> site, attach it to the application, and use it.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec290"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application using the composer, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec291"/>How to do it…</h2></div></div></div><p>For getting the currency rates, our component should send a HTTP GET query to a service URL such as <a class="ulink" href="http://api.fixer.io/2016-05-14?base=USD">http://api.fixer.io/2016-05-14?base=USD</a>.</p><p>The service must return all supported rates on the nearest working day:</p><div class="informalexample"><pre class="programlisting">{
    "base":"USD",
    "date":"2016-05-13",
    "rates": {
        "AUD":1.3728,
        "BGN":1.7235,
        ...
        "ZAR":15.168,
        "EUR":0.88121
    }
}</pre></div><p>The component should extract needle currency from the response in JSON format and return a target rate:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">components</code> directory in your application structure.</li><li class="listitem">Create the component class <a class="indexterm" id="id570"/>example with the following interface:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\components;

use yii\base\Component;

class Exchange extends Component
{
    public function getRate($source, $destination, $date = null)
    {

    }
}</pre></div></li><li class="listitem">Implement the <code class="literal">component</code> functional:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\components;

use yii\base\Component;
use yii\base\InvalidConfigException;
use yii\base\InvalidParamException;
use yii\caching\Cache;
use yii\di\Instance;
use yii\helpers\Json;

class Exchange extends Component
{
    /**
    * @var string remote host
    */
    public $host = 'http://api.fixer.io';
    /**
    * @var bool cache results or not
    */
    public $enableCaching = false;
    /**
    * @var string|Cache component ID
    */
    public $cache = 'cache';

    public function init()
    {
        if (empty($this-&gt;host)) {
            throw new InvalidConfigException('Host must be set.');
        }
        if ($this-&gt;enableCaching) {
            $this-&gt;cache = Instance::ensure($this-&gt;cache, Cache::className());
        }
        parent::init();
    }

    public function getRate($source, $destination, $date = null)
    {
        $this-&gt;validateCurrency($source);
        $this-&gt;validateCurrency($destination);
        $date = $this-&gt;validateDate($date);
        $cacheKey = $this-&gt;generateCacheKey($source, $destination, $date);
        if (!$this-&gt;enableCaching || ($result = $this-&gt;cache-&gt;get($cacheKey)) === false) {
            $result = $this-&gt;getRemoteRate($source, $destination, $date);
            if ($this-&gt;enableCaching) {
                $this-&gt;cache-&gt;set($cacheKey, $result);
            }
        }
        return $result;
    }

    private function getRemoteRate($source, $destination, $date)
    {
        $url = $this-&gt;host . '/' . $date . '?base=' . $source;
        $response = Json::decode(file_get_contents($url));
        if (!isset($response['rates'][$destination])) {
            throw new \RuntimeException('Rate not found.');
        }
        return $response['rates'][$destination];
    }

    private function validateCurrency($source)
    {
        if (!preg_match('#^[A-Z]{3}$#s', $source)) {
            throw new InvalidParamException('Invalid currency format.');
        }
    }

    private function validateDate($date)
    {
        if (!empty($date) &amp;&amp; !preg_match('#\d{4}\-\d{2}-\d{2}#s', $date)) {
            throw new InvalidParamException('Invalid date format.');
        }
        if (empty($date)) {
            $date = date('Y-m-d');
        }
        return $date;
    }

    private function generateCacheKey($source, $destination, $date)
    {
        return [__CLASS__, $source, $destination, $date];
    }
}</pre></div></li><li class="listitem">Attach the <a class="indexterm" id="id571"/>component to your <code class="literal">config/console.php</code> or <code class="literal">config/web.php</code> configuration files:<div class="informalexample"><pre class="programlisting">'components' =&gt; [
    'cache' =&gt; [
        'class' =&gt; 'yii\caching\FileCache',
    ],
    'exchange' =&gt; [
        'class' =&gt; 'app\components\Exchange',
        'enableCaching' =&gt; true,
    ],
    // ...
    db' =&gt; $db,
],</pre></div></li><li class="listitem">Right now, we can use a new component directly or via the <code class="literal">get</code> method:<div class="informalexample"><pre class="programlisting">echo \Yii::$app-&gt;exchange-&gt;getRate('USD', 'EUR');
echo \Yii::$app-&gt;get('exchange')-&gt;getRate('USD', 'EUR', '2014-04-12');</pre></div></li><li class="listitem">Create a demonstration console controller:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\commands;

use yii\console\Controller;

class ExchangeController extends Controller
{
    public function actionTest($currency, $date = null)
    {
        echo \Yii::$app-&gt;exchange-&gt;getRate('USD', $currency, $date) . PHP_EOL;
    }
}</pre></div></li><li class="listitem">Now try to <a class="indexterm" id="id572"/>run any command:<div class="informalexample"><pre class="programlisting">$ ./yii exchange/test EUR
&gt; 0.90196

$ ./yii exchange/test EUR 2015-11-24
&gt; 0.93888



$ ./yii exchange/test OTHER
&gt; Exception 'yii\base\InvalidParamException' with message 'Invalid currency format.'

 $ ./yii exchange/test EUR 2015/24/11
Exception 'yii\base\InvalidParamException' with message 'Invalid date format.'

$ ./yii exchange/test ASD
&gt; Exception 'RuntimeException' with message 'Rate not found.'</pre></div></li></ol><div style="height:10px; width: 1px"/></div><p>As a result, you must see the rate values in the success cases or specific exceptions in the error ones. Besides creating your own components, you can do more.</p><div class="section" title="Overriding existing application components"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec42"/>Overriding existing application components</h3></div></div></div><p>Most of the time, there will be no need to create your own application components since other types of extension <a class="indexterm" id="id573"/>such as widgets or behaviors, cover almost all types of reusable codes. However, overriding core framework components is a common practice and can be used to customize the framework's behavior for your specific needs without hacking into the core.</p><p>For example, to be able to format numbers using the <code class="literal">Yii::app()-&gt;formatter-&gt;asNumber($value)</code> method instead of our <code class="literal">NumberHelper::format</code> method from the <span class="emphasis"><em>Creating helpers</em></span> recipe, you can follow the next steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Extend the <code class="literal">yii\i18n\Formatter</code> component as follows:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\components;

class Formatter extends \yii\i18n\Formatter
{
    public function asNumber($value, $decimal = 2)
    {
        return number_format($value, $decimal, '.', ',');
    }
}</pre></div></li><li class="listitem">Override the class of the <a class="indexterm" id="id574"/>built-in <code class="literal">formatter</code> component:<div class="informalexample"><pre class="programlisting">'components' =&gt; [
    // ...
    formatter =&gt; [
        'class' =&gt; 'app\components\Formatter,
    ],
    // ...
],</pre></div></li><li class="listitem">Right now, we can <a class="indexterm" id="id575"/>use this method directly:<div class="informalexample"><pre class="programlisting">echo Yii::app()-&gt;formatter-&gt;asNumber(1534635.2, 3);</pre></div><p>Alternatively, it can be used as a new format for the <code class="literal">GridView</code> and <code class="literal">DetailView</code> widgets:</p><div class="informalexample"><pre class="programlisting">&lt;?= \yii\grid\GridView::widget([
    'dataProvider' =&gt; $dataProvider,
    'columns' =&gt; [
        'id',
        'created_at:datetime',
        'title',
        'value:number',
    ],
]) ?&gt;</pre></div></li><li class="listitem">Also, you can extend every existing component without overwriting its source code.</li></ol><div style="height:10px; width: 1px"/></div></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec292"/>How it works…</h2></div></div></div><p>To be able to attach a component to an application, it can be extended from the <code class="literal">yii\base\Component</code> class. Attaching is as simple as adding a new array to the components section of <a class="indexterm" id="id576"/>configuration. There, a class value specifies the component's class, and all other values are set to a component through the corresponding component's public properties and setter methods.</p><p>Implementation itself is very straightforward; we are wrapping the <a class="ulink" href="http://api.fixer.io">http://api.fixer.io</a> calls into a comfortable API with validators and caching. We can access our class by its component name using <code class="literal">Yii::$app</code>. In our case, it will be <code class="literal">Yii::$app-&gt;exchange</code>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec293"/>See also</h2></div></div></div><p>For official information <a class="indexterm" id="id577"/>about components, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-concept-components.html">http://www.yiiframework.com/doc-2.0/guide-concept-components.html</a>.</p><p>For the <code class="literal">NumberHelper</code> class sources, refer to the <span class="emphasis"><em>Creating helpers</em></span> recipe.</p></div></div>
<div class="section" title="Creating reusable controller actions"><div class="titlepage" id="2LQIK2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch08lvl1sec84"/>Creating reusable controller actions</h1></div></div></div><p>Common actions such as deleting the AR model by the primary key or getting data for AJAX autocomplete could be <a class="indexterm" id="id578"/>moved into reusable controller actions and later attached to controllers as needed.</p><p>In this recipe, we will create a <a class="indexterm" id="id579"/>reusable delete action that will delete the specified AR model by its primary key.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec294"/>Getting ready</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new <code class="literal">yii2-app-basic</code> application using the composer as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</li><li class="listitem">Create a new database and configure it.</li><li class="listitem">Create and apply the following migration:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\db\Migration;

class m160308_093233_create_post_table extends Migration
{
    public function up()
    {
        $this-&gt;createTable('{{%post}}', [
            'id' =&gt; $this-&gt;primaryKey(),
            'title' =&gt; $this-&gt;string()-&gt;notNull(),
            'text' =&gt; $this-&gt;text()-&gt;notNull(),
        ]);
    }

    public function down()
    {
        $this-&gt;dropTable('{{%post}}');
    }
}</pre></div></li><li class="listitem">Generate models for posts and <a class="indexterm" id="id580"/>comments using Gii.</li><li class="listitem">Generate the standard CRUD controller <code class="literal">app\controllers\PostController</code> in Gii.</li><li class="listitem">Ensure that CRUD properly works:<div class="mediaobject"><img alt="Getting ready" src="../Images/image00519.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">In a success case, add a set of example posts.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec295"/>How to do it…</h2></div></div></div><p>Carry out the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the actions <a class="indexterm" id="id581"/>directory and add the <code class="literal">DeleteAction</code> standalone action:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\actions;

use yii\base\Action;
use yii\base\InvalidConfigException;
use yii\web\MethodNotAllowedHttpException;
use yii\web\NotFoundHttpException;

class DeleteAction extends Action
{
    public $modelClass;
    public $redirectTo = ['index'];

    public function init()
    {
        if (empty($this-&gt;modelClass)) {
            throw new InvalidConfigException('Empty model class.');
        }
        parent::init();
    }

    public function run($id)
    {
        if (!\Yii::$app-&gt;getRequest()-&gt;getIsPost()) {
            throw new MethodNotAllowedHttpException('Method not allowed.');
        }
        $model = $this-&gt;findModel($id);
        $model-&gt;delete();
        return $this-&gt;controller-&gt;redirect($this-&gt;redirectTo);
    }

    /**
    * @param $id
    * @return \yii\db\ActiveRecord
    * @throws NotFoundHttpException
    */
    private function findModel($id)
    {
        $class = $this-&gt;modelClass;
        if (($model = $class::findOne($id)) !== null) {
            return $model;
        } else {
            throw new NotFoundHttpException('Page does not exist.');
        }
    }
}</pre></div></li><li class="listitem">Now we need to attach it to the <code class="literal">controllers/PostController.php</code> controller. Remove the <a class="indexterm" id="id582"/>controller's <code class="literal">actionDelete</code> and <code class="literal">behaviors</code> methods and attach your own action in the <code class="literal">action</code> method:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\controllers;

use app\actions\DeleteAction;
use Yii;
use app\models\Post;
use app\models\PostSearch;
use yii\web\Controller;
use yii\web\NotFoundHttpException;

class PostController extends Controller
{
    public function actions()
    {
        return [
            'delete' =&gt; [
                'class' =&gt; DeleteAction::className(),
                'modelClass' =&gt; Post::className(),
            ],
        ];
    }

    public function actionIndex()  {  ...  }

    public function actionView($id)  {  ...  }

    public function actionCreate()  {  ...  }

    public function actionUpdate($id)  {  ...  }

    protected function findModel($id)
    {
        if (($model = Post::findOne($id)) !== null) {
            return $model;
        } else {
            throw new NotFoundHttpException('The requested page does not exist.');
        }
    }
}</pre></div></li><li class="listitem">That is it. Ensure that the delete operation still works correctly, and after the deletion, you will be redirected to a corresponding index action.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec296"/>How it works…</h2></div></div></div><p>To create an external controller action, you need to extend your class from <code class="literal">yii\base\Action</code>. The only <a class="indexterm" id="id583"/>mandatory method to implement is <code class="literal">run</code>. In our case, it accepts the parameter named <code class="literal">$id</code> from <code class="literal">$_GET</code> using the automatic parameter binding feature of Yii and tries to delete a corresponding model.</p><p>To make it customizable, we've created two public properties configurable from the controller. These are <code class="literal">modelName</code>, which holds the name of the model we are working with, and <code class="literal">redirectTo</code> that specifies a route the user will be redirected to.</p><p>The configuration itself is done by implementing the actions method in your controller. There, you can attach the action once or multiple times and configure its public properties.</p><p>You can access the original controller object via the controller property if you need it to redirect to another action or render a specific view.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec297"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">To learn more about <a class="indexterm" id="id584"/>controllers and actions refer, to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-structure-controllers.html">http://www.yiiframework.com/doc-2.0/guide-structure-controllers.html</a></li><li class="listitem">The <span class="emphasis"><em>Creating reusable controllers</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" title="Creating reusable controllers"><div class="titlepage" id="2MP362-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch08lvl1sec85"/>Creating reusable controllers</h1></div></div></div><p>In Yii, you can create reusable <a class="indexterm" id="id585"/>controllers. If you are creating a lot of applications or controllers that are of the same type, moving all common code into a reusable controller will save you a lot of time.</p><p>In this recipe, we try to create a common <code class="literal">CleanController</code>, which will clear temporary directories and flush cached data.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec298"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application using the composer as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec299"/>How to do it…</h2></div></div></div><p>Carry out the following steps to <a class="indexterm" id="id586"/>create reusable controllers:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">cleaner</code> directory and add the standalone <code class="literal">CleanController </code>controller:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\cleaner;

use Yii;
use yii\filters\VerbFilter;
use yii\helpers\FileHelper;
use yii\web\Controller;

class CleanController extends Controller
{
    public $assetPaths = ['@app/web/assets'];
    public $runtimePaths = ['@runtime'];
    public $caches = ['cache'];

    public function behaviors()
    {
        return [
            'verbs' =&gt; [
                'class' =&gt; VerbFilter::className(),
                'actions' =&gt; [
                    'assets' =&gt; ['post'],
                    'runtime' =&gt; ['post'],
                    'cache' =&gt; ['post'],
                ],
            ],
        ];
    }

    public function actionIndex()
    {
        return $this-&gt;render('@app/cleaner/views/index');
    }

    public function actionAssets()
    {
        foreach ((array)$this-&gt;assetPaths as $path) {
            $this-&gt;cleanDir($path);
            Yii::$app-&gt;session-&gt;addFlash(
                'cleaner',
                'Assets path "' . $path . '" is cleaned.'
            );
        }
        return $this-&gt;redirect(['index']);
    }

    public function actionRuntime()
    {
        foreach ((array)$this-&gt;runtimePaths as $path) {
            $this-&gt;cleanDir($path);
            Yii::$app-&gt;session-&gt;addFlash(
                'cleaner',
                'Runtime path "' . $path . '" is cleaned.'
            );
        }
        return $this-&gt;redirect(['index']);
    }

    public function actionCache()
    {
        foreach ((array)$this-&gt;caches as $cache) {
            Yii::$app-&gt;get($cache)-&gt;flush();
            Yii::$app-&gt;session-&gt;addFlash(
                'cleaner',
                'Cache "' . $cache . '" is cleaned.'
            );
        }
        return $this-&gt;redirect(['index']);
    }

    private function cleanDir($dir)
    {
        $iterator = new \DirectoryIterator(Yii::getAlias($dir));
        foreach($iterator as $sub) {
            if(!$sub-&gt;isDot() &amp;&amp; $sub-&gt;isDir()) {
                FileHelper::removeDirectory($sub-&gt;getPathname());
            }
        }
    }
}</pre></div></li><li class="listitem">Create the <code class="literal">cleaner/views/index.php</code> view file <a class="indexterm" id="id587"/>for the <code class="literal">actionIndex</code> method:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;
/* @var $this yii\web\View */
$this-&gt;title = 'Cleaner';
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;
?&gt;
&lt;div class="clean-index"&gt;
    &lt;h1&gt;&lt;?= Html::encode($this-&gt;title) ?&gt;&lt;/h1&gt;

    &lt;?php if (Yii::$app-&gt;session-&gt;hasFlash('cleaner')): ?&gt;
    &lt;?php foreach ((array)Yii::$app-&gt;session-&gt;getFlash('cleaner', []) as $message): ?&gt;
    &lt;div class="alert alert-success"&gt;
        &lt;?= $message ?&gt;
    &lt;/div&gt;
    &lt;?php endforeach; ?&gt;
    &lt;?php endif; ?&gt;

    &lt;p&gt;
        &lt;?= Html::a('Clear Caches', ['cache'], [
            'class' =&gt; 'btn btn-primary',
            'data' =&gt; [
                'confirm' =&gt; 'Are you sure you want to clear all cache data?',
                'method' =&gt; 'post',
            ],
        ]) ?&gt;
        &lt;?= Html::a('Clear Assets', ['assets'], 
            ['class' =&gt; 'btn btn-primary',
                'data' =&gt; [
                    'confirm' =&gt; 'Are you sure you want to 
                        clear all temporary assets?',
                'method' =&gt; 'post',
            ],
        ]) ?&gt;
        &lt;?= Html::a('Clear Runtime', ['runtime'], 
            ['class' =&gt; 'btn btn-primary',
                'data' =&gt; [
                    'confirm' =&gt; 'Are you sure you want to clear all runtime files?',
                        'method' =&gt; 'post',
                ],
            ]) ?&gt;
    &lt;/p&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Attach the controller to <a class="indexterm" id="id588"/>application via the <code class="literal">controllerMap</code> section of the <code class="literal">config/web.php</code> configuration file:<div class="informalexample"><pre class="programlisting">$config = [
    'id' =&gt; 'basic',
    'basePath' =&gt; dirname(__DIR__),
    'bootstrap' =&gt; ['log'],
    'controllerMap' =&gt; [
        'clean' =&gt; 'app\cleaner\CleanController',
    ],
    'components' =&gt; [
        ...
    ]
    ...
];</pre></div></li><li class="listitem">Add a new item to the main menu:<div class="informalexample"><pre class="programlisting">echo Nav::widget([
    'options' =&gt; ['class' =&gt; 'navbar-nav navbar-right'],
    'items' =&gt; [
        ['label' =&gt; 'Home', 'url' =&gt; ['/site/index']],
        ['label' =&gt; 'Cleaner', 'url' =&gt; ['/clean/index']],
        ['label' =&gt; 'About', 'url' =&gt; ['/site/about']],
        ...
    ],
]);</pre></div></li><li class="listitem">Open the controller and clear the assets:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00385.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">In case you use <a class="indexterm" id="id589"/>the yii2-app-advanced application template, just specify the correct paths in the configuration:<div class="informalexample"><pre class="programlisting">'controllerMap' =&gt; [
    'clean' =&gt; 'app\cleaner\CleanController',
    'assetPaths' =&gt; [
        '@backend/web/assets',
        '@frontend/web/assets',
    ],
    'runtimePaths' =&gt; [
        '@backend/runtime',
        '@frontend/runtime',
        '@console/runtime',
    ],
],</pre></div></li></ol><div style="height:10px; width: 1px"/></div><p>Now we can attach the controller to any application.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec300"/>How it works…</h2></div></div></div><p>When you are running an application and <a class="indexterm" id="id590"/>passing a route such as <code class="literal">clean/index</code>, prior to executing <code class="literal">CleanController::actionIndex</code>, Yii checks if there is <code class="literal">controllerMap</code> defined. Since we have a clean controller defined there, Yii executes it instead of going the usual way.</p><p>In the controller itself we defined the <code class="literal">assetPaths</code>, <code class="literal">runtimePaths</code>, and <code class="literal">caches</code> properties to be able to connect the <a class="indexterm" id="id591"/>controller to applications with different directory and cache structures. We are setting it when attaching the controller.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec301"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">In order to learn more about <a class="indexterm" id="id592"/>controllers and about the <a class="indexterm" id="id593"/>controllers map, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-structure-controllers.html">http://www.yiiframework.com/doc-2.0/guide-structure-controllers.html</a></li><li class="listitem">The <span class="emphasis"><em>Creating reusable controllers</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" id="2NNJO1-ae331331bc644dc9b658d3634f0748da" title="Creating a widget"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec86"/>Creating a widget</h1></div></div></div><p>A widget is a reusable part of a view that not only renders some data but also does it according to some logic. It can even <a class="indexterm" id="id594"/>get data from models and use its own views, so it is like a reduced reusable version of a module.</p><p>Let's create a widget that will draw a pie chart using Google APIs.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec302"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application using the composer as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec303"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">widgets</code> directory and add the <code class="literal">ChartWidget</code> class:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\widgets;

use yii\base\Widget;

class ChartWidget extends Widget
{
    public $title;
    public $width = 300;
    public $height = 200;
    public $data = [];
    public $labels = [];

    public function run()
    {
        $path = 'http://chart.apis.google.com/chart';

        $query = http_build_query([
            'chtt' =&gt; $this-&gt;title,
            'cht' =&gt; 'pc',
            'chs' =&gt; $this-&gt;width . 'x' . $this-&gt;height,
            'chd' =&gt; 't:' . implode(',', $this-&gt;data),
            'chds' =&gt; 'a',
            'chl' =&gt; implode('|', $this-&gt;labels),
            'chxt' =&gt; 'y',
            'chxl' =&gt; '0:|0|' . max($this-&gt;data)
        ]);

        $url = $path  . '?' . $query;

        return $this-&gt;render('chart', [
            'url' =&gt; $url,
        ]);
    }
}</pre></div></li><li class="listitem">Create the <code class="literal">widgets/views/chart.php</code> view:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;

/* @var $this yii\web\View */
/* @var $url string */
?&gt;

&lt;div class="chart"&gt;
    &lt;?= Html::img($url) ?&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Now create <a class="indexterm" id="id595"/>a <code class="literal">ChartController</code> controller:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\controllers;

use yii\base\Controller;

class ChartController extends Controller
{
    public function actionIndex()
    {
        return $this-&gt;render('index');
    }
}</pre></div></li><li class="listitem">Add the <code class="literal">views/chart/index.php</code> view:<div class="informalexample"><pre class="programlisting">&lt;?php
use app\widgets\ChartWidget;
use yii\helpers\Html;

/* @var $this yii\web\View */

$this-&gt;title = 'Chart';
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;
?&gt;
&lt;div class="site-about"&gt;
    &lt;h1&gt;&lt;?= Html::encode($this-&gt;title) ?&gt;&lt;/h1&gt;

    &lt;?= ChartWidget::widget([
        'title' =&gt; 'My Chart Diagram',
        'data' =&gt; [
            100 - 32,
                32,
        ],
        'labels' =&gt; [
            'Big',
            'Small',
        ],
    ]) ?&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Now try to run the <a class="indexterm" id="id596"/>index action of the controller. You should see a pie chart like the following:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00512.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">You can show any chart with different sizes and data sets.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec304"/>How it works…</h2></div></div></div><p>As in every other type of extension, we are creating some public properties we can configure when calling a <a class="indexterm" id="id597"/>widget using its <code class="literal">widget</code> method. In this case, we are configuring the title, data set, and data labels.</p><p>The main method of a widget is <code class="literal">run()</code>. In our widget, we are generating a URL and rendering the widget view, which uses the Google charting API for printing the <code class="literal">&lt;img&gt;</code> tag.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec305"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">To learn more about <a class="indexterm" id="id598"/>widgets, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-structure-widgets.html">http://www.yiiframework.com/doc-2.0/guide-structure-widgets.html</a></li><li class="listitem">The <span class="emphasis"><em>Making extensions distribution-ready</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" title="Creating CLI commands"><div class="titlepage" id="2OM4A2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch08lvl1sec87"/>Creating CLI commands</h1></div></div></div><p>Yii has good command-line support and allows creating reusable console commands. Console commands are <a class="indexterm" id="id599"/>faster to create than web GUIs. If you need to create some kind of utility for your application that will be used by developers or administrators, console commands are the right tool.</p><p>To show how to create a console command, we'll create a simple command that will clean up various things, such as assets and temp directories.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec306"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application using the composer, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec307"/>How to do it…</h2></div></div></div><p>Carry out the following steps to create CLI commands:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">commands/CleanController.php</code> file with the following code:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\commands;

use yii\console\Controller;
use yii\helpers\FileHelper;

/**
* Removes content of assets and runtime directories.
*/
class CleanController extends Controller
{
    public $assetPaths = ['@app/web/assets'];
    public $runtimePaths = ['@runtime'];

    /**
    * Removes temporary assets.
    */
    public function actionAssets()
    {
        foreach ((array)$this-&gt;assetPaths as $path) {
            $this-&gt;cleanDir($path);
        }

        $this-&gt;stdout('Done' . PHP_EOL);
    }

    /**
    * Removes runtime content.
    */
    public function actionRuntime()
    {
        foreach ((array)$this-&gt;runtimePaths as $path) {
            $this-&gt;cleanDir($path);
        }

        $this-&gt;stdout('Done' . PHP_EOL);
    }

    private function cleanDir($dir)
    {
        $iterator = new \DirectoryIterator(\Yii::getAlias($dir));
        foreach($iterator as $sub) {
            if(!$sub-&gt;isDot() &amp;&amp; $sub-&gt;isDir()) {
                $this-&gt;stdout('Removed ' . $sub-&gt;getPathname() . PHP_EOL);
                FileHelper::removeDirectory($sub-&gt;getPathname());
            }
        }
    }
}</pre></div></li><li class="listitem">Now we can use our own <a class="indexterm" id="id600"/>console controller with default settings. Just run the <code class="literal">yii</code> shell script:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./yii</strong></span>
</pre></div></li><li class="listitem">Look for own <code class="literal">clean</code> commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>This is Yii version 2.0.7.</strong></span>

<span class="strong"><strong>The following commands are available:</strong></span>

<span class="strong"><strong>- asset                    Allows you to combine...</strong></span>
<span class="strong"><strong>    asset/compress         Combines and compresses the asset...</strong></span>
<span class="strong"><strong>    asset/template         Creates template of configuration file...</strong></span>

<span class="strong"><strong>...</strong></span>

<span class="strong"><strong>- clean                    Removes content of assets and runtime directories.</strong></span>
<span class="strong"><strong>    clean/assets           Removes temporary assets.</strong></span>
<span class="strong"><strong>    clean/runtime          Removes runtime content.</strong></span>

<span class="strong"><strong>- fixture                  Manages fixture data loading and unloading.</strong></span>
<span class="strong"><strong>    fixture/load (default) Loads the specified fixture data.</strong></span>
<span class="strong"><strong>    fixture/unload         Unloads the specified fixtures.</strong></span>

<span class="strong"><strong>...</strong></span>
</pre></div></li><li class="listitem">Right now run <a class="indexterm" id="id601"/>asset cleaning:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>.yii clean/assets</strong></span>
</pre></div></li><li class="listitem">See the process report:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Removed /yii-book.app/web/assets/25f82b8a</strong></span>
<span class="strong"><strong>Removed /yii-book.app/web/assets/9b3b2888</strong></span>
<span class="strong"><strong>Removed /yii-book.app/web/assets/f4307424</strong></span>
<span class="strong"><strong>Done</strong></span>
</pre></div></li><li class="listitem">If you want to use this controller in the <code class="literal">yii2-app-advanced</code> application, just specify the custom working paths:<div class="informalexample"><pre class="programlisting">return [
    'id' =&gt; 'app-console',
    'basePath' =&gt; dirname(__DIR__),
    'bootstrap' =&gt; ['log'],
    'controllerNamespace' =&gt; 'console\controllers',
    'controllerMap' =&gt; [
        'clean' =&gt; [
            'class' =&gt; 'console\controllers\CleanController',
            'assetPaths' =&gt; [
                '@backend/web/assets',
                '@frontend/web/assets',
            ],
            'runtimePaths' =&gt; [
                '@backend/runtime',
                '@frontend/runtime',
                '@console/runtime',
            ],
        ],
    ],
    // ...
];</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec308"/>How it works…</h2></div></div></div><p>All console commands should be extended from the <code class="literal">yii\console\Controller</code> class. Since all console commands <a class="indexterm" id="id602"/>are run in <code class="literal">yii\console\Application</code> instead of <code class="literal">yii\web\Application</code>, we don't have a way to determine the value of the <code class="literal">@webroot</code> alias. Also, in the <code class="literal">yii2-app-advanced</code> template we have backend, frontend, and console subdirectories by default. For this purpose, we are creating configurable public properties called <code class="literal">assetPaths</code> and <code class="literal">runtimePaths</code>.</p><p>The console command structure itself is like a typical controller. We are defining several actions we can run via <code class="literal">yii &lt;console command&gt;/&lt;command action&gt;</code>.</p><p>As you can see, there are no views used, so we can focus on programming tasks instead of design, markup, and so on. Still, you need to provide some useful output so that users will know what is going on. This is done through simple PHP echo statements.</p><p>If your command is relatively complex such as message or migrate bundled with Yii, it's a good decision to provide some extra description of the available options and actions. It can be done by overriding the <code class="literal">getHelp</code> method:</p><div class="informalexample"><pre class="programlisting">public function getHelp()
{
    $out = "Clean command allows you to clean up various temporary data Yii and an application are generating.\n\n";
    return $out . parent::getHelp();
}</pre></div><p>Run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./yii help clean</strong></span>
</pre></div><p>You can see the full output as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>DESCRIPTION</strong></span>
<span class="strong"><strong>Clean command allows you to clean up various temporary data Yii and an application are generating.</strong></span>
<span class="strong"><strong>Removes content of assets and runtime directories.</strong></span>
<span class="strong"><strong>SUB-COMMANDS</strong></span>
<span class="strong"><strong>- clean/assets   Removes temporary assets.</strong></span>
<span class="strong"><strong>- clean/runtime  Removes runtime content.</strong></span>
</pre></div><p>By default, when we run the shell command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./yii</strong></span>
</pre></div><p>We have seen simplified description of all commands in the output list:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>- clean                    Removes content of assets and runtime directories.</strong></span>
<span class="strong"><strong>    clean/assets           Removes temporary assets.</strong></span>
<span class="strong"><strong>    clean/runtime          Removes runtime content.</strong></span>
</pre></div><p>This description will be taken <a class="indexterm" id="id603"/>from comments before class and actions:</p><div class="informalexample"><pre class="programlisting">/**
* Removes content of assets and runtime directories.
*/
class CleanController extends Controller
{
    /**
    * Removes temporary assets.
    */
    public function actionAssets() { … }

    
    * Removes runtime content.
    */
    public function actionRuntime() { … }
}</pre></div><p>It is optional to add descriptions for your classes. You must not do it for your own CLI commands.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec309"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="emphasis"><em>Creating reusable controllers</em></span> recipe in this chapter</li><li class="listitem">The <span class="emphasis"><em>Making extensions distribution-ready</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" title="Creating filters"><div class="titlepage" id="2PKKS2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch08lvl1sec88"/>Creating filters</h1></div></div></div><p>A filter is a class that <a class="indexterm" id="id604"/>can run before/after an action is executed. It can be used to modify <a class="indexterm" id="id605"/>execution context or decorate output. In our example, we'll implement a simple access filter that will allow the user to see private content only after accepting the <span class="strong"><strong>User agreement</strong></span>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec310"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application using the composer, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec311"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the agreement form model:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\models;

use yii\base\Model;

class AgreementForm extends Model
{
    public $accept;

    public function rules()
    {
        return [
            ['accept', 'required'],
            ['accept', 'compare', 'compareValue' =&gt; 1, 'message' =&gt; 'You must agree the rules.'],
        ];
    }

    public function attributeLabels()
    {
        return [
            'accept' =&gt; 'I completely accept the rules.'
        ];
    }
}</pre></div></li><li class="listitem">Create the agreement <a class="indexterm" id="id606"/>checker service:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\services;

use Yii;
use yii\web\Cookie;

class AgreementChecker
{
    public function isAllowed()
    {
        return Yii::$app-&gt;request-&gt;cookies-&gt;has('agree');
    }

    public function allowAccess()
    {
        Yii::$app-&gt;response-&gt;cookies-&gt;add(new Cookie([
            'name' =&gt; 'agree',
            'value' =&gt; 'on',
            'expire' =&gt; time() + 3600 * 24 * 90, // 90 days
        ]));
    }
}</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">It encapsulates work <a class="indexterm" id="id607"/>with the agreement cookies.</li></ol><div style="height:10px; width: 1px"/></div></li><li class="listitem">Create the <code class="literal">filter</code> class:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\filters;

use app\services\AgreementChecker;
use Yii;
use yii\base\ActionFilter;

class AgreementFilter extends ActionFilter
{
    public function beforeAction($action)
    {
        $checker = new AgreementChecker();
        if (!$checker-&gt;isAllowed()) {
            Yii::$app-&gt;response-&gt;redirect(['/content/agreement'])-&gt;send();
            return false;
        }
        return true;
    }
}</pre></div></li><li class="listitem">Create the content controller and attach the filter to its behaviors:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\controllers;

use app\filters\AgreementFilter;
use app\models\AgreementForm;
use app\services\AgreementChecker;
use Yii;
use yii\web\Controller;

class ContentController extends Controller
{
    public function behaviors()
    {
        return [
            [
                'class' =&gt; AgreementFilter::className(),
                'only' =&gt; ['index'],
            ],
        ];
    }

    public function actionIndex()
    {
        return $this-&gt;render('index');
    }

    public function actionAgreement()
    {
        $model = new AgreementForm();
        if ($model-&gt;load(Yii::$app-&gt;request-&gt;post()) &amp;&amp; $model-&gt;validate()) {
            $checker = new AgreementChecker();
            $checker-&gt;allowAccess();
            return $this-&gt;redirect(['index']);
        } else {
            return $this-&gt;render('agreement', [
                'model' =&gt; $model,
            ]);
        }
    }
}</pre></div></li><li class="listitem">Add the <code class="literal">views/content/index.php</code> view <a class="indexterm" id="id608"/>with private content:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;

/* @var $this yii\web\View */
$this-&gt;title = 'Content';
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;
?&gt;
&lt;div class="site-about"&gt;
    &lt;h1&gt;&lt;?= Html::encode($this-&gt;title) ?&gt;&lt;/h1&gt;

    &lt;div class="well"&gt;
        This is our private page.
    &lt;/div&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Add the <code class="literal">views/content/agreement.php</code> view <a class="indexterm" id="id609"/>with the form:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;
use yii\bootstrap\ActiveForm;

/* @var $this yii\web\View */
/* @var $form yii\bootstrap\ActiveForm */
/* @var $model app\models\AgreementForm */

$this-&gt;title = 'User agreement';
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;
?&gt;
&lt;div class="site-login"&gt;
    &lt;h1&gt;&lt;?= Html::encode($this-&gt;title) ?&gt;&lt;/h1&gt;

    &lt;p&gt;Please agree with our rules:&lt;/p&gt;

    &lt;?php $form = ActiveForm::begin(); ?&gt;

    &lt;?= $form-&gt;field($model, 'accept')-&gt;checkbox() ?&gt;

    &lt;div class="form-group"&gt;
        &lt;?= Html::submitButton('Accept', ['class' =&gt; 'btn btn-success']) ?&gt;
        &lt;?= Html::a('Cancel', ['/site/index'], ['class' =&gt; 'btn btn-danger']) ?&gt;
    &lt;/div&gt;

    &lt;?php ActiveForm::end(); ?&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Add the main menu item to the <code class="literal">views/layouts/main.php</code> file:<div class="informalexample"><pre class="programlisting">echo Nav::widget([
    'options' =&gt; ['class' =&gt; 'navbar-nav navbar-right'],
    'items' =&gt; [
        ['label' =&gt; 'Home', 'url' =&gt; ['/site/index']],
        ['label' =&gt; 'Content', 'url' =&gt; ['/content/index']],
        ['label' =&gt; 'About', 'url' =&gt; ['/site/about']],
        ...
    ],
]);</pre></div></li><li class="listitem">Try to open the <a class="indexterm" id="id610"/>content page. The filter must redirect you to the agreement page:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00374.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Only after accepting the rules can you see the private content:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00514.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Also, you can attach the filter to other controllers or modules.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec312"/>How it works…</h2></div></div></div><p>A filter should extend the <code class="literal">yii\base\ActionFilter</code> class, which extends <code class="literal">yii\base\Behavior</code>. We can override the <code class="literal">beforeAction</code> or <code class="literal">afterAction</code> method if we want to do post- and pre-filtering.</p><p>For example, we can check <a class="indexterm" id="id611"/>user access and throw corresponding HTTP-exceptions in a fail case. In this recipe, we redirect the user to the agreement page if the specific cookie value does not exist:</p><div class="informalexample"><pre class="programlisting">class AgreementFilter extends ActionFilter
{
    public function beforeAction($action)
    {
        $checker = new AgreementChecker();
        if (!$checker-&gt;isAllowed()) {
            Yii::$app-&gt;response-&gt;redirect(['/content/agreement'])-&gt;send();
            return false;
        }
        return true;
    }
}</pre></div><p>You can attach filters to any controller or module. To specify the list of necessary routes, just use the <code class="literal">only</code> or <code class="literal">except</code> options. For example, we apply our filter only for the index action of the controller:</p><div class="informalexample"><pre class="programlisting">public function behaviors() 
{
    return [
        [
            'class' =&gt; AgreementFilter::className(),
            'only' =&gt; ['index'],
        ],
    ];
}</pre></div><div class="note" title="Note"><h3 class="title"><a id="note14"/>Note</h3><p>Do not forget to return a <code class="literal">true</code> value in the success case from the <code class="literal">beforeAction</code> method. Otherwise, the controller action will not be executed.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec313"/>See also</h2></div></div></div><p>For more information <a class="indexterm" id="id612"/>about filters, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-structure-filters.html">http://www.yiiframework.com/doc-2.0/guide-structure-filters.html</a>.</p><p>For build-in cache <a class="indexterm" id="id613"/>and access <a class="indexterm" id="id614"/>control filters, refer to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-caching-http.html">http://www.yiiframework.com/doc-2.0/guide-caching-http.html</a></li><li class="listitem"><a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-securityauthorization.html">http://www.yiiframework.com/doc-2.0/guide-securityauthorization.html</a></li><li class="listitem">The <span class="emphasis"><em>Creating model behaviors</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Creating modules"><div class="titlepage" id="2QJ5E2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch08lvl1sec89"/>Creating modules</h1></div></div></div><p>If you have created a complex <a class="indexterm" id="id615"/>application part and want to use it with some degree of customization in your next project, most probably you need to create a module. In this recipe, we will see how to create an application log view module.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec314"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application using the composer, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec315"/>How to do it…</h2></div></div></div><p>Let's do some planning first.</p><p>In <code class="literal">yii2-app-basic</code> with default configuration, all log entries are stored in the <code class="literal">runtime/logs/app.log</code> file. We can extract all messages from this file with help of regular expressions and display <a class="indexterm" id="id616"/>them on the <span class="strong"><strong>GridView</strong></span> widget. Besides, we must allow the user to configure the path to the custom log file.</p><p>Carry out the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">modules/log</code> directory and create the <code class="literal">Module</code> class with the new file option:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\modules\log;

class Module extends \yii\base\Module
{
    public $file = '@runtime/logs/app.log';
}</pre></div></li><li class="listitem">Create a simple model for transferring rows from the log file:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\modules\log\models;

use yii\base\Object;

class LogRow extends Object
{
    public $time;
    public $ip;
    public $userId;
    public $sessionId;
    public $level;
    public $category;
    public $text;
}</pre></div></li><li class="listitem">Write a log file <a class="indexterm" id="id617"/>reader class that will parse file rows, reverse its order, and return array of instances of the <code class="literal">LogRow</code> models:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\modules\log\services;

use app\modules\log\models\LogRow;

class LogReader
{
    public function getRows($file)
    {
        $result = [];
        $handle = @fopen($file, "r");
        if ($handle) {
            while (($row = fgets($handle)) !== false) {
                $pattern =
                    '#^' .
                    '(?P&lt;time&gt;\d{4}\-\d{2}\-\d{2} \d{2}:\d{2}:\d{2}) ' .
                    '\[(?P&lt;ip&gt;[^\]]+)\]' .
                    '\[(?P&lt;userId&gt;[^\]]+)\]' .
                    '\[(?P&lt;sessionId&gt;[^\]]+)\]' .
                    '\[(?P&lt;level&gt;[^\]]+)\]' .
                    '\[(?P&lt;category&gt;[^\]]+)\]' .
                    ' (?P&lt;text&gt;.*?)' .
                    '(\$\_(GET|POST|REQUEST|COOKIE|SERVER) = \[)?' .
                    '$#i';
                if (preg_match($pattern, $row, $matches)) {
                    if ($matches['text']) {
                        $result[] = new LogRow([
                            'time' =&gt; $matches['time'],
                            'ip' =&gt; $matches['ip'],
                            'userId' =&gt; $matches['userId'],
                            'sessionId' =&gt; $matches['sessionId'],
                            'level' =&gt; $matches['level'],
                            'category' =&gt; $matches['category'],
                            'text' =&gt; $matches['text'],
                        ]);
                    }
                }
            }
            fclose($handle);
        }
        return array_reverse($result);
    }
}</pre></div></li><li class="listitem">Add a helper for <a class="indexterm" id="id618"/>displaying pretty HTML-badges for the log levels:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\modules\log\helpers;

use yii\helpers\ArrayHelper;
use yii\helpers\Html;

class LogHelper
{
    public static function levelLabel($level)
    {
        $classes = [
            'error' =&gt; 'danger',
            'warning' =&gt; 'warning',
            'info' =&gt; 'primary',
            'trace' =&gt; 'default',
            'profile' =&gt; 'success',
            'profile begin' =&gt; 'info',
            'profile end' =&gt; 'info',
        ];

        $class = ArrayHelper::getValue($classes, $level, 'default');
        return Html::tag('span', Html::encode($level), ['class' =&gt; 'label-' . $class]);
    }
}</pre></div></li><li class="listitem">Create a module <a class="indexterm" id="id619"/>controller that will get an array of rows from the reader and pass them into <code class="literal">ArrayDataProvider</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\modules\log\controllers;

use app\modules\log\services\LogReader;
use yii\data\ArrayDataProvider;
use yii\web\Controller;

class DefaultController extends Controller
{
    public function actionIndex()
    {
        $reader = new LogReader();
        $dataProvider = new ArrayDataProvider([
            'allModels' =&gt; $reader-&gt;getRows($this-&gt;getFile()),
        ]);
        return $this-&gt;render('index', [
            'dataProvider' =&gt; $dataProvider,
        ]);
    }

    private function getFile()
    {
        return \Yii::getAlias($this-&gt;module-&gt;file);
    }
}</pre></div></li><li class="listitem">Now, create the <code class="literal">modules/log/default/index.php</code> view file:<div class="informalexample"><pre class="programlisting">&lt;?php
use app\modules\log\helpers\LogHelper;
use app\modules\log\models\LogRow;
use yii\grid\GridView;
use yii\helpers\Html;

/* @var $this yii\web\View */
/* @var $dataProvider yii\data\ArrayDataProvider */

$this-&gt;title = 'Application log';
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;
?&gt;
&lt;div class="log-index"&gt;
    &lt;h1&gt;&lt;?= Html::encode($this-&gt;title) ?&gt;&lt;/h1&gt;

    &lt;?= GridView::widget([
        'dataProvider' =&gt; $dataProvider,
        'columns' =&gt; [
            [
    


            'attribute' =&gt; 'time',
                'format' =&gt; 'datetime',
                'contentOptions' =&gt; [
                    'style' =&gt; 'white-space: nowrap',
                ],
            ],
            'ip:text:IP',
            'userId:text:User',
            [
                'attribute' =&gt; 'level',
                'value' =&gt; function (LogRow $row) {
                    return LogHelper::levelLabel($row-&gt;level);
                },
                'format' =&gt; 'raw',
            ],
            'category',
            'text',
        ],
    ]) ?&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Attach the module to <a class="indexterm" id="id620"/>your application in the <code class="literal">config/web.php</code> file:<div class="informalexample"><pre class="programlisting">$config = [
    'id' =&gt; 'basic',
    'basePath' =&gt; dirname(__DIR__),
    'bootstrap' =&gt; ['log'],
    'modules' =&gt; [
        'log' =&gt; 'app\modules\log\Module',
    ],
    'components' =&gt; [

    ],
    ...
];</pre></div></li><li class="listitem">Add a link to the controller in the <code class="literal">views/layouts/main.php</code> file:<div class="informalexample"><pre class="programlisting">echo Nav::widget([
    'options' =&gt; ['class' =&gt; 'navbar-nav navbar-right'],
    'items' =&gt; [
        ['label' =&gt; 'Home', 'url' =&gt; ['/site/index']],
        ['label' =&gt; 'Log', 'url' =&gt; ['/log/default/index']],
        ['label' =&gt; 'About', 'url' =&gt; ['/site/about']],
        ['label' =&gt; 'Contact', 'url' =&gt; ['/site/contact']],
        ...
    ],
]);
NavBar::end();</pre></div></li><li class="listitem">Go to <code class="literal">url /index.php?r=lo</code><code class="literal">g</code> and <a class="indexterm" id="id621"/>ensure that the module works:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00376.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec316"/>How it works...</h2></div></div></div><p>You can group your controllers, models, views, and other components by separated modules and attach them <a class="indexterm" id="id622"/>into your application. You can generate a module template with the help of Gii or make it manually.</p><p>Each module contains a main module class where we can define configurable properties, define change paths, attach controllers, and so on. By default, a module generated with Gii runs the <code class="literal">index</code> action of the default controller.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec317"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">For more information <a class="indexterm" id="id623"/>about modules and about best practices, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-structure-modules.html">http://www.yiiframework.com/doc-2.0/guide-structure-modules.html</a></li><li class="listitem">The <span class="emphasis"><em>Making extensions distribution-ready</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Creating a custom view renderer"><div class="titlepage" id="2RHM02-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch08lvl1sec90"/>Creating a custom view renderer</h1></div></div></div><p>There are many PHP template engines out there. Yii2 only offers native PHP templates. If you want to use one of the <a class="indexterm" id="id624"/>existing template engines or create your own one, you have to implement it—of course, if it's not yet implemented by the Yii community.</p><p>In this recipe we'll re-implement the Smarty templates support.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec318"/>Getting ready</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new <code class="literal">yii2-app-basic</code> application using the composer, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</li><li class="listitem">Install the Smarty library:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>composer require smarty/smarty</strong></span>
</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec319"/>How to do it…</h2></div></div></div><p>Carry out the following steps for creating a custom view renderer:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">smarty/ViewRenderer.php</code> file:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\smarty;

use Smarty;
use Yii;

class ViewRenderer extends \yii\base\ViewRenderer
{
    public $cachePath = '@runtime/smarty/cache';
    public $compilePath = '@runtime/smarty/compile';

    /**
    * @var Smarty
    */
    private $smarty;

    public function init()
    {
        $this-&gt;smarty = new Smarty();
        $this-&gt;smarty-&gt;setCompileDir(Yii::getAlias($this-&gt;compilePath));
        $this-&gt;smarty-&gt;setCacheDir(Yii::getAlias($this-&gt;cachePath));
        $this-&gt;smarty-&gt;setTemplateDir([
            dirname(Yii::$app-&gt;getView()-&gt;getViewFile()),
            Yii::$app-&gt;getViewPath(),
        ]);
    }

    public function render($view, $file, $params)
    {
        $templateParams = empty($params) ? null : $params;
        $template = $this-&gt;smarty-&gt;createTemplate($file, null, null, $templateParams, false);
        $template-&gt;assign('app', \Yii::$app);
        $template-&gt;assign('this', $view);
        return $template-&gt;fetch();
    }
}</pre></div></li><li class="listitem">Now we need to connect the view <a class="indexterm" id="id625"/>renderer to the application. In <code class="literal">config/web php</code>, we need to add renderers of the view component:<div class="informalexample"><pre class="programlisting">'components' =&gt; [
    ....
    'view' =&gt; [
        'renderers' =&gt; [
            'tpl' =&gt; [
                'class' =&gt; 'app\smarty\ViewRenderer',
            ],
        ],
    ],
    ...
];</pre></div></li><li class="listitem">Now let's test it. Create a new <code class="literal">SmartyController</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\controllers;

use yii\web\Controller;

class SmartyController extends Controller
{
    public function actionIndex()
    {
        return $this-&gt;render('index.tpl', [
            'name' =&gt; 'Bond',
        ]);
    }
}</pre></div></li><li class="listitem">Next, we need to <a class="indexterm" id="id626"/>create the <code class="literal">views/smarty/index.tpl</code> view:<div class="informalexample"><pre class="programlisting">&lt;div class="smarty-index"&gt;
    &lt;h1&gt;Smarty Example&lt;/h1&gt;
    &lt;p&gt;Hello, {$name}!&lt;/p&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Now try running the controller. In a success case, you should get the following as output:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00412.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec320"/>How it works…</h2></div></div></div><p>A view renderer is a child of the <code class="literal">yii\base\ViewRenderer</code> abstract class that implements only one method, called <code class="literal">render</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace yii\base;

abstract class ViewRenderer extends Component
{
    /**
    * Renders a view file.
    *
    * This method is invoked by [[View]] whenever it tries to render a view.
    * Child classes must implement this method to render the given view file.
    *
    * @param View $view the view object used for rendering the file.
    * @param string $file the view file.
    * @param array $params the parameters to be passed to the view file.
    * @return string the rendering result
    */
   abstract public function render($view, $file, $params);
}</pre></div><p>Therefore, we are getting a <a class="indexterm" id="id627"/>view component, file path, and render variables. We need to process the file and return the rendered result. In our case, processing itself is done by the Smarty template engine, so we need to properly initialize it and call its processing methods:</p><div class="informalexample"><pre class="programlisting">class ViewRenderer extends \yii\base\ViewRenderer
{
    public $cachePath = '@runtime/smarty/cache';
    public $compilePath = '@runtime/smarty/compile';
    private $smarty;

    public function init()
    {
        $this-&gt;smarty = new Smarty();
        $this-&gt;smarty-&gt;setCompileDir(Yii::getAlias($this-&gt;compilePath));
        $this-&gt;smarty-&gt;setCacheDir(Yii::getAlias($this-&gt;cachePath));
        $this-&gt;smarty-&gt;setTemplateDir([
            dirname(Yii::$app-&gt;getView()-&gt;getViewFile()),
            Yii::$app-&gt;getViewPath(),
        ]);
    }
    …
}</pre></div><p>It is a good practice to store Yii temporary files <a class="indexterm" id="id628"/>in the application runtime directory. That is why we are setting the <code class="literal">compile</code> directory, where Smarty stores its templates compiled into PHP, to <code class="literal">runtime/smarty/compile</code>.</p><p>Rendering itself is a bit simpler:</p><div class="informalexample"><pre class="programlisting">public function render($view, $file, $params)
{
    $templateParams = empty($params) ? null : $params;
    $template = $this-&gt;smarty-&gt;createTemplate($file, null, null, $templateParams, false);
    $template-&gt;assign('app', \Yii::$app);
    $template-&gt;assign('this', $view);
    return $template-&gt;fetch();
}</pre></div><p>All data set via <code class="literal">$this-&gt;render</code> is passed to the Smarty template as it is. Also, we are creating special Smarty template variables named <code class="literal">app</code> and <code class="literal">this</code> that point to <code class="literal">Yii::$app</code> and <code class="literal">Yii::$app-&gt;view</code> and allow us to get application properties inside a template.</p><p>Then, we are rendering the templates.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec321"/>See also</h2></div></div></div><p>You can get ready to use <a class="indexterm" id="id629"/>Smarty view renderer with plugins and configuration support at <a class="ulink" href="https://github.com/yiisoft/yii2-smarty">https://github.com/yiisoft/yii2-smarty</a>.</p><p>To learn more about Smarty and <a class="indexterm" id="id630"/>view renderers in general, refer to the <a class="indexterm" id="id631"/>following URLs:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><a class="ulink" href="http://www.smarty.net">http://www.smarty.net</a></li><li class="listitem"><a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-tutorial-templateengines.html">http://www.yiiframework.com/doc-2.0/guide-tutorial-templateengines.html</a></li><li class="listitem"><a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-structure-views.html">http://www.yiiframework.com/doc-2.0/guide-structure-views.html</a></li></ul></div></div></div>
<div class="section" title="Creating a multilanguage application"><div class="titlepage" id="2SG6I2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch08lvl1sec91"/>Creating a multilanguage application</h1></div></div></div><p>Every day, we meet more and more international companies, software products, and information resources that <a class="indexterm" id="id632"/>publish content on multiple languages. Yii2 provides built-in i18n support for making multilanguage applications.</p><p>In this recipe, we are translating the application interface to different languages.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec322"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application using the composer, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec323"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Change the main menu <a class="indexterm" id="id633"/>labels in the <code class="literal">views/layouts/main.php</code> file to use the <code class="literal">Yii::t('app/nav', '...')</code> method:<div class="informalexample"><pre class="programlisting">echo Nav::widget([
    'options' =&gt; ['class' =&gt; 'navbar-nav navbar-right'],
    'items' =&gt; [
        ['label' =&gt; Yii::t('app/nav', 'Home'), 'url' =&gt; ['/site/index']],
        ['label' =&gt; Yii::t('app/nav', 'About'), 'url' =&gt; ['/site/about']],
        ['label' =&gt; Yii::t('app/nav', 'Contact'), 'url' =&gt; ['/site/contact']],
        ...
    ],
]);</pre></div></li><li class="listitem">Change all your titles and breadcrumbs to use the common <code class="literal">Yii::t('app, '...')</code> method:<div class="informalexample"><pre class="programlisting">$this-&gt;title = Yii::t('app', 'Contact');
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;</pre></div></li><li class="listitem">Also, change all the labels of your buttons:<div class="informalexample"><pre class="programlisting">&lt;div class="form-group"&gt;
    &lt;?= Html::submitButton(Yii::t('app', 'Submit'), ['class' =&gt; 'btn btn-primary'']) ?&gt;
&lt;/div&gt;</pre></div><p>Change other hard-coded messages as well:</p><div class="informalexample"><pre class="programlisting">&lt;p&gt;
    &lt;?= Yii::t('app', 'The above error occurred while the Web server was processing your request.') ?&gt;
&lt;/p&gt;</pre></div></li><li class="listitem">Change the attribute labels of your <code class="literal">ContactForm</code> model:<div class="informalexample"><pre class="programlisting">class LoginForm extends Model
{
    ...

    public function attributeLabels()
    {
        return [
            'username' =&gt; Yii::t('app/user', 'Username'),
            'password' =&gt; Yii::t('app/user', 'Password'),
            'rememberMe' =&gt; Yii::t('app/user', 'Remember Me'),
        ];
    }
}</pre></div><p>Also, change the attribute labels of the <code class="literal">LoginForm</code> model:</p><div class="informalexample"><pre class="programlisting">class ContactForm extends Model
{
    ...

    public function attributeLabels()
    {
        return [
            'name' =&gt; Yii::t('app/contact', 'Name'),
            'email' =&gt; Yii::t('app/contact', 'Email'),
            'subject' =&gt; Yii::t('app/contact', 'Subject'),
            'body' =&gt; Yii::t('app/contact', 'Body'),
            'verifyCode' =&gt; Yii::t('app', 'Verification Code'),
        ];
    }
}</pre></div><p>It will output translated labels for the current language instead of originals.</p></li><li class="listitem">To prepare <a class="indexterm" id="id634"/>translations, create the <code class="literal">messages</code> directory. Right now, we can create translation files for all needed languages. We can do it manually, but there is a helpful crawler that can scan all project files and extract all messages from <code class="literal">Yii::t()</code> constructions. Let's use it.</li><li class="listitem">Generate the configuration file for the message scanner:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./yii message/config-template config/messages.php</strong></span>
</pre></div></li><li class="listitem">Open the configuration file and set the following values:<div class="informalexample"><pre class="programlisting">&lt;?php

return [
    'sourcePath' =&gt; '@app',
    'languages' =&gt; ['de', 'fr'],
    'translator' =&gt; 'Yii::t',
    'sort' =&gt; false,
    'removeUnused' =&gt; false,
    'markUnused' =&gt; true,
    'only' =&gt; ['*.php'],
    'except' =&gt; [
        '.svn',
        '.git',
        '.gitignore',
        '.gitkeep',
        '.hgignore',
        '.hgkeep',
        '/messages',
        '/vendor',
    ],

    'format' =&gt; 'php',
    'messagePath' =&gt; '@app/messages',
    'overwrite' =&gt; true,

    'ignoreCategories' =&gt; [
        'yii',
    ],
];</pre></div></li><li class="listitem">Run crawler while <a class="indexterm" id="id635"/>passing this configuration file to it:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./yii message config/messages.php</strong></span>
</pre></div></li><li class="listitem">After the process, we must get the following directory structure:<div class="informalexample"><pre class="programlisting">messages
├── de
│   ├── app
│   │   ├── contact.php
│   │   ├── nav.php
│   │   └── user.php
│   └── app.php
└── fr
    ├── app
    │   ├── contact.php
    │   ├── nav.php
    │   └── user.php
    └── app.php</pre></div></li><li class="listitem">For example, the <code class="literal">messages/de/app/contact</code> file contains the following content:<div class="informalexample"><pre class="programlisting">&lt;?php
... 
return [
    'Body' =&gt; '',
    'Email' =&gt; '',
    'Name' =&gt; '',
    'Subject' =&gt; '',
];</pre></div></li><li class="listitem">It is a plain PHP array with <a class="indexterm" id="id636"/>original sentences in keys and translated messages in values.</li><li class="listitem">Just put in the values needed to translate messages from Deutsch:<div class="informalexample"><pre class="programlisting">&lt;?php
... 
return [
    'Password' =&gt; 'Passwort',
    'Remember Me' =&gt; 'Erinnere dich an mich',
    'Username' =&gt; 'Benutzername',
];</pre></div></li><li class="listitem">Attach these translations to the <code class="literal">i18n</code> component of application in the <code class="literal">config/web.php</code> file:<div class="informalexample"><pre class="programlisting">$config = [
    'id' =&gt; 'basic',
    'basePath' =&gt; dirname(__DIR__),
    'bootstrap' =&gt; ['log'],
    'components' =&gt; [
        …
        'i18n' =&gt; [
            'translations' =&gt; [
                'app*' =&gt; [
                    'class' =&gt; 'yii\i18n\PhpMessageSource',
                    'sourceLanguage' =&gt; 'en-US',
                ],
            ],
        ],
        'db' =&gt; require(__DIR__ . '/db.php'),
    ],
    'params' =&gt; $params,
];</pre></div></li><li class="listitem">Open the login page with the default language:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00372.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Switch the <a class="indexterm" id="id637"/>application language to <code class="literal">de</code>:<div class="informalexample"><pre class="programlisting">$config = [
    'id' =&gt; 'basic',
    'language' =&gt; 'de',
    'basePath' =&gt; dirname(__DIR__),
    'bootstrap' =&gt; ['log'],
    ...
];</pre></div><p>Then refresh the login page:</p><div class="mediaobject"><img alt="How to do it…" src="../Images/image00503.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">The built-in frameworks <a class="indexterm" id="id638"/>messages and default validation errors will be translated automatically.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec324"/>How it works…</h2></div></div></div><p>Yii2 provides the <code class="literal">Yii::t()</code> method for translating interface messages via the <code class="literal">i18n</code> component, which supports different <a class="indexterm" id="id639"/>types of sources. In <a class="indexterm" id="id640"/>this recipe, we use  <code class="literal">yii\i18n\hpMessageSource</code>, which stores translated messages in plain PHP files.</p><p>The framework does not have artificial intelligence and does not translate messages by itself. You must put prepared translations in files or in the database and framework to get the needed message from this message source.</p><p>You can set the current language manually:</p><div class="informalexample"><pre class="programlisting">$config = [
    'id' =&gt; 'basic',
    'language' =&gt; 'de',
    ...
];</pre></div><p>Instead of setting the language in the configuration file, you can switch the application language in runtime:</p><div class="informalexample"><pre class="programlisting">Yii::$app-&gt;language = 'fr';</pre></div><p>For example, if you store the user <a class="indexterm" id="id641"/>language in the <code class="literal">lang</code> field of the <code class="literal">User</code> model, you can create the language loader:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\bootstrap;

use yii\base\BootstrapInterface;

class LanguageBootstrap implements BootstrapInterface
{
    public function bootstrap($app)
    {
        if (!$app-&gt;user-&gt;isGuest) {
            $app-&gt;language = $app-&gt;user-&gt;identity-&gt;lang;
        }
    }
}</pre></div><p>Register this class in the bootstrapping list:</p><div class="informalexample"><pre class="programlisting">$config = [
    'id' =&gt; 'basic',
    'basePath' =&gt; dirname(__DIR__),
    'bootstrap' =&gt; ['log', 'app'bootstrap\LanguageBoostrap'],
    ...
];</pre></div><p>Now, every authenticated user will see the interface in their own language.</p><p>Also, you can override the <code class="literal">yii\web\UrlManager</code> class for passing the current language as a GET parameter or as a prefix of a URL. Also, as an alternative you can store selected languages in browser cookies.</p><p>When you generate models and another code with Gii, you can check the following option:</p><div class="mediaobject"><img alt="How it works…" src="../Images/image00522.jpeg"/></div><p style="clear:both; height: 1em;"> </p><p>All labels in the generated code will be embraced into the <code class="literal">Yii::t()</code> calls.</p><div class="note" title="Note"><h3 class="title"><a id="note15"/>Note</h3><p>We did not cover the translating of model content in this recipe. However, for example, you can store <a class="indexterm" id="id642"/>translated texts in separate tables (such as the <code class="literal">post_lang</code> table for post model table) in a database and use the value of the <code class="literal">Yii::$app-&gt;language</code> property to get the current language and extract needed content for your models by the value.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec325"/>See also</h2></div></div></div><p>For more information about <a class="indexterm" id="id643"/>internationalization in Yii2, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-tutorial-i18n.html">http://www.yiiframework.com/doc-2.0/guide-tutorial-i18n.html</a>.</p></div></div>
<div class="section" title="Making extensions distribution-ready"><div class="titlepage" id="2TEN42-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch08lvl1sec92"/>Making extensions distribution-ready</h1></div></div></div><p>In this chapter, you learned how <a class="indexterm" id="id644"/>to create various types of Yii extensions. Now we'll talk about how to share your results with people and why it's important.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec326"/>Getting ready</h2></div></div></div><p>Let's form a checklist for a good extension first. A good programming product should follow these points:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Good coding style</li><li class="listitem">People should be able to find it</li><li class="listitem">A consistent, easy to read, and easy to use API</li><li class="listitem">Good documentation</li><li class="listitem">Extension should apply to the most common use cases</li><li class="listitem">Should be maintained</li><li class="listitem">Well-tested code, ideally with unit tests</li><li class="listitem">You need to provide support for it</li></ul></div><p>Of course, having all these requires a lot of work, but these are necessary to create a good product.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec327"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Every modern PHP product must follow the PSR4 standards of autoloading and the PSR1 and PSR2 standards of the coding style <a class="indexterm" id="id645"/>from the <a class="ulink" href="http://www.php-fig.org/psr/">http://www.php-fig.org/psr/</a> guide.</li><li class="listitem">Let's review our list in more detail, starting with the API. The API should be consistent, easy to read, and easy to use. Consistent means that the overall style should not change, so no different variable naming, no inconsistent names such as <code class="literal">isFlag1()</code> and <code class="literal">isNotFlag2()</code>, and so on. Everything should obey the rules you've defined for your code. This allows less checking of documentation and allows you to focus on coding.</li><li class="listitem">A code without any documentation is almost useless. An exception is a relatively simple <a class="indexterm" id="id646"/>code, but even if it's only a few lines, it doesn't feel right if there is not a single word about how to install and use it. What makes good documentation? The purpose of the code and its pros should be as visible as possible and should be written loud and clear.</li><li class="listitem">A code is useless if developers don't know where to put it and what should be in the application configuration. Don't expect that people know how to do framework-specific things. The installation guide should be verbose. A step-by-step form is preferred by a majority of developers. If the code needs SQL schema to work, provide it.</li><li class="listitem">Even if your API methods and properties are named properly, you still need to document them with PHPDoc comments specifying argument types and return types, providing a brief description for each method. Don't forget protected and private methods and properties since sometimes it's necessary to read these to understand the details of how code works. Also, consider listing public methods and properties in documentation so it can be used as a reference.</li><li class="listitem">Provide use case examples with well-commented code. Try to cover the most common ways of extension usage.</li><li class="listitem">In an example, don't try to solve multiple problems at a time since it can be confusing.</li><li class="listitem">It's important to make your code flexible so it will apply to many use cases. However, since it's not possible to create code for every possible use case, try to cover the most common ones.</li><li class="listitem">It's important to make people feel comfortable. Providing a good documentation is a first step. The second is providing a proof that your code works as expected and will work with further updates. The best way to do it is a set of unit tests.</li><li class="listitem">Extension should be maintained, at least until it's stable and there are no more feature requests and bug reports. So expect questions and reports, and reserve some time to work on the code further. If you can't devote more time to maintain extensions, but it's very innovative and no one did it before, it's still worth sharing. If the community likes it, someone will definitely offer his or her help.</li><li class="listitem">Finally, you need to make extensions available. Create the Composer package from your extension, push it on GitHub or other shared repository storage, and <a class="indexterm" id="id647"/>publish it on the <a class="ulink" href="https://packagist.org">https://packagist.org</a> site.</li><li class="listitem">Each extension should have a version number and a change log. It will allow the community to check if <a class="indexterm" id="id648"/>they have the latest version and check what is changed before upgrading. We recommend to follow the <span class="strong"><strong>Semantic Versioning</strong></span> rules <a class="indexterm" id="id649"/>from the <a class="ulink" href="http://semver.org">http://semver.org</a> site.</li><li class="listitem">Even if your extension is relatively simple and documentation is good, there could be questions, and for the first time, the only person who can answer them is you. Typically, questions are asked at official forums, so it is better to create a topic where people can discuss your code and provide a link at the extension page.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec328"/>How it works…</h2></div></div></div><p>If you want to share an extension with the community and be sure it will be useful and popular, you need to do more than just write code. Making extensions distribution-ready is much more work to do. It can be even more than creating an extension itself. So, why is it good to share extensions with the community in the first place?</p><p>Making the code you use in your own projects open source has its pros. You are getting people, a lot more people <a class="indexterm" id="id650"/>than you can get to test your closed source project. People who are using your extension are testing it, giving valuable feedback, and reporting bugs. If your code is popular, there will be passionate developers who will try to improve your code, to make it more extensive, more stable, and reusable. Moreover, it just feels good because you are doing a good thing.</p><p>We have covered the most important things. Still, there are more things to check out. Try existing extensions before writing your own. If an extension almost fits, try contacting the extension author and contributing ideas you have. Reviewing existing code helps you find out useful tricks, dos, and don'ts. Also, check wiki articles and the official forum from time to time; there is a lot of useful information about creating extensions and developing using Yii in general.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec329"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">For modern <a class="indexterm" id="id651"/>information about PHP coding standards, refer to <a class="ulink" href="http://www.php-fig.org/psr/">http://www.php-fig.org/psr/</a></li><li class="listitem">To learn more <a class="indexterm" id="id652"/>about semantic versioning, refer to <a class="ulink" href="http://semver.org">http://semver.org</a></li></ul></div></div></div></body></html>