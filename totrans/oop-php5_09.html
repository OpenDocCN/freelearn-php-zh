<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Building Better with MVC"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Building Better with MVC</h1></div></div></div><p>In chapter 4 we learned how design patterns can simplify your daily programming life by providing you with common approaches for solving problems. One of the popular design patterns used for application architecture is <span class="strong"><strong>Model-View-Controller,</strong></span> which is also known as <span class="strong"><strong>MVC</strong></span>. In <a id="id393" class="indexterm"/>
<a id="id394" class="indexterm"/>RAD (Rapid Application Development) for PHP, MVC frameworks play a vital role. These days several MVC frameworks have gained public interest and many of them are enterprise-ready. For example, <span class="strong"><strong>symfony</strong></span> framework has been used in developing Yahoo bookmarks, CakePHP is being developed in refactoring Mambo, CodeIgniter is used by many big applications showcased on their site. Also there are popular MVC frameworks like Zend Framework, which is used by IBM and also used to develop the Magento open-source ecommerce solution. </p><p>Therefore, nowadays, writing code from scratch and fine tuning it is obsolete, and if you are doing this, you should really avoid it. In this chapter, we will discuss the basic structure of MVC frameworks and then introduce you to some of these popular frameworks. <a id="id395" class="indexterm"/>
</p><div class="section" title="What is MVC?"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec85"/>What is MVC?</h1></div></div></div><a id="id396" class="indexterm"/><p>As the name implies, MVC consists of three components. The first one is Model, the second one is View, and the third one is Controller. This doesn't make any sense if we just list the names. To begin with, Model is an object, which interacts with a database. All business logics are usually written inside the model. A controller is a piece of code, which takes user inputs and based on that initializes models and other objects, and finally invokes all of them. Finally, the View is a component, which displays the result generated by controller with the help of model.</p><p>So for good practice, you should never implement any business logic in view or controller. Similarly, you should never process the output results in a model. And you should never produce any output directly from controller (instead use the view). </p><a id="id397" class="indexterm"/><p>In the following sections we will be creating a very small MVC. </p></div></div>
<div class="section" title="Planning for the Project"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec86"/>Planning for the Project</h1></div></div></div><a id="id398" class="indexterm"/><p>For successfully developing any application you must have a clear target. Whenever the architecture of an application is robust, stable, and foolproof, you will get a huge number of users using your application. The MVC framework we are going to develop in this chapter will serve the following issues successfully: </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Small footprint</li><li class="listitem" style="list-style-type: disc">Easy loading of components, libraries, helpers, and models</li><li class="listitem" style="list-style-type: disc">Nice and flexible syntax for developing view</li><li class="listitem" style="list-style-type: disc">Excellent support with popular database servers</li><li class="listitem" style="list-style-type: disc">Will not be resource extensive</li><li class="listitem" style="list-style-type: disc">Easy to use</li><li class="listitem" style="list-style-type: disc">Easy to integrate with other component frameworks like Pear, ezComponents, and so on. </li><li class="listitem" style="list-style-type: disc">Support for caching</li><li class="listitem" style="list-style-type: disc">Layout support like RubyOnRails for easy design of your web application </li><li class="listitem" style="list-style-type: disc">A native gzip compressor for JavaScript</li><li class="listitem" style="list-style-type: disc">Ajax support</li></ul></div></div>
<div class="section" title="Designing the Bootstrap File"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec87"/>Designing the Bootstrap File</h1></div></div></div><a id="id399" class="indexterm"/><p>The bootstrap is a file, which just prepares the environment for successful execution and integration of controllers, models, and views. Basically a bootstrap file initializes the environment, the router, the object loader, and passes all the input parameters to the controller. We will design the bootstrap file, which will receive all the parameters of a successful request URL with the help of <code class="literal">mod_rewrite</code>. </p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>
<code class="literal">mod_rewrite</code> is an apache module, which helps to redirect a request defined by a pattern (regular expression) to another request URL. It is an essential module for almost every web application designed. If you are interested in studying more on it, you can go to: <a class="ulink" href="http://httpd.apache.org/docs/2.0/mod/mod_rewrite.html">http://httpd.apache.org/docs/2.0/mod/mod_rewrite.html</a>
</p></div></div><p>To enable <code class="literal">mod_rewrite</code> you can follow the following details. Firstly, open <code class="literal">httpd.conf</code> and add the following lines:</p><div class="informalexample"><pre class="programlisting">LoadModule rewrite_module modules/mod_rewrite.so
&lt;Directory /&gt;
    Options FollowSymLinks
    AllowOverride None
    Order deny,allow
    Deny from all
    Satisfy all
&lt;/Directory&gt;</pre></div><p>We have to place the following code in an <code class="literal">.htaccess</code> file and place it inside our application root. </p><div class="informalexample"><pre class="programlisting">RewriteEngine on
RewriteCond $1 !^(index\.php|images|robots\.txt)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php?$1</pre></div><p>This code will just redirect every request to <code class="literal">index.php</code>, which will be our bootstrap file. This bootstrap file will receive any requested URL and then split it into different parts like controller, action and parameters. For example, the format will be <code class="literal">http://our_application/controller/action/param/param..../param</code>. The bootstrap will analyze the URL with the help of a router and then with the help of dispatcher it will invoke controller and action with all the parameters. </p><a id="id400" class="indexterm"/><p>Here is the code of our bootstrap file (<code class="literal">index.php</code>):  </p><div class="informalexample"><pre class="programlisting">&lt;?
include("core/ini.php");
initializer::initialize();
$router = loader::load("router");
dispatcher::dispatch($router);
?&gt;</pre></div><p>In the above code you see that there is an object called <code class="literal">loader</code>. The main purpose of this is to load objects for us, but via the Singleton pattern. This will help us to minimize the load. Using this loader we will load an object named <code class="literal">router</code>. There is also an object called <code class="literal">dispatcher</code>, which will finally dispatch the web request with the help of router. </p><p>Let's check the code of <code class="literal">core/ini.php</code>, which is a helper to help easy inclusion of class files from different directories. </p><div class="informalexample"><pre class="programlisting">&lt;?
set_include_path(get_include_path().PATH_SEPARATOR."core/main");
function __autoload($object)
{
  require_once("{$object}.php");
}
?&gt;</pre></div><p>Here goes the <code class="literal">initializer</code> file (<code class="literal">core/main/initializer.php</code>):</p><div class="informalexample"><pre class="programlisting">&lt;?
class initializer
{
  public static function initialize()
  {
  set_include_path(get_include_path().PATH_SEPARATOR."core/main");
  set_include_path(get_include_path().PATH_SEPARATOR.
                                               "core/main/cache");
  set_include_path(get_include_path().PATH_SEPARATOR."core/helpers");
  set_include_path(get_include_path().PATH_SEPARATOR.
                                                "core/libraries");
  //set_include_path(get_include_path().PATH_SEPARATOR.
                                                "app/controllers");
  set_include_path(get_include_path().PATH_SEPARATOR."app/models");
  set_include_path(get_include_path().PATH_SEPARATOR."app/views");
//include_once("core/config/config.php");
  }
}
?&gt;</pre></div><a id="id401" class="indexterm"/><p>If you take a look at the code of the <code class="literal">initializer</code> file, you will find that it actually just extends the include path. </p><p>Here is the code of our <code class="literal">loader</code> file (<code class="literal">core/main/loader.php</code>), which will load different components via the Singleton pattern.</p><div class="informalexample"><pre class="programlisting">&lt;?
class loader
{
  private static $loaded = array();
  public static function load($object)
  {
    $valid = array(	"library",
    "view",
    "model",
    "helper",
    "router",
    "config",
    "hook",
    "cache",
    "db");

    if (!in_array($object,$valid))
    {

      $config = self::load("config");
      if ("on"==$config-&gt;debug)
      {
        base::backtrace();
      }</pre></div><div class="informalexample"><pre class="programlisting">throw new Exception("Not a valid object '{$object}' to load");
    }

    if (empty(self::$loaded[$object])){
      self::$loaded[$object]= new $object();
    }
    return self::$loaded[$object];

  }

}
?&gt;</pre></div><a id="id402" class="indexterm"/><p>Loader uses another <code class="literal">config</code> file (<code class="literal">core/main/config.php</code>), which actually loads different <code class="literal">configs</code> from under <code class="literal">config/configs.php</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?
class config
{
  private $config;
  function __construct()
  {
    global $configs;
    include_once("core/config/configs.php");
    include_once("app/config/configs.php");
    $this-&gt;config = $configs;
  }

  private function __get($var)
  {
    return $this-&gt;config[$var];
  }
}
?&gt;</pre></div><p>If you wonder how our <code class="literal">configs.php</code> will look, here it goes: </p><div class="informalexample"><pre class="programlisting">&lt;?
$configs['debug']="on";
$configs['base_url']="http://localhost/orchid";
$configs['global_profile']=true;
$configs['allowed_url_chars'] = "/[^A-z0-9\/\^]/";
$configs['default_controller']="welcome";
?&gt;</pre></div><p>Well, if you look at the code of <code class="literal">loader.php</code> there is a section like this: </p><div class="informalexample"><pre class="programlisting">$config = self::load("config");
  if ("on"==$config-&gt;debug)
    {
      base::backtrace();
    }</pre></div><p>So <code class="literal">$config-&gt;debug</code> actually returns the value of <code class="literal">$configs['debug']</code> with the help of <code class="literal">__get()</code> <code class="literal">magic</code> method in <code class="literal">config.php</code>.</p><p>In loader there is a method named <code class="literal">base::backtrace()</code>. <code class="literal">base</code> is a static object declared in <code class="literal">core/libraries/base.php</code>. It contains some useful functions to use throughout the framework. This is in <code class="literal">core/libraries/base.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?
class base{
  public static function pr($array)
  {
    echo "&lt;pre&gt;";
    print_r($array);
    echo "&lt;/pre&gt;";
  }
<a id="id403" class="indexterm"/>
  public static function backtrace()
  {
    echo "&lt;pre&gt;";
    debug_print_backtrace();
    echo "&lt;/pre&gt;";
  }

  public static function basePath()
  {
    return getcwd();
  }

  public static function baseUrl()
  {
    $conf = loader::load("config");
    return $conf-&gt;base_url;
  }
?&gt;</pre></div><p>Therefore <code class="literal">base::backtrace()</code> actually prints <code class="literal">debug_backtrace</code> for easy tracing exceptions. </p><p>So far we haven't seen the code of <code class="literal">router.php</code> and <code class="literal">dispatcher.php</code>. Router and dispatcher are the main part of the whole application. Here is the code of <code class="literal">router.php</code> (<code class="literal">core/main/router.php</code>):</p><div class="informalexample"><pre class="programlisting">&lt;?
class router
{
  private $route;
  private $controller;
  private $action;
  private $params;
  public function __construct()
  {
    if(file_exists("app/config/routes.php")){
      require_once("app/config/routes.php");
    }
<a id="id404" class="indexterm"/>
    $path = array_keys($_GET);
    $config = loader::load("config");
    if (!isset($path[0]))
    {
      $default_controller = $config-&gt;default_controller;
      if (!empty($default_controller))
      $path[0] = $default_controller;
      else 
      $path[0] = "index";
    }
    $route= $path[0];
<a id="id405" class="indexterm"/>
    $sanitzing_pattern = $config-&gt;allowed_url_chars;
    $route = preg_replace($sanitzing_pattern, "", $route);
    $route = str_replace("^","",$route);
    $this-&gt;route = $route;
<a id="id406" class="indexterm"/>
    $routeParts = split( "/",$route);
    $this-&gt;controller=$routeParts[0];
    $this-&gt;action=isset($routeParts[1])? $routeParts[1]:"base";
    array_shift($routeParts);
    array_shift($routeParts);
    $this-&gt;params=$routeParts;
<a id="id407" class="indexterm"/>
    /* match user defined routing pattern */
    if (isset($routes)){
      foreach ($routes as $_route)
      {
        $_pattern = "~{$_route[0]}~";
        $_destination = $_route[1];
        if (preg_match($_pattern,$route))
        {
          $newrouteparts = split("/",$_destination);
          $this-&gt;controller = $newrouteparts[0];
          $this-&gt;action = $newrouteparts[1];
        }
      }
    }
  }
<a id="id408" class="indexterm"/>
  public function getAction()
  {
    if (empty($this-&gt;action)) $this-&gt;action="main";
    return $this-&gt;action;
  }
<a id="id409" class="indexterm"/>
  public function getController()
  {
    return $this-&gt;controller;
  }
<a id="id410" class="indexterm"/>
  public function getParams()
  {
    return $this-&gt;params;
  }
<a id="id411" class="indexterm"/>
}
?&gt;</pre></div><p>What router actually does is find the controller, action, and parameters from a request URL. If the controller name is not found, it uses the default controller name and if default controller name is not found in <code class="literal">config</code> file, it will use <code class="literal">index</code> as the default controller. </p><a id="id412" class="indexterm"/><p>Before proceeding to dispatcher, we must look at the view engine, which will be used for template engine, so that anyone from controller can set variables like this <code class="literal">$this-&gt;view-&gt;set(varname,</code> <code class="literal">value)</code>. After that, anyone can access the variable as <code class="literal">$varname</code> in our view file. </p><p>So here comes the view engine (<code class="literal">core/main/view.php</code>):</p><div class="informalexample"><pre class="programlisting">&lt;?
class view
{
  private $vars=array();
  private $template;
<a id="id413" class="indexterm"/>
  public function set($key, $value)
  {
  $this-&gt;vars[$key]=$value;
  }
<a id="id414" class="indexterm"/>
  public function getVars(&amp;$controller=null)
  {
    if (!empty($controller)) $this-&gt;vars['app']=$controller;
    return $this-&gt;vars;
  }
<a id="id415" class="indexterm"/>
  public function setTemplate($template)
  {
    $this-&gt;template = $template;
  }
<a id="id416" class="indexterm"/>
  public function getTemplate($controller=null)
  {
    if (empty($this-&gt;template)) return $controller;
    return $this-&gt;template;
  }
<a id="id417" class="indexterm"/>
  private function __get($var)
  {
    return loader::load($var);
  }
}
?&gt;</pre></div><a id="id418" class="indexterm"/><p>Here comes the dispatcher, the core part of our framework (<code class="literal">core/main/dispatcher.php</code>):</p><div class="informalexample"><pre class="programlisting">&lt;?
class dispatcher
{
  public static function dispatch($router)
  {
    global $app;
    //$cache = loader::load("cache");
    ob_start();
    $config = loader::load("config");
<a id="id419" class="indexterm"/>
    if ($config-&gt;global_profile) $start = microtime(true);
<a id="id420" class="indexterm"/>
<span class="strong"><strong>    $controller = $router-&gt;getController();</strong></span>
<span class="strong"><strong>    $action = $router-&gt;getAction();</strong></span>
<span class="strong"><strong>    $params = $router-&gt;getParams();</strong></span><a id="id421" class="indexterm"/>
<span class="strong"><strong>    if (count($params)&gt;1){</strong></span>
<span class="strong"><strong>      if ("unittest"==$params[count($params)-1] || </strong></span>
<span class="strong"><strong>                   '1'==$_POST['unittest'])unittest::setUp();</strong></span>
<span class="strong"><strong>    }</strong></span><a id="id422" class="indexterm"/>
<span class="strong"><strong>    $controllerfile = "app/controllers/{$controller}.php";</strong></span><a id="id423" class="indexterm"/>
<span class="strong"><strong>    if (file_exists($controllerfile)){</strong></span>
<span class="strong"><strong>      require_once($controllerfile);</strong></span>
<span class="strong"><strong>      $app = new $controller();</strong></span><a id="id424" class="indexterm"/>
<span class="strong"><strong>      $app-&gt;use_layout = true;</strong></span><a id="id425" class="indexterm"/>
<span class="strong"><strong>      $app-&gt;setParams($params);</strong></span><a id="id426" class="indexterm"/>
<span class="strong"><strong>      $app-&gt;$action();</strong></span><a id="id427" class="indexterm"/>
      unittest::tearDown();
<a id="id428" class="indexterm"/>
      ob_end_clean();
<a id="id429" class="indexterm"/>
      //manage view
      ob_start();
<a id="id430" class="indexterm"/>
<a id="id431" class="indexterm"/>
      $view = loader::load("view");
<span class="strong"><strong>      $viewvars = $view-&gt;getVars($app);</strong></span>
<span class="strong"><strong>      $uselayout = $config-&gt;use_layout;</strong></span>

<span class="strong"><strong>      if (!$app-&gt;use_layout) $uselayout=false;</strong></span>

<span class="strong"><strong>      $template = $view-&gt;getTemplate($action);</strong></span>
<span class="strong"><strong>      base::_loadTemplate($controller, $template, </strong></span>
<span class="strong"><strong>                               $viewvars, $uselayout);</strong></span>

      if (isset($start))
     echo "&lt;p&gt;Total time for dispatching is : 
                ".(microtime(true)-$start)." seconds.&lt;/p&gt;";
      $output = ob_get_clean();

      //$cache-&gt;set("abcde",array
                     ("content"=&gt;base64_encode($output)));
      echo $output;
    }
    else
    throw new Exception("Controller not found");
  }
}
?&gt;</pre></div><p>Here's what dispatcher mainly does (as seen from the highlighted section of the above code). It takes a router object as parameter then finds controller, action, and parameters from router. If the controller file is available, it loads that and then initializes the controller. After initializing, it just accesses the action. </p><p>After that, dispatcher initializes the current view object using loader. As it is coming via Singleton, all variables set to it are still in scope. Dispatcher then passes the view template file, variables to a function named <code class="literal">_loadTemplate</code> in base.</p><p>So what is the purpose of <code class="literal">$uselayout</code>? It just indicates whether a layout file should be appended to our template. This is more fun when we see it in practice. </p><a id="id432" class="indexterm"/><p>Here is the <code class="literal">base::_loadTemplate()</code> function:</p><div class="informalexample"><pre class="programlisting">  public static function _loadTemplate($controller, $template, 
                                  $vars, $uselayout=false)
  {
    extract($vars);
    if ($uselayout)
    ob_start();
    $templatefile ="app/views/{$controller}/{$template}.php";
    if (file_exists($templatefile)){
      include_once($templatefile);
    }
    else
    {
      throw new Exception("View '{$template}.php' is not found in 
                               views/{$controller} directory.");
    }

    if ($uselayout) {
      $layoutdata = ob_get_clean();
      $layoutfilelocal = "app/views/{$controller}/{$controller}.php";
      $layoutfileglobal = "app/views/layouts/{$controller}.php";
				
      if (file_exists($layoutfilelocal))
      include_once($layoutfilelocal);
      else 
      include_once($layoutfileglobal);
    }
  }</pre></div><p>If you are confused about placing these files, here is the directory structure to help you understand: </p><div class="mediaobject"><img src="graphics/2561_09_00.jpg" alt="Designing the Bootstrap File"/></div><p>Why are there other files like <code class="literal">jsm.php</code>, <code class="literal">benchmark.php</code>, <code class="literal">unittest.php</code>, <code class="literal">helper.php</code>, <code class="literal">model.php</code>, <code class="literal">library.php</code>, <code class="literal">cache.php</code>, and <code class="literal">db.php</code>?</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">T<a id="id433" class="indexterm"/>hese files will help us for the following sections:</li><li class="listitem" style="list-style-type: disc"><code class="literal">jsm.php</code>: Helps to load JavaScript with automatic gzip compression</li><li class="listitem" style="list-style-type: disc"><code class="literal">db.php</code>: For connecting to different database</li><li class="listitem" style="list-style-type: disc"><code class="literal">library.php</code>: Helps to load library files</li><li class="listitem" style="list-style-type: disc"><code class="literal">unittest.php</code>: Will help to automate unit testing</li><li class="listitem" style="list-style-type: disc"><code class="literal">model.php</code>: Will help to load models for database access</li></ul></div><p>Now let's see what our <code class="literal">model</code> and <code class="literal">library</code> are doing. </p><p>Here comes <code class="literal">core/main/model.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?
class model
{
  private $loaded = array();
  private function __get($model)
  {
    $model .="model";
    $modelfile = "app/models/{$model}.php";

    $config = loader::load("config");

    if (file_exists($modelfile))
    {
      include_once($modelfile);
      if (empty($this-&gt;loaded[$model]))
      {
        $this-&gt;loaded[$model]=new $model();
      }
      $modelobj = $this-&gt;loaded[$model];
      if ($config-&gt;auto_model_association)
      {
        $this-&gt;associate($modelobj, $_REQUEST); //auto association
      }
      return $modelobj;
    }
<a id="id434" class="indexterm"/>    else
    {
      throw new Exception("Model {$model} is not found");
    }
  }

  private function associate(&amp;$obj, $array)
  {
    foreach ($array as $key=&gt;$value)
    {
      if (property_exists($obj, $key))
      {
        $obj-&gt;$key = $value;
      }
    }
  }
}
?&gt;</pre></div><p>Whenever a form is submitted, we want to populate any model right after initializing it. Therefore, we have kept a configuration variable named <code class="literal">auto_model_association</code> for it. If you set it to true, models will be automatically associated. </p><p>Here comes the library loader <code class="literal">(core/main/library.php</code>):</p><div class="informalexample"><pre class="programlisting">&lt;?
class library{
  private $loaded = array();
  private function __get($lib)
  {
    if (empty($this-&gt;loaded[$lib]))
    {
      $libnamecore = "core/libraries/{$lib}.php";
      $libnameapp = "app/libraries/{$lib}.php";
      if (file_exists($libnamecore))
      {
        require_once($libnamecore);
        $this-&gt;loaded[$lib]=new $lib();
      }
      else if(file_exists($libnameapp))
      {
        require_once($libnameapp);
        $this-&gt;loaded[$lib]=new $lib();
      }
      else 
      {
        throw new Exception("Library {$lib} not found.");
      }
    }
    return $this-&gt;loaded[$lib];
  }
}
?&gt;</pre></div><p>
<code class="literal">library.php</code> helps only to load libraries via a Singleton. </p><p>N<a id="id435" class="indexterm"/>ow we will see the JavaScript loader, which by default delivers each library with gzip compression. These days every browser supports gzip compression for faster loading of any object. We are also distributing distributing our framework with built-in support for prototype, jQuery and script.aculo.us. </p><p>Here is <code class="literal">core/libraries/jsm.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?
/**
 * Javascript Manager
 *
 */
class jsm
{
  function loadPrototype()
  {
    $base = base::baseUrl();
    echo "&lt;script type='text/javascript' 
            src='{$base}/core/js/gzip.php?js=prototypec.js'&gt;\n";
  }
  function loadScriptaculous()
  {
    $base = base::baseUrl();
    echo "&lt;script type='text/javascript' 
      src='{$base}/core/js/gzip.php?js=scriptaculousc.js'&gt;\n";
  }
  function loadProtaculous()
  {
    $base = base::baseUrl();
    echo "&lt;script type='text/javascript' 
      src='{$base}/core/js/gzip.php?js=prototypec.js'&gt;\n";
    echo "&lt;script type='text/javascript' 
      src='{$base}/core/js/gzip.php?js=scriptaculousc.js'&gt;\n";
  }
  function loadJquery()
 <a id="id436" class="indexterm"/> {
    $base = base::baseUrl();
    echo "&lt;script type='text/javascript' 
            src='{$base}/core/js/gzip.php?js=jqueryc.js'&gt;\n";
  }
  /**
   * app specific libraries
   *
   * @param string $filename
   */
  function loadScript($filename)
  {
    $base = base::baseUrl();
    $script = $base."/app/js/{$filename}.js";
    echo "&lt;script type='text/javascript' 
         src='{$base}/core/js/gzip.php?js={$script}'&gt;\n";
  }
}
?&gt;</pre></div><p>If you take a look at the code you will find that it loads every JavaScript file via <code class="literal">gzip.php</code>, which is actually responsible for compressing the content. So here is the code of <code class="literal">gzip.php</code> (<code class="literal">core/js/gzip.php</code>):</p><div class="informalexample"><pre class="programlisting">&lt;?php 
  ob_start("ob_gzhandler");
  header("Content-type: text/javascript; charset: UTF-8");
  header("Cache-Control: must-revalidate");
  $offset = 60 * 60 * 24 * 3;
  $ExpStr = "Expires: " . 
         gmdate("D, d M Y H:i:s",  time() + $offset) . " GMT";
  header($ExpStr);
  $js = $_GET['js'];
  if (in_array($js, 
      array("prototypec.js","scriptaculousc.js","jqueryc.js")))
                               include(urldecode($_GET['js']));
?&gt;</pre></div><a id="id437" class="indexterm"/><p>If you have other libraries to load, you can modify this library and add them in the following line. </p><div class="informalexample"><pre class="programlisting">if (in_array($js, 
  array("prototypec.js","scriptaculousc.js","jqueryc.js")))</pre></div><p>Lastly, we have another file, which helps us writing a unit test during the developing of our application. <code class="literal">unittest.php</code> is responsible for that and there is also a Boolean configuration flag for this: <code class="literal">unit_test_enabled</code>.</p><p>Here is <code class="literal">core/main/unittest.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?
class unittest
{
  private static $results = array();
  private static $testmode = false;

  public static function setUp()
  {
    $config = loader::load("config");
    if ($config-&gt;unit_test_enabled){
      self::$results = array();
      self::$testmode = true;
    }
  }

  public static function tearDown()
  {
    if (self::$testmode)
    {
      self::printTestResult();
      self::$results = array();
      self::$testmode = false;
      die();
    }
  }

  public static function printTestResult()
  {
    foreach (self::$results as $result)
    {
      echo $result."&lt;hr/&gt;";
    }
  }

  public static function assertTrue($object)
  {
    if (!self::$testmode) return 0;
    if (true==$object) $result = "passed";
    self::saveResult(true, $object, $result);
  }

  public static function assertEqual($object, $constant)
  {
    if (!self::$testmode) return 0;
    if ($object==$constant)
    {
      $result = 1;
<a id="id438" class="indexterm"/>    }
    self::saveResult($constant, $object, $result);
  }

  private static function getTrace()
  {
    $result = debug_backtrace();
    $cnt = count($result);
    $callerfile = $result[2]['file'];
    $callermethod = $result[3]['function'];
    $callerline = $result[2]['line'];
    return array($callermethod, $callerline, $callerfile);
  }

  private static function saveResult($expected, $actual, 
                                              $result=false)
  {
    if (empty($actual)) $actual = "null/false";

    if ("failed"==$result || empty($result))
    $result = "&lt;font color='red'&gt;&lt;strong&gt;failed&lt;/strong&gt;&lt;/font&gt;";
    else
    $result = "&lt;font color='green'&gt;&lt;strong&gt;passed&lt;/strong&gt;&lt;/font&gt;";

    $trace = self::getTrace();
    $finalresult = "Test {$result} in Method: 
          &lt;strong&gt;{$trace[0]}&lt;/strong&gt;. Line: 
          &lt;strong&gt;{$trace[1]}&lt;/strong&gt;. File: 
          &lt;strong&gt;{$trace[2]}&lt;/strong&gt;. &lt;br/&gt; Expected: 
          &lt;strong&gt;{$expected}&lt;/strong&gt;, Actual: 
          &lt;strong&gt;{$actual}&lt;/strong&gt;. ";
    self::$results[] = $finalresult;
  }

  public static function assertArrayHasKey($key, array $array, 
                                                     $message = '')
  {
    if (!self::$testmode) return 0;
    if (array_key_exists($key, $array))
    {
      $result = 1;
      self::saveResult("Array has a key named '{$key}'", 
                    "Array has a key named '{$key}'", $result);
      return ;
    }
    self::saveResult("Array has a key named '{$key}'", 
                "Array has not a key named '{$key}'", $result);
  }
<a id="id439" class="indexterm"/>
  public static function assertArrayNotHasKey($key, array $array, 
                                               $message = '')
  {
    if (!self::$testmode) return 0;
    if (!array_key_exists($key, $array))
    {
      $result = 1;
      self::saveResult("Array has not a key named '{$key}'", 
              "Array has not a key named '{$key}'", $result);
      return ;
    }
    self::saveResult("Array has not a key named '{$key}'", 
                   "Array has a key named '{$key}'", $result);

  }
  public static function assertContains($needle, $haystack, 
                           $message = '')
  {
    if (!self::$testmode) return 0;
    if (in_array($needle,$haystack))
    {
      $result = 1;
      self::saveResult("Array has a needle named '{$needle}'", 
               "Array has a needle named '{$needle}'", $result);
      return ;
    }
    self::saveResult("Array has a needle named '{$needle}'", 
            "Array has not a needle named '{$needle}'", $result);

  }
}
?&gt;</pre></div><p>We must keep a built-in support for benchmarking our code to help profiling. Therefore, we have <code class="literal">benchmark.php</code> (<code class="literal">core/main/benchmark.php</code>) which performs it: <a id="id440" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">&lt;?
class benchmark
{
  private $times = array();
  private $keys = array();

  public function setMarker($key=null)
  {
    $this-&gt;keys[] = $key;
    $this-&gt;times[] = microtime(true);
  }

  public function initiate()
  {
    $this-&gt;keys= array();
    $this-&gt;times= array();
  }

  public function printReport()
  {
    $cnt = count($this-&gt;times);
    $result = "";
    for ($i=1; $i&lt;$cnt; $i++)
    {
      $key1 = $this-&gt;keys[$i-1];
      $key2 = $this-&gt;keys[$i];
      $seconds = $this-&gt;times[$i]-$this-&gt;times[$i-1];
      $result .= "For step '{$key1}' to '{$key2}' : {$seconds} 
                                              seconds.&lt;/br&gt;";
    }
    $total = $this-&gt;times[$i-1]-$this-&gt;times[0];
    $result .= "Total time  : {$total} seconds.&lt;/br&gt;";
    echo $result;
  }
}
?&gt;<a id="id441" class="indexterm"/>
</pre></div></div>
<div class="section" title="Adding Database Support"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec88"/>Adding Database Support</h1></div></div></div><a id="id442" class="indexterm"/><p>Our framework must have a data abstraction layer to facilitate database operations painlessly. We are going to provide support to three popular databases: SQLite, PostgreSQL, and MySQL. Here is the code of our data abstraction layer in <code class="literal">core/main/db.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?
include_once("dbdrivers/abstract.dbdriver.php");
class db
{
  private $dbengine;
  private $state  = "development";

  public function __construct()
  {
    $config = loader::load("config");
    $dbengineinfo = $config-&gt;db;
    if (!$dbengineinfo['usedb']==false)
    {
      $driver = $dbengineinfo[$this-&gt;state]['dbtype'].'driver';
      include_once("dbdrivers/{$driver}.php");
      $dbengine = new $driver($dbengineinfo[$this-&gt;state]);
      $this-&gt;dbengine = $dbengine;
    }
  }

  public function setDbState($state)
  {
    //must be 'development'/'production'/'test' or whatever
    if (empty($this-&gt;dbengine)) return 0;
    $config = loader::load("config");
    $dbengineinfo = $config-&gt;db;
    if (isset($dbengineinfo[$state]))
    {
      $this-&gt;state = $state;
    }
    else 
    {
      throw new Exception("No such state in config filed called 
                                          ['db']['{$state}']");
    }
  }

  private function __call($method, $args)
  {
    if (empty($this-&gt;dbengine)) return 0;
    if (!method_exists($this, $method))
    return call_user_func_array(array($this-&gt;dbengine,
                                           $method),$args);
  }

  /*private function __get($property)
  {
    if (property_exists($this-&gt;dbengine,$property))
    return $this-&gt;dbengine-&gt;$property;
  }*/
}
?&gt;</pre></div><a id="id443" class="indexterm"/><p>It uses an abstract driver object to ensure the extensibility and consistency of the driver objects. In the future, if any third-party developer wants to introduce new drivers he must extend it in <code class="literal">core/main/dbdrivers/abstract.dbdriver.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?
define ("FETCH_ASSOC",1);
define ("FETCH_ROW",2);
define ("FETCH_BOTH",3);
define ("FETCH_OBJECT",3);

abstract class abstractdbdriver
{
  protected $connection;
  protected $results = array();
  protected $lasthash = "";

  public function count()
  {
    return 0;
  }

  public function execute($sql)
  {
    return false;
  }

  private function prepQuery($sql)
  {
    return $sql;
  }

  public function escape($sql)
  {
    return $sql;
  }

  public function affectedRows()
  {
    return 0;
  }

  public function insertId()
  {
    return 0;
  }

  public function transBegin()
  {
    return false;
  }

  public function transCommit()<a id="id444" class="indexterm"/>
  {
  return false;	
  }

  public function transRollback()
  {
    return false;
  }

  public function getRow($fetchmode = FETCH_ASSOC)
  {
    return array();
  }

  public function getRowAt($offset=null,$fetchmode = FETCH_ASSOC)
  {
    return array();
  }

  public function rewind()
  {
    return false;
  }

  public function getRows($start, $count, $fetchmode = FETCH_ASSOC)
  {
    return array();
  }
}
?&gt;<a id="id445" class="indexterm"/>
</pre></div><div class="section" title="Drivers"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec45"/>Drivers</h2></div></div></div><a id="id446" class="indexterm"/><p>Now here comes the trickiest part; the drivers. Let's take a look at SQLite driver file <code class="literal">core/main/dbdrivers/sqlitedriver.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?
class sqlitedriver extends abstractdbdriver
{
  public function __construct($dbinfo)
  {
    if (isset($dbinfo['dbname']))
    {
      if (!$dbinfo['persistent'])
      $this-&gt;connection = 
           sqlite_open($dbinfo['dbname'],0666,$errormessage);
      else
      $this-&gt;connection = 
           sqlite_popen($dbinfo['dbname'],0666,$errormessage);
      if (!$this-&gt;connection)
      {
        throw new Exception($errormessage);
      }
    }
    else
    throw new Exception("You must supply database name for a 
                                         successful connection");

  }

  public function count()
  {
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    //print_r($this-&gt;results);
    $count = sqlite_num_rows($lastresult);
    if (!$count) $count = 0;
    return $count;
  }

  public function execute($sql)
  {

    $sql = $this-&gt;prepQuery($sql);
    $parts = split(" ",trim($sql));
    $type = strtolower($parts[0]);
    $hash = md5($sql);
    $this-&gt;lasthash = $hash;

    if ("select"==$type)
    {
      if (isset($this-&gt;results[$hash]))
      {
        if (is_resource($this-&gt;results[$hash]))
        return $this-&gt;results[$hash];
      }
    }
    else if("update"==$type || "delete"==$type)<a id="id447" class="indexterm"/>
    {
      $this-&gt;results = array(); //clear the result cache
    }
    $this-&gt;results[$hash] = sqlite_query($sql,$this-&gt;connection);
  }

  private function prepQuery($sql)
  {
    return $sql;
  }

  public function escape($sql)
  {
    if (function_exists('sqlite_escape_string'))
    {
      return sqlite_escape_string($sql);
    }
    else
    {
      return addslashes($sql);
    }
  }

  public function affectedRows()
  {
    return sqlite_changes($this-&gt;connection);
  }

  public function insertId()
  {
    return @sqlite_last_insert_rowid($this-&gt;connection);
  }

  public function transBegin()
  {
    $this-&gt;execute('BEGIN TRANSACTION');
  }

  public function transCommit()
  {
    $this-&gt;execute('COMMIT');
  }
  public function transRollback()
  {
    $this-&gt;execute('COMMIT');
  }

  public function getRow($fetchmode = FETCH_ASSOC)
  {
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    if (FETCH_ASSOC == $fetchmode)
    $row = sqlite_fetch_array($lastresult,SQLITE_ASSOC);
    elseif (FETCH_ROW == $fetchmode)
    $row = sqlite_fetch_array($lastresult, SQLITE_NUM);
    elseif (FETCH_OBJECT == $fetchmode)
    $row = sqlite_fetch_object($lastresult);
    else
    $row = sqlite_fetch_array($lastresult,SQLITE_BOTH);
    return $row;
  }<a id="id448" class="indexterm"/>

  public function getRowAt($offset=null,$fetchmode = FETCH_ASSOC)
  {
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    if (!empty($offset))
  {    
      sqlite_seek($lastresult, $offset);
    }
    return $this-&gt;getRow($fetchmode);
  }

  public function rewind()
  {
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    sqlite_rewind($lastresult);
  }

  public function getRows($start, $count, $fetchmode = FETCH_ASSOC)
  {
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    sqlite_seek($lastresult, $start);
    $rows = array();
    for ($i=$start; $i&lt;=($start+$count); $i++)
    {
      $rows[] = $this-&gt;getRow($fetchmode);
    }
    return $rows;
  }
}
?&gt;</pre></div><p>If you take a look at the code, you will find that we just implemented all the functions described in <code class="literal">abstractdbdriver</code> object in <code class="literal">abstractdbdriver.php</code>.<a id="id449" class="indexterm"/>
</p><p>Here comes the driver file for MySQL, <code class="literal">core/main/dbdrivers/mysqldriver.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?
class mysqldriver extends abstractdbdriver 
{
  public function __construct($dbinfo)
  {
    if (!empty($dbinfo['dbname']))
    {
      if ($dbinfo['persistent'])
      $this-&gt;connection = 
                mysql_pconnect($dbinfo['dbhost'],$dbinfo['dbuser'],
                $dbinfo['dbpwd']);
      else
      $this-&gt;connection = 
                mysql_connect($dbinfo['dbhost'],$dbinfo['dbuser'],
                $dbinfo['dbpwd']);
      mysql_select_db($dbinfo['dbname'],$this-&gt;connection);
    }
    else
    throw new Exception("You must supply username, password, 
           hostname and database name for connecting to mysql");
  }

  public function execute($sql)
  {
    $sql = $this-&gt;prepQuery($sql);
    $parts = split(" ",trim($sql));
    $type = strtolower($parts[0]);
    $hash = md5($sql);
    $this-&gt;lasthash = $hash;

    if ("select"==$type)
    {
      if (isset($this-&gt;results[$hash]))
      {
        if (is_resource($this-&gt;results[$hash]))
        return $this-&gt;results[$hash];
      }
    }
    else if("update"==$type || "delete"==$type)
    {
      $this-&gt;results = array(); //clear the result cache
    }
    $this-&gt;results[$hash] = mysql_query($sql,$this-&gt;connection);

  }<a id="id450" class="indexterm"/>

  public function count()
  {
    //print_r($this);
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    //print_r($this-&gt;results);
    $count = mysql_num_rows($lastresult);
    if (!$count) $count = 0;
    return $count;
  }

  private  function prepQuery($sql)
  {
    // "DELETE FROM TABLE" returns 0 affected rows.
    // This hack modifies the query so that
    // it returns the number of affected rows
    if (preg_match('/^\s*DELETE\s+FROM\s+(\S+)\s*$/i', $sql))
    {
      $sql = preg_replace("/^\s*DELETE\s+FROM\s+(\S+)\s*$/", 
                           "DELETE FROM \\1 WHERE 1=1", $sql);
    }

    return $sql;
  }

  public function escape($sql)
  {
    if (function_exists('mysql_real_escape_string'))
    {
      return mysql_real_escape_string($sql, $this-&gt;conn_id);
    }
    elseif (function_exists('mysql_escape_string'))
    {
      return mysql_escape_string( $sql);
    }
    else
    {
      return addslashes($sql);
    }
  }
  public function affectedRows()
  {
    return @mysql_affected_rows($this-&gt;connection);
  }<a id="id451" class="indexterm"/>
  public function insertId()
  {
    return @mysql_insert_id($this-&gt;connection);
  }

  public function transBegin()
  {
    $this-&gt;execute('SET AUTOCOMMIT=0');
    $this-&gt;execute('START TRANSACTION'); // can also be BEGIN or 
                                         // BEGIN WORK
    return TRUE;
  }

  public function transCommit()
  {
    $this-&gt;execute('COMMIT');
    $this-&gt;execute('SET AUTOCOMMIT=1');
    return TRUE;
  }

  public function transRollback()
  {
    $this-&gt;execute('ROLLBACK');
    $this-&gt;execute('SET AUTOCOMMIT=1');
    return TRUE;
  }

  public function getRow($fetchmode = FETCH_ASSOC)
  {

    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    if (FETCH_ASSOC == $fetchmode)
    $row = mysql_fetch_assoc($lastresult);
    elseif (FETCH_ROW == $fetchmode)
    $row = mysql_fetch_row($lastresult);
    elseif (FETCH_OBJECT == $fetchmode)
    $row = mysql_fetch_object($lastresult);
    else
    $row = mysql_fetch_array($lastresult,MYSQL_BOTH);
    return $row;
  }

  public function getRowAt($offset=null,$fetchmode = FETCH_ASSOC)
  {
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    if (!empty($offset))
    {
      mysql_data_seek($lastresult, $offset);
    }
    return $this-&gt;getRow($fetchmode);
  }<a id="id452" class="indexterm"/>

  public function rewind()
  {
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    mysql_data_seek($lastresult, 0);
  }

  public function getRows($start, $count, $fetchmode = FETCH_ASSOC)
  {
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    mysql_data_seek($lastresult, $start);
    $rows = array();
    for ($i=$start; $i&lt;=($start+$count); $i++)
    {
      $rows[] = $this-&gt;getRow($fetchmode);
    }
    return $rows;
  }

  function __destruct(){
    foreach ($this-&gt;results as $result)
    {
      @mysql_free_result($result);
    }
  }

}
?&gt;</pre></div><p>And finally, here comes the PostgreSQL driver, <code class="literal">core/main/dbdrivers/postgresql.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?
class pgsqldriver extends abstractdbdriver 
{

  public function __construct($dbinfo)
  {
    if (!empty($dbinfo['dbname']))
    {
      if ($dbinfo['persistent'])
      $this-&gt;connection = pg_pconnect("host={$dbinfo['dbname']} 
      port=5432 dbname={$dbinfo['dbname']} user={$dbinfo['$dbuser']} 
      password={$dbinfo['dbpwd']}");
      else
      $this-&gt;connection = pg_connect("host={$dbinfo['dbname']} 
      port=5432 dbname={$dbinfo['dbname']} user={$dbinfo['$dbuser']} 
      password={$dbinfo['dbpwd']}");
    }
    else
    throw new Exception("You must supply username, password, 
    hostname and database name for connecting to postgresql");
  }<a id="id453" class="indexterm"/>

  public function execute($sql)
  {
    $sql = $this-&gt;prepQuery($sql);
    $parts = split(" ",trim($sql));
    $type = strtolower($parts[0]);
    $hash = md5($sql);
    $this-&gt;lasthash = $hash;

    if ("select"==$type)
    {
      if (isset($this-&gt;results[$hash]))
      {
        if (is_resource($this-&gt;results[$hash]))
        return $this-&gt;results[$hash];
      }
    }
    else if("update"==$type || "delete"==$type)
    {
      $this-&gt;results = array(); //clear the result cache
    }
    $this-&gt;results[$hash] = pg_query($this-&gt;connection,$sql);
  }

  public function count()
  {
    //print_r($this);
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    //print_r($this-&gt;results);
    $count = pg_num_rows($lastresult);
    if (!$count) $count = 0;
    return $count;
  }

  private function prepQuery($sql)
  {
    // "DELETE FROM TABLE" returns 0 affected rows this hack modifies
    // the query so that it returns the number of affected rows
    if (preg_match('/^\s*DELETE\s+FROM\s+(\S+)\s*$/i', $sql))
    {
      $sql = preg_replace("/^\s*DELETE\s+FROM\s+(\S+)\s*$/", 
                         "DELETE FROM \\1 WHERE 1=1", $sql);
    }<a id="id454" class="indexterm"/>

    return $sql;
  }

  public function escape($sql)
  {
    if (function_exists('pg_escape_string'))
    {
      return pg_escape_string( $sql);
    }
    else
    {
      return addslashes($sql);
    }
  }

  public function affectedRows()
  {
    return @pg_affected_rows($this-&gt;connection);
  }

  public function insertId($table=null, $column=null)
  {
    $_temp = $this-&gt;lasthash;
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    $this-&gt;execute("SELECT version() AS ver");

    $row = $this-&gt;getRow();
    $v = $row['server'];

    $table = func_num_args() &gt; 0 ? func_get_arg(0) : null;
    $column = func_num_args() &gt; 1 ? func_get_arg(1) : null;

    if ($table == null &amp;&amp; $v &gt;= '8.1')
    {
      $sql='SELECT LASTVAL() as ins_id';
    }
    elseif ($table != null &amp;&amp; $column != null &amp;&amp; $v &gt;= '8.0')
    {
      $sql = sprintf("SELECT pg_get_serial_sequence('%s','%s') as 
                                           seq", $table, $column);
      $this-&gt;execte($sql);
      $row = $this-&gt;getRow();
      $sql = sprintf("SELECT CURRVAL('%s') as ins_id", $row['seq']);
    }
    elseif ($table != null)
    {<a id="id455" class="indexterm"/>
      // seq_name passed in table parameter
      $sql = sprintf("SELECT CURRVAL('%s') as ins_id", $table);
    }
    else
    {
      return pg_last_oid($lastresult);
    }
    $this-&gt;execute($sql);
    $row = $this-&gt;getRow();
    $this-&gt;lasthash = $_temp;
    return $row['ins_id'];
  }

  public function transBegin()
  {
    return @pg_exec($this-&gt;connection, "BEGIN");
    return TRUE;
  }

  public function transCommit()
  {
    return @pg_exec($this-&gt;connection, "COMMIT");
    return TRUE;
  }

  public function transRollback()
  {
    return @pg_exec($this-&gt;connection, "ROLLBACK");
    return TRUE;
  }

  public function getRow($fetchmode = FETCH_ASSOC)
  {

    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    if (FETCH_ASSOC == $fetchmode)
    $row = pg_fetch_assoc($lastresult);
    elseif (FETCH_ROW == $fetchmode)
    $row = pg_fetch_row($lastresult);
    elseif (FETCH_OBJECT == $fetchmode)
    $row = pg_fetch_object($lastresult);
    else
    $row = pg_fetch_array($lastresult,PGSQL_BOTH);
    return $row;
  }<a id="id456" class="indexterm"/>

  public function getRowAt($offset=null,$fetchmode = FETCH_ASSOC)
  {
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    if (!empty($offset))
    {
       pg_result_seek($lastresult, $offset);
    }
    return $this-&gt;getRow($fetchmode);
  }

  public function rewind()
  {
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    pg_result_seek($lastresult, 0);
  }

  public function getRows($start, $count, $fetchmode = FETCH_ASSOC)
  {
    $lastresult = $this-&gt;results[$this-&gt;lasthash];
    $rows = array();
    for ($i=$start; $i&lt;=($start+$count); $i++)
    {
      $rows[] = $this-&gt;getRowAt($i,$fetchmode);
    }
    return $rows;
  }

  function __destruct(){
    foreach ($this-&gt;results as $result)
    {
      @pg_free_result($result);
    }
  }

}
?&gt;<a id="id457" class="indexterm"/>
</pre></div><p>Now our framework is done. In the coming sections, we will see how to build applications over this framework. </p></div></div>
<div class="section" title="Building Applications over our Framework"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec89"/>Building Applications over our Framework</h1></div></div></div><a id="id458" class="indexterm"/><p>Now is the colourful moment. So far, we have done so many things to ease developing applications over our framework. So now in this section we will develop a basic blog application and discuss how to take advantage of our framework. </p><p>For those unfamiliar with Blogs, they are simply web-based publishing systems, where people are allowed to write anything and publish it. In this application we will allow users to write articles, display them, and also allow users to publish comments. </p><p>Let's create a MySQL database named <code class="literal">packtblog</code> with three tables; <code class="literal">Users</code>, <code class="literal">Posts</code>, and <code class="literal">Comments</code>. Here is the database schema:</p><div class="informalexample"><pre class="programlisting">Table: Posts
+---------+--------------+------+-----+---------+----------------+
| Field   | Type         | Null | Key | Default | Extra          |
+---------+--------------+------+-----+---------+----------------+
| id      | int(11)      | NO   | PRI | NULL    | auto_increment |
| title   | varchar(250) | YES  |     | NULL    |                |
| content | text         | YES  |     | NULL    |                |
| user_id | int(11)      | YES  |     | NULL    |                |
| date    | int(11)      | YES  |     | NULL    |                |
+---------+--------------+------+-----+---------+----------------+

Table: Comments
+---------+--------------+------+-----+---------+----------------+
| Field   | Type         | Null | Key | Default | Extra          |
+---------+--------------+------+-----+---------+----------------+
| id      | int(11)      | NO   | PRI | NULL    | auto_increment |
| post_id | int(11)      | YES  |     | NULL    |                |
| content | text         | YES  |     | NULL    |                |
| date    | int(11)      | YES  |     | NULL    |                |
| author  | varchar(250) | YES  |     | NULL    |                |
+---------+--------------+------+-----+---------+----------------+

Table: Users<a id="id459" class="indexterm"/>
+----------+--------------+------+-----+---------+----------------+
| Field    | Type         | Null | Key | Default | Extra          |
+----------+--------------+------+-----+---------+----------------+
| id       | int(11)      | NO   | PRI | NULL    | auto_increment |
| name     | varchar(100) | YES  |     | NULL    |                |
| fullname | varchar(250) | YES  |     | NULL    |                |
| email    | varchar(250) | YES  |     | NULL    |                |
| password | varchar(32)  | YES  |     | NULL    |                |
+----------+--------------+------+-----+---------+----------------+</pre></div><div class="section" title="Authentication Controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec46"/>Authentication Controller</h2></div></div></div><a id="id460" class="indexterm"/><p>Let's design our main controller with users who, will be able to register, or log into, their system. The code in the <code class="literal">app/controllers/auth.php</code> file is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?
session_start();
class auth extends controller
{
  public $use_layout = false;
  function base()
  {

  }

  public function login()
  {
    //$this-&gt;redirect("auth");
    $this-&gt;view-&gt;set("message","");
    if(!empty($_SESSION['userid']))
    {
      $this-&gt;redirect("blog","display");
    }
    else if (!empty($_POST))
    {
      $user = $this-&gt;model-&gt;user;
      $userdata = $user-&gt;find(array("name"=&gt;$user-&gt;name,
                          "password"=&gt;md5($user-&gt;password)));
      if (!$userdata)
      {
        //not found
        $this-&gt;view-&gt;set("message","Wrong username and password");
      }
      else 
      {
        $_SESSION['userid']=$userdata['id'];
        $this-&gt;redirect("blog","display");
      }
    }
  }
<a id="id461" class="indexterm"/>
  public function register()
  {
    if(!empty($_POST)){
      $user = $this-&gt;model-&gt;user;
      if (!$user-&gt;find(array("name"=&gt;$user-&gt;name))){
        $user-&gt;password = md5($user-&gt;password);
        $user-&gt;insert();
      }
    }
  }
}
?&gt;</pre></div><p>Here are the views for authentication controller:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>app/views/auth/base.php</strong></span>
&lt;h1&gt;
  Please &lt;a href='&lt;?=$base_url?&gt;/auth/login'&gt;login&lt;/a&gt; or 
         &lt;a href='&lt;?=$base_url?&gt;/auth/register'&gt;register&lt;/a&gt;
&lt;/h1&gt;</pre></div><p>This will display the following screen:</p><div class="mediaobject"><img src="graphics/2561_09_01.jpg" alt="Authentication Controller"/></div><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>app/views/auth/login.php</strong></span>
&lt;h1&gt;Please login&lt;/h1&gt;
&lt;font color="red"&gt;&lt;?=$message;?&gt;&lt;/font&gt;&lt;br/&gt;
&lt;form method="POST"&gt;
  Username:&lt;br/&gt;
  &lt;input type="text" name="name"/&gt;&lt;br/&gt;
  Password: &lt;br/&gt;
  &lt;input type="password" name="password" /&gt;&lt;br/&gt;
  &lt;input type="submit" name="Submit" value="Login" /&gt;
&lt;/form&gt;</pre></div><p>T<a id="id462" class="indexterm"/>his will display the following screen:</p><div class="mediaobject"><img src="graphics/2561_09_02.jpg" alt="Authentication Controller"/></div><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>app/views/auth/register.php</strong></span>
&lt;h1&gt;Please register your account&lt;/h1&gt;&lt;br/&gt;

&lt;form method="POST"&gt;
  Your username: &lt;br/&gt;
  &lt;input type="text" name="name" /&gt;&lt;br/&gt;
  Password: &lt;br/&gt;
  &lt;input type="password" name="password" /&gt;&lt;br/&gt;
  Fullname: &lt;br/&gt;
  &lt;input type="text" name="fullname" /&gt;&lt;br/&gt;
  Email: &lt;br/&gt;
  &lt;input type="text" name="email" /&gt;&lt;br/&gt;
  &lt;input type="submit"  name="submit" value="Register"/&gt;
&lt;/form&gt;</pre></div><p>This will display the following screen:</p><div class="mediaobject"><img src="graphics/2561_09_03.jpg" alt="Authentication Controller"/></div><p>Now comes the controller which will handle the blog operations</p><p>The<a id="id463" class="indexterm"/> code in the <code class="literal">app/controllers/blog.php</code> is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?
session_start();
class blog extends controller 
{
  public function display()
  {
    $user = $_SESSION['userid'];
    $posts = $this-&gt;model-&gt;post-&gt;find(array("user_id"=&gt;$user),10);
		
    if(!$posts)
    {
      $this-&gt;redirect("blog","write");
    }
    else 
    {
      foreach ($posts as &amp;$post)
      {
        $post['comments']=$this-&gt;model-&gt;comment-&gt;find
                            (array("post_id"=&gt;$post['id']));
      }
      $this-&gt;view-&gt;set("posts",$posts);
    }
  }
	
  public function post()
  {
    $postid= $this-&gt;params['0'];
    if (count($_POST)&gt;1)
    {
      $comment = $this-&gt;model-&gt;comment;
      $comment-&gt;date = time();
      $comment-&gt;post_id = $postid;
      $comment-&gt;insert();
    }
	
    $post = $this-&gt;model-&gt;post-&gt;find(array("id"=&gt;$postid));
    if (!empty($postid))
    {
      $post[0]['comments'] = $this-&gt;model-&gt;comment-&gt;find
                              (array("post_id"=&gt;$postid),100);
    }
	
    $this-&gt;view-&gt;set("message","");
    $this-&gt;view-&gt;set("post",$post[0]);
    //die($postid);
		
  }
	
  public function write()
  {
    $this-&gt;view-&gt;set("color","green");
    if (!empty($_POST))
    {
      $post = $this-&gt;model-&gt;post;
      $post-&gt;user_id=$_SESSION['userid'];
      $post-&gt;date = time();
      $post-&gt;insert();
      $this-&gt;view-&gt;set("color","green");
      $this-&gt;view-&gt;set("message","Successfully saved 
                                        your blog post");
    }
  }
}
?&gt;</pre></div><p>And<a id="id464" class="indexterm"/> here are the views of our blog controller:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>app/views/blog/display.php</strong></span>
&lt;?
foreach ($posts as $post)
{
  echo "&lt;div id='post{$post['id']}' &gt;";
  echo "&lt;b&gt;&lt;a href='{$base_url}/blog/post/{$post['id']}'&gt;
                          {$post['title']}&lt;/a&gt;&lt;/b&gt;&lt;br/&gt;";
  echo "&lt;p&gt;".nl2br($post['content'])."&lt;/p&gt;";
  echo "Number of comments: ".(count($post['comments']));
  echo "&lt;/div&gt;";
}
?&gt;</pre></div><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>app/views/blog/post.php</strong></span>
&lt;?
  echo "&lt;div id='post{$post['id']}' &gt;";
  echo "&lt;b&gt;&lt;a href='{$base_url}/blog/post/{$post['id']}'&gt;
                          {$post['title']}&lt;/a&gt;&lt;/b&gt;&lt;br/&gt;";
  echo "&lt;p&gt;".nl2br($post['content'])."&lt;/p&gt;";
  echo "Number of comments: ".(count($post['comments']));
  echo "&lt;/div&gt;";
  foreach ($post['comments'] as $comment)
  {
    echo "&lt;div style='padding:10px;margin-top:10px; 
    border:1px solid #cfcfcf;'&gt;";
    $time = date("Y-m-d",$comment['date']);
    echo "Posted by {$comment['author']} at {$time}:&lt;br/&gt;";
    echo "{$comment['content']}";
    echo "&lt;/div&gt;";
  }

?&gt; 
&lt;h<a id="id465" class="indexterm"/>2&gt;Post a new comment&lt;/h2&gt;
&lt;font color="red"&gt;&lt;?=$message;?&gt;&lt;/font&gt;&lt;br/&gt;
&lt;form method="POST"&gt;
  Name:&lt;br/&gt;
  &lt;input type="text" name="author"/&gt;&lt;br/&gt;
  Comment: &lt;br/&gt;
  &lt;textarea rows="5" cols="60" name="content" &gt;&lt;/textarea&gt;&lt;br/&gt;
  &lt;input type="submit" /&gt;
&lt;/form&gt;</pre></div><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>app/views/blog/write.php</strong></span>
&lt;h1&gt;Write a new blog post&lt;/h1&gt;
&lt;font color="&lt;?=$color;?&gt;"&gt;&lt;?=$message;?&gt;&lt;/font&gt;&lt;br/&gt;
&lt;form method="POST"&gt;
  Title:&lt;br/&gt;
  &lt;input type="text" name="title"/&gt;&lt;br/&gt;
  Content: &lt;br/&gt;
  &lt;textarea rows="5" cols="60" name="content" &gt;&lt;/textarea&gt;&lt;br/&gt;

  &lt;input type="submit" value="save"  /&gt;
&lt;/form&gt;</pre></div><p>This will display the following form:</p><div class="mediaobject"><img src="graphics/2561_09_04.jpg" alt="Authentication Controller"/></div><p>And <a id="id466" class="indexterm"/>last but not the least here comes the <code class="literal">config</code> file. Place it in <code class="literal">app/config/configs.php</code> or <code class="literal">core/config/configs.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?
$configs['use_layout']=false;
$configs['unit_test_enabled']=true;
$configs['default_controller']="welcome";
$configs['global_profile']=true;

/* DB */
$configs['db']['usedb']="mysql";

$configs['db']['development']['dbname']="packtblog";
$configs['db']['development']['dbhost']="localhost";
$configs['db']['development']['dbuser']="root";
$configs['db']['development']['dbpwd']="root1234";
$configs['db']['development']['persistent']=true;
$configs['db']['development']['dbtype']="mysql";
?&gt;</pre></div></div></div>
<div class="section" title="Summary&#x2029;"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec90"/>Summary </h1></div></div></div><p>In the rapid development of PHP applications, frameworks play a very important role. That is why today there are so many enterprise-level frameworks in the market and you have so many choices. We have learnt how to build a framework in this chapter which will also help to understand object loading, data abstraction layers, and the importance of separation. Finally, we took a closer look at how applications are done. </p></div></body></html>