<html><head></head><body>
<div id="_idContainer082">
<h1 class="chapter-number" id="_idParaDest-69"><a id="_idTextAnchor070"/><span class="koboSpan" id="kobo.1.1">5</span></h1>
<h1 id="_idParaDest-70"><a id="_idTextAnchor071"/><span class="koboSpan" id="kobo.2.1">Unit Testing</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Imagine working on a project without any automated tests with a few other developers, and everything seems to be working fine in production. </span><span class="koboSpan" id="kobo.3.2">Then, a bug has been discovered, and one of the developers fixes this bug. </span><span class="koboSpan" id="kobo.3.3">The QA department approves the fix and then is pushed to production. </span><span class="koboSpan" id="kobo.3.4">A few days later, another bug is reported in production. </span><span class="koboSpan" id="kobo.3.5">After investigation, the developers found out that the new bug was introduced by the fix for the other bug. </span><span class="koboSpan" id="kobo.3.6">Does that sound familiar? </span></p>
<p><span class="koboSpan" id="kobo.4.1">One small change in the code base can easily change the behavior of software. </span><span class="koboSpan" id="kobo.4.2">A single decimal point change can cause millions of dollars worth of incorrect computations. </span><span class="koboSpan" id="kobo.4.3">Imagine handballing all these computation checks to the QA department for manual testing – they would have to run these checks every time something had been updated in the code base. </span><span class="koboSpan" id="kobo.4.4">It’s simply inefficient, stressful, and not sustainable. </span></p>
<p><span class="koboSpan" id="kobo.5.1">One of the solutions to this recurring issue is unit testing. </span><span class="koboSpan" id="kobo.5.2">Writing unit test programs will help us developers verify whether our own programs are correct or not. </span><span class="koboSpan" id="kobo.5.3">By repeatedly running unit tests, we will also be able to catch problems very early during development if we break other existing tests. </span><span class="koboSpan" id="kobo.5.4">If we accidentally change the expected behavior of a function, and if we’ve written unit tests properly for this function before, then we can be confident that we will break those tests. </span><span class="koboSpan" id="kobo.5.5">This, to me, is amazing. </span><span class="koboSpan" id="kobo.5.6">I want to know that if I break something, I won’t push my code for final verification to the QA or testing department until I am confident that I have not compromised any existing sets of unit tests. </span><span class="koboSpan" id="kobo.5.7">For large products, this will save the QA or testing department a lot of man-hours, even if there are automated end-to-end and user interface-to-backend tests. </span></p>
<p><span class="koboSpan" id="kobo.6.1">There are different types of tests that we will be discussing in this chapter as well, but the unit tests are the foundations of those other automated </span><span class="No-Break"><span class="koboSpan" id="kobo.7.1">test types.</span></span></p>
<p><span class="koboSpan" id="kobo.8.1">In this chapter, we will be covering the </span><span class="No-Break"><span class="koboSpan" id="kobo.9.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.10.1">Defining </span><span class="No-Break"><span class="koboSpan" id="kobo.11.1">unit tests</span></span></li>
<li><span class="koboSpan" id="kobo.12.1">Writing and running </span><span class="No-Break"><span class="koboSpan" id="kobo.13.1">unit tests</span></span></li>
<li><span class="koboSpan" id="kobo.14.1">Setting up test </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">coverage monitoring</span></span></li>
<li><span class="koboSpan" id="kobo.16.1">What are the different types </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">of tests?</span></span></li>
<li><span class="koboSpan" id="kobo.18.1">Utilizing dependency injection and mocking on </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">integration tests</span></span></li>
</ul>
<h1 id="_idParaDest-71"><a id="_idTextAnchor072"/><span class="koboSpan" id="kobo.20.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.21.1">This chapter requires you to have all the containers we have previously built, and PHPStorm IDE configurations that were defined in </span><a href="B18318_03.xhtml#_idTextAnchor039"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.22.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.23.1">, </span><em class="italic"><span class="koboSpan" id="kobo.24.1">Setting Up Our Development Environment Using Docker Containers</span></em><span class="koboSpan" id="kobo.25.1">. </span><span class="koboSpan" id="kobo.25.2">You can simply download the development environment setup from GitHub and follow the instructions mentioned in </span><a href="B18318_03.xhtml#_idTextAnchor039"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.26.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.27.1">, </span><em class="italic"><span class="koboSpan" id="kobo.28.1">Setting Up Our Development Environment Using Docker </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.29.1">Containers</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">: </span></span><a href="https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%203"><span class="No-Break"><span class="koboSpan" id="kobo.31.1">https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%203</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.32.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.33.1">In this chapter, it’s also required that you understand how to use </span><strong class="bold"><span class="koboSpan" id="kobo.34.1">Object Relational Mappers</span></strong><span class="koboSpan" id="kobo.35.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.36.1">ORMs</span></strong><span class="koboSpan" id="kobo.37.1">), and the author assumes that you have experience working with </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">MySQL databases.</span></span></p>
<p><span class="koboSpan" id="kobo.39.1">It is also required for you to be familiar with PSR-11, and the use of service containers. </span><span class="koboSpan" id="kobo.39.2">More information about PSR-11 can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">at </span></span><a href="https://www.php-fig.org/psr/psr-11/"><span class="No-Break"><span class="koboSpan" id="kobo.41.1">https://www.php-fig.org/psr/psr-11/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.42.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.43.1">All the code files related to this chapter can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">at </span></span><a href="https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%203"><span class="No-Break"><span class="koboSpan" id="kobo.45.1">https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%203</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.46.1">.</span></span></p>
<h2 id="_idParaDest-72"><a id="_idTextAnchor073"/><span class="koboSpan" id="kobo.47.1">Preparing the development environment for the chapter</span></h2>
<p><span class="koboSpan" id="kobo.48.1">First, get the base code for </span><a href="B18318_05.xhtml#_idTextAnchor070"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.49.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.50.1">, found at </span><a href="https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%203"><span class="koboSpan" id="kobo.51.1">https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%203</span></a><span class="koboSpan" id="kobo.52.1"> or simply run the </span><span class="No-Break"><span class="koboSpan" id="kobo.53.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.54.1">
curl -Lo phptdd.zip "https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/raw/main/Chapter%205/base.zip" &amp;&amp; unzip -o phptdd.zip &amp;&amp; cd base &amp;&amp; ./demoSetup.sh</span></pre>
<p><span class="koboSpan" id="kobo.55.1">To run the containers, and execute the commands in this chapter, the reader should be inside the </span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.56.1">
docker-server-web-1 container.</span></pre>
<p><span class="koboSpan" id="kobo.57.1">To run the containers and execute the commands in this chapter, you should be inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.58.1">docker-server-web-1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.59.1"> container.</span></span></p>
<p><span class="koboSpan" id="kobo.60.1">Run the following command to confirm the container name for our </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">web server:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.62.1">
docker ps</span></pre>
<p><span class="koboSpan" id="kobo.63.1">To run the containers, run the following command from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.64.1">/phptdd/docker</span></strong><span class="koboSpan" id="kobo.65.1"> directory from the repository in your </span><span class="No-Break"><span class="koboSpan" id="kobo.66.1">host machine:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.67.1">
docker-compose build &amp;&amp; docker-compose up -d
docker exec -it docker_server-web_1 /bin/bash</span></pre>
<p><span class="koboSpan" id="kobo.68.1">Once inside the container, run the following commands to install the libraries required </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">through </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.70.1">composer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.71.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.72.1">
/var/www/html/symfony# ./setup.sh</span></pre>
<h1 id="_idParaDest-73"><a id="_idTextAnchor074"/><span class="koboSpan" id="kobo.73.1">Defining unit tests</span></h1>
<p><span class="koboSpan" id="kobo.74.1">A unit test </span><a id="_idIndexMarker158"/><span class="koboSpan" id="kobo.75.1">is a program that specifically tests a unit of your solution code. </span><span class="koboSpan" id="kobo.75.2">Just think of it as a program that tests a function and does not depend on other objects in your project. </span></p>
<p><span class="koboSpan" id="kobo.76.1">For example, if you have a function called </span><strong class="source-inline"><span class="koboSpan" id="kobo.77.1">calculateTotal($a, $b, $c)</span></strong><span class="koboSpan" id="kobo.78.1">, then you can write a unit test function for it called </span><strong class="source-inline"><span class="koboSpan" id="kobo.79.1">testCanCalculateTotal()</span></strong><span class="koboSpan" id="kobo.80.1">. </span><span class="koboSpan" id="kobo.80.2">This unit test’s job is to verify whether the </span><strong class="source-inline"><span class="koboSpan" id="kobo.81.1">calculateTotal($a, $b, $c)</span></strong><span class="koboSpan" id="kobo.82.1"> function is returning the expected result based on the business rules defined by your </span><span class="No-Break"><span class="koboSpan" id="kobo.83.1">project’s specification.</span></span></p>
<p><span class="koboSpan" id="kobo.84.1">In this example, let’s assume that the expected behavior of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.85.1">calculateTotal</span></strong><span class="koboSpan" id="kobo.86.1"> function is to get the summation of the three parameters, </span><strong class="source-inline"><span class="koboSpan" id="kobo.87.1">$a</span></strong><span class="koboSpan" id="kobo.88.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.89.1">$b</span></strong><span class="koboSpan" id="kobo.90.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.92.1">$c</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.94.1">Let’s create an example </span><a id="_idIndexMarker159"/><span class="koboSpan" id="kobo.95.1">unit test and solution codes. </span><span class="koboSpan" id="kobo.95.2">Create the following file inside our </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">development container:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.97.1">codebase/symfony/tests/Unit/CalculationTest.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.98.1">
&lt;?php
namespace App\Tests\Unit;
use App\Example\Calculator;
use PHPUnit\Framework\TestCase;
class CalculationTest extends TestCase
{
    public function testCanCalculateTotal()
    {
        // Expected result:
        $expectedTotal = 6;
        // Test data:
        $a = 1;
        $b = 2;
        $c = 3;
        $calculator = new Calculator();
        $total      = $calculator-&gt;calculateTotal($a, $b, 
            $c);
        $this-&gt;assertEquals($expectedTotal, $total);
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.99.1">The test class name needs to be suffixed with </span><strong class="source-inline"><span class="koboSpan" id="kobo.100.1">Test</span></strong><span class="koboSpan" id="kobo.101.1">, and it extends the </span><strong class="source-inline"><span class="koboSpan" id="kobo.102.1">PHPUnit\Framework\TestCase</span></strong><span class="koboSpan" id="kobo.103.1"> class. </span><span class="koboSpan" id="kobo.103.2">By doing so, we are now using the </span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">PHPUnit library.</span></span></p>
<p><span class="koboSpan" id="kobo.105.1">Next, let’s try to </span><a id="_idIndexMarker160"/><span class="koboSpan" id="kobo.106.1">run this unit test and see what happens. </span><span class="koboSpan" id="kobo.106.2">Run the following command while inside the container. </span><span class="koboSpan" id="kobo.106.3">The instructions on how to do all this are in </span><a href="B18318_03.xhtml#_idTextAnchor039"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.107.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.108.1">, </span><em class="italic"><span class="koboSpan" id="kobo.109.1">Setting Up Our Development Environment Using </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.110.1">Docker Containers</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.112.1">
/var/www/html/symfony# php bin/phpunit –filter testCanCalculateTotal</span></pre>
<p><span class="koboSpan" id="kobo.113.1">The result will be </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">an error:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer058">
<span class="koboSpan" id="kobo.115.1"><img alt="Figure 5.1 – Fail 1 (class not found)" src="image/Figure_5.01_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.116.1">Figure 5.1 – Fail 1 (class not found)</span></p>
<p><span class="koboSpan" id="kobo.117.1">Our unit test has </span><a id="_idIndexMarker161"/><span class="koboSpan" id="kobo.118.1">failed as expected – this is good! </span><span class="koboSpan" id="kobo.118.2">You’ll notice that we tried to instantiate a class that does not exist, so let’s now create that class and write the function to do </span><span class="No-Break"><span class="koboSpan" id="kobo.119.1">the calculation.</span></span></p>
<p><span class="koboSpan" id="kobo.120.1">Create the following solution class inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.121.1">codebase/symfony/src/Example/</span></strong><span class="koboSpan" id="kobo.122.1"> directory that we </span><span class="No-Break"><span class="koboSpan" id="kobo.123.1">previously created:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.124.1">codebase/symfony/src/Example/Calculator.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.125.1">
&lt;?php
namespace App\Example;
class Calculator
{
    public function calculateTotal(int $a, int $b, int $c) 
        : int
    {
        return $a + $b - $c;
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.126.1">After creating the solution class with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">calculateTotal</span></strong><span class="koboSpan" id="kobo.128.1"> function, let’s try to run the test again by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.130.1">
/var/www/html/symfony# php bin/phpunit –filter testCanCalculateTotal</span></pre>
<p><span class="koboSpan" id="kobo.131.1">We will get the </span><a id="_idIndexMarker162"/><span class="koboSpan" id="kobo.132.1">following </span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">failing result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer059">
<span class="koboSpan" id="kobo.134.1"><img alt="Figure 5.2 – Fail 2 (incorrect result)" src="image/Figure_5.02_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.135.1">Figure 5.2 – Fail 2 (incorrect result)</span></p>
<p><span class="koboSpan" id="kobo.136.1">PHPUnit will tell us why the test has failed. </span><span class="koboSpan" id="kobo.136.2">You’ll notice that it says: </span><strong class="bold"><span class="koboSpan" id="kobo.137.1">Failed asserting that 0 matches expected 6.</span></strong><span class="koboSpan" id="kobo.138.1">. </span><span class="koboSpan" id="kobo.138.2">Why is that? </span><span class="koboSpan" id="kobo.138.3">Well, this is </span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">what happened.</span></span></p>
<p><span class="koboSpan" id="kobo.140.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.141.1">testCanCalculateTotal</span></strong><span class="koboSpan" id="kobo.142.1"> unit test, we have declared </span><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">$expectedTotal</span></strong><span class="koboSpan" id="kobo.144.1"> to be </span><strong class="source-inline"><span class="koboSpan" id="kobo.145.1">6</span></strong><span class="koboSpan" id="kobo.146.1">. </span><span class="koboSpan" id="kobo.146.2">We then called the </span><strong class="source-inline"><span class="koboSpan" id="kobo.147.1">calculateTotal</span></strong><span class="koboSpan" id="kobo.148.1"> function and sent the following arguments: </span><strong class="source-inline"><span class="koboSpan" id="kobo.149.1">$a = 1</span></strong><span class="koboSpan" id="kobo.150.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.151.1">$b = 2</span></strong><span class="koboSpan" id="kobo.152.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">$c = 3</span></strong><span class="koboSpan" id="kobo.154.1">. </span><span class="koboSpan" id="kobo.154.2">If the specification you receive instructs you to get the summation of the three parameters within the </span><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">calculateTotal</span></strong><span class="koboSpan" id="kobo.156.1"> function, then the expected result </span><span class="No-Break"><span class="koboSpan" id="kobo.157.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.158.1">6</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.160.1">We then used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">assertEquals</span></strong><span class="koboSpan" id="kobo.162.1"> PHPUnit function, where we told PHPUnit that we were expecting that the expected value would be equal to the calculated value with the </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">following line:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.164.1">
$this-&gt;assertEquals($expectedTotal, $total);</span></pre>
<p><span class="koboSpan" id="kobo.165.1">Assertions are methods or functions that assert or check whether a condition within a test has been satisfied or not. </span><span class="koboSpan" id="kobo.165.2">Like in our example, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.166.1">assertEquals</span></strong><span class="koboSpan" id="kobo.167.1"> method where we tried to compare </span><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">$expectedTotal</span></strong><span class="koboSpan" id="kobo.169.1"> to the actual </span><strong class="source-inline"><span class="koboSpan" id="kobo.170.1">$total</span></strong><span class="koboSpan" id="kobo.171.1"> we received from the solution code. </span><span class="koboSpan" id="kobo.171.2">There are a lot of different types of PHPUnit assertions, and the documentation can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.172.1">here: </span></span><a href="https://phpunit.readthedocs.io/en/9.5/assertions.html"><span class="No-Break"><span class="koboSpan" id="kobo.173.1">https://phpunit.readthedocs.io/en/9.5/assertions.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.174.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.175.1">The unit test correctly expects the expected result to be </span><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">6</span></strong><span class="koboSpan" id="kobo.177.1"> – the problem is that in the solution function, we did not follow the expected behavior. </span><span class="koboSpan" id="kobo.177.2">We subtracted </span><strong class="source-inline"><span class="koboSpan" id="kobo.178.1">$c</span></strong><span class="koboSpan" id="kobo.179.1"> instead of adding it to the summation of </span><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">$a</span></strong><span class="koboSpan" id="kobo.181.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">$b</span></strong><span class="koboSpan" id="kobo.183.1">. </span><span class="koboSpan" id="kobo.183.2">If we fix the function to the following, our test should </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">finally pass:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.185.1">codebase/symfony/src/Example/Calculator.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.186.1">
public function calculateTotal(int $a, int $b, int $c) : int
{
    return $a + $b + $c;
}</span></pre>
<p><span class="koboSpan" id="kobo.187.1">To get the total, we just</span><a id="_idIndexMarker163"/><span class="koboSpan" id="kobo.188.1"> need to get the sum of the three parameters. </span><span class="koboSpan" id="kobo.188.2">Once you update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1">Calculator.php</span></strong><span class="koboSpan" id="kobo.190.1"> file, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.191.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.192.1">
php bin/phpunit --filter testCanCalculateTotal </span></pre>
<p><span class="koboSpan" id="kobo.193.1">We should now see the </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer060">
<span class="koboSpan" id="kobo.195.1"><img alt="Figure 5.3 – Correct result" src="image/Figure_5.03_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.196.1">Figure 5.3 – Correct result</span></p>
<p><span class="koboSpan" id="kobo.197.1">Nice! </span><span class="koboSpan" id="kobo.197.2">We have finally passed the unit test! </span><span class="koboSpan" id="kobo.197.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">assertEquals</span></strong><span class="koboSpan" id="kobo.199.1"> function has confirmed that </span><strong class="source-inline"><span class="koboSpan" id="kobo.200.1">$expectedTotal</span></strong><span class="koboSpan" id="kobo.201.1"> is now equal to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.202.1">$total</span></strong><span class="koboSpan" id="kobo.203.1"> amount returned by the solution codes! </span></p>
<p><span class="koboSpan" id="kobo.204.1">Now, imagine having thousands of these tests. </span><span class="koboSpan" id="kobo.204.2">One unintended change in the behavior of the solution codes will cause one or more unit tests to fail. </span><span class="koboSpan" id="kobo.204.3">This is very valuable. </span><span class="koboSpan" id="kobo.204.4">This will help developers verify the stability of any code change that they implement. </span></p>
<p><span class="koboSpan" id="kobo.205.1">To learn more about PHPUnit, you can visit </span><a id="_idIndexMarker164"/><span class="koboSpan" id="kobo.206.1">their documentation page </span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">at </span></span><a href="https://phpunit.readthedocs.io/"><span class="No-Break"><span class="koboSpan" id="kobo.208.1">https://phpunit.readthedocs.io/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.209.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.210.1">This is one of the most basic examples of the use of a unit test, but we’ll be writing more unit tests and utilizing more PHPUnit features as we continue with the project. </span></p>
<p><span class="koboSpan" id="kobo.211.1">The more tests we </span><a id="_idIndexMarker165"/><span class="koboSpan" id="kobo.212.1">have for our solution codes, the better it is for the stability of the solution. </span><span class="koboSpan" id="kobo.212.2">Therefore, next, we will look into PHPUnit’s code coverage analysis solution. </span><span class="koboSpan" id="kobo.212.3">This will help us get some metrics about how much test coverage we have for </span><span class="No-Break"><span class="koboSpan" id="kobo.213.1">our solution.</span></span></p>
<h1 id="_idParaDest-74"><a id="_idTextAnchor075"/><span class="koboSpan" id="kobo.214.1">Test coverage</span></h1>
<p><span class="koboSpan" id="kobo.215.1">It’s great having unit tests, but if we only test a few parts of the solution, then there’s more chance of breaking the code base unintentionally. </span><span class="koboSpan" id="kobo.215.2">Still, having a few unit tests is better than having </span><a id="_idIndexMarker166"/><span class="koboSpan" id="kobo.216.1">no unit tests. </span><span class="koboSpan" id="kobo.216.2">I’m not aware of a solid industry standard number or percentage of ideal test code coverage. </span><span class="koboSpan" id="kobo.216.3">Some say 80% to 95% test coverage is good, but that depends on the project. </span><span class="koboSpan" id="kobo.216.4">I still believe that 50% test coverage is better than 0% test coverage, and every project can be very different. </span><span class="koboSpan" id="kobo.216.5">The test coverage can be configured to exclude some parts of the code base as well, so having 100% test coverage does not literally mean 100% of all code in the code base is covered by automated tests. </span><span class="koboSpan" id="kobo.216.6">Nonetheless, it’s still good to know how much test coverage we have for our solution. </span><span class="koboSpan" id="kobo.216.7">For developers who are just getting started with unit testing, it’s important to point out that having a few tests is better than not writing unit tests at all. </span><span class="koboSpan" id="kobo.216.8">Don’t be scared or demotivated if your code coverage report gives you a low number; knowing this will at least give you the data or truth about your </span><span class="No-Break"><span class="koboSpan" id="kobo.217.1">test coverage.</span></span></p>
<p><span class="koboSpan" id="kobo.218.1">To let PHPUnit know that a certain </span><a id="_idIndexMarker167"/><span class="koboSpan" id="kobo.219.1">test function tests for a specific solution code, we will be using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">@covers</span></strong><span class="koboSpan" id="kobo.221.1"> annotation. </span><span class="koboSpan" id="kobo.221.2">Annotations in PHP are a type of metadata that is added to classes, functions, properties, and so on. </span><span class="koboSpan" id="kobo.221.3">In PHP, we declare annotations within </span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">documentation blocks.</span></span></p>
<h2 id="_idParaDest-75"><a id="_idTextAnchor076"/><span class="koboSpan" id="kobo.223.1">Declaring annotations</span></h2>
<p><span class="koboSpan" id="kobo.224.1">PHP annotations</span><a id="_idIndexMarker168"/><span class="koboSpan" id="kobo.225.1"> are just like comments – they are used by PHP libraries to get metadata from a function, property, or class in PHP. </span></p>
<p><span class="koboSpan" id="kobo.226.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.227.1">CalculationTest.php</span></strong><span class="koboSpan" id="kobo.228.1"> file and add the following </span><strong class="source-inline"><span class="koboSpan" id="kobo.229.1">@covers</span></strong><span class="koboSpan" id="kobo.230.1"> annotation right above the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.231.1">testCanCalculateTotal</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.232.1"> function:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.233.1">codebase/symfony/tests/Unit/CalculationTest.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.234.1">
/**
 * @covers \App\Example\Calculator::calculateTotal
 */
public function testCanCalculateTotal()</span></pre>
<p><span class="koboSpan" id="kobo.235.1">You’ll notice that we have declared the </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">\App\Example\Calculator::calculateTotal</span></strong><span class="koboSpan" id="kobo.237.1"> class and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">calculateTotal</span></strong><span class="koboSpan" id="kobo.239.1"> method after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.240.1">@covers</span></strong><span class="koboSpan" id="kobo.241.1"> annotation. </span><span class="koboSpan" id="kobo.241.2">We are basically telling PHPUnit that this specific </span><strong class="source-inline"><span class="koboSpan" id="kobo.242.1">testCanCalculateTotal</span></strong><span class="koboSpan" id="kobo.243.1"> test function will </span><em class="italic"><span class="koboSpan" id="kobo.244.1">cover</span></em><span class="koboSpan" id="kobo.245.1"> the method or function inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.246.1">\App\Example\Calculator</span></strong><span class="koboSpan" id="kobo.247.1"> class. </span></p>
<p><span class="koboSpan" id="kobo.248.1">Now, run the following CLI commands to run PHPUnit with </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">test coverage:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.250.1">
/var/www/html/symfony# export XDEBUG_MODE=coverage
/var/www/html/symfony# php bin/phpunit --coverage-text --filter CalculationTest</span></pre>
<p><span class="koboSpan" id="kobo.251.1">This time around, we </span><a id="_idIndexMarker169"/><span class="koboSpan" id="kobo.252.1">added the </span><strong class="source-inline"><span class="koboSpan" id="kobo.253.1">--coverage-text</span></strong><span class="koboSpan" id="kobo.254.1"> option. </span><span class="koboSpan" id="kobo.254.2">We are telling PHPUnit to output the coverage analysis report back to the terminal window. </span><span class="koboSpan" id="kobo.254.3">You will now receive the </span><span class="No-Break"><span class="koboSpan" id="kobo.255.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer061">
<span class="koboSpan" id="kobo.256.1"><img alt="Figure 5.4 – First test coverage" src="image/Figure_5.04_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.257.1">Figure 5.4 – First test coverage</span></p>
<p><span class="koboSpan" id="kobo.258.1">Congratulations! </span><span class="koboSpan" id="kobo.258.2">You </span><a id="_idIndexMarker170"/><span class="koboSpan" id="kobo.259.1">just received your first test coverage report! </span><span class="koboSpan" id="kobo.259.2">This means that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.260.1">calculate</span></strong><span class="koboSpan" id="kobo.261.1"> method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">Calculation.php</span></strong><span class="koboSpan" id="kobo.263.1"> class is covered by a unit test. </span><span class="koboSpan" id="kobo.263.2">However, in real life, we end up having more functions inside a class. </span><span class="koboSpan" id="kobo.263.3">What will happen if we start adding functions to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">Calculation.php</span></strong><span class="koboSpan" id="kobo.265.1"> class? </span><span class="koboSpan" id="kobo.265.2">Well, let’s find out. </span></p>
<h2 id="_idParaDest-76"><a id="_idTextAnchor077"/><span class="koboSpan" id="kobo.266.1">Adding more functions to the solution class</span></h2>
<p><span class="koboSpan" id="kobo.267.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">CalculationTest</span></strong><span class="koboSpan" id="kobo.269.1"> class </span><a id="_idIndexMarker171"/><span class="koboSpan" id="kobo.270.1">we previously created has a test that covers the </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">calculateTotal</span></strong><span class="koboSpan" id="kobo.272.1"> function. </span><span class="koboSpan" id="kobo.272.2">When we ran the coverage test, we received a 100% test coverage result. </span><span class="koboSpan" id="kobo.272.3">If we add more functions to the solution class, we will no longer get a 100% coverage test result. </span><span class="koboSpan" id="kobo.272.4">What does that mean though? </span><span class="koboSpan" id="kobo.272.5">In practice, that means that some parts of our solution class are not covered by our automated test. </span><span class="koboSpan" id="kobo.272.6">It’s not the end of the world, but this will help the developers in a company to identify how much of the system is covered by automated tests. </span><span class="koboSpan" id="kobo.272.7">This will affect the business’s confidence level with the updates in the code base, and thus also affect the amount of manual testing that needs to be done, or how confident the business is about releasing new code. </span></p>
<p><span class="koboSpan" id="kobo.273.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.274.1">Calculation.php</span></strong><span class="koboSpan" id="kobo.275.1"> class </span><a id="_idIndexMarker172"/><span class="koboSpan" id="kobo.276.1">and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.277.1">following method:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.278.1">codebase/symfony/src/Example/Calculator.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.279.1">
&lt;?php
namespace App\Example;
class Calculator
{
    public function calculateTotal(int $a, int $b, int $c) 
        : int
    {
        return $a + $b + $c;
    }
    public function add(int $a, int $b): int
    {
        return $a + $b;
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.280.1">As you</span><a id="_idIndexMarker173"/><span class="koboSpan" id="kobo.281.1"> can see in the preceding code block, we have added a new function called </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">add</span></strong><span class="koboSpan" id="kobo.283.1">. </span><span class="koboSpan" id="kobo.283.2">This function simply returns the summation of </span><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">$a</span></strong><span class="koboSpan" id="kobo.285.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">$b</span></strong><span class="koboSpan" id="kobo.287.1">. </span><span class="koboSpan" id="kobo.287.2">Since we have no unit test for this new function, let’s see what will happen when we run our test again. </span><span class="koboSpan" id="kobo.287.3">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.289.1">
/var/www/html/symfony# php bin/phpunit --coverage-text --filter CalculationTest</span></pre>
<p><span class="koboSpan" id="kobo.290.1">After running the preceding command, we’ll notice that something has changed in our test </span><span class="No-Break"><span class="koboSpan" id="kobo.291.1">coverage result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer062">
<span class="koboSpan" id="kobo.292.1"><img alt="Figure 5.5 ﻿– Test coverage has decreased" src="image/Figure_5.05_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.293.1">Figure 5.5 – Test coverage has decreased</span></p>
<p><span class="koboSpan" id="kobo.294.1">You will notice that before adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.295.1">add</span></strong><span class="koboSpan" id="kobo.296.1"> function inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.297.1">Calculator.php</span></strong><span class="koboSpan" id="kobo.298.1"> class, we had 100% test coverage. </span><span class="koboSpan" id="kobo.298.2">Now, we only have 50% test coverage. </span><span class="koboSpan" id="kobo.298.3">Obviously, it’s because we don’t have a unit test responsible for testing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">add</span></strong><span class="koboSpan" id="kobo.300.1"> function. </span><span class="koboSpan" id="kobo.300.2">To improve our test coverage, let’s add a unit test for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">add</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.302.1"> function:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.303.1">codebase/symfony/tests/Unit/CalculationTest.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.304.1">
&lt;?php
namespace App\Tests\Unit;
use App\Example\Calculator;
use PHPUnit\Framework\TestCase;
class CalculationTest extends TestCase
{
    /**
     * @covers \App\Example\Calculator::calculateTotal
     */
    public function testCanCalculateTotal()
    {
        // Expected result:
        $expectedTotal = 6;
        // Test data:
        $a = 1;
        $b = 2;
        $c = 3;
        $calculator = new Calculator();
        $total      = $calculator-&gt;calculateTotal($a, $b, 
            $c);
        $this-&gt;assertEquals($expectedTotal, $total);
    }
    /**
     * @covers \App\Example\Calculator::add
     */
    public function testCanAddIntegers()
    {
        // Expected Result
        $expectedSum = 7;
        // Test Data
        $a = 2;
        $b = 5;
        $calculator = new Calculator();
        $sum        = $calculator-&gt;add($a, $b);
        $this-&gt;assertEquals($expectedSum, $sum);
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.305.1">In the </span><a id="_idIndexMarker174"/><span class="koboSpan" id="kobo.306.1">preceding code block, we’ve added the </span><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">testCanAddIntegers</span></strong><span class="koboSpan" id="kobo.308.1"> test function. </span><span class="koboSpan" id="kobo.308.2">By using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">@covers</span></strong><span class="koboSpan" id="kobo.310.1"> annotation, we have also declared that this function tests for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.311.1">add</span></strong><span class="koboSpan" id="kobo.312.1"> function in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">Calculation.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.314.1"> class.</span></span></p>
<p><span class="koboSpan" id="kobo.315.1">Let’s run the test again and see whether we have improved our test coverage result. </span><span class="koboSpan" id="kobo.315.2">Run the following </span><span class="No-Break"><span class="koboSpan" id="kobo.316.1">command again:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.317.1">
/var/www/html/symfony# php bin/phpunit --coverage-text --filter CalculationTest</span></pre>
<p><span class="koboSpan" id="kobo.318.1">Now, we should see the </span><span class="No-Break"><span class="koboSpan" id="kobo.319.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer063">
<span class="koboSpan" id="kobo.320.1"><img alt="Figure 5.6 – Back to 100% test coverage" src="image/Figure_5.06_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.321.1">Figure 5.6 – Back to 100% test coverage</span></p>
<p><span class="koboSpan" id="kobo.322.1">Nice! </span><span class="koboSpan" id="kobo.322.2">Now, we </span><a id="_idIndexMarker175"/><span class="koboSpan" id="kobo.323.1">have 100% test coverage again. </span><span class="koboSpan" id="kobo.323.2">We have two functions inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.324.1">Calculation.php</span></strong><span class="koboSpan" id="kobo.325.1"> class, and we also have two unit tests that test for each of these functions. </span></p>
<p><span class="koboSpan" id="kobo.326.1">Now, imagine that you’re working with other developers on a project, which is very common. </span><span class="koboSpan" id="kobo.326.2">If other developers start refactoring a unit-tested class and start adding functions to that class without adding tests to cover them, when your team runs the coverage test, your team will easily and quickly identify that there are new functions or features in that class not covered by the </span><span class="No-Break"><span class="koboSpan" id="kobo.327.1">automated tests.</span></span></p>
<p><span class="koboSpan" id="kobo.328.1">What if you created a </span><strong class="source-inline"><span class="koboSpan" id="kobo.329.1">private</span></strong><span class="koboSpan" id="kobo.330.1"> function inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">Calculation.php</span></strong><span class="koboSpan" id="kobo.332.1"> class? </span><span class="koboSpan" id="kobo.332.2">If you need to test a </span><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">private</span></strong><span class="koboSpan" id="kobo.334.1"> method, then you can either indirectly test the </span><strong class="source-inline"><span class="koboSpan" id="kobo.335.1">private</span></strong><span class="koboSpan" id="kobo.336.1"> method by testing the method that calls it or use PHP’s reflection feature. </span></p>
<h2 id="_idParaDest-77"><a id="_idTextAnchor078"/><span class="koboSpan" id="kobo.337.1">Using PHP’s reflection feature to directly test for private methods</span></h2>
<p><span class="koboSpan" id="kobo.338.1">Private methods </span><a id="_idIndexMarker176"/><span class="koboSpan" id="kobo.339.1">are not supposed to be accessible to external objects, but they can be tested indirectly as will be explained in the next section. </span><span class="koboSpan" id="kobo.339.2">If you really want to try testing for a </span><strong class="source-inline"><span class="koboSpan" id="kobo.340.1">private</span></strong><span class="koboSpan" id="kobo.341.1"> method directly, you can use this method. </span><span class="koboSpan" id="kobo.341.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.342.1">Calculator.php</span></strong><span class="koboSpan" id="kobo.343.1"> class and add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.344.1">private</span></strong> <span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">getDifference</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.346.1"> method:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.347.1">codebase/symfony/src/Example/Calculator.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.348.1">
&lt;?php
namespace App\Example;
class Calculator
{
    public function calculateTotal(int $a, int $b, int $c) 
        : int
    {
        return $a + $b + $c;
    }
    public function add(int $a, int $b): int
    {
        return $a + $b;
    }
    private function getDifference(int $a, int $b): int
    {
        return $a - $b;
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.349.1">If you run</span><a id="_idIndexMarker177"/><span class="koboSpan" id="kobo.350.1"> the test again, you’ll see that your test coverage has decreased again, even if you just added a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">private</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.352.1"> method:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer064">
<span class="koboSpan" id="kobo.353.1"><img alt="Figure 5.7 – No test for private method" src="image/Figure_5.07_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.354.1">Figure 5.7 – No test for private method</span></p>
<p><span class="koboSpan" id="kobo.355.1">Now, we have untested code, which is also going to be tricky to test as it’s a </span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">private</span></strong><span class="koboSpan" id="kobo.357.1"> method. </span><span class="koboSpan" id="kobo.357.2">To test this, open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">CalculationTest.php</span></strong><span class="koboSpan" id="kobo.359.1"> test class and add the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">testCanGetDifference</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.361.1"> method:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.362.1">codebase/symfony/tests/Unit/CalculationTest.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.363.1">
/**
 * @covers \App\Example\Calculator::getDifference
 */
public function testCanGetDifference()
{
    // Expected Result
    $expectedDifference = 4;
    // Test Data
    $a = 10;
    $b = 6;
    // Reflection
    $calculatorClass    = new \ReflectionClass
        (Calculator::class);
    $privateMethod      = $calculatorClass-&gt;getMethod
        ("getDifference");
    $privateMethod-&gt;setAccessible(true);
    // Instance
    $calculatorInstance = new Calculator();
    // Call the private method
    $difference = $privateMethod-&gt;invokeArgs
        ($calculatorInstance, [$a, $b]);
    $this-&gt;assertEquals($expectedDifference, $difference);
}</span></pre>
<p><span class="koboSpan" id="kobo.364.1">As with the earlier test methods, we have also annotated this test to signify that it tests for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.365.1">getDifference</span></strong><span class="koboSpan" id="kobo.366.1"> method inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.367.1">Calculator.php</span></strong><span class="koboSpan" id="kobo.368.1"> class. </span><span class="koboSpan" id="kobo.368.2">Since we are trying to test for a </span><strong class="source-inline"><span class="koboSpan" id="kobo.369.1">private</span></strong><span class="koboSpan" id="kobo.370.1"> method that is obviously not accessible if we just instantiate a </span><strong class="source-inline"><span class="koboSpan" id="kobo.371.1">Calculator</span></strong><span class="koboSpan" id="kobo.372.1"> object, we need to use PHP’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">ReflectionClass</span></strong><span class="koboSpan" id="kobo.374.1">. </span><span class="koboSpan" id="kobo.374.2">We have manually specified the visibility of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">getDifference</span></strong><span class="koboSpan" id="kobo.376.1"> class and indirectly called </span><a id="_idIndexMarker178"/><span class="koboSpan" id="kobo.377.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.378.1">private</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.379.1">getDifference</span></strong><span class="koboSpan" id="kobo.380.1"> method. </span><span class="koboSpan" id="kobo.380.2">If we run the test again, we’ll now see </span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">the following:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer065">
<span class="koboSpan" id="kobo.382.1"><img alt="Figure 5.8 – Private method tested" src="image/Figure_5.08_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.383.1">Figure 5.8 – Private method tested</span></p>
<p><span class="koboSpan" id="kobo.384.1">Now, we are back to 100% test coverage, having tested two </span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">public</span></strong><span class="koboSpan" id="kobo.386.1"> methods and one </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">private</span></strong><span class="koboSpan" id="kobo.388.1"> method – but is this necessary or practical? </span><span class="koboSpan" id="kobo.388.2">I personally think that this is not very practical. </span><span class="koboSpan" id="kobo.388.3">If I have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">private</span></strong><span class="koboSpan" id="kobo.390.1"> method, I’ll obviously use that private method inside another publicly accessible method. </span><span class="koboSpan" id="kobo.390.2">What I’d do is test for that publicly accessible method instead. </span><span class="koboSpan" id="kobo.390.3">If the instructions inside a </span><strong class="source-inline"><span class="koboSpan" id="kobo.391.1">private</span></strong><span class="koboSpan" id="kobo.392.1"> method are very complex, I don’t think it should be a </span><strong class="source-inline"><span class="koboSpan" id="kobo.393.1">private</span></strong><span class="koboSpan" id="kobo.394.1"> method inside a class anyway. </span><span class="koboSpan" id="kobo.394.2">It might need its own class, or it might need to</span><a id="_idIndexMarker179"/><span class="koboSpan" id="kobo.395.1"> be broken down more. </span><span class="koboSpan" id="kobo.395.2">I’ve seen a lot of good classes (classes that can do everything) with very complex </span><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">private</span></strong><span class="koboSpan" id="kobo.397.1"> methods, and it’s a headache to maintain these types </span><span class="No-Break"><span class="koboSpan" id="kobo.398.1">of classes.</span></span></p>
<h2 id="_idParaDest-78"><a id="_idTextAnchor079"/><span class="koboSpan" id="kobo.399.1">Indirectly testing for private methods</span></h2>
<p><span class="koboSpan" id="kobo.400.1">If I have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">private</span></strong><span class="koboSpan" id="kobo.402.1"> method, I’d test the public method that uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.403.1">private</span></strong><span class="koboSpan" id="kobo.404.1"> method instead </span><a id="_idIndexMarker180"/><span class="koboSpan" id="kobo.405.1">of going through the reflection route. </span><span class="koboSpan" id="kobo.405.2">If it gets too complex, I will think of moving this test away from the unit test suite altogether. </span><span class="koboSpan" id="kobo.405.3">You can read about integration testing later in this chapter to </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">learn more.</span></span></p>
<p><span class="koboSpan" id="kobo.407.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.408.1">Calculator.php</span></strong><span class="koboSpan" id="kobo.409.1"> class and replace the content with </span><span class="No-Break"><span class="koboSpan" id="kobo.410.1">the following:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.411.1">codebase/symfony/src/Example/Calculator.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.412.1">
&lt;?php
namespace App\Example;
class Calculator
{
    public function calculateTotal(int $a, int $b, int $c) 
        : int
    {
        return $a + $b + $c;
    }
    public function add(int $a, int $b): int
    {
        return $a + $b;
    }
    public function subtract(int $a, int $b): int
    {
        return $this-&gt;getDifference($a, $b);
    }
    private function getDifference(int $a, int $b): int
    {
        return $a - $b;
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.413.1">We have </span><a id="_idIndexMarker181"/><span class="koboSpan" id="kobo.414.1">retained the private </span><strong class="source-inline"><span class="koboSpan" id="kobo.415.1">getDifference</span></strong><span class="koboSpan" id="kobo.416.1"> method, but we have also added a new publicly accessible method called </span><strong class="source-inline"><span class="koboSpan" id="kobo.417.1">subtract</span></strong><span class="koboSpan" id="kobo.418.1">, which, in turn, uses the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.419.1">getDifference</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.420.1"> method.</span></span></p>
<p><span class="koboSpan" id="kobo.421.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.422.1">CalculationTest.php</span></strong><span class="koboSpan" id="kobo.423.1"> file and replace the reflection test with </span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">the following:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.425.1">codebase/symfony/tests/Unit/CalculationTest.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.426.1">
/**
 * @covers \App\Example\Calculator::subtract
 * @covers \App\Example\Calculator::getDifference
 */
public function testCanSubtractIntegers()
{
    // Expected Result
    $expectedDifference = 4;
    // Test Data
    $a = 10;
    $b = 6;
    $calculator = new Calculator();
    $difference = $calculator-&gt;subtract($a, $b);
    $this-&gt;assertEquals($expectedDifference, $difference);
}</span></pre>
<p><span class="koboSpan" id="kobo.427.1">In the preceding </span><a id="_idIndexMarker182"/><span class="koboSpan" id="kobo.428.1">code block, we have deleted the </span><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">testCanGetDifference</span></strong><span class="koboSpan" id="kobo.430.1"> test that uses PHP’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">ReflectionClass</span></strong><span class="koboSpan" id="kobo.432.1"> method. </span><span class="koboSpan" id="kobo.432.2">It’s up to you whether you want to test manually and individually for your private or protected methods </span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.434.1">reflection</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.435.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.436.1">In this new </span><strong class="source-inline"><span class="koboSpan" id="kobo.437.1">testCanSubtractIntegers</span></strong><span class="koboSpan" id="kobo.438.1"> method, you will notice that there are now two </span><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">@covers</span></strong><span class="koboSpan" id="kobo.440.1"> annotations. </span><span class="koboSpan" id="kobo.440.2">We are explicitly declaring that this specific test method will cover both the public </span><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">subtract</span></strong><span class="koboSpan" id="kobo.442.1"> method and the private </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">getDifference</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.444.1"> method.</span></span></p>
<p><span class="koboSpan" id="kobo.445.1">Run the following command to execute the coverage test again and let’s see whether we still pass </span><span class="No-Break"><span class="koboSpan" id="kobo.446.1">the tests:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.447.1">
/var/www/html/symfony# php bin/phpunit --coverage-text --filter CalculationTest</span></pre>
<p><span class="koboSpan" id="kobo.448.1">You should see the following 100% </span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">coverage result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer066">
<span class="koboSpan" id="kobo.450.1"><img alt="Figure 5.9 – Two methods covered by one test" src="image/Figure_5.09_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.451.1">Figure 5.9 – Two methods covered by one test</span></p>
<p><span class="koboSpan" id="kobo.452.1">You’ll notice that the coverage report states that we have tested four methods. </span><span class="koboSpan" id="kobo.452.2">Technically speaking, we only have three tests inside our </span><strong class="source-inline"><span class="koboSpan" id="kobo.453.1">CalculationTest.php</span></strong><span class="koboSpan" id="kobo.454.1"> test class that are reported by the test result: </span></p>
<p><strong class="bold"><span class="koboSpan" id="kobo.455.1">OK (3 tests, 3 assertions)</span></strong> </p>
<p><span class="koboSpan" id="kobo.456.1">Since we </span><a id="_idIndexMarker183"/><span class="koboSpan" id="kobo.457.1">have declared that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.458.1">testCanSubtractIntegers</span></strong><span class="koboSpan" id="kobo.459.1"> test will be covering both the </span><strong class="source-inline"><span class="koboSpan" id="kobo.460.1">subtract</span></strong><span class="koboSpan" id="kobo.461.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.462.1">getDifference</span></strong><span class="koboSpan" id="kobo.463.1"> methods, we are able to get full test coverage for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.464.1">Calculator.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.465.1"> class:</span></span></p>
<p><strong class="bold"><span class="koboSpan" id="kobo.466.1">Methods: </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.467.1">100.00% (4/4)</span></strong></span></p>
<p><span class="koboSpan" id="kobo.468.1">We were now able to go through running unit tests, using Xdebug to debug with breakpoints and get test coverage results. </span><span class="koboSpan" id="kobo.468.2">Next, we will build our own small tools to run tests a little bit easier so that we don’t have to write long commands all </span><span class="No-Break"><span class="koboSpan" id="kobo.469.1">the time.</span></span></p>
<h1 id="_idParaDest-79"><a id="_idTextAnchor080"/><span class="koboSpan" id="kobo.470.1">Using shell scripts to run tests</span></h1>
<p><span class="koboSpan" id="kobo.471.1">We can use </span><a id="_idIndexMarker184"/><span class="koboSpan" id="kobo.472.1">shell scripts to run our tests for us, and by doing so, we</span><a id="_idIndexMarker185"/><span class="koboSpan" id="kobo.473.1"> can add extra configurations to each script. </span><span class="koboSpan" id="kobo.473.2">There are different configurations and commands to run when running PHPUnit tests, and there are different goals or intentions in mind when running unit tests. </span><span class="koboSpan" id="kobo.473.3">In this chapter so far, we ran tests to trigger Xdebug and go through codes, and we also used PHPUnit to get a report for our test coverage. </span><span class="koboSpan" id="kobo.473.4">To simplify the execution of these tests a bit better, we can build some shell scripts to help us encapsulate the commands and configurations to run </span><span class="No-Break"><span class="koboSpan" id="kobo.474.1">the tests.</span></span></p>
<p><span class="koboSpan" id="kobo.475.1">If you go back to your</span><a id="_idIndexMarker186"/><span class="koboSpan" id="kobo.476.1"> terminal and try to use Xdebug with a </span><a id="_idIndexMarker187"/><span class="koboSpan" id="kobo.477.1">breakpoint, you’ll probably be disappointed. </span><span class="koboSpan" id="kobo.477.2">In PHPStorm, put a breakpoint like so in one of </span><span class="No-Break"><span class="koboSpan" id="kobo.478.1">the tests:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer067">
<span class="koboSpan" id="kobo.479.1"><img alt="Figure 5.10 – Adding a breakpoint" src="image/Figure_5.10_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.480.1">Figure 5.10 – Adding a breakpoint</span></p>
<p><span class="koboSpan" id="kobo.481.1">After putting a breakpoint inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.482.1">CalculationTest.php</span></strong><span class="koboSpan" id="kobo.483.1"> class on line 16, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.484.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.485.1">
/var/www/html/symfony# php bin/phpunit --filter CalculationTest</span></pre>
<p><span class="koboSpan" id="kobo.486.1">Did you notice anything? </span><span class="koboSpan" id="kobo.486.2">Well, the breakpoint did not get called at all. </span><span class="koboSpan" id="kobo.486.3">This is because earlier, we specified that we wanted to use Xdebug in coverage mode by running </span><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">export XDEBUG_MODE=coverage</span></strong><span class="koboSpan" id="kobo.488.1">. </span><span class="koboSpan" id="kobo.488.2">On the other hand, if we are running the test in debug mode and we want to get the coverage report, then we’ll have to run different commands again. </span><span class="koboSpan" id="kobo.488.3">There’s really nothing wrong with this, but if we are going to be developing a lot of codes and running tests repeatedly with different configurations, it can be helpful to use shell </span><span class="No-Break"><span class="koboSpan" id="kobo.489.1">scripts instead.</span></span></p>
<p><span class="koboSpan" id="kobo.490.1">We will create two scripts to trigger PHPUnit and configure </span><span class="No-Break"><span class="koboSpan" id="kobo.491.1">our environment:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.492.1">runDebug.sh</span></strong><span class="koboSpan" id="kobo.493.1"> – We’ll use this </span><span class="No-Break"><span class="koboSpan" id="kobo.494.1">for debugging</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">runCoverage.sh</span></strong><span class="koboSpan" id="kobo.496.1"> – We’ll use this for test </span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">coverage reports</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.498.1">In symfony’s root </span><strong class="source-inline"><span class="koboSpan" id="kobo.499.1">dir</span></strong><span class="koboSpan" id="kobo.500.1">, create </span><a id="_idIndexMarker188"/><span class="koboSpan" id="kobo.501.1">the</span><a id="_idIndexMarker189"/> <span class="No-Break"><span class="koboSpan" id="kobo.502.1">following file:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.503.1">codebase/symfony/runDebug.sh</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.504.1">
#!/bin/bash
export XDEBUG_CONFIG="idekey=PHPSTORM"
export PHP_IDE_CONFIG="serverName=phptdd"
export XDEBUG_MODE="debug"
XDEBUGOPT=
if [ "x$NODEBUG" = "x" ]; then
    XDEBUGOPT="-d xdebug.start_with_request=yes"
fi
php $XDEBUGOPT bin/phpunit --color=always --debug $@</span></pre>
<p><span class="koboSpan" id="kobo.505.1">In the preceding script, we are configuring our environment to run a test with Xdebug. </span><span class="koboSpan" id="kobo.505.2">This is important during development as it will let us use breakpoints without having to always think about </span><span class="No-Break"><span class="koboSpan" id="kobo.506.1">the configurations.</span></span></p>
<p><span class="koboSpan" id="kobo.507.1">Make sure that the file you created is executable; run the following command to </span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">do so:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.509.1">
/var/www/html/symfony# chmod u+x runDebug.sh</span></pre>
<p><span class="koboSpan" id="kobo.510.1">Now, we can try using this script to execute our </span><strong class="source-inline"><span class="koboSpan" id="kobo.511.1">CalculationTest.php</span></strong><span class="koboSpan" id="kobo.512.1"> class, and see whether our breakpoint in line 16 </span><span class="No-Break"><span class="koboSpan" id="kobo.513.1">gets called:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.514.1">
/var/www/html/symfony# ./runDebug.sh</span></pre>
<p><span class="koboSpan" id="kobo.515.1">After </span><a id="_idIndexMarker190"/><span class="koboSpan" id="kobo.516.1">running the preceding command, go back to PHPStorm</span><a id="_idIndexMarker191"/><span class="koboSpan" id="kobo.517.1"> and make sure that the </span><span class="No-Break"><span class="koboSpan" id="kobo.518.1">breakpoint works:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer068">
<span class="koboSpan" id="kobo.519.1"><img alt="Figure 5.11 – Using runDebug.sh with Xdebug" src="image/Figure_5.11_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.520.1">Figure 5.11 – Using runDebug.sh with Xdebug</span></p>
<p><span class="koboSpan" id="kobo.521.1">Great! </span><span class="koboSpan" id="kobo.521.2">By using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.522.1">./runDebug.sh</span></strong><span class="koboSpan" id="kobo.523.1"> script, we can configure our container dynamically and trigger the breakpoint in PHPStorm with Xdebug. </span><span class="koboSpan" id="kobo.523.2">Now, if we want to get the test coverage report, we’ll need to run a different script to make </span><span class="No-Break"><span class="koboSpan" id="kobo.524.1">things easier.</span></span></p>
<p><span class="koboSpan" id="kobo.525.1">Create a</span><a id="_idIndexMarker192"/><span class="koboSpan" id="kobo.526.1"> new</span><a id="_idIndexMarker193"/><span class="koboSpan" id="kobo.527.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.528.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">runCoverage.sh</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.530.1">:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.531.1">codebase/symfony/runCoverage.sh</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.532.1">
#!/bin/bash
export XDEBUG_CONFIG="idekey=PHPSTORM"
export PHP_IDE_CONFIG="serverName=phptdd"
export XDEBUG_MODE="coverage"
php bin/phpunit --color=always --coverage-text $@</span></pre>
<p><span class="koboSpan" id="kobo.533.1">The preceding script will configure our environment and attach the </span><strong class="source-inline"><span class="koboSpan" id="kobo.534.1">--coverage-text</span></strong><span class="koboSpan" id="kobo.535.1"> option so that we can easily get a test coverage report when running </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">this script.</span></span></p>
<p><span class="koboSpan" id="kobo.537.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.538.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.539.1">
/var/www/html/symfony# ./runCoverage.sh</span></pre>
<p><span class="koboSpan" id="kobo.540.1">Running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.541.1">./runCoverage</span></strong><span class="koboSpan" id="kobo.542.1"> script should now generate the respective </span><strong class="bold"><span class="koboSpan" id="kobo.543.1">Code </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.544.1">Coverage Report</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.545.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer069">
<span class="koboSpan" id="kobo.546.1"><img alt="Figure 5.12 – Using the runCoverage.sh script" src="image/Figure_5.12_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.547.1">Figure 5.12 – Using the runCoverage.sh script</span></p>
<p><span class="koboSpan" id="kobo.548.1">Great! </span><span class="koboSpan" id="kobo.548.2">Now, we can run PHPUnit with different configurations. </span><span class="koboSpan" id="kobo.548.3">The last test execution returned a failure because of our previously created </span><strong class="source-inline"><span class="koboSpan" id="kobo.549.1">ExampleTest.php</span></strong><span class="koboSpan" id="kobo.550.1"> test class, which we </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">deliberately failed.</span></span></p>
<p><span class="koboSpan" id="kobo.552.1">You can </span><a id="_idIndexMarker194"/><span class="koboSpan" id="kobo.553.1">add your own scripts depending on your needs – after </span><a id="_idIndexMarker195"/><span class="koboSpan" id="kobo.554.1">all, we are software developers. </span><span class="koboSpan" id="kobo.554.2">We can build tools to make things a little bit easier for ourselves. </span><span class="koboSpan" id="kobo.554.3">When running </span><strong class="bold"><span class="koboSpan" id="kobo.555.1">Continuous Integration</span></strong><span class="koboSpan" id="kobo.556.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.557.1">CI</span></strong><span class="koboSpan" id="kobo.558.1">), we won’t </span><a id="_idIndexMarker196"/><span class="koboSpan" id="kobo.559.1">need the ability to debug nor run code coverage reports all the time, so we can also create a script further down the project for CI usage. </span><span class="koboSpan" id="kobo.559.2">CI will be discussed in more detail in </span><a href="B18318_09.xhtml#_idTextAnchor138"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.560.1">Chapter 9</span></em></span></a><span class="koboSpan" id="kobo.561.1">, </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.562.1">Continuous Integration</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.563.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.564.1">We’ve now learned how to write unit tests, and these tests are focused on testing small programs in our solution codes – but what if we need to test a more complex functionality that uses multiple classes? </span><span class="koboSpan" id="kobo.564.2">It would be nice if we could segregate those complex tests that depend on external objects or resources. </span><span class="koboSpan" id="kobo.564.3">In the next section, we’ll quickly go through the different types of </span><span class="No-Break"><span class="koboSpan" id="kobo.565.1">automated tests.</span></span></p>
<h1 id="_idParaDest-80"><a id="_idTextAnchor081"/><span class="koboSpan" id="kobo.566.1">Types of tests</span></h1>
<p><span class="koboSpan" id="kobo.567.1">Running PHPUnit tests</span><a id="_idIndexMarker197"/><span class="koboSpan" id="kobo.568.1"> can be very quick. </span><span class="koboSpan" id="kobo.568.2">In my experience, even with tens of thousands of unit tests, it can only take a few minutes to run them completely. </span><span class="koboSpan" id="kobo.568.3">This is because they only test small parts or units of the solution. </span></p>
<p><span class="koboSpan" id="kobo.569.1">We can also add tests that will call programs that will interact with external web service APIs or databases. </span><span class="koboSpan" id="kobo.569.2">Now, imagine how complex those tests are and how long it would take to execute them. </span><span class="koboSpan" id="kobo.569.3">If we combine all the complex tests that use multiple object and unit tests into a single group, it will take a lot of time to run the entire group of tests. </span><span class="koboSpan" id="kobo.569.4">I’ve experienced working with a company where there are thousands of tests that are all grouped into a single suite – you run the suite and wait an hour, only to find out there’s one broken unit test. </span><span class="koboSpan" id="kobo.569.5">That’s very time-consuming and impractical.   </span></p>
<div>
<div class="IMG---Figure" id="_idContainer070">
<span class="koboSpan" id="kobo.570.1"><img alt="Figure 5.13 – Grouping tests" src="image/Figure_5.13_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.571.1">Figure 5.13 – Grouping tests</span></p>
<p><span class="koboSpan" id="kobo.572.1">Identifying what a test does and putting it in the right group or basket of tests can help with organizing the tests. </span><span class="koboSpan" id="kobo.572.2">There are different types of tests that we can use as “baskets” or groups for our tests. </span><span class="koboSpan" id="kobo.572.3">We can simplify these baskets and divide them into two main types. </span><span class="koboSpan" id="kobo.572.4">In PHPUnit, these baskets are called </span><span class="No-Break"><span class="koboSpan" id="kobo.573.1">test suites.</span></span></p>
<h2 id="_idParaDest-81"><a id="_idTextAnchor082"/><span class="koboSpan" id="kobo.574.1">Basket 1 – unit tests</span></h2>
<p><span class="koboSpan" id="kobo.575.1">We’ve written unit tests</span><a id="_idIndexMarker198"/><span class="koboSpan" id="kobo.576.1"> earlier in this chapter. </span><span class="koboSpan" id="kobo.576.2">If you remember, we created a directory inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.577.1">codebase/symfony/tests</span></strong><span class="koboSpan" id="kobo.578.1"> directory called </span><strong class="source-inline"><span class="koboSpan" id="kobo.579.1">Unit</span></strong><span class="koboSpan" id="kobo.580.1">. </span><span class="koboSpan" id="kobo.580.2">This will be our unit test basket. </span><span class="koboSpan" id="kobo.580.3">Every test that specifically tests small parts or units of the solution will be put into this directory, and in turn, the namespace is the </span><span class="No-Break"><span class="koboSpan" id="kobo.581.1">following: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.582.1">App\Tests\Unit</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.583.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.584.1">Open up </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">codebase/symfony/phpunit.xml</span></strong><span class="koboSpan" id="kobo.586.1"> and you’ll notice that we have declared a </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">testsuite</span></strong><span class="koboSpan" id="kobo.588.1"> named </span><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">Unit</span></strong><span class="koboSpan" id="kobo.590.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.591.1">tests/Unit/</span></strong><span class="koboSpan" id="kobo.592.1"> directory. </span><span class="koboSpan" id="kobo.592.2">We will use test suites to help group and segregate our tests. </span><span class="koboSpan" id="kobo.592.3">This will come in handy when we want to isolate the group of tests we want </span><span class="No-Break"><span class="koboSpan" id="kobo.593.1">to run:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.594.1">
&lt;testsuites&gt;
    &lt;testsuite name="Project Test Suite"&gt;
        &lt;directory&gt;tests&lt;/directory&gt;
    &lt;/testsuite&gt;
    &lt;testsuite name="Unit"&gt;
        &lt;directory&gt;tests/Unit/&lt;/directory&gt;
    &lt;/testsuite&gt;
&lt;/testsuites&gt;</span></pre>
<p><span class="koboSpan" id="kobo.595.1">This means that if we want</span><a id="_idIndexMarker199"/><span class="koboSpan" id="kobo.596.1"> to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.597.1">Unit</span></strong><span class="koboSpan" id="kobo.598.1"> test suite, PHPUnit will find all of the tests inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.599.1">tests/Unit/</span></strong><span class="koboSpan" id="kobo.600.1"> directory. </span></p>
<p><span class="koboSpan" id="kobo.601.1">To run all the tests inside that unit basket or test suite, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.602.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.603.1">
/var/www/html/symfony# ./runDebug.sh --testsuite Unit</span></pre>
<p><span class="koboSpan" id="kobo.604.1">You’ll get the </span><span class="No-Break"><span class="koboSpan" id="kobo.605.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer071">
<span class="koboSpan" id="kobo.606.1"><img alt="Figure 5.14 – Unit test suite" src="image/Figure_5.14_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.607.1">Figure 5.14 – Unit test suite</span></p>
<p><span class="koboSpan" id="kobo.608.1">By adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">--testsuite</span></strong><span class="koboSpan" id="kobo.610.1"> unit option, we ensure that we only run tests inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.611.1">App\Tests\Unit</span></strong><span class="koboSpan" id="kobo.612.1"> namespace. </span><span class="koboSpan" id="kobo.612.2">This</span><a id="_idIndexMarker200"/><span class="koboSpan" id="kobo.613.1"> will help us focus our test execution on a specific basket or test suite. </span></p>
<p><span class="koboSpan" id="kobo.614.1">We have covered the first group or basket of tests. </span><span class="koboSpan" id="kobo.614.2">We have created a directory called </span><strong class="source-inline"><span class="koboSpan" id="kobo.615.1">Unit</span></strong><span class="koboSpan" id="kobo.616.1">, and this is where we will put all the future unit, or simple, tests. </span><span class="koboSpan" id="kobo.616.2">Next, we’ll need to create a separate group or basket to put the more </span><span class="No-Break"><span class="koboSpan" id="kobo.617.1">complex tests.</span></span></p>
<h2 id="_idParaDest-82"><a id="_idTextAnchor083"/><span class="koboSpan" id="kobo.618.1">Basket 2 – integration tests</span></h2>
<p><span class="koboSpan" id="kobo.619.1">Integration testing aims </span><a id="_idIndexMarker201"/><span class="koboSpan" id="kobo.620.1">to test a bigger part of the solution. </span><span class="koboSpan" id="kobo.620.2">Instead of testing a small unit of the application, integration tests aim to cover different parts of the solution in a single test. </span></p>
<p><span class="koboSpan" id="kobo.621.1">Imagine testing an object’s method that uses other objects. </span><span class="koboSpan" id="kobo.621.2">The success of the test can depend on external factors such as a database connection, an API call, or dependence on other classes that also depend on other classes. </span><span class="koboSpan" id="kobo.621.3">It’s like a unit test on a slightly </span><span class="No-Break"><span class="koboSpan" id="kobo.622.1">bigger scale.</span></span></p>
<p><span class="koboSpan" id="kobo.623.1">For example, if you have a class that computes some total and then persists it in the database, you’d want to have a test that checks the computation result that is persisted in the database. </span><span class="koboSpan" id="kobo.623.2">This is where integration tests can be </span><span class="No-Break"><span class="koboSpan" id="kobo.624.1">very useful.</span></span></p>
<p><span class="koboSpan" id="kobo.625.1">We previously created a directory for our unit tests – now, let’s create a directory to contain our integration tests. </span></p>
<p><span class="koboSpan" id="kobo.626.1">Create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.627.1">Integration</span></strong><span class="koboSpan" id="kobo.628.1"> directory inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.629.1">tests</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.630.1"> directory:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.631.1">
/var/www/html/symfony# mkdir tests/Integration</span></pre>
<p><span class="koboSpan" id="kobo.632.1">After creating the </span><strong class="source-inline"><span class="koboSpan" id="kobo.633.1">Integration</span></strong><span class="koboSpan" id="kobo.634.1"> directory, we need to let PHPUnit know about this directory. </span><span class="koboSpan" id="kobo.634.2">We need to</span><a id="_idIndexMarker202"/><span class="koboSpan" id="kobo.635.1"> add an </span><strong class="source-inline"><span class="koboSpan" id="kobo.636.1">Integration</span></strong><span class="koboSpan" id="kobo.637.1"> test suite and declare the directory path. </span><span class="koboSpan" id="kobo.637.2">Open </span><strong class="source-inline"><span class="koboSpan" id="kobo.638.1">codebase/symfony/phpunit.xml</span></strong><span class="koboSpan" id="kobo.639.1"> and use the </span><span class="No-Break"><span class="koboSpan" id="kobo.640.1">following configuration:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.641.1">
codebase/symfony/phpunit.xml    &lt;php&gt;
        &lt;ini name="display_errors" value="1" /&gt;
        &lt;ini name="error_reporting" value="-1" /&gt;
        &lt;server name="APP_ENV" value="test" force="true" /&gt;
        &lt;server name="SHELL_VERBOSITY" value="-1" /&gt;
        &lt;server name="SYMFONY_PHPUNIT_REMOVE" value="" /&gt;
        &lt;server name="SYMFONY_PHPUNIT_VERSION" value="9.5" /&gt;
        &lt;env name="SYMFONY_DEPRECATIONS_HELPER" 
            value="disabled" /&gt;
    &lt;/php&gt;
    &lt;testsuites&gt;
        &lt;testsuite name="Project Test Suite"&gt;
            &lt;directory&gt;tests&lt;/directory&gt;
        &lt;/testsuite&gt;
        &lt;testsuite name="Unit"&gt;
            &lt;directory&gt;tests/Unit/&lt;/directory&gt;
        &lt;/testsuite&gt;
        &lt;testsuite name="Integration"&gt;
            &lt;directory&gt;tests/Integration/&lt;/directory&gt;
        &lt;/testsuite&gt;
    &lt;/testsuites&gt;
    &lt;coverage processUncoveredFiles="true"&gt;
        &lt;include&gt;
            &lt;directory suffix=".php"&gt;src&lt;/directory&gt;
        &lt;/include&gt;
    &lt;/coverage&gt;
    &lt;listeners&gt;
        &lt;listener class="Symfony\Bridge\PhpUnit
            \SymfonyTestsListener" /&gt;
    &lt;/listeners&gt;</span></pre>
<p><span class="koboSpan" id="kobo.642.1">Now, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.643.1">Integration</span></strong><span class="koboSpan" id="kobo.644.1"> test</span><a id="_idIndexMarker203"/><span class="koboSpan" id="kobo.645.1"> suite has been registered. </span><span class="koboSpan" id="kobo.645.2">With this, we can still safely run our unit tests by passing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.646.1">Unit</span></strong><span class="koboSpan" id="kobo.647.1"> argument to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.648.1">--testsuite</span></strong><span class="koboSpan" id="kobo.649.1"> option when running our tests. </span><span class="koboSpan" id="kobo.649.2">To run integration tests, we simply use </span><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">--testsuite </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.651.1">Integration</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.652.1"> instead:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.653.1">
/var/www/html/symfony# ./runDebug.sh --testsuite Integration</span></pre>
<p><span class="koboSpan" id="kobo.654.1">Since we have no tests, running the preceding command will return the </span><span class="No-Break"><span class="koboSpan" id="kobo.655.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer072">
<span class="koboSpan" id="kobo.656.1"><img alt="Figure 5.15 – Integration test suite" src="image/Figure_5.15_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.657.1">Figure 5.15 – Integration test suite</span></p>
<p><span class="koboSpan" id="kobo.658.1">Now that we have a </span><a id="_idIndexMarker204"/><span class="koboSpan" id="kobo.659.1">basket to put all our integration tests into, let’s start writing our first integration test! </span></p>
<p><span class="koboSpan" id="kobo.660.1">We already have a unit-tested class, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.661.1">Calculate.php</span></strong><span class="koboSpan" id="kobo.662.1"> class. </span><span class="koboSpan" id="kobo.662.2">Now, it would be great if we could use this as a part of our integration test example. </span></p>
<h1 id="_idParaDest-83"><a id="_idTextAnchor084"/><span class="koboSpan" id="kobo.663.1">Integration test example</span></h1>
<p><span class="koboSpan" id="kobo.664.1">In this section, we will try to</span><a id="_idIndexMarker205"/><span class="koboSpan" id="kobo.665.1"> do some calculations and then try to store the result in the database. </span><span class="koboSpan" id="kobo.665.2">We will create a database called </span><strong class="source-inline"><span class="koboSpan" id="kobo.666.1">coffee</span></strong><span class="koboSpan" id="kobo.667.1"> and try to create a program that simply calculates the sum of how many coffee cups we had in a day, and then persist it. </span><span class="koboSpan" id="kobo.667.2">After persisting, we need to be able to verify whether the persisted sum </span><span class="No-Break"><span class="koboSpan" id="kobo.668.1">is correct.</span></span></p>
<h2 id="_idParaDest-84"><a id="_idTextAnchor085"/><span class="koboSpan" id="kobo.669.1">Installing Doctrine with Symfony 6</span></h2>
<p><span class="koboSpan" id="kobo.670.1">Since we are using the</span><a id="_idIndexMarker206"/><span class="koboSpan" id="kobo.671.1"> Symfony framework, which works well with </span><a id="_idIndexMarker207"/><span class="koboSpan" id="kobo.672.1">Doctrine, let’s just use Doctrine to persist and retrieve data from our database. </span><span class="koboSpan" id="kobo.672.2">There are a lot of ways to persist and retrieve data from a database, but for this project, we’ll just focus on using Doctrine to simplify our examples so that we can focus on testing rather than reinventing the wheel. </span><span class="koboSpan" id="kobo.672.3">Doctrine </span><a id="_idIndexMarker208"/><span class="koboSpan" id="kobo.673.1">is an ORM. </span><span class="koboSpan" id="kobo.673.2">You can read more about Doctrine </span><span class="No-Break"><span class="koboSpan" id="kobo.674.1">at </span></span><a href="https://www.doctrine-project.org"><span class="No-Break"><span class="koboSpan" id="kobo.675.1">https://www.doctrine-project.org</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.676.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.677.1">Let’s install Doctrine by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.678.1">following commands:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.679.1">
/var/www/html/symfony# composer require symfony/orm-pack
/var/www/html/symfony# composer require symfony/maker-bundle --dev</span></pre>
<p><span class="koboSpan" id="kobo.680.1">After running the preceding commands, which can take a few minutes, create a local environment file, and save it with the </span><span class="No-Break"><span class="koboSpan" id="kobo.681.1">following content:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.682.1">codebase/symfony/.env.local</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.683.1">
DATABASE_URL="mysql://root:mypassword@server-mysql/mydb?serverVersion=8&amp;charset=utf8mb4"</span></pre>
<p><span class="koboSpan" id="kobo.684.1">In the preceding line, we </span><a id="_idIndexMarker209"/><span class="koboSpan" id="kobo.685.1">are telling Symfony that in our local </span><a id="_idIndexMarker210"/><span class="koboSpan" id="kobo.686.1">environment, we’d like to use our MySQL container that we created in </span><a href="B18318_03.xhtml#_idTextAnchor039"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.687.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.688.1">, </span><em class="italic"><span class="koboSpan" id="kobo.689.1">Setting Up Our Development Environment Using Docker Containers</span></em><span class="koboSpan" id="kobo.690.1">. </span></p>
<p><span class="koboSpan" id="kobo.691.1">You can open up the </span><strong class="source-inline"><span class="koboSpan" id="kobo.692.1">docker-compose.yml</span></strong><span class="koboSpan" id="kobo.693.1"> file to review the MySQL container details. </span><span class="koboSpan" id="kobo.693.2">You can make any further configuration changes there to suit </span><span class="No-Break"><span class="koboSpan" id="kobo.694.1">your needs.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer073">
<span class="koboSpan" id="kobo.695.1"><img alt="Figure 5.16 – MySQL container settings for Doctrine" src="image/Figure_5.16_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.696.1">Figure 5.16 – MySQL container settings for Doctrine</span></p>
<p><span class="koboSpan" id="kobo.697.1">You can change</span><a id="_idIndexMarker211"/><span class="koboSpan" id="kobo.698.1"> the database password here, or even change the </span><a id="_idIndexMarker212"/><span class="koboSpan" id="kobo.699.1">MySQL version to whichever you need. </span><span class="koboSpan" id="kobo.699.2">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.700.1">.env.local</span></strong><span class="koboSpan" id="kobo.701.1"> file, we have specified that we want to use MySQL8, and we also specified that we want to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.702.1">server-mysql</span></strong><span class="koboSpan" id="kobo.703.1"> container, instead of using the IP address of the database server. </span><span class="koboSpan" id="kobo.703.2">We also used </span><strong class="source-inline"><span class="koboSpan" id="kobo.704.1">coffee</span></strong><span class="koboSpan" id="kobo.705.1"> as our </span><span class="No-Break"><span class="koboSpan" id="kobo.706.1">database name.</span></span></p>
<p><span class="koboSpan" id="kobo.707.1">Next, we will use the Doctrine ORM to create a MySQL database for us. </span><span class="koboSpan" id="kobo.707.2">We will then be using this new database for our example </span><span class="No-Break"><span class="koboSpan" id="kobo.708.1">integration test.</span></span></p>
<h2 id="_idParaDest-85"><a id="_idTextAnchor086"/><span class="koboSpan" id="kobo.709.1">Doctrine and database</span></h2>
<p><span class="koboSpan" id="kobo.710.1">We have configured our</span><a id="_idIndexMarker213"/><span class="koboSpan" id="kobo.711.1"> environment so that it can connect to the MySQL server container we created, and we have specified the database name we want to use for our example. </span><span class="koboSpan" id="kobo.711.2">Now, at this stage, we are ready to create a database for our integration test example. </span><span class="koboSpan" id="kobo.711.3">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.712.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.713.1">
/var/www/html/symfony# php bin/console doctrine:database:create</span></pre>
<p><span class="koboSpan" id="kobo.714.1">By running the preceding command, Doctrine will create a database named </span><strong class="source-inline"><span class="koboSpan" id="kobo.715.1">coffee</span></strong><span class="koboSpan" id="kobo.716.1"> for us, using the parameters we provided in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.717.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.718.1">env.local</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.719.1"> file.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer074">
<span class="koboSpan" id="kobo.720.1"><img alt="Figure 5.17 – Creating a new database" src="image/Figure_5.17_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.721.1">Figure 5.17 – Creating a new database</span></p>
<p><span class="koboSpan" id="kobo.722.1">Now, we have our own database to play with. </span><span class="koboSpan" id="kobo.722.2">If you have a desktop MySQL client, you can connect to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.723.1">server-mysql</span></strong><span class="koboSpan" id="kobo.724.1"> container to view the database we just created. </span><span class="koboSpan" id="kobo.724.2">If not, to make things look a bit prettier than the unending terminal windows for our automated tests, we have added a </span><strong class="source-inline"><span class="koboSpan" id="kobo.725.1">PHPMyAdmin</span></strong><span class="koboSpan" id="kobo.726.1"> container for quick and easy DB access back in </span><a href="B18318_03.xhtml#_idTextAnchor039"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.727.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.728.1">, </span><em class="italic"><span class="koboSpan" id="kobo.729.1">Setting Up Our Development Environment Using Docker Containers</span></em><span class="koboSpan" id="kobo.730.1">. </span></p>
<p><span class="koboSpan" id="kobo.731.1">Open your web browser and go to the following URL: </span><strong class="source-inline"><span class="koboSpan" id="kobo.732.1">http://127.0.0.1:3333/index.php</span></strong><span class="koboSpan" id="kobo.733.1">. </span><span class="koboSpan" id="kobo.733.2">You will see </span><span class="No-Break"><span class="koboSpan" id="kobo.734.1">the following:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer075">
<span class="koboSpan" id="kobo.735.1"><img alt="Figure 5.18 – coffee database" src="image/Figure_5.18_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.736.1">Figure 5.18 – coffee database</span></p>
<p><span class="koboSpan" id="kobo.737.1">Before we write </span><a id="_idIndexMarker214"/><span class="koboSpan" id="kobo.738.1">any codes that will utilize the database we just created, first, we need to understand what we want to do with it and create an integration test for it. </span><span class="koboSpan" id="kobo.738.2">Next, we’ll create our first failing </span><span class="No-Break"><span class="koboSpan" id="kobo.739.1">integration test.</span></span></p>
<h2 id="_idParaDest-86"><a id="_idTextAnchor087"/><span class="koboSpan" id="kobo.740.1">Failing our first integration test</span></h2>
<p><span class="koboSpan" id="kobo.741.1">We have a solution to </span><a id="_idIndexMarker215"/><span class="koboSpan" id="kobo.742.1">persist information, which is Doctrine and MySQL. </span><span class="koboSpan" id="kobo.742.2">We also have a way to calculate the sum of some random integers. </span><span class="koboSpan" id="kobo.742.3">Now, let’s put them to use. </span><span class="koboSpan" id="kobo.742.4">We want to be able to pass a string name and three integers to represent the number of cups of coffee we consumed, get the sum, and persist it. </span></p>
<p><span class="koboSpan" id="kobo.743.1">Create the following integration </span><span class="No-Break"><span class="koboSpan" id="kobo.744.1">test file:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.745.1">codebase/symfony/tests/Integration/ConsumptionTest.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.746.1">
&lt;?php
namespace App\Tests\Integration\Service;
use PHPUnit\Framework\TestCase;
class ConsumptionServiceTest extends TestCase
{
    public function testCanComputeAndSave()
    {
        $this-&gt;fail("--- RED --");
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.747.1">We created our </span><a id="_idIndexMarker216"/><span class="koboSpan" id="kobo.748.1">first integration test inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.749.1">App\Tests\Integration</span></strong><span class="koboSpan" id="kobo.750.1"> namespace, which, in turn, will be a part of our integration test suite. </span><span class="koboSpan" id="kobo.750.2">Run the following command to make sure everything works, and that our test fails </span><span class="No-Break"><span class="koboSpan" id="kobo.751.1">as expected:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.752.1">
/var/www/html/symfony# .runDebug.sh --testsuite Integration --filter ConsumptionServiceTest</span></pre>
<p><span class="koboSpan" id="kobo.753.1">You should see the failed test, caused by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.754.1">$this-&gt;fail("--- RED --");</span></strong><span class="koboSpan" id="kobo.755.1"> line we </span><span class="No-Break"><span class="koboSpan" id="kobo.756.1">have created:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer076">
<span class="koboSpan" id="kobo.757.1"><img alt="Figure 5.19 – First failing integration test" src="image/Figure_5.19_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.758.1">Figure 5.19 – First failing integration test</span></p>
<p><span class="koboSpan" id="kobo.759.1">Great! </span><span class="koboSpan" id="kobo.759.2">We now have a failing </span><strong class="source-inline"><span class="koboSpan" id="kobo.760.1">Integration</span></strong><span class="koboSpan" id="kobo.761.1"> test suite test. </span><span class="koboSpan" id="kobo.761.2">Now, all we must do is make </span><span class="No-Break"><span class="koboSpan" id="kobo.762.1">it pass.</span></span></p>
<p><span class="koboSpan" id="kobo.763.1">Let’s try to break down exactly what we want to do, and what we want to </span><span class="No-Break"><span class="koboSpan" id="kobo.764.1">test for:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.765.1">We want to be able to track how many cups of coffee a person drinks in </span><span class="No-Break"><span class="koboSpan" id="kobo.766.1">a day</span></span></li>
<li><span class="koboSpan" id="kobo.767.1">We want to have the number of coffee cups consumed in the morning, afternoon, </span><span class="No-Break"><span class="koboSpan" id="kobo.768.1">and night</span></span></li>
<li><span class="koboSpan" id="kobo.769.1">We want to get the sum and then persist the total, along with the name of </span><span class="No-Break"><span class="koboSpan" id="kobo.770.1">the person</span></span></li>
<li><span class="koboSpan" id="kobo.771.1">We want to be able to retrieve the persisted record and check whether </span><span class="No-Break"><span class="koboSpan" id="kobo.772.1">it’s correct.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.773.1">Based on the </span><a id="_idIndexMarker217"/><span class="koboSpan" id="kobo.774.1">preceding list, we can then update our test with </span><span class="No-Break"><span class="koboSpan" id="kobo.775.1">the following:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.776.1">codebase/symfony/tests/Integration/Service/ConsumptionTest.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.777.1">
&lt;?php
namespace App\Tests\Integration\Service;
use PHPUnit\Framework\TestCase;
class ConsumptionServiceTest extends TestCase
{
    public function testCanComputeAndSave()
    {
        // Given
        $name               = "Damo";
        $morningCoffee      = 2;
        $afternoonCoffee    = 3;
        $eveningCoffee      = 1;
        // Expected Total:
        $expectedTotal = 6;
        // Persist the data
        $service    = new ConsumptionService();
        $persistedId = $service-&gt;computeAndSave($name, 
        $morningCoffee, $afternoonCoffee, $eveningCoffee);
        // Verify if the data persisted is correct:
        // TODO:
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.778.1">As you can see, we have an incomplete test – but for me, this is good. </span><span class="koboSpan" id="kobo.778.2">I write a failing test and make sure it fails, but I also try to start writing exactly what I want to </span><span class="No-Break"><span class="koboSpan" id="kobo.779.1">test for.</span></span></p>
<p><span class="koboSpan" id="kobo.780.1">Run the following </span><a id="_idIndexMarker218"/><span class="koboSpan" id="kobo.781.1">command to see </span><span class="No-Break"><span class="koboSpan" id="kobo.782.1">what happens:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.783.1">
/var/www/html/symfony# ./runDebug.sh --testsuite Integration --filter ConsumptionServiceTest</span></pre>
<p><span class="koboSpan" id="kobo.784.1">The test tries to instantiate the </span><strong class="source-inline"><span class="koboSpan" id="kobo.785.1">ConsumptionService.php</span></strong><span class="koboSpan" id="kobo.786.1"> class that does not exist. </span><span class="koboSpan" id="kobo.786.2">Therefore, you’ll get the </span><span class="No-Break"><span class="koboSpan" id="kobo.787.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer077">
<span class="koboSpan" id="kobo.788.1"><img alt="Figure 5.20 – ConsumptionService not found" src="image/Figure_5.20_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.789.1">Figure 5.20 – ConsumptionService not found</span></p>
<p><span class="koboSpan" id="kobo.790.1">We </span><a id="_idIndexMarker219"/><span class="koboSpan" id="kobo.791.1">deliberately tried to instantiate an object from a class that does not exist, therefore resulting in a test failure. </span><span class="koboSpan" id="kobo.791.2">What does this tell us? </span><span class="koboSpan" id="kobo.791.3">Remember </span><strong class="bold"><span class="koboSpan" id="kobo.792.1">Test-Driven Development</span></strong><span class="koboSpan" id="kobo.793.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.794.1">TDD</span></strong><span class="koboSpan" id="kobo.795.1">), where the development of our solution codes was driven by our failing tests? </span><span class="koboSpan" id="kobo.795.2">Well, we might want to start writing the solution code, which is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.796.1">ConsumptionService.php</span></strong><span class="koboSpan" id="kobo.797.1"> class and the other program it needs to use. </span><span class="koboSpan" id="kobo.797.2">We should always fail our </span><span class="No-Break"><span class="koboSpan" id="kobo.798.1">test first.</span></span></p>
<p><span class="koboSpan" id="kobo.799.1">However, before we write the </span><strong class="source-inline"><span class="koboSpan" id="kobo.800.1">ConsumptionService.php</span></strong><span class="koboSpan" id="kobo.801.1"> class, let’s create the Doctrine entity needed by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.802.1">ConsumptionService.php</span></strong><span class="koboSpan" id="kobo.803.1"> class for </span><span class="No-Break"><span class="koboSpan" id="kobo.804.1">our example.</span></span></p>
<h2 id="_idParaDest-87"><a id="_idTextAnchor088"/><span class="koboSpan" id="kobo.805.1">Creating a Doctrine entity</span></h2>
<p><span class="koboSpan" id="kobo.806.1">Let’s create an entity </span><a id="_idIndexMarker220"/><span class="koboSpan" id="kobo.807.1">class to represent our data. </span><span class="koboSpan" id="kobo.807.2">A Doctrine entity is just a simple </span><strong class="bold"><span class="koboSpan" id="kobo.808.1">Plain Old PHP Object</span></strong><span class="koboSpan" id="kobo.809.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.810.1">POPO</span></strong><span class="koboSpan" id="kobo.811.1">) with</span><a id="_idIndexMarker221"/><span class="koboSpan" id="kobo.812.1"> some Doctrine-specific annotations that can be mapped to a database table in its most basic usage. </span></p>
<p><span class="koboSpan" id="kobo.813.1">Run the following command to create a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.814.1">Consumption.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.815.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.816.1">
/var/www/html/symfony# php bin/console make:entity</span></pre>
<p><span class="koboSpan" id="kobo.817.1">After running the preceding command, enter the fields you want to create. </span><span class="koboSpan" id="kobo.817.2">For our example, use </span><span class="No-Break"><span class="koboSpan" id="kobo.818.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.819.1">
New property name: name
Field type: string
Field length: 50
Can this field be null in the database? </span><span class="koboSpan" id="kobo.819.2">no
New property name: total
Field type: integer
Can this field be null in the database? </span><span class="koboSpan" id="kobo.819.3">no</span></pre>
<p><span class="koboSpan" id="kobo.820.1">After the </span><a id="_idIndexMarker222"/><span class="koboSpan" id="kobo.821.1">command prompts, you should now see a new entity class file </span><span class="No-Break"><span class="koboSpan" id="kobo.822.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.823.1">codebase/symfony/src/Entity/Consumption.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.824.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer078">
<span class="koboSpan" id="kobo.825.1"><img alt="Figure 5.21 – Consumption entity" src="image/Figure_5.21_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.826.1">Figure 5.21 – Consumption entity</span></p>
<p><span class="koboSpan" id="kobo.827.1">If you open the file, you’ll see the automatically generated Doctrine </span><span class="No-Break"><span class="koboSpan" id="kobo.828.1">entity codes:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.829.1">
&lt;?php
namespace App\Entity;
use App\Repository\ConsumptionRepository;
use Doctrine\ORM\Mapping as ORM;
#[ORM\Entity(repositoryClass: ConsumptionRepository::class)]
class Consumption
{
    #[ORM\Id]
    #[ORM\GeneratedValue]
    #[ORM\Column(type: 'integer')]
    private $id;
    #[ORM\Column(type: 'string', length: 50)]
    private $name;
    #[ORM\Column(type: 'integer')]
    private $total;
    public function getId(): ?int
    {
        return $this-&gt;id;
    }
    public function getName(): ?string
    {
        return $this-&gt;name;
    }
    public function setName(string $name): self
    {
        $this-&gt;name = $name;
        return $this;
    }
    public function getTotal(): ?int
    {
        return $this-&gt;total;
    }
    public function setTotal(int $total): self
    {
        $this-&gt;total = $total;
        return $this;
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.830.1">In summary, we only have two fields to play with, the name and total fields. </span><span class="koboSpan" id="kobo.830.2">That’s going to be perfect for </span><a id="_idIndexMarker223"/><span class="koboSpan" id="kobo.831.1">our integration </span><span class="No-Break"><span class="koboSpan" id="kobo.832.1">test example.</span></span></p>
<p><span class="koboSpan" id="kobo.833.1">Next, we’ll need the actual database table that our Doctrine entity is going to represent. </span><span class="koboSpan" id="kobo.833.2">We will use Doctrine ORM to run the migration tool so that we can generate the database tables </span><span class="No-Break"><span class="koboSpan" id="kobo.834.1">we need.</span></span></p>
<h2 id="_idParaDest-88"><a id="_idTextAnchor089"/><span class="koboSpan" id="kobo.835.1">Creating a Doctrine table for the entity</span></h2>
<p><span class="koboSpan" id="kobo.836.1">Now that we </span><a id="_idIndexMarker224"/><span class="koboSpan" id="kobo.837.1">have an entity, let’s also create the database table that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.838.1">Consumption</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.839.1">entity represents.</span></span></p>
<p><span class="koboSpan" id="kobo.840.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.841.1">following commands:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.842.1">
/var/www/html/symfony# php bin/console make:migration
/var/www/html/symfony# php bin/console doctrine:migrations:migrate</span></pre>
<p><span class="koboSpan" id="kobo.843.1">After </span><a id="_idIndexMarker225"/><span class="koboSpan" id="kobo.844.1">running the preceding commands, a new database table should be created for you. </span><span class="koboSpan" id="kobo.844.2">If you go back to the </span><strong class="bold"><span class="koboSpan" id="kobo.845.1">PHPMyAdmin</span></strong><span class="koboSpan" id="kobo.846.1"> page, you’ll see the new consumption table created, based on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.847.1">Consumption.php</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.848.1">entity class:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer079">
<span class="koboSpan" id="kobo.849.1"><img alt="Figure 5.22 – consumption database table" src="image/Figure_5.22_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.850.1">Figure 5.22 – consumption database table</span></p>
<p><span class="koboSpan" id="kobo.851.1">We now have a database table that will be represented by our </span><strong class="source-inline"><span class="koboSpan" id="kobo.852.1">Consumption.php</span></strong><span class="koboSpan" id="kobo.853.1"> entity class. </span><span class="koboSpan" id="kobo.853.2">This table will be used to persist our coffee drinkers’ coffee </span><span class="No-Break"><span class="koboSpan" id="kobo.854.1">consumption records!</span></span></p>
<p><span class="koboSpan" id="kobo.855.1">However, when </span><a id="_idIndexMarker226"/><span class="koboSpan" id="kobo.856.1">working on a real project, we don’t want to use the main database for running our tests; otherwise, our tests will end up inserting test data into the production database. </span><span class="koboSpan" id="kobo.856.2">Next, we’ll create the test database. </span><span class="koboSpan" id="kobo.856.3">This database will be specifically used by our integration tests and will mirror the structure of the </span><span class="No-Break"><span class="koboSpan" id="kobo.857.1">main database.</span></span></p>
<h2 id="_idParaDest-89"><a id="_idTextAnchor090"/><span class="koboSpan" id="kobo.858.1">Creating a test database</span></h2>
<p><span class="koboSpan" id="kobo.859.1">Just like in the </span><a id="_idIndexMarker227"/><span class="koboSpan" id="kobo.860.1">previous set of instructions, we’ll also create a database based on some environment configuration – but this time, this is specifically intended to be used by </span><span class="No-Break"><span class="koboSpan" id="kobo.861.1">our tests.</span></span></p>
<p><span class="koboSpan" id="kobo.862.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.863.1">.env.test</span></strong><span class="koboSpan" id="kobo.864.1"> file and add the following line at the end of </span><span class="No-Break"><span class="koboSpan" id="kobo.865.1">the file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.866.1">
DATABASE_URL="mysql://root:mypassword@server-mysql/coffee?serverVersion=8&amp;charset=utf8mb4"</span></pre>
<p><span class="koboSpan" id="kobo.867.1">You’ll notice that it’s identical to the value we used for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.868.1">.env.local</span></strong><span class="koboSpan" id="kobo.869.1"> file. </span><span class="koboSpan" id="kobo.869.2">Notice that we reused </span><strong class="source-inline"><span class="koboSpan" id="kobo.870.1">coffee</span></strong><span class="koboSpan" id="kobo.871.1"> as the </span><span class="No-Break"><span class="koboSpan" id="kobo.872.1">database name.</span></span></p>
<p><span class="koboSpan" id="kobo.873.1">Now, run the following command to create the </span><span class="No-Break"><span class="koboSpan" id="kobo.874.1">test database:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.875.1">
/var/www/html/symfony# php bin/console doctrine:database:create --env=test</span></pre>
<p><span class="koboSpan" id="kobo.876.1">A new database named </span><strong class="source-inline"><span class="koboSpan" id="kobo.877.1">coffee_test</span></strong><span class="koboSpan" id="kobo.878.1"> will be created. </span><strong class="source-inline"><span class="koboSpan" id="kobo.879.1">_test</span></strong><span class="koboSpan" id="kobo.880.1"> is suffixed to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.881.1">coffee</span></strong><span class="koboSpan" id="kobo.882.1"> database name we have specified. </span><span class="koboSpan" id="kobo.882.2">Every integration test we run that uses the database will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.883.1">coffee_test</span></strong><span class="koboSpan" id="kobo.884.1"> database to persist and read data. </span></p>
<p><span class="koboSpan" id="kobo.885.1">Next, run the following command so that we can also migrate the </span><strong class="source-inline"><span class="koboSpan" id="kobo.886.1">Consumption</span></strong><span class="koboSpan" id="kobo.887.1"> table into our new </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.888.1">coffee_test</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.889.1"> database:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.890.1">
/var/www/html/symfony# php bin/console doctrine:migrations:migrate -n --env=test</span></pre>
<p><span class="koboSpan" id="kobo.891.1">At this stage, we’ll have two almost identical databases. </span><span class="koboSpan" id="kobo.891.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.892.1">coffee</span></strong><span class="koboSpan" id="kobo.893.1"> database that’s to be used for the solution, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.894.1">coffee_test</span></strong><span class="koboSpan" id="kobo.895.1"> database that’s to be used for </span><span class="No-Break"><span class="koboSpan" id="kobo.896.1">our tests.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer080">
<span class="koboSpan" id="kobo.897.1"><img alt="Figure 5.23 – Coffee databases" src="image/Figure_5.23_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.898.1">Figure 5.23 – Coffee databases</span></p>
<p><span class="koboSpan" id="kobo.899.1">Now that we </span><a id="_idIndexMarker228"/><span class="koboSpan" id="kobo.900.1">have created our databases, and we also have the Doctrine ORM, which will serve as the main tool for communicating with our database from the PHP code base, we will now start building the solution codes to pass our failing </span><span class="No-Break"><span class="koboSpan" id="kobo.901.1">integration test.</span></span></p>
<h2 id="_idParaDest-90"><a id="_idTextAnchor091"/><span class="koboSpan" id="kobo.902.1">Putting things together</span></h2>
<p><span class="koboSpan" id="kobo.903.1">At this </span><a id="_idIndexMarker229"/><span class="koboSpan" id="kobo.904.1">stage, we’re now ready to start building the missing solution code that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.905.1">ComputationServiceTest.php</span></strong><span class="koboSpan" id="kobo.906.1"> integration test keeps on complaining about. </span><span class="koboSpan" id="kobo.906.2">Remember this message from our </span><span class="No-Break"><span class="koboSpan" id="kobo.907.1">failing test?</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.908.1">Error: Class "App\Tests\Integration\Service\ConsumptionService" </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.909.1">not found</span></strong></span></p>
<p><span class="koboSpan" id="kobo.910.1">Let’s start fixing that error by following these steps: </span></p>
<ol>
<li><span class="koboSpan" id="kobo.911.1">First, open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.912.1">services.yaml</span></strong><span class="koboSpan" id="kobo.913.1"> file and update it with the </span><span class="No-Break"><span class="koboSpan" id="kobo.914.1">following content:</span></span></li>
</ol>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.915.1">codebase/symfony/config/services.yaml</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.916.1">
# This file is the entry point to configure your own services.
</span><span class="koboSpan" id="kobo.916.2"># Files in the packages/ subdirectory configure your dependencies.
</span><span class="koboSpan" id="kobo.916.3"># Put parameters here that don't need to change on each machine where the app is deployed
# https://symfony.com/doc/current/best_practices.html#use-parameters-for-application-configuration
parameters:
services:
    # default configuration for services in *this* file
    _defaults:
        autowire: true      # Automatically injects 
            dependencies in your services.
</span><span class="koboSpan" id="kobo.916.4">        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.
</span><span class="koboSpan" id="kobo.916.5">    # makes classes in src/ available to be used as 
        services
    # this creates a service per class whose id is the 
        fully-qualified class name
    App\:
        resource: '../src/'
        exclude:
            - '../src/DependencyInjection/'
            - '../src/Entity/'
            - '../src/Kernel.php'
    App\Service\ConsumptionService:
        public: true
    # add more service definitions when explicit 
        configuration is needed
    # please note that last definitions always 
        *replace* previous ones</span></pre>
<p><span class="koboSpan" id="kobo.917.1">Since we are </span><a id="_idIndexMarker230"/><span class="koboSpan" id="kobo.918.1">using Symfony for this example, we will use its PSR-11-compliant service container to create instances of the objects we need. </span><span class="koboSpan" id="kobo.918.2">Instead of using the </span><em class="italic"><span class="koboSpan" id="kobo.919.1">new</span></em><span class="koboSpan" id="kobo.920.1"> PHP keyword to create an instance of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.921.1">ConsumptionService.php</span></strong><span class="koboSpan" id="kobo.922.1"> class that we are about to write, we’ll use the service </span><span class="No-Break"><span class="koboSpan" id="kobo.923.1">container instead.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.924.1">Create the following class with the </span><span class="No-Break"><span class="koboSpan" id="kobo.925.1">following content:</span></span></li>
</ol>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.926.1">codebase/symfony/src/Service/ConsumptionService.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.927.1">
&lt;?php
namespace App\Service;
use App\Entity\Consumption;
use App\Example\Calculator;
use Doctrine\Persistence\ManagerRegistry;
class ConsumptionService
{
    /**
     * @var Calculator
     */
    private Calculator $calculator;
    /**
     * @var ManagerRegistry
     */
    private $managerRegistry;
    /**
     * @param ManagerRegistry $doctrine
     * @param Calculator $calculator
     */
    public function __construct(ManagerRegistry $doctrine, Calculator $calculator)
    {
        $this-&gt;setManagerRegistry($doctrine);
        $this-&gt;setCalculator($calculator);
    }
    /**
     * @param string $name
     * @param int $morning
     * @param int $afternoon
     * @param int $evening
     * @return int
     */
    public function calculateAndSave(string $name, int 
        $morning, int $afternoon, int $evening): int
    {
        $entityManager = $this-&gt;getManagerRegistry()-&gt;
            getManager();
        // Calculate total:
        $sum = $this-&gt;getCalculator()-&gt;calculateTotal
            ($morning, $afternoon, $evening);
        // Consumption model or entity:
        $consumption = new Consumption();
        $consumption-&gt;setName($name);
        $consumption-&gt;setTotal($sum);
        // Persist using the Entity Manager:
        $entityManager-&gt;persist($consumption);
        $entityManager-&gt;flush();
        return $consumption-&gt;getId();
    }
    /**
     * @return Calculator
     */
    public function getCalculator(): Calculator
    {
        return $this-&gt;calculator;
    }
    /**
     * @param Calculator $calculator
     */
    public function setCalculator(Calculator 
        $calculator): void
    {
        $this-&gt;calculator = $calculator;
    }
    /**
     * @return ManagerRegistry
     */
    public function getManagerRegistry(): ManagerRegistry
    {
        return $this-&gt;managerRegistry;
    }
    /**
     * @param ManagerRegistry $managerRegistry
     */
    public function setManagerRegistry(ManagerRegistry 
        $managerRegistry): void
    {
        $this-&gt;managerRegistry = $managerRegistry;
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.928.1">Let’s quickly go through the things we did in this class before we move back to our integration test class. </span><span class="koboSpan" id="kobo.928.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.929.1">ConsumptionService</span></strong><span class="koboSpan" id="kobo.930.1"> class depends on two objects, </span><strong class="source-inline"><span class="koboSpan" id="kobo.931.1">ManagerRegistry</span></strong><span class="koboSpan" id="kobo.932.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.933.1">CalculationService</span></strong><span class="koboSpan" id="kobo.934.1">. </span><span class="koboSpan" id="kobo.934.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.935.1">calculateAndSave</span></strong><span class="koboSpan" id="kobo.936.1"> method will then use these two objects to achieve </span><span class="No-Break"><span class="koboSpan" id="kobo.937.1">its goal.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.938.1">Now, let’s go </span><a id="_idIndexMarker231"/><span class="koboSpan" id="kobo.939.1">back to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.940.1">ConsumptionServiceTest.php</span></strong><span class="koboSpan" id="kobo.941.1"> class, and replace its content with </span><span class="No-Break"><span class="koboSpan" id="kobo.942.1">the following:</span></span></li>
</ol>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.943.1">codebase/symfony/tests/Integration/Service/ConsumptionTest.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.944.1">
&lt;?php
namespace App\Tests\Integration\Service;
use App\Entity\Consumption;
use App\Service\ConsumptionService;
use Symfony\Bundle\FrameworkBundle\Test\
    KernelTestCase;
class ConsumptionServiceTest extends KernelTestCase
{
    public function testCanComputeAndSave()
    {
        self::bootKernel();
        // Given
        $name               = "Damo";
        $morningCoffee      = 2;
        $afternoonCoffee    = 3;
        $eveningCoffee      = 1;
        // Expected Total:
        $expectedTotal = 6;
        // Test Step 1: Get the Symfony's service 
            container:
        $container = static::getContainer();
        // Test Step 2: Use PSR-11 standards to get an 
        instance of our service, pre-injected with the 
        EntityManager:
        /** @var ConsumptionService $service */
        $service = $container-&gt;get
            (ConsumptionService::class);
        // Test Step 3: Run the method we want to test for:
        $persistedId = $service-&gt;calculateAndSave
            ($name, $morningCoffee, $afternoonCoffee, 
                $eveningCoffee);
        // Test Step 4: Verify if the data persisted 
            data is correct:
        $em             = $service-&gt;
            getManagerRegistry()-&gt;getManager();
        $recordFromDb   = $em-&gt;find
            (Consumption::class, $persistedId);
        $this-&gt;assertEquals($expectedTotal, 
            $recordFromDb-&gt;getTotal());
        $this-&gt;assertEquals($name, $recordFromDb-&gt;
            getName());
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.945.1">I have left comments</span><a id="_idIndexMarker232"/><span class="koboSpan" id="kobo.946.1"> in the code to explain clearly what we did in the test. </span><span class="koboSpan" id="kobo.946.2">Let us understand it in </span><span class="No-Break"><span class="koboSpan" id="kobo.947.1">more detail:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.948.1">Test step 1</span></strong><span class="koboSpan" id="kobo.949.1">: Since we are using Symfony and are extending the </span><strong class="source-inline"><span class="koboSpan" id="kobo.950.1">KernelTestCase</span></strong><span class="koboSpan" id="kobo.951.1"> class, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.952.1">static::getContainer()</span></strong><span class="koboSpan" id="kobo.953.1"> method to get an instance of Symfony’s service container. </span><span class="koboSpan" id="kobo.953.2">We will use this to create an instance of our </span><strong class="source-inline"><span class="koboSpan" id="kobo.954.1">ConsumptionService</span></strong><span class="koboSpan" id="kobo.955.1"> instead of manually using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.956.1">new</span></strong><span class="koboSpan" id="kobo.957.1"> PHP keyword to </span><span class="No-Break"><span class="koboSpan" id="kobo.958.1">instantiate it.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.959.1">Test step 2</span></strong><span class="koboSpan" id="kobo.960.1">: Since we are using Symfony, we can use its PSR-11-compliant service container. </span><span class="koboSpan" id="kobo.960.2">We can use this service container to get instances of classes without having to manually instantiate their dependencies. </span><span class="koboSpan" id="kobo.960.3">For example, our </span><strong class="source-inline"><span class="koboSpan" id="kobo.961.1">ConsumptionService</span></strong><span class="koboSpan" id="kobo.962.1"> class expects two objects in its constructor. </span><span class="koboSpan" id="kobo.962.2">With the service container being configured for auto wiring, the container will automatically instantiate the dependencies declared in the constructor of </span><strong class="source-inline"><span class="koboSpan" id="kobo.963.1">ConsumptionService</span></strong><span class="koboSpan" id="kobo.964.1">. </span><span class="koboSpan" id="kobo.964.2">The auto wiring configuration is declared in </span><strong class="source-inline"><span class="koboSpan" id="kobo.965.1">codebase/symfony/config/services.yaml</span></strong><span class="koboSpan" id="kobo.966.1"> we have modified earlier in </span><span class="No-Break"><span class="koboSpan" id="kobo.967.1">this chapter.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.968.1">Test step 3</span></strong><span class="koboSpan" id="kobo.969.1">: This is where it all matters! </span><span class="koboSpan" id="kobo.969.2">This is the method we are trying to test. </span><span class="koboSpan" id="kobo.969.3">We execute the </span><strong class="source-inline"><span class="koboSpan" id="kobo.970.1">calculateAndSave</span></strong><span class="koboSpan" id="kobo.971.1"> method. </span><span class="koboSpan" id="kobo.971.2">We expect that in this step, the summation of the three integers we provided will be summed up, and then persisted into </span><span class="No-Break"><span class="koboSpan" id="kobo.972.1">the database.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.973.1">Test step 4</span></strong><span class="koboSpan" id="kobo.974.1">: If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.975.1">calculateAndSave</span></strong><span class="koboSpan" id="kobo.976.1"> method succeeded in doing its job, then we can test it for real. </span><span class="koboSpan" id="kobo.976.2">We will retrieve a hydrated </span><strong class="source-inline"><span class="koboSpan" id="kobo.977.1">Consumption</span></strong><span class="koboSpan" id="kobo.978.1"> entity by using the entity manager object inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.979.1">ConsumptionService</span></strong><span class="koboSpan" id="kobo.980.1">. </span><span class="koboSpan" id="kobo.980.2">We will read the data stored in the database and compare it to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.981.1">$expectedTotal</span></strong><span class="koboSpan" id="kobo.982.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.983.1">$name</span></strong><span class="koboSpan" id="kobo.984.1"> values we have declared in the test by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.985.1">assertEquals</span></strong><span class="koboSpan" id="kobo.986.1"> method. </span><span class="koboSpan" id="kobo.986.2">If all goes well, then we should now be able to pass </span><span class="No-Break"><span class="koboSpan" id="kobo.987.1">the test.</span></span></li>
</ul>
<ol>
<li value="4"><span class="koboSpan" id="kobo.988.1">Now, execute the integration test again by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.989.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.990.1">/var/www/html/symfony# ./runDebug.sh --testsuite Integration --filter ConsumptionServiceTest</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.991.1">This time around, we should now be able to pass the test! </span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.992.1">
root@0cb77fcadb5f:/var/www/html/symfony# ./runDebug.sh --testsuite Integration --filter ConsumptionServiceTest
PHPUnit 9.5.5 by Sebastian Bergmann and contributors.
</span><span class="koboSpan" id="kobo.992.2">Testing
.                                                                   1 / 1 (100%)
Time: 00:00.580, Memory: 18.00 MB
OK (1 test, 2 assertions)
root@0cb77fcadb5f:/var/www/html/symfony#</span></pre>
<ol>
<li value="5"><span class="koboSpan" id="kobo.993.1">Great! </span><span class="koboSpan" id="kobo.993.2">We finally</span><a id="_idIndexMarker233"/><span class="koboSpan" id="kobo.994.1"> passed our first integration test! </span><span class="koboSpan" id="kobo.994.2">To see the record that we just created in the database, run the following command: </span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.995.1">/var/www/html/symfony# php bin/console dbal:run-sql 'SELECT * FROM consumption' --env=test</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.996.1">You should get the </span><span class="No-Break"><span class="koboSpan" id="kobo.997.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer081">
<span class="koboSpan" id="kobo.998.1"><img alt="Figure 5.24 – Database result" src="image/Figure_5.24_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.999.1">Figure 5.24 – Database result</span></p>
<p><span class="koboSpan" id="kobo.1000.1">Success! </span><span class="koboSpan" id="kobo.1000.2">We were able to create an integration test, create the solution class, and finally pass the </span><span class="No-Break"><span class="koboSpan" id="kobo.1001.1">integration test!</span></span></p>
<h2 id="_idParaDest-91"><a id="_idTextAnchor092"/><span class="koboSpan" id="kobo.1002.1">Why did we use an integration test in the first place?</span></h2>
<p><span class="koboSpan" id="kobo.1003.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1004.1">ConsumptionService.php</span></strong><span class="koboSpan" id="kobo.1005.1"> class and check the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1006.1">constructor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1007.1"> method.</span></span></p>
<p><span class="koboSpan" id="kobo.1008.1">In the constructor, we have </span><a id="_idIndexMarker234"/><span class="koboSpan" id="kobo.1009.1">specified two required parameters. </span><span class="koboSpan" id="kobo.1009.2">We require a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1010.1">ManagerRegistry</span></strong><span class="koboSpan" id="kobo.1011.1"> instance and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1012.1">Calculator</span></strong><span class="koboSpan" id="kobo.1013.1"> instance that we ourselves developed earlier in the chapter. </span><span class="koboSpan" id="kobo.1013.2">These are two objects that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1014.1">ComputationService.php</span></strong><span class="koboSpan" id="kobo.1015.1"> class depends on. </span><span class="koboSpan" id="kobo.1015.2">Now, this is exactly why we need an integration test and not a unit test. </span></p>
<p><span class="koboSpan" id="kobo.1016.1">When we execute the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1017.1">calculateAndSave</span></strong><span class="koboSpan" id="kobo.1018.1"> method, we will be using business logic that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1019.1">ConsumptionService</span></strong><span class="koboSpan" id="kobo.1020.1"> does not have. </span><span class="koboSpan" id="kobo.1020.2">Rather, it depends on other objects to achieve its goal. </span><span class="koboSpan" id="kobo.1020.3">In contrast with the methods we build unit tests for, those methods do not rely on other objects to do their jobs. </span><span class="koboSpan" id="kobo.1020.4">That’s the main difference between a unit test and an </span><span class="No-Break"><span class="koboSpan" id="kobo.1021.1">integration test.</span></span></p>
<h1 id="_idParaDest-92"><a id="_idTextAnchor093"/><span class="koboSpan" id="kobo.1022.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.1023.1">In this chapter, we defined what unit testing is by writing our own examples. </span><span class="koboSpan" id="kobo.1023.2">We have gone through building and passing unit tests, as well as writing our own shell scripts to help us execute different automated test configurations to make it easier for us to debug or run test coverages. </span><span class="koboSpan" id="kobo.1023.3">We’ve gone through what a test coverage report is, and how we can use it. </span></p>
<p><span class="koboSpan" id="kobo.1024.1">We’ve written our first integration test and configured our development environment so that we can also use a MySQL database. </span><span class="koboSpan" id="kobo.1024.2">We’ve created a solution class that will perform the business logic that we need to pass the test, and we are also able to verify that what we persist in the database is what we </span><span class="No-Break"><span class="koboSpan" id="kobo.1025.1">have intended.</span></span></p>
<p><span class="koboSpan" id="kobo.1026.1">In this chapter, we tried to clearly define what a unit test and an integration test are, how they differ, and why we must separate them into their baskets or test suites. </span></p>
<p><span class="koboSpan" id="kobo.1027.1">In the next chapter, we will be talking about </span><strong class="bold"><span class="koboSpan" id="kobo.1028.1">Behaviour-Driven Development</span></strong><span class="koboSpan" id="kobo.1029.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1030.1">BDD</span></strong><span class="koboSpan" id="kobo.1031.1">). </span><span class="koboSpan" id="kobo.1031.2">We will understand what it is used for, why we need it, and how it is related </span><span class="No-Break"><span class="koboSpan" id="kobo.1032.1">to TDD.</span></span></p>
</div>
</body></html>