<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Creating an E-Commerce Site"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Creating an E-Commerce Site</h1></div></div></div><p>This is a small, concise e-commerce application. There's no admin CMS to manage products (it would have been too much to write about in this chapter), but there is an easy-to-use (and importantly for you easy to adapt) process to display products and let customers order them.</p><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Design and wireframes</li><li class="listitem" style="list-style-type: disc">Creating the database</li><li class="listitem" style="list-style-type: disc">Creating models</li><li class="listitem" style="list-style-type: disc">Creating views</li><li class="listitem" style="list-style-type: disc">Creating controllers</li><li class="listitem" style="list-style-type: disc">Putting it all together</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec71"/>Introduction</h1></div></div></div><p>In this project, we will create a simple shopping cart. This application will allow customers to view products, filter products<a id="id562" class="indexterm"/> by category, and add products to their cart.</p><p>It will also let customers alter their shopping cart by removing items or changing the quantity of these items.</p><p>Finally, there is a customer details form that allows their personal details to be saved against an order for processing.</p><p>To create the web application for this project, we will create one controller; this will handle the display of products, amend the quantities of products in the cart, and also handle the processing of orders.</p><p>We'll create a language file to store text, which will allow you to have multiple language support should that be required.</p><p>We'll create all the necessary view files and a model to interface with the database.</p><p>However, this app along with all the others in this book relies on the basic setup we did in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>; although you can take large sections of the code and <a id="id563" class="indexterm"/>drop it into pretty much any app you might already have, please keep in mind that the setup done in the first chapter acts as a foundation for this chapter.</p><p>So without further ado, let's get on with it.</p></div></div>
<div class="section" title="Design and wireframes"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec72"/>Design and wireframes</h1></div></div></div><p>As always, before we start building, we should take a look at what we plan to build.</p><p>Firstly, we will provide a<a id="id564" class="indexterm"/> brief description of our intent. We plan to build an app that will allow people to view products as an online shop. They can sort these products <a id="id565" class="indexterm"/>by category. Add products to a cart and enter their details to create an order. A special code called <code class="literal">order_fulfilment_code</code> is generated (saved in the database in <code class="literal">orders.order_fulfilment_code</code>). This code will allow you to track any order through a payment system.</p><p>Anyway, to get a better idea of what's happening, let's take a look at the following site map:</p><div class="mediaobject"><img src="graphics/7093OS_07_01.jpg" alt="Design and wireframes"/></div><p>So that's the site map—the first thing to notice is how simple the site is. There are only four main areas<a id="id566" class="indexterm"/> to this project. Let's go over each item and get a brief idea<a id="id567" class="indexterm"/> of what it does:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Home</strong></span>: This is the initial landing area. The <code class="literal">index()</code> function displays products to view and also displays categories with which a user can filter the products to see items<a id="id568" class="indexterm"/> related to that category. So, by clicking on the Books category, they will see only products that are assigned the category as books.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Add to cart</strong></span>: This processes<a id="id569" class="indexterm"/> the addition of a product to the user's cart. The number of items in a cart is presented in the navigation bar at all times.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Cart</strong></span>: This displays a list<a id="id570" class="indexterm"/> of items in the cart as well as an option to increase or decrease the number of each items in that cart.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Proceed to checkout</strong></span>: This<a id="id571" class="indexterm"/> displays a form to the users, inviting them to enter their information. Once they press Go, their order and details are added to the database for processing.</li></ul></div><p>Now that we have a fairly good idea of the structure and form of the site, let's take a look at some wireframes of each page.</p><div class="section" title="Home – index()"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec63"/>Home – index()</h2></div></div></div><p>The following screenshot shows you<a id="id572" class="indexterm"/> a wireframe from point <span class="strong"><strong>1</strong></span> (the Home (<code class="literal">index()</code>) item) in the site map. Initially, the user is shown a list of products. This list is not filtered. On the right-hand side of the wireframe is<a id="id573" class="indexterm"/> a list of categories (as found in the <code class="literal">categories</code> table). The user is able to click on these categories to filter the results they view on the left-hand side, and clicking on All Categories clears the filter once more. </p><p>Beneath each product is the <span class="strong"><strong>Add to cart</strong></span> button, which allows the user to add a particular product to their cart.</p><div class="mediaobject"><img src="graphics/7093OS_07_02.jpg" alt="Home – index()"/></div></div><div class="section" title="Add to cart – add()"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec64"/>Add to cart – add()</h2></div></div></div><p>The following<a id="id574" class="indexterm"/> screenshot shows you a user clicking and adding a product to their cart. This is done by clicking on an <span class="strong"><strong>Add to</strong></span><a id="id575" class="indexterm"/>
<span class="strong"><strong> cart</strong></span> button below a particular product. Clicking on this button will call the <code class="literal">shop</code> controller's <code class="literal">add()</code> function, which will then call the CodeIgniter <code class="literal">Cart</code> class' <code class="literal">$this-&gt;cart-&gt;insert()</code> function, which will add the product to the cart.</p><div class="mediaobject"><img src="graphics/7093OS_07_05.jpg" alt="Add to cart – add()"/></div></div><div class="section" title="Cart – display_cart()"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec65"/>Cart – display_cart()</h2></div></div></div><p>The following <a id="id576" class="indexterm"/>screenshot shows you a wireframe from point 3 (the Cart <code class="literal">display_cart()</code> item) in the site map. The user is presented with a list of items currently in the cart. The <code class="literal">display_cart()</code> function is <a id="id577" class="indexterm"/>accessed in two ways—either by clicking on the <span class="strong"><strong>Cart</strong></span> link in the top navigation menu or immediately after clicking on <span class="strong"><strong>Add to cart</strong></span> under a product displayed in point <span class="strong"><strong>1</strong></span> (the Home <code class="literal">index()</code> item) in the site map. Adjusting the value in the text box under Quantity and pressing the <span class="strong"><strong>Update Cart</strong></span> button will increase or decrease the number of that product in<a id="id578" class="indexterm"/> the cart. </p><p>Pressing Proceed to check out will call the <code class="literal">user_details()</code> function from point <span class="strong"><strong>4</strong></span> (the Proceed to checkout item) in the site map.</p><div class="mediaobject"><img src="graphics/7093OS_07_03.jpg" alt="Cart – display_cart()"/></div></div><div class="section" title="User Details – user_details()"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec66"/>User Details – user_details()</h2></div></div></div><p>The following screenshot shows you a <a id="id579" class="indexterm"/>wireframe from point <span class="strong"><strong>4</strong></span> (the Proceed to checkout <code class="literal">user_details()</code> item) in the site map. The user<a id="id580" class="indexterm"/> is presented with a form in which they can add their contact and delivery details for the order. Once the user enters their details and presses Go, their order (content of the cart) and contact details are written to the <code class="literal">orders</code> and <code class="literal">customer</code> tables, which are joined in the <code class="literal">orders</code> table by the customer ID.</p><div class="mediaobject"><img src="graphics/7093OS_07_04.jpg" alt="User Details – user_details()"/></div></div><div class="section" title="File overview"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec67"/>File overview</h2></div></div></div><p>This is a relatively<a id="id581" class="indexterm"/> small project, and all in all, we're only going to create seven files; these are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/shop_model.php</code>: This provides read/write access to<a id="id582" class="indexterm"/> the<a id="id583" class="indexterm"/> database.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/shop/display_products.php</code>: This displays a list of products to the user, allows them to add a product to the cart, and filters<a id="id584" class="indexterm"/> products by categories—as defined in the <code class="literal">categories</code> table.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/shop/display_cart.php</code>: This displays the contents <a id="id585" class="indexterm"/>of the cart to the user. There are form options to amend product quantities and proceed to the checkout.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/shop/user_details.php</code>: This displays a form to the user, allowing them to enter their contact details for their order fulfillment. User information is stored in the <code class="literal">customer</code> table, which is<a id="id586" class="indexterm"/> joined to the <code class="literal">orders</code> table—in the <code class="literal">orders</code> table—by the <code class="literal">customer</code> table's primary key.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/nav/top_nav.php</code>: This provides a navigation<a id="id587" class="indexterm"/> bar at the top of the page.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/shop.php</code>: This contains all the necessary<a id="id588" class="indexterm"/> functions to display products, add products to a cart, amend that cart, and process the customer details.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/language/english/en_admin_lang.php</code>: This provides <a id="id589" class="indexterm"/>language support for the application.</li></ul></div><p>The file structure of the preceding seven files is as follows:</p><div class="informalexample"><pre class="programlisting">application/
├── controllers/
│   ├── shop.php
├── models/
│   ├── shop_model.php
├── views/shop/
│   ├── display_products.php
│   ├── display_cart.php
│   ├── user_details.php
├── views/nav/
│   ├── top_nav.php
├── language/english/
│   ├── en_admin_lang.php</pre></div></div></div>
<div class="section" title="Creating the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec73"/>Creating the database</h1></div></div></div><p>Okay, you <a id="id590" class="indexterm"/>should have<a id="id591" class="indexterm"/> already set up CodeIgniter and Bootstrap as described in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>. If not, then you should know that the code in this chapter is specifically built with the setup from <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>, in mind. However, it's not the end of the world if you haven't; the code can easily be applied to other situations.</p><p>First, we'll build the<a id="id592" class="indexterm"/> database. Copy the following MySQL <a id="id593" class="indexterm"/>code to your database:</p><div class="informalexample"><pre class="programlisting">CREATE DATABASE `shopdb`;
USE DATABASE `shopdb`;

CREATE TABLE `categories` (
  `cat_id` int(11) NOT NULL AUTO_INCREMENT,
  `cat_name` varchar(50) NOT NULL,
  `cat_url_name` varchar(15) NOT NULL,
  PRIMARY KEY (`cat_id`)
) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=latin1;

INSERT INTO `categories` VALUES (1,'Shirts','shirts'),(2,'Footware','footware'),(3,'Books','books'),(4,'Beauty','beauty'),(5,'Software','software'),(6,'Computers','computers'),(7,'Kitchen Ware','kitchenware'),(8,'Luggage','luggage'),(9,'Camping','camping'),(10,'Sports','sports');

CREATE TABLE `ci_sessions` (
  `session_id` varchar(40) COLLATE utf8_bin NOT NULL DEFAULT '0',
  `ip_address` varchar(16) COLLATE utf8_bin NOT NULL DEFAULT '0',
  `user_agent` varchar(120) COLLATE utf8_bin DEFAULT NULL,
  `last_activity` int(10) unsigned NOT NULL DEFAULT '0',
  `user_data` text COLLATE utf8_bin NOT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

CREATE TABLE `customer` (
  `cust_id` int(11) NOT NULL AUTO_INCREMENT,
  `cust_first_name` varchar(125) NOT NULL,
  `cust_last_name` varchar(125) NOT NULL,
  `cust_email` varchar(255) NOT NULL,
  `cust_created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `cust_address` text NOT NULL COMMENT 'card holder address',
  PRIMARY KEY (`cust_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=latin1;

CREATE TABLE `orders` (
  `order_id` int(11) NOT NULL AUTO_INCREMENT,
  `cust_id` int(11) NOT NULL,
  `order_details` text NOT NULL,
  `order_subtotal` int(11) NOT NULL,
  `order_created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `order_closed` int(1) NOT NULL COMMENT '0 = open, 1 = closed',
  `order_fulfilment_code` varchar(255) NOT NULL COMMENT 'the unique code sent to a payment provider',
  `order_delivery_address` text NOT NULL,
  PRIMARY KEY (`order_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=latin1;

CREATE TABLE `products` (
  `product_id` int(11) NOT NULL AUTO_INCREMENT,
  `product_name` varchar(255) NOT NULL,
  `product_code` int(11) NOT NULL,
  `product_description` varchar(255) NOT NULL,
  `category_id` int(11) NOT NULL,
  `product_price` int(11) NOT NULL,
  PRIMARY KEY (`product_id`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=latin1;

INSERT INTO `products` VALUES (1,'Running Shoes',423423,'These are some shoes',2,50),(2,'Hawaiian Shirt',34234,'This is a shirt',1,25),(3,'Slippers',23134,'Nice comfortable  slippers',2,4),(4,'Shirt',2553245,'White Office Shirt',1,25),(5,'CodeIgniter Blueprints',5442342,'Some excellent projects to make and do (in CodeIgniter) - it\'s good value too!',3,25),(6,'Office Suite',34234123,'Writer, Calc, Presentation software',5,299),(7,'Anti-Virus',324142,'Get rid of those pesky viruses from your computer',5,29),(8,'Operating System',12341,'This can run your computer',5,30),(9,'Web Browser',42412,'Browse the web with a web browser (that\'s what they\'re for)',5,5),(10,'Dinner set',3241235,'6 dinner plates, 6 side plates, 6 cups',7,45),(11,'Champagne Glasses',1454352,'Crystal glasses to drink fizzy French plonk from ',7,45),(12,'Toaster',523234,'Capable of toasting 4 slices at once!',7,35),(13,'Kettle',62546245,'Heat water with this amazing kettle',7,25);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>Now take a look at that last bit of SQL code; it's quite big and fiddly. Don't panic; all SQL code is available online from this book's support page on the Packt website.</p></div></div><p>You'll see that the<a id="id594" class="indexterm"/> first table we create is <code class="literal">ci_sessions</code>. We need this to allow CodeIgniter to manage sessions, specifically, a customer's cart. However, this is just the standard session table available from the <span class="emphasis"><em>CodeIgniter User Guide</em></span>, so I'll <a id="id595" class="indexterm"/>not include a description of that table as it's not technically specific to this application. However, if you're interested, there's a description at <a class="ulink" href="http://ellislab.com/codeigniter/user-guide/libraries/sessions.html">http://ellislab.com/codeigniter/user-guide/libraries/sessions.html</a>.</p><p>Right, let's take a look at each item in each table and see what it means. First we will see the <code class="literal">categories</code> table.</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th colspan="2" style="text-align: center" valign="bottom">
<p>Table: categories</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Element</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Description</strong></span>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cat_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id596" class="indexterm"/>primary key</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cat_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the name<a id="id597" class="indexterm"/> of the category, and it is displayed as a title in the right-hand side category filter list in the <code class="literal">views/shop/display_products.php</code> file</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cat_url_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is<a id="id598" class="indexterm"/> the short version of the <code class="literal">cat_name</code> element; it is used as the third parameter of the URL when a user clicks<a id="id599" class="indexterm"/> on a category in the<a id="id600" class="indexterm"/> right-hand side category filter list in the <code class="literal">views/shop/display_products.php</code> file</p>
</td></tr></tbody></table></div><p>Now take a look at the<a id="id601" class="indexterm"/> <code class="literal">products</code> table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th colspan="2" style="text-align: center" valign="bottom">
<p>Table: products</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Element</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Description</strong></span>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">product_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id602" class="indexterm"/>primary key</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">product_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id603" class="indexterm"/> name of the product</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">product_code</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is a place<a id="id604" class="indexterm"/> where you can store your internal reference code for the product</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">product_description</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id605" class="indexterm"/> description of the product</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">category_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id606" class="indexterm"/>category that the product belongs to, and it is the primary key of the <code class="literal">categories</code> table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">product_price</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id607" class="indexterm"/> price of the product</p>
</td></tr></tbody></table></div><p>Next we will see the <code class="literal">customer</code> table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th colspan="2" style="text-align: center" valign="bottom">
<p>Table: customer</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Element</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Description</strong></span>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cust_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id608" class="indexterm"/>primary key</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cust_first_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id609" class="indexterm"/> customer's first name</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cust_last_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id610" class="indexterm"/> customer's last name</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cust_email</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id611" class="indexterm"/>customer's e-mail address</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cust_created_at</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id612" class="indexterm"/>MySQL timestamp of the date on which the row was created in the database</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cust_address</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id613" class="indexterm"/> customer address (payment address)</p>
</td></tr></tbody></table></div><p>Finally, let's see the <code class="literal">orders</code> table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th colspan="2" style="text-align: center" valign="bottom">
<p>Table: orders</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Element</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Description</strong></span>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">order_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id614" class="indexterm"/>primary key</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cust_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id615" class="indexterm"/> primary key of the customer from<a id="id616" class="indexterm"/> the <code class="literal">customer</code> table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">order_details</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is a <a id="id617" class="indexterm"/>serialized dump of the <code class="literal">cart</code> table populated by the <code class="literal">serialize($this-&gt;cart-&gt;contents()</code>
<code class="literal">)</code> line</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">order_subtotal</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the value<a id="id618" class="indexterm"/> of the order</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">order_created_at</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id619" class="indexterm"/> MySQL timestamp of the date the row that was created in the database</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">order_closed</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The default <a id="id620" class="indexterm"/>value is <code class="literal">0</code> but can be <code class="literal">1</code>. <code class="literal">0</code>; it indicates that this is a new order, and <code class="literal">1</code> is that the order has been fulfilled</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">order_fulfilment_code</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id621" class="indexterm"/> value of the <code class="literal">$payment_code</code> generated in the <code class="literal">shop</code> controller's <code class="literal">user_details()</code> function, and it can be used to track the<a id="id622" class="indexterm"/> order through a payment system</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">order_delivery_address</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id623" class="indexterm"/>delivery address of the order</p>
</td></tr></tbody></table></div><p>We'll also need to make amends to the <code class="literal">config/database.php</code> file, namely setting the database access details, username password, and so on.</p><p>Open the <code class="literal">config/database.php</code> file and find the following lines:</p><div class="informalexample"><pre class="programlisting">$db['default']['hostname'] = 'localhost';
$db['default']['username'] = 'your username';
$db['default']['password'] = 'your password';
$db['default']['database'] = 'shopdb';</pre></div><p>Now edit the values in the preceding lines, ensuring you substitute these values with ones more specific to <a id="id624" class="indexterm"/>your setup and situation; so, enter your username, password, and so on.</p></div>
<div class="section" title="Adjusting the config.php file"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec74"/>Adjusting the config.php file</h1></div></div></div><p>There are a few<a id="id625" class="indexterm"/> things in this file that we'll need to configure to support sessions and encryption. So open the <code class="literal">config/config.php</code> file and <a id="id626" class="indexterm"/>make the following changes:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We will need to set an encryption key; both sessions and CodeIgniter's encryption functionality require a encryption key to be set in the <code class="literal">$config</code> array, so find the following line:<div class="informalexample"><pre class="programlisting">$config['encryption_key'] = '';</pre></div><p>Replace it with the following:</p><div class="informalexample"><pre class="programlisting">$config['encryption_key'] = 'a-random-string-of-alphanum-characters';</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip11"/>Tip</h3><p>Now obviously, don't actually <a id="id627" class="indexterm"/>change the value to literally a-random-string-of-alphanum-characters; instead, change it to, er, a random string of alphanum characters—if that makes sense? Yeah, you know what I mean.</p></div></div></li><li class="listitem">Find these lines:<div class="informalexample"><pre class="programlisting">$config['sess_cookie_name'] = 'ci_session';
$config['sess_expiration'] = 7200;
$config['sess_expire_on_close'] = FALSE;
$config['sess_encrypt_cookie'] = FALSE;
$config['sess_use_database'] = FALSE;
$config['sess_table_name'] = 'ci_sessions';
$config['sess_match_ip'] = FALSE;
$config['sess_match_useragent'] = TRUE;
$config['sess_time_to_update'] = 300;</pre></div><p>Replace the lines with the following:</p><div class="informalexample"><pre class="programlisting">$config['sess_cookie_name'] = 'ci_session';
$config['sess_expiration'] = 7200;
$config['sess_expire_on_close'] = TRUE;
$config['sess_encrypt_cookie'] = TRUE;
$config['sess_use_database'] = TRUE;
$config['sess_table_name'] = 'ci_sessions';
$config['sess_match_ip'] = TRUE;
$config['sess_match_useragent'] = TRUE;
$config['sess_time_to_update'] = 300;</pre></div></li></ol></div></div>
<div class="section" title="Adjusting the routes.php file"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec75"/>Adjusting the routes.php file</h1></div></div></div><p>We want to<a id="id628" class="indexterm"/> redirect the user to the <code class="literal">shop</code> controller rather than the default CodeIgniter <code class="literal">welcome</code> controller. We will need to amend the default  controller <a id="id629" class="indexterm"/>setting in the <code class="literal">routes.php</code> file to reflect this:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">config/routes.php</code> file for editing and find the following lines (near the bottom of the file):<div class="informalexample"><pre class="programlisting">$route['default_controller'] = "welcome";
$route['404_override'] = '';</pre></div></li><li class="listitem">Firstly, we need to change the default controller. Initially in a CodeIgniter application, the<a id="id630" class="indexterm"/> default controller is set to <code class="literal">welcome</code>; however, we don't need that. Instead, we want the default controller to be <code class="literal">shop</code>. So, find the following line:<div class="informalexample"><pre class="programlisting">$route['default_controller'] = "welcome";</pre></div><p>Change it to the following:</p><div class="informalexample"><pre class="programlisting">$route['default_controller'] = "shop";
$route['404_override'] = '';</pre></div></li></ol></div></div>
<div class="section" title="Creating the model"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec76"/>Creating the model</h1></div></div></div><p>There is only one model in this project—<code class="literal">shop_model.php</code>—which contains functions that are specific to searching and writing products to the database.</p><p>This is our one and<a id="id631" class="indexterm"/> only model for this project; let's briefly go over each function in it to give us a general idea of what it does, and then we will go into more <a id="id632" class="indexterm"/>detail in the code.</p><p>There are five main functions in this model, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">get_product_details()</code>: This<a id="id633" class="indexterm"/> accepts one argument—the <code class="literal">$product_id</code>—of the product being added to the cart and returns a database result object that<a id="id634" class="indexterm"/> contains information about a specific product. This model function is used by the <code class="literal">shop</code> controller's <code class="literal">add()</code> function to fetch the correct details about a product before it is added to the cart.</li><li class="listitem" style="list-style-type: disc"><code class="literal">get_all_products()</code>: This<a id="id635" class="indexterm"/> accepts no argument. This model function will return a list of <a id="id636" class="indexterm"/>products (as defined in the <code class="literal">products</code> table) to the <code class="literal">shop</code> controller's <code class="literal">index()</code> function.</li><li class="listitem" style="list-style-type: disc"><code class="literal">get_all_products_by_category_name()</code>: This accepts one argument—<code class="literal">$cat_url_name</code> (defined in the <a id="id637" class="indexterm"/>database as <code class="literal">categories.cat_url_name</code>). This function is<a id="id638" class="indexterm"/> called if a user has clicked on a category filter link (displayed on the right-hand side of the wireframe in the <span class="emphasis"><em>Home – index()</em></span> section of this chapter).</li><li class="listitem" style="list-style-type: disc"><code class="literal">get_all_categories()</code>: This fetches<a id="id639" class="indexterm"/> categories from the <code class="literal">categories</code> table. It is used to populate the categories<a id="id640" class="indexterm"/> list (displayed on the right-hand side of the wireframe in the <span class="emphasis"><em>Home – index()</em></span> section of this chapter).</li><li class="listitem" style="list-style-type: disc"><code class="literal">save_cart_to_database()</code>: This accepts two<a id="id641" class="indexterm"/> arguments: <code class="literal">$cust_data</code> and <code class="literal">$order_data</code>. The <code class="literal">$cust_data</code> is data<a id="id642" class="indexterm"/> submitted by the user in point <span class="strong"><strong>4</strong></span> (the Proceed to checkout <code class="literal">user_details()</code> item) in the site map, and <code class="literal">$order_data</code> is the contents of their cart. The customer data is added to the <code class="literal">customer</code> table <a id="id643" class="indexterm"/>and the primary key that's generated is used as a foreign key in the <code class="literal">orders</code> table.</li></ul></div><p>That was a quick overview, so let's create the model and discuss how it functions.</p><p>Create the <code class="literal">/path/to/codeigniter/application/models/shop_model.php</code> file and add the following<a id="id644" class="indexterm"/> code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed'); 

class Shop_model extends CI_Model { 
  function __construct() { 
    parent::__construct(); 
    $this-&gt;load-&gt;helper('url');
  } 

  public function get_product_details($product_id) { 
    $this-&gt;db-&gt;where('product_id', $product_id); 
    $query = $this-&gt;db-&gt;get('products'); 
    return $query; 
  }</pre></div><p>The preceding <code class="literal">get_product_details()</code> function returns a list of all products. This function is called by the <code class="literal">shop</code> controller's <code class="literal">index()</code> function if the user hasn't filtered any results, that is, they haven't clicked on a category link in the <code class="literal">views/shop/display_products.php</code> file:products() {</p><div class="informalexample"><pre class="programlisting">  $q
public function get_all_uery = $this-&gt;db-&gt;get('products'); 
  return $query; 
}</pre></div><p>The preceding <code class="literal">get_all_products()</code> function returns a list of products with a filter applied. This function is called by the <code class="literal">shop</code> controller's <code class="literal">index()</code> function if the user has filtered the <a id="id645" class="indexterm"/>products by a category, that, they have clicked on a category link in the <code class="literal">views/shop/display_products.php</code> file:</p><div class="informalexample"><pre class="programlisting">public function get_all_products_by_category_name($cat_url_name = null) {
  if ($cat_url_name) {
    $this-&gt;db-&gt;where('cat_url_name', $cat_url_name);
    $cat_query = $this-&gt;db-&gt;get('categories');

    foreach ($cat_query-&gt;result() as $row) {
      $category_id = $row-&gt;cat_id;
    }

    $this-&gt;db-&gt;where('category_id', $category_id);
  }

  $query = $this-&gt;db-&gt;get('products'); 
  return $query; 
}</pre></div><p>The preceding <code class="literal">get_all_products_by_category_name()</code> function returns a list of all categories in the <a id="id646" class="indexterm"/>
<code class="literal">categories</code> table. This model function is called from the <code class="literal">shop</code> controller's <code class="literal">index()</code> function to supply data to the product categories list on the right-hand side of the <code class="literal">views/shop/display_products.php</code> file:</p><div class="informalexample"><pre class="programlisting">public function get_all_categories($cat_url_name = null) {
  if ($cat_url_name) {
    $this-&gt;db-&gt;where('cat_url_name', $cat_url_name);
  }

  $query = $this-&gt;db-&gt;get('categories');
  return $query;
}</pre></div><p>The preceding <code class="literal">get_all_categories()</code> function returns a list of all categories in the <code class="literal">categories</code> table. This list is used in the <code class="literal">views/shop/display_products.php</code> file where a <code class="literal">foreach</code> loop iterates over the database object and displays the categories to the user. A user can then click on a category and filter their results.</p><p>Now, take a look at the following snippet:</p><div class="informalexample"><pre class="programlisting">  public function save_cart_to_database($cust_data, $order_data) { 
    $this-&gt;db-&gt;insert('customer', $cust_data); 
    $order_data['cust_id'] = $this-&gt;db-&gt;insert_id(); 
    if ($this-&gt;db-&gt;insert('orders', $order_data)) {
      return true;
    } else {
      return false;
    }
  } 
}</pre></div><p>The preceding <code class="literal">save_cart_to_database()</code> function saves an order to the database; it converts the data in <a id="id647" class="indexterm"/>a cart, along with the data entered by the user in the <code class="literal">views/shop/user_details.php</code> file.</p><p>As you can see, the model is fairly straightforward and concise, so let's now take a look at the views.</p></div>
<div class="section" title="Creating the views"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec77"/>Creating the views</h1></div></div></div><p>There are four views<a id="id648" class="indexterm"/> in this project, and these are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/shop/display_products.php</code>: This displays<a id="id649" class="indexterm"/> a list of <a id="id650" class="indexterm"/>products to the user and allows them to add products to their cart and also filter products.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/shop/display_cart.php</code>: This displays all products in the user's cart, allows them to alter the<a id="id651" class="indexterm"/> quantities of products in their cart, and also gives an option to move to the checkout stage. This is a customized version of the cart template available from the CodeIgniter documentation.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/shop/user_details.php</code>: This <a id="id652" class="indexterm"/>displays a form to the user, allowing them to enter information about their order, such as their contact details and delivery address.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/nav/top_nav.php</code>: This displays the top-level menu. In this project, this is very simple, containing a project name and link to go to the <code class="literal">shop`</code> controller and a link named <span class="strong"><strong>Cart</strong></span>; there is a variable positioned next to the word Cart, displaying the value (0 by default); however, this<a id="id653" class="indexterm"/> is in fact the number of items in the cart at any one time. If there were seven items in the cart, the link would say Cart (7).</li></ul></div><p>That was a good <a id="id654" class="indexterm"/>overview of the views; now let's go over each one, build the code, and discuss how they function.</p><p>Create the <code class="literal">/path/to/codeigniter/application/views/shop/display_products.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;div class="row row-offcanvas row-offcanvas-right"&gt;

  &lt;div class="col-xs-12 col-sm-9"&gt;
    &lt;div class="row"&gt;
      &lt;?php foreach ($query-&gt;result() as $row) : ?&gt; 
        &lt;div class="col-6 col-sm-6 col-lg-4"&gt;
          &lt;h2&gt;&lt;?php echo $row-&gt;product_name ; ?&gt;&lt;/h2&gt;
          &lt;p&gt;&amp;pound;&lt;?php echo $row-&gt;product_price ; ?&gt;&lt;/p&gt;
          &lt;p&gt;&lt;?php echo $row-&gt;product_description ; ?&gt;&lt;/p&gt;
          &lt;?php echo anchor('shop/add/'.$row-&gt;product_id, $this-&gt;lang-&gt;line('index_add_to_cart'), 'class="btn btn-default"') ; ?&gt;
        &lt;/div&gt;
      &lt;?php endforeach ; ?&gt; 
    &lt;/div&gt;
  &lt;/div&gt;</pre></div><p>The preceding block of code outputs a list of products and displays them with a description (<code class="literal">products.product_description</code>), price (<code class="literal">products.product_price</code>), and link to add to cart.</p><p>A <code class="literal">foreach</code> loop is used<a id="id655" class="indexterm"/> to iterate over the products in <code class="literal">$query</code>. The <code class="literal">$query</code> value is populated by data returned by the <code class="literal">get_all_products()</code> function of <code class="literal">Shop_model</code>; or, if the user has filtered by a category (explained in the following HTML), then <code class="literal">$query</code> is populated by the <code class="literal">get_all_products_by_category_name()</code> function of <code class="literal">Shop_model</code>:</p><div class="informalexample"><pre class="programlisting">  &lt;div class="col-xs-6 col-sm-3 sidebar-offcanvas" id="sidebar" role="navigation"&gt;
    &lt;div class="list-group"&gt;
      &lt;?php echo anchor(base_url(), $this-&gt;lang-&gt;line('index_all_categories'), 'class="list-group-item"') ; ?&gt;
      &lt;?php foreach ($cat_query-&gt;result() as $row) : ?&gt;
        &lt;?php echo anchor('shop/index/'.$row-&gt;cat_url_name, $row-&gt;cat_name, 'class="list-group-item"') ; ?&gt;
      &lt;?php endforeach ; ?&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div><p>The preceding block of <a id="id656" class="indexterm"/>code outputs a list of categories that the user can use to filter results. We use a <code class="literal">foreach</code> loop to iterate over the <code class="literal">$cat_query</code> array. This array is supplied by the <code class="literal">get_all_categories()</code> function of <code class="literal">Shop_model</code>.</p><p>Create the <code class="literal">/path/to/codeigniter/application/views/shop/display_cart.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php echo anchor('shop/user_details', $this-&gt;lang-&gt;line('display_cart_proceed_to_checkout'), 'type="button" class="btn btn-primary btn-lg"') ; ?&gt; 
&lt;br /&gt;&lt;br /&gt;
&lt;?php echo form_open('shop/update_cart'); ?&gt; 

&lt;table class="table"&gt; 

  &lt;tr&gt; 
    &lt;th&gt;&lt;?php echo $this-&gt;lang-&gt;line('display_cart_quantity') ; ?&gt;&lt;/th&gt; 
    &lt;th&gt;&lt;?php echo $this-&gt;lang-&gt;line('display_cart_description') ; ?&gt;&lt;/th&gt; 
    &lt;th&gt;&lt;?php echo $this-&gt;lang-&gt;line('display_cart_item_price') ; ?&gt;&lt;/th&gt; 
    &lt;th&gt;&lt;?php echo $this-&gt;lang-&gt;line('display_cart_sub_total') ; ?&gt;&lt;/th&gt; 
  &lt;/tr&gt; </pre></div><p>This view is responsible for displaying the contents of the cart to the user and also allowing the user to adjust item quantities in the cart.</p><p>Look at the<a id="id657" class="indexterm"/> following line of code; with it, we create the <code class="literal">$i</code> variable. This variable is incremented in the <code class="literal">foreach</code> loop. We use the <code class="literal">$i</code> variable to give the product quantity textbox a unique name, that is, 1, 2, 3, 4, and so on:</p><div class="informalexample"><pre class="programlisting">  &lt;?php $i = 1; ?&gt; </pre></div><p>This <code class="literal">foreach</code> loop iterates over each item in the CodeIgniter <code class="literal">Cart</code> class's <code class="literal">$this-&gt;cart-&gt;contents()</code> function. Each iteration is<a id="id658" class="indexterm"/> treated as the <code class="literal">$item</code> variable:</p><div class="informalexample"><pre class="programlisting">  &lt;?php foreach ($this-&gt;cart-&gt;contents() as $items): ?&gt; 

    &lt;?php echo form_hidden($i . '[rowid]', $items['rowid']); ?&gt; 

    &lt;tr&gt; 
      &lt;td&gt;&lt;?php echo form_input(array('name' =&gt; $i . '[qty]', 'value' =&gt; $items['qty'], 'maxlength' =&gt; '3', 'size' =&gt; '5')); ?&gt;&lt;/td&gt; 
      &lt;td&gt; 
        &lt;?php echo $items['name']; ?&gt; 

        &lt;?php if ($this-&gt;cart-&gt;has_options($items['rowid']) == TRUE): ?&gt; 

          &lt;p&gt; 
            &lt;?php foreach ($this-&gt;cart-&gt;product_options($items['rowid']) as $option_name =&gt; $option_value): ?&gt; 

              &lt;strong&gt;&lt;?php echo $option_name; ?&gt;:&lt;/strong&gt; &lt;?php echo $option_value; ?&gt;&lt;br /&gt; 

            &lt;?php endforeach; ?&gt; 
          &lt;/p&gt; 

        &lt;?php endif; ?&gt; 

      &lt;/td&gt; 
      &lt;td&gt;&lt;?php echo $this-&gt;cart-&gt;format_number($items['price']); ?&gt;&lt;/td&gt; 
      &lt;td&gt;&amp;pound;&lt;?php echo $this-&gt;cart-&gt;format_number($items['subtotal']); ?&gt;&lt;/td&gt; 
    &lt;/tr&gt; 

    &lt;?php $i++; ?&gt; 

  &lt;?php endforeach; ?&gt; 

  &lt;tr&gt; 
    &lt;td colspan="2"&gt; &lt;/td&gt; 
    &lt;td&gt;&lt;strong&gt;Total&lt;/strong&gt;&lt;/td&gt; 
    &lt;td&gt;&amp;pound&lt;?php echo $this-&gt;cart-&gt;format_number($this-&gt;cart-&gt;total()); ?&gt;&lt;/td&gt; 
  &lt;/tr&gt; 

&lt;/table&gt; </pre></div><p>After the <code class="literal">foreach</code> loop, we display a button to the user. The following code is for the button that will<a id="id659" class="indexterm"/> submit the form along with any adjusted item quantities:</p><div class="informalexample"><pre class="programlisting">&lt;p&gt;&lt;?php echo form_submit('', $this-&gt;lang-&gt;line('display_cart_update_cart'), 'class="btn btn-success"'); ?&gt;&lt;/p&gt; 
&lt;?php echo form_close() ; ?&gt;</pre></div><p>Create the <code class="literal">/path/to/codeigniter/application/views/shop/user_details.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;div class="row row-offcanvas row-offcanvas-right"&gt;
  &lt;div class="col-xs-12 col-sm-9"&gt;
    &lt;div class="row"&gt;
      &lt;?php echo validation_errors(); ?&gt; 
      &lt;?php echo form_open('/shop/user_details') ; ?&gt; 
      &lt;?php echo form_input($first_name); ?&gt;&lt;br /&gt; 
      &lt;?php echo form_input($last_name); ?&gt;&lt;br /&gt; 
      &lt;?php echo form_input($email); ?&gt;&lt;br /&gt; 
      &lt;?php echo form_input($email_confirm); ?&gt;&lt;br /&gt; 
      &lt;?php echo form_textarea($payment_address); ?&gt;&lt;br /&gt; 
      &lt;?php echo form_textarea($delivery_address); ?&gt;&lt;br /&gt; 
      &lt;?php echo form_submit('', $this-&gt;lang-&gt;line('common_form_elements_go'), 'class="btn btn-success"') ; ?&gt;&lt;br /&gt; 
      &lt;?php echo form_close() ; ?&gt; 
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div><p>The preceding block of code creates a form into which the user can enter contact details necessary for fulfilling their order.</p><p>Create the <code class="literal">/path/to/codeigniter/application/views/nav/top_nav.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;!-- Fixed navbar --&gt;
&lt;div class="navbar navbar-inverse navbar-fixed-top" role="navigation"&gt;
  &lt;div class="container"&gt;
    &lt;div class="navbar-header"&gt;
      &lt;button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"&gt;
        &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
      &lt;/button&gt;
      &lt;a class="navbar-brand" href="&lt;?php echo base_url() ; ?&gt;"&gt;&lt;?php echo $this-&gt;lang-&gt;line('system_system_name'); ?&gt;&lt;/a&gt;
    &lt;/div&gt;
    &lt;div class="navbar-collapse collapse"&gt;
      &lt;ul class="nav navbar-nav"&gt;
        &lt;li class="active"&gt;&lt;?php echo anchor('shop', $this-&gt;lang-&gt;line('nav_home')) ; ?&gt;&lt;/li&gt;
        <span class="strong"><strong>&lt;li&gt;&lt;?php echo anchor('shop/display_cart', ($items &gt; 0) ?</strong></span> <span class="strong"><strong>$this-&gt;lang-&gt;line('nav_cart_count') . '(' . $items . ')'</strong></span> <span class="strong"><strong>: $this-&gt;lang-&gt;line('nav_cart_count') .'(0)') ; ?&gt;&lt;/li&gt;</strong></span>
      &lt;/ul&gt;
    &lt;/div&gt;&lt;!--/.nav-collapse --&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;div class="container theme-showcase" role="main"&gt;</pre></div><p>The preceding block <a id="id660" class="indexterm"/>of code creates the navigation menu at the top of the page. Take a look at the code in bold, shown again here (restructured):</p><div class="informalexample"><pre class="programlisting">&lt;li&gt;
  &lt;?php 
    echo anchor('shop/display_cart', 
    ($items &gt; 0) ? $this-&gt;lang-&gt;line('nav_cart_count') . 
    '(' . $items . ')' : $this-&gt;lang-&gt;line('nav_cart_count').'(0)') ; 
  ?&gt;
&lt;/li&gt;</pre></div><p>The preceding block of code displays the word Cart along with a value in brackets. This value is initially set to 0 (zero). However, this value is in fact the quantity of items in the cart—if no items are in the cart, that number will be zero by default.</p><p>To start with, we use a PHP ternary operator to switch between displaying zero and the actual number of items in the cart. If the number of items is greater than zero, then there must be some items in the cart. So, we display that number of items, otherwise we display zero.</p><p>The word Cart is<a id="id661" class="indexterm"/> set in the language file, but what about the value of the number of cart items? Where does that come from?</p><p>The number of items in the cart is calculated from several functions in the <code class="literal">shop</code> controller, which are <code class="literal">index()</code>, <code class="literal">update_cart()</code> and <code class="literal">user_details()</code>. Let's take a look at just one of these (as they all work the same) and see how it works in the <code class="literal">index()</code> function; check out the following code segment from the <code class="literal">index()</code> function:</p><div class="informalexample"><pre class="programlisting">...
$cart_contents = $this-&gt;session-&gt;userdata('cart_contents');
$data['items'] = $cart_contents['total_items'];

$this-&gt;load-&gt;view('common/header');
$this-&gt;load-&gt;view('nav/top_nav', $data);
...</pre></div><p>We fetch the contents of the cart stored in the <code class="literal">cart_contents</code> session item and store it in the <code class="literal">$cart_contents</code> variable (to keep it simple).</p><p>The CodeIgniter <code class="literal">Cart</code> class automatically keeps a running total of the number of all items currently in the cart and conveniently stores it in the <code class="literal">total_items</code> item in the <code class="literal">$cart_contents</code> array.</p><p>We then assign <code class="literal">$data['items']</code> the value of <code class="literal">total_items</code> (which should be the number of items in the cart) and send it to the <code class="literal">nav/top_nav.php</code> view file where is it displayed next to the word Cart.</p></div>
<div class="section" title="Creating the controllers"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec78"/>Creating the controllers</h1></div></div></div><p>We're going to create only<a id="id662" class="indexterm"/> one controller in this project, which is <code class="literal">/path/to/codeigniter/application/controllers/shop.php</code>.</p><p>Let's go over that controller now, look at the code, and discuss how it functions.</p><p>Create the <code class="literal">/path/to/codeigniter/application/controllers/shop.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed'); 

class Shop extends MY_Controller {
  function __construct() { 
    parent::__construct(); 
    $this-&gt;load-&gt;library('cart'); 
    $this-&gt;load-&gt;helper('form'); 
    $this-&gt;load-&gt;helper('url'); 
    $this-&gt;load-&gt;helper('security'); 
    $this-&gt;load-&gt;model('Shop_model');
    $this-&gt;load-&gt;library('form_validation');
    $this-&gt;form_validation-&gt;set_error_delimiters('&lt;div class="alert alert-danger"&gt;', '&lt;/div&gt;');
  } 

  public function index() {</pre></div><p>We want to display the correct products and as such, we need to test whether the user has clicked on one of the<a id="id663" class="indexterm"/> filter links on the right-hand side of the <code class="literal">views/shop/display_products.php</code> file. We test for the presence of a third <code class="literal">uri</code> parameter.</p><p>If the third parameter does not exist, then we can safely assume the user does not want any filtering. So we call the <code class="literal">get_all_products()</code> function of <code class="literal">Shop_model</code>.</p><p>If a third parameter exists, then the user must be filtering their results. So we call the <code class="literal">get_all_products_by_category_name($this-&gt;uri-&gt;segment(3))</code> function, passing to it the third parameter.</p><p>The third parameter comes from the <code class="literal">categories.cat_url_name</code> column in the database, which is written out in the <code class="literal">views/shop/display_products.php</code> file by a <code class="literal">foreach</code> loop.</p><p>The loop iterates over the <code class="literal">cat_query</code> database object, which is populated by the <code class="literal">get_all_categories()</code> function of <code class="literal">Shop_model</code>, as shown here:</p><div class="informalexample"><pre class="programlisting">if (!$this-&gt;uri-&gt;segment(3)) {
  $data['query'] = $this-&gt;Shop_model-&gt;get_all_products();
} else {
  $data['query'] = $this-&gt;Shop_model-&gt;get_all_products_by_category_name($this-&gt;uri-&gt;segment(3));
}</pre></div><p>As mentioned in the preceding paragraph, the <code class="literal">get_all_categories()</code> function of <code class="literal">Shop_model</code> is called, returning its result to <code class="literal">$data['cat_query']</code>. In the <code class="literal">views/shop/display_products.php</code> file, it is iterated over with a <code class="literal">foreach</code> loop to create a list of categories:</p><div class="informalexample"><pre class="programlisting">$data['cat_query'] = $this-&gt;Shop_model-&gt;get_all_categories();</pre></div><p>Now we fetch the number of items in the cart from the <code class="literal">cart_contents</code> session item. A full explanation <a id="id664" class="indexterm"/>of this is in the <span class="emphasis"><em>Creating the views</em></span> section of this chapter, specifically in the explanation for the <code class="literal">/path/to/codeigniter/application/views/nav/top_nav.php</code> view file:</p><div class="informalexample"><pre class="programlisting">  $cart_contents = $this-&gt;session-&gt;userdata('cart_contents');
  $data['items'] = $cart_contents['total_items'];

  $this-&gt;load-&gt;view('common/header');
  $this-&gt;load-&gt;view('nav/top_nav', $data);
  $this-&gt;load-&gt;view('shop/display_products', $data); 
  $this-&gt;load-&gt;view('common/footer');
}</pre></div><p>The following <code class="literal">add()</code> function adds an item to the cart. It is called from the <code class="literal">views/shop/display_products.php</code> file when a user clicks on Add to cart. The third parameter of the link in <span class="strong"><strong>Add to cart</strong></span> is the product ID (<code class="literal">products.product_id</code>). We grab the product ID from the URI (it's the third segment) and pass it to the <code class="literal">get_product_details($product_id)</code> function of <code class="literal">Shop_model</code>. This will return the product details in the <code class="literal">$query</code> variable. We loop over <code class="literal">$query</code>, pulling out the individual details for the product and saving them to the <code class="literal">$data</code> array:</p><div class="informalexample"><pre class="programlisting">public function add() { 
  $product_id = $this-&gt;uri-&gt;segment(3);
  $query = $this-&gt;Shop_model-&gt;get_product_details($product_id); 
  foreach($query-&gt;result() as $row) { 
    $data = array( 
      'id'   =&gt; $row-&gt;product_id, 
      'qty' =&gt; 1, 
      'price'  =&gt; $row-&gt;product_price, 
      'name' =&gt; $row-&gt;product_name, 
     ); 
  } </pre></div><p>We save the <code class="literal">$data</code> array to the cart using the CodeIgniter <code class="literal">Cart</code> class's <code class="literal">$this-&gt;cart-&gt;insert();</code>function:</p><div class="informalexample"><pre class="programlisting">$this-&gt;cart-&gt;insert($data);</pre></div><p>We then fetch a list of all <a id="id665" class="indexterm"/>categories and the new number of items in the cart and send them to the <code class="literal">nav/top_nav.php</code> view file.</p><p>The <code class="literal">shop/display_cart.php</code> view file will loop over the contents of the cart using the CodeIgniter <code class="literal">Cart</code> class's <code class="literal">$this-&gt;cart-&gt;contents()</code> function:</p><div class="informalexample"><pre class="programlisting">  $data['cat_query'] = $this-&gt;Shop_model-&gt;get_all_categories();
  $cart_contents = $this-&gt;session-&gt;userdata('cart_contents');
  $data['items'] = $cart_contents['total_items'];

  $this-&gt;load-&gt;view('common/header');
  $this-&gt;load-&gt;view('nav/top_nav', $data);
  $this-&gt;load-&gt;view('shop/display_cart', $data); 
  $this-&gt;load-&gt;view('common/footer');
}</pre></div><p>The <code class="literal">update_cart()</code> function is called when the user clicks on the <span class="strong"><strong>Update Cart</strong></span> button in the <code class="literal">views/shop/display_cart.php</code> file. When it is called, it loops over the input posted from the form in <code class="literal">views/shop/display_cart.php</code> and saves it to the <code class="literal">$data</code> array; let's take a look:</p><div class="informalexample"><pre class="programlisting">public function update_cart() { 
  $data = array(); 
  $i = 0; </pre></div><p>First we create an array called <code class="literal">$data</code> in which we can store the adjusted cart data (we'll use this later). Then, we create a <code class="literal">$i</code> variable; we'll use this to create a multidimensional array, incrementing the value of <code class="literal">$i</code> on every iteration of the loop—with <code class="literal">$i</code> keeping the <code class="literal">rowid</code> value (the ID of the product in the cart) and <code class="literal">qty</code> value linked and related to each other.</p><p>We loop over the posted data (from the form in <code class="literal">views/shop/display_cart.php</code>), treating each iteration of the loop as <code class="literal">$item</code>.</p><p>Each <code class="literal">$item</code> has a <code class="literal">rowid</code>
<a id="id666" class="indexterm"/> element (the position of the product in the cart) and <code class="literal">qty</code>, which is the adjusted product quantity:</p><div class="informalexample"><pre class="programlisting">foreach($this-&gt;input-&gt;post() as $item) { 
  $data[$i]['rowid']  = $item['rowid']; 
  $data[$i]['qty']    = $item['qty'];
  $i++;
} </pre></div><p>Now that the cart data has been looped over and any quantity adjustments made, we'll use the CodeIgniter <code class="literal">Cart</code> class's <code class="literal">$this-&gt;cart-&gt;update()</code> function to update the cart. We then redirect the user using the <code class="literal">redirect()</code> function to the <code class="literal">shop</code> controller's <code class="literal">display_cart()</code> function, which will report the new values to the user:</p><div class="informalexample"><pre class="programlisting">  $this-&gt;cart-&gt;update($data); 
  redirect('shop/display_cart'); 
} </pre></div><p>The actual iteration over the cart data is done in the <code class="literal">views/shop/display_cart.php</code> view file, but the <code class="literal">display_cart()</code> function exists to offer a specific way to view items in the cart. Calling this function loads the <code class="literal">views/shop/display_cart.php</code> view:</p><div class="informalexample"><pre class="programlisting">public function display_cart() { 
  $data['cat_query'] = $this-&gt;Shop_model-&gt;get_all_categories();
  $cart_contents = $this-&gt;session-&gt;userdata('cart_contents');
  $data['items'] = $cart_contents['total_items'];
  $this-&gt;load-&gt;view('common/header');
  $this-&gt;load-&gt;view('nav/top_nav', $data);
  $this-&gt;load-&gt;view('shop/display_cart', $data); 
  $this-&gt;load-&gt;view('common/footer');
}

public function clear_cart() { 
  $this-&gt;cart-&gt;destroy(); 
  redirect('index');
}</pre></div><p>The <code class="literal">user_details()</code> function is responsible<a id="id667" class="indexterm"/> for displaying a form to the user, allowing them to enter their contact details, validating those details, and converting their cart to an order. Let's look in detail at how this works.</p><p>First off, we start by setting the validation rules for the form submission:</p><div class="informalexample"><pre class="programlisting">public function user_details() { 
    // Set validation rules 
    $this-&gt;form_validation-&gt;set_rules('first_name', $this-&gt;lang-&gt;line('user_details_placeholder_first_name'), 'required|min_length[1]|max_length[125]'); 
    $this-&gt;form_validation-&gt;set_rules('last_name', $this-&gt;lang-&gt;line('user_details_placeholder_last_name'), 'required|min_length[1]|max_length[125]'); 
    $this-&gt;form_validation-&gt;set_rules('email', $this-&gt;lang-&gt;line('user_details_placeholder_email'), 'required|min_length[1]|max_length[255]|valid_email'); 
    $this-&gt;form_validation-&gt;set_rules('email_confirm', $this-&gt;lang-&gt;line('user_details_placeholder_email_confirm'), 'required|min_length[1]|max_length[255]|valid_email|matches[email]'); 
    $this-&gt;form_validation-&gt;set_rules('payment_address', $this-&gt;lang-&gt;line('user_details_placeholder_payment_address'), 'required|min_length[1]|max_length[1000]'); 
    $this-&gt;form_validation-&gt;set_rules('delivery_address', $this-&gt;lang-&gt;line('user_details_placeholder_delivery_address'), 'min_length[1]|max_length[1000]'); </pre></div><p>If this is the initial page load or there were errors with the submission of the form, then the <code class="literal">$this-&gt;form_validation-&gt;run()</code> function will return <code class="literal">FALSE</code>. If either of these happens, then we will begin to<a id="id668" class="indexterm"/> build the form elements, defining the settings for each form item:</p><div class="informalexample"><pre class="programlisting">if ($this-&gt;form_validation-&gt;run() == FALSE) { 
  $data['first_name'] = array('name' =&gt; 'first_name', 'class' =&gt; 'form-control', 'id' =&gt; 'first_name', 'value' =&gt; set_value('first_name', ''), 'maxlength' =&gt; '100', 'size' =&gt; '35', 'placeholder' =&gt; $this-&gt;lang-&gt;line('user_details_placeholder_first_name'));
  $data['last_name'] = array('name' =&gt; 'last_name', 'class' =&gt; 'form-control', 'id' =&gt; 'last_name', 'value' =&gt; set_value('last_name', ''), 'maxlength' =&gt; '100', 'size' =&gt; '35', 'placeholder' =&gt; $this-&gt;lang-&gt;line('user_details_placeholder_last_name'));
  $data['email'] = array('name' =&gt; 'email', 'class' =&gt; 'form-control', 'id' =&gt; 'email', 'value' =&gt; set_value('email', ''), 'maxlength'   =&gt; '100', 'size' =&gt; '35', 'placeholder' =&gt; $this-&gt;lang-&gt;line('user_details_placeholder_email'));
  $data['email_confirm'] = array('name' =&gt; 'email_confirm', 'class' =&gt; 'form-control', 'id' =&gt; 'email_confirm', 'value' =&gt; set_value('email_confirm', ''), 'maxlength' =&gt; '100', 'size' =&gt; '35', 'placeholder' =&gt; $this-&gt;lang-&gt;line('user_details_placeholder_email_confirm'));
  $data['payment_address'] = array('name' =&gt; 'payment_address', 'class' =&gt; 'form-control', 'id' =&gt; 'payment_address', 'value' =&gt; set_value('payment_address', ''), 'maxlength' =&gt; '100', 'size' =&gt; '35', 'placeholder' =&gt; $this-&gt;lang-&gt;line('user_details_placeholder_payment_address'));
  $data['delivery_address'] = array('name' =&gt; 'delivery_address', 'class' =&gt; 'form-control', 'id' =&gt; 'delivery_address', 'value' =&gt; set_value('delivery_address', ''), 'maxlength' =&gt; '100', 'size' =&gt; '35', 'placeholder' =&gt; $this-&gt;lang-&gt;line('user_details_placeholder_delivery_address'));</pre></div><p>Now we fetch the number of items in the cart from the <code class="literal">cart_contents</code> session item. A full explanation of this is in the <span class="emphasis"><em>Creating the views</em></span> section of this chapter under the explanation for the <code class="literal">/path/to/codeigniter/application/views/nav/top_nav.php</code> view file. After we have the contents of the<a id="id669" class="indexterm"/> cart for the <span class="strong"><strong>Cart</strong></span> link in the navigation bar, we'll load the <code class="literal">views/shop/user_details.php</code> file, which will do the job of displaying the form:</p><div class="informalexample"><pre class="programlisting">  $cart_contents = $this-&gt;session-&gt;userdata('cart_contents');
  $data['items'] = $cart_contents['total_items'];
  $this-&gt;load-&gt;view('common/header');
  $this-&gt;load-&gt;view('nav/top_nav', $data);
  $this-&gt;load-&gt;view('shop/user_details', $data); 
  $this-&gt;load-&gt;view('common/footer'); 
} else { </pre></div><p>If, however, there were no errors with the form when it was submitted, then we will arrive at the following code. We define two arrays—one called <code class="literal">$cust_data</code>, which will store the information submitted by the user in the form in the <code class="literal">views/shop/user_details.php</code> file and the other called <code class="literal">$order_details</code>, which will store a serialized dump of the cart. So, the following block of code saves the users' form data:</p><div class="informalexample"><pre class="programlisting">$cust_data = array( 
'cust_first_name' =&gt; $this-&gt;input-&gt;post('cust_first_name'), 
'cust_last_name' =&gt; $this-&gt;input-&gt;post('cust_last_name'), 
'cust_email'=&gt; $this-&gt;input-&gt;post('cust_email'), 
'cust_address'  =&gt; $this-&gt;input-&gt;post('payment_address')); </pre></div><p>The <code class="literal">$payment_code</code> value acts as a type of hook that you can use for payment processing. For example, most payment processing systems support the addition of a <span class="emphasis"><em>code</em></span>—usually a string of text and/or numbers that are generated by the shop application, saved to the database, and sent off to the payment provider. After the payment, a webhook script will receive a signal from the payment processing system containing a success or error message (the success or error of the attempted payment from the customer's bank account), along with the <span class="emphasis"><em>code</em></span>. This way, you can ensure that the correct order has been paid for (or not); anyway, <code class="literal">$payment_code</code> is the following method in the current project:</p><div class="informalexample"><pre class="programlisting">$payment_code = mt_rand(); </pre></div><p>The following block of code saves the cart data to the <code class="literal">$order_data</code> array. The contents of the cart are fetched from the cart by the CodeIgniter <code class="literal">Cart</code> class's <code class="literal">$this-&gt;cart-&gt;contents()</code> function. The<a id="id670" class="indexterm"/> retuned array is passed to the <code class="literal">serialize()</code> PHP function and is written to <code class="literal">$order_data['order_details'</code>:</p><div class="informalexample"><pre class="programlisting">$order_data = array( 
'order_details' =&gt; serialize($this-&gt;cart-&gt;contents()), 
'order_delivery_address' =&gt; $this-&gt;input-&gt;post('delivery_address'),
'order_closed' =&gt; '0', 
'order_fulfilment_code' =&gt; $payment_code,
'order_delivery_address' =&gt; $this-&gt;input-&gt;post('payment_address')); </pre></div><p>Now that the customer's contact details and order details are in arrays, we can start to save them to the database. We call the <code class="literal">save_cart_to_database()</code> function of <code class="literal">Shop_model</code>, passing to it the <code class="literal">$cust_data</code> and <code class="literal">$order_data</code> array.</p><p>The <code class="literal">save_cart_to_database()</code> function of <code class="literal">Shop_model</code> first saves the customer to the <code class="literal">customer</code> table, returning the primary key of the insert and using that primary key as the foreign key value that goes in <code class="literal">orders.cust_id</code>:</p><div class="informalexample"><pre class="programlisting">      if ($this-&gt;Shop_model-&gt;save_cart_to_database($cust_data, $order_data)) {
        echo $this-&gt;lang-&gt;line('user_details_save_success');
      } else {
        echo $this-&gt;lang-&gt;line('user_details_save_error');
      }
    }
  }
}</pre></div></div>
<div class="section" title="Creating the language file"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec79"/>Creating the language file</h1></div></div></div><p>As with all the projects<a id="id671" class="indexterm"/> in this book, we're making use of the language file to serve text to users. This way, you can enable multiple region/multiple<a id="id672" class="indexterm"/> language support. Let's create the language file.</p><p>Create the <code class="literal">/path/to/codeigniter/application/language/english/en_admin_lang.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

// General
$lang['system_system_name'] = "Shop";

// nav
$lang['nav_cart_count'] = "Cart ";
$lang['nav_home'] = "Home";

// index()
$lang['index_all_categories'] = "All categories";
$lang['index_add_to_cart'] = "Add to cart";

// display_cart()
$lang['display_cart_proceed_to_checkout'] = "Proceed to checkout";
$lang['display_cart_quantity'] = "Quantity";
$lang['display_cart_description'] = "Description";
$lang['display_cart_item_price'] = "Item Price";
$lang['display_cart_sub_total'] = "Sub-Total";
$lang['display_cart_update_cart'] = "Update Cart";

// user_details()
$lang['user_details_placeholder_first_name'] = "First Name";
$lang['user_details_placeholder_last_name'] = "Last Name";
$lang['user_details_placeholder_email'] = "Email";
$lang['user_details_placeholder_email_confirm'] = "Confirm Email";
$lang['user_details_placeholder_payment_address'] = "Payment Address";
$lang['user_details_placeholder_delivery_address'] = "Delivery Address";
$lang['user_details_save_success'] = "Order and Customer saved to DB";
$lang['user_details_save_error'] = "Could not save to DB";</pre></div></div>
<div class="section" title="Putting it all together"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec80"/>Putting it all together</h1></div></div></div><p>Okay, here are a few<a id="id673" class="indexterm"/> examples that will help put everything together.</p><div class="section" title="Filtering a search"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec68"/>Filtering a search</h2></div></div></div><p>When you filter a<a id="id674" class="indexterm"/> search, the following events take place:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The user visits<a id="id675" class="indexterm"/> the site and CodeIgniter routes them to the <code class="literal">shop</code> controller. The <code class="literal">shop</code> controller loads the <code class="literal">index()</code> function</li><li class="listitem">The <code class="literal">index()</code> function recognizes that there is no third parameter in the URL, so it calls the <code class="literal">get_all_products()</code> function of <code class="literal">Shop_model</code>.</li><li class="listitem">The <code class="literal">index()</code> function loads the <code class="literal">get_all_categories()</code> function of <code class="literal">Shop_model</code>, passing the retuned result to <code class="literal">$data['cat_query']</code>. This is passed to the <code class="literal">views/shop/display_products.php</code> file, which—using a <code class="literal">foreach</code> loop—echoes out the categories.</li><li class="listitem">The user clicks on a category in the list. The URL calls the <code class="literal">index()</code> function, but this time with a <a id="id676" class="indexterm"/>third parameter.</li><li class="listitem">The <code class="literal">index()</code> function recognizes this third parameter and loads the <code class="literal">get_all_products_by_category_name()</code> function of <code class="literal">Shop_model</code>, passing it the third <code class="literal">uri</code> segment.</li><li class="listitem">The <code class="literal">get_all_products_by_category_name()</code> function of <code class="literal">Shop_model</code> then looks in the <code class="literal">categories</code> table for a category whose <code class="literal">categories.cat_url_name</code> value matches that supplied in the third parameter and returns the primary key of the category.</li><li class="listitem">It then looks in the <code class="literal">products</code> table for all products whose <code class="literal">products.category_id</code> value matches the primary key of the category found in just the previous step using <code class="literal">get_all_products_by_category_name()</code> and then returns the query to the <code class="literal">shop</code> controller's <code class="literal">index()</code> function, where it is sent to the <code class="literal">views/shop/view_products.php</code> file.</li></ol></div></div><div class="section" title="Adding to cart"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec69"/>Adding to cart</h2></div></div></div><p>The sequence of events to <a id="id677" class="indexterm"/>add items to a cart is as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The user visits the site and CodeIgniter routes them to the <code class="literal">shop</code> controller. The <code class="literal">shop</code> controller<a id="id678" class="indexterm"/> loads the <code class="literal">index()</code> function</li><li class="listitem">The <code class="literal">index()</code> function recognizes that there is no third parameter in the URL, so it calls the <code class="literal">get_all_products()</code> function of <code class="literal">Shop_model</code>.</li><li class="listitem">Using a <code class="literal">foreach</code> loop, the <code class="literal">views/shop/display_products.php</code> file iterates over the result object from <code class="literal">get_all_products()</code> and displays each product in turn.</li><li class="listitem">The user clicks on the <span class="strong"><strong>Add to cart</strong></span> button</li><li class="listitem">CodeIgniter calls the <code class="literal">shop</code> controller's <code class="literal">add()</code> function</li><li class="listitem">The <code class="literal">add()</code> function grabs the product ID from the third <code class="literal">uri</code> segment and sends it to the <code class="literal">get_product_details()</code> function of <code class="literal">Shop_model</code>.</li><li class="listitem">The <code class="literal">get_product_details()</code> function looks in the <code class="literal">products</code> table for the product whose primary key matches that in the argument passed to it and returns it to the <code class="literal">$query</code> variable.</li><li class="listitem">Using a <code class="literal">foreach</code> loop, we iterate over <code class="literal">$query</code>, fetching the details of the product, such as <code class="literal">product_name</code> and <code class="literal">product_price</code>, and saving them to an array called <code class="literal">$data</code>, which we will add to the cart. We also set the <code class="literal">qty</code> value to <code class="literal">1</code> (as they're <a id="id679" class="indexterm"/>only adding one item).</li><li class="listitem">Using the CodeIgniter <code class="literal">Cart</code> class's <code class="literal">$this-&gt;cart-&gt;insert()</code> function, we add the product to the cart by passing it the <code class="literal">$data</code> array.</li><li class="listitem">We then direct the user to <code class="literal">display_cart()</code> to make any amends should they wish.</li></ol></div></div><div class="section" title="Altering the product quantity"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec70"/>Altering the product quantity</h2></div></div></div><p>The user can access the cart in <a id="id680" class="indexterm"/>one of these two ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">By clicking on <span class="strong"><strong>Cart</strong></span> in<a id="id681" class="indexterm"/> the navigation bar at the top of the page</li><li class="listitem" style="list-style-type: disc">By being directed there automatically once they add an item to their cart</li></ul></div><p>We'll pick up the story assuming that the user has used either of these methods (as they both drop us here):</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">CodeIgniter calls the <code class="literal">display_cart()</code> shop function.</li><li class="listitem">The bulk of the work in displaying the cart occurs in the <code class="literal">views/shop/display_cart.php</code> file, which is a modified version of the template found in the CodeIgniter documentation.</li><li class="listitem">A variable called <code class="literal">$i</code> is created and given the value of <code class="literal">1</code>; this will increment as the loop iterates.</li><li class="listitem">Using a <code class="literal">foreach</code> loop, we iterate ever the CodeIgniter <code class="literal">Cart</code> class's <code class="literal">$this-&gt;cart-&gt;contents()</code> function. For each iteration, we call <code class="literal">$item</code>.</li><li class="listitem">An iteration writes the details of each product to an HTML table.</li><li class="listitem">An HTML text input is created called <code class="literal">$i</code>, so if the current iteration is <code class="literal">1</code>, then the name of the textbox will be <code class="literal">1</code>, and if the current iteration is <code class="literal">4</code>, the name of the textbox will be <code class="literal">4</code>.</li><li class="listitem">There are three<a id="id682" class="indexterm"/> items in the cart (three rows). Each row shows that there is one item of each of the three products in the cart. The user wishes to change the quantities of the product in the third row.</li><li class="listitem">The user selects the value of the textbox named <code class="literal">3</code> and replaces the value in that textbox with the number <code class="literal">2</code> (which means that the user wishes to buy one item of product 1, one item of product 2, and two items of product 3).</li><li class="listitem">The user presses the <span class="strong"><strong>Update Cart</strong></span> button.</li><li class="listitem">CodeIgniter calls the <code class="literal">update_cart()</code> shop function.</li><li class="listitem">The <code class="literal">update_cart()</code> function adjusts the quantity of the third product in the cart.</li></ol></div><p>For a detailed<a id="id683" class="indexterm"/> breakdown, check out the explanation in the <span class="emphasis"><em>Creating the controllers</em></span> section of this chapter—look for the <code class="literal">update_cart()</code> function description.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec81"/>Summary</h1></div></div></div><p>In this project, you saw the beginnings of a great shop platform. As always, there are a few things you can do to expand upon the functionality, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Product CMS</strong></span>: This project doesn't come with a CMS to manage products or categories—this is simply because adding such a functionality would have been far too big a topic to cover. However, perhaps you could add some sort of functionality to govern products, adding new ones, deleting old ones, and so on.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Product images</strong></span>: You could add a column to the <code class="literal">products</code> table where an image file name can be stored and then echo out that value in an HTML <code class="literal">&lt;img src=""&gt;</code> tag. You will, of course, need to add a folder somewhere in the filesystem to store the images.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Product pages</strong></span>: You could add a link to the product title, opening a new page and displaying detailed information about that product, such as color, size, weight, "what's in the box", and so on. Of course, you'll need to add extra columns to the <code class="literal">products</code> table to support the new information, but this can be done quite easily.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>BOGOFF</strong></span>: Verb, British slang—an encouragement from one person to another to leave! Depart! Never to be seen again!<p>Well, not quite, but you could add a <span class="strong"><strong>Buy One Get One Free</strong></span> (erm, not sure about the last F) option. You could add logic so that if a certain number of products are selected, a discount is applied.</p></li></ul></div></div></body></html>