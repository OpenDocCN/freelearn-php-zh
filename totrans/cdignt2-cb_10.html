<html><head></head><body><div class="chapter" title="Chapter&#xA0;10.&#xA0;Working with Images"><div class="titlepage"><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Working with Images</h1></div></div></div><p>In this chapter, you will learn:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Installing ImageMagick on MAC with Cactuslab</li><li class="listitem" style="list-style-type: disc">Uploading images with CodeIgniter</li><li class="listitem" style="list-style-type: disc">Generating thumbnails – resizing</li><li class="listitem" style="list-style-type: disc">Rotating images</li><li class="listitem" style="list-style-type: disc">Cropping images</li><li class="listitem" style="list-style-type: disc">Adding watermarks with text</li><li class="listitem" style="list-style-type: disc">Adding watermarks with image overlays</li><li class="listitem" style="list-style-type: disc">Submitting a form with CodeIgniter CAPTCHA</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec90"/>Introduction</h1></div></div></div><p>CodeIgniter has a useful array of tools to help you manipulate and amend images in the form of the image manipulation class; it's not Photoshop, but it's good enough for most of what you'll need to do in your day-to-day web development. It has functionalities to help you upload images, resize them, create thumbnails, add watermarks, crop, and rotate—all very useful things and exactly what you'll be after in a development environment. Here's how to do it.</p></div></div>
<div class="section" title="Installing ImageMagick on MAC with Cactuslab"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec91"/>Installing ImageMagick on MAC with Cactuslab</h1></div></div></div><p>Some of the features of the <a id="id635" class="indexterm"/>CodeIgniter image manipulation <a id="id636" class="indexterm"/>class require GD2, <a id="id637" class="indexterm"/>however, other features require ImageMagick. If you're using MAMP on MAC, then the chances are that you won't have it installed by default. Cactuslab have produced an installer that does the job for you.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec195"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to the URL <a class="ulink" href="http://www.cactuslab.com/imagemagick">http://www.cactuslab.com/imagemagick</a>.</li><li class="listitem">Download the installer. At the time of writing this, the latest version is ImageMagick 6.8.6-3 for Mac OS X 10.5 - 10.8.</li><li class="listitem">Run the installer, <a id="id638" class="indexterm"/>and if all goes well, you should now have ImageMagick installed. You'll need to set the <code class="literal">$config['library_path']</code> value to <code class="literal">/opt/ImageMagick/bin</code>, as follows:<div class="informalexample"><pre class="programlisting">'library_path' =&gt; '/opt/ImageMagick/bin'</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec196"/>How it works...</h2></div></div></div><p>The installer <a id="id639" class="indexterm"/>takes care of <a id="id640" class="indexterm"/>everything for you: it's voodoo!</p></div></div>
<div class="section" title="Uploading images with CodeIgniter"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec92"/>Uploading images with CodeIgniter</h1></div></div></div><p>This is similar to the file <a id="id641" class="indexterm"/>upload recipe mentioned earlier in the book; however, <a id="id642" class="indexterm"/>it differs from it, as we're making CodeIgniter upload images (rather than upload any file type) and perform specific tasks on images, which wouldn't be relevant to the other upload example in the book. Hence, consider this as a separate upload script. This script is the base script for the other recipes (apart from the CAPTCHA recipe) in this chapter—that is to say that the rotating, watermarking, resizing recipes and so on require this base recipe to function.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec197"/>How to do it...</h2></div></div></div><p>We're going to create the following two files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/upload.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/upload/upload.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the controller file, <code class="literal">upload.php</code>, and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed');

class Upload extends CI_Controller {
  function __construct() {
    parent::__construct();
    $this-&gt;load-&gt;helper('form');
    $this-&gt;load-&gt;helper('url');
  }

  function index() {
    $this-&gt;load-&gt;view('upload/upload', array('error' =&gt; ' ' ));
  }

  function do_upload() {
    $config['upload_path'] = '/path/to/upload/dir/';
    $config['allowed_types'] = 'gif|jpg|png';
    $config['max_size'] = '10000';
    $config['max_width'] = '1024';
    $config['max_height'] = '768';

    $this-&gt;load-&gt;library('upload', $config);

    if (! $this-&gt;upload-&gt;do_upload()) {
      $error = array('error' =&gt; $this-&gt;upload-&gt;display_errors());
      $this-&gt;load-&gt;view('upload/upload', $error);
    } else {
$data = array('upload_data' =&gt; $this-&gt;upload-&gt;data());
      echo '&lt;pre&gt;';
      var_dump($data);
      echo '&lt;/pre&gt;';
         }
  }  
}</pre></div></li><li class="listitem">Create <a id="id643" class="indexterm"/>the <code class="literal">/path/to/codeigniter/application/views/upload/upload.php</code> file and add the following <a id="id644" class="indexterm"/>code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if ($error) : ?&gt;
&lt;?php echo $error ; ?&gt;
&lt;?php endif ; ?&gt;

&lt;?php echo form_open_multipart('upload/do_upload');?&gt;

&lt;input type = "file" name = "userfile" size = "20" /&gt;

&lt;br /&gt;&lt;br /&gt;

&lt;input type = "submit" value = "upload" /&gt;

&lt;?php echo form_close() ; ?&gt;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec198"/>How it works...</h2></div></div></div><p>When the <code class="literal">upload</code> controller is run in the browser the user is presented with the form (which is in the view file <code class="literal">views/ipload/upload.php</code>). The user selects an image and presses the <span class="strong"><strong>Submit</strong></span> button public <a id="id645" class="indexterm"/>function<code class="literal"> do_upload()</code> is then called. We immediately define some settings which the image being uploaded is checked against, such as allowed image types, maximum size and <a id="id646" class="indexterm"/>dimensions, these are:</p><div class="informalexample"><pre class="programlisting">$config['upload_path'] = '/path/to/upload/dir';
$config['allowed_types'] = 'gif|jpg|png';
$config['max_size'] = '10000';
$config['max_width'] = '1024';
$config['max_height'] = '768';</pre></div><p>If the image being uploaded meets these requirements, the image can be moved to the location specified in <code class="literal">$config['upload_path']</code> where it is stored, ready should you need it.</p></div></div>
<div class="section" title="Generating thumbnails &#x2013; resizing"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec93"/>Generating thumbnails – resizing</h1></div></div></div><p>Obviously having the <a id="id647" class="indexterm"/>functionality to generate thumbnails is a useful thing to do. Most web <a id="id648" class="indexterm"/>developers have had the requirement to create thumbnails of images they are currently uploading, or images previously uploaded, from time to time. Usually that processing would have been done directly with PHP or whichever programming language you may have been using; but CodeIgniter gives you the ability to create thumbnails easily, and this is how you do it.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec199"/>Getting ready</h2></div></div></div><p>We're going to use a library of our own for this. If you haven't already done so (in the other recipes in this chapter), create the following file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/libraries/image_manip.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Ensure that the <code class="literal">Image_manip</code> library class is defined as follows:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed');
class Image_manip {
}</pre></div></li><li class="listitem">Also ensure that you have the image library, GD2, installed and that you have this chapter's "base" recipe—that is <span class="emphasis"><em>Uploading images with CodeIgniter</em></span>—already copied and ready to go, as this recipe uses the code from <span class="emphasis"><em>Uploading images with CodeIgniter </em></span>as a base recipe.</li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec200"/>How to do it...</h2></div></div></div><p>We’re going to amend the following files from the previous recipe, <span class="emphasis"><em>Uploading images with CodeIgniter</em></span>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/upload.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/libraries/image_manip.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following line (in bold) to the constructor so that the entire constructor looks like this code snippet:<div class="informalexample"><pre class="programlisting">function __construct() {
	parent::__construct();
	$this-&gt;load-&gt;helper('form');
	$this-&gt;load-&gt;helper('url');
	<span class="strong"><strong>$this-&gt;load-&gt;library('image_manip');</strong></span>
}</pre></div></li><li class="listitem">Alter the <code class="literal">do_upload()</code> function, changing it to reflect the following:<div class="informalexample"><pre class="programlisting">if ( ! $this-&gt;upload-&gt;do_upload()) {
	$error = array('error' =&gt; $this-&gt;upload-&gt;display_errors());
	$this-&gt;load-&gt;view('upload/upload', $error);
} else {
	$data = array('upload_data' =&gt; $this-&gt;upload-&gt;data());

	$result = $this-&gt;upload-&gt;data();
	$origional_image = $result['full_path'];

	$data = array(
		'image_library' =&gt; 'gd2',
		'source_image' =&gt; $origional_image,
		'create_thumb' =&gt; TRUE,
		'maintain_ratio' =&gt; TRUE,
		'width' =&gt; '75',
		'height' =&gt; '50'
		);

	if ($this-&gt;image_manip-&gt;resize_image($data)) {
		echo 'Image successfully resized&lt;br /&gt;&lt;pre&gt;';
		var_dump($result);
		echo '&lt;/pre&gt;';
	} else {
		echo 'There was an error with the image processing.';
	}
}</pre></div></li><li class="listitem">Amend the <code class="literal">image_manip</code> library to add the following function:<div class="informalexample"><pre class="programlisting">  function resize_image($data) {
    $CI =&amp; get_instance();
    $CI-&gt;load-&gt;library('image_lib', $data);
    if ($CI-&gt;image_lib-&gt;resize()) {
      return true;
    } else {
      echo $CI-&gt;image_lib-&gt;display_errors();
    }
  }</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec201"/>How it works...</h2></div></div></div><p>When the <code class="literal">upload</code> controller is run in the browser the user is presented with the form (which is in the view file <code class="literal">views/ipload/upload.php</code>). The user selects an image and presses the <span class="strong"><strong>Submit</strong></span> button after which <code class="literal">public function do_upload()</code> is called. We immediately define some settings against which the image being uploaded is checked, such as allowed image types, maximum <a id="id649" class="indexterm"/>size and dimensions - just as we would in the <span class="emphasis"><em>Uploading images with CodeIgniter</em></span> recipe. Assuming that the upload was successful and there were no errors we call the <code class="literal">resize_image()</code><a id="id650" class="indexterm"/>function in the <code class="literal">image_manip</code> library:</p><div class="informalexample"><pre class="programlisting">  $this-&gt;image_manip-&gt;resize_image($data);</pre></div><p>The <code class="literal">resize_image()</code> function grabs the <a id="id651" class="indexterm"/>main CodeIgniter object in <code class="literal">$CI</code> and loads its own <code class="literal">image_lib</code> library, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">  $CI = &amp; get_instance();
  $CI-&gt;load-&gt;library('image_lib', $data);</pre></div><p>The <code class="literal">image_lib</code> library will <a id="id652" class="indexterm"/>be used by CodeIgniter to perform the changes on the image using the parameters we provided in the <code class="literal">$data</code> array.</p><p>We call <code class="literal">$CI-&gt;image_lib-&gt;resize()</code>, testing for a returned <code class="literal">TRUE</code> value. If it returns <code class="literal">FALSE</code>, we then return any error messages from the operation. Otherwise, a thumbnail has been created, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">  if ($CI-&gt;image_lib-&gt;resize()) {
    return true;
  } else {
    echo $CI-&gt;image_lib-&gt;display_errors();
  }</pre></div></div></div>
<div class="section" title="Rotating images"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec94"/>Rotating images</h1></div></div></div><p>CodeIgniter allows for the rotation <a id="id653" class="indexterm"/>of images; this is useful if you need to flip something vertically <a id="id654" class="indexterm"/>or in any other direction. Here's how it's done.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec202"/>Getting ready</h2></div></div></div><p>We're going to use a library of our own for this. If you haven't already done so (in the other recipes in this chapter), create the following file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/libraries/image_manip.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Ensure that the <code class="literal">image_manip</code> library class is defined as follows:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');
class Image_manip {
}</pre></div></li><li class="listitem">Also ensure that you have the image library, ImageMagik, installed that you have this chapter's "base" recipe—that is <span class="emphasis"><em>Uploading images with CodeIgniter</em></span>—already copied and ready to go, as this recipe uses the code from <span class="emphasis"><em>Uploading images with CodeIgniter</em></span> as a base recipe.</li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec203"/>How to do it...</h2></div></div></div><p>We're going to <a id="id655" class="indexterm"/>amend the <a id="id656" class="indexterm"/>following two files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/upload.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/libraries/image_manip.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following function to the <code class="literal">image_manip.php</code> library file:<div class="informalexample"><pre class="programlisting">  function rotate($data) {
    $CI = &amp; get_instance();
    $CI-&gt;load-&gt;library('image_lib', $data);

    $CI-&gt;image_lib-&gt;initialize($data); 

    if ($CI-&gt;image_lib-&gt;rotate()) {
      return true;
    } else {
      echo $CI-&gt;image_lib-&gt;display_errors();
    }
  }</pre></div></li><li class="listitem">Add the following line (in bold) to the constructor so that the entire constructor looks like this:<div class="informalexample"><pre class="programlisting">function __construct() {
  parent::__construct();
  $this-&gt;load-&gt;helper('form');
  $this-&gt;load-&gt;helper('url');
  <span class="strong"><strong>$this-&gt;load-&gt;library('image_manip');</strong></span>
}</pre></div></li><li class="listitem">Alter the <code class="literal">do_upload()</code> function, changing it to reflect the following:<div class="informalexample"><pre class="programlisting">if ( ! $this-&gt;upload-&gt;do_upload()) {
	$error = array('error' =&gt; $this-&gt;upload-&gt;display_errors());
	$this-&gt;load-&gt;view('upload/upload', $error);
} else {
	$data = array('upload_data' =&gt; $this-&gt;upload-&gt;data());

	$result = $this-&gt;upload-&gt;data();
	$original_image = $result['full_path'];

	$data = array(
		'image_library' =&gt; 'imagemagick',
		'library_path' =&gt; '/opt/ImageMagick/bin',
		'source_image' =&gt; $original_image,			
		'rotation_angle' =&gt; 'vrt'
		);
		if ($this-&gt;image_manip-&gt;rotate($data)) {
		echo 'Image successfully rotated&lt;br /&gt;&lt;pre&gt;';
		var_dump($result);
		echo '&lt;/pre&gt;';
	} else {
		echo 'There was an error with the image processing.';
	}
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec204"/>How it works...</h2></div></div></div><p>When the upload controller is run in the browser the user is presented with the form (which is in the view <code class="literal">views/ipload/upload.php</code> file) . The user selects an image and presses the <span class="strong"><strong>Submit</strong></span> button, <code class="literal">public function do_uplaod()</code> is then called. We immediately define some settings against which the image being uploaded is checked, such as allowed image types, maximum size, and dimensions—just as we would in the <span class="emphasis"><em>Uploading images with CodeIgniter </em></span>recipe. Assuming that the upload was successful and there were no errors, we fetch <code class="literal">full_path</code> from the upload data:</p><div class="informalexample"><pre class="programlisting">	$original_image = $result['full_path'];</pre></div><p>Assign it as a local variable <code class="literal">$original_image</code>. We then define an array (<code class="literal">$data</code>) with all the configuration settings which CodeIgniter requires to crop the image (be sure to get the <code class="literal">library_path</code> correct). We pass this <code class="literal">$data</code> array to the library function, <code class="literal">rotate</code>:</p><div class="informalexample"><pre class="programlisting">	$this-&gt;image_manip-&gt;rotate($data);</pre></div><p>This performs the rotate operation on the image.</p></div></div>
<div class="section" title="Cropping images"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec95"/>Cropping images</h1></div></div></div><p>This is going to be most useful and <a id="id657" class="indexterm"/>relevant when coupled with a frontend mechanic, allowing <a id="id658" class="indexterm"/>the user to select an area of an image; however, I'm including the code here as you may need it. You never know!</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec205"/>Getting ready</h2></div></div></div><p>We're going to use a library of our own for this. If you haven't already done so (in the other recipes in this chapter), create the following file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/libraries/image_manip.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Ensure that the <code class="literal">image_manip</code> library class is defined as follows:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed');
class Image_manip {
}</pre></div></li><li class="listitem">Also ensure that you have the image library, ImageMagik, installed.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>If you're using MAMP on a MAC, chances are that you don't have ImageMagick installed by default. There is a process to installing ImageMagick on MAMP; however, there's a quicker way. There's an installer available from Cactuslab at <a class="ulink" href="http://www.cactuslab.com/imagemagick">http://www.cactuslab.com/imagemagick</a>, and it works like a charm. The <span class="emphasis"><em>Installing ImageMagick on MAC with Cactuslab</em></span> recipe is also available in this chapter explaining the installation process.</p></div></div></li><li class="listitem">Ensure that you have this chapters 'base' recipe that is <span class="emphasis"><em>Uploading images with CodeIgniter</em></span> already copied and ready to go as this recipe uses the code from <span class="emphasis"><em>Uploading images with CodeIgniter</em></span> as a base recipe.</li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec206"/>How to do it...</h2></div></div></div><p>We're going to amend the following two files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/upload.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/libraries/image_manip.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following line (in bold) to the constructor so that the entire constructor looks like this:<div class="informalexample"><pre class="programlisting">function __construct() {
	parent::__construct();
	$this-&gt;load-&gt;helper('form');
	$this-&gt;load-&gt;helper('url');
	<span class="strong"><strong>$this-&gt;load-&gt;library('image_manip');</strong></span>
}</pre></div></li><li class="listitem">Alter the do_upload() function, changing it to reflect the following:<div class="informalexample"><pre class="programlisting">if ( ! $this-&gt;upload-&gt;do_upload()) {
	$error = array('error' =&gt; $this-&gt;upload-&gt;display_errors());
	$this-&gt;load-&gt;view('upload/upload', $error);
} else {
	$data = array('upload_data' =&gt; $this-&gt;upload-&gt;data());

	$result = $this-&gt;upload-&gt;data();
	$original_image = $result['full_path'];

	$data = array(
		'source_image' =&gt; $original_image,
		'image_library' =&gt; 'imagemagick',
		'library_path' =&gt; '/opt/ImageMagick/bin',
		'x_axis' =&gt; '100',
		'y_axis' =&gt; '60'	
	);

	if ($this-&gt;image_manip-&gt;crop_image($data)) {
		echo 'Image successfully cropped&lt;br /&gt;&lt;pre&gt;';
		var_dump($result);
		echo '&lt;/pre&gt;';
	} else {
		echo 'There was an error with the image processing.';
	}
}</pre></div></li><li class="listitem">Amend the following <a id="id659" class="indexterm"/>function in the <code class="literal">image_manip</code> library:<div class="informalexample"><pre class="programlisting">  function crop_image($data) {
    $CI =&amp; get_instance();
    $CI-&gt;load-&gt;library('image_lib', $data);

    $CI-&gt;image_lib-&gt;initialize($data); 

    if ($CI-&gt;image_lib-&gt;crop()) {
      return true; 
    } else {
      echo $CI-&gt;image_lib-&gt;display_errors();
    }
  } </pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec207"/>How it works...</h2></div></div></div><p>When the <code class="literal">upload</code> controller is run in the browser the user is presented with the form (which is in the view <code class="literal">views/ipload/upload.php</code> file). The user selects an image and presses the <span class="strong"><strong>Submit</strong></span> button, <code class="literal">public function do_uplaod()</code> is then called. We immediately define some settings against which the image being uploaded is checked, such as allowed image types, maximum size, and dimensions—just as we would in the <span class="emphasis"><em>Uploading images with CodeIgniter</em></span> recipe. Assuming that the upload was successful and there were no errors we fetch the <code class="literal">full_path</code> from the upload data:</p><div class="informalexample"><pre class="programlisting">  $original_image = $result['full_path'];</pre></div><p>We assign it as a local variable, <code class="literal">$original_image</code>. We then define an array (<code class="literal">$data</code>) with all the configuration settings <a id="id660" class="indexterm"/>which CodeIgniter requires to crop the image (be sure to get the <code class="literal">library_path</code> variable correct). We pass this <code class="literal">$data</code> array to the library function, <code class="literal">crop_image</code>, as shown in the <a id="id661" class="indexterm"/>following code snippet:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  $this-&gt;image_manip-&gt;crop_image($data);</strong></span>
</pre></div><p>This performs the cropping operation on the image.</p><div class="section" title="Potential errors"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec18"/>Potential errors</h3></div></div></div><p>You may see some or all (or perhaps entirely different) error messages while coding this recipe. The following are some of <a id="id662" class="indexterm"/>those errors and possible solutions (if all else fails, Google it):</p><p>
<span class="strong"><strong>Error</strong></span>: Image processing failed. Please verify that your server supports the chosen protocol and that the path to your image library is correct.</p><p>
<span class="strong"><strong>Possible Solution</strong></span>: It may be that the path to your image library is incorrect or that the configuration settings for the image library are wrong. Verify that you have the correct library installed and that the path is correct. To do this, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Type <code class="literal">cd /usr/X11R6/bin</code> in your terminal.</li><li class="listitem">Then type <code class="literal">ls</code> (or <code class="literal">dir</code> on Windows).</li><li class="listitem">Look for the ImageMagick <a id="id663" class="indexterm"/>library there. If you cannot see it, then it's probably not installed, and you'll need to install it to be able to perform the cropping operation.</li></ol></div><p>How do you install ImageMagick? Well, there are many instructions and tutorials on the Internet which can help. However, if you're using <a id="id664" class="indexterm"/>MAMP, go to the <span class="emphasis"><em>Installing ImageMagick on MAC with Cactuslab</em></span> recipe in this chapter and use the installer to help that can install ImageMagick and do the leg work of the configuration.</p><p>However be aware that the library path won't be <code class="literal">/use/X11R6/bin/</code> (with the trailing slash) like it is in the CodeIgniter documentation; it will be <code class="literal">/opt/ImageMagick/bin</code> (without the trailing slash).</p></div></div></div>
<div class="section" title="Adding watermarks with text"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec96"/>Adding watermarks with text</h1></div></div></div><p>Adding a watermark can be a <a id="id665" class="indexterm"/>useful way to tag images with your copyright (just <a id="id666" class="indexterm"/>make sure you're the copyright owner). <a id="id667" class="indexterm"/>CodeIgniter comes with an easy method to apply a watermark to an image. Watermarks can be either text or an image overlay and can be positioned on an original image at any position you wish. The following is a description of how to add text watermarks.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec208"/>Getting ready</h2></div></div></div><p>We're going to use a library of our own for this. If you haven't already done so (in the other recipes in this chapter), create the following file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/libraries/image_manip.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Ensure that the <code class="literal">image_manip</code> library class is defined as follows:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed');
class Image_manip {
}</pre></div></li><li class="listitem">Also ensure that you have the image library, GD2, installed.</li><li class="listitem">Ensure that you have this chapters base recipe that is <span class="emphasis"><em>Uploading images with CodeIgniter</em></span> already copied and ready to go as this recipe uses the code from <span class="emphasis"><em>Uploading images with CodeIgniter</em></span> as a base recipe.</li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec209"/>How to do it...</h2></div></div></div><p>We're going to amend the following two files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/uplod.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/libraries/image_manip.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following function to the <code class="literal">image_manip.php</code> library file:<div class="informalexample"><pre class="programlisting">  function do_watermark($data) {
    $CI =&amp; get_instance();
    $CI-&gt;load-&gt;library('image_lib', $data);

    $CI-&gt;image_lib-&gt;initialize($data); 
    if ($CI-&gt;image_lib-&gt;watermark()) {
      return true;
    } else {
      echo $CI-&gt;image_lib-&gt;display_errors();
    }
  }</pre></div></li><li class="listitem">Add the following line (in bold) to the constructor so that the entire constructor looks <a id="id668" class="indexterm"/>like this:<div class="informalexample"><pre class="programlisting">function __construct() {
  parent::__construct();
  $this-&gt;load-&gt;helper('form');
  $this-&gt;load-&gt;helper('url');
<span class="strong"><strong>  $this-&gt;load-&gt;library('image_manip');</strong></span>
}</pre></div></li><li class="listitem">Alter the <code class="literal">do_upload()</code> function, <a id="id669" class="indexterm"/>changing it to <a id="id670" class="indexterm"/>reflect the following:<div class="informalexample"><pre class="programlisting">if ( ! $this-&gt;upload-&gt;do_upload()) {
  $error = array('error' =&gt; $this-&gt;upload-&gt;display_errors());
  $this-&gt;load-&gt;view('upload/upload', $error);
} else {
  $data = array('upload_data' =&gt; $this-&gt;upload-&gt;data());

  $result = $this-&gt;upload-&gt;data();
  $original_image = $result['full_path'];

  $data = array(
  'image_library' =&gt; 'GD2','source_image' =&gt; $original_image,'wm_text' =&gt; 'Copyright (c) ' . date("Y",time()) . ' - YOUR NAME','wm_type' =&gt; 'text','wm_font_path' =&gt; './system/fonts/texb.ttf',
    'wm_font_size' =&gt; '16','wm_font_color' =&gt; 'ffffff','wm_vrt_alignment' =&gt; 'middle','wm_hor_alignment' =&gt; 'left','wm_padding' =&gt; '20'
  );

  if ($this-&gt;image_manip-&gt;do_watermark($data)) {
    echo 'Image successfully watermarked&lt;br /&gt;&lt;pre&gt;';
    var_dump($result);
    echo '&lt;/pre&gt;';
  } else {
    echo 'There was an error with the image processing.';
  }
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec210"/>How it works...</h2></div></div></div><p>When the <code class="literal">upload</code> controller is run in the browser the user is presented with the form (which is in the view file <code class="literal">views/ipload/upload.php</code>). The user selects an image and presses the <span class="strong"><strong>Submit</strong></span> button, <code class="literal">public function do_uplaod()</code> is then called. We immediately define some settings against which the image being uploaded is checked, such as allowed image types, <a id="id671" class="indexterm"/>maximum size and dimensions just as we would in the <span class="emphasis"><em>Uploading images with CodeIgniter</em></span> recipe. Assuming that the upload was successful <a id="id672" class="indexterm"/>and there were no errors we fetch the <code class="literal">full_path</code> from the upload data:</p><div class="informalexample"><pre class="programlisting">  $original_image = $result['full_path'];</pre></div><p>Assign it as a local variable, <code class="literal">$original_image</code>. Next, we'll define an array (<code class="literal">$data</code>) with all the necessary settings to allow CodeIgniter to perform a watermark overlay on our uploaded image. There are a couple of <a id="id673" class="indexterm"/>interesting settings I'll go through in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Setting</p>
</th><th style="text-align: left" valign="bottom">
<p>Options</p>
</th><th style="text-align: left" valign="bottom">
<p>How we're applying it</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">wm_type</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">text</code>, <code class="literal">overlay</code>
</p>
</td><td style="text-align: left" valign="top">
<p>In <a id="id674" class="indexterm"/>this recipe, it's set to text, which tells CodeIgniter that it has to write text over the image, rather than call an image as the overlay. In the next recipe, we'll look at overlay watermarking.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">wn_vrt_alignment</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">top</code>, <code class="literal">middle</code>, <code class="literal">bottom</code>
</p>
</td><td style="text-align: left" valign="top">
<p>We're telling CodeIgniter that it <a id="id675" class="indexterm"/>should place the text towards the middle of the uploaded image.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">wn_hor_alignment</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">left</code>, <code class="literal">center</code>, <code class="literal">right</code>
</p>
</td><td style="text-align: left" valign="top">
<p>We're telling CodeIgniter that it should place the <a id="id676" class="indexterm"/>text towards the left of the uploaded image.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">wm_font_color</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Any hexadecimal value (see the following tip for a useful URL)</p>
</td><td style="text-align: left" valign="top">
<p>We're writing the text as white for no other reason <a id="id677" class="indexterm"/>than the image I used to test this code on was quite dark—a romantic sunset (ahh)—but you can of course change it to any hexadecimal value you wish.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">wm_font_path</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">./system/fonts/texb.ttf</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the font which <a id="id678" class="indexterm"/>comes with CodeIgniter; it's a bit industrial and you may want to change it for another, either copy a different true type font into the <code class="literal">./system/fonts/</code> directory, or link to one outside that directory.</p>
</td></tr></tbody></table></div><p>The following URL has a list of <a id="id679" class="indexterm"/>hexadecimal color values: <a class="ulink" href="http://www.w3schools.com/html/html_colors.asp">http://www.w3schools.com/html/html_colors.asp</a>.</p></div></div>
<div class="section" title="Adding watermarks with image overlays"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec97"/>Adding watermarks with image overlays</h1></div></div></div><p>CodeIgniter can add <a id="id680" class="indexterm"/>watermarks with text as detailed in the preceding recipe, but CodeIgniter can also by overlaying a watermark image on <a id="id681" class="indexterm"/>top of a base image. Here's how it's done…</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec211"/>Getting ready</h2></div></div></div><p>We're going to use a library <a id="id682" class="indexterm"/>of our own for this. If you haven't already done so (in the other recipes in this chapter), create the following file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/libraries/image_manip.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Ensure that the <code class="literal">image_manip</code> library class is defined as follows:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');
class Image_manip {
}</pre></div></li><li class="listitem">This recipe is based on the <span class="emphasis"><em>Adding watermarks with text</em></span> recipe. Make sure you have followed that recipe first. We're going to make a few code changes to it to help us with watermark overlays.</li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec212"/>How to do it...</h2></div></div></div><p>We're going to amend the <a id="id683" class="indexterm"/>following files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/uplod.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/libraries/image_manip.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following function to the library file <code class="literal">image_manip.php</code>:<div class="informalexample"><pre class="programlisting">  function do_watermark($data) {
    $CI =&amp; get_instance();
    $CI-&gt;load-&gt;library('image_lib', $data);

    $CI-&gt;image_lib-&gt;initialize($data); 
    if ($CI-&gt;image_lib-&gt;watermark()) {
      return true;
    } else {
      echo $CI-&gt;image_lib-&gt;display_errors();
    }
  }</pre></div></li><li class="listitem">Add the following line <a id="id684" class="indexterm"/> (in bold) to the constructor so that the entire constructor looks like this:<div class="informalexample"><pre class="programlisting">function __construct() {
  parent::__construct();
  $this-&gt;load-&gt;helper('form');
  $this-&gt;load-&gt;helper('url');
<span class="strong"><strong>  $this-&gt;load-&gt;library('image_manip');</strong></span>
}</pre></div></li><li class="listitem">Alter the <code class="literal">do_upload()</code> function, <a id="id685" class="indexterm"/>changing it to <a id="id686" class="indexterm"/>reflect the following:<div class="informalexample"><pre class="programlisting">if (! $this-&gt;upload-&gt;do_upload()) {
  $error = array('error' =&gt; $this-&gt;upload-&gt;display_errors());
    $this-&gt;load-&gt;view('upload/upload', $error);
  } else {
    $data = array('upload_data' =&gt; $this-&gt;upload-&gt;data());

    $result = $this-&gt;upload-&gt;data();
    $original_image = $result['full_path'];

    // Create Watermark
    $data = array(
    'image_library' =&gt; 'gd2','source_image' =&gt; $original_image,<span class="strong"><strong>    'wm_type' =&gt; 'overlay','wm_overlay_path' =&gt; $config['upload_path'] . '/overlay_image_name',</strong></span>
    'wm_font_path' =&gt; './system/fonts/texb.ttf','wm_font_size' =&gt; '16','wm_font_color' =&gt; 'ffffff','wm_vrt_alignment' =&gt; 'middle','wm_hor_alignment' =&gt; 'left','wm_padding' =&gt; '20'
    );

    $this-&gt;image_manip-&gt;do_watermark($data);
  }</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec213"/>How it works...</h2></div></div></div><p>This is the same basic functionality as the <span class="emphasis"><em>Adding watermarks with text</em></span> recipe. However, instead of the <code class="literal">wm_type</code> being <code class="literal">text</code>, we have set it to <code class="literal">overlay</code>. We have added the config array item, <code class="literal">wm_overlay_path</code>, and set it to where we have the overlay image stored (in this case, we have placed the <a id="id687" class="indexterm"/>overlay image in the same folder as the uploads; of course, you can move it anywhere on your system, but it's here to keep it simple). We have also removed the array item, <code class="literal">wm_text</code>, <a id="id688" class="indexterm"/>which is now not needed (however, you can keep it if you wish, it'll not <a id="id689" class="indexterm"/>interfere with the image overlay).</p></div></div>
<div class="section" title="Submitting a form with CodeIgniter CAPTCHA"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec98"/>Submitting a form with CodeIgniter CAPTCHA</h1></div></div></div><p>It is sometimes necessary to add a <a id="id690" class="indexterm"/>little more security to a form other than escaping and validating user input; sometimes you may wish to ensure that a <a id="id691" class="indexterm"/>human and not some script or bot is entering data and submitting your form.</p><p>A tried and tested way of doing this is <a id="id692" class="indexterm"/>
<span class="strong"><strong>CAPTCHA</strong></span>. There are alternatives to CAPTCHA; for example, a mathematic question (what's 10 + 7, for example) is fairly easy to construct in your application. A new method is getting your users to play a <a id="id693" class="indexterm"/>short game. Based on how they do, they are assessed as being either a human or a bot; <a class="ulink" href="http://areyouahuman.com">areyouahuman.com</a> is a good resource for this. But for now, we'll concentrate on CodeIgniter's CAPTCHA functionality to make a CAPTCHA protected form for us.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec214"/>Getting ready</h2></div></div></div><p>We're going to store the CAPTCHA information CodeIgniter generates for us in a table in the database. To do that, we first need to create that table. The following is the MySQL code to do that. Copy the following into your database:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `captcha` (`captcha_id` bigint(13) unsigned NOT NULL AUTO_INCREMENT,`captcha_time` int(10) unsigned NOT NULL,`ip_address` varchar(16) NOT NULL DEFAULT '0',`word` varchar(20) NOT NULL,PRIMARY KEY (`captcha_id`),KEY `word` (`word`)) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec215"/>How to do it...</h2></div></div></div><p>We're going to make the following four files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/comments.php</code>: This is a controller which helps in processing a name, e-mail address, and comment from the user, and it also calls a helper to process the CAPTCHA data</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/helpers/make_captcha_helper.php</code>: This helper contains the code necessary for generating a CAPTCHA image</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/captcha_model.php</code>: This model is used to check the CAPTCHA value from the user against that stored in the database</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/comments/post_form.php</code>: This view file will <a id="id694" class="indexterm"/>display the form (name, e-mail, comments, and so on) and the CAPTCHA image</li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create <a id="id695" class="indexterm"/>the <code class="literal">controllers/comments.php</code> <a id="id696" class="indexterm"/>controller file and add the following <a id="id697" class="indexterm"/>code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Comments extends CI_Controller {
  function __construct() {
    parent::__construct();
      $this-&gt;load-&gt;helper('form');
      $this-&gt;load-&gt;helper('url');
      $this-&gt;load-&gt;helper('make_captcha');
      $this-&gt;load-&gt;model('Captcha_model');
  }

  public function index() {
      $this-&gt;load-&gt;library('form_validation');
      $this-&gt;form_validation-&gt;set_error_delimiters('', '&lt;br /&gt;');

      $this-&gt;form_validation-&gt;set_rules('name', 'Name', 'required|max_length[225]');
      $this-&gt;form_validation-&gt;set_rules('email', 'Email', 'required|max_length[225]');
      $this-&gt;form_validation-&gt;set_rules('message', 'Message', 'required|max_length[225]');
      $this-&gt;form_validation-&gt;set_rules('captcha', 'Captcha', 'required|max_length[225]');

      // Begin validation
      if ($this-&gt;form_validation-&gt;run() == FALSE) {
        $data['img'] = make_captcha();
        $this-&gt;load-&gt;view('comments/post_form', $data);
      } else {
        $expiration = time() - 7200;

        $this-&gt;Captcha_model-&gt;delete_expired($expiration);

        $data = array(
          'captcha' =&gt; $this-&gt;input-&gt;post('captcha'),
          'ip_address' =&gt; $this-&gt;input-&gt;ip_address(),
          'expiration' =&gt; $expiration);

        $num_rows = 
          $this-&gt;Captcha_model-&gt;does_exist($data);

        if ($num_rows == 0) {
          $data['error'] = "Type the word in the image.";
          $data['img'] = make_captcha();
          $this-&gt;load-&gt;view('comments/post_form', $data);
        } else {
          echo 'CAPTCHA OKAY - HERE IS YOUR POST:' . '&lt;br /&gt;';
          echo $this-&gt;input-&gt;post('name') . '&lt;br /&gt;';
          echo $this-&gt;input-&gt;post('email') . '&lt;br /&gt;';
          echo $this-&gt;input-&gt;post('message') . '&lt;br /&gt;';
      }
    }
  }
}</pre></div></li><li class="listitem">Next create <a id="id698" class="indexterm"/>the <code class="literal">helpers/make_captcha_helper.php</code> <a id="id699" class="indexterm"/>helper <a id="id700" class="indexterm"/>file <a id="id701" class="indexterm"/>and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed');

function make_captcha() {
  $CI =&amp; get_instance();
  $CI-&gt;load-&gt;helper('captcha');

  $vals = array(
      'img_path' =&gt; '/file/path/to/image/captcha/',
      'img_url' =&gt; 'http://url/to/image/captcha/',
      'font_path' =&gt; './system/fonts/texb.ttf',
      'img_width' =&gt; '150',
      'img_height' =&gt; 30,
      'expiration' =&gt; 7200
      );

  $cap = create_captcha($vals);
  $data = array(
      'captcha_time' =&gt; $cap['time'],
      'ip_address' =&gt; $CI-&gt;input-&gt;ip_address(),
      'word' =&gt; $cap['word']
      );

  $query = $CI-&gt;db-&gt;insert_string('captcha', $data);
  $CI-&gt;db-&gt;query($query);

  return $cap['image'];
}</pre></div><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip13"/>Tip</h3><p>
<code class="literal">img_path</code> and <code class="literal">img_url</code> <a id="id702" class="indexterm"/>are two interesting settings here. <code class="literal">img_path</code> should be the path to <a id="id703" class="indexterm"/>the image folder on the file system, and <code class="literal">img_url</code> should be the path of your image as it would be displayed in a web browser. CodeIgniter uses <code class="literal">img_url</code> to build a HTML <code class="literal">img</code> tag, and it is this that is sent to the <code class="literal">post_form</code> as <code class="literal">$data['img']</code>.</p></div></div></li><li class="listitem">Create the <code class="literal">models/captcha_model.php</code> <a id="id704" class="indexterm"/>model <a id="id705" class="indexterm"/>file and add the <a id="id706" class="indexterm"/>following <a id="id707" class="indexterm"/>code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed');

class Captcha_model extends CI_Model {
    function __construct() {
        parent::__construct();
    }

    public function delete_expired($expiration) {
        $this-&gt;db-&gt;where('captcha_time &lt; ',$expiration);
        $this-&gt;db-&gt;delete('captcha');
    }

    public function does_exist($data) {
        $this-&gt;db-&gt;where('word', $data['captcha']);
        $this-&gt;db-&gt;where('ip_address', $data['ip_address']);
        $this-&gt;db-&gt;where('captcha_time &gt; ', $data['expiration']);
        $query = $this-&gt;db-&gt;get('captcha');
        return $query-&gt;num_rows();
    }
}</pre></div></li><li class="listitem">Then create the <code class="literal">comments/post_form.php</code> <a id="id708" class="indexterm"/>view file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php echo form_open() ; ?&gt;
  &lt;?php echo validation_errors() ; ?&gt;
  &lt;?php if (isset($errors)) { echo $errors ; }  ?&gt;
  &lt;br /&gt;
  Name &lt;input type = "text" name = "name" size = "5" value = "&lt;?php echo set_value('name') ; ?&gt;"/&gt;&lt;br /&gt;
  Email &lt;input type = "text" name = "email" size = "5" value = "&lt;?php echo set_value('email') ; ?&gt;"/&gt;&lt;br /&gt;
  Message &lt;br /&gt;
  &lt;textarea name = "message" rows = "4" cols = "20" /&gt;&lt;?php echo set_value('message') ; ?&gt;&lt;/textarea&gt;&lt;br /&gt;

  Please enter the string you see below
  &lt;input type = "text" name = "captcha" value = "" /&gt;
  &lt;br /&gt;
  &lt;?php echo $img ; ?&gt;
  &lt;br /&gt;
  &lt;input type = "submit" value = "Submit" /&gt;
&lt;?php echo form_close() ; ?&gt;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec216"/>How it works...</h2></div></div></div><p>The comments controller loads <code class="literal">public function index()</code>, which sets the validation environment for when or if the <a id="id709" class="indexterm"/>user submits the form. As <code class="literal">$this-&gt;form_validation-&gt;run()</code> will equal <code class="literal">FALSE</code> (as the <a id="id710" class="indexterm"/>form hasn't been submitted yet), the <code class="literal">make_captcha_helper</code> function, <code class="literal">make_captcha()</code>, is called, <a id="id711" class="indexterm"/>sending it's returned values to the <code class="literal">comments/post_form</code> view, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">        if ($this-&gt;form_validation-&gt;run() == FALSE) {
          $data['img'] = make_captcha();
          $this-&gt;load-&gt;view('comments/post_form', $data);
        } else {
  ... etc</pre></div><p>The <code class="literal">make_captcha_helper</code> function, <code class="literal">make_captcha()</code>, will grab the main CodeIgniter object, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">  $CI = &amp; get_instance();
  $CI-&gt;load-&gt;helper('captcha');</pre></div><p>It defines the values necessary to build the CAPTCHA image, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">  $vals = array(
    'img_path' =&gt; '/file/path/to/image/',
    'img_url' =&gt; 'http://url/to/image/',
    'font_path' =&gt; './system/fonts/texb.ttf',
    'img_width' =&gt; '150',
    'img_height' =&gt; 30,
    'expiration' =&gt; 7200
    );</pre></div><p>These values are stored in <a id="id712" class="indexterm"/>the <code class="literal">$data</code> array, <a id="id713" class="indexterm"/>which is passed to the <a id="id714" class="indexterm"/>CodeIgniter helper, <code class="literal">captcha</code>, which returns to us the <code class="literal">$cap</code> array. <code class="literal">$cap</code> is passed to the database function, <code class="literal">insert_string()</code>, so the CAPTCHA <a id="id715" class="indexterm"/>information can be saved to the database, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">  $cap = create_captcha($vals);
  $data = array(
    'captcha_time' =&gt; $cap['time'],
    'ip_address' =&gt; $CI-&gt;input-&gt;ip_address(),
    'word' =&gt; $cap['word']
    );

  $query = $CI-&gt;db-&gt;insert_string('captcha', $data);</pre></div><p>We'll use this row in the database for comparison with the data entered by the user when they submit the form.</p><p>Finally, the <code class="literal">make_captcha</code> <a id="id716" class="indexterm"/>helper returns an HTML <code class="literal">img</code> tag string to our comments controller. This is saved in the <code class="literal">$data</code> array and passed to the <code class="literal">post_form</code> view file.</p><p>The user is then shown the HTML form, with name, e-mail, comments inputs, as well as an image of the CAPTCHA and a <a id="id717" class="indexterm"/>textbox in which to type the CAPTCHA string they see. The user then completes the form, carefully entering their data <a id="id718" class="indexterm"/>along with the string from the CAPTCHA image, and clicks on the <span class="strong"><strong>Submit</strong></span> button.</p><p>Assuming validation is passed (there were no form errors), the comments controller will then begin to compare the CAPTCHA string inputted by the user to the one in the database created by the <code class="literal">make_captcha</code> helper.</p><p>It starts this process by first cleaning the database of old CAPTCHA rows (in this example, old is anything older than two hours); it does this by defining the current time (as a unix time stamp) minus two hours (or <code class="literal">7200</code> seconds), this is set as the <code class="literal">$expiration</code> time, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">  $expiration = time() - 7200;

  $this-&gt;Captcha_model-&gt;delete_expired($expiration);</pre></div><p>The <code class="literal">Captcha_model</code> function, <code class="literal">delete_expired()</code>, is called, passing the expiration to it. This model function will delete rows in the database whose <code class="literal">captcha_time</code> is less than the expiration time, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">    public function delete_expired($expiration) {
        $this-&gt;db-&gt;where('captcha_time &lt; ',$expiration);
        $this-&gt;db-&gt;delete('captcha');
    }</pre></div><p>Once old CAPTCHAS are removed from the database, a <code class="literal">$data</code> array is created and populated with the user's CAPTCHA <a id="id719" class="indexterm"/>input, their IP address, and again, the <code class="literal">$expiration</code> time (the one we made to remove old rows). This <code class="literal">$data</code> array is passed to the <code class="literal">Captcha_model</code> function, <code class="literal">does_exist()</code>. This model function will check whether the CAPTCHA string entered by the user exists in the database, and if so, is valid (that is, less than two hours old and matching the <a id="id720" class="indexterm"/>provided IP address). The model function returns the number of rows found, as shown in the following code snippet</p><div class="informalexample"><pre class="programlisting">    public function does_exist($data) {
        $this-&gt;db-&gt;where('word', $data['captcha']);
        $this-&gt;db-&gt;where('ip_address', $data['ip_address']);
        $this-&gt;db-&gt;where('captcha_time &gt; ', $data['expiration']);
        $query = $this-&gt;db-&gt;get('captcha');
        return $query-&gt;num_rows();
    }</pre></div><p>If zero rows exist, then <code class="literal">$data['errors']</code> is given an error message. <code class="literal">make_captcha()</code> is called again, a new CAPTCHA image <a id="id721" class="indexterm"/>is generated and sent to the <code class="literal">post_form</code> view, and the error message is displayed to the user above the new CAPTCHA image. The system then waits for the user to fill in the form again and have another go.</p><p>However, if the result wasn't zero, <a id="id722" class="indexterm"/>then the CAPTCHA string entered by the user was correct, so we display a quick message to them and echo out their input. In reality, you can do what you like here, such as process their message and save it to a blog feed, or redirect them to another area on the site, whatever you wish.</p></div></div></body></html>