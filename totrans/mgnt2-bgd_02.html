<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;2.&#xA0;Managing the Environment"><div class="book" id="I3QM2-818f5224668745eb9070ddf1d85e6bfa"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02" class="calibre1"/>Chapter 2. Managing the Environment</h1></div></div></div><p class="calibre7">Throughout this chapter, we will look into setting up our development and production environments. The idea is to have a fully automated development environment, which can be initiated with a single console command. For a production environment, we will turn our focus to one of the available cloud services, and see how easy it is to set up Magento for simpler production projects. We will not be covering any robust environment setups like auto-scaling, caching servers, content delivery networks, and similar. These are really jobs for <span class="strong"><em class="calibre9">System Administrator or DevOps</em></span> roles. Our attention here is the bare minimum needed to get our Magento store up and running; a milestone we will achieve throughout the following sections would be:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Setting up a development environment<div class="book"><ul class="itemizedlist1"><li class="listitem">VirtualBox</li><li class="listitem">Vagrant</li><li class="listitem">Vagrant project<div class="book"><ul class="itemizedlist2"><li class="listitem">Provisioning PHP</li><li class="listitem">Provisioning MySQL</li><li class="listitem">Provisioning Apache</li><li class="listitem">Provisioning Magento installation</li></ul></div></li></ul></div></li><li class="listitem">Setting up a production environment<div class="book"><ul class="itemizedlist1"><li class="listitem">Introduction to <span class="strong"><strong class="calibre8">Amazon Web Services</strong></span> (<span class="strong"><strong class="calibre8">AWS</strong></span>)</li><li class="listitem">Setting up access for S3 usage<div class="book"><ul class="itemizedlist2"><li class="listitem">Creating IAM users</li><li class="listitem">Creating IAM groups</li></ul></div></li><li class="listitem">Setting up S3 for database and media files backup</li><li class="listitem">Bash script for automated EC2 setup<div class="book"><ul class="itemizedlist2"><li class="listitem">Setting up EC2</li><li class="listitem">Setting up Elastic IP and DNS</li></ul></div></li></ul></div></li></ul></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Managing the Environment">
<div class="book" title="Setting up a development environment"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch02lvl1sec13" class="calibre1"/>Setting up a development environment</h1></div></div></div><p class="calibre7">In <a id="id34" class="calibre1"/>this section, we will build a development environment using <span class="strong"><strong class="calibre8">VirtualBox</strong></span> and <span class="strong"><strong class="calibre8">Vagrant</strong></span>.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note02" class="calibre1"/>Note</h3><p class="calibre7">Magento official requirements call for Apache 2.2 or 2.4, PHP 5.6.x or 5.5.x (PHP 5.4 is not supported), and MySQL 5.6.x. We need to keep this in mind during the environment setup.</p></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Managing the Environment">
<div class="book" title="Setting up a development environment">
<div class="book" title="VirtualBox"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec07" class="calibre1"/>VirtualBox</h2></div></div></div><p class="calibre7"><span class="strong"><strong class="calibre8">VirtualBox</strong></span> is<a id="id35" class="calibre1"/> powerful and feature-rich x86 and<a id="id36" class="calibre1"/> AMD64/Intel64 virtualization software. It is free, runs on a large number of platforms, and supports a large number of guest operating systems. If we are using Windows, Linux, or OS X in our daily development, we can use VirtualBox to spin up a virtual machine with an isolated guest operating system in which we can install our server software needed to run Magento. This means using MySQL, Apache, and a few other things.</p></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Managing the Environment">
<div class="book" title="Setting up a development environment">
<div class="book" title="Vagrant"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec08" class="calibre1"/>Vagrant</h2></div></div></div><p class="calibre7"><span class="strong"><strong class="calibre8">Vagrant</strong></span> is<a id="id37" class="calibre1"/> a high-level software wrapper used for <a id="id38" class="calibre1"/>virtualization software management. We can use it to create and configure development environments. Vagrant supports several types of virtualization <a id="id39" class="calibre1"/>software <a id="id40" class="calibre1"/>such as VirtualBox, <span class="strong"><strong class="calibre8">VMware, Kernel-based Virtual Machine</strong></span> (<span class="strong"><strong class="calibre8">KVM</strong></span>), <span class="strong"><strong class="calibre8">Linux Containers</strong></span> (<span class="strong"><strong class="calibre8">LXC</strong></span>), and others. It even supports server environments like Amazon EC2.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note03" class="calibre1"/>Note</h3><p class="calibre7">Before<a id="id41" class="calibre1"/> we start, we need to make sure we have VirtualBox and Vagrant installed already. We can download them and install the following<a id="id42" class="calibre1"/> instructions from their official websites: <a class="calibre1" href="https://www.virtualbox.org">https://www.virtualbox.org</a> and <a class="calibre1" href="https://www.vagrantup.com">https://www.vagrantup.com</a>.</p></div></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Managing the Environment">
<div class="book" title="Setting up a development environment">
<div class="book" title="Vagrant project"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch02lvl2sec09" class="calibre1"/>Vagrant project</h2></div></div></div><p class="calibre7">We start<a id="id43" class="calibre1"/> by manually creating an empty<a id="id44" class="calibre1"/> directory somewhere within our host operating system, let's say <code class="email">/Users/branko/www/B05032-Magento-Box/</code>. This is the directory we will pull in Magento code. We want Magento source code to be external to Vagrant box, so we can easily work with it in our favorite IDE.</p><p class="calibre7">We then create a Vagrant project directory, let's say <code class="email">/Users/branko/www/magento-box/</code>.</p><p class="calibre7">Within the <code class="email">magento-box</code> directory, we run the console command <code class="email">vagrant init</code>. This results in an output as follows:</p><div class="informalexample"><pre class="programlisting">A 'Vagrantfile' has been placed in this directory. You are now ready to 'vagrant up' your first virtual environment! Please read the comments in the Vagrantfile as well as documentation on 'vagrantup.com' for more information on using Vagrant.</pre></div><p class="calibre7">The <code class="email">Vagrantfile</code> is actually a Ruby language source file. If we strip away the comments, its original content looks like the following:</p><div class="informalexample"><pre class="programlisting"># -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure(2) do |config|
  config.vm.box = "base"
end</pre></div><p class="calibre7">If we were to run <code class="email">vagrant up</code> now within the <code class="email">magento-box</code> directory, this would start the VirtualBox in headless (no GUI) mode and run the base operating system. However, let's hold off running that command just now.</p><p class="calibre7">The idea is to create a more robust <code class="email">Vagrantfile</code> that covers everything required for running Magento, from Apache, MySQL, PHP, PHPUnit, composer, and full Magento installation with performance fixture data.</p><p class="calibre7">Though Vagrant does not have a separate configuration file on its own, we will create one, as we want to store configuration data like a MySQL user and password in it.</p><p class="calibre7">Let's go ahead and create the <code class="email">Vagrantfile.config.yml</code> file, alongside a <code class="email">Vagrantfile</code> in the same directory, with content as follows:</p><div class="informalexample"><pre class="programlisting">ip: 192.168.10.10
s3:
  access_key: "AKIAIPRNHSWEQNWHLCDQ"
  secret_key: "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"
  bucket: "foggy-project-dhj6"
synced_folder:
  host_path: "/Users/branko/www/B05032-Magento-Box/"
  guest_path: "/vagrant-B05032-Magento-Box/"
mysql:
  host: "127.0.0.1"
  username: root
  password: user123
http_basic:
  repo_magento_com:
    username: a8adc3ac98245f519ua0d2v2c8770ec8
    password: a38488dc908c6d6923754c268vc41bc4
github_oauth:
  github_com: "d79fb920d4m4c2fb9d8798b6ce3a043f0b7c2af6"
magento:
  db_name: "magento"
  admin_firstname: "John"
  admin_lastname: "Doe"
  admin_password: "admin123"
  admin_user: "admin"
  admin_email: "email@change.me"
  backend_frontname: "admin"
  language: "en_US"
  currency: "USD"
  timezone: "Europe/London"
  base_url: "http://magento.box"
  fixture: "small"</pre></div><p class="calibre7">There is <a id="id45" class="calibre1"/>no Vagrant-imposed structure here. This <a id="id46" class="calibre1"/>can be any valid YAML file. The values presented are merely examples of what we can put in.</p><p class="calibre7">Magento enables us to generate a pair of 32-character authentication tokens that can use to access the Git repository. This is done by logging in to Magento Connect with a user name and password, then going to <span class="strong"><strong class="calibre8">My Account</strong></span> | <span class="strong"><strong class="calibre8">Developers</strong></span> | <span class="strong"><strong class="calibre8">Secure Keys</strong></span>. The Public Key and Private Key then become our username and password for accessing Magento GitHub repository.</p><p class="calibre7">Having a separate configuration file means we can commit <code class="email">Vagrantfile</code> to version control with our project, while leaving the <code class="email">Vagrantfile.config.yml</code> out of version control.</p><p class="calibre7">We now edit the <code class="email">Vagrantfile</code> by replacing its content with the following:</p><div class="informalexample"><pre class="programlisting"># -*- mode: ruby -*-
# vi: set ft=ruby :

require 'yaml'

vagrantConfig = YAML.load_file 'Vagrantfile.config.yml'

Vagrant.configure(2) do |config|

  config.vm.box = "ubuntu/vivid64"

  config.vm.network "private_network", ip: vagrantConfig['ip']

  # Mount local "~/www/B05032-Magento-Box/" path into box's "/vagrant-B05032-Magento-Box/" path
  config.vm.synced_folder vagrantConfig['synced_folder']['host_path'], vagrantConfig['synced_folder']['guest_path'], owner:"vagrant", group: "www-data", mount_options:["dmode=775, fmode=664"]

  # VirtualBox specific settings
  config.vm.provider "virtualbox" do |vb|
    vb.gui = false
    vb.memory = "2048"
    vb.cpus = 2
  end

  # &lt;provisioner here&gt;

end</pre></div><p class="calibre7">The preceding<a id="id47" class="calibre1"/> code first includes the <code class="email">yaml</code> library, and then <a id="id48" class="calibre1"/>reads the content of the <code class="email">Vagrantfile.config.yml</code> file into a <code class="email">vagrantConfig</code> variable. Then we have a <code class="email">config</code> block, within which we define the box type, fixed IP address, shared folder between our host and guest operating system, and a few VirtualBox specific details such as CPU and memory allocated.</p><p class="calibre7">We are using the <code class="email">ubuntu/vivid64</code> box that stands for the server edition of Ubuntu 15.04 (Vivid Vervet). The reason is that this Ubuntu version gives us the MySQL 5.6.x and PHP 5.6.x, which stand as requirements for Magento installation, among other things.</p><p class="calibre7">We further have a configuration entry assigning a fixed IP to our virtual machine. Let's go ahead and add an entry in the <span class="strong"><em class="calibre9">hosts</em></span> file of our host operating system as follows:</p><div class="informalexample"><pre class="programlisting">192.168.10.10 magento.box</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note04" class="calibre1"/>Note</h3><p class="calibre7">The reason why we are assigning the fixed IP address to our box is that we can directly open a URL like <code class="email">http://magento.box</code> within our host operating system, and then access Apache served page within our guest operating system.</p></div><p class="calibre7">Another important part of the preceding code is the one where we defined <code class="email">synced_folder</code>. Besides source and destination paths, the crucial parts here are <code class="email">owner</code>, group, and <code class="email">mount_options</code>. We set those to the vagrant user the <code class="email">www-data</code> user group, and <code class="email">774</code> and <code class="email">664</code> for directory and file permissions that play nicely with Magento.</p><p class="calibre7">Let's continue editing our <code class="email">Vagrantfile</code> adding several provisioners to it, one below the other. We do so by replacing the <code class="email"># &lt;provisioner here&gt;</code> from the preceding example, with content as follows:</p><div class="informalexample"><pre class="programlisting">config.vm.provision "file", source: "~/.gitconfig", destination: ".gitconfig"
config.vm.provision "shell", inline: "sudo apt-get update"</pre></div><p class="calibre7">Here we<a id="id49" class="calibre1"/> are instructing Vagrant to pass our <code class="email">.gitconfig</code> file from<a id="id50" class="calibre1"/> the host to the guest operating system. This is so we inherit the host operating system Git setup to the guest operating system Git. We then call for <code class="email">apt-get update</code> in order to update the guest operating system.</p><div class="book" title="Provisioning PHP"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch02lvl3sec02" class="calibre1"/>Provisioning PHP</h3></div></div></div><p class="calibre7">Further <a id="id51" class="calibre1"/>adding to <code class="email">Vagrantfile</code>, we run several provisioners that will install PHP, required PHP modules, and PHPUnit, as follows:</p><div class="informalexample"><pre class="programlisting">config.vm.provision "shell", inline: "sudo apt-get -y install php5 php5-dev php5-curl php5-imagick php5-gd php5-mcrypt php5-mhash php5-mysql php5-xdebug php5-intl php5-xsl"
config.vm.provision "shell", inline: "sudo php5enmod mcrypt"
config.vm.provision "shell", inline: "echo \"xdebug.max_nesting_level=200\" &gt;&gt; /etc/php5/apache2/php.ini"
config.vm.provision "shell", inline: "sudo apt-get -y install phpunit"</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note05" class="calibre1"/>Note</h3><p class="calibre7">There is one thing worth pointing out here – the line where we are writing <code class="email">xdebug.max_nesting_level=200</code> into the <code class="email">php.ini</code> file. This is done to exclude the possibility that Magento would not start throwing a <span class="strong"><strong class="calibre8">Maximum Functions Nesting Level of '100' reached...</strong></span> error.</p></div></div><div class="book" title="Provisioning MySQL"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch02lvl3sec03" class="calibre1"/>Provisioning MySQL</h3></div></div></div><p class="calibre7">Further<a id="id52" class="calibre1"/> adding to <code class="email">Vagrantfile</code>, we run provisioners that will install the MySQL server, as follows:</p><div class="informalexample"><pre class="programlisting">config.vm.provision "shell", inline: "sudo debconf-set-selections &lt;&lt;&lt; 'mysql-server mysql-server/root_password password #{vagrantConfig['mysql']['password']}'"
config.vm.provision "shell", inline: "sudo debconf-set-selections &lt;&lt;&lt; 'mysql-server mysql-server/root_password_again password #{vagrantConfig['mysql']['password']}'"
config.vm.provision "shell", inline: "sudo apt-get -y install mysql-server"
config.vm.provision "shell", inline: "sudo service mysql start"
config.vm.provision "shell", inline: "sudo update-rc.d mysql defaults"</pre></div><p class="calibre7">What is <a id="id53" class="calibre1"/>interesting with the MySQL installation is that it requires a password and a password confirmation to be provided during installation. This makes it a troubling part of the provisioning process that expects shell commands to simply execute without asking for input. To bypass this, we use <code class="email">debconf-set-selections</code> to store the parameters for input. We read the password from the <code class="email">Vagrantfile.config.yml</code> file and pass it onto <code class="email">debconf-set-selections</code>.</p><p class="calibre7">Once installed, <code class="email">update-rc.d mysql</code> defaults will add MySQL to the operating system boot process, thus making sure MySQL is running when we reboot the box.</p></div><div class="book" title="Provisioning Apache"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch02lvl3sec04" class="calibre1"/>Provisioning Apache</h3></div></div></div><p class="calibre7">Further<a id="id54" class="calibre1"/> adding to <code class="email">Vagrantfile</code>, we run the Apache provisioner as follows:</p><div class="informalexample"><pre class="programlisting">config.vm.provision "shell", inline: "sudo apt-get -y install apache2"
config.vm.provision "shell", inline: "sudo update-rc.d apache2 defaults"
config.vm.provision "shell", inline: "sudo service apache2 start"
config.vm.provision "shell", inline: "sudo a2enmod rewrite"
config.vm.provision "shell", inline: "sudo awk '/&lt;Directory \\/&gt;/,/AllowOverride None/{sub(\"None\", \"All\",$0)}{print}' /etc/apache2/apache2.conf &gt; /tmp/tmp.apache2.conf"
config.vm.provision "shell", inline: "sudo mv /tmp/tmp.apache2.conf /etc/apache2/apache2.conf"
config.vm.provision "shell", inline: "sudo awk '/&lt;Directory \\/var\\/www\\/&gt;/,/AllowOverride None/{sub(\"None\", \"All\",$0)}{print}' /etc/apache2/apache2.conf &gt; /tmp/tmp.apache2.conf"
config.vm.provision "shell", inline: "sudo mv /tmp/tmp.apache2.conf /etc/apache2/apache2.conf"
config.vm.provision "shell", inline: "sudo service apache2 stop"</pre></div><p class="calibre7">The preceding code installs Apache, adds it to the boot sequence, starts it, and turns on the rewrite module. We then have an update to the Apache configuration file, as we want to replace <code class="email">AllowOverride None</code> with <code class="email">AllowOverride All</code>, or else our Magento won't work. Once the changes are done, we stop Apache due to the later processes.</p></div><div class="book" title="Provisioning Magento installation"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch02lvl3sec05" class="calibre1"/>Provisioning Magento installation</h3></div></div></div><p class="calibre7">Further <a id="id55" class="calibre1"/>adding to <code class="email">Vagrantfile</code>, we now turn our attention to Magento installation, which we split into several steps. First, we link our host folder, <code class="email">/vagrant-B05032-Magento-Box/</code>, with the guest, <code class="email">/var/www/html</code>, using Vagrant's synced folder feature:</p><div class="informalexample"><pre class="programlisting">config.vm.provision "shell", inline: "sudo rm -Rf /var/www/html"
config.vm.provision "shell", inline: "sudo ln -s #{vagrantConfig['synced_folder']['guest_path']} /var/www/html"</pre></div><p class="calibre7">We<a id="id56" class="calibre1"/> then use the <code class="email">composer create-project</code> command to pull the Magento 2 files from the official <code class="email">repo.magento.com</code> source into the <code class="email">/var/www/html/</code> director:</p><div class="informalexample"><pre class="programlisting">config.vm.provision "shell", inline: "curl -sS https://getcomposer.org/installer | php"
config.vm.provision "shell", inline: "mv composer.phar /usr/local/bin/composer"
config.vm.provision "shell", inline: "composer clearcache"
config.vm.provision "shell", inline: "echo '{\"http-basic\": {\"repo.magento.com\": {\"username\": \"#{vagrantConfig ['http_basic']['repo_magento_com']['username']}\",\"password\": \"#{vagrantConfig['http_basic']['repo_magento_com']['password']} \"}}, \"github-oauth\": {\"github.com\": \"#{vagrantConfig['github_oauth']['github_com']}\"}}' &gt;&gt; /root/.composer/auth.json"
config.vm.provision "shell", inline: "composer create-project -- repository-url=https://repo.magento.com/ magento/project- community-edition /var/www/html/"</pre></div><p class="calibre7">We then create a database in which Magento will be installed later on:</p><div class="informalexample"><pre class="programlisting">config.vm.provision "shell", inline: "sudo mysql -- user=#{vagrantConfig['mysql']['username']} -- password=#{vagrantConfig['mysql']['password']} -e \"CREATE DATABASE #{vagrantConfig['magento']['db_name']};\""</pre></div><p class="calibre7">We then run the Magento installation from the command line:</p><div class="informalexample"><pre class="programlisting">config.vm.provision "shell", inline: "sudo php /var/www/html/bin/magento setup:install --base- url=\"#{vagrantConfig['magento']['base_url']}\" --db- host=\"#{vagrantConfig['mysql']['host']}\" --db- user=\"#{vagrantConfig['mysql']['username']}\" --db- password=\"#{vagrantConfig['mysql']['password']}\" --db- name=\"#{vagrantConfig['magento']['db_name']}\" --admin- firstname=\"#{vagrantConfig['magento']['admin_firstname']}\" -- admin-lastname=\"#{vagrantConfig['magento']['admin_lastname']}\" --admin-email=\"#{vagrantConfig['magento']['admin_email']}\" -- admin-user=\"#{vagrantConfig['magento']['admin_user']}\" -- admin-password=\"#{vagrantConfig['magento']['admin_password']}\" --backend- frontname=\"#{vagrantConfig['magento']['backend_frontname']}\" - -language=\"#{vagrantConfig['magento']['language']}\" -- currency=\"#{vagrantConfig['magento']['currency']}\" -- timezone=\"#{vagrantConfig['magento']['timezone']}\""
config.vm.provision "shell", inline: "sudo php /var/www/html/bin/magento deploy:mode:set developer"
config.vm.provision "shell", inline: "sudo php /var/www/html/bin/magento cache:disable"
config.vm.provision "shell", inline: "sudo php /var/www/html/bin/magento cache:flush"
config.vm.provision "shell", inline: "sudo php /var/www/html/bin/magento setup:performance:generate-fixtures /var/www/html/setup/performance-toolkit/profiles/ce/small.xml"</pre></div><p class="calibre7">The preceding code shows we are installing the fixtures data as well.</p><p class="calibre7">We <a id="id57" class="calibre1"/>need to be careful during the <code class="email">Vagrantfile.config.yml</code> file configuration. Magento installation is quite sensible around provided data. We need to make sure we provide valid data for fields like mail and password or else the installation will fail showing errors similar to the following:</p><div class="informalexample"><pre class="programlisting">SQLSTATE[28000] [1045] Access denied for user 'root'@'localhost' (using password: NO)
User Name is a required field.
First Name is a required field.
Last Name is a required field.
'magento.box' is not a valid hostname for email address 'john.doe@magento.box'
'magento.box' appears to be a DNS hostname but cannot match TLD against known list
'magento.box' appears to be a local network name but local network names are not allowed
Password is required field.
Your password must be at least 7 characters.
Your password must include both numeric and alphabetic characters.</pre></div><p class="calibre7">With this, we conclude our <code class="email">Vagrantfile</code> content.</p><p class="calibre7">Running the <code class="email">vagrant up</code> command now within the same directory as <code class="email">Vagrantfile</code> triggers the box creation process. During this process, all of the previously listed commands will get executed. The process alone takes up to an hour or so.</p><p class="calibre7">Once vagrant up is complete, we can issue another console command, <code class="email">vagrant ssh</code>, to log in to the box.</p><p class="calibre7">At the same time, if we open a URL like <code class="email">http://magento.box</code> in our browser, we should see the Magento storefront loading.</p><p class="calibre7">The preceding <code class="email">Vagrantfile</code> simply pulls from the official Magento Git repository and installs Magento from the ground up. <code class="email">Vagrantfile</code> and <code class="email">Vagrantfile.config.yml</code> can be further extended and tailored to suit our individual project needs, like pulling the code from the private Git repository, restoring the database from the shared drive, and so on.</p><p class="calibre7">This makes for a simple yet powerful scripting process by which we can prepare fully ready per-project machines for other developers in a team to be able to quickly spin up.</p></div></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Setting up a production environment"><div class="book" id="J2B82-818f5224668745eb9070ddf1d85e6bfa"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec14" class="calibre1"/>Setting up a production environment</h1></div></div></div><p class="calibre7">A<a id="id58" class="calibre1"/> production environment is the client-facing environment that focuses on good performance and availability. Setting up production environments is not really something we developers tend to do, especially if there are robust requirements around scaling, load balancing, high availability, and similar. Sometimes, however, we need to set up a simple production environment. There are various cloud providers that offer quick and simple solutions to this. For the purpose of this section, we will turn to Amazon Web Services.</p></div>

<div class="book" title="Setting up a production environment">
<div class="book" title="Introduction to Amazon Web Services"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch02lvl2sec10" class="calibre1"/>Introduction to Amazon Web Services</h2></div></div></div><p class="calibre7"><span class="strong"><strong class="calibre8">Amazon Web Services</strong></span> (<span class="strong"><strong class="calibre8">AWS</strong></span>) is a collection of remote computing services frequently referred to<a id="id59" class="calibre1"/> as web services. AWS <a id="id60" class="calibre1"/>provides on-demand computing resources and services in the cloud, with <span class="strong"><em class="calibre9">pay-as-you-go</em></span> pricing. Amazon gives a nice comparison of its AWS resources, saying that using AWS resources instead of your own is like purchasing electricity from a power company instead of running your own generator.</p><p class="calibre7">If we stop and think about it for a minute, this makes it interesting to not only system operation roles but also for developers like us. We (developers) are now able to spin various databases, web application servers, and even complex infrastructures in a matter of minutes and a few mouse clicks. We can run these services for a few minutes, hours, or days then shut them down. Meanwhile, we only pay for the actual usage, not the full monthly or yearly price as we do with most of the hosting services. Although the overall AWS pricing for certain services might not be the cheapest out there, it certainly provides a level of commodity and usability unlike many other services. Commodity comes from things like auto-scaling resources, a feature that often offers significant cost savings compared to the equivalent on-premises infrastructure.</p><p class="calibre7">Quality training and a certification program is another important aspect of the AWS ecosystem. Certifications are available for <span class="strong"><strong class="calibre8">Solutions Architect</strong></span>, <span class="strong"><strong class="calibre8">Developer</strong></span>, and <span class="strong"><strong class="calibre8">SysOps Administrator</strong></span>, across associate and professional levels. Though the certification is not mandatory, if we deal with AWS on a regular basis, we are encouraged to take one. Earning the certification puts the seal on our expertise to design, deploy, and operate highly available, cost-effective, and secure applications on the AWS platform.</p><p class="calibre7">We can<a id="id61" class="calibre1"/> manage our AWS through a simple and intuitive web-based user interface called AWS management console, which is available at <a class="calibre1" href="https://aws.amazon.com/console">https://aws.amazon.com/console</a>. Signing into AWS, we should be able to see a screen similar to the following one:</p><div class="mediaobject"><img src="../images/00002.jpeg" alt="Introduction to Amazon Web Services" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">The<a id="id62" class="calibre1"/> preceding image shows how<a id="id63" class="calibre1"/> the AWS management console groups the AWS services visually into several major groups, as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre8">Compute</strong></span></li><li class="listitem"><span class="strong"><strong class="calibre8">Developer Tools</strong></span></li><li class="listitem"><span class="strong"><strong class="calibre8">Mobile Services</strong></span></li><li class="listitem"><span class="strong"><strong class="calibre8">Storage &amp; Content Delivery</strong></span></li><li class="listitem"><span class="strong"><strong class="calibre8">Management Tools</strong></span></li><li class="listitem"><span class="strong"><strong class="calibre8">Application Services</strong></span></li><li class="listitem"><span class="strong"><strong class="calibre8">Database</strong></span></li><li class="listitem"><span class="strong"><strong class="calibre8">Security &amp; Identity</strong></span></li><li class="listitem"><span class="strong"><strong class="calibre8">Networking</strong></span></li><li class="listitem"><span class="strong"><strong class="calibre8">Analytics</strong></span></li><li class="listitem"><span class="strong"><strong class="calibre8">Enterprise Applications</strong></span></li></ul></div><p class="calibre7">As part of this chapter, we will be taking a look at the <span class="strong"><strong class="calibre8">EC2</strong></span> service found under the <span class="strong"><strong class="calibre8">Compute</strong></span> group and the <span class="strong"><strong class="calibre8">S3</strong></span> service found under the <span class="strong"><strong class="calibre8">Storage &amp; Content Delivery</strong></span> group.</p><p class="calibre7"><span class="strong"><strong class="calibre8">Amazon Elastic Compute Cloud</strong></span> (<span class="strong"><strong class="calibre8">Amazon EC2</strong></span>) is a web service that provides a re-sizable<a id="id64" class="calibre1"/> compute capacity in the cloud. We can think of it as a virtual computer machine in the cloud that we can turn on and off at any time, within minutes. We can further commission one, hundreds, or even thousands of these machine instances simultaneously. This makes for the <span class="strong"><em class="calibre9">re-sizable</em></span> compute capacity.</p><p class="calibre7">S3 provides secure, durable, and highly scalable object storage. It is designed to provide durability of 99.99% of objects. The service provides a web service interface to store and retrieve any amount of data from anywhere on the web. S3 is charged only per storage that is <a id="id65" class="calibre1"/>actually used. S3 can be <a id="id66" class="calibre1"/>used alone or together with other AWS services such as EC2.</p></div></div>

<div class="book" title="Setting up a production environment">
<div class="book" title="Setting up access for S3 usage"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec11" class="calibre1"/>Setting up access for S3 usage</h2></div></div></div><p class="calibre7">As<a id="id67" class="calibre1"/> part of our production environment, it is good to have reliable storage where we can archive database and media files. Amazon S3 stands out as a possible solution.</p><p class="calibre7">In order to properly set access to the S3 scalable storage service, we need to take a quick look into AWS <span class="strong"><strong class="calibre8">Identity and Access Management</strong></span> (<span class="strong"><strong class="calibre8">IAM</strong></span> for short). IAM is a web service <a id="id68" class="calibre1"/>that helps us securely control access to AWS resources for our users. We can use IAM to control authentication (who can use our AWS resources) and authorization (what resources they can use and in what ways). More specifically, as we will soon see, we are interested in <span class="strong"><strong class="calibre8">Users</strong></span> and <span class="strong"><strong class="calibre8">Groups</strong></span>.</p><div class="book" title="Creating IAM users"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch02lvl3sec06" class="calibre1"/>Creating IAM users</h3></div></div></div><p class="calibre7">This<a id="id69" class="calibre1"/> section describes how to create IAM users. An IAM user is an entity that we create in AWS to represent the person or service using it when interacting with AWS.</p><p class="calibre7">Log in to the AWS console.</p><p class="calibre7">Under the user menu, click on <span class="strong"><strong class="calibre8">Security Credentials</strong></span> as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00003.jpeg" alt="Creating IAM users" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">This<a id="id70" class="calibre1"/> opens up the security dashboard page.</p><p class="calibre7">Clicking on the <span class="strong"><strong class="calibre8">Users</strong></span> menu should open a screen like the following one:</p><div class="mediaobject"><img src="../images/00004.jpeg" alt="Creating IAM users" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">On the <span class="strong"><strong class="calibre8">Users</strong></span> menu, we click on <span class="strong"><strong class="calibre8">Create New User</strong></span>, which opens a page like the following:</p><div class="mediaobject"><img src="../images/00005.jpeg" alt="Creating IAM users" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Here, we <a id="id71" class="calibre1"/>fill in the desired username for one or more users, something like <code class="email">foggy_s3_user1</code>, and then click on the <span class="strong"><strong class="calibre8">Create</strong></span> button.</p><p class="calibre7">We should now see a screen like the following one:</p><div class="mediaobject"><img src="../images/00006.jpeg" alt="Creating IAM users" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Here, we can click on <span class="strong"><strong class="calibre8">Download Credentials</strong></span> to initiate the CSV format file download or copy and paste our credentials manually.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note06" class="calibre1"/>Note</h3><p class="calibre7"><span class="strong"><strong class="calibre8">Access Key ID</strong></span> and <span class="strong"><strong class="calibre8">Secret Access Key</strong></span> are the two pieces of information we will be using to access S3 storage.</p></div><p class="calibre7">Clicking<a id="id72" class="calibre1"/> the close link takes us back to the <span class="strong"><strong class="calibre8">Users</strong></span> menu, showing our newly created user listed as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00007.jpeg" alt="Creating IAM users" class="calibre10"/></div><p class="calibre11"> </p></div><div class="book" title="Creating IAM groups"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch02lvl3sec07" class="calibre1"/>Creating IAM groups</h3></div></div></div><p class="calibre7">This <a id="id73" class="calibre1"/>section describes how to create IAM groups. Groups are collections of IAM users that we can manage as a single unit. So let's begin:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log in to the AWS console.</li><li class="listitem" value="2">Under the user menu, click on <span class="strong"><strong class="calibre8">Security Credentials</strong></span> as shown in the following screenshot:<div class="mediaobject"><img src="../images/00008.jpeg" alt="Creating IAM groups" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="3">This<a id="id74" class="calibre1"/> opens up the security dashboard page. Clicking on the <span class="strong"><strong class="calibre8">Groups</strong></span> menu should open a screen like the following one:<div class="mediaobject"><img src="../images/00009.jpeg" alt="Creating IAM groups" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="4">On the <span class="strong"><strong class="calibre8">Groups</strong></span> menu, we click on <span class="strong"><strong class="calibre8">Create New Group</strong></span>, which opens a page like the following:<div class="mediaobject"><img src="../images/00010.jpeg" alt="Creating IAM groups" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="5">Here, we<a id="id75" class="calibre1"/> fill in the desired group name, something like <code class="email">FoggyS3Test</code>.</li><li class="listitem" value="6">We should now see a screen like the following one, where we need to select the group <span class="strong"><strong class="calibre8">Policy Type</strong></span> and click the <span class="strong"><strong class="calibre8">Next Step</strong></span> button:<div class="mediaobject"><img src="../images/00011.jpeg" alt="Creating IAM groups" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="7">We select the <span class="strong"><strong class="calibre8">AmazonS3FullAccess</strong></span> policy type and click the <span class="strong"><strong class="calibre8">Next Step</strong></span> button. The <span class="strong"><strong class="calibre8">Review</strong></span> screen is now shown, asking us to review the provided information:<div class="mediaobject"><img src="../images/00012.jpeg" alt="Creating IAM groups" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="8">If the provided information is correct, we confirm it by clicking the <span class="strong"><strong class="calibre8">Create Group</strong></span> button. We should now be able to see our group under the <span class="strong"><strong class="calibre8">Groups</strong></span> menu as shown in the following screenshot:<div class="mediaobject"><img src="../images/00013.jpeg" alt="Creating IAM groups" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="9">Mark the <a id="id76" class="calibre1"/>checkbox to the left of <span class="strong"><strong class="calibre8">Group Name</strong></span>, click the <span class="strong"><strong class="calibre8">Group Actions</strong></span> dropdown, and then select <span class="strong"><strong class="calibre8">Add Users to Group</strong></span> as shown in the following screenshot:<div class="mediaobject"><img src="../images/00014.jpeg" alt="Creating IAM groups" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="10">This <a id="id77" class="calibre1"/>opens the <span class="strong"><strong class="calibre8">Add Users to Group</strong></span> page as shown in the following screenshot:<div class="mediaobject"><img src="../images/00015.jpeg" alt="Creating IAM groups" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="11">Mark the checkbox to the left of <span class="strong"><strong class="calibre8">User Name</strong></span> and click on the <span class="strong"><strong class="calibre8">Add Users</strong></span> button. This should add the selected user to the group and throw us back to the <span class="strong"><strong class="calibre8">Groups</strong></span> listing.</li></ol><div class="calibre14"/></div><p class="calibre7">The result of this user and group creation process is a user with <span class="strong"><strong class="calibre8">Access Key Id</strong></span>, <span class="strong"><strong class="calibre8">Secret Access Key</strong></span>, and assigned user group with the <span class="strong"><strong class="calibre8">AmazonS3FullAccess</strong></span> policy. We will use this information later on when we demonstrate backing up the database to S3.</p></div></div></div>

<div class="book" title="Setting up a production environment">
<div class="book" title="Setting up S3 for database and media files backup"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec12" class="calibre1"/>Setting up S3 for database and media files backup</h2></div></div></div><p class="calibre7">S3 consists of buckets. We <a id="id78" class="calibre1"/>can think of a bucket as the first level directory within our S3 account. We then set the permissions and other options on that directory (bucket). In this section, we are going to create our own bucket, with two empty folders called <code class="email">database</code> and <code class="email">media</code>. We will use these folders later on during our environment setup in order to back up our MySQL <a id="id79" class="calibre1"/>database and our media files.</p><p class="calibre7">We start by logging in to the AWS management console.</p><p class="calibre7"> Under the <span class="strong"><strong class="calibre8">Storage &amp; Content Delivery</strong></span> group, we click on <span class="strong"><strong class="calibre8">S3</strong></span>. This opens a screen similar to the following:</p><div class="mediaobject"><img src="../images/00016.jpeg" alt="Setting up S3 for database and media files backup" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Click on the <span class="strong"><strong class="calibre8">Create Bucket</strong></span> button. This opens a popup like the one shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00017.jpeg" alt="Setting up S3 for database and media files backup" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Let's provide a unique <span class="strong"><strong class="calibre8">Bucket Name</strong></span>, preferably something identifying the project for which we will be backing up the <code class="email">database</code> and <code class="email">media</code> file, and click the <span class="strong"><strong class="calibre8">Create</strong></span> button. For the purpose of this chapter, let's imagine we selected something like <code class="email">foggy-project-dhj6</code>.</p><p class="calibre7">Our bucket should now be visible<a id="id80" class="calibre1"/> under the <span class="strong"><strong class="calibre8">All Buckets</strong></span> list. If we click on it, a new screen opens like the one shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00018.jpeg" alt="Setting up S3 for database and media files backup" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Here, we click on the <span class="strong"><strong class="calibre8">Create Folder</strong></span> button and add the necessary <code class="email">database</code> and <code class="email">media</code> folders.</p><p class="calibre7">While still within the root bucket directory, click on the <span class="strong"><strong class="calibre8">Properties</strong></span> button and fill in the <span class="strong"><strong class="calibre8">Permissions</strong></span> section as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00019.jpeg" alt="Setting up S3 for database and media files backup" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Here, we are basically assigning all permissions to <span class="strong"><strong class="calibre8">Authenticated Users</strong></span>.</p><p class="calibre7">We should now have an S3 bucket to which we can potentially store our database and media backups using the <code class="email">s3cmd</code> console<a id="id81" class="calibre1"/> tool that we will soon reference.</p></div></div>

<div class="book" title="Setting up a production environment">
<div class="book" title="Bash script for automated EC2 setup"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch02lvl2sec13" class="calibre1"/>Bash script for automated EC2 setup</h2></div></div></div><p class="calibre7">Similar<a id="id82" class="calibre1"/> to the <code class="email">Vagrantfile</code> shell provisioners, let's go ahead and create a sequence of bash shell commands we can use for a production setup.</p><p class="calibre7">The first block of commands goes as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">#!/bin/bash</strong></span>
<span class="strong"><strong class="calibre8">apt-get update</strong></span>
<span class="strong"><strong class="calibre8">apt-get -y install s3cmd</strong></span>
</pre></div><p class="calibre7">Here, start with the <code class="email">#!/bin/bash</code> expression. This specifies the type of script we are executing. Then we have a system update and <code class="email">s3cmd</code> tool installation. The <code class="email">s3cmd</code> is a free command-line tool and client for uploading, retrieving, and managing data in Amazon S3. We can use it later on for database and media file backups and restores.</p><p class="calibre7">We then install the <code class="email">postfix</code> mail server, using the following commands. Since the postfix installation triggers a graphical interface in the console, asking for <code class="email">mailname</code> and <code class="email">main_mailer_type</code>, we bypass those using <code class="email">sudo debconf-set-selections</code>. Once installed, we reload <code class="email">postfix</code>.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo debconf-set-selections &lt;&lt;&lt; "postfix postfix/mailname string magentize.me"</strong></span>
<span class="strong"><strong class="calibre8">sudo debconf-set-selections &lt;&lt;&lt; "postfix postfix/main_mailer_type string 'Internet Site'"</strong></span>
<span class="strong"><strong class="calibre8">sudo apt-get install -y postfix</strong></span>
<span class="strong"><strong class="calibre8">sudo /etc/init.d/postfix reload</strong></span>
</pre></div><p class="calibre7">Using mail server directly on the EC2 box is fine for smaller production sites, where we do not expect high traffic or a large number of customers. For more intensive production sites, we need to pay attention to Amazon, possibly putting a throttle on port <code class="email">25</code>, thus resulting in outgoing e-mail timeouts. In which case we can either ask Amazon to remove the limitation on our account, or move on to more robust services like <span class="strong"><strong class="calibre8">Amazon Simple Email Service</strong></span>.</p><p class="calibre7">We then install all things related to PHP. Notice how we even install <code class="email">xdebug</code>, though immediately turning it off. This might come in handy for those very rare moments when we really need to debug the live site, then we can turn it off and play with remote debugging. We further download and set composer to the user path:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">apt-get -y install php5 php5-dev php5-curl php5-imagick php5-gd php5- mcrypt php5-mhash php5-mysql php5-xdebug php5-intl php5-xsl</strong></span>
<span class="strong"><strong class="calibre8">php5enmod mcrypt</strong></span>
<span class="strong"><strong class="calibre8">php5dismod xdebug</strong></span>
<span class="strong"><strong class="calibre8">service php5-fpm restart</strong></span>
<span class="strong"><strong class="calibre8">apt-get -y install phpunit</strong></span>
<span class="strong"><strong class="calibre8">echo "Starting Composer stuff" &gt;&gt; /var/tmp/box-progress.txt</strong></span>
<span class="strong"><strong class="calibre8">curl -sS https://getcomposer.org/installer | php</strong></span>
<span class="strong"><strong class="calibre8">mv composer.phar /usr/local/bin/composer</strong></span>
</pre></div><p class="calibre7">We <a id="id83" class="calibre1"/>then move on to MySQL installation. Here, we are also using <code class="email">debconf-set-selections</code> to automate the console part of providing input parameters to the installation. Once installed, MySQL is started and added to the boot process.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">debconf-set-selections &lt;&lt;&lt; 'mysql-server mysql-server/root_password password RrkSBi6VDg6C'</strong></span>
<span class="strong"><strong class="calibre8">debconf-set-selections &lt;&lt;&lt; 'mysql-server mysql-server/root_password_again password RrkSBi6VDg6C'</strong></span>
<span class="strong"><strong class="calibre8">apt-get -y install mysql-server</strong></span>
<span class="strong"><strong class="calibre8">service mysql start</strong></span>
<span class="strong"><strong class="calibre8">update-rc.d mysql defaults</strong></span>
</pre></div><p class="calibre7">Alongside MySQL, another major component is Apache. We install it using the following commands. With Apache, we need to pay attention to its <code class="email">apache2.conf</code> file. We need to change <code class="email">AllowOverride None</code> to <code class="email">AllowOverride All</code> for the Magento directory:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">apt-get -y install apache2</strong></span>
<span class="strong"><strong class="calibre8">update-rc.d apache2 defaults</strong></span>
<span class="strong"><strong class="calibre8">service apache2 start</strong></span>
<span class="strong"><strong class="calibre8">a2enmod rewrite</strong></span>
<span class="strong"><strong class="calibre8">awk '/&lt;Directory \/&gt;/,/AllowOverride None/{sub("None", "All",$0)}{print}' /etc/apache2/apache2.conf &gt; /tmp/tmp.apache2.conf</strong></span>
<span class="strong"><strong class="calibre8">mv /tmp/tmp.apache2.conf /etc/apache2/apache2.conf</strong></span>
<span class="strong"><strong class="calibre8">awk '/&lt;Directory \/var\/www\/&gt;/,/AllowOverride None/{sub("None", "All",$0)}{print}' /etc/apache2/apache2.conf &gt; /tmp/tmp.apache2.conf</strong></span>
<span class="strong"><strong class="calibre8">mv /tmp/tmp.apache2.conf /etc/apache2/apache2.conf</strong></span>
<span class="strong"><strong class="calibre8">service apache2 restart</strong></span>
</pre></div><p class="calibre7">Now that we have MySQL and Apache installed, we move on to getting the source code files in place. Next, we are pulling from the official Magento Git repository. This is not the same as <code class="email">repo.magento.com</code> we used when setting up the vagrant. Though in this case the Magento Git repository is public, the idea is to be able to pull the code from the private GitHub repository. Based on the production environment we tend to set up, we can easily replace the next part with pulling from any other private Git repository.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo rm -Rf /var/www/html/*</strong></span>
<span class="strong"><strong class="calibre8">git clone https://github.com/magento/magento2.git /var/www/html/.</strong></span>
<span class="strong"><strong class="calibre8">sudo composer config --global github-oauth.github.com 7d6da6bld50dub454edc27db70db78b1f8997e6</strong></span>
<span class="strong"><strong class="calibre8">sudo composer install --working-dir="/var/www/html/"</strong></span>
<span class="strong"><strong class="calibre8">mysql -uroot -pRrkSBi6VDg6C -e "CREATE DATABASE magento;"</strong></span>
<span class="strong"><strong class="calibre8">PUBLIC_HOSTNAME="'wget -q -O - http://instance-data/latest/meta- data/public-hostname'"</strong></span>
</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip02" class="calibre1"/>Tip</h3><p class="calibre7">To pull the code from a private git repository, we can use a command of the following form, Git clone: <code class="email">https://&lt;user&gt;:&lt;OAuthToken&gt;@github.com/&lt;user&gt;/&lt;repo&gt;.git</code>.</p></div><p class="calibre7">The <code class="email">PUBLIC_HOSTNAME</code> variable stores the response of the <code class="email">wget</code> command that calls the <code class="email">http://instance-data/latest/meta-data/public-hostname</code> URL. This URL is a feature<a id="id84" class="calibre1"/> of AWS that allows us to get the current EC2 instance metadata. We then use the <code class="email">PUBLIC_HOSTNAME</code> variable during Magento installation, passing it as the <code class="email">--base-url</code> parameter:</p><div class="informalexample"><pre class="programlisting">php /var/www/html/bin/magento setup:install --base- url="http://$PUBLIC_HOSTNAME" --db-host="127.0.0.1" --db- user="root" --db-password="RrkSBi6VDg6C" --db-name="magento" -- admin-firstname="John" --admin-lastname="Doe" --admin- email="john.doe@change.me" --admin-user="admin" --admin- password="pass123" --backend-frontname="admin" -- language="en_US" --currency="USD" --timezone="Europe/London"</pre></div><p class="calibre7">The preceding command takes a lot of <span class="strong"><em class="calibre9">per project</em></span> specific configuration values, so we need to be sure to paste in our own information here appropriately before simply copying and pasting it.</p><p class="calibre7">Now we make sure the Magento mode is set to production, and cache is turned on and flushed, so it regenerates fresh:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php /var/www/html/bin/magento deploy:mode:set production</strong></span>
<span class="strong"><strong class="calibre8">php /var/www/html/bin/magento cache:enable</strong></span>
<span class="strong"><strong class="calibre8">php /var/www/html/bin/magento cache:flush</strong></span>
</pre></div><p class="calibre7">Finally, we reset the permissions on the <code class="email">/var/www/html</code> directory in order for our Magento to function properly:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">chown -R ubuntu:www-data /var/www/html</strong></span>
<span class="strong"><strong class="calibre8">find /var/www/html -type f -print0 | xargs -r0 chmod 640</strong></span>
<span class="strong"><strong class="calibre8">find /var/www/html -type d -print0 | xargs -r0 chmod 750</strong></span>
<span class="strong"><strong class="calibre8">chmod -R g+w /var/www/html/pub</strong></span>
<span class="strong"><strong class="calibre8">chmod -R g+w /var/www/html/var</strong></span>
<span class="strong"><strong class="calibre8">chmod -R g+w /var/www/html/app</strong></span>
<span class="strong"><strong class="calibre8">chmod -R g+w /var/www/html/vendor</strong></span>
</pre></div><p class="calibre7">We need to take caution with the preceding Git and Magento installation example. The idea here was to show how we could automatically set Git pull from the public or private repository. The Magento installation part is a little bonus for this specific case, not something we would actually do on our production machine. The whole purpose of this script would be to serve as a blueprint for powering up new AMI images. So ideally what we would usually do once the code is pulled, is to restore the database from some private storage<a id="id85" class="calibre1"/> like S3 and then attach it to our installation. Thus making for a complete restore of files, database, and media once the script is finished.</p><p class="calibre7">Putting that thought aside, let's get back to our script, further adding the daily database backup using the set of command as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">CRON_CMD="mysql --user=root --password=RrkSBi6VDg6C magento | gzip -9 &gt; ~/database.sql.gz" CRON_JOB="30 2 * * * $CRON_CMD"</strong></span>
<span class="strong"><strong class="calibre8">( crontab -l | grep -v "$CRON_CMD" ; echo "$CRON_JOB" ) | crontab -</strong></span>

<span class="strong"><strong class="calibre8">CRON_CMD="s3cmd  --access_key="AKIAINLIM7M6WGJKMMCQ" -- secret_key="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" put ~/database.sql.gz s3://foggy-project-ghj7/database/database_'date +"%Y-%m-%d_%H-%M"'.sql.gz"</strong></span>
<span class="strong"><strong class="calibre8">CRON_JOB="30 3 * * * $CRON_CMD"</strong></span>
<span class="strong"><strong class="calibre8">( crontab -l | grep -v "$CRON_CMD" ; echo "$CRON_JOB" ) | crontab -</strong></span>
</pre></div><p class="calibre7">Here, we are adding the 2:30 AM <span class="strong"><strong class="calibre8">cron job</strong></span> for backing up the database into the home directory file named <code class="email">database.sql.gz</code>. Then we are adding another cron job that executes at 3:30 AM, which pushes the database backup to S3 storage.</p><p class="calibre7">Similar to the database backup, we can add media backup instructions to our script using the set of command as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">CRON_CMD="tar -cvvzf ~/media.tar.gz /var/www/html/pub/media/"</strong></span>
<span class="strong"><strong class="calibre8">CRON_JOB="30 2 * * * $CRON_CMD"</strong></span>
<span class="strong"><strong class="calibre8">( crontab -l | grep -v "$CRON_CMD" ; echo "$CRON_JOB" ) | crontab -</strong></span>

<span class="strong"><strong class="calibre8">CRON_CMD="s3cmd --access_key="AKIAINLIM7M6WGJKMMCQ" -- secret_key="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" put ~/media.tar.gz s3://foggy-project-ghj7/media/media_'date +"%Y-%m- %d_%H-%M"'.tar.gz"</strong></span>
<span class="strong"><strong class="calibre8">CRON_JOB="30 3 * * * $CRON_CMD"</strong></span>
<span class="strong"><strong class="calibre8">( crontab -l | grep -v "$CRON_CMD" ; echo "$CRON_JOB" ) | crontab -</strong></span>
</pre></div><p class="calibre7">The preceding commands have several pieces of information coded in them. We need to make sure to paste in our access key, secret key, and S3 bucket name accordingly. For simplicity sake, we are not addressing security implications such as hardcoding the access tokens into the cron jobs. Amazon provides an extensive <span class="strong"><em class="calibre9">AWS Security Best Practices</em></span> guide that can be downloaded via the official AWS website.</p><p class="calibre7">Now that we have some understanding of what the bash script for automated EC2 setup could<a id="id86" class="calibre1"/> look like, let's proceed to setting up the EC2 instance.</p><div class="book" title="Setting up EC2"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch02lvl3sec08" class="calibre1"/>Setting up EC2</h3></div></div></div><p class="calibre7">Follow<a id="id87" class="calibre1"/> these steps to get the setting done:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log in to the AWS console</li><li class="listitem" value="2">Under the <span class="strong"><strong class="calibre8">Compute</strong></span> group, click on <span class="strong"><strong class="calibre8">EC2</strong></span>, which should open a screen like the following:<div class="mediaobject"><img src="../images/00020.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="3">Click on the <span class="strong"><strong class="calibre8">Launch Instance</strong></span> button, which should open a screen like the following:<div class="mediaobject"><img src="../images/00021.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="4">Click on the <span class="strong"><strong class="calibre8">Community AMIs</strong></span> tab to the left, and type in <code class="email">Ubuntu Vivid</code> into <a id="id88" class="calibre1"/>the search field, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00022.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p><div class="note" title="Note"><h3 class="title2"><a id="tip03" class="calibre1"/>Tip</h3><p class="calibre7">The Ubuntu 15.x (Vivid Vervet) server by default supports MySQL 5.6.x and PHP 5.6.x, which makes it a good candidate for Magento installation.</p></div><p class="calibre15">We should now see a screen like the following:</p><div class="mediaobject"><img src="../images/00023.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="5">Choose an instance type and click the <span class="strong"><strong class="calibre8">Next: Configure Instance Details</strong></span> button. We should now see a screen like the following:<div class="mediaobject"><img src="../images/00024.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p><div class="note" title="Note"><h3 class="title2"><a id="note07" class="calibre1"/>Note</h3><p class="calibre7">We won't be getting into the details of each of these options. Suffice to say that if we are working on smaller production sites, chances are we can leave most of these options with their default values.</p></div></li><li class="listitem" value="6">Make <a id="id89" class="calibre1"/>sure <span class="strong"><strong class="calibre8">Shutdown behavior</strong></span> is set to <span class="strong"><strong class="calibre8">Stop</strong></span>.</li><li class="listitem" value="7">While still on the <span class="strong"><strong class="calibre8">Step 3: Configure Instance Details</strong></span> screen, scroll down to the bottom <span class="strong"><strong class="calibre8">Advanced Details</strong></span> area and expand it. We should see a screen like the following:<div class="mediaobject"><img src="../images/00025.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="8">The <span class="strong"><strong class="calibre8">User Data</strong></span> input is where we will copy and paste the <code class="email">auto-setup bash</code> script<a id="id90" class="calibre1"/> described in the previous section, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00026.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="9">Once we copy and paste in the <span class="strong"><strong class="calibre8">User Data</strong></span>, click on the <span class="strong"><strong class="calibre8">Next: Add Storage</strong></span> button. This should bring up the screen as shown in the following screenshot:<div class="mediaobject"><img src="../images/00027.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="10">Within <span class="strong"><strong class="calibre8">Step 4: Add Storage</strong></span>, we can select one or more volumes to attach to our <a id="id91" class="calibre1"/>EC2 instance. Preferably, we should select the SSD type of storage for faster performance. Once the volume is set, click on <span class="strong"><strong class="calibre8">Next: Tag Instance</strong></span>. We should now see a screen like the following:<div class="mediaobject"><img src="../images/00028.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="11">The <span class="strong"><strong class="calibre8">Tag Instance</strong></span> screen allows us to assign tags. Tags enable us to categorize our AWS resource by purpose, owner, environment, or some other way. Once we have assigned one or more tags, we click on the <span class="strong"><strong class="calibre8">Next: Configure Security Group</strong></span> button. We should now see a screen like the following:<div class="mediaobject"><img src="../images/00029.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="12">The <span class="strong"><strong class="calibre8">Configure Security Group</strong></span> screen allows us to set rules for inbound and outbound <a id="id92" class="calibre1"/>traffic. We want to be able to access SSH, HTTP, HTTPs, and SMTP services on the box. Once we add the rules we want, click on the <span class="strong"><strong class="calibre8">Review and Launch</strong></span> button. This opens a screen like the following:<div class="mediaobject"><img src="../images/00030.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="13">The <span class="strong"><strong class="calibre8">Review Instance Launch</strong></span> screen is where we can view the summary of the <a id="id93" class="calibre1"/>box we configured up to this point. If needed, we can go back and edit individual settings. Once we are satisfied with the summary, we click on the <span class="strong"><strong class="calibre8">Launch</strong></span> button. This opens a popup like the following:<div class="mediaobject"><img src="../images/00031.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="14">Here, we get to choose an existing security key, or create a new one. Keys are <a id="id94" class="calibre1"/>provided in PEM format. Once we select the key, we click on the <span class="strong"><strong class="calibre8">Launch Instance</strong></span> button.<p class="calibre15">We should now see the <span class="strong"><strong class="calibre8">Launch Status</strong></span> screen like the following:</p><div class="mediaobject"><img src="../images/00032.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="15">Clicking on the instance name link should throw us back at the <span class="strong"><strong class="calibre8">EC2 Dashboard</strong></span> like shown in the following screenshot:<div class="mediaobject"><img src="../images/00033.jpeg" alt="Setting up EC2" class="calibre10"/></div><p class="calibre13"> </p></li></ol><div class="calibre14"/></div><p class="calibre7">With<a id="id95" class="calibre1"/> regard to the preceding image, we should now be able to connect to our EC2 box with either one of the following console commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">ssh -i /path/to/magento-box.pem ubuntu@ec2-52-29-35-49.eu-central-1.compute.amazonaws.com</strong></span>

<span class="strong"><strong class="calibre8">ssh -i /path/to/magento-box.pem ubuntu@52.29.35.49</strong></span>
</pre></div><p class="calibre7">It might take some time for our EC2 box to execute all of the shell commands passed to it. We can conveniently SSH into the box and then execute the following command to get an overview of current progress:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo tail -f /var/tmp/box-progress.txt</strong></span>
</pre></div><p class="calibre7">With this, we conclude our instance launch process.</p></div><div class="book" title="Setting up Elastic IP and DNS"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch02lvl3sec09" class="calibre1"/>Setting up Elastic IP and DNS</h3></div></div></div><p class="calibre7">Now<a id="id96" class="calibre1"/> that we have an EC2 box in place, let's go ahead and create <a id="id97" class="calibre1"/>the so-called Elastic IP for it. The <span class="strong"><strong class="calibre8">Elastic IP address</strong></span> is a static IP address designed for dynamic cloud computing. It is tied to the AWS account, and not<a id="id98" class="calibre1"/> some specific instance. This makes it convenient to easily re-map it from one instance to another.</p><p class="calibre7">Let's go ahead and create an Elastic IP as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log in to the AWS console.</li><li class="listitem" value="2">Under the <span class="strong"><strong class="calibre8">Compute</strong></span> group, click on <span class="strong"><strong class="calibre8">EC2</strong></span>, which should get us to the <span class="strong"><strong class="calibre8">EC2 Dashboard</strong></span>.</li><li class="listitem" value="3">Under <a id="id99" class="calibre1"/>the <span class="strong"><strong class="calibre8">EC2 Dashboard</strong></span>, in the left area under <a id="id100" class="calibre1"/>Network and Security grouping, click on Elastic IPs. This should open a screen like the following:<div class="mediaobject"><img src="../images/00034.jpeg" alt="Setting up Elastic IP and DNS" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="4">Click on the <span class="strong"><strong class="calibre8">Allocate New Address</strong></span> button, which should open a popup like the following:<div class="mediaobject"><img src="../images/00035.jpeg" alt="Setting up Elastic IP and DNS" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="5">Click on the <span class="strong"><strong class="calibre8">Yes, Allocate</strong></span> button, which should open another popup like the following:<div class="mediaobject"><img src="../images/00036.jpeg" alt="Setting up Elastic IP and DNS" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="6">Now <a id="id101" class="calibre1"/>that the Elastic IP address is created, right-clicking<a id="id102" class="calibre1"/> on it within the table listing should bring up the options menu as shown in the following screenshot:<div class="mediaobject"><img src="../images/00037.jpeg" alt="Setting up Elastic IP and DNS" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="7">Click on the <span class="strong"><strong class="calibre8">Associate Address</strong></span> link. This should open a popup like the following:<div class="mediaobject"><img src="../images/00038.jpeg" alt="Setting up Elastic IP and DNS" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="8">On <a id="id103" class="calibre1"/>the <span class="strong"><strong class="calibre8">Associate Address</strong></span> popup, we select the <span class="strong"><strong class="calibre8">Instance</strong></span> to <a id="id104" class="calibre1"/>which we want to assign the Elastic IP address and click on the <span class="strong"><strong class="calibre8">Associate</strong></span> button.</li></ol><div class="calibre14"/></div><p class="calibre7">At this point, our EC2 box has a static (Elastic IP) address assigned. We can now log in to our domain registrar and point the A-record of our DNS to the Elastic IP we just created.</p><p class="calibre7">Until we wait for the DNS change to kick in, there is one more thing we need to address. We need to SSH into our box and execute the following set of commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">mysql -uroot -pRrkSBi6VDg6C -e "USE magento; UPDATE core_config_data SET value = 'http://our-domain.something/' WHERE path LIKE "%web/unsecure/base_url%";"</strong></span>
<span class="strong"><strong class="calibre8">php /var/www/html/bin/magento cache:flush</strong></span>
</pre></div><p class="calibre7">This <a id="id105" class="calibre1"/>will update the Magento URL, so we can access it via a web browser<a id="id106" class="calibre1"/> once the DNS change kicks in. With a little bit of upfront planning, we could have easily made this bit a part of the user data for our EC2 instance, simply by providing the right <code class="email">--base-url</code> parameter value in the first place.</p></div></div></div>
<div class="book" title="Summary" id="K0RQ1-818f5224668745eb9070ddf1d85e6bfa"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec15" class="calibre1"/>Summary</h1></div></div></div><p class="calibre7">Throughout this chapter, we focused on two main things: setting up development and production environments.</p><p class="calibre7">As part of the development environment, we embraced free software such as VirtualBox and Vagrant to manage our environment setup. The setup alone came down to a single <code class="email">Vagrantfile</code> script that contained the necessary set of commands to install everything from the Ubuntu server, PHP, Apache, MySQL, and even Magento itself. We should by no means look at this script as final and only as a valid script to set up our development environment. Investing time in making the development environment closer to the project-specific requirements pays off in terms of team productivity.</p><p class="calibre7">We then moved on to the production environment. Here, we looked into Amazon Web Services, utilizing S3 and EC2 along the way. The production environment also came with its own scripted installation process that sets most of the things. Similarly, this script is by no means final and is only a valid way to set things up; it's more of a base example of how to do it.</p><p class="calibre7">In the next chapter, we will take a closer look at some of programming concepts and conventions.</p></div></body></html>