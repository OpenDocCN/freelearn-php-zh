<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Creating a Photo-sharing Application"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Creating a Photo-sharing Application</h1></div></div></div><p>There are quite a few image-sharing websites around at the moment. They all share roughly the same structure: the user uploads an image and that image can be shared, allowing others to view that image. Perhaps limits or constraints are placed on the viewing of an image, perhaps the image only remains viewable for a set period of time, or within set dates, but the general structure is the same. And I'm happy to announce that this project is exactly the same.</p><p>We'll create an application allowing users to share pictures; these pictures are accessible from a unique URL. To make this app, we will create two controllers: one to process image uploading and one to process the viewing and displaying of images stored.</p><p>We'll create a language file to store the text, allowing you to have support for multiple languages should it be needed.</p><p>We'll create all the necessary view files and a model to interface with the database.</p><p>However, this project along with all the others in this book relies on the basic setup we did in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>, although you can take large sections of the code and drop it into pretty much any project you may already have. Keep in mind that the setup done in the first chapter acts as a foundation for this chapter.</p><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Design and wireframes</li><li class="listitem" style="list-style-type: disc">Creating the database</li><li class="listitem" style="list-style-type: disc">Creating the models</li><li class="listitem" style="list-style-type: disc">Creating the views</li><li class="listitem" style="list-style-type: disc">Creating the controllers</li><li class="listitem" style="list-style-type: disc">Putting it all together</li></ul></div><p>So without further ado, let's get on with it.</p><div class="section" title="Design and wireframes"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec38"/>Design and wireframes</h1></div></div></div><p>As always, before we start building, we should take a look at what we plan to build.</p><p>First, a brief <a id="id292" class="indexterm"/>description of our intent: we plan to build an app to allow the user to upload an image. That image<a id="id293" class="indexterm"/> will be stored in a folder with a unique name. A URL will also be generated containing a <a id="id294" class="indexterm"/>unique code, and the URL and code will be assigned to that image. The image can be accessed via that URL.</p><p>The idea of using a unique<a id="id295" class="indexterm"/> URL to access that image is so that we can control access to that image, such as allowing an image to be viewed only a set number of times, or for a certain period of time only.</p><p>Anyway, to get a better idea of what's happening, let's take a look at the following site map:</p><div class="mediaobject"><img src="graphics/7093OS_04_04.jpg" alt="Design and wireframes"/></div><p>So that's the site map. The first thing to notice is how simple the site is. There are only three main areas to this project. Let's go over each item and get a brief idea of what they do:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>create</strong></span>: Imagine this as the start <a id="id296" class="indexterm"/>point. The user will be shown a simple form allowing them to upload an image. Once the user presses the Upload button, they are directed to <code class="literal">do_upload</code>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>do_upload</strong></span>: The uploaded image is validated for size and file type. If it passes, then a unique eight-character string is generated. This string is then used as the name of a folder we will make. This folder is present in the main <code class="literal">upload</code> folder and the <a id="id297" class="indexterm"/>uploaded image is saved in it. The image details (image name, folder name, and so on) are then passed to the database model, where another unique code is generated for the image URL. This unique code, image name, and folder name are then saved to the database.<p>The user is then presented with a message informing them that their image has been uploaded and that a URL has been created. The user is also presented with the image they have uploaded.</p></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>go</strong></span>: This will take a URL provided by someone typing into a browser's address bar, or an <code class="literal">img src</code> tag, or some other method. The <code class="literal">go</code> item will look at the unique code in<a id="id298" class="indexterm"/> the URL, query the database to see if that code exists, and if so, fetch the folder name and image name and deliver the image back to the method that called it.</li></ul></div><p>Now that we have a fairly good idea of the structure and form of the site, let's take a look at the wireframes of each page.</p><div class="section" title="The create item"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec43"/>The create item</h2></div></div></div><p>The following screenshot shows<a id="id299" class="indexterm"/> a wireframe for the <code class="literal">create</code> item discussed in the previous section. The user is shown a simple form allowing them to upload an image.</p><div class="mediaobject"><img src="graphics/7093OS_04_01.jpg" alt="The create item"/></div></div><div class="section" title="The do_upload item"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec44"/>The do_upload item</h2></div></div></div><p>The following <a id="id300" class="indexterm"/>screenshot shows a wireframe from the <code class="literal">do_upload</code> item discussed in the previous section. The user is shown the image they have uploaded and the URL that will direct other users to that image.</p><div class="mediaobject"><img src="graphics/7093OS_04_02.jpg" alt="The do_upload item"/></div></div><div class="section" title="The go item"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec45"/>The go item</h2></div></div></div><p>The following screenshot <a id="id301" class="indexterm"/>shows a wireframe from the go item described in the previous section. The <code class="literal">go</code> controller takes the unique code in a URL, attempts to find it in the database table images, and if found, supplies the image associated with it. Only the image is supplied, not the actual HTML markup.</p><div class="mediaobject"><img src="graphics/7093OS_04_03.jpg" alt="The go item"/></div></div><div class="section" title="File overview"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec46"/>File overview</h2></div></div></div><p>This is a<a id="id302" class="indexterm"/> relatively small project, and all in all we're only going to create seven files, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/image_model.php</code>: This provides read/write access to<a id="id303" class="indexterm"/> the <code class="literal">images</code> database table. This model also takes the upload information and unique folder name (which we store the uploaded image in) from the <code class="literal">create</code> controller and stores this to the database.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/create/create.php</code>: This provides us with an interface to display a form allowing the user to upload a file. This also displays any error<a id="id304" class="indexterm"/> messages to the user, such as wrong file type, file size too big, and so on.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/create/result.php</code>: This displays the image to the user after it has been successfully uploaded, as well as the URL required to view that image.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/nav/top_nav.php</code>: This provides a navigation bar at the top<a id="id305" class="indexterm"/> of the page.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/create.php</code>: This performs validation checks <a id="id306" class="indexterm"/>on the image uploaded by the user, creates a uniquely named folder to store the uploaded image, and passes this information to the model.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/go.php</code>: This performs validation checks on the URL input by the user, looks for the unique code in the URL and<a id="id307" class="indexterm"/> attempts to find this record in the database. If it is found, then it will display the image stored on disk.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/language/english/en_admin_lang.php</code>: This provides language<a id="id308" class="indexterm"/> support for the application.</li></ul></div><p>The file structure of the preceding seven files is as follows:</p><div class="informalexample"><pre class="programlisting">application/
├── controllers/
│   ├── create.php
│   ├── go.php
├── models/
│   ├── image_model.php
├── views/create/
│   ├── create.php
│   ├── result.php
├── views/nav/
│   ├── top_nav.php
├── language/english/
│   ├── en_admin_lang.php</pre></div></div></div></div>
<div class="section" title="Creating the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec39"/>Creating the database</h1></div></div></div><p>Okay, you should have already set up CodeIgniter and Bootstrap as described in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>; if you have not, then you should know that the code in this chapter is specifically built<a id="id309" class="indexterm"/> with the setup from <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources,</em></span> in mind. However, it's not the end of the world if you haven't. The code can easily be applied to other projects and applications you may have developed independently.</p><p>First, we'll build the database. Copy the following MySQL code into your database:</p><div class="informalexample"><pre class="programlisting">CREATE DATABASE `imagesdb`;
USE `imagesdb`;

DROP TABLE IF EXISTS `images`;
CREATE TABLE `images` (
  `img_id` int(11) NOT NULL AUTO_INCREMENT,
  `img_url_code` varchar(10) NOT NULL,
  `img_url_created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `img_image_name` varchar(255) NOT NULL,
  `img_dir_name` varchar(8) NOT NULL,
  PRIMARY KEY (`img_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</pre></div><p>Right, let's take a look at each item in every table and see what they mean:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th colspan="2" style="text-align: center" valign="bottom">
<p>Table: images</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Element</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Description</strong></span>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">img_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is<a id="id310" class="indexterm"/> the primary key.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">img_url_code</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This stores<a id="id311" class="indexterm"/> the unique code that we use to identify the image in the database.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">img_url_created_at</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the MySQL<a id="id312" class="indexterm"/> timestamp for the record.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">img_image_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id313" class="indexterm"/> filename provided by the CodeIgniter upload functionality.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">img_dir_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the name <a id="id314" class="indexterm"/>of the directory we store the image in.</p>
</td></tr></tbody></table></div><p>We'll also need to make amends to the <code class="literal">config/database.php</code> file, namely setting the database access details, username, password, and so on.</p><p>Open the <code class="literal">config/database.php</code> file and find the following lines:</p><div class="informalexample"><pre class="programlisting">$db['default']['hostname'] = 'localhost';
$db['default']['username'] = 'your username';
$db['default']['password'] = 'your password';
$db['default']['database'] = 'imagesdb';</pre></div><p>Edit the values in the preceding code ensuring you substitute those values for the ones more specific to your setup and situation—so enter your username, password, and so on.</p></div>
<div class="section" title="Adjusting the config.php and autoload.php files"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec40"/>Adjusting the config.php and autoload.php files</h1></div></div></div><p>We don't actually need to<a id="id315" class="indexterm"/> adjust the <code class="literal">config.php</code> file in this project as we're not really using sessions or anything like that. So we don't need an encryption key or database<a id="id316" class="indexterm"/> information.</p><p>So just ensure that you are not autoloading the session in the <code class="literal">config/autoload.php</code> file or you will get an error, as we've not set any session variables in the <code class="literal">config/config.php</code> file.</p></div>
<div class="section" title="Adjusting the routes.php file"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec41"/>Adjusting the routes.php file</h1></div></div></div><p>We want to redirect the<a id="id317" class="indexterm"/> user to the <code class="literal">create</code> controller rather than the default CodeIgniter <code class="literal">welcome</code> controller. To do this, we will need to amend the default controller settings in the <code class="literal">routes.php</code> file to reflect this. The steps are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">config/routes.php</code> file for editing and find the following lines (near the bottom of the file):<div class="informalexample"><pre class="programlisting">$route['default_controller'] = "welcome";
$route['404_override'] = '';</pre></div></li><li class="listitem">First, we need to change the default controller. Initially, in a CodeIgniter application, the default controller is set to <code class="literal">welcome</code>. However, we don't need that, instead we want the default controller to be <code class="literal">create</code>, so find the following line:<div class="informalexample"><pre class="programlisting">$route['default_controller'] = "welcome";</pre></div><p>Replace it with the following lines:</p><div class="informalexample"><pre class="programlisting">$route['default_controller'] = "create";
$route['404_override'] = '';</pre></div></li><li class="listitem">Then we need to add some rules to govern how we handle URLs coming in and form submissions.<p>Leave a few<a id="id318" class="indexterm"/> blank lines underneath the preceding two lines of code (default controller and 404 override) and add the following three lines of code:</p><div class="informalexample"><pre class="programlisting">$route['create'] = "create/index";
$route['(:any)'] = "go/index";
$route['create/do_upload'] = "create/do_upload";</pre></div></li></ol></div></div>
<div class="section" title="Creating the model"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec42"/>Creating the model</h1></div></div></div><p>There is only one <a id="id319" class="indexterm"/>model in this project, <code class="literal">image_model.php</code>. It contains functions specific to creating and resetting passwords.</p><p>Create the <code class="literal">/path/to/codeigniter/application/models/image_model.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Image_model extends CI_Model {
  function __construct() {
    parent::__construct();
  }

  function save_image($data) {
    do {
      $img_url_code = random_string('alnum', 8); 

      $this-&gt;db-&gt;where('img_url_code = ', $img_url_code);
      $this-&gt;db-&gt;from('images');
      $num = $this-&gt;db-&gt;count_all_results();
    } while ($num &gt;= 1);

    $query = "INSERT INTO `images` (`img_url_code`, `img_image_name`, `img_dir_name`) VALUES (?,?,?) ";
    $result = $this-&gt;db-&gt;query($query, array($img_url_code, $data['image_name'], $data['img_dir_name']));

    if ($result) {
      return $img_url_code;
    } else {
      return flase;
    }
  }

function fetch_image($img_url_code) {
    $query = "SELECT * FROM `images` WHERE `img_url_code` = ? ";
    $result = $this-&gt;db-&gt;query($query, array($img_url_code));

    if ($result) {
      return $result;
    } else {
      return false;
    }
  }
}</pre></div><p>There are two main functions in this model, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">save_image()</code>: This generates<a id="id320" class="indexterm"/> a unique code that is associated with the uploaded image and saves it, with the image name and folder name, to the database.</li><li class="listitem" style="list-style-type: disc"><code class="literal">fetch_image()</code>: This fetches <a id="id321" class="indexterm"/>an image's details from the database according to the unique code provided.</li></ul></div><p>Okay, let's take <code class="literal">save_image()</code> first. The <code class="literal">save_image()</code> function accepts an array from the <code class="literal">create</code> controller containing <code class="literal">image_name</code> (from the upload process) and <code class="literal">img_dir_name</code> (this is the folder that the image is stored in).</p><p>A unique code is generated using a <code class="literal">do…while</code> loop as shown here:</p><div class="informalexample"><pre class="programlisting">$img_url_code = random_string('alnum', 8); </pre></div><p>First a string is created, eight<a id="id322" class="indexterm"/> characters in length, containing alpha-numeric characters. The <code class="literal">do…while</code> loop checks to see if this code already exists in the database, generating a new code if it is already present. If it does not already exist, this code is used:</p><div class="informalexample"><pre class="programlisting">do {
  $img_url_code = random_string('alnum', 8); 

  $this-&gt;db-&gt;where('img_url_code = ', $img_url_code);
  $this-&gt;db-&gt;from('images');
  $num = $this-&gt;db-&gt;count_all_results();
} while ($num &gt;= 1);</pre></div><p>This code and the contents of the <code class="literal">$data</code> array are then saved to the database using the following code:</p><div class="informalexample"><pre class="programlisting">$query = "INSERT INTO `images` (`img_url_code`, `img_image_name`, `img_dir_name`) VALUES (?,?,?) ";
$result = $this-&gt;db-&gt;query($query, array($img_url_code, $data['image_name'], $data['img_dir_name']));</pre></div><p>The <code class="literal">$img_url_code</code> is returned if the <code class="literal">INSERT</code> operation was successful, and <code class="literal">false</code> if it failed. The code to <a id="id323" class="indexterm"/>achieve this is as follows:</p><div class="informalexample"><pre class="programlisting">if ($result) {
  return $img_url_code;
} else {
  return false;
}</pre></div></div>
<div class="section" title="Creating the views"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec43"/>Creating the views</h1></div></div></div><p>There are only three views in this project, which are<a id="id324" class="indexterm"/> as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/create/create.php</code>: This displays a form to the user<a id="id325" class="indexterm"/> allowing them to upload an image.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/create/result.php</code>: This displays a link<a id="id326" class="indexterm"/> that the user can use to forward other people to the image, as well as the image itself.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/nav/top_nav.php</code>: This displays the top-level menu. In this<a id="id327" class="indexterm"/> project it's very simple, containing a project name and a link to go to the <code class="literal">create</code> controller.</li></ul></div><p>So those are our views, as I said, there are only three of them as it's a simple project. Now, let's create each view file.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">/path/to/codeigniter/application/views/create/create.php</code> file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;div class="page-header"&gt;
  &lt;h1&gt;&lt;?php echo $this-&gt;lang-&gt;line('system_system_name'); ?&gt;&lt;/h1&gt;
&lt;/div&gt;

&lt;p&gt;&lt;?php echo $this-&gt;lang-&gt;line('encode_instruction_1'); ?&gt;&lt;/p&gt;

  &lt;?php echo validation_errors(); ?&gt;

&lt;?php if (isset($success) &amp;&amp; $success == true) : ?&gt;
  &lt;div class="alert alert-success"&gt;
    &lt;strong&gt;&lt;?php echo $this-&gt;lang-&gt;line('common_form_elements_success_notifty'); ?&gt;&lt;/strong&gt;&lt;?php echo $this-&gt;lang-&gt;line('encode_encode_now_success'); ?&gt; 
  &lt;/div&gt;
&lt;?php endif ; ?&gt;

&lt;?php if (isset($fail) &amp;&amp; $fail == true) : ?&gt;
  &lt;div class="alert alert-danger"&gt;
    &lt;strong&gt;&lt;?php echo $this-&gt;lang-&gt;line('common_form_elements_error_notifty'); ?&gt; &lt;/strong&gt;&lt;?php echo $this-&gt;lang-&gt;line('encode_encode_now_error'); ?&gt;
    &lt;?php echo $fail ; ?&gt; 
  &lt;/div&gt;
&lt;?php endif ; ?&gt;

&lt;?php echo form_open_multipart('create/do_upload');?&gt;
  &lt;input type="file" name="userfile" size="20" /&gt;
  &lt;br /&gt;
  &lt;input type="submit" value="upload" /&gt;
&lt;?php echo form_close() ; ?&gt;
&lt;br /&gt;
&lt;?php if (isset($result) &amp;&amp; $result == true) : ?&gt;
  &lt;div class="alert alert-info"&gt;
    &lt;strong&gt;&lt;?php echo $this-&gt;lang-&gt;line('encode_upload_url'); ?&gt; &lt;/strong&gt; 
    &lt;?php echo anchor($result, $result) ; ?&gt;
  &lt;/div&gt;
&lt;?php endif ; ?&gt;</pre></div><p>This view file can be thought of as the main view file; it is here that the user can upload<a id="id328" class="indexterm"/> their image.  Error messages are displayed here too.</p></li><li class="listitem">Create the <code class="literal">/path/to/codeigniter/application/views/create/result.php</code> file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;div class="page-header"&gt;
  &lt;h1&gt;&lt;?php echo $this-&gt;lang-&gt;line('system_system_name'); ?&gt;&lt;/h1&gt;
&lt;/div&gt;

&lt;?php if (isset($result) &amp;&amp; $result == true) : ?&gt;
    &lt;strong&gt;&lt;?php echo $this-&gt;lang-&gt;line('encode_encoded_url'); ?&gt; &lt;/strong&gt; 
    &lt;?php echo anchor($result, $result) ; ?&gt;
    &lt;br /&gt;
    &lt;img src="&lt;?php echo base_url() . 'upload/' . $img_dir_name . '/' . $file_name ;?&gt;" /&gt;
&lt;?php endif ; ?&gt;</pre></div><p>This view will display the encoded image resource URL to the user (so they can copy and share it) and the actual image itself.</p></li><li class="listitem">Create the <code class="literal">/path/to/codeigniter/application/views/nav/top_nav.php</code> file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;!-- Fixed navbar --&gt;
&lt;div class="navbar navbar-inverse navbar-fixed-top" role="navigation"&gt;
  &lt;div class="container"&gt;
    &lt;div class="navbar-header"&gt;
      &lt;button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"&gt;
        &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
      &lt;/button&gt;
      &lt;a class="navbar-brand" href="#"&gt;&lt;?php echo $this-&gt;lang-&gt;line('system_system_name'); ?&gt;&lt;/a&gt;
    &lt;/div&gt;
    &lt;div class="navbar-collapse collapse"&gt;
      &lt;ul class="nav navbar-nav"&gt;
        &lt;li class="active"&gt;&lt;?php echo anchor('create', 'Create') ; ?&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/div&gt;&lt;!--/.nav-collapse --&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;div class="container theme-showcase" role="main"&gt;</pre></div><p>This view is quite<a id="id329" class="indexterm"/> basic but still serves an important role. It displays an option to return to the <code class="literal">index()</code> function of the <code class="literal">create</code> controller.</p></li></ol></div></div>
<div class="section" title="Creating the controllers"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec44"/>Creating the controllers</h1></div></div></div><p>We're going to create two<a id="id330" class="indexterm"/> controllers in this project, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/create.php</code>: This handles the creation of<a id="id331" class="indexterm"/> unique folders to store images and performs the upload of a file.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/go.php</code>: This fetches the unique code from<a id="id332" class="indexterm"/> the database, and returns any image associated with that code.</li></ul></div><p>These are two of our controllers for this project, let's now go ahead and create them.</p><p>Create the <code class="literal">/path/to/codeigniter/application/controllers/create.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Create extends MY_Controller {
  function __construct() {
    parent::__construct();
      $this-&gt;load-&gt;helper(array('string'));
      $this-&gt;load-&gt;library('form_validation');
      $this-&gt;load-&gt;library('image_lib');
      $this-&gt;load-&gt;model('Image_model');
      $this-&gt;form_validation-&gt;set_error_delimiters('&lt;div class="alert alert-danger"&gt;', '&lt;/div&gt;');
    }

  public function index() {
    $page_data = array('fail' =&gt; false,
                       'success' =&gt; false); 
    $this-&gt;load-&gt;view('common/header');
    $this-&gt;load-&gt;view('nav/top_nav');
    $this-&gt;load-&gt;view('create/create', $page_data);
    $this-&gt;load-&gt;view('common/footer');
  }

  public function do_upload() {
    $upload_dir = '/filesystem/path/to/upload/folder/';
    do {
      // Make code
      $code = random_string('alnum', 8); 

      // Scan upload dir for subdir with same name
      // name as the code
      $dirs = scandir($upload_dir);

      // Look to see if there is already a 
      // directory with the name which we 
      // store in $code 
      if (in_array($code, $dirs)) { // Yes there is
        $img_dir_name = false; // Set to false to begin again
      } else { // No there isn't
        $img_dir_name = $code; // This is a new name
      }

    } while ($img_dir_name == false);

    if (!mkdir($upload_dir.$img_dir_name)) {
      $page_data = array('fail' =&gt; $this-&gt;lang-&gt;line('encode_upload_mkdir_error'),
                         'success' =&gt; false);
      $this-&gt;load-&gt;view('common/header');
      $this-&gt;load-&gt;view('nav/top_nav');
      $this-&gt;load-&gt;view('create/create', $page_data);
      $this-&gt;load-&gt;view('common/footer');
    }

    $config['upload_path'] = $upload_dir.$img_dir_name;
    $config['allowed_types'] = 'gif|jpg|jpeg|png';
    $config['max_size'] = '10000';
    $config['max_width']  = '1024';
    $config['max_height']  = '768';

    $this-&gt;load-&gt;library('upload', $config);

    if ( ! $this-&gt;upload-&gt;do_upload()) {
      $page_data = array('fail' =&gt; $this-&gt;upload-&gt;display_errors(),
                         'success' =&gt; false);
      $this-&gt;load-&gt;view('common/header');
      $this-&gt;load-&gt;view('nav/top_nav');
      $this-&gt;load-&gt;view('create/create', $page_data);
      $this-&gt;load-&gt;view('common/footer');
    } else {
      $image_data = $this-&gt;upload-&gt;data();
      $page_data['result'] = $this-&gt;Image_model-&gt;save_image(array('image_name' =&gt; $image_data['file_name'], 'img_dir_name' =&gt; $img_dir_name));
      $page_data['file_name'] = $image_data['file_name'];
      $page_data['img_dir_name'] = $img_dir_name;

      if ($page_data['result'] == false) {
        // success - display image and link
        $page_data = array('fail' =&gt; $this-&gt;lang-&gt;line('encode_upload_general_error'));
        $this-&gt;load-&gt;view('common/header');
        $this-&gt;load-&gt;view('nav/top_nav');
        $this-&gt;load-&gt;view('create/create', $page_data);
        $this-&gt;load-&gt;view('common/footer');
      } else {
        // success - display image and link
        $this-&gt;load-&gt;view('common/header');
        $this-&gt;load-&gt;view('nav/top_nav');
        $this-&gt;load-&gt;view('create/result', $page_data);
        $this-&gt;load-&gt;view('common/footer');
      }
    }
  }
}</pre></div><p>Let's start with the <code class="literal">index()</code> function. The<a id="id333" class="indexterm"/> <code class="literal">index()</code> function sets the <code class="literal">fail</code> and <code class="literal">success</code> elements of the <code class="literal">$page_data</code> array to <code class="literal">false</code>. This will suppress any initial messages from being displayed to the user. The views<a id="id334" class="indexterm"/> are loaded, specifically the <code class="literal">create/create.php</code> view, which contains the image upload form's HTML markup.</p><p>Once the user submits the form in <code class="literal">create/create.php</code>, the form will be submitted to the <code class="literal">do_upload()</code> function of the <code class="literal">create</code> controller. It is this function that will perform the task of uploading the image to the server.</p><p>First off, <code class="literal">do_upload()</code> defines an initial location for the <code class="literal">upload</code> folder. This is stored in the <code class="literal">$upload_dir</code> variable.</p><p>Next, we move into a <code class="literal">do…while</code> structure. It looks something like this:</p><div class="informalexample"><pre class="programlisting">do {
// something
} while ('…a condition is not met');</pre></div><p>So that means <span class="emphasis"><em>do something while a condition is not being met</em></span>. Now with that in mind, think about our problem—we have to save the image being uploaded in a folder. That folder must have a unique name. So what we will do is generate a random string of eight alpha-numeric characters and then look to see if a folder exists with that name. Keeping that in mind, let's look at<a id="id335" class="indexterm"/> the code in detail:</p><div class="informalexample"><pre class="programlisting">do {
  // Make code
  $code = random_string('alnum', 8); 

  // Scan uplaod dir for subdir with same name
  // name as the code
  $dirs = scandir($upload_dir);

  // Look to see if there is already a 
  // directory with the name which we 
  // store in $code 
  if (in_array($code, $dirs)) { // Yes there is
    $img_dir_name = false; // Set to false to begin again
  } else { // No there isn't
    $img_dir_name = $code; // This is a new name
  }
} while ($img_dir_name == false);</pre></div><p>So we make a string of eight characters, containing only alphanumeric characters, using the following line of code:</p><div class="informalexample"><pre class="programlisting">$code = random_string('alnum', 8);</pre></div><p>We then use the PHP function <code class="literal">scandir()</code> to look in <code class="literal">$upload_dir</code>. This will store all directory names in the <code class="literal">$dirs</code> variable, as follows:</p><div class="informalexample"><pre class="programlisting">$dirs = scandir($upload_dir);</pre></div><p>We then use the PHP<a id="id336" class="indexterm"/> function <code class="literal">in_array()</code> to look for the value in <code class="literal">$code</code> in the list of directors from <code class="literal">scandir()</code>.</p><p>If we don't find a match, then the value in <code class="literal">$code</code> must not be taken, so we'll go with that. If the value is found, then we set <code class="literal">$img_dir_name</code> to <code class="literal">false</code>, which is picked up by the final line of the <code class="literal">do…while</code> loop:</p><div class="informalexample"><pre class="programlisting">...
} while ($img_dir_name == false);</pre></div><p>Anyway, now that we have our unique folder name, we'll attempt to create it. We use the PHP function <code class="literal">mkdir()</code>, passing to it <code class="literal">$upload_dir</code> concatenated with <code class="literal">$img_dir_name</code>. If <code class="literal">mkdir()</code> returns <code class="literal">false</code>, the form is displayed again along with the <code class="literal">encode_upload_mkdir_error</code> message set in the language file, as shown here:</p><div class="informalexample"><pre class="programlisting">if (!mkdir($upload_dir.$img_dir_name)) {
  $page_data = array('fail' =&gt; $this-&gt;lang-&gt;line('encode_upload_mkdir_error'),
                     'success' =&gt; false);
  $this-&gt;load-&gt;view('common/header');
  $this-&gt;load-&gt;view('nav/top_nav');
  $this-&gt;load-&gt;view('create/create', $page_data);
  $this-&gt;load-&gt;view('common/footer');
}</pre></div><p>Once the folder has been made, we then set the configuration variables for the upload process, as follows:</p><div class="informalexample"><pre class="programlisting">$config['upload_path'] = $upload_dir.$img_dir_name;
$config['allowed_types'] = 'gif|jpg|jpeg|png';
$config['max_size'] = '10000';
$config['max_width']  = '1024';
$config['max_height']  = '768';</pre></div><p>Here we are specifying<a id="id337" class="indexterm"/> that we only want to upload <code class="literal">.gif</code>, <code class="literal">.jpg</code>, <code class="literal">.jpeg</code>, and <code class="literal">.png</code> files. We also specify that an image cannot be above 10,000 KB in size (although you can set this to any value you wish—remember to adjust the <code class="literal">upload_max_filesize</code> and <code class="literal">post_max_size</code> PHP settings in your <code class="literal">php.ini</code> file if you want to have a really big file).</p><p>We also set the minimum dimensions that an image must be. As with the file size, you can adjust this as you wish.</p><p>We then load the <code class="literal">upload</code> library, passing to it the configuration settings, as shown here:</p><div class="informalexample"><pre class="programlisting">$this-&gt;load-&gt;library('upload', $config);</pre></div><p>Next we will attempt to do the upload. If unsuccessful, the CodeIgniter function <code class="literal">$this-&gt;upload-&gt;do_upload()</code> will return <code class="literal">false</code>. We will look for this and reload the upload page if it does return <code class="literal">false</code>. We will also pass the specific error as a reason why it failed. This error is stored in the <code class="literal">fail</code> item of the <code class="literal">$page_data</code> array. This can be done as follows:</p><div class="informalexample"><pre class="programlisting">    if ( ! $this-&gt;upload-&gt;do_upload()) {
      $page_data = array('fail' =&gt; $this-&gt;upload-&gt;display_errors(),
                         'success' =&gt; false);
      $this-&gt;load-&gt;view('common/header');
      $this-&gt;load-&gt;view('nav/top_nav');
      $this-&gt;load-&gt;view('create/create', $page_data);
      $this-&gt;load-&gt;view('common/footer');
    } else {
...</pre></div><p>If, however, it did not fail, we grab the information generated by CodeIgniter from the upload. We'll store this in the <code class="literal">$image_data</code> array, as follows:</p><div class="informalexample"><pre class="programlisting">$image_data = $this-&gt;upload-&gt;data();</pre></div><p>Then we try to store a record of the upload in the database. We call the <code class="literal">save_image</code> function of <code class="literal">Image_model</code>, passing to it <code class="literal">file_name</code> from the <code class="literal">$image_data</code> array, as well as <code class="literal">$img_dir_name</code>, as shown here:</p><div class="informalexample"><pre class="programlisting">$page_data['result'] = $this-&gt;Image_model-&gt;save_image(array('image_name' =&gt; $image_data['file_name'], 'img_dir_name' =&gt; $img_dir_name));</pre></div><p>We then test for the return value of the <code class="literal">save_image()</code> function; if it is successful, then <code class="literal">Image_model</code> will return the unique URL code generated in the model. If it is unsuccessful, then <code class="literal">Image_model</code> will return the Boolean <code class="literal">false</code>.</p><p>If <code class="literal">false</code> is returned, then the form is<a id="id338" class="indexterm"/> loaded with a general error. If successful, then the <code class="literal">create/result.php</code> view file is loaded. We pass to it the unique URL code (for the link the user needs), and the folder name and image name, necessary to display the image correctly.</p><p>Create the <code class="literal">/path/to/codeigniter/application/controllers/go.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Go extends MY_Controller {
  function __construct() {
  parent::__construct();
    $this-&gt;load-&gt;helper('string');
  }

  public function index() {
    if (!$this-&gt;uri-&gt;segment(1)) {
      redirect (base_url());
    } else {
      $image_code = $this-&gt;uri-&gt;segment(1);
      $this-&gt;load-&gt;model('Image_model');
      $query = $this-&gt;Image_model-&gt;fetch_image($image_code);

      if ($query-&gt;num_rows() == 1) {
        foreach ($query-&gt;result() as $row) {
          $img_image_name = $row-&gt;img_image_name;
          $img_dir_name = $row-&gt;img_dir_name;
        }

        $url_address = base_url() . 'upload/' . $img_dir_name .'/' . $img_image_name;
        redirect (prep_url($url_address));
      } else {
        redirect('create');
      }
    }
  }
}</pre></div><p>The <code class="literal">go</code> controller has only one main function, <code class="literal">index()</code>. It is called when a user clicks on a URL or a URL is called (perhaps as the <code class="literal">src</code> value of an HTML <code class="literal">img</code> tag). Here we grab the unique code generated and assigned to an image when it was uploaded in the <code class="literal">create</code> controller.</p><p>This code is in the first value of the URI. Usually it would occupy the third parameter—with the first and second parameters normally being used to specify the controller and controller function <a id="id339" class="indexterm"/>respectively. However, we have changed this behavior using CodeIgniter routing. This is explained fully in the <span class="emphasis"><em>Adjusting the routes.php file</em></span> section of this chapter.</p><p>Once we have the unique code, we pass it to the <code class="literal">fetch_image()</code> function of <code class="literal">Image_model</code>:</p><div class="informalexample"><pre class="programlisting">$image_code = $this-&gt;uri-&gt;segment(1);
$this-&gt;load-&gt;model('Image_model');
$query = $this-&gt;Image_model-&gt;fetch_image($image_code);</pre></div><p>We test for what is returned. We ask if the number of rows returned equals exactly <code class="literal">1</code>. If not, we will then redirect to the <code class="literal">create</code> controller.</p><p>Perhaps you may not want to do this. Perhaps you may want to do nothing if the number of rows returned does not equal <code class="literal">1</code>. For example, if the image requested is in an HTML <code class="literal">img</code> tag, then if an image is not found a redirect may send someone away from the site they're viewing to the upload page of this project—something you might not want to happen. If you want to remove this functionality, remove the following lines in bold from the code excerpt:</p><div class="informalexample"><pre class="programlisting">....
        $img_dir_name = $row-&gt;img_dir_name;
        }

        $url_address = base_url() . 'upload/' . $img_dir_name .'/' . $img_image_name;
        redirect (prep_url($url_address));
      } <span class="strong"><strong>else {</strong></span>
        <span class="strong"><strong>redirect('create');</strong></span>
      <span class="strong"><strong>}</strong></span>
    }
  }
}
....</pre></div><p>Anyway, if the returned value is exactly <code class="literal">1</code>, then we'll loop over the returned database object and find <code class="literal">img_image_name</code> and <code class="literal">img_dir_name</code>, which we'll need to locate the image in the <code class="literal">upload</code> folder<a id="id340" class="indexterm"/> on the disk. This can be done as follows:</p><div class="informalexample"><pre class="programlisting">foreach ($query-&gt;result() as $row) {
  $img_image_name = $row-&gt;img_image_name;
  $img_dir_name = $row-&gt;img_dir_name;
}</pre></div><p>We then build the address of the image file and redirect the browser to it, as follows:</p><div class="informalexample"><pre class="programlisting">$url_address = base_url() . 'upload/' . $img_dir_name .'/' . $img_image_name;
redirect (prep_url($url_address));</pre></div></div>
<div class="section" title="Creating the language file"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec45"/>Creating the language file</h1></div></div></div><p>As with all the <a id="id341" class="indexterm"/>projects in this book, we're making use of the language file to serve text to users. In this way, you can enable multiple region/multiple language support.</p><p>Create the <code class="literal">/path/to/codeigniter/application/language/english/en_admin_lang.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

// General
$lang['system_system_name'] = "Image Share";

// Upload
$lang['encode_instruction_1'] = "Upload your image to share it";
$lang['encode_upload_now'] = "Share Now";
$lang['encode_upload_now_success'] = "Your image was uploaded, you can share it with this URL";
$lang['encode_upload_url'] = "Hey look at this, here's your image:";
$lang['encode_upload_mkdir_error'] = "Cannot make temp folder";
$lang['encode_upload_general_error'] = "The Image cannot be saved at this time";</pre></div></div>
<div class="section" title="Putting it all together"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec46"/>Putting it all together</h1></div></div></div><p>Let's look at how the user<a id="id342" class="indexterm"/> uploads an image. The following is the sequence of events:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">CodeIgniter looks in the <code class="literal">routes.php</code> config file and finds the following line:<div class="informalexample"><pre class="programlisting">$route['create'] = "create/index";</pre></div><p>It directs the request to the <code class="literal">create</code> controller's <code class="literal">index()</code> function.</p></li><li class="listitem">The <code class="literal">index()</code> function loads the <code class="literal">create/create.php</code> view file that displays the upload form to the user.</li><li class="listitem">The user clicks on the Choose file button, navigates to the image file they wish to upload, and selects it.</li><li class="listitem">The user presses the Upload button and the form is submitted to the <code class="literal">create</code> controller's <code class="literal">index()</code> function.</li><li class="listitem">The <code class="literal">index()</code> function creates a folder in the main <code class="literal">upload</code> directory to store the image in, then does the actual upload.</li><li class="listitem">On a successful upload, <code class="literal">index()</code> sends the details of the upload (the new folder name and image name) to the <code class="literal">save_image()</code> model function.</li><li class="listitem">The <code class="literal">save_model()</code> function also creates a unique code and saves it in the <code class="literal">images</code> table along with the folder name and image name passed to it by the <code class="literal">create</code> controller.</li><li class="listitem">The unique code<a id="id343" class="indexterm"/>  generated during the database insert is then returned to the controller and passed to the result view, where it will form part of a success message to the user.</li></ol></div><p>Now, let's see how an image is viewed (or fetched). The following is the sequence of events:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">A URL with the syntax <code class="literal">www.domain.com/226KgfYH</code> comes into the application—either when someone clicks on a link or some other call (<code class="literal">&lt;img src=""&gt;</code>).</li><li class="listitem">CodeIgniter looks in the <code class="literal">routes.php</code> config file and finds the following line:<div class="informalexample"><pre class="programlisting">$route['(:any)'] = "go/index";</pre></div></li><li class="listitem">As the incoming request does not match the other two routes, the preceding route is the one CodeIgniter applies to this request.</li><li class="listitem">The <code class="literal">go</code> controller is called and the code of <code class="literal">226KgfYH</code> is passed to it as the 1st segment of <code class="literal">uri</code>.</li><li class="listitem">The <code class="literal">go</code> controller passes this to the <code class="literal">fetch_image()</code> function of the <code class="literal">Image_model.php</code> file. The <code class="literal">fetch_image()</code> function will attempt to find a matching record in the database. If found, it returns the folder name marking the saved location of the image, and its filename.</li><li class="listitem">This is returned and the path to that image is built. CodeIgniter then redirects the user to that image, that is, supplies that image resource to the user that requested it.</li></ol></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec47"/>Summary</h1></div></div></div><p>So here we have a basic image sharing application. It is capable of accepting a variety of images and assigning them to records in a database and unique folders in the filesystem. This is interesting as it leaves things open to you to improve on. For example, you can do the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You can add limits on views. As the image record is stored in the database, you could adapt the database. Adding two columns called <code class="literal">img_count</code> and <code class="literal">img_count_limit</code>, you could allow a user to set a limit for the number of views per image and stop providing that image when that limit is met.</li><li class="listitem" style="list-style-type: disc">You can limit views by date. Similar to the preceding point, but you could limit image views to set dates.</li><li class="listitem" style="list-style-type: disc">You can have different URLs for different dimensions. You could add functionality to make several dimensions of image based on the initial upload, offering several different URLs for different image dimensions.</li><li class="listitem" style="list-style-type: disc">You can report abuse. You could add an option allowing viewers of images to report unsavory images that might be uploaded.</li><li class="listitem" style="list-style-type: disc">You can have terms of service. If you are planning on offering this type of application as an actual web service that members of the public could use, then I strongly recommend you add a terms of service document, perhaps even require that people agree to terms before they upload an image.<p>In those terms, you'll want to mention that in order for someone to use the service, they first have to agree that they do not upload and share any images that could be considered illegal. You should also mention that you'll cooperate with any court if information is requested of you.</p><p>You really don't want to get into trouble for owning or running a web service that stores unpleasant images; as much as possible you want to make your limits of liability clear and emphasize that it is the uploader who has provided the images.</p></li></ul></div><p>In the next chapter, we will create a newsletter signup system. You'll be able to get people to sign up and have their details in a database. People will be allowed to unsubscribe and opt-in and opt-out of various settings.</p></div></body></html>