<html><head></head><body>
		<div>
			<div class="Content" id="_idContainer291">
			</div>
		</div>
		<div class="Content" id="_idContainer292">
			<h1 id="_idParaDest-368"><a id="_idTextAnchor379"/>Appendix</h1>
		</div>
		<div id="_idContainer293">
			<h2>About</h2>
			<p>This section is included to assist the students to perform the activities present in the book. It includes detailed steps that are to be performed by the students to complete and achieve the objectives of the book.</p>
		</div>
		<div class="Content" id="_idContainer318">
			<h1 id="_idParaDest-369"><a id="_idTextAnchor380"/>1. Introducing PHP</h1>
			<h2 id="_idParaDest-370"><a id="_idTextAnchor381"/>Activity 1.1: Displaying Query Strings in the Browser</h2>
			<p><strong class="bold">Solution</strong></p>
			<ol>
				<li>Create a file named <strong class="source-inline">movies.php</strong>.</li>
				<li>Capture query string data in the file to store the details of the movies, such as the name, the actors, and the release years:<p class="source-code">&lt;?php </p><p class="source-code">$name = $_GET['movieName'];</p><p class="source-code">$star = $_GET['movieStar'];</p><p class="source-code">$year = $_GET['movieYear'];</p><p class="source-code">?&gt;</p></li>
				<li>Create a basic HTML structure and then display the captured query strings:<p class="source-code-heading">movies.php</p><p class="source-code">8      &lt;head&gt;</p><p class="source-code">9          &lt;meta charset="UTF-8"&gt;</p><p class="source-code">10         &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</p><p class="source-code">11         &lt;meta http-equiv="X-UA-Compatible" content="ie=edge"&gt;</p><p class="source-code">12         &lt;title&gt;&lt;?php echo $name; ?&gt;&lt;/title&gt;</p><p class="source-code">13     &lt;/head&gt;</p><p class="source-code">14     &lt;body&gt;</p><p class="source-code">15         &lt;div&gt;</p><p class="source-code">16             &lt;h1&gt;Information about &lt;?php  echo $name; ?&gt;&lt;/h1&gt;</p><p class="source-code">17             &lt;p&gt;</p><p class="source-code">28             Based on the input, here is the information so far:</p><p class="source-code">19             &lt;br&gt;</p><p class="source-code">20             &lt;?php echo $star . ' starred in the movie ' . $name .'                  which was released in year ' . $year; ?&gt;</p><p class="source-code">21             &lt;/p&gt;</p><p class="source-code">22         &lt;/div&gt;</p><p class="source-code">23     &lt;/body&gt;</p><p class="source-code-link"><a href="https://packt.live/2P3sZ75">https://packt.live/2P3sZ75</a></p></li>
				<li>Now, go to the Terminal and type the following command to start the built-in web server:<p class="source-code">php -S localhost:8085</p><p>You should see a screen like the following:</p><div class="IMG---Figure" id="_idContainer294"><img alt="Figure 1.17: Starting the server&#13;&#10;" src="image/C14196_01_17.jpg"/></div><p class="figure-caption">Figure 1.17: Starting the server</p></li>
				<li>After the web server is up and running, open the PHP page and append your query strings to the URL in your browser:<p><strong class="source-inline">http://localhost:8085/movies.php?movieName=Avengers&amp;movieStar=IronMan&amp;movieYear=2019</strong></p><p>You can change the values to anything you like to see how they will be displayed in the browser.</p><p>You should see a screen like the following:</p></li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer295">
					<img alt="Figure 1.18: Printing the information about the movie&#13;&#10;" src="image/C14196_01_18.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 1.18: Printing the information about the movie</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Ensure that the port you have specified is not being used by any other application on your system.</p>
			<p>Depending on the last few exercises, you should now be aware of how this code is working. Let's go through the query string and code.</p>
			<p>The query string this time is <strong class="source-inline">movieName=Avengers&amp;movieStar=IronMan&amp;movieYear=2019</strong>. This means that the <strong class="source-inline">$_GET</strong> variable in PHP will have access to three different variables now, which are <strong class="source-inline">movieName</strong>, <strong class="source-inline">movieStar</strong>, and <strong class="source-inline">movieYear</strong>.</p>
			<p>In the first three lines of code, we are extracting values for <strong class="source-inline">movieName</strong>, <strong class="source-inline">movieStar</strong>, and <strong class="source-inline">movieYear</strong> and assigning them to the <strong class="source-inline">$name</strong>, <strong class="source-inline">$star</strong>, and <strong class="source-inline">$year</strong> variables, respectively.</p>
			<p>In the head section of HTML, we have a title. Inside it, we have used the <strong class="source-inline">echo</strong> statement to print the movie name, which will appear in the browser. Moving further down, we have an <strong class="source-inline">h1</strong> element where we are printing the name again. After the <strong class="source-inline">h1</strong> element is a <strong class="source-inline">p</strong> element, where we are creating a sentence dynamically. We have used the variables and the dot operator (<strong class="source-inline">.</strong>) to append different strings and variables to create a full sentence.</p>
			<h1 id="_idParaDest-371"><a id="_idTextAnchor382"/>2. Types and Operators</h1>
			<h2 id="_idParaDest-372"><a id="_idTextAnchor383"/>Activity 2.1: Printing the BMI of a User</h2>
			<p><strong class="bold">Solution</strong></p>
			<ol>
				<li value="1">Create a new file called <strong class="source-inline">tracker.php</strong>. Then, open PHP and create a variable to store the name. You can assign a value directly, in other words, <strong class="source-inline">$name = 'Joe'</strong>:<p class="source-code">&lt;?php</p><p class="source-code">$name = 'Joe';</p></li>
				<li>Add variables for the weight and height; again, set a default value:<p class="source-code">$weightKg = 80;</p><p class="source-code">$heightCm = 180;</p></li>
				<li>Take the <strong class="source-inline">$heightCm</strong> variable, convert it to meters by dividing by <strong class="source-inline">100</strong>, and then store the result:<p class="source-code">$heightMeters = $heightCm/100;</p></li>
				<li>Square the height and store the result:<p class="source-code">$heightSquared = $heightMeters * $heightMeters;</p></li>
				<li>Calculate the BMI by taking the weight and dividing it by the squared height:<p class="source-code">$bmi = $weightKg / ($heightSquared);</p></li>
				<li>Display a message to the user showing the name and BMI result:<p class="source-code">echo "&lt;p&gt;Hello $name, your BMI is $bmi&lt;/p&gt;";</p></li>
				<li>Open the Terminal/Command Prompt and navigate to your <strong class="source-inline">chapter2</strong> folder or where you stored <strong class="source-inline">tracker.php</strong>. Run the server by typing in this command:<p class="source-code">php -S localhost:8085</p><p>Now, in a browser, go to <strong class="source-inline">http://localhost:8085/tracker.php</strong>.</p><p>You will see the following output:</p><div class="IMG---Figure" id="_idContainer296"><img alt="Figure 2.11: Printing the BMI&#13;&#10;" src="image/C14196_02_11.jpg"/></div></li>
			</ol>
			<p class="figure-caption">Figure 2.11: Printing the BMI</p>
			<p>In this activity, we've looked at assigning data to variables and performing calculations (divisions and multiplications). Then, we printed the end result to the screen.</p>
			<h1 id="_idParaDest-373"><a id="_idTextAnchor384"/>3. Control Statements</h1>
			<h2 id="_idParaDest-374"><a id="_idTextAnchor385"/>Activity 3.1: Creating a Movie Listing Script to Print Movies per Director</h2>
			<p><strong class="bold">Solution</strong></p>
			<p>The steps to complete the activity are as follows:</p>
			<ol>
				<li value="1">Create an <strong class="source-inline">activity-movies.php</strong> script and add the following nested array, which contains five directors with a list of the five movies associated with them:<p class="source-code">&lt;?php</p><p class="source-code">$directors = [</p><p class="source-code">"Steven Spielberg" =&gt; ["The Terminal", "Minority Report", "Catch Me If You Can", "Lincoln", "Bridge of Spies"],</p><p class="source-code">"Christopher Nolan" =&gt; ["Dunkirk", "Interstellar", "The Dark Knight Rises", "Inception", "Memento"],</p><p class="source-code">"Martin Scorsese" =&gt; ["Silence", "Hugo", "Shutter Island", "The Departed", "Gangs of New York"],</p><p class="source-code">"Spike Lee" =&gt; ["Do the Right Thing", "Malcolm X", "Summer of Sam", "25th Hour", "Inside Man"],</p><p class="source-code">"Lynne Ramsey" =&gt; ["Ratcatcher", "Swimmer", "Morvern Callar", "We Need To Talk About Kevin", "You Were Never Really Here"]</p><p class="source-code">                 ];</p><p>Here, we have an associative array, <strong class="source-inline">$directors</strong>, which contains five directors' names and each director is used as a key for the array. Also, each director's key has been assigned another associative array that contains five movie names.</p></li>
				<li>Using our previous knowledge of nested looping, loop through the nested array using two <strong class="source-inline">foreach</strong> loops, as follows. As in the following, add the loops after the <strong class="source-inline">$directors</strong> array:<p class="source-code">foreach ($directors as $director =&gt; $movies) {</p><p class="source-code">        echo "$director's movies: " . PHP_EOL;</p><p class="source-code">        foreach ($movies as $movie) {</p><p class="source-code">                echo " &gt; $movie " . PHP_EOL;</p><p class="source-code">        }</p><p class="source-code">}</p><p>In the preceding example, we have a simple looping through a nested array. Since a <strong class="source-inline">foreach</strong> loop is a good choice to iterate through associative arrays, we have utilized <strong class="source-inline">foreach</strong> in both the inner and outer loop to print a formatted director's name along with the movies they directed on each new line.</p></li>
				<li>Run the PHP file from a Terminal or console with the following command:<p class="source-code">php activity-movies.php</p><p>The preceding command outputs the following:</p><div class="IMG---Figure" id="_idContainer297"><img alt="Figure 3.21: The activity movies script output with default arguments&#13;&#10;" src="image/C14196_03_21.jpg"/></div><p class="figure-caption">Figure 3.21: The activity movies script output with default arguments</p><p>The nested <strong class="source-inline">foreach</strong> loops do their job and iterate through the nested array to print the available movie names against the directors' names.</p></li>
				<li>Now, it's time to add some dynamic behavior to our looping technique so that we can control the iterations in both loops with command-line arguments. This means we will be taking two arguments from the command line, as follows:<p class="source-code">php activity_movies.php 3 2</p><p>Here, the script name itself is an argument for a <strong class="source-inline">php</strong> command, hence, the first, second, and third arguments are <strong class="source-inline">activity-movies.php</strong>, <strong class="source-inline">3</strong>, and <strong class="source-inline">2</strong> respectively. The second argument should control the number of directors to iterate and the third argument should control the number of movies to iterate.</p><p>Command-line arguments can be obtained using the <strong class="source-inline">$argv</strong> system variable, so we will be using <strong class="source-inline">$argv[1]</strong> and <strong class="source-inline">$argv[2]</strong> for the second and third arguments. Note that <strong class="source-inline">$argv[0]</strong> is the script name in this case.</p></li>
				<li>Add the following lines at the beginning of the script to add the command-line arguments:<p class="source-code">&lt;?php</p><p class="source-code">$directorsLimit = $argv[1] ?? 5;</p><p class="source-code">$moviesLimit = $argv[2] ?? 5;</p></li>
				<li>Here, <strong class="source-inline">??</strong>, the null coalescing operator, has been used so that if <strong class="source-inline">$argv[1]</strong> or <strong class="source-inline">$argv[2]</strong> does not exist or is <strong class="source-inline">NULL</strong>, then we can assign a default number 5 to the <strong class="source-inline">$directorsLimit</strong> and <strong class="source-inline">$moviesLimit</strong> limit variables.</li>
				<li>Now we need to add two counters that will count the directors and movies to print so that we can maintain the number of directors and movies to print, supplied in the form of command-line arguments. Let's add the counters and the control statements to restrict the prints so that the nested loops look like the following:<p class="source-code">$directorsCounter = 1;</p><p class="source-code">foreach ($directors as $director =&gt; $movies) {</p><p class="source-code">        if ($directorsCounter &gt; $directorsLimit) {</p><p class="source-code">                break;</p><p class="source-code">        }</p><p class="source-code">        echo "$director's movies: " . PHP_EOL;</p><p class="source-code">        $moviesCounter = 1;</p><p class="source-code">        foreach ($movies as $movie) {</p><p class="source-code">                if ($moviesCounter &gt; $moviesLimit) {</p><p class="source-code">                        break;</p><p class="source-code">                }</p><p class="source-code">                echo " &gt; $movie " . PHP_EOL;</p><p class="source-code">                $moviesCounter++;</p><p class="source-code">        }</p><p class="source-code">        $directorsCounter++;</p><p class="source-code">}</p><p>Here, we have added <strong class="source-inline">$directorsCounter</strong> before the outer loop and <strong class="source-inline">$moviesCounter</strong> before the inner loop. Both of them start counting from <strong class="source-inline">1</strong> and immediately inside the loops we have checked whether the directors or movies exceed the limits given in <strong class="source-inline">$directorsLimit</strong> and <strong class="source-inline">$moviesLimit</strong> respectively. If any of the counters become greater than their limit, we terminate the iteration using the <strong class="source-inline">break</strong> command.</p><p>At the beginning of each loop, we have used a condition expression in the <strong class="source-inline">if</strong> control to check that the counter doesn't exceed the limit, and at the very end of each loop, the corresponding counter gets incremented.</p><p class="callout-heading">Note</p><p class="callout">The final file can be referred at: <a href="https://packt.live/35QfYnp">https://packt.live/35QfYnp</a>.</p></li>
				<li>Now run the following command to see the <strong class="source-inline">directors</strong> and <strong class="source-inline">movies</strong> arguments in action:<p class="source-code">php activity_movies.php 2 1</p><p>The preceding command should print one movie from each of the two directors, as follows:</p><div class="IMG---Figure" id="_idContainer298"><img alt="Figure 3.22: The activity movies script output with custom arguments&#13;&#10;" src="image/C14196_03_22.jpg"/></div><p class="figure-caption">Figure 3.22: The activity movies script output with custom arguments</p></li>
				<li>Test the preceding script with different arguments; that is, <strong class="source-inline">php activity-movies.php 2 3</strong>. As we have already assigned the default limit value to 5 in the limit variables, if no arguments are present in the command; that is, <strong class="source-inline">php activity-movies.php</strong>, it will complete all iterations to loop through the array elements.</li>
				<li>We can also try passing only the <strong class="source-inline">directors</strong> limit argument so that the <strong class="source-inline">movies</strong> limit stays at the default limit of 5. The following command will output all of the movies from the given number of directors:<p class="source-code">php activity-movies.php 2</p><p>The output is as follows:</p><div class="IMG---Figure" id="_idContainer299"><img alt="Figure 3.23: The activity movies script output with the first argument&#13;&#10;" src="image/C14196_03_23.jpg"/></div></li>
			</ol>
			<p class="figure-caption">Figure 3.23: The activity movies script output with the first argument</p>
			<p>Congratulations! You have used control statements and looping techniques to create a dynamic script that works based on command-line arguments. <em class="italic">Control structures are used to control the execution of a program</em>, hence we can leverage such structures to make decisions about things such as which branch of code to execute, to perform repetitive executions, to control the flow of iterations, and so on. </p>
			<h1 id="_idParaDest-375"><a id="_idTextAnchor386"/>4. Functions</h1>
			<h2 id="_idParaDest-376"><a id="_idTextAnchor387"/>Activity 4.1: Creating a Calculator</h2>
			<p><strong class="bold">Solution</strong></p>
			<ol>
				<li value="1">Create a new file within the <strong class="source-inline">Chapter04</strong> directory with the name <strong class="source-inline">activity.php</strong>.</li>
				<li>Start your script with the opening PHP tag and set the strict type to <strong class="source-inline">1</strong>:<p class="source-code">&lt;?php</p><p class="source-code">declare(strict_types=1);</p></li>
				<li>Now we can start by writing our <strong class="source-inline">factorial</strong> function in the same file:<p class="source-code-heading">activity.php</p><p class="source-code">13 function factorial(int $number): float</p><p class="source-code">14 {</p><p class="source-code">15     $factorial = $number;</p><p class="source-code">16     while ($number &gt; 2) {</p><p class="source-code">17         $number--;</p><p class="source-code">18         $factorial *= $number;</p><p class="source-code">19     }</p><p class="source-code">20     return $factorial;</p><p class="source-code">21 }</p><p class="source-code-link"><a href="https://packt.live/31nkK8E">https://packt.live/31nkK8E</a></p><p>Let me explain what the function does. First of all, it takes an integer argument; we can be sure that it will always be an integer because we added a type hint and declared that we are using strict types. There are several ways in which you may have implemented the function, so don't let my solution put you off.</p><p>My take on it is that the first number in the calculation will have to be the input number – we store it in <strong class="source-inline">$factorial</strong>, which is the variable we will use to hold the result. Then, it is multiplied by <strong class="source-inline">$number - 1</strong>. This goes on until <strong class="source-inline">$number === 2;</strong>. The <strong class="source-inline">while</strong> condition runs for the last time when <strong class="source-inline">$number</strong> has become <strong class="source-inline">3</strong>; it will then be decremented by <strong class="source-inline">1</strong> and multiplied with the <strong class="source-inline">$factorial</strong> variable. By the end, <strong class="source-inline">$factorial</strong> contains the result and is returned from the function.</p><p>Instead of <strong class="source-inline">$number--;</strong> using the post decrement operator, <strong class="source-inline">--</strong>, we could have written <strong class="source-inline">$number = $number -1;</strong>. Some people consider the latter to be a better practice because it is more explicit. I sometimes prefer to use the handy shortcuts that PHP has to offer. Because <strong class="source-inline">$number--</strong> is on its own line as a single statement, we could have also written <strong class="source-inline">--$number</strong>. In this case, there is no difference. </p><p>The difference between the two operators is that with <strong class="source-inline">--$number</strong>, <strong class="source-inline">$number</strong> will be decremented before the statement runs, and with <strong class="source-inline">$number--</strong>, it will be decremented after the statement has been evaluated. In this case, there is no consequence of that difference.</p></li>
				<li>Next, we will define the <strong class="source-inline">sum</strong> function as follows:<p class="source-code">/**</p><p class="source-code"> * Return the sum of its inputs. Give as many inputs as you like.</p><p class="source-code"> *</p><p class="source-code"> * @return float</p><p class="source-code"> */</p><p class="source-code">function sum(): float</p><p class="source-code">{</p><p class="source-code">    return array_sum(func_get_args());</p><p class="source-code">}</p><p>While we could have just looped over <strong class="source-inline">func_get_args();</strong> and added all the numbers together to get the sum, there is already a built-in function in PHP that does just that. So, why not use it? That is what <strong class="source-inline">array_sum</strong> does: it adds up all the numbers in the input array you give it. The <strong class="source-inline">return</strong> keyword makes the function return the result.</p><p>If you wanted to validate each parameter to check whether it was numeric (using <strong class="source-inline">is_numeric</strong>), then looping over the arguments would have been better because you would do the check in the same iteration as the addition and throw an exception when the argument wasn't numeric.</p></li>
				<li>The last mathematical function we will define is the <strong class="source-inline">prime</strong> function:<p class="source-code-heading">activity.php</p><p class="source-code">41 function prime(int $number): bool</p><p class="source-code">42 {</p><p class="source-code">43     // everything equal or smaller than 2 is not a prime number</p><p class="source-code">44     if (2 &gt;= $number) {</p><p class="source-code">45         return false;</p><p class="source-code">46     }</p><p class="source-code">47     for ($i = 2; $i &lt;= sqrt($number); $i++) {</p><p class="source-code">48         if ($number % $i === 0) {</p><p class="source-code">49             return false;</p><p class="source-code">50         }</p><p class="source-code">51     }</p><p class="source-code">52     return true;</p><p class="source-code">53 }</p><p class="source-code-link"><a href="https://packt.live/2OYdEox">https://packt.live/2OYdEox</a></p><p>The <strong class="source-inline">prime</strong> function is definitely the most challenging of them all. The naive implementation would just try to determine the modulo of the <strong class="source-inline">$number</strong> input by all values that are smaller: when the modulo is <strong class="source-inline">0</strong>, then it is not a prime number. However, it has already been proven that you only have to check all the numbers up to the square root of the input. In fact, you could check even fewer numbers, but we have not gone as far as that. </p><p>Now we know 1 is not a prime number so, if the number that is passed through is 1 then we return <strong class="source-inline">false</strong> early. This also rules out 0 and negative numbers. Prime numbers are positive by definition. Then, starting with 2, up until the square root of the <strong class="source-inline">$number</strong> input, we increment <strong class="source-inline">$i</strong> by 1 and check whether the modulo of the division of <strong class="source-inline">$number</strong> by <strong class="source-inline">$i</strong> is 0. If it is, <strong class="source-inline">$number</strong> is not a prime number and we again return <strong class="source-inline">false</strong> early. The modulo operator is written as <strong class="source-inline">%</strong> (the percentage symbol). In other words, when the <strong class="source-inline">$number</strong> modulo <strong class="source-inline">$i</strong> equals 0, <strong class="source-inline">$number</strong> is divisible by <strong class="source-inline">$i</strong>, and since <strong class="source-inline">$i</strong> is not equal to 1 and not equal to <strong class="source-inline">$number</strong>, <strong class="source-inline">$number</strong> is not a prime number.</p></li>
				<li>Our last major function that we will define is the <strong class="source-inline">performOperation</strong> function:<p class="source-code-heading">activity.php</p><p class="source-code">59 function performOperation(string $operation)</p><p class="source-code">60 {</p><p class="source-code">61     switch ($operation) {</p><p class="source-code">62         case 'factorial':</p><p class="source-code">63             // get the second parameter, it must be an int.</p><p class="source-code">64             // we will cast it to int to be sure</p><p class="source-code">65             $number = (int) func_get_arg(1);</p><p class="source-code">66             return factorial($number);</p><p class="source-code">67         case 'sum':</p><p class="source-code">68             // get all parameters</p><p class="source-code">69             $params = func_get_args();</p><p class="source-code">70             // remove the first parameter, because it is the operation</p><p class="source-code">71             array_shift($params);</p><p class="source-code">72             return call_user_func_array('sum', $params);</p><p class="source-code">73         case 'prime':</p><p class="source-code">74             $number = (int) func_get_arg(1);</p><p class="source-code">75             return prime($number);</p><p class="source-code">76     }</p><p class="source-code">77 }</p><p class="source-code-link"><a href="https://packt.live/31s2YB2">https://packt.live/31s2YB2</a></p><p>This function just switches between the three other functions based on the <strong class="source-inline">$operation</strong> case you give it as its first argument. Since one of the functions it delegates its work to accepts a varying amount of arguments, <strong class="source-inline">performOperation</strong> also has to accept a varying number of arguments.</p><p>You could also choose an implementation where you let <strong class="source-inline">performOperation</strong> have a second parameter, <strong class="source-inline">$number</strong>, which can then be passed exactly as it is to both factorial and prime. In that case, you only query <strong class="source-inline">func_get_args</strong> in the case of the <strong class="source-inline">sum</strong> operation. The approach you choose is not only a matter of taste, but also of performance. It is faster not to use <strong class="source-inline">func_get_args()</strong>, so the alternative approach would definitely be the fastest.</p></li>
				<li>Print the output as follows:<p class="source-code">echo performOperation("factorial", 3) . PHP_EOL;</p><p class="source-code">echo performOperation('sum', 2, 2, 2) . PHP_EOL;</p><p class="source-code">echo (performOperation('prime', 3)) ? "The number you entered was prime."   . PHP_EOL : "The number you entered was not prime." . PHP_EOL;</p><p>Here is the output:</p><div class="IMG---Figure" id="_idContainer300"><img alt="Figure 4.18: Printing the results&#13;&#10;" src="image/C14196_04_18.jpg"/></div></li>
			</ol>
			<p class="figure-caption">Figure 4.18: Printing the results</p>
			<h1 id="_idParaDest-377"><a id="_idTextAnchor388"/>5. Object-Oriented Programming</h1>
			<h2 id="_idParaDest-378"><a id="_idTextAnchor389"/>Activity 5.1: Building a Student and Professor Object Relationship</h2>
			<p><strong class="bold">Solution</strong></p>
			<p>The steps to complete the activity are as follows:</p>
			<ol>
				<li value="1">Create a directory named <strong class="source-inline">activity1</strong> to put all our activity content in it. This should be our working directory (you can <strong class="source-inline">cd</strong> to the directory). </li>
				<li>Create a directory named <strong class="source-inline">Student</strong> inside the <strong class="source-inline">activity1</strong> directory to put the namespaced <strong class="source-inline">Student</strong> class in it.</li>
				<li>Create a PHP file called <strong class="source-inline">Student.php</strong> inside the <strong class="source-inline">Student</strong> directory. </li>
				<li>Declare a <strong class="source-inline">Student</strong> class where the <strong class="source-inline">Student</strong> class has been namespaced as <strong class="source-inline">Student</strong> and has two member attributes, <strong class="source-inline">$name</strong> and <strong class="source-inline">$title</strong>, which are <strong class="source-inline">student</strong> by default. The constructor method accepts the student's name as an argument. The argument is hinted with its desired type as <strong class="source-inline">string</strong> (anything other than <strong class="source-inline">string</strong> will produce an error) and assigns it to the <strong class="source-inline">$name</strong> property using <strong class="source-inline">$this-&gt;name</strong>. So, whenever we instantiate the <strong class="source-inline">Student</strong> class, we should call the class by its namespace, such as the new <strong class="source-inline">Student\Student('Student Name')</strong> namespace:<p class="source-code">&lt;?php</p><p class="source-code">namespace Student;</p><p class="source-code">class Student</p><p class="source-code">{</p><p class="source-code">    public $name;</p><p class="source-code">    public $title = 'student';</p><p class="source-code">    function __construct(string $name)</p><p class="source-code">{</p><p class="source-code">        $this-&gt;name = $name;</p><p class="source-code">    }</p><p class="source-code">}</p></li>
				<li>For the professor, create a directory called <strong class="source-inline">Professor</strong> under the <strong class="source-inline">activity1</strong> directory.</li>
				<li>Inside the <strong class="source-inline">Professor</strong> directory, create a PHP file called <strong class="source-inline">Professor.php</strong>.</li>
				<li>Declare the <strong class="source-inline">Professor</strong> class with the <strong class="source-inline">Professor</strong> namespace at <strong class="source-inline">Professor.php</strong>. The <strong class="source-inline">Professor</strong> class is similar to <strong class="source-inline">Student</strong> but with an extra private attribute, <strong class="source-inline">$students</strong>, which will hold an array of students. The <strong class="source-inline">$students</strong> array is kept private so that the students' list can't be accessed outside of the <strong class="source-inline">Professor</strong> class. The default title for a professor is <strong class="source-inline">Prof.</strong>, which has been assigned in the <strong class="source-inline">$title</strong> attribute. The constructor accepts hinted parameters, a name (accepts strings only), and the students (accepts arrays only) list as two arguments, and the first parameter, <strong class="source-inline">$name</strong>, has been assigned to the <strong class="source-inline">$name</strong> property using <strong class="source-inline">$this-&gt;name</strong>. We are using parameter type hints to ensure that no other types are passed:<p class="source-code">&lt;?php</p><p class="source-code">namespace Professor;</p><p class="source-code">class Professor</p><p class="source-code">{</p><p class="source-code">    public $name;</p><p class="source-code">    public $title = 'Prof.';</p><p class="source-code">    private $students = array();</p><p class="source-code">    function __construct(string $name, array $students)</p><p class="source-code">    {</p><p class="source-code">        $this-&gt;name = $name;</p><p class="source-code">    }</p><p class="source-code">}</p></li>
				<li>Also, we will use the instance of the <strong class="source-inline">Student</strong> class within the <strong class="source-inline">Professor</strong> namespace, so we need to import the <strong class="source-inline">Student</strong> class via the <strong class="source-inline">Student</strong> namespace in <strong class="source-inline">Professor.php</strong>, as follows:<p class="source-code">&lt;?php</p><p class="source-code">namespace Professor;</p><p class="source-code">use Student\Student;</p><p>Here, after the <strong class="source-inline">Professor</strong> namespace declaration, we have imported the <strong class="source-inline">Student</strong> class via its <strong class="source-inline">Student</strong> namespace.</p></li>
				<li>We need to iterate through the array of students and check each of the objects – whether it is an instance of the <strong class="source-inline">Student</strong> class or not. If it is a valid student, then add it to the professor's <strong class="source-inline">$students</strong> array.<p>Add the following filtration in the <strong class="source-inline">Professor</strong> constructor for <strong class="source-inline">$students</strong>:</p><p class="source-code">    function __construct(string $name, array $students)</p><p class="source-code">{</p><p class="source-code">        $this-&gt;name = $name;</p><p class="source-code">        </p><p class="source-code">        foreach ($students as $student) {</p><p class="source-code">            if ($student instanceof Student) {</p><p class="source-code">                $this-&gt;students[] = $student;</p><p class="source-code">            }</p><p class="source-code">        }</p><p class="source-code">    }</p><p>Here, we have iterated through <strong class="source-inline">$students</strong> using a <strong class="source-inline">foreach</strong> loop and, inside, checked whether <strong class="source-inline">$student</strong> is an instance of the <strong class="source-inline">Student</strong> class, then added it to the <strong class="source-inline">$this-&gt;students</strong> array. So, only valid students can be added to the professor's student list.</p></li>
				<li>Now, add the following setter method in the <strong class="source-inline">Professor</strong> class in order to set the title:<p class="source-code">    public function setTitle(string $title)</p><p class="source-code">{</p><p class="source-code">        $this-&gt;title = $title;</p><p class="source-code">    }</p><p>This one should be used to set the professor's title. If a professor is a <strong class="source-inline">Ph.D.</strong>, then we set the title as <strong class="source-inline">Dr.</strong>.</p></li>
				<li>Create a member method, <strong class="source-inline">printStudents()</strong>, as follows, in the <strong class="source-inline">Professor</strong> class, which will print the professor's title, name, the student count, and the list of students in the following:<p class="source-code">    public function printStudents()</p><p class="source-code">{</p><p class="source-code">        echo "$this-&gt;title $this-&gt;name's students (" .count($this-          &gt;students). "): " . PHP_EOL;</p><p class="source-code">        $serial = 1;</p><p class="source-code">        foreach ($this-&gt;students as $student) {</p><p class="source-code">            echo " $serial. $student-&gt;name " . PHP_EOL;</p><p class="source-code">            $serial++;</p><p class="source-code">        }</p><p class="source-code">    }</p><p>Here, we have printed the professor's title, name, and the number of students. Again, we have used a <strong class="source-inline">foreach</strong> loop to iterate through the professor's private property, <strong class="source-inline">$students</strong>, and inside the loop we have printed each student's name. Also, for the sake of maintaining a serial order of the students, we have used the <strong class="source-inline">$serial</strong> variable starting from <strong class="source-inline">1</strong>, which increments by one after each iteration in order to add a number before each student's name while printing.</p></li>
				<li>Create a PHP file called <strong class="source-inline">activity-classes.php</strong> inside the <strong class="source-inline">activity1</strong> directory.</li>
				<li>Add the <strong class="source-inline">spl_autoload_register()</strong> function at the beginning of the file to load the <strong class="source-inline">Professor</strong> and <strong class="source-inline">Student</strong> classes automatically according to their namespaces:<p class="source-code">&lt;?php</p><p class="source-code">spl_autoload_register();</p><p>Here, we haven't registered any class loader methods in the <strong class="source-inline">spl_autoload_register()</strong> function; rather, we have kept it as the default to load the classes according to their namespaces.</p></li>
				<li>Create a <strong class="source-inline">Professor</strong> instance, providing a name and a list of students that contains instances of <strong class="source-inline">Student</strong> in the constructor as follows:<p class="source-code">$professor = new Professor\Professor('Charles Kingsfield', array(</p><p class="source-code">                    new Student\Student('Elwin Ransom'),</p><p class="source-code">                    new Student\Student('Maurice Phipps'),</p><p class="source-code">                    new Student\Student('James Dunworthy'),</p><p class="source-code">                    new Student\Student('Alecto Carrow')</p><p class="source-code">            ));</p><p>Here, we have added a random amount of <strong class="source-inline">Student</strong> instances in an array and passed them to the <strong class="source-inline">Professor</strong> constructor. When we instantiate the <strong class="source-inline">Professor</strong> class as <strong class="source-inline">new</strong> <strong class="source-inline">Professor\Professor()</strong>, this namespaced class name tells the auto loader to load the <strong class="source-inline">Professor</strong> class from the <strong class="source-inline">Professor</strong> directory. This same namespaced class' loading technique is applied to the <strong class="source-inline">Student</strong> class as well. The new <strong class="source-inline">Student\Student()</strong> namespace tells the autoloader to expect the <strong class="source-inline">Student</strong> class in the <strong class="source-inline">Student</strong> directory.</p></li>
				<li>Now, change the professor's title to <strong class="source-inline">Dr.</strong> using the corresponding setter method, as follows:<p class="source-code">$professor-&gt;setTitle('Dr.');</p></li>
				<li>Print the output by invoking the <strong class="source-inline">printStudents()</strong> method with the <strong class="source-inline">Professor</strong> object:<p class="source-code">$professor-&gt;printStudents();</p><p>Finally, the <strong class="source-inline">activity-classes.php</strong> looks like:</p><p class="source-code">&lt;?php</p><p class="source-code">spl_autoload_register();</p><p class="source-code">$professor = new Professor\Professor('Charles Kingsfield', array(</p><p class="source-code">                    new Student\Student('Elwin Ransom'),</p><p class="source-code">                    new Student\Student('Maurice Phipps'),</p><p class="source-code">                    new Student\Student('James Dunworthy'),</p><p class="source-code">                    new Student\Student('Alecto Carrow')</p><p class="source-code">            ));</p><p class="source-code">$professor-&gt;setTitle('Dr.');</p><p class="source-code">$professor-&gt;printStudents(); </p></li>
				<li>Run the PHP script using the following command:<p class="source-code">php activity-classes.php</p><p>The output should look like the following:</p><div class="IMG---Figure" id="_idContainer301"><img alt="Figure 5.30: Professor’s students list&#13;&#10;" src="image/C14196_05_30.jpg"/></div></li>
			</ol>
			<p class="figure-caption">Figure 5.30: Professor's students list</p>
			<p>We have successfully obtained a list of a professor's students using OOP techniques. In this activity, we have practiced class attributes, access modifiers, methods, class declaration, class namespacing, object instantiation, autoloading namespaced classes, type hints in parameters, and object filtration using <strong class="source-inline">instanceof</strong>, and so on.</p>
			<h1 id="_idParaDest-379"><a id="_idTextAnchor390"/>6. Using HTTP</h1>
			<h2 id="_idParaDest-380"><a id="_idTextAnchor391"/>Activity 6.1: Creating a Support Contact Form</h2>
			<p><strong class="bold">Solution</strong></p>
			<ol>
				<li value="1">The first thing that pops out is the login handling difference since we now have to authenticate random users, not just a single one. So, we will need a method to fetch the user data for the username that is being logged in. The method will return user data for the existing user (using the <strong class="source-inline">level</strong> and <strong class="source-inline">password</strong> hashes), or <strong class="source-inline">NULL</strong> if the user is not found. Since we will learn about databases in the next chapter, we will store the available user list in code, in the same way as the previous exercise:<p class="source-code-heading">Login.php</p><p class="source-code">37 private function getUserData(string $username): ?array</p><p class="source-code">38 {</p><p class="source-code">39     $users = [</p><p class="source-code">40         'vip' =&gt; [</p><p class="source-code">41             'level' =&gt; 'VIP',</p><p class="source-code">42             'password' =&gt; '$2y$10$JmCj4KVnBizmy6WS3I/bXuYM/yEI3dRg/IYkGdqHrBlOu4FKOliMa'                  // "vip" password hash</p><p class="source-code">43         ],</p><p class="source-code-link"><a href="https://packt.live/2VWoRqU">https://packt.live/2VWoRqU</a></p></li>
				<li>Then, the <strong class="source-inline">\Handlers\Login::handle()</strong> method will slightly change the way it validates the authentication and the stored data in the user session. First, if we get user data for the provided username, this means we have a valid user from our <em class="italic">database</em>, and we can proceed further. The password match is performed as usual and, if we get a match, then we can proceed by adding the username and user data in the session. In the case of any failure (such as fetching the user from the <em class="italic">database</em> or a password match), we should prepare the errors that will be displayed in the HTML form:<p class="source-code">$username = 'admin';</p><p class="source-code">$passwordHash = '$2y$10$Y09UvSz2tQCw/454Mcuzzuo8ARAjzAGGf8OPGeBloO7j47Fb2v.  lu'; // "admin" password hash</p><p class="source-code">$formError = [];</p><p class="source-code">$userData = $this-&gt;getUserData($formUsername);</p><p class="source-code">if (!$userData) {</p><p class="source-code">    $formError = ['username' =&gt; sprintf('The username [%s] was not       found.', $formUsername)];</p><p class="source-code">} elseif (!password_verify($formPassword, $userData['password'])) {</p><p class="source-code">    $formError = ['password' =&gt; 'The provided password is invalid.'];</p><p class="source-code">} else {</p><p class="source-code">    $_SESSION['username'] = $formUsername;</p><p class="source-code">    $_SESSION['userdata'] = $userData;</p><p class="source-code">    $this-&gt;requestRedirect('/profile');</p><p class="source-code">    return '';</p><p class="source-code">}</p><p class="callout-heading">Note</p><p class="callout">For convenience, generate password hash with command line <strong class="source-inline">using php -r "echo password_hash('admin', PASSWORD_BCRYPT);"</strong> command</p></li>
				<li>The login form doesn't require any changes; let's just remove the credentials hint for the <strong class="source-inline">admin</strong> user, under the <strong class="source-inline">Authenticate</strong> form title:<p class="source-code">&lt;div class="text-center mb-4"&gt;</p><p class="source-code">    &lt;h1 class="h3 mb-3 mt-5 font-weight-normal"&gt;Authenticate&lt;/h1&gt;</p><p class="source-code">&lt;/div&gt;</p></li>
				<li>Now the authentication part is covered. The user will be redirected to the <strong class="source-inline">Profile</strong> page after login, so they will have to see the layout presented previously.<p>The <strong class="source-inline">src/templates/profile.php</strong> file will have to be rebuilt from scratch. First, let's add the greetings and logout button part. While browsing Bootstrap's framework documentation, we came across alerts component, and we saw we could use this component for our current purpose:</p><p class="source-code">&lt;div class="row"&gt;</p><p class="source-code">    &lt;div class="my-5 alert alert-secondary w-100"&gt;</p><p class="source-code">        &lt;h3&gt;Welcome, &lt;?= $username ?&gt;!&lt;/h3&gt;</p><p class="source-code">        &lt;p class="mb-0"&gt;&lt;a href="/logout"&gt;Logout&lt;/a&gt;&lt;/p&gt;</p><p class="source-code">    &lt;/div&gt;</p><p class="source-code">&lt;/div&gt;</p></li>
				<li>Next, we have to add the support area, and divide it horizontally into two equal parts:<p class="source-code">&lt;div class="row"&gt;</p><p class="source-code">    &lt;div class="col-sm-6"&gt;...&lt;/div&gt;</p><p class="source-code">    &lt;div class="col-sm-6"&gt;...&lt;/div&gt;</p><p class="source-code">&lt;/div&gt;</p><p class="callout-heading">Note</p><p class="callout">To learn more about grid system in Bootstrap, please follow this link: <a href="https://packt.live/31zF72E">https://packt.live/31zF72E</a>.</p></li>
				<li>We'll use a support contact form with the following specifications: two inputs of type text, for the name and email, and a text area input for the message. Each of these will have an associated <strong class="source-inline">&lt;label&gt;</strong> element and, if there are any errors, they will have to be printed under the input with erroneous data: <p class="source-code-heading">profile.php</p><p class="source-code">15 &lt;div class="form-label-group mb-3"&gt;</p><p class="source-code">16     &lt;label for="name"&gt;Name:&lt;/label&gt;</p><p class="source-code">17     &lt;input type="text" name="name" id="name"</p><p class="source-code">18            class="form-control &lt;?= isset($formErrors['name']) ?                 'is-invalid' : ''; ?&gt;"</p><p class="source-code">19            value="&lt;?= htmlentities($_POST['name'] ?? ''); ?&gt;"&gt;</p><p class="source-code">20     &lt;?php if (isset($formErrors['name'])) {</p><p class="source-code">21         echo sprintf('&lt;div class="invalid-feedback"&gt;%s&lt;/div&gt;',              htmlentities($formErrors['name']));</p><p class="source-code">22     } ?&gt;</p><p class="source-code">23 &lt;/div&gt;</p><p class="source-code-link"><a href="https://packt.live/33NQZ2b">https://packt.live/33NQZ2b</a></p></li>
				<li>Since the standard-level user can only send the form once a day, trying to send more messages should result in an error message, which we may assign to the form level, and display it right on top of the form. Additionally, we may use the alert components again, this time using the <strong class="source-inline">danger</strong> red background: <p class="source-code">&lt;?php if (isset($formErrors['form'])) { ?&gt;</p><p class="source-code">    &lt;div class="alert alert-danger"&gt;&lt;?= $formErrors['form']; ?&gt;&lt;/div&gt;</p><p class="source-code">&lt;?php } ?&gt;</p></li>
				<li>We also need to add the CSRF token to the form, for security purposes:<p class="source-code">&lt;input type="hidden" name="csrf-token" value="&lt;?= $formCsrfToken ?&gt;"&gt;</p></li>
				<li>On the submit button, we may want to add more form data, so that we can know for sure what form we have to process in the PHP scripts; this is very useful when many forms are added on a single HTML page and each form is sending data to the same URL: <p class="source-code">&lt;button type="submit" name="do" value="get-support" class="btn btn-lg   btn-primary"&gt;Send&lt;/button&gt;</p></li>
				<li>For the message list history, we may chose the <strong class="source-inline">card</strong> component, and print each of the message details. Each history entry will contain the form data (that is, the <strong class="source-inline">form</strong> key) and time when the form was sent (that is, the <strong class="source-inline">timeAdded</strong> key):<p class="source-code">&lt;?php foreach ($sentForms as $item) { ?&gt;</p><p class="source-code">    &lt;div class="card mb-2"&gt;</p><p class="source-code">        &lt;div class="card-body"&gt;</p><p class="source-code">            &lt;h5 class="card-text"&gt;&lt;?= htmlentities($item['form']              ['message']) ?&gt;&lt;/h5&gt;</p><p class="source-code">            &lt;h6 class="card-subtitle mb-2 text-muted"&gt;</p><p class="source-code">                &lt;strong&gt;Added:&lt;/strong&gt; &lt;?=                   htmlentities($item['timeAdded']) ?&gt;&lt;/h6&gt;</p><p class="source-code">            &lt;h6 class="card-subtitle mb-2 text-muted"&gt;</p><p class="source-code">                &lt;strong&gt;Reply-to:&lt;/strong&gt; &lt;?= sprintf('%s &amp;lt;%s&amp;gt;',                   htmlentities($item['form']['name']),                   htmlentities($item['form']['email'])) ?&gt;</p><p class="source-code">            &lt;/h6&gt;</p><p class="source-code">        &lt;/div&gt;</p><p class="source-code">    &lt;/div&gt;</p><p class="source-code">&lt;?php } ?&gt;</p><p class="callout-heading">Note</p><p class="callout">The complete code in <strong class="source-inline">profile.php</strong> can be referred at: <a href="https://packt.live/2pvh0or">https://packt.live/2pvh0or</a>.</p></li>
				<li>Now that we have the layout ready, let's proceed to the processing part in the <strong class="source-inline">\Handlers\Profile</strong> handler. First, what we have to add there is the processing form in the case of a <strong class="source-inline">POST</strong> request. The <strong class="source-inline">processContactForm()</strong> will return an array of errors when the form validation fails:<p class="source-code">$formErrors = $this-&gt;processContactForm($_POST);</p></li>
				<li>If no errors are returned, it means that the form was validated and successfully saved; therefore, we can refresh the page.<p class="callout-heading">Note</p><p class="callout">It is a good practice to reload the page (perform a redirect to the same page, which will result in a <strong class="source-inline">GET HTTP</strong> request) after a successful operation due to a <strong class="source-inline">POST</strong> request, in order to avoid subsequent submissions when the page is reloaded in the browser by the user.</p><p>The code is as follows:</p><p class="source-code">if (!count($formErrors)) {</p><p class="source-code">    $this-&gt;requestRefresh();</p><p class="source-code">    return '';</p><p class="source-code">}</p></li>
				<li>The data we have to send in the template is the username (the greeting); the form errors, if any; the form CSRF token; and the sent form's history:<p class="source-code">return (new \Components\Template('profile'))-&gt;render([</p><p class="source-code">    'username' =&gt; $_SESSION['username'],</p><p class="source-code">    'formErrors' =&gt; $formErrors ?? null,</p><p class="source-code">    'sentForms' =&gt; $_SESSION['sentForms'] ?? [],</p><p class="source-code">    'formCsrfToken' =&gt; $this-&gt;getCsrfToken(),</p><p class="source-code">]);</p></li>
				<li>So far, we have referred to three methods that do not exist yet. Let's address them one by one, and start with <strong class="source-inline">getCsrfToken()</strong>. This method will return the CSRF token stored in the user session and, if it is not there, it will create and set one. To generate the token string, we can use the same approach we used in <em class="italic">Exercise 6.9,</em> <em class="italic">Securing against CSRF</em>:<p class="source-code">private function getCsrfToken(): string</p><p class="source-code">{</p><p class="source-code">    if (!isset($_SESSION['csrf-token'])) {</p><p class="source-code">        $_SESSION['csrf-token'] = bin2hex(random_bytes(32));</p><p class="source-code">    }</p><p class="source-code">    return $_SESSION['csrf-token'];</p><p class="source-code">}</p></li>
				<li>The <strong class="source-inline">processContactForm()</strong> method is returning a list of form errors, so it has to validate the data first. A call to the <strong class="source-inline">validateForm()</strong> method should return the form with sanitized data and the list of errors, if any:<p class="source-code">list($form, $errors) = $this-&gt;validateForm($data);</p></li>
				<li>If the <strong class="source-inline">$errors</strong> array is empty, then save the sanitized form data with extra information, such as the added time and added date (which is useful for checking whether standard-level users have already added one message in the current day). Again, since data persistence will be explored in the next chapter, we will use the means we have to store the data, and we will use the ephemeral session storage in this case. The forms will be stored under the <strong class="source-inline">sentForms</strong> key; therefore, <strong class="source-inline">$_SESSION['sentForms']</strong> becomes the sent form's history:<p class="source-code">$_SESSION['sentForms'][] = [</p><p class="source-code">    'dateAdded' =&gt; date('Y-m-d'),</p><p class="source-code">    'timeAdded' =&gt; date(DATE_COOKIE),</p><p class="source-code">    'form' =&gt; $form,</p><p class="source-code">];</p></li>
				<li>The <strong class="source-inline">validateForm()</strong> method will start by checking the CSRF token:<p class="source-code">if (!isset($data['csrf-token']) || $data['csrf-token'] !==   $this-&gt;getCsrfToken()) {</p><p class="source-code">    $errors['form'] = 'Invalid token, please refresh the page and try       again.';</p><p class="source-code">}</p></li>
				<li>Then, we check for multiple submissions in the case of standard-level users:<p class="source-code">if (($_SESSION['userdata']['level'] === 'STANDARD')</p><p class="source-code">    &amp;&amp; $this-&gt;hasSentFormToday($_SESSION['sentForms'] ?? [])</p><p class="source-code">) {</p><p class="source-code">    $errors['form'] = 'You are only allowed to send one form per day.';</p><p class="source-code">}</p></li>
				<li>The name validation requires a non-empty input as follows:<p class="source-code">$name = trim($data['name'] ?? '');</p><p class="source-code">if (empty($name)) {</p><p class="source-code">    $errors['name'] = 'The name cannot be empty.';</p><p class="source-code">}</p></li>
				<li>The email validation is performed using the <strong class="source-inline">filter_var()</strong> function with the <strong class="source-inline">FILTER_VALIDATE_EMAIL</strong> validation:<p class="source-code">if (empty($data['email'] ?? '')) {</p><p class="source-code">    $errors['email'] = 'The email cannot be empty.';</p><p class="source-code">} elseif (!filter_var($data['email'], FILTER_VALIDATE_EMAIL)) {</p><p class="source-code">    $errors['email'] = 'The email address is invalid.';</p><p class="source-code">}</p></li>
				<li>The message validation requires a message of at least 40 characters in length:<p class="source-code">$message = trim($data['message'] ?? '');</p><p class="source-code">if (!$message) {</p><p class="source-code">    $errors['message'] = 'The message cannot be empty.';</p><p class="source-code">}</p><p class="source-code">if (strlen($message) &lt;= 40) {</p><p class="source-code">    $errors['message'] = 'The message is too short.';</p><p class="source-code">}</p></li>
				<li>The sanitized form data is collected and stored in the <strong class="source-inline">$form</strong> variable, which is then returned with the <strong class="source-inline">$errors</strong> variable, as expected:<p class="source-code">$form = [</p><p class="source-code">    'name' =&gt; $name,</p><p class="source-code">    'email' =&gt; $data['email'],</p><p class="source-code">    'message' =&gt; $message,</p><p class="source-code">];</p><p class="source-code">return [$form, $errors];</p></li>
				<li>We referenced yet another method: <strong class="source-inline">hasSentFormToday()</strong>. This method requires the form history as the first parameter, and what it does is iterate through the history and check whether there is a message that is registered on the current day. As soon as one message is found, it will return <strong class="source-inline">TRUE</strong> immediately:<p class="source-code">private function hasSentFormToday(array $sentForms): bool</p><p class="source-code">{</p><p class="source-code">    $today = date('Y-m-d');</p><p class="source-code">    foreach ($sentForms as $sentForm) {</p><p class="source-code">        if ($sentForm['dateAdded'] === $today) {</p><p class="source-code">            return true;</p><p class="source-code">        }</p><p class="source-code">    }</p><p class="source-code">    return false;</p><p class="source-code">}</p></li>
				<li>What we have not covered yet is the <strong class="source-inline">requestRefresh()</strong> method. This method will call the <strong class="source-inline">requestRedirect()</strong> method providing the current request URI:<p class="source-code">private function requestRefresh()</p><p class="source-code">{</p><p class="source-code">    $this-&gt;requestRedirect($_SERVER['REQUEST_URI']);</p><p class="source-code">}</p><p class="callout-heading">Note</p><p class="callout">The final code in the handler Profile.php can be referred at: <a href="https://packt.live/2VREaRY">https://packt.live/2VREaRY</a>.</p></li>
				<li>Now we can test our full implementation. Access the Profile page at <strong class="source-inline">http://127.0.0.1:8080/profile</strong>:<div class="IMG---Figure" id="_idContainer302"><img alt="Figure 6.42: Authentication at the profile page&#13;&#10;" src="image/C14196_06_42.jpg"/></div><p class="figure-caption">Figure 6.42: Authentication at the profile page</p></li>
				<li>Let's log in as a standard-level user by entering <strong class="source-inline">user</strong> for both <strong class="source-inline">Username</strong> and <strong class="source-inline">Password</strong>:<div class="IMG---Figure" id="_idContainer303"><img alt="Figure 6.43: The login page&#13;&#10;" src="image/C14196_06_43.jpg"/></div><p class="figure-caption">Figure 6.43: The login page</p><p>We are redirected to the Profile page and we can see the HTML elements we have worked on so far.</p></li>
				<li>By sending an empty form, we should get all the inputs marked with errors:<div class="IMG---Figure" id="_idContainer304"><img alt="Figure 6.44: Sending an empty form&#13;&#10;" src="image/C14196_06_44.jpg"/></div><p class="figure-caption">Figure 6.44: Sending an empty form</p></li>
				<li>By entering <strong class="source-inline">invalid@email</strong> for our email, and a short sentence as a message, we should get another error, such as <strong class="source-inline">Email address is invalid</strong> or <strong class="source-inline">The message is too short</strong>:<div class="IMG---Figure" id="_idContainer305"><img alt="Figure 6.45: Messages for invalid input &#13;&#10;" src="image/C14196_06_45.jpg"/></div><p class="figure-caption">Figure 6.45: Messages for invalid input </p></li>
				<li>Sending valid data should result in a successful form-saving operation, and a listing in the Send messages list:<p>You could try this data:</p><p>Name: Luigi</p><p>Email: <strong class="source-inline">luigi@marionbros.mb</strong></p><p>Message: <strong class="source-inline">I would like to be able to upload a profile picture. Do you consider adding this feature?</strong></p><div class="IMG---Figure" id="_idContainer306"><img alt="Figure 4.46: Displaying the list of the sent messages&#13;&#10;" src="image/C14196_06_46.jpg"/></div><p class="figure-caption">Figure 4.46: Displaying the list of the sent messages</p></li>
				<li>Trying to post more messages on the same day will result in an error:<div class="IMG---Figure" id="_idContainer307"><img alt="Figure 6.47: Posting more messages results in an error &#13;&#10;" src="image/C14196_06_47.jpg"/></div><p class="figure-caption">Figure 6.47: Posting more messages results in an error </p></li>
				<li>Let's log out (to do this, click on the <strong class="source-inline">Logout</strong> button from the greeting header) and log in as a VIP-level user, using <strong class="source-inline">vip</strong> for <strong class="source-inline">Username</strong> and <strong class="source-inline">Password</strong>:<div class="IMG---Figure" id="_idContainer308"><img alt="Figure 6.48: Welcome message for a VIP user&#13;&#10;" src="image/C14196_06_48.jpg"/></div><p class="figure-caption">Figure 6.48: Welcome message for a VIP user</p></li>
				<li>Let's add the first message:<p>Name: Mario</p><p>Email: <strong class="source-inline">mario@marionbros.mb</strong></p><p>Message: <strong class="source-inline">I would like to be able to upload a profile picture. Do you consider adding this feature?</strong></p><div class="IMG---Figure" id="_idContainer309"><img alt="Figure 6.49: Adding the first message&#13;&#10;" src="image/C14196_06_49.jpg"/></div><p class="figure-caption">Figure 6.49: Adding the first message</p><p>It looks fine, as expected.</p></li>
				<li>Now, let's try to add another message; this time, we should be able to add messages without any limitations:<p>Name: Mario</p><p>Email: <strong class="source-inline">mario@marionbros.mb</strong></p><p>Message: <strong class="source-inline">Can I filter my order history by the payment method used to make the purchase?</strong></p><div class="IMG---Figure" id="_idContainer310"><img alt="Figure 6.50: The output for adding messages without limitations&#13;&#10;" src="image/C14196_06_50.jpg"/></div></li>
			</ol>
			<p class="figure-caption">Figure 6.50: The output for adding messages without limitations</p>
			<p>As you can see, we succeeded in adding another entry, as expected.</p>
			<h1 id="_idParaDest-381"><a id="_idTextAnchor392"/>7. Data Persistence</h1>
			<h2 id="_idParaDest-382"><a id="_idTextAnchor393"/>Activity 7.1: Contact Management Application</h2>
			<p><strong class="bold">Solution</strong></p>
			<p>Let's discuss the new or changed items, from the most uncoupled ones to the most complex ones.</p>
			<p>A good start here is the <strong class="source-inline">User</strong> model class since this class will be invoked on every page for authenticated users; let's put this file inside the <strong class="source-inline">src/models/</strong> directory:</p>
			<ol>
				<li value="1">Create the <strong class="source-inline">src/models/User.php</strong> file and add the following content.</li>
				<li>After declaring the namespace and imports (the <strong class="source-inline">use</strong> keyword), we define the properties of the <strong class="source-inline">User</strong> class, giving names similar to the column names of the <strong class="source-inline">users</strong> table from the database:<p class="source-code">&lt;?php </p><p class="source-code">declare(strict_types=1);</p><p class="source-code">namespace Models;</p><p class="source-code">use DateTime;</p><p class="source-code">class User</p><p class="source-code">{</p><p class="source-code">    /** @var int */</p><p class="source-code">    private $id;</p><p class="source-code">    /** @var string */</p><p class="source-code">    private $username;</p><p class="source-code">    /** @var string */</p><p class="source-code">    private $password;</p><p class="source-code">    /** @var DateTime */</p><p class="source-code">    private $signupTime;</p></li>
				<li>Add the constructor method, which requires an input array that represents a record of the <strong class="source-inline">users</strong> table, and, for each class field, fetch the appropriate value from the input array; also add the getter methods:<p class="source-code-heading">User.php</p><p class="source-code">21     public function __construct(array $input)</p><p class="source-code">22     {</p><p class="source-code">23         $this-&gt;id = (int)($input['id'] ?? 0);</p><p class="source-code">24         $this-&gt;username = (string)($input['username'] ?? '');</p><p class="source-code">25         $this-&gt;password = (string)($input['password'] ?? '');</p><p class="source-code">26         $this-&gt;signupTime = new DateTime($input['signup_time'] ?? 'now',              new \DateTimeZone('UTC'));</p><p class="source-code">27     }</p><p class="source-code">28 </p><p class="source-code">29     public function getId(): int</p><p class="source-code">30     {</p><p class="source-code">31         return $this-&gt;id;</p><p class="source-code">32     }</p><p class="source-code-link"><a href="https://packt.live/2Br0x7k">https://packt.live/2Br0x7k</a></p></li>
				<li>Finally, add the method that will perform the password match, requiring the raw input value (the value submitted with the login form):<p class="source-code">    public function passwordMatches(string $formPassword): bool</p><p class="source-code">    {</p><p class="source-code">        return password_verify($formPassword, $this-&gt;password);</p><p class="source-code">    }</p><p class="source-code">}</p><p>This class aims to be a representation of a database record from the <strong class="source-inline">users</strong> table. The <strong class="source-inline">constructor</strong> function will ensure that each field will get data of its own type. The following methods are simple getters, and the last method, <strong class="source-inline">Users::passwordMatches()</strong>, is a convenient way to validate the input passwords at login.</p><p>Since the <strong class="source-inline">User</strong> entity is strongly related to the authentication mechanism, let's see what the <strong class="source-inline">Auth</strong> component would look like. </p></li>
				<li>Create the <strong class="source-inline">src/components/Auth.php</strong> file.</li>
				<li>Declare the namespace, the imports, and add the <strong class="source-inline">userIsAuthenticated()</strong> and <strong class="source-inline">getLastLogin()</strong> methods that return information for the current session, in the <strong class="source-inline">Auth</strong> class. Add the following in the <strong class="source-inline">src/components/Auth.php</strong> file:<p class="source-code">&lt;?php declare(strict_types=1);</p><p class="source-code">namespace Components;</p><p class="source-code">use DateTime;</p><p class="source-code">use Models\User;</p><p class="source-code">class Auth</p><p class="source-code">{</p><p class="source-code">    public static function userIsAuthenticated(): bool</p><p class="source-code">    {</p><p class="source-code">        return isset($_SESSION['userid']);</p><p class="source-code">    }</p><p class="source-code">    public static function getLastLogin(): DateTime</p><p class="source-code">    {</p><p class="source-code">        return DateTime::createFromFormat('U',           (string)($_SESSION['loginTime'] ?? ''));</p><p class="source-code">    }</p></li>
				<li>Add the methods that return the <strong class="source-inline">User</strong> instance, when the user is authenticated:<p class="source-code">    public static function getUser(): ?User</p><p class="source-code">    {</p><p class="source-code">        if (self::userIsAuthenticated()) {</p><p class="source-code">            return Database::getUserById((int)$_SESSION['userid']);</p><p class="source-code">        }</p><p class="source-code">        return null;</p><p class="source-code">    }</p></li>
				<li>Add the methods that modify the session state by authenticating or de-authenticating a user:<p class="source-code">    public static function authenticate(int $id)</p><p class="source-code">    {</p><p class="source-code">        $_SESSION['userid'] = $id;</p><p class="source-code">        $_SESSION['loginTime'] = time();</p><p class="source-code">    }</p><p class="source-code">    public static function logout()</p><p class="source-code">    {</p><p class="source-code">        if (session_status() === PHP_SESSION_ACTIVE) {</p><p class="source-code">            session_regenerate_id(true);</p><p class="source-code">            session_destroy();</p><p class="source-code">        }</p><p class="source-code">    }</p><p class="source-code">}</p></li>
				<li>Create the <strong class="source-inline">src/components/Database.php</strong> file and add the following content.</li>
				<li>Add the usual namespace declaration and imports:<p class="source-code">&lt;?php declare(strict_types=1);</p><p class="source-code">namespace Components;</p><p class="source-code">use Models\User;</p><p class="source-code">use PDO;</p><p class="source-code">use PDOStatement;</p></li>
				<li>Define the <strong class="source-inline">Database</strong> class and add the <strong class="source-inline">construct</strong> method. In <strong class="source-inline">construct</strong> is where you will instantiate the <strong class="source-inline">PDO</strong> object, establishing the database connection. To reuse the <strong class="source-inline">PDO</strong> object inside the <strong class="source-inline">Database</strong> class, you set it to the <strong class="source-inline">$pdo</strong> private field of the <strong class="source-inline">Database</strong> class:<p class="source-code">class Database</p><p class="source-code">{</p><p class="source-code">    public $pdo;</p><p class="source-code">    private function __construct()</p><p class="source-code">    {</p><p class="source-code">        $dsn = "mysql:host=mysql-host;port=3306;dbname=app;charset=utf           8mb4";</p><p class="source-code">        $options = [</p><p class="source-code">            PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_ASSOC,</p><p class="source-code">        ];</p><p class="source-code">        $this-&gt;pdo = new PDO($dsn, "php-user", "php-pass", $options);</p><p class="source-code">    }</p></li>
				<li>Add the <strong class="source-inline">instance()</strong> method to return the same instance of <strong class="source-inline">Database</strong> when this method is invoked (the singleton pattern):<p class="source-code">public static function instance()</p><p class="source-code">    {</p><p class="source-code">        static $instance;</p><p class="source-code">        if (is_null($instance)) {</p><p class="source-code">            $instance = new static();</p><p class="source-code">        }</p><p class="source-code">        return $instance;</p><p class="source-code">    }</p></li>
				<li>Next, let's add <strong class="source-inline">users</strong> table-related methods, and let's start with <strong class="source-inline">addUser()</strong>; this method would require the username and the raw password as input parameters, and the return value would be the <strong class="source-inline">PDOStatement</strong> instance. Prepared statements will be used for all queries that involve user input data:<p class="source-code">public function addUser(string $username, string $password): PDOStatement</p><p class="source-code">    {</p><p class="source-code">        $stmt = $this-&gt;pdo-&gt;prepare("INSERT INTO users ('username',           'password') values (:user, :pass)");</p><p class="source-code">        $stmt-&gt;execute([</p><p class="source-code">            ':user' =&gt; $username,</p><p class="source-code">            ':pass' =&gt; password_hash($password, PASSWORD_BCRYPT),</p><p class="source-code">        ]);</p><p class="source-code">        return $stmt;</p><p class="source-code">    }</p><p class="callout-heading">Note</p><p class="callout">It is advised to return the <strong class="source-inline">PDOStatement</strong> instance in this case, instead of Boolean <strong class="source-inline">true</strong>/<strong class="source-inline">false</strong> values, which indicate whether the operation succeeded, because the former can give more info in the event of a failed operation (for example, <strong class="source-inline">PDOStatement::errorInfo()</strong>).</p></li>
				<li>Add the two methods that query for the user from the database – the <strong class="source-inline">getUserByUsername()</strong> and <strong class="source-inline">getUserById()</strong> methods. As their names suggest, one method requires a username, and the other a numerical ID. Both of them will return the <strong class="source-inline">User</strong> instance when the queried record exists, or <strong class="source-inline">null</strong> otherwise:<p class="source-code-heading">Database.php</p><p class="source-code">41     public function getUserByUsername(string $formUsername): ?User</p><p class="source-code">42     {</p><p class="source-code">43         $stmt = $this-&gt;pdo-&gt;prepare("SELECT * FROM users WHERE username =              :username");</p><p class="source-code">44         if ($stmt-&gt;execute([':username' =&gt; $formUsername]) &amp;&amp; ($data =              $stmt-&gt;fetch(PDO::FETCH_ASSOC))) {</p><p class="source-code">45             return new User($data);</p><p class="source-code">46         }</p><p class="source-code">47         return null;</p><p class="source-code">48     }</p><p class="source-code-link"><a href="https://packt.live/2pz4AMh">https://packt.live/2pz4AMh</a></p><p>Notice the <strong class="source-inline">if (stmt-&gt;execute() &amp;&amp; ($data = $stmt-&gt;fetch(PDO::FETCH_ASSOC))) { /* ... */ }</strong> expression. This is a combined expression that executes the evaluation-assignment-evaluation type of operations, and is identical to the following:</p><p class="source-code">if (stmt-&gt;execute()) { // evaluation</p><p class="source-code">  $data = $stmt-&gt;fetch(PDO::FETCH_ASSOC); // assignment</p><p class="source-code">  if ($data) { // evaluation</p><p class="source-code">   /* ... */</p><p class="source-code"> }</p><p class="source-code">}</p><p>While the latter block might look more readable, especially for beginner developers, the former expression might look cleaner, especially for seasoned developers. Both approaches are valid and, in the end, it's a matter of subjective preference.</p></li>
				<li>We are done with the <strong class="source-inline">users</strong> table; now, let's add some contact table-related queries. Add the <strong class="source-inline">getOwnContacts()</strong> method, which requires the user ID for which the contacts list is fetched. The <strong class="source-inline">PDOStatement</strong> instance will be returned in this case as well, as in the case of queries that change the state of a database (<strong class="source-inline">INSERT</strong>/<strong class="source-inline">UPDATE</strong>/<strong class="source-inline">DELETE</strong>). This approach is preferred, rather than an array of entries, because it gives a greater degree of flexibility in terms of how the data is fetched from <strong class="source-inline">PDOStatement</strong> after it is returned – as an associative array, as an instance of a class, and so on. Also, in the case of big result sets, it helps to avoid high memory usage or script failure on account of exhausted memory. Iterating over a big result set, loading, and then discarding the records from memory one at a time, is an approach that's way more friendly to memory usage than loading the entire result set in memory:<p class="source-code">    public function getOwnContacts(int $uid): PDOStatement</p><p class="source-code">    {</p><p class="source-code">        $stmt = $this-&gt;pdo-&gt;prepare("SELECT * FROM contacts WHERE user_id           = :uid");</p><p class="source-code">        $stmt-&gt;bindParam(':uid', $uid, PDO::PARAM_INT);</p><p class="source-code">        $stmt-&gt;execute();</p><p class="source-code">        return $stmt;</p><p class="source-code">    }</p></li>
				<li>Add the <strong class="source-inline">getOwnContactById()</strong> method, which is useful when one record is fetched to fill the Edit Contact form. This method requires two parameters, the user ID that owns the contact, and the contact ID. The returned value is an associative array, if the record was found, or <strong class="source-inline">null</strong> otherwise:<p class="source-code">    public function getOwnContactById(int $ownerId, int $contactId):       ?array</p><p class="source-code">    {</p><p class="source-code">        $stmt = $this-&gt;pdo-&gt;prepare("SELECT * FROM contacts WHERE           id = :cid and user_id = :uid");</p><p class="source-code">        $stmt-&gt;bindParam(':cid', $contactId, PDO::PARAM_INT);</p><p class="source-code">        $stmt-&gt;bindParam(':uid', $ownerId, PDO::PARAM_INT);</p><p class="source-code">        if ($stmt-&gt;execute() &amp;&amp; ($data = $stmt-&gt;fetch(PDO::FETCH_ASSOC)))</p><p class="source-code">        {</p><p class="source-code">            return $data;</p><p class="source-code">        }</p><p class="source-code">        return null;</p><p class="source-code">    }</p></li>
				<li>Add the <strong class="source-inline">addContact()</strong> method. This will require a list of parameters for each <strong class="source-inline">contacts</strong> table column, except the <strong class="source-inline">id</strong> column, the value of which is generated by MySQL. This method will return the <strong class="source-inline">PDOStatement</strong> instance:<p class="source-code-heading">Database.php</p><p class="source-code">79    public function addContact(</p><p class="source-code">80         int $ownerId,</p><p class="source-code">81         string $name,</p><p class="source-code">82         string $email,</p><p class="source-code">83         string $phone,</p><p class="source-code">84         string $address</p><p class="source-code">85     ): PDOStatement</p><p class="source-code">86     {</p><p class="source-code">87         $stmt = $this-&gt;pdo-&gt;prepare("INSERT INTO contacts (user_id,           'name', phone, email, address) " .</p><p class="source-code">88             "VALUES (:uid, :name, :phone, :email, :address)");</p><p class="source-code-link"><a href="https://packt.live/31rQoll">https://packt.live/31rQoll</a></p></li>
				<li>Add the <strong class="source-inline">updateContact()</strong> method. This is similar to the <strong class="source-inline">addContact()</strong> method, except for the fact that it also requires the contact ID, used to match the record to update, together with the user ID. This method will return the <strong class="source-inline">PDOStatement</strong> instance:<p class="source-code-heading">Database.php</p><p class="source-code">98     public function updateContact(</p><p class="source-code">99         int $contactId,</p><p class="source-code">100         int $ownerId,</p><p class="source-code">111         string $name,</p><p class="source-code">112         string $email,</p><p class="source-code">113         string $phone,</p><p class="source-code">114         string $address</p><p class="source-code">115     ): PDOStatement</p><p class="source-code-link"><a href="https://packt.live/31oY47W">https://packt.live/31oY47W</a></p></li>
				<li>Add the <strong class="source-inline">deleteOwnContactById()</strong> method, which requires the user ID that owns the contact, and the contact ID. The two input parameters will be used to match the record to be deleted. This method will return the <strong class="source-inline">PDOStatement</strong> instance:<p class="source-code">    public function deleteOwnContactById(int $ownerId, int $contactId):       PDOStatement</p><p class="source-code">    {</p><p class="source-code">        $stmt = $this-&gt;pdo-&gt;prepare("DELETE FROM contacts WHERE id = :cid           and user_id = :uid");</p><p class="source-code">        $stmt-&gt;bindParam(':cid', $contactId, PDO::PARAM_INT);</p><p class="source-code">        $stmt-&gt;bindParam(':uid', $ownerId, PDO::PARAM_INT);</p><p class="source-code">        $stmt-&gt;execute();</p><p class="source-code">        return $stmt;</p><p class="source-code">    }</p></li>
				<li>The <strong class="source-inline">Router</strong> component (<strong class="source-inline">src/components/Router.php</strong> file) will now cover the <strong class="source-inline">/signup</strong> and <strong class="source-inline">/contacts</strong> URIs as well. The highlighted part is the addition:<p class="source-code-heading">Router.php</p><p class="source-code">1  &lt;?php declare(strict_types=1);</p><p class="source-code">2 </p><p class="source-code">3  namespace Components;</p><p class="source-code">4 </p><p class="source-code">5  use Handlers\Contacts;</p><p class="source-code">6  use Handlers\Signup;</p><p class="source-code">7  use Handlers\Login;</p><p class="source-code">8  use Handlers\Logout;</p><p class="source-code">9  use Handlers\Profile;</p><p class="source-code">10 use Handlers\Signup;</p><p class="source-code-link"><a href="https://packt.live/2MTj4OR">https://packt.live/2MTj4OR</a></p></li>
				<li>In the case of the <strong class="source-inline">'/'</strong> route (home), a check for a currently authenticated user is performed and, in the event of a positive return, a redirect to <strong class="source-inline">/profile</strong> is requested. Otherwise, just return the <strong class="source-inline">home</strong> template:<p class="source-code-heading">Router.php</p><p class="source-code">21             case '/profile':</p><p class="source-code">22                 return new Profile();</p><p class="source-code">23             case '/login':</p><p class="source-code">24                 return new Login();</p><p class="source-code">25             case '/logout':</p><p class="source-code">26                 return new Logout();</p><p class="source-code">27             case '/':</p><p class="source-code">28                 return new class extends Handler</p><p class="source-code">29                 {</p><p class="source-code">30                     public function __invoke(): string</p><p class="source-code">31                     {</p><p class="source-code">32                         if (Auth::userIsAuthenticated()) {</p><p class="source-code">33                             $this-&gt;requestRedirect('/profile');</p><p class="source-code">34                         }</p><p class="source-code-link"><a href="https://packt.live/2BrvFn6">https://packt.live/2BrvFn6</a></p></li>
				<li>Let's check the new and modified handlers. First, let's implement the Contacts page; this is the page that lists contacts and allows new entries to be added and existing ones to be edited. Create the <strong class="source-inline">src/handlers/Contacts.php</strong> file and add the following content. Declare the <strong class="source-inline">Handlers</strong> namespace and add the imports:<p class="source-code">&lt;?php declare(strict_types=1);</p><p class="source-code">namespace Handlers;</p><p class="source-code">use Components\Auth;</p><p class="source-code">use Components\Database;</p><p class="source-code">use Components\Template;</p><p class="source-code">class Contacts extends Handler</p><p class="source-code">{</p></li>
				<li>Add the <strong class="source-inline">handle()</strong> method, and start with an authentication check. If the user is not authenticated, then the login form is displayed; otherwise, the user is fetched:<p class="source-code">    public function handle(): string</p><p class="source-code">    {</p><p class="source-code">        if (!Auth::userIsAuthenticated()) {</p><p class="source-code">            return (new Login)-&gt;handle();</p><p class="source-code">        }</p><p class="source-code">        $user = Auth::getUser();</p></li>
				<li>Initialize the <strong class="source-inline">$formError</strong> and <strong class="source-inline">$formData</strong> variables as arrays; they will be used to collect useful info, such as the form data to fill in the HTML form, or error messages:<p class="source-code">        $formError = [];</p><p class="source-code">        $formData = [];</p></li>
				<li>In the case of the <strong class="source-inline">POST</strong> HTTP method, process the form (call a separate method, to improve the readability of the current method). If no errors are returned, then redirect user to the Contacts page (refresh the page):<p class="source-code">        if ($_SERVER['REQUEST_METHOD'] === 'POST') {</p><p class="source-code">            $formError = $this-&gt;processForm();</p><p class="source-code">            if (!$formError) {</p><p class="source-code">                $this-&gt;requestRedirect('/contacts');</p><p class="source-code">                return '';</p><p class="source-code">            }</p><p class="source-code">            $formData = $_POST;</p><p class="source-code">        }</p></li>
				<li>If the <strong class="source-inline">edit</strong> entry is found in a query string, then the form data will be the record from the database – a contact will be edited. The form data is rendered on the HTML page, on the Edit Contact form:<p class="source-code">if (!empty($_GET['edit'])) {</p><p class="source-code">            $formData = Database::instance()-&gt;getOwnContactById               ($user-&gt;getId(), (int)$_GET['edit']);</p><p class="source-code">        }</p></li>
				<li>If the <strong class="source-inline">delete</strong> entry is found in a query string, then the record will be deleted and a redirect to the Contacts page (refresh page) will be performed:<p class="source-code">if (!empty($_GET['delete'])) {</p><p class="source-code">            Database::instance()-&gt;deleteOwnContactById($user-&gt;getId(),               (int)$_GET['delete']);</p><p class="source-code">            $this-&gt;requestRedirect('/contacts');</p><p class="source-code">            return '';</p><p class="source-code">        }</p></li>
				<li>In the last part of the <strong class="source-inline">handle()</strong> method, the <strong class="source-inline">contacts </strong>template (the Contacts page) will be rendered, being provided with the data from the variables defined previously, and then returned:<p class="source-code">        return (new Template('contacts'))-&gt;render([</p><p class="source-code">            'user' =&gt; $user,</p><p class="source-code">            'contacts' =&gt; Database::instance()-&gt;getOwnContacts               ($user-&gt;getId()),</p><p class="source-code">            'formError' =&gt; $formError,</p><p class="source-code">            'formData' =&gt; $formData,</p><p class="source-code">        ]);</p></li>
				<li>Implement the aforementioned <strong class="source-inline">processForm()</strong> method. In the first part, validate the input data as requested:<p class="source-code-heading">Contacts.php</p><p class="source-code">46     private function processForm(): array</p><p class="source-code">47     {</p><p class="source-code">48         $formErrors = [];</p><p class="source-code">49         if (empty($_POST['name'])) {</p><p class="source-code">50             $formErrors['name'] = 'The name is mandatory.';</p><p class="source-code">51         } elseif (strlen($_POST['name']) &lt; 2) {</p><p class="source-code">52             $formErrors['name'] = 'At least two characters are required                  for name.';</p><p class="source-code">53         }</p><p class="source-code">54         if (!filter_var($_POST['email'] ?? '', FILTER_VALIDATE_EMAIL)) {</p><p class="source-code">55             $formErrors['email'] = 'The email is invalid.';</p><p class="source-code">56         }</p><p class="source-code-link"><a href="https://packt.live/2pxEYiQ">https://packt.live/2pxEYiQ</a></p></li>
				<li>If the <strong class="source-inline">$formErrors</strong> array is empty, proceed with the contact update or insertion. To decide whether to insert a new record or to update the existing ones, the script will look for the ID parameter in the <strong class="source-inline">POST</strong> data, which will be the ID of the contact being edited. Finally, the <strong class="source-inline">$formErrors</strong> variable is returned:<p class="source-code">    if (!$formErrors) {</p><p class="source-code">        if (!empty($_POST['id']) &amp;&amp; ($contactId = (int)$_POST['id'])) {</p><p class="source-code">            Database::instance()-&gt;updateContact($contactId,               Auth::getUser()-&gt;getId(), $_POST['name'], $_POST['email'],               $_POST['phone'] ?? '', $_POST['address'] ?? '');</p><p class="source-code">        } else {</p><p class="source-code">            Database::instance()-&gt;addContact(Auth::getUser()-&gt;getId(),               $_POST['name'], $_POST['email'], $_POST['phone'] ?? '',               $_POST['address'] ?? '');</p><p class="source-code">        }</p><p class="source-code">    }</p><p class="source-code">    return $formErrors;</p><p class="source-code">}</p></li>
				<li>The Sign up page: This page is for adding new users to the database. Create the <strong class="source-inline">src/handlers/Signup.php</strong> file and add the following content. Declare the <strong class="source-inline">Handlers</strong> namespace and add the imports. Add the Sign up class with the <strong class="source-inline">handle()</strong> method. This method will check whether the user is already authenticated, in which case they will be redirected to the Profile page. In the case of <strong class="source-inline">POST</strong> requests, they will call the <strong class="source-inline">handleSignup()</strong> method to deal with the <strong class="source-inline">POST</strong> data. Finally, return the rendered <strong class="source-inline">signup-form</strong> template, providing the requisite data:<p class="source-code-heading">Signup.php</p><p class="source-code">1 &lt;?php </p><p class="source-code">2 declare(strict_types=1);</p><p class="source-code">3 </p><p class="source-code">4 namespace Handlers;</p><p class="source-code">5 </p><p class="source-code">6 use Components\Auth;</p><p class="source-code">7 use Components\Database;</p><p class="source-code">8 use Components\Template;</p><p class="source-code-link"><a href="https://packt.live/2W2TWJS">https://packt.live/2W2TWJS</a></p></li>
				<li>Add the <strong class="source-inline">handleSignup()</strong> method in order to process the sign up form data. First, validate the input data, as requested. If the validation is successful, proceed with the new record insertion and, if the query executes successfully, authenticate the new user and redirect them to the Profile page:<p class="source-code-heading">Signup.php</p><p class="source-code">32     private function handleSignup(): ?array</p><p class="source-code">33     {</p><p class="source-code">34         $formError = null;</p><p class="source-code">35         $formUsername = trim($_POST['username'] ?? '');</p><p class="source-code">36         $formPassword = trim($_POST['password'] ?? '');</p><p class="source-code">37         $formPasswordVerify = $_POST['passwordVerify'] ?? '';</p><p class="source-code">38         if (!$formUsername || strlen($formUsername) &lt; 3) {</p><p class="source-code">39             $formError = ['username' =&gt; 'Please enter an username of at                  least 3 characters.'];</p><p class="source-code">40         } elseif (!ctype_alnum($formUsername)) {</p><p class="source-code">41             $formError = ['username' =&gt; 'The username should contain only                  numbers and letters.'];</p><p class="source-code">42         } elseif (!$formPassword) {</p><p class="source-code">43             $formError = ['password' =&gt; 'Please enter a password of at                  least 6 characters.'];</p><p class="source-code">44         } elseif ($formPassword !== $formPasswordVerify) {</p><p class="source-code">45             $formError = ['passwordVerify' =&gt; 'The passwords doesn\'t                  match.'];</p><p class="source-code">46         } else {</p><p class="source-code">47             $stmt = Database::instance()                 -&gt;addUser(strtolower($formUsername), $formPassword);</p><p class="source-code-link"><a href="https://packt.live/32pPGX7">https://packt.live/32pPGX7</a></p></li>
				<li>The Profile page is a simple page that will only display some user info and the current session login time. Open the Profile page handler – <strong class="source-inline">src/handlers/Profile.php</strong> – and make sure that only the <strong class="source-inline">handle()</strong> method remains, which would only print the Profile page. In the case of unauthenticated users, it will print the login form:<p class="source-code">&lt;?php</p><p class="source-code">declare(strict_types=1);</p><p class="source-code">namespace Handlers;</p><p class="source-code">use Components\Auth;</p><p class="source-code">use Components\Template;</p><p class="source-code">class Profile extends Handler</p><p class="source-code">{</p><p class="source-code">    public function handle(): string</p><p class="source-code">    {</p><p class="source-code">        if (!Auth::userIsAuthenticated()) {</p><p class="source-code">            return (new Login)-&gt;handle();</p><p class="source-code">        }</p><p class="source-code">        return (new Template('profile'))-&gt;render();</p><p class="source-code">    }</p><p class="source-code">}</p></li>
				<li>The Logout page: This page logs the user out. Open the <strong class="source-inline">src/handlers/Logout.php</strong> file and make sure to use the <strong class="source-inline">Auth</strong> component to log the user out:<p class="source-code">&lt;?php</p><p class="source-code">declare(strict_types=1);</p><p class="source-code">namespace Handlers;</p><p class="source-code">use Components\Auth;</p><p class="source-code">class Logout extends Handler</p><p class="source-code">{</p><p class="source-code">    public function handle(): string</p><p class="source-code">    {</p><p class="source-code">        Auth::logout();</p><p class="source-code">        $this-&gt;requestRedirect('/');</p><p class="source-code">        return '';</p><p class="source-code">    }</p><p class="source-code">}</p></li>
				<li>Login page: This page authenticates the username and password. Open the <strong class="source-inline">src/handlers/Login.php</strong> file and make sure that the necessary adjustments are performed. The <strong class="source-inline">Handlers\Login::handle()</strong> method will redirect the authenticated users to the Profile page as well. Otherwise, it will perform the same flow as in the previous activity but will evaluate the data differently in each step. That's because it now uses the database as a source of data and the User model with a dedicated method to perform password validation (the differences are highlighted). So, in the case of a <strong class="source-inline">POST</strong> request, first, it retrieves the user from the database by calling <strong class="source-inline">Database::getUserByUsername()</strong> and then evaluates them (the <strong class="source-inline">$user</strong> value can be the <strong class="source-inline">User</strong> object or null). If no user was found and returned, an error message is set in the <strong class="source-inline">$formError</strong> variable. The next step is to validate the login password and, in the event of an error, to set the error message in the <strong class="source-inline">$formError</strong> variable. In the end, if all checkpoints have been passed, the authentication is made by calling the <strong class="source-inline">Auth::authenticate()</strong> method, and then redirecting to the Profile page. If the request was not of the <strong class="source-inline">POST</strong> type, or there was an error with the username or password, the login form template (Login page) is rendered and returned:<p class="source-code-heading">Login.php</p><p class="source-code">1  &lt;?php</p><p class="source-code">2  declare(strict_types=1);</p><p class="source-code">3 </p><p class="source-code">4  namespace Handlers;</p><p class="source-code">5 </p><p class="source-code">6  use Components\Auth;</p><p class="source-code">7  use Components\Database;</p><p class="source-code">8  use Components\Template;</p><p class="source-code">9 </p><p class="source-code">10 class Login extends Handler</p><p class="source-code">11 {</p><p class="source-code">12     public function handle(): string</p><p class="source-code">13     {</p><p class="source-code">14         if (Auth::userIsAuthenticated()) {</p><p class="source-code">15             $this-&gt;requestRedirect('/profile');</p><p class="source-code">16             return '';</p><p class="source-code">17         }</p><p class="source-code-link"><a href="https://packt.live/2JjzX4z">https://packt.live/2JjzX4z</a></p></li>
				<li>The entry point of the application (<strong class="source-inline">web/index.php</strong>) does not change the logic; it will just require the new script files (highlighted rows):<p class="source-code-heading">index.php</p><p class="source-code">1  &lt;?php</p><p class="source-code">2  declare(strict_types=1);</p><p class="source-code">3 </p><p class="source-code">4  use Components\Router;</p><p class="source-code">5  use Components\Template;</p><p class="source-code">6 </p><p class="source-code">7  const WWW_PATH = __DIR__;</p><p class="source-code">8  </p><p class="source-code">9  require_once __DIR__ . '/../src/components/Auth.php';</p><p class="source-code">10 require_once __DIR__ . '/../src/components/Database.php';</p><p class="source-code">11 require_once __DIR__ . '/../src/components/Template.php';</p><p class="source-code">12 require_once __DIR__ . '/../src/components/Router.php';</p><p class="source-code">13 require_once __DIR__ . '/../src/handlers/Handler.php';</p><p class="source-code">14 require_once __DIR__ . '/../src/handlers/Login.php';</p><p class="source-code">15 require_once __DIR__ . '/../src/handlers/Logout.php';</p><p class="source-code-link"><a href="https://packt.live/2P1f7ud">https://packt.live/2P1f7ud</a></p><p>Now to the templates – let's see what has changed.</p></li>
				<li>Firstly, the <strong class="source-inline">main</strong> template – the <strong class="source-inline">src/templates/main.php</strong> file. The changes are highlighted and commented on further. The <strong class="source-inline">navbar</strong> has changed to Contacts list. As requested, the navbar links are Username (link to the Profile page), Contacts, and Logout for an authenticated user, and Login for an unauthenticated user. The default content is now replaced by the <strong class="source-inline">home</strong> template:<p class="source-code-heading">main.php</p><p class="source-code">1 &lt;?php use Components\Auth; ?&gt;</p><p class="source-code">2 &lt;!doctype html&gt;</p><p class="source-code">3 &lt;html lang="en"&gt;</p><p class="source-code">4 &lt;head&gt;</p><p class="source-code">5     &lt;meta charset="utf-8"&gt;</p><p class="source-code">6     &lt;meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"&gt;</p><p class="source-code">8     &lt;title&gt;&lt;?= ($title ?? '(no title)') ?&gt;&lt;/title&gt;</p><p class="source-code-link"><a href="https://packt.live/2VU7zuG">https://packt.live/2VU7zuG</a></p></li>
				<li>Now, the <strong class="source-inline">home</strong> template – the <strong class="source-inline">src/templates/home.php</strong> file. This template prints two links – Sign up and Login, as requested:<p class="source-code">&lt;div class="jumbotron"&gt;</p><p class="source-code">    &lt;h1 class="display-4"&gt;Hello!&lt;/h1&gt;</p><p class="source-code">    &lt;p class="lead"&gt;&lt;a href="/signup"&gt;Sign up&lt;/a&gt; to start creating your       contacts list.&lt;/p&gt;</p><p class="source-code">    &lt;p class="lead"&gt;Already have an account? &lt;a href="/login"&gt;Login here&lt;/a&gt;.&lt;/p&gt;</p><p class="source-code">&lt;/div&gt;</p></li>
				<li>Now, the <strong class="source-inline">login-form</strong> template – the <strong class="source-inline">src/templates/login-form.php</strong> file. In this template, only the link to the "sign up" page (highlighted) was added:<p class="source-code-heading">login-form.php</p><p class="source-code">1 &lt;?php</p><p class="source-code">2 /** @var array $formError */</p><p class="source-code">3 /** @var string $formUsername */</p><p class="source-code">4 ?&gt;</p><p class="source-code">5 &lt;div class="d-flex justify-content-center"&gt;</p><p class="source-code">6     &lt;form action="/login" method="post" style="width: 100%; max-width: 420px;"&gt;</p><p class="source-code">7         &lt;div class="text-center mb-4"&gt;</p><p class="source-code">8             &lt;h1 class="h3 mb-3 mt-5 font-weight-normal"&gt;Authenticate&lt;/h1&gt;</p><p class="source-code">9         &lt;/div&gt;</p><p class="source-code-link"><a href="https://packt.live/2MYqXTr">https://packt.live/2MYqXTr</a></p></li>
				<li>Now, the <strong class="source-inline">signup-form</strong> template—the <strong class="source-inline">src/templates/signup-form.php</strong> file. This template is similar to the <strong class="source-inline">login</strong> template. The only differences are the form action (<strong class="source-inline">/signup</strong>), header title (<strong class="source-inline">Sign up</strong>), the extra input (<strong class="source-inline">Password verify</strong>), and the fact that the link points to the Login page:<p class="source-code-heading">signup-form.php</p><p class="source-code">1 &lt;?php</p><p class="source-code">2 /** @var array $formError */</p><p class="source-code">3 /** @var string $formUsername */</p><p class="source-code">4 ?&gt;</p><p class="source-code">5 &lt;div class="d-flex justify-content-center"&gt;</p><p class="source-code">6     &lt;form action="/signup" method="post" style="width: 100%; max-width: 420px;"&gt;</p><p class="source-code">7         &lt;div class="text-center mb-4"&gt;</p><p class="source-code">8             &lt;h1 class="h3 mb-3 mt-5 font-weight-normal"&gt;Sign up&lt;/h1&gt;</p><p class="source-code">9         &lt;/div&gt;</p><p class="source-code-link"><a href="https://packt.live/2MXzeXo">https://packt.live/2MXzeXo</a></p></li>
				<li>Now, the <strong class="source-inline">profile</strong> template – the <strong class="source-inline">src/templates/profile.php</strong> file. The Profile page template looks totally different to the one in the previous activity. Now, it simply outputs a welcoming message and some minimal user information: username, signup date, and session login time:<p class="source-code-heading">profile.php</p><p class="source-code">1  &lt;?php</p><p class="source-code">2 </p><p class="source-code">3  use Components\Auth;</p><p class="source-code">4 </p><p class="source-code">5  $user = Auth::getUser();</p><p class="source-code">6  ?&gt;</p><p class="source-code">7 </p><p class="source-code">8  &lt;section class="my-5"&gt;</p><p class="source-code">9      &lt;h3&gt;Welcome, &lt;?= $user-&gt;getUsername() ?&gt;!&lt;/h3&gt;</p><p class="source-code">10 &lt;/section&gt;</p><p class="source-code-link"><a href="https://packt.live/2BmQRL0">https://packt.live/2BmQRL0</a></p></li>
				<li>Now, the <strong class="source-inline">contacts</strong> template, the contacts list – the <strong class="source-inline">src/templates/contacts.php</strong> file (the first part). The Contacts page template has two major areas: the contacts list, on the one hand, and the contacts form (with add/edit actions), on the other. Before rendering the contacts list, <strong class="source-inline">PDOStatement</strong> (stored in the <strong class="source-inline">$contacts</strong> variable) is "asked" about the number of rows and, if there are no rows, then the message <strong class="source-inline">No contacts</strong> is printed. If the row count returns at least one, then the table is printed, iterating over the results of <strong class="source-inline">$contacts</strong>, using the <strong class="source-inline">while</strong> loop. The <strong class="source-inline">Edit</strong> and <strong class="source-inline">Delete</strong> buttons are also printed for every contact. For the <strong class="source-inline">Delete</strong> button, a confirmation dialog is used, utilizing the <strong class="source-inline">onclick</strong> tag attribute and the <strong class="source-inline">confirm()</strong> JavaScript function:<p class="source-code-heading">contacts.php</p><p class="source-code">1 &lt;?php</p><p class="source-code">2 /** @var \PDOStatement $contacts */</p><p class="source-code">3 /** @var array $formError */</p><p class="source-code">4 /** @var array $formData */</p><p class="source-code">5 ?&gt;</p><p class="source-code">6 &lt;section class="my-5"&gt;</p><p class="source-code">7     &lt;h3&gt;Contacts&lt;/h3&gt;</p><p class="source-code">8 &lt;/section&gt;</p><p class="source-code-link"><a href="https://packt.live/2pDdjwF">https://packt.live/2pDdjwF</a></p></li>
				<li>Now, the <strong class="source-inline">contacts</strong> template, the edit form – the <strong class="source-inline">src/templates/contacts.php</strong> file (the second part). The contacts add/edit form features four visible inputs (<strong class="source-inline">name</strong>, <strong class="source-inline">email</strong>, <strong class="source-inline">phone</strong>, and <strong class="source-inline">address</strong>), one hidden input (contact ID when editing, 0 otherwise), and the <strong class="source-inline">Save</strong> button:</li>
			</ol>
			<p class="source-code-heading">cont<a id="_idTextAnchor394"/>acts.php</p>
			<p class="source-code">33 &lt;div class="col-12 col-lg-4"&gt;</p>
			<p class="source-code">34         &lt;h4 class="mb-3"&gt;Add contact:&lt;/h4&gt;</p>
			<p class="source-code">35         &lt;form method="post"&gt;</p>
			<p class="source-code">36             &lt;div class="form-row"&gt;</p>
			<p class="source-code">37                 &lt;div class="form-group col-6"&gt;</p>
			<p class="source-code">38                     &lt;label for="contactName"&gt;Name&lt;/label&gt;</p>
			<p class="source-code">39                     &lt;input type="text" class="form-control &lt;?=                          isset($formError['name']) ? 'is-invalid' : ''; ?&gt;"</p>
			<p class="source-code">40                            id="contactName" placeholder="Enter name"                                 name="name"</p>
			<p class="source-code">41                            value="&lt;?= htmlentities($formData['name'] ??                                 '') ?&gt;"&gt;</p>
			<p class="source-code-link"><a href="https://packt.live/2VU7UgW">https://packt.live/2VU7UgW</a></p>
			<p>Thus, we have created a contact management system based on the concepts covered so far in the chapter.</p>
			<h1 id="_idParaDest-383"><a id="_idTextAnchor395"/>8. Error Handling</h1>
			<h2 id="_idParaDest-384"><a id="_idTextAnchor396"/>Activity 8.1: Improving the User Experience through the Handling System and User-Level Errors </h2>
			<p><strong class="bold">Solution</strong></p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">factorial.php</strong>.</li>
				<li>First, add the exception handler that, in order to log the exceptions to the log file, will create a data stream resource using the <strong class="source-inline">fopen()</strong> function, which is assigned to the static variable, <strong class="source-inline">$fh</strong>:<p class="source-code">$exceptionHandler = function (Throwable $e) {</p><p class="source-code">    static $fh;</p><p class="source-code">    if (is_null($fh)) {</p><p class="source-code">        $fh = fopen(__DIR__ . '/app.log', 'a');</p><p class="source-code">        if (!$fh) {</p><p class="source-code">            echo 'Unable to access the log file.', PHP_EOL;</p><p class="source-code">            exit(1);</p><p class="source-code">        }</p><p class="source-code">    }</p></li>
				<li>Format the log message and write to the log file, using the <strong class="source-inline">fwrite()</strong> function:<p class="source-code">    $message = sprintf('%s [%d]: %s', get_class($e), $e-&gt;getCode(),       $e-&gt;getMessage());</p><p class="source-code">    $msgLength = mb_strlen($message);</p><p class="source-code">    $line = str_repeat('-', $msgLength);</p><p class="source-code">    $logMessage = sprintf(</p><p class="source-code">        "%s\n%s\n&gt; File: %s\n&gt; Line: %d\n&gt; Trace: %s\n%s\n",</p><p class="source-code">        $line,</p><p class="source-code">        $message,</p><p class="source-code">        $e-&gt;getFile(),</p><p class="source-code">        $e-&gt;getLine(),</p><p class="source-code">        $e-&gt;getTraceAsString(),</p><p class="source-code">        $line</p><p class="source-code">    );</p><p class="source-code">    fwrite($fh, $logMessage);</p><p class="source-code">};</p></li>
				<li>Define the error handler, which will translate the errors to exceptions and forward these to the exception handler. This error handler is meant to collect all the system errors reported, which are required to be handled as an exception (to log to a file, in a specific format, in our case):<p class="source-code">$errorHandler = function (int $code, string $message, string $file,   int $line) use ($exceptionHandler) {</p><p class="source-code">    $exception = new ErrorException($message, $code, $code, $file, $line);</p><p class="source-code">    $exceptionHandler($exception);</p><p class="source-code">    if (in_array($code, [E_ERROR, E_RECOVERABLE_ERROR, E_USER_ERROR])) {</p><p class="source-code">        exit(1);</p><p class="source-code">    }</p><p class="source-code">};</p></li>
				<li>Register both handlers, using <strong class="source-inline">set_error_handler()</strong> and <strong class="source-inline">set_exception_handler()</strong>:<p class="source-code">set_error_handler($errorHandler);</p><p class="source-code">set_exception_handler($exceptionHandler);</p></li>
				<li>Create a list of custom exceptions, one for each validation rule:<p class="source-code">class NotANumber extends Exception {}</p><p class="source-code">class DecimalNumber extends Exception {}</p><p class="source-code">class NumberIsZeroOrNegative extends Exception {}</p></li>
				<li>Create the <strong class="source-inline">printError()</strong> function, which will prepend <strong class="source-inline">(!)</strong> to the input message:<p class="source-code">function printError(string $message): void</p><p class="source-code">{</p><p class="source-code">    echo '(!) ', $message, PHP_EOL;</p><p class="source-code">}</p></li>
				<li>Create the <strong class="source-inline">calculateFactorial()</strong> function, which will initially validate the input argument. If any validation fails, an appropriate exception will be thrown, including a detailed message regarding the validation failure:<p class="source-code">function calculateFactorial($number): int</p><p class="source-code">{</p><p class="source-code">    if (!is_numeric($number)) {</p><p class="source-code">        throw new NotANumber(sprintf('%s is not a number.', $number));</p><p class="source-code">    }</p><p class="source-code">    $number = $number * 1;</p><p class="source-code">    if (is_float($number)) {</p><p class="source-code">        throw new DecimalNumber(sprintf('%s is decimal; integer is           expected.', $number));</p><p class="source-code">    }</p><p class="source-code">    if ($number &lt; 1) {</p><p class="source-code">        throw new NumberIsZeroOrNegative(sprintf('Given %d while higher           than zero is expected.', $number));</p><p class="source-code">    }</p><p>We use <strong class="source-inline">is_numeric()</strong> to check whether the input is an integer or a numeric string and throw a <strong class="source-inline">NotANumber</strong> exception if the validation fails. Then, we validate whether the input is a decimal number since we only want to allow integers. To achieve this, we have to "convert" the potential string numeral to one of integers or float types, and therefore we multiply the number with the numeric <strong class="source-inline">1</strong> so that PHP will convert the input automatically for us. Another way of checking whether we are dealing with decimals is to look for decimal separators in the input, using the built-in <strong class="source-inline">strpos()</strong> function. In the case of a decimal value, we throw a <strong class="source-inline">DecimalNumber</strong> exception. Then, if the input number is lower than <strong class="source-inline">1</strong>, we throw a <strong class="source-inline">NumberIsZeroOrNegative</strong> exception. At this step, validation ends, and we can proceed with the computation.</p></li>
				<li>Once validation is complete, proceed to the factorial number calculation, and then return it:<p class="source-code">    $factorial = 1;</p><p class="source-code">    for ($i = 2; $i &lt;= $number; $i++) {</p><p class="source-code">        $factorial *= $i;</p><p class="source-code">    }</p><p class="source-code">    return $factorial;</p><p class="source-code">}</p><p>A <strong class="source-inline">for</strong> loop is used to multiplicate the <strong class="source-inline">$factorial</strong> variable through its iterations until <strong class="source-inline">$i</strong> reaches the <strong class="source-inline">$number</strong> input value provided.</p><p class="callout-heading">Note </p><p class="callout">We use the <strong class="source-inline">$factorial *= $i;</strong> notation, which is equivalent to the more verbose one—<strong class="source-inline">$factorial = $factorial * $i;</strong></p></li>
				<li>Consider input arguments starting with the second element, since the first one is the script name. If no input arguments are provided, then print the error message asking for an input argument:<p class="source-code">$arguments = array_slice($argv, 1);</p><p class="source-code">if (!count($arguments)) {</p><p class="source-code">    printError('At least one number is required.');</p></li>
				<li>Otherwise, iterate through the input arguments and invoke the <strong class="source-inline">calculateFactorial()</strong> function, the result of which will be printed:<p class="source-code">} else {</p><p class="source-code">    foreach ($arguments as $argument) {</p><p class="source-code">        try {</p><p class="source-code">            $factorial = calculateFactorial($argument);</p><p class="source-code">            echo $argument, '! = ', $factorial, PHP_EOL;</p><p>The <strong class="source-inline">calculateFactorial()</strong> function is wrapped in a <strong class="source-inline">try</strong> block since we are expecting an exception to be thrown, which we want to catch eventually. Remember that we have to display an output value for each input argument, so, in the event of errors for one argument, we want to be able to continue to advance the script to the next argument.</p></li>
				<li>Catch any of the custom exceptions defined previously and print the error message:<p class="source-code">        } catch (NotANumber | DecimalNumber | NumberIsZeroOrNegative $e) {</p><p class="source-code">            printError(sprintf('[%s]: %s', get_class($e),               $e-&gt;getMessage()));</p></li>
				<li>Catch any other exception and send this to the exception handler to log to a file and print a generic error message that will highlight the current argument for which the unexpected exception was thrown:<p class="source-code">        } catch (Throwable $e) {</p><p class="source-code">            printError("Unexpected error occured for [$argument]               input number.");</p><p class="source-code">            $exceptionHandler($e);</p><p class="source-code">        }</p><p class="source-code">    }</p><p class="source-code">}</p></li>
				<li>Execute the following command:<p class="source-code">php factorial.php; </p><p>The output is as follows:</p><div class="IMG---Figure" id="_idContainer311"><img alt="Figure 8.38: Executing the script without an argument&#13;&#10;" src="image/C14196_08_38.jpg"/></div><p class="figure-caption">Figure 8.38: Executing the script without an argument</p><p>Since no arguments were passed to the script, the appropriate error message is printed on the screen.</p></li>
				<li>Run the script with <strong class="source-inline">php factorial.php 1 2 3 20 21 -1 4.2 4th four</strong>; expect the following output:</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer312">
					<img alt="Figure 8.39: Printing a factorial for integer values&#13;&#10;" src="image/C14196_08_39.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.39: Printing a factorial for integer values</p>
			<p>In this case, a list of arguments was provided, starting with <strong class="source-inline">1</strong> and ending in <strong class="source-inline">four</strong>. As expected, for each argument, a new line is printed, containing either the response or the error. An interesting line here is the one for the argument <strong class="source-inline">21</strong>, for which we got an <strong class="source-inline">Unexpected error</strong> message, without giving many details. We should look in the log file to see some relevant data: </p>
			<div>
				<div class="IMG---Figure" id="_idContainer313">
					<img alt="Figure 8.40: Data for the input value “21”&#13;&#10;" src="image/C14196_08_40.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.40: Data for the input value "21"</p>
			<p>The complaint here concerns a <strong class="source-inline">float</strong> type being returned by the <strong class="source-inline">calculateFactorial()</strong> function, while <strong class="source-inline">int</strong> is expected. That's because the resulting factorial number for <strong class="source-inline">21</strong> (<strong class="source-inline">51090942171709440000</strong>) is higher than the maximum integer the PHP engine can handle (<strong class="source-inline">php -r 'echo PHP_INT_MAX;'</strong> would output 9223372036854775807), and so is converted to a float type and is presented in scientific notation (5.1090942171709E+19). Since the <strong class="source-inline">calculateFactorial()</strong> function has declared <strong class="source-inline">int</strong> as a return type, the returned float type value has caused a <strong class="source-inline">TypeError</strong>, and now we may decide to apply an extra condition to input arguments, limiting the maximum number to <strong class="source-inline">20</strong>, throwing a custom exception when the number is higher, or to check the type of factorial in <strong class="source-inline">calculateFactorial()</strong> before the value is returned, and throw a custom exception as well.</p>
			<p>In this activity, you managed to improve the user experience by printing pretty messages to user output, even for unexpected errors. Also, in the case of unexpected errors, the messages were logged to a log file so that the developer could check on them and, based on that data, reproduce the issue, and then come up with a fix or an improved solution for the script.</p>
			<h1 id="_idParaDest-385"><a id="_idTextAnchor397"/>9. Composer</h1>
			<h2 id="_idParaDest-386"><a id="_idTextAnchor398"/>Activity 9.1: Implementing a Package to Generate a UUID</h2>
			<p><strong class="bold">Solution</strong></p>
			<ol>
				<li value="1">Run the following command:<p class="source-code">composer require ramsey/uuid</p><p>The output is as follows:</p><div class="IMG---Figure" id="_idContainer314"><img alt="Figure 9.17: Requiring the packages&#13;&#10;" src="image/C14196_09_17.jpg"/></div><p class="figure-caption">Figure 9.17: Requiring the packages</p></li>
				<li>List the packages in your vendor directory using the following command:<p class="source-code">ls -lart vendor</p><p>The output is as follows:</p><div class="IMG---Figure" id="_idContainer315"><img alt="Figure 9.18: Listing the packages&#13;&#10;" src="image/C14196_09_18.jpg"/></div><p class="figure-caption">Figure 9.18: Listing the packages</p></li>
				<li>Edit <strong class="source-inline">Example.php</strong> to add a <strong class="source-inline">use ramsey/uuid/uuid</strong> statement, and add a method similar to <strong class="source-inline">printUuid()</strong> as follows:<p class="source-code-heading">Example.php</p><p class="source-code">1  &lt;?php</p><p class="source-code">2 </p><p class="source-code">3  namespace Packt;</p><p class="source-code">4 </p><p class="source-code">5  use Monolog\Logger;</p><p class="source-code">6  use Ramsey\Uuid\Uuid;</p><p class="source-code">7 </p><p class="source-code">8  class Example</p><p class="source-code">9  {</p><p class="source-code">10     protected $logger;</p><p class="source-code">11     public function __construct(Logger $logger)</p><p class="source-code">12     {</p><p class="source-code">13         $this-&gt;logger = $logger;</p><p class="source-code">14     }</p><p class="source-code-link"><a href="https://packt.live/33Hk6Ev">https://packt.live/33Hk6Ev</a></p></li>
				<li>Edit your <strong class="source-inline">index.php</strong> file to add the call to <strong class="source-inline">printUuid()</strong>:<p class="source-code">&lt;?php</p><p class="source-code">require 'vendor/autoload.php';</p><p class="source-code">use Monolog\Logger;</p><p class="source-code">use Monolog\Handler\StreamHandler;</p><p class="source-code">use Packt\Example;</p><p class="source-code">$logger = new Logger('application_log');</p><p class="source-code">$logger-&gt;pushHandler(new StreamHandler('.logs/app.log', Logger::INFO));</p><p class="source-code">$e = new Example($logger);</p><p class="source-code">$e-&gt;doSomething();</p><p class="source-code">$e-&gt;printUuid();</p></li>
				<li>Run <strong class="source-inline">php index.php</strong>. The UUID generated will be different to the one in the screenshot, but should follow a similar format:</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer316">
					<img alt="Figure 9.19: Printing the UUID&#13;&#10;" src="image/C14196_09_19.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.19: Printing the UUID</p>
			<h1 id="_idParaDest-387"><a id="_idTextAnchor399"/>10. Web Services</h1>
			<h2 id="_idParaDest-388"><a id="_idTextAnchor400"/>Activity 10.1: Making Your Own POST Request to httpbin.org</h2>
			<p><strong class="bold">Solution</strong></p>
			<ol>
				<li value="1">Create a <strong class="source-inline">httpbin.php</strong> file in the <strong class="source-inline">guzzle-example</strong> directory. Require the Composer autoload file and import the <strong class="source-inline">Guzzle Client</strong> class:<p class="source-code">&lt;?php</p><p class="source-code">require 'vendor/autoload.php';</p><p class="source-code">use GuzzleHttp\Client;</p></li>
				<li>Instantiate a new <strong class="source-inline">Guzzle Client</strong> by passing the <strong class="source-inline">httpbin</strong> address:<p class="source-code">$client = new Client(['base_uri'=&gt;'http://httpbin.org/']);</p></li>
				<li>Inside a <strong class="source-inline">try</strong>…<strong class="source-inline">catch</strong> block, make a <strong class="source-inline">POST</strong> request to the <strong class="source-inline">/response-headers</strong> endpoint. Add an <strong class="source-inline">Accept</strong> header set to <strong class="source-inline">application/json</strong> and set two query parameter key-value pairs, with <strong class="source-inline">first</strong> as <strong class="source-inline">John</strong> and <strong class="source-inline">last</strong> as <strong class="source-inline">Doe</strong>:<p class="source-code">try</p><p class="source-code">{</p><p class="source-code">    $response=$client-&gt;request('POST', '/response-headers',[</p><p class="source-code">        'headers'=&gt;[</p><p class="source-code">            'Accept'=&gt;'application-json'</p><p class="source-code">        ]</p><p class="source-code">        'query'=&gt; [</p><p class="source-code">            'first'=&gt;'John',</p><p class="source-code">            'last'=&gt;'Doe'</p><p class="source-code">        ]</p><p class="source-code">    ]);</p></li>
				<li>Check whether the HTTP status code is not 200, and if so, throw an exception:<p class="source-code">    if ($response-&gt;getStatusCode()!==200){</p><p class="source-code">        throw new Exception("Status code was {$response-&gt;getStatusCode()},           not 200");</p><p class="source-code">    }</p></li>
				<li>Parse the response body into an object using <strong class="source-inline">json_decode()</strong> and store it in a variable:<p class="source-code">    $responseObject=json_decode($response-&gt;getBody()-&gt;getContents());</p></li>
				<li>Output a string, <strong class="source-inline">The web service responded with</strong>, concatenated with the first and last properties from the response object:<p class="source-code">    echo "The web service responded with {$responseObject-&gt;first}       {$responseObject-&gt;last}".PHP_EOL;</p><p class="source-code">}</p><p class="source-code">catch(Exception $ex)</p><p class="source-code">{</p><p class="source-code">    echo "An error occurred: ".$ex-&gt;getMessage().PHP_EOL;</p><p class="source-code">}</p></li>
				<li>Run the script and see whether the output contains <strong class="source-inline">John Doe</strong>:</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer317">
					<img alt="Figure 10.13: The output of the script" src="image/C14196_10_13.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.13: The output of the script</p>
		</div>
	</body></html>