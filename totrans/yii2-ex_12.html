<html><head></head><body><div class="chapter" title="Chapter&#xA0;12.&#xA0;Create a Console Application to Automate the Periodic Task"><div class="titlepage"><div><div><h1 class="title"><a id="ch12"/>Chapter 12. Create a Console Application to Automate the Periodic Task</h1></div></div></div><p>In this chapter, we will learn how to write a console application and will discover the main differences between web and console apps.</p><p>Then, we will create our first console controller, using a practical example to illustrate how to update a database table.</p><p>In the final paragraphs, we will see how to set output colors and text formats and how to implement a complete periodic task, such as sending an e-mail with daily reservations. We will cover the following topics in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Interacting with console applications</li><li class="listitem" style="list-style-type: disc">Creating a console controller<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Example – setting an alarm flag for expired reservation </li></ul></div></li><li class="listitem" style="list-style-type: disc">Formatting the output from the console</li><li class="listitem" style="list-style-type: disc">Implementing and executing cron jobs<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Example – sending an e-mail with new reservations of the day</li></ul></div></li></ul></div><div class="section" title="Interacting with console applications"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec81"/>Interacting with console applications</h1></div></div></div><p>The console is the <a id="id526" class="indexterm"/>third application installed by default with the advanced template.</p><p>This app is configured to launch commands through a console access, and it has the same application structure of those already seen in the previous chapters. Therefore, in this section, we require a console access to the host.</p><p>Compared to the web and API applications used until now, there are some differences.</p><p>The <code class="literal">public</code> properties of a controller, in fact, are visible from the command line as <code class="literal">option</code>. It is required to extend the <code class="literal">option()</code> method of the controller to make those properties available. Also, based on specific action, action parameters are passed as arguments of the command line.</p><p>Finally, a console controller action can return an exit code, a number where 0 indicates that everything is OK, a best practice for console application development.</p><p>Here is a typical usage of the console application starting from a shell:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>yii &lt;route&gt; [--option1=value1 --option2=value2 ... argument1 argument2 ...]</strong></span>
</pre></div><p>The elements of the <a id="id527" class="indexterm"/>preceding code are explained as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">route</code>: This indicates the <code class="literal">controller/action</code> path to be called</li><li class="listitem" style="list-style-type: disc"><code class="literal">option</code>: This indicates the accessible <code class="literal">public</code> properties of the controller for that specific action; we can access only the public properties returned by the <code class="literal">options()</code> method of the controller</li><li class="listitem" style="list-style-type: disc"><code class="literal">argument</code>: This indicates the arguments to be passed to the controller action<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note74"/>Note</h3><p>There is an option always available, <code class="literal">appconfig</code>, to indicate which path of the configuration files you must use. If it is not set, the default configuration file will be adopted.</p></div></div></li></ul></div><p>Yii provides a set of core console applications, which we can access by calling the <code class="literal">help</code> controller (being a web application, the default action will be <code class="literal">index</code>), so as to display everything concerning the list of available console controllers or details about a single controller or action controller.</p><p>Let's consider an example; open the command line (in this case, a Linux shell) and type the following from the project root:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./yii help</strong></span>
</pre></div><p>This will display an output similar to the following (partially displayed):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>This is Yii version 2.0.4.</strong></span>

<span class="strong"><strong>The following commands are available:</strong></span>

<span class="strong"><strong>- asset                         Allows you to combine and compress your JavaScript and CSS files.</strong></span>
<span class="strong"><strong>    asset/compress (default)    Combines and compresses the asset files according to the given configuration.</strong></span>
<span class="strong"><strong>    asset/template              Creates template of configuration file for [[actionCompress]].</strong></span>

<span class="strong"><strong>- cache                         Allows you to flush cache.</strong></span>
<span class="strong"><strong>    cache/flush                 Flushes given cache components.</strong></span>
<span class="strong"><strong>    cache/flush-all             Flushes all caches registered in the system.</strong></span>
<span class="strong"><strong>    cache/flush-schema          Clears DB schema cache for a given connection component.</strong></span>
<span class="strong"><strong>    cache/index (default)       Lists the caches that can be flushed.</strong></span>
<span class="strong"><strong>…</strong></span>
<span class="strong"><strong>…</strong></span>
</pre></div><p>Here, the first <a id="id528" class="indexterm"/>grouping level represents the controller names (with relative descriptions on the right), and the second level includes the actions of the relative controller. We will require a more deep response when passing the name of controller to help it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./yii help message</strong></span>
</pre></div><p>To display the controller description and the list of the actions, we can also require help about the complete route (controller/action) typing:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./yii help message/config</strong></span>
</pre></div><p>This returns an output containing the description of the action, its usage, and the options available:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>DESCRIPTION</strong></span>

<span class="strong"><strong>Creates a configuration file for the "extract" command.</strong></span>

<span class="strong"><strong>The generated configuration file contains detailed instructions on</strong></span>
<span class="strong"><strong>how to customize it to fit for your needs. After customization,</strong></span>
<span class="strong"><strong>you may use this configuration file with the "extract" command.</strong></span>

<span class="strong"><strong>USAGE</strong></span>

<span class="strong"><strong>yii message/config &lt;filePath&gt; [...options...]</strong></span>

<span class="strong"><strong>- filePath (required): string</strong></span>
<span class="strong"><strong>  output file name or alias.</strong></span>

<span class="strong"><strong>OPTIONS</strong></span>

<span class="strong"><strong>--appconfig: string</strong></span>
<span class="strong"><strong>  custom application configuration file path.</strong></span>
<span class="strong"><strong>  If not set, default application configuration is used.</strong></span>

<span class="strong"><strong>--color: boolean, 0 or 1</strong></span>
<span class="strong"><strong>  whether to enable ANSI color in the output.</strong></span>
<span class="strong"><strong>  If not set, ANSI color will only be enabled for terminals that support it.</strong></span>

<span class="strong"><strong>--interactive: boolean, 0 or 1 (defaults to 1)</strong></span>
<span class="strong"><strong>  whether to run the command interactively.</strong></span>
</pre></div></div></div>
<div class="section" title="Creating a console controller"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec82"/>Creating a console controller</h1></div></div></div><p>A console controller <a id="id529" class="indexterm"/>is totally similar to the web controllers that we created earlier. It extends the <code class="literal">\yii\console\Controller</code> base class and can return an integer value indicating the status response of the action (0 stands for successful execution of the action), also named <code class="literal">exit code</code>.</p><p>The <code class="literal">public</code> properties of the controller can be made available as an option only if their names are returned by the <code class="literal">options()</code> method that accepts <code class="literal">actionID</code> as the parameter; so the response can be customized according to <code class="literal">actionID</code>.</p><p>The response of the <code class="literal">options()</code> method is an array of text string that represents the public property names of the controller.</p><p>Starting from the advanced template application that we previously installed in the <code class="literal">yiiadv</code> folder, let's create a new console controller named <code class="literal">MyExampleController</code> in <code class="literal">console/controllers/MyExampleController.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php

namespace console\controllers;

use \yii\console\Controller;

/**
 * This is an example controller
 */
class MyExampleController extends Controller
{
    public $option1;
    public $option2;
    
    public function options($action)
    {
        return ['option1'];
    }
    
    /**
     * Simply return a welcome text
     */
    public function actionTest($param1)
    {
        echo 'this is my first controller using console application';
        echo "\n";
        echo "You have passed param1 with value: ".$param1;
        echo "\n";
        echo "Value of option1 is: ".$this-&gt;option1;
        echo "\n";
        
        // equivalent to return 0;
        return Controller::EXIT_CODE_NORMAL;
    }
    
}

?&gt;</pre></div><p>This controller contains<a id="id530" class="indexterm"/> two public properties, but only <code class="literal">option1</code> will be usable from the console, since it is returned by the <code class="literal">options()</code> method. We will display the result of the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./yii help my-example</strong></span>
</pre></div><p>The preceding command will return the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>DESCRIPTION</strong></span>

<span class="strong"><strong>This is an example controller</strong></span>

<span class="strong"><strong>SUB-COMMANDS</strong></span>

<span class="strong"><strong>- my-example/test  Simply return a welcome text</strong></span>

<span class="strong"><strong>To see the detailed information about individual sub-commands, enter:</strong></span>

<span class="strong"><strong>  yii help &lt;sub-command&gt;</strong></span>
</pre></div><p>If we need other details about the <code class="literal">test</code> action, we can launch the preceding command specifying the complete route:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./yii help my-example/test</strong></span>
</pre></div><p>Now, try to launch the command with the route <code class="literal">my-example/test</code>, without any parameter:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./yii my-example/test</strong></span>
</pre></div><p>We will receive an error about missing <code class="literal">param1</code>. The following is the correct syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./yii my-example/test "this is value for param1"</strong></span>
</pre></div><p>The preceding command will return the following output without any value for <code class="literal">option1</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>this is my first controller using console application</strong></span>
<span class="strong"><strong>You have passed param1 with value: this is value for param1</strong></span>
<span class="strong"><strong>Value of option1 is:.</strong></span>
</pre></div><p>We can also pass the value <code class="literal">option1</code> by appending <code class="literal">--option1</code> to the command, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./yii my-example/test "this is value for param1" --option1="this is value for option1"</strong></span>
</pre></div><p>The preceding<a id="id531" class="indexterm"/> command will return a complete output, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>this is my first controller using console application</strong></span>
<span class="strong"><strong>You have passed param1 with value: this is value for param1</strong></span>
<span class="strong"><strong>Value of option1 is: this is value for option1</strong></span>
</pre></div><div class="section" title="Example – setting an alarm flag for expired reservation"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec53"/>Example – setting an alarm flag for expired reservation </h2></div></div></div><p>Now, let's consider an<a id="id532" class="indexterm"/> example to illustrate how to use <a id="id533" class="indexterm"/>console commands to execute maintenance operations.</p><p>In console controllers, we can access all the models, components, and extensions available in the project, as well as what we have done in the web application. Therefore, we will manipulate data in the same way as we should do for a web application.</p><p>Starting from the reservation database table used in the previous chapters, we will add a new Boolean field, named expired, to set which reservations are out of the end date.</p><p>This is the structure of the <code class="literal">reservation</code> table to store data in the MySQL Server:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `reservation` (
 `id` int(11) NOT NULL AUTO_INCREMENT,
 `room_id` int(11) NOT NULL,
 `customer_id` int(11) NOT NULL,
 `price_per_day` decimal(20,2) NOT NULL,
 `date_from` date NOT NULL,
 `date_to` date NOT NULL,
 `reservation_date` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
 `expired` int(1) NOT NULL DEFAULT '0',
 PRIMARY KEY (`id`)
 )</pre></div><p>Now, let's insert some records to make a simulation. We will update the <code class="literal">expired</code> field with value <code class="literal">1</code> if today is after <code class="literal">date_to value</code>; otherwise, it will be <code class="literal">0</code>.</p><p>These are the records to insert in the <code class="literal">reservation</code> database table:</p><div class="informalexample"><pre class="programlisting">INSERT INTO `reservation` (`id`, `room_id`, `customer_id`, `price_per_day`, `date_from`, `date_to`, `reservation_date`, `expired`) VALUES
(1, 2, 1, 90.00, '2015-02-10', '2015-05-23', '2015-05-24 22:45:37', 0),
(2, 2, 1, 48.00, '2019-08-27', '2019-08-31', '2015-05-24 22:45:37', 0),
(3, 1, 2, 105.00, '2015-09-24', '2015-10-06', '2015-06-03 00:21:14', 0),
(4, 1, 2, 150.00, '2015-06-22', '2015-06-28', '2015-06-21 22:24:25', 0),
(5, 1, 2, 150.00, '2015-07-22', '2015-08-28', '2015-06-21 22:24:34', 0);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note75"/>Note</h3><p>Make sure that users exist in user database table</p></div></div><p>Now, create a<a id="id534" class="indexterm"/> new console <a id="id535" class="indexterm"/>controller in <code class="literal">console/controllers/ReservationsController.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php

namespace console\controllers;

use \yii\console\Controller;

/**
 * Manage reservations
 */
class ReservationsController extends Controller
{
    /**
     * Update 'expired' field of reservations
     */
    public function actionUpdateExpired()
    {
        $models = \common\models\Reservation::find()-&gt;all();
        
        foreach($models as $m)
        {
            echo sprintf('Check reservation #%d - date_to = %s - status : %s', $m-&gt;id, $m-&gt;date_to, (strtotime($m-&gt;date_to)&lt;=time())?'OK':'Expired');
            echo "\n";
            // Set expired field. I'll for every model because if we could have changed 'date_to' value.
            $m-&gt;expired = (strtotime($m-&gt;date_to)&lt;=time())?0:1;
            $m-&gt;save();
        }
        // equivalent to return 0;
        return Controller::EXIT_CODE_NORMAL;
    }
}
?&gt;</pre></div><p>In <code class="literal">actionUpdateExpired</code>, we display for each model some data to the console, such as <code class="literal">id</code>, <code class="literal">date_to</code>, and <code class="literal">status</code>. Then, we will set for each model the value of the <code class="literal">expired</code> field, based on the <code class="literal">date_to</code> value.</p><p>Finally, we <a id="id536" class="indexterm"/>will launch<a id="id537" class="indexterm"/> this command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./yii reservations/update-expired</strong></span>
</pre></div><p>This will return the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Check reservation #1 - date_to = 2015-05-23 - status : OK</strong></span>
<span class="strong"><strong>Check reservation #2 - date_to = 2019-08-31 - status : Expired</strong></span>
<span class="strong"><strong>Check reservation #3 - date_to = 2015-10-06 - status : Expired</strong></span>
<span class="strong"><strong>Check reservation #4 - date_to = 2015-06-28 - status : OK</strong></span>
<span class="strong"><strong>Check reservation #5 - date_to = 2015-08-28 - status : OK</strong></span>
</pre></div></div></div>
<div class="section" title="Formatting the output from the console"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec83"/>Formatting the output from the console</h1></div></div></div><p>The base class <a id="id538" class="indexterm"/>console controller <code class="literal">yii\console\Controller</code> supports<a id="id539" class="indexterm"/> methods to display colored and formatted output.</p><p>There are two standard methods to display the output, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">stdout</code>: This prints a string to <code class="literal">STDOUT</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">strerr</code>: This prints a string to <code class="literal">STDERR</code></li></ul></div><p>Both these methods support more parameters: the first is the text string to be displayed, and the other includes the formatting options that can be passed to make a pretty output.</p><p>There are formatting options for colors and typing; these are defined by constants from <code class="literal">\yii\helpers\Console</code>; for example, <code class="literal">BG_CYAN</code> for cyan background color, <code class="literal">BG_RED</code> for red background color, and <code class="literal">UNDERLINE</code> for underlined text.</p><p>Let's see an example using the following code:</p><div class="informalexample"><pre class="programlisting">$this-&gt;stdout("Hello?\n", Console::BOLD);</pre></div><p>This will display <code class="literal">Hello?</code> (with a carriage return) with bold font. Sometimes, it could be possible that no effect will be displayed, since our terminal does not support colors.</p><p>In this case, a method of the console controller will help us verify our terminal capabilities: <code class="literal">isColorEnabled()</code> returns a Boolean indicating whether the terminal supports ANSI colors.</p><p>Both the methods <code class="literal">strout</code> and <code class="literal">strerr</code> are applied to the whole text string and are passed as the first parameter. If <a id="id540" class="indexterm"/>we want to apply some features only to a single<a id="id541" class="indexterm"/> part of the text, we must use the <code class="literal">ansiFormat</code> method that returns an ANSI-formatted string.</p><p>Let's take an example. Create a controller to check whether the console supports ANSI or not, and try to print the colored text if this feature is supported.</p><p>Then, create a new controller named <code class="literal">ColorController</code> in <code class="literal">console/controllers/ColorController.php</code> with this content:</p><div class="informalexample"><pre class="programlisting">&lt;?php

namespace console\controllers;

use \yii\console\Controller;
use \yii\helpers\Console;

/**
 * Colors dedicated controller
 */
class ColorController extends Controller
{
    /**
     * Simply return a welcome text
     */
    public function actionIsClientEnabled()
    {
        if($this-&gt;isColorEnabled())
        {
            $this-&gt;stdout('OK, terminal supports colors!');
        }
        else
        {
            $this-&gt;stdout('NOT OK, terminal does not support colors!'); 
            
        }

        $this-&gt;stdOut("\n");        
        
        // equivalent to return 0;
        return Controller::EXIT_CODE_NORMAL;
    }
    
    public function actionPrintColouredText()
    {
        $colouredText = $this-&gt;ansiFormat('This text is coloured', Console::FG_RED);
        $normalText ="This text is normal";
        
        $this-&gt;stdout(sprintf("%s - %s\n", $normalText, $colouredText));
    }
    
    
}

?&gt;</pre></div><p>We call <a id="id542" class="indexterm"/>launch to check if <a id="id543" class="indexterm"/>client supports ANSI colors or not:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./yii color/is-client-enabled</strong></span>
</pre></div><p>And to display colored text (if the client supports it):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./yii color/print-coloured-text</strong></span>
</pre></div><p>The <code class="literal">Console</code> class under <code class="literal">\yii\helpers\</code> contains many other useful methods to format text and output, such as <code class="literal">confirm()</code> or <code class="literal">prompt()</code> to get input from the user, or progress to create a progress bar to display the execution state.</p></div>
<div class="section" title="Implementing and executing cron jobs"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec84"/>Implementing and executing cron jobs</h1></div></div></div><p>The main usage of console <a id="id544" class="indexterm"/>applications consists in the execution of periodic tasks <a id="id545" class="indexterm"/>using cron job (on Linux or Unix machines).</p><p>We can use console applications to send massive e-mails to perform system maintenance or to check a specific status of the application.</p><p>In the next example, we will see how to send an e-mail with a summary of the reservations made in the current date.</p><div class="section" title="Example – sending an e-mail with new reservations of the day"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec54"/>Example – sending an e-mail with new reservations of the day</h2></div></div></div><p>This example illustrates how to <a id="id546" class="indexterm"/>send an e-mail with a summary of new daily reservations.</p><p>First of all, let's configure the <code class="literal">mailer</code> component in <code class="literal">console/config/main.php</code>, if it is not already configured.</p><p>It is enough to pass a few parameters to the component:</p><div class="informalexample"><pre class="programlisting">    'components' =&gt; [
    ..
    ..

        'mailer' =&gt; [
            'class' =&gt; 'yii\swiftmailer\Mailer',
            'viewPath' =&gt; '@common/mail',
            // send all mails to a file by default. You have to set
            // 'useFileTransport' to false and configure a transport
            // for the mailer to send real emails.
            'useFileTransport' =&gt; true,
        ],
..
..
    ],
];</pre></div><p>The <code class="literal">class</code> parameter<a id="id547" class="indexterm"/> indicates the class that handles the component, <code class="literal">viewPath</code>, which indicates where views of the e-mail, or rather e-mail templates, are stored; the last parameter <code class="literal">useFileTransport</code> indicates the e-mail sending method.</p><p>Now, in <code class="literal">ReservationsController</code>, under <code class="literal">console/controllers/ReservationsController.php</code>, add the method, <code class="literal">actionReservationsOfTheDay</code>, which sends the content of daily reservations:</p><div class="informalexample"><pre class="programlisting">    public function actionReservationsOfTheDay($currentDate=null)
    {
        if($currentDate == null) $currentDate = date('Y-m-d');
        $models = \common\models\Reservation::find()-&gt;where('DATE(reservation_date) = "'.$currentDate.'"')-&gt;all(); 
        \Yii::$app-&gt;mailer-&gt;compose(['html' =&gt; 'reservationsOfTheDay-html', 'text' =&gt; 'reservationsOfTheDay-text'], ['models' =&gt; $models, 'currentDate' =&gt; $currentDate])
            -&gt;setFrom('myemail@example.com')
            -&gt;setTo('administrator@example.com')
            -&gt;setSubject('Reservations of the day: '.$currentDate)
            -&gt;send();
            
                 
    }</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note76"/>Note</h3><p>It is advisable to put the <code class="literal">from</code> e-mail parameter, for example, in a <code class="literal">params.php</code> file, which contains all the global parameters available in the whole application.</p></div></div><p>This method simply gets the <code class="literal">currentDate</code> parameter from the input so that we can change the evaluation date as we need; the action body finds reservations for the input date and passes them to the e-mail view <code class="literal">reservationsOfTheDay</code> in the <code class="literal">html</code> and <code class="literal">text</code> format.</p><p>Now, we must create <a id="id548" class="indexterm"/>the content of the e-mail format, creating two files in <code class="literal">common/mail</code>: <code class="literal">reservationsOfTheDay-html.php</code> and <code class="literal">reservationsOfTheDay-text.php</code>.</p><p>This is the content of the HTML version:</p><div class="informalexample"><pre class="programlisting">There are &lt;?= count($models) ?&gt; reservations for the date &lt;?= $currentDate ?&gt;

&lt;br /&gt;&lt;br /&gt;

&lt;?php if(count($models)&gt;0) { ?&gt;
    &lt;b&gt;This is a summary:&lt;/b&gt;
    
    &lt;br /&gt;
    
    &lt;table&gt;
        &lt;tr&gt;
            &lt;td&gt;Reservation #&lt;/td&gt;
            &lt;td&gt;Room&lt;/td&gt;
            &lt;td&gt;Customer&lt;/td&gt;
            &lt;td&gt;Price per day&lt;/td&gt;
            &lt;td&gt;Date from&lt;/td&gt;
            &lt;td&gt;Date to&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;?php foreach($models as $m) { ?&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;?= $m-&gt;id ?&gt;&lt;/td&gt;
            &lt;td&gt;&lt;?= $m-&gt;room-&gt;floor.' '.$m-&gt;room-&gt;number ?&gt;&lt;/td&gt;
            &lt;td&gt;&lt;?= $m-&gt;customer-&gt;surname.' '.$m-&gt;customer-&gt;name ?&gt;&lt;/td&gt;
            &lt;td&gt;&lt;?= $m-&gt;price_per_day ?&gt;&lt;/td&gt;
            &lt;td&gt;&lt;?= $m-&gt;date_from ?&gt;&lt;/td&gt;
            &lt;td&gt;&lt;?= $m-&gt;date_to ?&gt;&lt;/td&gt;
        &lt;/tr&gt;    
        &lt;?php } ?&gt;
        
    &lt;/table&gt;
&lt;?php } else { ?&gt;
    &lt;i&gt;There is no summary for current date&lt;/i&gt;
&lt;?php } ?&gt;    </pre></div><p>This is the corresponding<a id="id549" class="indexterm"/> content in text format (not required for the HTML e-mail client):</p><div class="informalexample"><pre class="programlisting">There are &lt;?= count($models) ?&gt; reservations for the date &lt;?= $currentDate ?&gt;

&lt;?php if(count($models)&gt;0) { ?&gt;
    This is a summary
    
    
    &lt;?php foreach($models as $m) { ?&gt;
        Reservation #: &lt;?= $m-&gt;id ?&gt; - Room: &lt;?= $m-&gt;room-&gt;floor.' '.$m-&gt;room-&gt;number ?&gt; - Customer: &lt;?= $m-&gt;customer-&gt;surname.' '.$m-&gt;customer-&gt;name ?&gt; - Price per day: &lt;?= $m-&gt;price_per_day ?&gt; - Date from: &lt;?= $m-&gt;date_from ?&gt; - Date to: &lt;?= $m-&gt;date_to ?&gt;
    &lt;?php } ?&gt;
&lt;?php } else { ?&gt;
    There is no summary for the current date
&lt;?php } ?&gt;</pre></div><p>The command can be executed by launching:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./yii reservations/reservations-of-the-day</strong></span>
</pre></div><p>We can also call the pass date parameter to change the date to check, for example, to check the reservations made on <code class="literal">2015-08-05</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./yii reservations/reservations-of-the-day "2015-08-05"</strong></span>
</pre></div><p>The last thing to do is to attach that command to a periodic task scheduler according to the operating system, for instance, cron in the Linux or Unix environment.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec85"/>Summary</h1></div></div></div><p>In this chapter, we have discussed the third kind of default application installed with Yii's advanced template, the console application.</p><p>We have seen the primary differences between console and web applications, and we have learned how to create our first console controller, handling options and parameters to pass to the actions. Then, we have applied a console application with a concrete example, such as making maintenance operation to the reservation table in order to update the status of the reservations to expired.</p><p>Then, we focused on how the console application can make pretty outputs, using colors and text formatting features.</p><p>Finally, we have mastered how to create a complete periodic task with a console controller action to send a daily summary e-mail containing reservations made in current date.</p><p>In the final chapter, we will see the final stage of our development, where we have to make the code reusable but, especially, maintainable.</p></div></body></html>