<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer153">
<h1 class="chapter-number" id="_idParaDest-92" lang="en-GB"><a id="_idTextAnchor092"/>5</h1>
<h1 id="_idParaDest-93" lang="en-GB"><a id="_idTextAnchor093"/>Managing Users, Cohorts, and Authentication</h1>
<p lang="en-GB">This chapter will teach you how to manage users in your Moodle system. We will first look at what information is stored for each user and how we can extend their profiles. We will then perform several standard user actions before dealing with cohorts. Finally, we will deal with a wide range of user authentication mechanisms. We will cover the following topics:</p>
<ul>
<li lang="en-GB">Understanding user profiles</li>
<li lang="en-GB">Performing standard user actions (manual and bulk)</li>
<li lang="en-GB">Creating user accounts manually (including batch upload)</li>
<li lang="en-GB">Managing cohorts (including batch upload)</li>
<li lang="en-GB">Configuring user authentication (internal, external, service providers, and system)</li>
</ul>
<p lang="en-GB">The following diagram shows a high-level overview of the aforementioned topics (users, cohorts, and authentication) and how they are connected:</p>
<div>
<div class="IMG---Figure" id="_idContainer113">
<img alt="Figure 5.1 – Users, courses, and authentication – a high-level overview " height="794" src="image/Figure_5.01_B18779.jpg" width="1212"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.1 – Users, courses, and authentication – a high-level overview</p>
<p lang="en-GB">By the end of this chapter, you will be able to manage all aspects of user accounts and user authentication. This is a lot to take in, so we’d better get going!</p>
<h1 id="_idParaDest-94" lang="en-GB"><a id="_idTextAnchor094"/>Understanding user profiles</h1>
<p lang="en-GB">Other than guests, each user has a profile containing information about them. We will first deal <a id="_idIndexMarker305"/>with the information stored for each user and how it is organized in Moodle.</p>
<p lang="en-GB">You can view your own profile by selecting the <strong class="bold" lang="">Profile</strong> item in the drop-down menu beside your name at the top of the screen. Click on the <strong class="bold" lang="">Edit profile</strong> link in the <strong class="bold" lang="">User details</strong> section to change your profile details. To modify the profiles of other users, click on the <strong class="bold" lang="">Edit</strong> icon beside their name by navigating to <strong class="bold" lang="">Site administration | Users | Accounts | Browse list of users</strong>.</p>
<h2 id="_idParaDest-95" lang="en-GB"><a id="_idTextAnchor095"/>Profile fields</h2>
<p lang="en-GB">Moodle user <a id="_idIndexMarker306"/>profiles are divided into pre-defined categories, which cannot be changed via the Moodle user interface:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">General</strong>: Standard user fields</li>
<li lang="en-GB"><strong class="bold" lang="">User picture</strong>: Image of the user</li>
<li lang="en-GB"><strong class="bold" lang="">Additional names</strong>: Phonetic name, middle name, and alternate name</li>
<li lang="en-GB"><strong class="bold" lang="">Interests</strong>: Tags for networking activities</li>
<li lang="en-GB"><strong class="bold" lang="">Optional</strong>: Additional user information</li>
</ul>
<p lang="en-GB">In addition to these static profile field categories, Moodle allows us to create user-defined profile categories and fields. Before dealing with custom profile fields, we will cover the pre-defined fields grouped by the aforementioned categories.</p>
<h3 lang="en-GB">User profile fields – General</h3>
<p lang="en-GB">The following <a id="_idIndexMarker307"/>screenshot shows the profile fields of the <strong class="bold" lang="">General</strong> category:</p>
<div>
<div class="IMG---Figure" id="_idContainer114">
<img alt="Figure 5.2 – User profile fields – General " height="1604" src="image/Figure_5.02_B18779.jpg" width="1376"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.2 – User profile fields – General</p>
<p lang="en-GB">Most of these items are self-explanatory, but there are a few things you need to know about <a id="_idIndexMarker308"/>each of them. Here is a brief description of each profile element, along with tips to use them effectively:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Username</strong>: A unique username has to be provided. By default, only alphanumeric <a id="_idIndexMarker309"/>lowercase characters, underscores (_), hyphens (-), periods (.), or the <em class="italic" lang="">at</em> symbol (@) are allowed. Suppose you also want to use other characters in usernames, such as umlauts (¨). In that case, you will have to enable these by going to <strong class="bold" lang="">Site administration | Security | Site security settings</strong> and turning on <strong class="bold" lang="">Allow extended characters in usernames</strong>. It is important to remember that you ought to have administrator rights to change the username.</li>
</ul>
<p lang="en-GB">If you wish to use the email address as the username, consider the <strong class="bold" lang="">Allow login via email</strong> option (at <strong class="bold" lang="">Site administration | Plugins | Authentication | Manage authentication</strong>). That way, users have two alternatives to log in, their username and their email address.</p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">If your users don’t already have a unique identifier that can be (re)used as their Moodle username, such as an email address or a staff ID, it is highly recommended to develop a consistent naming scheme for usernames, for example, <strong class="source-inline" lang="">firstname.lastname</strong> for smaller institutions or <strong class="source-inline" lang="">startyear.firstname.lastname.index</strong> for larger organizations.</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Choose an authentication method</strong>: This menu allows changes to the user’s authentication method. While useful for testing and development purposes, it is highly <a id="_idIndexMarker310"/>recommended that you do not select any disabled option from this menu. You cannot change the <strong class="source-inline" lang="">auth</strong> method of the main admin account. We’ll look at authentication methods in detail in the second half of this chapter.</li>
</ul>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">An incorrect authentication method prevents users from logging in, or even completely deletes their account!</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Suspended account</strong>: Select this option to prevent a user from logging in. This is useful <a id="_idIndexMarker311"/>as a disciplinary measure or in case of a more prolonged absence, for instance, a sabbatical term. There is no expiry date on the suspension, so you must manually change this back.</li>
</ul>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">Account suspension is not the same as enrolment suspension. The former affects users and the latter, individual course enrolments.</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">New password</strong>: When creating manual accounts, a password must be provided <a id="_idIndexMarker312"/>for security reasons. If the user ought to change the given password on their first login, the <strong class="bold" lang="">Force password change</strong> option has to be selected. You can unmask (reveal) your own password but not that of other users. However, administrators can override the existing passwords of users.</li>
</ul>
<p lang="en-GB">If <strong class="bold" lang="">Password policy</strong> is enabled (in <strong class="bold" lang="">Site administration | Security | Site security settings</strong>), the password must adhere to this policy. Refer to <a href="B18779_13.xhtml#_idTextAnchor251"><em class="italic" lang="">Chapter 13</em></a>, <em class="italic" lang="">Ensuring Moodle Security</em>, for more details on password policy.</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">First name</strong> and <strong class="bold" lang="">Surname</strong>: These <a id="_idIndexMarker313"/>are compulsory fields for users, for which diacritical marks (ä, â, à, á, …) are fully supported.</li>
<li lang="en-GB"><strong class="bold" lang="">Email address</strong>: This is a compulsory field and should be unique. Ensure the address <a id="_idIndexMarker314"/>is correct since Moodle makes regular use of it, for example, to notify users who have forgotten their username or password.</li>
</ul>
<p lang="en-GB">Some organizations still do not make use of email addresses. As it is a mandatory field, there are two typical workarounds in this scenario.</p>
<p lang="en-GB">The first option is to develop a unique dummy email address scheme or void email <a id="_idIndexMarker315"/>addresses solely used for identification purposes. While this solves the problem technically, it limits the user experience significantly because communication among users or notifications generated by Moodle cannot be sent.</p>
<p lang="en-GB">The second <a id="_idIndexMarker316"/>alternative is to activate <strong class="bold" lang="">duplicate email addresses</strong> (enable <strong class="bold" lang="">Allow accounts with same email</strong> in <strong class="bold" lang="">Site administration | Plugins | Authentication | Manage authentication</strong>) and have users with an email address responsible for groups of learners, for example, a teacher for a class or a supervisor for workers. While this approach is not ideal from a privacy perspective – user-specific messages could potentially be read by multiple persons – at least somebody knows what is going on and can then communicate it to the intended recipients.</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Email display</strong>: Choices <a id="_idIndexMarker317"/>can be made as to who can see the user’s email address. The self-explanatory choices are <strong class="bold" lang="">Hide my email address from non-privileged users</strong>, <strong class="bold" lang="">Allow everyone to see my email address</strong>, and <strong class="bold" lang="">Allow only other participants to see my email address</strong> (default). Administrators and teachers (with editing rights) will always see email addresses, even if they are hidden.</li>
<li lang="en-GB"><strong class="bold" lang="">MoodleNet profile</strong>: Link <a id="_idIndexMarker318"/>to the user’s MoodleNet profile, which has to be a WebFinger-compliant URI. We will deal with MoodleNet in <a href="B18779_19.xhtml#_idTextAnchor344"><em class="italic" lang="">Chapter 19</em></a>, <em class="italic" lang="">Setting Up Moodle Networking</em>.</li>
<li lang="en-GB"><strong class="bold" lang="">City/town</strong> and <strong class="bold" lang="">Select a country</strong>: These <a id="_idIndexMarker319"/>are used to further identify users by their geographical location.</li>
<li lang="en-GB"><strong class="bold" lang="">Timezone</strong>: This is <a id="_idIndexMarker320"/>used to convert time-related messages on the system (such as assignment deadlines) from the local time (typically, the server time) to the correct time in whichever zone the user has selected. It is necessary as your users may be geographically spread across multiple time zones. The default city, country, and time zone can be specified by navigating to <strong class="bold" lang="">Site administration | Location | Location settings</strong>.</li>
<li lang="en-GB"><strong class="bold" lang="">Description</strong>: This <a id="_idIndexMarker321"/>provides additional information about the user. As an administrator, you can leave the field empty.</li>
</ul>
<p lang="en-GB">Additional fields might appear in the user’s profile, for example, <strong class="bold" lang="">Preferred theme</strong> or <strong class="bold" lang="">Email charset</strong>, but this requires the settings to be changed elsewhere. We will mention these when the respective topics are being dealt with.</p>
<h3 lang="en-GB">User profile fields – User picture</h3>
<p lang="en-GB">The second <a id="_idIndexMarker322"/>category is called <strong class="bold" lang="">User picture</strong>, and, as the name suggests, it deals with the image attached to a user’s profile.</p>
<p lang="en-GB">Simply drag it to the <strong class="bold" lang="">New picture</strong> pane or select the image from the file picker to upload a new picture. The image cannot be larger than the maximum size listed; if your image is too large, it is recommended to reduce its size to a minimum of 100 x 100 pixels. The supported formats are GIF, PNG, and the JPEG family; however, be careful with transparent backgrounds as they might cause issues in some browsers.</p>
<p lang="en-GB">The <strong class="bold" lang="">Picture description</strong> field is used as an alt tag, a description of the image used for nonvisual browsers; it is in conformance with accessibility guidelines.</p>
<div>
<div class="IMG---Figure" id="_idContainer115">
<img alt="Figure 5.3 – User profile fields – User picture " height="872" src="image/Figure_5.03_B18779.jpg" width="1377"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.3 – User profile fields – User picture</p>
<p lang="en-GB">Once a <a id="_idIndexMarker323"/>picture has been assigned, it will be shown in place of the <strong class="bold" lang="">None</strong> label. To remove the picture, check the <strong class="bold" lang="">Delete</strong> checkbox, and the picture will be removed when the profile information is updated.</p>
<p lang="en-GB">Moodle will automatically crop the image to a square and resize it to 100 x 100 pixels for the larger view and 35 x 35 pixels for the smaller thumbnail view.</p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">Two thumbnails are created automatically during the upload process, which reduces the file size to approximately 4 KB. An administrator can view all the uploaded user pictures via the <strong class="source-inline" lang="">&lt;moodleurl&gt;/userpix</strong> URL.</p>
<p lang="en-GB">Moodle also <a id="_idIndexMarker324"/>supports <strong class="bold" lang="">Gravatars</strong>, so-called globally recognized avatars. Once you select the <strong class="bold" lang="">Enable Gravatar</strong> option on <strong class="bold" lang="">Site administration | Users | Permissions | User policies</strong>, Moodle will attempt to fetch a user profile picture from <a href="http://gravatar.com">gravatar.com</a> if the user has not uploaded an image.</p>
<p lang="en-GB">If you <a id="_idIndexMarker325"/>suspect that your learners will likely misuse this feature by uploading inappropriate images, you can disable the functionality. Go to <strong class="bold" lang="">Site administration | Security | Site security settings</strong> and tick the <strong class="bold" lang="">Disable user profile images</strong> checkbox. Remember that once this feature is disabled, pictures cannot be assigned to any users (except the administrator), nor will it be possible for teachers to represent groups in courses with images.</p>
<h3 lang="en-GB">User profile fields – Additional names</h3>
<p lang="en-GB">This <strong class="bold" lang="">Additional names</strong> section <a id="_idIndexMarker326"/>comprises the following fields:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">First name – phonetic</strong> and <strong class="bold" lang="">Surname – phonetic</strong>: The primary use case for the field pair is in Far East languages where users have an original and a Romanized version or a phonetic name displayed (for instance, Pinyin).</li>
<li lang="en-GB"><strong class="bold" lang="">Middle name</strong>: In some cultures, it is common to have three or more names that are displayed.</li>
<li lang="en-GB"><strong class="bold" lang="">Alternate name</strong>: This can be a nickname, a handle, or an alias used in specific pedagogical settings, for example, in gamification or role-playing scenarios.</li>
</ul>
<h3 lang="en-GB">User profile fields – Interests</h3>
<p lang="en-GB">Interests, such <a id="_idIndexMarker327"/>as hobbies or professional activities, can be entered one by one. To remove a tag, select its label. The given <strong class="bold" lang="">List of interests</strong> represents tags displayed in the user’s profile. You can find more information on tagging at <a href="http://docs.moodle.org/en/Tags">docs.moodle.org/en/Tags</a> and in <a href="B18779_09.xhtml#_idTextAnchor181"><em class="italic" lang="">Chapter 9</em></a>, <em class="italic" lang="">Configuring Educational Features</em>.</p>
<div>
<div class="IMG---Figure" id="_idContainer116">
<img alt="Figure 5.4 – User profile fields – Interests " height="276" src="image/Figure_5.04_B18779.jpg" width="871"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.4 – User profile fields – Interests</p>
<h3 lang="en-GB">User profile fields – Optional</h3>
<p lang="en-GB">More <a id="_idIndexMarker328"/>personal details are grouped under the <strong class="bold" lang="">Optional</strong> category:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">ID number</strong> can contain a student or staff number and is usually used in synchronization tools, such as HR systems.</li>
<li lang="en-GB"><strong class="bold" lang="">Institution</strong> and <strong class="bold" lang="">Department</strong> might be used for campus and faculty in a university. If you are using Moodle Workplace, do not confuse these two fields with departments that are part of the organization structure, including department frameworks, positions, job assignments, and managers.</li>
<li lang="en-GB"><strong class="bold" lang="">Phone</strong>, <strong class="bold" lang="">Mobile phone</strong>, and <strong class="bold" lang="">Address</strong> should be self-explanatory.</li>
</ul>
<p lang="en-GB">Some organizations rename unused fields to ones required in their setup. For more information on this, refer to the <em class="italic" lang="">Localization</em> section in <a href="B18779_10.xhtml#_idTextAnchor204"><em class="italic" lang="">Chapter 10</em></a>, <em class="italic" lang="">Configuring Technical Features</em>.</p>
<p lang="en-GB">This concludes the explanation of pre-defined user profile fields. The list can be extended by custom fields covered in the following section.</p>
<h2 id="_idParaDest-96" lang="en-GB"><a id="_idTextAnchor096"/>Creating user-defined profile fields</h2>
<p lang="en-GB">Moodle <a id="_idIndexMarker329"/>allows new arbitrary fields to be added to user profiles. We have already described the management of user-defined fields in the previous chapter when we dealt with custom course fields. Since the exact mechanism is used for user profile fields, we only deal with account-specific idiosyncrasies.</p>
<p lang="en-GB">We just learned that profile fields are organized into categories (for instance, <strong class="bold" lang="">General</strong>, <strong class="bold" lang="">User picture</strong>, <strong class="bold" lang="">Interests</strong>, and <strong class="bold" lang="">Optional</strong>). Additional categories can be created, and user-defined fields can be placed within these new categories. This feature can be found by navigating to <strong class="bold" lang="">Site administration | Users | Accounts | User profile fields</strong>.</p>
<p lang="en-GB">Unlike in <a id="_idIndexMarker330"/>custom courses, a default category, called <strong class="bold" lang="">Other fields</strong>, is already present, which can be deleted or renamed via the standard Moodle icons. To create a new category, click the <strong class="bold" lang="">Create a new profile category</strong> button at the bottom of the user profiles once the profile fields have been added.</p>
<p lang="en-GB">The five profile field types in courses (checkbox, date/time, drop-down menu, text area, and text input) exist <a id="_idIndexMarker331"/>for users, plus one more: social. Let us go through the differences in the field-specific settings:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Checkbox</strong>: This is the same as in custom course fields.</li>
<li lang="en-GB"><strong class="bold" lang="">Date/time</strong>: Instead of minimum and maximum value, the two date boundaries are <strong class="bold" lang="">Start year</strong> and <strong class="bold" lang="">End year</strong>, respectively. There also exists an <strong class="bold" lang="">Include time?</strong> option, though you cannot specify a default time.</li>
<li lang="en-GB"><strong class="bold" lang="">Drop-down menu</strong>: This is the same as in custom course fields.</li>
<li lang="en-GB"><strong class="bold" lang="">Social</strong>: This new field type lets you specify social network IDs, such as the user’s Skype handle. The options you can see in the <strong class="bold" lang="">Network type</strong> list were formerly hard coded in the user profile. Let’s hope the list will be updated to the 21st century soon to support social media platforms such as Facebook, Twitter, Instagram, and TikTok, instead of outdated services such as ICQ and AIM.</li>
</ul>
<p lang="en-GB">If you upgrade from Moodle 3.x and any of these services are populated, they will be retained and converted automatically.</p>
<div>
<div class="IMG---Figure" id="_idContainer117">
<img alt="Figure 5.5 – User profile fields of type social " height="1521" src="image/Figure_5.05_B18779.jpg" width="1409"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.5 – User profile fields of type social</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Text area</strong>: This is <a id="_idIndexMarker332"/>precisely the same as in custom course fields.</li>
<li lang="en-GB"><strong class="bold" lang="">Text input</strong>: This is the same as the <strong class="bold" lang="">Short text</strong> field in courses, but some fields have been renamed: <strong class="bold" lang="">Form input size</strong> is now <strong class="bold" lang="">Display size</strong>, and <strong class="bold" lang="">Maximum number of characters</strong> is now <strong class="bold" lang="">Character limit</strong>. Why? I have absolutely no idea!</li>
</ul>
<p lang="en-GB">Each field type in user-profile fields has the same parameters as custom course fields with <a id="_idIndexMarker333"/>three notable differences:</p>
<ul>
<li lang="en-GB">The fields are arranged slightly differently, and the common field settings <strong class="bold" lang="">Locked</strong> and <strong class="bold" lang="">Visible</strong> have been moved to the <strong class="bold" lang="">General</strong> section.</li>
<li lang="en-GB">The options in <strong class="bold" lang="">Who is field visible to?</strong> have been adjusted as follows. Instead of <strong class="bold" lang="">Teachers</strong>, there are now two options to choose from, namely <strong class="bold" lang="">Visible to user</strong> and <strong class="bold" lang="">Visible to user, teachers, and admins</strong>.</li>
<li lang="en-GB">The only additional setting available is <strong class="bold" lang="">Display on signup page?</strong>. When self-registration is enabled, several default fields must be provided at signup. If a custom field should also be displayed on the signup page, the option must be set to <strong class="bold" lang="">Yes</strong>. This feature can be helpful in commercial training settings when additional information, such as the learner’s address or previous qualifications, is required.</li>
</ul>
<p lang="en-GB">To demonstrate how user profile fields work, let’s assume a school where you wish to extend the user profile with a new profile category called <strong class="bold" lang="">Parental responsibilities</strong> comprising fields such as <strong class="bold" lang="">Contact person</strong> and <strong class="bold" lang="">Relationship</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer118">
<img alt="Figure 5.6 – User profile fields example " height="382" src="image/Figure_5.06_B18779.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.6 – User profile fields example</p>
<p lang="en-GB">This completes the subsection dealing with custom user profile fields, extending standard user profiles. The third and last component of user profiles is user preferences, which we will cover next.</p>
<h2 id="_idParaDest-97" lang="en-GB"><a id="_idTextAnchor097"/>User preferences</h2>
<p lang="en-GB">Some more <a id="_idIndexMarker334"/>fields technically belong to the user profile, but they have been placed in the <strong class="bold" lang="">Preferences</strong> section, which can be accessed via the drop-down menu beside the user icon in the toolbar. The reason why this has been done is that you can disallow users from editing their profile altogether (via the <strong class="source-inline" lang="">moodle/user:editownprofile</strong> capability) and let them specify preferences via dedicated forms:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Preferred language</strong>: The default language of the system is shown and can be changed to the user’s preferred language. We will deal with localization in <a href="B18779_10.xhtml#_idTextAnchor204"><em class="italic" lang="">Chapter 10</em></a>, <em class="italic" lang="">Configuring Technical Features</em>.</li>
<li lang="en-GB"><strong class="bold" lang="">Forum preferences</strong>: <strong class="bold" lang="">Email digest type</strong> determines how a user receives posts from forums to which a subscription exists. There are three possible choices, which are <strong class="bold" lang="">No digest (single email per forum post)</strong>, which is the default, <strong class="bold" lang="">Complete (daily email with full posts)</strong>, or <strong class="bold" lang="">Subjects (daily email with subjects only)</strong>. The <strong class="bold" lang="">Forum auto-subscribe</strong> setting dictates whether users are automatically subscribed to forums to which they post. The <strong class="bold" lang="">Use experimental nested discussion view</strong> option makes available a new discussion view; at the time of print, the feature is still in trial mode.</li>
<li lang="en-GB">If <strong class="bold" lang="">Forum tracking</strong> is enabled, posts that have not yet been read will be highlighted, which improves forum usability. When sending forum post notifications, users can choose whether they should mark the post as read or not to impact forum tracking.</li>
<li lang="en-GB"><strong class="bold" lang="">Editor preferences</strong>: This option determines which editor should be used when entering information in text areas. Unless the user has special requirements or preferences, this should be left as the <strong class="bold" lang="">Default editor</strong> option. In <a href="B18779_07.xhtml#_idTextAnchor140"><em class="italic" lang="">Chapter 7</em></a>, <em class="italic" lang="">Enhancing Moodle’s Look and Feel</em>, you’ll learn more about editors.</li>
<li lang="en-GB"><strong class="bold" lang="">Calendar preferences</strong>: The user’s choice of calendar and event-related settings. Calendars will be discussed in a dedicated section in <a href="B18779_10.xhtml#_idTextAnchor204"><em class="italic" lang="">Chapter 10</em></a>, <em class="italic" lang="">Configuring Technical Features</em>.</li>
<li lang="en-GB"><strong class="bold" lang="">Content bank preferences</strong>: This setting determines the visibility of content the user has created (public or unlisted). We will cover content as part of the <em class="italic" lang="">H5P integration</em> section in <a href="B18779_08.xhtml#_idTextAnchor168"><em class="italic" lang="">Chapter 8</em></a>, <em class="italic" lang="">Understanding Moodle Plugins</em>.</li>
<li lang="en-GB"><strong class="bold" lang="">Message preferences</strong>: These settings control privacy and notification preferences. We will deal with messaging as part of the <em class="italic" lang="">Communications</em> section in <a href="B18779_10.xhtml#_idTextAnchor204"><em class="italic" lang="">Chapter 10</em></a>, <em class="italic" lang="">Configuring Technical Features</em>.</li>
<li lang="en-GB"><strong class="bold" lang="">Notification preferences</strong>: The user can choose the channels for different notification types. We will deal with messaging as part of the <em class="italic" lang="">Communications</em> section in <a href="B18779_10.xhtml#_idTextAnchor204"><em class="italic" lang="">Chapter 10</em></a>, <em class="italic" lang="">Configuring Technical Features</em>.</li>
</ul>
<p lang="en-GB">The default <a id="_idIndexMarker335"/>preferences of some settings (email, forums, and content bank) can be specified by navigating to <strong class="bold" lang="">Site administration | Users | Accounts | User default preferences</strong>.</p>
<p lang="en-GB">This completes the section on user profiles, where we covered standard and custom profile fields and briefly looked at various user preferences. Now that we know what a user profile looks like, let’s start interacting with users.</p>
<h1 id="_idParaDest-98" lang="en-GB"><a id="_idTextAnchor098"/>Performing standard user actions</h1>
<p lang="en-GB">So far, you have <a id="_idIndexMarker336"/>learned what type of user information Moodle holds and how to extend the data stored in each profile. Now, it is time to work with existing users on your system, which consists of browsing and filtering user accounts and applying bulk actions.</p>
<h2 id="_idParaDest-99" lang="en-GB"><a id="_idTextAnchor099"/>Browsing users</h2>
<p lang="en-GB">The quickest <a id="_idIndexMarker337"/>way to view your Moodle user accounts is by navigating to <strong class="bold" lang="">Site administration | Users | Accounts | Browse list of users</strong>. Initially, a list of users is displayed, ordered by <strong class="bold" lang="">First name</strong>. Thirty users are shown at a time, and, if applicable, you can navigate via the <strong class="bold" lang="">«</strong> and <strong class="bold" lang="">»</strong> links or jump directly to another page by selecting a number. Each column can be sorted in ascending or descending order by clicking on the column header.</p>
<div>
<div class="IMG---Figure" id="_idContainer119">
<img alt="Figure 5.7 – Browsing user accounts " height="662" src="image/Figure_5.07_B18779.jpg" width="1206"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.7 – Browsing user accounts</p>
<p lang="en-GB">You can <a id="_idIndexMarker338"/>view an individual’s profile by clicking on a user’s name. In addition to the fields we introduced in the first section of this chapter, you can see <strong class="bold" lang="">Login activity</strong> showing <strong class="bold" lang="">First access to site</strong>, <strong class="bold" lang="">Last access to site</strong>, and the <strong class="bold" lang="">Last IP address</strong> login took place from.</p>
<p lang="en-GB">You can specify which identity information (username, ID number, email address, phone numbers, department, institution, city, and country) about the users is shown in this list and other places. Go to <strong class="bold" lang="">Site administration | Users | Permissions | User policies</strong> and select the fields that should be shown in the <strong class="bold" lang="">Show user identity</strong> list. This only applies to users with the <strong class="source-inline" lang="">moodle/site:viewuseridentity</strong> capability.</p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">To masquerade as another user, use the <strong class="bold" lang="">Log in as</strong> option in a user’s profile.</p>
<p lang="en-GB">When you look at the profile of another user account, you will see a <strong class="bold" lang="">Log in as</strong> link in the <strong class="bold" lang="">Administration</strong> pane, which lets you masquerade as another user. This feature is useful when tracking down issues you cannot locate as an administrator. To view all the user profile fields of a user or modify any of them, as discussed earlier, click on the <strong class="bold" lang="">Edit profile</strong> link. To modify any of the user’s preferences, select the respective link.</p>
<p lang="en-GB">Go back to the user list and click on the standard <strong class="bold" lang="">Delete</strong> icon in the rightmost column to delete a user. A confirmation screen has to be answered before the user is irreversibly removed. Actually, the user is only removed from Moodle’s user interface. Internally, the user is retained in the database with the deleted flag turned on, which is necessary so <a id="_idIndexMarker339"/>that certain user contributions don’t disappear, for instance, forum posts. Technically, a user account can be reinstated by changing the delete flag manually in the database.</p>
<p lang="en-GB">To <strong class="bold" lang="">suspend</strong> a user account, toggle the <strong class="bold" lang="">Show/Hide</strong> icon, which triggers the account suspension, as discussed in the <em class="italic" lang="">User profile fields</em> section.</p>
<p lang="en-GB">Related to browsing accounts is filtering, which narrows down the number of user entries you are dealing with. This refinement mechanism is particularly helpful on sites with a large number of user accounts.</p>
<h2 id="_idParaDest-100" lang="en-GB"><a id="_idTextAnchor100"/>Filtering users</h2>
<p lang="en-GB">We may often be required to search for a particular user or a set of users. Moodle provides <a id="_idIndexMarker340"/>a flexible filtering mechanism to refine the list of displayed users. In basic mode, you can filter by the user’s full name, which is the first and last name combined. The following filter operations are available, all of which are case insensitive:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Contains</strong>: The provided text has to be contained in the field</li>
<li lang="en-GB"><strong class="bold" lang="">Doesn’t contain</strong>: This is the opposite of contains</li>
<li lang="en-GB"><strong class="bold" lang="">Is equal to</strong>: The provided text has to be the same as the value of the field</li>
<li lang="en-GB"><strong class="bold" lang="">Starts with</strong>: The field has to begin with the provided text</li>
<li lang="en-GB"><strong class="bold" lang="">Ends with</strong>: The field has to end with the provided text</li>
<li lang="en-GB"><strong class="bold" lang="">Is empty</strong>: The field has to be empty</li>
</ul>
<p lang="en-GB">For example, when adding a filter, such as <strong class="bold" lang="">User full name starts with “cl”</strong>, all users whose name begins with <em class="italic" lang="">cl</em> are displayed. Take a look at the following screenshot:</p>
<div>
<div class="IMG---Figure" id="_idContainer120">
<img alt="Figure 5.8 – Filtering user accounts I " height="657" src="image/Figure_5.08_B18779.jpg" width="1206"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.8 – Filtering user accounts I</p>
<p lang="en-GB">You can <a id="_idIndexMarker341"/>see that the added filter is now active, which becomes more useful once multiple filters have been added (switch to advanced mode via the <strong class="bold" lang="">Show more…</strong> link). Now, we can apply filters to a wide range of fields:</p>
<div>
<div class="IMG---Figure" id="_idContainer121">
<img alt="Figure 5.9 – Filtering user accounts II " height="883" src="image/Figure_5.09_B18779.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.9 – Filtering user accounts II</p>
<p lang="en-GB">For instance, in the <a id="_idIndexMarker342"/>preceding screenshot, we look for all users whose username starts with <strong class="bold" lang="">22</strong> (assuming the naming scheme starts with the year of entry) and whose account has been suspended. Using this mechanism, it is possible to add as many filters as required.</p>
<p lang="en-GB">Every time a filter is added, it will be shown in the <strong class="bold" lang="">Active filters</strong> frame and applied to the user data in Moodle.</p>
<div>
<div class="IMG---Figure" id="_idContainer122">
<img alt="Figure 5.10 – Filtering user accounts III " height="298" src="image/Figure_5.10_B18779.jpg" width="873"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.10 – Filtering user accounts III</p>
<p lang="en-GB">Here, three <a id="_idIndexMarker343"/>self-explanatory filters have been added. It is now possible to delete individual filters (select the filter and click on the <strong class="bold" lang="">Remove selected</strong> button) or <strong class="bold" lang="">Remove all filters</strong>.</p>
<p lang="en-GB">The filter criteria for text fields have been described earlier in this section. Depending on the field type, some additional operations can be used, as listed in the following table:</p>
<div>
<div class="IMG---Figure" id="_idContainer123">
<img alt="Figure 5.11 – Filtering operations " height="359" src="image/Figure_5.11_B18779.jpg" width="1211"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.11 – Filtering operations</p>
<p lang="en-GB">The <strong class="bold" lang="">Authentication</strong> criterion offers a selection of all the supported authentication methods. We will deal with these later in the chapter. If user profile fields have been specified, an additional <strong class="bold" lang="">User profile fields</strong> criterion is shown, offering a choice of all the user-defined fields (as specified earlier).</p>
<p lang="en-GB">The current filter settings are saved and can be used the next time you log in. Not only that but they are also saved for bulk user actions, which are covered in the next section.</p>
<h2 id="_idParaDest-101" lang="en-GB"><a id="_idTextAnchor101"/>Bulk user actions</h2>
<p lang="en-GB">Bulk actions allow an administrator to perform a single action on multiple users, for example, forcing <a id="_idIndexMarker344"/>a password to change or sending a message. To illustrate how bulk user actions work, have a look at the user actions funnel depicted in the following diagram:</p>
<div>
<div class="IMG---Figure" id="_idContainer124">
<img alt="Figure 5.12 – Bulk user actions funnel " height="802" src="image/Figure_5.12_B18779.jpg" width="1220"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.12 – Bulk user actions funnel</p>
<p lang="en-GB">The three <a id="_idIndexMarker345"/>layers of the funnel have the following characteristics:</p>
<ul>
<li lang="en-GB">The top layer shows all users in the system (tenant in Moodle Workplace)</li>
<li lang="en-GB">The middle layer contains all users after active filters have been applied</li>
<li lang="en-GB">The bottom layer comprises any users left after you have narrowed down the list by selecting users manually</li>
</ul>
<p lang="en-GB">Various bulk actions can then be applied to this group of chosen user accounts by going to <strong class="bold" lang="">Site administration | Users | Accounts | Bulk user actions</strong>.</p>
<div>
<div class="IMG---Figure" id="_idContainer125">
<img alt="Figure 5.13 – Bulk user actions I " height="1295" src="image/Figure_5.13_B18779.jpg" width="1184"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.13 – Bulk user actions I</p>
<p lang="en-GB">The screen <a id="_idIndexMarker346"/>contains three main sections. The first two parts are the familiar <strong class="bold" lang="">New filter</strong> and <strong class="bold" lang="">Active filters</strong> sections. Interestingly, filters already created will also show up on this screen since they have been saved.</p>
<p lang="en-GB">The third part displays the users that match the specified filter criteria in the <strong class="bold" lang="">All filtered</strong> list. Before you can do anything with the users, you must move them to the <strong class="bold" lang="">All selected</strong> list using the <strong class="bold" lang="">Add to selection</strong> button. In the preceding screenshot, all users except one have been moved across. To move them back to the <strong class="bold" lang="">All filtered</strong> list, select the users and click the <strong class="bold" lang="">Remove from selection</strong> button. Two shortcut buttons exist, which allow you to add all users from the <strong class="bold" lang="">All filtered</strong> list to the <strong class="bold" lang="">All selected</strong> list and use <strong class="bold" lang="">Remove all</strong> to move them in the opposite direction.</p>
<p lang="en-GB">The advantage of this approach is that you can apply several filters in succession and select the <a id="_idIndexMarker347"/>respective users, for example, in a setting where the usernames start with the year of entry. Suppose you wish to select all the users from 2022 and 2023, filter for all usernames that start with <strong class="bold" lang="">22</strong>, and select all the entries that show up in the results. You can then delete the filter and repeat the filtering with the value <strong class="source-inline" lang="">23</strong>.</p>
<p lang="en-GB">When the <strong class="bold" lang="">Go</strong> button for the <strong class="bold" lang="">With selected users...</strong> drop-down menu is clicked, the operation selected will be performed on the users from the <strong class="bold" lang="">All selected</strong> list. The available operations are shown in the following table:</p>
<div>
<div class="IMG---Figure" id="_idContainer126">
<img alt="Figure 5.14 – Bulk user actions II " height="479" src="image/Figure_5.14_B18779.jpg" width="1208"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.14 – Bulk user actions II</p>
<p lang="en-GB">Now that we know how to deal with existing users, let’s look at how they are added to the system.</p>
<h1 id="_idParaDest-102" lang="en-GB"><a id="_idTextAnchor102"/>Creating user accounts manually</h1>
<p lang="en-GB">There are <a id="_idIndexMarker348"/>two ways to manually create accounts for users to get access to your system:</p>
<ul>
<li lang="en-GB">Adding individual users</li>
<li lang="en-GB">Uploading users in bulk, including their user pictures</li>
</ul>
<p lang="en-GB">In the following three sections, you will learn how to perform and support each type.</p>
<h2 id="_idParaDest-103" lang="en-GB"><a id="_idTextAnchor103"/>Adding individual users</h2>
<p lang="en-GB">To add <a id="_idIndexMarker349"/>user accounts manually, go to <strong class="bold" lang="">Site administration | Users | Accounts | Add a new user</strong>. Alternatively, you can navigate the list of users and select the <strong class="bold" lang="">Add a new user</strong> button at the bottom of the screen. You will see the same form you saw earlier when you edited the user’s profile.</p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">Adding users manually should be the exception, not the rule. It is highly recommended to automate the process.</p>
<p lang="en-GB">You should avoid adding individual users manually as much as possible, as it is a very time-consuming, cumbersome, and potentially error-prone procedure. However, there are situations when you cannot avoid it, for example, when a student joins a school halfway through the term or an external trainer requires access to Moodle but is not part of the organization’s staff database.</p>
<p lang="en-GB">If you have more than one user to add, use Moodle’s batch uploading facility, which we will look at next.</p>
<h2 id="_idParaDest-104" lang="en-GB"><a id="_idTextAnchor104"/>Bulk uploading and updating user data</h2>
<p lang="en-GB">Uploading <a id="_idIndexMarker350"/>users in bulk allows importing <a id="_idIndexMarker351"/>multiple user accounts from a text file or updating <a id="_idIndexMarker352"/>user accounts that already exist in your system.</p>
<p lang="en-GB">Learner information is often available in existing applications, such as the internal student management information system or HR database, which can export data to an Excel spreadsheet or directly to a text file. The data represented in the CSV file is then loaded to <a id="_idIndexMarker353"/>the Moodle database, and, if specified, users <a id="_idIndexMarker354"/>are enrolled in courses and added as members to cohorts. This process is shown in the following workflow diagram:</p>
<div>
<div class="IMG---Figure" id="_idContainer127">
<img alt="Figure 5.15 – Bulk user upload " height="383" src="image/Figure_5.15_B18779.jpg" width="998"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.15 – Bulk user upload</p>
<p lang="en-GB">You will <a id="_idIndexMarker355"/>find excellent and detailed instructions on uploading and updating users in batch mode at <a href="http://docs.moodle.org/en/Upload_users">docs.moodle.org/en/Upload_users</a>. We will focus on the key elements and upload workflows to supplement the well-documented feature.</p>
<h3 lang="en-GB">The text file format</h3>
<p lang="en-GB">Before <a id="_idIndexMarker356"/>uploading users, you must generate a text file <a id="_idIndexMarker357"/>conforming to a specific format. Its general format is a <strong class="bold" lang="">Comma Separated Value</strong> (<strong class="bold" lang="">CSV</strong>) file, a <a id="_idIndexMarker358"/>flat text file format. While creating CSV files manually (using a plain text editor or a spreadsheet application) is possible, the files are usually generated automatically by a system hosting the user data.</p>
<p lang="en-GB">The format of a text file is as follows:</p>
<ul>
<li lang="en-GB">Each line of the file must contain a single record</li>
<li lang="en-GB">Each record must be a series of data that are separated by delimiters</li>
<li lang="en-GB">The first record of the file must contain the list of field names defining the structure of the rest of the file</li>
</ul>
<p lang="en-GB">An example <a id="_idIndexMarker359"/>of a valid input file is as follows:</p>
<p lang="en-GB"><strong class="source-inline" lang="">username, password, firstname, lastname, email</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">galmond, pwd, Graham, Almond, galmond@openumlaut.com</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">earmstrong, pwd, Eleanor, Armstrong, earmstrong@openumlaut.com</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">jarnold, pwd, Joanne, Arnold, jarnold@openumlaut.com</strong></p>
<p lang="en-GB">The first line contains the list of provided fields, while the remaining three lines represent individual users to be uploaded.</p>
<p lang="en-GB">Moodle’s upload function supports the following types of data fields:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Required</strong>: Compulsory fields that must be included</li>
<li lang="en-GB"><strong class="bold" lang="">Password</strong>: Password fields</li>
<li lang="en-GB"><strong class="bold" lang="">Optional</strong>: If no value is provided, specified default values will be used</li>
<li lang="en-GB"><strong class="bold" lang="">Custom</strong>: User-defined profile fields</li>
<li lang="en-GB"><strong class="bold" lang="">Enrolment</strong>: Dealing with courses, roles, and groups</li>
<li lang="en-GB"><strong class="bold" lang="">Cohort</strong>: Adding users as members to cohorts</li>
<li lang="en-GB"><strong class="bold" lang="">System</strong>: Assigning and unassigning system roles to and from users</li>
<li lang="en-GB"><strong class="bold" lang="">Special</strong>: Modifying and deleting user accounts</li>
</ul>
<p lang="en-GB">We will be going through each field type to understand better how Moodle’s user batch upload works and how you can use it in your setting.</p>
<h4 lang="en-GB">Required fields</h4>
<p lang="en-GB">When <a id="_idIndexMarker360"/>adding new users, only <strong class="source-inline" lang="">firstname</strong> and <strong class="source-inline" lang="">lastname</strong> are compulsory. When updating records, only <strong class="source-inline" lang="">username</strong> is required. You might recall that the user profile has a few more compulsory fields, such as the username or email address. A default value must be specified via a template if these fields are not provided. We will deal with templates later in this chapter.</p>
<p lang="en-GB">The sample file is an example of an input file containing five fields, including the required <strong class="source-inline" lang="">firstname</strong> and <strong class="source-inline" lang="">lastname</strong>.</p>
<h4 lang="en-GB">Password</h4>
<p lang="en-GB">The <strong class="source-inline" lang="">password</strong> value <a id="_idIndexMarker361"/>is required unless <strong class="bold" lang="">Create password if needed and send via email</strong> has been enabled. If this is the case, a welcome email with a one-off password will be sent to the respective user the next time the <strong class="source-inline" lang="">cron</strong> process runs.</p>
<p class="callout-heading" lang="en-GB">Note</p>
<p class="callout" lang="en-GB">If you set <strong class="source-inline" lang="">password</strong> to <strong class="source-inline" lang="">changeme</strong>, the user will be forced to change the password when they log in for the first time. A better way to do this is using the <strong class="bold" lang="">Force password change</strong> option.</p>
<h4 lang="en-GB">Optional fields</h4>
<p lang="en-GB">As the name <a id="_idIndexMarker362"/>suggests, optional fields do not have to be specified—if they are not included in the text file, default values are taken, if present. These optional fields are as follows:</p>
<div>
<div class="IMG---Figure" id="_idContainer128">
<img alt="Figure 5.16 – User upload (optional fields) " height="693" src="image/Figure_5.16_B18779.jpg" width="1211"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.16 – User upload (optional fields)</p>
<p lang="en-GB">It is crucial to include empty fields when the default setting has to be used. These must be left <a id="_idIndexMarker363"/>empty even if it is the last field in each record. An empty field is represented by two consecutive commas, as shown in the sample file:</p>
<p lang="en-GB"><strong class="source-inline" lang="">username, password, firstname, lastname, email, city</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">galmond, changeme, Graham, Almond, galmond@openumlaut.com, Kyiv</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">earmstrong, , Eleanor, Armstrong, ermstrong@openumlaut.com,</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">jarnold, , Joanne, Arnold, jrnold@openumlaut.com, Doha</strong></p>
<p lang="en-GB">A <strong class="source-inline" lang="">city</strong> field has been added in the preceding sample file, and the default city has been set to <strong class="bold" lang="">Paris</strong>. After uploading the file, the <strong class="source-inline" lang="">city</strong> value for <strong class="bold" lang="">Graham Almond</strong> is set to <strong class="bold" lang="">Kyiv</strong>, and that for <strong class="bold" lang="">Joanne Arnold</strong> is set to <strong class="bold" lang="">Doha</strong>. The <strong class="source-inline" lang="">city</strong> value for <strong class="bold" lang="">Eleanor</strong> <strong class="bold" lang="">Armstrong</strong> has been left empty and will be set to the default value of <strong class="bold" lang="">Paris</strong>. Some <strong class="source-inline" lang="">password</strong> fields have also been left empty.</p>
<h4 lang="en-GB">Custom profile fields</h4>
<p lang="en-GB">Any <a id="_idIndexMarker364"/>user-defined fields you have specified (in our case, those for parental responsibilities) can also be used as part of the batch upload process. Each field must be preceded by <strong class="source-inline" lang="">profile_field_</strong>; for instance, the field representing the Skype ID would be labeled <strong class="source-inline" lang="">profile_field_skype_id</strong>.</p>
<p lang="en-GB">Custom fields are treated in precisely the same way as optional fields. If specified, the values are taken; otherwise, default values will be used, if present.</p>
<h4 lang="en-GB">Enrolment fields</h4>
<p lang="en-GB">Enrolment <a id="_idIndexMarker365"/>fields allow you to assign roles to users; you can enrol them in courses and assign them to groups. Roles will be covered in detail in <a href="B18779_06.xhtml#_idTextAnchor116"><em class="italic" lang="">Chapter 6</em></a>, <em class="italic" lang="">Managing Permissions, Roles, and Capabilities</em>.</p>
<p lang="en-GB">Each course has to be specified separately by <strong class="source-inline" lang="">course1</strong>, <strong class="source-inline" lang="">course2</strong>, <strong class="source-inline" lang="">course3</strong>, and so on. The course name is the course’s short name and the only compulsory enrolment field. Each corresponding type, role, group, enrolment start time, enrolment period, and enrolment status must have the same postfix: <strong class="source-inline" lang="">type1</strong>, <strong class="source-inline" lang="">role1</strong>, <strong class="source-inline" lang="">group1</strong>, <strong class="source-inline" lang="">enroltimestart1</strong>, <strong class="source-inline" lang="">enrolperiod1</strong>, and <strong class="source-inline" lang="">enrolstatus1</strong> correspond to <strong class="source-inline" lang="">course1</strong>.</p>
<p lang="en-GB">It is further possible to set a user’s role in a course. Each role has a role short name and a role ID, either of which can be specified. If the type is left blank or no course is specified, the user will be enrolled as a student. The enrolment period sets the enrolment duration in terms of days; the enrolment status suspends a user from a course when it’s set to <strong class="source-inline" lang="">1</strong>.</p>
<p lang="en-GB">If you want to assign users to groups in a course (<strong class="source-inline" lang="">group1</strong> in <strong class="source-inline" lang="">course1</strong>, <strong class="source-inline" lang="">group2</strong> in <strong class="source-inline" lang="">course2</strong>, and so on), you have to specify the group name or ID. If a specified group does not exist, it will be created automatically.</p>
<p lang="en-GB">The following example demonstrates some of the enrolment features:</p>
<p lang="en-GB"><strong class="source-inline" lang="">username, course1, role1, course2</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">galmond, Advanced, editingteacher, Staff</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">earmstrong, Advanced, examiner, Staff</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">jarnold, Basic, 3, Staff</strong></p>
<p lang="en-GB">The <strong class="source-inline" lang="">course1</strong> field and <a id="_idIndexMarker366"/>its corresponding <strong class="source-inline" lang="">role1</strong> and <strong class="source-inline" lang="">course2</strong> are optional enrolment fields. Graham Almond (<strong class="source-inline" lang="">galmond</strong>) will be assigned the <strong class="source-inline" lang="">editingteacher</strong> role in the <strong class="source-inline" lang="">Advanced</strong> course, and Eva Armstrong (<strong class="source-inline" lang="">earmstrong</strong>) will be assigned the <strong class="source-inline" lang="">examiner</strong> role. Jonny Arnold (<strong class="source-inline" lang="">jarnold</strong>) will be <strong class="source-inline" lang="">editingteacher</strong> (the role ID is <strong class="source-inline" lang="">3</strong>) in the <strong class="source-inline" lang="">Basic</strong> course. All three users will be assigned the <strong class="source-inline" lang="">student</strong> role in the <strong class="source-inline" lang="">Staff</strong> course (no role has been specified, hence the default is set).</p>
<h4 lang="en-GB">Cohort fields</h4>
<p lang="en-GB">Cohort fields <a id="_idIndexMarker367"/>allow you to add users as members to cohorts. Like enrolments and groups in courses, the field name has to be suffixed by a counter: <strong class="source-inline" lang="">cohort1</strong>, <strong class="source-inline" lang="">cohort2</strong>, and so on. An example file snippet is as follows:</p>
<p lang="en-GB"><strong class="source-inline" lang="">username, firstname, lastname, cohort1, cohort2</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">pupil1, Pupil, One, 7a, drama</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">pupil2, Pupil, Two, 7a, archery</strong></p>
<p lang="en-GB">Users can be added to system cohorts as well as context cohorts. Cohorts will be dealt with after this main section.</p>
<h4 lang="en-GB">System role</h4>
<p lang="en-GB">If you need <a id="_idIndexMarker368"/>to assign users a system role, you must specify this via <strong class="source-inline" lang="">sysrole1</strong>, <strong class="source-inline" lang="">sysrole2</strong>, and so on. The field’s value has to be <strong class="source-inline" lang="">shortname</strong> of the role, for instance, <strong class="source-inline" lang="">manager</strong> or <strong class="source-inline" lang="">coursecreator</strong>.</p>
<p lang="en-GB">You can also unassign a system role from a user by preceding the role name with the minus symbol, for example, <strong class="source-inline" lang="">-manager</strong> or <strong class="source-inline" lang="">-coursecreator</strong>.</p>
<h4 lang="en-GB">Special fields</h4>
<p lang="en-GB">The following <a id="_idIndexMarker369"/>special fields are supported:</p>
<ul>
<li lang="en-GB"><strong class="source-inline" lang="">oldusername</strong>: When changing a username, you must provide the current value</li>
<li lang="en-GB"><strong class="source-inline" lang="">deleted</strong>: When removing a user, you will set <strong class="source-inline" lang="">deleted</strong> to <strong class="source-inline" lang="">1</strong></li>
<li lang="en-GB"><strong class="source-inline" lang="">suspended</strong>: When suspending a user, set <strong class="source-inline" lang="">suspended</strong> to <strong class="source-inline" lang="">1</strong>; to activate, set it to <strong class="source-inline" lang="">0</strong></li>
</ul>
<p lang="en-GB">Special fields are the last category of text file format. Once you have created your user file, it is time to upload users to Moodle, which we will tackle next.</p>
<h3 lang="en-GB">Uploading users</h3>
<p lang="en-GB">Uploading <a id="_idIndexMarker370"/>users is a four-step process, as shown in the following diagram:</p>
<div>
<div class="IMG---Figure" id="_idContainer129">
<img alt="Figure 5.17 – User upload workflow " height="631" src="image/Figure_5.17_B18779.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.17 – User upload workflow</p>
<p lang="en-GB">The workflow comprises the following four steps:</p>
<ol>
<li lang="en-GB">Creating or generating the CSV file</li>
<li lang="en-GB">Uploading the file, specifying metadata, and viewing the data preview</li>
<li lang="en-GB">Configuring upload settings and default values</li>
<li lang="en-GB">Checking upload results</li>
</ol>
<p lang="en-GB">We already covered <em class="italic" lang="">step 1</em> in the previous subsection, so let’s jump straight to the second and <a id="_idIndexMarker371"/>third phases. To upload or update users in batch mode, go to <strong class="bold" lang="">Site administration | Users | Accounts | Upload users,</strong> where the following settings are available:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">File</strong>: The name of the text file.</li>
<li lang="en-GB"><strong class="bold" lang="">CSV delimiter</strong>: Specify whether the delimiter is a comma (default), semicolon, colon, or tab. In most European locales, for instance, German, French, and Dutch, the default delimiter is a semicolon!</li>
<li lang="en-GB"><strong class="bold" lang="">Encoding</strong>: The encoding scheme of your uploaded file specifies the locale in which it has been saved (the default is <strong class="bold" lang="">UTF-8</strong>).</li>
<li lang="en-GB"><strong class="bold" lang="">Preview rows</strong>: The number of rows displayed on the preview screen.</li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer130">
<img alt="Figure 5.18 – Upload users configuration " height="588" src="image/Figure_5.18_B18779.jpg" width="1219"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.18 – Upload users configuration</p>
<p lang="en-GB">Once this screen has been confirmed, you will see the following four sections:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Upload users</strong> preview: A sneak peek of the specified number of rows that will be uploaded. Records that are to be skipped will not be shown.</li>
<li lang="en-GB"><strong class="bold" lang="">Settings</strong>: Different options, which depend on the selected upload type.</li>
<li lang="en-GB"><strong class="bold" lang="">Default values</strong>: All the user fields for which default values can be set.</li>
<li lang="en-GB"><strong class="bold" lang="">Custom values</strong>: Any user-defined fields grouped by category, if present.</li>
</ul>
<p lang="en-GB">Remember that <a id="_idIndexMarker372"/>not all settings exist for all upload types; they will remain hidden if they are not applicable. The following table shows which settings are available for which upload type:</p>
<div>
<div class="IMG---Figure" id="_idContainer131">
<img alt="Figure 5.19 – Upload users settings " height="649" src="image/Figure_5.19_B18779.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.19 – Upload users settings</p>
<p lang="en-GB">Here is <a id="_idIndexMarker373"/>a brief description of each <strong class="bold" lang="">Upload users</strong> setting:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">New user password</strong>: Moodle requires either a password in the file (<strong class="bold" lang="">Field required in file</strong>) or the <strong class="source-inline" lang="">cron</strong> process will generate a one-off password automatically if none is specified (<strong class="bold" lang="">Create password if needed and send via email</strong>).</li>
<li lang="en-GB"><strong class="bold" lang="">Existing user details</strong>: Specifies what action is performed on the existing user details when an account is updated. The options are <strong class="bold" lang="">No changes</strong>, <strong class="bold" lang="">Override with file</strong>, <strong class="bold" lang="">Override with file and defaults</strong>, and <strong class="bold" lang="">Fill in missing [fields] from file and defaults</strong>.</li>
<li lang="en-GB"><strong class="bold" lang="">Existing user password</strong>: Specifies what happens with users’ passwords when the user details are updated. The password can be left unchanged (<strong class="bold" lang="">No changes</strong>) or overridden (<strong class="bold" lang="">Update</strong>).</li>
<li lang="en-GB"><strong class="bold" lang="">Force password change</strong>: Specifies when to tag accounts requiring users to change the password (<strong class="bold" lang="">Users having a weak password</strong>, <strong class="bold" lang="">None</strong>, and <strong class="bold" lang="">All</strong>).</li>
<li lang="en-GB"><strong class="bold" lang="">Allow renames</strong>: Specifies whether the changing of usernames is allowed. This only applies to the special <strong class="source-inline" lang="">oldusername</strong> field.</li>
<li lang="en-GB"><strong class="bold" lang="">Allow deletes</strong>: Specifies whether removing user accounts is allowed. This only applies to the special <strong class="source-inline" lang="">deleted</strong> field.</li>
<li lang="en-GB"><strong class="bold" lang="">Allow suspending or activating of accounts</strong>: Specifies whether deactivating <a id="_idIndexMarker374"/>or activating user accounts s is allowed. This only applies to the special <strong class="source-inline" lang="">suspended</strong> field.</li>
<li lang="en-GB"><strong class="bold" lang="">Prevent email address duplicates</strong>: Multiple users can have the same email address (as discussed in the <em class="italic" lang="">Understanding user profiles</em> section). This setting will only show if <strong class="bold" lang="">Allow accounts with same email</strong> on <strong class="bold" lang="">Site administration | Plugins | Authentication | Manage authentication</strong> is enabled.</li>
<li lang="en-GB"><strong class="bold" lang="">Standardise usernames</strong>: Removes any invalid characters from usernames (extended characters, unless allowed, as well as spaces) and ensures that all characters are lowercase.</li>
<li lang="en-GB"><strong class="bold" lang="">Select for bulk user operations</strong>: You can specify whether <strong class="bold" lang="">New users</strong>, <strong class="bold" lang="">Updated users</strong>, or <strong class="bold" lang="">All users</strong> should be selected for bulk operations. You will see the names in the user list for <strong class="bold" lang="">Bulk user actions</strong>.</li>
</ul>
<p lang="en-GB">Default values have been mentioned a few times so far; now, it is time to deal with them alongside templates.</p>
<h3 lang="en-GB">Setting default values and templates</h3>
<p lang="en-GB">Moodle’s user batch upload function supports default values that are used if no value has been <a id="_idIndexMarker375"/>set. Default values cover all user profile fields that can be uploaded as well as user-defined custom fields.</p>
<p lang="en-GB">Each text-based field can be populated using a template. This feature is helpful for optional fields, such as the URL of students’ websites, and is compulsory for required fields if they’re not specified in the CSV file, for example, <strong class="source-inline" lang="">username</strong> and <strong class="source-inline" lang="">email</strong>. Moodle will warn you if the latter is the case. For example, in the following screenshot, <strong class="bold" lang="">Username template</strong> has not been provided, which is indicated by the red warning message:</p>
<div>
<div class="IMG---Figure" id="_idContainer132">
<img alt="Figure 5.20 – Template missing " height="225" src="image/Figure_5.20_B18779.jpg" width="1052"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.20 – Template missing</p>
<p lang="en-GB">The template (or pattern) will create a value based on the values of other fields and the standard characters you specify. A template can comprise the following content:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Replacement values</strong>: The <a id="_idIndexMarker376"/>value is substituted by the corresponding profile field</li>
<li lang="en-GB"><strong class="bold" lang="">Template modifiers</strong>: The value <a id="_idIndexMarker377"/>is converted or truncated based on the modifier</li>
<li lang="en-GB"><strong class="bold" lang="">Standard text</strong>: Plain text is <a id="_idIndexMarker378"/>included without any modification</li>
</ul>
<p lang="en-GB">The following table hopefully clarifies the preceding concepts:</p>
<div>
<div class="IMG---Figure" id="_idContainer133">
<img alt="Figure 5.21 – Template content " height="596" src="image/Figure_5.21_B18779.jpg" width="1039"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.21 – Template content</p>
<p lang="en-GB">There are <a id="_idIndexMarker379"/>four replacement values, indicated by a percentage. For example, if the username should be the first name of a user, followed by a period, and then the surname, the template would look like <strong class="source-inline" lang="">%f.%l</strong>.</p>
<p lang="en-GB">Four modifiers can be included between the <strong class="source-inline" lang="">%</strong> sign and any of the three code letters (<strong class="source-inline" lang="">l</strong>, <strong class="source-inline" lang="">f</strong>, and <strong class="source-inline" lang="">u</strong>), where the hash represents a decimal number. The last template is an example embedding the replacement values inside other text; in this case, it is a URL representing a user’s home page.</p>
<p lang="en-GB">This completes the third step of our user upload workflow. The last step is to load and review the actual user data.</p>
<h3 lang="en-GB">Loading of data</h3>
<p lang="en-GB">Once all the <a id="_idIndexMarker380"/>settings have been specified, the default values have been provided, and the <strong class="bold" lang="">Upload users</strong> button has been pressed, Moodle will finally start the actual importing process.</p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">It is highly recommended that you create a test file with a smaller number of dummy records first to ensure that the syntax is correct.</p>
<p lang="en-GB">Moodle displays a large table that contains all the user fields that have been added and/or changed. It also shows the status of each field, including any problems or errors that have occurred.</p>
<p lang="en-GB">A message is <a id="_idIndexMarker381"/>displayed at the end of the results screen, summarizing the upload process. It contains the number of users created and updated, those with a weak password (according to the password policy), and the number of errors. Take a look at the following screenshot:</p>
<div>
<div class="IMG---Figure" id="_idContainer134">
<img alt="Figure 5.22 – Reviewing upload results " height="643" src="image/Figure_5.22_B18779.jpg" width="1208"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.22 – Reviewing upload results</p>
<p lang="en-GB">It is recommended that you immediately identify invalid user accounts and modify their user settings manually or fix the upload file and do a re-run.</p>
<p lang="en-GB">Bulk user operations provide a versatile means to create and update textual user data. However, one type of user information that CSV files cannot process exists: profile images. Moodle comes with a dedicated feature that deals with user pictures. Let’s take a look at it in the next section.</p>
<h2 id="_idParaDest-105" lang="en-GB"><a id="_idTextAnchor105"/>Uploading user pictures</h2>
<p lang="en-GB">As described so far, the process of uploading users does not support profile images; instead, user <a id="_idIndexMarker382"/>pictures must be uploaded separately. The workflow to upload user images is simple yet effective, as depicted <a id="_idIndexMarker383"/>in the following diagram:</p>
<div>
<div class="IMG---Figure" id="_idContainer135">
<img alt="Figure 5.23 – User pictures upload workflow " height="290" src="image/Figure_5.23_B18779.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.23 – User pictures upload workflow</p>
<p lang="en-GB">The upload user picture tool can be found at <strong class="bold" lang="">Site administration | Users | Accounts | Upload user pictures</strong>. The images to be uploaded have to be archived in a ZIP file. Each image filename inside the compressed file must conform to the following format: <strong class="source-inline" lang="">attribute.ext</strong>.</p>
<p lang="en-GB">The <strong class="bold" lang="">User attribute to use to match pictures</strong> field is set to any of these values: <strong class="bold" lang="">username</strong>, <strong class="bold" lang="">idnumber</strong>, or (the internal user) <strong class="bold" lang="">id</strong>. This attribute is used to match the picture to an existing user, and you have to select the attribute in the respective pull-down menu. <strong class="source-inline" lang="">ext</strong> is the filename extension (<strong class="source-inline" lang="">.jpg</strong>, <strong class="source-inline" lang="">.gif</strong> or <strong class="source-inline" lang="">.png</strong>). The image filenames are not case sensitive.</p>
<div>
<div class="IMG---Figure" id="_idContainer136">
<img alt="Figure 5.24 – Upload user pictures " height="746" src="image/Figure_5.24_B18779.jpg" width="890"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.24 – Upload user pictures</p>
<p lang="en-GB">For example, if the username consists of the first name’s initial and a surname (<strong class="source-inline" lang="">%1f%l</strong>, if expressed <a id="_idIndexMarker384"/>in template style), the valid filenames are <strong class="source-inline" lang="">psmith.png</strong>, <strong class="source-inline" lang="">lcohen.png</strong>, and <strong class="source-inline" lang="">mstripe.png</strong>. If the users exist, the <a id="_idIndexMarker385"/>pictures will be added to their profiles; otherwise, they will be ignored. If a picture already exists for a user, it will only be replaced if you have enabled the <strong class="bold" lang="">Overwrite existing user pictures?</strong> option.</p>
<p lang="en-GB">So far, we have only looked at individual users on an account-by-account basis. Moodle thrives on being a learning system that supports communication and collaboration among learners and teachers. To support working together, users can be arranged in two ways: groups and groupings at the course level, and cohorts at the system or category level. We have already come across groups in the previous chapter and during the user batch upload, so let’s have a closer look at cohorts now.</p>
<h1 id="_idParaDest-106" lang="en-GB"><a id="_idTextAnchor106"/>Managing cohorts</h1>
<p lang="en-GB">We have <a id="_idIndexMarker386"/>already come across cohorts in <a href="B18779_04.xhtml#_idTextAnchor074"><em class="italic" lang="">Chapter 4</em></a>, <em class="italic" lang="">Managing Courses and Enrolment</em>, and in the introductory diagram of this chapter.</p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">Cohorts are groups that are used to logically cluster related users.</p>
<p lang="en-GB">So far, we mainly mentioned cohorts in the context of enrolments; however, cohorts are utilized by Moodle in various places, such as the following:</p>
<ul>
<li lang="en-GB">Course enrolments and synchronization</li>
<li lang="en-GB">Cohort themes provide a user experience to a pre-defined group of users, for example, visually impaired learners</li>
<li lang="en-GB">Report audiences to limit access of a report to cohorts</li>
<li lang="en-GB">Execute actions automatically, such as notifying or issuing a certificate to a cohort as part of dynamic rules (Moodle Workplace only)</li>
</ul>
<p lang="en-GB">Zooming in <a id="_idIndexMarker387"/>on the cohort element, we can see its structure and properties:</p>
<div>
<div class="IMG---Figure" id="_idContainer137">
<img alt="Figure 5.25 – Cohorts (high-level) " height="789" src="image/Figure_5.25_B18779.jpg" width="1154"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.25 – Cohorts (high-level)</p>
<p lang="en-GB">Let’s have a closer look at how to create and manage cohorts. To do this, navigate to <strong class="bold" lang="">Site administration | Users | Accounts | Cohorts</strong>.</p>
<div>
<div class="IMG---Figure" id="_idContainer138">
<img alt="Figure 5.26 – Available cohorts " height="505" src="image/Figure_5.26_B18779.jpg" width="1206"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.26 – Available cohorts</p>
<p lang="en-GB">The details <a id="_idIndexMarker388"/>of each cohort and its standard actions (hide, delete, edit, and assign) are provided. The <strong class="bold" lang="">All cohorts</strong> tab provides an almost identical view, displaying system and category cohorts.</p>
<p lang="en-GB">To create a cohort, select the <strong class="bold" lang="">Add new cohort</strong> tab and specify the cohort’s properties. <strong class="bold" lang="">Context</strong> is the scope of the cohort that indicates where the cohort can be used; the options are <strong class="bold" lang="">System</strong> (global or site-wide) and a selected category. <strong class="bold" lang="">Cohort ID</strong> is optional, but it is good practice to set this as it will be used for different operations, such as when adding bulk users.</p>
<div>
<div class="IMG---Figure" id="_idContainer139">
<img alt="Figure 5.27 – Adding a cohort " height="598" src="image/Figure_5.27_B18779.jpg" width="1200"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.27 – Adding a cohort</p>
<p lang="en-GB">Once you <a id="_idIndexMarker389"/>have added a cohort, you will return to the list of all cohorts. Now, you should add members to it by selecting the <strong class="bold" lang="">Assign</strong> icon, which will display the familiar user selection screen to add or remove cohort memberships.</p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">Removing users from a cohort will unenrol them from all courses where cohort synchronization has been enabled!</p>
<p lang="en-GB">Instead of adding cohorts manually, you can perform this task in a batch via the <strong class="bold" lang="">Upload cohorts</strong> tab. The principle is the same as adding users in batch mode, as described in the previous section. Here is a sample file representing the cohorts used earlier:</p>
<p lang="en-GB"><strong class="source-inline" lang="">name, contextid, idnumber, description, visible</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">7a, 1, 7a, All students from class 7a, 1</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">7b, 1, 7b, All students from class 7b, 1</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">7c, 1, 7c, All students from class 7c, 1</strong></p>
<p lang="en-GB"><strong class="source-inline" lang="">Temp, , , Used as a placeholder, 0</strong></p>
<p lang="en-GB">You can find details on uploading cohorts, including optional and additional fields, at <a href="http://docs.moodle.org/en/Upload_cohorts">docs.moodle.org/en/Upload_cohorts</a>.</p>
<p lang="en-GB">Now that <a id="_idIndexMarker390"/>you know everything about user accounts and the information stored about them, let’s look at how to authenticate them with Moodle.</p>
<h1 id="_idParaDest-107" lang="en-GB"><a id="_idTextAnchor107"/>Configuring user authentication</h1>
<p lang="en-GB">Authentication is the process of getting access to a system. Moodle supports a significant <a id="_idIndexMarker391"/>number of authentication types. Furthermore, Moodle supports <strong class="bold" lang="">multi-authentication</strong>, that is, concurrent authentication <a id="_idIndexMarker392"/>from different authentication sources. For example, your organization might use an LDAP server containing user information for all your staff, and OAuth2 for students, but it wishes to manage part-time users locally.</p>
<p lang="en-GB">In the second half of this chapter, we will explore user authentication and the overall management of authentication plugins before covering common authentication settings. Then, we will deal with all authentication methods, which have been grouped into four categories: internal, external, provider, and system.</p>
<h2 id="_idParaDest-108" lang="en-GB"><a id="_idTextAnchor108"/>Exploring user authentication</h2>
<p lang="en-GB">Remember the <a id="_idIndexMarker393"/>basic authentication workflow we looked at in <a href="B18779_03.xhtml#_idTextAnchor059"><em class="italic" lang="">Chapter 3</em></a>, <em class="italic" lang="">Exploring Courses, Users, and Roles</em>. Now, we can have a look at a more complete picture, as shown in the following diagram:</p>
<div>
<div class="IMG---Figure" id="_idContainer140">
<img alt="Figure 5.28 – Authentication workflow " height="546" src="image/Figure_5.28_B18779.jpg" width="1186"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.28 – Authentication workflow</p>
<p lang="en-GB">Let’s start from the top, where the user enters their user credentials, for example, username and password. Bear in mind that this could take place automatically, for example, in a single sign-on setup or via a service provider login. Moodle checks whether a <a id="_idIndexMarker394"/>profile exists for the user. If it does and the account is authenticated via an internal mechanism, Moodle only has to check whether the credentials are valid.</p>
<p lang="en-GB">If the user profile doesn’t exist, which is often the case the first time a user attempts to log in, Moodle checks for any enabled and configured external provider-based authentication mechanisms. If there is a valid entry, an account will be created, any existing data for which a mapping exists will be copied to the local user profile, and access will be granted.</p>
<p lang="en-GB">Once the profile exists and authentication is external or via a provider, Moodle checks whether the credentials are valid for the set authentication method. If this is the case, any modified data in the source will be updated, and access will be granted.</p>
<h2 id="_idParaDest-109" lang="en-GB"><a id="_idTextAnchor109"/>Managing user authentication</h2>
<p lang="en-GB">To access <a id="_idIndexMarker395"/>all the authentication plugins, go to <strong class="bold" lang="">Site administration | Plugins | Authentication | Manage authentication</strong>. You will see a list of available authentication plugins. Each plugin can be activated/deactivated by toggling the <strong class="bold" lang="">show/hide</strong> icon. The settings for each type discussed in this section are accessed by their respective links or directly through the link in the plugins menu once the authentication method is active.</p>
<p lang="en-GB">You can also <a id="_idIndexMarker396"/>change the order in which Moodle attempts to authenticate users via the up and down arrows.</p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">The order in which authentication plugins are applied will impact how long it takes for users to log in, so make sure that the main ones are at the top.</p>
<p lang="en-GB">The <strong class="bold" lang="">Users</strong> column gives you an indication of the number of registered users for each authentication mechanism.</p>
<div>
<div class="IMG---Figure" id="_idContainer141">
<img alt="Figure 5.29 – Authentication plugins " height="1234" src="image/Figure_5.29_B18779.jpg" width="1649"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.29 – Authentication plugins</p>
<p lang="en-GB">Additional <a id="_idIndexMarker397"/>authentication methods are supported by external plugins on <a href="http://moodle.org/plugins/?q=type:auth">moodle.org/plugins/?q=type:auth</a>, for example, <strong class="bold" lang="">OpenID</strong> and <strong class="bold" lang="">SAML2</strong>. Once installed (refer to the <em class="italic" lang="">Installing third-party add-ons</em> section in <a href="B18779_08.xhtml#_idTextAnchor168"><em class="italic" lang="">Chapter 8</em></a>, <em class="italic" lang="">Understanding Moodle Plugins</em>), they will appear in the list alongside all the core authentication methods. It is not recommended that you remove plugins via the <strong class="bold" lang="">Uninstall</strong> option—delete them at the system level instead.</p>
<p lang="en-GB">The following diagram illustrates a clustering of Moodle authentication plugins:</p>
<div>
<div class="IMG---Figure" id="_idContainer142">
<img alt="Figure 5.30 – Authentication plugins grouping " height="644" src="image/Figure_5.30_B18779.jpg" width="1218"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.30 – Authentication plugins grouping</p>
<p lang="en-GB">This grouping <a id="_idIndexMarker398"/>also forms the structure of the remainder of the chapter, starting with common authentication settings all mechanisms share.</p>
<h2 id="_idParaDest-110" lang="en-GB"><a id="_idTextAnchor110"/>Common authentication settings</h2>
<p lang="en-GB">First, let’s <a id="_idIndexMarker399"/>look at the common authentication settings, which you will see under the list of available plugins. Whatever your preferred authentication system(s) is, several common settings apply across all methods:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Self registration</strong>: Specify which plugin, if any, is used for self-registration (refer to the next section for details).</li>
<li lang="en-GB"><strong class="bold" lang="">Allow login via email</strong>: Users can log in via their username or email address as long as the latter is unique.</li>
<li lang="en-GB"><strong class="bold" lang="">Allow accounts with same email</strong>: In some settings, users will have to share the same email address. We discussed this topic in the <em class="italic" lang="">Understanding user profiles</em> section.</li>
<li lang="en-GB"><strong class="bold" lang="">Prevent account creation when authenticating</strong>: Some authentication mechanisms, for instance, LDAP, support the creation of new accounts. If this is prevented, you must ensure that the accounts are created by other means.</li>
<li lang="en-GB"><strong class="bold" lang="">Autofocus login page form</strong>: When enabled, the cursor on the login page will always jump directly to the username input field if it is empty or to the password field otherwise.</li>
<li lang="en-GB"><strong class="bold" lang="">Guest login button</strong>: By default, guest access to your Moodle system is allowed. If you <a id="_idIndexMarker400"/>disable this, which is recommended for most educational and commercial sites, the guest login button will not be shown on the login screen.</li>
</ul>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">Ensure to disable guest access to your Moodle system to prevent unwanted registrations.</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Limit concurrent logins</strong>: You can specify the number of simultaneous browser logins. Once the number has been exceeded, the oldest session will be terminated. This limitation is useful in exam scenarios where you might allow only a single concurrent login.</li>
<li lang="en-GB"><strong class="bold" lang="">Alternate login URL</strong>: By default, users have to log on to Moodle via the standard login screen. However, to change the source of the login credentials (username and password), enter the correct URL here. This redirect is necessary if you wish to have a login block on a separate web page, such as your home page. Details of this mechanism are shown in the <em class="italic" lang="">Customizing the login</em> subsection in <a href="B18779_07.xhtml#_idTextAnchor140"><em class="italic" lang="">Chapter 7</em></a>, <em class="italic" lang="">Enhancing Moodle’s Look and Feel</em>.</li>
<li lang="en-GB"><strong class="bold" lang="">Forgotten password URL</strong>: Moodle has a built-in mechanism to deal with lost or forgotten passwords. You should enter its URL here if you use an authentication method with its own password-recovery system.</li>
<li lang="en-GB"><strong class="bold" lang="">Instructions</strong>: It is good practice to provide information on how to sign up for the system and what format the username should have (this only applies to self-registration). There are default instructions if it’s left blank.</li>
<li lang="en-GB"><strong class="bold" lang="">Allowed/Denied email domains</strong>: You can restrict the email domains for self-registration <a id="_idIndexMarker401"/>that are allowed/not allowed on your system when new user accounts are created, for example, <strong class="source-inline" lang="">openumlaut.com</strong> or <strong class="source-inline" lang="">.edu</strong>.</li>
<li lang="en-GB"><strong class="bold" lang="">Restrict domains when changing email</strong>: If enabled, the allowed/denied email domain settings will also be applied when an email address is changed.</li>
<li lang="en-GB"><strong class="bold" lang="">ReCAPTCHA public/private key</strong>: This is the key to display the reCAPTCHA element on the signup form/to communicate with the reCAPTCHA server (refer to the <em class="italic" lang="">Email-based self-registration</em> section).</li>
</ul>
<p lang="en-GB">Some common authentication settings will make more sense once we have dealt with the authentication methods they impact. Let’s start with internal authentication methods.</p>
<h2 id="_idParaDest-111" lang="en-GB"><a id="_idTextAnchor111"/>Internal authentication methods</h2>
<p lang="en-GB">Internal <a id="_idIndexMarker402"/>authentication methods <a id="_idIndexMarker403"/>handle all authentication within Moodle; no other system is connected. There are two internal authentication methods: manual accounts and email-based self-registration.</p>
<h3 lang="en-GB">Manual accounts</h3>
<p lang="en-GB">Manual <a id="_idIndexMarker404"/>account authentication <a id="_idIndexMarker405"/>is simply the verification at login that the entered user credentials (username and password) stored in Moodle are correct.</p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">The main Moodle administrator account is always a manual account.</p>
<p lang="en-GB">There are two types of settings for all manual accounts created: password expiry and the locking of user fields. Both can be changed by navigating to <strong class="bold" lang="">Site administration | Plugins | Authentication | Manual accounts</strong>.</p>
<div>
<div class="IMG---Figure" id="_idContainer143">
<img alt="Figure 5.31 – Manual accounts settings " height="1069" src="image/Figure_5.31_B18779.jpg" width="1208"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.31 – Manual accounts settings</p>
<p lang="en-GB">Password <a id="_idIndexMarker406"/>expiry lets you <a id="_idIndexMarker407"/>choose how long a password is valid via the <strong class="bold" lang="">Password duration</strong> setting before it has to be changed by a user. <strong class="bold" lang="">Notification threshold</strong> lets you specify when a user is notified of the password rotation.</p>
<p lang="en-GB">You can lock fields for accounts that are manually created or uploaded via batch files. This locking mechanism is helpful whenever you do not want users to be able to change specific data in their user profiles—young students may misuse the <strong class="bold" lang="">Description</strong> field, the ID number may be used internally to link to other systems, the company might have provided the email address, and so on.</p>
<p lang="en-GB">By default, all fields are <strong class="bold" lang="">Unlocked</strong>. If a field is <strong class="bold" lang="">Locked</strong>, the user will not be able to change its value. If you lock any compulsory fields, you either have to ensure they are populated correctly, or you set their lock state to <strong class="bold" lang="">Unlocked if empty</strong>. The latter will force the <a id="_idIndexMarker408"/>user to enter <a id="_idIndexMarker409"/>the value the next time they log in and lock the field afterward.</p>
<p lang="en-GB">Accounts verified by the manual authentication method are usually created manually or via user batch upload. Both operations have been described in detail in the first part of this chapter, where the latter effectively automates manual account creation. Two other authentication mechanisms mimic adding user accounts manually: web services, which we deal with in the <em class="italic" lang="">System authentication methods</em> section later on, and <em class="italic" lang="">Email-based self-registration</em>, which we cover next.</p>
<h3 lang="en-GB">Email-based self-registration</h3>
<p lang="en-GB">Moodle <a id="_idIndexMarker410"/>supports a mechanism <a id="_idIndexMarker411"/>that allows users to create accounts without any intervention or knowledge of the administrator. When new users sign up with Moodle via the <strong class="bold" lang="">Create new account</strong> button on the login screen, they can choose their new username and password. Once this step has been completed, a confirmation mail is sent to the user’s email address, containing a secure link that must be confirmed to activate the account. The signup screen looks like this:</p>
<div>
<div class="IMG---Figure" id="_idContainer144">
<img alt="Figure 5.32 – Self-registration signup screen " height="1619" src="image/Figure_5.32_B18779.jpg" width="843"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.32 – Self-registration signup screen</p>
<p lang="en-GB">We explained <a id="_idIndexMarker412"/>how to add <a id="_idIndexMarker413"/>more items to the signup screen (via the <strong class="bold" lang="">Display on signup page</strong> option) when dealing with user-defined profile fields. This feature is often invaluable in commercial training settings when additional data, such as the learner’s address, a participant’s dietary requirements, or a customer number, has to be gathered.</p>
<p lang="en-GB">Moodle supports a <strong class="bold" lang="">reCAPTCHA</strong> mechanism activated on the pictured signup screen. The facility is used to avoid automated signups by bots. To enable this facility, you must sign up for an account at <a href="http://www.google.com/recaptcha">www.google.com/recaptcha</a>, add the public and private key in <strong class="bold" lang="">Common settings</strong> in the <strong class="bold" lang="">Manage Authentication</strong> area, and enable the <strong class="bold" lang="">reCAPTCHA</strong> element.</p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">The PHP cURL extension must be installed for reCAPTCHA to work.</p>
<p lang="en-GB">The same <a id="_idIndexMarker414"/>locking settings <a id="_idIndexMarker415"/>can be set for self-registration as for manual accounts (go to <strong class="bold" lang="">Site administration | Plugins | Authentication | Email-based self-registration</strong>). Also, the same restrictions apply as described earlier. Additionally, you have the <strong class="bold" lang="">Enable reCAPTCHA element</strong> option.</p>
<p lang="en-GB">If a user policy has been specified when you navigate to <strong class="bold" lang="">Site administration | Users | Privacy and policies | Policy settings</strong>, a link to the agreement with the confirmation checkbox is shown on the signup screen. We will deal with more complex user consent handling as part of the GDPR set up in <a href="B18779_14.xhtml#_idTextAnchor271"><em class="italic" lang="">Chapter 14</em></a>, <em class="italic" lang="">Complying with Data Protection Regulations</em>.</p>
<p lang="en-GB">If the confirmation email cannot be sent, for instance, because of technical issues, go to the list of users, where you will find two links beside the account entry: one to confirm the account and one to resend the email.</p>
<p lang="en-GB">Before we move on to the next authentication method, here is a short checklist for setting up self-registration (apart from enablement, all steps are optional):</p>
<div>
<div class="IMG---Figure" id="_idContainer145">
<img alt="Figure 5.33 – Checklist for self-registration " height="506" src="image/Figure_5.33_B18779.jpg" width="1208"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.33 – Checklist for self-registration</p>
<p lang="en-GB">Allowing <a id="_idIndexMarker416"/>users to register <a id="_idIndexMarker417"/>accounts on your site comes with a degree of risk since you have no control over who – humans or bots – is coming to your site (assuming it is publicly accessible). Therefore, it is highly recommended to test self-registration thoroughly and regularly check your new users list.</p>
<p lang="en-GB">Now that we have covered internal authentication, it is time to look over the (Moodle) fence and deal with external methods.</p>
<h2 id="_idParaDest-112" lang="en-GB"><a id="_idTextAnchor112"/>External authentication methods</h2>
<p lang="en-GB">External <a id="_idIndexMarker418"/>authentication methods require a separate, connected <a id="_idIndexMarker419"/>system to handle authentication. We will cover two external authentication methods in detail (LDAP and databases) and two more we only briefly describe (CAS and Shibboleth).</p>
<h3 lang="en-GB">LDAP server</h3>
<p lang="en-GB">In the <a id="_idIndexMarker420"/>previous chapter, we had already seen <a id="_idIndexMarker421"/>a basic introduction to LDAP when dealing with course enrolment. Now, let’s look at how it can be <a id="_idIndexMarker422"/>utilized for <strong class="bold" lang="">single sign-on</strong> (<strong class="bold" lang="">SSO</strong>) authentication. We will only cover the basic LDAP settings and exclude advanced setups, such as multiple LDAP servers and secure LDAP. These configurations are documented in great detail at <a href="http://docs.moodle.org/en/LDAP_authentication">docs.moodle.org/en/LDAP_authentication</a>.</p>
<p lang="en-GB">The principle of the LDAP authentication method is relatively simple but effective—if the entered username and password are valid, Moodle creates a new user account in its database if it doesn’t already exist. Once it does exist, that is, from the second login onwards, the credentials are checked against LDAP for validity.</p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">The PHP LDAP extension must be installed on the server for LDAP authentication to work.</p>
<p lang="en-GB">Go to <strong class="bold" lang="">Site administration | Plugins | Authentication | LDAP server</strong> to see the settings, which also cover <strong class="bold" lang="">Active Directory</strong> (Microsoft’s implementation of LDAP). There is <a id="_idIndexMarker423"/>a significant number of parameters that <a id="_idIndexMarker424"/>you must set to communicate with an LDAP server. The settings have been amended with detailed explanations (which I will not repeat). Instead, additional information is provided wherever applicable. Contact your system administrator if you are unsure where to locate some of the required information.</p>
<p lang="en-GB">Two parts must be populated to make Moodle work in your LDAP setup: <strong class="bold" lang="">server settings</strong> and <strong class="bold" lang="">data mappings</strong>, discussed in the following paragraphs.</p>
<p lang="en-GB">There are <a id="_idIndexMarker425"/>ten sections of <strong class="bold" lang="">LDAP server settings</strong> that have to be provided:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">LDAP server settings</strong>: These establish the connection to the directory. LDAP servers with SSL encryption are also supported.</li>
<li lang="en-GB"><strong class="bold" lang="">Bind settings</strong>: These specify details about the credentials needed to access the LDAP server. If you have multiple bases, it is recommended that you put them in order of importance as Moodle stops searching once it has found an entry. For example, if you have <strong class="source-inline" lang="">ou=Students</strong> and <strong class="source-inline" lang="">ou=Staff</strong> and your students make up 90% of the logins, it is recommended that you put them before their lecturers unless staff is given priority.</li>
<li lang="en-GB"><strong class="bold" lang="">User lookup settings</strong>: These describe how and where user details are stored on your LDAP directory. Make sure you select the correct user type. The same applies to the distinguished name in the bind settings for multiple contexts. It is crucial to set <strong class="bold" lang="">Search subcontexts</strong> correctly. If it is set to <strong class="bold" lang="">No</strong>, subcontexts will not be searched, but the search is potentially faster, and vice versa.</li>
<li lang="en-GB"><strong class="bold" lang="">Force change password</strong>: This specifies whether and how users must change passwords <a id="_idIndexMarker426"/>when accessing Moodle for the first time.</li>
<li lang="en-GB"><strong class="bold" lang="">LDAP password expiration settings</strong>: These are concerned with password lapsing and how this is being dealt with.</li>
<li lang="en-GB"><strong class="bold" lang="">Enable user creation</strong>: This lets you activate a mechanism that is similar to self-registration, but, in addition to this, an account is created with the values from your LDAP.</li>
<li lang="en-GB"><strong class="bold" lang="">System role mapping</strong>: This specifies which LDAP user groups will have manager and course creator permissions in Moodle, respectively.</li>
<li lang="en-GB"><strong class="bold" lang="">User account synchronization</strong>: This setting specifies what Moodle should do with local user accounts when these have been deleted on the LDAP server.</li>
<li lang="en-GB"><strong class="bold" lang="">NTLM SSO</strong>: This describes how, in a Windows-based environment with MS-AD and NTLM active, users can log in via the Windows domain without re-entering their credentials when accessing Moodle. Check out <a href="http://docs.moodle.org/en/NTLM_authentication">docs.moodle.org/en/NTLM_authentication</a> for details.</li>
</ul>
<p lang="en-GB">The second <a id="_idIndexMarker427"/>half of the admittedly very long screen contains the LDAP data mapping. It is common for user profile information to be stored in the LDAP server. To connect user profile fields and the Active Directory, a mapping has to be provided by specifying their counterparts in the directory for each field in Moodle (including user-defined profile fields). All the fields are optional. Default values are used if you leave any of the fields blank:</p>
<div>
<div class="IMG---Figure" id="_idContainer146">
<img alt="Figure 5.34 – LDAP authentication (data mapping) " height="997" src="image/Figure_5.34_B18779.jpg" width="1043"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.34 – LDAP authentication (data mapping)</p>
<p lang="en-GB">If you <a id="_idIndexMarker428"/>provide the field information, you will have to set four parameters for each data field, as follows:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Data mapping</strong>: This is the field name in the external database representing the value in Moodle.</li>
<li lang="en-GB"><strong class="bold" lang="">Update local</strong>: For each external user, information is stored locally. You can update this information using <strong class="bold" lang="">On creation</strong> (this is faster but potentially not up-to-date) or <strong class="bold" lang="">On every login</strong> (this is a bit slower, but it’s always up to date).</li>
<li lang="en-GB"><strong class="bold" lang="">Update external</strong>: If a user updates the data field’s value in Moodle, you can decide whether you want to write this information back to the external database (<strong class="bold" lang="">On update</strong>) or not (<strong class="bold" lang="">Never</strong>). Often, the external database is a read-only view, preventing Moodle from updating data in it.</li>
<li lang="en-GB"><strong class="bold" lang="">Lock value</strong>: You can <a id="_idIndexMarker429"/>specify whether the user can modify the value. As explained earlier, the settings (<strong class="bold" lang="">Unlocked</strong>, <strong class="bold" lang="">Unlocked if empty</strong>, and <strong class="bold" lang="">Locked</strong>) are identical to the lock field.</li>
</ul>
<p lang="en-GB">If you use Microsoft’s Active Directory MS-AD, check out the data mapping section in <a href="http://docs.moodle.org/en/LDAP_authentication">docs.moodle.org/en/LDAP_authentication</a> for details.</p>
<p lang="en-GB">Setting up LDAP authentication can be a bit of trial-and-error. Verifying that the connection works can be assisted by the <strong class="bold" lang="">Test setting</strong> facility located in the list of available <a id="_idIndexMarker430"/>authentication plugins. More detailed error messages will be displayed, which will help you identify any SSO connection issues.</p>
<p lang="en-GB">When using LDAP, you might encounter a situation where you wish to assign courses to users before they have logged in to the system for the first time. This scenario regularly applies before the start of the academic year. The problem is that the local user accounts do not exist yet, and you cannot access this information as it is only stored in the external directory. There are two ways around this conundrum:</p>
<ul>
<li lang="en-GB">Create the user accounts via batch files and set the <strong class="source-inline" lang="">auth</strong> field to <strong class="source-inline" lang="">ldap</strong>; that way, you effectively mimic the initial logging in of each user.</li>
<li lang="en-GB">Set up the <strong class="bold" lang="">LDAP users sync job</strong> scheduled task. Tasks are covered in <a href="B18779_15.xhtml#_idTextAnchor289"><em class="italic" lang="">Chapter 15</em></a>, <em class="italic" lang="">Optimizing Moodle Performance</em>.</li>
</ul>
<p lang="en-GB">LDAP is effectively a specialized and lightweight database for authentication purposes. Authentication against LDAP is very similar to authentication against external databases, which is the topic of the following subsection.</p>
<h3 lang="en-GB">External databases</h3>
<p lang="en-GB">Most large <a id="_idIndexMarker431"/>organizations use a student or management information system—either open source (good), proprietary (bad), or developed in-house (worst)—which holds information about staff and learners. It makes perfect sense to utilize this data for authorization to Moodle. Since all information systems use a database at their core, all we have to do is to get access to the relevant data.</p>
<p lang="en-GB">IT departments are usually not too keen for external systems to connect directly to their database. A mechanism <a id="_idIndexMarker432"/>that has proven valuable is the <strong class="bold" lang="">read-only view</strong>, which has several advantages:</p>
<ul>
<li lang="en-GB">A view can be prepared for Moodle usage; only required fields are shown in the required format</li>
<li lang="en-GB">There’s no write-access to the database</li>
<li lang="en-GB">If the database schema of the information system ever changes, only the view has to be adapted, not the Moodle configuration</li>
</ul>
<p lang="en-GB">The external <a id="_idIndexMarker433"/>database authentication method contains two types of parameters that you have to provide by going to <strong class="bold" lang="">Site administration | Plugins | Authentication | External database</strong>: <strong class="bold" lang="">connection settings</strong> and <strong class="bold" lang="">data mappings</strong>.</p>
<div>
<div class="IMG---Figure" id="_idContainer147">
<img alt="Figure 5.35 – External database authentication " height="849" src="image/Figure_5.35_B18779.jpg" width="1209"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.35 – External database authentication</p>
<p lang="en-GB">The database connection settings have been amended with good explanations. Contact your database administrator if you are unsure where to locate some of the required information.</p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">Some databases, such as Oracle, are case sensitive, and field names must be provided with the correct casing for the database link to work correctly.</p>
<p lang="en-GB">The second <a id="_idIndexMarker434"/>half of the settings screen contains the data mapping. User profile information is stored in the external database. To connect the user profile fields and the database, a mapping has to be provided where a counterpart in the external store has to be provided for each field in Moodle, including user-defined profile fields. All the fields are optional, and default values are used if you leave any fields blank.</p>
<p lang="en-GB">Most facilities covered in the LDAP section are also available for external database authentication:</p>
<ul>
<li lang="en-GB">Creating user accounts via batch files (set the <strong class="source-inline" lang="">auth</strong> field to <strong class="source-inline" lang="">db</strong>)</li>
<li lang="en-GB">Automating synchronization via the task scheduler, <strong class="bold" lang="">Synchronise users task</strong></li>
<li lang="en-GB">Testing the database connection</li>
</ul>
<p lang="en-GB">To sum up the topic, here is a checklist for external authentication methods:</p>
<div>
<div class="IMG---Figure" id="_idContainer148">
<img alt="Figure 5.36 – Checklist for external database authentication " height="505" src="image/Figure_5.36_B18779.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.36 – Checklist for external database authentication</p>
<p lang="en-GB">Hopefully, the <a id="_idIndexMarker435"/>previous two subsections gave you an insight into how external authentication mechanisms work in Moodle. Two more methods fall in the same category: CAS and Shibboleth.</p>
<h3 lang="en-GB">Other external authentication mechanisms</h3>
<p lang="en-GB">Moodle <a id="_idIndexMarker436"/>supports <a id="_idIndexMarker437"/>some additional external SSO authentication methods that are not utilized as often as LDAP, external databases, and OAuth 2; we only briefly touch upon them:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">CAS Server (SSO)</strong>: <strong class="bold" lang="">Central Authentication Service</strong> (<strong class="bold" lang="">CAS</strong>) is an open source <a id="_idIndexMarker438"/>authentication server based on Tomcat and supports single sign-on in a web environment. CAS <a id="_idIndexMarker439"/>is particularly popular in environments that comprise multiple authentication sources and consumers. It utilizes LDAP and, therefore, requires the PHP LDAP modules to be installed.</li>
<li lang="en-GB"><strong class="bold" lang="">Shibboleth</strong>: Shibboleth <a id="_idIndexMarker440"/>is <a id="_idIndexMarker441"/>SAML-based open source middleware that provides single sign-on across organizational boundaries. Privacy, security, and flexibility in terms of multi-setups are at the heart of Shibboleth. However, the price to pay is a complicated setup process detailed in the local readme file at <strong class="source-inline" lang="">&lt;YOURSITE&gt;/auth/shibboleth/README.txt</strong>. More information on Shibboleth <a id="_idIndexMarker442"/>can be found at www.internet2.edu/products-services/trust-identity-middleware/shibboleth.</li>
</ul>
<p lang="en-GB">All authentication mechanisms covered so far are either internal to Moodle (manual accounts and self-registration) or usually local to the organization but external to Moodle (LDAP or database). Moodle also supports provider-based authentication services via <strong class="bold" lang="">OAuth 2</strong>, which we will cover next.</p>
<h2 id="_idParaDest-113" lang="en-GB"><a id="_idTextAnchor113"/>Service provider-based authentication (OAuth 2)</h2>
<p lang="en-GB">OAuth 2.0 is the <a id="_idIndexMarker443"/>de facto industry standard protocol for user authorization. OAuth 2 <a id="_idIndexMarker444"/>authentication enables users to access Moodle via buttons on the login page using their credentials <a id="_idIndexMarker445"/>from popular service providers, such as Google, Microsoft, Facebook, and LinkedIn.</p>
<div>
<div class="IMG---Figure" id="_idContainer149">
<img alt="Figure 5.37 – Authentication via OAuth 2 service providers " height="359" src="image/Figure_5.37_B18779.jpg" width="704"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.37 – Authentication via OAuth 2 service providers</p>
<p lang="en-GB">Before we dive into the configuration of service provider-based authentication, have a look at the interaction diagram, which illustrates how OAuth 2 works in a Moodle context:</p>
<div>
<div class="IMG---Figure" id="_idContainer150">
<img alt="Figure 5.38 – OAuth 2 interactions " height="812" src="image/Figure_5.38_B18779.jpg" width="1209"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.38 – OAuth 2 interactions</p>
<p lang="en-GB">An OAuth <a id="_idIndexMarker446"/>service provider is an external system (“in the cloud”) that <a id="_idIndexMarker447"/>provides identity (via the authorization server) and API access (via the resource server) by issuing OAuth access tokens to a client (Moodle). Let’s go through the interactions from top to bottom:</p>
<ol>
<li lang="en-GB" value="1">A user sends an <strong class="bold" lang="">authorization request</strong>; that is, a user logs in to the service provider via the client. This step is initiated via the service provider buttons on the Moodle login screen.</li>
<li lang="en-GB">The authorization server issues an <strong class="bold" lang="">authorization code</strong> if the entered credentials are valid. Once this has taken place, the user is authenticated with Moodle. If account creation is enabled (the <strong class="bold" lang="">Prevent account creation when authenticating</strong> setting), a new account will be created. Otherwise, the user will be prompted to link the authorization to an existing account with the same email address. An entry can be found in the <strong class="bold" lang="">Linked logins</strong> section in the user’s preferences.</li>
<li lang="en-GB">An <strong class="bold" lang="">access token</strong> will be issued when the user logs in using the stored authorization code. A scheduled task exists to regularly update the OAuth 2 tokens (<strong class="source-inline" lang="">\core\oauth2\refresh_system_tokens_task</strong>).</li>
<li lang="en-GB">Moodle uses this access token for any internal services that require a <strong class="bold" lang="">resource</strong> from the service provider, for instance, a link to files in a repository. Some internal services require a system account to be connected.</li>
</ol>
<p lang="en-GB">The <a id="_idIndexMarker448"/>preceding interaction <a id="_idIndexMarker449"/>process is a very crude summary of how OAuth 2 authentication works in Moodle, but this should be sufficient to understand the overall concept. OK, enough of the high-level stuff; let’s start setting up service provider authentication.</p>
<p lang="en-GB">The first step is to configure OAuth 2 services in <strong class="bold" lang="">Site administration | Server | Server | OAuth 2 services</strong>.</p>
<div>
<div class="IMG---Figure" id="_idContainer151">
<img alt="Figure 5.39 – OAuth 2 services" height="522" src="image/Figure_5.39_B18779.jpg" width="1386"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.39 – OAuth 2 services</p>
<p lang="en-GB">At the bottom, you can see all supported service providers. Select the respective button to add a preconfigured service, which will direct you to the form to create a new service. The service specifications are already populated – all you must do is add the <strong class="bold" lang="">Client ID</strong> and the <strong class="bold" lang="">Client secret</strong> details of the respective service provider.</p>
<p lang="en-GB">How do you get the client ID and secret? The issuer provides these, so setup must be done at their end, not in Moodle. There is a <strong class="bold" lang="">Service provider setup instructions</strong> link for the six supported prominent OAuth 2 providers at the top of the screen.</p>
<p class="callout-heading" lang="en-GB">Important note</p>
<p class="callout" lang="en-GB">It is recommended to leave all fields at their default values for pre-defined service providers, except <strong class="bold" lang="">Client ID</strong>, <strong class="bold" lang="">Client secret</strong>, and <strong class="bold" lang="">Service base URL</strong>.</p>
<p lang="en-GB">If you <a id="_idIndexMarker450"/>wish to set up a service <a id="_idIndexMarker451"/>provider not listed, you can create a <strong class="bold" lang="">Custom</strong> service. The form is identical to the pre-defined services but without any pre-populated values. You <a id="_idIndexMarker452"/>find details about the purpose of each parameter at <a href="http://docs.moodle.org/en/OAuth_2_services">docs.moodle.org/en/OAuth_2_services</a>.</p>
<p lang="en-GB">Once the service has been created (pre-defined or custom), the standard actions are available in the <strong class="bold" lang="">Edit</strong> column, plus two more actions that require some more explanation:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">Configure endpoints</strong>: Endpoints are the URLs that Moodle uses to make OAuth 2 authentication requests. These have already been added for pre-defined services and shouldn’t be changed; for custom services, the mandatory endpoints are <strong class="source-inline" lang="">authorization_endpoint</strong>, <strong class="source-inline" lang="">token_endpoint</strong>, and <strong class="source-inline" lang="">userinfo_endpoint</strong>.</li>
<li lang="en-GB"><strong class="bold" lang="">Configure user field mappings</strong>: Here, you define how the provider’s response from <strong class="source-inline" lang="">userinfo_endpoint</strong> should be mapped to Moodle user fields. It is recommended to at least configure <strong class="source-inline" lang="">firstname</strong>, <strong class="source-inline" lang="">lastname</strong>, and <strong class="source-inline" lang="">email</strong> since these are compulsory fields in Moodle’s user profiles.</li>
</ul>
<p lang="en-GB">Once the service provider has been configured properly, it can be used by the OAuth 2 authentication plugin, which has to be enabled at <strong class="bold" lang="">Site administration | Plugins | Authentication | Manage authentication</strong>. Like all other authentication plugins, OAuth 2 lets you configure any locked fields, and there are no additional configuration options as the service provider setup controls all behavior.</p>
<p lang="en-GB">As with other authentication methods, let’s conclude the section with a checklist, which hopefully comes in useful when you have to configure OAuth 2 authentication:</p>
<div>
<div class="IMG---Figure" id="_idContainer152">
<img alt="Figure 5.40 – Checklist for OAuth 2 authentication " height="432" src="image/Figure_5.40_B18779.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.40 – Checklist for OAuth 2 authentication</p>
<p lang="en-GB">We have <a id="_idIndexMarker453"/>now covered all the <a id="_idIndexMarker454"/>authentication mechanisms that ship with Moodle and belong to the first three pillars of our authentication plugin grouping. The fourth category comprises system authentication methods, which we are covering next.</p>
<h2 id="_idParaDest-114" lang="en-GB"><a id="_idTextAnchor114"/>System authentication methods</h2>
<p lang="en-GB">Moodle <a id="_idIndexMarker455"/>contains authentication methods, which are required <a id="_idIndexMarker456"/>by certain features <a id="_idIndexMarker457"/>to function correctly:</p>
<ul>
<li lang="en-GB"><strong class="bold" lang="">No login</strong>: This plugin has no settings and cannot be disabled or uninstalled. Its sole purpose is to suspend users from logging in to your Moodle system, which takes place in the user’s profile by selecting the authentication method in the <strong class="bold" lang="">Choose an authentication method</strong> drop-down list.</li>
<li lang="en-GB"><strong class="bold" lang="">No authentication</strong>: When this method is enabled, users can create accounts without any kind of authentication or email-based confirmation. It is highly recommended that you do not use this method since it creates a very insecure Moodle site and should only be used for testing or development purposes. Only user fields can be locked in the same way as described earlier.</li>
<li lang="en-GB"><strong class="bold" lang="">MNet authentication</strong>: Moodle networking allows the connection of multiple Moodle sites in a peer-to-peer or hub style. See <a href="B18779_19.xhtml#_idTextAnchor344"><em class="italic" lang="">Chapter 19</em></a>, <em class="italic" lang="">Setting Up Moodle Networking</em>, for details.</li>
<li lang="en-GB"><strong class="bold" lang="">LTI</strong>: This <a id="_idIndexMarker458"/>plugin has the sole purpose of facilitating the login to LTI producers. LTI will be discussed in <a href="B18779_09.xhtml#_idTextAnchor181"><em class="italic" lang="">Chapter 9</em></a>, <em class="italic" lang="">Configuring Education Features</em>.</li>
<li lang="en-GB"><strong class="bold" lang="">Web services authentication</strong>: This plugin authenticates users via external clients communicating with Moodle via web services (see <a href="B18779_18.xhtml#_idTextAnchor337"><em class="italic" lang="">Chapter 18</em></a>, <em class="italic" lang="">Integrating External Systems Using Web Services</em>, for details). The authentication plugin has no settings.</li>
</ul>
<p lang="en-GB">This concludes <a id="_idIndexMarker459"/>the section on user authentication. While there has been a lot of content, you are highly likely only to require <a id="_idIndexMarker460"/>information on manual accounts plus the method(s) you are utilizing in your organization. Since no two authentication setups are the same, you will soon be familiar with all the quirks and idiosyncrasies of your authentication infrastructure and the plugin(s) that connect it.</p>
<p lang="en-GB">A last piece of advice: be on good terms with your system, database, and network admins. They will grant you access to your LDAP directory or the organization’s authentication database system and open up the ports you need to connect to service providers and web services. Buy them a coffee or bribe them with other niceties!</p>
<h1 id="_idParaDest-115" lang="en-GB"><a id="_idTextAnchor115"/>Summary</h1>
<p lang="en-GB">Phew! That was a lot to take in for one chapter.</p>
<p lang="en-GB">The first part of this chapter demonstrated the different ways Moodle provides to manage users. We first looked at what information is stored for each user account and how their profiles can be extended. We then performed several standard manual and bulk user actions before dealing with cohorts.</p>
<p lang="en-GB">In the second part, we dealt with different types of user authentication, namely internal, external, service providers (via OAuth 2), and system. Due to the variety and complexity of authentication methods, we covered prominent plugins in more detail than others.</p>
<p lang="en-GB">Authentication has become a complex topic, and we only touched upon methods supported in Moodle core. Other methods such as Microsoft Azure AD or Open ID as well as mechanisms such as two-factor authentication, one-time passwords, and user key authentication are beyond the scope of this already packed chapter and are catered for via plugins at <a href="http://moodle.org/plugins/?q=type:auth">moodle.org/plugins/?q=type:auth</a>.</p>
<p lang="en-GB">One aspect of authentication we didn’t mention at all is <strong class="bold" lang="">multi-tenancy</strong>. Assume a setup where different users have to connect via different authentication mechanisms of the same type; for instance, staff authenticates via <strong class="source-inline" lang="">SAML_internal</strong>, and customers and partners via <strong class="source-inline" lang="">SAML_external</strong>. There are two options for how this can be facilitated:</p>
<ul>
<li lang="en-GB">Duplicate the authentication plugin at the system level and modify the source code accordingly. A programmer must carry out this task as source code changes are required in the copied module. Be careful with this approach, as this might not work when Moodle is updated to a newer version.</li>
<li lang="en-GB">Consider Moodle’s big brother, Moodle Workplace, which supports multi-tenancy authentication. To get a feel for how this works, have a look at <a href="http://docs.moodle.org/en/Multi-tenancy_authentication">docs.moodle.org/en/Multi-tenancy_authentication</a>. At the time of writing, the following authentication methods support multi-tenancy: manual, email-based self-registration, OAuth 2, and SAML 2 (as a third-party plugin).</li>
</ul>
<p lang="en-GB">The next step is to grant user roles, that is, the rights as to what they are allowed to do and what they are not. This will be dealt with in the next chapter.</p>
</div>
<div>
<div id="_idContainer154">
</div>
</div>
</div></body></html>