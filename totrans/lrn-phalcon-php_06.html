<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Assets, Authentication, and ACL"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Assets, Authentication, and ACL</h1></div></div></div><p>We will make use of our <code class="literal">Backoffice</code> module for this chapter, since it will be the second module that we will develop.</p><p>We will cover the following topics in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Assets management</li><li class="listitem" style="list-style-type: disc">Developing an authentication system</li><li class="listitem" style="list-style-type: disc">Securing the application using the <span class="strong"><strong>Access Control List</strong></span> (<span class="strong"><strong>ACL</strong></span>)<a id="id369" class="indexterm"/> component</li></ul></div><div class="section" title="Assets management"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec41"/>Assets management</h1></div></div></div><p>Before going further, I would<a id="id370" class="indexterm"/> like to introduce you to Phalcon's assets manager. This is a very useful component when you need to handle lots of assets (in general, CSS files, images, and JavaScript files). The service should already be available, and you can access it via DI using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$manager = $this-&gt;assets;</strong></span>
</pre></div><p>Otherwise, you can use the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$manager = $this-&gt;getDI()-&gt;get('assets');</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note17"/>Note</h3><p>I've heard some people complaining that after its installation, this service does not exist. If you are using Phalcon version 1.3.* (and you should be), then you wouldn't have any problem. If you use an older version, you might need to inject this service into the DI:</p><div class="informalexample"><pre class="programlisting">$di-&gt;set('assets', function () {
    return new Phalcon\Assets\Manager();
}, true);</pre></div></div></div><p>Now, let's <a id="id371" class="indexterm"/>open the main layout for the back office and do some changes. Open <code class="literal">modules/Backoffice/Views/Default/layout.volt</code> and remove all the lines containing <code class="literal">stylesheetLink</code> and <code class="literal">javascriptInclude</code>.</p><p>Now, between <code class="literal">&lt;head&gt;</code> and <code class="literal">&lt;/head&gt;</code> sections, add the following code:</p><div class="informalexample"><pre class="programlisting">{{ assets.outputCss('headerCss') }}
{% block css %}{% endblock %}</pre></div><p>And before the <code class="literal">&lt;/body&gt;</code> close tag:</p><div class="informalexample"><pre class="programlisting">{{ assets.outputJs('footerJs') }}
{% block javascripts %} {% endblock %}</pre></div><p>The <code class="literal">outputJs</code> and <code class="literal">outputCss</code> methods contain two parameters (<code class="literal">headerCss</code> and <code class="literal">footerJs</code>). These parameters are the names of the assets collections that we are going to build in a few moments. I have added two blocks (<code class="literal">css</code> and <code class="literal">javascripts</code>), because we might want to add some special resource for a certain page.</p><p>Now, we are going to modify the <code class="literal">BaseController.php</code> file, and we will add the assets. Open <code class="literal">Backoffice/Controllers/BaseController.php</code> and append this code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Backoffice\Controllers;

class BaseController extends \Phalcon\Mvc\Controller
{
    public function afterExecuteRoute()
    {
        $this-&gt;buildAssets();
    }

    /**
     * Build the collection of assets
     */
    private function buildAssets()
    {
        $assets_dir = __DIR__.'/../../../public/assets/';

        $this-&gt;assets
            -&gt;collection('headerCss')
            -&gt;addCss($assets_dir.'default/bower_components/bootstrap/dist/css/bootstrap.min.css')
            -&gt;addCss($assets_dir.'default/css/lp.backoffice.css')
            -&gt;setTargetPath('assets/default/prod/backoffice.css')
            -&gt;setTargetUri('../assets/default/prod/backoffice.css')
            -&gt;join(true)
            -&gt;addFilter(new \Phalcon\Assets\Filters\Cssmin());

        $this-&gt;assets
            -&gt;collection('footerJs')
            -&gt;addJs($assets_dir.'default/bower_components/jquery/dist/jquery.min.js')
            -&gt;addJs($assets_dir.'default/bower_components/bootstrap/dist/js/bootstrap.min.js')
            -&gt;addJs($assets_dir.'default/js/lp.js')
            -&gt;setTargetPath('assets/default/prod/backoffice.js')
            -&gt;setTargetUri('../assets/default/prod/backoffice.js')
            -&gt;join(true)
            -&gt;addFilter(new \Phalcon\Assets\Filters\Jsmin());
    }
}</pre></div><p>You can see <a id="id372" class="indexterm"/>the new private method <code class="literal">buildAssets()</code>, where we create the asset groups and use special filters to minify them. After that, we call this method in <code class="literal">afterExecuteRoute()</code>. You can create your own custom filters, if you want, by extending <code class="literal">Phalcon\Assets\FilterInterface</code> class. Note that the output goes to a new folder named <code class="literal">prod</code>. We must create this directory and give it the proper permissions:</p><div class="informalexample"><pre class="programlisting">$ cd public/assets/default
$ mkdir prod &amp;&amp; chmod 777 prod</pre></div><p>If you handle many assets, you might want to save a list in a <code class="literal">config</code> array or something similar. If you use assets from a CDN, you need to pass some special parameter, for example, something like the following.</p><div class="informalexample"><pre class="programlisting">$js-&gt;addJs('cnd.mysite.com/jquery.js', true, false);
// An external resource that does not need filtering.</pre></div><p>Before checking the result, we need to do two more things. First, remove any content from the <code class="literal">IndexController</code> class to <code class="literal">indexAction()</code>. The final <code class="literal">IndexController.php</code> file should look like this:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Backoffice\Controllers;

class IndexController extends BaseController
{
    public function indexAction()
    {
    }
}</pre></div><p>Then, open the template for <code class="literal">IndexAction()</code> that can be found at <code class="literal">Backoffice/Views/Default/index/index.volt</code>, remove any content from it, and append this code to it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>{% extends 'layout.volt' %}</strong></span>
<span class="strong"><strong>{% block body %}</strong></span>
<span class="strong"><strong>Welcome, User !</strong></span>
<span class="strong"><strong>{% endblock %}</strong></span>
</pre></div><p>This is it. You<a id="id373" class="indexterm"/> should now be able to access <code class="literal">http://www.learning-phalcon.localhost/backoffice</code>, and the <a id="id374" class="indexterm"/>result should be exactly the same as that shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_06_01.jpg" alt="Assets management"/><div class="caption"><p>Fig. 1</p></div></div><p>This is pretty much everything about assets manager, which is a simple, yet powerful and useful tool.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note18"/>Note</h3><p>You can see an example of custom filters<a id="id375" class="indexterm"/> in the official documentation at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/assets.html#assets-management">http://docs.phalconphp.com/en/latest/reference/assets.html#assets-management</a>.</p></div></div></div></div>
<div class="section" title="Developing an authentication system"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec42"/>Developing an authentication system</h1></div></div></div><p>There are always parts <a id="id376" class="indexterm"/>within your application that need to be protected. In this section, we will implement an authentication system that is partially based on the user tables that we created in the previous chapters, and we will use Phalcon's ACL component.</p><p>We are not going to reinvent the wheel, so parts of the HTML code are taken from the official Bootstrap<a id="id377" class="indexterm"/> website (<a class="ulink" href="http://getbootstrap.com">http://getbootstrap.com</a>). In addition, you can find parts of the PHP <a id="id378" class="indexterm"/>code in a plugin that I developed a long time ago and which can be found at <a class="ulink" href="https://github.com/calinrada/PhalconUserPlugin">https://github.com/calinrada/PhalconUserPlugin</a>. That being said, let's start developing our authentication system.</p><div class="section" title="The database structure"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec51"/>The database structure</h2></div></div></div><p>We will add a few more tables for<a id="id379" class="indexterm"/> users, and we will create new ones for<a id="id380" class="indexterm"/> the ACL according to the <a id="id381" class="indexterm"/>example found at <a class="ulink" href="https://github.com/phalcon/incubator/tree/master/Library/Phalcon/Acl/Adapter">https://github.com/phalcon/incubator/tree/master/Library/Phalcon/Acl/Adapter</a> because we will use the database adapter. The incubator page contains a structure for the SQLite database, but we are going to "convert it" for MySQL. The new <code class="literal">user_*</code> tables are extracted as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CREATE TABLE IF NOT EXISTS `user_failed_logins` (</strong></span>
<span class="strong"><strong>  `id` int(11) NOT NULL AUTO_INCREMENT,</strong></span>
<span class="strong"><strong>  `user_id` int(11) DEFAULT NULL,</strong></span>
<span class="strong"><strong>  `ip_address` char(15) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>  `attempted` int(11) unsigned NOT NULL,</strong></span>
<span class="strong"><strong>  PRIMARY KEY (`id`),</strong></span>
<span class="strong"><strong>  KEY `usersId` (`user_id`)</strong></span>
<span class="strong"><strong>) ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;</strong></span>

<span class="strong"><strong>CREATE TABLE IF NOT EXISTS `user_remember_tokens` (</strong></span>
<span class="strong"><strong>  `id` int(11) NOT NULL AUTO_INCREMENT,</strong></span>
<span class="strong"><strong>  `user_id` int(11) NOT NULL,</strong></span>
<span class="strong"><strong>  `token` char(32) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>  `user_agent` varchar(255) CHARACTER SET utf8 COLLATE utf8_unicode_ci DEFAULT NULL,</strong></span>
<span class="strong"><strong>  `created_at` int(11) NOT NULL,</strong></span>
<span class="strong"><strong>  PRIMARY KEY (`id`),</strong></span>
<span class="strong"><strong>  KEY `token` (`token`),</strong></span>
<span class="strong"><strong>  KEY `user_id` (`user_id`)</strong></span>
<span class="strong"><strong>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin AUTO_INCREMENT=1 ;</strong></span>

<span class="strong"><strong>CREATE TABLE IF NOT EXISTS `user_success_logins` (</strong></span>
<span class="strong"><strong>  `id` int(11) NOT NULL AUTO_INCREMENT,</strong></span>
<span class="strong"><strong>  `user_id` int(11) NOT NULL,</strong></span>
<span class="strong"><strong>  `ip_address` char(15) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>  `user_agent` varchar(255) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>  `created_at` datetime NOT NULL,</strong></span>
<span class="strong"><strong>  PRIMARY KEY (`id`),</strong></span>
<span class="strong"><strong>  KEY `usersId` (`user_id`)</strong></span>
<span class="strong"><strong>) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_bin AUTO_INCREMENT=1 ;</strong></span>

<span class="strong"><strong>ALTER TABLE `user_failed_logins`</strong></span>
<span class="strong"><strong>    ADD CONSTRAINT `user_failed_logins_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION;</strong></span>

<span class="strong"><strong>ALTER TABLE `user_remember_tokens`</strong></span>
<span class="strong"><strong>    ADD CONSTRAINT `user_remember_tokens_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `article_translation` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION;</strong></span>

<span class="strong"><strong>ALTER TABLE `user_success_logins`</strong></span>
<span class="strong"><strong>    ADD CONSTRAINT `user_success_logins_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION;</strong></span>
</pre></div><p>And the <a id="id382" class="indexterm"/>new <code class="literal">acl_*</code> tables <a id="id383" class="indexterm"/>can look like this:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `acl_access_list` (
  `roles_name` varchar(32) COLLATE utf8_unicode_ci NOT NULL,
  `resources_name` varchar(32) COLLATE utf8_unicode_ci NOT NULL,
  `access_name` varchar(32) COLLATE utf8_unicode_ci NOT NULL,
  `allowed` smallint(3) NOT NULL,
  PRIMARY KEY (`roles_name`,`resources_name`,`access_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

CREATE TABLE IF NOT EXISTS `acl_resources` (
  `name` varchar(32) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL,
  `description` varchar(255) CHARACTER SET utf8 COLLATE utf8_unicode_ci DEFAULT NULL,
  PRIMARY KEY (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE IF NOT EXISTS `acl_resources_accesses` (
  `resources_name` varchar(32) COLLATE utf8_unicode_ci NOT NULL,
  `access_name` varchar(32) COLLATE utf8_unicode_ci NOT NULL,
  PRIMARY KEY (`resources_name`,`access_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

CREATE TABLE IF NOT EXISTS `acl_roles` (
  `name` varchar(32) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL,
  `description` varchar(255) CHARACTER SET utf8 COLLATE utf8_unicode_ci DEFAULT NULL,
  PRIMARY KEY (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE IF NOT EXISTS `acl_roles_inherits` (
  `roles_name` varchar(32) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL,
  `roles_inherit` varchar(32) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL,
  PRIMARY KEY (`roles_name`,`roles_inherit`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;</pre></div></div><div class="section" title="Models"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec52"/>Models</h2></div></div></div><p>Now that we have the <a id="id384" class="indexterm"/>DB structure, we need to generate the models for<a id="id385" class="indexterm"/> the newly created <code class="literal">user_*</code> tables. There is really no point in filling pages with complete models because for now, they will contain only getters and setters. The sort version of our models (without getters and setters) is this:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models;
class UserFailedLogins extends Base
{
    public function getSource()
    {
        return 'user_failed_logins';
    }
}

&lt;?php
namespace App\Core\Models;
class UserSuccessLogins extends Base
{
    public function getSource()
    {
        return 'user_success_logins';
    }
}

&lt;?php
namespace App\Core\Models;
class UserRememberTokens extends Base
{
    public function getSource()
    {
        return 'user_remember_tokens';
    }
}</pre></div><p>You can add the getters and setters on your own or check the source code for this chapter.</p><p>Next, we will add <a id="id386" class="indexterm"/>the relations to the User models so that we can have <a id="id387" class="indexterm"/>quick access to the data from these new tables. Open <code class="literal">App\Core\Models\User.php</code> and append this code to the <code class="literal">initialize()</code> method:</p><div class="informalexample"><pre class="programlisting">$this-&gt;hasMany('id', 'App\Core\Models\UserFailedLogins', 'user_id', array(
    'alias' =&gt; 'failedLogins',
    'foreignKey' =&gt; array(
    'action' =&gt; \Phalcon\Mvc\Model\Relation::ACTION_CASCADE
    )
));

$this-&gt;hasMany('id', 'App\Core\Models\UserSuccessLogins', 'user_id', array(
    'alias' =&gt; 'successLogins',
    'foreignKey' =&gt; array(
    'action' =&gt; \Phalcon\Mvc\Model\Relation::ACTION_CASCADE
    )
));

$this-&gt;hasMany('id', 'App\Core\Models\UserRememberTokens', 'user_id', array(
    'alias' =&gt; 'rememberTokens',
    'foreignKey' =&gt; array(
    'action' =&gt; \Phalcon\Mvc\Model\Relation::ACTION_CASCADE
    )
));</pre></div><p>As for the <code class="literal">acl_*</code> tables, for now, we don't need to create any models. The <code class="literal">acl</code> database adapter will handle most of the data from them. We can also add data manually or create a task for it. We have database tables and models. Next, we will create an authentication component that will interact with them.</p><p>To do this, navigate to <code class="literal">modules/Core/ directory</code> and create a new folder named <code class="literal">Security</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd modules/Core</strong></span>
<span class="strong"><strong>$ mkdir Security</strong></span>
</pre></div><p>In the <code class="literal">security</code><a id="id388" class="indexterm"/> folder, create a new file named <code class="literal">Auth.php</code> and add the <a id="id389" class="indexterm"/>following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Security;

use App\Core\Models\User,
    App\Core\Models\UserRememberTokens,
    App\Core\Models\UserSuccessLogins,
    App\Core\Models\UserFailedLogins;

class Auth extends \Phalcon\Mvc\User\Component
{
    /**
     * Checks the user credentials
     *
     * @param  array  $credentials
     * @return boolean
     */
    public function check($credentials)
    {
        $user = User::findFirstByUserEmail(strtolower($credentials['email']));
        if ($user == false) {
            $this-&gt;registerUserThrottling(null);
            throw new \Exception('Wrong email/password combination');
        }

        if (!$this-&gt;security-&gt;checkHash($credentials['password'], $user-&gt;getUserPassword())) {
                $this-&gt;registerUserThrottling($user-&gt;getId());
                throw new \Exception('Wrong email/password combination');
        }

        $this-&gt;checkUserFlags($user);
        $this-&gt;saveSuccessLogin($user);

        if (isset($credentials['remember'])) {
            $this-&gt;createRememberEnviroment($user);
        }

        $this-&gt;setIdentity($user);
    }

    /**
     * Set identity in session
     *
     * @param object $user
     */
    private function setIdentity($user)
    {
        $st_identity = [
            'id'    =&gt; $user-&gt;getId(),
            'email' =&gt; $user-&gt;getUserEmail(),
            'name'  =&gt; $user-&gt;getUserFirstName().' '.$user-&gt;getUserLastName(),
            'roles' =&gt; [
                'Administrator'
            ]
        ];

        $this-&gt;session-&gt;set('identity', $st_identity);
    }

    /**
     * Login user - normal way
     *
     * @param  App\Core\Forms\UserSigninForm $form
     * @return \Phalcon\Http\ResponseInterface
     */
    public function signin($form)
    {
        if (!$this-&gt;request-&gt;isPost()) {
            if ($this-&gt;hasRememberMe()) {
                return $this-&gt;loginWithRememberMe();
            }
        } else {
            if ($form-&gt;isValid($this-&gt;request-&gt;getPost()) == false) {
                foreach ($form-&gt;getMessages() as $message) {
                    $this-&gt;flashSession-&gt;error($message-&gt;getMessage());
                }
            } else {
                $this-&gt;check([
                    'email'    =&gt; $this-&gt;request-&gt;getPost('email'),
                    'password' =&gt; $this-&gt;request-&gt;getPost('password'),
                    'remember' =&gt; $this-&gt;request-&gt;getPost('remember')
                ]);

                $redirect = $this-&gt;getDI()-&gt;get('config')-&gt;auth-&gt;redirect;

                return $this-&gt;response-&gt;redirect($redirect-&gt;success);
            }
        }

        return false;
    }

    /**
     * Creates the remember me environment settings the related cookies and generating tokens
     */
    public function saveSuccessLogin($user)
    {
        $successLogin = new UserSuccessLogins();
        $successLogin-&gt;setUserId($user-&gt;getId());
        $successLogin-&gt;setIpAddress($this-&gt;request-&gt;getClientAddress());
        $successLogin-&gt;setUserAgent($this-&gt;request-&gt;getUserAgent());

        if (!$successLogin-&gt;save()) {
            $messages = $successLogin-&gt;getMessages();
            throw new \Exception($messages[0]);
        }
    }

    /**
     * Implements login throttling
     * Reduces the efectiveness of brute force attacks
     *
     * @param int $user_id
     */
    public function registerUserThrottling($user_id)
    {
        $failedLogin = new UserFailedLogins();
        $failedLogin-&gt;setUserId($user_id == null ? new \Phalcon\Db\RawValue('NULL') : $user_id);
        $failedLogin-&gt;setIpAddress($this-&gt;request-&gt;getClientAddress());
        $failedLogin-&gt;setAttempted(time());
        $failedLogin-&gt;save();

        $attempts = UserFailedLogins::count([
            'ip_address = ?0 AND attempted &gt;= ?1',
            'bind' =&gt; [
                $this-&gt;request-&gt;getClientAddress(),
                time() - 3600 * 6
            ]
        ]);

        switch ($attempts) {
            case 1:
            case 2:
                // no delay
            break;
            case 3:
            case 4:
                sleep(2);
            break;
            default:
                sleep(4);
            break;
        }
    }

    /**
     * Check if the user is signed in
     *
     * @return boolean
     */
    public function isUserSignedIn()
    {
        $identity = $this-&gt;getIdentity();

        if (is_array($identity)) {
            if (isset($identity['id'])) {
                return true;
            }
        }

        return false;
    }

    /**
     * Checks if the user is banned/inactive/suspended
     *
     * @param App\Core\Models\User $user
     */
    public function checkUserFlags($user)
    {
        if (false === $user-&gt;getUserIsActive()) {
            throw new \Exception('The user is inactive');
        }
    }

    /**
     * Returns the current identity
     *
     * @return array
     */
    public function getIdentity()
    {
        return $this-&gt;session-&gt;get('identity');
    }

    /**
     * Removes the user identity information from session
     */
    public function remove()
    {
        if ($this-&gt;cookies-&gt;has('RMU')) {
            $this-&gt;cookies-&gt;get('RMU')-&gt;delete();
        }

        if ($this-&gt;cookies-&gt;has('RMT')) {
            $this-&gt;cookies-&gt;get('RMT')-&gt;delete();
        }

        $this-&gt;session-&gt;remove('identity');
    }

    public function getUser()
    {
        $identity = $this-&gt;session-&gt;get('identity');

        if (isset($identity['id'])) {
            $user = User::findFirstById($identity['id']);
            if ($user == false) {
                throw new \Exception('The user does not exist');
            }

            return $user;
        }

        return false;
    }

}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note19"/>Note</h3><p>Please note that this is not the complete code due to its size. Please check the source code for this chapter. You can see that this file is extending <code class="literal">\Phalcon\Mvc\User\Component</code>. This means that we already have access to the DI, so we don't have to inject any services because they are already available.</p></div></div><p>Let's analyze a few <a id="id390" class="indexterm"/>of the methods from the <code class="literal">Auth</code> component<a id="id391" class="indexterm"/> a little <a id="id392" class="indexterm"/>bit:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">registerUserThrottling($user_id)</code>: This method logs any failed login attempts with a<a id="id393" class="indexterm"/> time stamp, and it checks the number of attempts for a user from a certain IP. If the number of attempts is greater than three, we will delay the response. This is a simple method to reduce the effectiveness of brute force attacks.</li><li class="listitem" style="list-style-type: disc"><code class="literal">checkUserFlags($user)</code>: This method checks whether or not a user is active. Here, you <a id="id394" class="indexterm"/>can add other checks, for example, whether a user is banned or temporarily suspended.</li><li class="listitem" style="list-style-type: disc"><code class="literal">saveSuccessLogin($user)</code>: This method saves all the successful logins of a user and contains the user <a id="id395" class="indexterm"/>ID, IP, user agent, and the date and time.</li><li class="listitem" style="list-style-type: disc"><code class="literal">createRememberEnviroment($user)</code>: This method (check the source code for <code class="literal">Chapter 6</code>) creates<a id="id396" class="indexterm"/> tokens that we will hold in the database and some cookies. If this operation is successful, next time, we can auto login the user, using this information.</li><li class="listitem" style="list-style-type: disc"><code class="literal">setIdentity($user)</code>: This method simply saves an array containing information about the <a id="id397" class="indexterm"/>current authenticated user in the session. We can retrieve this information by using the <code class="literal">getIdentity()</code> method or directly from the session by calling <code class="literal">$session-&gt;get('identity')</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">check($credentials)</code>: This method is the most important one. Here, we first check whether <a id="id398" class="indexterm"/>there is any user in our database, registered <a id="id399" class="indexterm"/>with the e-mail that we provided. If the user exists, we compare their password with the one that is provided, by making use of the <code class="literal">checkHash()</code> security component. After that, we check whether the user is active, save a log in successful login table, create a <code class="literal">Remember me</code> environment, and then save the information of the user in the session, by calling the <code class="literal">setIdentity()</code> method.</li><li class="listitem" style="list-style-type: disc"><code class="literal">signin($form)</code>: We use <a id="id400" class="indexterm"/>this method to log in the user with the help of a form (and we will create this form in a few moments). If the form is valid, we call the <code class="literal">check()</code> method to validate the credentials. The rest of the methods are quite easy to understand.</li></ul></div><p>We have the <code class="literal">Auth</code> component, but<a id="id401" class="indexterm"/> it is not available just yet. We need to add it<a id="id402" class="indexterm"/> to our DI. Open <code class="literal">modules/Backoffice/Config/services.php</code> and add this code:</p><div class="informalexample"><pre class="programlisting">$di['auth'] = function () use ($di) {
    return new App\Core\Security\Auth();
};</pre></div><p>Then, open the <code class="literal">config.php</code> file and append this code to the <code class="literal">$module_config</code> array:</p><div class="informalexample"><pre class="programlisting">    'auth' =&gt; array(
        'redirect' =&gt; array(
            'success' =&gt; 'index/index',
            'failure' =&gt; 'auth/signin',
        ),
    ),</pre></div><p>The component is now active, and we can use it. We will create the templates, forms, and controllers for a sign in action. Navigate to <code class="literal">modules/Backoffice/Controllers</code> and create a new file named <code class="literal">AuthController.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Backoffice\Controllers;

use App\Core\Forms\UserSigninForm;

class AuthController extends BaseController
{
    public function signinAction()
    {
        $form = new UserSigninForm();

        if ($this-&gt;request-&gt;isPost()) {
            try {
                $this-&gt;auth-&gt;signin($form);
            } catch (\Exception $e) {
                $this-&gt;flash-&gt;error($e-&gt;getMessage());
            }
        }

        $this-&gt;view-&gt;signinForm = $form;
    }

    public function signoutAction()
    {
        $this-&gt;auth-&gt;remove();

        return $this-&gt;response-&gt;redirect('auth/signin');
    }
}</pre></div><p>We don't have the <code class="literal">UserSinginForm</code>. Navigate to <code class="literal">modules/Core/</code> directory and create a new folder named <code class="literal">Forms</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd modules/Core</strong></span>
<span class="strong"><strong>$ mkdir Forms</strong></span>
</pre></div><p>In the <code class="literal">Forms</code> directory, create <a id="id403" class="indexterm"/>a new file named <code class="literal">UserSigninForm.php</code> with the<a id="id404" class="indexterm"/> following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Forms;

use Phalcon\Forms\Form;
use Phalcon\Forms\Element\Text;
use Phalcon\Forms\Element\Password;
use Phalcon\Forms\Element\Submit;
use Phalcon\Forms\Element\Check;
use Phalcon\Forms\Element\Hidden;
use Phalcon\Validation\Validator\PresenceOf;
use Phalcon\Validation\Validator\Email;
use Phalcon\Validation\Validator\Identical;

class UserSigninForm extends Form
{
    public function initialize()
    {
        $email = new Text('email', array(
            'placeholder' =&gt; 'Email',
        ));

        $email-&gt;addValidators(array(
            new PresenceOf(array(
                'message' =&gt; 'The e-mail is required',
            )),
            new Email(array(
                'message' =&gt; 'The e-mail is not valid',
            )),
        ));

        $this-&gt;add($email);

        //Password
        $password = new Password('password', array(
            'placeholder' =&gt; 'Password',
        ));

        $password-&gt;addValidator(
            new PresenceOf(array(
                'message' =&gt; 'The password is required',
            ))
        );

        $this-&gt;add($password);

        //Remember
        $remember = new Check('remember', array(
            'value' =&gt; 'yes',
        ));

        $remember-&gt;setLabel('Remember me');

        $this-&gt;add($remember);

        //CSRF (Cross-Site Request Forgery)
        $csrf = new Hidden('csrf');

        $csrf-&gt;addValidator(
            new Identical(array(
                'value' =&gt; $this-&gt;security-&gt;getSessionToken(),
                'message' =&gt; 'CSRF validation failed',
            ))
        );

        $this-&gt;add($csrf);

        $this-&gt;add(new Submit('signin', array(
            'class' =&gt; 'btn btn-lg btn-primary btn-block',
        )));
    }
}</pre></div><p>You might have<a id="id405" class="indexterm"/> noticed that we are using <span class="strong"><strong>CSRF</strong></span> fields in order to <a id="id406" class="indexterm"/>prevent <span class="strong"><strong>Cross-Site Request Forgery</strong></span> attacks. If you have no idea what this is, please take a few moments and read about<a id="id407" class="indexterm"/> it at <a class="ulink" href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet">https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet</a>.</p><p>Next, we will create the templates. We will use the example template from <a class="ulink" href="http://getbootstrap.com/examples/signin/">http://getbootstrap.com/examples/signin/</a>, but we will adapt it to our needs. Since our main template, <code class="literal">layout.volt</code>, contains information that would be available just to authenticated users, we will clone this template and clean it so that we can use it for our sign in action and other actions that requires simple templates. Navigate to <code class="literal">modules/Backoffice/Views/Default/</code> and duplicate the <code class="literal">layout.volt</code> file by renaming it to <code class="literal">layout_simple.volt</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd modules/Backoffice/Views/Default/</strong></span>
<span class="strong"><strong>$ cp layout.volt layout_simple.volt</strong></span>
</pre></div><p>Then, remove the code from <code class="literal">layout_simple.volt</code> and append the new cleaned code:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
&lt;meta charset="utf-8"&gt;
&lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
&lt;title&gt;{% block pageTitle %}Learning Phalcon{% endblock %}&lt;/title&gt;

{{ assets.outputCss('headerCss') }}
{% block css %}{% endblock %}

&lt;!--[if lt IE 9]&gt;       &lt;script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"&gt;&lt;/script&gt;
      &lt;script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"&gt;&lt;/script&gt;
&lt;![endif]--&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container-fluid"&gt;
      &lt;div class="row"&gt;
        &lt;div class="col-sm-12 main"&gt;
          {% block body %}

          {% endblock %}
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    {{ assets.outputJs('footerJs') }}
    {% block javascripts %} {% endblock %}
&lt;/body&gt;
&lt;/html&gt;</pre></div><p>The final step is to <a id="id408" class="indexterm"/>create the template for <code class="literal">signingAction()</code>. Navigate <a id="id409" class="indexterm"/>to <code class="literal">modules/Backoffice/Views/Default</code> and create a new folder named <code class="literal">auth</code>. After that, in the <code class="literal">auth</code> folder, create a file named <code class="literal">signin.volt</code> with the following content:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>{% extends 'layout_simple.volt' %}</strong></span>
<span class="strong"><strong>{% block pageTitle %}Sign in{% endblock %}</strong></span>
<span class="strong"><strong>{% block css %}</strong></span>
<span class="strong"><strong>    {{ assets.outputCss('signin') }}</strong></span>
<span class="strong"><strong>{% endblock %}</strong></span>
<span class="strong"><strong>{% block body %}</strong></span>

<span class="strong"><strong>&lt;form class="form-signin" method="post" action=""&gt;</strong></span>
<span class="strong"><strong>    {{ content() ~ flashSession.output() }}</strong></span>
<span class="strong"><strong>    &lt;h2 class="form-signin-heading"&gt;Sign in&lt;/h2&gt;</strong></span>
<span class="strong"><strong>    &lt;label for="inputEmail" class="sr-only"&gt;Email address&lt;/label&gt;</strong></span>
<span class="strong"><strong>    {{ signinForm.render('email', {'class':'form-control', 'required':true, 'autofocus':true, 'type':'email'}) }}</strong></span>
<span class="strong"><strong>    &lt;label for="inputPassword" class="sr-only"&gt;Password&lt;/label&gt;</strong></span>
<span class="strong"><strong>    {{ signinForm.render('password', {'class':'form-control', 'required':true}) }}</strong></span>
<span class="strong"><strong>    &lt;div class="checkbox"&gt;</strong></span>
<span class="strong"><strong>        &lt;label&gt;</strong></span>
<span class="strong"><strong>           {{ signinForm.render('remember') }} Remember me</strong></span>
<span class="strong"><strong>        &lt;/label&gt;</strong></span>
<span class="strong"><strong>    &lt;/div&gt;</strong></span>
<span class="strong"><strong>    {{ signinForm.render('signin', {'value':'Sign in'}) }}</strong></span>
<span class="strong"><strong>    {{ signinForm.render('csrf', {'value':security.getToken()}) }}</strong></span>
<span class="strong"><strong>&lt;/form&gt;</strong></span>

<span class="strong"><strong>{% endblock %}</strong></span>
</pre></div><p>The <code class="literal">signin.volt</code> template extends the newly created <code class="literal">layout_simple.volt</code>. Note the new <code class="literal">css</code> block. We have added a new <code class="literal">css</code> group named <code class="literal">signin</code>. We will enable it in a few moments. The <code class="literal">{{ content() ~ flashSession.output() }}</code> line is a concatenation, because the <code class="literal">flashSession</code> component is not returned in the <code class="literal">content()</code> file. So, if we output just the <code class="literal">content()</code> method, the <code class="literal">flashSession</code> messages will not be seen.</p><p>The template is<a id="id410" class="indexterm"/> missing a <code class="literal">css</code> file. We need to create it and add <a id="id411" class="indexterm"/>it to our assets collection. To do this, navigate to <code class="literal">public/assets/default/css/</code> and create a new file named <code class="literal">lp.backoffice.signin.css</code> with the following content:</p><div class="informalexample"><pre class="programlisting">body {
  padding-top: 40px;
  padding-bottom: 40px;
  background-color: #eee;
}

.form-signin {
  max-width: 330px;
  padding: 15px;
  margin: 0 auto;
}

.form-signin .form-signin-heading,
.form-signin .checkbox {
  margin-bottom: 10px;
}

.form-signin .checkbox {
  font-weight: normal;
}

.form-signin .form-control {
  position: relative;
  height: auto;
  -webkit-box-sizing: border-box;
     -moz-box-sizing: border-box;
          box-sizing: border-box;
  padding: 10px;
  font-size: 16px;
}

.form-signin .form-control:focus {
  z-index: 2;
}

.form-signin input[type="email"] {
  margin-bottom: -1px;
  border-bottom-right-radius: 0;
  border-bottom-left-radius: 0;
}

.form-signin input[type="password"] {
  margin-bottom: 10px;
  border-top-left-radius: 0;
  border-top-right-radius: 0;
}</pre></div><p>Then, we add this <a id="id412" class="indexterm"/>file to<a id="id413" class="indexterm"/> our <code class="literal">assets</code> collection. Open <code class="literal">modules/Backoffice/Controllers/BaseController.php</code> and append the following code to the <code class="literal">buildAssets()</code> method:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$this-&gt;assets</strong></span>
<span class="strong"><strong>  -&gt;collection('signin')</strong></span>
<span class="strong"><strong>  -&gt;addCss($assets_dir.'default/css/lp.backoffice.signin.css')</strong></span>
<span class="strong"><strong>  -&gt;setTargetPath('assets/default/prod/backoffice.signin.css')</strong></span>
<span class="strong"><strong>  -&gt;setTargetUri('../assets/default/prod/backoffice.signin.css')</strong></span>
<span class="strong"><strong>  -&gt;addFilter(new \Phalcon\Assets\Filters\Cssmin());</strong></span>
</pre></div><p>This should be all. Our <code class="literal">Backoffice</code>  module is not yet protected, but we can actually do a <code class="literal">signin</code> action. Using your browser, go to <code class="literal">http://www.learning-phalcon.localhost/backoffice/auth/signin</code>, and you should be able to see the exact result that is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_06_02.jpg" alt="Models"/><div class="caption"><p>The <span class="strong"><strong>Sign in</strong></span> page</p></div></div><p>If you already<a id="id414" class="indexterm"/> have a user name, you can try to log in. If not, you can create <a id="id415" class="indexterm"/>a new user using the task that we created in <a class="link" href="ch04.html" title="Chapter 4. Database Architecture, Models, and CLI Applications">Chapter 4</a>, <span class="emphasis"><em>Database Architecture, Models, and CLI Applications</em></span>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php modules/cli.php user create John Doe john.doe@learning-phalcon.localhost myPassw0rd 1 Barcelona 1985-03-25</strong></span>
</pre></div><p>This will create a user who has the e-mail address as <code class="literal">john.doe@learning-phalcon.localhost</code> and the password as <code class="literal">myPassw0rd</code>. You can use these details to test the form. On success, you will be redirected to index page, on failure; you will see some error messages.</p><p>Now that we have a fully functional authentication system, we can secure the entire application. For this, we will make use of Phalcon's <code class="literal">Acl</code> component.</p></div></div>
<div class="section" title="Securing the application using the ACL component"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec43"/>Securing the application using the ACL component</h1></div></div></div><p>An ACL is <a id="id416" class="indexterm"/>very useful when you have users with <a id="id417" class="indexterm"/>different roles. For example, an administrator should have unlimited access, but an editor should have access only to the Articles section. We already have the database structure for the Acl, so we just need to create some relations. First, we will create a new intermediate table named <code class="literal">user_roles</code> that will hold information about each user's role. A user can have many roles.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CREATE TABLE IF NOT EXISTS `user_role` (</strong></span>
<span class="strong"><strong>  `user_id` int(11) NOT NULL,</strong></span>
<span class="strong"><strong>  `role` varchar(32) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>  UNIQUE KEY `user_id_2` (`user_id`,`role`),</strong></span>
<span class="strong"><strong>  KEY `role` (`role`)</strong></span>
<span class="strong"><strong>) ENGINE=InnoDB DEFAULT CHARSET=latin1;</strong></span>

<span class="strong"><strong>ALTER TABLE `user_role`</strong></span>
<span class="strong"><strong>  ADD CONSTRAINT `user_role_ibfk_2` FOREIGN KEY (`role`) REFERENCES `acl_roles` (`name`) ON DELETE CASCADE ON UPDATE CASCADE,</strong></span>
<span class="strong"><strong>  ADD CONSTRAINT `user_role_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION;</strong></span>
</pre></div><p>Another thing that we can do is get rid of the <code class="literal">user_group</code> table since we are not going to use it anymore.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Delete the <code class="literal">modules/Core/Models/UserGroup.php</code> file.</li><li class="listitem">Remove this code from <code class="literal">User.php</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$this-&gt;hasOne('user_group_id', 'App\Core\Models\UserGroups', 'id', array(</strong></span>
<span class="strong"><strong>  'alias' =&gt; 'group',</strong></span>
<span class="strong"><strong>  'reusable' =&gt; true,</strong></span>
<span class="strong"><strong>));</strong></span>
</pre></div></li><li class="listitem">Remove the column from <code class="literal">user</code> table and drop the <code class="literal">user_group</code> table:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ALTER TABLE `user` DROP FOREIGN KEY `user_ibfk_1` ;</strong></span>
<span class="strong"><strong>ALTER TABLE  `user` DROP  `user_group_id` ;</strong></span>
<span class="strong"><strong>DROP TABLE user_group;</strong></span>
</pre></div></li><li class="listitem">Update the user <code class="literal">create()</code> method by navigating to <code class="literal">Core/Managers/UserManager.php</code>, and remove the following lines of code:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$user_group_id = $this-&gt;findFirstGroupByName($user_group_name)-&gt;getId();</strong></span>
<span class="strong"><strong>$user-&gt;setUserGroupId($user_group_id);</strong></span>
</pre></div></li><li class="listitem">On the <code class="literal">create()</code> method, replace the <code class="literal">param $user_group_name = 'User'</code> with <code class="literal">$user_role = 'Guest'</code>. (We will implement the functionality in a few moments.)</li></ol></div><p>Now, let's create <a id="id418" class="indexterm"/>the models from <code class="literal">user_role</code> and <code class="literal">acl_roles</code>. Remember <a id="id419" class="indexterm"/>that I will not write down the getters and the setters, just the important stuff.</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models;

class UserRole extends Base
{
    public function initialize()
    {
        $this-&gt;belongsTo('user_id', 'App\Core\Models\User', 'id', array(
            'foreignKey' =&gt; true,
            'reusable' =&gt; true,
            'alias' =&gt; 'user',
        ));

        $this-&gt;belongsTo('user_role', 'App\Core\Models\AclRoles', 'name', array(
            'foreignKey' =&gt; true,
            'reusable' =&gt; true,
            'alias' =&gt; 'role',
        ));
    }
}</pre></div><div class="informalexample"><pre class="programlisting">&lt;?php

namespace App\Core\Models;

class AclRoles extends Base
{
// Nothing important here for now, just getters and setters
}</pre></div><p>We need to make some changes to the <code class="literal">create()</code> method from <code class="literal">UserManager.php</code> in order to assign existing roles to a user. The new method should look like this:</p><div class="informalexample"><pre class="programlisting">    public function create($data, $user_role = 'Guest')
    {
        $security = $this-&gt;getDI()-&gt;get('security');

        $user = new User();
        $user-&gt;setUserFirstName($data['user_first_name']);
        $user-&gt;setUserLastName($data['user_last_name']);
        $user-&gt;setUserEmail($data['user_email']);
        $user-&gt;setUserPassword($security-&gt;hash($data['user_password']));
        $user-&gt;setUserIsActive($data['user_is_active']);


        $o_acl_role  = AclRoles::findFirstByName($user_role);

        if (!$o_acl_role) {
            throw new \Exception("Role $user_role does not exists");
        };

        $o_user_role[0] = new UserRole();
        $o_user_role[0]-&gt;setUserRole($user_role);

        $user-&gt;roles = $o_user_role;

        $profile = new UserProfile();
        $profile-&gt;setUserProfileLocation($data['user_profile_location']);
        $profile-&gt;setUserProfileBirthday($data['user_profile_birthday']);

        $user-&gt;profile = $profile;

        return $this-&gt;save($user);
    }</pre></div><p>The reason why <a id="id420" class="indexterm"/>we define <code class="literal">$o_user_role</code> as <a id="id421" class="indexterm"/>array collection of objects is because the relationship between a user and the roles is one-to-many. We also need to modify the <code class="literal">createAction()</code> method from the <code class="literal">UserTask.php</code>. Open the file located at <code class="literal">modules/Tasks/UserTask.php</code> and append the user's role as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$user = $manager-&gt;create(array(</strong></span>
<span class="strong"><strong>    'user_first_name' =&gt; $params[0],</strong></span>
<span class="strong"><strong>    'user_last_name' =&gt; $params[1],</strong></span>
<span class="strong"><strong>    'user_email' =&gt; $params[2],</strong></span>
<span class="strong"><strong>    'user_password' =&gt; $params[3],</strong></span>
<span class="strong"><strong>    'user_is_active' =&gt; $params[4],</strong></span>
<span class="strong"><strong>    'user_profile_location' =&gt; $params[5],</strong></span>
<span class="strong"><strong>    'user_profile_birthday' =&gt; $params[6],</strong></span>
<span class="strong"><strong>), 'Guest');</strong></span>
</pre></div><p>We will use <code class="literal">Guest</code> by <a id="id422" class="indexterm"/>default. Later, we will create a method that <a id="id423" class="indexterm"/>will add and remove roles for a user. Now, we are going to implement the security check. Switch to <code class="literal">modules/Core/Security</code> folder and create a new file with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Security;

class Acl extends \Phalcon\Mvc\User\Plugin
{
    public function beforeDispatch(\Phalcon\Events\Event $event, \Phalcon\Mvc\Dispatcher $dispatcher)
    {
        $controller = $dispatcher-&gt;getControllerName();
        $action     = $dispatcher-&gt;getActionName();
        $redirect   = $this-&gt;getDI()-&gt;get('config')-&gt;auth-&gt;redirect;

        if ($controller == 'auth' &amp;&amp; $action == 'signin') {
            return true;
        }

        $account = $this-&gt;auth-&gt;getIdentity();

        if (!$account) {
            if ($this-&gt;getDI()-&gt;get('auth')-&gt;hasRememberMe()) {
                return $this-&gt;getDI()-&gt;get('auth')-&gt;loginWithRememberMe();
            }
        }

        if (!is_array($account) || !array_key_exists('roles', $account)) {

            $this-&gt;view-&gt;disable();
            $this-&gt;response-&gt;setStatusCode(403, 'Forbidden');
            $this-&gt;flashSession-&gt;error('You are not allowed to access this section');
            return $this-&gt;response-&gt;redirect($redirect-&gt;failure);
        }

        $acl = $this-&gt;getDI()-&gt;get('acl');

        foreach ($account['roles'] as $role) {
            if ($acl-&gt;isAllowed($role, $controller, $action) == \Phalcon\Acl::ALLOW) {
                return true;
            }
        }

        $this-&gt;view-&gt;disable();
        $this-&gt;response-&gt;setStatusCode(403, 'Forbidden');
        return $this-&gt;response-&gt;redirect($redirect-&gt;failure);
    }
}</pre></div><p>Basically, using <a id="id424" class="indexterm"/>the <code class="literal">beforeDispatch()</code> method, we check for what the user is requesting, whether it is authenticated, and <a id="id425" class="indexterm"/>whether the role that they have allows them to access a certain resource. We need to enable the <code class="literal">Acl</code> service and attach the <code class="literal">Acl</code> to the events manager. In <code class="literal">config/services.php</code> (globally), add the setting for the <code class="literal">Acl</code> service:</p><div class="informalexample"><pre class="programlisting">$di['acl'] = function () use ($di) {
    $acl = new \Phalcon\Acl\Adapter\Database([
        'db' =&gt; $di['db'],
        'roles' =&gt; 'acl_roles',
        'rolesInherits' =&gt; 'acl_roles_inherits',
        'resources' =&gt; 'acl_resources',
        'resourcesAccesses' =&gt; 'acl_resources_accesses',
        'accessList' =&gt; 'acl_access_list',
    ]);

    $acl-&gt;setDefaultAction(\Phalcon\Acl::DENY);

    return $acl;
};</pre></div><p>Then, update the dispatcher with the following code:</p><div class="informalexample"><pre class="programlisting">$di['dispatcher'] = function () use ($di) {
    $eventsManager = $di-&gt;getShared('eventsManager');

    $eventsManager-&gt;attach('dispatch', new App\Core\Security\Acl($di));

    $dispatcher = new \Phalcon\Mvc\Dispatcher();
    $dispatcher-&gt;setEventsManager($eventsManager);
    $dispatcher-&gt;setDefaultNamespace("App\Backoffice\Controllers");

    return $dispatcher;
};</pre></div><p>We will also <a id="id426" class="indexterm"/>need to update the <code class="literal">setIdentity()</code> method <a id="id427" class="indexterm"/>from <code class="literal">Auth.php</code>. Replace it with this code to get the user roles from the database:</p><div class="informalexample"><pre class="programlisting">private function setIdentity($user)
{
    $roles = [];
    foreach ($user-&gt;roles as $role) {
      $roles[] = $role-&gt;getUserRole();
    }

    $st_identity = [
      'id'    =&gt; $user-&gt;getId(),
      'email' =&gt; $user-&gt;getUserEmail(),
      'name'  =&gt; $user-&gt;getUserFirstName().' '.$user-&gt;getUserLastName(),
      'roles' =&gt; $roles
    ];

    $this-&gt;session-&gt;set('identity', $st_identity);
}</pre></div><p>If you followed the steps closely and did everything by the book, you should be able to access <code class="literal">http://www.learning-phalcon.localhost/backoffice/</code>; the browser will redirect you to the <span class="strong"><strong>Sign in</strong></span> page (the same page where we saw the <span class="strong"><strong>Sign in</strong></span> page).</p><p>We are almost at the end of this chapter. What we will do next is create a task that will handle <code class="literal">Acl</code>, and we will use this task in the future when we need to modify someone's permissions. Let's see how a simple task for <code class="literal">Acl</code> can look.</p><p>Switch to <code class="literal">modules/Tasks</code> and create a new file named <code class="literal">AclTask.php</code>, with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class AclTask extends BaseTask
{
    /**
     *
     * @var \Phalcon\Acl\Adapter\Database
     */
    private $acl;

    public function __construct()
    {
        $this-&gt;acl = $this-&gt;getDI()-&gt;get('acl');
    }

    /**
     * @Description("Install the initial(default) acl resources")
     */
    public function initAction()
    {
        $roles = array(
            'Administrator' =&gt; new \Phalcon\Acl\Role('Administrator'),
            'Guest' =&gt; new \Phalcon\Acl\Role('Guest'),
        );

        foreach ($roles as $role) {
            $this-&gt;acl-&gt;addRole($role);
        }

        $userResources = array(
            'index' =&gt; array('index'),
        );

        foreach ($userResources as $resource =&gt; $actions) {
            //$this-&gt;acl-&gt;addResource(new \Phalcon\Acl\Resource($resource), $actions);
            foreach ($actions as $action) {
                $this-&gt;acl-&gt;allow('Administrator', $resource, $action);
            }
        }

        $this-&gt;consoleLog('Default resources created');
    }
}</pre></div><p>We created only<a id="id428" class="indexterm"/> one method named <code class="literal">initAction()</code> that <a id="id429" class="indexterm"/>will create the two default acl roles: <code class="literal">Administrator</code> and <code class="literal">Guest</code>. An administrator will be allowed to access everything, whereas a <code class="literal">Guest</code> role will be able to access nothing. Run this task:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php modules/cli.php acl init</strong></span>
</pre></div><p>Now you should be able to see records in your database with the two roles inserted. If you see them, you can navigate to the <code class="literal">user_role</code> table and insert an <code class="literal">Administrator</code> role for your user, then try to login, then delete the <code class="literal">Administrator</code> role and add the <code class="literal">Guest</code> one. We will add more methods to this task in the next chapters.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec44"/>Summary</h1></div></div></div><p>In this chapter, you learned about assets management and Access Control List. We also developed an authentication system for our application. We will continue our journey with the development of the <code class="literal">Backoffice</code> module, where you will learn more about Forms, Volt, and Models.</p></div></body></html>