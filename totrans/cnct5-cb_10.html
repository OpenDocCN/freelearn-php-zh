<html><head></head><body><div class="appendix" title="Appendix&#xA0;A.&#xA0;Blueprint &#x2013; Creating an Image Gallery Add-on"><div class="titlepage"><div><div><h1 class="title"><a id="appA"/>Appendix A. Blueprint – Creating an Image Gallery Add-on</h1></div></div></div><p>Now that we have learned dozens of concrete5 recipes, it is time to put them to practical use. Think of this chapter as one giant recipe, with the sole purpose of creating an image gallery add-on, which you can install on your concrete5 website and begin using right away. If you visit the website for this book, there is a complete download of the source code to help you out if you get stuck.</p><div class="section" title="Before we begin..."><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec159"/>Before we begin...</h1></div></div></div><p>This entire chapter was developed with a fresh installation of concrete5 Version 5.6.1.2, though the code will technically work for any concrete5 after Version 5.6. If you'd like to follow along exactly, get a new version of concrete5 running on your development server and install the sample content with it. That will give us some pages and images to work with.</p></div></div>
<div class="section" title="Creating the package controller"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec160"/>Creating the package controller</h1></div></div></div><p>The first step in creating our <a id="id591" class="indexterm"/>add-on is to create the directories and files.</p><p>Create a new directory in <code class="literal">/packages</code> called <code class="literal">cookbook_gallery</code>. The first file we will need is <code class="literal">controller.php</code>.</p><p>Enter the following code in <code class="literal">controller.php</code> to define the add-on:</p><div class="informalexample"><pre class="programlisting">&lt;?php
defined('C5_EXECUTE') or die(_("Access Denied."));

class CookbookGalleryPackage extends Package {
  protected $pkgHandle = 'cookbook_gallery';

  protected $appVersionRequired = '5.6.0';
  protected $pkgVersion = '0.9.0';

  public function getPackageName() {
    return t('Cookbook Gallery');
  }

  public function getPackageDescription() {
    return t('An image gallery that ties into the file manager.');
  }

}</pre></div><p>You may recall from <a class="link" href="ch08.html" title="Chapter 8. Working with Themes and Add-ons">Chapter 8</a>, <span class="emphasis"><em>Working with Themes and Add-Ons</em></span>, that packages only require one file, the <code class="literal">controller</code>. The <code class="literal">controller</code> file contains methods that tell concrete5 what the package's name is, and a text description of the package.</p><p>There are a few things we need to make note of here. First, notice the class name of the controller. Since our package handle is <code class="literal">cookbook_gallery</code>, we need to camel case that handle and append the package to the end, to create the class name that concrete5 can predict and load correctly.</p><p>The next thing we need is the <code class="literal">defined</code> or <code class="literal">die</code> statement at the top of the file. This is a special security requirement of <a id="id592" class="indexterm"/>concrete5 to ensure that scripts cannot be executed arbitrarily. Everything has to get run through the concrete5 dispatcher. This statement is required at the top of every <code class="literal">.php</code> (excluding third-party libraries that exist in <code class="literal">libraries/3rd_party</code>) file in your package if you plan on submitting the package to the concrete5 marketplace.</p><p>Another thing that we need to pay attention to is that all public facing strings are encased in the <code class="literal">t()</code> function (see the package name and description). The <code class="literal">t()</code> function, as discussed in <a class="link" href="ch09.html" title="Chapter 9. System Events and Advanced Configuration">Chapter 9</a>, <span class="emphasis"><em>System Events and Advanced Configuration</em></span> allows translators to supply alternate translations for the given string. This is another requirement for add-ons to be submitted into the concrete5 marketplace.</p><p>We aren't done with the controller yet; we will need to come back and add the installation function once our block is created.</p></div>
<div class="section" title="Creating the block type"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec161"/>Creating the block type</h1></div></div></div><p>Our image gallery is going to be a <a id="id593" class="indexterm"/>custom block type. This block type can be added to any page in the concrete5 site, and will show an image gallery wherever it is placed. The first thing we will need to do is create the block's directory. Add a new directory in <code class="literal">/packages/cookbook_gallery/blocks</code>. Inside the new block's directory, add a directory called <code class="literal">cookbook_gallery</code>. This will contain our block's files.</p><div class="section" title="The block's controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec564"/>The block's controller</h2></div></div></div><p>First up for our block type is the <code class="literal">controller</code> file. Create <code class="literal">controller.php</code> in <code class="literal">/packages/cookbook_gallery_blocks/cookbook_gallery</code>.</p><p>Declare the block <code class="literal">controller</code> <a id="id594" class="indexterm"/>class and add the following methods:</p><div class="informalexample"><pre class="programlisting">&lt;?php defined('C5_EXECUTE') or die(_("Access Denied."));

class CookbookGalleryBlockController extends BlockController {

  protected $btTable = "btCookbookGallery";
  protected $btInterfaceWidth = "350";
  protected $btInterfaceHeight = "300";

  var $defaultCount = 20;

  public function getBlockTypeName() {
    return t('Photo Gallery');
  }

  public function getBlockTypeDescription() {
    return t('Shows photos from a file set.');
  }
  
}</pre></div><p>Again, notice the <code class="literal">defined</code> or <code class="literal">die</code> statement at the top of the file and the use of <code class="literal">t()</code> functions to wrap our public facing strings. We have also defined the name of the block's database table, using the member variable <code class="literal">$btTable</code>.</p><p>Save the <code class="literal">controller</code> file, we will be coming back to it later to add our block's functionality.</p></div><div class="section" title="The database XML file"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec565"/>The database XML file</h2></div></div></div><p>The next file that our block type needs is the database XML file. Create it at <code class="literal">/packages/cookbook_gallery/blocks/cookbook_gallery/db.xml</code>. This file defines all of the tables <a id="id595" class="indexterm"/>and fields that the block type will need. concrete5 will automatically create the defined tables when the block type is installed.</p><p>You may recall from <a class="link" href="ch02.html" title="Chapter 2. Working with Blocks">Chapter 2</a>, <span class="emphasis"><em>Working with Blocks</em></span> that this file makes use of ADOdb's XML schema (or AXMLS). You can learn more about AXMLS on the ADOdb website, located at <a class="ulink" href="http://phplens.com/lens/adodb/docs-datadict.htm#xmlschema">http://phplens.com/lens/adodb/docs-datadict.htm#xmlschema</a>.</p><p>Enter the following XML code in <code class="literal">db.xml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;schema version="0.3"&gt;
  &lt;table name="btCookbookGallery"&gt;
    &lt;field name="bID" type="I"&gt;
      &lt;key /&gt;
      &lt;unsigned /&gt;
    &lt;/field&gt;
    &lt;field name="file_set" type="I"&gt;&lt;/field&gt;
    &lt;field name="count" type="I"&gt;&lt;/field&gt;
  &lt;/table&gt;
&lt;/schema&gt;</pre></div><p>We created a database table with the same name that we specified in the block type's controller. The table has <a id="id596" class="indexterm"/>two fields, a unique integer ID called <code class="literal">bID</code> (which is required for the block to be installed), and an integer file set ID field. Save this <code class="literal">db.xml</code> file, and you can close it if you'd like, as we won't be needing it again.</p></div><div class="section" title="The block type's view files"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec566"/>The block type's view files</h2></div></div></div><p>Finally, we will need to create files for the various views for the block. The block has three views—add, edit, and view. <a id="id597" class="indexterm"/>Create <code class="literal">add.php</code>, <code class="literal">edit.php</code>, and <code class="literal">view.php</code> in the block's directory. Since add and edit share the same HTML, we will create a shared template that both views will include, called <code class="literal">form.php</code>. Oh, why not create <code class="literal">view.css</code> as well, since our view file will need to use some styles.</p><p>The resulting contents of our new package are in the following screenshot:</p><div class="mediaobject"><img src="graphics/4548OS_A_01.jpg" alt="The block type's view files"/></div><p>Let's leave these view files empty for <a id="id598" class="indexterm"/>now, because we want to install our block type and its package to the website!</p></div></div>
<div class="section" title="Installing the block type with the package"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec162"/>Installing the block type with the package</h1></div></div></div><p>Right now, if we were to <a id="id599" class="indexterm"/>install the package, the block type would not come with it, and users of your add-on would be confused and disappointed. We can tell the <a id="id600" class="indexterm"/>package to install the block type during the package's installation, though.</p><p>Open the package <code class="literal">controller</code> (<code class="literal">/packages/cookbook_gallery/controller.php</code>) in your code editor.</p><p>Add a new method to the <code class="literal">controller</code> class called <code class="literal">install</code>, as follows:</p><div class="informalexample"><pre class="programlisting">public function install() {
  $pkg = parent::install();

  // install the block type
  BlockType::installBlockTypeFromPackage('cookbook_gallery', $pkg); 
}</pre></div><p>What's going on here? Well, the <code class="literal">Package</code> class has a function called <code class="literal">install</code>, which, you guessed it, installs the package to the concrete5 database. Since our package controller extends the <code class="literal">Package</code> class, <a id="id601" class="indexterm"/>the <code class="literal">install</code> function is automatically available to us.</p><p>The first step is to call the <code class="literal">Package</code> class's <code class="literal">install</code> function and get the object that it returns. This will allow us to install <a id="id602" class="indexterm"/>the block type and have it assigned to our package.</p><p>It's important to pass the <code class="literal">$pkg</code> object to the block type installer, because if users uninstall or reinstall your add-on, the block type will come and go with it.</p><p>Save the controller file. It's time to install our add-on!</p><div class="section" title="Installing the package in concrete5"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec567"/>Installing the package in concrete5</h2></div></div></div><p>Visit <code class="literal">/dashboard/extend/install/</code> on your concrete5 site (you'll have to log in if your haven't already). You will <a id="id603" class="indexterm"/>see <a id="id604" class="indexterm"/>your add-on awaiting installation.</p><p>The gallery add-on awaiting installation is as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/4548OS_A_02.jpg" alt="Installing the package in concrete5"/></div><p>Click on the <span class="strong"><strong>Install</strong></span> button. <a id="id605" class="indexterm"/>concrete5 will add your package and its block controller to the site. If it succeeds, you will <a id="id606" class="indexterm"/>see a message at the top of the screen.</p><p>After successful installation of the add-on, we see the following screenshot:</p><div class="mediaobject"><img src="graphics/4548OS_A_03.jpg" alt="Installing the package in concrete5"/></div></div><div class="section" title="Creating a page for the gallery"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec568"/>Creating a page for the gallery</h2></div></div></div><p>Visit your concrete5 <a id="id607" class="indexterm"/>homepage and hover over the <span class="strong"><strong>Edit</strong></span> button to add a <a id="id608" class="indexterm"/>sub-page underneath the home page.</p><div class="mediaobject"><img src="graphics/4548OS_A_04.jpg" alt="Creating a page for the gallery"/></div><p>Let's use the <a id="id609" class="indexterm"/>
<span class="strong"><strong>Full</strong></span> <a id="id610" class="indexterm"/>layout for this gallery page.</p><div class="mediaobject"><img src="graphics/4548OS_A_05.jpg" alt="Creating a page for the gallery"/></div><p>Give the page a title <a id="id611" class="indexterm"/>and <a id="id612" class="indexterm"/>path. How about <code class="literal">Image Gallery</code>?</p><div class="mediaobject"><img src="graphics/4548OS_A_06.jpg" alt="Creating a page for the gallery"/></div><p>Add the page to the site. <a id="id613" class="indexterm"/>Now that we <a id="id614" class="indexterm"/>have a nice place to put our block, let's actually make our block do something!</p></div></div>
<div class="section" title="Giving life to the block"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec163"/>Giving life to the block</h1></div></div></div><p>Open your block's controller (located at <code class="literal">/packages/cookbook_gallery/blocks/cookbook_gallery/controller.php</code>) in your code editor. We need to add some <a id="id615" class="indexterm"/>functions to this class to make it work. First, let's bring the block's add and edit forms to life. Add the following functions to the <code class="literal">controller</code> class.</p><div class="informalexample"><pre class="programlisting">public function add() {
  $this-&gt;addEdit();
}

public function edit() {
  $this-&gt;addEdit();
}

public function addEdit() {
  $fsList = new FileSetList();
  $sets = $fsList-&gt;get();
  
  $options = array();
  
  foreach ($sets as $fs) {
    $options[$fs-&gt;fsID] = $fs-&gt;fsName;
  }
  
  $this-&gt;set('sets', $options);
}</pre></div><p>Whoa, what are we doing here? You may recall from earlier chapters that concrete5 controllers employ the use of callbacks, which are functions in the class that get automatically executed when certain <a id="id616" class="indexterm"/>things happen. Whenever a block is added to a page for the first time, concrete5 will call the <code class="literal">add</code> function when the <code class="literal">add.php</code> view is displayed. The same goes for the <a id="id617" class="indexterm"/>
<code class="literal">edit</code> function and the <code class="literal">edit.php</code> view.</p><p>Since we want the same code to run when both add and edit forms are used, why not create a function that they each can use? The <a id="id618" class="indexterm"/>
<code class="literal">addEdit</code> function contains the real code for our backend work.</p><p>First, we load a list of all of the file sets in the concrete5 database. Next, we transform this list of file sets into a simple key/value array that we can feed into a select box in the HTML form. Lastly, we send the array of <code class="literal">&lt;select&gt;</code> options to the view as the variable <code class="literal">$sets</code>.</p><p>Awesome. Now, what about when the gallery block is actually viewed on the website? There's a callback for that, too.</p><div class="informalexample"><pre class="programlisting">public function view() {
  if ($this-&gt;file_set) {
    $list = new FileList();
    $set = FileSet::getByID($this-&gt;file_set);
    
    $list-&gt;filterBySet($set);
    $list-&gt;filterByType(FileType::T_IMAGE);
    
    $count = ($this-&gt;count) ? $this-&gt;count : $this-&gt;defaultCount;
    
    $this-&gt;set('images', $list-&gt;get($count));
  }
  else {
    $this-&gt;set('images', false);
  }
}</pre></div><p>The <code class="literal">view</code> function will be <a id="id619" class="indexterm"/>automatically run by concrete5 whenever the block is displayed on the website. It is here that we load the images from the chosen file set and send them to the view.</p><p>First, we need to create a new instance of the <a id="id620" class="indexterm"/>
<code class="literal">FileList</code> class. This class allows us to filter the files in the file manager, to only show the ones that belong in our image gallery.</p><p>Next, we load the file set object, based on the file set ID that we will set in the add/edit form. Using the file set object, we are able to <a id="id621" class="indexterm"/>filter the set to only show us files that are in that set. We don't want all types of files appearing though (imagine a PDF in the image gallery—that's no fun!), so we add another filter to only show us images.</p><p>Next, we write a ternary expression to fall back on the default gallery limit, if one was not chosen when the block was added to the page.</p><p>Finally, let's send the images array to the view, so we can show our gallery!</p><div class="section" title="Filling out the add and edit view files"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec569"/>Filling out the add and edit view files</h2></div></div></div><p>Alright, so we have some great <a id="id622" class="indexterm"/>code in our controller, but there's still no HTML in our views. Let's fix that right now.</p><p>Open <code class="literal">form.php</code> in your code editor. We are going to create the HTML form that site editors will see when the block is added or edited on a page.</p><p>Enter the following HTML and PHP code in <code class="literal">form.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php 
defined('C5_EXECUTE') or die(_("Access Denied.")); 
$form = Loader::helper('form');
?&gt;	

&lt;div class="ccm-ui"&gt;
  &lt;table class="table table-striped table-bordered"&gt;
    &lt;tr&gt;
      &lt;td&gt;
        &lt;?php echo t('File set to show photos from') ?&gt;
      &lt;/td&gt;
      &lt;td&gt;
        &lt;?php echo $form-&gt;select('file_set', $sets, $file_set) ?&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;
        &lt;?php echo t('How many images to show?') ?&gt;
      &lt;/td&gt;
      &lt;td&gt;
        &lt;?php echo $form-&gt;text('count', $count) ?&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
  &lt;/table&gt;
&lt;/div&gt;</pre></div><p>Hey, that wasn't so bad! This form will contain two fields—a select box containing a list of the file sets in concrete5, and a text <a id="id623" class="indexterm"/>input to limit the image gallery. Don't worry about wrapping it in a form element or adding save controls, concrete5 will take care of all of that.</p><p>Now, let's include this form in <code class="literal">add.php</code> and <code class="literal">edit.php</code>. Add the following code to both files:</p><div class="informalexample"><pre class="programlisting">&lt;?php 
defined('C5_EXECUTE') or die(_("Access Denied.")); 
 $this-&gt;inc('form.php');</pre></div><p>That's it! Now when our block gets added to the website, editors will see our nice new form.</p></div><div class="section" title="Creating the gallery view file"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec570"/>Creating the gallery view file</h2></div></div></div><p>Of course, our gallery is still <a id="id624" class="indexterm"/>missing the most important component, the gallery itself. Let's add some HTML and PHP to <code class="literal">view.php</code> to show the various images in the chosen file set as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?php 
  defined('C5_EXECUTE') or die(_("Access Denied.")); 
  $ih = Loader::helper('image');
?&gt;

&lt;h1&gt;&lt;?php echo t('Image Gallery') ?&gt;&lt;/h1&gt;

&lt;?php if ($images !== false): ?&gt;
  &lt;div class="gallery-wrapper"&gt;
    &lt;?php foreach ($images as $image): ?&gt;
      &lt;?php $thumbnail = $ih-&gt;getThumbnail($image, 100, 100, true); ?&gt;
      &lt;a class="gallery-image" href="&lt;?php echo $image-&gt;getRelativePath() ?&gt;"&gt;
        &lt;img src="&lt;?php echo $thumbnail-&gt;src ?&gt;" /&gt;
      &lt;/a&gt;
    &lt;?php endforeach; ?&gt;
  &lt;/div&gt;
&lt;?php else: ?&gt;
  &lt;p&gt;&lt;?php echo t('There are no images!') ?&gt;&lt;/p&gt;
&lt;?php endif; ?&gt;</pre></div><p>Great. Now let's see what we did. At the very top of the file, of course, we included the <code class="literal">defined</code> or <code class="literal">die</code> statement that is required on all the PHP files. Following that, we load up the Image helper, which we will be using later to generate thumbnails.</p><p>Next, we output a title for the gallery, using the <code class="literal">t()</code> wrapper to remain translation friendly, of course.</p><p>Shortly after that, we begin looping through the array of images. These are <code class="literal">File</code> objects, so we have access to all of the related properties. Let's use the Image helper to generate a 100 x 100 pixel crop of the image (passing <code class="literal">true</code> as the second parameter tells the Image helper to crop the image, not just resize it). <a id="id625" class="indexterm"/>That will give our gallery a clean and consistent look.</p><p>Next, let's wrap the image in an <code class="literal">&lt;a&gt;</code> tag, so we can link to the full size image. Output the image tag, using the thumbnail's source.</p><p>Don't forget to wrap the whole thing in an <code class="literal">if</code> statement to handle file sets with no images.</p><p>Lastly, let's add some basic styles to <code class="literal">view.css</code> so our gallery looks pretty as follows:</p><div class="informalexample"><pre class="programlisting">.gallery-wrapper {
  margin: 50px 0;
}

.gallery-image {
  opacity: .85;
}

.gallery-image:hover {
  opacity: 1;
}</pre></div></div><div class="section" title="Trying out the block"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec571"/>Trying out the block</h2></div></div></div><p>Alright, let's see how we did! Before we can <a id="id626" class="indexterm"/>use the block, let's add a file set to concrete5. Visit <code class="literal">/dashboard/files/sets/</code> in your browser and click on the big blue button to add a file set. We need to add at least one file set before we can use the gallery.</p><div class="mediaobject"><img src="graphics/4548OS_A_07.jpg" alt="Trying out the block"/></div><p>Create a new file set called <code class="literal">Gallery Images</code>.</p><div class="mediaobject"><img src="graphics/4548OS_A_08.jpg" alt="Trying out the block"/></div><p>Now we have a file set, but still it is <a id="id627" class="indexterm"/>empty. Let's add some images to this file set by visiting the file manager at <code class="literal">/dashboard/files/search/</code>.</p><p>Select a few images to add to the set.</p><div class="mediaobject"><img src="graphics/4548OS_A_09.jpg" alt="Trying out the block"/></div><p>Click on the dropdown menu in the <a id="id628" class="indexterm"/>upper-left hand corner. Select <span class="strong"><strong>Sets</strong></span>, as in the following screenshot:</p><div class="mediaobject"><img src="graphics/4548OS_A_10.jpg" alt="Trying out the block"/></div><p>Select the file set that we just created to assign these images to that set.</p><div class="mediaobject"><img src="graphics/4548OS_A_11.jpg" alt="Trying out the block"/></div><p>Fantastic! Now we are ready to try out our block. Visit the image gallery page that we created earlier and enter edit mode. <a id="id629" class="indexterm"/>Click on the main content area to add a new block.</p><div class="mediaobject"><img src="graphics/4548OS_A_12.jpg" alt="Trying out the block"/></div><p>Scroll to the bottom of the block list to <a id="id630" class="indexterm"/>find the photo gallery block that we created.</p><div class="mediaobject"><img src="graphics/4548OS_A_13.jpg" alt="Trying out the block"/></div><p>Now, fill out the form to add the block. <a id="id631" class="indexterm"/>Select the file set and set a limit to how many images can appear (or leave it blank to use the default of 20).</p><div class="mediaobject"><img src="graphics/4548OS_A_14.jpg" alt="Trying out the block"/></div><p>Add the block to the page and publish the <a id="id632" class="indexterm"/>changes. You will see a great-looking image gallery!</p><div class="mediaobject"><img src="graphics/4548OS_A_15.jpg" alt="Trying out the block"/></div><p>Click on one of the images to see it in its original size.</p><div class="mediaobject"><img src="graphics/4548OS_A_16.jpg" alt="Trying out the block"/></div><p>Well, that looks like our code worked! <a id="id633" class="indexterm"/>Congratulations, you have created an add-on that can be installed on any concrete5 website and work automatically.</p></div></div>
<div class="section" title="Wrap-up"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec164"/>Wrap-up</h1></div></div></div><p>We accomplished a lot in this chapter. We started with nothing, and ended up with a fully functioning image gallery. There's still a lot of room for expansion and improvements, though. What if we would have added a jQuery <a id="id634" class="indexterm"/>lightbox plugin, such as fancyBox (available at <a class="ulink" href="http://fancyapps.com/fancybox/">http://fancyapps.com/fancybox/</a>)? Or if the gallery had multiple pages? This block type is a great starting point for many different possibilities. These tasks are all possible with the concrete5 API, so have fun exploring and learning new things.</p></div></body></html>