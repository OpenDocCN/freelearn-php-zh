<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Off the Drupalicon Island</h1>
                </header>
            
            <article>
                
<p>In this chapter, we will see how to use third-party libraries, such as JavaScript, CSS, and PHP in detail:</p>
<ul>
<li>Implementing and using a third-party JavaScript library</li>
<li>Implementing and using a third-party CSS library</li>
<li>Implementing and using a third-party PHP library</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article>
                
<p>Drupal 8 comes with a <em>Proudly Built Elsewhere</em> attitude. There has been an effort made to use more components created by the PHP community at large and other communities. Drupal 8 is built with Symfony. It includes Twig as its templating system, the provided WYSIWYG editor as its CKEditor, and PHPUnit for testing.</p>
<p>How does Drupal 8 promote using libraries made elsewhere? The new asset management system in Drupal 8 makes it easier to use frontend libraries. Drupal implements PSR-0 and PSR-4 from the <strong>PHP Framework Interoperability Group</strong> (<strong>PHP-FIG</strong>), and <strong>PHP Standards Recommendations</strong> (<strong>PSRs</strong>) are suggested standards used to increase interoperability between PHP applications. This has streamlined integrating third-party PHP libraries.</p>
<p>Both areas will be constantly improved with each minor release of Drupal 8. These areas will be mentioned throughout the chapter.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Implementing and using a third-party JavaScript library</h1>
                </header>
            
            <article>
                
<p>In the past, Drupal has only shipped with jQuery and a few jQuery plugins used by Drupal core for the JavaScript API. This has changed with Drupal 8. <strong>Underscore.js</strong> and <strong>Backbone.js</strong> are now included in Drupal, bringing two popular JavaScript frameworks to its developers.</p>
<p>However, there are many JavaScript frameworks that can be used. In <a href="991ad206-3a73-4c3a-b6b7-c680a0a74a53.xhtml"><em><span class="ChapterrefPACKT">Chapter 5</span></em></a>, <em>Frontend for the Win</em>, we covered the asset management system and libraries. In this recipe, we will create a module that provides <strong>Angular.js</strong> as a library and a custom Angular application; the demo is available on the AngularJS home page.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>In this example, we will use Bower to manage our third-party <kbd>Angular.js</kbd> library components. If you are not familiar with Bower, it is simply a package manager for frontend components. Instead of using Bower, you can just manually download and place the required files.</p>
<p>If you do not have Bower, you can follow the instructions to install it from <kbd>bower.io</kbd> at<br/>
<a href="http://bower.io/#install-bower"><span class="URLPACKT">http://bower.io/#install-bower</span></a>. If you do not want to install Bower, we will provide links to manually download libraries.</p>
<p>Having a background in AngularJS is not required but is beneficial. This recipe implements the example from the home page of the library.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Create a custom module named <kbd>mymodule</kbd> that will serve the AngularJS library and its implementation:</li>
</ol>
<pre style="padding-left: 60px">name: My Module! 
type: module 
description: Provides an AngularJS app. 
core: 8.x</pre>
<ol start="2">
<li>Run the <kbd>bower init</kbd> command to create a Bower project in our module's directory. We will use most of the default values for the prompted questions:</li>
</ol>
<pre style="padding-left: 60px">$ bower init 
? name mymodule 
? description Example module with AngularJS 
? main file  
? what types of modules does this package expose?  
? keywords  
? authors Matt Glaman &lt;nmd.matt@gmail.com&gt; 
? license GPL 
? homepage  
? set currently installed components as dependencies? Yes 
? would you like to mark this package as private which prevents it from being accidentally published to the registry? No 
{ 
  name: 'mymodule', 
  authors: [ 
    'Matt Glaman &lt;nmd.matt@gmail.com&gt;' 
  ], 
  description: 'Example module with AngularJS', 
  main: '', 
  moduleType: [], 
  license: 'GPL', 
  homepage: '', 
  ignore: [ 
    '**/.*', 
    'node_modules', 
    'bower_components', 
    'test', 
    'tests' 
  ] 
} 
 
? Looks good? Yes </pre>
<ol start="3">
<li>Next, we will install the AngularJS library using <kbd>bower install</kbd>:</li>
</ol>
<pre style="padding-left: 60px">$ bower install --save angular 
bower angular#*                 cached git://github.com/angular/bower-angular.git#1.5.0 
bower angular#*               validate 1.5.0 against git://github.com/angular/bower-angular.git#* 
bower angular#^1.5.0           install angular#1.5.0 
angular#1.5.0 bower_components/angular </pre>
<p style="padding-left: 60px">The <kbd>--save</kbd> option will ensure that the package's dependency is saved in the created <kbd>bower.json</kbd>. If you do not have Bower, you can download AngularJS from <a href="https://angularjs.org/"><span class="URLPACKT">https://angularjs.org/</span></a> and place it in the <kbd>bower_components</kbd> folder.</p>
<ol start="4">
<li>Create <kbd>mymodule.libraries.yml</kbd>. We will define AngularJS as its own library:</li>
</ol>
<pre style="padding-left: 60px">angular: 
  js: 
    'bower_components/angular/angular.js: {} 
  css: 
    component: 
      'bower_components/angular/angular-csp.css': {} </pre>
<p style="padding-left: 60px">When the <kbd>angular</kbd> library is attached, it will add the AngularJS library file and attach the CSS style sheet.</p>
<ol start="5">
<li>Next, create a <kbd>mymodule.module</kbd> file. We will use the theme layer's preprocess functions to add an <kbd>ng-app</kbd> attribute to the root HTML element:</li>
</ol>
<pre style="padding-left: 60px">&lt;?php 
 
/** 
 * Implements hook_preprocess_html(). 
 */ 
function mymodule_preprocess_html(&amp;$variables) { 
    $variables['html_attributes']['ng-app'] = ''; 
} </pre>
<p style="padding-left: 60px">AngularJS uses the <kbd>ng-app</kbd> attribute as a directive for bootstrapping an AngularJS application. It marks the root of the application.</p>
<ol start="6">
<li>We will use a custom block to implement the HTML required for the AngularJS example. Create an <kbd>src/Plugin/Block</kbd> directory and an <kbd>AngularBlock.php</kbd> file.</li>
<li>Extend the <kbd>BlockBase</kbd> class and implement the <kbd>build</kbd> method to return our Angular app's HTML:</li>
</ol>
<pre style="padding-left: 60px">&lt;?php 
 
namespace Drupal\mymodule\Plugin\Block; 
 
use Drupal\Core\Block\BlockBase; 
 
/** 
 * Provides a block for AngularJS example. 
 * 
 * @Block( 
 *   id = "mymodule_angular_block", 
 *   admin_label = @Translation("AngularJS Block") 
 * ) 
 */ 
class AngularBlock extends BlockBase { 
 
  public function build() { 
    return [ 
      'input' =&gt; [ 
        '#type' =&gt; 'textfield', 
        '#title' =&gt; $this-&gt;t('Name'), 
        '#placeholder' =&gt; $this-&gt;t('Enter a name here'), 
        '#attributes' =&gt; [ 
          'ng-model' =&gt; 'yourName', 
        ], 
      ], 
      'name' =&gt; [ 
        '#markup' =&gt; '&lt;hr&gt;&lt;h1&gt;Hello {{yourName}}!&lt;/h1&gt;', 
      ], 
      '#attached' =&gt; [ 
        'library' =&gt; [ 
          'mymodule/angular', 
        ], 
      ], 
    ]; 
  } 
 
} </pre>
<p style="padding-left: 60px">We return a render array that contains the <kbd>input</kbd>, <kbd>name</kbd>, and our <kbd>library</kbd> attachments. The <kbd>input</kbd> array returns the Form API render information for a text field. The <kbd>name</kbd> returns a regular markup that will bind Angular's changes to the <kbd>yourName</kbd> scope variable.</p>
<ol start="8">
<li>Install your custom module, or rebuild Drupal's cache if the module is already installed.</li>
<li>Go to the block layout form from the <span class="packt_screen">Structure</span> page and place your block within a region, such as the <span class="packt_screen">Sidebar first</span> region.</li>
</ol>
<p>Â </p>
<ol start="10">
<li>View your Drupal site and interact with your block, which is powered by AngularJS:</li>
</ol>
<div class="packt_figure CDPAlignCenter CDPAlign"><img class=" image-border" src="assets/776cd369-c137-436d-9a00-9340843b08a6.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>The simplicity of integrating with a JavaScript framework is provided by the new asset management system in Drupal 8. The usage of <strong>Bower</strong> is optional, but it is usually a preferred method used to manage frontend dependencies. Using Bower, we can place <kbd>bower_components</kbd> in an <kbd>ignore</kbd> file that can be used to keep third-party libraries out of version control.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>Drupal 8 uses Composer for handling PHP dependencies, but frontend libraries are still being sorted out for best practices.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Best practices for handling external libraries</h1>
                </header>
            
            <article>
                
<p class="mce-root">In our recipe, we added the third-party library through a local copy of the code, inside the module. This approach, however, makes it difficult to reuse the same library in another module. The other module would have to declare a dependency on the module providing the library or define its own copy, and two versions of AngularJS would have been loaded on the page.</p>
<div class="mce-root packt_infobox">There is currently a discussion in the Drupal core issue queue by the community on how to best tackle this issue--refer to <a href="https://www.drupal.org/node/2605130"><span class="URLPACKT">https://www.drupal.org/node/2605130</span></a>.</div>
<p>A leading practice is to place a <kbd>libraries</kbd> directory in the Drupal docroot (alongside <kbd>modules</kbd> and <kbd>themes</kbd>.) An example can be found in the DropzoneJS integration module:</p>
<pre> 
dropzonejs: 
  title: 'Dropzonejs' 
  website: http://www.dropzonejs.com 
  version: 4.0.1 
  license: 
    name: MIT 
    url: https://github.com/enyo/dropzone/blob/master/LICENSE 
    gpl-compatible: true 
  js: 
    /libraries/dropzone/dist/min/dropzone.min.js: {} 
  css: 
    component: 
      /libraries/dropzone/dist/min/dropzone.min.css: {} 
 </pre>
<p>This pattern would allow any module to load the library through this path. Its author recommends that you have a base module that defines the library and simple integration and always make that a dependency.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>Refer to the core issue to add Backbone.js and Underscore.js at<br/>
<a href="https://www.drupal.org/node/1149866"><span class="URLPACKT">https://www.drupal.org/node/1149866</span></a></li>
<li><span>Refer to the</span> <em>Using the new asset management system</em> <span>recipe</span> of <a href="991ad206-3a73-4c3a-b6b7-c680a0a74a53.xhtml"><em><span class="ChapterrefPACKT">Chapter 5</span></em></a>, <em>Frontend for the Win</em></li>
<li><span>Refer to the</span> <em>Creating a Module</em> recipe of <em><a href="a634af62-2148-4382-9121-b8500df169ed.xhtml"><span class="ChapterrefPACKT">Chapter 4</span></a></em>, <em>Extending Drupal</em></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Implementing and using a third-party CSS library</h1>
                </header>
            
            <article>
                
<p>Drupal provides many things. However, one thing that it does not provide is any kind of CSS component library. In the <em>Using the new asset management system</em> <span>recipe of</span> <a href="991ad206-3a73-4c3a-b6b7-c680a0a74a53.xhtml"><em><span class="ChapterrefPACKT">Chapter 5</span></em></a>, <em>Frontend for the Win</em>, we added <kbd>FontAwesome</kbd> as a library. CSS frameworks implement robust user interface design components, and they can be quite large if you use a compiled version with everything bundled. The asset management system can be used to define each component as its own library to only deliver the exact files required for a strong frontend performance.</p>
<p>In this recipe, we will implement the Semantic UI framework, using the CSS-only distribution, which provides each individual component's CSS file. We will register the <kbd>form</kbd>, <kbd>button</kbd>, <kbd>label</kbd>, and <kbd>input</kbd> components as libraries. Our custom theme will then alter the Drupal elements for <kbd>buttons</kbd>, <kbd>labels</kbd>, and <kbd>inputs</kbd> to have the Semantic UI classes and load the proper library.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>In this example, we will use Bower to manage our third-party components. If you are not familiar with Bower, it is simply a package manager used for frontend components. Instead of using Bower, you can just manually download and place the required files.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>For this recipe, create a new custom theme named <kbd>mytheme</kbd> using Classy as a base theme. This way, you can reuse some existing styling. If you are unfamiliar with creating a base theme, refer to the <em>Creating a custom theme based on Classy</em> <span>recipe of</span> <a href="991ad206-3a73-4c3a-b6b7-c680a0a74a53.xhtml"><em><span class="ChapterrefPACKT">Chapter 5</span></em></a>, <em>Frontend for the Win</em>.</li>
<li>Using your terminal, navigate to your theme's directory. Run <kbd>bower init</kbd> to create a <kbd>bower</kbd> project:</li>
</ol>
<pre style="padding-left: 60px">$ bower init 
? name mytheme 
? description Example theme with Semantic UI 
? main file  
? what types of modules does this package expose?  
? keywords  
? authors Matt Glaman &lt;nmd.matt@gmail.com&gt; 
? license GPL 
? homepage  
? set currently installed components as dependencies? Yes 
? would you like to mark this package as private which prevents it from being accidentally published to the registry? No 
{ 
  name: 'mytheme', 
  authors: [ 
    'Matt Glaman &lt;nmd.matt@gmail.com&gt;' 
  ], 
  description: 'Example theme with Semantic UI, 
  main: '', 
  moduleType: [], 
  license: 'GPL', 
  homepage: '', 
  ignore: [ 
    '**/.*', 
    'node_modules', 
    'bower_components', 
    'test', 
   'tests' 
  ] 
} 
 
? Looks good? Yes </pre>
<ol start="3">
<li>Next, use <kbd>bower install</kbd> to save the Semantic UI library:</li>
</ol>
<pre style="padding-left: 60px">$ bower install --save semantic-ui 
bower semantic-ui#*         not-cached git://github.com/Semantic-Org/Semantic-UI.git#* 
bower semantic-ui#*            resolve git://github.com/Semantic-Org/Semantic-UI.git#* 
bower semantic-ui#*           download https://github.com/Semantic-Org/Semantic-UI/archive/2.1.8.tar.gz 
bower semantic-ui#*            extract archive.tar.gz 
bower semantic-ui#*           resolved git://github.com/Semantic-Org/Semantic-UI.git#2.1.8 
bower jquery#&gt;=1.8          not-cached git://github.com/jquery/jquery-dist.git#&gt;=1.8 
bower jquery#&gt;=1.8             resolve git://github.com/jquery/jquery-dist.git#&gt;=1.8 
bower jquery#&gt;=1.8            download https://github.com/jquery/jquery-dist/archive/2.2.0.tar.gz 
bower jquery#&gt;=1.8             extract archive.tar.gz 
bower jquery#&gt;=1.8            resolved git://github.com/jquery/jquery-dist.git#2.2.0 
bower semantic#^2.1.8          install semantic#2.1.8 
bower jquery#&gt;=1.8             install jquery#2.2.0 </pre>
<p style="padding-left: 60px">The <kbd>--save</kbd> option will ensure that the package's dependency is saved in the created <kbd>bower.json</kbd>. If you do not have Bower, you can download Semantic UI from <a href="https://github.com/semantic-org/semantic-ui/"><span class="URLPACKT">https://github.com/semantic-org/semantic-ui/</span></a> and place it in a <kbd>bower_components</kbd> folder.</p>
<ol start="4">
<li>Create <kbd>mytheme.libraries.yml</kbd> in your theme's base directory. This will hold your main Semantic UI definition along with specific component library definitions.</li>
<li>You will then add a new library to the <kbd>form</kbd> component:</li>
</ol>
<pre style="padding-left: 60px">semantic_ui.form: 
  js: 
    bower_components/semantic/dist/components/form.js: {} 
  css: 
    component: 
      bower_components/semantic/dist/components/form.css: {} </pre>
<p style="padding-left: 60px">The <kbd>form</kbd> component for Semantic UI has a style sheet and JavaScript file. Your library ensures that both are loaded when the library is attached.</p>
<ol start="6">
<li>The <kbd>button</kbd>, <kbd>input</kbd>, and <kbd>label</kbd> components do not have any JavaScript files. Add a library for each component:</li>
</ol>
<pre style="padding-left: 60px">semantic_ui.button: 
  css: 
    component: 
      bower_components/semantic/dist/components/button.css: {} 
semantic_ui.input: 
  css: 
    component: 
      bower_components/semantic/dist/components/input.css: {} 
semantic_ui.label: 
  css: 
    component: 
      bower_components/semantic/dist/components/label.css: {} </pre>
<ol start="7">
<li>Now that the libraries are defined, you can use the <kbd>attach_library</kbd> Twig function to add your libraries to the appropriate templates when you add the Semantic UI classes.</li>
</ol>
<p>Â </p>
<ol start="8">
<li>Copy the <kbd>form.html.twig</kbd> file from the Classy theme's <kbd>templates</kbd> folder and paste it into your theme's templates folder. Then, attach <kbd>mytheme/semantic_ui.form</kbd> and add the <kbd>ui</kbd> and <kbd>form</kbd> classes:</li>
</ol>
<pre style="padding-left: 60px">{{ attach_library('mytheme/semantic_ui.form') }} 
  &lt;form{{ attributes.addClass(['ui', 'form']) }}&gt; 
{{ children }} 
&lt;/form&gt; </pre>
<p style="padding-left: 60px">The <kbd>attach_library</kbd> function will attach the specified library. Use the <kbd>addClass</kbd> method from Twig to add the <kbd>ui</kbd> and <kbd>form</kbd> classes. Semantic UI requires all elements to have the matching <kbd>ui</kbd> class.</p>
<ol start="9">
<li>Next, copy the <kbd>input.html.twig</kbd> file from the Classy theme and paste it into your theme's <kbd>template</kbd> folder. Then, attach <kbd>mytheme/semantic_ui.input</kbd> and add the <kbd>ui</kbd> and <kbd>input</kbd> classes:</li>
</ol>
<pre style="padding-left: 60px">{{ attach_library('mytheme/semantic_ui.input') }} 
&lt;input{{ attributes.addClass(['ui', 'input']) }} /&gt;{{ children }} </pre>
<ol start="10">
<li>Copy the <kbd>input.html.twig</kbd> file that you just created and use it to make <kbd>input-submit.html.twig</kbd>. This template file will be used for <kbd>submit</kbd> and other buttons:</li>
</ol>
<pre style="padding-left: 60px">{{ attach_library('mytheme/semantic_ui.button') }} 
&lt;input{{ attributes.addClass(['ui', 'button', 'primary']) }} /&gt;{{ children }} </pre>
<ol start="11">
<li>Finally, copy the <kbd>form-element-label.html.twig</kbd> file from Classy to your theme and add the label library and appropriate class, along with the defaults that Classy has defined:</li>
</ol>
<pre style="padding-left: 60px">{{ attach_library('mytheme/semantic_ui.label') }} 
 
{% 
  set classes = [ 
    title_display == 'after' ? 'option', 
    title_display == 'invisible' ? 'visually-hidden', 
    required ? 'js-form-required', 
    required ? 'form-required', 
    'ui', 
    'label', 
  ] 
%} 
{% if title is not empty or required -%} 
  &lt;label{{ attributes.addClass(classes) }}&gt;{{ title }}&lt;/label&gt; 
{%- endif %} </pre>
<ol start="12">
<li>View a form and check whether it has been styled by the Semantic UI CSS framework:</li>
</ol>
<div class="packt_figure CDPAlignCenter CDPAlign"><img class=" image-border" src="assets/63a5449e-2b26-4be2-b282-1fd9f6c6736a.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>The simplicity of integrating with a CSS framework is provided by the new template system, Twig, and the asset management system in Drupal 8. The usage of Bower is optional, but it is usually a preferred method for managing frontend dependencies and can be used to keep third-party libraries out of version control.</p>
<p>Although it may be a task to add each component as its own library and attach when specifically needed, it ensures optimal asset delivery. With CSS and JavaScript aggregation enabled, each page will only have the minimal resources that are needed. This is an advantage when the entire Semantic UI minified is still 524 KB.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>Refer to Semantic UI at <a href="http://semantic-ui.com/"><span class="URLPACKT">http://semantic-ui.com/</span></a></li>
<li><span>Refer to</span> the <em>Creating a custom theme based on Classy</em> <span>recipe of</span> <a href="991ad206-3a73-4c3a-b6b7-c680a0a74a53.xhtml"><em><span class="ChapterrefPACKT">Chapter 5</span></em></a>, <em>Frontend for the Win</em></li>
<li><span>Refer to</span> the <em>Using the new asset management system</em> <span>recipe</span> of <a href="991ad206-3a73-4c3a-b6b7-c680a0a74a53.xhtml"><em><span class="ChapterrefPACKT">Chapter 5</span></em></a>, <em>Frontend for the Win</em></li>
<li><span>Refer to</span> the <em>Twig templating</em> <span>recipe</span> of <a href="991ad206-3a73-4c3a-b6b7-c680a0a74a53.xhtml"><em><span class="ChapterrefPACKT">Chapter 5</span></em></a>, <em>Frontend for the Win</em></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Implementing and using a third-party PHP library</h1>
                </header>
            
            <article>
                
<p>Drupal 8 uses Composer for package dependencies and <kbd>autoloading</kbd> classes based on PSR standards. This allows us to use any available PHP library much more easily than in previous versions of Drupal.</p>
<p>In this recipe, we will add the <kbd>IpRestrict Stack Middleware</kbd> library to add the functionality to whitelist access to the Drupal site based on allowed IP addresses.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You need to have Composer installed in order to use the Composer manager workflow. You can follow the <em>Getting Started</em> documentation at <a href="https://getcomposer.org/doc/00-intro.md"><span class="URLPACKT">https://getcomposer.org/doc/00-intro.md</span></a>. We will add the <kbd>alsar/stack-ip-restrict</kbd> library as a dependency to our Drupal installation.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Using your terminal, navigate to your Drupal site's root directory.</li>
<li>Use the <kbd>require</kbd> command from Composer to add the library:</li>
</ol>
<pre style="padding-left: 60px"><strong>composer require alsar/stack-ip-restrict</strong> </pre>
<ol start="3">
<li>Composer will then add the library to the <kbd>composer.json</kbd> file and install the library along with any dependencies. Its namespace will now be registered.</li>
<li>Now, you will need to implement a module that registers the library as a middleware service. We'll call the module <kbd>ip_restrict</kbd>. Add the following code to the <kbd>ip_restrict.info.yml</kbd> file:</li>
</ol>
<pre style="padding-left: 60px">name: IP Restrict 
type: module 
description: Restricts access to the Drupal site based on allowed IP addresses 
core: 8.x </pre>
<ol start="5">
<li>Create <kbd>ip_restrict.services.yml</kbd>. This will register the library with Drupal's service container:</li>
</ol>
<pre style="padding-left: 60px">parameters: 
  ip_restrict: 
    enabled: true 
    ipAddresses: ['127.0.0.1', 'fe80::1', '::1'] 
services: 
  ip_restrict.middleware: 
    class: Alsar\Stack\IpRestrict 
    arguments: ['%ip_restrict%'] 
    tags: 
      - { name: http_middleware } </pre>
<p style="padding-left: 60px">The <kbd>parameters</kbd> section defines configuration values, which can be overridden in the site's <kbd>services.yml</kbd> file. The <kbd>services</kbd> section defines the service's machine name, class file, its constructor arguments, and any tags.</p>
<ol start="6">
<li>Next, you will need to implement a compiler pass injection. This will allow us to alter our service in the container definition when it is compiled. Create a <kbd>src/Compiler</kbd> directory and make <kbd>IpRestrictPass.php</kbd>.</li>
</ol>
<div class="mce-root packt_tip">When making a compiler pass class, the class and filename must be formatted in a specific way. It is the camel case version of the module name followed by <kbd>Pass</kbd>.</div>
<ol start="7">
<li>The <kbd>IpRestrictPass.php</kbd> will provide the <kbd>IpRestrictPass</kbd> class, which implements <kbd>\Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface</kbd>:</li>
</ol>
<pre style="padding-left: 60px">&lt;?php 
 
namespace Drupal\ip_restrict\Compiler; 
 
use Symfony\Component\DependencyInjection\ContainerBuilder; 
use Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface; 
 
/** 
 * Adds the IP Restrict middleware if enabled. 
 */ 
class IpRestrictPass implements CompilerPassInterface { 
 
  /** 
   * {@inheritdoc} 
   */ 
  public function process(ContainerBuilder $container) { 
    if (FALSE === $container-&gt;hasDefinition('ip_restrict.middleware')) { 
      return; 
    } 
 
    $ip_restrict_config = $container-&gt;getParameter('ip_restrict'); 
 
    if (!$ip_restrict_config['enabled']) { 
      $container-&gt;removeDefinition('ip_restrict.middleware'); 
    } 
  } 
 
} </pre>
<p style="padding-left: 60px">In our compiler pass, we check the <kbd>enabled</kbd> parameter and remove our middleware if it has been disabled (so that it does not restrict allowed IPs).</p>
<ol start="8">
<li>Enable the module. The stack middleware service will be registered and now supporting restrict access from local IP addresses.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>Drupal 8 utilizes Symfony components. One of them is the service container and the services it has registered. During the building of the container, there is a compiler pass process that allows alterations of the container's services.</p>
<p>First, we will need to register the service in the module's <kbd>services.yml</kbd> file. The <kbd>\Drupal\Core\DependencyInjection\Compiler\StackedKernelPass</kbd> class provided by the core will automatically load all the services tagged with <kbd>http_middleware</kbd>, such as our <kbd>ip_restrict.middleware</kbd> service.</p>
<p>Our <kbd>arguments</kbd> definition loads items defined in the <kbd>parameters.ip_restrict</kbd> that are used for the class's constructor.</p>
<p>With our provided <kbd>IpRestrictPass</kbd> class, we are also tapping into the container's compile cycle. We will take a look at the parameter values for the <kbd>ip_restrict</kbd> section to check whether they are enabled. If the enabled setting is set to <kbd>false</kbd>, we remove our service from the container.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li><span>Refer to</span> Services and dependency injection in the Drupal 8 documentation at <a href="https://www.drupal.org/docs/8/api/services-and-dependency-injection/services-and-dependency-injection-in-drupal-8"><span class="URLPACKT">https://www.drupal.org/docs/8/api/services-and-dependency-injection/services-and-dependency-injection-in-drupal-8</span></a></li>
<li>Refer to the Symfony service container documentation at<br/>
<a href="http://symfony.com/doc/current/book/service_container.html"><span class="URLPACKT">http://symfony.com/doc/current/book/service_container.html</span></a></li>
<li>Refer to the Symfony Dependency Injection component documentation at<br/>
<a href="http://symfony.com/doc/current/components/dependency_injection/introduction.html"><span class="URLPACKT">http://symfony.com/doc/current/components/dependency_injection/introduction.htmlï»¿</span></a></li>
</ul>


            </article>

            
        </section>
    </body></html>