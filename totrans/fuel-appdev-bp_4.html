<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Creating and Using Packages"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Creating and Using Packages</h1></div></div></div><p>In this chapter, you will learn how to install, use, and create FuelPHP packages. For illustration purposes, we suppose that we want to prevent spammers and bots from polluting our website, and we will explore two different solutions for solving this issue. We will first use an existing package (recatpcha), and then we will create our own package.</p><p>By the end of this chapter, you will know:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">What are CAPTCHAs</li><li class="listitem" style="list-style-type: disc">How to install an external package manually or with the oil command line</li><li class="listitem" style="list-style-type: disc">What is reCAPTCHA and how to use the associated FuelPHP package</li><li class="listitem" style="list-style-type: disc">How to create your own package</li><li class="listitem" style="list-style-type: disc">What is a bootstrap file and how to use it</li></ul></div><div class="section" title="What are CAPTCHAs?"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec38"/>What are CAPTCHAs?</h1></div></div></div><p>
<span class="strong"><strong>CAPTCHA</strong></span>s (<span class="strong"><strong>Completely Automated Public Turing test to tell Computers and Humans Apart</strong></span>) are <a id="id361" class="indexterm"/>generally used to prevent bots or programs from accessing some features of a website. For instance, in a blog, you may want to prevent bots from adding unsolicited and unrelated ads in the comments section. If you want your users to pay a membership fee to access your content, you might also want to prevent programs from aspiring this restricted content.</p><p>You have probably already seen a lot of CAPTCHAs, generally displayed as distorted text inside images. A well-known service is <a id="id362" class="indexterm"/>reCAPTCHA, whose verification form looks like the following image:</p><div class="mediaobject"><img src="graphics/5401OS_04_01.jpg" alt="What are CAPTCHAs?"/></div><p>Unfortunately, since <a id="id363" class="indexterm"/>there are a lot of incentives to create Spam bots, no CAPTCHA system is perfect, but at least they make the bots' work more difficult.</p></div></div>
<div class="section" title="Preliminary steps"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec39"/>Preliminary steps</h1></div></div></div><p>You first need to <a id="id364" class="indexterm"/>follow the given steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install a new FuelPHP instance.</li><li class="listitem">Configure Apache and your host file to handle it. In this chapter, we will access our application by requesting <code class="literal">http://mytest.app</code>.</li><li class="listitem">Update Composer if necessary.</li><li class="listitem">Create a new database for your application.</li><li class="listitem">Configure FuelPHP in order to allow your application to access this database.</li></ol></div><p>These steps have been covered in <a class="link" href="ch01.html" title="Chapter 1. Building Your First FuelPHP Application">Chapter 1</a>, <span class="emphasis"><em>Building Your First FuelPHP Application,</em></span> so you might want to take a look at it.</p></div>
<div class="section" title="Generating the sample application"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec40"/>Generating the sample application</h1></div></div></div><p>In order to test our packages, we will create a simple application that will handle dummy items. Just to be perfectly clear, we are not interested here by the ultimate goal of the application; this is just a test application. Most of the work will be done inside the packages. The user interface and the model will therefore be very simple and will be fully generated by the scaffold command of the <code class="literal">oil</code> utility. The packages will later be connected to the creation and edition features to determine whether or not the visitor is human.</p><p>First, generate the scaffold using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php oil generate scaffold/crud item name:string</strong></span>
</pre></div><p>It will print the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Creating migration: APPPATH/migrations/001_create_items.php</strong></span>
<span class="strong"><strong>Creating model: APPPATH/classes/model/item.php</strong></span>
<span class="strong"><strong>Creating controller: APPPATH/classes/controller/item.php</strong></span>
<span class="strong"><strong>Creating view: APPPATH/views/item/index.php</strong></span>
<span class="strong"><strong>Creating view: APPPATH/views/item/view.php</strong></span>
<span class="strong"><strong>Creating view: APPPATH/views/item/create.php</strong></span>
<span class="strong"><strong>Creating view: APPPATH/views/item/edit.php</strong></span>
<span class="strong"><strong>Creating view: APPPATH/views/item/_form.php</strong></span>
<span class="strong"><strong>Creating view: APPPATH/views/template.php</strong></span>
</pre></div><p>Then, execute the <a id="id365" class="indexterm"/>generated migration file by executing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php oil refine migrate</strong></span>
</pre></div><p>If you now request the following URL, our test application should work perfectly:</p><p>
<code class="literal">http://mytest.app/item</code>
</p></div>
<div class="section" title="The reCAPTCHA solution"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec41"/>The reCAPTCHA solution</h1></div></div></div><p>The first method for integrating a CAPTCHA system <a id="id366" class="indexterm"/>into your website is to use FuelPHP's <a id="id367" class="indexterm"/>
<span class="strong"><strong>recaptcha package</strong></span>. This is a convenient solution, since there is not much to be implemented and it allows you to integrate a well-known CAPTCHA system that your visitors are used to dealing with.</p><div class="section" title="Installing the recaptcha package"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec41"/>Installing the recaptcha package</h2></div></div></div><p>First, we will install the <a id="id368" class="indexterm"/>recaptcha package, which easily integrates the <span class="strong"><strong>reCAPTCHA service</strong></span> <a id="id369" class="indexterm"/>into your FuelPHP application.</p><p>The reCAPTCHA service <a id="id370" class="indexterm"/>is a popular and free service provided by Google that allows you to check whether or not your visitor is a bot by asking him/her to enter words seen in distorted text images on screen. An interesting fact is that it helps to digitize the text of actual images and books.</p><p>Installing the package <a id="id371" class="indexterm"/>is very simple. Visit the following URL:</p><p>
<a class="ulink" href="https://github.com/fuel-packages/fuel-recaptcha">https://github.com/fuel-packages/fuel-recaptcha</a></p><p>Now, click on the <span class="strong"><strong>Download ZIP</strong></span> button and then unzip the file inside the <code class="literal">PKGPATH</code> directory (<code class="literal">fuel/packages</code>).</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note24"/>Note</h3><p>There are alternative ways of downloading packages. You can use the <code class="literal">oil</code> utility using the following command:</p><div class="informalexample"><pre class="programlisting">php oil package install recaptcha</pre></div><p>It is <a id="id372" class="indexterm"/>recommended that you read the official documentation<a id="id373" class="indexterm"/> about this <code class="literal">oil</code> feature<a id="id374" class="indexterm"/> available at the following URL:</p><p>
<a class="ulink" href="http://fuelphp.com/docs/packages/oil/package.html">http://fuelphp.com/docs/packages/oil/package.html</a></p><p>(Can be accessed through the FuelPHP website by navigating to <span class="strong"><strong>DOCS</strong></span> | <span class="strong"><strong>TABLE OF CONTENTS</strong></span> | <span class="strong"><strong>Oil</strong></span> | <span class="strong"><strong>Package</strong></span>)</p><p>Some packages can also be installed through the Composer utility.</p></div></div></div><div class="section" title="Configuring the recaptcha package"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec42"/>Configuring the recaptcha package</h2></div></div></div><p>Before proceeding, you need to<a id="id375" class="indexterm"/> create an account on the reCAPTCHA<a id="id376" class="indexterm"/> website:</p><p>
<a class="ulink" href="http://www.google.com/recaptcha">http://www.google.com/recaptcha</a></p><p>Once this is done, you have to copy the <code class="literal">PKGPATH/fuel-recaptcha/config/recaptcha.php</code> configuration file to <code class="literal">APPPATH/config/recaptcha.php</code> and set inside the new file the <code class="literal">private_key</code> and <code class="literal">public_key</code> keys provided in the reCAPTCHA website.</p></div><div class="section" title="Integrating the recaptcha package"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec43"/>Integrating the recaptcha package</h2></div></div></div><p>Now that we have installed and configured the recaptcha package in our FuelPHP instance, we just have to integrate it into our creation and edition forms. Open the <code class="literal">APPPATH/views/item/_form.php</code> file, and between the two <code class="literal">div</code> elements with the <code class="literal">form-group</code> class, add the following code:</p><div class="informalexample"><pre class="programlisting">&lt;div class="form-group"&gt;
&lt;?php
echo Form::label('Please verify that you are human');

// It is how we display the recaptcha form as you can read
// in the package readme file.
echo ReCaptcha::instance()-&gt;get_html();
?&gt;
&lt;/div&gt;</pre></div><p>At the beginning of the <code class="literal">create</code> and <code class="literal">edit</code> action of the <code class="literal">Item</code> controller, add the following line of code:</p><div class="informalexample"><pre class="programlisting">Package::load('fuel-recaptcha');</pre></div><p>If you display the creation or edition form, the reCAPTCHA validation system will appear as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5401OS_04_02.jpg" alt="Integrating the recaptcha package"/></div><p>All we have to do now is to<a id="id377" class="indexterm"/> check whether the value entered by the user is correct. Open the <code class="literal">Item</code> controller, and in the <code class="literal">create</code> and <code class="literal">edit</code> actions, surround the following code:</p><div class="informalexample"><pre class="programlisting">$val = Model_Item::validate(/* 'create' or 'edit' */);

if ($val-&gt;run())
// And the following if else statement content</pre></div><p>By:</p><div class="informalexample"><pre class="programlisting">if (static::is_captcha_correct())
{
    // Code to be surrounded
} else {
    Session::set_flash(
        'error',
        'You have entered an invalid value for the CAPTCHA'
    );
}</pre></div><p>In the <code class="literal">Item</code> controller, add the CAPTCHA verification method:</p><div class="informalexample"><pre class="programlisting">public static function is_captcha_correct() {
    // This is how a CAPTCHA is checked according to the
    // package readme file.
    return ReCaptcha::instance()
        -&gt;check_answer(
            Input::real_ip(),
            Input::post('recaptcha_challenge_field'),
            Input::post('recaptcha_response_field')
    );
}</pre></div><p>Any item addition/edition will <a id="id378" class="indexterm"/>now fail if you enter an invalid value for the CAPTCHA.</p></div></div>
<div class="section" title="Creating your own package"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec42"/>Creating your own package</h1></div></div></div><p>The solution we saw previously<a id="id379" class="indexterm"/> can be implemented quickly, but there is a major flaw; reCAPTCHA is very well known, and there are various online services that offer to decode thousands of them for a few dollars (they can use Optical Character Recognition or even actual human solvers). In fact, any well-known system has the same problem, so sometimes the best solution lies more in the originality of the system than its absolute robustness. Indeed, even if the new system is much simpler, it will force spammers to specifically create new bots if they want to pollute your website, thus creating a kind of resistance (as long as your website is not popular).</p><p>We will therefore build a new CAPTCHA package in order to create our own original solution. Instead of displaying an image containing distorted text, we will simply ask the visitor to calculate a simple addition.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note26"/>Note</h3><p>Please note that the solution is only implemented to demonstrate how a package can be built. We will therefore, choose a very simple solution that can potentially be easily decoded. You are welcome to adapt this modest package to create your own robust verification system.</p></div></div><div class="section" title="Conception"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec44"/>Conception</h2></div></div></div><p>As we need to check whether the user has entered the correct number on the server, we will save the expected answer in the database. For doing this, we will generate the <code class="literal">Captcha_Answer</code> model that will only contain the <code class="literal">id</code>, <code class="literal">expected_value</code>, and <code class="literal">created_at</code> attributes.</p></div><div class="section" title="Generating the package"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec45"/>Generating the package</h2></div></div></div><p>We will again use the <code class="literal">oil</code> command to<a id="id380" class="indexterm"/> generate a scaffold for our package:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php oil generate package captcha</strong></span>
</pre></div><p>This will print the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Creating file: PKGPATH/captcha/classes/captcha.php</strong></span>
<span class="strong"><strong>Creating file: PKGPATH/captcha/config/captcha.php</strong></span>
<span class="strong"><strong>Creating file: PKGPATH/captcha/bootstrap.php</strong></span>
</pre></div><p>You can see that several files have been generated. If you open the <code class="literal">Captcha</code> class located at <code class="literal">PKGPATH/captcha/classes/captcha.php</code>, you will see that the class is in the <code class="literal">Captcha</code> namespace and several methods are already implemented:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace Captcha;

class CaptchaException extends \FuelException {}

class Captcha
{
    // ...
    protected static $_defaults = array();
    // ...
    protected $config = array();
    // ...
    public static function _init()
    {
        \Config::load('captcha', true);
    }
    // ...
    public static function forge($config = array())
    {
        $config = \Arr::merge(
            static::$_defaults,
            \Config::get('captcha', array()),
            $config
        );
        $class = new static($config);
        return $class;
    }
    // ...
    public function __construct(array $config = array())
    {
        $this-&gt;config = $config;
    }
    // ...
    public function get_config($key, $default = null)
    {
        return \Arr::get($this-&gt;config, $key, $default);
    }
    // ...
    public function set_config($key, $value)
    {
        \Arr::set($this-&gt;config, $key, $value);
        return $this;
    }
}</pre></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">There are five methods, as follows: The constructor, where you <a id="id381" class="indexterm"/>pass the package configuration as a parameter.</li><li class="listitem" style="list-style-type: disc">The static <code class="literal">forge</code> method, which gets the package configuration file located at <code class="literal">PKGPATH/captcha/config/captcha.php</code> and passes it to the constructor. This means that if you create a <code class="literal">Captcha</code> object using the <code class="literal">forge</code> method, its configuration will automatically be loaded from the configuration file, whereas if you create it using the constructor, you will have to define the package configuration manually.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">get_config</code> and <code class="literal">set_config</code> methods are self-explanatory.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">_init</code> method, which is called when the <code class="literal">Captcha</code> class is initialized. In a general manner, in any class, if you define a static <code class="literal">_init</code> method, it will be called when the class is loaded by FuelPHP. In our class, the method loads the configuration file located at <code class="literal">PKGPATH/captcha/config/captcha.php</code>.</li></ul></div><p>The <code class="literal">PKGPATH/captcha/config/captcha.php</code> configuration file is currently an empty array, but you are free to add as many parameters as you wish.</p><p>The <code class="literal">captcha</code> package we generated also has a <code class="literal">bootstrap</code> file located at <code class="literal">PKGPATH/captcha/bootstrap.php</code>. This <code class="literal">bootstrap</code> file is executed when the package is loaded. Similarly, the <code class="literal">APPPATH/bootstrap.php</code> file is executed when your application is loaded (almost each time a web page is requested).</p><p>If you open the <code class="literal">PKGPATH/captcha/bootstrap.php</code> file, you will see the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php

Autoloader::add_core_namespace('Captcha');

Autoloader::add_classes(array(
  'Captcha\\Captcha' =&gt; __DIR__ . '/classes/captcha.php',
  'Captcha\\CaptchaException' =&gt; __DIR__ . '/classes/captcha.php',

)); </pre></div><p>The <code class="literal">Autoloader::add_classes</code> method specifies to the Autoloader where classes can be found. For instance, after <a id="id382" class="indexterm"/>executing the <code class="literal">bootstrap</code> file, FuelPHP will know that the <code class="literal">Captcha\Captcha</code> class is located in the <code class="literal">PKGPATH/captcha/classes/captcha.php</code> file.</p><p>The <code class="literal">Autoloader::add_core_namespace</code> method specifies to the <code class="literal">Autoloader</code> a namespace that needs to be added to the core namespace. In practical terms, after executing the <code class="literal">bootstrap</code> file, <code class="literal">\Captcha\Captcha</code> and <code class="literal">\Captcha</code> will both refer to the same class.</p><p>It is recommended that you read the Autoloader official documentation<a id="id383" class="indexterm"/> that can be found at:</p><p>
<a class="ulink" href="http://fuelphp.com/docs/classes/autoloader.html">http://fuelphp.com/docs/classes/autoloader.html</a></p><p>(This can be accessed by navigating to the FuelPHP website at <span class="strong"><strong>DOCS</strong></span> | <span class="strong"><strong>TABLE OF CONTENTS</strong></span> | <span class="strong"><strong>Core</strong></span> | <span class="strong"><strong>Autoloader</strong></span>)</p><p>It is also recommended that you read the <a id="id384" class="indexterm"/>official documentation about packages:</p><p>
<a class="ulink" href="http://fuelphp.com/docs/general/packages.html">http://fuelphp.com/docs/general/packages.html</a></p><p>(This can be accessed by navigating to the FuelPHP website at <span class="strong"><strong>DOCS</strong></span> | <span class="strong"><strong>TABLE OF CONTENTS</strong></span> | <span class="strong"><strong>FuelPHP</strong></span> | <span class="strong"><strong>General</strong></span> | <span class="strong"><strong>Packages</strong></span>.)</p></div><div class="section" title="Generating the Captcha_Answer model"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec46"/>Generating the Captcha_Answer model</h2></div></div></div><p>For speeding up the<a id="id385" class="indexterm"/> process, we will again use the <code class="literal">oil</code> command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php oil generate model captcha_answer expected_value:int created_at:int --crud</strong></span>
</pre></div><p>This will print the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Creating model: APPPATH/classes/model/captcha/answer.php</strong></span>
<span class="strong"><strong>Creating migration: APPPATH/migrations/002_create_captcha_answers.php</strong></span>
</pre></div><p>Before doing anything else, you need to move these files into our package:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Move <code class="literal">APPPATH/classes/model/captcha/answer.php</code> to <code class="literal">PKGPATH/captcha/classes/model/captcha/answer.php</code>.</li><li class="listitem" style="list-style-type: disc">Also, move <code class="literal">APPPATH/migrations/002_create_captcha_answers.php</code> to <code class="literal">PKGPATH/captcha/migrations/001_create_captcha_answers.php</code> (don't forget to rename the file).</li></ul></div><p>Once it is done, open <code class="literal">PKGPATH/captcha/classes/model/captcha/answer.php</code> and add the following at the beginning of the file (after <code class="literal">&lt;?php</code>):</p><div class="informalexample"><pre class="programlisting">namespace Captcha;</pre></div><p>You also need to add the following property inside the model, in order to automatically fill the <code class="literal">created_at</code> property:</p><div class="informalexample"><pre class="programlisting">protected static $_created_at = 'created_at';</pre></div><p>Open the <code class="literal">bootstrap</code> file located at <code class="literal">PKGPATH/captcha/bootstrap.php</code>, and add the following code at the end of the array passed to <code class="literal">Autoloader::add_classes</code>:</p><div class="informalexample"><pre class="programlisting">    'Captcha\\Model_Captcha_Answer' =&gt; __DIR__ . '/classes/model/captcha/answer.php',</pre></div></div><div class="section" title="Migrating the package"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec47"/>Migrating the package</h2></div></div></div><p>We now need to execute the <a id="id386" class="indexterm"/>migration file in the <code class="literal">Captcha</code> package. In order to do this, simply enter the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php oil refine migrate --packages=captcha</strong></span>
</pre></div></div><div class="section" title="Integrating the package into our application"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec48"/>Integrating the package into our application</h2></div></div></div><p>In this section, for the sake of clarity, we will assume that you haven't implemented the reCAPTCHA solution. Although, it is worth noting that this new implementation will clearly be inspired from it. Thus, if you have implemented the reCAPTCHA solution, simply replace the old code by the new one as you go.</p><p>First, add the following methods in the <code class="literal">Captcha</code> class located at <code class="literal">PKGPATH/captcha/classes/captcha.php</code>:</p><div class="informalexample"><pre class="programlisting">public function check_answer($id, $answer) {
    return true;
}

public function get_html() {
    return '&lt;div&gt;Will be implemented in the next section&lt;/div&gt;';
}</pre></div><p>You can notice we didn't implement anything inside those methods; these are just dummy methods. As they are a little bit complex, we will complete them in the next section, but for now we will connect them to the test application. Open the <code class="literal">APPPATH/views/item/_form.php</code>, and between the two <code class="literal">div</code> elements with the <code class="literal">form-group</code> class, add the following lines of code:</p><div class="informalexample"><pre class="programlisting">&lt;div class="form-group"&gt;
&lt;?php
echo Form::label('Please verify that you are human');

// Displaying the captcha form
echo Captcha::forge()-&gt;get_html();
?&gt;
&lt;/div&gt;</pre></div><p>At the beginning <a id="id387" class="indexterm"/>of the <code class="literal">create</code> and <code class="literal">edit</code> action of the <code class="literal">Item</code> controller, add the following code:</p><div class="informalexample"><pre class="programlisting">Package::load('captcha');</pre></div><p>We have now to check whether the value entered by the user is correct. Open the <code class="literal">Item</code> controller, and in the <code class="literal">create</code> and <code class="literal">edit</code> actions, surround the following code:</p><div class="informalexample"><pre class="programlisting">$val = Model_Item::validate(/* 'create' or 'edit' */);

if ($val-&gt;run())
// And the following if else statement content</pre></div><p>By:</p><div class="informalexample"><pre class="programlisting">if (static::is_captcha_correct())
{
    // Code to be surrounded
} else {
    Session::set_flash(
        'error',
        'You have entered an invalid value for the captcha'
    );
}</pre></div><p>Finally, still in the <code class="literal">Item</code> controller, add the CAPTCHA verification method:</p><div class="informalexample"><pre class="programlisting">public static function is_captcha_correct() {
    // Checking the captcha
    return Captcha::forge()
        -&gt;check_answer(
            Input::post('captcha_id'),
            Input::post('captcha_answer')
    );
}</pre></div><p>If you now test your<a id="id388" class="indexterm"/> application, the message <span class="strong"><strong>Will be implemented in the next section</strong></span> will appear under <span class="strong"><strong>Please verify that you are human</strong></span>, and any item will be added or updated without any checking, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5401OS_04_03.jpg" alt="Integrating the package into our application"/></div></div><div class="section" title="Implementing the get_html method"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec49"/>Implementing the get_html method</h2></div></div></div><p>Open the <code class="literal">Captcha</code> class and <a id="id389" class="indexterm"/>replace the <code class="literal">get_html</code> method by the following:</p><div class="informalexample"><pre class="programlisting">/**
* Returns the CAPTCHA form
* 
* @return string the CAPTCHA form html code
*/
public function get_html() {

    // Getting configuration
    $min_number = $this-&gt;get_config('min_number');
    $max_number = $this-&gt;get_config('max_number');

    // Generating two random numbers
    $number_1 = rand($min_number, $max_number);
    $number_2 = rand($min_number, $max_number);

    // Computing the correct answer
    $answer = $number_1 + $number_2;

    // Saving the expected answer
    $captcha_answer = Model_Captcha_Answer::forge();
    $captcha_answer-&gt;expected_value = $answer;
    $captcha_answer-&gt;save();


    return \View::forge(
        'captcha',
        array(
            'number_1' =&gt; $number_1,
            'number_2' =&gt; $number_2,
            'captcha_answer' =&gt; $captcha_answer,
        )
    )-&gt;render();
}</pre></div><p>As you can see, we are calling the <code class="literal">captcha</code> view inside the <code class="literal">get_html</code> method. Thus, we need to implement it. Create the <code class="literal">PKGPATH/captcha/views/captcha.php</code> view file and add the following content:</p><div class="informalexample"><pre class="programlisting">&lt;div class="captcha_area"&gt;
    &lt;div class="captcha_instruction"&gt;
        &lt;?php echo $number_1; ?&gt; + &lt;?php echo $number_2; ?&gt; ?
    &lt;/div&gt;
    &lt;div class="captcha_fields"&gt;
        &lt;input type="hidden" name="captcha_id"
               value="&lt;?php echo $captcha_answer-&gt;id; ?&gt;" /&gt;
        &lt;input type="text" name="captcha_answer"
               value="" class="col-md-4 form-control" /&gt;
    &lt;/div&gt;
&lt;/div&gt;</pre></div><p>Finally, as you probably <a id="id390" class="indexterm"/>noticed in the <code class="literal">new get_html</code> method, we get <code class="literal">min_number</code> and <code class="literal">max_number</code> from the configuration file, so we need to define these values (feel free to change them). Open the <code class="literal">PKGPATH/captcha/config/captcha.php</code> configuration file, and replace its content by the following lines of code:</p><div class="informalexample"><pre class="programlisting">&lt;?php

return array(
    'min_number' =&gt; 1,
    'max_number' =&gt; 9,
);</pre></div><p>If you reload the creation or edition form, you will now see the CAPTCHA verification form:</p><div class="mediaobject"><img src="graphics/5401OS_04_04.jpg" alt="Implementing the get_html method"/></div></div><div class="section" title="Implementing the CAPTCHA verification method"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec50"/>Implementing the CAPTCHA verification method</h2></div></div></div><p>The <code class="literal">check_answer</code> method is pretty simple; as<a id="id391" class="indexterm"/> we saved the expected answer into a <code class="literal">Model_Captcha_Answer</code> instance, we just have to retrieve it and check whether the posted answer is correct. In the <code class="literal">Captcha</code> class, replace the <code class="literal">check_answer</code> method by the following code:</p><div class="informalexample"><pre class="programlisting">/**
* Check if the captcha is valid
* 
* @param int $id id of the CAPTCHA answer
* @param string $answer answer given by the visitor
* @return boolean is the answer correct ?
*/
public function check_answer($id, $answer) {
    // Model::find_by_pk finds an instance by its
    // Primary Key (in our case, id).
    $captcha_answer = Model_Captcha_Answer::find_by_pk(
        intval($id)
    );
    $correct = $captcha_answer-&gt;expected_value == $answer;
    
    // The answer has been checked, so no need to keep the
    // expected answer
    $captcha_answer-&gt;delete();
    
    return $correct;
}</pre></div></div><div class="section" title="Cleaning old captchas"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec51"/>Cleaning old captchas</h2></div></div></div><p>As you might have noticed, each <a id="id392" class="indexterm"/>time we display a CAPTCHA, we add a new row<a id="id393" class="indexterm"/> into the <code class="literal">captcha_answers</code> table, and this row will be cleared when, or rather if, the user submits their answer. If the user leaves the form without submitting it, the row will never be deleted. A good practice would be to periodically delete these rows. We could use the model's delete method for this, but since there can be several rows to be removed, we will instead simply execute a SQL request.</p><p>Still in the <code class="literal">Captcha</code> class, add the following method:</p><div class="informalexample"><pre class="programlisting">/**
* Clean the old captchas
*/
public function clean_old_captchas() {
    \DB::query('
        DELETE FROM `captcha_answers`
        WHERE `created_at` &lt; '.
       intval(\Date::forge()-&gt;get_timestamp()
        - $this-&gt;get_config('captcha_expiration'))
        .';')
        -&gt;execute();
}</pre></div><p>You can then add the<a id="id394" class="indexterm"/> following <a id="id395" class="indexterm"/>at the beginning of the <code class="literal">get_html</code> and <code class="literal">check_answer</code> methods:</p><div class="informalexample"><pre class="programlisting">$this-&gt;clean_old_captchas();</pre></div><p>Since we are using <code class="literal">$this-&gt;get_config('captcha_expiration')</code> to determine when a <code class="literal">CAPTCHA</code> expires, we need to define the <code class="literal">captcha_expiration</code> key in the <code class="literal">PKGPATH/captcha/config/captcha.php</code> configuration file:</p><div class="informalexample"><pre class="programlisting">    // Captcha are expired 4 hours after generation
    'captcha_expiration' =&gt; 3600 * 4,</pre></div></div><div class="section" title="Possible improvements"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec52"/>Possible improvements</h2></div></div></div><p>As we explained in the beginning of this section, the package<a id="id396" class="indexterm"/> can certainly be improved. Instead of displaying the addition in plain text, you could display it inside an image. You could then make it a little difficult to read, for example, by adding noise and alternating colors. This is out of scope of this chapter, since we want to focus on packages, but it is recommended that you add such features to improve your PHP and FuelPHP skills.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec43"/>Summary</h1></div></div></div><p>The main focus of this chapter was packages: how to install external packages and how to create your own packages. You have therefore learned how to create and use reusable code. We have used the <span class="strong"><strong>fuel-recaptcha</strong></span> package, but if you go to the URL <a class="ulink" href="https://github.com/fuel-packages?tab=repositories">https://github.com/fuel-packages?tab=repositories</a>, you will see there are a lot of different packages available. Since FuelPHP also uses Composer, you can look into <a class="ulink" href="https://packagist.org/search/?q=fuel">https://packagist.org/search/?q=fuel</a> and install additional packages using Composer.</p><p>When you think about adding a new feature in your application, it is always a good idea to see if there is an existing project fulfilling your needs. If you can't find one, you can improve a close enough package or create your own, as we did with our custom <code class="literal">Captcha</code> package. Once finished, consider sharing it, for instance, by publishing it on GitHub; you can then give back to the community who brought you this amazing framework.</p><p>In the next chapter, you will see how you can create an application providing and using its own API. We will also tackle how you can automatically test your application to prevent unwanted regressions.</p></div></body></html>