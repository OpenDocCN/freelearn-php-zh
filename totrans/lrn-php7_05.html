<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;5.&#xA0;Using Databases" id="1AT9A1-edcc22b134104d5db0bf3aa086c86851"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05" class="calibre1"/>Chapter 5. Using Databases</h1></div></div></div><p class="calibre8">Data is probably the cornerstone of most web applications. Sure, your application has to be pretty, fast, error-free, and so on, but if something is essential to users, it is what data you can manage for them. From this, we can extract that managing data is one of the most important things you have to consider when designing your application.</p><p class="calibre8">Managing data implies not only storing read-only files and reading them when needed, as we were doing so far, but also adding, fetching, updating, and removing individual pieces of information. For this, we need a tool that categorizes our data and makes these tasks easier for us, and this is when databases come into play.</p><p class="calibre8">In this chapter, you will learn about:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Schemas and tables</li><li class="listitem">Manipulating and querying data</li><li class="listitem">Using PDO to connect your database with PHP</li><li class="listitem">Indexing your data</li><li class="listitem">Constructing complex queries in joining tables</li></ul></div></div>

<div class="book" title="Chapter&#xA0;5.&#xA0;Using Databases" id="1AT9A1-edcc22b134104d5db0bf3aa086c86851">
<div class="book" title="Introducing databases"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch05lvl1sec39" class="calibre1"/>Introducing databases</h1></div></div></div><p class="calibre8">Databases <a id="id356" class="calibre1"/>are tools to manage data. The basic functions of a database are inserting, searching, updating, and deleting data, even though most database systems do more than this. Databases are classified into two different categories depending on how they store data: relational and nonrelational databases.</p><p class="calibre8">Relational databases structure data in a very detailed way, forcing the user to use a defined format and allowing the creation of connections—that is, relations—between different pieces of information. Nonrelational databases are systems that store data in a more relaxed way, as though there were no apparent structure. Even though with these very vague definitions you could assume that everybody would like to use relational databases, both systems are very useful; it just depends on how you want to use them.</p><p class="calibre8">In this book, we will focus on relational databases as they are widely used in small web applications, in which there are not huge amounts of data. The reason is that usually the application contains data that is interrelated; for example, our application could store sales, which<a id="id357" class="calibre1"/> are composed of customers and books.</p></div></div>

<div class="book" title="Chapter&#xA0;5.&#xA0;Using Databases" id="1AT9A1-edcc22b134104d5db0bf3aa086c86851">
<div class="book" title="Introducing databases">
<div class="book" title="MySQL"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec71" class="calibre1"/>MySQL</h2></div></div></div><p class="calibre8">MySQL<a id="id358" class="calibre1"/> has been the favorite choice of PHP developers for quite a long time. It is a relational database system that uses SQL as the language to communicate with the system. SQL is used in quite a few other systems, which makes things easier in case you need to switch databases or just need to understand an application with a different database than the one you are used to. The rest of the chapter will be focused on<a id="id359" class="calibre1"/> MySQL, but it will be helpful for you even if you choose a different SQL system.</p><p class="calibre8">In order to use MySQL, you need to install two applications: the server and the client. You might remember server-client applications from <a class="calibre1" title="Chapter 2. Web Applications with PHP" href="part0019_split_000.html#I3QM2-edcc22b134104d5db0bf3aa086c86851">Chapter 2</a>, <span class="strong"><em class="calibre12">Web Applications with PHP</em></span>. The MySQL server is a program that listens for instructions or queries from clients, executes them, and returns a result. You need to start the server in order to access the database; take a look at <a class="calibre1" title="Chapter 1. Setting Up the Environment" href="part0014_split_000.html#DB7S1-edcc22b134104d5db0bf3aa086c86851">Chapter 1</a>, <span class="strong"><em class="calibre12">Setting Up the Environment</em></span>, on how to do this. The client is an application that allows you to construct instructions and send them to the server, and it is the one that you will use.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note14" class="calibre1"/>Note</h3><p class="calibre8">
<span class="strong"><strong class="calibre2">GUI versus command line</strong></span>
</p><p class="calibre8">
<span class="strong"><strong class="calibre2">The Graphical User Interface</strong></span> (<span class="strong"><strong class="calibre2">GUI</strong></span>)<a id="id360" class="calibre1"/> is very common when using a database. It helps you in constructing instructions, and you can even manage data without them using just visual tables. On the other hand, command-line clients force you to write all the commands by hand, but they are lighter than GUIs, faster to start, and force you to remember how to write SQL, which you need when you write your applications in PHP. Also, in general, almost any machine with a database will have a MySQL client but might not have a graphical application.</p><p class="calibre8">You can choose the one that you are more comfortable with as you will usually work with your own machine. However, keep in mind that a basic knowledge of the command line will save your life on several occasions.</p></div><p class="calibre8">In order to connect the client with a server, you need to provide some information on where to connect and the credentials for the user to use. If you do not customize your MySQL installation, you should at least have a root user with no password, which is the one we will use. You could think that this seems to be a horrible security hole, and it might be so, but you should not be able to connect using this user if you do not connect from the same machine on which the server is. The most common arguments that you can use to provide information when starting the client are:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">-u &lt;name&gt;</code>: This specifies the user—in our case, <code class="email">root</code>.</li><li class="listitem"><code class="email">-p&lt;password&gt;</code>: Without a space, this specifies the password. As we do not have a password for our user, we do not need to provide this.</li><li class="listitem"><code class="email">-h &lt;host&gt;</code>: This specifies where to connect. By default, the client connects to the same machine. As this is our case, there is no need to specify any. If you had to, you could specify either an IP address or a hostname.</li><li class="listitem"><code class="email">&lt;schema name&gt;</code>: This specifies the name of the schema to use. We will explain in a bit what this means.</li></ul></div><p class="calibre8">With these rules, you <a id="id361" class="calibre1"/>should be able to connect to your database with the <code class="email">mysql -u root</code> command. You should get an output very similar to the following one:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">$ mysql -u root</strong></span>
<span class="strong"><strong class="calibre2">Welcome to the MySQL monitor.  Commands end with ; or \g.</strong></span>
<span class="strong"><strong class="calibre2">Your MySQL connection id is 2</strong></span>
<span class="strong"><strong class="calibre2">Server version: 5.1.73 Source distribution</strong></span>

<span class="strong"><strong class="calibre2">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</strong></span>

<span class="strong"><strong class="calibre2">Oracle is a registered trademark of Oracle Corporation and/or its</strong></span>
<span class="strong"><strong class="calibre2">affiliates. Other names may be trademarks of their respective</strong></span>
<span class="strong"><strong class="calibre2">owners.</strong></span>

<span class="strong"><strong class="calibre2">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</strong></span>

<span class="strong"><strong class="calibre2">mysql&gt;</strong></span>
</pre></div><p class="calibre8">The <a id="id362" class="calibre1"/>terminal will show you the version of the server and some useful information about how to use the client. From now on, the command line will start with <code class="email">mysql&gt;</code> instead of your normal prompt, showing you that you are using the MySQL client. In order to execute queries, just type the query, end it with a semicolon, and press <span class="strong"><em class="calibre12">Enter</em></span>. The client will send the query to the server and will show the result of it. To exit the client, you can either type <code class="email">\q</code> and press <span class="strong"><em class="calibre12">Enter</em></span> or press <span class="strong"><em class="calibre12">Ctrl</em></span> + <span class="strong"><em class="calibre12">D</em></span>, even though this last option will depend on your operating system.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Schemas and tables"><div class="book" id="1BRPS2-edcc22b134104d5db0bf3aa086c86851"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec40" class="calibre1"/>Schemas and tables</h1></div></div></div><p class="calibre8">Relational database systems usually have the same structure. They store data in different databases or <a id="id363" class="calibre1"/>
<span class="strong"><strong class="calibre2">schemas</strong></span>, which separate the data from different applications. These schemas are just collections of<a id="id364" class="calibre1"/> <span class="strong"><strong class="calibre2">tables</strong></span>. Tables are definitions of specific data structures and are composed of <a id="id365" class="calibre1"/>
<span class="strong"><strong class="calibre2">fields</strong></span>. A field is a basic data type that defines the smallest component of information as though they were the atoms of the data. So, schemas are group of tables that are composed of fields. Let's look at each of these elements.</p></div>

<div class="book" title="Schemas and tables">
<div class="book" title="Understanding schemas"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec72" class="calibre1"/>Understanding schemas</h2></div></div></div><p class="calibre8">As defined<a id="id366" class="calibre1"/> before, schemas or databases— in MySQL, they are synonyms—are collections of tables with a common context, usually belonging to the same application. Actually, there are no restrictions around this, and you could have several schemas belonging to the same application if needed. However, for small web applications, as it is our case, we will have just one schema.</p><p class="calibre8">Your server probably already has some schemas. They usually contain the metadata needed for MySQL in order to operate, and we highly recommend that you do not modify them. Instead, let's just create our own schema. Schemas are quite simple elements, and they only have a mandatory name and an optional charset. The name identifies the schema, and the charset defines which type of codification or "alphabet" the strings should follow. As the default charset is <code class="email">latin1</code>, if you do not need to change it, you do not need to specify it.</p><p class="calibre8">Use <code class="email">CREATE SCHEMA</code> followed by the name of the schema in order to create the schema that we will use for our bookstore. The name has to be representative, so let's name it <code class="email">bookstore</code>. Remember to end your line with a semicolon. Take a look at the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; CREATE SCHEMA bookstore;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 1 row affected (0.00 sec)</strong></span>
</pre></div><p class="calibre8">If you need to remember how a schema was created, you can use <code class="email">SHOW CREATE SCHEMA</code> to see its description, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SHOW CREATE SCHEMA bookstore \G</strong></span>
<span class="strong"><strong class="calibre2">*************************** 1. row ***************************</strong></span>
<span class="strong"><strong class="calibre2">       Database: bookstore</strong></span>
<span class="strong"><strong class="calibre2">Create Database: CREATE DATABASE `bookstore` /*!40100 DEFAULT CHARACTER SET latin1 */</strong></span>
<span class="strong"><strong class="calibre2">1 row in set (0.00 sec)</strong></span>
</pre></div><p class="calibre8">As you can see, we ended the query with <code class="email">\G</code> instead of a semicolon. This tells the client to format the response in a different way than the semicolon does. When using a command of the <code class="email">SHOW CREATE</code> family, we recommend that you end it with <code class="email">\G</code> to get a better understanding.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip08" class="calibre1"/>Tip</h3><p class="calibre8">
<span class="strong"><strong class="calibre2">Should you use uppercase or lowercase?</strong></span>
</p><p class="calibre8">When writing queries, you might note that we used uppercase for keywords and lowercase for identifiers, such as names of schemas. This is just a convention widely used in order to make it clear what is part of SQL and what is your data. However, MySQL keywords are case-insensitive, so you could use any case indistinctively.</p></div><p class="calibre8">All data must<a id="id367" class="calibre1"/> belong to a schema. There cannot be data floating around outside all schemas. This way, you cannot do anything unless you specify the schema you want to use. In order to do this, just after starting your client, use the <code class="email">USE</code> keyword followed by the name of the schema. Optionally, you could tell the client which schema to use when connecting to it, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; USE bookstore;</strong></span>
<span class="strong"><strong class="calibre2">Database changed</strong></span>
</pre></div><p class="calibre8">If you do not remember what the name of your schema is or want to check which other schemas are in your server, you can run the <code class="email">SHOW SCHEMAS;</code> command to get a list of them, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SHOW SCHEMAS;</strong></span>
<span class="strong"><strong class="calibre2">+--------------------+</strong></span>
<span class="strong"><strong class="calibre2">| Database           |</strong></span>
<span class="strong"><strong class="calibre2">+--------------------+</strong></span>
<span class="strong"><strong class="calibre2">| information_schema |</strong></span>
<span class="strong"><strong class="calibre2">| bookstore          |</strong></span>
<span class="strong"><strong class="calibre2">| mysql              |</strong></span>
<span class="strong"><strong class="calibre2">| test               |</strong></span>
<span class="strong"><strong class="calibre2">+--------------------+</strong></span>
<span class="strong"><strong class="calibre2">4 rows in set (0.00 sec)</strong></span>
</pre></div></div></div>

<div class="book" title="Schemas and tables">
<div class="book" title="Database data types"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec73" class="calibre1"/>Database data types</h2></div></div></div><p class="calibre8">As in PHP, MySQL<a id="id368" class="calibre1"/> also has data types. They are used to define which kind of data a field can contain. As in PHP, MySQL is quite flexible with data types, transforming them from one type to the other if needed. There are quite a few of them, but we will explain the most important ones. We highly recommend that you visit the official documentation related to data types<a id="id369" class="calibre1"/> at <a class="calibre1" href="http://dev.mysql.com/doc/refman/5.7/en/data-types.html">http://dev.mysql.com/doc/refman/5.7/en/data-types.html</a> if you want to build applications with more complex data structures.</p><div class="book" title="Numeric data types"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec10" class="calibre1"/>Numeric data types</h3></div></div></div><p class="calibre8">Numeric data <a id="id370" class="calibre1"/>can be categorized as integers or decimal <a id="id371" class="calibre1"/>numbers. For integers, MySQL uses the <code class="email">INT</code> data type even though there are versions to store smaller numbers, such as <code class="email">TINYINT</code>, <code class="email">SMALLINT</code>, or <code class="email">MEDIUMINT</code>, or bigger numbers, such as <code class="email">BIGINT</code>. The following table shows what the sizes of the different numeric types are, so you can choose which one to use depending on your situation:</p><div class="informalexample"><table border="1" class="calibre15"><colgroup class="calibre16"><col class="calibre17"/><col class="calibre17"/></colgroup><thead class="calibre18"><tr class="calibre19"><th valign="bottom" class="calibre20">
<p class="calibre21">Type</p>
</th><th valign="bottom" class="calibre20">
<p class="calibre21">Size/precision</p>
</th></tr></thead><tbody class="calibre22"><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">TINYINT</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">-128 to 127</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">SMALLINT</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">-32,768 to 32,767</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">MEDIUMINT</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">-8,388,608 to 8,388,607</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">INT</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">-2,147,483,648 to 2,147,483,647</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">BIGINT</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">-9,223,372,036,854,775,808 to 9,223,372,036,854,775,807</p>
</td></tr></tbody></table></div><p class="calibre8">Numeric types can be defined as signed by default or unsigned; that is, you can allow or not allow them to contain negative values. If a numeric type is defined as <code class="email">UNSIGNED</code>, the range of numbers that it can take is doubled as it does not need to save space for negative numbers.</p><p class="calibre8">For decimal numbers we have two types: approximate values, which are faster to process but are not exact sometimes, and exact values that give you exact precision on the decimal value. For approximate values or the floating-point type, we have <code class="email">FLOAT</code> and <code class="email">DOUBLE</code>. For exact values or the fixed-point type we have <code class="email">DECIMAL</code>.</p><p class="calibre8">MySQL allows you to specify the number of digits and decimal positions that the number can take. For example, to specify a number that can contains five digits and up to two of them can be decimal, we will use the <code class="email">FLOAT(5,2)</code> notation. This is useful as a constraint, as you will note when we create tables with prices.</p></div><div class="book" title="String data types"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec11" class="calibre1"/>String data types</h3></div></div></div><p class="calibre8">Even though <a id="id372" class="calibre1"/>there are several data types that allow you to store<a id="id373" class="calibre1"/> from single characters to big chunks of text or binary code, it is outside the scope of this chapter. In this section, we will introduce you to three types: <code class="email">CHAR</code>, <code class="email">VARCHAR</code>, and <code class="email">TEXT</code>.</p><p class="calibre8">
<code class="email">CHAR</code> is a data type that allows you to store an exact number of characters. You need to specify how long the string will be once you define the field, and from this point on, all values for this field have to be of this length. One possible usage in our applications could be when storing the ISBN of the book as we know it is always 13 characters long.</p><p class="calibre8">
<code class="email">VARCHAR</code> or variable char is a data type that allows you to store strings up to 65,535 characters long. You do not need to specify how long they need to be, and you can insert strings of different lengths without an issue. Of course, the fact that this type is dynamic makes it slower to process compared with the previous one, but after a few times you know how long a string will always be. You could tell MySQL that even if you want to insert strings of different lengths, the maximum length will be a determined number. This will help its performance. For example, names are of different lengths, but you can safely assume that no name will be longer than 64 characters, so your field could be defined as <code class="email">VARCHAR(64)</code>.</p><p class="calibre8">Finally, <code class="email">TEXT</code> is<a id="id374" class="calibre1"/> a data type for really big strings. You could<a id="id375" class="calibre1"/> use it if you want to store long comments from users, articles, and so on. As with <code class="email">INT</code>, there are different versions of this data type: <code class="email">TINYTEXT</code>, <code class="email">TEXT</code>, <code class="email">MEDIUMTEXT</code>, and <code class="email">LONGTEXT</code>. Even if they are very important in almost any web application with user interaction, we will not use them in ours.</p></div><div class="book" title="List of values"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec12" class="calibre1"/>List of values</h3></div></div></div><p class="calibre8">In MySQL, you can force <a id="id376" class="calibre1"/>a field to have a set of valid values. There are <a id="id377" class="calibre1"/>two types of them: <code class="email">ENUM</code>, which allows exactly one of the possible predefined values, and <code class="email">SET</code>, which allows any number of the predefined values.</p><p class="calibre8">For example, in our application, we have two types of customers: basic and premium. If we want to store our customers in a database, there is a chance that one of the fields will be the type of customer. As a customer has to be either basic or premium, a good solution would be to define the field as an enum as <code class="email">ENUM("basic", "premium")</code>. In this way, we will make sure that all customers stored in our database will be of a correct type.</p><p class="calibre8">Although enums are quite common to use, the use of sets is less widespread. It is usually a better idea to use an extra table to define the values of the list, as you will note when we talk about foreign keys in this chapter.</p></div><div class="book" title="Date and time data types"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec13" class="calibre1"/>Date and time data types</h3></div></div></div><p class="calibre8">Date and time types <a id="id378" class="calibre1"/>are the most complex data types in<a id="id379" class="calibre1"/> MySQL. Even though the idea is simple, there are several functions and edge cases around these types. We cannot go through all of them, so we will just explain the most common uses, which are the ones we will need for our application.</p><p class="calibre8">
<code class="email">DATE</code> stores dates—that is, a combination of day, month, and year. <code class="email">TIME</code> stores times—that is, a combination of hour, minute, and second. <code class="email">DATETIME</code> are data types for both date and time. For any of these data types, you can provide just a string specifying what the value is, but you need to be careful with the format that you use. Even though you can always specify the format that you are entering the data in, you can just enter the dates or times in the default format—for example, 2014-12-31 for dates, 14:34:50 for time, and 2014-12-31 14:34:50 for the date and time.</p><p class="calibre8">A fourth type is <code class="email">TIMESTAMP</code>. This type stores an integer, which is the representation of the seconds from January 1, 1970, which is also known as the Unix timestamp. This is a very useful type as in PHP, it is really easy to get the current Unix timestamp with the <code class="email">now()</code> function, and the format for this data type is always the same, so it is safer to work with it. The downside is that the range of dates that it can represent is limited as compared to other types.</p><p class="calibre8">There are some<a id="id380" class="calibre1"/> functions that help you manage these types. These <a id="id381" class="calibre1"/>functions extract specific parts of the whole value, return the value with a different format, add or subtract dates, and so on. Let's take a look at a short list of them:</p><div class="informalexample"><table border="1" class="calibre15"><colgroup class="calibre16"><col class="calibre17"/><col class="calibre17"/></colgroup><thead class="calibre18"><tr class="calibre19"><th valign="bottom" class="calibre20">
<p class="calibre21">Function name</p>
</th><th valign="bottom" class="calibre20">
<p class="calibre21">Description</p>
</th></tr></thead><tbody class="calibre22"><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">DAY()</code>, <code class="literal">MONTH()</code>, and <code class="literal">YEAR()</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">Extracts <a id="id382" class="indexterm"/>the <a id="id383" class="indexterm"/>specific value for the day, month, or<a id="id384" class="indexterm"/> year from the <code class="literal">DATE</code> or <code class="literal">DATETIME</code> provided value.</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">HOUR()</code>, <code class="literal">MINUTE()</code>, and <code class="literal">SECOND()</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">Extracts <a id="id385" class="indexterm"/>the specific value for the hour, minute, or<a id="id386" class="indexterm"/> second<a id="id387" class="indexterm"/> from the <code class="literal">TIME</code> or <code class="literal">DATETIME</code> provided value.</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">CURRENT_DATE()</code> and <code class="literal">CURRENT_TIME()</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">Returns<a id="id388" class="indexterm"/> the current date or <a id="id389" class="indexterm"/>current time.</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">NOW()</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">Returns the<a id="id390" class="indexterm"/> current date and time.</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">DATE_FORMAT()</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">Returns<a id="id391" class="indexterm"/> the <code class="literal">DATE</code>, <code class="literal">TIME</code> or <code class="literal">DATETIME</code> value with the specified format.</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">DATE_ADD()</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">Adds <a id="id392" class="indexterm"/>the specified interval of time to a given date or time type.</p>
</td></tr></tbody></table></div><p class="calibre8">Do not worry if you are confused on how to use any of these functions; we will use them during the rest of the book as part of our application. Also, an extensive list of all the types can be <a id="id393" class="calibre1"/>found at <a class="calibre1" href="http://dev.mysql.com/doc/refman/5.7/en/date-and-time-functions.html">http://dev.mysql.com/doc/refman/5.7/en/date-and-time-functions.html</a>.</p></div></div></div>

<div class="book" title="Schemas and tables">
<div class="book" title="Managing tables"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec74" class="calibre1"/>Managing tables</h2></div></div></div><p class="calibre8">Now that you<a id="id394" class="calibre1"/> understand the different types of data that fields can take, it is time to introduce tables. As defined in the <span class="strong"><em class="calibre12">Schemas and tables</em></span> section, a table is a collection of fields that defines a type of information. You could compare it with OOP and think of tables as classes, fields being their properties. Each instance of the class would be a row on the table.</p><p class="calibre8">When defining a table, you have to declare the list of fields that the table contains. For each field, you need to specify its name, its type, and some extra information depending on the type of the field. The most common are:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">NOT NULL</code>: This is used if the field cannot be null—that is, if it needs a concrete valid <a id="id395" class="calibre1"/>value for each row. By default, a field can be null.</li><li class="listitem"><code class="email">UNSIGNED</code>: As <a id="id396" class="calibre1"/>mentioned earlier, this is used to forbid the use of negative numbers in this field. By default, a numeric field accepts negative numbers.</li><li class="listitem"><code class="email">DEFAULT &lt;value&gt;</code>: This<a id="id397" class="calibre1"/> defines a default value in case the user does not provide any. Usually, the default value is null if this clause is not specified.</li></ul></div><p class="calibre8">Table definitions also need a name, as with schemas, and some optional attributes. You can define the charset of the table or its engine. Engines can be a quite large topic to cover, but for the scope of this chapter, let's just note that we should use the InnoDB engine if we need strong relationships between tables. For more advanced readers, you can read more about<a id="id398" class="calibre1"/> MySQL engines at <a class="calibre1" href="https://dev.mysql.com/doc/refman/5.0/en/storage-engines.html">https://dev.mysql.com/doc/refman/5.0/en/storage-engines.html</a>.</p><p class="calibre8">Knowing this, let's try to create a table that will keep our books. The name of the table should be <code class="email">book</code>, as each row will define a book. The fields could have the same properties the <code class="email">Book</code> class has. Let's take a look at how the query to construct the table would look:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; CREATE TABLE book(</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; isbn CHAR(13) NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; title VARCHAR(255) NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; author VARCHAR(255) NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; stock SMALLINT UNSIGNED NOT NULL DEFAULT 0,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; price FLOAT UNSIGNED</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ) ENGINE=InnoDb;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 0 rows affected (0.01 sec)</strong></span>
</pre></div><p class="calibre8">As you can note, we can add more new lines until we end the query with a semicolon. With this, we can format the query in a way that looks more readable. MySQL will let us know that we are still writing the same query showing the <code class="email">-&gt;</code> prompt. As this table contains five fields, it is very likely that we will need to refresh our minds from time to time as we will forget them. In order to display the structure of the table, you could use the <code class="email">DESC</code> command, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; DESC book;</strong></span>
<span class="strong"><strong class="calibre2">+--------+----------------------+------+-----+---------+-------+</strong></span>
<span class="strong"><strong class="calibre2">| Field  | Type                 | Null | Key | Default | Extra |</strong></span>
<span class="strong"><strong class="calibre2">+--------+----------------------+------+-----+---------+-------+</strong></span>
<span class="strong"><strong class="calibre2">| isbn   | char(13)             | NO   |     | NULL    |       |</strong></span>
<span class="strong"><strong class="calibre2">| title  | varchar(255)         | NO   |     | NULL    |       |</strong></span>
<span class="strong"><strong class="calibre2">| author | varchar(255)         | NO   |     | NULL    |       |</strong></span>
<span class="strong"><strong class="calibre2">| stock  | smallint(5) unsigned | NO   |     | 0       |       |</strong></span>
<span class="strong"><strong class="calibre2">| price  | float unsigned       | YES  |     | NULL    |       |</strong></span>
<span class="strong"><strong class="calibre2">+--------+----------------------+------+-----+---------+-------+</strong></span>
<span class="strong"><strong class="calibre2">5 rows in set (0.00 sec)</strong></span>
</pre></div><p class="calibre8">We used <code class="email">SMALLINT</code> for <code class="email">stock</code> as it is very unlikely that we will have more than thousands of copies of <a id="id399" class="calibre1"/>the same book. As we know that ISBN is 13 characters long, we enforced this when defining the field. Finally, both <code class="email">stock</code> and <code class="email">price</code> are unsigned as negative values do not make sense. Let's now create our <code class="email">customer</code> table via the following script:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; CREATE TABLE customer(</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; id INT UNSIGNED NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; firstname VARCHAR(255) NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; surname VARCHAR(255) NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; email VARCHAR(255) NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; type ENUM('basic', 'premium')</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ) ENGINE=InnoDb;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 0 rows affected (0.00 sec)</strong></span>
</pre></div><p class="calibre8">We already anticipated the use of enum for the field type as when designing classes, we could draw a diagram identifying the content of our database. On this, we could show the tables and their fields. Let's take a look at how the diagram of tables would look so far:</p><div class="mediaobject"><img src="../images/00025.jpeg" alt="Managing tables" class="calibre9"/></div><p class="calibre10"> </p><p class="calibre8">Note that even if we<a id="id400" class="calibre1"/> create tables similar to our classes, we will not create a table for <code class="email">Person</code>. The reason is that databases store data, and there isn't any data that we could store for this class as the <code class="email">customer</code> table already contains everything we need. Also, sometimes, we may create tables that do not exist as classes on our code, so the class-table relationship is a very flexible one.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Keys and constraints"><div class="book" id="1CQAE2-edcc22b134104d5db0bf3aa086c86851"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec41" class="calibre1"/>Keys and constraints</h1></div></div></div><p class="calibre8">Now that we have our <a id="id401" class="calibre1"/>main tables <a id="id402" class="calibre1"/>defined, let's try to think about how the data inside would look. Each row inside a table would describe an object, which may be either a book or a customer. What would happen if our application has a bug and allows us to create books or customers with the same data? How will the database differentiate them? In theory, we will assign IDs to customers in order to avoid these scenarios, but how do we enforce that the ID not be repeated?</p><p class="calibre8">MySQL has a mechanism that allows you to enforce certain restrictions on your data. Other than attributes such as <code class="email">NOT NULL</code> or <code class="email">UNSIGNED</code> that you already saw, you can tell MySQL that certain fields are more special than others and instruct it to add some behavior to them. These mechanisms are called <span class="strong"><strong class="calibre2">keys</strong></span>, and there are four types: primary key, unique key, foreign key, and index. Let's take a closer look at them.</p></div>

<div class="book" title="Keys and constraints">
<div class="book" title="Primary keys"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec75" class="calibre1"/>Primary keys</h2></div></div></div><p class="calibre8">Primary keys<a id="id403" class="calibre1"/> are fields that identify a unique row from a table. There<a id="id404" class="calibre1"/> cannot be two of the same value in the same table, and they cannot be null. Adding a primary key to a table that defines <span class="strong"><em class="calibre12">objects</em></span> is almost a must as it will assure you that you will always be able to differentiate two rows by this field.</p><p class="calibre8">Another part that makes primary keys so attractive is their ability to set the primary key as an autoincremental numeric value; that is, you do not have to assign a value to the ID, and MySQL will just pick up the latest inserted ID and increment it by 1, as we did with our <code class="email">Unique</code> trait. Of course, for this to happen, your field has to be an integer data type. In fact, we highly recommend that you always define your primary key as an integer, even if the real-life object does not really have this ID at all. The reason is that you should search a row by this numeric ID, which is unique, and MySQL will add some performance improvements that come by setting the field as a key.</p><p class="calibre8">Then, let's add an ID to our <code class="email">book</code> table. In order to add a new field, we need to alter our table. There is a command that allows you to do this: <code class="email">ALTER TABLE</code>. With this command, you can modify the definition of any existing field, add new ones, or remove existing ones. As we add the field that will be our primary key and be autoincremental, we can add all these modifiers to the field definition. Execute the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; ALTER TABLE book</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ADD id INT UNSIGNED NOT NULL AUTO_INCREMENT </strong></span>
<span class="strong"><strong class="calibre2">    -&gt; PRIMARY KEY FIRST;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 0 rows affected (0.02 sec)</strong></span>
<span class="strong"><strong class="calibre2">Records: 0  Duplicates: 0  Warnings: 0</strong></span>
</pre></div><p class="calibre8">Note <code class="email">FIRST</code> at the end of the command. When adding new fields, if you want them to appear on a different position than at the end of the table, you need to specify the position. It could be either <code class="email">FIRST</code> or <code class="email">AFTER &lt;other field&gt;</code>. For convenience, the primary key of a table is the first of its fields.</p><p class="calibre8">As the table <a id="id405" class="calibre1"/>customer already has an ID field, we do not have to add it <a id="id406" class="calibre1"/>again but rather modify it. In order to do this, we will just use the <code class="email">ALTER TABLE</code> command with the <code class="email">MODIFY</code> option, specifying the new definition of an already existing field, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; ALTER TABLE customer</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; MODIFY id INT UNSIGNED NOT NULL</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; AUTO_INCREMENT PRIMARY KEY;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 0 rows affected (0.00 sec)</strong></span>
<span class="strong"><strong class="calibre2">Records: 0  Duplicates: 0  Warnings: 0</strong></span>
</pre></div></div></div>

<div class="book" title="Keys and constraints">
<div class="book" title="Foreign keys"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec76" class="calibre1"/>Foreign keys</h2></div></div></div><p class="calibre8">Let's imagine<a id="id407" class="calibre1"/> that we need to keep track of the borrowed books. The table <a id="id408" class="calibre1"/>should contain the borrowed book, who borrowed it, and when it was borrowed. So, what kind of data would you use to identify the book or the customer? Would you use the title or the name? Well, we should use something that identifies a unique row from these tables, and this "something" is the primary key. With this action, we will eliminate the change of using a reference that can potentially point to two or more rows at the same time.</p><p class="calibre8">We could then create a table that contains <code class="email">book_id</code> and <code class="email">customer_id</code> as numeric fields, containing the IDs that reference these two tables. As the first approach, it makes sense, but we can find some weaknesses. For example, what happens if we insert wrong IDs and they do not exist in <code class="email">book</code> or <code class="email">customer</code>? We could have some code in our PHP side to make sure that when fetching information from <code class="email">borrowed_books</code>, we only displayed the information that is correct. We could even have a routine that periodically checks for wrong rows and removes them, solving the issue of having wrong data wasting space in the disk. However, as with the <code class="email">Unique</code> trait versus adding primary keys in MySQL, it is usually better to allow the database system to manage these things as the performance will usually be better, and you do not need to write extra code.</p><p class="calibre8">MySQL allows you<a id="id409" class="calibre1"/> to create keys that enforce references to other tables. These are called <span class="strong"><strong class="calibre2">foreign keys</strong></span>, and they are the primary reason for which we were forced to use the <a id="id410" class="calibre1"/>InnoDB table engine instead of any other. A foreign key defines and enforces a reference between this field and another row of a different table. If the ID supplied for the field with a foreign key does not exist in the referenced table, the query will fail. Furthermore, if you have a valid <code class="email">borrowed_books</code> row pointing to an existing book and you remove the entry from the book table, MySQL will complain about it—even though you will be able to customize this behavior soon—as this action would leave wrong data in the system. As you can note, this is way more useful than having to write code to manage these cases.</p><p class="calibre8">Let's create the <code class="email">borrowed_books</code> table with the book, customer references, and dates. Note that we have to define the foreign keys after the definition of the fields as opposed to when we defined primary keys, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; CREATE TABLE borrowed_books(</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; book_id INT UNSIGNED NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; customer_id INT UNSIGNED NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; start DATETIME NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; end DATETIME DEFAULT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; FOREIGN KEY (book_id) REFERENCES book(id),</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; FOREIGN KEY (customer_id) REFERENCES customer(id)</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ) ENGINE=InnoDb;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 0 rows affected (0.00 sec)</strong></span>
</pre></div><p class="calibre8">As with <code class="email">SHOW CREATE SCHEMA</code>, you can also check how the table looks. This command will also show you information about the keys as opposed to the <code class="email">DESC</code> command. Let's take a look at how it would work:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; SHOW CREATE TABLE borrowed_books \G</strong></span>
<span class="strong"><strong class="calibre2">*************************** 1. row ***************************</strong></span>
<span class="strong"><strong class="calibre2">       Table: borrowed_books</strong></span>
<span class="strong"><strong class="calibre2">Create Table: CREATE TABLE `borrowed_books` (</strong></span>
<span class="strong"><strong class="calibre2">  `book_id` int(10) unsigned NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">  `customer_id` int(10) unsigned NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">  `start` datetime NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">  `end` datetime DEFAULT NULL,</strong></span>
<span class="strong"><strong class="calibre2">  KEY `book_id` (`book_id`),</strong></span>
<span class="strong"><strong class="calibre2">  KEY `customer_id` (`customer_id`),</strong></span>
<span class="strong"><strong class="calibre2">  CONSTRAINT `borrowed_books_ibfk_1` FOREIGN KEY (`book_id`) REFERENCES `book` (`id`),</strong></span>
<span class="strong"><strong class="calibre2">  CONSTRAINT `borrowed_books_ibfk_2` FOREIGN KEY (`customer_id`) REFERENCES `customer` (`id`)</strong></span>
<span class="strong"><strong class="calibre2">) ENGINE=InnoDB DEFAULT CHARSET=latin1</strong></span>
<span class="strong"><strong class="calibre2">1 row in set (0.00 sec)</strong></span>
</pre></div><p class="calibre8">Note two important <a id="id411" class="calibre1"/>things here. On one hand, we have two extra keys that we did not define. The reason is that when defining a foreign key, MySQL also defines the field as<a id="id412" class="calibre1"/> a key that will be used to improve performance on the table; we will look into this in a moment. The other element to note is the fact that MySQL defines names to the keys by itself. This is necessary as we need to be able to reference them in case we want to change or remove this key. You can let MySQL name the keys for you, or you can specify the names you prefer when creating them.</p><p class="calibre8">We are running a bookstore, and even if we allow customers to borrow books, we want to be able to sell them. A sale is a very important element that we need to track down as customers may want to review them, or you may just need to provide this information for taxation purposes. As opposed to borrowing, in which knowing the book, customer, and date was more than enough, here, we need to set IDs to the sales in order to identify them to the customers.</p><p class="calibre8">However, this table is more difficult to design than the other ones and not just because of the ID. Think about it: do customers buy books one by one? Or do they rather buy any number of books at once? Thus, we need to allow the table to contain an undefined amount of books. With PHP, this is easy as we would just use an array, but we do not have arrays in MySQL. There are two options to this problem.</p><p class="calibre8">One solution could be to set the ID of the sale as a normal integer field and not as a primary key. In this way, we would be able to insert several rows to the <code class="email">sales</code> table, one for each borrowed book. However, this solution is less than ideal as we miss the opportunity of defining a very good primary key because it has the <code class="email">sales</code> ID. Also, we are duplicating the data about the customer and date since they will always be the same.</p><p class="calibre8">The second solution, the one that we will implement, is the creation of a separated table that acts as a "list". We will still have our <code class="email">sales</code> table, which will contain the ID of the sale as a primary key, the customer ID as a foreign key, and the dates. However, we will create a second table that we could name <code class="email">sale_book</code>, and we will define there the ID of the sale, the ID of the book, and the amount of books of the same copy that the customer bought. In this way, we will have at once the information about the customer and date, and we will be able to insert as many rows as needed in our <code class="email">sale_book</code> list-table without duplicating any data. Let's take a look at how we would create these:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; CREATE TABLE sale(</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; id INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; customer_id INT UNSIGNED NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; date DATETIME NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; FOREIGN KEY (customer_id) REFERENCES customer(id)</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ) ENGINE=InnoDb;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 0 rows affected (0.00 sec)</strong></span>

<span class="strong"><strong class="calibre2">mysql&gt; CREATE TABLE sale_book(</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; sale_id INT UNSIGNED NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; book_id INT UNSIGNED NOT NULL,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; amount SMALLINT UNSIGNED NOT NULL DEFAULT 1,</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; FOREIGN KEY (sale_id) REFERENCES sale(id),</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; FOREIGN KEY (book_id) REFERENCES book(id)</strong></span>
<span class="strong"><strong class="calibre2">    -&gt; ) ENGINE=InnoDb;</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 0 rows affected (0.00 sec)</strong></span>
</pre></div><p class="calibre8">Keep in mind that you should always create the <code class="email">sales</code> table first because if you create the <code class="email">sale_book</code> table with a foreign key first, referencing a table that does not exist yet, MySQL will complain.</p><p class="calibre8">We created three new <a id="id413" class="calibre1"/>tables in this section, and they are interrelated. It is a good time <a id="id414" class="calibre1"/>to update the diagram of tables. Note that we link the fields with the tables when there is a foreign key defined. Take a look:</p><div class="mediaobject"><img src="../images/00026.jpeg" alt="Foreign keys" class="calibre9"/></div><p class="calibre10"> </p></div></div>

<div class="book" title="Keys and constraints">
<div class="book" title="Unique keys"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec77" class="calibre1"/>Unique keys</h2></div></div></div><p class="calibre8">As you know, primary keys<a id="id415" class="calibre1"/> are extremely useful as they provide several features with <a id="id416" class="calibre1"/>them. One of these is that the field has to be unique. However, you can define only one primary key per table, even though you might have several fields that are unique. In order to amend this limitation, MySQL incorporates <span class="strong"><strong class="calibre2">unique keys</strong></span>. Their job is to make sure that the field is not repeated in multiple rows, but they do not come with the rest of the functionalities of primary keys, such as being autoincremental. Also, unique keys can be null.</p><p class="calibre8">Our <code class="email">book</code> and <code class="email">customer</code> tables contain good candidates for unique keys. Books can potentially have the same title, and surely, there will be more than one book by the same author. However, they also have an ISBN which is unique; two different books should not have the same ISBN. In the same way, even if two customers were to have the same name, their e-mail addresses will be always different. Let's add the two keys with the <code class="email">ALTER TABLE</code> command, though you can also add them when creating the table as we did with foreign keys, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mysql&gt; ALTER TABLE book ADD UNIQUE KEY (isbn);</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 0 rows affected (0.01 sec)</strong></span>
<span class="strong"><strong class="calibre2">Records: 0  Duplicates: 0  Warnings: 0</strong></span>

<span class="strong"><strong class="calibre2">mysql&gt; ALTER TABLE customer ADD UNIQUE KEY (email);</strong></span>
<span class="strong"><strong class="calibre2">Query OK, 0 rows affected (0.01 sec)</strong></span>
<span class="strong"><strong class="calibre2">Records: 0  Duplicates: 0  Warnings: 0</strong></span>
</pre></div></div></div></body></html>