<html><head></head><body>
<div id="_idContainer042">
<h1 class="chapter-number" id="_idParaDest-188"><a id="_idTextAnchor217"/><span class="koboSpan" id="kobo.1.1">6</span></h1>
<h1 id="_idParaDest-189"><a id="_idTextAnchor218"/><span class="koboSpan" id="kobo.2.1">Accessing and Working with Entities</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, we will go through the </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">create, read, update, and delete</span></strong><span class="koboSpan" id="kobo.5.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.6.1">CRUD</span></strong><span class="koboSpan" id="kobo.7.1">) operations of working with entities in Drupal. </span><span class="koboSpan" id="kobo.7.2">We will create a series of routes to create, read, update, and delete nodes that </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">are articles.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">In this chapter, we will cover </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.11.1">Creating and saving </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">an entity</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Querying and </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">loading entities</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Checking </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">entity access</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">Updating an entity’s </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">field values</span></span></li>
<li><span class="koboSpan" id="kobo.19.1">Performing </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">entity validation</span></span></li>
<li><span class="koboSpan" id="kobo.21.1">Deleting </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">an entity</span></span></li>
</ul>
<h1 id="_idParaDest-190"><a id="_idTextAnchor219"/><span class="koboSpan" id="kobo.23.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.24.1">This chapter will require a custom module that has a </span><strong class="source-inline"><span class="koboSpan" id="kobo.25.1">routing.yml</span></strong><span class="koboSpan" id="kobo.26.1"> file and a controller named </span><strong class="source-inline"><span class="koboSpan" id="kobo.27.1">ArticleController</span></strong><span class="koboSpan" id="kobo.28.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.29.1">src/Controller</span></strong><span class="koboSpan" id="kobo.30.1"> directory of the module. </span><span class="koboSpan" id="kobo.30.2">In the following recipes, the module name is </span><strong class="source-inline"><span class="koboSpan" id="kobo.31.1">mymodule</span></strong><span class="koboSpan" id="kobo.32.1">. </span><span class="koboSpan" id="kobo.32.2">Replace as appropriate. </span><span class="koboSpan" id="kobo.32.3">You can find the full code used in this chapter on </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">GitHub: </span></span><a href="https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp06"><span class="No-Break"><span class="koboSpan" id="kobo.34.1">https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp06</span></span></a></p>
<p><span class="koboSpan" id="kobo.35.1">We are using the </span><strong class="bold"><span class="koboSpan" id="kobo.36.1">Article content</span></strong><span class="koboSpan" id="kobo.37.1"> type created by the standard </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">Drupal installation.</span></span></p>
<p><span class="koboSpan" id="kobo.39.1">The recipes in this chapter have example HTTP requests that are used to interact with code created in each recipe. </span><span class="koboSpan" id="kobo.39.2">These HTTP requests can be run with any HTTP client. </span><span class="koboSpan" id="kobo.39.3">If you use VSCode, try the </span><strong class="bold"><span class="koboSpan" id="kobo.40.1">REST Client</span></strong><span class="koboSpan" id="kobo.41.1"> extension (</span><a href="https://marketplace.visualstudio.com/items?itemName=humao.rest-client"><span class="koboSpan" id="kobo.42.1">https://marketplace.visualstudio.com/items?itemName=humao.rest-client</span></a><span class="koboSpan" id="kobo.43.1">), or if you have PhpStorm, use the built-in </span><strong class="bold"><span class="koboSpan" id="kobo.44.1">HTTP Client</span></strong><span class="koboSpan" id="kobo.45.1"> (</span><a href="https://www.jetbrains.com/help/idea/http-client-in-product-code-editor.html"><span class="koboSpan" id="kobo.46.1">https://www.jetbrains.com/help/idea/http-client-in-product-code-editor.html</span></a><span class="koboSpan" id="kobo.47.1">). </span><span class="koboSpan" id="kobo.47.2">If for some reason you do not have an editor or cannot get those working, you can use </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">Postman (</span></span><a href="https://www.postman.com/"><span class="No-Break"><span class="koboSpan" id="kobo.49.1">https://www.postman.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.50.1">).</span></span></p>
<h1 id="_idParaDest-191"><a id="_idTextAnchor220"/><span class="koboSpan" id="kobo.51.1">Creating and saving an entity</span></h1>
<p><span class="koboSpan" id="kobo.52.1">In this recipe, we </span><a id="_idIndexMarker321"/><span class="koboSpan" id="kobo.53.1">will </span><a id="_idIndexMarker322"/><span class="koboSpan" id="kobo.54.1">define a route to create a new article. </span><span class="koboSpan" id="kobo.54.2">The route will be for an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.55.1">POST</span></strong><span class="koboSpan" id="kobo.56.1"> request sending JSON to specify the article’s title and </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1">body text.</span></span></p>
<h2 id="_idParaDest-192"><a id="_idTextAnchor221"/><span class="koboSpan" id="kobo.58.1">How to do it…</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.59.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.60.1">store</span></strong><span class="koboSpan" id="kobo.61.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.62.1">ArticleController</span></strong><span class="koboSpan" id="kobo.63.1"> controller in your module that will receive the incoming </span><span class="No-Break"><span class="koboSpan" id="kobo.64.1">request object:</span></span><pre class="console"><span class="koboSpan" id="kobo.65.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.66.1">
namespace Drupal\mymodule\Controller;</span></pre><pre class="console"><span class="koboSpan" id="kobo.67.1">
use Drupal\Core\Controller\ControllerBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.68.1">
use Symfony\Component\HttpFoundation\JsonResponse;</span></pre><pre class="console"><span class="koboSpan" id="kobo.69.1">
use Symfony\Component\HttpFoundation\Request;</span></pre><pre class="console"><span class="koboSpan" id="kobo.70.1">
class ArticleController extends ControllerBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.71.1">
  public function store(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.72.1">
      JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.73.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.74.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.75.1">We need the request object so that we can retrieve the JSON provided in the </span><span class="No-Break"><span class="koboSpan" id="kobo.76.1">request payload.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.77.1">Next, we will convert the request’s content from JSON to a PHP array using Drupal’s JSON serialization </span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">utility class:</span></span><pre class="console"><span class="koboSpan" id="kobo.79.1">
  public function store(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.80.1">
   JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.81.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.82.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.83.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.84.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.85.1">While we could use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.86.1">json_decode</span></strong><span class="koboSpan" id="kobo.87.1"> function directly, leveraging utility classes provided by Drupal standardizes the way </span><span class="No-Break"><span class="koboSpan" id="kobo.88.1">code works.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.89.1">Then, we </span><a id="_idIndexMarker323"/><span class="koboSpan" id="kobo.90.1">get</span><a id="_idIndexMarker324"/><span class="koboSpan" id="kobo.91.1"> the entity type manager and retrieve the entity storage for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.92.1">node</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.93.1">entity type:</span></span><pre class="console"><span class="koboSpan" id="kobo.94.1">
  public function store(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.95.1">
   JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.96.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.97.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.98.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.99.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.100.1">
   $node_storage = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.101.1">
      getStorage('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.102.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.103.1">The entity type manager is a repository of information for entity types and is used to get handlers for entity types, such as the storage handler. </span><span class="koboSpan" id="kobo.103.2">When getting an entity storage handler, you pass the entity </span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">type ID.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.105.1">From the storage, invoke the </span><strong class="source-inline"><span class="koboSpan" id="kobo.106.1">create</span></strong><span class="koboSpan" id="kobo.107.1"> method to create a new node </span><span class="No-Break"><span class="koboSpan" id="kobo.108.1">entity object:</span></span><pre class="console"><span class="koboSpan" id="kobo.109.1">
  public function store(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.110.1">
   JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.111.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.112.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.113.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.114.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.115.1">
   $node_storage = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.116.1">
      getStorage('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.117.1">
   $article = $node_storage-&gt;create([</span></pre><pre class="console"><span class="koboSpan" id="kobo.118.1">
    'type' =&gt; 'article',</span></pre><pre class="console"><span class="koboSpan" id="kobo.119.1">
   ]);</span></pre><pre class="console"><span class="koboSpan" id="kobo.120.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.121.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.122.1">create</span></strong><span class="koboSpan" id="kobo.123.1"> method </span><a id="_idIndexMarker325"/><span class="koboSpan" id="kobo.124.1">instantiates </span><a id="_idIndexMarker326"/><span class="koboSpan" id="kobo.125.1">a new entity object with the entity type class. </span><span class="koboSpan" id="kobo.125.2">For the node entity type, our </span><strong class="source-inline"><span class="koboSpan" id="kobo.126.1">$article</span></strong><span class="koboSpan" id="kobo.127.1"> variable will be of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.128.1">\Drupal\node\Node</span></strong><span class="koboSpan" id="kobo.129.1"> type. </span><span class="koboSpan" id="kobo.129.2">When instantiating a new entity, you must specify its bundle, which we do with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.130.1">type</span></strong><span class="koboSpan" id="kobo.131.1"> key set </span><span class="No-Break"><span class="koboSpan" id="kobo.132.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">article</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.134.1">.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.135.1">Provide an associative array of </span><strong class="source-inline"><span class="koboSpan" id="kobo.136.1">title</span></strong><span class="koboSpan" id="kobo.137.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.138.1">body</span></strong><span class="koboSpan" id="kobo.139.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.140.1">create</span></strong><span class="koboSpan" id="kobo.141.1"> method, copying values from the JSON we received from </span><span class="No-Break"><span class="koboSpan" id="kobo.142.1">the request:</span></span><pre class="console"><span class="koboSpan" id="kobo.143.1">
  public function store(Request $request): JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.144.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.145.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.146.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.147.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.148.1">
   $node_storage = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.149.1">
      getStorage('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.150.1">
   $article = $node_storage-&gt;create([</span></pre><pre class="console"><span class="koboSpan" id="kobo.151.1">
    'type' =&gt; 'article',</span></pre><pre class="console"><span class="koboSpan" id="kobo.152.1">
    'title' =&gt; $json['title'],</span></pre><pre class="console"><span class="koboSpan" id="kobo.153.1">
    'body' =&gt; $json['body'],</span></pre><pre class="console"><span class="koboSpan" id="kobo.154.1">
   ]);</span></pre><pre class="console"><span class="koboSpan" id="kobo.155.1">
  }</span></pre></li>
<li><span class="koboSpan" id="kobo.156.1">Invoke the </span><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">save</span></strong><span class="koboSpan" id="kobo.158.1"> method</span><a id="_idIndexMarker327"/><span class="koboSpan" id="kobo.159.1"> on</span><a id="_idIndexMarker328"/><span class="koboSpan" id="kobo.160.1"> the entity object to save </span><span class="No-Break"><span class="koboSpan" id="kobo.161.1">the entity:</span></span><pre class="console"><span class="koboSpan" id="kobo.162.1">
  public function store(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.163.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.164.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.165.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.166.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.167.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.168.1">
   $node_storage = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.169.1">
      getStorage('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.170.1">
   $article = $node_storage-&gt;create([</span></pre><pre class="console"><span class="koboSpan" id="kobo.171.1">
    'type' =&gt; 'article',</span></pre><pre class="console"><span class="koboSpan" id="kobo.172.1">
    'title' =&gt; $json['title'],</span></pre><pre class="console"><span class="koboSpan" id="kobo.173.1">
    'body' =&gt; $json['body'],</span></pre><pre class="console"><span class="koboSpan" id="kobo.174.1">
   ]);</span></pre><pre class="console"><span class="koboSpan" id="kobo.175.1">
   $article-&gt;save();</span></pre><pre class="console"><span class="koboSpan" id="kobo.176.1">
  }</span></pre></li>
<li><span class="koboSpan" id="kobo.177.1">We will now return a response with a Location header that has the URL to the newly</span><a id="_idIndexMarker329"/><span class="koboSpan" id="kobo.178.1"> created </span><a id="_idIndexMarker330"/><span class="koboSpan" id="kobo.179.1">now and an HTTP status code of </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">201 Created</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.181.1">:</span></span><pre class="console"><span class="koboSpan" id="kobo.182.1">
  public function store(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.183.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.184.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.185.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.186.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.187.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.188.1">
   $node_storage = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.189.1">
      getStorage('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.190.1">
   $article = $node_storage-&gt;create([</span></pre><pre class="console"><span class="koboSpan" id="kobo.191.1">
    'type' =&gt; 'article',</span></pre><pre class="console"><span class="koboSpan" id="kobo.192.1">
    'title' =&gt; $json['title'],</span></pre><pre class="console"><span class="koboSpan" id="kobo.193.1">
    'body' =&gt; $json['body'],</span></pre><pre class="console"><span class="koboSpan" id="kobo.194.1">
   ]);</span></pre><pre class="console"><span class="koboSpan" id="kobo.195.1">
   $article-&gt;save();</span></pre><pre class="console"><span class="koboSpan" id="kobo.196.1">
   $article_url = $article-&gt;toUrl()-&gt;setAbsolute()-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.197.1">
      toString();</span></pre><pre class="console"><span class="koboSpan" id="kobo.198.1">
   return new JsonResponse(</span></pre><pre class="console"><span class="koboSpan" id="kobo.199.1">
    $article-&gt;toArray(),</span></pre><pre class="console"><span class="koboSpan" id="kobo.200.1">
    201,</span></pre><pre class="console"><span class="koboSpan" id="kobo.201.1">
    ['Location' =&gt; $article_url],</span></pre><pre class="console"><span class="koboSpan" id="kobo.202.1">
   );</span></pre><pre class="console"><span class="koboSpan" id="kobo.203.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.204.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.205.1">201 Created</span></strong><span class="koboSpan" id="kobo.206.1"> status code is used to represent a successful response and signifies that an item has been created. </span><span class="koboSpan" id="kobo.206.2">When a </span><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">201 Created</span></strong><span class="koboSpan" id="kobo.208.1"> response is returned, it is recommended to return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.209.1">Location</span></strong><span class="koboSpan" id="kobo.210.1"> header with a URL to the created item. </span><span class="koboSpan" id="kobo.210.2">Entity classes have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.211.1">toUrl</span></strong><span class="koboSpan" id="kobo.212.1"> method to return a URL object, and then call its </span><strong class="source-inline"><span class="koboSpan" id="kobo.213.1">toString</span></strong><span class="koboSpan" id="kobo.214.1"> method to convert it to a string from </span><span class="No-Break"><span class="koboSpan" id="kobo.215.1">an object.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.216.1">We must create the</span><a id="_idIndexMarker331"/><span class="koboSpan" id="kobo.217.1"> route</span><a id="_idIndexMarker332"/><span class="koboSpan" id="kobo.218.1"> in our module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.219.1">routing.yml</span></strong><span class="koboSpan" id="kobo.220.1"> that points to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">store</span></strong><span class="koboSpan" id="kobo.222.1"> method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.223.1">ArticleController</span></strong><span class="koboSpan" id="kobo.224.1"> for an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">POST</span></strong><span class="koboSpan" id="kobo.226.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.227.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.228.1">articles</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.229.1"> path:</span></span><pre class="console"><span class="koboSpan" id="kobo.230.1">
mymodule.create_article:</span></pre><pre class="console"><span class="koboSpan" id="kobo.231.1">
  path: /articles</span></pre><pre class="console"><span class="koboSpan" id="kobo.232.1">
  defaults:</span></pre><pre class="console"><span class="koboSpan" id="kobo.233.1">
   _controller: Drupal\mymodule\Controller\</span></pre><pre class="console"><span class="koboSpan" id="kobo.234.1">
      ArticleController::store</span></pre><pre class="console"><span class="koboSpan" id="kobo.235.1">
  methods: [POST]</span></pre><pre class="console"><span class="koboSpan" id="kobo.236.1">
  requirements:</span></pre><pre class="console"><span class="koboSpan" id="kobo.237.1">
   _access: 'TRUE'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.238.1">Routes may specify the HTTP methods they support with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.239.1">methods</span></strong><span class="koboSpan" id="kobo.240.1"> key. </span><span class="koboSpan" id="kobo.240.2">In this recipe, we have set </span><strong class="source-inline"><span class="koboSpan" id="kobo.241.1">requirements</span></strong><span class="koboSpan" id="kobo.242.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">_access: 'TRUE'</span></strong><span class="koboSpan" id="kobo.244.1"> only to bypass access checks. </span><span class="koboSpan" id="kobo.244.2">This should be set to </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">_entity_create_access: 'node'</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.246.1">.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.247.1">Rebuild your Drupal site’s cache to make it aware of the </span><span class="No-Break"><span class="koboSpan" id="kobo.248.1">new route:</span></span><pre class="console"><span class="koboSpan" id="kobo.249.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.250.1">An HTTP request such as the following can then be used to create a new node that is an article on your </span><span class="No-Break"><span class="koboSpan" id="kobo.251.1">Drupal site:</span></span><pre class="console"><span class="koboSpan" id="kobo.252.1">
POST http://localhost/articles</span></pre><pre class="console"><span class="koboSpan" id="kobo.253.1">
Content-Type: application/json</span></pre><pre class="console"><span class="koboSpan" id="kobo.254.1">
Accept: application/json</span></pre><pre class="console"><span class="koboSpan" id="kobo.255.1">
{</span></pre><pre class="console"><span class="koboSpan" id="kobo.256.1">
  "title": "New article",</span></pre><pre class="console"><span class="koboSpan" id="kobo.257.1">
  "body": "Test body"</span></pre><pre class="console"><span class="koboSpan" id="kobo.258.1">
}</span></pre></li>
</ol>
<h2 id="_idParaDest-193"><a id="_idTextAnchor222"/><span class="koboSpan" id="kobo.259.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.260.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">create</span></strong><span class="koboSpan" id="kobo.262.1"> method is </span><a id="_idIndexMarker333"/><span class="koboSpan" id="kobo.263.1">used </span><a id="_idIndexMarker334"/><span class="koboSpan" id="kobo.264.1">to instantiate a new entity object and returns an object of that entity type’s class. </span><span class="koboSpan" id="kobo.264.2">For this recipe, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">node</span></strong><span class="koboSpan" id="kobo.266.1"> storage will return entities with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">\Drupal\node\Node</span></strong><span class="koboSpan" id="kobo.268.1"> class. </span><span class="koboSpan" id="kobo.268.2">The values accepted in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">create</span></strong><span class="koboSpan" id="kobo.270.1"> method are based on that entity type’s field definitions. </span><span class="koboSpan" id="kobo.270.2">These include the base fields and any fields created through the </span><span class="No-Break"><span class="koboSpan" id="kobo.271.1">user interface.</span></span></p>
<p><span class="koboSpan" id="kobo.272.1">The bundle for an entity type must be specified when it is created. </span><span class="koboSpan" id="kobo.272.2">This is used to determine the fields available since each bundle can have different fields. </span><span class="koboSpan" id="kobo.272.3">For nodes, the bundle field is named </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">type</span></strong><span class="koboSpan" id="kobo.274.1">. </span><span class="koboSpan" id="kobo.274.2">That is why we provide the </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">article</span></strong><span class="koboSpan" id="kobo.276.1"> value for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">type</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.278.1"> key.</span></span></p>
<p><span class="koboSpan" id="kobo.279.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.280.1">save</span></strong><span class="koboSpan" id="kobo.281.1"> method then commits the entity to the </span><span class="No-Break"><span class="koboSpan" id="kobo.282.1">database storage.</span></span></p>
<p><span class="koboSpan" id="kobo.283.1">When an entity is inserted on its first save, the entity storage fires invoke the following hooks, allowing you to hook into the insert of a new entity. </span><span class="koboSpan" id="kobo.283.2">The entity being inserted is passed as </span><span class="No-Break"><span class="koboSpan" id="kobo.284.1">an argument:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">hook_ENTITY_TYPE_presave</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">hook_entity_presave</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.287.1">hook_ENTITY_TYPE_insert</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">hook_entity_insert</span></strong></span></li>
</ul>
<h1 id="_idParaDest-194"><a id="_idTextAnchor223"/><span class="koboSpan" id="kobo.289.1">Querying and loading entities</span></h1>
<p><span class="koboSpan" id="kobo.290.1">In this recipe, we </span><a id="_idIndexMarker335"/><span class="koboSpan" id="kobo.291.1">will use </span><a id="_idIndexMarker336"/><span class="koboSpan" id="kobo.292.1">an entity query to find all published articles and return them as JSON. </span><span class="koboSpan" id="kobo.292.2">We will also allow specifying the sort order via a </span><span class="No-Break"><span class="koboSpan" id="kobo.293.1">query parameter.</span></span></p>
<h2 id="_idParaDest-195"><a id="_idTextAnchor224"/><span class="koboSpan" id="kobo.294.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.295.1">Create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">index</span></strong><span class="koboSpan" id="kobo.297.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.298.1">ArticleController</span></strong><span class="koboSpan" id="kobo.299.1"> controller in your module that will receive the incoming </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.300.1">Request</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.301.1"> object:</span></span><pre class="console"><span class="koboSpan" id="kobo.302.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.303.1">
namespace Drupal\mymodule\Controller;</span></pre><pre class="console"><span class="koboSpan" id="kobo.304.1">
use Drupal\Core\Controller\ControllerBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.305.1">
use Symfony\Component\HttpFoundation\JsonResponse;</span></pre><pre class="console"><span class="koboSpan" id="kobo.306.1">
use Symfony\Component\HttpFoundation\Request;</span></pre><pre class="console"><span class="koboSpan" id="kobo.307.1">
class ArticleController extends ControllerBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.308.1">
  public function index(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.309.1">
   JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.310.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.311.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.312.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">request</span></strong><span class="koboSpan" id="kobo.314.1"> object will be used to retrieve query parameters passed in </span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">the URL.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.316.1">From the request, get the sort query parameter, defaulting </span><span class="No-Break"><span class="koboSpan" id="kobo.317.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.318.1">DESC</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.319.1">:</span></span><pre class="console"><span class="koboSpan" id="kobo.320.1">
  public function index(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.321.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.322.1">
   $sort = $request-&gt;query-&gt;get('sort', 'DESC');</span></pre><pre class="console"><span class="koboSpan" id="kobo.323.1">
  }</span></pre></li>
<li><span class="koboSpan" id="kobo.324.1">Then, we get the entity type manager and retrieve the entity storage for the node </span><span class="No-Break"><span class="koboSpan" id="kobo.325.1">entity type:</span></span><pre class="console"><span class="koboSpan" id="kobo.326.1">
  public function index(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.327.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.328.1">
   $sort = $request-&gt;query-&gt;get('sort', 'DESC');</span></pre><pre class="console"><span class="koboSpan" id="kobo.329.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.330.1">
   $node_storage = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.331.1">
      getStorage('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.332.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.333.1">The entity</span><a id="_idIndexMarker337"/><span class="koboSpan" id="kobo.334.1"> type </span><a id="_idIndexMarker338"/><span class="koboSpan" id="kobo.335.1">manager is a repository of information for entity types and is used to get handlers for entity types, such as the storage handler. </span><span class="koboSpan" id="kobo.335.2">When getting an entity storage handler, you pass the entity </span><span class="No-Break"><span class="koboSpan" id="kobo.336.1">type ID.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.337.1">From the storage handler, invoke the </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">getQuery</span></strong><span class="koboSpan" id="kobo.339.1"> method. </span><span class="koboSpan" id="kobo.339.2">This returns a query object that is used to perform an </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">entity query:</span></span><pre class="console"><span class="koboSpan" id="kobo.341.1">
  public function index(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.342.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.343.1">
   $sort = $request-&gt;query-&gt;get('sort', 'DESC');</span></pre><pre class="console"><span class="koboSpan" id="kobo.344.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.345.1">
    $node_storage = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.346.1">
        getStorage('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.347.1">
   $query = $node_storage-&gt;getQuery()</span></pre><pre class="console"><span class="koboSpan" id="kobo.348.1">
    -&gt;accessCheck(TRUE);</span></pre><pre class="console"><span class="koboSpan" id="kobo.349.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.350.1">Drupal requires specifying if the entity query should perform entity access checks when querying for content entities. </span><span class="koboSpan" id="kobo.350.2">We must call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">accessCheck</span></strong><span class="koboSpan" id="kobo.352.1"> method and set it to </span><strong class="source-inline"><span class="koboSpan" id="kobo.353.1">TRUE</span></strong><span class="koboSpan" id="kobo.354.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">FALSE</span></strong><span class="koboSpan" id="kobo.356.1">. </span><span class="koboSpan" id="kobo.356.2">In this case, we want entity access checks to be applied to the </span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">entity query.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.358.1">We will add conditions </span><a id="_idIndexMarker339"/><span class="koboSpan" id="kobo.359.1">to </span><a id="_idIndexMarker340"/><span class="koboSpan" id="kobo.360.1">the query to make sure we only return </span><span class="No-Break"><span class="koboSpan" id="kobo.361.1">published articles:</span></span><pre class="console"><span class="koboSpan" id="kobo.362.1">
  public function index(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.363.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.364.1">
   $sort = $request-&gt;query-&gt;get('sort', 'DESC');</span></pre><pre class="console"><span class="koboSpan" id="kobo.365.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.366.1">
   $node_storage = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.367.1">
      getStorage('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.368.1">
   $query = $node_storage-&gt;getQuery();</span></pre><pre class="console"><span class="koboSpan" id="kobo.369.1">
    -&gt;accessCheck(TRUE);</span></pre><pre class="console"><span class="koboSpan" id="kobo.370.1">
   $query-&gt;condition('type', 'article');</span></pre><pre class="console"><span class="koboSpan" id="kobo.371.1">
   $query-&gt;condition('status', TRUE);</span></pre><pre class="console"><span class="koboSpan" id="kobo.372.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.373.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">condition</span></strong><span class="koboSpan" id="kobo.375.1"> method is passed the field name and value to create a condition. </span><span class="koboSpan" id="kobo.375.2">The first condition ensures we only query for nodes with the type (bundle) of </span><strong class="source-inline"><span class="koboSpan" id="kobo.376.1">article</span></strong><span class="koboSpan" id="kobo.377.1">. </span><span class="koboSpan" id="kobo.377.2">The second condition is to ensure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.378.1">status</span></strong><span class="koboSpan" id="kobo.379.1"> field is </span><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">true</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.381.1">for published.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.382.1">Then, we specify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">sort</span></strong><span class="koboSpan" id="kobo.384.1"> order of the query from our URL </span><span class="No-Break"><span class="koboSpan" id="kobo.385.1">query parameter:</span></span><pre class="console"><span class="koboSpan" id="kobo.386.1">
  public function index(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.387.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.388.1">
   $sort = $request-&gt;query-&gt;get('sort', 'DESC');</span></pre><pre class="console"><span class="koboSpan" id="kobo.389.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.390.1">
   $node_storage = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.391.1">
      getStorage('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.392.1">
   $query = $node_storage-&gt;getQuery();</span></pre><pre class="console"><span class="koboSpan" id="kobo.393.1">
    -&gt;accessCheck(TRUE);</span></pre><pre class="console"><span class="koboSpan" id="kobo.394.1">
   $query-&gt;condition('type', 'article');</span></pre><pre class="console"><span class="koboSpan" id="kobo.395.1">
   $query-&gt;condition('status', TRUE);</span></pre><pre class="console"><span class="koboSpan" id="kobo.396.1">
   $query-&gt;sort('created', $sort);</span></pre><pre class="console"><span class="koboSpan" id="kobo.397.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.398.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.399.1">sort</span></strong><span class="koboSpan" id="kobo.400.1"> method is passed </span><a id="_idIndexMarker341"/><span class="koboSpan" id="kobo.401.1">the</span><a id="_idIndexMarker342"/><span class="koboSpan" id="kobo.402.1"> field name to order the query by and a direction of </span><strong class="source-inline"><span class="koboSpan" id="kobo.403.1">ASC</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.404.1">or </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.405.1">DESC</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.407.1">Calling the </span><strong class="source-inline"><span class="koboSpan" id="kobo.408.1">execute</span></strong><span class="koboSpan" id="kobo.409.1"> method will execute the entity query and return the available </span><span class="No-Break"><span class="koboSpan" id="kobo.410.1">entity IDs:</span></span><pre class="console"><span class="koboSpan" id="kobo.411.1">
  public function index(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.412.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.413.1">
   $sort = $request-&gt;query-&gt;get('sort', 'DESC');</span></pre><pre class="console"><span class="koboSpan" id="kobo.414.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.415.1">
   $node_storage = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.416.1">
      getStorage('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.417.1">
   $query = $node_storage-&gt;getQuery()</span></pre><pre class="console"><span class="koboSpan" id="kobo.418.1">
    -&gt;accessCheck(TRUE);</span></pre><pre class="console"><span class="koboSpan" id="kobo.419.1">
   $query-&gt;condition('type', 'article');</span></pre><pre class="console"><span class="koboSpan" id="kobo.420.1">
   $query-&gt;condition('status', TRUE);</span></pre><pre class="console"><span class="koboSpan" id="kobo.421.1">
   $query-&gt;sort('created', $sort);</span></pre><pre class="console"><span class="koboSpan" id="kobo.422.1">
   $node_ids = $query-&gt;execute();</span></pre><pre class="console"><span class="koboSpan" id="kobo.423.1">
  }</span></pre></li>
<li><span class="koboSpan" id="kobo.424.1">After calling </span><strong class="source-inline"><span class="koboSpan" id="kobo.425.1">execute</span></strong><span class="koboSpan" id="kobo.426.1">, we have an array of node IDs that can be passed to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">loadMultiple</span></strong><span class="koboSpan" id="kobo.428.1"> method from </span><a id="_idIndexMarker343"/><span class="koboSpan" id="kobo.429.1">the </span><a id="_idIndexMarker344"/><span class="koboSpan" id="kobo.430.1">entity storage to load </span><span class="No-Break"><span class="koboSpan" id="kobo.431.1">the nodes:</span></span><pre class="console"><span class="koboSpan" id="kobo.432.1">
  public function index(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.433.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.434.1">
   $sort = $request-&gt;query-&gt;get('sort', 'DESC');</span></pre><pre class="console"><span class="koboSpan" id="kobo.435.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.436.1">
   $node_storage = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.437.1">
      getStorage('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.438.1">
   $query = $node_storage-&gt;getQuery()</span></pre><pre class="console"><span class="koboSpan" id="kobo.439.1">
    -&gt;accessCheck(TRUE);</span></pre><pre class="console"><span class="koboSpan" id="kobo.440.1">
   $query-&gt;condition('type', 'article');</span></pre><pre class="console"><span class="koboSpan" id="kobo.441.1">
   $query-&gt;condition('status', TRUE);</span></pre><pre class="console"><span class="koboSpan" id="kobo.442.1">
   $query-&gt;sort('created', $sort);</span></pre><pre class="console"><span class="koboSpan" id="kobo.443.1">
   $node_ids = $query-&gt;execute();</span></pre><pre class="console"><span class="koboSpan" id="kobo.444.1">
   $nodes = $node_storage-&gt;loadMultiple($node_ids);</span></pre><pre class="console"><span class="koboSpan" id="kobo.445.1">
  }</span></pre></li>
<li><span class="koboSpan" id="kobo.446.1">We can now use </span><strong class="source-inline"><span class="koboSpan" id="kobo.447.1">array_map</span></strong><span class="koboSpan" id="kobo.448.1"> to turn</span><a id="_idIndexMarker345"/><span class="koboSpan" id="kobo.449.1"> the </span><a id="_idIndexMarker346"/><span class="koboSpan" id="kobo.450.1">nodes into array values and return a JSON response </span><span class="No-Break"><span class="koboSpan" id="kobo.451.1">of articles:</span></span><pre class="console"><span class="koboSpan" id="kobo.452.1">
  public function index(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.453.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.454.1">
   $sort = $request-&gt;query-&gt;get('sort', 'DESC');</span></pre><pre class="console"><span class="koboSpan" id="kobo.455.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.456.1">
   $node_storage = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.457.1">
      getStorage('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.458.1">
   $query = $node_storage-&gt;getQuery()</span></pre><pre class="console"><span class="koboSpan" id="kobo.459.1">
    -&gt;accessCheck(TRUE);</span></pre><pre class="console"><span class="koboSpan" id="kobo.460.1">
   $query-&gt;condition('type', 'article');</span></pre><pre class="console"><span class="koboSpan" id="kobo.461.1">
   $query-&gt;condition('status', TRUE);</span></pre><pre class="console"><span class="koboSpan" id="kobo.462.1">
   $query-&gt;sort('created', $sort);</span></pre><pre class="console"><span class="koboSpan" id="kobo.463.1">
   $node_ids = $query-&gt;execute();</span></pre><pre class="console"><span class="koboSpan" id="kobo.464.1">
   $nodes = $node_storage-&gt;loadMultiple($node_ids);</span></pre><pre class="console"><span class="koboSpan" id="kobo.465.1">
   $nodes = array_map(function (\Drupal\node\</span></pre><pre class="console"><span class="koboSpan" id="kobo.466.1">
      NodeInterface $node) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.467.1">
    return $node-&gt;toArray();</span></pre><pre class="console"><span class="koboSpan" id="kobo.468.1">
   }, $nodes);</span></pre><pre class="console"><span class="koboSpan" id="kobo.469.1">
   return new JsonResponse($nodes);</span></pre><pre class="console"><span class="koboSpan" id="kobo.470.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.471.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.472.1">array_map</span></strong><span class="koboSpan" id="kobo.473.1"> function allows you to transform the values of items in an existing array. </span><span class="koboSpan" id="kobo.473.2">We will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.474.1">array_map</span></strong><span class="koboSpan" id="kobo.475.1"> to iterate over the returned node entities and call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.476.1">toArray</span></strong><span class="koboSpan" id="kobo.477.1"> method to get their values as </span><span class="No-Break"><span class="koboSpan" id="kobo.478.1">an array.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.479.1">We must create the route in </span><strong class="source-inline"><span class="koboSpan" id="kobo.480.1">routing.yml</span></strong><span class="koboSpan" id="kobo.481.1"> that points to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.482.1">index</span></strong><span class="koboSpan" id="kobo.483.1"> method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.484.1">ArticleController</span></strong><span class="koboSpan" id="kobo.485.1"> for an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">GET</span></strong><span class="koboSpan" id="kobo.487.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.488.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.489.1">articles</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.490.1"> path:</span></span><pre class="console"><span class="koboSpan" id="kobo.491.1">
mymodule.get_articles:</span></pre><pre class="console"><span class="koboSpan" id="kobo.492.1">
  path: /articles</span></pre><pre class="console"><span class="koboSpan" id="kobo.493.1">
  defaults:</span></pre><pre class="console"><span class="koboSpan" id="kobo.494.1">
   _controller: Drupal\mymodule\Controller\</span></pre><pre class="console"><span class="koboSpan" id="kobo.495.1">
      ArticleController::index</span></pre><pre class="console"><span class="koboSpan" id="kobo.496.1">
  methods: [GET]</span></pre><pre class="console"><span class="koboSpan" id="kobo.497.1">
  requirements:</span></pre><pre class="console"><span class="koboSpan" id="kobo.498.1">
   _permission: 'access content'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.499.1">Routes may share the </span><a id="_idIndexMarker347"/><span class="koboSpan" id="kobo.500.1">same </span><a id="_idIndexMarker348"/><span class="koboSpan" id="kobo.501.1">path if they explicitly define the HTTP methods </span><span class="No-Break"><span class="koboSpan" id="kobo.502.1">they support.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.503.1">Rebuild your Drupal site’s cache to make it aware of the </span><span class="No-Break"><span class="koboSpan" id="kobo.504.1">new route:</span></span><pre class="console"><span class="koboSpan" id="kobo.505.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.506.1">An HTTP request such as the following can then be used to retrieve the articles on your </span><span class="No-Break"><span class="koboSpan" id="kobo.507.1">Drupal site:</span></span><pre class="console"><span class="koboSpan" id="kobo.508.1">
GET http://localhost/articles</span></pre><pre class="console"><span class="koboSpan" id="kobo.509.1">
Accept: application/json</span></pre></li>
</ol>
<h2 id="_idParaDest-196"><a id="_idTextAnchor225"/><span class="koboSpan" id="kobo.510.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.511.1">Entity queries are an abstraction above the Database API in Drupal. </span><span class="koboSpan" id="kobo.511.2">Drupal stores entity and field data in normalized database tables. </span><span class="koboSpan" id="kobo.511.3">The entity query builds the appropriate database query to check the entity’s base table, data table, and any field tables. </span><span class="koboSpan" id="kobo.511.4">It orchestrates all of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.512.1">JOIN</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.513.1">statements required.</span></span></p>
<p><span class="koboSpan" id="kobo.514.1">When an entity</span><a id="_idIndexMarker349"/><span class="koboSpan" id="kobo.515.1"> query</span><a id="_idIndexMarker350"/><span class="koboSpan" id="kobo.516.1"> is executed, it returns the IDs of matching entities. </span><span class="koboSpan" id="kobo.516.2">These IDs are then passed to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.517.1">loadMultiple</span></strong><span class="koboSpan" id="kobo.518.1"> method to retrieve </span><span class="No-Break"><span class="koboSpan" id="kobo.519.1">entity objects.</span></span></p>
<h2 id="_idParaDest-197"><a id="_idTextAnchor226"/><span class="koboSpan" id="kobo.520.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.521.1">There are more things that can be done with </span><span class="No-Break"><span class="koboSpan" id="kobo.522.1">entity queries.</span></span></p>
<h3><span class="koboSpan" id="kobo.523.1">Count queries</span></h3>
<p><span class="koboSpan" id="kobo.524.1">An entity query can also </span><a id="_idIndexMarker351"/><span class="koboSpan" id="kobo.525.1">perform a count instead of returning the entity IDs. </span><span class="koboSpan" id="kobo.525.2">This is done by calling the </span><strong class="source-inline"><span class="koboSpan" id="kobo.526.1">count</span></strong><span class="koboSpan" id="kobo.527.1"> method on an entity </span><span class="No-Break"><span class="koboSpan" id="kobo.528.1">query object:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.529.1">
$node_storage-&gt;getQuery()
  -&gt;accessCheck(FALSE)
  -&gt;condition('type', 'article')
  -&gt;condition('status', FALSE)
  -&gt;count()
  -&gt;execute();</span></pre>
<p><span class="koboSpan" id="kobo.530.1">The preceding code would return the number of </span><span class="No-Break"><span class="koboSpan" id="kobo.531.1">unpublished articles.</span></span></p>
<h1 id="_idParaDest-198"><a id="_idTextAnchor227"/><span class="koboSpan" id="kobo.532.1">Checking entity access</span></h1>
<p><span class="koboSpan" id="kobo.533.1">In this recipe, we will </span><a id="_idIndexMarker352"/><span class="koboSpan" id="kobo.534.1">demonstrate how to check whether the current user has access to </span><a id="_idIndexMarker353"/><span class="koboSpan" id="kobo.535.1">view an </span><strong class="bold"><span class="koboSpan" id="kobo.536.1">article</span></strong><span class="koboSpan" id="kobo.537.1"> node. </span><span class="koboSpan" id="kobo.537.2">In previous recipes throughout the book, we have used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.538.1">_entity_access</span></strong><span class="koboSpan" id="kobo.539.1"> route requirement to perform entity access checks. </span><span class="koboSpan" id="kobo.539.2">This recipe will use its own entity access control so that the response is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.540.1">404 Not Found</span></strong><span class="koboSpan" id="kobo.541.1"> response instead of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.542.1">403 </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">Forbidden</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.544.1"> response.</span></span></p>
<h2 id="_idParaDest-199"><a id="_idTextAnchor228"/><span class="koboSpan" id="kobo.545.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.546.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.547.1">get</span></strong><span class="koboSpan" id="kobo.548.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.549.1">ArticleController</span></strong><span class="koboSpan" id="kobo.550.1"> controller in your module that has a parameter for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.551.1">node</span></strong><span class="koboSpan" id="kobo.552.1"> entity object that will be provided by a </span><span class="No-Break"><span class="koboSpan" id="kobo.553.1">route parameter:</span></span><pre class="console"><span class="koboSpan" id="kobo.554.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.555.1">
namespace Drupal\mymodule\Controller;</span></pre><pre class="console"><span class="koboSpan" id="kobo.556.1">
use Drupal\Core\Controller\ControllerBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.557.1">
use Drupal\node\NodeInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.558.1">
use Symfony\Component\HttpFoundation\JsonResponse;</span></pre><pre class="console"><span class="koboSpan" id="kobo.559.1">
use Symfony\Component\HttpFoundation\Request;</span></pre><pre class="console"><span class="koboSpan" id="kobo.560.1">
class ArticleController extends ControllerBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.561.1">
  public function get(NodeInterface $node):</span></pre><pre class="console"><span class="koboSpan" id="kobo.562.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.563.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.564.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.565.1">If using the same</span><a id="_idIndexMarker354"/><span class="koboSpan" id="kobo.566.1"> controller from previous recipes, this adds a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">use</span></strong><span class="koboSpan" id="kobo.568.1"> statement for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">Drupal\node\NodeInterface</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.570.1"> interface.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.571.1">Then, we get the entity type manager and retrieve the access control handler for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.572.1">node</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.573.1">entity type:</span></span><pre class="console"><span class="koboSpan" id="kobo.574.1">
  public function get(NodeInterface $node):</span></pre><pre class="console"><span class="koboSpan" id="kobo.575.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.576.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.577.1">
   $access_handler = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.578.1">
      getAccessControlHandler('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.579.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.580.1">The entity type manager is a repository of information for entity types and is used to get handlers for entity types, such as the access </span><span class="No-Break"><span class="koboSpan" id="kobo.581.1">control handler.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.582.1">From the access control handler, invoke the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.583.1">access</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.584.1"> method:</span></span><pre class="console"><span class="koboSpan" id="kobo.585.1">
  public function get(NodeInterface $node):</span></pre><pre class="console"><span class="koboSpan" id="kobo.586.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.587.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.588.1">
   $access_handler = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.589.1">
      getAccessControlHandler('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.590.1">
   $node_access = $access_handler-&gt;access($node,</span></pre><pre class="console"><span class="koboSpan" id="kobo.591.1">
      'view');</span></pre><pre class="console"><span class="koboSpan" id="kobo.592.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.593.1">The first</span><a id="_idIndexMarker355"/><span class="koboSpan" id="kobo.594.1"> parameter of </span><strong class="source-inline"><span class="koboSpan" id="kobo.595.1">access</span></strong><span class="koboSpan" id="kobo.596.1"> is the entity. </span><span class="koboSpan" id="kobo.596.2">The second parameter is the operation, which is </span><strong class="source-inline"><span class="koboSpan" id="kobo.597.1">view</span></strong><span class="koboSpan" id="kobo.598.1"> for this recipe. </span><span class="koboSpan" id="kobo.598.2">By default, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.599.1">access</span></strong><span class="koboSpan" id="kobo.600.1"> method returns a </span><span class="No-Break"><span class="koboSpan" id="kobo.601.1">Boolean value.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.602.1">If the result is not allowed, we want to return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.603.1">404 Not </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.604.1">Found</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.605.1"> response:</span></span><pre class="console"><span class="koboSpan" id="kobo.606.1">
  public function get(NodeInterface $node):</span></pre><pre class="console"><span class="koboSpan" id="kobo.607.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.608.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.609.1">
   $access_handler = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.610.1">
      getAccessControlHandler('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.611.1">
   $node_access = $access_handler-&gt;access($node,</span></pre><pre class="console"><span class="koboSpan" id="kobo.612.1">
      'view');</span></pre><pre class="console"><span class="koboSpan" id="kobo.613.1">
   if (!$node_access) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.614.1">
    return new JsonResponse(NULL, 404);</span></pre><pre class="console"><span class="koboSpan" id="kobo.615.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.616.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.617.1">We will return a JSON response, but with </span><strong class="source-inline"><span class="koboSpan" id="kobo.618.1">NULL</span></strong><span class="koboSpan" id="kobo.619.1"> data and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.620.1">404</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.621.1">status code.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.622.1">If the result is</span><a id="_idIndexMarker356"/><span class="koboSpan" id="kobo.623.1"> allowed, return a JSON response of the article </span><span class="No-Break"><span class="koboSpan" id="kobo.624.1">node’s content:</span></span><pre class="console"><span class="koboSpan" id="kobo.625.1">
  public function get(NodeInterface $node):</span></pre><pre class="console"><span class="koboSpan" id="kobo.626.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.627.1">
   $entity_type_manager = $this-&gt;entityTypeManager();</span></pre><pre class="console"><span class="koboSpan" id="kobo.628.1">
   $access_handler = $entity_type_manager-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.629.1">
      getAccessControlHandler('node');</span></pre><pre class="console"><span class="koboSpan" id="kobo.630.1">
   $node_access = $access_handler-&gt;access($node,</span></pre><pre class="console"><span class="koboSpan" id="kobo.631.1">
      'view');</span></pre><pre class="console"><span class="koboSpan" id="kobo.632.1">
   if (!$node_access) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.633.1">
    return new JsonResponse(NULL, 404);</span></pre><pre class="console"><span class="koboSpan" id="kobo.634.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.635.1">
   return new JsonResponse(</span></pre><pre class="console"><span class="koboSpan" id="kobo.636.1">
    $node-&gt;toArray(),</span></pre><pre class="console"><span class="koboSpan" id="kobo.637.1">
   );</span></pre><pre class="console"><span class="koboSpan" id="kobo.638.1">
  }</span></pre></li>
<li><span class="koboSpan" id="kobo.639.1">We must create the route in our module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.640.1">routing.yml</span></strong><span class="koboSpan" id="kobo.641.1"> that points to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.642.1">get</span></strong><span class="koboSpan" id="kobo.643.1"> method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.644.1">ArticleController</span></strong><span class="koboSpan" id="kobo.645.1"> for an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.646.1">GET</span></strong><span class="koboSpan" id="kobo.647.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.648.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.649.1">articles/{node}</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.650.1"> path:</span></span><pre class="console"><span class="koboSpan" id="kobo.651.1">
mymodule.get_article:</span></pre><pre class="console"><span class="koboSpan" id="kobo.652.1">
  path: /articles/{node}</span></pre><pre class="console"><span class="koboSpan" id="kobo.653.1">
  defaults:</span></pre><pre class="console"><span class="koboSpan" id="kobo.654.1">
   _controller: Drupal\mymodule\Controller\</span></pre><pre class="console"><span class="koboSpan" id="kobo.655.1">
      ArticleController::get</span></pre><pre class="console"><span class="koboSpan" id="kobo.656.1">
  requirements:</span></pre><pre class="console"><span class="koboSpan" id="kobo.657.1">
   _permission: 'access content'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.658.1">Since our route parameter is named </span><strong class="source-inline"><span class="koboSpan" id="kobo.659.1">node</span></strong><span class="koboSpan" id="kobo.660.1"> and our controller method accepts the class for a node entity, Drupal will automatically have our </span><strong class="source-inline"><span class="koboSpan" id="kobo.661.1">node</span></strong><span class="koboSpan" id="kobo.662.1"> parameter converted to an entity object </span><span class="No-Break"><span class="koboSpan" id="kobo.663.1">for us.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.664.1">Rebuild your Drupal site’s cache to make it aware of the </span><span class="No-Break"><span class="koboSpan" id="kobo.665.1">new route:</span></span><pre class="console"><span class="koboSpan" id="kobo.666.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.667.1">An HTTP request</span><a id="_idIndexMarker357"/><span class="koboSpan" id="kobo.668.1"> such as the following can then be used to retrieve an article that is on your </span><span class="No-Break"><span class="koboSpan" id="kobo.669.1">Drupal site:</span></span><pre class="console"><span class="koboSpan" id="kobo.670.1">
GET http://localhost/articles/1</span></pre><pre class="console"><span class="koboSpan" id="kobo.671.1">
Accept: application/json</span></pre></li>
</ol>
<h2 id="_idParaDest-200"><a id="_idTextAnchor229"/><span class="koboSpan" id="kobo.672.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.673.1">This recipe did not use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.674.1">_entity_access</span></strong><span class="koboSpan" id="kobo.675.1"> route requirement to showcase entity validation. </span><span class="koboSpan" id="kobo.675.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.676.1">_entity_access</span></strong><span class="koboSpan" id="kobo.677.1"> route requirement invokes the access method on the entity located in the route parameter against </span><span class="No-Break"><span class="koboSpan" id="kobo.678.1">an operation.</span></span></p>
<p><span class="koboSpan" id="kobo.679.1">The following operations are recognized by Drupal’s entity </span><span class="No-Break"><span class="koboSpan" id="kobo.680.1">access system:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.681.1">view</span></strong><span class="koboSpan" id="kobo.682.1">: The user is allowed to view </span><span class="No-Break"><span class="koboSpan" id="kobo.683.1">the entity.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.684.1">view_label</span></strong><span class="koboSpan" id="kobo.685.1">: A less used operation. </span><span class="koboSpan" id="kobo.685.2">It is used to check whether the user has the privilege to at least view the </span><span class="No-Break"><span class="koboSpan" id="kobo.686.1">entity’s label/title.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.687.1">update</span></strong><span class="koboSpan" id="kobo.688.1">: The user is allowed to update </span><span class="No-Break"><span class="koboSpan" id="kobo.689.1">the entity.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.690.1">delete</span></strong><span class="koboSpan" id="kobo.691.1">: The user is allowed to delete </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">the entity.</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.693.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.694.1">The access to create an entity is a different call to the access control handler since it cannot be checked against an entity object. </span><span class="koboSpan" id="kobo.694.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.695.1">createAccess</span></strong><span class="koboSpan" id="kobo.696.1"> method on the access control handler is used to see if a user has access to create a new entity of the </span><span class="No-Break"><span class="koboSpan" id="kobo.697.1">entity type.</span></span></p>
<p><span class="koboSpan" id="kobo.698.1">Checking </span><strong class="source-inline"><span class="koboSpan" id="kobo.699.1">access</span></strong><span class="koboSpan" id="kobo.700.1"> of an entity can also be done by invoking the </span><strong class="source-inline"><span class="koboSpan" id="kobo.701.1">access</span></strong><span class="koboSpan" id="kobo.702.1"> method on the entity itself. </span><span class="koboSpan" id="kobo.702.2">This recipe is intended to showcase the access control handler as well. </span><span class="koboSpan" id="kobo.702.3">The recipe could check access by performing </span><span class="No-Break"><span class="koboSpan" id="kobo.703.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.704.1">
$node_access = $node-&gt;access('view');</span></pre>
<p><span class="koboSpan" id="kobo.705.1">By default, the access check uses the current user. </span><span class="koboSpan" id="kobo.705.2">Access checks allow passing an alternative user </span><a id="_idIndexMarker358"/><span class="koboSpan" id="kobo.706.1">account to perform access checks. </span><span class="koboSpan" id="kobo.706.2">This may be useful when running code on the command line or in </span><span class="No-Break"><span class="koboSpan" id="kobo.707.1">background jobs:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.708.1">
$node_access = $node-&gt;access('view', $other_user);</span></pre>
<h1 id="_idParaDest-201"><a id="_idTextAnchor230"/><span class="koboSpan" id="kobo.709.1">Updating an entity’s field values</span></h1>
<p><span class="koboSpan" id="kobo.710.1">In this recipe, we will </span><a id="_idIndexMarker359"/><span class="koboSpan" id="kobo.711.1">define a route to update the field values of an article node. </span><span class="koboSpan" id="kobo.711.2">The route will be for an </span><strong class="source-inline"><span class="koboSpan" id="kobo.712.1">HTTP PATCH</span></strong><span class="koboSpan" id="kobo.713.1"> request sending JSON to specify a new title and </span><span class="No-Break"><span class="koboSpan" id="kobo.714.1">body text.</span></span></p>
<h2 id="_idParaDest-202"><a id="_idTextAnchor231"/><span class="koboSpan" id="kobo.715.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.716.1">Create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.717.1">update</span></strong><span class="koboSpan" id="kobo.718.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.719.1">ArticleController</span></strong><span class="koboSpan" id="kobo.720.1"> controller that receives the incoming request and </span><span class="No-Break"><span class="koboSpan" id="kobo.721.1">node object:</span></span><pre class="console"><span class="koboSpan" id="kobo.722.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.723.1">
namespace Drupal\mymodule\Controller;</span></pre><pre class="console"><span class="koboSpan" id="kobo.724.1">
use Drupal\Core\Controller\ControllerBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.725.1">
use Drupal\node\NodeInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.726.1">
use Symfony\Component\HttpFoundation\JsonResponse;</span></pre><pre class="console"><span class="koboSpan" id="kobo.727.1">
use Symfony\Component\HttpFoundation\Request;</span></pre><pre class="console"><span class="koboSpan" id="kobo.728.1">
class ArticleController extends ControllerBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.729.1">
  public function update(Request $request,</span></pre><pre class="console"><span class="koboSpan" id="kobo.730.1">
    NodeInterface $node): JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.731.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.732.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.733.1">We need the request </span><a id="_idIndexMarker360"/><span class="koboSpan" id="kobo.734.1">object so that we can retrieve the JSON payload provided to this method and the node object </span><span class="No-Break"><span class="koboSpan" id="kobo.735.1">to update.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.736.1">Next, we will convert the request’s content from JSON to a PHP array using Drupal’s JSON serialization </span><span class="No-Break"><span class="koboSpan" id="kobo.737.1">utility class:</span></span><pre class="console"><span class="koboSpan" id="kobo.738.1">
  public function update(Request $request,</span></pre><pre class="console"><span class="koboSpan" id="kobo.739.1">
    NodeInterface $node): JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.740.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.741.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.742.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.743.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.744.1">While we could use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.745.1">json_decode</span></strong><span class="koboSpan" id="kobo.746.1"> function directly, leveraging utility classes provided by Drupal standardizes the way </span><span class="No-Break"><span class="koboSpan" id="kobo.747.1">code works.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.748.1">First, we will update the article node’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.749.1">title</span></strong><span class="koboSpan" id="kobo.750.1">, if provided in the </span><span class="No-Break"><span class="koboSpan" id="kobo.751.1">request’s JSON:</span></span><pre class="console"><span class="koboSpan" id="kobo.752.1">
  public function update(Request $request,</span></pre><pre class="console"><span class="koboSpan" id="kobo.753.1">
    NodeInterface $node): JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.754.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.755.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.756.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.757.1">
   if (!empty($json['title'])) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.758.1">
    $node-&gt;setTitle($json['title']);</span></pre><pre class="console"><span class="koboSpan" id="kobo.759.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.760.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.761.1">Some entity classes provide methods for setting specific field values like the </span><strong class="source-inline"><span class="koboSpan" id="kobo.762.1">Node</span></strong><span class="koboSpan" id="kobo.763.1"> class does with </span><strong class="source-inline"><span class="koboSpan" id="kobo.764.1">setTitle</span></strong><span class="koboSpan" id="kobo.765.1"> to modify the </span><span class="No-Break"><span class="koboSpan" id="kobo.766.1">node’s </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.767.1">title</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.768.1">.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.769.1">Then, we will</span><a id="_idIndexMarker361"/><span class="koboSpan" id="kobo.770.1"> update the article’s body field, if provided in the </span><span class="No-Break"><span class="koboSpan" id="kobo.771.1">request’s JSON:</span></span><pre class="console"><span class="koboSpan" id="kobo.772.1">
  public function update(Request $request,</span></pre><pre class="console"><span class="koboSpan" id="kobo.773.1">
    NodeInterface $node): JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.774.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.775.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.776.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.777.1">
   if (!empty($json['title'])) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.778.1">
    $node-&gt;setTitle($json['title']);</span></pre><pre class="console"><span class="koboSpan" id="kobo.779.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.780.1">
   if (!empty($json['body'])) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.781.1">
    $node-&gt;set('field_body', $json['body']);</span></pre><pre class="console"><span class="koboSpan" id="kobo.782.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.783.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.784.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.785.1">set</span></strong><span class="koboSpan" id="kobo.786.1"> method allows us to set the value for a field. </span><span class="koboSpan" id="kobo.786.2">The first parameter is the field name and the second parameter is the </span><span class="No-Break"><span class="koboSpan" id="kobo.787.1">field’s value.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.788.1">After the fields have been</span><a id="_idIndexMarker362"/><span class="koboSpan" id="kobo.789.1"> updated, we can save the entity and return it as a </span><span class="No-Break"><span class="koboSpan" id="kobo.790.1">JSON response:</span></span><pre class="console"><span class="koboSpan" id="kobo.791.1">
  public function update(Request $request,</span></pre><pre class="console"><span class="koboSpan" id="kobo.792.1">
    NodeInterface $node): JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.793.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.794.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.795.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.796.1">
   if (isset($json['title'])) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.797.1">
    $node-&gt;setTitle($json['title']);</span></pre><pre class="console"><span class="koboSpan" id="kobo.798.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.799.1">
   if (isset($json['body'])) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.800.1">
    $node-&gt;set('body', $json['body']);</span></pre><pre class="console"><span class="koboSpan" id="kobo.801.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.802.1">
   $node-&gt;save();</span></pre><pre class="console"><span class="koboSpan" id="kobo.803.1">
   return new JsonResponse(</span></pre><pre class="console"><span class="koboSpan" id="kobo.804.1">
    $node-&gt;toArray()</span></pre><pre class="console"><span class="koboSpan" id="kobo.805.1">
   );</span></pre><pre class="console"><span class="koboSpan" id="kobo.806.1">
  }</span></pre></li>
<li><span class="koboSpan" id="kobo.807.1">We must create the route in </span><strong class="source-inline"><span class="koboSpan" id="kobo.808.1">routing.yml</span></strong><span class="koboSpan" id="kobo.809.1"> that points to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.810.1">update</span></strong><span class="koboSpan" id="kobo.811.1"> method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.812.1">ArticleController</span></strong><span class="koboSpan" id="kobo.813.1"> for an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.814.1">PATCH</span></strong><span class="koboSpan" id="kobo.815.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.816.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.817.1">articles/{node}</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.818.1"> path:</span></span><pre class="console"><span class="koboSpan" id="kobo.819.1">
mymodule.update_article:</span></pre><pre class="console"><span class="koboSpan" id="kobo.820.1">
  path: /articles/{node}</span></pre><pre class="console"><span class="koboSpan" id="kobo.821.1">
  defaults:</span></pre><pre class="console"><span class="koboSpan" id="kobo.822.1">
   _controller: Drupal\mymodule\Controller\</span></pre><pre class="console"><span class="koboSpan" id="kobo.823.1">
      ArticleController::update</span></pre><pre class="console"><span class="koboSpan" id="kobo.824.1">
  methods: [PATCH]</span></pre><pre class="console"><span class="koboSpan" id="kobo.825.1">
  requirements:</span></pre><pre class="console"><span class="koboSpan" id="kobo.826.1">
   _access: 'TRUE'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.827.1">This route should have </span><strong class="source-inline"><span class="koboSpan" id="kobo.828.1">_entity_access: 'node.update'</span></strong><span class="koboSpan" id="kobo.829.1"> as its requirements. </span><span class="koboSpan" id="kobo.829.2">However, we have used </span><strong class="source-inline"><span class="koboSpan" id="kobo.830.1">_access: 'TRUE'</span></strong><span class="koboSpan" id="kobo.831.1"> to bypass access checks for </span><span class="No-Break"><span class="koboSpan" id="kobo.832.1">this recipe.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.833.1">Rebuild your Drupal site’s cache to make it aware of the </span><span class="No-Break"><span class="koboSpan" id="kobo.834.1">new route:</span></span><pre class="console"><span class="koboSpan" id="kobo.835.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.836.1">An HTTP request </span><a id="_idIndexMarker363"/><span class="koboSpan" id="kobo.837.1">such as the following can then be used to update an article that is on your </span><span class="No-Break"><span class="koboSpan" id="kobo.838.1">Drupal site:</span></span><pre class="console"><span class="koboSpan" id="kobo.839.1">
PATCH http://localhost/articles/1</span></pre><pre class="console"><span class="koboSpan" id="kobo.840.1">
Content-Type: application/json</span></pre><pre class="console"><span class="koboSpan" id="kobo.841.1">
Accept: application/json</span></pre><pre class="console"><span class="koboSpan" id="kobo.842.1">
{</span></pre><pre class="console"><span class="koboSpan" id="kobo.843.1">
  "title": "New updated title!",</span></pre><pre class="console"><span class="koboSpan" id="kobo.844.1">
  "body": "Modified body text"</span></pre><pre class="console"><span class="koboSpan" id="kobo.845.1">
}</span></pre></li>
</ol>
<h2 id="_idParaDest-203"><a id="_idTextAnchor232"/><span class="koboSpan" id="kobo.846.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.847.1">When updating an entity, the entity storage updates the field values in the database and the entity’s database record. </span><span class="koboSpan" id="kobo.847.2">The entity storage will write the field values to the appropriate database tables that hold </span><span class="No-Break"><span class="koboSpan" id="kobo.848.1">field values.</span></span></p>
<p><span class="koboSpan" id="kobo.849.1">When an entity is updated, the entity storage fires invoke the following hooks, allowing you to hook into an update to an entity. </span><span class="koboSpan" id="kobo.849.2">The entity being updated is passed as </span><span class="No-Break"><span class="koboSpan" id="kobo.850.1">an argument:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.851.1">hook_ENTITY_TYPE_presave</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.852.1">hook_entity_presave</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.853.1">hook_ENTITY_TYPE_update</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.854.1">hook_entity_update</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.855.1">Entities may also be </span><a id="_idIndexMarker364"/><span class="koboSpan" id="kobo.856.1">validated, to ensure their updated values are correct. </span><span class="koboSpan" id="kobo.856.2">This is covered in the next recipe, </span><em class="italic"><span class="koboSpan" id="kobo.857.1">Performing </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.858.1">entity validation</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.859.1">.</span></span></p>
<h1 id="_idParaDest-204"><a id="_idTextAnchor233"/><span class="koboSpan" id="kobo.860.1">Performing entity validation</span></h1>
<p><span class="koboSpan" id="kobo.861.1">In this recipe, we will</span><a id="_idIndexMarker365"/><span class="koboSpan" id="kobo.862.1"> walk through entity validation. </span><span class="koboSpan" id="kobo.862.2">Drupal has integrated with the </span><strong class="bold"><span class="koboSpan" id="kobo.863.1">Symfony Validator</span></strong><span class="koboSpan" id="kobo.864.1"> component. </span><span class="koboSpan" id="kobo.864.2">Entities</span><a id="_idIndexMarker366"/><span class="koboSpan" id="kobo.865.1"> can be validated before saving. </span><span class="koboSpan" id="kobo.865.2">We will build off of the last recipe, which allows updating an article node to add validation of </span><span class="No-Break"><span class="koboSpan" id="kobo.866.1">its values.</span></span></p>
<h2 id="_idParaDest-205"><a id="_idTextAnchor234"/><span class="koboSpan" id="kobo.867.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.868.1">We will be adding validation to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.869.1">update</span></strong><span class="koboSpan" id="kobo.870.1"> method from the </span><span class="No-Break"><span class="koboSpan" id="kobo.871.1">previous recipe:</span></span><pre class="console"><span class="koboSpan" id="kobo.872.1">
  public function update(Request $request,</span></pre><pre class="console"><span class="koboSpan" id="kobo.873.1">
    NodeInterface $node): JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.874.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.875.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.876.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.877.1">
   if (isset($json['title'])) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.878.1">
    $node-&gt;setTitle($json['title']);</span></pre><pre class="console"><span class="koboSpan" id="kobo.879.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.880.1">
   if (isset($json['body'])) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.881.1">
    $node-&gt;set('body', $json['body']);</span></pre><pre class="console"><span class="koboSpan" id="kobo.882.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.883.1">
   $node-&gt;save();</span></pre><pre class="console"><span class="koboSpan" id="kobo.884.1">
   return new JsonResponse(</span></pre><pre class="console"><span class="koboSpan" id="kobo.885.1">
    $node-&gt;toArray()</span></pre><pre class="console"><span class="koboSpan" id="kobo.886.1">
   );</span></pre><pre class="console"><span class="koboSpan" id="kobo.887.1">
  }</span></pre></li>
<li><span class="koboSpan" id="kobo.888.1">We will </span><a id="_idIndexMarker367"/><span class="koboSpan" id="kobo.889.1">modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.890.1">update</span></strong><span class="koboSpan" id="kobo.891.1"> method to </span><strong class="source-inline"><span class="koboSpan" id="kobo.892.1">validate</span></strong><span class="koboSpan" id="kobo.893.1"> the node </span><span class="No-Break"><span class="koboSpan" id="kobo.894.1">before saving:</span></span><pre class="console"><span class="koboSpan" id="kobo.895.1">
  public function update(Request $request,</span></pre><pre class="console"><span class="koboSpan" id="kobo.896.1">
    NodeInterface $node): JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.897.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.898.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.899.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.900.1">
   if (isset($json['title'])) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.901.1">
    $node-&gt;setTitle($json['title']);</span></pre><pre class="console"><span class="koboSpan" id="kobo.902.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.903.1">
   if (isset($json['body'])) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.904.1">
    $node-&gt;set('body', $json['body']);</span></pre><pre class="console"><span class="koboSpan" id="kobo.905.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.906.1">
   $constraint_violations = $node-&gt;validate();</span></pre><pre class="console"><span class="koboSpan" id="kobo.907.1">
   $node-&gt;save();</span></pre><pre class="console"><span class="koboSpan" id="kobo.908.1">
   return new JsonResponse(</span></pre><pre class="console"><span class="koboSpan" id="kobo.909.1">
    $node-&gt;toArray()</span></pre><pre class="console"><span class="koboSpan" id="kobo.910.1">
   );</span></pre><pre class="console"><span class="koboSpan" id="kobo.911.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.912.1">We will invoke the </span><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">validate</span></strong><span class="koboSpan" id="kobo.914.1"> method, which runs the validation system against all constraints on the entity and its </span><span class="No-Break"><span class="koboSpan" id="kobo.915.1">field values.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.916.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.917.1">validate</span></strong><span class="koboSpan" id="kobo.918.1"> method returns an object containing any constraint violations and does not throw an </span><a id="_idIndexMarker368"/><span class="koboSpan" id="kobo.919.1">exception. </span><span class="koboSpan" id="kobo.919.2">We must check whether there are </span><span class="No-Break"><span class="koboSpan" id="kobo.920.1">any violations:</span></span><pre class="console"><span class="koboSpan" id="kobo.921.1">
  public function update(Request $request,</span></pre><pre class="console"><span class="koboSpan" id="kobo.922.1">
    NodeInterface $node): JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.923.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.924.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.925.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.926.1">
   if (isset($json['title'])) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.927.1">
    $node-&gt;setTitle($json['title']);</span></pre><pre class="console"><span class="koboSpan" id="kobo.928.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.929.1">
   if (isset($json['body'])) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.930.1">
    $node-&gt;set('body', $json['body']);</span></pre><pre class="console"><span class="koboSpan" id="kobo.931.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.932.1">
   $constraint_violations = $node-&gt;validate();</span></pre><pre class="console"><span class="koboSpan" id="kobo.933.1">
   if (count($constraint_violations) &gt; 0) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.934.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.935.1">
   $node-&gt;save();</span></pre><pre class="console"><span class="koboSpan" id="kobo.936.1">
   return new JsonResponse(</span></pre><pre class="console"><span class="koboSpan" id="kobo.937.1">
    $node-&gt;toArray()</span></pre><pre class="console"><span class="koboSpan" id="kobo.938.1">
   );</span></pre><pre class="console"><span class="koboSpan" id="kobo.939.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.940.1">The returned object, an instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.941.1">\Drupal\Core\Entity\EntityConstraintViolationListInterface</span></strong><span class="koboSpan" id="kobo.942.1">, implements </span><strong class="source-inline"><span class="koboSpan" id="kobo.943.1">\Countable</span></strong><span class="koboSpan" id="kobo.944.1">. </span><span class="koboSpan" id="kobo.944.2">This allows us to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.945.1">count</span></strong><span class="koboSpan" id="kobo.946.1"> function to see if there are </span><span class="No-Break"><span class="koboSpan" id="kobo.947.1">any violations.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.948.1">If there are constraint </span><a id="_idIndexMarker369"/><span class="koboSpan" id="kobo.949.1">violations, we will build an array of error messages and return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.950.1">400 Bad </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.951.1">Request</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.952.1"> response:</span></span><pre class="console"><span class="koboSpan" id="kobo.953.1">
  public function update(Request $request,</span></pre><pre class="console"><span class="koboSpan" id="kobo.954.1">
    NodeInterface $node): JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.955.1">
   $content = $request-&gt;getContent();</span></pre><pre class="console"><span class="koboSpan" id="kobo.956.1">
   $json = \Drupal\Component\Serialization\</span></pre><pre class="console"><span class="koboSpan" id="kobo.957.1">
      Json::decode($content);</span></pre><pre class="console"><span class="koboSpan" id="kobo.958.1">
   if (isset($json['title'])) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.959.1">
    $node-&gt;setTitle($json['title']);</span></pre><pre class="console"><span class="koboSpan" id="kobo.960.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.961.1">
   if (isset($json['body'])) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.962.1">
    $node-&gt;set('body', $json['body']);</span></pre><pre class="console"><span class="koboSpan" id="kobo.963.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.964.1">
   $constraint_violations = $node-&gt;validate();</span></pre><pre class="console"><span class="koboSpan" id="kobo.965.1">
   if (count($constraint_violations) &gt; 0) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.966.1">
    $errors = [];</span></pre><pre class="console"><span class="koboSpan" id="kobo.967.1">
    foreach ($constraint_violations as $violation) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.968.1">
      $errors[] = $violation-&gt;getPropertyPath()</span></pre><pre class="console"><span class="koboSpan" id="kobo.969.1">
        . </span><span class="koboSpan" id="kobo.969.2">': ' . </span><span class="koboSpan" id="kobo.969.3">$violation-&gt;getMessage();</span></pre><pre class="console"><span class="koboSpan" id="kobo.970.1">
    }</span></pre><pre class="console"><span class="koboSpan" id="kobo.971.1">
    return new JsonResponse($errors, 400);</span></pre><pre class="console"><span class="koboSpan" id="kobo.972.1">
   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.973.1">
   $node-&gt;save();</span></pre><pre class="console"><span class="koboSpan" id="kobo.974.1">
   return new JsonResponse(</span></pre><pre class="console"><span class="koboSpan" id="kobo.975.1">
    $node-&gt;toArray()</span></pre><pre class="console"><span class="koboSpan" id="kobo.976.1">
   );</span></pre><pre class="console"><span class="koboSpan" id="kobo.977.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.978.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.979.1">EntityConstraintViolationListInterface</span></strong><span class="koboSpan" id="kobo.980.1"> object is also iterable, allowing </span><a id="_idIndexMarker370"/><span class="koboSpan" id="kobo.981.1">us to loop over all of the violations. </span><span class="koboSpan" id="kobo.981.2">From each violation, we can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.982.1">getPropertyPath</span></strong><span class="koboSpan" id="kobo.983.1"> to identify the invalid field and </span><strong class="source-inline"><span class="koboSpan" id="kobo.984.1">getMessage</span></strong><span class="koboSpan" id="kobo.985.1"> for information about the </span><span class="No-Break"><span class="koboSpan" id="kobo.986.1">invalid value.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.987.1">The following HTTP request would trigger a constraint violation for an empty value in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.988.1">title</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.989.1"> field:</span></span><pre class="console"><span class="koboSpan" id="kobo.990.1">
PATCH https://localhost/articles/1</span></pre><pre class="console"><span class="koboSpan" id="kobo.991.1">
Content-Type: application/json</span></pre><pre class="console"><span class="koboSpan" id="kobo.992.1">
Accept: application/json</span></pre><pre class="console"><span class="koboSpan" id="kobo.993.1">
{</span></pre><pre class="console"><span class="koboSpan" id="kobo.994.1">
  "title": "",</span></pre><pre class="console"><span class="koboSpan" id="kobo.995.1">
  "body": "Modified body text"</span></pre><pre class="console"><span class="koboSpan" id="kobo.996.1">
}</span></pre></li>
</ol>
<h2 id="_idParaDest-206"><a id="_idTextAnchor235"/><span class="koboSpan" id="kobo.997.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.998.1">Drupal utilizes the </span><a id="_idIndexMarker371"/><span class="koboSpan" id="kobo.999.1">Symfony Validator component (</span><a href="https://symfony.com/components/Validator"><span class="koboSpan" id="kobo.1000.1">https://symfony.com/components/Validator</span></a><span class="koboSpan" id="kobo.1001.1">) to validate data. </span><span class="koboSpan" id="kobo.1001.2">The Validator component has a concept of constraints that are validated, and if the validation fails a violation is reported. </span><span class="koboSpan" id="kobo.1001.3">Drupal’s entity validation works with an outside-in approach: entity-level constraints are validated and then each field is validated, going down through each </span><span class="No-Break"><span class="koboSpan" id="kobo.1002.1">field’s properties.</span></span></p>
<p><span class="koboSpan" id="kobo.1003.1">Entity validation does not automatically run when an entity is saved. </span><span class="koboSpan" id="kobo.1003.2">It is an explicit operation that must be invoked when manipulating entities programmatically. </span><span class="koboSpan" id="kobo.1003.3">The only time Drupal invokes entity validation is when an entity is modified through </span><span class="No-Break"><span class="koboSpan" id="kobo.1004.1">its forms.</span></span></p>
<p><span class="koboSpan" id="kobo.1005.1">At the same time, the invoker of the entity invalidation must choose how to react to constraint violations, such</span><a id="_idIndexMarker372"/><span class="koboSpan" id="kobo.1006.1"> as our recipe did to prevent the entity from being saved. </span><span class="koboSpan" id="kobo.1006.2">An invalid entity can always be </span><span class="No-Break"><span class="koboSpan" id="kobo.1007.1">saved programmatically.</span></span></p>
<h2 id="_idParaDest-207"><a id="_idTextAnchor236"/><span class="koboSpan" id="kobo.1008.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.1009.1">There are more options when validating an entity’s values. </span><span class="koboSpan" id="kobo.1009.2">Let us see a few of these options in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1010.1">following sections.</span></span></p>
<h3><span class="koboSpan" id="kobo.1011.1">Validating fields directly</span></h3>
<p><span class="koboSpan" id="kobo.1012.1">Field item </span><a id="_idIndexMarker373"/><span class="koboSpan" id="kobo.1013.1">classes have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1014.1">validate</span></strong><span class="koboSpan" id="kobo.1015.1"> method for directly validating a specific field instead of validating the entire entity. </span><span class="koboSpan" id="kobo.1015.2">This can be done by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1016.1">get</span></strong><span class="koboSpan" id="kobo.1017.1"> method to get the field item and then invoking the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1018.1">validate</span></strong><span class="koboSpan" id="kobo.1019.1"> method on the </span><span class="No-Break"><span class="koboSpan" id="kobo.1020.1">field item:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1021.1">
$node-&gt;get('body')-&gt;validate();</span></pre>
<h3><span class="koboSpan" id="kobo.1022.1">Filtering constraint violations</span></h3>
<p><span class="koboSpan" id="kobo.1023.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1024.1">EntityConstraintViolationListInterface</span></strong><span class="koboSpan" id="kobo.1025.1"> class </span><a id="_idIndexMarker374"/><span class="koboSpan" id="kobo.1026.1">extends the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1027.1">Symfony\Component\Validator\ConstraintViolationListInterface</span></strong><span class="koboSpan" id="kobo.1028.1"> class provided by Symfony. </span><span class="koboSpan" id="kobo.1028.2">This adds Drupal-specific methods for filtering returned violations. </span><span class="koboSpan" id="kobo.1028.3">The following methods are available to filter </span><span class="No-Break"><span class="koboSpan" id="kobo.1029.1">the violations:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1030.1">getEntityViolations</span></strong><span class="koboSpan" id="kobo.1031.1">: Some violations may be at the entity level and not at the class level. </span><span class="koboSpan" id="kobo.1031.2">Constraints may be applied at the entity level and not to specific fields. </span><span class="koboSpan" id="kobo.1031.3">For example, the Workspaces module adds a constraint at the entity level to check for </span><span class="No-Break"><span class="koboSpan" id="kobo.1032.1">workspace conflicts.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1033.1">filterByFields</span></strong><span class="koboSpan" id="kobo.1034.1">: Given a series of field names, the violations are reduced to only those that apply to </span><span class="No-Break"><span class="koboSpan" id="kobo.1035.1">those fields.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1036.1">filterByFieldAccess</span></strong><span class="koboSpan" id="kobo.1037.1">: This filters the violations based on fields accessible only to the user. </span><span class="koboSpan" id="kobo.1037.2">Drupal allows saving entities in an invalid state, especially if a workflow allows a less privileged user to modify specific fields of an entity. </span><span class="koboSpan" id="kobo.1037.3">If using this filter, be cautious because the entity must have updated fields the user may not have had </span><span class="No-Break"><span class="koboSpan" id="kobo.1038.1">access to.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1039.1">The previous</span><a id="_idIndexMarker375"/><span class="koboSpan" id="kobo.1040.1"> methods always return a new object instance and do not have side effects on the original </span><span class="No-Break"><span class="koboSpan" id="kobo.1041.1">violations list.</span></span></p>
<h1 id="_idParaDest-208"><a id="_idTextAnchor237"/><span class="koboSpan" id="kobo.1042.1">Deleting an entity</span></h1>
<p><span class="koboSpan" id="kobo.1043.1">In this recipe, we will </span><a id="_idIndexMarker376"/><span class="koboSpan" id="kobo.1044.1">walk through deleting an entity. </span><span class="koboSpan" id="kobo.1044.2">Deleting an entity allows you to remove an entity from the database so that it no </span><span class="No-Break"><span class="koboSpan" id="kobo.1045.1">longer exists.</span></span></p>
<h2 id="_idParaDest-209"><a id="_idTextAnchor238"/><span class="koboSpan" id="kobo.1046.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.1047.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1048.1">delete</span></strong><span class="koboSpan" id="kobo.1049.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1050.1">ArticleController</span></strong><span class="koboSpan" id="kobo.1051.1"> controller in your module that has a parameter for the node entity object that will be provided by a </span><span class="No-Break"><span class="koboSpan" id="kobo.1052.1">route parameter:</span></span><pre class="console"><span class="koboSpan" id="kobo.1053.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.1054.1">
namespace Drupal\mymodule\Controller;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1055.1">
use Drupal\Core\Controller\ControllerBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1056.1">
use Drupal\node\NodeInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1057.1">
use Symfony\Component\HttpFoundation\JsonResponse;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1058.1">
use Symfony\Component\HttpFoundation\Request;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1059.1">
class ArticleController extends ControllerBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1060.1">
  public function delete(NodeInterface $node):</span></pre><pre class="console"><span class="koboSpan" id="kobo.1061.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1062.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.1063.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.1064.1">To delete an</span><a id="_idIndexMarker377"/><span class="koboSpan" id="kobo.1065.1"> entity, you will invoke the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1066.1">delete</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1067.1"> method:</span></span><pre class="console"><span class="koboSpan" id="kobo.1068.1">
  public function delete(NodeInterface $node):</span></pre><pre class="console"><span class="koboSpan" id="kobo.1069.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1070.1">
   $node-&gt;delete();</span></pre><pre class="console"><span class="koboSpan" id="kobo.1071.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1072.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1073.1">delete</span></strong><span class="koboSpan" id="kobo.1074.1"> method immediately removes the entity from the </span><span class="No-Break"><span class="koboSpan" id="kobo.1075.1">database storage.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1076.1">We will then return an empty </span><span class="No-Break"><span class="koboSpan" id="kobo.1077.1">JSON response:</span></span><pre class="console"><span class="koboSpan" id="kobo.1078.1">
  public function delete(NodeInterface $node):</span></pre><pre class="console"><span class="koboSpan" id="kobo.1079.1">
    JsonResponse {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1080.1">
   $node-&gt;delete();</span></pre><pre class="console"><span class="koboSpan" id="kobo.1081.1">
   return new JsonResponse(null, 204);</span></pre><pre class="console"><span class="koboSpan" id="kobo.1082.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1083.1">When no content is returned, we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1084.1">204 No Content</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1085.1">status code.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1086.1">We must create the route in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1087.1">routing.yml</span></strong><span class="koboSpan" id="kobo.1088.1"> that points to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1089.1">delete</span></strong><span class="koboSpan" id="kobo.1090.1"> method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1091.1">ArticleController</span></strong><span class="koboSpan" id="kobo.1092.1"> for an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.1093.1">DELETE</span></strong><span class="koboSpan" id="kobo.1094.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1095.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1096.1">articles/{node}</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1097.1"> path:</span></span><pre class="console"><span class="koboSpan" id="kobo.1098.1">
mymodule.delete_article:</span></pre><pre class="console"><span class="koboSpan" id="kobo.1099.1">
  path: /articles/{node}</span></pre><pre class="console"><span class="koboSpan" id="kobo.1100.1">
  defaults:</span></pre><pre class="console"><span class="koboSpan" id="kobo.1101.1">
   _controller: Drupal\mymodule\Controller\</span></pre><pre class="console"><span class="koboSpan" id="kobo.1102.1">
      ArticleController::delete</span></pre><pre class="console"><span class="koboSpan" id="kobo.1103.1">
  methods: [DELETE]</span></pre><pre class="console"><span class="koboSpan" id="kobo.1104.1">
  requirements:</span></pre><pre class="console"><span class="koboSpan" id="kobo.1105.1">
   _access: 'TRUE'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1106.1">This route should have </span><strong class="source-inline"><span class="koboSpan" id="kobo.1107.1">_entity_access: 'node.delete'</span></strong><span class="koboSpan" id="kobo.1108.1"> for its requirements. </span><span class="koboSpan" id="kobo.1108.2">However, we have used </span><strong class="source-inline"><span class="koboSpan" id="kobo.1109.1">_access: 'TRUE'</span></strong><span class="koboSpan" id="kobo.1110.1"> to bypass access checks for </span><span class="No-Break"><span class="koboSpan" id="kobo.1111.1">this recipe.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1112.1">Rebuild your</span><a id="_idIndexMarker378"/><span class="koboSpan" id="kobo.1113.1"> Drupal site’s cache to make it aware of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1114.1">new route:</span></span><pre class="console"><span class="koboSpan" id="kobo.1115.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.1116.1">An HTTP request such as the following can then be used to retrieve an article that is on your </span><span class="No-Break"><span class="koboSpan" id="kobo.1117.1">Drupal site:</span></span><pre class="console"><span class="koboSpan" id="kobo.1118.1">
DELETE http://localhost/articles/1</span></pre><pre class="console"><span class="koboSpan" id="kobo.1119.1">
Accept: application/json</span></pre></li>
<li><span class="koboSpan" id="kobo.1120.1">A second HTTP request to get the article will return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1121.1">404 Not Found</span></strong><span class="koboSpan" id="kobo.1122.1"> response since it has </span><span class="No-Break"><span class="koboSpan" id="kobo.1123.1">been deleted:</span></span><pre class="console"><span class="koboSpan" id="kobo.1124.1">
GET http://localhost/articles/1</span></pre><pre class="console"><span class="koboSpan" id="kobo.1125.1">
Accept: application/json</span></pre></li>
</ol>
<h2 id="_idParaDest-210"><a id="_idTextAnchor239"/><span class="koboSpan" id="kobo.1126.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.1127.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1128.1">delete</span></strong><span class="koboSpan" id="kobo.1129.1"> method on the entity class is delegated to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1130.1">delete</span></strong><span class="koboSpan" id="kobo.1131.1"> method on the entity type’s storage handler. </span><span class="koboSpan" id="kobo.1131.2">When a content entity is deleted, the storage purges all field values from the database and the entity’s database record. </span><span class="koboSpan" id="kobo.1131.3">Deletion is permanent and cannot </span><span class="No-Break"><span class="koboSpan" id="kobo.1132.1">be reversed.</span></span></p>
<p><span class="koboSpan" id="kobo.1133.1">When an entity is deleted, the entity storage fires invoke the following hooks, allowing you to hook into an</span><a id="_idIndexMarker379"/><span class="koboSpan" id="kobo.1134.1"> entity’s deletion. </span><span class="koboSpan" id="kobo.1134.2">The entity being deleted is passed as </span><span class="No-Break"><span class="koboSpan" id="kobo.1135.1">an argument:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1136.1">hook_ENTITY_TYPE_predelete</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1137.1">hook_entity_predelete</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1138.1">hook_ENTITY_TYPE_delete</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1139.1">hook_entity_delete</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1140.1">Throwing an exception in a hook will roll back the database transaction and prevent the entity from being deleted, but it may also crash Drupal if not </span><span class="No-Break"><span class="koboSpan" id="kobo.1141.1">handled appropriately.</span></span></p>
</div>
</body></html>