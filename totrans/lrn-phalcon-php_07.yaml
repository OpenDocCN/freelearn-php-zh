- en: Chapter 7. The Backoffice Module (Part 1)
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Unless you are developing a static website, you will need a section/module
    where an administrator can add and manage content, such as articles, categories,
    and users. This is where `Backoffice` comes into the picture. In this chapter,
    we will develop parts of the **CRUD** (**Create**, **Read**, **Update**, and **Delete**)
    operations needed to administrate our website. We will also use part of the API
    that we developed in [Chapter 5](ch05.html "Chapter 5. The API Module"), *The
    API Module*. We will play more with forms and validations. We will cover this
    chapter in two parts, namely:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: Hashtag CRUD
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Category CRUD
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Editing the main layout
  id: totrans-4
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Let''s start this chapter with some modifications to the main layout. Edit
    the main layout located at `modules/Backoffice/Views/Default/layout.volt` and
    add the following code:'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-6
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'You can see that we are using `include` to include two new files: `topbar.volt`
    and `sidebar.volt`. In Volt, you can use the `include` method or the `partial()`
    method. The main difference between `partial` and `include` is that a `partial`
    method is included in the runtime but an `include` file compiles the content and
    returns it as part of the view that was included. I prefer `include` because it
    improves performance. If you need to assign variables to a file that will be included,
    you need to avoid the file extension. Here is an example:'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-8
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Tip
  id: totrans-9
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: You can read more about `include` at [http://docs.phalconphp.com/en/latest/reference/volt.html#include](http://docs.phalconphp.com/en/latest/reference/volt.html#include).
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: The code for the two new files is the same code that resided in the main layout
    earlier but with a small modification for the sidebar. Let's create the folder
    and the files. Go to `modules/Backoffice/Views/Default/` and create a new folder
    named `common`. In this new folder, create two new files named `sidebar.volt`
    and `topbar.volt` with the following code.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: common/topbar.volt
  id: totrans-12
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Here is the code for the navigation bar that can be found at the top of the
    page. It contains a link to the home page and a link that is used to sign out:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-14
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: common/sidebar.volt
  id: totrans-15
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The following is the code for the sidebar (the left menu) and the code that
    contains the links to different controllers from our application:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-17
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: There is something new about these two files. We are making use of a method
    named `url()`, the sidebar has incorporated some logic, and we notice that the
    dispatcher from DI is available without the need to assign it from a controller.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
- en: By default, Volt has access to a number of methods. The `url()` method, which
    uses the URL service, is one of them. For a list of supported methods, you can
    check out the official documentation at [http://docs.phalconphp.com/en/latest/reference/volt.html#functions](http://docs.phalconphp.com/en/latest/reference/volt.html#functions).
    Sometimes, you need special functions that are not accessible from Volt. In such
    a case, you will need to extend the Volt engine and implement your own methods.
    How do you extend Volt?
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
- en: 'In our case, we can do it directly in the `voltService` DI, which can be found
    in `config/services.php`, for example, we want to add a method named `randomGen()`
    that generates a number of random strings, and it''s located in `modules/Core/Library/Util.php`.
    The `voltService` DI will look like this:'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'We will be able to call this method in Volt by using the following syntax:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-23
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: The preceding method will generate five random strings.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-25
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: You can learn more about extending Volt at [http://docs.phalconphp.com/en/latest/reference/volt.html#extending-volt](http://docs.phalconphp.com/en/latest/reference/volt.html#extending-volt).
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
- en: 'In the sidebar file (`sidebar.volt`), we use `IF` statements to check the name
    of the current controller. The name is available through the dispatcher, and we
    assign it to a variable named `c_name`. The equivalent PHP code for our `IF` statements
    and `set` is as follows:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Of course, there are other ways of generating the code for this menu, but try
    to use Volt as much as you can, so that you get used to the syntax. Now that we
    have made a few modifications, let''s access `http://www.learning-phalcon.localhost/backoffice/`.
    If there are no errors, you should see the same things as shown in the following
    screenshot:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
- en: '![common/sidebar.volt](img/B03522_07_01.jpg)'
  id: totrans-30
  prefs: []
  type: TYPE_IMG
- en: Cleaning the Core module
  id: totrans-31
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Let''s also clean our `Core` module. We will use this folder as a collection
    of libraries instead of using it as a module. First, remove the following files:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-33
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Then remove these lines from `modules/Bootstrap.php`:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Now we have a clean core and our bootstrap will not register it as part of
    our modules any more. We will make modifications to `modules/Core/Controllers/BaseController.php`
    and `modules/Backoffice/Controllers/BaseController.php` so that this controller
    will extend `modules/Core/Controllers/BaseController.php`:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
- en: 'In the `modules/Api/Controllers/BaseController.php` file:'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-38
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'In the `modules/Backoffice/Controllers/BaseController.php` file:'
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-40
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE10]'
- en: These modifications help us reuse some code in all our modules.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
- en: Hashtag CRUD
  id: totrans-42
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The reason we leave articles at the end is that when we implement it, we will
    need to assign hashtags, categories, and users to it. Before going further, we
    will make a slight modification to `layout.volt` and `BaseController`. We will
    remove this line from `BaseController.php`:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Also, we will add this line to `layout.volt`, right before `{{` `assets.outputCss(''headerCss'')`
    `}}`:'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-46
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: We are doing this because the CSS for bootstrap is already minified, and if
    we do it again, the bootstrap fonts will not be rendered correctly. Remember to
    apply the same modification to `layout_simple.volt`.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
- en: In [Chapter 5](ch05.html "Chapter 5. The API Module"), *The API Module*, when
    we developed the API module, one of our tasks was to create the rest of the required
    models and managers. They included the hashtag manager and models. If you didn't
    do this, don't worry. You have it in the source code. Here, I will show you just
    the part of the code that we need in order to develop CRUD operations for hashtags.
    The first thing that you have to do is create the controller in the API module,
    if you haven't done so already.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
- en: The hashtag controller within the API module
  id: totrans-49
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'All the methods found in this controller follow the same logic:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
- en: We retrieve an instance of the hashtag manager
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: We get parameters from the request object
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: We call its specific API method and send the response
  id: totrans-53
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Let''s write the code for this controller. We will start with `listAction()`.
    All the methods are written between the `try{}-catch(){}` statements:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'This method calls the hashtag manager and it reads the page number from the
    request. Next, we output the result of the `$manager->restGet()` method, which
    is an array of records with **pagination**:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'This method is mostly similar to `listAction()`, the difference being that
    it will only return one record. Notice that we bind the ID of the requested object
    to the `$manager->restGet()` method:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'This method calls the hashtag manager and it reads the page number and content
    from the request. If the body that we are posting is in the JSON format, we will
    read it with `getJsonRawBody()`. The `true` parameter is used to convert data
    into arrays. If we don''t have data, we throw an exception. Next, we output the
    result of the `$manager->restUpdate()` method:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'The `deleteAction()` method simply calls `$manager->restDelete()` with the
    ID of the object as the argument. If the object is found, it will be deleted:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: This method is similar to `updateAction()`, but instead of updating an object,
    it creates it.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
- en: 'The routing is missing, so we are going to add it to `modules/Api/Config.routing.php`.
    We will create a new routing group for hashtags:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-66
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'If everything is okay, you can now insert a few records into the hashtag table
    and call the API to get the records by using the following command line:'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-68
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'The output of the command line should be similar to what is shown in the following
    screenshot:'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
- en: '![The hashtag controller within the API module](img/B03522_07_02.jpg)'
  id: totrans-70
  prefs: []
  type: TYPE_IMG
- en: This cURL command makes a request to `/api/v1/hashtags`. The `-H` option is
    used to send header information; in our case, we send the token and the API key.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
- en: A common method to reduce code duplication
  id: totrans-72
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Let''s create a method in `modules/Core/Controllers/BaseController.php` that
    will help us get data from our API. This method will be available within the controllers
    that extend it:'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-74
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: Retrieving the data
  id: totrans-75
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'To get the data, we just need to provide the URL and extra parameters, if needed.
    With the help of Phalcon''s built-in cURL provider, we make the call. Next, we
    create a hashtag controller in the `Backoffice` module. It will look like this:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: As you can see, the only thing that we do here is call the API's URL, and it
    returns an array of paginated items.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
- en: The layout structure
  id: totrans-79
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Creating the layout for this listing is quite simple. Go to `modules/Backoffice/Views/Default`
    and create a new folder named `hashtag`. In this new folder, create a new file
    named `list.volt` with the following content:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-81
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Before ending the block of the code for the list template, we include another
    template named `paginator`. This is the paginator that will help us navigate through
    records. Create a file named `paginator.volt` in `modules/Backoffce/Views/Default/common/`
    and write this code in it:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: Tip
  id: totrans-84
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The preceding code makes use of the paginator variables that are already available
    (see [http://docs.phalconphp.com/en/latest/reference/pagination.html](http://docs.phalconphp.com/en/latest/reference/pagination.html)).
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
- en: 'Now, you can authenticate and access the hashtags listing at `http://www.learning-phalcon.localhost/backoffice/hashtag/list`.
    You should be able to see something similar to what is shown in the next screenshot:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
- en: '![The layout structure](img/B03522_07_03.jpg)'
  id: totrans-87
  prefs: []
  type: TYPE_IMG
- en: Let's continue with the rest of the actions (create, delete, and update). There
    are several ways to achieve this, but we will *not* make use of our API for create
    and update, mainly because of the time needed to cover all the aspects, and also
    because doing it the "old normal way" is faster. However, you can play with the
    idea and try to migrate these two actions to be API-driven.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
- en: The hashtag form
  id: totrans-89
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'For create and update, I like to use forms because it''s easier to maintain
    the code and also to validate it. We will start with the `create` action by writing
    the code for the create form (the same form will be used for update). Switch to
    `modules/Core/Forms` and create a new file named `HashtagForm.php` with the following
    code:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  id: totrans-91
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'Our new form is quite simple. We have three elements: the name of the hashtag,
    a `csrf` field, and a **Submit** button. We validate the name and the `csrf` field
    with the help of two validators: `PresenceOf` and `Identical`.'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
- en: The hashtag controller
  id: totrans-93
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We continue by writing the code for the `create` action and for the template.
    Open `modules/Backoffice/Controllers/HashtagController.php` and add these two
    methods:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  id: totrans-95
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: The `addAction()` method simply renders the form we just created. The processes
    of creation and validation take place in the `createAction()` method. This method
    accepts only `POST` data, as you can see in the first two lines. When you're working
    on a big project, you might want to use custom routes, just as we did in the API
    module.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
- en: The hashtag manager
  id: totrans-97
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'You might notice a new method named `getForm()` in the hashtag manager. This
    method returns an instance of `HashtagForm` and it looks like this:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'If you have already created the hashtag manager, you should have a `create()`
    method similar to this one:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  id: totrans-101
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: The View template for the add() method
  id: totrans-102
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We also need to write the code for the template. Create a new file named `add.volt`
    in `modules/Backoffice/Views/Default/hashtag` and add the following code:'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  id: totrans-104
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'Our template extends `layout.volt` and renders the hashtag form elements. At
    this point, you should be able to add a new hashtag from your `Backoffice` module.
    Open `http://www.learning-phalcon.localhost/backoffice/hashtag/add`, fill in the
    name for the hashtag, and click on the **Add** button, like this:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
- en: '![The View template for the add() method](img/B03522_07_04.jpg)'
  id: totrans-106
  prefs: []
  type: TYPE_IMG
- en: If the hashtag was saved correctly, you will be redirected to a hashtags list
    page, otherwise an error message will be shown.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
- en: Improving the database table structure and adding validation
  id: totrans-108
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Now that we can add hashtags, we will face a problem, because we are able to
    add duplicated hashtags. To fix this, we will make a small change to our hashtags
    table and implement a new validator in the hashtag model.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
- en: 'The change that we will apply to this table is meant to make the `name` field
    unique. Do this by executing the following SQL query against your database:'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  id: totrans-111
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'If you try to add a new hashtag, you will get an **Integrity constraint violation**
    error. This is good enough to avoid duplicates in your database, but you will
    need to implement a more human-friendly error by making use of `Phalcon\Mvc\Model\Validator\Uniqueness`.
    Open the hashtag model and append the following code:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  id: totrans-113
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: This is it! If you try to add the same hashtag, you will get an error message
    saying **This hashtag already exists**. We can now continue with the edit/update
    methods for the hashtags.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
- en: Editing hashtags
  id: totrans-115
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Editing follows the same workflow as creating, except that we need to search
    for an existing object to edit. Let''s first create the `update()` method in `modules/Core/Managers/HashtagManager.php`:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'As you can see, there are only two differences between `update()` and `create()`.
    One is that we searched for a hashtag based on its ID, and the second is that
    we changed the second parameter from `$this->save()` to `update`. The template
    is the same as that for the `create()` method. Create a new file named `edit.volt`
    in `modules/Backoffice/Views/Default/hashtag` with the following code:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE32]'
  id: totrans-119
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: 'The only modification that we have done here is that we changed the `<h1>`
    title from `Add` to `Edit`. We can now switch to `HashtagController` and create
    two new methods, `editAction()` and `updateAction()`:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE33]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'In this method, we search for an object and output an error message if we can''t
    find it. If it is found, we save the ID in a persistent bag (when using persistent
    bags, data is temporarily saved in the session and removed the first time you
    get the variable) and then assign the object to the form to be rendered. The `updateAction()`
    method looks like this:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE34]'
  id: totrans-123
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'The main difference between this method and the `createAction()` method is
    that we get the object ID from the persistent bag and search for it. The final
    step is to create a link from the listing page to the edit page. Update `list.volt`
    and replace the current `edit` link with this code:'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE35]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: This is it! You can now access `http://www.learning-phalcon.localhost/backoffice/hashtag/list`,
    click on the **Edit** button of an existing record, and try to edit (change the
    name).
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
- en: Deleting hashtags
  id: totrans-127
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We can move forward and write the code for the last step in this process—deletion.
    Deletion is very simple and quick. We will use an intermediate page so that a
    user can confirm when they want to delete an object. Let''s start by writing the
    code for the template. Create a new file named `delete.volt` in the `hashtag`
    folder and write this code:'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE36]'
  id: totrans-129
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'This template has a simple form. When a user clicks on the **Yes, delete**
    button, the actual deletion takes place. Switch to `HashtagController.php` and
    create a method named `deleteAction()`:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: 'By default, the `deleteAction($id)` method only renders its template (`delete.volt`).
    When we confirm the deletion, we make a post and delete the record. If you haven''t
    already written the code for the `delete()` method from manager, here is what
    it should look like:'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE38]'
  id: totrans-133
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: 'In the final step, we need to update the `list.volt` template to create a link
    to the delete page. Open `hashtag/list.volt` and replace the `delete` link with
    this one:'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE39]'
  id: totrans-135
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: 'This is pretty much all there is to know about deleting. You can test it by
    clicking on the **Delete** link from the list. You should see exactly the same
    output as presented in the next screenshot:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
- en: '![Deleting hashtags](img/B03522_07_05.jpg)'
  id: totrans-137
  prefs: []
  type: TYPE_IMG
- en: 'If you click on **Cancel**, you should be redirected to the listing page. If
    you click on **Yes, delete** and there are no errors, you will be redirected to
    the listing page and the following success message will be shown: **Item has been
    deleted successfully**. We will now continue with CRUD development for categories.'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
- en: Category CRUD
  id: totrans-139
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'When we created the architecture for category tables, we added a `category_translation`
    table. We will alter this table and add a unique index to avoid duplicates for
    the same country code and category ID. Execute the following query:'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE40]'
  id: totrans-141
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: 'We will add a new array to the `config/config.php` global configuration file
    that will hold information about `i18n`:'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE41]'
  id: totrans-143
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: The Category form
  id: totrans-144
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We will now create the form for the add/edit categories. Create a new file
    in `modules/Core/Forms/`, name it `CategoryForm.php`, and write the following
    code:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE42]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: 'In this form, we automatically add the required fields based on the available
    locales. If we edit a record, we need to retrieve the translations and assign
    the correct values to each field. We use the array naming style for easy processing.
    This means that the name of the generated field will look like this: `translations[en][category_translation_name]`.'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, we need to assign the available locales to the view. Open `BaseController.php`
    from `modules/Backoffice/Controllers/` and append the following line to the `afterExecuteRoute()`
    method:'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  id: totrans-149
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: Creating the Category templates
  id: totrans-150
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Let's see how our templates will look. Create a new folder in `modules/Backoffice/Views/Default`
    and name it `category`. In this new folder, create the `list.volt`, `add.volt`,
    `edit.volt`, and `delete.volt` template files. The following sections contain
    the code for each file.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
- en: list.volt
  id: totrans-152
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Usually, listing is pretty much the same for any section. Here is the `list.volt`
    template file for `Category`:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  id: totrans-154
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: add.volt
  id: totrans-155
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The only important thing to notice in this template is how we render the elements.
    We loop through the `locales` variable that we assigned from `BaseController.php`,
    and for each locale, we render the element:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE45]'
  id: totrans-157
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: edit.volt
  id: totrans-158
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The `edit.volt` file is mostly the same as `add.volt`. We just need to change
    the form action to `{{ url('category/update') }}`. If you know that you're not
    going to develop a complex system, you can use the same file for add/edit. Personally,
    I prefer to use two separate files because it happened to me many times that the
    complexity of editing was very high compared to adding.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
- en: delete.volt
  id: totrans-160
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'This is the simplest template, but for the same reason as for add/edit, I prefer
    to keep these files separate:'
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE46]'
  id: totrans-162
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: Note
  id: totrans-163
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'If you want, and if you don''t have any complex operations, you can create
    a `delete.volt` file in the `common/` folder and include it from there for all
    sections. Here is an example of how you can do so:'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE47]'
  id: totrans-165
  prefs: []
  type: TYPE_PRE
  zh: '[PRE47]'
- en: Creating the Category controller
  id: totrans-166
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Now that we have the code for the templates, let''s create the controller.
    Switch to `modules/Backoffice/Controllers/` and create a new file named `CategoryController.php`
    with the following code:'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE48]'
  id: totrans-168
  prefs: []
  type: TYPE_PRE
  zh: '[PRE48]'
- en: If you check out the `updateAction()` and `createAction()` methods, you will
    notice that we use `$post_data` as it is. We can do it this way because the form
    fields have the array-style name, so we send the data in exactly the same format
    that the manager expects.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
- en: The `editAction()` method renders the form to edit a record. Notice the second
    parameter from `$manager->getForm()`. It is an array containing the `edit` key
    and the `true` value, which we use in `CategoryForm.php`.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
- en: Creating the Category manager
  id: totrans-171
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We are missing the manager. Create a new file named `CategoryManager.php` in
    `modules/Core/Managers/CategoryManager.php` with the following content:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE49]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE49]'
- en: 'We need to enable this manager. Add the following code to `config/managers.php`:'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE50]'
  id: totrans-175
  prefs: []
  type: TYPE_PRE
  zh: '[PRE50]'
- en: 'That''s all! You can now access `http://www.learning-phalcon.localhost/backoffice/category/list`
    and you should see something similar to this:'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating the Category manager](img/B03522_07_06.jpg)'
  id: totrans-177
  prefs: []
  type: TYPE_IMG
- en: 'If you don''t have any records, click on the **+ New** button to create a new
    category. This action will render the template for `add.volt` and you will see
    the following screenshot:'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating the Category manager](img/B03522_07_07.jpg)'
  id: totrans-179
  prefs: []
  type: TYPE_IMG
- en: This is it! You can check out the source code for this chapter and play with
    the API with different categories. Note that the API documentation is always available
    in `docs/api/index.html`.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 就这样！你可以查看本章的源代码，并使用不同类别来尝试 API。请注意，API 文档始终可在 `docs/api/index.html` 中找到。
- en: Summary
  id: totrans-181
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, we developed a functional CRUD for hashtags and categories.
    You learned how to make API calls and render form elements dynamically.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们为标签和类别开发了一个功能性的 CRUD。你学习了如何进行 API 调用和动态渲染表单元素。
- en: In the next chapter, we will focus on completing the `Backoffice` module (developing
    CRUD for articles and users). We will continue to develop this module by writing
    code for the user and article CRUD.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将专注于完成“后台”模块（为文章和用户开发 CRUD）。我们将通过编写用户和文章 CRUD 的代码来继续开发这个模块。
