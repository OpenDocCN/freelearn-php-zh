<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Database Concepts"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Database Concepts</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Finding your way in the tables</li><li class="listitem" style="list-style-type: disc">Creating a database connection in Magento</li><li class="listitem" style="list-style-type: disc">Working with flat tables</li><li class="listitem" style="list-style-type: disc">Working with EAV tables</li><li class="listitem" style="list-style-type: disc">Configuring a Master/Slave setup</li><li class="listitem" style="list-style-type: disc">Repairing the database</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec38"/>Introduction</h1></div></div></div><p>Magento has a very large database model to store all kinds of information. There are many Magento modules. Every module has its own tables in the database. A naming convention is used to provide a good overview in the database. Some modules use a flat database model (one table per entity), while other modules use the <span class="strong"><strong>EAV</strong></span> (<span class="strong"><strong>Entity Attribute Value</strong></span>) database model. The recipes in this chapter <a id="id203" class="indexterm"/>will cover the most important things you need to know when you are working with a database.</p></div></div>
<div class="section" title="Finding your way in the tables"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec39"/>Finding your way in the tables</h1></div></div></div><p>When you look at the tables, you will realize that the number of tables is very high. In a standard installation, there are more than 300 database tables. A structured naming convention is needed to find your way in this maze of tables.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec94"/>Getting ready</h2></div></div></div><p>In this recipe, we will make some queries to the database to get an idea of the tables and their purpose.</p><p>Here, you have to firstly make a connection with your database client using <span class="strong"><strong>phpMyAdmin</strong></span>.<a id="id204" class="indexterm"/>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec95"/>How to do it...</h2></div></div></div><p>In the next steps, we will learn some methods to familiarize you with the <a id="id205" class="indexterm"/>database model<a id="id206" class="indexterm"/> in Magento:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Get a list of the core modules. You can do this by running the <code class="literal">ls –l</code> command in the <code class="literal">app/code/core/Mage</code> folder. This will give you the following output: <div class="informalexample"><pre class="programlisting">drwxrwxr-x  7 www-data www-data Admin
drwxrwxr-x  8 www-data www-data Adminhtml
drwxrwxr-x  6 www-data www-data AdminNotification
drwxrwxr-x  8 www-data www-data Api
drwxrwxr-x  8 www-data www-data Api2
drwxrwxr-x  7 www-data www-data Authorizenet
drwxrwxr-x  5 www-data www-data Backup
drwxrwxr-x  9 www-data www-data Bundle
drwxrwxr-x  8 www-data www-data Captcha
drwxrwxr-x  9 www-data www-data Catalog
drwxrwxr-x  5 www-data www-data CatalogIndex
drwxrwxr-x  7 www-data www-data CatalogInventory
drwxrwxr-x  6 www-data www-data CatalogRule
drwxrwxr-x  8 www-data www-data CatalogSearch
drwxrwxr-x  7 www-data www-data Centinel
drwxrwxr-x  9 www-data www-data Checkout
drwxrwxr-x 10 www-data www-data Cms
drwxrwxr-x  7 www-data www-data Compiler
drwxrwxr-x  7 www-data www-data Connect
drwxrwxr-x  7 www-data www-data Contacts</pre></div></li><li class="listitem">Run the <a id="id207" class="indexterm"/><code class="literal">SHOW TABLES</code> command on your database. This will give the following result in phpMyAdmin:<div class="mediaobject"><img src="graphics/3329OS_05_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Compare the first part of the table names with the module list. You will see that the name of every table starts with the name of the module.</li><li class="listitem">Go to phpMyAdmin<a id="id208" class="indexterm"/> and navigate to the <span class="strong"><strong>Designer</strong></span> tab of the database. This page will render a database schema with all the database tables in Magento.</li><li class="listitem">You can limit the<a id="id209" class="indexterm"/> result by checking the tables you want to see in the left column. Uncheck all the tables and check the core tables. These are the tables starting with <code class="literal">core_*</code>. This will give you an overview of the relationships between the core tables, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_05_03.jpg" alt="How to do it..."/></div></li><li class="listitem">In the previous screenshot, we see that there are a lot of relations starting from the <code class="literal">core_store</code><a id="id210" class="indexterm"/> table. Let's have a look at the structure of this table. You can do this by clicking on the <span class="strong"><strong>Relation view</strong></span> link in the <a id="id211" class="indexterm"/><span class="strong"><strong>Structure</strong></span> tab of the <code class="literal">core_store</code> table. This gives the following output:<div class="mediaobject"><img src="graphics/3329OS_05_04.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec96"/>How it works...</h2></div></div></div><p>The Magento database is just like any database with tables and relations between them. The difficulty is that there are so many tables that make a simple overview very difficult.</p><p>You don't need to know the whole structure of the database while working. With the <a id="id212" class="indexterm"/>
<span class="strong"><strong>Designer</strong></span> option<a id="id213" class="indexterm"/> in phpMyAdmin, you can show the tables you want to see.</p><p>Most of the tables in the database represent entities in Magento. These entities (models) are connected with the database using the Magento framework. This framework uses collections to do<a id="id214" class="indexterm"/> select queries on the database. These collections will generate a <code class="literal">Zend_Db_Statement</code> object that generates SQL queries.</p><p>The purpose of these collections is that they return instances of Magento models. A SQL or Zend DB query will return an array with data.</p></div></div>
<div class="section" title="Creating a database connection in Magento"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec40"/>Creating a database connection in Magento</h1></div></div></div><p>Magento uses resources to connect to a database. By default, Magento uses one connection to interact with the database. In this connection, there are resources declared in the <code class="literal">config.xml</code> files of the modules to link the models with the right table.</p><p>In this recipe, we will use<a id="id215" class="indexterm"/> a Magento connection to read some tables and we will learn how to configure a second connection to another database, such as a<a id="id216" class="indexterm"/> third-party system.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec97"/>Getting ready</h2></div></div></div><p>Navigate to <code class="literal">IndexController</code> of the <code class="literal">Packt_Helloworld</code> module that we created in <a class="link" href="ch04.html" title="Chapter 4. Creating a Module">Chapter 4</a>, <span class="emphasis"><em> Creating a Module</em></span>. We will test some connections in the <code class="literal">indexController</code>. </p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec98"/>How to do it...</h2></div></div></div><p>In the following steps, we will explain how to work with multiple database connections in your script:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Paste the following code in the <code class="literal">indexAction</code> method:<div class="informalexample"><pre class="programlisting">$resource = Mage::getSingleton('core/resource');
$connection = $resource-&gt;getConnection('core_read');

$results = $connection-&gt;query('SELECT * FROM core_store')-&gt;fetchAll();

Zend_Debug::dump($results);</pre></div><p>This query will return an array of the values in the <code class="literal">core_store</code> table.</p></li><li class="listitem">Reload the<a id="id217" class="indexterm"/> <code class="literal">indexAction</code> method in the frontend. You will see all the values from the <code class="literal">core_store</code> table like the following code:<div class="informalexample"><pre class="programlisting">array(4) {
  [0] =&gt; array(7) {
    ["store_id"] =&gt; string(1) "0"
    ["code"] =&gt; string(5) "admin"
    ["website_id"] =&gt; string(1) "0"
    ["group_id"] =&gt; string(1) "0"
    ["name"] =&gt; string(5) "Admin"
    ["sort_order"] =&gt; string(1) "0"
    ["is_active"] =&gt; string(1) "1"
  }
  [1] =&gt; array(7) {
    ["store_id"] =&gt; string(1) "1"
    ["code"] =&gt; string(7) "default"
    ["website_id"] =&gt; string(1) "1"
    ["group_id"] =&gt; string(1) "1"
    ["name"] =&gt; string(7) "English"
    ["sort_order"] =&gt; string(1) "0"
    ["is_active"] =&gt; string(1) "1"
  }
...</pre></div></li><li class="listitem">Create a new connection. For example, we will make some queries on a second Drupal database. Paste the following code in the <a id="id218" class="indexterm"/><code class="literal">indexAction</code> method and modify the connection parameters with your credentials:<div class="informalexample"><pre class="programlisting">$dbConfig = array(
    'host' =&gt; 'localhost',
    'dbname' =&gt; 'drupal',
    'username' =&gt; 'drupal_web',
    'password' =&gt; 'drupal_pwd',
);
$_resource = Mage::getSingleton('core/resource');

//Create the connection
$connection = $_resource-&gt;createConnection('drupalConnection', 'pdo_mysql', $dbConfig);
$results = $connection-&gt;query('SELECT * FROM node')-&gt;fetchAll();

Zend_Debug::dump($results);</pre></div></li><li class="listitem">Reload<a id="id219" class="indexterm"/> your frontend and you will see the result of your previous query. The previous piece of code will make a connection to an external database using the Magento connection.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec99"/>How it works...</h2></div></div></div><p>The database connections<a id="id220" class="indexterm"/> in Magento are managed by the <code class="literal">Mage_Core_Model_Resource</code> model. By using the<a id="id221" class="indexterm"/> <span class="strong"><strong>singleton</strong></span> pattern to load the class, the connection is made once per process.</p><p>To get an instance of a model, you can use the <code class="literal">Mage::getModel()</code> function, which returns a new instance of the object. By using the <code class="literal">Mage::getSingleton()</code> function, an instance of the object given in the first parameter is returned. However, once the model is declared, Magento doesn't <a id="id222" class="indexterm"/>create a new instance but returns the existing instance of the object.</p></div></div>
<div class="section" title="Working with flat tables"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec41"/>Working with flat tables</h1></div></div></div><p>Magento has two types of entities while working with the databases:<a id="id223" class="indexterm"/> <span class="strong"><strong>flat</strong></span> entities and <span class="strong"><strong>EAV</strong></span> entities.</p><p>Flat tables works with<a id="id224" class="indexterm"/> fields that represent columns in a database table. EAV tables, which are described in the next chapter, will use attributes. In this recipe, we will concentrate on flat tables.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec100"/>Getting ready</h2></div></div></div><p>In this recipe, we will make some example queries on flat tables. Open the <code class="literal">IndexController</code> from the <code class="literal">Packt_Helloworld</code> module and create a <code class="literal">flatAction()</code> method<a id="id225" class="indexterm"/> in it. This controller action will be used to trigger the example queries.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec101"/>How to do it...</h2></div></div></div><p>In the next set of instructions, we will show you how a flat table from the database is linked to a Magento model:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Have a look at the review tables. You can do this by filtering them in the phpMyAdmin table names.<div class="mediaobject"><img src="graphics/3329OS_05_05.jpg" alt="How to do it..."/></div></li><li class="listitem">Get all the data from the <code class="literal">review_detail</code> table. You can do this by clicking on the table.</li><li class="listitem">Print the same data by selecting it in the Magento code. To do this, paste the following code in your <a id="id226" class="indexterm"/><code class="literal">flatAction</code> method:<div class="informalexample"><pre class="programlisting">$resource = Mage::getSingleton('core/resource');
$connection = $resource-&gt;getConnection('core_read');

$results = $connection-&gt;query('SELECT * FROM review_detail')-&gt;fetchAll();

Zend_Debug::dump($results);</pre></div><p>While executing this code, an array of values is returned.</p></li><li class="listitem">We can get the same<a id="id227" class="indexterm"/> result by working with the Magento collections. You can do this by running the following code:<div class="informalexample"><pre class="programlisting">$reviews = Mage::getModel('review/review')-&gt;getCollection();

foreach ($reviews as $_review) {
    Zend_Debug::dump($_review-&gt;debug());
}</pre></div></li><li class="listitem">This code will give the same output, but the data of a collection is coming from objects and not directly from the database. The purpose of this is that we can directly call functions on the object.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip22"/>Tip</h3><p>When working with Magento database tables, it is recommended to use the collections instead of a direct SQL query. More information about the Magento collection is described in the <span class="emphasis"><em>Working with Magento collections</em></span> recipe from <a class="link" href="ch06.html" title="Chapter 6. Databases and Modules">Chapter 6</a>, <span class="emphasis"><em>Databases and Modules</em></span>. </p></div></div></li><li class="listitem">Print the URLs of the reviews on the screen. We can do this simply by calling the <code class="literal">getReviewUrl()</code> function<a id="id228" class="indexterm"/> on the <code class="literal">review</code> entities. Add the following code in each loop:<div class="informalexample"><pre class="programlisting">echo $_review-&gt;getReviewUrl().'&lt;br/&gt;';</pre></div></li><li class="listitem">While reloading<a id="id229" class="indexterm"/> the page, you will see that all the URLs of the reviews are printed. The logic of the URL structure is done in the <code class="literal">Mage_Review_Model_Review</code> class<a id="id230" class="indexterm"/>, which represents a <code class="literal">review</code> entity.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec102"/>How it works...</h2></div></div></div><p>Working with flat tables in Magento is not so difficult. When using the Magento framework, a flat entity consists of the following parts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The database table</strong></span>: The database<a id="id231" class="indexterm"/> table is used to store the information of the entity. This database table can have relations to different tables in the Magento database, such as a relation with a product.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The model object</strong></span>: The model <a id="id232" class="indexterm"/>object is a class where an instance is returned while loading a row from the database table. This class can have methods with business logic, such as the <code class="literal">getReviewUrl()</code> function<a id="id233" class="indexterm"/> in this recipe.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The resource model object</strong></span>: The resource <a id="id234" class="indexterm"/>model is a class that connects the model with the database table. This class will handle, for example, the <code class="literal">save()</code> method<a id="id235" class="indexterm"/>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The resource collection object</strong></span>: The resource collection<a id="id236" class="indexterm"/> object is a class that makes it possible to work with Magento collections for an entity.</li></ul></div></div></div>
<div class="section" title="Working with EAV tables"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec42"/>Working with EAV tables</h1></div></div></div><p>The EAV table is a database model that<a id="id237" class="indexterm"/> is used for some entities in Magento. In this recipe, we will explore the details of the EAV implementation in Magento.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec103"/>Getting ready</h2></div></div></div><p>The EAV pattern is used for some entities in Magento such as the product entity. In this recipe, we will make some queries for updating a product using SQL queries. Open your database client and prepare yourself for running some complex queries.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec104"/>How to do it...</h2></div></div></div><p>The following steps<a id="id238" class="indexterm"/> show you how you can create a query to return the data of a Magento EAV model:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The Magento EAV entities are declared in the <code class="literal">eav_entity_type</code> table. Run the following query to see which EAV entities are available:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>SELECT * FROM eav_entity_type;</strong></span>
</pre></div><p>Remember the ID of the <code class="literal">catalog_product</code> entity.</p></li><li class="listitem">To get the attributes related to a product, we have to look in the <code class="literal">eav_attribute</code> table. To see which attributes are related to a product, we have to run the following query:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>SELECT * FROM eav_attribute WHERE entity_type_id = 10</strong></span>
</pre></div><p>Make sure <code class="literal">10</code> is the entity type ID for <code class="literal">catalog_product</code>.</p></li><li class="listitem">Now we have the entity and attributes, so the value is the next part to find out. Find a product in the backend and remember the ID. For example, the product <code class="literal">HTC Touch Diamond</code> with the ID <code class="literal">166</code>. </li><li class="listitem">Select the product from the <code class="literal">catalog_product_entity</code> table by running the following query:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>SELECT * FROM catalog_product_entity WHERE entity_id = 166;</strong></span>
</pre></div></li><li class="listitem">The last query will only return the entity information of this product. To get the information for an attribute, such as <code class="literal">name</code>, we have to look in the <code class="literal">value</code> table. For the <code class="literal">name</code> attribute, the <code class="literal">value</code> table is <code class="literal">catalog_product_entity_varchar</code>. Run the following query to get all the <code class="literal">varchar</code> attribute values for the product:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>SELECT * FROM catalog_product_entity_varchar WHERE entity_id = 166</strong></span>
</pre></div></li><li class="listitem">The previous query gives the following result:<div class="mediaobject"><img src="graphics/3329OS_05_06.jpg" alt="How to do it..."/></div></li><li class="listitem">With this result, you can recognize the name of the product. If you look at the attribute ID of the row and match the attribute ID with the one in the <code class="literal">eav_attribute</code> table, you will see that this refers to the <code class="literal">name</code> attribute.</li><li class="listitem">To update the<a id="id239" class="indexterm"/> name of the product, make an update query on the row as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>UPDATE catalog_product_entity_varchar SET value = 'HTC Touch Diamond sql' WHERE value_id = 1131;</strong></span>
</pre></div><p>See that the <code class="literal">value_id</code> value matches the value ID of your previous result.</p></li><li class="listitem">Reload the product in the backend, and you will see that the name of the product is updated.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec105"/>How it works...</h2></div></div></div><p>EAV entities in Magento are declared in the <code class="literal">eav_entity_type</code> table and the attributes are declared in the <code class="literal">eav_attribute</code> table.</p><p>Like every entity, each EAV entity has its own base table. In this base table, the primary fields are declared as columns in this table. All the other fields are declared as attributes in the <code class="literal">eav_attribute</code> table.</p><p>Every attribute is of a specific type such as <code class="literal">int</code>, <code class="literal">varchar</code>, <code class="literal">date</code>, <code class="literal">time</code>, <code class="literal">decimal</code>, and <code class="literal">text</code>. The place where these <a id="id240" class="indexterm"/>values are stored depends on the entity type and is declared in the configuration files of Magento.</p><p>The following screenshot shows<a id="id241" class="indexterm"/> the structure of the EAV tables for a product:</p><div class="mediaobject"><img src="graphics/3329OS_05_07.jpg" alt="How it works..."/></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec106"/>There's more...</h2></div></div></div><p>Not all EAV entities work with multiple tables by entity. For example, the <code class="literal">sales_flat_*</code> tables are all EAV tables, but they are, as their name suggests, flat. This means that all the attributes of the entity are set in a separate column of the flat table.</p><p>In the catalog configuration, you have the ability to enable the <span class="strong"><strong>Flat catalog</strong></span> option for the tables for category and products. When this configuration is enabled, Magento will sync all the data from the EAV tables to the <code class="literal">catalog_flat_*</code> tables and will load the data from there.</p><p>When the <a id="id242" class="indexterm"/>
<span class="strong"><strong>Flat catalog</strong></span> option is enabled, you get a better performance because a <code class="literal">select</code> query on a single table is faster than getting the data from the different tables. The advantage is a better performance, but on the other hand, there are some disadvantages that could be a problem with a large amount of products and categories.</p><p>The Master data will be stored in the EAV tables. This means there is synchronization between the flat tables. This process is implemented as a <a id="id243" class="indexterm"/>
<span class="strong"><strong>Magento Index Process</strong></span>. When there are a lot of products and categories, this process can run very long. Another thing is that the size of the database can <a id="id244" class="indexterm"/>explode because the data is stored twice.</p></div></div>
<div class="section" title="Configuring a Master/Slave setup"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec43"/>Configuring a Master/Slave setup</h1></div></div></div><p>
<span class="strong"><strong>Database replication</strong></span> is used <a id="id245" class="indexterm"/>when you want to scale your infrastructure to serve more requests. There are a lot of methods available to scale your database to set up replication. The exact choice is different for every situation.</p><p>In this recipe, we will use a generic setup to create a Master/Slave setup for our Magento store. This setup will use a Master database server where all the <code class="literal">write</code> queries will be saved. The Slave database server(s) will be used for the <code class="literal">read</code> queries. The database is the most difficult component of an application to scale.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec107"/>Getting ready</h2></div></div></div><p>To complete the Master/Slave setup, we will use two different MySQL servers. Get the connection information such as hostname, IP addresses, username, and passwords.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec108"/>How to do it...</h2></div></div></div><p>Here, we will set up a <a id="id246" class="indexterm"/>Master/Slave replication in MySQL and configure Magento to use this setup. Have a look at the following steps:</p><div class="section" title="Setting up the Master database"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec09"/>Setting up the Master database</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to the server with SSH and open the <code class="literal">/etc/mysql/my.cnf</code> file.</li><li class="listitem">Look for the <code class="literal">bind-address</code> section in the file and comment it out. By commenting this, you make<a id="id247" class="indexterm"/> it possible to make connections from different servers:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>#bind-address = 127.0.0.1</strong></span>
</pre></div></li><li class="listitem">Paste the following code in the <code class="literal">my.cnf</code> file under the <code class="literal">[mysqld]</code> section:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>server-id = 1</strong></span>
<span class="strong"><strong>log_bin = /var/log/mysql/mysql-bin.log</strong></span>
<span class="strong"><strong>expire_logs_days = 10</strong></span>
<span class="strong"><strong>max_binlog_size = 100M</strong></span>
<span class="strong"><strong>binlog_do_db = magento_dev</strong></span>
</pre></div></li><li class="listitem">Restart your MySQL server by running the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo service mysql restart</strong></span>
</pre></div></li><li class="listitem">Open the MySQL shell by<a id="id248" class="indexterm"/> running the following command. This will perform a login with the root user:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysql -u root -p </strong></span>
</pre></div></li><li class="listitem">When you are logged in, you have to run the following queries:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>GRANT ALL PRIVILEGES ON `magento_dev` . * TO `user_slave`@`%` WITH</strong></span>
<span class="strong"><strong>GRANT OPTION IDENTIFIED BY `password_slave`;</strong></span>
<span class="strong"><strong>FLUSH PRIVILEGES;</strong></span>
</pre></div></li><li class="listitem">Run the following commands to show the status of the Master database:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>USE magento_dev;</strong></span>
<span class="strong"><strong>FLUSH TABLES WITH READ LOCK;</strong></span>
<span class="strong"><strong>SHOW MASTER STATUS;</strong></span>
</pre></div><p>The last command from the previous snippet will give the following output:</p><div class="mediaobject"><img src="graphics/3329OS_05_08.jpg" alt="Setting up the Master database"/></div><p>We will use this information in the Slave setup, so keep this with you.</p></li><li class="listitem">Unlock the tables with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>UNLOCK TABLES;</strong></span>
<span class="strong"><strong>quit;</strong></span>
</pre></div><p>While entering the <code class="literal">quit</code> or <code class="literal">exit</code> command, you will be returned to the shell of the server. The<a id="id249" class="indexterm"/> setup of the Master database is done.</p></li></ol></div></div><div class="section" title="Setting up the Slave database"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec10"/>Setting up the Slave database</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Perform an <a id="id250" class="indexterm"/>SSH login to your Slave server. This is a different server than your Master server.</li><li class="listitem">Open the MySQL shell with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysql –u root –p</strong></span>
</pre></div></li><li class="listitem">Create a new database <code class="literal">magento_dev</code> and import the Master database in it.</li><li class="listitem">Add the following configuration in <code class="literal">the /etc/mysql/my.cnf</code> file under the <code class="literal">[mysqld]</code> section:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[mysqld]</strong></span>
<span class="strong"><strong>server-id = 2</strong></span>
<span class="strong"><strong>master-host = 192.168.56.3</strong></span>
<span class="strong"><strong>master-user = user_slave</strong></span>
<span class="strong"><strong>master-password = password_slave</strong></span>
<span class="strong"><strong>master-connect-retry = 60</strong></span>
<span class="strong"><strong>replicate-do-db = magento_dev</strong></span>
</pre></div></li><li class="listitem">Restart the MySQL server with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo service mysql restart</strong></span>
</pre></div></li><li class="listitem">Run the following commands in your MySQL shell. Make sure the <code class="literal">MASTER_LOG_FILE</code> and <code class="literal">MASTER_LOG_POST</code> values match the values that you have seen while running the <code class="literal">SHOW MASTER STATUS</code> command<a id="id251" class="indexterm"/>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CHANGE MASTER TO MASTER_HOST=`192.168.56.3`, MASTER_USER=`user_slave`, MASTER_PASSWORD=`password_slave`, MASTER_LOG_FILE=`mysql-bin.000001`, MASTER_LOG_POS=88;</strong></span>
</pre></div></li><li class="listitem">Run the following command to start the Slave server:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>START SLAVE; </strong></span>
</pre></div></li><li class="listitem">Check the status by running the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>SHOW SLAVE STATUS \G</strong></span>
</pre></div><p>The output will look as follows:</p></li></ol></div><div class="mediaobject"><img src="graphics/3329OS_05_09.jpg" alt="Setting up the Slave database"/></div></div><div class="section" title="Configuring Magento"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec11"/>Configuring Magento</h3></div></div></div><p>Now, when the MySQL setup for the Master/Slave setup is done, it is time to configure Magento to use this setup. We have to configure this in the <code class="literal">app/etc/local.xml</code> file of Magento. Here, we will <a id="id252" class="indexterm"/>configure a <code class="literal">default_setup</code> connection and a<a id="id253" class="indexterm"/> <code class="literal">default_read</code> connection. To configure this, add the following XML in the <code class="literal">local.xml</code> file under the <code class="literal">&lt;resources&gt;</code> tag:</p><div class="informalexample"><pre class="programlisting">&lt;resources&gt;
    &lt;db&gt;
        &lt;table_prefix&gt;&lt;![CDATA[]]&gt;&lt;/table_prefix&gt;
    &lt;/db&gt;
    &lt;default_setup&gt;
        &lt;connection&gt;
            &lt;host&gt;&lt;![CDATA[192.168.56.3]]&gt;&lt;/host&gt;
            &lt;username&gt;&lt;![CDATA[user_master]]&gt;&lt;/username&gt;
            &lt;password&gt;&lt;![CDATA[password_master]]&gt;&lt;/password&gt;
            &lt;dbname&gt;&lt;![CDATA[magento_dev]]&gt;&lt;/dbname&gt;
            &lt;initStatements&gt;&lt;![CDATA[SET NAMES utf8]]&gt;&lt;/initStatements&gt;
            &lt;model&gt;&lt;![CDATA[mysql4]]&gt;&lt;/model&gt;
            &lt;type&gt;&lt;![CDATA[pdo_mysql]]&gt;&lt;/type&gt;
            &lt;pdoType&gt;&lt;![CDATA[]]&gt;&lt;/pdoType&gt;
            &lt;active&gt;1&lt;/active&gt;
        &lt;/connection&gt;
    &lt;/default_setup&gt;
    &lt;default_read&gt;
        &lt;connection&gt;
            &lt;host&gt;&lt;![CDATA[192.168.56.3]]&gt;&lt;/host&gt;
            &lt;username&gt;&lt;![CDATA[user_slave]]&gt;&lt;/username&gt;
            &lt;password&gt;&lt;![CDATA[password_slave]]&gt;&lt;/password&gt;
            &lt;dbname&gt;&lt;![CDATA[magento_dev]]&gt;&lt;/dbname&gt;
            &lt;active&gt;1&lt;/active&gt;
        &lt;/connection&gt;
    &lt;/default_read&gt;
&lt;/resources&gt;</pre></div><p>Clear your cache and<a id="id254" class="indexterm"/> your Magento will use this setup.</p></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec109"/>How it works...</h2></div></div></div><p>When data in the Master database changes, it has to be in sync with the Slave database. To establish this, the binary<a id="id255" class="indexterm"/> logfile is used to communicate between each other.</p><p>You have to see that binary logging is configured on the Master. If not, you have to enable this and restart your MySQL server. If it is not enabled, there is no logfile, so there is no communication between servers. This is also the reason why the <code class="literal">MASTER_LOG_FILE</code> Slave must match the one on the Master database.</p><p>If the setup is done and the Magento configuration is in the <code class="literal">app/etc/local.xml</code> file, everything is finished. Magento is smart enough to send the <code class="literal">write</code> request to the Master and the <code class="literal">read</code> requests to the Slave.</p></div></div>
<div class="section" title="Repairing the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec44"/>Repairing the database</h1></div></div></div><p>Sometimes it happens that your Magento database is broken or corrupt. This can be caused by various reasons such as hacking or server crash. When the database is broken and you have to fix it, the database repair tool from Magento is of great help.</p><p>In this recipe, we will make our database corrupt and fix it with the repair tool.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec110"/>Getting ready</h2></div></div></div><p>To prepare you, download the<a id="id256" class="indexterm"/> <span class="strong"><strong>database repair tool</strong></span> from the Magento site at <a class="ulink" href="http://www.magentocommerce.com">http://www.magentocommerce.com</a> and place the PHP file in your server root.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec111"/>How to do it...</h2></div></div></div><p>The following steps show <a id="id257" class="indexterm"/>you how to make your database corrupt and fix it using the database repair tool:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a backup of your existing database.</li><li class="listitem">Create an empty database as the reference database. Let's say we call it <code class="literal">magento_dev_repair</code>.</li><li class="listitem">Configure Magento to use this database in the <code class="literal">app/etc/local.xml</code> file.</li><li class="listitem">Clear the cache and run Magento. This will install an empty Magento in this database.</li><li class="listitem">Make your original database corrupt. You can do this by running the following queries that remove a foreign key and a table:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ALTER TABLE core_store DROP FOREIGN KEY FK_CORE_STORE_GROUP_ID_CORE_STORE_GROUP_GROUP_ID;</strong></span>
<span class="strong"><strong>DROP TABLE catalog_product_index_price</strong></span>
</pre></div></li><li class="listitem">Browse to the repair tool in your browser, and configure your original and reference database as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_05_10.jpg" alt="How to do it..."/></div></li><li class="listitem">Submit the form and the script will repair your database. On the next page, you will see what changes are made to your original database.</li><li class="listitem">Switch the database in the <code class="literal">app/etc/local.xml</code> file, so Magento uses your original database.</li><li class="listitem">Clear the cache and your shop is up and running.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec112"/>How it works...</h2></div></div></div><p>While running the database repair tool, the script will compare the original database with the reference database. If the comparison is done, the script will make the structure of your original database the same as the one of the reference databases.</p><p>The database repair tool <a id="id258" class="indexterm"/>only fixes structural issues with your database. If you miss some data, this is not the right tool to get the data back.</p></div></div></body></html>