<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Customizing Post and Page Editors</h1>
                </header>
            
            <article>
                
<p>In this chapter, you will learn how to customize the core post and page editors through the following recipes:</p>
<ul>
<li>Capturing and displaying information using custom meta boxes</li>
<li>Displaying custom post data via filter functions</li>
<li>Hiding the Custom Field section in the post editor</li>
<li>Extending the post editor to allow users to upload files directly</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article>
                
<p>In the last few chapters, you learned how to create custom plugin configuration panels and how to set up custom post types. With this knowledge in hand, we will now see how to customize the post and page editors <span>using meta boxes.</span></p>
<p>Meta boxes are a very useful tool in the creation of WordPress plugins. They were first used to organize large administration panels into manageable sections in <a href="0346c3c6-27ee-45fb-bfd6-df398e04b2b4.xhtml"><span class="ChapterrefPACKT">Chapter 3</span></a>, <em>User Settings and Administration Pages</em>, and then continued to be a key element in the creation of tailored interfaces to edit custom post types in <a href="6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml"><span class="ChapterrefPACKT">Chapter 4</span></a>, <em>The Power of Custom Post Types</em>.</p>
<p>This chapter explores how meta boxes can be used to augment the default post and page editors' capabilities. While WordPress posts and pages already offer a lot of functionalities in a default installation, custom data entry fields go a long way in crafting a user experience that is much smoother than using the custom fields editor. These extra fields can be used to store anything. For example, they could be used to specify alternative language links for blog entries or to assign a pop-up dialog to specific articles on a site.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Capturing and displaying information using custom meta boxes</h1>
                </header>
            
            <article>
                
<p>The WordPress post and page editors are organized in a series of collapsible sections with headers called meta boxes. While WordPress is mainly responsible for populating these containers with all of the appropriate elements, plugin developers can insert their own sections by registering user meta boxes.</p>
<p>To demonstrate this capability, this recipe shows how to add a custom meta box that will be used to display and capture information about the name and web address of the source materials used when writing a new post or page entry.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have access to a WordPress development environment, either on your local computer or a remote server, where you will be able to load your new plugin files.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the WordPress plugin directory of your development installation.</li>
<li>Create a new directory called <kbd>ch5-post-source-link</kbd>.</li>
<li>Navigate to the directory and create a text file called <kbd>ch5-post-source-link.php</kbd>.</li>
<li>Open the new file in a code editor and add an appropriate header at the top of the plugin file, naming the plugin <kbd>Chapter 5 - Post Source Link</kbd>.</li>
<li>Add the following line of code to register a function that will be executed when WordPress is preparing a list of meta boxes for all the administration areas:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'add_meta_boxes', 'ch5_psl_register_meta_box' );</pre>
<ol start="6">
<li>Add the following code segment to provide an implementation for the <kbd>ch5_psl_register_meta_box</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch5_psl_register_meta_box() { <br/>    add_meta_box( 'ch5_psl_source_meta_box', 'Post/Page Source',<br/>                  'ch5_psl_source_meta_box', 'post', 'normal'); <br/>    add_meta_box( 'ch5_psl_source_meta_box', 'Post/Page Source',<br/>                  'ch5_psl_source_meta_box', 'page', 'normal'); <br/>} </pre>
<ol start="7">
<li>Insert this code to provide an implementation for the <kbd>ch5_psl_source_meta_box</kbd> function, responsible for rendering the meta box contents:</li>
</ol>
<pre style="padding-left: 60px">function ch5_psl_source_meta_box( $post ) {  <br/>    // Retrieve current source name and address for post <br/>    $post_source_name =<br/>        esc_html( get_post_meta( $post-&gt;ID, 'post_source_name',<br/>                                 true ) ); <br/>    $post_source_address =<br/>        esc_html( get_post_meta( $post-&gt;ID, <br/>                                 'post_source_address', <br/>                                 true ) ); <br/>    ?&gt; <br/>    &lt;!-- Display fields to enter source name and address --&gt; <br/>    &lt;table&gt; <br/>        &lt;tr&gt; <br/>            &lt;td style="width: 100px"&gt;Source Name&lt;/td&gt; <br/>            &lt;td&gt; <br/>                &lt;input type="text" size="40" <br/>                       name="post_source_name"<br/>                       value="&lt;?php echo $post_source_name; ?&gt;" /&gt; <br/>            &lt;/td&gt; <br/>        &lt;/tr&gt; <br/>        &lt;tr&gt; <br/>            &lt;td&gt;Source Address&lt;/td&gt; <br/>            &lt;td&gt; <br/>                &lt;input type="text" size="40" <br/>                       name="post_source_address"<br/>                       value="&lt;?php echo $post_source_address; ?&gt;"<br/>                /&gt; <br/>            &lt;/td&gt; <br/>        &lt;/tr&gt; <br/>    &lt;/table&gt; <br/>&lt;?php } </pre>
<ol start="8">
<li>Insert the following block of code to register a function that will be called when any type of post is saved:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'save_post', 'ch5_psl_save_source_data', 10, 2 ); </pre>
<ol start="9">
<li>Append the following code section to provide an implementation for the <kbd>ch5_psl_save_source_data</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch5_psl_save_source_data( $post_id = false,  <br/>                                   $post = false ) { <br/>    // Check post type for posts or pages <br/>    if ( 'post' == $post-&gt;post_type || <br/>         'page' == $post-&gt;post_type ) { <br/>        // Store data in post meta table if present in post data <br/>        if ( isset( $_POST['post_source_name'] ) ) {<br/>            update_post_meta( $post_id, 'post_source_name', <br/>                sanitize_text_field(<br/>                    $_POST['post_source_name'] ) ); <br/>        }<br/><br/>        if ( isset( $_POST['post_source_address'] ) ) {<br/>            update_post_meta( $post_id, 'post_source_address', <br/>                esc_url( $_POST['post_source_address'] ) ); <br/>        }<br/>    } <br/>} </pre>
<ol start="10">
<li>Save and close the plugin file.</li>
<li>Navigate to the <span class="packt_screen">Plugins</span> management page and <span class="packt_screen">Activate</span> the <kbd>Chapter 5 - Post Source Link</kbd> plugin.</li>
<li>Go to the <span class="packt_screen">Posts</span> section of the administration, click on one of the entries to open the post editor, and see the new <span class="packt_screen">Post/Page Source</span> meta box:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="114" width="396" class="image-border" src="assets/b7c004c5-a5d7-49c0-96aa-417c4fc6f96e.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>Every time an administrator or content manager visits the platform's backend, WordPress creates a number of meta boxes for all of its internal editors (posts, pages, links, and so on) using the <kbd>add_meta_box</kbd> function that we have seen in the previous two chapters.</p>
<p>In this recipe, we will use the same <kbd>add_meta_box</kbd> function twice to associate a new box to the page and post editors, with both calls registering the same callback function, since we want the same functionality in both places. As WordPress stores posts and pages in the same database table, it will automatically make sure that all the entries have unique IDs between both types of entries.</p>
<p>The other function that we have seen before is <kbd>get_post_meta</kbd>, which is used to retrieve custom metadata associated with post entries.</p>
<p>The content of the meta box itself is displayed using standard HTML. As this box will be part of a larger editor, there is no need to worry about declaring a form in this box.</p>
<p>Once the new dialog section is created, the next task is to put code in place to store data from the additional fields upon submission through the use of the <kbd>save_post</kbd> action. Functions associated with this hook are called when posts of any type are saved. When executed, the associated function receives two parameters from WordPress that contain the ID of the post being saved and a copy of all the data that has been processed to be saved so far. The callback also has access to all the server post data received from the user, and uses the <kbd>sanitize_text_field</kbd> and <kbd>esc_url</kbd> functions to make sure that no malicious content was received.</p>
<p>As indicated in the previous chapter, it is important to set the fourth parameter of the <kbd>add_action</kbd> call--that is, <kbd>accepted_args</kbd>--for actions and filters that receive more than one argument. If it is not specified, these additional arguments will not be available to the receiving hook function.</p>
<p>Working with the assumption that the meta box was only added to the post and page editors, the code contained in the <kbd>ch5_psl_save_source_data</kbd> function first checks to see whether the post type is set as a post or page. If it is one of these two types, it moves on to check for the presence of post data for the source name and address fields. If found, <kbd>update_post_meta</kbd> is called once for each field to store the new information in the site's database associated with the posts that it belongs to. Making a call to the <kbd>update_post_meta</kbd> function actually updates the post custom field data if it exists or creates it in the case of new post or page entries.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>While this recipe specifically adds a new section to the post and page editors, it may be desirable to make the new fields available to all post types, including custom ones.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding a new meta box to all post types (including custom ones)</h1>
                </header>
            
            <article>
                
<p>This recipe made two function calls to register meta boxes with the post and page editors. This concept does not expand well to register a custom section with all the post types, since custom types created by other plugins are not known. Thankfully, there is an easy way to get an array of all the post types that can be used to associate the new meta box with all the post editors, using a quick <kbd>foreach</kbd> loop.</p>
<p>The following code shows how the <kbd>ch5_psl_register_meta_box</kbd> function can be re-written to associate the new box with all the post types:</p>
<pre>function ch5_psl_register_meta_box() { <br/>    $post_types = get_post_types( array(), 'objects' ); <br/>    foreach ( $post_types as $post_type ) { <br/>        add_meta_box( 'ch5_psl_post_source_meta_box', <br/>                      'Post/Page Source', <br/>                      'ch5_psl_source_meta_box', <br/>                      $post_type-&gt;name, 'normal' );  <br/>    } <br/>} </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Displaying custom post data using filter functions</h1>
                </header>
            
            <article>
                
<p>Once we have captured additional data in the post editor, the next logical step will be to add code to display it when visitors view posts and pages. In the case of our source link data, the most logical place to show this link is after each post's content, which can easily be accomplished by assigning a function to the filter <kbd>the_content</kbd>.</p>
<p>This recipe explains how to create a filter function to display the source data associated with a post or page item as a clean link.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Capturing and displaying information using custom meta boxes</em> recipe to have a starting point for this recipe <span>and the resulting plugin should still be active in your development site</span>. Alternatively, you can get the resulting code (<kbd>Chapter 5/ch5-post-source-link/ch5-post-source-link-v1.php</kbd>) from the code bundle you downloaded from the Packt Publishing website (<a href="https://www.packtpub.com/support"><span class="URLPACKT">https://www.packtpub.com/support</span></a>) and rename the file as <kbd>ch5-post-source-link.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the <kbd>ch5-post-source-link</kbd> folder of the WordPress plugin directory of your development installation.</li>
<li>Open the <kbd>ch5-post-source-link.php</kbd> file in a code editor.</li>
<li>Add the following line of code to register a filter function to be called when the post and page content is prepared for display:</li>
</ol>
<pre style="padding-left: 60px">add_filter( 'the_content', 'ch5_psl_display_source_link' );</pre>
<ol start="4">
<li>Add the following code section to provide an implementation for the <kbd>ch5_psl_display_source_link</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch5_psl_display_source_link ( $content ) { <br/>    $post_id = get_the_ID();<br/> <br/>    if ( !empty( $post_id ) ) {<br/>        if ( 'post' == get_post_type( $post_id ) ||<br/>             'page' == get_post_type( $post_id ) ) {<br/><br/>            // Retrieve current source name and address for post <br/>            $post_source_name =<br/>                get_post_meta( $post_id, 'post_source_name', <br/>                               true ); <br/>            $post_source_address =<br/>                get_post_meta( $post_id, 'post_source_address', <br/>                               true ); <br/> <br/>            // Output information to browser <br/>            if ( !empty( $post_source_name ) &amp;&amp; <br/>                 !empty( $post_source_address ) ) { <br/>                $content .= '&lt;div class="source_link"&gt;Source: '; <br/>                $content .= '&lt;a href="';<br/>                $content .= esc_url( $post_source_address ); <br/>                $content .= '"&gt;' . esc_html( $post_source_name );<br/>                $content .= '&lt;/a&gt;&lt;/div&gt;';<br/>            } <br/>        }<br/>    }<br/>    return $content;<br/>} </pre>
<ol start="5">
<li>Save and close the plugin file.</li>
<li>Add source data to one of your site's posts and view it to see the new <span class="packt_screen">Source</span> link displayed on the page.</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="121" width="338" class="image-border" src="assets/bbbae67f-3b45-4c08-9f42-562860d41056.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>Similarly to what was done in <a href="f7395811-9e4a-4913-8a02-cc68875d0071.xhtml">Chapter 2</a>, <em>Plugin Framework Basics</em>, in the <em>Adding text after each item's content using plugin filters</em> recipe, this recipe registers a callback with the <kbd>the_content</kbd> filter hook, which allows us to add an additional link after each post or page where the source name and source address fields have been filled in. We use the <kbd>get_post_type</kbd> function in our callback to first check whether the item being displayed is in one of these two categories. Then, we use <kbd>get_post_meta</kbd> to retrieve the information and display the source link if both fields contain information.</p>
<p>We also use the <kbd>esc_url</kbd> and <kbd>esc_html</kbd> functions as a precaution to be sure that the data stored in these two post meta fields is clean.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Capturing and displaying information using custom meta boxes</em> recipe</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Hiding the Custom Field section in the post editor</h1>
                </header>
            
            <article>
                
<p>After having full control over which meta boxes are shown when creating custom post type editor controls and putting together plugin configuration pages, things are a little different when it comes to altering the basic post and page editors. More specifically, instead of choosing which meta boxes to display, the editor sections created by WordPress need to be removed to tailor the user experience.</p>
<p>This recipe shows how to remove the <span class="packt_screen">Custom</span> <span class="packt_screen">Fields</span> meta boxes from the post and page editors:</p>
<div class="CDPAlignCenter CDPAlign"><img height="237" width="328" class="image-border" src="assets/16a1a8cb-233f-460d-bfc4-242f7ce1d003.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have access to a WordPress development environment, either on your local computer or a remote server, where you will be able to load your new plugin files.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the WordPress plugin directory of your development installation.</li>
<li>Create a new directory called <kbd>ch5-hide-custom-fields</kbd>.</li>
</ol>
<p> </p>
<ol start="3">
<li>Navigate to this directory and create a new text file called <kbd>ch5-hide-custom-fields.php</kbd>.</li>
<li>Open the new file in a code editor and add an appropriate header at the top of the plugin file, naming the plugin <kbd>Chapter 5 - Hide Custom Fields</kbd>.</li>
<li>Add the following line of code to register a function that will be executed when WordPress is preparing a list of meta boxes for all the administration areas:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'add_meta_boxes', <br/>            'ch5_hcf_remove_custom_fields_metabox' ); </pre>
<ol start="6">
<li>Add the following code section to provide an implementation for the <kbd>ch5_hcf_remove_custom_fields_metabox</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch5_hcf_remove_custom_fields_metabox() { <br/>    remove_meta_box( 'postcustom', 'post', 'normal' ); <br/>    remove_meta_box( 'postcustom', 'page', 'normal' ); <br/>} </pre>
<ol start="7">
<li>Save and close the plugin file.</li>
<li>Navigate to the <span class="packt_screen">Plugins</span> management page and <span class="packt_screen">Activate</span> the <kbd>Chapter 5 - Hide Custom Fields</kbd> plugin.</li>
<li>Go to the <span class="packt_screen">Posts</span> section of the administration and click on one of the entries to open the post editor. You will see that the <span class="packt_screen">Custom</span> <span class="packt_screen">Fields</span> section is no longer visible in the editor and does not show up in the <span class="packt_screen">Screen Options</span> configuration tab either:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="205" width="561" class="image-border" src="assets/c466d605-2903-4a09-a783-3cef9e9960c4.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>This short recipe contains only a few lines of code which register a function to be called when WordPress is preparing meta boxes for all the administration sections, followed by the implementation of this function. The function itself makes two calls to the <kbd>remove_meta_box</kbd> function to remove the custom fields section from the post and page editors. This function requires three parameters:</p>
<pre>remove_meta_box( $id, $page, $context );  </pre>
<p>The first argument is the meta box identifier that was used when it was first created. While you may not know where the creation code for a given meta box is located within the WordPress source code, a quick look at the box's <kbd>div id</kbd> in the page source from a browser reveals its name. In this case, the <kbd>id</kbd> is <kbd>postcustom</kbd>. The other two arguments indicate the name of the editor from which the meta box is to be removed and the context of the meta box (<kbd>normal</kbd>, <kbd>advanced</kbd>, or <kbd>side</kbd>).</p>
<p>Once the plugin is activated, the designated box disappears from the interface immediately.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Extending the post editor to allow users to upload files directly</h1>
                </header>
            
            <article>
                
<p>WordPress offers a very complete media upload dialog. However, some projects might require users to be able to attach files right from the post editor. This recipe shows how to modify the post editor form to be able to attach files to articles and how to store these files once they have been uploaded. While any type of file could be attached using this technique, the code will be written to accept only items with a PDF file extension.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have access to a WordPress development environment, either on your local computer or a remote server, where you will be able to load your new plugin files.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the WordPress plugin directory of your development installation.</li>
<li>Create a new directory called <kbd>ch5-custom-file-uploader</kbd>.</li>
<li>Navigate to this directory and create a new text file called <kbd>ch5-custom-file-uploader.php</kbd>.</li>
<li>Open the new file in a code editor and add an appropriate header at the top of the plugin file, naming the plugin <kbd>Chapter 5 - Custom File Uploader</kbd>.</li>
<li>Add the following line of code to register a function that will be executed when WordPress is rendering the HTML code at the beginning of the post editor form:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'post_edit_form_tag', 'ch5_cfu_form_add_enctype' ); </pre>
<ol start="6">
<li>Add the following code section to provide an implementation for the <kbd>ch5_cfu_form_add_enctype</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch5_cfu_form_add_enctype() {   <br/>    echo ' enctype="multipart/form-data"';   <br/>} </pre>
<ol start="7">
<li>Insert the following line of code to register a function to be called when WordPress is preparing the meta boxes for all the administration sections:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'add_meta_boxes', 'ch5_cfu_register_meta_box' ); </pre>
<ol start="8">
<li>Add the following block of code to implement the <kbd>ch5_cfu_register_meta_box</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch5_cfu_register_meta_box() { <br/>    add_meta_box( 'ch5_cfu_upload_file', 'Upload File', <br/>                  'ch5_cfu_upload_meta_box', 'post', 'normal' ); <br/>    add_meta_box( 'ch5_cfu_upload_file', 'Upload File', <br/>                  'ch5_cfu_upload_meta_box', 'page', 'normal' ); <br/>} </pre>
<ol start="9">
<li>Implement the function responsible for rendering the meta box contents, <kbd>ch5_cfu_upload_meta_box</kbd>, with the following code:</li>
</ol>
<pre style="padding-left: 60px">function ch5_cfu_upload_meta_box( $post ) { ?&gt; <br/>    &lt;table&gt; <br/>        &lt;tr&gt; <br/>            &lt;td style="width: 150px"&gt;PDF Attachment&lt;/td&gt; <br/>            &lt;td&gt; <br/>            &lt;?php <br/>            // Retrieve attachment data for post <br/>            $attachment_data = get_post_meta( $post-&gt;ID, <br/>                                              'attach_data', <br/>                                              true ); <br/>                 <br/>            // Display post link if data is present <br/>            if ( empty ( $attachment_data ) ) { <br/>                echo 'No Attachment Present'; <br/>            } else { <br/>                echo '&lt;a target="_blank" href="'; <br/>                echo esc_url( $attachment_data['url'] ); <br/>                echo '"&gt;' . 'Download Attachment&lt;/a&gt;'; <br/>            }                 <br/>            ?&gt; <br/>            &lt;/td&gt; <br/>        &lt;/tr&gt; <br/>        &lt;tr&gt; <br/>            &lt;td&gt;Upload File&lt;/td&gt; <br/>            &lt;td&gt;&lt;input name="upload_pdf" type="file" /&gt;&lt;/td&gt; <br/>        &lt;/tr&gt; <br/>        &lt;tr&gt; <br/>            &lt;td&gt;Delete File&lt;/td&gt; <br/>            &lt;td&gt;&lt;input type="submit" name="delete_attachment" <br/>                       class="button-primary"<br/>                       id="delete_attachment" <br/>                       value="Delete Attachment" /&gt;&lt;/td&gt; <br/>        &lt;/tr&gt; <br/>    &lt;/table&gt; <br/>&lt;?php } </pre>
<ol start="10">
<li>Add the following line of code, which calls the <kbd>add_action</kbd> function to register a callback that will be executed when post data is processed to be saved:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'save_post', 'ch5_cfu_save_uploaded_file', 10, 2 ); </pre>
<ol start="11">
<li>Implement <kbd>ch5_cfu_save_uploaded_file</kbd> with the following code:</li>
</ol>
<pre style="padding-left: 60px">function ch5_cfu_save_uploaded_file( $post_id = false,  <br/>                                     $post = false ) { <br/>    if ( isset($_POST['delete_attachment'] ) ) { <br/>        $attach_data = get_post_meta( $post_id, 'attach_data', <br/>                                      true ); <br/> <br/>        if ( !empty( $attach_data ) ) { <br/>            unlink( $attach_data['file'] ); <br/>            delete_post_meta( $post_id, 'attach_data' ); <br/>        } <br/>    } elseif ( 'post' == $post-&gt;post_type ||<br/>               'page' == $post-&gt;post_type ) { <br/><br/>        // Look to see if file has been uploaded by user <br/>        if( array_key_exists( 'upload_pdf', $_FILES ) &amp;&amp; <br/>            !$_FILES['upload_pdf']['error'] ) { <br/> <br/>            // Retrieve file type and store lower-case version <br/>            $file_type_array = wp_check_filetype( basename( <br/>                 $_FILES['upload_pdf']['name'] ) );            <br/>            $file_ext = strtolower( $file_type_array['ext'] );  <br/> <br/>            // Display error message if file is not a PDF <br/>            if ( 'pdf' != $file_ext ) { <br/>                wp_die( 'Only files of PDF type are allowed.' ); <br/>                exit; <br/>            } else { <br/>                // Send uploaded file data to upload directory  <br/>                $upload_return = wp_upload_bits( <br/>                    $_FILES['upload_pdf']['name'], null, <br/>                    file_get_contents( <br/>                    $_FILES['upload_pdf']['tmp_name'] ) ); <br/> <br/>                // Replace backslashes with slashes for Windows<br/>                // web servers<br/>                $upload_return['file'] =  <br/>                    str_replace( '\\', '/', <br/>                                 $upload_return['file'] ); <br/> <br/>                // Set upload path data if successful. <br/>                if ( isset( $upload_return['error'] ) &amp;&amp; <br/>                            $upload_return['error'] != 0 ) { <br/>                    $errormsg = 'There was an error uploading'; <br/>                    $errormsg .= 'your file. The error is: '; <br/>                    $errormsg .= $upload_return['error']; <br/>                    wp_die( $errormsg );   <br/>                    exit; <br/>                } else { <br/>                    $attach_data = get_post_meta( $post_id,<br/>                                                  'attach_data', <br/>                                                  true ); <br/> <br/>                    if ( !empty( $attach_data ) ) {<br/>                        unlink( $attach_data['file'] ); <br/>                    } <br/>                    update_post_meta( $post_id, 'attach_data', <br/>                                      $upload_return ); <br/>                }  <br/>            } <br/>        } <br/>    } <br/>} </pre>
<ol start="12">
<li>Add the following line of code to register a filter function to be called when the post and page content is prepared for display:</li>
</ol>
<pre style="padding-left: 60px">add_filter( 'the_content', 'ch5_cfu_display_pdf_link' );</pre>
<ol start="13">
<li>Insert the following code to provide an implementation for the <kbd>ch5_cfu_display_pdf_link</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch5_cfu_display_pdf_link ( $content ) { <br/>    $post_id = get_the_ID();<br/><br/>    if ( !empty( $post_id ) ) {<br/>        if ( 'post' == get_post_type( $post_id ) ||<br/>             'page' == get_post_type( $post_id ) ) {<br/> <br/>            $attachment_data =<br/>                get_post_meta( $post_id, 'attach_data', true ); <br/> <br/>            if ( !empty( $attachment_data ) ) { <br/>                $content .= '&lt;div class="file_attachment"&gt;';<br/>                $content .= '&lt;a target="_blank" href="'; <br/>                $content .= esc_url( $attachment_data['url'] ); <br/>                $content .= '"&gt;' . 'Download additional '; <br/>                $content .= 'information&lt;/a&gt;&lt;/div&gt;'; <br/>            } <br/>        }<br/>    }<br/>    return $content;<br/>} </pre>
<ol start="14">
<li>Save and close the plugin file.</li>
<li>Navigate to the <span class="packt_screen">Plugins</span> management page and <span class="packt_screen">Activate</span> the <span class="packt_screen">Chapter 5 - Custom File Uploader</span> plugin.</li>
</ol>
<p> </p>
<ol start="16">
<li>Edit any post on your site to see the new <span class="packt_screen">Upload File</span> meta box and click on <span class="packt_screen">Update</span> to save the post and upload the selected PDF file to be associated with the item:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="105" width="326" class="image-border" src="assets/b643d75a-a996-42c7-8cd2-9568aeaf1b6d.png"/></div>
<ol start="17">
<li>View the post to see the link to download the attached file:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="111" width="319" class="image-border" src="assets/0a43c622-0066-4969-80f6-dcaf81c292b5.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>The default WordPress post editor declares a simple form that does not have an encoding type defined and, therefore, can only accept regular text input. Fortunately, we have access to an action hook to register a callback function that will output additional code when the form gets created, allowing us to upload files. This callback is implemented in the first part of this recipe.</p>
<p>The next code section registers a meta box, as we have seen in many recipes so far, to display a new editor section that will display a link to an attached file if present, a file selection box to upload a new file, and a button to request for the attachment to be deleted.</p>
<p>Moving on to the function responsible for processing the post data, the recipe's code first checks whether the user requested to delete a file associated with a post. If that is the case, it will proceed with the deletion of the file and remove the associated post metadata. In other circumstances, if the item's post type is a post or page, the plugin will proceed to search for a file uploaded by the user within the PHP global <kbd>$_FILES</kbd> array. This array contains information on any uploads that have been processed as part of a form's post data. If an entry is found, we will use the <kbd>wp_check_filetype</kbd> function to retrieve information about the file type and proceed to convert the resulting extension to a lowercase string to make comparisons easier.</p>
<p>As this example only expects to receive PDF files, the code then checks to see whether the file extension is correct to decide whether it will display an error message using the <kbd>wp_die</kbd> function or move the file from the web server's temp directory to the <kbd>wp-content/uploads</kbd> directory in WordPress, using the <kbd>wp_upload_bits</kbd> function. In the latter case, it also stores the resulting file's path and URL in the post custom field table.</p>
<p>Once this is done, this recipe implements a filter function for <kbd>the_content</kbd> to display a link to associated PDF attachments under posts and pages.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Adding extra fields to the post editor using custom meta boxes</em> recipe</li>
</ul>


            </article>

            
        </section>
    </body></html>