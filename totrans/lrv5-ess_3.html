<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Your First Application"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Your First Application</h1></div></div></div><p>Having learned about Laravel's conventions, working with dependencies using Composer, and setting up a development environment with Homestead, you are now ready to build your first application!</p><p>In this chapter, you will use the concepts presented in the previous two chapters in a practical way and learn how to do the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Plan the URLs and entities of your application</li><li class="listitem" style="list-style-type: disc">Troubleshoot common issues when getting started</li><li class="listitem" style="list-style-type: disc">Define routes and their actions, as well as models and their relationships</li><li class="listitem" style="list-style-type: disc">Prepare your database and learn how to interact with it using Eloquent</li><li class="listitem" style="list-style-type: disc">Use the Blade template language to create hierarchical layouts</li></ul></div><p>The first step in creating a web application is to identify and define its requirements. Then, once the main features have been decided, we derive the main entities as well as the URL structure of the application. Having a well-defined set of requirements and URLs is also essential for other tasks such as testing; this will be covered later in the book.</p><p>A lot of new concepts are presented in this chapter. If you have trouble understanding something or if you are not quite sure where to place a particular snippet of code, you can download the annotated source code of the application from <a class="ulink" href="http://packtpub.com/support">http://packtpub.com/support</a>, which will help you to follow along.</p><div class="section" title="Planning our application"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec18"/>Planning our application</h1></div></div></div><p>We are<a id="id50" class="indexterm"/> going to build a browsable database of cat profiles. Visitors will be able to create pages for their cats and fill in basic information such as the name, date <a id="id51" class="indexterm"/>of birth, and breed of each cat. This application will implement the default <span class="strong"><strong>Create-Retrieve-Update-Delete</strong></span> (<span class="strong"><strong>CRUD</strong></span>) operations. We will also create an overview page with the option to filter cats by breed. All of the security, authentication, and permission features are intentionally left out, since <a id="id52" class="indexterm"/>they will be covered in the further chapters.</p><div class="section" title="Entities, relationships, and attributes"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec19"/>Entities, relationships, and attributes</h2></div></div></div><p>Firstly, we<a id="id53" class="indexterm"/> need<a id="id54" class="indexterm"/> to define the <span class="emphasis"><em>entities</em></span> of our application. In <a id="id55" class="indexterm"/>broad terms, an entity is a thing (person, place, or<a id="id56" class="indexterm"/> object) about which the application should store data. From<a id="id57" class="indexterm"/> the requirements, we can extract the following entities and attributes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Cats</strong></span>: They have a numeric identifier, a name, a date of birth, and a breed</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Breeds</strong></span>: They <a id="id58" class="indexterm"/>only have an identifier and a name</li></ul></div><p>This information will help us when defining the database schema that will store the entities, relationships, attributes, as well as the models, which are the PHP classes that represent the objects in our database.</p></div><div class="section" title="The map of our application"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec20"/>The map of our application</h2></div></div></div><p>We now<a id="id59" class="indexterm"/> need to think about the URL structure of our application. Having clean and expressive URLs has many benefits. On a usability level, the application will be easier to navigate and will look less intimidating to the user (descriptive URLs look far more appealing than a lengthy query string). For frequent users, individual pages will be easier to remember or bookmark and, if they contain relevant keywords, they will often rank higher in search engine results.</p><p>To fulfill the initial set of requirements, we are going to need the following routes in our application. A route<a id="id60" class="indexterm"/> is a URL and HTTP method to which the application will respond.</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Method</p>
</th><th style="text-align: left" valign="bottom">
<p>Route</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Index</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cats</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Overview page</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cats/breeds/:name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Overview page for specific breed</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cats/:id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Individual cat page</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cats/create</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Form to create a new cat page</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">POST</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cats</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Handle creation of new cat page</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cats/:id/edit</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Form to edit existing cat page</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">PUT</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cats/:id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Handle updates to cat page</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cats/:id/delete</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Form to confirm deletion of page</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">DELETE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cats/:id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Handle deletion of cat page</p>
</td></tr></tbody></table></div><p>You will <a id="id61" class="indexterm"/>shortly learn how Laravel helps us to turn this routing sketch into actual code. If you have written PHP applications without a framework, you can briefly reflect on how you would have implemented such a routing structure. To add some perspective, this is what the second to last URL could have looked like with a traditional PHP script (without URL rewriting): <code class="literal">/index.php?p=cats&amp;id=1&amp;_action=delete&amp;confirm=true</code>.</p><p>The preceding table can be prepared using a pen and paper, in a spreadsheet editor, or even in your favorite code editor, using ASCII characters. In the initial development phases, this table of routes is an important prototyping tool that makes you to think about URLs first and helps you define and refine the structure of your application iteratively.</p><p>If you have worked with REST APIs, this kind of routing structure will look familiar to you. In RESTful terms, we have a <code class="literal">cats</code> resource that responds to the different HTTP verbs and provides an additional set of routes to display the necessary forms.</p><p>If, on the other hand, you have not worked with RESTful sites, the use of the <code class="literal">PUT</code> and <code class="literal">DELETE</code> HTTP methods might be new to you. Even though web browsers do not support these methods for standard HTTP requests, Laravel uses a technique that other frameworks such as Rails use, and emulates those methods by adding a <code class="literal">_method</code> input field to the forms. This way, they can be sent over a standard <code class="literal">POST</code> request and are then delegated to the correct route or controller method in the application.</p><p>Note also that none of the form submissions endpoints are handled with a <code class="literal">GET</code> method. This is primarily because they have side effects; a user can trigger the same action multiple times accidentally when using the browser history. Therefore, when they are called, these routes never display anything to the users. Instead, they redirect them after completing the action (for instance, <code class="literal">DELETE /cats/:id</code> will redirect the user to <code class="literal">GET /cats</code>).</p></div></div></div>
<div class="section" title="Starting the application"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec19"/>Starting the application</h1></div></div></div><p>Now that<a id="id62" class="indexterm"/> we have the blueprints for the application, let's roll up our sleeves and start writing some code.</p><p>Start by opening a new terminal window and launch Homestead:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ homestead ssh</strong></span>
</pre></div><p>Navigate to the directory you have mapped to Homestead (by default this is <code class="literal">~/Code</code>):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd ~/Code</strong></span>
</pre></div><p>Then use Composer to create a new Laravel project, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ composer create-project laravel/laravel furbook.com --prefer-dist</strong></span>
<span class="strong"><strong>$ cd furbook.com</strong></span>
</pre></div><p>Once Composer finishes downloading Laravel and resolving its dependencies, you will have a directory structure identical to the one presented in the first chapter.</p><div class="section" title="Setting the application namespace"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec21"/>Setting the application namespace</h2></div></div></div><p>Applications <a id="id63" class="indexterm"/>in Laravel are namespaced. By <a id="id64" class="indexterm"/>default, this is just <code class="literal">App</code>—Laravel's great, but it still can't guess the name of your application! To set it to something more appropriate, we can use the Artisan command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php artisan app:name Furbook</strong></span>
</pre></div><p>This will update our application's namespace to be <code class="literal">Furbook</code> instead.</p></div></div>
<div class="section" title="Writing the first routes"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec20"/>Writing the first routes</h1></div></div></div><p>Let's start by<a id="id65" class="indexterm"/> writing the first two routes of our application at <code class="literal">app/Http/routes.php</code>. This file already contains some comments as well as a couple of sample routes. Remove the existing routes (but leave the opening <code class="literal">&lt;?php</code> declaration) before adding the following routes:</p><div class="informalexample"><pre class="programlisting">Route::get('/', function() {
  return 'All cats';
});

Route::get('cats/{id}', function($id) {
  return sprintf('Cat #%s', $id);
});</pre></div><p>The first parameter of the <code class="literal">get</code> method is the URI pattern. When a pattern is matched, the closure function in the second parameter is executed with any parameters that were extracted from the pattern. Note that the slash prefix in the pattern is optional; however, you should not have any trailing slashes. You can make sure that your routes work by opening your<a id="id66" class="indexterm"/> web browser and visiting <code class="literal">http://dev.furbook.com/cats/123</code>.</p><div class="section" title="Restricting the route parameters"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec22"/>Restricting the route parameters</h2></div></div></div><p>In the <a id="id67" class="indexterm"/>pattern of the second route, <code class="literal">{id}</code> currently <a id="id68" class="indexterm"/>matches any string or number. To restrict it so that it only matches numbers, we can chain a <code class="literal">where</code> method to our route as follows:</p><div class="informalexample"><pre class="programlisting">Route::get('cats/{id}', function($id) {
  sprintf('Cat #%d', $id);
})-&gt;where('id', '[0-9]+');</pre></div><p>The <code class="literal">where</code> method takes two arguments: the first one is the name of the parameter and the second one is the regular expression pattern that it needs to match.</p><p>If you now try to visit an invalid URL, nginx (the server software serving the application) will display a <span class="strong"><strong>404 Not Found</strong></span> error page.</p></div><div class="section" title="Handling HTTP exceptions"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec23"/>Handling HTTP exceptions</h2></div></div></div><p>When an<a id="id69" class="indexterm"/> error occurs in your application, Laravel<a id="id70" class="indexterm"/> raises an exception. This is also true for HTTP errors, as Laravel will raise an appropriate HTTP exception. Usually when an HTTP error occurs, you will want to display a response informing the user what went wrong. This is easy in Laravel 5, as all you need to do is create a view named after the HTTP status code you want it to display for in the <code class="literal">resources/views/errors</code> directory.</p><p>For example, if you wanted to display a view for <span class="strong"><strong>404 Not Found</strong></span> errors, then all you need to do is create a view at <code class="literal">resources/views/errors/404.blade.php</code>.</p><p>You can use this approach to handle other HTTP errors as well, such as <span class="strong"><strong>403 Forbidden</strong></span> errors; simply create a view at <code class="literal">resources/views/errors/403.blade.php</code>.</p><p>We'll cover<a id="id71" class="indexterm"/> views later on in this chapter. In the meantime, you can find a list of HTTP status codes at <a class="ulink" href="http://en.wikipedia.org/wiki/List_of_HTTP_status_codes">http://en.wikipedia.org/wiki/List_of_HTTP_status_codes</a>.</p></div><div class="section" title="Performing redirections"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec24"/>Performing redirections</h2></div></div></div><p>It is <a id="id72" class="indexterm"/>also possible to redirect visitors using the <code class="literal">redirect()</code> helper <a id="id73" class="indexterm"/>in your routes. If, for example, we wanted everyone to be redirected to <code class="literal">/cats</code> when they visit the application for the first time, we would write the following lines of code:</p><div class="informalexample"><pre class="programlisting">Route::get('/', function() {
  <span class="strong"><strong>return redirect('cats');</strong></span>
});</pre></div><p>Now, we<a id="id74" class="indexterm"/> can create the route for the URL we're redirecting <a id="id75" class="indexterm"/>to:</p><div class="informalexample"><pre class="programlisting">Route::get('cats', function() {
  return 'All cats';
});</pre></div></div><div class="section" title="Returning views"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec25"/>Returning views</h2></div></div></div><p>The <a id="id76" class="indexterm"/>most frequent object that you will return from your routes<a id="id77" class="indexterm"/> is the <code class="literal">View</code> object. Views receive data from a route (or controller action) and inject it into a template, therefore helping you to separate the business and presentation logic in your application.</p><p>To add your first view, simply create a file called <code class="literal">about.php</code> at <code class="literal">resources/views</code> and add the following content to it:</p><div class="informalexample"><pre class="programlisting">&lt;h2&gt;About this site&lt;/h2&gt;
There are over &lt;?php echo $number_of_cats; ?&gt; cats on this site!</pre></div><p>Then, return the view using the <code class="literal">view()</code> helper function with the variable, <code class="literal">$number_of_cats</code>:</p><div class="informalexample"><pre class="programlisting">Route::get('about', function() {
  return view('about')-&gt;with('number_of_cats', 9000);
});</pre></div><p>Finally, visit <code class="literal">/about</code> in your browser to see the rendered view. This view was written with plain PHP; however, Laravel comes with a powerful template language called Blade, which will be introduced later in this chapter.</p></div></div>
<div class="section" title="Preparing the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec21"/>Preparing the database</h1></div></div></div><p>Before<a id="id78" class="indexterm"/> we can expand the functionality of our routes, we need to define the models of our application, prepare the necessary database schema, and populate the database with some initial data.</p><p>Homestead ships with a MySQL server built in, so we can use MySQL for our database; however, it does require a little bit of configuration first, before we can use a MySQL database in our application.</p><p>The first step is to open our application's configuration file, which should have been created at <code class="literal">.env</code> when we created the application with Composer. Find the line that says <code class="literal">DB_DATABASE=homestead</code> and change it to <code class="literal">DB_DATABASE=furbook</code>.</p><p>We can<a id="id79" class="indexterm"/> also add the database name to our Homestead configuration file, so that the database is created automatically for us. Open the file from the command line, using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ homestead edit</strong></span>
</pre></div><p>Under the <code class="literal">databases</code> section, add a new line:</p><div class="informalexample"><pre class="programlisting">databases:
    - homestead
    <span class="strong"><strong>- furbook</strong></span>
</pre></div><p>Save the file, then run the <code class="literal">homestead provision</code> command to create the database.</p><div class="section" title="Creating Eloquent models"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec26"/>Creating Eloquent models</h2></div></div></div><p>The first<a id="id80" class="indexterm"/> and easiest step is to define the models<a id="id81" class="indexterm"/> with which our application is going to interact. At the beginning of this chapter, we identified two main entities: <span class="emphasis"><em>cats</em></span> and <span class="emphasis"><em>breeds</em></span>. Laravel ships with Eloquent, a powerful ORM that lets you define these entities, map them to their corresponding database tables, and interact with them using PHP methods, rather than raw SQL. By convention, they are written in the singular form; a model named <code class="literal">Cat</code> will map to the <code class="literal">cats</code> table in the database, and a hypothetical <code class="literal">Mouse</code> model will map to the <code class="literal">mice</code> table. You can also manually define the name of the database table using the aptly-named <code class="literal">$table</code> property, in case your table name doesn't follow the convention expected by Laravel:</p><div class="informalexample"><pre class="programlisting">protected $table = 'custom_table_name';</pre></div><p>The <code class="literal">Cat</code> model, saved at <code class="literal">app/Cat.php</code>, will have a <code class="literal">belongsTo</code> relationship with the <code class="literal">Breed</code> model, which is defined in the following code snippet:</p><div class="informalexample"><pre class="programlisting">&lt;?php namespace Furbook;

use Illuminate\Database\Eloquent\Model;

class Cat extends Model {
  protected $fillable = ['name','date_of_birth','breed_id'];
  public function breed() {
    return $this-&gt;belongsTo('Furbook\Breed');
  }
}</pre></div><p>The <code class="literal">$fillable</code> array defines the list of fields that Laravel can fill by <span class="strong"><strong>mass assignment</strong></span>, which is<a id="id82" class="indexterm"/> a convenient way to assign attributes to a model. By convention, the column that Laravel will use to find the related model has to be called <code class="literal">breed_id</code> in the database. The <code class="literal">Breed</code> model, <code class="literal">app/Breed.php</code>, is defined with the inverse <code class="literal">hasMany</code> relationship as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?php namespace Furbook;

use Illuminate\Database\Eloquent\Model;

class Breed extends Model {
  public $timestamps = false;
  public function cats(){
    return $this-&gt;hasMany('Furbook\Cat');
  }
}</pre></div><p>By <a id="id83" class="indexterm"/>default, Laravel expects a <code class="literal">created_at</code> and <code class="literal">updated_at</code> timestamp field in the database table. Since we are not interested in storing<a id="id84" class="indexterm"/> these timestamps with the breeds, we disable them in the model by setting the <code class="literal">$timestamps</code> property to <code class="literal">false</code>:</p><div class="informalexample"><pre class="programlisting">protected $timestamps = false;</pre></div><p>This is the entire code that is required in our models for now. We will discover various other features of Eloquent as we progress in this book; however, in this chapter, we will primarily use two methods: <code class="literal">all()</code> and <code class="literal">find()</code>. To illustrate their purpose, here are the SQL queries that they generate:</p><div class="informalexample"><pre class="programlisting">Furbook\Breed::all()     =&gt; SELECT * FROM breeds;
Furbook\Cat::find(1)     =&gt; SELECT * FROM cats WHERE id = 1;</pre></div><p>The properties of an Eloquent model can be retrieved with the <code class="literal">-&gt;</code> operator: <code class="literal">$cat-&gt;name</code>. The same goes for the properties of the related models, which are accessible with: <code class="literal">$cat-&gt;breed-&gt;name</code>. Behind the scenes, Eloquent will perform the necessary SQL joins.</p></div><div class="section" title="Building the database schema"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec27"/>Building the database schema</h2></div></div></div><p>Now<a id="id85" class="indexterm"/> that we have defined our models, we need to <a id="id86" class="indexterm"/>create the corresponding database schema. Thanks to Laravel's support for migrations and its powerful schema builder, you will not have to write any SQL code and you will also be able to keep track of any schema changes in a version control system. To create your first migration, open a new terminal window and enter the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php artisan make:migration create_breeds_table --create=breeds</strong></span>
</pre></div><p>This will create a new migration at <code class="literal">database/migrations/</code>. If you open the newly created file, you will find some code that Laravel has generated for you. Migrations always have an <code class="literal">up()</code> and <code class="literal">down()</code> method that defines the schema changes when migrating up or down. Migrating up is modifying the database schema (that is, adding a table at a later date), whereas, migrating down is the process of undoing that schema change. By<a id="id87" class="indexterm"/> convention, the table and field names are<a id="id88" class="indexterm"/> written in snake_case. Also, the table names are written in plural form.</p><p>Our <code class="literal">breeds</code> table migration will look like this:</p><div class="informalexample"><pre class="programlisting">  public function up() {
    Schema::create('breeds', function($table) {
      $table-&gt;increments('id');
      $table-&gt;string('name');
    });
  }
  public function down() {
    Schema::drop('breeds');
  }</pre></div><p>We can repeat the process to also create our <code class="literal">cats</code> table schema:</p><div class="informalexample"><pre class="programlisting">public function up() {
  Schema::create('cats', function($table) {
    $table-&gt;increments('id');
    $table-&gt;string('name');
    $table-&gt;date('date_of_birth');
    $table-&gt;integer('breed_id')-&gt;unsigned()-&gt;nullable();
    $table-&gt;foreign('breed_id')-&gt;references('id')-&gt;on('breeds');
  });
}
public function down() {
  Schema::drop('cats');
}</pre></div><p>The <code class="literal">date()</code> and <code class="literal">string()</code> methods create fields with the corresponding types (in this case, <code class="literal">DATE</code> and <code class="literal">VARCHAR</code>) in the database, <code class="literal">increments()</code> creates an auto-incrementing <code class="literal">INTEGER</code> primary key, and <code class="literal">timestamps()</code> adds the <code class="literal">created_at</code> and <code class="literal">updated_at DATETIME</code> fields that Eloquent expects, by default. The <code class="literal">nullable()</code> method specifies that the column can have <code class="literal">NULL</code> values.</p><p>Laravel offers the following methods for defining migrations:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Command</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;bigIncrements('name');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates an auto-incrementing big integer column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;bigInteger('name');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">BIGINT</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;binary('name');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">BLOB</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;boolean('active');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">BOOLEAN</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;char('name', 8);</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">CHAR</code> column with the given length</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;date('birthdate');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">DATE</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;dateTime('created_at');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">DATETIME</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;decimal('amount', 5, 2);</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates<a id="id89" class="indexterm"/> a <code class="literal">DECIMAL</code> column<a id="id90" class="indexterm"/> with the given precision and scale</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;double('column', 10, 5);</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">DOUBLE</code> column, with 10 digits in total and 5 after the decimal point</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;enum('gender', ['Female', 'Male']);</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates an <code class="literal">ENUM</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;float('amount');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">FLOAT</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;increments('id');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates an auto-incrementing integer column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;integer('rating');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates an <code class="literal">INTEGER</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;json('options');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">JSON</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;longText('description');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">LONGTEXT</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;mediumInteger('name');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">MEDIUMINT</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;mediumText('name');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">MEDIUMTEXT</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;morphs('taggable');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates two columns: <code class="literal">INTEGER taggable_id</code> and <code class="literal">STRING taggable_type</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;nullableTimestamps();</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>This is similar to timestamps (next), but allows <code class="literal">NULL</code> values</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;rememberToken();</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It adds a <code class="literal">remember_token VARCHAR</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;tinyInteger('name');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">TINYINT</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;softDeletes();</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It adds a <code class="literal">deleted_at</code> column for soft deletes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;string('name');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">VARCHAR</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;string('name', 255);</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">VARCHAR</code> column of the given length</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;text('name');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">TEXT</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;time('name');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">TIME</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;timestamp('name');</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates a <code class="literal">TIMESTAMP</code> column</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$table-&gt;timestamps();</strong></span>
</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>It creates <code class="literal">created_at</code> and <code class="literal">deleted_at</code> columns</p>
</td></tr></tbody></table></div><p>We've also created a foreign key in the <code class="literal">cats</code> migration. This links the <code class="literal">breed_id</code> column value to an ID in the <code class="literal">breeds</code> table. This is so that we don't have to keep specifying the breed <a id="id91" class="indexterm"/>name over and over again. We can just reference <a id="id92" class="indexterm"/>one record in the <code class="literal">breeds</code> table. If that record is updated, then all <code class="literal">cats</code> linked to it will also be updated.</p><p>To run both of the migrations, enter the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php artisan migrate</strong></span>
</pre></div><p>When it is run for the first time, this command will also create a <code class="literal">migrations</code> table that Laravel will use to keep track of the migrations that have been run. It will then run any outstanding migrations. On subsequent runs, the command will use the <code class="literal">migrations</code> table to determine if any migration files need running, and run them, if so.</p><p>We <a id="id93" class="indexterm"/>created our <code class="literal">breeds</code> table migration before the <code class="literal">cats</code> table migration because we have a <span class="strong"><strong>foreign key</strong></span> in our <code class="literal">cats</code> table. If we were to try and create the <code class="literal">cats</code> table first, it will fail as the column it is referencing does not exist yet.</p></div><div class="section" title="Seeding the database"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec28"/>Seeding the database</h2></div></div></div><p>Rather<a id="id94" class="indexterm"/> than manually populating our database, we can use the seeding helpers offered by Laravel. This time, there is no Artisan command to generate the file, but all we need to do is create a new class called <code class="literal">BreedsTableSeeder.php</code> at <code class="literal">database/seeds/</code>. This class extends Laravel's <code class="literal">Seeder</code> class and defines the following <code class="literal">run()</code> method:</p><div class="informalexample"><pre class="programlisting">class BreedsTableSeeder extends Seeder {
  public function run() {
    DB::table('breeds')-&gt;insert([
      ['id' =&gt; 1, 'name' =&gt; "Domestic"],
      ['id' =&gt; 2, 'name' =&gt; "Persian"],
      ['id' =&gt; 3, 'name' =&gt; "Siamese"],
      ['id' =&gt; 4, 'name' =&gt; "Abyssinian"],
    ]);
  }
}</pre></div><p>You can bulk insert an array but you can also insert arbitrary code in the <code class="literal">run()</code> method to load data from say, a CSV or JSON file. There are also third-party libraries that can help you generate large amounts of test data to fill your database, such as the excellent Faker.</p><p>To control the order of execution of the seeders, Laravel lets you call them individually at <code class="literal">database/seeds/DatabaseSeeder.php</code>. In our case, since we only have one seeder, all we need to write is the following line:</p><div class="informalexample"><pre class="programlisting">$this-&gt;call('BreedsTableSeeder');</pre></div><p>Then, we can seed the database by calling it, using the following command:</p><div class="informalexample"><pre class="programlisting">$ php artisan db:seed</pre></div><p>Seeding is<a id="id95" class="indexterm"/> good for initially populating a database. If we were to re-run the seed command, we would actually get an error as we're defining primary keys for our records; if we tried re-seeding, the database will trigger a duplicate primary key error. We can first truncate the table, but this will be dangerous if deployed to a production environment, as it will delete any user-contributed records, as well as your seed data definitions!</p></div></div>
<div class="section" title="Mastering Blade"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec22"/>Mastering Blade</h1></div></div></div><p>Now that <a id="id96" class="indexterm"/>we have some information in our database, we need to define the templates that are going to display it. Blade is Laravel's lightweight template language and its syntax is very easy to learn. Here are some examples of how Blade can reduce the number of keystrokes and increase the readability of your templates:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Standard PHP syntax</p>
</th><th style="text-align: left" valign="bottom">
<p>Blade syntax</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">&lt;?php echo $var; ?&gt;</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">{!! $var !!}</pre></div><p>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">&lt;?php echo htmlentities($var); ?&gt;</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">{{ $var }}</pre></div><p>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">&lt;?php if ($cond): ?&gt;…&lt;?php endif; ?&gt;</pre></div><p>
</p>
</td><td style="text-align: left" valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">@if ($cond) … @endif</pre></div><p>
</p>
</td></tr></tbody></table></div><p>If you use the default double braces notation, then variables are escaped. This is to protect against XSS vulnerabilities (explained in more detail in <a class="link" href="ch07.html" title="Chapter 7. Authentication and Security">Chapter 7</a>, <span class="emphasis"><em>Authentication and Security</em></span>). If you really need the raw value of variable un-escaped, then you can use single braces, with two exclamation marks inside on each side. You should only do this if you trust the value that the variable contains.</p><p>Blade also supports all of PHP's major constructs to create loops and conditions: <code class="literal">@for</code>, <code class="literal">@foreach</code>, <code class="literal">@while</code>, <code class="literal">@if</code>, and <code class="literal">@elseif</code>, allowing you to avoid opening and closing the <code class="literal">&lt;?php</code> tags <a id="id97" class="indexterm"/>everywhere in your templates.</p><div class="section" title="Creating a master view"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec29"/>Creating a master view</h2></div></div></div><p>Blade lets<a id="id98" class="indexterm"/> you build hierarchical layouts by allowing the <a id="id99" class="indexterm"/>templates to be nested and extended. The following code snippet is<a id="id100" class="indexterm"/> the <span class="strong"><strong>master</strong></span> template that we are going to use for our application. We will save it as <code class="literal">resources/views/layouts/master.blade.php</code>.</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8" /&gt;
    &lt;title&gt;Furbook&lt;/title&gt;
<span class="strong"><strong>    &lt;link rel="stylesheet" href="{{ asset('css/bootstrap.min.css') }}"&gt;</strong></span>
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class="container"&gt;
      &lt;div class="page-header"&gt;
<span class="strong"><strong>        @yield('header')</strong></span>
      &lt;/div&gt;
<span class="strong"><strong>      @if (Session::has('success'))</strong></span>
        &lt;div class="alert alert-success"&gt;
<span class="strong"><strong>          {{ Session::get('success') }}</strong></span>
        &lt;/div&gt;
<span class="strong"><strong>      @endif</strong></span>
<span class="strong"><strong>      @yield('content')</strong></span>
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div><p>The <a id="id101" class="indexterm"/>Bootstrap CSS framework is included to speed up the prototyping of the application interface. You can download it from <a class="ulink" href="http://getbootstrap.com">http://getbootstrap.com</a> and place the minified CSS file at <code class="literal">public/css/</code>. To ensure that its path prefix is set correctly, even when Laravel is run from a subfolder, we use the <code class="literal">asset()</code> helper. You can see the complete list of Blade template helpers that are available to you, visit <a class="ulink" href="http://laravel.com/docs/helpers">http://laravel.com/docs/helpers</a>.</p><p>To inform the user about the outcome of certain actions, we have prepared a notification area between the header and the page content. This <a id="id102" class="indexterm"/>
<span class="strong"><strong>flash data</strong></span> (in other words, the session data that is only available for the next request) is passed and retrieved to and from the <code class="literal">Session</code> object.</p><p>The <code class="literal">@yield</code> directives act as placeholders for the different sections that a child view can populate and override. To see how a child template can re-use them, we are going to recreate the <code class="literal">about</code> view by changing its extension to <code class="literal">.blade.php</code> and extending our <code class="literal">master</code> layout template instead:</p><div class="informalexample"><pre class="programlisting">@extends('layouts.master')
@section('header')
  &lt;h2&gt;About this site&lt;/h2&gt;
@stop
@section('content')
  &lt;p&gt;There are over {{ $number_of_cats }} cats on this site!&lt;/p&gt;
@stop</pre></div><p>The <code class="literal">@section ... @stop</code> directives delimit the blocks of content that are going to be injected <a id="id103" class="indexterm"/>into the master template. You can see how this is<a id="id104" class="indexterm"/> done in the following diagram:</p><div class="mediaobject"><img src="graphics/B04308_03_01.jpg" alt="Creating a master view"/></div><p>If you now reopen the <code class="literal">/about</code> route in your web browser, without changing anything in your previous route definition, you will see the new view. Laravel's view finder will simply use the new file, and since its name ends with <code class="literal">.blade.php</code>, treat it like a Blade template.</p></div></div>
<div class="section" title="Back to the routes"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec23"/>Back to the routes</h1></div></div></div><p>Now that <a id="id105" class="indexterm"/>we have a main layout template that we can extend and re-use, we can start to create the individual routes of our application at <code class="literal">app/Http/routes.php</code>, along with the different views that will display the application data.</p><div class="section" title="The overview page"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec30"/>The overview page</h2></div></div></div><p>This is the <span class="emphasis"><em>index</em></span> page that is going to display all of the cats using the <code class="literal">cats.index</code> view. We will <a id="id106" class="indexterm"/>also re-use this view for the second route where cats are filtered by breed, since both the routes are almost identical. Note that Laravel expects you to use the dot notation (<code class="literal">cats.index</code> and not <code class="literal">cats/index</code>) to refer to a view located inside a subdirectory:</p><div class="informalexample"><pre class="programlisting">Route::get('cats', function() {
  $cats = Furbook\Cat::all();
  return view('cats.index')-&gt;with('cats', $cats);
});

Route::get('cats/breeds/{name}', function($name) {
<span class="strong"><strong>  $breed = Furbook\Breed::with('cats')</strong></span>
<span class="strong"><strong>    -&gt;whereName($name)</strong></span>
<span class="strong"><strong>    -&gt;first();</strong></span>
  return view('cats.index')
    -&gt;with('breed', $breed)
    -&gt;with('cats', $breed-&gt;cats);
});</pre></div><p>The only novelty in these routes is the slightly more advanced Eloquent queries. While we already know that the <code class="literal">all()</code> method in the first route loads all of the entries from the <code class="literal">cats</code> table, the second route uses a more complex query. The <code class="literal">with('cats')</code> method will load any related <code class="literal">cat</code> models. The <code class="literal">whereName</code> is a dynamic method that creates a <code class="literal">WHERE</code> SQL clause, which will translate to <code class="literal">WHERE name = $name</code>. The long-hand expression of this will be <code class="literal">where('name', '=', $name)</code>. Finally, we fetch the first breed record (and related cat models) with the <code class="literal">first()</code> method.</p><p>The template, saved at <code class="literal">cats/index.blade.php</code>, will look like this:</p><div class="informalexample"><pre class="programlisting">@extends('layouts.master')

@section('header')
  @if (isset($breed))
    &lt;a href="{{ url('/') }}"&gt;Back to the overview&lt;/a&gt;
  @endif
&lt;h2&gt;
  All @if (isset($breed)){{ $breed-&gt;name }}@endif Cats

  &lt;a href="{{ url('cats/create') }}" class="btn btn-primary pull-right"&gt;
    Add a new cat
  &lt;/a&gt;
&lt;/h2&gt;
@stop
@section('content')
  @foreach ($cats as $cat)
    &lt;div class="cat"&gt;
      &lt;a href="{{ url('cats/'.$cat-&gt;id) }}"&gt;
        &lt;strong&gt;{{ $cat-&gt;name }}&lt;/strong&gt; - {{ $cat-&gt;breed-&gt;name }}
      &lt;/a&gt;
    &lt;/div&gt;
  @endforeach
@stop</pre></div><p>With the<a id="id107" class="indexterm"/> help of a <code class="literal">foreach</code> loop, the view iterates over the list of cats that it received from the route. Since we will be using this view to display both the index page (<code class="literal">/cats</code>) as well as the breed overview page (<code class="literal">/cats/breeds/{breed}</code>), we used the <code class="literal">@if</code> directives in two places to conditionally display more information.</p></div><div class="section" title="Displaying a cat's page"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec31"/>Displaying a cat's page</h2></div></div></div><p>The<a id="id108" class="indexterm"/> next route is used to display a single cat. To find a cat by its ID, we use Eloquent's <code class="literal">find()</code> method:</p><div class="informalexample"><pre class="programlisting">Route::get('cats/{id}', function($id) {
  $cat = Furbook\Cat::find($id);
  return view('cats.show) -&gt;with('cat', $cat);
});</pre></div><div class="section" title="Route-model binding"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec04"/>Route-model binding</h3></div></div></div><p>Route-model binding is the method of automatically transforming a route parameter to a model <a id="id109" class="indexterm"/>instance, so we don't have to manually retrieve the model. Since this is such a common pattern, Laravel provides you with a way to automatically bind a model to a route and, therefore, make your code shorter and more expressive. To bind the <code class="literal">$cat</code> variable to the <code class="literal">Cat</code> model, open <code class="literal">app/Providers/RouteServiceProvider.php</code>. Modify the <code class="literal">boot()</code> method so that it looks like this:</p><div class="informalexample"><pre class="programlisting">public function boot(Router $router) {
  parent::boot($router);
  $router-&gt;model('cat', 'Furbook\Cat');
}</pre></div><p>This allows you to shorten your route and pass a <code class="literal">Cat</code> object to it instead:</p><div class="informalexample"><pre class="programlisting">Route::get('cats/{cat}', function(Furbook\Cat $cat) {
  return view('cats.show')-&gt;with('cat', $cat);
});</pre></div><p>The view, <code class="literal">cats/show.blade.php</code>, does not contain any new directives. It simply displays<a id="id110" class="indexterm"/> the name of the cat with the links to edit or delete it. In the <code class="literal">content</code> section, we return its age and breed if the breed is set; this is shown in the following snippet:</p><div class="informalexample"><pre class="programlisting">@extends('layouts.master')

@section('header')
  &lt;a href="{{ url('/') }}"&gt;Back to overview&lt;/a&gt;
  &lt;h2&gt;
      {{ $cat-&gt;name }}
  &lt;/h2&gt;
  &lt;a href="{{ url('cats/'.$cat-&gt;id.'/edit') }}"&gt;
    &lt;span class="glyphicon glyphicon-edit"&gt;&lt;/span&gt;
	Edit
  &lt;/a&gt;
  &lt;a href="{{ url('cats/'.$cat-&gt;id.'/delete') }}"&gt;
    &lt;span class="glyphicon glyphicon-trash"&gt;&lt;/span&gt;
	Delete
  &lt;/a&gt;
  &lt;p&gt;Last edited: {{ $cat-&gt;updated_at-&gt;diffForHumans() }}&lt;/p&gt;
@stop

@section('content')
  &lt;p&gt;Date of Birth: {{ $cat-&gt;date_of_birth }}&lt;/p&gt;
  &lt;p&gt;
    @if ($cat-&gt;breed)
      Breed:
      {{ link_to('cats/breeds/'.$cat-&gt;breed-&gt;name, $cat-&gt;breed-&gt;name) }}
    @endif
  &lt;/p&gt;
@stop</pre></div></div></div><div class="section" title="Adding, editing, and deleting cats"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec32"/>Adding, editing, and deleting cats</h2></div></div></div><p>The next<a id="id111" class="indexterm"/> series<a id="id112" class="indexterm"/> of routes and views will be used to <a id="id113" class="indexterm"/>create, edit, and delete a cat page.</p><p>Until version 5, Laravel came with a package for creating common HTML and form elements. In Laravel 5 applications, we need to bring this package back into use. We do this via Composer.</p><p>In the <code class="literal">require</code> section of <code class="literal">composer.json</code>, add the following code:</p><div class="informalexample"><pre class="programlisting">"laravelcollective/html": "5.0.*"</pre></div><p>Then run <code class="literal">$ composer update</code>. This will install the package. Next, we need to register the service provider and façades. Open <code class="literal">config/app.php</code> and add the following the <code class="literal">$providers</code> array:</p><div class="informalexample"><pre class="programlisting">'Collective\Html\HtmlServiceProvider',</pre></div><p>Then <a id="id114" class="indexterm"/>add<a id="id115" class="indexterm"/> the following two lines to the <code class="literal">$facades</code> array:</p><div class="informalexample"><pre class="programlisting">'Form' =&gt; 'Collective\Html\FormFacade',
'HTML' =&gt; 'Collective\Html\HtmlFacade',
</pre></div><p>This now<a id="id116" class="indexterm"/> gives us a lot of helpful methods with which to build forms in our templates.</p><p>Although Blade templates are hierarchical, it is still possible to include other templates in views, as you may be used to doing with the <code class="literal">include()</code> or <code class="literal">require()</code> functions in PHP. We will use this to share the form fields needed for both the create and edit templates.</p><p>In <code class="literal">resources/views/partials/forms/cat.blade.php</code>, add the following content:</p><div class="informalexample"><pre class="programlisting">&lt;div class="form-group"&gt;
  {!! Form::label('name', 'Name') !!}
  &lt;div class="form-controls"&gt;
    {!! Form::text('name', null, ['class' =&gt; 'form-control']) !!}
  &lt;/div&gt;
&lt;/div&gt;
&lt;div class="form-group"&gt;
  {!! Form::label('date_of_birth', 'Date of Birth') !!}
  &lt;div class="form-controls"&gt;
    {!! Form::date('date_of_birth', null, ['class' =&gt; 'form-control']) !!}
  &lt;/div&gt;
&lt;/div&gt;
&lt;div class="form-group"&gt;
  {!! Form::label('breed_id', 'Breed') !!}
  &lt;div class="form-controls"&gt;
    {!! Form::select('breed_id', $breeds, null, ['class' =&gt; 'form-control']) !!}
  &lt;/div&gt;
&lt;/div&gt;
{!! Form::submit('Save Cat', ['class' =&gt; 'btn btn-primary']) !!}</pre></div><p>The <code class="literal">Form::select()</code> helper builds a <code class="literal">&lt;select&gt;</code> dropdown with the different choices. It expects the list of choices to be passed to a multidimensional array. Rather than binding this array to <a id="id117" class="indexterm"/>each route, we can use <span class="strong"><strong>view composers</strong></span>, another feature of Laravel, which allows you to bind a variable to a specific view each time.</p><p>We can initialize a view composer by adding it to our application's service provider. Open <code class="literal">app/Providers/AppServiceProvider.php</code> and change the <code class="literal">boot()</code> method to look like this:</p><div class="informalexample"><pre class="programlisting">public function boot(ViewFactory $view) {
  $view-&gt;composer('partials.forms.cat', 'App\Http\Views\Composers\CatFormComposer');
}</pre></div><p>We also need to resolve <code class="literal">ViewFactory</code>. At the top of the file, underneath the namespace declaration, add the following line:</p><div class="informalexample"><pre class="programlisting">use Illuminate\Contracts\View\Factory as ViewFactory;</pre></div><p>We now<a id="id118" class="indexterm"/> need <a id="id119" class="indexterm"/>to create the actual view composer<a id="id120" class="indexterm"/> class. We've specified the path, so let's create the file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php namespace Furbook\Http\Views\Composers;
use Furbook\Breed;
use Illuminate\Contracts\View\View;

class CatFormComposer {
  protected $breeds;
  public function __construct(Breed $breeds) {
    $this-&gt;breeds = $breeds;
  }
  public function compose(View $view) {
    $view-&gt;with('breeds', $this-&gt;breeds-&gt;lists('name', 'id');
  }
}</pre></div><p>Now when the <code class="literal">partials.forms.cat</code> template partial is called, the view composer kicks in. When Laravel instantiates it, it'll read the constructor and automatically inject instances of the specified types. In our view composer's constructor, we specify that we need an instance of our <code class="literal">Breed</code> model, and then store the instance as a class property.</p><p>Once the view composer has been initialized, the <code class="literal">compose()</code> method is called. This is where the actual binding of data to the view occurs. As our model is an Eloquent model, we can use the <code class="literal">lists()</code> method that fetches all records in an associative array, which is just what we need for our <code class="literal">select</code> list. The first parameter is the value that the user will see (the breed name in this instance) and the second parameter is what will be used as the <code class="literal">value</code> attribute in the <code class="literal">&lt;option&gt;</code> tag (the breed ID).</p><p>Now that we have a partial form with breed options automatically being injected when requested, we can continue on with building the create, edit, and delete views.</p><p>The create view is straightforward: we extend out master layout, open our form, and then include the partial we've just created. In <code class="literal">resources/views/cats/create.blade.php</code>, add the following code:</p><div class="informalexample"><pre class="programlisting">@extends('layouts.master')
@section('header')
  &lt;h2&gt;Add a new cat&lt;/h2&gt;
@stop
@section('content')
  {!! Form::open(['url' =&gt; '/cats']) !!}
    @include('partials.forms.cat')
  {!! Form::close() !!}
@stop</pre></div><p>The edit template (<code class="literal">resources/views/cats/edit.blade.php</code>) will look similar, barring a few small changes:</p><div class="informalexample"><pre class="programlisting">@extends('layouts.master')
@section('header')
  &lt;h2&gt;Edit a cat&lt;/h2&gt;
@stop
@section('content')
  {!! Form::model($cat, ['url' =&gt; '/cats/'.$cat-&gt;id],
    'method' =&gt; 'put') !!}
    @include('partials.forms.cat')
  {!! Form::close() !!}
@stop
</pre></div><p>We didn't include<a id="id121" class="indexterm"/> the opening and closing form tags in the partial, as we need <a id="id122" class="indexterm"/>to change the action URL and method depending on the action. Also, in<a id="id123" class="indexterm"/> the edit template, we're using form-model binding to bind the <code class="literal">Cat</code> instance passed to our template, to the form. This automatically populates the values of the form fields with the value of the attributes in our <code class="literal">Cat</code> model instance.</p><p>Now that we have our views, we can create the corresponding routes:</p><div class="informalexample"><pre class="programlisting">Route::get('cats/create', function() {
  return view('cats.create');
});

Route::post('cats', function() {
<span class="strong"><strong>  $cat = Furbook\Cat::create(Input::all());</strong></span>
  return redirect('cats/'.$cat-&gt;id)
    -&gt;withSuccess('Cat has been created.');
});

Route::get('cats/{cat}/edit', function(Furbook\Cat $cat) {
  return view('cats.edit')-&gt;with('cat', $cat);
});

Route::put('cats/{cat}', function(Furbook\Cat $cat) {
<span class="strong"><strong>  $cat-&gt;update(Input::all());</strong></span>
  return redirect('cats/'.$cat-&gt;id)
    -&gt;withSuccess('Cat has been updated.');
});

Route::delete('cats/{cat}', function(Furbook\Cat $cat) {
<span class="strong"><strong>  $cat-&gt;delete();</strong></span>
  return redirect('cats')
    -&gt;withSuccess('Cat has been deleted.');
});</pre></div><p>You might <a id="id124" class="indexterm"/>have noticed that a new method <code class="literal">withSuccess()</code> is being used in<a id="id125" class="indexterm"/> the preceding routes in conjunction with our redirects. This isn't an <a id="id126" class="indexterm"/>explicitly defined method; instead, it is an example of <span class="strong"><strong>overloading</strong></span> in <a id="id127" class="indexterm"/>Laravel. In the context of redirects, Laravel looks at method calls that have <code class="literal">with</code> in the beginning; it takes the latter part and assigns it to the session flash data. This includes the session variables that will be available in the next request, and the next request only. This makes it perfect for single-use data such as success messages, as we have seen earlier.</p><p>If you look back at our master layout template, you can see the provision we have to check for any session variables with the key <code class="literal">success</code>; if it exists, we simply display it in a Bootstrap success alert.</p><p>Any input data that is received by the application and that you would normally access via the <code class="literal">$_GET</code> or <code class="literal">$_POST</code> variables is instead retrievable by using the <code class="literal">Input::get()</code> method. It is also possible to retrieve an array of all the input data with <code class="literal">Input::all()</code>. In the <code class="literal">POST /cats</code> and <code class="literal">PUT /cats/{cat}</code> routes respectively, we use the <code class="literal">create()</code> and <code class="literal">update()</code> methods from Eloquent with <code class="literal">Input::all()</code> as their argument. This is only possible because we specified the fields that are fillable in the <code class="literal">Cat</code> model beforehand.</p><p>We now have a working application where users can add, edit, and delete cats.</p></div></div>
<div class="section" title="Moving from simple routing to powerful controllers"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec24"/>Moving from simple routing to powerful controllers</h1></div></div></div><p>So far, we<a id="id128" class="indexterm"/> have been creating <span class="strong"><strong>closure-based routes</strong></span>. This <a id="id129" class="indexterm"/>is great for quickly prototyping applications, and is prevalent in micro-frameworks such as <span class="strong"><strong>Silex</strong></span> and <span class="strong"><strong>Slim</strong></span>; however, as your <a id="id130" class="indexterm"/>application<a id="id131" class="indexterm"/> grows, this approach might become cumbersome and limiting. The alternative (and recommended) approach to defining the logic to be executed when a route is requested is in controllers, the C in MVC.</p><p>A <a id="id132" class="indexterm"/>controller is usually a class, containing one or more methods, also known as <span class="strong"><strong>actions</strong></span>. You usually have a route map to a controller action.</p><p>Consider the following example:</p><div class="informalexample"><pre class="programlisting">Route::get('user/{id}', ['middleware' =&gt; ['auth'], function($id) {
  // Perform some operations
  return 'Something';
}]);</pre></div><p>To<a id="id133" class="indexterm"/> achieve the same functionality with a controller and remove the business logic from the routes, create a new file at <code class="literal">app/Http/Controllers/UserController.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php namespace Furbook\Http\Controllers;

class UserController extends Controller {
  public function __construct()
  {
    $this-&gt;middleware('auth');
  }
  public function show($id)
  {
    $this-&gt;doSomething();
    return 'Something';
  }
  protected function doSomething()
  {
    // Perform some operations
  }
}</pre></div><p>This approach can greatly improve the reusability and testability of your code, especially if your theoretical <code class="literal">doSomething()</code> method is used in more than one controller action. You can test it just once in isolation, and then rely on it. When you venture into more advanced topics such as dependency injection, you can even swap entire classes when you instantiate the controller, but we will not cover this here.</p><p>Finally, to tell Laravel which controller action to use, simply rewrite the route declaration as follows:</p><div class="informalexample"><pre class="programlisting">Route::get('user/{id}', ['uses' =&gt; 'UserController@show']);</pre></div><p>The root controller namespace (<code class="literal">App\Http\Controllers</code>) is automatically prepended to the controller class name to avoid the task of specifying it for each and every route.</p><div class="section" title="Resource controllers"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec33"/>Resource controllers</h2></div></div></div><p>Laravel greatly <a id="id134" class="indexterm"/>simplifies the creation of REST APIs with resource controllers. Since they adhere to conventions, there is only a limited defined set of actions that can be performed from the controller. In fact, all the routes we created earlier can be rewritten as follows:</p><div class="informalexample"><pre class="programlisting">Route::resource('cat', 'CatController');</pre></div><p>This will register the following routes:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Verb</p>
</th><th style="text-align: left" valign="bottom">
<p>Path</p>
</th><th style="text-align: left" valign="bottom">
<p>Action</p>
</th><th style="text-align: left" valign="bottom">
<p>Route Name</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cat</code>
</p>
</td><td style="text-align: left" valign="top">
<p>index</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">cat.index</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cat/create</code>
</p>
</td><td style="text-align: left" valign="top">
<p>create</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">cat.create</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">POST</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cat</code>
</p>
</td><td style="text-align: left" valign="top">
<p>store</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">cat.store</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cat/{id}</code>
</p>
</td><td style="text-align: left" valign="top">
<p>show</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">cat.show</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cat/{id}/edit</code>
</p>
</td><td style="text-align: left" valign="top">
<p>edit</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">cat.edit</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">PUT/PATCH</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cat/{id}</code>
</p>
</td><td style="text-align: left" valign="top">
<p>update</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">cat.update</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">DELETE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/cat/{id}</code>
</p>
</td><td style="text-align: left" valign="top">
<p>destroy</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">cat.destroy</code>
</p>
</td></tr></tbody></table></div><p>Then, in your <code class="literal">CatController</code> class, you will have all of the different actions: <code class="literal">index</code>, <code class="literal">create</code>, <code class="literal">show</code>, <code class="literal">edit</code>, and so on. These will then be wired up to respond to the correct route and HTTP verb.</p><p>You can create a stub resource controller with the following Artisan command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php artisan make:controller CatController</strong></span>
</pre></div><p>Why not try re-writing the closure-based route actions into your new <code class="literal">CatController</code> class?</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec25"/>Summary</h1></div></div></div><p>We have covered a lot in this chapter. You learned how to define routes, prepare the models of the application, and interact with them. Moreover, we have had a glimpse at the many powerful features of Eloquent, Blade, as well as the other convenient helpers in Laravel to create forms and input fields—all of this in under 200 lines of code!</p><p>In the next chapter, you will learn more about Laravel's powerful ORM, Eloquent, which allows you to perform powerful database queries without writing a line of SQL.</p></div></body></html>