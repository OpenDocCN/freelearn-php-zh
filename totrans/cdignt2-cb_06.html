<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Working with Databases"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Working with Databases</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Configuring CodeIgniter for databases</li><li class="listitem" style="list-style-type: disc">Connecting to multiple databases</li><li class="listitem" style="list-style-type: disc">Active Record – Create (insert)</li><li class="listitem" style="list-style-type: disc">Active Record – Read (select)</li><li class="listitem" style="list-style-type: disc">Active Record – Update</li><li class="listitem" style="list-style-type: disc">Active Record – Delete</li><li class="listitem" style="list-style-type: disc">Looping through database results</li><li class="listitem" style="list-style-type: disc">Counting the number of returned results with num_rows()</li><li class="listitem" style="list-style-type: disc">Counting the number of returned results with count_all_results()</li><li class="listitem" style="list-style-type: disc">Counting the number of returned results</li><li class="listitem" style="list-style-type: disc">Query binding</li><li class="listitem" style="list-style-type: disc">Finding the last insert ID</li><li class="listitem" style="list-style-type: disc">Finding the number of affected rows</li><li class="listitem" style="list-style-type: disc">Finding the last database query</li><li class="listitem" style="list-style-type: disc">Using CodeIgniter database migrations</li><li class="listitem" style="list-style-type: disc">Moving to the current version with current()</li><li class="listitem" style="list-style-type: disc">Rolling back/stepping forward with version()</li><li class="listitem" style="list-style-type: disc">Generating an XML from a database result</li><li class="listitem" style="list-style-type: disc">Generating a CSV from a database result</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec51"/>Introduction</h1></div></div></div><p>Pretty much any application you build will require database access and a functionality, from basic <span class="strong"><strong>Create</strong></span>, <span class="strong"><strong>Read</strong></span>, <a id="id344" class="indexterm"/>
<span class="strong"><strong>Update</strong></span>, and <span class="strong"><strong>Delete</strong></span> (<span class="strong"><strong>CRUD</strong></span>) operations to more sophisticated approaches. In this chapter, we'll look at some fairly simple recipes (for example, simple CRUD operations), and then some more capable recipes such as connecting to multiple databases, database caching, and generating files as output.</p><p>Some recipes are quite simple, so I won't provide all the files for you to copy (in some cases, it may be unnecessary); instead, many of the recipes are small blocks of code that you can drop into real-world scenarios as you need to.</p></div></div>
<div class="section" title="Configuring CodeIgniter for databases"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec52"/>Configuring CodeIgniter for databases</h1></div></div></div><p>If you have already <a id="id345" class="indexterm"/>configured CodeIgniter to connect with <a id="id346" class="indexterm"/>a database, you can skip this part, as all we're going to do is make sure we can connect to a database; to do this, we're going to amend the following two files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/config/database.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/config/autoload.php</code></li></ul></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec100"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">database.php</code> config file, look for the following lines and amend them accordingly:<div class="informalexample"><pre class="programlisting">$db['default']['hostname'] = 'localhost'; 
$db['default']['username'] = 'Replace with database username'; 
$db['default']['password'] = 'Replace with database password'; 
$db['default']['database'] = 'Replace with database name'; </pre></div><p>The chances are that you'll not need to change <code class="literal">$db['default']['hostname']</code> from the <code class="literal">'localhost'</code>, and replace other values (<code class="literal">username</code>, <code class="literal">password</code>, and <code class="literal">database</code>) with the specific values for your environment.</p></li><li class="listitem">In the <code class="literal">autoload.php</code> config file, look for the following line (around line 55):<div class="informalexample"><pre class="programlisting">$autoload['libraries'] = array(); </pre></div></li><li class="listitem">Ensure that the database is being autoloaded by adding it to the <code class="literal">$autoload</code> array like this:<div class="informalexample"><pre class="programlisting">$autoload['libraries'] = array('database'); </pre></div><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip08"/>Tip</h3><p>Be sure to separate each library you're auto-loading with a comma, for example, <code class="literal">$autoload['libraries'] = array('database', 'session', 'javascript')</code> and so on.</p></div></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec101"/>How it works...</h2></div></div></div><p>There's not a lot to this really; it's only setting the configuration settings, but one interesting point is that of autoloading the <a id="id347" class="indexterm"/>libraries. By placing a library name in this array in the autoload configuration file, <a id="id348" class="indexterm"/>you no longer need to load the library explicitly in a controller later in your application.</p></div></div>
<div class="section" title="Connecting to multiple databases"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec53"/>Connecting to multiple databases</h1></div></div></div><p>There may be times when you <a id="id349" class="indexterm"/>require your application to connect to more than one database or database server. For example, imagine you managed an online shop, and you may wish to have one database to handle customer orders, billing, invoicing, and so on, and another database to store and maintain product and stock information. CodeIgniter can be configured to use many database instances, and the following section shows how you do it.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec102"/>Getting ready</h2></div></div></div><p>In order to let CodeIgniter interact with two or more databases, we'll need to amend a few settings in the <code class="literal">config</code> file at:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/config/database.php</code></li></ul></div><p>Scroll down to the bottom of the file and copy the following into it. Remember to replace <code class="literal">hostname</code>, <code class="literal">username</code>, <code class="literal">password</code>, and <code class="literal">database</code> with the correct details for your setup.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$db['database1']['hostname'] = ''; </strong></span>
<span class="strong"><strong>$db['database1']['username'] = ''; </strong></span>
<span class="strong"><strong>$db['database1']['password'] = ''; </strong></span>
<span class="strong"><strong>$db['database1']['database'] = 'database1'; </strong></span>
$db['database1']['dbdriver'] = 'mysql'; 
$db['database1']['dbprefix'] = ''; 
<span class="strong"><strong>$db['database1']['pconnect'] = FALSE; </strong></span>
$db['database1']['db_debug'] = FALSE; 
$db['database1']['cache_on'] = FALSE; 
$db['database1']['cachedir'] = ''; 
$db['database1']['char_set'] = 'utf8'; 
$db['database1']['dbcollat'] = 'utf8_general_ci'; 
$db['database1']['swap_pre'] = ''; 
$db['database1']['autoinit'] = TRUE; 
$db['database1']['stricton'] = FALSE; 

<span class="strong"><strong>$db['database2']['hostname'] = ''; </strong></span>
<span class="strong"><strong>$db['database2']['username'] = ''; </strong></span>
<span class="strong"><strong>$db['database2']['password'] = ''; </strong></span>
<span class="strong"><strong>$db['database2']['database'] = 'database2'; </strong></span>
$db['database2']['dbdriver'] = 'mysql'; 
$db['database2']['dbprefix'] = ''; 
<span class="strong"><strong>$db['database2']['pconnect'] = FALSE; </strong></span>
$db['database2']['db_debug'] = FALSE; 
$db['database2']['cache_on'] = FALSE; 
$db['database2']['cachedir'] = ''; 
$db['database2']['char_set'] = 'utf8'; 
$db['database2']['dbcollat'] = 'utf8_general_ci'; 
$db['database2']['swap_pre'] = ''; 
$db['database2']['autoinit'] = TRUE; 
$db['database2']['stricton'] = FALSE;</pre></div><p>Look closely at the lines in bold. The first four lines in each database group details the standard host, username, password, and database name for each database you wish to use. But, also look at the following lines:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$db['database1']['pconnect'] = FALSE; </strong></span>
<span class="strong"><strong>$db['database2']['pconnect'] = FALSE; </strong></span>
</pre></div><p>The database configuration setting <code class="literal">'pconnect'</code> tells CodeIgniter whether you wish to have persistent connections or not. <a id="id350" class="indexterm"/>Setting this value to <code class="literal">False</code> in each database group allows CodeIgniter to communicate with more than one database. We're going to create two databases with one table in each. Obviously, your requirements will be different, but you can adapt to the recipe as necessary. Copy the following code into your database:</p><div class="informalexample"><pre class="programlisting">CREATE DATABASE  `database1` ;
USE `database1`;

CREATE TABLE `table1` (
  `t1_id` int(11) NOT NULL AUTO_INCREMENT,
  `t1_first_name` varchar(255) NOT NULL,
  `t1_last_name` varchar(255) NOT NULL,
  PRIMARY KEY (`t1_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=3 ;

INSERT INTO `table1` (`t1_id`, `t1_first_name`, `t1_last_name`) VALUES
(1, 'Lucy', 'Welsh'),
(2, 'Rob', 'Foster');

CREATE DATABASE  `database2` ;
USE `database2`;

CREATE TABLE `table2` (
  `t2_id` int(11) NOT NULL AUTO_INCREMENT,
  `t2_first_name` varchar(255) NOT NULL,
  `t2_last_name` varchar(255) NOT NULL,
  PRIMARY KEY (`t2_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=3 ;

INSERT INTO `table2` (`t2_id`, `t2_first_name`, `t2_last_name`) VALUES
(1, 'Oliver', 'Welsh'),
(2, 'Chloe', 'Graves');</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec103"/>How to do it...</h2></div></div></div><p>Now, we have two databases to work with and have configured the <code class="literal">database.php</code> configuration file to communicate with <a id="id351" class="indexterm"/>both of them, so now we can begin to access each database in turn.</p><p>We're going to create the controller, <code class="literal">'database1'</code>, and <code class="literal">'database2'</code> files that would be available at:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/multi_database.php</code>: This is the controller file; it will call models for both databases <code class="literal">'database1'</code> and <code class="literal">'database2'</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/multi_database_model_db_1.php</code>: This model will communicate with the first database <code class="literal">'database1'</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/multi_database_model_db_2.php</code>: This model will communicate with the second database <code class="literal">'database2'</code>.</li></ul></div><p>The following steps will help us in accessing each database:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Ensure that <code class="literal">$db['users']['pconnect']</code> in <code class="literal">/config/database.php</code> is set to <code class="literal">FALSE</code>, and you have entered the correct access information for each database.</li><li class="listitem">Create the file <code class="literal">/path/to/codeigniter/application/controllers/multi_database.php</code>. This controller will call the two database models and output results from each. Add the following code to the controller file <code class="literal">multi_database.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Multi_database extends CI_Controller {

  function __construct() {
    parent::__construct();
    $this-&gt;load-&gt;helper('url'); 
  }

  public function index() {
    redirect('multi_database/select');
  }

  public function select() {   
    $this-&gt;load-&gt;model('Multi_database_model_db_1');
    $query1 = $this-&gt;Multi_database_model_db_1-&gt;select_1();

    $this-&gt;load-&gt;model('Multi_database_model_db_2');
    $query2 = $this-&gt;Multi_database_model_db_2-&gt;select_2();

    foreach ($query1-&gt;result() as $row1) {
      echo $row1-&gt;t1_first_name . ' ' . $row1-&gt;t1_last_name;
      echo '&lt;br /&gt;';
    }

    foreach ($query2-&gt;result() as $row2) {
      echo $row2-&gt;t2_first_name . ' ' . $row2-&gt;t2_last_name;
      echo '&lt;br /&gt;';      
    }
  }
}</pre></div></li><li class="listitem">Create the model <code class="literal">/path/to/codeigniter/application/models/multi_database_model_db_1php</code>. This model will <a id="id352" class="indexterm"/>communicate with <code class="literal">'database1'</code>. Add the following code to the model:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');
class Multi_database_model_db_1 extends CI_Model {
  function __construct() {
    parent::__construct();
  }

  function select_1() {
    $DBconn1 = $this-&gt;load-&gt;database('database1', TRUE);	    
    $query1 = $DBconn1-&gt;query("SELECT * FROM `table1`");
    return $query1;
  }
}</pre></div></li><li class="listitem">Create the model <code class="literal">/path/to/codeigniter/application/models/multi_database_model_db_2.php</code>. This model will communicate with <code class="literal">'database2'</code>. Add the following code to the model:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Multi_database_model_db_2 extends CI_Model {
  function __construct() {
    parent::__construct();
  }

  function select_2() {
    $DBconn2 = $this-&gt;load-&gt;database('database2', TRUE);
    $query2 = $DBconn2-&gt;query("SELECT * FROM `table2`");
    return $query2;
  }
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec104"/>How it works...</h2></div></div></div><p>Firstly, let's pay attention to the settings we've defined for each one of our databases in the file <code class="literal">/path/to/codeigniter/application/config/database.php</code>. These database settings are specific to each database we want to connect to. We have also set the configuration variable <code class="literal">'pconnect'</code> to <code class="literal">FALSE</code> for each of our databases (see the preceding bold text). When we run the controller <code class="literal">Multi_database</code> in the browser, the controller will load our two database models named—for ease of explanation—<code class="literal">'Multi_database_model_db_1'</code> and <code class="literal">'Multi_database_model_db_2'</code>. The <code class="literal">Multi_database</code> controller will then call one function from each model, again named <code class="literal">select_1</code> and <code class="literal">select_2</code> for ease of explanation. The following code shows the same:</p><div class="informalexample"><pre class="programlisting">    $this-&gt;load-&gt;model('Multi_database_model_db_1');
    $query1 = $this-&gt;Multi_database_model_db_1-&gt;select_1();

    $this-&gt;load-&gt;model('Multi_database_model_db_2');
    $query2 = $this-&gt;Multi_database_model_db_2-&gt;select_2();</pre></div><p>Okay! So far so good. There's nothing <a id="id353" class="indexterm"/>new here—just calling some database models; however, it's inside those models that things get interesting. Let's take a look at the code for the model <code class="literal">Multi_database_model_db_1</code>:</p><div class="informalexample"><pre class="programlisting">    function select_1() {
      $DBconn1 = $this-&gt;load-&gt;database('database1', TRUE);      
      $query1 = $DBconn1-&gt;query("SELECT * FROM `table1`");
      return $query1;
    }</pre></div><p>We're loading the database <code class="literal">'database1'</code>—meaning, we're connecting to a database called <code class="literal">'database1'</code> using the settings defined for <code class="literal">'database1'</code> in the <code class="literal">database.php</code> configuration file—and storing that in the object which we're calling, that is, <code class="literal">$DBconn1</code>:</p><div class="informalexample"><pre class="programlisting">      $DBconn1 = $this-&gt;load-&gt;database('database1', TRUE);</pre></div><p>Next, we're using the database object <code class="literal">$DBconn1</code> to run a query and store the database result object in the variable <code class="literal">$query1</code>:</p><div class="informalexample"><pre class="programlisting">      $query1 = $DBconn1-&gt;query("SELECT * FROM `table1`");</pre></div><p>We then return <code class="literal">$query</code> to the calling controller. The controller <code class="literal">Multi_database</code> then loops through the <code class="literal">$query1</code> result object, echoing as we go:</p><div class="informalexample"><pre class="programlisting">    foreach ($query1-&gt;result() as $row1) {
      echo $row1-&gt;t1_first_name . ' ' . $row1-&gt;t1_last_name;
      echo '&lt;br /&gt;';
    }</pre></div></div></div>
<div class="section" title="Active Record &#x2013; create (insert)"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec54"/>Active Record – create (insert)</h1></div></div></div><p>There are several ways to insert <a id="id354" class="indexterm"/>data into a database using <a id="id355" class="indexterm"/>CodeIgniter Active Record; for example, <code class="literal">$this-&gt;db-&gt;insert()</code> and <code class="literal">$this-&gt;db-&gt;insert_batch()</code>. The first will insert only one record at a time, and the <a id="id356" class="indexterm"/>second will insert an array of data as <a id="id357" class="indexterm"/>individual rows into the database; this can be quite useful if you know you need to insert more than one record at a time, thereby saving you the trouble of calling <code class="literal">insert()</code> more than once.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec105"/>Getting ready</h2></div></div></div><p>This is the SQL code required to support this recipe; you'll need to adapt it to your circumstances. Copy the following SQL code into your database:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `ch6_users` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `firstname` varchar(50) NOT NULL,
  `lastname` varchar(50) NOT NULL,
  `username` varchar(20) NOT NULL,
  `password` varchar(20) NOT NULL,
  `created_date` int(11) NOT NULL,
  `is_active` varchar(3) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec106"/>How to do it...</h2></div></div></div><p>We're going to create the following two files (or amend those files if you have already created them):</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/database.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/database_model.php</code></li></ul></div><p>The following steps will demonstrate how to insert data into a database using CodeIgniter Active Record:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following code into the controller <code class="literal">database.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed'); 

class Database extends CI_Controller { 

  function __construct() { 
    parent::__construct();
  }

  public function index() { 
    redirect('database/create');
  } 

  public function create() { 
    $data = array( 
      'firstname' =&gt; 'Lucy', 
      'lastname' =&gt; 'Welsh', 
      'username' =&gt; 'lucywelsh', 
      'password' =&gt; 'password', 
      'created_date' =&gt; time(), 
      'is_active' =&gt; 'yes' 
    ); 

    $this-&gt;load-&gt;model('Database_model');
    if ($this-&gt;Database_model-&gt;insert_data($data) ) { 
      echo 'Success';  
    } 
    else 
    {
      echo 'Cannot insert to database';
    }     

  }

  public function create_batch() { 
    $data = array( 
      array( 
        'firstname' =&gt; 'Lucy', 
        'lastname' =&gt; 'Welsh', 
        'username' =&gt; 'lwelsh', 
        'password' =&gt; 'password', 
        'created_date' =&gt; time(), 
        'is_active' =&gt; 'yes'), 
      array( 
        'firstname' =&gt; 'claire', 
        'lastname' =&gt; 'Strickland', 
        'username' =&gt; 'cstrickland', 
        'password' =&gt; 'password', 
        'created_date' =&gt; time(), 
        'is_active' =&gt; 'yes'), 
       array( 
        'firstname' =&gt; 'Douglas', 
        'lastname' =&gt; 'Morrisson', 
        'username' =&gt; 'dmorrisson', 
        'password' =&gt; 'password', 
        'created_date' =&gt; time(), 
        'is_active' =&gt; 'yes') 
      ); 

    $this-&gt;load-&gt;model('Database_model'); 
    if ($this-&gt;Database_model-&gt;insert_batch_data($data)) { 
      echo 'Success';  
    } 
    else
    {
      echo 'Cannot insert to database';
    }     
  }
}</pre></div></li><li class="listitem">Add the following code <a id="id358" class="indexterm"/>into the model <code class="literal">database_model.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed'); 
class Database_model extends CI_Model { 

  function __construct() { 
    parent::__construct(); 
  } 

  function insert_data($data) { 
    $this-&gt;db-&gt;insert('ch6_users', $data);
  } 
  
  function insert_batch_data($data) { 
    $this-&gt;db-&gt;insert_batch('ch6_users',$data);
  } 
} </pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec107"/>How it works...</h2></div></div></div><p>There are two methods used here: <code class="literal">create() </code>and <code class="literal">create_batch()</code>. Let's take each function in turn and go through how they work.</p><div class="section" title="The public function create()"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl4sec01"/>The public function create()</h3></div></div></div><p>The <code class="literal">create()</code> <a id="id359" class="indexterm"/>function should be fairly familiar; we're creating an array (named <code class="literal">$data</code>) and populating it with the data for one user or equivalent to one row's insert. The <code class="literal">create()</code> method then passes the <code class="literal">$data</code> <a id="id360" class="indexterm"/>array to the model function <code class="literal">insert_data()</code> with the following code:</p><div class="informalexample"><pre class="programlisting">    $this-&gt;load-&gt;model('Database_model'); 
    $this-&gt;Database_model-&gt;insert_data($data); </pre></div><p>The model will then insert one row into the table <code class="literal">ch6_users</code>:</p><div class="informalexample"><pre class="programlisting">    function insert_data($data) { 
      $this-&gt;db-&gt;insert('ch6_users', $data); 
    } </pre></div></div><div class="section" title="The public function create_batch()"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl4sec02"/>The public function create_batch()</h3></div></div></div><p>The <code class="literal">create_batch()</code> public function similar to the preceding functionality of <code class="literal">create()</code>, <a id="id361" class="indexterm"/>but rather than passing an array with one set of items, we create a multidimensional array with multiple rows of data as follows:</p><div class="informalexample"><pre class="programlisting">    $data = array( 
      array( 
        'firstname' =&gt; 'Lucy', 
        'lastname' =&gt; 'Welsh', 
        'username' =&gt; 'lwelsh', 
        'password' =&gt; 'password', 
        'created_date' =&gt; time(), 
        'is_active' =&gt; 'yes'), 
      array( 
        'firstname' =&gt; 'claire', 
        'lastname' =&gt; 'Strickland', 
        'username' =&gt; 'cstrickland', 
        'password' =&gt; 'password', 
        'created_date' =&gt; time(), 
        'is_active' =&gt; 'yes'), 
       array( 
        'firstname' =&gt; 'Douglas', 
        'lastname' =&gt; 'Morrisson', 
        'username' =&gt; 'dmorrisson', 
        'password' =&gt; 'password', 
        'created_date' =&gt; time(), 
        'is_active' =&gt; 'yes') 
    ); </pre></div><p>We then send that array to a new model function <code class="literal">create_batch()</code>:</p><div class="informalexample"><pre class="programlisting">    function insert_batch_data($data) { 
      $this-&gt;db-&gt;insert_batch('ch6_users',$data); 
    } </pre></div><p>The <code class="literal">function create_batch()</code> <a id="id362" class="indexterm"/>function uses the CodeIgniter <code class="literal">function insert_batch()</code> to INSERT each row into the database.</p></div></div></div>
<div class="section" title="Active Record &#x2013; read (select)"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec55"/>Active Record – read (select)</h1></div></div></div><p>The R of CRUD represents the process to select data from a database. CodeIgniter <a id="id363" class="indexterm"/>uses the <code class="literal">$this-&gt;db-&gt;get()</code> database function to fetch rows from the database. Its usage is explained in the following sections.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec108"/>Getting ready</h2></div></div></div><p>The following is the SQL code required to support this recipe; you'll need to adapt it to your circumstances.</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `ch6_users` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `firstname` varchar(50) NOT NULL,
  `lastname` varchar(50) NOT NULL,
  `username` varchar(20) NOT NULL,
  `password` varchar(20) NOT NULL,
  `created_date` int(11) NOT NULL,
  `is_active` varchar(3) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;

INSERT INTO `ch6_users` (`firstname`, `lastname`, `username`, `password`, `created_date`, `is_active`) VALUES
('claire', 'Strickland', 'cstrickland', 'password', 1366114115, 'yes'),
('Douglas', 'Morrisson', 'dmorrisson', 'password', 1366114115, 'yes'),
('Jessica', 'Welsh', 'jesswelsh', 'password', 1366114115, 'yes');</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec109"/>How to do it...</h2></div></div></div><p>We're going to create the following two files (or amend those files if you have already created them): </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/database.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/database_model.php\</code></li></ul></div><p>The following steps will demonstrate how to read data into a database using CodeIgniter Active Record:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following code into the file <code class="literal">/path/to/codeigniter/application/controllers/database.php</code>:<div class="informalexample"><pre class="programlisting">  public function select_row() { 
    $id = 1; 
    $this-&gt;load-&gt;model('Database_model'); 
    $result = $this-&gt;Database_model-&gt;select_row($id);  
    echo '&lt;pre&gt;'; 

    var_dump($result-&gt;result()); 
  } </pre></div></li><li class="listitem">Add the following code <a id="id364" class="indexterm"/>into the file <code class="literal">/path/to/codeigniter/application/models/database_model.php</code>:<div class="informalexample"><pre class="programlisting">function select_row($id) {	 
  $this-&gt;db-&gt;where('id', $id); 
  $query = $this-&gt;db-&gt;get('ch6_users'); 
  return $query; 
} </pre></div></li></ol></div><p>You know it has worked if you see the following output:</p><div class="informalexample"><pre class="programlisting">array(1) { 
  [0]=&gt; 
  object(stdClass)#20 (7) { 
    ["id"]=&gt; 
    string(1) "1" 
    ["firstname"]=&gt; 
    string(4) "Lucy" 
    ["lastname"]=&gt; 
    string(5) "Welsh" 
    ["username"]=&gt; 
    string(6) "lwelsh" 
    ["password"]=&gt; 
    string(8) "password" 
    ["created_date"]=&gt; 
    string(10) "1366114115" 
    ["is_active"]=&gt; 
    string(3) "yes" 
  } 
} </pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec110"/>How it works...</h2></div></div></div><p>In the preceding controller, <code class="literal">public function select_row()</code> assigns <code class="literal">$id</code> with the value <code class="literal">1</code>—however, this can also be done from <span class="strong"><strong>post</strong></span>, <span class="strong"><strong>get</strong></span>, <span class="strong"><strong>session</strong></span>, or another source—and loads the database model, passing the variable <code class="literal">$id</code> to it as follows:</p><div class="informalexample"><pre class="programlisting">    $this-&gt;load-&gt;model('Database_model'); 
    $this-&gt;Database_model-&gt;insert_batch_data($data);  </pre></div><p>The model function <code class="literal">select_row()</code>
<a id="id365" class="indexterm"/>pulls the matching record from the table <code class="literal">'ch6_users'</code> and returns it to the calling controller.</p></div></div>
<div class="section" title="Active Record &#x2013; update"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec56"/>Active Record – update</h1></div></div></div><p>The U of CRUD represents the process to update data record(s) from a database in a <a id="id366" class="indexterm"/>database. CodeIgniter uses the database function <code class="literal">$this-&gt;db-&gt;update()</code> to update database records; this recipe will explain how it is done.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec111"/>Getting ready</h2></div></div></div><p>The following is the SQL code required to support this recipe; you'll need to adapt it to your circumstances.</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `ch6_users` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `firstname` varchar(50) NOT NULL,
  `lastname` varchar(50) NOT NULL,
  `username` varchar(20) NOT NULL,
  `password` varchar(20) NOT NULL,
  `created_date` int(11) NOT NULL,
  `is_active` varchar(3) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;

INSERT INTO `ch6_users` (`firstname`, `lastname`, `username`, `password`, `created_date`, `is_active`) VALUES ('Jessica', 'Welsh', 'jesswelsh', 'password', 1366114115, 'yes');</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec112"/>How to do it...</h2></div></div></div><p>We're going to create the following two files (or amend those files if you have already created them): </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/database.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/database_model.php</code></li></ul></div><p>The following step will demonstrate how to update data into a database using CodeIgniter Active Record:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following code into the file: <code class="literal">/path/to/codeigniter/application/controllers/database.php</code>:<div class="informalexample"><pre class="programlisting">public function update_row() {
  $id = 1; 

  $data = array( 
    'firstname' =&gt; 'Jessica', 
    'lastname' =&gt; 'Welsh', 
    'username' =&gt; 'jesswelsh', 
    'password' =&gt; 'password', 
    'created_date' =&gt; time(), 
    'is_active' =&gt; 'yes' 
  ); 

  $this-&gt;load-&gt;model('Database_model'); 
  $result = $this-&gt;Database_model-&gt;update_row($id, $data);  

  redirect('database/select_row');
} 

Add the following code into the file: /path/to/codeigniter/application/models/database_model.php:::

function update_row($id, $data) { 
  $this-&gt;db-&gt;where('id', $id); 
  $this-&gt;db-&gt;update('ch6_users', $data); 
}

array(1) { 
  [0]=&gt; 
  object(stdClass)#20 (7) { 
    ["id"]=&gt; 
    string(1) "1" 
    ["firstname"]=&gt; 
    string(7) "Jessica" 
    ["lastname"]=&gt; 
    string(5) "Welsh" 
    ["username"]=&gt; 
    string(9) "jesswelsh" 
    ["password"]=&gt; 
    string(8) "password" 
    ["created_date"]=&gt; 
    string(10) "1366117753" 
    ["is_active"]=&gt; 
    string(3) "yes" 
  } 
} </pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec113"/>How it works...</h2></div></div></div><p>In the controller we just saw, <code class="literal">public function update_row()</code> assigns <code class="literal">$id</code> with the value <code class="literal">1</code>—however this can be from post, <a id="id367" class="indexterm"/>get, session or another source—and loads the database model, passing the variable <code class="literal">$id</code> to it as follows:</p><div class="informalexample"><pre class="programlisting">  $this-&gt;load-&gt;model('Database_model'); 
  $result = $this-&gt;Database_model-&gt;update_row($id, $data);  </pre></div><p>The model function <code class="literal">update_row()</code> <a id="id368" class="indexterm"/>updates the matching record from the table as follows:</p><div class="informalexample"><pre class="programlisting">function update_row($id, $data) { 
  $this-&gt;db-&gt;where('id', $id); 
  $this-&gt;db-&gt;update('ch6_users', $data); 
} </pre></div></div></div>
<div class="section" title="ActiveRecord &#x2013; delete"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec57"/>ActiveRecord – delete</h1></div></div></div><p>The D of CRUD is used for deleting rows of <a id="id369" class="indexterm"/>data in a database table. CodeIgniter uses the <code class="literal">$this-&gt;db-&gt;delete()</code>database function to remove rows from a database; it is <a id="id370" class="indexterm"/>used in the following section.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec114"/>Getting ready</h2></div></div></div><p>The following is the SQL code required to support this recipe; you'll need to adapt it to your circumstances:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `ch6_users` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `firstname` varchar(50) NOT NULL,
  `lastname` varchar(50) NOT NULL,
  `username` varchar(20) NOT NULL,
  `password` varchar(20) NOT NULL,
  `created_date` int(11) NOT NULL,
  `is_active` varchar(3) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;

INSERT INTO `ch6_users` (`firstname`, `lastname`, `username`, `password`, `created_date`, `is_active`) VALUES ('Jessica', 'Welsh', 'jesswelsh', 'password', 1366114115, 'yes');</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec115"/>How to do it...</h2></div></div></div><p>We're going to create the following two files (or amend those files if you have already created them):</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/database.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/database_model.php</code></li></ul></div><p>The following steps will demonstrate how to delete data from a database using CodeIgniter Active Record:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following code into <a id="id371" class="indexterm"/>the file <code class="literal">/path/to/codeigniter/application/controllers/database.php</code>:<div class="informalexample"><pre class="programlisting">public function delete_row() { 
  $id = 1; 

  $this-&gt;load-&gt;model('Database_model'); 
  $result = $this-&gt;Database_model-&gt;delete_row($id);    

  redirect('database/select_row');   
} </pre></div></li><li class="listitem">Add the following code into the file <code class="literal">/path/to/codeigniter/application/models/database_model.php</code>:<div class="informalexample"><pre class="programlisting">function delete_row($id) { 
  $this-&gt;db-&gt;where('id', $id); 
  $this-&gt;db-&gt;delete('ch6_users');
} </pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec116"/>How it works...</h2></div></div></div><p>In the preceding controller, <code class="literal">public function delete_row()</code> assigns <code class="literal">$id</code> with the value <code class="literal">1</code>—however, this can be from post, get, session or another source—and loads the database model, passing the variable <code class="literal">$id</code> to it as follows:</p><div class="informalexample"><pre class="programlisting">  $this-&gt;load-&gt;model('Database_model'); 
  $result = $this-&gt;Database_model-&gt;delete_row($id);    </pre></div><p>The model function <code class="literal">delete_row()</code><a id="id372" class="indexterm"/>deletes the matching record from the table:</p><div class="informalexample"><pre class="programlisting">function delete_row($id) { 
  $this-&gt;db-&gt;where('id', $id); 
  $this-&gt;db-&gt;delete('ch6_users'); 
} </pre></div></div></div>
<div class="section" title="Looping through the database results"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec58"/>Looping through the database results</h1></div></div></div><p>In any application with database <a id="id373" class="indexterm"/>connectivity, you'll probably need to display records from a database; looping through rows of data returned from a query is one of the most common tasks you'll perform in programming. CodeIgniter handles looping through database results using PHP for each statement. In this recipe, we will loop through each record at a time, echoing out the relevant information.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec117"/>Getting ready</h2></div></div></div><p>To support this recipe, we are going to create a database table and write some data to it. If you already have the data, you can skip this recipe; if not, copy the following code into your database:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `loop_table` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `first_name` varchar(255) NOT NULL,
  `last_name` varchar(255) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=3 ;

INSERT INTO `loop_table` (`id`, `first_name`, `last_name`) VALUES
(1, 'Lucy', 'Welsh'),
(2, 'Rob', 'Foster');</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec118"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add or adapt the following code into your controller:<div class="informalexample"><pre class="programlisting">public function loop_through_data() {
  $this-&gt;load-&gt;model('Some_model');
  $data['query'] = $this-&gt;Some_model-&gt;select_data();
  $this-&gt;load-&gt;view('some_view', $data);
}</pre></div></li><li class="listitem">Add or adapt the following code into your model:<div class="informalexample"><pre class="programlisting">function select_data() {
  $query = $this-&gt;db-&gt;get('loop_table');
  return $query;
}</pre></div></li><li class="listitem">Add or adapt the following code into your view:<div class="informalexample"><pre class="programlisting">foreach ($query-&gt;result() as $row) {
  echo $row-&gt;first_name . ' ' . $row-&gt;last_name;
  echo '&lt;br /&gt;';
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec119"/>How it works...</h2></div></div></div><p>Firstly, let's look at the SQL code; if you used the preceding SQL code, all we would have done is create a very simple table and populate it with two rows of data.</p><p>Next, we call the controller function <code class="literal">loop_through_data()</code>, which loads a model; in this case, rename <code class="literal">Some_model</code> to the model relevant to your application. We call the model function <code class="literal">select_data()</code>, storing <a id="id374" class="indexterm"/>its returned result in the <code class="literal">$data</code> array, or more specifically, in a section of the <code class="literal">$data</code> array that we're calling <code class="literal">'query'</code>:</p><div class="informalexample"><pre class="programlisting">  $data['query'] = $this-&gt;Some_model-&gt;select_data();</pre></div><p>The model function <code class="literal">select_data()</code> fetches all the rows from the database table <code class="literal">loop_table</code> and returns it to the calling controller function.</p><p>Returning to our controller, now that we have the database result in our <code class="literal">$data</code> array, we can call the <code class="literal">view</code> file <code class="literal">some_view.php</code>—you obviously need to rename it to something else in your application—and pass the <code class="literal">$data</code> array to it:</p><div class="informalexample"><pre class="programlisting">  $this-&gt;load-&gt;view('some_view', $data);</pre></div><p>The <code class="literal">view</code> file then uses a simple <code class="literal">foreach()</code><a id="id375" class="indexterm"/>loop to cycle through each result in <code class="literal">$query</code>. <a id="id376" class="indexterm"/>Let's look at this <code class="literal">foreach()</code> loop more closely. Look at the following line of code:</p><div class="informalexample"><pre class="programlisting">foreach ($query-&gt;result() as $row) {</pre></div><p>Remember how we stored the database result in <code class="literal">$data['query']</code>? Well, we're going to use the <code class="literal">'query'</code> part of the <code class="literal">$data</code> array, which has stored the database results, and we're going to use the CodeIgniter function <code class="literal">result()</code> on it. I hear you ask, "What does <code class="literal">result()</code> do?" The <code class="literal">result()</code> function <a id="id377" class="indexterm"/>will take an object or array and allow you to iterate through each row, allowing you to act on the individual data items within that row.</p><p>So, we're using <code class="literal">result()</code> to split apart <code class="literal">$query</code> into each row, passing that row to <code class="literal">$row</code> (because it's obvious) and allowing us to do something like:</p><div class="informalexample"><pre class="programlisting">  echo $row-&gt;first_name . ' ' . $row-&gt;last_name;</pre></div><p>This is displaying the first and last name of each person in <code class="literal">$row</code>.</p></div></div>
<div class="section" title="Counting the number of returned results with num_rows()"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec59"/>Counting the number of returned results with num_rows()</h1></div></div></div><p>It's useful to count the <a id="id378" class="indexterm"/>number of results returned—often bugs can arise if a section of the code that expects to have at least one row is passed with zero rows. Without handling the eventuality of a zero result, an application may become unpredictably unstable and may give away hints to a malicious user about the architecture of the app. Ensuring correct handling of zero results is what we're going to focus on here.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec120"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We're going to create a block of code for a model and controller. You may already have code in a controller, model, or view that does all or some of the following—obviously, you can skip any step that you do not need. Add or adapt the ensuing code into your controller:<div class="informalexample"><pre class="programlisting">$this-&gt;load-&gt;model('Some_model');
$data['query'] = $this-&gt;Some_model-&gt;some_model_function();
$this-&gt;load-&gt;view('some_view', $data);</pre></div></li><li class="listitem">Add or adapt the following code into your model:<div class="informalexample"><pre class="programlisting">function some_model_function() {	
       $query = $this-&gt;db-&gt;get('database_table_name');
       return $query;
}</pre></div></li><li class="listitem">Add or adapt the following code into your view:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>if ($query-&gt;num_rows() &gt; 0) {</strong></span>
  foreach ($query-&gt;result() as $row) {
    echo $row-&gt;item1;
    echo $row-&gt;item2;
  }
} else {
  echo 'No results returned';
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec121"/>How it works...</h2></div></div></div><p>This is quite common; a controller loads the required model and calls a function within that model; the result of this model is stored in an array. This is then passed to a view. It is here in the view that we'd count the number of rows. Take a look at the line in bold. We're using the CodeIgniter function <code class="literal">num_rows()</code> to look into the <code class="literal">$query</code> result and count the number of rows returned by the model. We're asking whether the number of rows is greater than zero. If it is, there must be at least one result from the model—we then look through the <code class="literal">$query</code> array as we would normally. However, if the number of results isn't greater than zero, it would mean that there were no results returned by the model. So, we use an else statement to <a id="id379" class="indexterm"/>display a brief message stating that there were <code class="literal">No results returned</code>.</p></div></div>
<div class="section" title="Counting the number of returned results with count_all_results()"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec60"/>Counting the number of returned results with count_all_results()</h1></div></div></div><p>It's useful to count the number <a id="id380" class="indexterm"/>of results returned—often bugs can arise if a section of code which expects to have at least one row is passed zero rows. Without handling the eventuality of a zero result, an application may become unpredictably unstable and may give away hints to a malicious user about the architecture of the app. Ensuring correct handling of zero results is what we're going to focus on here.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec122"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add or adapt the following code into your controller:<div class="informalexample"><pre class="programlisting">$this-&gt;load-&gt;model('Some_model');
$data['num_results'] = $this-&gt;Some_model-&gt;some_model_function();
$this-&gt;load-&gt;view('some_view', $data);</pre></div></li><li class="listitem">Add or adapt the following code into your model:<div class="informalexample"><pre class="programlisting">function some_model_function() {	
  $this-&gt;db-&gt;from('table');
  return $num_rows = $this-&gt;db-&gt;count_all_results();
}</pre></div></li><li class="listitem">Add or adapt the following code into your view:<div class="informalexample"><pre class="programlisting">if (isset($num_results)) {
  echo 'There are ' . $num_results . ' returned';
}</pre></div></li></ol></div><p>This is fairly similar to the recipe above <a id="id381" class="indexterm"/>
<code class="literal">num_rows()</code>, but there are a few key differences. We start off by calling a controller that loads the required model and calls a function within it. Take a look at the code in bold: <code class="literal">$this-&gt;db-&gt;count_all_results();</code>. This will return the number of results returned in a given query. The result of this code is stored in an array and passed to a view where we test whether the variable <code class="literal">$num_results</code> is set; if it is, we echo a <a id="id382" class="indexterm"/>brief message indicating the number of results.</p></div></div>
<div class="section" title="Query binding"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec61"/>Query binding</h1></div></div></div><p>Binding queries is another useful <a id="id383" class="indexterm"/>security process; if you use binding with your queries, values are automatically escaped by CodeIgniter, and there is no need for you to manually do so.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec123"/>Getting ready</h2></div></div></div><p>Copy the following SQL into your database:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `users` (
  `user_id` int(11) NOT NULL AUTO_INCREMENT,
  `user_first_name` varchar(125) NOT NULL,
  `user_last_name` varchar(125) NOT NULL,
  `user_email` varchar(255) NOT NULL,
  `user_created_date` int(11) NOT NULL COMMENT 'unix timestamp',
  `user_is_active` varchar(3) NOT NULL COMMENT 'yes or no',
  PRIMARY KEY (`user_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;

INSERT INTO `users` (`user_first_name`, `user_last_name`, `user_email`, `user_created_date`, `user_is_active`) VALUES
('Chloe', 'Graves', 'cgraves@domain.com', 1366114115, 'yes'),
('Mark', 'Brookes', 'mbrookes@domain.com', 1366114115, 'yes');</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec124"/>How to do it...</h2></div></div></div><p>In any of your models, adapt your query code to reflect the following:</p><div class="informalexample"><pre class="programlisting">$query = "SELECT * FROM users WHERE users.is_active = ? AND users.created_date &gt; ?";
$this-&gt;db-&gt;query($query, 'yes', '1366114114');</pre></div></div><div class="section" title="How it works"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec125"/>How it works</h2></div></div></div><p>Using a table called <code class="literal">users</code> as an example, the query will try to fetch all records where <code class="literal">users.is_active</code> equals <code class="literal">Y</code> and <code class="literal">users.created_date</code> is greater than <code class="literal">1359706809 (02/01/2013 – 03:20)</code>. But, you'll notice that there are two question marks in the query, and each question mark represents an item in the <code class="literal">$data array</code>. The values in the <code class="literal">$data</code> array are passed in order and into the query by the line <code class="literal">$this-&gt;db-&gt;query($query, $data);</code>. So, the first question mark in the query will be replaced with the first item in the array, the second <a id="id384" class="indexterm"/>question mark in the query will be replaced by the second item in the array, and so on.</p></div></div>
<div class="section" title="Finding the last insert id"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec62"/>Finding the last insert id</h1></div></div></div><p>Returning the Primary Key of the <a id="id385" class="indexterm"/>last inserted row can be useful in instances where you may wish to write data to more than one table and whose data may be related via the keys. CodeIgniter provides support for returning the last inserted key.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec126"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add or adapt the following code into a model:<div class="informalexample"><pre class="programlisting">  function insert($data) { 
<span class="strong"><strong>    if ($this-&gt;db-&gt;insert($data, 'table_name')) { </strong></span>
<span class="strong"><strong>      return $this-&gt;db-&gt;last_id();</strong></span>
<span class="strong"><strong>    } else { </strong></span>
<span class="strong"><strong>  return false; </strong></span>
<span class="strong"><strong>  } </strong></span>
} </pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec127"/>How it works...</h2></div></div></div><p>Take a look at the lines in bold. We test for the returned value of <code class="literal">$this-&gt;db-&gt;insert($data);</code>, which will return true if successful and false if there was an error. If the returned value is true, we grab the Primary Key of the last inserted record for this connection; this value along with <code class="literal">return $this-&gt;db-&gt;insert_id();</code>is returned from the model to the code that called the function. If the database insert was unsuccessful, it would return false. You can adapt the above recipe easily; just drop the lines in bold into your model.</p></div></div>
<div class="section" title="Finding the number of affected rows"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec63"/>Finding the number of affected rows</h1></div></div></div><p>Finding the number of affected rows <a id="id386" class="indexterm"/>can be useful in several ways—perhaps you want to update some records and only proceed if a certain number of records are updated, or perhaps you simply want to display the number of rows that have been deleted or updated by a query.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec128"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add or adapt the following code into your model:<div class="informalexample"><pre class="programlisting">  function update($id, $data) {
    $this-&gt;db-&gt;where('id', $id); 
    if ($data-&gt;db-&gt;update($data, 'table_name')) {
      return $this-&gt;db-&gt;affected_rows(); 
    } else { 
      return false; 
    } 
  } </pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec129"/>How it works...</h2></div></div></div><p>The model <code class="literal">function update()</code> <a id="id387" class="indexterm"/>accepts two parameters: a <code class="literal">$data</code> array and the <code class="literal">$id</code> array of the database row we wish to update.</p><p>Next, we test for the returned value of <code class="literal">$this-&gt;db-&gt;update($data);</code>, which will return true if successful and false if there was an error. If the returned value is true, we grab the number of affected rows for the update with the following line:</p><div class="informalexample"><pre class="programlisting">return $this-&gt;db-&gt;affected_rows();  </pre></div><p>If the update doesn't happen, the returned value will be false.</p></div></div>
<div class="section" title="Finding the last database query"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec64"/>Finding the last database query</h1></div></div></div><p>Sometimes, it is useful to know <a id="id388" class="indexterm"/>about the last query that was run against the <a id="id389" class="indexterm"/>database, either for debugging purposes or for reasons where you wish to have an audit trail of every interaction with the database—you'll be surprised at the number of times you'll need to do this. CodeIgniter comes with a really handy function that you can use to write out the most recent query that CodeIgniter sent to the database.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec130"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add or adapt the following line of code into your controller or model:<div class="informalexample"><pre class="programlisting">$this-&gt;db-&gt;last_query();</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec131"/>How it works...</h2></div></div></div><p>Quite simply, this function will return the last query to be sent to the database; you can place it in the controller or model (even the view if you wish, but it's better to keep it at the logical side of your application rather than the view). It will return the query that you can use as an audit in the form of a string; <a id="id390" class="indexterm"/>for example, consider the following line of code:</p><div class="informalexample"><pre class="programlisting">log_message('level', $this-&gt;db-&gt;last_query())</pre></div><p>The preceding line of code will write the last query to your log files, where <code class="literal">'level'</code> denotes the type of message. We will go <a id="id391" class="indexterm"/>through some error reporting and logging recipes in <a class="link" href="ch09.html" title="Chapter 9. Extending the Core">Chapter 9</a>, <span class="emphasis"><em>Extending the core</em></span>.</p></div></div>
<div class="section" title="Using CodeIgniter database migrations"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec65"/>Using CodeIgniter database migrations</h1></div></div></div><p>Imagine that you work in a <a id="id392" class="indexterm"/>team of other developers, and everyone is busy working, making changes to the code and the database structure. Keeping up with all of those changes to a database can become a challenge, particularly if many people are working on roughly the same area of the project.</p><p>CodeIgniter Migration gives you the option to install (or rollback) the changes of a database structure that might support the changes in the code. For example, if you were working on coding changes for, say, a user registration script—this change requires a column to be added to a database table; you could include a CodeIgniter database migration script with your version control commit (assuming you're using version control)—other developers will now know that for your code change to work they must run the migration which would amend their database.</p><p>Migration also allows you to roll back changes. This should not be confused with the database concept of rolling back with transactions; think of rolling back using migrations as uninstalling previously installed changes.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec132"/>Getting ready</h2></div></div></div><p>There are some configuration settings we need to change before we do this, so open <code class="literal">/path/to/codeigniter/application/config/migration.php</code> and find the following options:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Preference</p>
</th><th style="text-align: left" valign="bottom">
<p>Default Value</p>
</th><th style="text-align: left" valign="bottom">
<p>Options</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">migration_enabled</code>
</p>
</td><td style="text-align: left" valign="top">
<p>FALSE</p>
</td><td style="text-align: left" valign="top">
<p>TRUE/</p>
<p>FALSE</p>
</td><td style="text-align: left" valign="top">
<p>Specifies <a id="id393" class="indexterm"/>whether or not you wish migrations to be enabled; TRUE is enabled, and FALSE is disabled.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">migration_version</code>
</p>
</td><td style="text-align: left" valign="top">
<p>0</p>
</td><td style="text-align: left" valign="top">
<p>None</p>
</td><td style="text-align: left" valign="top">
<p>Specifies <a id="id394" class="indexterm"/>the current migration version your database uses or rather the most suitable migration version you wish to work with. We'll talk more about this later in the chapter. By using <code class="literal">current()</code>, we will install the up-to-date value set in <code class="literal">'migration_version'</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">migration_path</code>
</p>
</td><td style="text-align: left" valign="top">
<p>APPPATH.'migrations/'</p>
</td><td style="text-align: left" valign="top">
<p>None</p>
</td><td style="text-align: left" valign="top">
<p>Specifies the <a id="id395" class="indexterm"/>path of the folder where you store the migration files. Migration files are PHP scripts where those queries located that define the necessary database changes. Ensure that you have set the <code class="literal">migrations</code> folder to be writable.</p>
</td></tr></tbody></table></div><p>Be sure to load the migration library in your controller with the following line:</p><div class="informalexample"><pre class="programlisting">$this-&gt;load-&gt;library('migration');</pre></div><p>In this recipe, we're going to create a <a id="id396" class="indexterm"/>simple users table and use a migration library to add and then remove a column from it. Enter the following SQL into your database:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `users` (
  `user_id` int(11) NOT NULL AUTO_INCREMENT,
  `user_first_name` varchar(125) NOT NULL,
  `user_last_name` varchar(125) NOT NULL,
  `user_email` varchar(255) NOT NULL,
  PRIMARY KEY (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec133"/>How to do it...</h2></div></div></div><p>First off, all your database migration files should be placed in the <code class="literal">migrations</code> folder at <code class="literal">/path/to/codeigniter/application/migrations/</code>.</p><p>If the folder does not already exist, you'll need to create it in the <code class="literal">/path/to/codeigniter/application/</code> folder—be sure to give write permissions to it.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We're going to create the following two files:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/migrations/001_add_icon.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/migrate.php</code><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip09"/>Tip</h3><p>Notice the filename <code class="literal">001_add_icon.php</code>. The first part (001) is the migration number; this will increment every time you add a new migration file. The second part (add_icon) is a descriptive indication of the purpose of the migration file. Add the following code into the file <code class="literal">001_add_icon.php</code>. This migration file defines the queries to be run to effect the migration change or to roll back from that change.</p></div></div><div class="informalexample"><pre class="programlisting">&lt;?php defined('BASEPATH') OR exit('No direct script access allowed');
class Migration_Add_icon extends CI_Migration {
  public function up() {
    $this-&gt;db-&gt;query("ALTER TABLE `users` ADD COLUMN `user_icon`  TEXT NULL AFTER `user_email`;");
  }
  public function down() {
    $this-&gt;db-&gt;query("ALTER TABLE `users` DROP COLUMN `user_icon`;");
  }
}</pre></div></li></ul></div></li><li class="listitem">Add the following <a id="id397" class="indexterm"/>code into <code class="literal">/path/to/codeigniter/application/controllers/migrate.php</code>; the migrate controller gives us access to CodeIgniter's migration functions.<div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Migrate extends CI_Controller {
  function __construct() {
    parent::__construct();

    if ( ! $this-&gt;input-&gt;is_cli_request() ) {
      echo 'Only access via command line.';
      exit;
    }

    $this-&gt;load-&gt;library('migration');
  }
  
  public function index() {
    echo 'Config: ' . $config['migration_version'];
  }

  public function current() {
    if ( ! $this-&gt;migration-&gt;current()) {
      show_error($this-&gt;migration-&gt;error_string());
    }        
  }

  public function latest() {
    if ( ! $this-&gt;migration-&gt;latest()) {
    show_error($this-&gt;migration-&gt;error_string());
  }        
}    

  public function version() {
    if ( $this-&gt;uri-&gt;segment(3) == '') {
      echo 'You must specify a migration version number';
    } else {
      if ( ! $this-&gt;migration-&gt;version($this-&gt;uri-&gt;segment(3)) ) {
        show_error($this-&gt;migration-&gt;error_string());
      }       
   } 
  }
}</pre></div></li></ol></div><p>Okay, so what have we done so far? We've configured migrations to run in CodeIgniter, we've created our first migration file (taking care to name it properly), and we have two files: the controller <code class="literal">migrate.php</code> and the migration file <code class="literal">001_add_icon.php</code>.</p><p>In the migration file <code class="literal">001_add_icon.php</code>, there are 222 functions; out of these, <code class="literal">up()</code> and <code class="literal">down()</code> are functions where you would define SQL to go with your code changes. The function <code class="literal">down()</code> is where you would define SQL for removing your changes should someone (perhaps another developer) <a id="id398" class="indexterm"/>wish to revert a code change you might have made; therefore, it supports SQL.</p><p>In the controller <code class="literal">migrate.php</code>, we've created several functions for us to work with migrations, such as <code class="literal">current()</code> and <code class="literal">latest()</code>. The following two recipes will show you some basic usage of these migrations.</p></div></div>
<div class="section" title="Moving to the current version with current()"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec66"/>Moving to the current version with current()</h1></div></div></div><p>To simply alter your database <a id="id399" class="indexterm"/>so that it corresponds with the version <a id="id400" class="indexterm"/>number in <code class="literal">$config['migration_version']</code>, you should use the <code class="literal">current()</code> function.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec134"/>Getting ready</h2></div></div></div><p>Ensure that you have followed the preceding recipe, <span class="emphasis"><em>Using CodeIgniter database migrations</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec135"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Using your command line (terminal application), navigate to the root of your CodeIgniter installation (where the <code class="literal">index.php</code> file is) and type the following:<div class="informalexample"><pre class="programlisting">php index.php migrate current</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec136"/>How it works...</h2></div></div></div><p>Consider the following command line:</p><div class="informalexample"><pre class="programlisting">php index.php migrate current </pre></div><p>The first thing we should bear in mind is the constructor in the migrate controller. The constructor is looking at how the migrate controller is accessed; it'll deny access to the migrate controller if it is accessed via anything other than the command line—a useful security measure.</p><p>By typing the command we just saw, you'll run <code class="literal">public function current()</code>. The function accepts no parameter. CodeIgniter will look into the migrations folder for the file whose number corresponds with the value set in <code class="literal">$config['migration_version']</code> in the configuration file <code class="literal">/path/to/codeigniter/application/config/migration.php</code>.</p></div></div>
<div class="section" title="Rolling back/stepping forward with version()"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec67"/>Rolling back/stepping forward with version()</h1></div></div></div><p>You may wish to deliberately <a id="id401" class="indexterm"/>alter the database by pointing it to a specific <a id="id402" class="indexterm"/>migration number. This can be achieved by use of the <code class="literal">version()</code> function within CodeIgniter.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec137"/>Getting ready</h2></div></div></div><p>Ensure that you have followed the preceding recipe, <span class="emphasis"><em>Using CodeIgniter database migrations</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec138"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Using your command line (terminal application), navigate to the root of your CodeIgniter installation (where the index.php file is) and type the following:<div class="informalexample"><pre class="programlisting">php index.php migrate version 1</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec139"/>How it works...</h2></div></div></div><p>Consider the following command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php index.php migrate version number</strong></span>
</pre></div><p>
<code class="literal">number</code> is highlighted as it specifies the migration file number to move to, that is, <code class="literal">1</code>, <code class="literal">2</code>, <code class="literal">3</code>, and so on.</p><p>The first thing we should bear in mind is the constructor in the migrate controller. The constructor is looking at how the migrate controller is accessed; it'll deny access to the migrate controller if it is accessed via anything other than the command line—a useful security measure.</p><p>By typing the preceding command, <a id="id403" class="indexterm"/>you'll run <code class="literal">public function version()</code>, passing to it the third parameter (which has the value of <code class="literal">1</code>). CodeIgniter will look into the migrations folder for the file whose number corresponds with the third parameter (1), which by amazing coincidence is the number of the migration files we created—who would have known this?</p><p>CodeIgniter will load the migration file <code class="literal">001_add_icon.php</code> and immediately run <code class="literal">public function up()</code>, which will add the column <code class="literal">user_icon</code> to the database table <code class="literal">'users'</code>.</p><p>We can undo the creation of the <code class="literal">user_icon</code> column by entering the following in the command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php index.php migrate version 0</strong></span>
</pre></div><p>CodeIgniter will then run the public function <a id="id404" class="indexterm"/>
<code class="literal">down()</code> in the migration file, which will remove the <code class="literal">user_icon</code> column.</p></div></div>
<div class="section" title="Generating an XML from a database result"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec68"/>Generating an XML from a database result </h1></div></div></div><p>Generating an XML from a database <a id="id405" class="indexterm"/>may be useful in several ways, perhaps you wish to send data from a query across a network using a SOAP request, or perhaps <a id="id406" class="indexterm"/>you're using it to build some data for a web service. Whatever your purpose, this is how to do it—also we'll look at some real-world uses—for example, we'll generate the XML output from a database query.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec140"/>Getting ready</h2></div></div></div><p>Firstly, we need to create a table and enter some example data so that you'll see some data in the CSV format, so with that in mind, copy the following code into SQL:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `users` (
  `user_id` int(11) NOT NULL AUTO_INCREMENT,
  `user_first_name` varchar(125) NOT NULL,
  `user_last_name` varchar(125) NOT NULL,
  `user_email` varchar(255) NOT NULL,
  `user_created_date` int(11) NOT NULL COMMENT 'unix timestamp',
  `user_is_active` varchar(3) NOT NULL COMMENT 'yes or no',
  PRIMARY KEY (`user_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;

INSERT INTO `users` (`user_first_name`, `user_last_name`, `user_email`, `user_created_date`, `user_is_active`) VALUES
('Chloe', 'Graves', 'cgraves@domain.com', 1366114115, 'yes'),
('Mark', 'Brookes', 'mbrookes@domain.com', 1366114115, 'yes');</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec141"/>How to do it...</h2></div></div></div><p>We're going to create the following file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/export.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the controller <code class="literal">export.php</code>. This controller will load the CodeIgniter <code class="literal">dbutil</code> (database utility) class, which will provide support for various database-specific operations and generate the XML. Add the following code into your <code class="literal">export.php</code> controller:<div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Export extends CI_Controller {

  function __construct() {
    parent::__construct();
    $this-&gt;load-&gt;helper('url');
    $this-&gt;load-&gt;dbutil();
  }

  public function index() {
    redirect('export/xml');
  }

  public function xml() {
    $config = array ('root'    =&gt; 'root',
                     'element' =&gt; 'element', 
                     'newline' =&gt; "\n", 
                     'tab'    =&gt; "\t"
                    );

    $query = $this-&gt;db-&gt;query("SELECT * FROM users");

    echo $this-&gt;dbutil-&gt;xml_from_result($query, $config);
  }
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec142"/>How it works...</h2></div></div></div><p>Okay, take a look at the line in bold—we're loading the database utilities class in the controllers constructor. This utilities class contains some excellent functions for working with databases. We're using it to provide <a id="id407" class="indexterm"/>access to the function <code class="literal">xml_from_result()</code>.</p><p>The <code class="literal">export.php</code> controller function <code class="literal">index()</code> redirects us to <code class="literal">public function xml()</code>, which runs a database query. You could, of course, have any source of data here, but we're calling a database and storing the result <a id="id408" class="indexterm"/>in the array <code class="literal">$query</code>. This is passed to the CodeIgniter function <code class="literal">xml_from_result()</code>. The <code class="literal">xml_from_result()</code> function takes the following two parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$query</code>: This is the data for <a id="id409" class="indexterm"/>XML; in this case, the output of our database query.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$config</code>: This is the configuration <a id="id410" class="indexterm"/>parameter; in this case, the XML formatting options.</li></ul></div><p>We then echo the result of <code class="literal">xml_from_result()</code> to the screen—the result of which can be seen by viewing the page source code in your browser. You don't have to echo it out; you can store it in a variable if you require the XML for other purposes.</p><p>Be sure to separate a database query <a id="id411" class="indexterm"/>into its own model—the query is shown in the preceding controller for explanatory purposes.</p></div></div>
<div class="section" title="Generating a CSV from a database result"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec69"/>Generating a CSV from a database result</h1></div></div></div><p>Perhaps one of the most common <a id="id412" class="indexterm"/>things you'll be asked to do, especially if you are building a complex application that may have users, products, orders, and various other metrics is to provide some sort of reporting of that data. Perhaps you'll be <a id="id413" class="indexterm"/>asked to generate a CSV file, and the following sections show how you do it.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec143"/>Getting ready</h2></div></div></div><p>Firstly, we need to create a table and enter some example data so that you'll see some data in the CSV format, so with that in mind, copy the following code into SQL:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `users` (
  `user_id` int(11) NOT NULL AUTO_INCREMENT,
  `user_first_name` varchar(125) NOT NULL,
  `user_last_name` varchar(125) NOT NULL,
  `user_email` varchar(255) NOT NULL,
  `user_created_date` int(11) NOT NULL COMMENT 'unix timestamp',
  `user_is_active` varchar(3) NOT NULL COMMENT 'yes or no',
  PRIMARY KEY (`user_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;

INSERT INTO `users` (`user_first_name`, `user_last_name`, `user_email`, `user_created_date`, `user_is_active`) VALUES
('Chloe', 'Graves', 'cgraves@domain.com', 1366114115, 'yes'),
('Mark', 'Brookes', 'mbrookes@domain.com', 1366114115, 'yes');</pre></div><p>Now that the database is ready we'll need to ensure that you're calling the database utility class; make sure that you call it with the following line:</p><div class="informalexample"><pre class="programlisting">$this-&gt;load-&gt;dbutil();</pre></div><p>You can either put this line in the constructor of your controller or call it in your controller function.</p><p>Also, as we're going to be creating a file, we need the support of the <code class="literal">'file'</code> helper, so make sure you're calling the helper with the <a id="id414" class="indexterm"/>following line:</p><div class="informalexample"><pre class="programlisting">$this-&gt;load-&gt;helper('file');</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec144"/>How to do it...</h2></div></div></div><p>We're going to create the following file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/export.php</code></li></ul></div><div class="section" title="Forcing download"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec11"/>Forcing download</h3></div></div></div><p>Add the following code into your <code class="literal">export.php</code> controller:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Export extends CI_Controller {

  function __construct() {
    parent::__construct();
    $this-&gt;load-&gt;helper('download');
    $this-&gt;load-&gt;dbutil();    
    $this-&gt;load-&gt;helper('url');
  }

  public function index() {
    redirect('export/csv');
  }

  public function csv() {
    $query = $this-&gt;db-&gt;query("SELECT * FROM users");
    $delimiter = ",";
    $newline = "\r\n";    

    force_download('myfile.csv', $this-&gt;dbutil-&gt;csv_from_result($query, $delimiter, $newline));
  }</pre></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec145"/>How it works...</h2></div></div></div><p>Okay, take a look at the lines in bold—we're loading the CodeIgniter helper <code class="literal">'download'</code> and the database utilities class in the <a id="id415" class="indexterm"/>controller constructor. This'll help us with this recipe.</p><p>The <code class="literal">export.php</code> controller function <code class="literal">index()</code> redirects us to <code class="literal">public function csv()</code>, which runs a database query. You could, of course, have any source of data here, but we're calling a database and storing the result in the array <code class="literal">$query</code>. This is passed to the CodeIgniter function <code class="literal">force_download()</code>, <a id="id416" class="indexterm"/>which accepts the following two parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The name and extension of the file to be created (or in this case, downloaded)</li><li class="listitem" style="list-style-type: disc">The data that will go into the file; in this case, we're using the CodeIgniter function <code class="literal">csv_from_result()</code> that will take a row of data from a database query and convert it into a delimiter-separated string of text. <code class="literal">csv_from_result()</code> takes the following three parameters:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$query</code>: This is the data for the <a id="id417" class="indexterm"/>CSV; in this case, the output of our database query</li><li class="listitem" style="list-style-type: disc"><code class="literal">$delimiter</code>: This is the data <a id="id418" class="indexterm"/>delimiter, that is, it specifies how we are separating each cell worth of data; this is usually a comma (<code class="literal">,</code>).</li><li class="listitem" style="list-style-type: disc"><code class="literal">$newline</code>: This is the new <a id="id419" class="indexterm"/>line character; it is usually '<code class="literal">\n\n</code>'</li></ul></div></li></ul></div><p>If all goes according to plan, <code class="literal">force_download()</code> will, as the name says, force a download of the CSV file.</p><div class="section" title="Saving to file"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec12"/>Saving to file</h3></div></div></div><p>Add the following code into your <code class="literal">export.php</code> controller:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Export extends CI_Controller {

  function __construct() {
    parent::__construct();
<span class="strong"><strong>    $this-&gt;load-&gt;helper('url');</strong></span>
<span class="strong"><strong>    $this-&gt;load-&gt;helper('file');</strong></span>
<span class="strong"><strong>    $this-&gt;load-&gt;dbutil();    </strong></span>
  }

  public function index() {
    redirect('export/csv');
  }

  public function csv() {
    $query = $this-&gt;db-&gt;query("SELECT * FROM users");

    $delimiter = ",";
    $newline = "\r\n";

    $data = $this-&gt;dbutil-&gt;csv_from_result($query, $delimiter, $newline);
<span class="strong"><strong>    $path = '/path/to/write/to/myfile.csv';</strong></span>

<span class="strong"><strong>    if ( ! write_file($path, $data)) {</strong></span>
<span class="strong"><strong>         echo 'Cannot write file - permissions maybe?';</strong></span>
<span class="strong"><strong>    } else {</strong></span>
<span class="strong"><strong>         echo 'File write OK';</strong></span>
<span class="strong"><strong>    }</strong></span>
  }</pre></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec146"/>How it works...</h2></div></div></div><p>Okay, take a look at the lines in bold; we're loading the CodeIgniter helpers <code class="literal">'download'</code>, and <code class="literal">'file'</code> and the database utilities class in the controller constructor. This'll help us with this recipe. We're also adding CodeIgniter-specific syntax to write a file to a disk.</p><p>The <code class="literal">export.php</code> controller <code class="literal">function index()</code> redirects us to <code class="literal">public function csv()</code>, which runs a database query. You could, of course, have any source of data here, but we're calling a database query and storing the result in the <code class="literal">$query</code> array. We then call the CodeIgniter <code class="literal">csv_from_result()</code> function where <code class="literal">csv_from_result()</code> takes the following three parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$query</code>: The data for the CSV; in <a id="id420" class="indexterm"/>this case, the output of our database query</li><li class="listitem" style="list-style-type: disc"><code class="literal">$delimiter</code>: The data <a id="id421" class="indexterm"/>delimiter, that is, it specifies how we are separating each cell worth of data</li><li class="listitem" style="list-style-type: disc"><code class="literal">$newline</code>: The new line character; <a id="id422" class="indexterm"/>it is usually set to <code class="literal">'\n\n'</code></li></ul></div><p>The <code class="literal">csv_from_result()</code> function <a id="id423" class="indexterm"/>will store its output in the variable <code class="literal">$data</code>. We then try to run the CodeIgniter <code class="literal">function write_file()</code>, which accepts the following two parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The path to write the file, including the filename and extension; remember that this path should be writeable</li><li class="listitem" style="list-style-type: disc">The data to write to the file</li></ul></div><p>Should all go as per the plan, the recipe will return the message <code class="literal">File write OK</code>—of course, you should replace it with your own code as you see fit. Should it fail, it'll return an error message and again replace it with your own code where necessary.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec147"/>There's more...</h2></div></div></div><p>The chances are that if the file isn't being written, you don't have the necessary permissions to write to the desired destination folder. You will need to amend the permissions for the destination folder so that they are at a level high enough to allow CodeIgniter to write to it. For example, in Linux/Mac, you would use the <code class="literal">chmod</code> command in the terminal.</p></div></div></body></html>