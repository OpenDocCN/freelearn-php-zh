<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;6.&#xA0;Asset Management"><div class="book" id="1565U2-ad3e09b384df46aea690d9c8897d5fe7"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06" class="calibre1"/>Chapter 6. Asset Management</h1></div></div></div><p class="calibre9">Modern web applications are made up of many different components. Second only to functionality, the presentation of our application might be considered the most important aspect of our application. Presentation of our user interface and the corresponding user experience is vital to building excellent web applications. In web applications, the presentation and experience is usually defined by <a id="id313" class="calibre1"/>
<span class="strong"><strong class="calibre2">Cascading Style Sheets</strong></span> (<span class="strong"><strong class="calibre2">CSS</strong></span>), and JavaScript files. With raw HTML, we can include any necessary scripts and styles we need to, however often we need to handle our assets in a programmatic way (such as when using modules, components, or widgets). To help manage our assets, we can use a combination of third-party tools and Yii2's built-in asset manager. In this chapter, we'll cover how to use Yii2's asset management tools, as well as cover several third-party tools we can use to simplify management of our asset files.</p></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Asset Management">
<div class="book" title="Asset bundles"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch06lvl1sec33" class="calibre1"/>Asset bundles</h1></div></div></div><p class="calibre9">Assets in Yii2 are <a id="id314" class="calibre1"/>managed through an asset bundle. An asset bundle in Yii2 is simply a class that declares all the assets that we want to use in our application, and resides within the <code class="email">assets/</code> directory of our application, usually within the <code class="email">AppAsset.php</code> file that declares an <code class="email">AppAsset</code> class that extends <code class="email">yii\web\AssetBundle</code>. Since our default application comes within a pre-defined <code class="email">AppAsset</code> class, let's take a look at what is already defined in that file.</p><div class="note"><pre class="programlisting">&lt;?php

namespace app\assets;
use yii\web\AssetBundle;

class AppAsset extends AssetBundle
{
    public $basePath = '@webroot';
    public $baseUrl = '@web';

    public $css = [
        'css/site.css',
        '//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js'
    ];

    public $js = [ ];

    public $depends = [
        'yii\web\YiiAsset',
        'yii\bootstrap\BootstrapAsset',
    ];
}</pre></div><p class="calibre9">Our example asset <a id="id315" class="calibre1"/>bundle file declares several public properties. The first properties are the base path and base URL for our application which define where our assets should be loaded from. The second properties are an array of CSS and JavaScript files which define which assets should be registered with our asset bundle. Finally our asset bundle defines which asset bundles our current asset bundle depends upon. The details of the most common properties are outlined as follows:</p><div class="note"><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre21">
<p class="calibre22">Property</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Explanation</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">basePath</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">The string or path alias to the public directory of our web server contains the asset files.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">baseUrl</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">The base URL for the relative assets listed in the JS or CSS property.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">css</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">An array of CSS files to include in the asset bundle.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">cssOptions</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">An array of options and conditionals that will be rendered with the generated <code class="literal">&lt;link&gt;</code> tag.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">depends</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">A array of asset bundles that this asset bundle depends upon.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">js</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">An array of JavaScript files to be included in the asset bundle.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">jsOptions</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">An array of options and conditionals that will be rendered with the generated <code class="literal">&lt;script&gt;</code> tag.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">publishOptions</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Options to be passed to the <code class="literal">publish()</code> method of <code class="literal">yii\web\AssetManager</code>.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">sourcePath</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Defines the directory that contains the asset files we want to include in our bundle. Setting this property will override <code class="literal">basePath</code> and <code class="literal">baseUrl</code>.</p>
</td></tr></tbody></table></div></div></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Asset Management">
<div class="book" title="Asset bundles">
<div class="book" title="Using asset bundles"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec65" class="calibre1"/>Using asset bundles</h2></div></div></div><p class="calibre9">After defining <a id="id316" class="calibre1"/>our asset bundles, we then need to include them in our layout files. We can do that by adding the following to the beginning of our main layout file (in our case this is <code class="email">views/layouts/main.php</code>).</p><div class="note"><pre class="programlisting">&lt;?php
use app\assets\AppAsset;
AppAsset::register($this);</pre></div><p class="calibre9">On page load, our asset bundle will register all of its dependent asset bundles, and publish any and all non-web accessible files to a web-accessible directory. Then during the view rendering stage, it will generate all the necessary HTML markup to be included in our view.</p><div class="note" title="Note"><h3 class="title2"><a id="tip103" class="calibre1"/>Tip</h3><p class="calibre9">In the previous instance, <code class="email">$this</code> is an instance of <code class="email">yii\web\View</code>. When working in widgets or components, you can retrieve the view object within a component or widget by using <code class="email">$this-&gt;view</code>.</p></div></div></div></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Asset Management">
<div class="book" title="Asset bundles">
<div class="book" title="Configuration"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec66" class="calibre1"/>Configuration</h2></div></div></div><p class="calibre9">Internally, Yii2 manages <a id="id317" class="calibre1"/>asset bundles and their configuration through the <code class="email">assetManager</code> application component, which is implemented by the <code class="email">yii\web\AssetManager </code>class. By configuring the <code class="email">$bundles</code> property of this component, we can customize how our asset bundles behave. Take for instance the <code class="email">yii\web\JQueryAsset</code> bundle; by default, it provides a version of jQuery from <span class="strong"><strong class="calibre2">Bower</strong></span> (a third-party asset dependency manager we'll cover later in the chapter) when our Yii2 project is installed. If we wanted this asset bundle to use a different version of jQuery, or wanted to improve performance by using a third-party CDN, we could override the jQuery asset bundle options as follows.</p><div class="note"><pre class="programlisting">// config/web.php
return [
    // [...],
    'components' =&gt; [
        // [...],
        'assetManager' =&gt; [
            'bundles' =&gt; [
                'yii\web\JqueryAsset' =&gt; [
                    // Prevents the asset bundle from publishing this file
                    'sourcePath' =&gt; null,
                    'js' =&gt; [
                        'https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js',
                    ]
                ],
            ],
        ],
    ],
];</pre></div><p class="calibre9">In this<a id="id318" class="calibre1"/> instance, we're redefining the JavaScript files for the asset bundle by setting the <code class="email">js</code> parameter to a CloudFlare CDN, and telling our <code class="email">JQueryAsset</code> bundle to not push the asset as it is being rendered from a third-party CDN.</p><p class="calibre9">Alternatively, we can also conditionally redefine which files are rendering, say in the instance where we have a minified version of a script we want to display in production, but a non-minified version we'd like to use in other environments.</p><div class="note"><pre class="programlisting">// config/web.php
return [
    // [...],
    'components' =&gt; [
        // [...],
        'assetManager' =&gt; [
            'bundles' =&gt; [
                'yii\web\JqueryAsset' =&gt; [
                    'js' =&gt; [
                        <span class="strong"><strong class="calibre2">APPLICATION_ENV == 'prod' ? </strong></span>
<span class="strong"><strong class="calibre2">'jquery.min.js' : 'jquery.js'</strong></span>
                    ]
                ],
            ],
        ],
    ],
];</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip104" class="calibre1"/>Tip</h3><p class="calibre9">As a reminder, our <code class="email">APPLICATION_ENV</code> constant is dependent upon our multi-environment setup we established in <a class="calibre1" title="Chapter 1. Composer, Configuration, Classes, and Path Aliases" href="part0014_split_000.html#DB7S2-ad3e09b384df46aea690d9c8897d5fe7">Chapter 1</a>, <span class="strong"><em class="calibre13">Composer, Configuration, Classes, and Path Aliases</em></span>.</p></div><p class="calibre9">Additionally, we can disable specific asset bundles by setting that bundle to <code class="email">false</code>, as shown in the following example.</p><div class="note"><pre class="programlisting">// config/web.php
return [
    // [...],
    'components' =&gt; [
        // [...],
        'assetManager' =&gt; [
            'bundles' =&gt; [
                'yii\web\BootstrapAsset' =&gt; false
            ],
        ],
    ],
];</pre></div><p class="calibre9">Moreover, we <a id="id319" class="calibre1"/>can completely disable all included asset bundles within our application by setting the <code class="email">bundles</code> property to <code class="email">false</code>.</p><div class="note"><pre class="programlisting">// config/web.php
return [
    // [...],
    'components' =&gt; [
        // [...],
        'assetManager' =&gt; [
            'bundles' =&gt; false
        ],
    ],
];</pre></div><div class="book" title="Asset mapping"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec41" class="calibre1"/>Asset mapping</h3></div></div></div><p class="calibre9">In some<a id="id320" class="calibre1"/> instances, multiple asset bundles may define different versions of the same script. For example, one asset bundle may include jQuery version 2.1.3, and another may define 2.1.4. To resolve these conflicts, we can set the <code class="email">assetMap</code> property of our configuration file to resolve any named instances of an asset file to a single<a id="id321" class="calibre1"/> dependency that will be included in our view.</p><div class="note"><pre class="programlisting">// config/web.php
return [
    // [...],
    'components' =&gt; [
        // [...],
        'assetManager' =&gt; [
            'assetMap' =&gt; [
                'jquery.js' =&gt; 'https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js',
                'jquery.min.js' =&gt; 'https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js'
            ]
        ],
    ],
];</pre></div><p class="calibre9">In this instance, any asset bundle that has an instance of <code class="email">jquery.js</code> and <code class="email">jquery.min.js</code> defined within the <code class="email">js</code> section of the asset bundle will have that asset re-mapped to our CloudFlare CDN asset.</p><div class="note" title="Note"><h3 class="title2"><a id="tip105" class="calibre1"/>Tip</h3><p class="calibre9">The <code class="email">assetMap</code> property matches on the last part of an asset file within bundles as a key-value pair.</p></div></div></div></div></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Asset Management">
<div class="book" title="Asset bundles">
<div class="book" title="Asset types and locations"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec67" class="calibre1"/>Asset types and locations</h2></div></div></div><p class="calibre9">Depending upon their location, Yii2 will <a id="id322" class="calibre1"/>classify an asset in one of three different ways. Assets will be classified as a source asset, a published asset, or an external asset. Source assets are asset files that are mixed in within our source code and are not in a web-accessible directory. Such assets are often included with modules, widgets, extensions, or components. Any assets that Yii2 defines as source assets will need to be published by Yii2 to a web-accessible directory. Published assets are source assets that have been published to a web-accessible directory. And finally, external assets are assets that are<a id="id323" class="calibre1"/> located in a web-accessible location, such as on our current server or on another server or CDN. Unlike published assets, Yii2 will not publish these assets to our assets directory, and will instead reference them directly as an external resource.</p><p class="calibre9">When working with asset bundles, if the <code class="email">sourcePath</code> property is specified, Yii2 will consider any assets listed with a relative path as a source asset, and will attempt to publish those assets<a id="id324" class="calibre1"/> during runtime. If the <code class="email">sourcePath</code> property is not specified, Yii2 will assume the listed assets are in a web-accessible directory and are published. In this case, it is necessary to specify either the <code class="email">basePath</code> property, or the <code class="email">baseUrl</code> property to tell Yii2 where the assets are located.</p><div class="note" title="Note"><h3 class="title2"><a id="tip106" class="calibre1"/>Tip</h3><p class="calibre9">Do not use the <code class="email">@webroot/assets</code> alias for the <code class="email">sourcePath</code> property, as this directory is used by asset manager to save the asset files published from their source location. Any data stored in this directory could be removed at any time by Yii2.</p></div></div></div></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Asset Management">
<div class="book" title="Asset bundles">
<div class="book" title="Asset options"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch06lvl2sec68" class="calibre1"/>Asset options</h2></div></div></div><p class="calibre9">Like the <code class="email">yii\web\View</code> methods <code class="email">registerJsFile()</code> and <code class="email">registerCssFile()</code>, asset bundles can be rendered <a id="id325" class="calibre1"/>with a given set of options by setting the respective <code class="email">$jsOptions</code> and <code class="email">$cssOptions</code> properties of our asset bundle.</p><p class="calibre9">For example, we can have our asset bundle include our listed JavaScript files at the end of the <code class="email">&lt;body&gt;</code> tag within our view.</p><div class="note"><pre class="programlisting">public $jsOptions = ['position' =&gt; \yii\web\View::POS_END];</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip107" class="calibre1"/>Tip</h3><p class="calibre9">The <code class="email">yii\web\View</code> class also provides position methods for the beginning of the body (<code class="email">yii\web\View::POS_BEGIN</code>), the end of the body (<code class="email">yii\web\View::POS_END</code>), within a <code class="email">jQuery(window).load()</code> event (<code class="email">yii\web\View::POS_LOAD</code>), and within a <code class="email">jQuery(window).ready()</code> event (<code class="email">yii\web\View::POS_READY</code>).</p></div><p class="calibre9">With CSS, we can also define <code class="email">&lt;noscript&gt;</code> blocks as follows:</p><div class="note"><pre class="programlisting">public $cssOptions = ['noscript' =&gt; true];</pre></div><p class="calibre9">Additionally, we can wrap our CSS blocks in conditionals:</p><div class="note"><pre class="programlisting">public $cssOptions = ['condition' =&gt; 'IE 11'];</pre></div><p class="calibre9">This will result in the following HTML being rendered:</p><div class="note"><pre class="programlisting">&lt;!--[if IE11]&gt;
&lt;link rel="stylesheet" href="path/to/ie11.css"&gt;
&lt;![endif]--&gt;</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip108" class="calibre1"/>Tip</h3><p class="calibre9">Setting the <code class="email">$jsOptions</code> or <code class="email">$cssOptions</code> property will apply the specified options to all CSS and JavaScript files defined in the asset bundle. To apply different conditionals to each asset individually, you'll need to create a separate asset bundle defining those conditionals, or inline the assets within the view using <code class="email">theregisterCssFile()</code> or <code class="email">registerJsFile()</code> methods.</p></div></div></div></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Asset Management">
<div class="book" title="Asset bundles">
<div class="book" title="Asset publication"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch06lvl2sec69" class="calibre1"/>Asset publication</h2></div></div></div><p class="calibre9">As previously<a id="id326" class="calibre1"/> mentioned, if the assets referenced by an asset bundle are located in a directory that is not publicly accessible from a web browser (or has the <code class="email">sourcePath</code> property set), its assets will be copied to <code class="email">@webroot/assets</code> (which corresponds to the web path of <code class="email">@web/assets</code>) as part of the automatic publication process the asset manager performs when the bundle is registered with the view. As previously mentioned, the publication path can be altered by setting the <code class="email">baseUrl</code> and <code class="email">basePath</code> properties of the asset bundle.</p><p class="calibre9">As you may expect, the process of copying over files on a web request can be rather expensive, and can cause performance-related issues in production environments if allowed to continually run. To help alleviate this problem, Yii2 provides two alternatives.</p><p class="calibre9">Rather than copying over files, Yii's asset manager can be configured to create a symbolic link between the origin asset files and the web-accessible directory by setting the <code class="email">linkAssets</code> property of <code class="email">assetManager</code> as follows:</p><div class="note"><pre class="programlisting">// config/web.php
return [
    // [...], 
    'components' =&gt; [
        'assetManager' =&gt; [
            'linkAssets' =&gt; true,
        ],
    ],
    // [...], 
];</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip109" class="calibre1"/>Tip</h3><p class="calibre9">The publication process usually only occurs once. Once Yii2 has published our assets, it won't publish them again unless we remove our assets directory or tell Yii2 to republish our assets.</p></div><p class="calibre9">By default, Yii2 will run the publication process on every file listed in the <code class="email">sourcePath</code> property, which means if you have a large directory then every file will be copied over regardless of whether it is actually used. To have Yii2's asset manager only copy over the files you need, you can modify the <code class="email">publishOptions</code> property of the asset bundle.</p><p class="calibre9">Take for instance if we're using Yahoo's popular CSS library, <code class="email">purecss</code>. To build <code class="email">purecss</code> from source, we need to run Bower, NPM, and Grunt, which will leave behind build files we shouldn't publish to our web directory.</p><p class="calibre9">By setting the <a id="id327" class="calibre1"/>
<code class="email">publishOptions</code> property as shown in the following example, we can ensure only the build files are published, which can drastically improve performance during initial publication.</p><div class="note"><pre class="programlisting">&lt;?php
namespace app\assets;

use yii\web\AssetBundle;

class PureCssAsset extends AssetBundle 
{
    public $sourcePath = '@bower/purecss'; 

    public $css = [ 
        'build/base-min.css', 
    ];

    public $publishOptions = [
        'only' =&gt; [
        	'build/'
        ]
    ];
}</pre></div></div></div></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Asset Management">
<div class="book" title="Asset bundles">
<div class="book" title="Client cache management with asset bundles"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_7"><a id="ch06lvl2sec70" class="calibre1"/>Client cache management with asset bundles</h2></div></div></div><p class="calibre9">When running applications<a id="id328" class="calibre1"/> in production, we often set long-lived cache expiration dates on our JavaScript and CSS assets to improve performance. When pushing out new code, often our assets will change, but their file locations will not, which will prevent clients from receiving our updated assets when we make changes. The simplest way to overcome this issue is to append a version or timestamp to the end of our assets so that browsers can cache a specific version of our assets, and be able to re-cache new assets as we push to them.</p><p class="calibre9">With Yii2, we can configure our asset manager to automatically append the last modified timestamp to our assets by <a id="id329" class="calibre1"/>setting the <code class="email">appendTimestamp</code> property of our <code class="email">assetManager</code> as follows:</p><div class="note"><pre class="programlisting">// config/web.php
return [
    // [...],
    'components' =&gt; [
        'assetManager' =&gt; [
            'appendTimestamp' =&gt; true,
        ],
    ],
    // [...],
];</pre></div></div></div></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Asset Management">
<div class="book" title="Asset bundles">
<div class="book" title="Using preprocessor with asset bundles"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_8"><a id="ch06lvl2sec71" class="calibre1"/>Using preprocessor with asset bundles</h2></div></div></div><p class="calibre9">To make asset development <a id="id330" class="calibre1"/>simpler and easy to manage, many developers have moved to extended syntax languages such as LESS and CoffeeScript, and rely on their corresponding tools to convert those assets into CSS and JavaScript files. Yii2 can help facilitate this process by enabling asset manager to take care of this build process for you. Using Yii2's asset bundles, you can list LESS, SCSS, Stylus, CoffeeScript, and TypeScript files directly in asset bundles and Yii2 will identify them and automatically run them through their corresponding preprocessor. Take for instance the following asset bundle:</p><div class="note"><pre class="programlisting">&lt;?php
namespace app\assets;

use yii\web\AssetBundle;

class AppAsset extends AssetBundle
{
    public $basePath = '@webroot';
    public $baseUrl = '@web';
    public $css = [
        'css/app.less',
    ];
    public $js = [
        'js/app.ts'
    ];
    public $depends = [
        'yii\web\YiiAsset'
    ];
}</pre></div><p class="calibre9">When our asset <a id="id331" class="calibre1"/>bundle is registered with our view, Yii2 will automatically run the appropriate pre-processor tool to convert the assets to CSS and JavaScript to include in our views.</p><div class="note" title="Note"><h3 class="title2"><a id="note17" class="calibre1"/>Note</h3><p class="calibre9">Yii2 is dependent upon the corresponding pre-processor software to be installed on your computer for this feature to work.</p></div><p class="calibre9">When working with pre-processors it may be necessary to specify additional arguments to the pre-processor for your assets to be generated correctly. To set this in Yii2, you can set the <code class="email">converter</code> property of our <code class="email">assetManager</code> instance as follows.</p><div class="note"><pre class="programlisting">// config/web.php
return [
    // [...],
    'components' =&gt; [
        'assetManager' =&gt; [
            'converter' =&gt; [
                'class' =&gt; 'yii\web\AssetConverter',
                'commands' =&gt; [
                    'less' =&gt; ['css', 'lessc {from} {to}'],
                    'ts' =&gt; ['js', 'tsc --out {to} {from}'],
                ],
            ],
        ],
    ],
    // [...],
];</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip110" class="calibre1"/>Tip</h3><p class="calibre9">While convenient to use, it's generally not a good idea to let Yii2 build our asset files in production, as it introduces unnecessary software into production environments that may not match that in your development environment or have security vulnerabilities, and can seriously hinder application performance as Yii2 will need to build out the asset files on its initial run. When working in production, it's usually a better idea to build all of your asset files on a build server before pushing your application out to production. We'll cover how to build asset files with Grunt, NodeJS, and Bower later on in this chapter, and cover some basic deployment strategies in <a class="calibre1" title="Chapter 13. Debugging and Deploying" href="part0079_split_000.html#2BASE2-ad3e09b384df46aea690d9c8897d5fe7">Chapter 13</a>, <span class="strong"><em class="calibre13">Debugging and Deploying</em></span>.</p></div></div></div></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Asset Management">
<div class="book" title="Asset bundles">
<div class="book" title="The asset command line tool"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_9"><a id="ch06lvl2sec72" class="calibre1"/>The asset command line tool</h2></div></div></div><p class="calibre9">With HTTP/1.1 applications, to<a id="id332" class="calibre1"/> save bandwidth and requests, it's <a id="id333" class="calibre1"/>often better to combine and compress multiple asset files together. Yii2 can help facilitate this process through the <code class="email">asset</code> command, which can help you use Yii2, and some third-party Java tools to compress and combine your asset files.</p><div class="note" title="Note"><h3 class="title2"><a id="tip111" class="calibre1"/>Tip</h3><p class="calibre9">Due to changes in the HTTP/2 protocol, it's often more beneficial to serve asset files individually rather than combining them. As more web servers such as Nginx and Apache start supporting the HTTP/2 protocol, you should run your own experiments to determine if combining assets or not is the best choice for your application.</p></div><p class="calibre9">The <code class="email">asset</code> command-line tool provides two options <code class="email">asset/template</code>, which is used to generate an instruction file called <code class="email">asset.php</code> for use by the second command <code class="email">asset/compress</code>, which is used to compress files together. The first tool, <code class="email">asset/template</code>, is invoked as follows:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">./yii asset/template config/assets.php</strong></span>
</pre></div><p class="calibre9">After running this command, a file called <code class="email">assets.php</code> will be generated in the <code class="email">config</code> directory of our application, and by default will have the following output.</p><div class="note"><pre class="programlisting">&lt;?php
/**
 * Configuration file for the "yii asset" console command.
 */

// In the console environment, some path aliases may not exist. Please define these:
// Yii::setAlias('@webroot', __DIR__ . '/../web');
// Yii::setAlias('@web', '/');

return [
    // Adjust command/callback for JavaScript files compressing:
    'jsCompressor' =&gt; 'java -jar compiler.jar --js {from} --js_output_file {to}',
    // Adjust command/callback for CSS files compressing:
    'cssCompressor' =&gt; 'java -jar yuicompressor.jar --type css {from} -o {to}',
    // The list of asset bundles to compress:
    'bundles' =&gt; [
        // 'app\assets\AppAsset',
        // 'yii\web\YiiAsset',
        // 'yii\web\JqueryAsset',
    ],

    // Asset bundle for compression output:
    'targets' =&gt; [
        'all' =&gt; [
            'class' =&gt; 'yii\web\AssetBundle',
            'basePath' =&gt; '@webroot/assets',
            'baseUrl' =&gt; '@web/assets',
            'js' =&gt; 'js/all-{hash}.js',
            'css' =&gt; 'css/all-{hash}.css',
        ],
    ],

    // Asset manager configuration:
    'assetManager' =&gt; [
        //'basePath' =&gt; '@webroot/assets',
        //'baseUrl' =&gt; '@web/assets',
    ],  
];</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip112" class="calibre1"/>Tip</h3><p class="calibre9">To compress assets, Yii2 by default will try to use Closure Compiler (<a class="calibre1" href="https://developers.google.com/closure/compiler/">https://developers.google.com/closure/compiler/</a>) and YUI Compressor (<a class="calibre1" href="https://github.com/yui/yuicompressor/">https://github.com/yui/yuicompressor/</a>). You will need to install both of these tools for the <code class="email">asset</code> command to function as intended.</p></div><p class="calibre9">This configuration<a id="id334" class="calibre1"/> file defines several different <a id="id335" class="calibre1"/>options. The first two options, <code class="email">jsCompressor</code> and <code class="email">cssCompressor</code>, define what commands should be run to compress both JavaScript and CSS files. By default, these tools will try to use Closure Compile and YUI Compressor; both can be configured as needed if you wish to use other tools.</p><p class="calibre9">The second <a id="id336" class="calibre1"/>option, <code class="email">bundles</code>, defines the asset bundles <a id="id337" class="calibre1"/>that you wish to compress together. The third option, <code class="email">assetManager</code>, defines some basic options that the asset manager component should use, such as the <code class="email">basePath</code> and <code class="email">baseUrl</code> for the compressed assets. Finally, the <code class="email">targets</code> option defines the output asset bundles that will be generated. By default, Yii2 will create a target called <code class="email">all</code>, and will generate compressed assets for all asset bundles listed.</p><p class="calibre9">In many cases, we often have assets split among several different asset bundles, such as a shared, frontend, and backend tool. As the frontend assets don't need to be included with our backend assets, we can define multiple targets, which will generate separate assets after compression, allowing us to include those assets specifically, thus saving bandwidth for our end user. An example is shown as follows:</p><div class="note"><pre class="programlisting">&lt;?php
/**
 * Configuration file for the "yii asset" console command.
 */

// In the console environment, some path aliases may not exist. Please define these:
// Yii::setAlias('@webroot', __DIR__ . '/../web');
// Yii::setAlias('@web', '/');

return [
    // [...],
    'targets' =&gt; [
        'shared' =&gt; [
            'js' =&gt; 'js/shared-{hash}.js',
            'css' =&gt; 'css/shared-{hash}.css',
            'depends' =&gt; [
                'yii\web\YiiAsset',
                'app\assets\AppAsset',
            ],
        ],
        'backend' =&gt; [
            'js' =&gt; 'js/backend-{hash}.js',
            'css' =&gt; 'css/backend-{hash}.css',
            'depends' =&gt; [
                'yii\web\YiiAsset',
                'app\assets\AdminAsset'
            ],
        ],
        'frontend' =&gt; [
            'js' =&gt; 'js/frontend-{hash}.js',
            'css' =&gt; 'css/frontend-{hash}.css',
            'depends' =&gt; [], 
        ],
    ] 
];</pre></div><p class="calibre9">After writing our <a id="id338" class="calibre1"/>asset <a id="id339" class="calibre1"/>configuration file, we can then generate our compressed asset files by running the asset command, as follows:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">./yii asset/compress config/asset.php</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip113" class="calibre1"/>Tip</h3><p class="calibre9">The asset configuration file is provided as convenience should desire to keep everything in Yii2 as much as possible. While Closure Compiler and YUI Compressor are good tools, tools like Grunt and NodeJS can often provide a solution that is easier to work with and develop for, while eliminating much of the configuration you need to do in Yii2 to compile and compress assets. When working with assets, be sure to find a tool that works best with your development workflow, team, and build process.</p></div></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Third-party asset tools"><div class="book" id="164MG2-ad3e09b384df46aea690d9c8897d5fe7"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec34" class="calibre1"/>Third-party asset tools</h1></div></div></div><p class="calibre9">When working <a id="id340" class="calibre1"/>with modern web applications, we often need to include many different types of asset from various sources. Including these assets directly in our application can cause several problems, namely:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Licensing of third-party assets</li><li class="listitem">Management of versions and security</li><li class="listitem">Repository size</li><li class="listitem">Build processes</li></ul></div><p class="calibre9">Rather than including assets directly in our application, we can utilize third-party asset management tools such as NodeJS and Bower, which can alleviate all of the issues outlined previously.</p><p class="calibre9">With Yii2, we can work directly with Node and Bower packages. For simple applications, we can include these packages directly in our <code class="email">composer.json</code> file by including <code class="email">bower-asset/PackageName</code> and <code class="email">npm-asset/PackageName</code> within the <code class="email">require</code> section. Yii2's post-scripts will automatically take care of including these assets within the <code class="email">@bower</code> folder and <a id="id341" class="calibre1"/>the <code class="email">@npm</code> folder, which we can then reference in our asset bundle. In a typical Yii2 instance, this will correspond to <code class="email">vendor/bower</code> and <code class="email">vendor/npm</code>, respectively.</p><p class="calibre9">With more complicated projects, it may make more sense to utilize those third-party tools directly in our application, and included the requisite CSS and JavaScript files later. In this next section, we'll take a look at three tools: NodeJS, Bower, and Grunt, and explore how we can use them in conjunction with Yii2.</p></div>

<div class="book" title="Third-party asset tools">
<div class="book" title="NodeJS"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec73" class="calibre1"/>NodeJS</h2></div></div></div><p class="calibre9">The first and <a id="id342" class="calibre1"/>most important tool we'll often use to manage our assets<a id="id343" class="calibre1"/> is called <span class="strong"><strong class="calibre2">NodeJS</strong></span>, and is a tool that we can use to install the other two packages, Bower and Grunt. To get started with node, we'll first need to download the software <a id="id344" class="calibre1"/>from <a class="calibre1" href="https://nodejs.org/download/">https://nodejs.org/download/</a> and install it on our system.</p><p class="calibre9">For our purposes, NodeJS will provide us with the tools and packages that we need to automatically download and build our asset files. To get started with NodeJS, we first need to include a <code class="email">package.json</code> file within our application. This file will define all the dependencies we want to use. A typical NodeJS file for asset management will look as follows:</p><div class="note"><pre class="programlisting">{
  "name": "masteringyii-ch6",
  "description": "Chapter 6 source code for the book 'Mastering Yii'",
  "repository": {
    "type": "git",
    "url": "https://www.github.com/masteringyii/chapter6"
  },
  "dependencies": {
    "ansi-styles": "^1.1.0",
    "bower": "1.3.12",
    "grunt": "^0.4.4",
    "grunt-cli": "^0.1.13",
    "grunt-contrib-concat": "^0.4.0",
    "grunt-contrib-cssmin": "0.6.1",
    "grunt-contrib-uglify": "0.2.0"
  }
}</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip114" class="calibre1"/>Tip</h3><p class="calibre9">There are two different ways of working with other packages such as Bower and Grunt within NodeJS. The first way is to include them as dependencies within our <code class="email">package.json</code> file. This is advantageous as we can version lock our build tools to our application. Alternatively, we can globally install these tools so that we can run them directly through the command line. When working with many developers and teams, it's generally better to use the tools as defined in the <code class="email">package.json</code> file.</p></div><p class="calibre9">In <a id="id345" class="calibre1"/>our <code class="email">package.json</code> file, we defined a few details about our repository such as the name, description, and repository details, as well as several of the tools we <a id="id346" class="calibre1"/>want to use, such as Bower, Grunt, and a few Grunt tools to concatenate and minify our CSS and JavaScript files.</p><p class="calibre9">With our NodeJS configuration file setup; we can now use NodeJS to add these tools to our repository by running the following command:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">npm install</strong></span>
</pre></div><p class="calibre9">This will install our build tools to the <code class="email">node_modules</code> directory.</p><div class="note" title="Note"><h3 class="title2"><a id="tip115" class="calibre1"/>Tip</h3><p class="calibre9">Since this directory contains build tools, we should exclude it from our repository by adding it to our <code class="email">.gitignore</code> file.</p></div></div></div>

<div class="book" title="Third-party asset tools">
<div class="book" title="Bower"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec74" class="calibre1"/>Bower</h2></div></div></div><p class="calibre9">To manage CSS and<a id="id347" class="calibre1"/> JavaScript<a id="id348" class="calibre1"/> libraries, we can utilize an asset dependency management tool called Bower. To get started with Bower, we first need to create a <code class="email">bower.json</code> file in the root directory of our application, and populate it with the libraries we want to include. As an example, let's include the popular CSS library PureCSS in our application. We can do that by writing out a basic <code class="email">bower.json</code> file as follows:</p><div class="note"><pre class="programlisting">{
  "name": "masteringyii-ch6",
  "dependencies": {
    "pure": "~0.6.0"
  }
}</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip116" class="calibre1"/>Tip</h3><p class="calibre9">A full list of package names can be <a id="id349" class="calibre1"/>discovered at <a class="calibre1" href="http://bower.io/">http://bower.io/</a>.</p></div><p class="calibre9">To install these<a id="id350" class="calibre1"/> packages, we can then run Bower from our <code class="email">node_modules</code> directory as follows:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">./node_modules/.bin/bower install</strong></span>
</pre></div><p class="calibre9">This will add our <a id="id351" class="calibre1"/>libraries and CSS to the <code class="email">vendor/bower</code> directory in the root of our application.</p><div class="note" title="Note"><h3 class="title2"><a id="tip117" class="calibre1"/>Tip</h3><p class="calibre9">By default, Bower will install itself to the <code class="email">bower_components</code> directory. Since, however, Yii2 has already defined the installation directory, it is re-mapped to <code class="email">vendor/bower</code>.</p></div></div></div>

<div class="book" title="Third-party asset tools">
<div class="book" title="Grunt"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec75" class="calibre1"/>Grunt</h2></div></div></div><p class="calibre9">Since we <a id="id352" class="calibre1"/>already <a id="id353" class="calibre1"/>know how to use YUI Compressor and Closure Compiler and the Yii2 <code class="email">asset</code> command, one option we have at this point is to direct our asset bundle and asset configuration file to the <code class="email">node_modules</code> and <code class="email">bower_components</code> directory. While this eliminates many of the issues listed previously, we can alternatively use another third-party tool called Grunt to take care of compressing and concatenating our files together.</p><p class="calibre9">In short, Grunt is JavaScript task-runner, designed to help automate much of the trivial tasks that need to be repeated, such as building asset files. The main benefit of using a tool like Grunt is that you can automate your workflow both for development and for your build server.</p><p class="calibre9">To get started with Grunt, we first need to create a file called <code class="email">Gruntfile.js</code>, which will contain all the build instructions for our app.</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">The first step in creating our <code class="email">Gruntfile.js</code> file is to declare that we're using Grunt, and to specify the Grunt modules we want to use (the names of which we specified in our <code class="email">package.json</code> file).<div class="note"><pre class="programlisting">module.exports = function(grunt) {

    // Register the NPM tasks we want
    grunt.loadNpmTasks('grunt-contrib-concat');
    grunt.loadNpmTasks('grunt-contrib-cssmin');
    grunt.loadNpmTasks('grunt-contrib-uglify');

};</pre></div></li><li class="listitem" value="2">Within this <a id="id354" class="calibre1"/>section, we'll then want to declare our default task by specifying which tasks we want to run when we run Grunt. In our case, we want to concatenate our JavaScript and CSS files, then minify both our JavaScript and CSS files.<div class="note"><pre class="programlisting">// Register the tasks we want to run
grunt.registerTask('default', [
    'concat',
    'cssmin:css',
    'uglify:js'
]);</pre></div></li><li class="listitem" value="3">We then <a id="id355" class="calibre1"/>begin configuring our Grunt tasks by telling Grunt where it can find our <code class="email">package.json</code> file, and setting up some basic path aliases.<div class="note"><pre class="programlisting">grunt.initConfig({
    pkg: grunt.file.readJSON('package.json'),
    
    paths: {
        assets: 'web',
        bower: 'vendor/bower',
        css : '&lt;%= paths.assets %&gt;/css',
        js: '&lt;%= paths.assets %&gt;/js',
        dist: '&lt;%= paths.assets %&gt;/dist',
    },
}</pre></div></li><li class="listitem" value="4">Within this section we then define our task to concatenate our JavaScript and CSS files.<div class="note"><pre class="programlisting">concat: {
    css: {
        src: [
            '&lt;%= paths.bower %&gt;/pure/pure-min.css',
            '&lt;%= paths.css %&gt;/*'
        ],
        dest: '&lt;%= paths.dist %&gt;/app.css'
    },
    js : {
        src: [
            '&lt;%= paths.js %&gt;/*.js'
        ],
        dest: '&lt;%= paths.dist %&gt;/app.js'
    }
},</pre></div></li><li class="listitem" value="5">Our task to <a id="id356" class="calibre1"/>minify <a id="id357" class="calibre1"/>our CSS assets after concatenating them together.<div class="note"><pre class="programlisting">cssmin : {
    css:{
        src: '&lt;%= paths.dist %&gt;/app.css',
        dest: '&lt;%= paths.dist %&gt;/app.min.css'
    }
},</pre></div></li><li class="listitem" value="6">And finally, the task to compress our JavaScript files.<div class="note"><pre class="programlisting">uglify: {
    js: {
        files: {
            '&lt;%= paths.dist %&gt;/app.min.js' : ['&lt;%= paths.dist %&gt;/app.js']
        }
    }
},</pre></div></li></ol><div class="calibre15"/></div><p class="calibre9">With our <code class="email">Gruntfile.js</code> file now configured, we can then build our asset files by running Grunt as follows:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">./node_modules/.bin/grunt</strong></span>
</pre></div><p class="calibre9">If everything ran well, we should see the following output:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">Running "concat:css" (concat) task</strong></span>
<span class="strong"><strong class="calibre2">File web/dist/app.css created.</strong></span>

<span class="strong"><strong class="calibre2">Running "concat:js" (concat) task</strong></span>
<span class="strong"><strong class="calibre2">File web/dist/app.js created.</strong></span>

<span class="strong"><strong class="calibre2">Running "cssmin:css" (cssmin) task</strong></span>
<span class="strong"><strong class="calibre2">File web/dist/app.min.css created.</strong></span>

<span class="strong"><strong class="calibre2">Running "uglify:js" (uglify) task</strong></span>
<span class="strong"><strong class="calibre2">File "web/dist/app.min.js" created.</strong></span>

<span class="strong"><strong class="calibre2">Done, without errors.</strong></span>
</pre></div><p class="calibre9">As shown in the output of <a id="id358" class="calibre1"/>Grunt, we generated four files for us, a compressed and uncompressed JavaScript and CSS file containing all the assets we want to include in our website. From this <a id="id359" class="calibre1"/>point, we can then conditionally include our asset files in our asset bundle, and toggle off our <code class="email">APPLICATION_ENV</code> or <code class="email">YII_ENV_&lt;ENV&gt;</code> environment so that we use the minified versions in production, and the non-minified versions in our non-production environment.</p><div class="note" title="Note"><h3 class="title2"><a id="tip118" class="calibre1"/>Tip</h3><p class="calibre9">NodeJS, Bower, and Grunt each provide powerful tools to accomplish certain tasks automatically, and work well with Yii2. Before deciding on a specific technology to use however, be sure to consult your team to determine what works best for them.</p></div></div></div>
<div class="book" title="Summary" id="173721-ad3e09b384df46aea690d9c8897d5fe7"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec35" class="calibre1"/>Summary</h1></div></div></div><p class="calibre9">In this chapter, we covered how assets work and are managed in Yii2. We explored the basics of asset bundle files and their integration with Yii2's asset manager. We also explored how we can use the <code class="email">asset</code> command to build configuration files and to combine and compress our assets. Finally, we explored three third-party tools: NodeJS, Bower, and Grunt, and illustrated how we can use those tools in conjunction with our asset bundle to automate the building of our asset files.</p><p class="calibre9">Having explored the front-end aspect of Yii, in the next chapter, we're going to return to the backend to learn how we can handle user authentication and authorization within our application, as well as cover how we can set up access control filters and rule-based authentication within our app.</p></div></body></html>