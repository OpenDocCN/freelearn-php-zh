<html><head></head><body>
<div id="_idContainer110">
<h1 class="chapter-number" id="_idParaDest-107"><a id="_idTextAnchor108"/><span class="koboSpan" id="kobo.1.1">7</span></h1>
<h1 id="_idParaDest-108"><a id="_idTextAnchor109"/><span class="koboSpan" id="kobo.2.1">Building Solution Code with BDD and TDD</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Now that we have gone through the fundamentals of writing test programs using </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">test-driven development</span></strong><span class="koboSpan" id="kobo.5.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.6.1">TDD</span></strong><span class="koboSpan" id="kobo.7.1">) and </span><strong class="bold"><span class="koboSpan" id="kobo.8.1">behavior-driven development</span></strong><span class="koboSpan" id="kobo.9.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.10.1">BDD</span></strong><span class="koboSpan" id="kobo.11.1">), we can start using both processes in developing our example application. </span><span class="koboSpan" id="kobo.11.2">When working on commercially successful and large-scale applications, one thing is common: they all need maintenance. </span><span class="koboSpan" id="kobo.11.3">There will always be room for improvement in terms of the product’s functionality. </span><span class="koboSpan" id="kobo.11.4">There could be some bugs that were missed, and—more commonly—more features to improve the product will continuously be added to the application. </span><span class="koboSpan" id="kobo.11.5">This is usually how badly written code gets worse. </span><span class="koboSpan" id="kobo.11.6">A nicely written class can end up being a god class: a class that can do everything with a few thousand lines of code. </span><span class="koboSpan" id="kobo.11.7">A developer can start writing additional functions inside the god class while another developer is using that class, therefore changing the class’s behavior. </span><span class="koboSpan" id="kobo.11.8">You can guess what happens next! </span><span class="koboSpan" id="kobo.11.9">A new bug </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">is introduced.</span></span></p>
<p><span class="koboSpan" id="kobo.13.1">There are a lot of times during development when a developer may start working on a feature that will depend on other features that are not written yet. </span><span class="koboSpan" id="kobo.13.2">So, how do we write tests for these types of features? </span><span class="koboSpan" id="kobo.13.3">We’ll need to start mocking those dependencies. </span><span class="koboSpan" id="kobo.13.4">In this chapter, we will learn how to use mock objects and we will also start writing our code so that it will be cleaner and easier to maintain by following the SOLID principles. </span><span class="koboSpan" id="kobo.13.5">We will also be using the Red-Green-Refactor pattern to help us lay down the tests and features that we need to build. </span><span class="koboSpan" id="kobo.13.6">But before all that, we’ll first create a Behat feature to kickstart all of the tests and code we’ll </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">be writing.</span></span></p>
<p><span class="koboSpan" id="kobo.15.1">In this chapter, we will go through the </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.17.1">Implementing the </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">Red-Green-Refactor pattern</span></span></li>
<li><span class="koboSpan" id="kobo.19.1">Writing tests and solution code for the </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">example project</span></span></li>
<li><span class="koboSpan" id="kobo.21.1">Creating a Behat feature based on a </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">Jira ticket</span></span></li>
<li><span class="koboSpan" id="kobo.23.1">Passing the Behat </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">registration feature</span></span></li>
</ul>
<h1 id="_idParaDest-109"><a id="_idTextAnchor110"/><span class="koboSpan" id="kobo.25.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.26.1">In this chapter, you are advised to use the following base code from this code repository: </span><a href="https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%207/base/phptdd"><span class="koboSpan" id="kobo.27.1">https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%207/base/phptdd</span></a><span class="koboSpan" id="kobo.28.1">. </span><span class="koboSpan" id="kobo.28.2">After completing the chapter, the resulting solution code can be found at </span><a href="https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%207/complete"><span class="koboSpan" id="kobo.29.1">https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%207/complete</span></a> <span class="No-Break"><span class="koboSpan" id="kobo.30.1">for reference.</span></span></p>
<h2 id="_idParaDest-110"><a id="_idTextAnchor111"/><span class="koboSpan" id="kobo.31.1">Preparing the development environment for the chapter</span></h2>
<p><span class="koboSpan" id="kobo.32.1">First, get the base code for this chapter found at </span><a href="https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%207/base"><span class="koboSpan" id="kobo.33.1">https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%207/base</span></a><span class="koboSpan" id="kobo.34.1"> or simply run the </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.36.1">
curl -Lo phptdd.zip "https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/raw/main/Chapter%207/base.zip" &amp;&amp; unzip -o phptdd.zip &amp;&amp; cd base &amp;&amp; ./demoSetup.sh</span></pre>
<p><span class="koboSpan" id="kobo.37.1">To run the containers and execute the commands in this chapter, you should be inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.38.1">docker-server-web-1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.39.1"> container.</span></span></p>
<p><span class="koboSpan" id="kobo.40.1">Run the following command to confirm the container name for our </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">web server:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.42.1">
docker ps</span></pre>
<p><span class="koboSpan" id="kobo.43.1">To run the containers, run the following command from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.44.1">/docker</span></strong><span class="koboSpan" id="kobo.45.1"> directory from the repository in your </span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">host machine:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.47.1">
docker-compose build &amp;&amp; docker-compose up -d
docker exec -it docker-server-web-1 /bin/bash</span></pre>
<p><span class="koboSpan" id="kobo.48.1">Once inside the container, run the following commands to install the libraries required </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">through Composer:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.50.1">
/var/www/html/symfony# ./setup.sh
/var/www/html/behat# ./setup.sh </span></pre>
<h1 id="_idParaDest-111"><a id="_idTextAnchor112"/><span class="koboSpan" id="kobo.51.1">Implementing the Red-Green-Refactor pattern</span></h1>
<p><span class="koboSpan" id="kobo.52.1">The Red-Green-Refactor pattern</span><a id="_idIndexMarker279"/><span class="koboSpan" id="kobo.53.1"> is a type of programming approach to implementing TDD. </span><span class="koboSpan" id="kobo.53.2">It’s a cycle where you first deliberately write a failing test, in which you see a red-colored failing message when you execute the test. </span><span class="koboSpan" id="kobo.53.3">Then, you write solution code to pass that test, in which you will see a green-colored passing message. </span><span class="koboSpan" id="kobo.53.4">After passing the test, you can then go back to clean up and refactor your test and </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">solution code.</span></span></p>
<p><span class="koboSpan" id="kobo.55.1">If you open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.56.1">codebase/symfony/runDebug.sh</span></strong><span class="koboSpan" id="kobo.57.1"> file that we created</span><a id="_idIndexMarker280"/><span class="koboSpan" id="kobo.58.1"> earlier in this book in </span><a href="B18318_05.xhtml#_idTextAnchor070"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.59.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.60.1">, </span><em class="italic"><span class="koboSpan" id="kobo.61.1">Unit Testing</span></em><span class="koboSpan" id="kobo.62.1">, you’ll notice that we are running PHPUnit by adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.63.1">--color=always</span></strong><span class="koboSpan" id="kobo.64.1"> parameter. </span><span class="koboSpan" id="kobo.64.2">Then, whenever we run PHPUnit and we get a failing test, you will notice that we always get a red error or failed </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">test message.</span></span></p>
<p><span class="koboSpan" id="kobo.66.1">To demonstrate the pattern clearly, let’s go through </span><span class="No-Break"><span class="koboSpan" id="kobo.67.1">an example:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.68.1">Create a new file </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.70.1">HelloTest.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.71.1">:</span></span></li>
</ol>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.72.1">codebase/symfony/tests/Unit/HelloTest.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.73.1">
&lt;?php
namespace App\Tests\Unit;
use PHPUnit\Framework\TestCase;
class HelloTest extends TestCase
{
    public function testCanSayHello()
    {
        $this-&gt;fail("--- RED ---");
    }
}</span></pre>
<ol>
<li value="2"><span class="koboSpan" id="kobo.74.1">After creating the new unit test, run the following command to make sure that PHPUnit can execute a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.75.1">testCanSayHello</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.76.1"> test:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.77.1">/var/www/html/symfony# php bin/phpunit --filter testCanSayHello --color=always</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.78.1">You should then see the </span><span class="No-Break"><span class="koboSpan" id="kobo.79.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer095">
<span class="koboSpan" id="kobo.80.1"><img alt="Figure 7.1 – Red highlighted failed message" src="image/Figure_7.01_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.81.1">Figure 7.1 – Red highlighted failed message</span></p>
<p><span class="koboSpan" id="kobo.82.1">In TDD, we always</span><a id="_idIndexMarker281"/><span class="koboSpan" id="kobo.83.1"> start by writing a test that will have no implementations to support or pass it. </span><span class="koboSpan" id="kobo.83.2">We then need to run the test to make sure that PHPUnit recognizes the test and that it can execute it. </span><span class="koboSpan" id="kobo.83.3">We also want to confirm that we’ve created the test class in the correct test suite and the correct directory and that it uses the correct namespace. </span></p>
<p><span class="koboSpan" id="kobo.84.1">After running the command stated previously, this newly created test will fail as expected and PHPUnit will show a red colored error or fail message. </span><span class="koboSpan" id="kobo.84.2">This is the </span><em class="italic"><span class="koboSpan" id="kobo.85.1">Red</span></em><span class="koboSpan" id="kobo.86.1"> in the </span><span class="No-Break"><span class="koboSpan" id="kobo.87.1">Red-Green-Refactor pattern!</span></span></p>
<p><span class="koboSpan" id="kobo.88.1">Once we are sure that we can use PHPUnit to run a test, we can then move on to start writing code to pass our failing test. </span><span class="koboSpan" id="kobo.88.2">Remember TDD? </span><span class="koboSpan" id="kobo.88.3">Our test will start or drive the creation of the solution code to solve a problem, hence test-driven. </span><span class="koboSpan" id="kobo.88.4">So, now, to quickly pass the failing test, we will write some code to pass the failing test by following these steps: </span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.89.1">Modify the test and add a </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">new class:</span></span></li>
</ol>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.91.1">Codebase/symfony/tests/Unit/HelloTest.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.92.1">
&lt;?php
namespace App\Tests\Unit;
use App\Speaker;
use PHPUnit\Framework\TestCase;
class HelloTest extends TestCase
{
    public function testCanSayHello()
    {
        $speaker = new Speaker();
        $this-&gt;assertEquals('Hello' $speaker-&gt;
            sayHello());
    }
}</span></pre>
<ol>
<li value="2"><span class="koboSpan" id="kobo.93.1">Create a new</span><a id="_idIndexMarker282"/><span class="koboSpan" id="kobo.94.1"> class: </span></li>
</ol>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.95.1">codebase/symfony/src/Speaker.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.96.1">
&lt;?php
namespace App;
class Speaker
{
    public function sayHello(): string
    {
        return 'Hello';
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.97.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.98.1">HelloTest</span></strong><span class="koboSpan" id="kobo.99.1"> class, we have</span><a id="_idIndexMarker283"/><span class="koboSpan" id="kobo.100.1"> modified the </span><strong class="source-inline"><span class="koboSpan" id="kobo.101.1">testCanSayHello()</span></strong><span class="koboSpan" id="kobo.102.1"> method so that it will create an instance of the new </span><strong class="source-inline"><span class="koboSpan" id="kobo.103.1">Speaker</span></strong><span class="koboSpan" id="kobo.104.1"> class we created, and then, in the assertion line, we directly compare the expected word </span><strong class="source-inline"><span class="koboSpan" id="kobo.105.1">Hello</span></strong><span class="koboSpan" id="kobo.106.1"> to the string returned by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.107.1">sayHello()</span></strong><span class="koboSpan" id="kobo.108.1"> method. </span><span class="koboSpan" id="kobo.108.2">Now, if we run the test again, we should no longer see the red </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">failure message.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.110.1">Run the same test by using the </span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.112.1">/var/www/html/symfony# php bin/phpunit --filter testCanSayHello --color=always</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.113.1">We should now see the following result </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">from PHPUnit:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer096">
<span class="koboSpan" id="kobo.115.1"><img alt="Figure 7.2 – Green highlighted message" src="image/Figure_7.02_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.116.1">Figure 7.2 – Green highlighted message</span></p>
<p><span class="koboSpan" id="kobo.117.1">We passed the test! </span><span class="koboSpan" id="kobo.117.2">Now, our </span><strong class="source-inline"><span class="koboSpan" id="kobo.118.1">testCanSayHello()</span></strong><span class="koboSpan" id="kobo.119.1"> test no longer returns a red error/failure message. </span><span class="koboSpan" id="kobo.119.2">We did the minimum work to pass the test, and we can now see a green </span><strong class="bold"><span class="koboSpan" id="kobo.120.1">OK (1 test, 1 assertion)</span></strong><span class="koboSpan" id="kobo.121.1"> message instead. </span><span class="koboSpan" id="kobo.121.2">This is the </span><em class="italic"><span class="koboSpan" id="kobo.122.1">Green</span></em><span class="koboSpan" id="kobo.123.1"> in the </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">Red-Green-Refactor pattern.</span></span></p>
<p><span class="koboSpan" id="kobo.125.1">When you’re working</span><a id="_idIndexMarker284"/><span class="koboSpan" id="kobo.126.1"> on your own project, at this stage after passing a test, you can either move on to the next test or next problem in your list of things to do or you can try improving both the test and the solution code to make it cleaner and easier </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">to read.</span></span></p>
<p><span class="koboSpan" id="kobo.128.1">In this example, we’ll go ahead and improve both the test and solution code to let it support more </span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">test scenarios.</span></span></p>
<p><span class="koboSpan" id="kobo.130.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">these steps:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.132.1">Modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">HelloTest</span></strong><span class="koboSpan" id="kobo.134.1"> class with the </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">following content:</span></span></li>
</ol>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.136.1">codebase/symfony/tests/Unit/HelloTest.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.137.1">
&lt;?php
namespace App\Tests\Unit;
use App\Speaker;
use PHPUnit\Framework\TestCase;
class HelloTest extends TestCase
{
    /**
     * @param \Closure $func
     * @param string $expected
     * @dataProvider provideHelloStrings
     */
    public function testCanSayHello(\Closure 
        $func, string $expected)
    {
        $speaker        = new Speaker();
        $helloMessage   = $speaker-&gt;sayHello($func);
        $this-&gt;assertEquals($expected, $helloMessage);
    }
    /**
     * @return array[]
     */
    private function provideHelloStrings(): array
    {
        return [
            [function($str) {return ucfirst($str);},  
                'Hello'],
            [function($str) {return strtolower($str)
                ;}, 'hello'],
            [function($str) {return strtoupper($str)
                ;}, 'HELLO'],
        ];
    }
}</span></pre>
<ol>
<li value="2"><span class="koboSpan" id="kobo.138.1">Modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.139.1">Speaker.php</span></strong><span class="koboSpan" id="kobo.140.1"> class</span><a id="_idIndexMarker285"/><span class="koboSpan" id="kobo.141.1"> with the </span><span class="No-Break"><span class="koboSpan" id="kobo.142.1">following content:</span></span></li>
</ol>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.143.1">codebase/symfony/src/Speaker.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.144.1">
&lt;?php
namespace App;
class Speaker
{
    /**
     * @return string 
     */
    public function sayHello(\Closure $func): string
    {
        return $func('Hello');
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.145.1">We have refactored the test so that we can add more flexibility to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">Speaker.php</span></strong><span class="koboSpan" id="kobo.147.1"> class. </span><span class="koboSpan" id="kobo.147.2">We have also refactored the </span><strong class="source-inline"><span class="koboSpan" id="kobo.148.1">HelloTest.php</span></strong><span class="koboSpan" id="kobo.149.1"> test class itself to be more flexible as well. </span><span class="koboSpan" id="kobo.149.2">If we run the test again, we should still pass </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">the test.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.151.1">Run the test again by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.152.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.153.1">/var/www/html/symfony# php bin/phpunit --filter testCanSayHello --color=always</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.154.1">Now, we should see the </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer097">
<span class="koboSpan" id="kobo.156.1"><img alt="Figure 7.3 – Still green after the refactor" src="image/Figure_7.03_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.157.1">Figure 7.3 – Still green after the refactor</span></p>
<p><span class="koboSpan" id="kobo.158.1">You will notice that instead of getting </span><strong class="bold"><span class="koboSpan" id="kobo.159.1">OK (1 test, 1 assertion)</span></strong><span class="koboSpan" id="kobo.160.1"> because we only executed one test, we are now getting </span><strong class="bold"><span class="koboSpan" id="kobo.161.1">OK (3 tests, 3 assertions)</span></strong><span class="koboSpan" id="kobo.162.1"> instead. </span><span class="koboSpan" id="kobo.162.2">This is because we have refactored the test so that it can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">@dataProvider</span></strong><span class="koboSpan" id="kobo.164.1">. </span><span class="koboSpan" id="kobo.164.2">We then created a new function called </span><strong class="source-inline"><span class="koboSpan" id="kobo.165.1">provideHelloStrings()</span></strong><span class="koboSpan" id="kobo.166.1"> that returns an array of closures and strings. </span><span class="koboSpan" id="kobo.166.2">Each array set will be used as parameters for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.167.1">testCanSayHello()</span></strong><span class="koboSpan" id="kobo.168.1"> test method. </span><span class="koboSpan" id="kobo.168.2">At this stage, we still pass the test, even after we have done the refactors. </span><span class="koboSpan" id="kobo.168.3">This is the </span><em class="italic"><span class="koboSpan" id="kobo.169.1">Refactor</span></em><span class="koboSpan" id="kobo.170.1"> phase of the </span><span class="No-Break"><span class="koboSpan" id="kobo.171.1">Red-Green-Refactor pattern.</span></span></p>
<p><span class="koboSpan" id="kobo.172.1">It will be very common in a real-world</span><a id="_idIndexMarker286"/><span class="koboSpan" id="kobo.173.1"> enterprise project to write programs that rely on someone else’s project that is not readily available to you or your team. </span><span class="koboSpan" id="kobo.173.2">Should this stop you from developing your program that relies on something that is not complete yet? </span><span class="koboSpan" id="kobo.173.3">Probably not! </span><span class="koboSpan" id="kobo.173.4">Next, we’ll need a way to focus on testing a specific part of our application, even if it depends on other objects that are not built yet. </span><span class="koboSpan" id="kobo.173.5">For this, we will need to use mock objects. </span></p>
<h1 id="_idParaDest-112"><a id="_idTextAnchor113"/><span class="koboSpan" id="kobo.174.1">Writing tests and solution code for the example project</span></h1>
<p><span class="koboSpan" id="kobo.175.1">Back in </span><a href="B18318_02.xhtml#_idTextAnchor027"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.176.1">Chapter 2</span></em></span></a><span class="koboSpan" id="kobo.177.1">, </span><em class="italic"><span class="koboSpan" id="kobo.178.1">Understanding and Organizing the Business Requirements of Our Project</span></em><span class="koboSpan" id="kobo.179.1">, we used Jira</span><a id="_idIndexMarker287"/><span class="koboSpan" id="kobo.180.1"> as a tool to organize</span><a id="_idIndexMarker288"/><span class="koboSpan" id="kobo.181.1"> the list of things</span><a id="_idIndexMarker289"/><span class="koboSpan" id="kobo.182.1"> we need to build</span><a id="_idIndexMarker290"/><span class="koboSpan" id="kobo.183.1"> for the project. </span><span class="koboSpan" id="kobo.183.2">Aside from using Jira, there is other project tracking software out there too, or we can just simply use a notepad or a piece of paper and write down the tasks we want to write programs for. </span><span class="koboSpan" id="kobo.183.3">But we just want to be a bit more organized, and if you’re working with a team of software developers and with other teams in the company, it’s easier to collaborate if you use issue-tracking software, rather than a piece of physical paper. </span></p>
<p><span class="koboSpan" id="kobo.184.1">We have grouped</span><a id="_idIndexMarker291"/><span class="koboSpan" id="kobo.185.1"> the Jira user stories</span><a id="_idIndexMarker292"/><span class="koboSpan" id="kobo.186.1"> into two groups: the </span><strong class="bold"><span class="koboSpan" id="kobo.187.1">Inventory Clerk Solution</span></strong><span class="koboSpan" id="kobo.188.1"> group and the </span><strong class="bold"><span class="koboSpan" id="kobo.189.1">Visitors Page</span></strong><span class="koboSpan" id="kobo.190.1"> group. </span><span class="koboSpan" id="kobo.190.2">These groups are called epics. </span><span class="koboSpan" id="kobo.190.3">We will start</span><a id="_idIndexMarker293"/><span class="koboSpan" id="kobo.191.1"> working on the </span><strong class="bold"><span class="koboSpan" id="kobo.192.1">Inventory Clerk Solution</span></strong><span class="koboSpan" id="kobo.193.1"> epic first. </span><span class="koboSpan" id="kobo.193.2">This is to allow the car museum inventory clerk to enter that valuable data into the system for the visitors </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">to view.</span></span></p>
<p><span class="koboSpan" id="kobo.195.1">Up to this point, as we were going</span><a id="_idIndexMarker294"/><span class="koboSpan" id="kobo.196.1"> through BDD</span><a id="_idIndexMarker295"/><span class="koboSpan" id="kobo.197.1"> and TDD, we were playing</span><a id="_idIndexMarker296"/><span class="koboSpan" id="kobo.198.1"> with our development</span><a id="_idIndexMarker297"/><span class="koboSpan" id="kobo.199.1"> environment setup as an example. </span><span class="koboSpan" id="kobo.199.2">Now, we can use it to build our example project too. </span><span class="koboSpan" id="kobo.199.3">Download the base code from </span><a href="https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%207/base/phptdd"><span class="koboSpan" id="kobo.200.1">https://github.com/PacktPublishing/Test-Driven-Development-with-PHP-8/tree/main/Chapter%207/base/phptdd</span></a><span class="koboSpan" id="kobo.201.1">. </span><span class="koboSpan" id="kobo.201.2">You can use the base code and push it into your master branch that is linked to your Jira project. </span><span class="koboSpan" id="kobo.201.3">Then, all subsequent tickets that we will be working on moving forward will branch off and get merged from and into that </span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">master branch.</span></span></p>
<p><span class="koboSpan" id="kobo.203.1">Let’s start with the first ticket, </span><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">TOYC-2</span></strong><span class="koboSpan" id="kobo.205.1">. </span><span class="koboSpan" id="kobo.205.2">Go back to your Jira </span><strong class="bold"><span class="koboSpan" id="kobo.206.1">Roadmap</span></strong><span class="koboSpan" id="kobo.207.1"> page and click on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">TOYC-2</span></strong><span class="koboSpan" id="kobo.209.1"> story, then click on the </span><strong class="bold"><span class="koboSpan" id="kobo.210.1">Create branch</span></strong><span class="koboSpan" id="kobo.211.1"> link from </span><span class="No-Break"><span class="koboSpan" id="kobo.212.1">the popup:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer098">
<span class="koboSpan" id="kobo.213.1"><img alt="Figure 7.4 – TOYC-2 story: Create branch link" src="image/Figure_7.04_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.214.1">Figure 7.4 – TOYC-2 story: Create branch link</span></p>
<p><span class="koboSpan" id="kobo.215.1">We’ll need to create</span><a id="_idIndexMarker298"/><span class="koboSpan" id="kobo.216.1"> a new Bitbucket</span><a id="_idIndexMarker299"/><span class="koboSpan" id="kobo.217.1"> branch for this </span><a id="_idIndexMarker300"/><span class="koboSpan" id="kobo.218.1">feature. </span><span class="koboSpan" id="kobo.218.2">This is where</span><a id="_idIndexMarker301"/><span class="koboSpan" id="kobo.219.1"> we will commit all additional code we will be building for this specific ticket. </span><span class="koboSpan" id="kobo.219.2">Ideally, you’ll need to develop a branch that is branched off the master branch. </span><span class="koboSpan" id="kobo.219.3">We will then branch off the develop branch, and after we finish a feature, we will merge it back into the </span><span class="No-Break"><span class="koboSpan" id="kobo.220.1">develop branch.</span></span></p>
<p><span class="koboSpan" id="kobo.221.1">Create a new feature branch from the develop branch. </span><span class="koboSpan" id="kobo.221.2">Let’s call this the </span><strong class="source-inline"><span class="koboSpan" id="kobo.222.1">TOYC-1</span></strong><span class="koboSpan" id="kobo.223.1"> branch, which represents our </span><strong class="bold"><span class="koboSpan" id="kobo.224.1">Inventory Clerk Solution</span></strong><span class="koboSpan" id="kobo.225.1"> epic. </span><span class="koboSpan" id="kobo.225.2">Then, branch off the </span><strong class="source-inline"><span class="koboSpan" id="kobo.226.1">TOYC-1</span></strong><span class="koboSpan" id="kobo.227.1"> branch and create a new feature branch—let’s call it </span><strong class="source-inline"><span class="koboSpan" id="kobo.228.1">TOYC-2</span></strong><span class="koboSpan" id="kobo.229.1">. </span><span class="koboSpan" id="kobo.229.2">Check out the </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">TOYC-2</span></strong><span class="koboSpan" id="kobo.231.1"> branch into your local development environment, and at this stage, you should have all the base files cloned into your </span><span class="No-Break"><span class="koboSpan" id="kobo.232.1">local machine.</span></span></p>
<p><span class="koboSpan" id="kobo.233.1">We will need to make sure that our containers are running. </span><span class="koboSpan" id="kobo.233.2">Run the following commands to build and run </span><span class="No-Break"><span class="koboSpan" id="kobo.234.1">the containers.</span></span></p>
<p><span class="koboSpan" id="kobo.235.1">Using your terminal, within the </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">docker</span></strong><span class="koboSpan" id="kobo.237.1"> directory, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.238.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.239.1">
$ docker-compose build &amp;&amp; docker-compose up -d</span></pre>
<p><span class="koboSpan" id="kobo.240.1">After successfully running</span><a id="_idIndexMarker302"/><span class="koboSpan" id="kobo.241.1"> the containers, execute</span><a id="_idIndexMarker303"/><span class="koboSpan" id="kobo.242.1"> the following command, and make</span><a id="_idIndexMarker304"/><span class="koboSpan" id="kobo.243.1"> sure you can go</span><a id="_idIndexMarker305"/><span class="koboSpan" id="kobo.244.1"> inside the </span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">web container:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.246.1">
$ docker exec -it docker_server-web_1 /bin/bash</span></pre>
<p><span class="koboSpan" id="kobo.247.1">At this point, you should now see our main </span><strong class="source-inline"><span class="koboSpan" id="kobo.248.1">behat</span></strong><span class="koboSpan" id="kobo.249.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.250.1">symfony</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.251.1"> directories:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer099">
<span class="koboSpan" id="kobo.252.1"><img alt="Figure 7.5 – behat and symfony root directories" src="image/Figure_7.05_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.253.1">Figure 7.5 – behat and symfony root directories</span></p>
<p><span class="koboSpan" id="kobo.254.1">At this stage, our development environment is running properly again. </span><span class="koboSpan" id="kobo.254.2">Next, we will create a Behat feature that will help us start the development of the software solution for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">TOYC-2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.256.1"> ticket.</span></span></p>
<h1 id="_idParaDest-113"><a id="_idTextAnchor114"/><span class="koboSpan" id="kobo.257.1">Creating a Behat feature based on a Jira ticket</span></h1>
<p><span class="koboSpan" id="kobo.258.1">In the previous chapter, we learned</span><a id="_idIndexMarker306"/><span class="koboSpan" id="kobo.259.1"> how to create a simple Behat feature. </span><span class="koboSpan" id="kobo.259.2">In this section, we will create a new Behat feature that will represent the </span><strong class="source-inline"><span class="koboSpan" id="kobo.260.1">TOYC-2</span></strong><span class="koboSpan" id="kobo.261.1"> Jira ticket we created earlier, in </span><a href="B18318_02.xhtml#_idTextAnchor027"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.262.1">Chapter 2</span></em></span></a><span class="koboSpan" id="kobo.263.1">, </span><em class="italic"><span class="koboSpan" id="kobo.264.1">Understanding and Organizing the Business Requirements of Our Project</span></em><span class="koboSpan" id="kobo.265.1">. </span><span class="koboSpan" id="kobo.265.2">This will then help drive the development of the integration and unit tests that will help us build the actual solution code. </span><span class="koboSpan" id="kobo.265.3">Let’s get started with </span><span class="No-Break"><span class="koboSpan" id="kobo.266.1">the steps.</span></span></p>
<p><span class="koboSpan" id="kobo.267.1">Create a Behat feature file, name it </span><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">inventory_clerk_registration.feature</span></strong><span class="koboSpan" id="kobo.269.1">, and save it with the following </span><span class="No-Break"><span class="koboSpan" id="kobo.270.1">feature content:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.271.1">codebase/behat/features/inventory_clerk_registration.feature</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.272.1">
Feature: Inventory Clerk Registration
  In order to access the inventory system
  As an Inventory Clerk
  I need to be able to create a clerk account
  Scenario: Access Registration Page
    Given I am in the home "/" path
    When I click the "Register" link
    Then I should be redirected to the registration page
  Scenario: Register
    Given I am in the register "/register" path
    When I fill in Email "Email" with 
        "clerk_email@phptdd.bdd"
    And I fill in Password "Password" with "password"
    And I check the "AgreeTerms" checkbox
    And I click on the "Register" button
    Then I should be able to register a new account</span></pre>
<p><span class="koboSpan" id="kobo.273.1">If you read through the Behat feature</span><a id="_idIndexMarker307"/><span class="koboSpan" id="kobo.274.1"> we just created, it is going to be very self-explanatory about what we are trying to achieve. </span><span class="koboSpan" id="kobo.274.2">These steps are the steps that a real-life user would do to be able to register to our system. </span><span class="koboSpan" id="kobo.274.3">At this point, we won’t be building the solution code yet but will create Behat registration test </span><span class="No-Break"><span class="koboSpan" id="kobo.275.1">code first.</span></span></p>
<h2 id="_idParaDest-114"><a id="_idTextAnchor115"/><span class="koboSpan" id="kobo.276.1">Creating a Behat registration feature</span></h2>
<p><span class="koboSpan" id="kobo.277.1">Since we are using the base code</span><a id="_idIndexMarker308"/><span class="koboSpan" id="kobo.278.1"> for this chapter, we will have to make sure that we have all the libraries installed for us to be able to run Behat. </span></p>
<p><span class="koboSpan" id="kobo.279.1">We need to install the Composer package again to be able to use Behat. </span><span class="koboSpan" id="kobo.279.2">Run the following command to reinstall the </span><span class="No-Break"><span class="koboSpan" id="kobo.280.1">libraries needed:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.281.1">
/var/www/html/behat# composer install</span></pre>
<p><span class="koboSpan" id="kobo.282.1">This will then pull and install all the libraries we were using in the previous chapter. </span><span class="koboSpan" id="kobo.282.2">After the installation, let’s see whether we can generate a Behat PHP class for our </span><span class="No-Break"><span class="koboSpan" id="kobo.283.1">login feature:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.284.1">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">behay.yml</span></strong><span class="koboSpan" id="kobo.286.1"> file with the </span><span class="No-Break"><span class="koboSpan" id="kobo.287.1">following content:</span></span></li>
</ol>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.288.1">codebase/behat/behat.yml</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.289.1">
default:
  suites:
    default:
      contexts:
        - FeatureContext
        - HomeContext
        - InventoryClerkRegistrationContext</span></pre>
<ol>
<li value="2"><span class="koboSpan" id="kobo.290.1">After updating the </span><strong class="source-inline"><span class="koboSpan" id="kobo.291.1">behat.yml</span></strong><span class="koboSpan" id="kobo.292.1"> file, let’s now try running this command to generate a PHP context class: </span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.293.1">/var/www/html/behat# ./vendor/bin/behat --init </span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.294.1">After running the command, we should have been able to generate a new PHP class </span><span class="No-Break"><span class="koboSpan" id="kobo.295.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">codebase/behat/features/bootstrap/InventoryClerkRegistrationContext.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.297.1">.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.298.1">Now, let’s try to automatically generate PHP methods inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">InventoryClerkRegistrationContext.php</span></strong><span class="koboSpan" id="kobo.300.1"> class based on the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">inventory_clerk_registration.feature</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.302.1"> file.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.303.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.304.1">following</span></span><span class="No-Break"><a id="_idIndexMarker309"/></span><span class="No-Break"><span class="koboSpan" id="kobo.305.1"> command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.306.1">/var/www/html/behat# ./vendor/bin/behat features/inventory_clerk_registration.feature --append-snippets</span></strong></pre>
<p><span class="koboSpan" id="kobo.307.1">After running the command, you should see the </span><span class="No-Break"><span class="koboSpan" id="kobo.308.1">following result:</span></span></p>
<p class="IMG---Figure"> </p>
<div>
<div class="IMG---Figure" id="_idContainer100">
<span class="koboSpan" id="kobo.309.1"><img alt="Figure 7.6 – Autogenerating context methods" src="image/Figure_7.06_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.310.1">Figure 7.6 – Autogenerating context methods</span></p>
<p><span class="koboSpan" id="kobo.311.1">After running the preceding</span><a id="_idIndexMarker310"/><span class="koboSpan" id="kobo.312.1"> command, if you open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">codebase/behat/features/bootstrap/InventoryClerkRegistrationContext.php</span></strong><span class="koboSpan" id="kobo.314.1"> class, you should be able to see the newly added methods. </span><span class="koboSpan" id="kobo.314.2">Now, if we run Behat, we’ll probably get a </span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">failing result.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.316.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.317.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.318.1">/var/www/html/behat# ./vendor/bin/behat</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.319.1">You should</span><a id="_idIndexMarker311"/><span class="koboSpan" id="kobo.320.1"> see the </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer101">
<span class="koboSpan" id="kobo.322.1"><img alt="Figure 7.7 – Behat failures" src="image/Figure_7.07_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.323.1">Figure 7.7 – Behat failures</span></p>
<p><span class="koboSpan" id="kobo.324.1">You will notice that we have failed the home feature, have skipped the pending tests, and at this stage, we can’t even visit the home page. </span><span class="koboSpan" id="kobo.324.2">This is because we also must install the missing</span><a id="_idIndexMarker312"/><span class="koboSpan" id="kobo.325.1"> libraries for the Symfony application. </span><span class="koboSpan" id="kobo.325.2">Like what we did for Behat, let’s install the missing Composer packages for the </span><span class="No-Break"><span class="koboSpan" id="kobo.326.1">Symfony app.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.327.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.328.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.329.1">/var/www/html/symfony# composer install</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.330.1">After installing the missing Symfony packages, let’s modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">InventoryClerkRegistrationContext.php</span></strong><span class="koboSpan" id="kobo.332.1"> class so that we throw an exception on the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">iAmOn</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.334.1"> method:</span></span></li>
</ol>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.335.1">codebase/behat/features/bootstrap/InventoryClerkRegistrationContext.php </span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.336.1">
/**
 * @Given I am on \/
 */
public function iAmOn()
{
    throw new \Exception();
}</span></pre>
<p><span class="koboSpan" id="kobo.337.1">Now, let’s try running Behat again and see whether we can at least pass the home page </span><span class="No-Break"><span class="koboSpan" id="kobo.338.1">feature test.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.339.1">Run Behat again by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.341.1">/var/www/html/behat# vendor/bin/behat</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.342.1">We should now be able to pass the </span><strong class="bold"><span class="koboSpan" id="kobo.343.1">home page</span></strong><span class="koboSpan" id="kobo.344.1"> feature test and still continue to fail the inventory clerk </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">feature test:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer102">
<span class="koboSpan" id="kobo.346.1"><img alt="Figure 7.8 – Home page feature passing, login failing" src="image/Figure_7.08_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.347.1">Figure 7.8 – Home page feature passing, login failing</span></p>
<p><span class="koboSpan" id="kobo.348.1">Because we have installed the missing Symfony</span><a id="_idIndexMarker313"/><span class="koboSpan" id="kobo.349.1"> packages, the home page test now passes. </span><span class="koboSpan" id="kobo.349.2">But since we have not built any solution code to pass the login test yet, it will continue </span><span class="No-Break"><span class="koboSpan" id="kobo.350.1">to fail.</span></span></p>
<p><span class="koboSpan" id="kobo.351.1">By following the Red-Green-Refactor pattern, now that we have a failing test, which is the Red phase, we can now move on to writing the solution code needed to pass this failing test, which is the </span><span class="No-Break"><span class="koboSpan" id="kobo.352.1">Green phase.</span></span></p>
<h1 id="_idParaDest-115"><a id="_idTextAnchor116"/><span class="koboSpan" id="kobo.353.1">Passing the Behat registration feature</span></h1>
<p><span class="koboSpan" id="kobo.354.1">Now that we have a couple </span><a id="_idIndexMarker314"/><span class="koboSpan" id="kobo.355.1">of failing Behat tests for the login feature, let’s try to do the minimum amount of work to complete the feature, and pass the tests. </span><span class="koboSpan" id="kobo.355.2">Luckily, Symfony makes it easy to implement security. </span><span class="koboSpan" id="kobo.355.3">We can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">symfony/security-bundle</span></strong><span class="koboSpan" id="kobo.357.1"> Composer package to add authentication and authorization to our application, without having to build everything </span><span class="No-Break"><span class="koboSpan" id="kobo.358.1">from scratch.</span></span></p>
<p><span class="koboSpan" id="kobo.359.1">You can read more about</span><a id="_idIndexMarker315"/><span class="koboSpan" id="kobo.360.1"> Symfony’s security documentation </span><span class="No-Break"><span class="koboSpan" id="kobo.361.1">at </span></span><a href="https://symfony.com/doc/current/security.html"><span class="No-Break"><span class="koboSpan" id="kobo.362.1">https://symfony.com/doc/current/security.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.363.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.364.1">To pass the failing Behat registration feature, as Behat simulates a user using a web browser, we will have to create all the programs needed for a real user to be able to register an account in our application from the web browser, which then hits the controllers, the services, and then down to the database persistence process. </span><span class="koboSpan" id="kobo.364.2">Let’s start with </span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">the controllers.</span></span></p>
<h2 id="_idParaDest-116"><a id="_idTextAnchor117"/><span class="koboSpan" id="kobo.366.1">Writing failing controller tests</span></h2>
<p><span class="koboSpan" id="kobo.367.1">Before passing our main</span><a id="_idIndexMarker316"/><span class="koboSpan" id="kobo.368.1"> Behat feature tests, which can also be considered functional tests, let’s write some controller tests inside our Symfony application itself. </span><span class="koboSpan" id="kobo.368.2">Although the Behat tests will also run tests against the controllers, these Symfony controller tests will be less complex than the Behat </span><span class="No-Break"><span class="koboSpan" id="kobo.369.1">feature tests.</span></span></p>
<p><span class="koboSpan" id="kobo.370.1">By reading the Behat registration feature we created earlier, we can easily identify that we need two controllers at the very least: a home page controller and a registration page controller. </span><span class="koboSpan" id="kobo.370.2">The home page is where the user starts the journey, and the registration page is where the clerk registers for a </span><span class="No-Break"><span class="koboSpan" id="kobo.371.1">new account.</span></span></p>
<p><span class="koboSpan" id="kobo.372.1">Create home page test classes with the </span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">following content:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.374.1">codebase/symfony/tests/ Integration /Controller/HomeControllerTest.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.375.1">
&lt;?php
namespace App\Tests\Integration\Controller;
use Symfony\Bundle\FrameworkBundle\Test\WebTestCase;
class HomeControllerTest extends WebTestCase
{
    public function testCanLoadIndex(): void
    {
        $client = static::createClient();
        $client-&gt;request('GET', '/');
        $this-&gt;assertResponseIsSuccessful();
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.376.1">Next, create a registration page test</span><a id="_idIndexMarker317"/><span class="koboSpan" id="kobo.377.1"> class with the </span><span class="No-Break"><span class="koboSpan" id="kobo.378.1">following content:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.379.1">codebase/symfony/tests/ Integration /Controller/RegistrationControllerTest.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.380.1">
&lt;?php
namespace App\Tests\Integration\Controller;
use Symfony\Bundle\FrameworkBundle\Test\WebTestCase;
class RegistrationControllerTest extends WebTestCase
{
    public function testCanLoadRegister(): void
    {
        $client = static::createClient();
        $client-&gt;request('GET', '/register');
        $this-&gt;assertResponseIsSuccessful();
        $this-&gt;markTestIncomplete();
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.381.1">Now that we have tests</span><a id="_idIndexMarker318"/><span class="koboSpan" id="kobo.382.1"> for the main controllers that we’ll be using to pass the Behat feature tests, let’s first see whether we pass these </span><span class="No-Break"><span class="koboSpan" id="kobo.383.1">Symfony tests.</span></span></p>
<p><span class="koboSpan" id="kobo.384.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.385.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.386.1">
/var/www/html/symfony# php bin/phpunit --testsuite Functional </span></pre>
<p><span class="koboSpan" id="kobo.387.1">After running the tests, you should get two failing tests. </span><span class="koboSpan" id="kobo.387.2">We used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.388.1">--testsuite</span></strong><span class="koboSpan" id="kobo.389.1"> parameter so that we only execute the two controller tests we </span><span class="No-Break"><span class="koboSpan" id="kobo.390.1">just created.</span></span></p>
<p><span class="koboSpan" id="kobo.391.1">Now we know that we will have to pass these two tests, we can continue working on the solutions to pass them. </span><span class="koboSpan" id="kobo.391.2">At this stage, we are in the “Red” phase of the Red-Green-Refactor pattern we discussed earlier in </span><span class="No-Break"><span class="koboSpan" id="kobo.392.1">the chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.393.1">We can now start working on the registration and registration </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1">solution first.</span></span></p>
<h2 id="_idParaDest-117"><a id="_idTextAnchor118"/><span class="koboSpan" id="kobo.395.1">Implementing a registration solution using Symfony</span></h2>
<p><span class="koboSpan" id="kobo.396.1">The great thing about using open source frameworks</span><a id="_idIndexMarker319"/><span class="koboSpan" id="kobo.397.1"> is that there is a big</span><a id="_idIndexMarker320"/><span class="koboSpan" id="kobo.398.1"> chance of a lot of the software we developers need to build for our own projects having already been built as an open source library or package. </span><span class="koboSpan" id="kobo.398.2">And to pass our failing registration test, let’s use Symfony’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.399.1">security-bundle</span></strong><span class="koboSpan" id="kobo.400.1"> package instead of writing everything </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1">from scratch.</span></span></p>
<p><span class="koboSpan" id="kobo.402.1">Remember—as software</span><a id="_idIndexMarker321"/><span class="koboSpan" id="kobo.403.1"> developers, we don’t simply develop</span><a id="_idIndexMarker322"/><span class="koboSpan" id="kobo.404.1"> code alone. </span><span class="koboSpan" id="kobo.404.2">We develop solutions. </span><span class="koboSpan" id="kobo.404.3">And if there are existing packages or libraries that can help you speed up the development of your solution, and if they fit your specifications, you can consider using them instead. </span><span class="koboSpan" id="kobo.404.4">Otherwise, you’ll have to build the code </span><span class="No-Break"><span class="koboSpan" id="kobo.405.1">from scratch.</span></span></p>
<p><span class="koboSpan" id="kobo.406.1">You can read about Symfony’s security solution</span><a id="_idIndexMarker323"/><span class="koboSpan" id="kobo.407.1"> on its official documentation page </span><span class="No-Break"><span class="koboSpan" id="kobo.408.1">at </span></span><a href="https://symfony.com/doc/current/security.html"><span class="No-Break"><span class="koboSpan" id="kobo.409.1">https://symfony.com/doc/current/security.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.410.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.411.1">We can use Symfony’s security solution by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.412.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.413.1">
/var/www/html/symfony# php bin/console make:user </span></pre>
<p><span class="koboSpan" id="kobo.414.1">Read the prompts and enter the default </span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">values suggested.</span></span></p>
<p><span class="koboSpan" id="kobo.416.1">Next, we need to set up the databases we need. </span><span class="koboSpan" id="kobo.416.2">Remember—we are not only using one database, but we also need a separate test database as well. </span><span class="koboSpan" id="kobo.416.3">You can read more about this in </span><a href="B18318_05.xhtml#_idTextAnchor070"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.417.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.418.1">, </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.419.1">Unit Testing</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.420.1">.</span></span></p>
<h3><span class="koboSpan" id="kobo.421.1">Database setup</span></h3>
<p><span class="koboSpan" id="kobo.422.1">We will need</span><a id="_idIndexMarker324"/><span class="koboSpan" id="kobo.423.1"> to create two databases: </span><strong class="source-inline"><span class="koboSpan" id="kobo.424.1">cars</span></strong><span class="koboSpan" id="kobo.425.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">cars_test</span></strong><span class="koboSpan" id="kobo.427.1"> databases. </span><span class="koboSpan" id="kobo.427.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.428.1">cars</span></strong><span class="koboSpan" id="kobo.429.1"> database will serve as our main database, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.430.1">cars_test</span></strong><span class="koboSpan" id="kobo.431.1"> database will be like a replica database that our automated tests will use. </span><span class="koboSpan" id="kobo.431.2">After all, you don’t want to run data mutation tests against your </span><span class="No-Break"><span class="koboSpan" id="kobo.432.1">production database.</span></span></p>
<p><span class="koboSpan" id="kobo.433.1">Run the following commands to set up </span><span class="No-Break"><span class="koboSpan" id="kobo.434.1">our databases:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.435.1">
/var/www/html/symfony# php bin/console doctrine:database:create --env=test
/var/www/html/symfony# php bin/console doctrine:database:create
/var/www/html/symfony# php bin/console make:migration
/var/www/html/symfony# php bin/console doctrine:migrations:migrate -n --env=test
/var/www/html/symfony# php bin/console doctrine:migrations:migrate -n</span></pre>
<p><span class="koboSpan" id="kobo.436.1">As we did in </span><a href="B18318_05.xhtml#_idTextAnchor070"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.437.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.438.1">, </span><em class="italic"><span class="koboSpan" id="kobo.439.1">Unit Testing</span></em><span class="koboSpan" id="kobo.440.1">, we have created our MySQL databases and tables based on the Doctrine</span><a id="_idIndexMarker325"/><span class="koboSpan" id="kobo.441.1"> entity found in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">codebase/symfony/src/Entity</span></strong><span class="koboSpan" id="kobo.443.1"> directory. </span></p>
<p><span class="koboSpan" id="kobo.444.1">Next, let’s create a registration form using Symfony’s </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.445.1">security-bundle</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.446.1"> package.</span></span></p>
<h4><span class="koboSpan" id="kobo.447.1">Using Symfony’s registration form</span></h4>
<p><span class="koboSpan" id="kobo.448.1">Next, we can use Symfony’s registration</span><a id="_idIndexMarker326"/><span class="koboSpan" id="kobo.449.1"> form. </span><span class="koboSpan" id="kobo.449.2">The base solution</span><a id="_idIndexMarker327"/><span class="koboSpan" id="kobo.450.1"> code already has all the dependencies declared in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.451.1">composer.json</span></strong><span class="koboSpan" id="kobo.452.1"> file, so you can just run the following command to generate the </span><span class="No-Break"><span class="koboSpan" id="kobo.453.1">registration code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.454.1">
/var/www/html/symfony# php bin/console make:registration-form</span></pre>
<p><span class="koboSpan" id="kobo.455.1">The preceding command will generate a few files—one of them is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">RegistrationController.php</span></strong><span class="koboSpan" id="kobo.457.1"> class. </span><span class="koboSpan" id="kobo.457.2">If you open that class, you’ll see that it has a </span><strong class="source-inline"><span class="koboSpan" id="kobo.458.1">register</span></strong><span class="koboSpan" id="kobo.459.1"> method. </span><span class="koboSpan" id="kobo.459.2">We also created a test for this controller and method. </span><span class="koboSpan" id="kobo.459.3">Let’s see whether it </span><span class="No-Break"><span class="koboSpan" id="kobo.460.1">now works.</span></span></p>
<p><span class="koboSpan" id="kobo.461.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.462.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.463.1">
/var/www/html/symfony# php bin/phpunit --filter RegistrationControllerTest</span></pre>
<p><span class="koboSpan" id="kobo.464.1">After running the test, we should now be able to pass </span><span class="No-Break"><span class="koboSpan" id="kobo.465.1">this test:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer103">
<span class="koboSpan" id="kobo.466.1"><img alt="Figure 7.9 – Passing the register route test" src="image/Figure_7.09_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.467.1">Figure 7.9 – Passing the register route test</span></p>
<p><span class="koboSpan" id="kobo.468.1">At this stage, we are in the “Green” phase of the Red-Green-Refactor pattern. </span><span class="koboSpan" id="kobo.468.2">Does that mean we are done with the registration</span><a id="_idIndexMarker328"/><span class="koboSpan" id="kobo.469.1"> feature? </span><span class="koboSpan" id="kobo.469.2">Absolutely</span><a id="_idIndexMarker329"/><span class="koboSpan" id="kobo.470.1"> not. </span><span class="koboSpan" id="kobo.470.2">Since we are not completed with this test yet, usually I use PHPUnit’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.471.1">$this-&gt;markTestIncomplete();</span></strong><span class="koboSpan" id="kobo.472.1"> method and add it to the test class. </span><span class="koboSpan" id="kobo.472.2">This can help remind developers that the test is written and the solution is partially there but is still incomplete. </span><span class="koboSpan" id="kobo.472.3">Go ahead and add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.473.1">$this-&gt;markTestIncomplete();</span></strong><span class="koboSpan" id="kobo.474.1"> method inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">testCanLoadRegister</span></strong><span class="koboSpan" id="kobo.476.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">codebase/symfony/tests/Functional/Controller/RegistrationControllerTest.php</span></strong><span class="koboSpan" id="kobo.478.1"> test class. </span></p>
<p><span class="koboSpan" id="kobo.479.1">Now, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.480.1">test again:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.481.1">
/var/www/html/symfony# php bin/phpunit --filter RegistrationControllerTest</span></pre>
<p><span class="koboSpan" id="kobo.482.1">You should see the </span><span class="No-Break"><span class="koboSpan" id="kobo.483.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer104">
<span class="koboSpan" id="kobo.484.1"><img alt="Figure 7.10 – Incomplete register route test" src="image/Figure_7.10_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.485.1">Figure 7.10 – Incomplete register route test</span></p>
<p><span class="koboSpan" id="kobo.486.1">Now the test is marked as incomplete, and we can go back to it later. </span><span class="koboSpan" id="kobo.486.2">It’s up to you whether you want to use this feature, but I find it useful when working on large projects. </span><span class="koboSpan" id="kobo.486.3">The only thing I don’t like about this is that sometimes it doesn’t grab my attention as much as a failing test would. </span><span class="koboSpan" id="kobo.486.4">For now, let’s remove the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.487.1">Incomplete</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.488.1"> mark.</span></span></p>
<h4><span class="koboSpan" id="kobo.489.1">Creating a home controller</span></h4>
<p><span class="koboSpan" id="kobo.490.1">Now let’s create a home controller</span><a id="_idIndexMarker330"/><span class="koboSpan" id="kobo.491.1"> where the users usually land first. </span><span class="koboSpan" id="kobo.491.2">Here, we will also find the </span><strong class="bold"><span class="koboSpan" id="kobo.492.1">Register</span></strong><span class="koboSpan" id="kobo.493.1"> link that the user will click to get redirected to the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.494.1">Registration</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.495.1"> page.</span></span></p>
<p><span class="koboSpan" id="kobo.496.1">Create a home controller by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.498.1">
/var/www/html/symfony# php bin/console make:controller HomeController</span></pre>
<p><span class="koboSpan" id="kobo.499.1">After running that command, we should </span><a id="_idIndexMarker331"/><span class="koboSpan" id="kobo.500.1">now have a new Symfony controller in </span><strong class="source-inline"><span class="koboSpan" id="kobo.501.1">codebase/symfony/src/Controller/HomeController.php</span></strong><span class="koboSpan" id="kobo.502.1">. </span><span class="koboSpan" id="kobo.502.2">Edit the route inside the controller and replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.503.1">/home</span></strong><span class="koboSpan" id="kobo.504.1"> with just a forward slash (</span><strong class="source-inline"><span class="koboSpan" id="kobo.505.1">/</span></strong><span class="koboSpan" id="kobo.506.1">). </span></p>
<p><span class="koboSpan" id="kobo.507.1">Now, let’s see whether our controller tests now pass. </span><span class="koboSpan" id="kobo.507.2">Run the Symfony functional </span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">tests again:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.509.1">
/var/www/html/symfony# php bin/phpunit --testsuite Functional --debug</span></pre>
<p><span class="koboSpan" id="kobo.510.1">You should now see the </span><span class="No-Break"><span class="koboSpan" id="kobo.511.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer105">
<span class="koboSpan" id="kobo.512.1"><img alt="Figure 7.11 – Passing controller tests" src="image/Figure_7.11_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.513.1">Figure 7.11 – Passing controller tests</span></p>
<p><span class="koboSpan" id="kobo.514.1">Since our controller tests are very simple, we are basically just testing whether the page response for the route is successful; we can now be sure that both tests pass. </span><span class="koboSpan" id="kobo.514.2">This will not satisfy the Behat registration feature test, though. </span><span class="koboSpan" id="kobo.514.3">So, let’s continue working </span><span class="No-Break"><span class="koboSpan" id="kobo.515.1">on it!</span></span></p>
<p><span class="koboSpan" id="kobo.516.1">Let’s modify the home controller’s twig template content. </span><span class="koboSpan" id="kobo.516.2">Open the following file and replace the entire </span><strong class="source-inline"><span class="koboSpan" id="kobo.517.1">example-wrapper</span></strong><span class="koboSpan" id="kobo.518.1"> div content with </span><span class="No-Break"><span class="koboSpan" id="kobo.519.1">the following:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.520.1">codebase/symfony/templates/home/index.html.twig</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.521.1">
&lt;div class="example-wrapper"&gt;
    &lt;h1&gt;{{ controller_name }}&lt;/h1&gt;
    &lt;ul&gt;
        &lt;li&gt;&lt;a href="/register" id="lnk-register"&gt;
            Register&lt;/a&gt; &lt;/li&gt;
    &lt;/ul&gt;
&lt;/div&gt;</span></pre>
<p><span class="koboSpan" id="kobo.522.1">We just added a link to the</span><a id="_idIndexMarker332"/><span class="koboSpan" id="kobo.523.1"> registration page. </span><span class="koboSpan" id="kobo.523.2">If you try to access the home page through the browser, you’ll see something </span><span class="No-Break"><span class="koboSpan" id="kobo.524.1">like this:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer106">
<span class="koboSpan" id="kobo.525.1"><img alt="Figure 7.12 – HomeController" src="image/Figure_7.12_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.526.1">Figure 7.12 – HomeController</span></p>
<p><span class="koboSpan" id="kobo.527.1">Next, let’s go back to our BDD test in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.528.1">behat</span></strong><span class="koboSpan" id="kobo.529.1"> directory. </span><span class="koboSpan" id="kobo.529.2">Let’s try to write some test code and see whether we can finally register a </span><span class="No-Break"><span class="koboSpan" id="kobo.530.1">new user.</span></span></p>
<h2 id="_idParaDest-118"><a id="_idTextAnchor119"/><span class="koboSpan" id="kobo.531.1">Passing the Behat feature</span></h2>
<p><span class="koboSpan" id="kobo.532.1">Our Behat registration feature</span><a id="_idIndexMarker333"/><span class="koboSpan" id="kobo.533.1"> simulates a user visiting the home page, clicking on the registration link, getting redirected to the registration page, filling up the registration form, clicking on the </span><strong class="bold"><span class="koboSpan" id="kobo.534.1">Register</span></strong><span class="koboSpan" id="kobo.535.1"> button, and then getting redirected to some </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">elected page.</span></span></p>
<p><span class="koboSpan" id="kobo.537.1">This is exactly like what a manual tester would do to test the registration feature. </span><span class="koboSpan" id="kobo.537.2">Instead of doing these steps manually using a browser, let’s just use Behat to do all these steps </span><span class="No-Break"><span class="koboSpan" id="kobo.538.1">for us.</span></span></p>
<p><span class="koboSpan" id="kobo.539.1">Open the following Behat context file, and replace the content with </span><span class="No-Break"><span class="koboSpan" id="kobo.540.1">the following:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.541.1">codebase/behat/features/bootstrap/InventoryClerkRegistrationContext.php</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.542.1">
&lt;?php
use Behat\Mink\Mink;
use Behat\Mink\Session;
use Behat\Mink\Driver\GoutteDriver;
use Behat\MinkExtension\Context\MinkContext;
use Behat\MinkExtension\Context\MinkAwareContext;
/**
 * Defines application features from the specific context.
 </span><span class="koboSpan" id="kobo.542.2">*/
class InventoryClerkRegistrationContext extends MinkContext implements MinkAwareContext
{
    /**
     * Initializes context.
</span><span class="koboSpan" id="kobo.542.3">     *
     * Every scenario gets its own context instance.
</span><span class="koboSpan" id="kobo.542.4">     * You can also pass arbitrary arguments to the
     * context constructor through behat.yml.
</span><span class="koboSpan" id="kobo.542.5">     */
    public function __construct()
    {
        $mink = new Mink([
            'goutte'    =&gt; new Session(new GoutteDriver()), // Headless browser
        ]);
        $this-&gt;setMink($mink);
        $this-&gt;getMink()-&gt;getSession('goutte')-&gt;start();
    }
}  </span></pre>
<p><span class="koboSpan" id="kobo.543.1">In the preceding snippet, we started</span><a id="_idIndexMarker334"/><span class="koboSpan" id="kobo.544.1"> with the constructor. </span><span class="koboSpan" id="kobo.544.2">We declared the emulator and session objects we will use in </span><span class="No-Break"><span class="koboSpan" id="kobo.545.1">the class.</span></span></p>
<p><span class="koboSpan" id="kobo.546.1">Next, add the </span><span class="No-Break"><span class="koboSpan" id="kobo.547.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.548.1">
/**
 * @Given I am in the home :arg1 path
 */
public function iAmInTheHomePath($arg1)
{
    $sessionHeadless = $this-&gt;getMink()-&gt;getSession
        ('goutte');
    $sessionHeadless-&gt;visit($arg1);
    // Make sure the register link exists.
</span><span class="koboSpan" id="kobo.548.2">    $assertHeadless = $this-&gt;assertSession('goutte');
    $assertHeadless-&gt;elementExists('css', '#lnk-register');
}
/**
 * @When I click the :arg1 link
 */
public function iClickTheLink($arg1)
{
    $sessionHeadless = $this-&gt;getMink()-&gt;getSession
        ('goutte');
    $homePage = $sessionHeadless-&gt;getPage();
    $homePage-&gt;clickLink($arg1);
}</span></pre>
<p><span class="koboSpan" id="kobo.549.1">The preceding code will simulate a user being on the home page, then clicking on the </span><strong class="bold"><span class="koboSpan" id="kobo.550.1">Register</span></strong><span class="koboSpan" id="kobo.551.1"> link. </span></p>
<p><span class="koboSpan" id="kobo.552.1">In the next snippet, Behat will try to confirm</span><a id="_idIndexMarker335"/><span class="koboSpan" id="kobo.553.1"> that it got redirected to the register </span><span class="No-Break"><span class="koboSpan" id="kobo.554.1">controller page:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.555.1">
/**
 * @Then I should be redirected to the registration page
 */
public function iShouldBeRedirectedToTheRegistrationPage()
{
    // Make sure we are in the correct page.
</span><span class="koboSpan" id="kobo.555.2">    $assertHeadless = $this-&gt;assertSession('goutte');
    $assertHeadless-&gt;pageTextContains('Register');
    $assertHeadless-&gt;elementExists('css', '#registration_form_email');
} </span></pre>
<p><span class="koboSpan" id="kobo.556.1">You can easily check whether you’re on the right page by checking the route, but the preceding snippet shows that you can inspect the DOM itself, returned by </span><span class="No-Break"><span class="koboSpan" id="kobo.557.1">the controller.</span></span></p>
<p><span class="koboSpan" id="kobo.558.1">Next, add the following code</span><a id="_idIndexMarker336"/><span class="koboSpan" id="kobo.559.1"> to mimic a user inputting values into </span><span class="No-Break"><span class="koboSpan" id="kobo.560.1">input forms:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.561.1">
/**
 * @When I fill in Email :arg1 with :arg2
 */
public function iFillInEmailWith($arg1, $arg2)
{
    $sessionHeadless = $this-&gt;getMink()-&gt;getSession
        ('goutte');
    $registrationPage = $sessionHeadless-&gt;getPage();
    $registrationPage-&gt;fillField($arg1, $arg2);
}
/**
 * @When I fill in Password :arg1 with :arg2
 */
public function iFillInPasswordWith($arg1, $arg2)
{
    $sessionHeadless = $this-&gt;getMink()-&gt;getSession
        ('goutte');
    $registrationPage = $sessionHeadless-&gt;getPage();
    $registrationPage-&gt;fillField($arg1, $arg2);
}</span></pre>
<p><span class="koboSpan" id="kobo.562.1">In the preceding snippet, the code mimics entering text into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.563.1">Email</span></strong><span class="koboSpan" id="kobo.564.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.565.1">Password</span></strong><span class="koboSpan" id="kobo.566.1"> fields. </span><span class="koboSpan" id="kobo.566.2">Next, we will simulate checking a checkbox and clicking on the </span><strong class="bold"><span class="koboSpan" id="kobo.567.1">Submit</span></strong><span class="koboSpan" id="kobo.568.1"> button. </span><span class="koboSpan" id="kobo.568.2">Add the </span><span class="No-Break"><span class="koboSpan" id="kobo.569.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.570.1">
/**
 * @When I check the :arg1 checkbox
 */
public function iCheckTheCheckbox($arg1)
{
    $sessionHeadless = $this-&gt;getMink()-&gt;getSession
        ('goutte');
    $registrationPage = $sessionHeadless-&gt;getPage();
    $registrationPage-&gt;checkField($arg1);
}
/**
 * @When I click on the :arg1 button
 */
public function iClickOnTheButton($arg1)
{
    $sessionHeadless = $this-&gt;getMink()-&gt;getSession
        ('goutte');
    $registrationPage = $sessionHeadless-&gt;getPage();
    $registrationPage-&gt;pressButton($arg1);
}</span></pre>
<p><span class="koboSpan" id="kobo.571.1">In the preceding code, we have checked</span><a id="_idIndexMarker337"/><span class="koboSpan" id="kobo.572.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.573.1">Agree terms</span></strong><span class="koboSpan" id="kobo.574.1"> checkbox, then clicked on the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.575.1">Register</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.576.1"> button.</span></span></p>
<p><span class="koboSpan" id="kobo.577.1">Next, add the following code to complete </span><span class="No-Break"><span class="koboSpan" id="kobo.578.1">the test:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.579.1">
/**
 * @Then I should be able to register a new account
 */
public function iShouldBeAbleToRegisterANewAccount()
{
    $sessionHeadless = $this-&gt;getMink()-&gt;getSession
        ('goutte');
    $thePage = $sessionHeadless-&gt;getPage()-&gt;getText();
    if (!str_contains($thePage, 'There is already an 
        account with this email')) {
    $assertHeadless = $this-&gt;assertSession('goutte');
    $assertHeadless-&gt;addressEquals('/home');
}</span></pre>
<p><span class="koboSpan" id="kobo.580.1">Since, in the Symfony app, we are redirecting</span><a id="_idIndexMarker338"/><span class="koboSpan" id="kobo.581.1"> the user back to the home controller when successful, we can check whether we got redirected to the home page. </span><span class="koboSpan" id="kobo.581.2">You’ll notice that it also checks whether the user already exists; you can break down this test further as much as you want so that you can separate scenarios </span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">like this.</span></span></p>
<p><span class="koboSpan" id="kobo.583.1">What we did in the preceding code block is break down the scenarios inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.584.1">codebase/behat/features/inventory_clerk_registration.feature</span></strong><span class="koboSpan" id="kobo.585.1"> file into PHP methods. </span><span class="koboSpan" id="kobo.585.2">We then wrote PHP code to click links and buttons, populate text fields, check a checkbox, </span><span class="No-Break"><span class="koboSpan" id="kobo.586.1">and more.</span></span></p>
<p><span class="koboSpan" id="kobo.587.1">But let’s see whether this works. </span><span class="koboSpan" id="kobo.587.2">Run the following command to run </span><span class="No-Break"><span class="koboSpan" id="kobo.588.1">this test:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.589.1">
/var/www/html/behat# ./runBehat.sh --suite=suite_a features/inventory_clerk_registration.feature</span></pre>
<p><span class="koboSpan" id="kobo.590.1">It will take a few seconds to execute, but you should get the </span><span class="No-Break"><span class="koboSpan" id="kobo.591.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer107">
<span class="koboSpan" id="kobo.592.1"><img alt="Figure 7.13 – Registration feature test" src="image/Figure_7.13_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.593.1">Figure 7.13 – Registration feature test</span></p>
<p><span class="koboSpan" id="kobo.594.1">By running the Behat test, we can replace</span><a id="_idIndexMarker339"/><span class="koboSpan" id="kobo.595.1"> a manual testing process usually done from a browser. </span><span class="koboSpan" id="kobo.595.2">But we need to confirm whether we were really able to register, and persist the data into our MySQL database using Doctrine ORM! </span><span class="koboSpan" id="kobo.595.3">At this point, we are in the “Refactor” phase of the Red-Green-Refactor pattern, and I personally think that the “Refactor” phase can be a bit more open-ended and open </span><span class="No-Break"><span class="koboSpan" id="kobo.596.1">to interpretation.</span></span></p>
<p><span class="koboSpan" id="kobo.597.1">You can use your own MySQL client or the phpMyAdmin app that we configured earlier, in </span><a href="B18318_03.xhtml#_idTextAnchor039"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.598.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.599.1">, </span><em class="italic"><span class="koboSpan" id="kobo.600.1">Setting Up Our Development Environment Using Docker Containers</span></em><span class="koboSpan" id="kobo.601.1">, to verify </span><span class="No-Break"><span class="koboSpan" id="kobo.602.1">the data.</span></span></p>
<p><span class="koboSpan" id="kobo.603.1">You will get the following result using the command line in the </span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">MySQL container:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer108">
<span class="koboSpan" id="kobo.605.1"><img alt="Figure 7.14 – User successfully registered: view from ﻿the CLI" src="image/Figure_7.14_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.606.1">Figure 7.14 – User successfully registered: view from the CLI</span></p>
<p><span class="koboSpan" id="kobo.607.1">And this is the result using the phpMyAdmin application we configured, which can be accessed with a local browser </span><span class="No-Break"><span class="koboSpan" id="kobo.608.1">at </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">http://127.0.0.1:3333</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.610.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer109">
<span class="koboSpan" id="kobo.611.1"><img alt="Figure 7.15 – User successfully registered: view from ﻿﻿phpMyAdmin" src="image/Figure_7.15_B18318.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.612.1">Figure 7.15 – User successfully registered: view from phpMyAdmin</span></p>
<p><span class="koboSpan" id="kobo.613.1">We can see from the database that we were</span><a id="_idIndexMarker340"/><span class="koboSpan" id="kobo.614.1"> able to persist the registration details. </span><span class="koboSpan" id="kobo.614.2">At this stage, we can say that our registration functionality works! </span><span class="koboSpan" id="kobo.614.3">And we were able to test it without manually opening a desktop browser to enter form details. </span></p>
<p><span class="koboSpan" id="kobo.615.1">We now have a PHP program doing the registration feature testing for us, but we also need to build the login feature and the most important part: the inventory system itself. </span><span class="koboSpan" id="kobo.615.2">We have a lot of other features to build, but this is a </span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">great start!</span></span></p>
<h1 id="_idParaDest-119"><a id="_idTextAnchor120"/><span class="koboSpan" id="kobo.617.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.618.1">In this chapter, we started by creating an easy-to-understand list of features and scenarios detailing what needs to be built, based on a Jira ticket. </span><span class="koboSpan" id="kobo.618.2">Before working on the solution code, we first started with a Gherkin feature called </span><strong class="bold"><span class="koboSpan" id="kobo.619.1">Inventory Clerk Registration</span></strong><span class="koboSpan" id="kobo.620.1">. </span><span class="koboSpan" id="kobo.620.2">This feature can be read by anyone—even non-developers will be able to understand it. </span><span class="koboSpan" id="kobo.620.3">This feature explains how our system should behave. </span><span class="koboSpan" id="kobo.620.4">We then took that behavior and created simple and failing functional tests inside the Symfony application. </span><span class="koboSpan" id="kobo.620.5">Creating these failing tests gave us a list of things we need to build. </span><span class="koboSpan" id="kobo.620.6">We then proceeded to develop the solution to pass these failing functional tests. </span><span class="koboSpan" id="kobo.620.7">And finally, we wrote code to tell Behat the intricate steps to click a link or a button, and fill up fields. </span><span class="koboSpan" id="kobo.620.8">BDD and TDD are not just about writing automated tests—it’s about using them as a process to develop </span><span class="No-Break"><span class="koboSpan" id="kobo.621.1">our solutions.</span></span></p>
<p><span class="koboSpan" id="kobo.622.1">In the next chapter, we will continue building tests and solution code. </span><span class="koboSpan" id="kobo.622.2">We will go through the SOLID principles to help us structure our own code to make sure it is more maintainable </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">and testable.</span></span></p>
</div>
</body></html>