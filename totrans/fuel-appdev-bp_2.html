<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Building a To-do List Application"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Building a To-do List Application</h1></div></div></div><p>We saw in the last chapter a few basics of the FuelPHP framework, but there is still a lot to learn to be comfortable with it. We will create here our first real-world application to dive a little bit deeper into the main FuelPHP features. We will create a to-do list application, a common training example when introducing frameworks. Again, it won't be a very complicated application, but this project will be used as a basis to introduce essential FuelPHP components.</p><p>By the end of this chapter, you should know the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">What is a <span class="strong"><strong>Entity Relationship</strong></span> (<span class="strong"><strong>ER</strong></span>) diagram</li><li class="listitem" style="list-style-type: disc">What is an profiler and how to use it</li><li class="listitem" style="list-style-type: disc">How to use the <code class="literal">Debug</code> class</li><li class="listitem" style="list-style-type: disc">What is an <span class="strong"><strong>Object Relational Mapper</strong></span> (<span class="strong"><strong>ORM</strong></span>) and how to use it in your project</li><li class="listitem" style="list-style-type: disc">How to use the basic operations of <code class="literal">Model_Crud</code> and <code class="literal">Model_Orm</code></li><li class="listitem" style="list-style-type: disc">The ORM relations</li><li class="listitem" style="list-style-type: disc">What are observers and how to use them</li><li class="listitem" style="list-style-type: disc">How to handle Ajax requests</li></ul></div><p>We will assume here, that you have read <a class="link" href="ch01.html" title="Chapter 1. Building Your First FuelPHP Application">Chapter 1</a>, <span class="emphasis"><em>Building Your First FuelPHP Application</em></span>, as the very basics of the framework have been explained there. We will also use JavaScript and jQuery for improving the to-do list user interface. Since this book is intended for intermediary web developers, we will assume you have some knowledge about these technologies. If this is not the case, don't worry, we will use them very lightly and you can find a lot of resources about these tools on the web.</p><div class="section" title="Specifications"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec15"/>Specifications</h1></div></div></div><p>First of all, let's define what should be <a id="id122" class="indexterm"/>expected in our final application as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A to-do list<a id="id123" class="indexterm"/> is created to monitor the progress of a project. A project is described by a name and has many tasks (the to-do list). We will assume here that a user could have many simultaneous projects and, therefore, can create and manage as many projects as he/she wants. Each project can also be deleted.</li><li class="listitem" style="list-style-type: disc">A task<a id="id124" class="indexterm"/> is described by a name and has a Boolean status ("done" or "not done").</li><li class="listitem" style="list-style-type: disc">Tasks are ordered in the project and the user should be able to easily move items in the list using drag and drop.</li></ul></div><p>This is still a simple application, and we won't support any privacy feature such as authentication (this will be addressed in <a class="link" href="ch03.html" title="Chapter 3. Building a Blog Application">Chapters 3</a>, <span class="emphasis"><em>Building a Blog Application</em></span> and <a class="link" href="ch05.html" title="Chapter 5. Building Your Own Restful API">Chapter 5</a>, <span class="emphasis"><em>Building Your Own Restful API</em></span>).</p></div></div>
<div class="section" title="Conception"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec16"/>Conception</h1></div></div></div><p>This step should be pretty <a id="id125" class="indexterm"/>straightforward from the specification phase. We will generate the following two models:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Project</strong></span>: This <a id="id126" class="indexterm"/>model will only have a name property.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Task</strong></span>: This<a id="id127" class="indexterm"/> model will have a name, a status, and a rank property. A project contains many tasks, and each task is related to a project, so we will add an additional column here, named <code class="literal">project_id</code>. This column will contain the ID of the project each task is associated with.</li></ul></div><p>We can represent our models by the following <span class="strong"><strong>ER</strong></span> diagram:</p><div class="mediaobject"><img src="graphics/5401OS_02_01.jpg" alt="Conception"/><div class="caption"><p>Entity Relationship diagram (Min-Max notation)</p></div></div><p>An <span class="strong"><strong>ER</strong></span> diagram<a id="id128" class="indexterm"/> allows you to describe the data structure of your application. As you noticed, almost everything we wrote earlier can be found in the diagram:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The models (called entities in ER diagrams), represented by rectangles</li><li class="listitem" style="list-style-type: disc">The model's properties (called attributes), represented by ellipses (primary keys are underlined) and linked to models using lines</li><li class="listitem" style="list-style-type: disc">The relationships between models, represented by a line from a model to another</li></ul></div><p>We used the Min-Max notation for relations. Here is how to understand it:</p><p>On the line joining the <a id="id129" class="indexterm"/>
<span class="strong"><strong>Project</strong></span> model to the <a id="id130" class="indexterm"/>
<span class="strong"><strong>Task</strong></span> model, you can read <span class="strong"><strong>(0, N) Has many</strong></span> next to the <span class="strong"><strong>Project</strong></span> rectangle and <span class="strong"><strong>Belongs to (1, 1)</strong></span> next to the <span class="strong"><strong>Task</strong></span> rectangle. The <span class="strong"><strong>(0, N)</strong></span> and <span class="strong"><strong>(1, 1)</strong></span> you can read on the diagram represent the minimum and maximum number of elements an instance can be linked to: in our case, a project can be linked to any number of tasks (between <span class="emphasis"><em>0</em></span> and <span class="emphasis"><em>N</em></span>) and a task can be linked to only one project (between <span class="emphasis"><em>1</em></span> and <span class="emphasis"><em>1</em></span>). The text next to <span class="strong"><strong>(0, N)</strong></span> and <span class="strong"><strong>(1, 1)</strong></span> is the relation's name. Here, we simply used the FuelPHP relation's type we will use (we will explain those relations later in the <span class="emphasis"><em>ORM relations</em></span> section). Even a non-programmer can understand it by reading it as follows: "Each project has many tasks", "Each task belongs to one project".</p><p>It can be convenient to draw an ER diagram if you struggle to understand how you can organize your data. We will use this diagram in the upcoming chapters, and it is especially recommended if you want to understand a complex data structure with many models and relations between them. You are<a id="id131" class="indexterm"/> recommended to read more on the subject at <a class="ulink" href="http://en.wikipedia.org/wiki/Entity-relationship_model">http://en.wikipedia.org/wiki/Entity-relationship_model</a>.</p></div>
<div class="section" title="FuelPHP installation and configuration"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec17"/>FuelPHP installation and configuration</h1></div></div></div><p>You first need to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Install a new <a id="id132" class="indexterm"/>FuelPHP instance</li><li class="listitem" style="list-style-type: disc">Configure Apache<a id="id133" class="indexterm"/> and your host file to handle it: in this chapter, we will access our application by requesting the URL <code class="literal">http://mytodolists.app</code></li><li class="listitem" style="list-style-type: disc">Update Composer if necessary</li><li class="listitem" style="list-style-type: disc">Create a new database for your application</li><li class="listitem" style="list-style-type: disc">And configure FuelPHP in order to allow your application to access this database</li></ul></div><p>These steps have been<a id="id134" class="indexterm"/> covered in <a class="link" href="ch01.html" title="Chapter 1. Building Your First FuelPHP Application">Chapter 1</a>, <span class="emphasis"><em>Building Your First FuelPHP Application</em></span>, so you might want to take a look at it.</p><p>This project will also need the ORM package, and since it is already installed, we just need to enable it. For doing this, simply open the <code class="literal">APPPATH/config/config.php</code> file and insert the following at the end of the returned array:</p><div class="informalexample"><pre class="programlisting">  'always_load'  =&gt; array(
    'packages'  =&gt; array(
      'orm',
    ),
  ),</pre></div><p>Or you can uncomment the appropriate lines. This will load the ORM package every time the FuelPHP instance is loaded.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>You can also load a package in an ad hoc manner, using the <code class="literal">Package::load</code> method. This will be addressed in <a class="link" href="ch03.html" title="Chapter 3. Building a Blog Application">Chapter 3</a>, <span class="emphasis"><em>Building a Blog Application</em></span>.</p></div></div></div>
<div class="section" title="Scaffolding"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Scaffolding</h1></div></div></div><p>We will now <a id="id135" class="indexterm"/>generate, as in <a class="link" href="ch01.html" title="Chapter 1. Building Your First FuelPHP Application">Chapter 1</a>, <span class="emphasis"><em>Building Your First FuelPHP Application</em></span>, the necessary code to handle our objects.</p><p>Let's first generate the scaffold of the project model:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php oil generate scaffold/orm project name:string</strong></span>
</pre></div><p>The command should print the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Creating migration: APPPATH/migrations/001_create_projects.php</strong></span>
<span class="strong"><strong>Creating model: APPPATH/classes/model/project.php</strong></span>
<span class="strong"><strong>Creating controller: APPPATH/classes/controller/project.php</strong></span>
<span class="strong"><strong>Creating view: APPPATH/views/project/index.php</strong></span>
<span class="strong"><strong>Creating view: APPPATH/views/project/view.php</strong></span>
<span class="strong"><strong>Creating view: APPPATH/views/project/create.php</strong></span>
<span class="strong"><strong>Creating view: APPPATH/views/project/edit.php</strong></span>
<span class="strong"><strong>Creating view: APPPATH/views/project/_form.php</strong></span>
<span class="strong"><strong>Creating view: APPPATH/views/template.php</strong></span>
</pre></div><p>Note that we used <code class="literal">scaffold/orm</code> instead of <code class="literal">scaffold/crud</code> in <a class="link" href="ch01.html" title="Chapter 1. Building Your First FuelPHP Application">Chapter 1</a>, <span class="emphasis"><em>Building Your First FuelPHP Application</em></span>: this way, oil will generate code files that use the ORM package. For instance, we will see later that the generated model will extend <code class="literal">Orm\Model</code> instead of <code class="literal">Model_Crud</code>.</p><p>We now need to generate the model for managing our tasks. We won't use scaffold here because we plan to manage tasks on the project's visualization page, so we only need the model.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php oil generate model/orm task name:string status:boolean rank:int project_id:int</strong></span>
</pre></div><p>This command should print the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Creating model: APPPATH/classes/model/task.php</strong></span>
<span class="strong"><strong>Creating migration: APPPATH/migrations/002_create_tasks.php</strong></span>
</pre></div><p>As you can notice, we generated here only the model and the migration file. All you have to do now is to execute the migration files:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php oil refine migrate</strong></span>
</pre></div></div>
<div class="section" title="Routes configuration"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec19"/>Routes configuration</h1></div></div></div><p>You can now <a id="id136" class="indexterm"/>manage your project by requesting the URL <code class="literal">http://mytodolists.app/project</code>.</p><p>Since this is our point of entry, we would like to access this page when requesting the root URL <code class="literal">http://mytodolists.app/</code>.</p><p>As we saw in <a class="link" href="ch01.html" title="Chapter 1. Building Your First FuelPHP Application">Chapter 1</a>, <span class="emphasis"><em>Building Your First FuelPHP Application</em></span>, you just need to edit the <code class="literal">APPPATH/config/routes.php</code> configuration file. Replace <code class="literal">'_root_'  =&gt; 'welcome/index'</code> with <code class="literal">'_root_'  =&gt; 'project/index'</code>.</p></div>
<div class="section" title="The profiler"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec20"/>The profiler</h1></div></div></div><p>Since we will need the <a id="id137" class="indexterm"/>profiler for the next section, we will introduce it here. FuelPHP supplies a profiler that enables you to get a sense of what is going on when you request a web page. It can indeed show many performance metrics, executed SQL requests, current logs, session, and POST / GET variables.</p><p>You will need to activate it though. It is wise to only use this tool in development mode, since otherwise you can have serious security issues. For doing that, you first need to create the <code class="literal">APPPATH/config/development/config.php</code> configuration file and write the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php

return array(
    'profiling'  =&gt; true,
);</pre></div><p>You also need to edit the <code class="literal">APPPATH/config/development/db.php</code> configuration file in order to see database queries (the profiler won't show them otherwise): at the end of the <code class="literal">default</code> array, add <code class="literal">'profiling' =&gt; true,</code>.</p><p>If you now request your root URL <code class="literal">http://mytodolists.app/</code>, you will see a black rectangle labeled <span class="strong"><strong>Code Profiler</strong></span> at the bottom right of the screen. If you click on it, you should see the following:</p><div class="mediaobject"><img src="graphics/5401OS_02_02.jpg" alt="The profiler"/></div><p>The following describes the <a id="id138" class="indexterm"/>several tabs you can access:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>NB Console</strong></span> (<span class="strong"><strong>NB</strong></span> being the number of logs): This tab displays all logs. For instance, if you add <code class="literal">Log::info('Index Action', 'This is a test');</code> at the beginning of the index action of the Project controller and then refresh the web page, you should see a new item appear in this tab .</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>TIME Load Time</strong></span> (<span class="strong"><strong>TIME</strong></span> being the web page total load time): This tab displays logs associated with time markers. Note that these logs also appear in the first tab. For instance, if you add <code class="literal">Profiler::mark('Index Action');</code> at the beginning of the index action of the Project controller, you should see a new item appear in this tab.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>NB Queries Database</strong></span> (<span class="strong"><strong>NB</strong></span> being the number of queries): This tab displays database queries that have been executed when loading the web page. For each query, its analysis and its call trace are displayed. The number of duplicates is also displayed, and you can spot queries that appear to duplicate a previous one by seeing the word <span class="strong"><strong>DUPLICATE</strong></span> next to <span class="strong"><strong>Speed</strong></span>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>SIZE Memory Used</strong></span> (<span class="strong"><strong>SIZE</strong></span> being the amount of used memory): This tab displays logs associated with memory markers. Note that these logs also appear in the first tab. For instance, if you add <code class="literal">Profiler::mark_memory($this, 'Controller_Project object');</code> at the beginning of the index action of the Project controller, you should see a new item appear in this tab.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>NB Files Included</strong></span> (<span class="strong"><strong>NB</strong></span> being the number of files): This tab displays all files (code or configuration) that have been loaded for displaying the web page.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>NB Config items loaded</strong></span> (<span class="strong"><strong>NB</strong></span> being the number of items): This tab displays the configuration items (not the files) that have been loaded. For instance, if you load a configuration file that contains an associated array with 5 keys, 5 new items will appear in this tab.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>NB Session vars loaded</strong></span>, <span class="strong"><strong>NB GET vars loaded</strong></span>, <span class="strong"><strong>NB POST vars loaded</strong></span>: These tabs display<a id="id139" class="indexterm"/> request and session variables. For instance, a new item should appear in the <span class="strong"><strong>NB GET vars loaded</strong></span> tab if you request the URL <code class="literal">http://mytodolists.app/?param=test</code>.</li></ul></div></div>
<div class="section" title="Models, relations, and the ORM"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec21"/>Models, relations, and the ORM</h1></div></div></div><p>We have now<a id="id140" class="indexterm"/> done the<a id="id141" class="indexterm"/> preliminary steps: we installed FuelPHP, configured it, generated the scaffold for managing the projects, and created the task model. We didn't connect the two models though, and we haven't yet displayed tasks anywhere. More importantly, we haven't explained how to load objects until now. This is the aim of this section.</p><div class="section" title="Differences between CRUD and ORM"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec24"/>Differences between CRUD and ORM</h2></div></div></div><p>As we explained earlier, we<a id="id142" class="indexterm"/> used oil to generate code, but instead of using <code class="literal">scaffold/crud</code> as<a id="id143" class="indexterm"/> in <a class="link" href="ch01.html" title="Chapter 1. Building Your First FuelPHP Application">Chapter 1</a>, <span class="emphasis"><em>Building Your First FuelPHP Application</em></span>, we used <code class="literal">scaffold/orm</code> and <code class="literal">model/orm</code>. If you take a look at the files (controllers, views, and models), you will only see minor changes, except for the model files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">$_table_name</code> attribute is no longer declared. It is still used by <code class="literal">Orm\Model</code> though, but it takes a default value that depends on the model name, so you can still define it if you want to use a custom table name.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">$_properties</code> attribute has been added. This attribute contains all the properties (linked to table columns) the model has to manage. Defining this attribute is not compulsory, but not doing so might reduce your website performance, as FuelPHP will need to synchronize the model with the table structure. Note that <code class="literal">Model_Crud</code> also uses this attribute, but the code generated by oil simply doesn't define it.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">$_observers</code> attribute has also been added. This attribute defines used observers and their parameters. We will explain what observers are and how to use them in the next section.</li></ul></div></div><div class="section" title="The FuelPHP ORM"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec25"/>The FuelPHP ORM</h2></div></div></div><p>ORM stands<a id="id144" class="indexterm"/> for Object Relational Mapper. It allows developers to do the following two things:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">It maps table rows to objects. For doing that, the ORM provides several functions to extract specific table rows and transform them to PHP objects. Other methods also exist that allow developers to save objects to table rows. The <code class="literal">find</code> and the <code class="literal">save</code> methods are both examples.</li><li class="listitem" style="list-style-type: disc">It allows you to establish relations between models. In this chapter's project, we have created two models, <span class="strong"><strong>Project</strong></span> <a id="id145" class="indexterm"/>and <span class="strong"><strong>Task</strong></span>, and<a id="id146" class="indexterm"/> there exists a relationship between them: a project can have many tasks, and each task is associated to a project. When defining these relations to the ORM, it will enable methods allowing developers to access a project's tasks more easily for instance.</li></ul></div><p>In short, the purpose of the ORM is to simplify the job of the developer. Beyond the preceding two main points, the ORM will also handle some security issues (as SQL injection) and handle observers that can affect how some properties are saved for instance. In a general manner, FuelPHP's ORM follows the active record pattern closely.</p><div class="section" title="DB and ORM basics"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec18"/>DB and ORM basics</h3></div></div></div><p>Note that <a id="id147" class="indexterm"/>most <a id="id148" class="indexterm"/>methods we are going to use here are working on <code class="literal">Orm/Model,</code> as well as <code class="literal">Model_Crud</code>.</p><p>First, we need to create a PHP file that will test our code. We could have used the oil console here, and in most cases you should, but in this instance we won't because we want to see the executed SQL requests (we plan to use the profiler for doing so). Please note that this file should not be pushed into production. Create a file located at <code class="literal">public/test.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php

// Fuel initialization (inspired from index.php)
define('DOCROOT', __DIR__.DIRECTORY_SEPARATOR);
define('APPPATH', realpath(__DIR__.'/../fuel/app/')
                    .DIRECTORY_SEPARATOR);
define('PKGPATH', realpath(__DIR__.'/../fuel/packages/')
                    .DIRECTORY_SEPARATOR);
define('COREPATH', realpath(__DIR__.'/../fuel/core/')
                    .DIRECTORY_SEPARATOR);
defined('FUEL_START_TIME') or define('FUEL_START_TIME', 
                                     microtime(true));
defined('FUEL_START_MEM') or define('FUEL_START_MEM',
                                    memory_get_usage());
require COREPATH.'classes'.DIRECTORY_SEPARATOR.'autoloader.php';
class_alias('Fuel\\Core\\Autoloader', 'Autoloader');
require APPPATH.'bootstrap.php';

echo 'FuelPHP is initialized...';</pre></div><p>The preceding<a id="id149" class="indexterm"/> code initializes FuelPHP (it is necessary when you have a PHP script<a id="id150" class="indexterm"/> in the public folder and you want to use FuelPHP features). This script should be accessible when requesting the following URL and should display <span class="strong"><strong>FuelPHP is initialized...</strong></span>: <code class="literal">http://mytodolists.app/test.php</code>.</p><p>All the examples that follow must be progressively appended to the file. For those of you who didn't use any ORM yet, it is recommended you append the code inside each section, refresh, and take a deep look at the web page output and the executed queries in the profiler. Please note that this is just an introduction; to learn more about the ORM, you are recommended to read the official documentation<a id="id151" class="indexterm"/> at <a class="ulink" href="http://fuelphp.com/docs/packages/orm/intro.html">http://fuelphp.com/docs/packages/orm/intro.html</a>.</p><div class="section" title="Executing queries without the ORM"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl4sec06"/>Executing queries without the ORM</h4></div></div></div><p>You should first know that it is<a id="id152" class="indexterm"/> possible to execute a query without the ORM. Using it is supposed to simplify your life but it is not compulsory. In some cases, for instance changes affecting many rows, you should not even use the ORM. Another instance is when you want to empty a table:</p><div class="informalexample"><pre class="programlisting">// --- Executing queries without the ORM
\DB::query('TRUNCATE TABLE `projects`;')-&gt;execute();
\DB::query('TRUNCATE TABLE `tasks`;')-&gt;execute();
// \DBUtil::truncate_table('projects'); is also possible</pre></div></div><div class="section" title="Creating new objects"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl4sec07"/>Creating new objects</h4></div></div></div><p>The following example shows how to <a id="id153" class="indexterm"/>create new projects:</p><div class="informalexample"><pre class="programlisting">// --- Creating new objects
$project = Model_Project::forge(); // = new Model_Project()
$project-&gt;name = 'First project';
$project-&gt;save();

// You can also set properties when calling the forge method
$project = Model_Project::forge(
    array('name' =&gt; 'Second project')
);
$project-&gt;save();</pre></div></div><div class="section" title="Finding specific objects"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl4sec08"/>Finding specific objects</h4></div></div></div><p>This is how you find the <a id="id154" class="indexterm"/>first object in a table:</p><div class="informalexample"><pre class="programlisting">// --- Finding specific objects
$project = Model_Project::find('first');
\Debug::dump('first', $project);</pre></div><p>If you refresh your web page now, you should see the following gray box:</p><div class="mediaobject"><img src="graphics/5401OS_02_03.jpg" alt="Finding specific objects"/></div><p>If you unfold <span class="strong"><strong>Model_Project</strong></span> by clicking on <span class="strong"><strong>↵</strong></span>, and then <span class="strong"><strong>_data</strong></span>, you should see that this is indeed the first project:</p><div class="mediaobject"><img src="graphics/5401OS_02_04.jpg" alt="Finding specific objects"/></div><p>If you take a look at the <a id="id155" class="indexterm"/>console, you can also confirm this by seeing the executed SQL request:</p><div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0` ORDER BY `t0`.`id` ASC
LIMIT 1</pre></div><p>You can also load the last object:</p><div class="informalexample"><pre class="programlisting">$project = Model_Project::find('last');
\Debug::dump('last', $project);</pre></div><p>The executed request should be as follows:</p><div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0` ORDER BY `t0`.`id` DESC
LIMIT 1</pre></div><p>Or you can load a project by specifying an ID:</p><div class="informalexample"><pre class="programlisting">$project = Model_Project::find(1);
\Debug::dump('with id = 1', $project);</pre></div><p>You can note here that no request was executed. That is because the ORM caches loaded objects and the project has already been loaded in a previous request. Otherwise, the following request should have been executed:</p><div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0` WHERE `t0`.`id` = 1
LIMIT 1</pre></div></div><div class="section" title="Updating an object"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl4sec09"/>Updating an object</h4></div></div></div><p>Here is how we <a id="id156" class="indexterm"/>update an existing object (here, we change the name of the project with <code class="literal">id = 1</code>):</p><div class="informalexample"><pre class="programlisting">// --- Updating an object
$project = Model_Project::find(1); // Load project with id = 1
$project-&gt;name = 'First one';
$project-&gt;save();</pre></div><p>Executed request:</p><div class="informalexample"><pre class="programlisting">UPDATE `projects` SET `name` = 'First one' WHERE `id` = '1'</pre></div></div><div class="section" title="Deleting an object"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl4sec10"/>Deleting an object</h4></div></div></div><p>We can delete a project <a id="id157" class="indexterm"/>by calling:</p><div class="informalexample"><pre class="programlisting">// --- Deleting an object.
$project = Model_Project::find(1); // Load project with id = 1
$project-&gt;delete();</pre></div><p>Executed request:</p><div class="informalexample"><pre class="programlisting">DELETE FROM `projects` WHERE `id` = '1' LIMIT 1</pre></div></div><div class="section" title="Loading several objects"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl4sec11"/>Loading several objects</h4></div></div></div><p>We can load several <a id="id158" class="indexterm"/>objects at once. The following example shows how we can load all project instances:</p><div class="informalexample"><pre class="programlisting">// --- Loading several objects
// First creating an additional project for a more interesting
// result
$project = Model_Project::forge();
$project-&gt;name = 'Third project';
$project-&gt;save();

// Finding all projects
$projects = Model_Project::find('all');
\Debug::dump('all', $projects);</pre></div><p>In that case, <code class="literal">$projects</code> will be an associative array of projects, the key being the project's ID, and the value being the associated project. The executed request is as follows:</p><div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0`</pre></div></div><div class="section" title="Using method chaining"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl4sec12"/>Using method chaining</h4></div></div></div><p>The <code class="literal">query</code> method is an equivalent <a id="id159" class="indexterm"/>of the <code class="literal">find</code> method, but allows you to fetch objects using method chaining.</p><p>Here is how you can find all the project instances using the <code class="literal">query</code> method:</p><div class="informalexample"><pre class="programlisting">$projects = Model_Project::query()-&gt;get();
\Debug::dump('all (using query)', $projects);</pre></div><p>The executed request is the same as previously executed:</p><div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0`</pre></div></div><div class="section" title="More complex requests"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl4sec13"/>More complex requests</h4></div></div></div><p>It is also possible to execute much more <a id="id160" class="indexterm"/>complex requests. First, let's add various tasks:</p><div class="informalexample"><pre class="programlisting">// Creating sample tasks
Model_Task::forge(array('name' =&gt; 'Marketing plan',
    'status' =&gt; 0, 'rank' =&gt; 0, 'project_id' =&gt; 2))-&gt;save();

Model_Task::forge(array('name' =&gt; 'Update website',
    'status' =&gt; 1, 'rank' =&gt; 1, 'project_id' =&gt; 2))-&gt;save();

Model_Task::forge(array('name' =&gt; 'Improve website template',
    'status' =&gt; 1, 'rank' =&gt; 2, 'project_id' =&gt; 2))-&gt;save();

Model_Task::forge(array('name' =&gt; 'Contact director',
    'status' =&gt; 0, 'rank' =&gt; 0, 'project_id' =&gt; 3))-&gt;save();

Model_Task::forge(array('name' =&gt; 'Buy a new computer',
    'status' =&gt; 1, 'rank' =&gt; 1, 'project_id' =&gt; 3))-&gt;save();</pre></div><p>Now that we have created various tasks, we will be able to test the second parameter of the <code class="literal">find</code> method.</p><p>Let's get the first task with <code class="literal">project_id = 2</code>:</p><div class="informalexample"><pre class="programlisting">$task = Model_Task::find('first',
    array(
        'where' =&gt; array(
            array('project_id' =&gt; 2)
        )
    )
);
\Debug::dump('first with project_id = 2', $task);</pre></div><p>Or using the <code class="literal">query</code> method:</p><div class="informalexample"><pre class="programlisting">$task = Model_Task::query()
    -&gt;where('project_id', 2)
    -&gt;order_by('id', 'asc') // Will be introduced shortly
    -&gt;get_one();
\Debug::dump('first with project_id = 2 (using query)', $task);</pre></div><p>Executed request:</p><div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE (`t0`.`project_id` = 2)
ORDER BY `t0`.`id` ASC LIMIT 1</pre></div><p>Let's now get all tasks with <code class="literal">project_id = 2</code>:</p><div class="informalexample"><pre class="programlisting">$tasks = Model_Task::find('all',
    array(
        'where' =&gt; array(
            array('project_id' =&gt; 2)
        )
    )
);
\Debug::dump('project_id = 2', $tasks);</pre></div><p>Or using<a id="id161" class="indexterm"/> the <code class="literal">query</code> method:</p><div class="informalexample"><pre class="programlisting">$tasks = Model_Task::query()
    -&gt;where('project_id', 2)
    -&gt;get();
\Debug::dump('project_id = 2 (using query)', $tasks);</pre></div><p>Executed request:</p><div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE (`t0`.`project_id` = 2)</pre></div><p>It is also possible to get all tasks with <code class="literal">project_id = 2</code> and <code class="literal">status = 1</code>:</p><div class="informalexample"><pre class="programlisting">$tasks = Model_Task::find('all',
    array(
        'where' =&gt; array(
            array('project_id' =&gt; 2),
            array('status' =&gt; 1)
        )
    )
);
\Debug::dump('project_id = 2 &amp; status = 1', $tasks);</pre></div><p>Or using the <code class="literal">query</code> method:</p><div class="informalexample"><pre class="programlisting">$tasks = Model_Task::query()
    -&gt;where('project_id', 2)
    -&gt;where('status', 1)
    -&gt;get();
\Debug::dump('project_id = 2 &amp; status = 1 (using query)', $tasks);</pre></div><p>Executed <a id="id162" class="indexterm"/>request:</p><div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE (`t0`.`project_id` = 2)
AND (`t0`.`status` = 1)</pre></div><p>This is how we get all tasks with <code class="literal">project_id &gt; 2</code> and <code class="literal">status = 1</code>:</p><div class="informalexample"><pre class="programlisting">$tasks = Model_Task::find('all',
    array(
        'where' =&gt; array(
            array('project_id', '&gt;', 2),
            array('status' =&gt; 1)
        )
    )
);
\Debug::dump('project_id &gt; 2 &amp; status = 1', $tasks);</pre></div><p>Or using the <code class="literal">query</code> method:</p><div class="informalexample"><pre class="programlisting">$tasks = Model_Task::query()
    -&gt;where('project_id', '&gt;', 2)
    -&gt;where('status', 1)
    -&gt;get();
\Debug::dump('project_id &gt; 2 &amp; status = 1 (using query)', $tasks);</pre></div><p>Executed request:</p><div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE `t0`.`project_id` &gt; 2
AND (`t0`.`status` = 1)</pre></div><p>This is how we get tasks with <code class="literal">project_id &gt; 2</code> or <code class="literal">status = 1</code>:</p><div class="informalexample"><pre class="programlisting">$tasks = Model_Task::find('all',
    array(
        'where' =&gt; array(
            array('project_id' =&gt; 2),
            'or' =&gt; array('status' =&gt; 1)
        )
    )
);
\Debug::dump('project_id = 2 or status = 1', $tasks);</pre></div><p>Or using the <code class="literal">query</code> method:</p><div class="informalexample"><pre class="programlisting">$tasks = Model_Task::query()
    -&gt;where('project_id', '=', 2)
    -&gt;or_where('status', 1)
    -&gt;get();
\Debug::dump('project_id = 2 or status = 1 (query)', $tasks);</pre></div><p>Executed request:</p><div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE (`t0`.`project_id` = 2) OR ((`t0`.`status` = 1))</pre></div><p>This is how <a id="id163" class="indexterm"/>we get tasks that name contains the word <code class="literal">website</code>:</p><div class="informalexample"><pre class="programlisting">$tasks = Model_Task::find('all',
    array(
        'where' =&gt; array(
            array(
                'name',
                'LIKE',
                '%website%'
            ),
        )
    )
);
\Debug::dump('name contains "website"', $tasks);</pre></div><p>Or using the <code class="literal">query</code> method:</p><div class="informalexample"><pre class="programlisting">$tasks = Model_Task::query()
    -&gt;where('name', 'LIKE', '%website%')
    -&gt;get();
\Debug::dump('name contains "website" (using query)', $tasks);</pre></div><p>Executed request:</p><div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE `t0`.`name` LIKE
'%website%'</pre></div><p>You can also specify an order:</p><div class="informalexample"><pre class="programlisting">$tasks = Model_Task::find('all',
    array(
        'where' =&gt; array(
            array(
                'name',
                'LIKE',
                '%website%'
            ),
        ),
        'order_by' =&gt; array(
            'rank' =&gt; 'ASC'
        ),
    )
);
\Debug::dump(
    'name contains "website" ordered by the rank column',
    $tasks
);</pre></div><p>Or using <a id="id164" class="indexterm"/>the <code class="literal">query</code> method:</p><div class="informalexample"><pre class="programlisting">$tasks = Model_Task::query()
    -&gt;where('name', 'LIKE', '%website%')
    -&gt;order_by('rank', 'ASC')
    -&gt;get();
\Debug::dump(
    'name contains "website" ordered by the rank column (query)',
    $tasks
);</pre></div><p>Executed request:</p><div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE `t0`.`name` LIKE
'%website%' ORDER BY `t0`.`rank` ASC</pre></div><p>You have probably noticed that using the <code class="literal">query</code> method generally allows you to write a much more concise and readable code. Therefore, you are recommended to use the <code class="literal">query</code> method for complex requests. In most cases though, using <code class="literal">find</code> or <code class="literal">query</code> doesn't make much difference, so use your best judgment.</p><p>As already stated, this is just a very small introduction to the ORM. There are many more keys other than <code class="literal">where</code> and <code class="literal">order_by</code>, and we will see some of those later (as the <code class="literal">related</code> key for instance). You are recommended to take a look at the official documentation<a id="id165" class="indexterm"/> of the ORM package at <a class="ulink" href="http://fuelphp.com/docs/packages/orm/intro.html">http://fuelphp.com/docs/packages/orm/intro.html</a>.</p><p>We also used the <code class="literal">Debug</code> and <code class="literal">DB</code> classes. Knowing them can be useful. Again, feel free to read their official <a id="id166" class="indexterm"/>documentation, which is available at the following links:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://fuelphp.com/docs/classes/debug.html">http://fuelphp.com/docs/classes/debug.html</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://fuelphp.com/docs/classes/database/db.html">http://fuelphp.com/docs/classes/database/db.html</a></li></ul></div></div></div><div class="section" title="ORM relations"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec19"/>ORM relations</h3></div></div></div><p>It is time for us to define the <a id="id167" class="indexterm"/>relationship between tasks and projects. As we explained earlier, defining them activates useful features that make the job of the developers easy and improve performance. Relations must be defined inside a model. For instance, we will define a relation in the <span class="strong"><strong>Project</strong></span> model<a id="id168" class="indexterm"/> in order to access each project's tasks, and we will also define another relation in the <span class="strong"><strong>Task</strong></span> model<a id="id169" class="indexterm"/> in order to access each task's associated project. There are 4 relation types:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Belongs To</strong></span>: When you define a <span class="emphasis"><em>belongs to</em></span> relationship in model A toward model B, each model A's instance can only be associated with one model B's instance. You will generally need to create a column in model A's table that will be used to connect instances. In this chapter, the <span class="strong"><strong>Task</strong></span> model has a <span class="emphasis"><em>belongs to</em></span> relationship with the <span class="strong"><strong>Project</strong></span> model. Indeed, each task is associated with only one project, and the <code class="literal">project_id</code> column in the tasks' table is used to connect each instance. A concrete example is that a task with <code class="literal">project_id = 1</code> will belong to the project with <code class="literal">id = 1</code>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Has many</strong></span>: When you define a <span class="emphasis"><em>has many</em></span> relationship in model A toward model B, each model A's instance can be associated with many model B's instances. You will generally need to create a column in model B's table that will be used to connect instances. In this chapter, the <span class="strong"><strong>Project</strong></span> model has a <span class="emphasis"><em>has many</em></span> relationship with the <span class="strong"><strong>Task</strong></span> model; indeed, each project can have many tasks, and the <code class="literal">project_id</code> column in the tasks' table is used to connect each instance. A concrete example is that a project with <code class="literal">id = 1</code> can have many tasks with <code class="literal">project_id = 1</code>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Has one</strong></span>: A way to understand this relation is to think of it as a special case of a has many relationship, except that each model A's instance can be associated with only one model B's instance. If we defined a <span class="emphasis"><em>has one</em></span> relationship (instead of has many) in the <span class="strong"><strong>Project</strong></span> model toward the <span class="strong"><strong>Task</strong></span> model, we would still need to define the <code class="literal">project_id</code> column inside the tasks' table, but in that case only a single task could be associated to each project.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Many to Many</strong></span>: When you define a <span class="emphasis"><em>many to many</em></span> relationship in model A toward model B, each model A's instance can be associated with many model B's instances and each model B's instance can be associated with many model A's instances. In that case, you will need to create an intermediary table.</li></ul></div><p>You are recommended to read the official documentation<a id="id170" class="indexterm"/> about relations at <a class="ulink" href="http://fuelphp.com/docs/packages/orm/relations/intro.html">http://fuelphp.com/docs/packages/orm/relations/intro.html</a>.</p><div class="section" title="Defining relations inside the models"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl4sec14"/>Defining relations inside the models</h4></div></div></div><p>Now that we have<a id="id171" class="indexterm"/> introduced the different types of relations, let's<a id="id172" class="indexterm"/> define them in our model.</p><p>First, open <code class="literal">APPPATH/classes/model/task.php</code> and add the following attribute in the <code class="literal">Model_Task</code> class:</p><div class="informalexample"><pre class="programlisting">protected static $_belongs_to = array('project');</pre></div><p>Note that this is equivalent to the following code:</p><div class="informalexample"><pre class="programlisting">protected static $_belongs_to = array(
    'project' =&gt; array(
        'model_to'          =&gt; 'Model_Project',
        'key_from'          =&gt; 'project_id',
        'key_to'            =&gt; 'id',
        'cascade_save'      =&gt; true,
        'cascade_delete'    =&gt; false,
    )
);</pre></div><p>In the first case, the <code class="literal">model_to</code>, <code class="literal">key_from</code>, and <code class="literal">key_to</code> keys are inferred from the array value (<code class="literal">'project'</code>). If not defined, <code class="literal">cascade_save</code> default value is <code class="literal">true</code> and <code class="literal">cascade_delete</code> default value is <code class="literal">false</code>. These keys define the following relation characteristics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">model_to</code> key: The <a id="id173" class="indexterm"/>model across the relation (model B)</li><li class="listitem" style="list-style-type: disc">The <code class="literal">key_from</code> key: The<a id="id174" class="indexterm"/> model's (model A's) column used to connect instances</li><li class="listitem" style="list-style-type: disc">The <code class="literal">key_to</code> key: The <a id="id175" class="indexterm"/>model across the relation's (model B's) column used to connect instances</li><li class="listitem" style="list-style-type: disc">The <code class="literal">cascade_save</code> key: If true, each<a id="id176" class="indexterm"/> time a model's instance is saved, the related instances will also be saved</li><li class="listitem" style="list-style-type: disc">The <code class="literal">cascade_delete</code> key: If true, each time a model's instance is deleted, the related instances <a id="id177" class="indexterm"/>will also be deleted. Beware of this feature, as you could end up deleting more information than you really want.</li></ul></div><p>Now, open <code class="literal">APPPATH/classes/model/project.php</code> and add the <a id="id178" class="indexterm"/>following <a id="id179" class="indexterm"/>attribute in the <code class="literal">Model_Project</code> class:</p><div class="informalexample"><pre class="programlisting">protected static $_has_many = array('tasks');</pre></div><p>As with the <code class="literal">belongs_to</code> relation, it is equivalent to the following code:</p><div class="informalexample"><pre class="programlisting">protected static $_has_many = array(
    'tasks' =&gt; array(
        'model_to'          =&gt; 'Model_Task',
        'key_from'          =&gt; 'id',
        'key_to'            =&gt; 'project_id',
        'cascade_save'      =&gt; true,
        'cascade_delete'    =&gt; false,
    )
);</pre></div></div><div class="section" title="Testing the relations"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl4sec15"/>Testing the relations</h4></div></div></div><p>To better illustrate <a id="id180" class="indexterm"/>this, let's test how these relations work by appending code in our <code class="literal">public/test.php</code> file.</p><div class="section" title="Getting objects' relations"><div class="titlepage"><div><div><h5 class="title"><a id="ch02lvl5sec01"/>Getting objects' relations</h5></div></div></div><p>First let's load a task's <a id="id181" class="indexterm"/>instance with <code class="literal">id = 1</code>, and then its related project. You can notice that we set the <code class="literal">from_cache</code> parameter to <code class="literal">false</code>. This has been done to prevent FuelPHP to load the instance from the cache because we want to display all executed requests. In most cases, you are not recommended to use this parameter.</p><div class="informalexample"><pre class="programlisting">$task = Model_Task::find(1, array('from_cache' =&gt; false));
$project = $task-&gt;project;
\Debug::dump('Project of task with id = 1', $project);</pre></div><p>In the second line, we loaded the task's project by accessing the <code class="literal">project</code> attribute. This is the relation name we declared in the <code class="literal">Model_Task</code> class. In a general manner, if you want to access a related instance through the relation <code class="literal">RELATION_NAME</code>, you can get it using <code class="literal">$item-&gt;RELATION_NAME</code>.</p><p>You can see that the following two requests were executed:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first request was executed in the <code class="literal">find</code> method in order to load the task with <code class="literal">id = 1</code>.<div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE `t0`.`id` = 1
   LIMIT 1</pre></div></li><li class="listitem">The second request was executed when getting <code class="literal">$task-&gt;project</code>: in this case the project with <code class="literal">id = $task-&gt;project_id</code> was retrieved:<div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0` WHERE `t0`.`id` =
   '2' LIMIT 1</pre></div></li></ol></div><p>Let's load a project's <a id="id182" class="indexterm"/>instance with <code class="literal">id = 2</code>, and then its related tasks:</p><div class="informalexample"><pre class="programlisting">$project = Model_Project::find(
    2,
    array('from_cache' =&gt; false)
);
$tasks = $project-&gt;tasks;
\Debug::dump('Tasks of project with id = 2', $tasks);</pre></div><p>Two requests have been executed:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first request loads the project's instance:<div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0` WHERE `t0`.`id` = 2
   LIMIT 1</pre></div></li><li class="listitem">The second request loads the project's associated tasks:<div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE
   `t0`.`project_id` = '2'</pre></div></li></ol></div><p>When relations are defined, the <code class="literal">find</code> method allows you to improve performance by reducing the number of SQL requests. For instance, if you do the following:</p><div class="informalexample"><pre class="programlisting">$projects = Model_Project::find(
    'all',
    array('from_cache' =&gt; false)
);
foreach ($projects as $project) {
    \Debug::dump(
        'LOOP 1: Tasks of project with id = '.$project-&gt;id,
        $project-&gt;tasks
    );
}</pre></div><p>Three requests will be executed, which are given as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">One for loading all the projects<div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0`</pre></div></li><li class="listitem" style="list-style-type: disc">Two for loading <code class="literal">$project-&gt;tasks</code> for each project in <code class="literal">$projects</code><div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE
   `t0`.`project_id` = '2'</pre></div><div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE
   `t0`.`project_id` = '3'</pre></div></li></ul></div><p>Three requests <a id="id183" class="indexterm"/>don't seem a lot, but if you load 100 projects this means that you will execute 101 requests and this can lead to serious performance issues.</p><p>The <code class="literal">find</code> method allows you to address this issue through the <code class="literal">related</code> key:</p><div class="informalexample"><pre class="programlisting">$projects = Model_Project::find(
    'all',
    array(
        'related' =&gt; 'tasks'
    )
);
foreach ($projects as $project) {
    \Debug::dump(
        'LOOP 2: Tasks of project with id = '.$project-&gt;id,
        $project-&gt;tasks
    );
}</pre></div><p>Here, only one request has been executed. The FuelPHP's ORM has loaded the relation when executing the find method by joining the tasks' table in the request.</p><p>Executed request:</p><div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0` LEFT JOIN
`tasks` AS `t1` ON (`t0`.`id` = `t1`.`project_id`)</pre></div></div><div class="section" title="Updating objects' relations"><div class="titlepage"><div><div><h5 class="title"><a id="ch02lvl5sec02"/>Updating objects' relations</h5></div></div></div><p>If you want to<a id="id184" class="indexterm"/> update a relation, you can simply update the column supporting it. For instance, the following code loads the task with <code class="literal">id = 1</code> and makes it belong to the project with <code class="literal">id = 3</code>:</p><div class="informalexample"><pre class="programlisting">$task = Model_Task::find(1, array('from_cache' =&gt; false));
$task-&gt;project_id = 3;
$task-&gt;save();</pre></div><p>Two requests will be executed, which are given as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first request loads the task:<div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE `t0`.`id` = 1 LIMIT 1</pre></div></li><li class="listitem">The second updates the <code class="literal">project_id</code> column of the task:<div class="informalexample"><pre class="programlisting">UPDATE `tasks` SET `project_id` = '3',
   `updated_at` = 1404729671 WHERE `id` = '1'</pre></div></li></ol></div><p>Though it executes more SQL requests, we could also have written the following:</p><div class="informalexample"><pre class="programlisting">$task = Model_Task::find(1, array('from_cache' =&gt; false));
$task-&gt;project = Model_Project::find(
    3,
    array('from_cache' =&gt; false)
);
$task-&gt;save();</pre></div><p>Four requests will be executed, which are given as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first request loads the task (executed by <code class="literal">Model_Task::find(...)</code>):<div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE `t0`.`id` = 1 LIMIT 1</pre></div></li><li class="listitem">The second request loads the project we want to associate to the task (executed by <code class="literal">Model_Project::find(...)</code>):<div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0` WHERE 
   `t0`.`id` = 3 LIMIT 1</pre></div></li><li class="listitem">The third request loads the existing project associated to the task (executed by <code class="literal">$task-&gt;project</code>):<div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0` WHERE 
   `t0`.`id` = '2' LIMIT 1</pre></div></li><li class="listitem">The fourth request updates the <code class="literal">project_id</code> column of the task (executed by <code class="literal">$task-&gt;save()</code>):<div class="informalexample"><pre class="programlisting">UPDATE `tasks` SET `project_id` = '3',
   `updated_at` = 1404729671 WHERE `id` = '1'</pre></div></li></ol></div><p>It is also possible to affect a new project to a task:</p><div class="informalexample"><pre class="programlisting">$task = Model_Task::find(1, array('from_cache' =&gt; false));
$task-&gt;project = Model_Project::forge();
$task-&gt;project-&gt;name = 'Fourth project';
$task-&gt;save();</pre></div><p>In that case, the ORM will create a new project and then assign the correct ID to the <code class="literal">project_id</code> attribute.</p><p>Four requests <a id="id185" class="indexterm"/>will be executed, which are given as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first request loads the task (executed by <code class="literal">Model_Task::find(...)</code>):<div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE `t0`.`id` = 1 LIMIT 1</pre></div></li><li class="listitem">The second request loads the existing project associated to the task (executed by <code class="literal">$task-&gt;project</code>):<div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0` WHERE 
   `t0`.`id` = '3' LIMIT 1</pre></div></li><li class="listitem">The third request creates the new project (executed by <code class="literal">$task-&gt;save()</code>):<div class="informalexample"><pre class="programlisting">INSERT INTO `projects` (`name`, `created_at`,
   `updated_at`) VALUES ('Fourth project', 1404729796,
   1404729796)</pre></div></li><li class="listitem">The fourth request updates the <code class="literal">project_id</code> column of the task (executed by <code class="literal">$task-&gt;save()</code>):<div class="informalexample"><pre class="programlisting">UPDATE `tasks` SET `project_id` = '4', `updated_at`
   = 1404729796 WHERE `id` = '1'</pre></div></li></ol></div><p>Similarly, it is possible to affect a new task to a project:</p><div class="informalexample"><pre class="programlisting">$project = Model_Project::find(
    2,
    array('from_cache' =&gt; false)
);
$task               = Model_Task::forge();
$task-&gt;name         = 'Buy a new mouse';
$task-&gt;status       = 0;
$task-&gt;rank         = 2;
$project-&gt;tasks[]   = $task;
$project-&gt;save();</pre></div><p>Three requests will be executed, which are given as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first request loads the project (executed by <code class="literal">Model_Project::find(...)</code>):<div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0` WHERE `t0`.`id` = 2
   LIMIT 1</pre></div></li><li class="listitem">The second request loads the existing tasks associated to the project (executed by <code class="literal">$project-&gt;tasks</code>):<div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE
   `t0`.`project_id` = '2'</pre></div></li><li class="listitem">The third<a id="id186" class="indexterm"/> request creates the new task (executed by <code class="literal">$project-&gt;save()</code>):<div class="informalexample"><pre class="programlisting">INSERT INTO `tasks` (`name`, `status`, `rank`,
   `project_id`, `created_at`, `updated_at`) VALUES
   ('Buy a new mouse', 0, 2, '2', 1404731559, null)</pre></div></li></ol></div><p>If you take a precise look at <code class="literal">$project-&gt;tasks</code>, you will notice that it is an associated array, the keys being the instances ID and the values being the instances. Thus, this is how you can update a specific task through relations:</p><div class="informalexample"><pre class="programlisting">$project = Model_Project::find(
    2,
    array('from_cache' =&gt; false)
);
$project-&gt;tasks[6]-&gt;name = 'Buy an optical mouse';
$project-&gt;save();</pre></div><p>It will change the name of the task with <code class="literal">id = 6</code> to <code class="literal">'Buy an optical mouse'</code> (if this task exists and its <code class="literal">project_id</code> is equal to 2).</p><p>Three requests will be executed, which are given as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first request loads the project (executed by <code class="literal">Model_Project::find(...)</code>):<div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0` WHERE `t0`.`id` = 2
   LIMIT 1</pre></div></li><li class="listitem">The second request loads the existing tasks associated to the project (executed by <code class="literal">$project-&gt;tasks</code>):<div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE
   `t0`.`project_id` = '2'</pre></div></li><li class="listitem">The third request updates the task's <code class="literal">name</code> column (executed by <code class="literal">$project-&gt;save()</code>):<div class="informalexample"><pre class="programlisting">UPDATE `tasks` SET `name` = 'Buy an optical mouse',
   `updated_at` = 1404732349 WHERE `id` = '6'</pre></div></li></ol></div><p>It is also possible to disconnect two related items. This example is not adapted or useful for our project, but it is important to know that you can do this. Let's try to disconnect the task with <code class="literal">id = 4</code> from the project with <code class="literal">id = 3</code>:</p><div class="informalexample"><pre class="programlisting">$project = Model_Project::find(
    3,
    array('from_cache' =&gt; false)
);
unset($project-&gt;tasks[4]);
$project-&gt;save();</pre></div><p>Executed requests:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first request loads the project (executed by <code class="literal">Model_Project::find(...)</code>):<div class="informalexample"><pre class="programlisting">SELECT … FROM `projects` AS `t0` WHERE `t0`.`id` = 3 LIMIT 1</pre></div></li><li class="listitem">The second<a id="id187" class="indexterm"/> request loads the existing tasks associated to the project (executed by <code class="literal">$project-&gt;tasks</code>):<div class="informalexample"><pre class="programlisting">SELECT … FROM `tasks` AS `t0` WHERE
   `t0`.`project_id` = '3'</pre></div></li><li class="listitem">The third request attempts to disconnect the task with <code class="literal">id = 4</code> from the project (executed by <code class="literal">$project-&gt;save()</code>):<div class="informalexample"><pre class="programlisting">UPDATE `tasks` SET `project_id` = null,
   `updated_at` = 1404803182 WHERE `id` = '4'</pre></div></li></ol></div><p>If you take a look at the executed requests, this code is not adapted to our project because:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For it to correctly work, we should allow the <code class="literal">project_id</code> column to be null, and that isn't the case right now</li><li class="listitem" style="list-style-type: disc">In our application, a task belonging to no project would make no sense</li></ul></div><p>In other cases, doing that can be legitimate though. Again, this is only a short introduction to the ORM's relations, and you<a id="id188" class="indexterm"/> are recommended to read the official documentation at <a class="ulink" href="http://fuelphp.com/docs/packages/orm/relations/intro.html">http://fuelphp.com/docs/packages/orm/relations/intro.html</a>.</p></div></div></div><div class="section" title="Observers and events"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec20"/>Observers and events</h3></div></div></div><p>You have probably noticed in the<a id="id189" class="indexterm"/> previous section that, when saving an object, some additional values<a id="id190" class="indexterm"/> were saved in the <code class="literal">created_at</code> and <code class="literal">updated_at</code> columns without us specifying anything. For instance:</p><div class="informalexample"><pre class="programlisting">INSERT INTO `projects` (`name`, `created_at`, `updated_at`) VALUES ('Third project', 1404729796, 1404729796);</pre></div><p>This happens because of the observers defined in the models. Observers override some model behaviors; for example, they can change properties' values before committing the changes to the database, or prevent the object from being saved if some conditions are met. Let's take a look at the observers defined in <code class="literal">Model_Project</code>:</p><div class="informalexample"><pre class="programlisting">protected static $_observers = array(
    'Orm\Observer_CreatedAt' =&gt; array(
        'events' =&gt; array('before_insert'),
        'mysql_timestamp' =&gt; false,
    ),
    'Orm\Observer_UpdatedAt' =&gt; array(
        'events' =&gt; array('before_save'),
        'mysql_timestamp' =&gt; false,
    ),
);</pre></div><p>You can notice that two observers are defined: <code class="literal">Orm\Observer_CreatedAt</code> and <code class="literal">Orm\Observer_UpdatedAt</code>. They handle the <code class="literal">created_at</code> and <code class="literal">updated_at</code> columns, respectively, setting their value to the current timestamp when the object is created or updated. Observers can have custom parameters such as <code class="literal">mysql_timestamp</code>, which defines if a MySQL timestamp is saved instead of a UNIX one.</p><p>The <code class="literal">events</code> parameter is common to all observers and defines which events they should be connected to. Events are methods called in behaviors when something happens to an object; for instance, when you save an object, the ORM will try to call its behaviors' <code class="literal">before_save</code> method before changes are committed to the database. There are several events, such as <code class="literal">after_create</code> or <code class="literal">after_save</code>. You can read the full descriptive list in the official documentation<a id="id191" class="indexterm"/> at <a class="ulink" href="http://fuelphp.com/docs/packages/orm/observers/creating.html#/event_names">http://fuelphp.com/docs/packages/orm/observers/creating.html#/event_names</a>
</p><p>In order to learn more, you are also recommended to read the introduction to observers<a id="id192" class="indexterm"/> in the official documentation at <a class="ulink" href="http://fuelphp.com/docs/packages/orm/observers/intro.html">http://fuelphp.com/docs/packages/orm/observers/intro.html</a>
</p></div></div></div>
<div class="section" title="Implementation of the to-do list"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec22"/>Implementation of the to-do list</h1></div></div></div><p>Now that we explained the <a id="id193" class="indexterm"/>essential ORM features and implemented our relations, it is finally time to build our to-do list. This section assumes you have executed the complete <code class="literal">public/test.php</code> script at least once.</p><div class="section" title="Allowing the user to see and change tasks' status"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec26"/>Allowing the user to see and change tasks' status</h2></div></div></div><p>First, we will display the<a id="id194" class="indexterm"/> associated tasks when viewing a project's details. For<a id="id195" class="indexterm"/> instance, this web page should display all tasks of project with <code class="literal">id = 2</code> after the project's name:</p><p>
<code class="literal">http://mytodolists.app/project/view/2</code>
</p><p>In order to do that, we can, as we did in <a class="link" href="ch01.html" title="Chapter 1. Building Your First FuelPHP Application">Chapter 1</a>, <span class="emphasis"><em>Building Your First FuelPHP Application</em></span>, dissect the URL and deduce that, in this case, the view action of the <span class="strong"><strong>Project</strong></span> controller is executed. The action displays <code class="literal">project/view</code>; thus, we have to edit <code class="literal">APPPATH/views/project/view.php</code>. Add the following code under the first paragraph displaying the project's name:</p><div class="informalexample"><pre class="programlisting">&lt;?php echo render('task/list', array('project' =&gt; $project)); ?&gt;</pre></div><p>The <code class="literal">render(...)</code> method is an alias for <code class="literal">View::forge(...)-&gt;render()</code>, and thus the preceding code displays the <code class="literal">task/list</code> view. Create the <code class="literal">APPPATH/views/task/list.php</code> view file (you have to create the <code class="literal">task</code> folder) and set its content to:</p><div class="informalexample"><pre class="programlisting">&lt;ul id="todo_list" data-project_id="&lt;?php echo $project-&gt;id; ?&gt;"&gt;
    &lt;?php foreach ($project-&gt;tasks as $task) {
            $input_id = 'todo_item_'.$task-&gt;id;
    ?&gt;
        &lt;li&gt;
            &lt;input
                type="checkbox"
                autocomplete="off"
                id="&lt;?php echo $input_id; ?&gt;"
                data-task_id="&lt;?php echo $task-&gt;id; ?&gt;"
                &lt;?php echo $task-&gt;status ? 'checked' : ''; ?&gt;
            &gt;
            &lt;label for="&lt;?php echo $input_id; ?&gt;"&gt;
                &lt;?php echo $task-&gt;name; ?&gt;
            &lt;/label&gt;
        &lt;/li&gt;
    &lt;?php } ?&gt;
&lt;/ul&gt;</pre></div><p>This code should be pretty straightforward; it displays an HTML list of the project's tasks. Each item displays the name in a label linked to a checkbox displaying its status. We can make the two following observations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We defined the <code class="literal">data-project_id</code> attribute <a id="id196" class="indexterm"/>inside the <code class="literal">ul</code> element. It will be later used by our JavaScript code to easily retrieve the project's ID. The same goes for the <code class="literal">data-task_id</code> attribute for each checkbox.</li><li class="listitem" style="list-style-type: disc">You can notice we printed <code class="literal">$task-&gt;name</code> without escaping the string. You could think that this is a security breach because <code class="literal">$task-&gt;name</code> could contain HTML tags such as the <code class="literal">&lt;script&gt;</code> tag and therefore would be prone to XSS injections. However, it isn't because when you use the <code class="literal">View::forge</code> method, all parameters (even model properties) are, by default, processed (escaped) to prevent such security flaws. You can disable this behavior though (we will see in <a class="link" href="ch03.html" title="Chapter 3. Building a Blog Application">Chapter 3</a>, <span class="emphasis"><em>Building a Blog Application</em></span>, that sometimes we have to), and in that case FuelPHP provides the <code class="literal">e</code> method to manually escape variables.</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>It is recommended to separate your views into small view files, each displaying a specific area of your web page. We just did it by creating an additional view for displaying the task lists. We could have gone even further by creating a view file that displays a single task and then rendering it for each item in the tasks' list.</p></div></div><p>We can now see our to-do items. But if we click on our checkboxes, it doesn't synchronize with our server, and if we refresh our web page, we can see that items are back to their old status. We will use a bit of JavaScript and jQuery in order to synchronize the checkboxes with the website.</p><p>Create a JavaScript file at <code class="literal">public/assets/js/website.js</code>.</p><p>We first have to include it in the template. Open <code class="literal">APPPATH/views/template.php</code> and add before the end of the <code class="literal">head</code> tag the following:</p><div class="informalexample"><pre class="programlisting">&lt;?php
echo Asset::js(array(
    'http://code.jquery.com/jquery-1.11.2.min.js',
    'http://code.jquery.com/ui/1.11.2/jquery-ui.min.js',
    'website.js'
)); 
?&gt;</pre></div><p>The preceding code includes three JavaScript files into the template:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The first two lines<a id="id197" class="indexterm"/> are the jQuery and jQuery UI scripts that <a id="id198" class="indexterm"/>we will need.</li><li class="listitem" style="list-style-type: disc">The third one is the script containing our JavaScript code. Note that you didn't have to write the complete path. The <code class="literal">Asset::js</code> method automatically searches for the file in the <code class="literal">public/assets/js</code> folder. You should know it is possible to specify additional directories to search JavaScript and CSS files using the <code class="literal">Asset::add_path</code> method if necessary. You are recommended to read the official documentation<a id="id199" class="indexterm"/> at <a class="ulink" href="http://fuelphp.com/docs/classes/asset/usage.html">http://fuelphp.com/docs/classes/asset/usage.html</a>.</li></ul></div><p>As we will need to know our base URL in our JavaScript code in order to send AJAX requests, add the following just before the code we previously added:</p><div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript"&gt;
&lt;?php
echo 'var uriBase = '.Format::forge(Uri::base())-&gt;to_json().';';
?&gt;
&lt;/script&gt;</pre></div><p>This code creates a JavaScript variable named <code class="literal">uriBase</code> containing the base URL obtained from <code class="literal">Uri::base()</code> and encoded to a JavaScript string by <code class="literal">Format::forge(...)-&gt;to_json()</code>. You are recommended to read the official documentation about these classes at<a id="id200" class="indexterm"/> the following<a id="id201" class="indexterm"/> URLs:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://fuelphp.com/docs/classes/uri.html">http://fuelphp.com/docs/classes/uri.html</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://fuelphp.com/docs/classes/format.html">http://fuelphp.com/docs/classes/format.html</a></li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>This <code class="literal">uriBase</code> variable was implemented for those of you that created your project inside your webserver root directory without using virtual hosts: in that case, sending AJAX requests using only relative URLs will cause issues. An alternative is to use the base HTML tag, as we will see in <a class="link" href="ch05.html" title="Chapter 5. Building Your Own Restful API">Chapter 5</a>, <span class="emphasis"><em>Building Your Own RESTful API</em></span>.</p></div></div><p>Now that our JavaScript file and its dependencies are included in the template, we have to implement the checkbox synchronization. Open the JavaScript file we created earlier at <code class="literal">public/assets/js/website.js</code> and set its content to:</p><div class="informalexample"><pre class="programlisting">$(document).ready(function() {
    
    // Checkbox synchronization
    $('#todo_list input[type=checkbox]').change(function() {
        var $this = $(this);
        $.post(
            uriBase + 'project/change_task_status',
            {
                'task_id': $this.data('task_id'),
                'new_status': $this.is(':checked') ? 1 : 0
            }
        );
    });
});</pre></div><p>For those unfamiliar <a id="id202" class="indexterm"/>with jQuery, the code does the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">When the<a id="id203" class="indexterm"/> document DOM is ready, the script will look for checkboxes inside our to-do list and track their changes.</li><li class="listitem" style="list-style-type: disc">When a checkbox is changed, it sends a <code class="literal">POST</code> request to the <code class="literal">project/change_task_status</code> action with the task's ID and its new status.</li><li class="listitem" style="list-style-type: disc">It does not handle errors; if there is a connection problem, the user will think the web page is synchronized with the server though it isn't. It could be an axis of improvement.</li></ul></div><p>Now, we have to handle this request on the server side, so we need to create the <code class="literal">change_task_status</code> action inside the <span class="strong"><strong>Project</strong></span> controller.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note11"/>Note</h3><p>Note that, for the sake of simplicity, we decided to create the action in the <span class="strong"><strong>Project</strong></span> controller, though it handles tasks and should therefore be created inside a <span class="strong"><strong>Task</strong></span> controller. For your real projects, it is highly recommended not to do this. It is easy to fall into the trap of having a single controller handling your whole website, and though for small projects it might be 'OK', you will have serious maintainability issues as your features add up.</p></div></div><p>Open the <span class="strong"><strong>Project</strong></span> controller and add the following action:</p><div class="informalexample"><pre class="programlisting">public function action_change_task_status()
{
    if (Input::is_ajax()) {
        $task = Model_Task::find(intval(Input::post('task_id')));
        $task-&gt;status = intval(Input::post('new_status'));
        $task-&gt;save();
    }
    return false; // we return no content at all
}</pre></div><p>You can notice <a id="id204" class="indexterm"/>we used <code class="literal">Input::post</code> instead of the <code class="literal">$_POST</code> global<a id="id205" class="indexterm"/> variable; it gets the same value, except you can define a default value in the second parameter of <code class="literal">Input::post</code> in case the key is not defined. The same applies for <code class="literal">Input::get</code> and <code class="literal">$_GET</code>.</p><p>We also checked using <code class="literal">Input::is_ajax</code> if it is an Ajax request. Note though there is no safe ways to detect if the request was made via Ajax (never trust data coming from the client).</p><p>The synchronization should now work; any status change should be saved and preserved if you refresh the web page.</p></div><div class="section" title="Allowing the user to add tasks"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec27"/>Allowing the user to add tasks</h2></div></div></div><p>Now that we can see and <a id="id206" class="indexterm"/>change the status of projects' tasks, it could be useful to add new ones. We will add a form for doing that under the to-do list.</p><p>First open <code class="literal">APPPATH/views/task/list.php</code> and add, at the end, the following:</p><div class="informalexample"><pre class="programlisting">&lt;?php echo render('task/create', array('project' =&gt; $project)); ?&gt;</pre></div><p>Then create a view file located at <code class="literal">APPPATH/views/task/create.php</code> and set its content to:</p><div class="informalexample"><pre class="programlisting">&lt;h3&gt;Create a new task:&lt;/h3&gt;
&lt;?php
echo Form::open();
echo Form::input(
    'task_name',
    null,
    array('placeholder'=&gt;'Task name')
);
echo Form::submit('task_submit', 'Create');
echo Form::close();
?&gt;</pre></div><p>Nothing spectacular here, we just display a form with a text input (for the task title) and a <span class="strong"><strong>Create</strong></span> button. We use the <code class="literal">Form</code> class for doing that, but we could have written that in HTML code as well. For more detail about this class, you are recommended to read the official documentation at <a class="ulink" href="http://fuelphp.com/docs/classes/form.html">http://fuelphp.com/docs/classes/form.html</a>.</p><p>Note that no <a id="id207" class="indexterm"/>parameter was passed to <code class="literal">Form::open</code>; the consequence is that the form will submit information to the current URL (and that is how we will know which project the new task must be associated with). Thus, we have to handle the form in the view action of the <span class="strong"><strong>Project</strong></span> controller. Inside the action, add the following:</p><div class="informalexample"><pre class="programlisting">// Checking first if we received a POST request
if (Input::method() == 'POST')
{
    // Getting the task name. If empty, we display an
    // error, otherwise we attempt to create the new
    // task
    $task_name = Input::post('task_name', '');
    if ($task_name == '') {
        // Setting the flash session variable named
        // error. Reminder: this variable is displayed
        // in the template using Session::get_flash
        Session::set_flash(
            'error',
            'The task name is empty!'
        );
    } else {
        $task = Model_Task::forge();
        $task-&gt;name = $task_name;
        $task-&gt;status = 0; 
        $task-&gt;rank = 0; // temporary
        $data['project']-&gt;tasks[] = $task;
        $data['project']-&gt;save();
        // When the task has been saved, we redirect
        // the browser to the same webpage. This
        // prevents the form from being submitted
        // again if the user refreshes the webpage
        Response::redirect('project/view/'.$id);
    }
}</pre></div><p>Before:</p><div class="informalexample"><pre class="programlisting">$this-&gt;template-&gt;title = "Project";</pre></div><p>If you read the comments, the changes we made should be pretty straightforward.</p></div><div class="section" title="Allowing the user to change tasks' order"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec28"/>Allowing the user to change tasks' order</h2></div></div></div><p>Return back to the<a id="id208" class="indexterm"/> JavaScript file located at <code class="literal">public/assets/js/website.js</code>, and add at the end of the <code class="literal">$(document).ready</code> callback method:</p><div class="informalexample"><pre class="programlisting">var $todoList = $('#todo_list');
$todoList.sortable();
$todoList.disableSelection();</pre></div><p>Now, if you request a project view page, you should be able to change the tasks' order by dragging the labels. This is done using the <code class="literal">sortable</code> method. The <code class="literal">disableSelection</code> method prevents the user from selecting text inside the list, because it can sometimes cause user interface issues when dragging an item.</p><p>However, the order is not synchronized, so if you refresh the web page, your custom order will be forgotten. In order to save the changes, replace <code class="literal">$todoList.sortable()</code>; with the following:</p><div class="informalexample"><pre class="programlisting">$todoList.sortable({
    // The stop event is called when the user drop an item
    // (when the sorting process has stopped).
    'stop': function() {
        // Collecting task ids from checkboxes in the
        // new order.
        var ids = [];
        $todoList.find('input[type=checkbox]').each(function() {
            ids.push($(this).data('task_id'));
        });
        // Sending the ordered task ids to the server.
        $.post(
            uriBase + 'project/change_tasks_order',
            {
                'project_id': $todoList.data('project_id'),
                'task_ids': ids
            }
        );
    }
});</pre></div><p>For more information, you are recommended to read the official documentation of the <code class="literal">sortable</code> method of jQuery UI<a id="id209" class="indexterm"/> at <a class="ulink" href="http://api.jqueryui.com/sortable/">http://api.jqueryui.com/sortable/</a>.</p><p>We now have to handle requests sent to the <code class="literal">change_tasks_order</code> action of the <span class="strong"><strong>Project</strong></span> controller. Add the following method to the controller:</p><div class="informalexample"><pre class="programlisting">public function action_change_tasks_order() {
    if (Input::is_ajax()) {
        $project = Model_Project::find(
            intval(Input::post('project_id'))
        );
        // Changing the rank property according to the
        // list of ids received by the controller
        $task_ids = Input::post('task_ids');
        for ($i = 0; $i &lt; count($task_ids); $i++) {
            $task_id = intval($task_ids[$i]);
            $project-&gt;tasks[$task_id]-&gt;rank = $i;
        }
        $project-&gt;save();
    }
    return false; // we return no content at all
}</pre></div><p>And, in the<a id="id210" class="indexterm"/> view action, replace:</p><div class="informalexample"><pre class="programlisting">$task-&gt;rank = 0; // temporary
</pre><p>with the following:</p><pre class="programlisting">// Appending the task at the end of the to-do list
$task-&gt;rank = count($data['project']-&gt;tasks);</pre></div><p>If you check the task's table, the tasks' rank column is now updated when dragging tasks to new positions. But if you refresh the web page, the order is still lost; this is because we don't sort the project's tasks when we display them. In order to do that, replace the following inside the view action:</p><div class="informalexample"><pre class="programlisting">if ( ! $data['project'] = Model_Project::find($id))</pre></div><p>with the following:</p><div class="informalexample"><pre class="programlisting">$data['project'] = Model_Project::find($id, array(
    'related' =&gt; array(
        'tasks' =&gt; array(
            'order_by' =&gt; 'rank',
        ),
    ),
));
if ( ! $data['project'])</pre></div><p>As explained in the previous section, the <code class="literal">related</code> key allows the developer to load relations when retrieving objects. More than allowing you to improve your website's performance, it also allows you to sort or add conditions to your relations. You even can add again a <code class="literal">related</code> key <a id="id211" class="indexterm"/>to load your relations' relations.</p></div><div class="section" title="Axis of improvements"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec29"/>Axis of improvements</h2></div></div></div><p>Many features <a id="id212" class="indexterm"/>can still be added to the application. You can implement them to improve your skill:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Allow the user to delete a task. This could be done by adding a delete icon next to each task.</li><li class="listitem" style="list-style-type: disc">Add a dashboard to give the user a general overview of the project and their remaining tasks.</li><li class="listitem" style="list-style-type: disc">Improve the visual interface.</li><li class="listitem" style="list-style-type: disc">A bit trickier: add support for a multiuser environment. What happens if two users change the tasks order at the same time for instance? How to prevent loss of information?</li></ul></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec23"/>Summary</h1></div></div></div><p>In this chapter, we have built our first real project and learnt to use important FuelPHP features such as the ORM and debugging tools. You should begin to feel confident about implementing simple projects. In the next chapter, we are going to use more advanced FuelPHP features such as modules and presenters.</p></div></body></html>