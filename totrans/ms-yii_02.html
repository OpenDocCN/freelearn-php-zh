<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;2.&#xA0;Console Commands and Applications"><div class="book" id="I3QM2-ad3e09b384df46aea690d9c8897d5fe7"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02" class="calibre1"/>Chapter 2. Console Commands and Applications</h1></div></div></div><p class="calibre9">Often when building modern web applications, we need to write background and maintenance tasks to support our main application. These tasks may include things such as generating reports, sending e-mails via a queuing system, or even running data analysis that would cause a web-based endpoint to timeout. With Yii2, we can build these tools and scripts directly into our application by writing console commands or even complete console applications.</p></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Console Commands and Applications">
<div class="book" title="Configuration and usage"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch02lvl1sec13" class="calibre1"/>Configuration and usage</h1></div></div></div><p class="calibre9">The<a id="id45" class="calibre1"/> basic structure of Yii2 console applications is very similar to the structure used in web applications. In Yii2, console commands that extend from <code class="email">yii\console\Controller</code> are nearly identical to <code class="email">yii\web\Controller</code>.</p></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Console Commands and Applications">
<div class="book" title="Configuration and usage">
<div class="book" title="Entry script"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec15" class="calibre1"/>Entry script</h2></div></div></div><p class="calibre9">Before<a id="id46" class="calibre1"/> moving on to the configuration files themselves, let's take a look at the console entry script, which is part of the file called <code class="email">yii</code>. This entry script serves as the bootstrapper for all our console commands, and in general, they can be run by calling this:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii</strong></span>
</pre></div><p class="calibre9">This command will output all the currently available commands for the system. Like the <code class="email">web/index.php</code> entry script, though, it isn't aware of its environment yet. We can change this by replacing <code class="email">yii</code> with the following code block:</p><div class="note"><pre class="programlisting">#!/usr/bin/env php
&lt;?php
/**
 * Yii console bootstrap file.
 */

// Define our application_env variable as provided by nginx/apache
<span class="strong"><strong class="calibre2">if (!defined('APPLICATION_ENV'))</strong></span>
<span class="strong"><strong class="calibre2">{</strong></span>
<span class="strong"><strong class="calibre2">    if (getenv('APPLICATION_ENV') != false)</strong></span>
<span class="strong"><strong class="calibre2">        define('APPLICATION_ENV', getenv('APPLICATION_ENV'));</strong></span>
<span class="strong"><strong class="calibre2">    else </strong></span>
<span class="strong"><strong class="calibre2">       define('APPLICATION_ENV', 'prod');</strong></span>
<span class="strong"><strong class="calibre2">}</strong></span>

$env = require(__DIR__ . '/config/env.php');

defined('YII_DEBUG') or define('YII_DEBUG', $env['debug']);

// fcgi doesn't have STDIN and STDOUT defined by default
defined('STDIN') or define('STDIN', fopen('php://stdin', 'r'));
defined('STDOUT') or define('STDOUT', fopen('php://stdout', 'w'));

require(__DIR__ . '/vendor/autoload.php');
require(__DIR__ . '/vendor/yiisoft/yii2/Yii.php');

$config = require(__DIR__ . '/config/console.php');

$application = new yii\console\Application($config);
$exitCode = $application-&gt;run();
exit($exitCode);</pre></div><div class="note" title="Note"><h3 class="title2"><a id="note10" class="calibre1"/>Note</h3><p class="calibre9">This script is intended for Linux-like environments. Yii2 also provides a <code class="email">yii.bat</code> file that can be run on Windows. If you're following along on a Windows computer, ensure that you change <code class="email">yii.bat</code> in addition to the yii file.</p></div><p class="calibre9">With <a id="id47" class="calibre1"/>our entry script files configured, we're ready to take a look at our application configuration files.</p><div class="note" title="Note"><h3 class="title2"><a id="tip11" class="calibre1"/>Tip</h3><p class="calibre9">You may also notice that in the <code class="email">web/</code> folder, there is a separate entry script called <code class="email">index-test.php</code>. This script is used by Codeception, a testing framework that is used to run unit, functional, and acceptance tests in Yii2. We'll cover how to configure and use this entry script and Codeception in <a class="calibre1" title="Chapter 10. Testing with Codeception" href="part0060_split_000.html#1P71O1-ad3e09b384df46aea690d9c8897d5fe7">Chapter 10</a>, <span class="strong"><em class="calibre13">Testing with Codeception</em></span>.</p></div></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Console Commands and Applications">
<div class="book" title="Configuration and usage">
<div class="book" title="Configuration"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec16" class="calibre1"/>Configuration</h2></div></div></div><p class="calibre9">In Yii2, the<a id="id48" class="calibre1"/> console configuration file is located at <code class="email">config/console.php</code> and is nearly identical to our web configuration file:</p><div class="note"><pre class="programlisting">&lt;?php

Yii::setAlias('@tests', dirname(__DIR__) . '/tests');

return [
    'id' =&gt; 'basic-console',
    'basePath' =&gt; dirname(__DIR__),
    'bootstrap' =&gt; ['log'],
    'controllerNamespace' =&gt; 'app\commands',
    'components' =&gt; [
        'cache' =&gt; [
            'class' =&gt; 'yii\caching\FileCache',
        ],
        'log' =&gt; [
            'targets' =&gt; [
                [
                    'class' =&gt; 'yii\log\FileTarget',
                    'levels' =&gt; ['error', 'warning'],
                ],
            ],
        ],
        'db' =&gt; require(__DIR__ . '/db.php'),
    ],
    'params' =&gt; require(__DIR__ . '/params.php'),
];</pre></div><p class="calibre9">Like our web configuration file, we can include our database and parameters' configuration files using the environment-aware configurations we wrote in <a class="calibre1" title="Chapter 1. Composer, Configuration, Classes, and Path Aliases" href="part0014_split_000.html#DB7S2-ad3e09b384df46aea690d9c8897d5fe7">Chapter 1</a>, <span class="strong"><em class="calibre13">Composer, Configuration, Classes, and Path Aliases</em></span>. In fact, the only major difference between our web and console configuration is the explicit declaration of our console command namespace and the explicit declaration of the <code class="email">@test</code> alias, which defines where our test files will be located.</p><div class="note" title="Note"><h3 class="title2"><a id="tip12" class="calibre1"/>Tip</h3><p class="calibre9">Thanks to Yii's extremely flexible structure, we can reorganize our bootstrap and entry<a id="id49" class="calibre1"/> script files to be in many different physical locations on our file system. Because of this flexibility, the console configuration file expects us to declare the <code class="email">@test</code> alias explicitly so that we can run our console tests.</p></div></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Console Commands and Applications">
<div class="book" title="Configuration and usage">
<div class="book" title="Setting the console environment"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch02lvl2sec17" class="calibre1"/>Setting the console environment</h2></div></div></div><p class="calibre9">Following <a id="id50" class="calibre1"/>the same convention we set up for our web application, we now need to instruct our console to pass the <code class="email">APPLICATION_ENV</code> variable to our console application. From the command line, we can easily change the environment by exporting a variable:</p><div class="note"><pre class="programlisting">export APPLICATION_ENV="dev"</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip13" class="calibre1"/>Tip</h3><p class="calibre9">If we want to make this change permanent for the server we are working on, we can store this variable in our <code class="email">~/.bash_profile</code> file, or we can store it globally for all users at <code class="email">/etc/profile</code>. By adding this command to either of these files, the next time we log in to our shell, this variable will automatically be exported. Note that if you're using Windows, you'll need to export this variable to your <code class="email">%path%</code> variable.</p></div><p class="calibre9">Go ahead and give it a try! Log out and log in to your shell again and run the following:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">echo $APPLICATION_ENV</strong></span>
</pre></div><p class="calibre9">If your computer is configured correctly, you should see the environment outputted to your screen.</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">dev</strong></span>
</pre></div></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Console Commands and Applications">
<div class="book" title="Configuration and usage">
<div class="book" title="Running console commands"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch02lvl2sec18" class="calibre1"/>Running console commands</h2></div></div></div><p class="calibre9">With <a id="id51" class="calibre1"/>our console application now configured, we can easily run our console commands by running the following command:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip14" class="calibre1"/>Tip</h3><p class="calibre9">On Windows, this command is <code class="email">yii.bat</code>.</p></div><p class="calibre9">If you <a id="id52" class="calibre1"/>are familiar with Yii1, this command has now replaced the <code class="email">/yiic</code> command.</p><p class="calibre9">Without any arguments, this is the same as running <code class="email">/yii help</code> and will output the help menu, which lists all the built-in console commands for our application:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00002.jpeg" alt="Running console commands" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre9">Yii provides additional help information for each of the default commands. For example, if we want to<a id="id53" class="calibre1"/> see what subcommands exist for the cache command, we can run the following:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii help cache</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00003.jpeg" alt="Running console commands" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre9">In general, we can reduce the usage of the Yii console to the following pattern:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii &lt;route&gt; [--option1=value1 --option2=value2 ... \</strong></span>
<span class="strong"><strong class="calibre2">argument1 argument2 ...]</strong></span>
</pre></div><p class="calibre9">Here, <code class="email">&lt;route&gt;</code> refers to the specific controller and action that we want to run. For example, if we wanted to flush the entire cache for our application from the console, we could run <a id="id54" class="calibre1"/>the following command:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii cache/flush-all</strong></span>
</pre></div><p class="calibre9">This is the output we receive:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">The following cache components were processed:</strong></span>
<span class="strong"><strong class="calibre2">        * cache (yii\caching\FileCache)</strong></span>
</pre></div><p class="calibre9">The <code class="email">./yii</code> command also enables you to use alternative console configuration files from the same command:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii &lt;route&gt; --appconfig=path/to/config.php</strong></span>
</pre></div><p class="calibre9">Without having to change anything in our code, we can simply instruct Yii to use an alternate configuration file, which can contain anything, ranging from something as simple as a reference to another database or cache to something more complex such as an entirely different controller namespace. This option is especially useful when creating applications that have both a frontend and a backend that may contain different caches or database components.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Built-in console commands"><div class="book" id="J2B82-ad3e09b384df46aea690d9c8897d5fe7"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec14" class="calibre1"/>Built-in console commands</h1></div></div></div><p class="calibre9">Now that <a id="id55" class="calibre1"/>we know how to run console commands, let's take a look at the built-in commands to see how they work. As shown previously, Yii2 has seven built-in console commands: <code class="email">help</code>, <code class="email">asset</code>, <code class="email">cache</code>, <code class="email">fixtures</code>, <code class="email">gii</code>, <code class="email">message</code>, and <code class="email">migrate</code>. During the development of our application, we're likely to use all seven in order to make our application more robust. Let's take a look at each one in more detail.</p></div>

<div class="book" title="Built-in console commands">
<div class="book" title="The help command"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch02lvl2sec19" class="calibre1"/>The help command</h2></div></div></div><p class="calibre9">The<a id="id56" class="calibre1"/> first command built in to Yii2 is the <code class="email">help</code> command. Often when running console commands, you may not know what options a certain command needs. Rather than referencing the Yii2 documentation, you can use the <code class="email">help</code> command to provide you with all the core information you need.</p><p class="calibre9">At the most basic level, the <code class="email">help</code> command will output all the currently available console commands:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii help</strong></span>
</pre></div><p class="calibre9">Some commands contain additional subcommands that can be run. To view a list of all the available subcommands for a given command, you can run this:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii help &lt;command&gt;</strong></span>
</pre></div><p class="calibre9">Some <a id="id57" class="calibre1"/>subcommands, such as those found in the Gii tool, require additional options to be passed to them in order for them to function. To see a list of all the required and optional flags for a given subcommand, you can run the following:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii help &lt;command/sub&gt;</strong></span>
</pre></div><p class="calibre9">As we move through the next sections, ensure that you use the <code class="email">help</code> command to see all the possible options and requirements for each command.</p></div></div>

<div class="book" title="Built-in console commands">
<div class="book" title="The asset command"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec20" class="calibre1"/>The asset command</h2></div></div></div><p class="calibre9">The <a id="id58" class="calibre1"/>second default set of commands in our toolbox is the set of <code class="email">asset</code> commands, which include <code class="email">asset/template</code> and <code class="email">asset/compress</code>.</p><p class="calibre9">The first command, <code class="email">asset/template</code>, is used to generate a configuration file to automate the compression and minification of JavaScript and CSS assets, and it is used as follows:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii asset/template path/to/asset.php</strong></span>
</pre></div><p class="calibre9">Running this command will generate a new file at <code class="email">path/to/asset.php</code>, containing build instructions that are used by the next command, <code class="email">asset/compress</code>. This file outlines which CSS and JavaScript compressor to use, a list of asset bundles to be compressed, a set of targets that the compressed assets will be outputted to, and any custom configuration for our <code class="email">assetManager</code>.</p><p class="calibre9">The next command, <code class="email">asset/compress</code>, reads our generated configuration file and builds the compressed asset files and a referable asset bundle configuration that we can load into our layouts and/or views. This command is called using the following:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii asset/compress path/to/asset.php path/to/asset-bundle.php</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="note11" class="calibre1"/>Note</h3><p class="calibre9">In <a class="calibre1" title="Chapter 6. Asset Management" href="part0039_split_000.html#1565U2-ad3e09b384df46aea690d9c8897d5fe7">Chapter 6</a>, <span class="strong"><em class="calibre13">Asset Management</em></span>, we will take an in-depth look at how we can use these commands in addition to the <code class="email">assetManager</code> class in order to manage our assets in more detail.</p></div></div></div>

<div class="book" title="Built-in console commands">
<div class="book" title="The cache command"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec21" class="calibre1"/>The cache command</h2></div></div></div><p class="calibre9">The<a id="id59" class="calibre1"/> third built-in command in our toolbox is the <code class="email">cache</code> command. The <code class="email">cache</code> command provides the functionality to flush caches that are generated by our application. These commands are <code class="email">cache</code>, <code class="email">cache/flush</code>, <code class="email">cache/flush-all</code>, and <code class="email">cache/flush-schema</code>.</p><p class="calibre9">The first command, <code class="email">cache</code>, returns a named list of all the available caches defined in our configuration file and can be run using the following command:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii cache</strong></span>
</pre></div><p class="calibre9">Here's the output:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">The following caches were found in the system:</strong></span>
<span class="strong"><strong class="calibre2">        * cache (yii\caching\FileCache)</strong></span>
</pre></div><p class="calibre9">The output of this command takes the following format so that we can identify which caches are in use. In our default application, only one cache is predefined: our file cache.</p><div class="note"><pre class="programlisting">&lt;cache_name&gt; (&lt;cache_type&gt;)</pre></div><p class="calibre9">Once we know what caches are in use, we can then use the <code class="email">cache/flush</code> command to flush that cache by name. Using the output of the previous command, we can clear the cache component by name by running this:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">./yii cache/flush cache</strong></span>
</pre></div><p class="calibre9">Here's the output:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">The following cache components will be flushed:</strong></span>
<span class="strong"><strong class="calibre2">        * cache</strong></span>
<span class="strong"><strong class="calibre2">The following cache components were processed:</strong></span>
<span class="strong"><strong class="calibre2">        * cache (yii\caching\FileCache)</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip15" class="calibre1"/>Tip</h3><p class="calibre9">Some commands in Yii2 are interactive and prompt for confirmation before running. This may be problematic when you need to automate the use of a command, such as on deployment. You can bypass this behavior by appending <code class="email">--interactive=0</code> to the command. When running commands noninteractively, additional arguments may be required. Ensure that you reference the <code class="email">help</code> command to determine what arguments you need to pass when running noninteractive commands.</p></div><p class="calibre9">Alternatively, if we want to flush the entire cache for our application, we can use the <code class="email">cache/flush-all</code> option:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii cache/flush-all</strong></span>
</pre></div><p class="calibre9">In our production environments, we'll want to reduce the load on our database server by caching our database schema. Yii2 will maintain a cache of the currently active <code class="email">db</code> component (the database) and the database schema when instructed to. When making schema<a id="id60" class="calibre1"/> changes, such as when applying new migrations, we need to clear this cache so that Yii2 becomes aware of our updated database structure. We can clear the database schema cache by running this:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii cache/flush-schema</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip16" class="calibre1"/>Tip</h3><p class="calibre9">We'll cover how to enable the schema cache and improve the performance of our database in the next chapter.</p></div></div></div>

<div class="book" title="Built-in console commands">
<div class="book" title="The fixture command"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch02lvl2sec22" class="calibre1"/>The fixture command</h2></div></div></div><p class="calibre9">When <a id="id61" class="calibre1"/>testing our application, we'll often want to set up our database such that our tests always run in a predictable and repeatable way. One <a id="id62" class="calibre1"/>way in which we can do this is by creating <span class="strong"><strong class="calibre2">fixtures</strong></span>, which will represent database objects in our application for testing. Yii2 provides a set of commands to both load and unload fixtures; these commands are <code class="email">fixture/load</code> and <code class="email">fixture/unload</code>, and they do exactly what you expect them to do.</p><p class="calibre9">When using fixtures, our typical test flow is as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Apply database migrations.</li><li class="listitem" value="2">Execute our test cases in the following manner:<div class="book"><ol class="orderedlist1"><li class="listitem" value="1">Load our database fixtures.</li><li class="listitem" value="2">Execute a specific test.</li><li class="listitem" value="3">Unload our database fixtures.</li></ol><div class="calibre15"/></div></li><li class="listitem" value="3">Repeat as required until all tests have run.</li></ol><div class="calibre15"/></div><p class="calibre9">The <code class="email">fixture/load</code> and <code class="email">fixture/unload</code> commands are called in the same way from the command line:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii fixture/load &lt;FixtureName&gt;</strong></span>
<span class="strong"><strong class="calibre2">$ ./yii fixture/unload &lt;FixtureName&gt;</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip17" class="calibre1"/>Tip</h3><p class="calibre9">Fixtures are a powerful way to create repeatable tests for our applications. Additionally, the <code class="email">yii2-codeception</code> package provides additional support for the loading and unloading of fixtures when our tests run. In <a class="calibre1" title="Chapter 10. Testing with Codeception" href="part0060_split_000.html#1P71O1-ad3e09b384df46aea690d9c8897d5fe7">Chapter 10</a>, <span class="strong"><em class="calibre13">Testing with Codeception</em></span>, we'll cover how to creature new fixtures and how to integrate<a id="id63" class="calibre1"/> them with Codeception.</p></div></div></div>

<div class="book" title="Built-in console commands">
<div class="book" title="The Gii command"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch02lvl2sec23" class="calibre1"/>The Gii command</h2></div></div></div><p class="calibre9">The next<a id="id64" class="calibre1"/> set of commands in our toolbox is the <code class="email">Gii</code> command. If you are familiar with Yii1, Gii provides the functionality to generate controllers, models, forms, and even basic CRUD functionality. In Yii2, Gii has been extended from a web application module to both a web and console application and has been enhanced to include additional features as well.</p><p class="calibre9">The <code class="email">Gii</code> module in Yii2 provides these console commands to automatically generate code: <code class="email">gii/controller</code>, <code class="email">gii/model</code>, <code class="email">gii/crud</code>, <code class="email">gii/form</code>, <code class="email">gii/extension</code>, and <code class="email">gii/module</code>. Each of these commands, when supplied with the right options, will generate the respective item identified by the subcommand. For a complete list of requirements and options, ensure that you use the <code class="email">help</code> command on the <code class="email">Gii</code> subcommands.</p><div class="note" title="Note"><h3 class="title2"><a id="tip18" class="calibre1"/>Tip</h3><p class="calibre9">As a development tool, Gii has the ability to arbitrarily generate and override existing code in your application. For security purposes, you should conditionally load the <code class="email">Gii</code> module only in your development environment. Moreover, the <code class="email">Gii</code> module itself should never be deployed to your production environment. For this reason, it is advised that you only load the <code class="email">Gii</code> module in the <code class="email">require-dev</code> section of your <code class="email">composer.json</code> file.</p><p class="calibre9">The <code class="email">require-dev</code> section is a special section within our <code class="email">composer.json</code> file, which allows us to separate our development dependencies from our production dependencies. By default, running Composer will install all packages in our <code class="email">require</code> and <code class="email">require-dev</code> sections. In production environments, we will want to exclude our development environments by passing the <code class="email">--no-dev</code> flag to our Composer installation command. For more information on the Composer CLI, ensure <a id="id65" class="calibre1"/>that you reference the Composer documentation at <a class="calibre1" href="https://getcomposer.org/doc/03-cli.md">https://getcomposer.org/doc/03-cli.md</a>.</p></div></div></div>

<div class="book" title="Built-in console commands">
<div class="book" title="The message command"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch02lvl2sec24" class="calibre1"/>The message command</h2></div></div></div><p class="calibre9">The <a id="id66" class="calibre1"/>next set of commands is the <code class="email">message</code> commands, which provide functionalities to automatically generate message translations for our application in a variety of different formats.</p><p class="calibre9">The first subcommand is the <code class="email">message/config</code> command, which generates a configuration file that the <code class="email">message/extract</code> command will then use to output the translation files. Before generating any translations, we must run the <code class="email">message/config</code> command as follows:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii message/config /path/to/translation/config.php</strong></span>
</pre></div><p class="calibre9">This command generates a configuration file at <code class="email">/path/to/translation/config.php</code> that contains all the information <code class="email">message/extract</code> will need in order to generate the message output files.</p><p class="calibre9">After configuring your message configuration file to your liking, you can then run the <code class="email">message/extract</code> command as follows:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii message /path/to/translation/config.php</strong></span>
</pre></div><p class="calibre9">Depending upon your configuration file and the use of <code class="email">\Yii::t()</code>, the built-in Yii translation tool in your application, this command will generate either a PHP file containing a list of messages, a <code class="email">.po</code> file, and a command translation file format, or it will populate the specified table in your database with the necessary message lists.</p><div class="note" title="Note"><h3 class="title2"><a id="tip19" class="calibre1"/>Tip</h3><p class="calibre9">In <a class="calibre1" title="Chapter 11. Internationalization and Localization" href="part0068_split_000.html#20R681-ad3e09b384df46aea690d9c8897d5fe7">Chapter 11</a>, <span class="strong"><em class="calibre13">Internationalization and Localization</em></span>, we'll go into more depth about how to use these commands to generate PHP message files and <code class="email">.po</code> files and how to populate our database. We'll also cover the use of the <code class="email">Yii::t()</code> method in detail.</p></div></div></div>

<div class="book" title="Built-in console commands">
<div class="book" title="The migration command"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_7"><a id="ch02lvl2sec25" class="calibre1"/>The migration command</h2></div></div></div><p class="calibre9">The<a id="id67" class="calibre1"/> final built-in command set with Yii2 is the <code class="email">migration</code> command. The <code class="email">migration</code> commands provide functionalities to generate, apply, revert, and review database migrations. This tool provides these subcommands: <code class="email">migrate/create</code>, <code class="email">migrate/history</code>, <code class="email">migrate/mark</code>, <code class="email">migrate/up</code>, <code class="email">migrate/down</code>, <code class="email">migrate/to</code>, <code class="email">migrate/new</code>, and <code class="email">migrate/redo</code>.</p><div class="note" title="Note"><h3 class="title2"><a id="tip20" class="calibre1"/>Tip</h3><p class="calibre9">We'll cover<a id="id68" class="calibre1"/> how to completely use this tool and work with databases in general in more detail in <a class="calibre1" title="Chapter 3. Migrations, DAO, and Query Building" href="part0023_split_000.html#LTSU1-ad3e09b384df46aea690d9c8897d5fe7">Chapter 3</a>, <span class="strong"><em class="calibre13">Migrations, DAO, and Query Building</em></span>. For now, use the <code class="email">./yii help migrate</code> command to view more information on the migration tool.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating console commands"><div class="book" id="K0RQ2-ad3e09b384df46aea690d9c8897d5fe7"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec15" class="calibre1"/>Creating console commands</h1></div></div></div><p class="calibre9">Now <a id="id69" class="calibre1"/>that we know what built-in commands Yii2 provides, let's start adding our own commands. In Yii2, any custom commands we write are going to be stored in the <code class="email">/commands</code> subfolder of our application. If this folder doesn't exist yet, go ahead and create it:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">mkdir commands</strong></span>
</pre></div><p class="calibre9">Now, let's write a basic console command that just outputs some text:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we'll create a new file called <code class="email">BasicController.php</code> in the <code class="email">commands</code> folder:<div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">touch commands/BasicController.php</strong></span>
</pre></div></li><li class="listitem" value="2">Now, let's write some PHP code. First, we need to declare the namespace that our <code class="email">BasicController</code> lives in. This namespace directly corresponds to the <code class="email">controllerNamespace</code> parameter we defined in <code class="email">config/console.php</code>:<div class="note"><pre class="programlisting">&lt;?php

namespace app\commands;</pre></div></li><li class="listitem" value="3">Then, we'll want to declare that we want to use the <code class="email">\yii\console\Controller</code> class in our new controller:<div class="note"><pre class="programlisting">use \yii\console\Controller;</pre></div></li><li class="listitem" value="4">Next, we'll declare our controller class as follows:<div class="note"><pre class="programlisting">class BasicController extends Controller { }</pre></div></li><li class="listitem" value="5">Finally, inside our class, we'll create an <code class="email">actionIndex()</code> method that will simply output <code class="email">HelloWorld</code> and then gracefully return with a successful error code. By default, the <code class="email">actionIndex()</code> method is the method that is called when an action is not specified to a controller:<div class="note"><pre class="programlisting">public function actionIndex()
{
  echo "HelloWorld";
  return 0;
}</pre></div></li></ol><div class="calibre15"/></div><p class="calibre9">We have <a id="id70" class="calibre1"/>our first console command! Now, if we run the <code class="email">help</code> command, you can see that our command appears in the list of available commands:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii help</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00004.jpeg" alt="Creating console commands" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre9">Moreover, we can now execute our command to verify that it functions properly:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii basic</strong></span>
</pre></div><p class="calibre9">This is the output:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">HelloWorld</strong></span>
</pre></div></div>

<div class="book" title="Creating console commands">
<div class="book" title="Generating help information"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch02lvl2sec26" class="calibre1"/>Generating help information</h2></div></div></div><p class="calibre9">While we<a id="id71" class="calibre1"/> can now run our commands, the <code class="email">help</code> command for both the global help menu and the action help menu currently doesn't provide any useful information. In Yii2, this information is extracted directly from the document block comments (also known as <code class="email">DocBlock</code> comments) that are used before our <code class="email">BasicController</code> class and our <code class="email">actionIndex()</code> method. For instance, consider that we add the following before our class declaration:</p><div class="note"><pre class="programlisting">/**
 * A basic controller for our Yii2 Application
 */
class BasicController extends \yii\console\Controller {}</pre></div><p class="calibre9">We could also provide more information to our <code class="email">actionIndex()</code> method by specifying a <code class="email">DocBlock</code> comment before the method:</p><div class="note"><pre class="programlisting">/**
 * Outputs HelloWorld
 */
public function actionIndex() {}</pre></div><p class="calibre9">Running the <code class="email">help</code> command on the basic controller would then display the following:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii help basic</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00005.jpeg" alt="Generating help information" class="calibre10"/></div><p class="calibre11"> </p></div></div>

<div class="book" title="Creating console commands">
<div class="book" title="Passing command-line arguments"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec27" class="calibre1"/>Passing command-line arguments</h2></div></div></div><p class="calibre9">Like<a id="id72" class="calibre1"/> our web controllers (<code class="email">yii\web\Controller</code>), we can also pass arguments through the command line to our console commands. Rather than using <code class="email">$_GET</code> parameters to determine the arguments in use, Yii2 will pull the arguments directly from the command-line interface. Take, for instance, the following method of our <code class="email">BasicController</code>:</p><div class="note"><pre class="programlisting">/**
 * Outputs "$name lives in $city"
 * @param string $name	  The name of the person
 * @param string $city  The city $name lives in
 * @return 0
 */
public function actionLivesIn($name, $city="Chicago")
{
  echo "$name lives in $city.\n";
  return 0;
}</pre></div><p class="calibre9">The <code class="email">help</code> command <a id="id73" class="calibre1"/>now shows us what arguments are required and what arguments are optional for this new method:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii help basic/lives-in</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00006.jpeg" alt="Passing command-line arguments" class="calibre10"/></div><p class="calibre11"> </p><div class="note" title="Note"><h3 class="title2"><a id="tip21" class="calibre1"/>Tip</h3><p class="calibre9">By now, you may have noticed that console commands can accept two types of input: arguments, (in this example, <code class="email">name</code> and <code class="email">city</code>), and options. Arguments serve as the data that we provide to your actions. On the other hand, options allow us to specify additional configuration for our controller in general. For instance, as previously shown, we can run our commands noninteractively by passing the <code class="email">--interactve=0</code> flag option. Each console application we create and use may have separate options that we can set. Ensure that you reference the Yii2 documentation for that class and use the <code class="email">help</code> command to determine what options are available for each command.</p></div><p class="calibre9">Without <a id="id74" class="calibre1"/>any arguments, this command will throw the following error, indicating that the <code class="email">name</code> parameter is required:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">Error: Missing required arguments: name</strong></span>
</pre></div><p class="calibre9">Once we provide the name, the console outputs the result as expected:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii basic/lives-in Alice</strong></span>
</pre></div><p class="calibre9">This is the output:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">Alice lives in Chicago.</strong></span>
</pre></div><p class="calibre9">By providing a default value to the <code class="email">city</code> parameter, that option is not required for our command to be executed. However, if we passed a value as the second parameter, it would override our default value as expected:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii basic/lives-in Alice California</strong></span>
</pre></div><p class="calibre9">Here's the output:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">Alice lives in California.</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip22" class="calibre1"/>Tip</h3><p class="calibre9">Depending upon how your shell is configured, you may not be able to pass certain characters (such as <code class="email">$</code> or <code class="email">*</code>) from the command line. Ensure that you wrap any strings that use special characters in quotes to ensure that the full argument is passed to your application.</p></div><p class="calibre9">In addition to simple strings, Yii2 will also accept arrays in the form of comma-separated lists. Take, for instance, the following method:</p><div class="note"><pre class="programlisting">/**
 * Outputs each element of the input $array on a new line
 * @param array $array A comma separated list of elements
 * @return 0
 */
public function actionListElements(array $array)
{
  foreach ($array as $$k)
    echo "$$k\n";

  return 0;
}</pre></div><p class="calibre9">By type-hinting the first parameter using the array <code class="email">type-hint</code>, we can notify Yii to convert <a id="id75" class="calibre1"/>the command-line arguments into a usable PHP array. From the command line, we can specify an element as an array by representing it as a comma-separated list:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii basic/list-elements these,are,separate,items</strong></span>
</pre></div><p class="calibre9">This is the output that will appear:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">these</strong></span>
<span class="strong"><strong class="calibre2">are</strong></span>
<span class="strong"><strong class="calibre2">separate</strong></span>
<span class="strong"><strong class="calibre2">items</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip23" class="calibre1"/>Tip</h3><p class="calibre9">Yii2 does <a id="id76" class="calibre1"/>not support the use of multidimensional arrays from the command line. If you need to pass a multidimensional array of data from the command line, you can pass a path to a configuration file instead and then load that file inside your controller action.</p><p class="calibre9">The options to store this data range from a PHP file, which returns an array of data, to a JSON- or YAML-formatted file, which would be loaded and converted to a PHP array within your controller action.</p></div></div></div>

<div class="book" title="Creating console commands">
<div class="book" title="Exit codes"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec28" class="calibre1"/>Exit codes</h2></div></div></div><p class="calibre9">As<a id="id77" class="calibre1"/> shown in our previous examples, each action we've written thus far has a return value of <code class="email">0</code>. While returning from our controller action isn't strictly necessary, it's considered a best practice so that our shell can be notified whether our console command has been executed successfully or not. By convention, an exit code of <code class="email">0</code> indicates that our command ran without errors, whereas any positive integer greater than zero would indicate that a specific error occurred. The number returned will be the error code that is returned to the shell, and it can be used by our end users to reference our application documentation or support forum to identify what went wrong.</p><p class="calibre9">Suppose, for instance, that we wanted to validate one of our inputs without diving into custom forms and validators. In this example, we want our input of <code class="email">$shouldRun</code> to be a positive nonzero integer. If that integer is less than zero, we could return an error code that our <a id="id78" class="calibre1"/>documentation would be able to reference:</p><div class="note"><pre class="programlisting">/**
 * Returns successfully IFF $shouldRun is set to any 
 * positive integer greater than 0
 *
 * @param integer $shouldRun
 * @return integer
 */
public function actionConditionalExit($shouldRun=0)
{
  if ((int)$shouldRun &lt; 0)
  {
    echo 'The $shouldRun argument must be an positive non-zero integer' . "\n";
    return 1;
  }

  return 0;
}</pre></div><p class="calibre9">Additionally, Yii2 provides some predefined constants for us to work with: <code class="email">Controller::EXIT_CODE_NORMAL</code>, which has a value of <code class="email">0</code>, and <code class="email">Controller::EXIT_CODE_ERROR</code>, which has a value of <code class="email">1</code>. If you have more than one return code, it is considered a good practice to define meaningful constants in your controller to identify your error code.</p></div></div>

<div class="book" title="Creating console commands">
<div class="book" title="Formatting"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch02lvl2sec29" class="calibre1"/>Formatting</h2></div></div></div><p class="calibre9">Yii2 provides <a id="id79" class="calibre1"/>support for the formatting of the output of our console commands. This is provided through the <code class="email">yii\helpers\Console</code> helper. Before we can use this helper, we need to import it into our class:</p><div class="note"><pre class="programlisting">&lt;?php

namespace app\commands;
use yii\helpers\Console;</pre></div><p class="calibre9">With this helper loaded, we can now use either the <code class="email">stdout()</code> method from <code class="email">\yii\console\Controller</code> or the <code class="email">ansiFormat()</code> method. While both methods will format text, the <code class="email">ansiFormat()</code> method can be used to dynamically combine multiple strings with different formats:</p><div class="note"><pre class="programlisting">/**
 * Outputs text in bold and cyan
 * @return 0
 */
public function actionColors()
{
  $this-&gt;stdout("Waiting on important thing to happen...\n", Console::BOLD);

  $yay = $this-&gt;ansiFormat('Yay', Console::FG_CYAN);
  echo "$yay! We're done!\n";
  return 0;
}</pre></div><p class="calibre9">Then, if <a id="id80" class="calibre1"/>we run our new console command, we can see how our output text changes:</p><div class="note"><pre class="programlisting"><span class="strong"><strong class="calibre2">$ ./yii basic/colors</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00007.jpeg" alt="Formatting" class="calibre10"/></div><p class="calibre11"> </p><div class="note" title="Note"><h3 class="title2"><a id="note12" class="calibre1"/>Note</h3><p class="calibre9">A <a id="id81" class="calibre1"/>complete list of available constants is available in the Yii2 documentation at <a class="calibre1" href="http://www.yiiframework.com/doc-2.0/yii-helpers-baseconsole.html">http://www.yiiframework.com/doc-2.0/yii-helpers-baseconsole.html</a>.</p></div></div></div>
<div class="book" title="Summary" id="KVCC1-ad3e09b384df46aea690d9c8897d5fe7"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec16" class="calibre1"/>Summary</h1></div></div></div><p class="calibre9">In this chapter, we covered how to configure Yii to run console commands in a manner consistent with our web applications. We also covered the seven built-in console commands in brief. Additionally, we covered how to create our own console commands, how to pass parameters to our command, how to return values properly from within our code, and how to format the output of our commands.</p><p class="calibre9">In the next chapter, we'll expand our mastery of Yii by learning how to use and write migrations, how to use <span class="strong"><strong class="calibre2">database access objects</strong></span> (<span class="strong"><strong class="calibre2">DAO</strong></span>), and how to use Yii's built-in Query Builder.</p></div></body></html>