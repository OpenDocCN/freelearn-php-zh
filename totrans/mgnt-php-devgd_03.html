<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Frontend Development"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Frontend Development</h1></div></div></div><p>So far, we have focused on the theory behind Magento, its architecture, and getting familiar with the common and important concepts of everyday Magento development.</p><p>In this chapter, we will give practical use to the skills and knowledge we have acquired so far by incrementally building a Magento extension for our frontend. We will build a fully functional gift registry extension.</p><div class="section" title="Extending Magento"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec23"/>Extending Magento</h1></div></div></div><p>Before jumping <a id="id172" class="indexterm"/>ahead and building our extension, let's define an example scenario and a scope for our extension. This way, we will have a clear idea of what we are building, and more importantly, what we are not building.</p><div class="section" title="Scenario"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec27"/>Scenario</h2></div></div></div><p>Our scenario<a id="id173" class="indexterm"/> is simple. We want to extend Magento to allow customers to create gift registry lists and share them with their friends and families. Customers should be able to create multiple gift registries and specify the recipients of those gift registries.</p><p>A gift registry will hold the following information:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Event type</li><li class="listitem" style="list-style-type: disc">Event name</li><li class="listitem" style="list-style-type: disc">Event date</li><li class="listitem" style="list-style-type: disc">Event location</li><li class="listitem" style="list-style-type: disc">List of products</li></ul></div></div><div class="section" title="Features"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec28"/>Features</h2></div></div></div><p>Have a look at the <a id="id174" class="indexterm"/>following features:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A <a id="id175" class="indexterm"/>store administrator can define multiple event types (birthdays, weddings, and gift registries)</li><li class="listitem" style="list-style-type: disc">Create events and assign multiple gift registry lists to each event</li><li class="listitem" style="list-style-type: disc">Customers can add products to their registries from the cart, wish list, or directly from the product pages</li><li class="listitem" style="list-style-type: disc">Customers can have multiple gift registries</li><li class="listitem" style="list-style-type: disc">People can share their registries with friends and family through e-mail and/or a direct link</li><li class="listitem" style="list-style-type: disc">Friends and family can buy the items from the gift registry</li></ul></div></div><div class="section" title="Further improvements"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec29"/>Further improvements</h2></div></div></div><p>The following is a list of possible <a id="id176" class="indexterm"/>features that have been left out of this example extension due to their complexity, or in the case of social media, due to the fact that their APIs and the amount of social media platforms is ever changing. However, they are still a good challenge for readers who want to extend this module event further. These features are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Social media integration</li><li class="listitem" style="list-style-type: disc">Keep track of the request and fulfilled quantities for each registry item</li><li class="listitem" style="list-style-type: disc">Specify multiple and different registry owners</li><li class="listitem" style="list-style-type: disc">Delivery to the registry owner's address</li></ul></div></div></div></div>
<div class="section" title="Hello Magento!"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec24"/>Hello Magento!</h1></div></div></div><p>In previous chapters, we learned about the Magento code pools (core, community, and local). As we don't intend to distribute our module on Magento Connect, we will create it under the local directory.</p><p>All Magento modules are kept inside packages or namespaces. For example, all the core Magento modules are kept under the <code class="literal">Mage</code> namespace. For the purpose of this book, we will use <a id="id177" class="indexterm"/>
<span class="strong"><strong>Magento Developer's Guide</strong></span> (<span class="strong"><strong>Mdg</strong></span>).</p><p>The Magento <a id="id178" class="indexterm"/>naming convention for modules is <code class="literal">Namespace_Modulename</code>
</p><p>Our next step is to create the module structure and configuration files. We need to create a "namespace" directory under <code class="literal">app/code/local/</code>. </p><p>The namespace can be anything you like. The accepted convention is to use the company name or the author name as the namespace. So, our first step will be to create the directory <code class="literal">app/code/local/Mdg/</code>. This directory will hold not only our gift registry module, but any future modules we develop.</p><p>Under our namespace directory, we will also need to create a new directory with the name of our module which will hold all the code of a custom extension.</p><p>So let's go ahead and <a id="id179" class="indexterm"/>create a <code class="literal">Giftregistry</code> directory. Once that is done, let's create the rest of our directory structure located at <code class="literal">/app/code/local/Mdg/Giftregistry/</code>:</p><div class="informalexample"><pre class="programlisting">Block/
Controller/
controllers/
Helper/
etc/
Model/
sql/</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>Magento<a id="id180" class="indexterm"/> is a bit sensitive to the use of camel casing due to its use of factory methods. In general, it's a good idea to avoid using camel casing in our module/controller/action names. For more information on Magento naming conventions, please see the Appendices of this book.</p></div></div><p>As we have learned so far, Magento uses XML files as a central part of its configuration. In order for a module to be recognized and activated by Magento, we need to create a single file under <code class="literal">app/etc/modules/</code> following the <code class="literal">Namespace_Modulename.xml</code> convention. Let's create our file located at <code class="literal">app/etc/modules/Mdg_Giftregistry.xml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;config&gt;
  &lt;modules&gt;
    &lt;Mdg_Giftregistry&gt;
      &lt;active&gt;true&lt;/active&gt;
      &lt;codePool&gt;local&lt;/codePool&gt;
    &lt;/Mdg_Giftregistry&gt;
  &lt;/modules&gt;
&lt;/config&gt;</pre></div><p>After creating this file or making any changes to our module configuration files, we will need to refresh the Magento configuration cache:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the Magento backend.</li><li class="listitem">Go to the <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Cache Management</strong></span> menu.</li><li class="listitem">Click on <span class="strong"><strong>Flush Magento Cache</strong></span>.</li></ol></div><p>As we are working on a development extension and are going to make frequent changes to the configuration and extension code, it is a good idea to disable the cache as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate<a id="id181" class="indexterm"/> to the Magento backend.</li><li class="listitem">Go to the <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Cache Management</strong></span> menu.</li><li class="listitem">Select all the checkboxes under <span class="strong"><strong>Cache Type</strong></span>.</li><li class="listitem">Select <span class="strong"><strong>Disable</strong></span> from the <span class="strong"><strong>Actions</strong></span> drop-down menu.</li><li class="listitem">Click on the <span class="strong"><strong>Submit</strong></span> button.<div class="mediaobject"><img src="graphics/4195OS_03_02.jpg" alt="Hello Magento!"/></div></li></ol></div><p>Once we have cleared the cache, we can confirm that our extension is active by going into the Magento backend's <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Advanced</strong></span> section and confirming our new module is shown on the list.</p><div class="mediaobject"><img src="graphics/4195OS_03_01.jpg" alt="Hello Magento!"/></div><p>Magento now knows about our module, but we haven't told Magento what our module is supposed to do. For that, we will need to set up the module configuration.</p></div>
<div class="section" title="The XML module configuration"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec25"/>The XML module configuration</h1></div></div></div><p>There are two main files<a id="id182" class="indexterm"/> involved in a module configuration, <code class="literal">config.xml</code> and <code class="literal">system.xml</code>. In addition to these, module configuration is also stored in the following files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">api.xml</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">adminhtml.xml</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">cache.xml</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">widget.xml</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">wsdl.xml</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">wsi.xml</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">convert.xml</code></li></ul></div><p>In this chapter, we will only focus on <code class="literal">config.xml</code>. Let's create our base file and break down each of the nodes:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Start by <a id="id183" class="indexterm"/>creating the <code class="literal">config.xml</code> file under our module <code class="literal">etc/</code> directory.</li><li class="listitem">Copy the given code to <code class="literal">config.xml</code>, located at <code class="literal">app/code/local/Mdg/Giftregistry/etc/config.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"&gt;
&lt;config&gt;
  &lt;modules&gt;
    &lt;Mdg_Giftregistry&gt;
      &lt;version&gt;0.2.0&lt;/version&gt;
    &lt;/Mdg_Giftregistry&gt;
  &lt;/modules&gt;
  &lt;global&gt;
    &lt;models&gt;
      &lt;mdg_giftregistry&gt;
        &lt;class&gt;Mdg_Giftregistry_Model&lt;/class&gt;
      &lt;/mdg_giftregistry&gt;
    &lt;/models&gt;
    &lt;blocks&gt;
      &lt;mdg_giftregistry&gt;
        &lt;class&gt;Mdg_Giftregistry_Block&lt;/class&gt;
      &lt;/mdg_giftregistry&gt;
    &lt;/blocks&gt;
    &lt;helpers&gt;
      &lt;mdg_giftregistry&gt;
        &lt;class&gt;Mdg_Giftregistry_Helper&lt;/class&gt;
      &lt;/mdg_giftregistry&gt;
    &lt;/helpers&gt;
    &lt;resources&gt;
      &lt;mdg_giftregistry_setup&gt;
        &lt;setup&gt;
          &lt;module&gt;Mdg_Giftregistry&lt;/module&gt;
        &lt;/setup&gt;
      &lt;/mdg_giftregistry_setup&gt;
    &lt;/resources&gt;
  &lt;/global&gt;
&lt;/config&gt;</pre></div></li></ol></div><p>All module configurations are contained inside the <code class="literal">&lt;config&gt;</code> node. Inside this node, we have the <code class="literal">&lt;global&gt;</code> and <code class="literal">&lt;modules&gt;</code> nodes.</p><p>The <code class="literal">&lt;modules&gt;</code> node is just used to specify the current module version, which is later used to decide which installation and upgrade scripts to run.</p><p>There are three main configuration nodes that are most commonly used to specify the configuration scope:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;global&gt;</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;adminhtml&gt;</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;frontend&gt;</code></li></ul></div><p>For now, we will be<a id="id184" class="indexterm"/> working on the <code class="literal">&lt;global&gt;</code> scope. This will make any configuration available to both the Magento frontend and backend. Under the <code class="literal">&lt;global&gt;</code> node, we have the following nodes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;models&gt;</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;blocks&gt;</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;helpers&gt;</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;resources&gt;</code></li></ul></div><p>As we can see, each node follows the same configuration pattern:</p><div class="informalexample"><pre class="programlisting">&lt;context&gt;
  &lt;factory_alias&gt;
    &lt;class&gt;NameSpace_ModuleName_ClassType&lt;/class&gt;
  &lt;/factory_alias&gt;
&lt;/context&gt;</pre></div><p>Each of the nodes is used by the Magento class <span class="strong"><strong>factories</strong></span><a id="id185" class="indexterm"/> to instantiate our custom objects. The <code class="literal">&lt;factory_alias&gt;</code> node is a critical part of our extension configuration; it is used by factory methods such as <code class="literal">Mage::getModel()</code> or <code class="literal">Mage::helper()</code>.</p><p>Notice that we are not defining each specific <span class="strong"><strong>Model</strong></span>, <span class="strong"><strong>Block</strong></span>, or <span class="strong"><strong>Helper</strong></span>, just the path where Magento factories can find them. The Magento naming convention allows us to have any folder structure under each of these folders and Magento will be smart enough to load the appropriated class.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note11"/>Note</h3><p>In Magento, class names and directory structures are one and the same.</p></div></div><p>For example, we could have created a new model class under <code class="literal">app/code/local/Mdg/Giftregistry/Models/Folder1/Folder2/Folder3</code> and the factory name to instantiate an object from this class would be as follows:</p><div class="informalexample"><pre class="programlisting">Mage::getModel('mdg_giftregistry/folder1_folder2_folder3_classname');</pre></div><p>Let's create our first model, or to be more specific, our helper class. Helpers are used to contain utility methods used to perform common tasks and can be shared among different classes.</p><p>Let's go ahead and create an empty helper class at <code class="literal">app/code/loca/Mdg/Giftregistry/Helper/Data.php</code> (we will add the helper logic later in this chapter):</p><div class="informalexample"><pre class="programlisting">&lt;?php
  class Mdg_Giftregistry_Helper_Data extends Mage_Core_Helper_Abstract {

}</pre></div><p>It may seem <a id="id186" class="indexterm"/>odd that we are naming our helper <code class="literal">Data</code>, but this is actually part of Magento standards. Each module has a default helper class named <code class="literal">Data</code>. Another interesting thing with helpers is that they can just pass <code class="literal">&lt;factory_alias&gt;</code> without a class-specific class name to the <code class="literal">helper</code> factory method and this will default to the <code class="literal">Data</code> helper class.</p><p>So, if we wanted to instantiate our default helper class, we only need to do the following:</p><div class="informalexample"><pre class="programlisting">Mage::helper('mdg_registry');</pre></div></div>
<div class="section" title="Models and saving data"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec26"/>Models and saving data</h1></div></div></div><p>Before jumping <a id="id187" class="indexterm"/>straight to creating our models, we need to define clearly what type of <a id="id188" class="indexterm"/>models we are going to build and how many. So let's review our example scenario. For our gift registry, it appears that we will need two different models, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Registry model</strong></span>: This is <a id="id189" class="indexterm"/>used to store the gift registry information such as gift registry type, address, and recipient information</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Registry item</strong></span>: This is used <a id="id190" class="indexterm"/>to store the information of each of the gift registry items (for example, quantity requested, quantity bought, and product_id)</li></ul></div><p>Although this approach is correct, it does not meet all the requirements of our example scenario. By having all the registry information stored in a single table, we cannot add more registry types without modifying the code.</p><p>So, in this case, we need to break down our data into multiple tables:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Registry entity</strong></span>: This is used to <a id="id191" class="indexterm"/>store the gift registry and event information</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Registry type</strong></span>: By storing the gift<a id="id192" class="indexterm"/> registry type into a separate table, we can add or remove event types</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Registry item</strong></span>: This is used<a id="id193" class="indexterm"/> to store the information of each of the gift registry items (for example, quantity requested, quantity bought, and product_id)</li></ul></div><p>Now that we have defined our data structure, we can start building the corresponding <a id="id194" class="indexterm"/>models that will allow us to access and manipulate our data.</p><div class="section" title="Creating the models"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec30"/>Creating the models</h2></div></div></div><p>Let's start by <a id="id195" class="indexterm"/>creating the <code class="literal">Giftregistry</code> type model, which is used to manage the registry types (wedding, birthday, baby shower, and so on):</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">Model</code> folder in our module directory.</li><li class="listitem">Create a new file named <code class="literal">Type.php</code> and copy the following contents into the file located at <code class="literal">app/code/local/Mdg/Giftregistry/Model/Type.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Model_Type extends Mage_Core_Model_Abstract
{
  public function _construct()
  {
    $this-&gt;_init('mdg_giftregistry/type');
    parent::_construct();
  }
}</pre></div></li></ol></div><p>We also need to create a resource class. Every Magento data model has its own resource class. It is also important to clarify that only models that handle the data directly, be it a simple data model or an EAV model, need to have a resource class.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">Model</code> folder in our module directory.</li><li class="listitem">Create a new folder under <code class="literal">Model</code>, named <code class="literal">Resource</code>.</li><li class="listitem">Create a new file named <code class="literal">Type.php</code> and copy the following content into the file located at <code class="literal">app/code/local/Mdg/Giftregistry/Model/Resource/Type.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Model_Resource_Type extends Mage_Core_Model_Resource_Db_Abstract
{
  public function _construct()
  {
    $this-&gt;_init('mdg_giftregistry/type', 'type_id');
  }
}</pre></div></li></ol></div><p>Finally, we will also need a <code class="literal">collection</code> class to retrieve all the available event types. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate <a id="id196" class="indexterm"/>to the <code class="literal">Model</code>/<code class="literal">Resource</code> folder in our module directory.</li><li class="listitem">Create a new folder named <code class="literal">Type</code>.</li><li class="listitem">Create a new file named <code class="literal">Collection.php</code> in the <code class="literal">Type</code> folder and copy the following content into the file located at <code class="literal">app/code/local/Mdg/Giftregistry/Model/Resource/Type/Collection.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Model_Resource_Type_Collection extends Mage_Core_Model_Resource_Db_Collection_Abstract{
    public function _construct()
    {
      $this-&gt;_init('mdg_giftregistry/type');
      parent::_construct();
    }
}</pre></div></li></ol></div><p>Let's do the same and create another model to handle the gift registry items. This model will hold all the relevant product information for the registry items.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">Model</code> folder in our module directory.</li><li class="listitem">Create a new file named <code class="literal">Item.php</code> and copy the following content into the file located at<span class="emphasis"><em> </em></span><code class="literal">app/code/local/Mdg/Giftregistry/Model/Item.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Model_Item extends Mage_Core_Model_Abstract
{
  public function __construct()
  {
    $this-&gt;_init('mdg_giftregistry/item');
    parent::_construct();
  }
}</pre></div></li></ol></div><p>Let's go ahead and <a id="id197" class="indexterm"/>create the resource class:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">Model</code> folder in our module directory.</li><li class="listitem">Open the <code class="literal">Resource</code> folder.</li><li class="listitem">Create a new file named <code class="literal">Item.php</code> and copy the following content into the file located at <code class="literal">app/code/local/Mdg/Giftregistry/Model/Resource/Item.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Model_Resource_Item extends Mage_Core_Model_Resource_Db_Abstract
{
  public function _construct()
  {
    $this-&gt;_init('mdg_giftregistry/item', 'item_id');
  }
}</pre></div></li></ol></div><p>Finally, let's create <a id="id198" class="indexterm"/>the corresponding collection class:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">Model</code>/<code class="literal">Resource</code> folder in our module directory.</li><li class="listitem">Create an <code class="literal">Item</code> folder.</li><li class="listitem">Create a new file named <code class="literal">Item</code>/<code class="literal">Collection.php</code> and copy the following content into the file located at <code class="literal">app/code/local/Mdg/Giftregistry/Model/Resource/Item/Collection.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Model_Resource_Item_Collection extends Mage_Core_Model_Resource_Db_Collection_Abstract
{
  public function _construct()
  {
    $this-&gt;_init('mdg_giftregistry/item');
    parent::_construct();
  }
}</pre></div></li></ol></div><p>Our next step will be to create our <code class="literal">registry</code> entity. This is the core of our registry and is the model that ties everything together. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">Model</code> folder in our module directory.</li><li class="listitem">Create a new file named <code class="literal">Entity.php</code> and copy the following content into the file located at <code class="literal">app/code/local/Mdg/Giftregistry/Model/Entity.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Model_Entity extends Mage_Core_Model_Abstract
{
  public function __construct()
  {
    $this-&gt;_init('mdg_giftregistry/entity');
    parent::_construct();
  }
}</pre></div></li></ol></div><p>Let's go ahead and <a id="id199" class="indexterm"/>create the resource class:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">Model</code> folder in our module directory.</li><li class="listitem">Open the <code class="literal">Resource</code> folder.</li><li class="listitem">Create a new file named <code class="literal">Entity.php</code> and copy the following content into the file located at <code class="literal">app/code/local/Mdg/Giftregistry/Model/Resource/Entity.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Model_Resource_Entity extends Mage_Core_Model_Resource_Db_Abstract{
  public function _construct()
  {
    $this-&gt;_init('mdg_giftregistry/entity', 'entity_id');
  }
}</pre></div></li></ol></div><p>Finally, let's create the corresponding collection class:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">Model</code>/<code class="literal">Resource</code> folder in our module directory.</li><li class="listitem">Create a new folder named <code class="literal">Entity</code>.</li><li class="listitem">Create a new file named <code class="literal">Entity</code>/<code class="literal">Collection.php</code> and copy the following content into the file located at <code class="literal">app/code/local/Mdg/Giftregistry/Model/Resource/Entity/Collection.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Model_Resource_Entity_Collection extends Mage_Core_Model_Resource_Db_Collection_Abstract
{
  public function _construct()
  {
    $this-&gt;_init('mdg_giftregistry/entity');
    parent::_construct();
  }
}</pre></div></li></ol></div><p>So far, we haven't done more than blindly create new models by copying code and adding classes to our module. Now, let's test our newly created models.</p><p>In the previous version of this book, we were using <a id="id200" class="indexterm"/>
<span class="strong"><strong>Interactive Magento Console</strong></span> (<span class="strong"><strong>IMC</strong></span>) to test code on the fly. Nowadays, the community has built a much more powerful tool that not only allows us to test code interactively, but also to run common and useful commands right from the shell. This tool is called <a id="id201" class="indexterm"/>
<span class="strong"><strong>Netz98/n98-magerun</strong></span>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note12"/>Note</h3><p>This Netz98/n98-magerun tool<a id="id202" class="indexterm"/> can be downloaded at <a class="ulink" href="https://github.com/netz98/n98-magerun">https://github.com/netz98/n98-magerun</a>.</p></div></div><p>Let's fire up the <code class="literal">dev</code> console and try out the new models by running the following command in the root of our Magento installation:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ n98-magerun.php dev:console</strong></span>
</pre></div><p>The following code assumes you are running a Magento test installation<a id="id203" class="indexterm"/> with sample data:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We will start by loading the <code class="literal">customer</code> model:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php &gt; $customer = Mage::getModel('customer/customer')-&gt;load(1);</strong></span>
</pre></div></li><li class="listitem">Next, we need to instantiate a new registry object:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php &gt; $registry = Mage::getModel('mdg_giftregistry/entity');</strong></span>
</pre></div></li><li class="listitem">One handy function that is part of all Magento models is the <code class="literal">getData()</code> function, which returns an array of all the object attributes. Let's run this function on both the <code class="literal">registry</code> and <code class="literal">customer</code> objects, and compare the output:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php &gt; print_r($customer-&gt;getData());</strong></span>
<span class="strong"><strong>php &gt; print_r($registry-&gt;getData());</strong></span>
</pre></div></li><li class="listitem">You may notice that the customer has all the datasets for our John Doe example record, while the <code class="literal">registry</code> object returns a completely empty array. Let's change this by running the following code:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php &gt; $registry-&gt;setCustomerId($customer-&gt;getId());</strong></span>
<span class="strong"><strong>php &gt; $registry-&gt;setTypeId(1);</strong></span>
<span class="strong"><strong>php &gt; $registry-&gt;setWebsiteId(1);</strong></span>
<span class="strong"><strong>php &gt; $registry-&gt;setEventDate('2012-12-12');</strong></span>
<span class="strong"><strong>php &gt; $registry-&gt;setEventCountry('CA');</strong></span>
<span class="strong"><strong>php &gt; $registry-&gt;setEventLocation('Toronto');</strong></span>
</pre></div></li><li class="listitem">Now, let's try to print the <code class="literal">registry</code> data one more time by running the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php &gt; print_r($registry-&gt;getData());</strong></span>
</pre></div></li><li class="listitem">Finally, to make our changes permanent, we need to call the model's <code class="literal">save()</code> function:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php &gt; $registry-&gt;save();</strong></span>
</pre></div></li></ol></div><p>And oops! Something went wrong when saving the product. We got the following error in the console:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Fatal error: Call to a member function beginTransaction() on a non-object in …/app/code/core/Mage/Core/Model/Abstract.php on line 313</strong></span>
</pre></div><p>What happened? The <code class="literal">save()</code> function that is being called is part of the parent class <code class="literal">Mage_Core_Model_Resource_Abstract</code>, which in turn calls the abstract class' <code class="literal">save()</code> function, but we are missing a critical part of our <code class="literal">config.xml</code> file.</p><p>In order for Magento to <a id="id204" class="indexterm"/>properly identify which resource class to use, we need to specify the resource model class and the matching table for each entity. Let's go ahead and update our configuration file:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the extension <code class="literal">etc/</code> folder.</li><li class="listitem">Open <code class="literal">config.xml</code>.</li><li class="listitem">Update the <code class="literal">&lt;models&gt;</code> node located at <code class="literal">app/code/local/Mdg/Giftregistry/etc/config.xml</code> with the following code:<div class="informalexample"><pre class="programlisting">…
&lt;models&gt;
  &lt;mdg_giftregistry&gt;
    &lt;class&gt;Mdg_Giftregistry_Model&lt;/class&gt;
    &lt;resourceModel&gt;mdg_giftregistry_mysql4&lt;/resourceModel&gt;
  &lt;/mdg_giftregistry&gt;
  &lt;mdg_giftregistry_mysql4&gt;
    &lt;class&gt;Mdg_Giftregistry_Model_Mysql4&lt;/class&gt;
    &lt;entities&gt;
      &lt;entity&gt;
        &lt;table&gt;mdg_giftregistry_entity&lt;/table&gt;
      &lt;/entity&gt;
      &lt;item&gt;
        &lt;table&gt;mdg_giftregistry_item&lt;/table&gt;
      &lt;/item&gt;
      &lt;type&gt;
        &lt;table&gt;mdg_giftregistry_type&lt;/table&gt;
      &lt;/type&gt;
    &lt;/entities&gt;
  &lt;/mdg_giftregistry_mysql4&gt;
&lt;/models&gt;
…</pre></div></li></ol></div><p>Now, before we can actually save a product to the database, we have to create our database tables first. Next, we will learn how to use setup resources to create our table structure and set our default data.</p></div><div class="section" title="Setup resources"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec31"/>Setup resources</h2></div></div></div><p>Now that we<a id="id205" class="indexterm"/> have created our model code, we need to create setup resources in order to be able to save them. The setup resources will take care of creating the corresponding database tables. Now, we could just use straight <span class="strong"><strong>SQL</strong></span><a id="id206" class="indexterm"/> or a tool such as <span class="strong"><strong>phpmyadmin</strong></span><a id="id207" class="indexterm"/> to create all the tables. However, this is not the standard practice and by general rule, we should never modify the Magento database directly.</p><p>To achieve this, we will do the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Define a setup resource on our configuration file</li><li class="listitem" style="list-style-type: disc">Create a resource class</li><li class="listitem" style="list-style-type: disc">Create an installer script</li><li class="listitem" style="list-style-type: disc">Create a data script</li><li class="listitem" style="list-style-type: disc">Create an upgrade script</li></ul></div><div class="section" title="Defining a setup resource"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec01"/>Defining a setup resource</h3></div></div></div><p>When we first <a id="id208" class="indexterm"/>defined our configuration file, we defined a <code class="literal">&lt;resources&gt;</code> node, which is located at <code class="literal">app/code/local/Mdg/Giftregistry/etc/config.xml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;resources&gt;
  &lt;mdg_giftregistry_setup&gt;
    &lt;setup&gt;
      &lt;module&gt;Mdg_Giftregistry&lt;/module&gt;
    &lt;/setup&gt;
  &lt;/mdg_giftregistry_setup&gt;
&lt;/resources&gt;</pre></div><p>The first thing to notice is that <code class="literal">&lt;mdg_giftregistry_setup&gt;</code> is used as a unique identifier for our setup resource. The standard naming convention is <code class="literal">&lt;modulename_setup&gt;</code>
<span class="strong"><strong> </strong></span>and while it is not required, it is highly recommend to follow this naming convention. Creating this setup resource is not required for basic setup scripts and <code class="literal">Mage_Core_Model_Resource_Setup</code> can be used instead, but by creating our own setup class, we are planning ahead and giving ourselves more flexibility for future improvements.</p><p>Adding this resource node allows Magento to keep track of the versions and data of each of the extensions installed. We are going to use that functionality to our advantage and make an upgrade script to create the tables we need.</p></div><div class="section" title="Creating the upgrade script"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec02"/>Creating the upgrade script</h3></div></div></div><p>Our next step is to create an <a id="id209" class="indexterm"/>upgrade script. This script contains all the SQL code to create our tables. First, let's take another quick look at our <code class="literal">config.xml</code> file. If we remember, the first node defined before our <code class="literal">&lt;global&gt;</code> node was the <code class="literal">&lt;modules&gt;</code> node, which is located at<span class="emphasis"><em> </em></span>
<code class="literal">app/code/local/Mdg/Giftregistry/etc/config.xml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;modules&gt;
  &lt;Mdg_Giftregistry&gt;
    &lt;version&gt;0.2.0&lt;/version&gt;
  &lt;/Mdg_Giftregistry&gt;
&lt;/modules&gt;</pre></div><p>As we mentioned before, this node is required on all Magneto modules and is used to identify the current installed version of our module. This version number is used by Magento to identify which installation and upgrade scripts to run.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note13"/>Note</h3><p>
<span class="strong"><strong>A word on naming conventions</strong></span>: Since Magento 1.6, the setup script naming conventions have changed. Originally, the <code class="literal">mysql4-install-x.x.x.php</code> naming convention was used. It is currently deprecated but still supported.</p></div></div><p>Since Magento 1.6, the naming convention for the setup script has changed and now, developers can make use of three different script types:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Install</strong></span>: This is used <a id="id210" class="indexterm"/>when the module is first installed and no record of it exists on the <code class="literal">core_resource</code> table</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Upgrade</strong></span>: This is <a id="id211" class="indexterm"/>used if the version in the <code class="literal">core_resource</code> table is lower than the one in the <code class="literal">config.xml</code> file</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Data</strong></span>: This will<a id="id212" class="indexterm"/> run after the matching version install/upgrade script and is used to populate the tables with required data</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note14"/>Note</h3><p>Data scripts were introduced in Magento 1.6 and are stored under the data/directory directly under our module's root. They follow a slightly different convention to the install and upgrade scripts, by adding the prefix.</p></div></div><p>Let's continue creating our registry entity table in our installation script, which is located at <code class="literal">app/code/local/Mdg/Giftregistry/sql/mdg_giftregistry_setup/upgrade-0.2.0-0.2.1.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$installer = $this;
$installer-&gt;startSetup();
// Create the mdg_giftregistry/registry table
$tableName = $installer-&gt;getTable('mdg_giftregistry/entity');
// Check if the table already exists
if ($installer-&gt;getConnection()-&gt;isTableExists($tableName) != true) {
    $table = $installer-&gt;getConnection()
        -&gt;newTable($tableName)
        -&gt;addColumn('entity_id', Varien_Db_Ddl_Table::TYPE_INTEGER, null,
            array(
                'identity' =&gt; true,
                'unsigned' =&gt; true,
                'nullable' =&gt; false,
                'primary' =&gt; true,
            ),
            'Entity Id'
        )
        -&gt;addColumn('customer_id', Varien_Db_Ddl_Table::TYPE_INTEGER, null,
            array(
                'unsigned' =&gt; true,
                'nullable' =&gt; false,
                'default' =&gt; '0',
            ),
            'Customer Id'
        )
        -&gt;addColumn('type_id', Varien_Db_Ddl_Table::TYPE_SMALLINT, null,
            array(
                'unsigned' =&gt; true,
                'nullable' =&gt; false,
                'default' =&gt; '0',
            ),
            'Type Id'
        )
        -&gt;addColumn('website_id', Varien_Db_Ddl_Table::TYPE_SMALLINT, null,
            array(
                'unsigned' =&gt; true,
                'nullable' =&gt; false,
                'default' =&gt; '0',
            ),
            'Website Id'
        )
        -&gt;addColumn('event_name', Varien_Db_Ddl_Table::TYPE_TEXT, 255,
            array(),
            'Event Name'
        )
        -&gt;addColumn('event_date', Varien_Db_Ddl_Table::TYPE_DATE, null,
            array(),
            'Event Date'
        )
        -&gt;addColumn('event_country', Varien_Db_Ddl_Table::TYPE_TEXT, 3,
            array(),
            'Event Country'
        )
        -&gt;addColumn('event_location', Varien_Db_Ddl_Table::TYPE_TEXT, 255,
            array(),
            'Event Location'
        )
        -&gt;addColumn('created_at', Varien_Db_Ddl_Table::TYPE_TIMESTAMP, null,
            array(
                'nullable' =&gt; false,
            ),
            'Created At')
        -&gt;addIndex($installer- &gt;getIdxName('mdg_giftregistry/entity', array('customer_id')),
            array('customer_id'))
        -&gt;addIndex($installer- &gt;getIdxName('mdg_giftregistry/entity', 
        array('website_id')),
            array('website_id'))         -&gt;addIndex($installer- &gt;getIdxName('mdg_giftregistry/entity', array('type_id')),
            array('type_id'))
        -&gt;addForeignKey(
            $installer-&gt;getFkName(
                'mdg_giftregistry/entity',
                'customer_id',
                'customer/entity',
                'entity_id'
            ),
            'customer_id', $installer- &gt;getTable('customer/entity'), 'entity_id',
            Varien_Db_Ddl_Table::ACTION_CASCADE, Varien_Db_Ddl_Table::ACTION_CASCADE)
        -&gt;addForeignKey(
            $installer-&gt;getFkName(
                'mdg_giftregistry/entity',
                'website_id',
                'core/website',
                'website_id'
            ),
            'website_id', $installer-&gt;getTable('core/website'), 'website_id',
            Varien_Db_Ddl_Table::ACTION_CASCADE, Varien_Db_Ddl_Table::ACTION_CASCADE)
        -&gt;addForeignKey(
            $installer-&gt;getFkName(
                'mdg_giftregistry/entity',
                'type_id',
                'mdg_giftregistry/type',
                'type_id'
            ),
            'type_id', $installer- &gt;getTable('mdg_giftregistry/type'), 'type_id',
            Varien_Db_Ddl_Table::ACTION_CASCADE, Varien_Db_Ddl_Table::ACTION_CASCADE);

    $installer-&gt;getConnection()-&gt;createTable($table);
}
$installer-&gt;endSetup();</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note15"/>Note</h3><p>Please note that due to space constraints, we have not added the full installation script. You still need to add the installer code for the item and type tables. The full installation file and the code files can be downloaded directly at <a class="ulink" href="https://github.com/amacgregor/mdg_giftreg">https://github.com/amacgregor/mdg_giftreg</a>.</p></div></div><p>Now that <a id="id213" class="indexterm"/>might look like a lot of code, but it is only creating one of the tables. In order to make sense of it, let's break it down and see exactly what the code does.</p><p>The first thing to notice is that even if we are creating and setting database tables, we are not writing any SQL. The Magento ORM provides an adapter with the database. All the installation, upgrade, and data scripts inherit from <code class="literal">Mage_Core_Model_Resource_Setup</code>. Let's break down each of the functions being used in our installation script.</p><p>The first three <a id="id214" class="indexterm"/>lines of the script take off by instantiating both the <code class="literal">resource_setup</code> model and the connection. The rest of the script deals with setting up a new table instance and calls the following functions on it:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">addColumn</code>: This function is used to define each of the table columns and takes the following five parameters:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">name</code>: This is the name of the column</li><li class="listitem" style="list-style-type: disc"><code class="literal">type</code>: This is the data storage type (<code class="literal">int</code>, <code class="literal">varchar</code>, <code class="literal">text</code>, and so on)</li><li class="listitem" style="list-style-type: disc"><code class="literal">size</code>: This is the column's length</li><li class="listitem" style="list-style-type: disc"><code class="literal">options</code>: This is an array of additional options for data storage</li><li class="listitem" style="list-style-type: disc"><code class="literal">comment</code>: This is the column's description</li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">addIndex</code>: This function is used to define the indexes of a particular table and takes the following three parameters:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">index</code>: This is the index's name</li><li class="listitem" style="list-style-type: disc"><code class="literal">columns</code>: This can be a string with a single column name or an array with multiple ones</li><li class="listitem" style="list-style-type: disc"><code class="literal">options</code>: This is an array of additional options for data storage</li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">addForeginKey</code>: This function is used to define foreign key relationships and it takes the following six parameters:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">fkName</code>: This is the foreign key's name</li><li class="listitem" style="list-style-type: disc"><code class="literal">column</code>: This is the foreign key column's name</li><li class="listitem" style="list-style-type: disc"><code class="literal">refTable</code>: This is the reference table's name.</li><li class="listitem" style="list-style-type: disc"><code class="literal">refColumn</code>: This is the reference table column's name.</li><li class="listitem" style="list-style-type: disc"><code class="literal">onDelete</code>: This is the action to delete a row</li><li class="listitem" style="list-style-type: disc"><code class="literal">onUpdate</code>: This is the action to update a row</li></ul></div></li></ul></div><p>The code creating each of our tables is basically composed of these three functions. After each table definition, the following code is executed:</p><div class="informalexample"><pre class="programlisting">$installer-&gt;getConnection()-&gt;createTable($table);</pre></div><p>This code is telling our database adapter to convert our code into SQL and run it against the database. There is one important thing to notice. Instead of providing or hardcoding the database names, the following code is called:</p><div class="informalexample"><pre class="programlisting">$installer-&gt;getTable('mdg_giftregistry/entity')</pre></div><p>This is the table alias that we defined earlier inside our <code class="literal">config.xml</code> files. To finish our installer, we need to create a <code class="literal">newTable</code> instance for each of our entities. The data scripts can be used to populate our tables. In our case, this will come in handy to set up some base event types.</p><p>We will first need to create a data installation script under the data folder. As we mentioned before, the structure is very similar to the SQL folder, and the only difference is that we append the data prefix to the matching installation/upgrade script. Perform the following <a id="id215" class="indexterm"/>steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to the module data folder by navigating to <code class="literal">app/code/local/Mdg/Giftregistry/data/</code>.</li><li class="listitem">Create a new directory based on the resource. In this case, it would be <code class="literal">mdg_giftregistry_setup</code>.</li><li class="listitem">Under <code class="literal">mdg_giftregistry_setup</code>, create a file named <code class="literal">data-upgrade-0.2.0-0.2.1.php</code>.</li><li class="listitem">Copy the following code into the <code class="literal">data-upgrade-0.2.0-0.2.1.php</code> located at <code class="literal">app/code/local/Mdg/Giftregistry/data/mdg_giftregistry_setup/data-upgrade-0.2.0-0.2.1.php &lt;?php</code>:<div class="informalexample"><pre class="programlisting">$registryTypes = array(
    array(
        'code' =&gt; 'baby_shower',
        'name' =&gt; 'Baby Shower',
        'description' =&gt; 'Baby Shower',
        'store_id' =&gt; Mage_Core_Model_App::ADMIN_STORE_ID,
        'is_active' =&gt; 1,
    ),
    array(
        'code' =&gt; 'wedding',
        'name' =&gt; 'Wedding',
        'description' =&gt; 'Wedding',
        'store_id' =&gt; Mage_Core_Model_App::ADMIN_STORE_ID,
        'is_active' =&gt; 1,
    ),
    array(
        'code' =&gt; 'birthday',
        'name' =&gt; 'Birthday',
        'description' =&gt; 'Birthday',
        'store_id' =&gt; Mage_Core_Model_App::ADMIN_STORE_ID,
        'is_active' =&gt; 1,
    ),
);

foreach ($registryTypes as $data) {
    Mage::getModel('mdg_giftregistry/type')
        -&gt;addData($data)
        -&gt;setStoreId($data['store_id'])
        -&gt;save();
}</pre></div></li></ol></div><p>Let's take a closer look at the last conditional block in the <code class="literal">data-install-0.1.0.php</code> script:</p><div class="informalexample"><pre class="programlisting">foreach ($registryTypes as $data) {
    Mage::getModel('mdg_giftregistry/type')
        -&gt;addData($data)
        -&gt;setStoreId($data['store_id'])
        -&gt;save();
}</pre></div><p>Now, if we refresh<a id="id216" class="indexterm"/> our Magento installation, the error should be gone. If we take a closer look at the <code class="literal">mdg_giftregistry_type</code> table, we should see the following records:</p><div class="mediaobject"><img src="graphics/4195OS_03_03.jpg" alt="Creating the upgrade script"/></div><p>As we learned before, the installation and data scripts will run the first time our module is installed. However, what happens in our case when Magento already thinks our module is installed?</p><p>As the module is already registered in the <code class="literal">core_resource</code> table, the installation scripts will not be run again unless Magento detects a version change in the extension. This is great to handle multiple releases of an extension but not very practical for development purposes.</p><p>Fortunately, it is easy to trick Magento into running our extension installation scripts again. We only have to delete the corresponding entry in the <code class="literal">core_resource</code> table:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open your MySQL console. If you are using our Vagrant box, you can just open it by typing <code class="literal">mysql</code>.</li><li class="listitem">Once we are in the MySQL shell, we need to select our working database.</li><li class="listitem">Finally, we need to add the entry the <code class="literal">core_resource</code> table using the following query:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysql&gt; DELETE FROM core_resource WHERE code =  'mdg_giftregistry_setup'</strong></span>
</pre></div></li></ol></div></div></div><div class="section" title="What we have learned"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec32"/>What we have learned</h2></div></div></div><p>So far, we have learned the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To create the base directory structure for our Magento module</li><li class="listitem" style="list-style-type: disc">The role and importance of the configuration files</li><li class="listitem" style="list-style-type: disc">Creating models and setup resources</li><li class="listitem" style="list-style-type: disc">The role and order of installation, upgrade, and data scripts</li></ul></div></div></div>
<div class="section" title="Setting up our routes"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec27"/>Setting up our routes</h1></div></div></div><p>Now that we are capable <a id="id217" class="indexterm"/>of saving and manipulating the data by using our models, we need to provide a way for customers to interact with the actual gift registries. Our first step is to need to create valid routes or URLs for the frontend.</p><p>As are many things in Magento, this is controlled by the configuration file. A route will convert a URL into a valid controller, action, and method.</p><p>Open our <code class="literal">config.xml</code> file and insert the following code, located at <code class="literal">app/code/local/Mdg/Giftregistry/etc/config.xml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;config&gt;

  &lt;frontend&gt;
    &lt;routers&gt;
      &lt;mdg_giftregistry&gt;
        &lt;use&gt;standard&lt;/use&gt;
        &lt;args&gt;
          &lt;module&gt;Mdg_Giftregistry&lt;/module&gt;
          &lt;frontName&gt;giftregistry&lt;/frontName&gt;
        &lt;/args&gt;
      &lt;/mdg_giftregistry&gt;
    &lt;/routers&gt;   &lt;/frontend&gt;

&lt;/config&gt;</pre></div><p>Let's break down the configuration code we just added:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;frontend&gt;</code>: Previously, we added all the configurations inside the global scope. As we want our routes to only be available in the frontend, we need to declare our custom routes under the frontend scope.</li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;routers&gt;</code>: This is the container tag that holds the configuration for our custom routes.</li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;mdg_giftregistry&gt;</code>: The naming convention for this tag is to match the module name and is the unique identifier for our route.</li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;frontName&gt;</code>: As we learned in <a class="link" href="ch02.html" title="Chapter 2. ORM and Data Collections">Chapter 2</a>, <span class="emphasis"><em>ORM and Data Collections</em></span>, break down the URLs into the following sections: <code class="literal">http://localhost.com/frontName/actionControllerName/actionMethod/</code>.</li></ul></div><p>Once we have defined our route configuration, we need to create an actual controller to handle all the incoming requests.</p><div class="section" title="IndexController"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec33"/>IndexController</h2></div></div></div><p>Our first step is to create <a id="id218" class="indexterm"/>an <code class="literal">IndexController</code> under our module controllers <a id="id219" class="indexterm"/>directory. Magento will always try to load the <code class="literal">IndexController</code> if no controller name is specified, this is located at <code class="literal">app/code/local/Mdg/Giftregistry/controllers/IndexController.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_IndexController extends Mage_Core_Controller_Front_Action
{
     public function indexAction()
  {
    echo 'This is our test controller';
     }
}</pre></div><p>After creating our file, if we go to <code class="literal">http://localhost.com/giftregistry/index/index</code>, we should see a blank page with only the message <code class="literal">This is our test controller</code>. This is because we are not loading the layout. To properly load the layout of our customer controller, we need to change our action code to the following, which is located at <code class="literal">app/code/local/Mdg/Giftregistry/controllers/IndexController.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_IndexController extends Mage_Core_Controller_Front_Action
{
  public function indexAction()
  {
    $this-&gt;loadLayout();
    $this-&gt;renderLayout();
  }
}</pre></div><p>Before going into the details of what is happening in the controller action, let's create the rest of the controllers and corresponding actions.</p><p>We need a controller that takes care of the basic operations for customers so that they are able to create, manage, and delete their registries. Also, we require a <code class="literal">SearchController</code> so that family and friends can locate the matching gift registries. Finally, we require a <code class="literal">ViewController</code> to show the registry's details.</p><p>Our first step is to add the<a id="id220" class="indexterm"/> remaining actions to the<a id="id221" class="indexterm"/> <code class="literal">IndexController</code> located at <code class="literal">app/code/local/Mdg/Giftregistry/controllers/IndexController.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_IndexController extends Mage_Core_Controller_Front_Action
{
    public function indexAction()
    {
        $this-&gt;loadLayout();
        $this-&gt;renderLayout();
        return $this;
    }

    public function deleteAction()
    {
        $this-&gt;loadLayout();
        $this-&gt;renderLayout();
        return $this;
    }

    public function newAction()
    {
        $this-&gt;loadLayout();
        $this-&gt;renderLayout();
        return $this;
    }

    public function editAction()
    {
        $this-&gt;loadLayout();
        $this-&gt;renderLayout();
        return $this;
    }

    public function newPostAction()
    {
        $this-&gt;loadLayout();
        $this-&gt;renderLayout();
        return $this;
    }

    public function editPostAction()
    {
        $this-&gt;loadLayout();
        $this-&gt;renderLayout();
        return $this;
    }
}</pre></div><p>Before we start adding<a id="id222" class="indexterm"/> all the logic to the <code class="literal">IndexController</code>, we need <a id="id223" class="indexterm"/>to take an extra step to prevent customers who are not logged in from accessing the <code class="literal">giftregistry</code> functionality. The Magento Front Controller already has a very useful method for handling this; it's called the <code class="literal">preDispatch()</code> method that is executed before any other action in the controller.</p><p>Open your <code class="literal">IndexController.php</code> and add the following code to the beginning of the class located at <code class="literal">app/code/local/Mdg/Giftregistry/controllers/IndexController.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_IndexController extends Mage_Core_Controller_Front_Action
{
    public function preDispatch()
    {
        parent::preDispatch();
        if (!Mage::getSingleton('customer/session')- &gt;authenticate($this)) {
            $this-&gt;getResponse()- &gt;setRedirect(Mage::helper('customer')-&gt;getLoginUrl());
            $this-&gt;setFlag('', self::FLAG_NO_DISPATCH, true);
        }
    }</pre></div><p>Now, if we try to load <code class="literal">http://localhost.com/giftregistry/index/index</code>, we will be redirected to the login page, unless we are logged into the frontend.</p><p>Our next step is to add all the logic to each of the controller actions so that the controller can properly handle creation, update, and deletion.</p><p>The index, new, and edit actions are mostly used to load and render the layout so there is not much logic involved in the controller. The <code class="literal">newPostAction()</code>, <code class="literal">editPostAction()</code>, and the <code class="literal">deleteAction()</code> controllers, on the other hand, handle heavier and more complicated logic.</p><p>Let's get started with the <code class="literal">newPostAction()</code> controller. This action is used to handle the data received from the <code class="literal">newAction()</code> form:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">IndexController.php</code> file.</li><li class="listitem">The first thing we will add to the action is an <code class="literal">if</code> statement to check if the request is a <code class="literal">Post</code> request that we can retrieve by using the following code:<div class="informalexample"><pre class="programlisting">$this-&gt;getRequest()-&gt;isPost()</pre></div></li><li class="listitem">In addition to this, we<a id="id224" class="indexterm"/> also want to check if the request has actual <a id="id225" class="indexterm"/>data. To do this, we can use the following code:<div class="informalexample"><pre class="programlisting">$this-&gt;getRequest()-&gt;getParams()</pre></div></li></ol></div><p>Once we have validated that the request is a proper request, and while we are receiving data, we need to actually create a gift registry. To do this, we must add a new function inside our registry model:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the registry <code class="literal">Entity</code> model.</li><li class="listitem">Create a new function named <code class="literal">updateRegistryData()</code> and make sure the function takes two parameters, <code class="literal">$customer</code> and <code class="literal">$data</code>.</li><li class="listitem">Add the following code inside this function located at <code class="literal">app/code/local/Mdg/Giftregistry/Model/Entity.php</code>:<div class="informalexample"><pre class="programlisting">public function updateRegistryData(Mage_Customer_Model_Customer $customer, $data)
{
    try{
        if(!empty($data))
        {
            $this-&gt;setCustomerId($customer-&gt;getId());
            $this-&gt;setWebsiteId($customer-&gt;getWebsiteId());
            $this-&gt;setTypeId($data['type_id']);
            $this-&gt;setEventName($data['event_name']);
            $this-&gt;setEventDate($data['event_date']);
            $this-&gt;setEventCountry($data['event_country']);
            $this- &gt;setEventLocation($data['event_location']);
        }else{
            throw new Exception("Error Processing Request: Insufficient Data Provided");
        }
    } catch (Exception $e){
        Mage::logException($e);
    }
    return $this;
}</pre></div></li></ol></div><p>This function will help us out by adding the form data into the current instance of the registry object, which means we need to create one inside our controller. Let's put the code for our controller together, which is located at <code class="literal">app/code/local/Mdg/Giftregistry/controllers/IndexController.php</code>:</p><div class="informalexample"><pre class="programlisting">public function newPostAction()
{
    try {
        $data = $this-&gt;getRequest()-&gt;getParams();
        $registry = Mage::getModel('mdg_giftregistry/entity');
        $customer = Mage::getSingleton('customer/session')- &gt;getCustomer();

        if($this-&gt;getRequest()-&gt;getPost() &amp;&amp; !empty($data)) {
            $registry-&gt;updateRegistryData($customer, $data);
            $registry-&gt;save();
            $successMessage = Mage::helper('mdg_giftregistry')- &gt;__('Registry Successfully Created');
            Mage::getSingleton('core/session')- &gt;addSuccess($successMessage);
        }else{
            throw new Exception("Insufficient Data provided");
        }
    } catch (Mage_Core_Exception $e) {
        Mage::getSingleton('core/session')-&gt;addError($e- &gt;getMessage());
        $this-&gt;_redirect('*/*/');
    }
    $this-&gt;_redirect('*/*/');
}</pre></div><p>We have created a very <a id="id226" class="indexterm"/>basic controller action that will handle the registry creation <a id="id227" class="indexterm"/>and most of the possible exceptions.</p><p>Let's continue by creating the <code class="literal">editPostAction()</code> controller. This action is very similar to the <code class="literal">newPostAction()</code> controller. The main difference is that, in the case of the <code class="literal">editPostAction()</code> controller, we are working with an already existing registry record so we will need to add some validation before setting the data.</p><p>Let's take a closer look at the action code which is located at<span class="emphasis"><em> </em></span>
<code class="literal">app/code/local/Mdg/Giftregistry/controllers/IndexController.php</code>:</p><div class="informalexample"><pre class="programlisting">public function editPostAction()
{
    try {
        $data = $this-&gt;getRequest()-&gt;getParams();
        $registry = Mage::getModel('mdg_giftregistry/entity');
        $customer = Mage::getSingleton('customer/session')- &gt;getCustomer();

        if($this-&gt;getRequest()-&gt;getPosts() &amp;&amp; !empty($data)) {
            $registry-&gt;load($data['registry_id']);
            if($registry) {
                $registry-&gt;updateRegistryData($customer, $data);
                $registry-&gt;save();
                $successMessage =  Mage::helper('mdg_giftregistry')-&gt;__('Registry Successfully Saved');
                Mage::getSingleton('core/session')- &gt;addSuccess($successMessage);
            }else {
                throw new Exception("Invalid Registry Specified");
            }
        }else {
            throw new Exception("Insufficient Data provided");
        }
    } catch (Mage_Core_Exception $e) {
        Mage::getSingleton('core/session')-&gt;addError($e- &gt;getMessage());
        $this-&gt;_redirect('*/*/');
    }
    $this-&gt;_redirect('*/*/');
}</pre></div><p>As we can see, this<a id="id228" class="indexterm"/> code is pretty much the same as our <code class="literal">newPostAction()</code> controller,<a id="id229" class="indexterm"/> with the critical distinction that it tries to load an existing registry before updating the data.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note16"/>Note</h3><p>
<span class="strong"><strong>Challenge</strong></span>: As the code between <code class="literal">editPostAction()</code> and <code class="literal">newPostAction()</code> are very similar, try combining both into a single post action that can be reused. To see the answer with the complete code and full breakdown, visit <a class="ulink" href="http://www.magedevguide.com/challenge/chapter3/3">http://www.magedevguide.com/challenge/chapter3/3</a>.</p></div></div><p>To finalize the <code class="literal">IndexController</code>, we need to add an action that allows us to delete a specific registry record. For this, we will use the <code class="literal">deleteAction()</code> controller.</p><p>Thanks to the Magento <span class="strong"><strong>Object Relation Mapping</strong></span> (<span class="strong"><strong>ORM</strong></span>)<a id="id230" class="indexterm"/> system, this process is really simple. Magento models inherit the <code class="literal">delete</code> function, which, as the name implies, will simply delete that specific model instance.</p><p>Inside your <code class="literal">IndexController</code>, add the following code, which is located at <code class="literal">app/code/local/Mdg/Giftregistry/controllers/IndexController.php</code>:</p><div class="informalexample"><pre class="programlisting">public function deleteAction()
{
    try {
        $registryId = $this-&gt;getRequest()- &gt;getParam('registry_id');
        if($registryId &amp;&amp; $this-&gt;getRequest()-&gt;getPost()){
            if($registry = Mage::getModel('mdg_giftregistry/entity')- &gt;load($registryId))
            {
                $registry-&gt;delete();
                $successMessage =  Mage::helper('mdg_giftregistry')-&gt;__('Gift registry has been succesfully deleted.');
                Mage::getSingleton('core/session')- &gt;addSuccess($successMessage);
            }else{
                throw new Exception("There was a problem deleting the registry");
            }
        }
    } catch (Exception $e) {
        Mage::getSingleton('core/session')-&gt;addError($e- &gt;getMessage());
        $this-&gt;_redirect('*/*/');
    }
}</pre></div><p>The important actions to <a id="id231" class="indexterm"/>notice in<a id="id232" class="indexterm"/> our delete controller are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We check for the right type of request in our action.</li><li class="listitem">We instantiate the registry object and verify if it is a valid one.</li><li class="listitem">Finally, we call the <code class="literal">delete()</code> function on the registry instance.</li></ol></div><p>You may notice by now that as we have made a critical omission, there is no way for us to add an actual product to our cart.</p><p>We will skip that particular action for now and create it after we have a better understanding of the blocks and layouts involved and how to interact with our custom controllers.</p></div><div class="section" title="SearchController"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec34"/>SearchController</h2></div></div></div><p>Now that we have a <a id="id233" class="indexterm"/>working <code class="literal">IndexController</code> that will handle most of the logic to <a id="id234" class="indexterm"/>modify actual registries, using the following steps, we will create the next controller, <code class="literal">SearchController</code>:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new controller under the <code class="literal">controllers</code> directory with the name <code class="literal">SearchController</code>.</li><li class="listitem">Copy the following code into the <code class="literal">SearchController.php</code> file located at<span class="emphasis"><em> </em></span><code class="literal">app/code/local/Mdg/Giftregistry/controllers/SearchController.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_SearchController extends Mage_Core_Controller_Front_Action
{
    public function indexAction()
    {
        $this-&gt;loadLayout();
        $this-&gt;renderLayout();
        return $this;
    }
    public function resultsAction()
    {
        $this-&gt;loadLayout();
        $this-&gt;renderLayout();
        return $this;
    }
}</pre></div></li></ol></div><p>We will leave our <code class="literal">indexAction()</code> as is for now and focus on the logic involved in <code class="literal">resultsAction()</code>, which will be taking the search parameters and loading a registry collection.</p><p>Let's take a look at the complete action code and break it down, this is located at <code class="literal">app/code/local/Mdg/Giftregistry/controllers/SearchController.php</code>:</p><div class="informalexample"><pre class="programlisting">public function resultsAction()
{
    $this-&gt;loadLayout();
    if ($searchParams = $this-&gt;getRequest()- &gt;getParam('search_params')) {
        $results = Mage::getModel('mdg_giftregistry/entity')- &gt;getCollection();
        if($searchParams['type']){
            $results-&gt;addFieldToFilter('type_id', $searchParams['type']);
        }
        if($searchParams['date']){
            $results-&gt;addFieldToFilter('event_date', $searchParams['date']);
        }
        if($searchParams['location']){
            $results-&gt;addFieldToFilter('event_location', $searchParams['location']);
        }
        $this-&gt;getLayout()- &gt;getBlock('mdg_giftregistry.search.results')
            -&gt;setResults($results);
    }
    $this-&gt;renderLayout();
    return $this;
}</pre></div><p>As with the previous <a id="id235" class="indexterm"/>actions, we are taking the request parameters, but in this <a id="id236" class="indexterm"/>particular case, we load a gift registry collection and apply a field filter for each of the available fields. One thing that stands out is that this is the first time we are interacting with the layout directly from a Magento controller:</p><div class="informalexample"><pre class="programlisting">$this-&gt;getLayout()-&gt;getBlock('mdg_giftregistry.search.results')
        -&gt;setResults($results);</pre></div><p>What we are doing here is making the loaded registry collection available to that particular block instance.</p></div><div class="section" title="ViewController"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec35"/>ViewController</h2></div></div></div><p>Finally, we need a<a id="id237" class="indexterm"/> controller that <a id="id238" class="indexterm"/>allows the display of registry details regardless of whether a customer is logged in or not:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new controller under the controllers directory with the name <code class="literal">ViewController</code>.</li><li class="listitem">Open the controller that we just created and use the following placeholder code which is located at<span class="emphasis"><em> </em></span><code class="literal">app/code/local/Mdg/Giftregistry/controllers/ViewController.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_ViewController extends Mage_Core_Controller_Front_Action
{
    public function viewAction()
    {
        $registryId = $this-&gt;getRequest()- &gt;getParam('registry_id');
        if($registryId){
            $entity = Mage::getModel('mdg_giftregistry/entity');
            if($entity-&gt;load($registryId))
            {
                Mage::register('loaded_registry', $entity);
                $this-&gt;loadLayout();
                $this- &gt;_initLayoutMessages('customer/session');
                $this-&gt;renderLayout();
                return $this;
            } else {
                $this-&gt;_forward('noroute');
                return $this;
            }
        }
    }
}</pre></div></li></ol></div><p>So here, we are using a new function named <code class="literal">Mage::register()</code>, which sets a global variable that we can retrieve later into the application flow by any method. This function is part of the Magento registry pattern, which comprises the following three functions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Mage::register()</code>: This is used to set global variables</li><li class="listitem" style="list-style-type: disc"><code class="literal">Mage::unregister()</code>: This is used to unset global variables</li><li class="listitem" style="list-style-type: disc"><code class="literal">Mage::registry()</code>: This is used to retrieve global variables</li></ul></div><p>We are using the registry<a id="id239" class="indexterm"/> function to provide access to the <a id="id240" class="indexterm"/>registry entity later down the application flow, and doing so in this particular case, to the view block that we will be creating next.</p></div></div>
<div class="section" title="Blocks and layouts"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec28"/>Blocks and layouts</h1></div></div></div><p>As we learned in <a class="link" href="ch02.html" title="Chapter 2. ORM and Data Collections">Chapter 2</a>, <span class="emphasis"><em>ORM and Data Collections</em></span>, Magento separates its view layer into<a id="id241" class="indexterm"/> blocks, templates, and<a id="id242" class="indexterm"/> layout files. Blocks are objects that handle part of the logic. Templates are <code class="literal">.phtml</code> files that are a mix of HTML and PHP code. Layout files are XML files that control the position of the blocks.</p><p>Each module has its own layout file that is in charge of updating that specific module layout. We need to start by creating a layout file for our module:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to <code class="literal">app/design/frontend/base/default/layout/</code>.</li><li class="listitem">Create a file named <code class="literal">mdg_giftregistry.xml</code>.</li><li class="listitem">Add the following code located at <code class="literal">app/design/frontend/base/default/layout/mdg_giftregistry.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;layout version="0.1.0"&gt;
  &lt;mdg_giftregistry_index_index&gt;
  &lt;/mdg_giftregistry_index_index&gt;

  &lt;mdg_giftregistry_index_new&gt;
  &lt;/mdg_giftregistry_index_new&gt;

  &lt;mdg_giftregistry_index_edit&gt;
  &lt;/mdg_giftregistry_index_edit&gt;

  &lt;mdg_giftregistry_view_view&gt;
  &lt;/mdg_giftregistry_view_view&gt;

  &lt;mdg_giftregistry_search_index&gt;
  &lt;/mdg_giftregistry_search_index&gt;

  &lt;mdg_giftregistry_search_results&gt;
  &lt;/mdg_giftregistry_search_results&gt;
&lt;/layout&gt;</pre></div></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note17"/>Note</h3><p>By adding our templates and layouts to the base/default theme, we'll make our templates and layouts available to all stores and themes.</p></div></div><p>If we take a closer <a id="id243" class="indexterm"/>look at the XML we just pasted, we can see that we have a default XML tag <a id="id244" class="indexterm"/>and several sets of tags. As we mentioned before, Magento routes are formed by a frontend name, a controller, and an action.</p><p>Each of the XML tags in the layout file represents one of our controllers and actions. For example, <code class="literal">&lt;giftregistry_index_index&gt;</code> will control the layout of our <code class="literal">IndexController</code> index action. Magento assigns each page a unique handle.</p><p>In order for Magento to recognize our layout file, we need to declare the layout file inside the <code class="literal">config.xml</code> file:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the extension <code class="literal">etc/</code> folder.</li><li class="listitem">Open <code class="literal">config.xml</code>.</li><li class="listitem">Add the following code inside the <code class="literal">&lt;frontend&gt;</code> node, which is located at <code class="literal">app/design/frontend/base/default/layout/mdg_giftregistry.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;frontend&gt;
   &lt;layout&gt;
       &lt;updates&gt;
           &lt;mdg_giftregistry module="mdg_giftregistry"&gt;
               &lt;file&gt;mdg_giftregistry.xml&lt;/file&gt;
           &lt;/mdg_giftregistry&gt;
       &lt;/updates&gt;
   &lt;/layout&gt;
   
&lt;/frontend&gt;</pre></div></li></ol></div><div class="section" title="IndexController blocks and views"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec36"/>IndexController blocks and views</h2></div></div></div><p>As we did before, we will start by <a id="id245" class="indexterm"/>building the <code class="literal">IndexController</code>. Let's define which <a id="id246" class="indexterm"/>templates and blocks we need to define for each of the actions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Index</code>: This is a list of the current customer available registries</li><li class="listitem" style="list-style-type: disc"><code class="literal">New</code>: This is used if we need a new form to capture the registry information</li><li class="listitem" style="list-style-type: disc"><code class="literal">Edit</code>: This loads a specific registry data and loads them in the a form</li></ul></div><p>For the index action, we need to create a new block named listed while the <span class="strong"><strong>New</strong></span> and <span class="strong"><strong>Edit</strong></span> actions can share their template form:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's start by creating the registry's <code class="literal">List</code> block.</li><li class="listitem">Navigate to <code class="literal">app/code/local/Mdg/Giftregistry/Block/</code>.</li><li class="listitem">Create a file named <code class="literal">List.php</code>.</li><li class="listitem">Copy the following code which is located at <code class="literal">app/code/local/Mdg/Giftregistry/Block/List.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Block_List extends Mage_Core_Block_Template
{
    public function getCustomerRegistries()
    {
        $collection = null;
        $currentCustomer = Mage::getSingleton('customer/session')- &gt;getCustomer();
        if($currentCustomer)
        {
            $collection = Mage::getModel('mdg_giftregistry/entity')- &gt;getCollection()
                -&gt;addFieldToFilter('customer_id', $currentCustomer-&gt;getId());
        }
        return $collection;
    }
}</pre></div></li></ol></div><p>The previous code declares the <code class="literal">list</code> block that will be used in the <code class="literal">IndexController</code>. The blocks declares <code class="literal">getCustomerRegistries()</code>, which will check for the current customer and try to retrieve a collection of registries based on that customer.</p><p>Now that we have created<a id="id247" class="indexterm"/> a new block, we need to add it to our layout XML file:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">mdg_giftregistry.xml</code> file.</li><li class="listitem">Add the following code inside the <code class="literal">&lt;mdg_gifregistry_index_index&gt;</code> file located at <code class="literal">app/design/frontend/base/default/layout/mdg_giftregistry.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;reference name="content"&gt;
    &lt;block name="giftregistry.list" type="mdg_giftregistry/list" template="mdg/list.phtml" as="giftregistry_list"/&gt;
&lt;/reference&gt;</pre></div></li></ol></div><p>In the layout, we declare our block. Inside that declaration, we set the block name's template and type. If we try loading the <code class="literal">IndexController</code> page right now, because we have not created our template file, we should see an error about the missing template.</p><p>Let's create the <a id="id248" class="indexterm"/>template file:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to <code class="literal">design/frontend/base/default/template/</code>.</li><li class="listitem">Create the <code class="literal">mdg/</code> folder.</li><li class="listitem">Inside that folder, create a file named <code class="literal">list.phtml</code>, located at <code class="literal">app/design/frontend/base/default/template/mdg/list.phtml</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
$_collection = $this-&gt;getCustomerRegistries();
?&gt;
&lt;div class="customer-list"&gt;
    &lt;ul&gt;
        &lt;?php foreach($_collection as $registry): ?&gt;
            &lt;li&gt;
                &lt;h3&gt;&lt;?php echo $registry-&gt;getEventName(); ?&gt;&lt;/h3&gt;
                &lt;p&gt;&lt;strong&gt;&lt;?php echo $this-&gt;__('Event Date:') ?&gt; &lt;?php echo $registry- &gt;getEventDate(); ?&gt;&lt;/strong&gt;&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;&lt;?php echo $this-&gt;__('Event Location:') ?&gt; &lt;?php echo $registry- &gt;getEventLocation(); ?&gt;&lt;/strong&gt;&lt;/p&gt;
                &lt;a href="&lt;?php echo $this- &gt;getUrl('giftregistry/view/view', array('_query' =&gt; array('registry_id' =&gt; $registry-&gt;getEntityId()))) ?&gt;"&gt;
                    &lt;?php echo $this-&gt;__('View Registry') ?&gt;
                &lt;/a&gt;
            &lt;/li&gt;
        &lt;?php endforeach; ?&gt;
    &lt;/ul&gt;
&lt;/div&gt;</pre></div></li></ol></div><p>This is the first<a id="id249" class="indexterm"/> time we generate a <code class="literal">.phtml</code> file. As we mentioned <a id="id250" class="indexterm"/>before, <code class="literal">.phtml</code> files are just a combination of PHP and HTML code.</p><p>In the case of <code class="literal">list.phtml</code>, the first thing we are doing is loading a collection by calling the <code class="literal">getCustomerRegistries()</code> method. One thing to notice is that we are actually calling <code class="literal">$this-&gt;getCustomerRegistries()</code>. Each template is assigned to a specific block.</p><p>We are missing a few important things:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If there are no registries for the current customer, we would only display an empty unordered list</li><li class="listitem" style="list-style-type: disc">There is no link to delete or edit a specific registry</li></ul></div><p>One quick way to check if the collection has registries is to call the <code class="literal">count</code> function and display an error message if the collection is actually empty which is located at<span class="emphasis"><em> </em></span>
<code class="literal">app/design/frontend/base/default/template/mdg/list.phtml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
    $_collection = $this-&gt;getCustomerRegistries();
?&gt;
&lt;div class="customer-list"&gt;
    &lt;?php if(!$_collection-&gt;count()): ?&gt;
        &lt;h2&gt;&lt;?php echo $this-&gt;__('You have no registries.') ?&gt;&lt;/h2&gt;
        &lt;a href="&lt;?php echo $this- &gt;getUrl('giftregistry/index/new') ?&gt;"&gt;
            &lt;?php echo $this-&gt;__('Click Here to create a new Gift Registry') ?&gt;
        &lt;/a&gt;
    &lt;?php else: ?&gt;
        &lt;ul&gt;
            &lt;?php foreach($_collection as $registry): ?&gt;
                &lt;li&gt;
                    &lt;h3&gt;&lt;?php echo $registry-&gt;getEventName(); ?&gt;&lt;/h3&gt;
                    &lt;p&gt;&lt;strong&gt;&lt;?php echo $this-&gt;__('Event Date:') ?&gt; &lt;?php echo $registry-&gt;getEventDate(); ?&gt;&lt;/strong&gt;&lt;/p&gt;
                    &lt;p&gt;&lt;strong&gt;&lt;?php echo $this-&gt;__('Event Location:') ?&gt; &lt;?php echo $registry- 
                    &gt;getEventLocation(); ?&gt;&lt;/strong&gt;&lt;/p&gt;
                    &lt;a href="&lt;?php echo $this- &gt;getUrl('giftregistry/view/view', array('_query' =&gt; array('registry_id' =&gt; $registry-&gt;getEntityId()))) ?&gt;"&gt;
                        &lt;?php echo $this-&gt;__('View Registry') ?&gt;
                    &lt;/a&gt;
                    &lt;a href="&lt;?php echo $this- &gt;getUrl('giftregistry/index/edit', array('_query' =&gt; array('registry_id' =&gt; $registry-&gt;getEntityId()))) ?&gt;"&gt;
                        &lt;?php echo $this-&gt;__('Edit Registry') ?&gt;
                    &lt;/a&gt;
                    &lt;a href="&lt;?php echo $this- &gt;getUrl('giftregistry/index/delete', array('_query' =&gt; array('registry_id' =&gt; $registry-&gt;getEntityId()))) ?&gt;"&gt;
                        &lt;?php echo $this-&gt;__('Delete Registry') ?&gt;
                    &lt;/a&gt;
                &lt;/li&gt;             &lt;?php endforeach; ?&gt;
        &lt;/ul&gt;
    &lt;?php endif; ?&gt;
&lt;/div&gt;</pre></div><p>We have added a <a id="id251" class="indexterm"/>new <code class="literal">if</code> statement to check that the collection count is not<a id="id252" class="indexterm"/> empty and link it to the <code class="literal">IndexController</code> edit action. Finally, if there are no registries to show, we are displaying an error message linking to <code class="literal">newAction</code>.</p><p>Let's continue by adding the block and templates for the new action:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">mdg_giftregistry.xml</code> layout file.</li><li class="listitem">Add the following code inside the <code class="literal">&lt;mdg_gifregistry_index_new&gt;</code> node located at<span class="emphasis"><em> </em></span><code class="literal">app/design/frontend/base/default/layout/mdg_giftregistry.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;reference name="content"&gt;
    &lt;block name="giftregistry.new" type="core/template" template="mdg/new.phtml" as="giftregistry_new"/&gt;
&lt;/reference&gt;</pre></div></li></ol></div><p>As we are just displaying a form to post the registry information to <code class="literal">newPostAction()</code>, we<a id="id253" class="indexterm"/> are just creating a core/template block with <a id="id254" class="indexterm"/>the custom template file that will contain the form code. Our template file is located at<span class="emphasis"><em> </em></span>
<code class="literal">app/design/frontend/base/default/template/mdg/new.phtml</code> and will look like this:</p><div class="informalexample"><pre class="programlisting">&lt;?php $helper = Mage::helper('mdg_giftregistry'); ?&gt;
&lt;form action="&lt;?php echo $this- &gt;getUrl('giftregistry/index/newPost/') ?&gt;" method="post" id="form-validate"&gt;
    &lt;fieldset&gt;
        &lt;?php echo $this-&gt;getBlockHtml('formkey')?&gt;
        &lt;ul class="form-list"&gt;
            &lt;li&gt;
                &lt;label for="type_id"&gt;&lt;?php echo $this-&gt;__('Event type') ?&gt;&lt;/label&gt;
                &lt;select name="type_id" id="type_id"&gt;
                    &lt;?php foreach($helper-&gt;getEventTypes() as $type): ?&gt;
                        &lt;option id="&lt;?php echo $type-&gt;getTypeId(); ?&gt;" value="&lt;?php echo $type-&gt;getCode(); ?&gt;"&gt;
                            &lt;?php echo $type-&gt;getName(); ?&gt;
                        &lt;/option&gt;
                    &lt;?php endforeach; ?&gt;
                &lt;/select&gt;
            &lt;/li&gt;
            &lt;li class="field"&gt;
                &lt;input type="text" name="event_name" id="event_name" value="" title="Event Name"/&gt;
                &lt;label class="giftreg" for="event_name"&gt;&lt;?php echo $this-&gt;__('Event Name') ?&gt;&lt;/label&gt;
            &lt;/li&gt;
            &lt;li class="field"&gt;
                &lt;input type="text" name="event_location" id="event_location" value="" title="Event Location"/&gt;
                &lt;label class="giftreg" for="event_location"&gt;&lt;?php echo $this-&gt;__('Event Location') ?&gt;&lt;/label&gt;
            &lt;/li&gt;
            &lt;li class="field"&gt;
                &lt;input type="text" name="event_country" id="event_country" value="" title="Event Country"/&gt;
                &lt;label class="giftreg" for="event_country"&gt;&lt;?php echo $this-&gt;__('Event Country') ?&gt;&lt;/label&gt;
            &lt;/li&gt;
        &lt;/ul&gt;
        &lt;div class="buttons-set"&gt;
            &lt;button type="submit" title="Save" class="button"&gt;
                &lt;span&gt;
                    &lt;span&gt;&lt;?php echo $this-&gt;__('Save') ?&gt;&lt;/span&gt;
                &lt;/span&gt;
            &lt;/button&gt;
        &lt;/div&gt;
    &lt;/fieldset&gt;
&lt;/form&gt;
&lt;script type="text/javascript"&gt;
    //&lt;![CDATA[
    var dataForm = new VarienForm('form-validate', true);
    //]]&gt;
&lt;/script&gt;</pre></div><p>So we are doing <a id="id255" class="indexterm"/>something new here, we are calling a helper. A <a id="id256" class="indexterm"/>helper is a class that contains methods that can be reused from blocks, templates, controllers, and so on. In our case, we are creating a helper that will retrieve all the available registry types:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to <code class="literal">app/code/local/Mdg/Giftregistry/Helper</code>.</li><li class="listitem">Open the <code class="literal">Data.php</code> class.</li><li class="listitem">Add the following code to it, which is located at<span class="emphasis"><em> </em></span><code class="literal">app/code/local/Mdg/Giftregistry/Helper/Data.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Helper_Data extends Mage_Core_Helper_Abstract {

public function getEventTypes()
    {
        $collection = Mage::getModel('mdg_giftregistry/type')- &gt;getCollection();
        return $collection;
    }
}</pre></div></li></ol></div><p>Finally, we need to set up the <code class="literal">edit</code> template. The edit template will be exactly the same as the <code class="literal">new</code> template but with one major difference. We will check for the existence of a loaded registry and pre-populate the values of our fields in the <code class="literal">edit</code> template which is located at<span class="emphasis"><em> </em></span>
<code class="literal">app/design/frontend/base/default/template/mdg/edit.phtml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
    $helper = Mage::helper('mdg_giftregistry');
    $loadedRegistry = Mage::getSingleton('customer/session')- &gt;getLoadedRegistry();
?&gt;
&lt;?php if($loadedRegistry): ?&gt;
    &lt;form action="&lt;?php echo $this- &gt;getUrl('giftregistry/index/editPost/') ?&gt;" method="post" id="form-validate"&gt;
        &lt;fieldset&gt;
            &lt;?php echo $this-&gt;getBlockHtml('formkey')?&gt;
            &lt;input type="hidden" id="type_id" value="&lt;?php echo $loadedRegistry-&gt;getTypeId(); ?&gt;" /&gt;
            &lt;ul class="form-list"&gt;
                &lt;li class="field"&gt;
                    &lt;label class="giftreg" for="event_name"&gt;&lt;?php echo $this-&gt;__('Event Name') ?&gt;&lt;/label&gt;
                    &lt;input type="text" name="event_name" id="event_name" value="&lt;?php echo $loadedRegistry-&gt;getEventName(); ?&gt;" title="Event Name"/&gt;
                &lt;/li&gt;
                &lt;li class="field"&gt;
                    &lt;label class="giftreg" for="event_location"&gt;&lt;?php echo $this- &gt;__('Event Location') ?&gt;&lt;/label&gt;
                    &lt;input type="text" name="event_location" id="event_location" value="&lt;?php echo $loadedRegistry-&gt;getEventLocation(); ?&gt;" title="Event Location"/&gt;
                &lt;/li&gt;
                &lt;li class="field"&gt;
                    &lt;label class="giftreg" for="event_country"&gt;&lt;?php echo $this- &gt;__('Event Country') ?&gt;&lt;/label&gt;
                    &lt;input type="text" name="event_country" id="event_country" value="&lt;?php echo $loadedRegistry-&gt;getEventCountry(); ?&gt;" title="Event Country"/&gt;
                &lt;/li&gt;
            &lt;/ul&gt;
            &lt;div class="buttons-set"&gt;
                &lt;button type="submit" title="Save" class="button"&gt;
                    &lt;span&gt;
                        &lt;span&gt;&lt;?php echo $this-&gt;__('Save') ?&gt;&lt;/span&gt;
                    &lt;/span&gt;
                &lt;/button&gt;
            &lt;/div&gt;
        &lt;/fieldset&gt;
    &lt;/form&gt;
    &lt;script type="text/javascript"&gt;
        //&lt;![CDATA[
        var dataForm = new VarienForm('form-validate', true);
        //]]&gt;
    &lt;/script&gt;
&lt;?php else: ?&gt;
    &lt;h2&gt;&lt;?php echo $this-&gt;__('There was a problem loading the registry') ?&gt;&lt;/h2&gt;
&lt;?php endif; ?&gt;</pre></div><p>Let's continue<a id="id257" class="indexterm"/> by adding the blocks and templates for the <a id="id258" class="indexterm"/>edit action.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">mdg_giftregistry.xml</code> layout file.</li><li class="listitem">Add the following code inside the <code class="literal">&lt;mdg_gifregistry_index_edit&gt;</code> node located at <code class="literal">app/design/frontend/base/default/layout/mdg_giftregistry.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;reference name="content"&gt;
    &lt;block name="giftregistry.edit" type="core/template" template="mdg/edit.phtml" as="giftregistry_edit"/&gt;
&lt;/reference&gt;</pre></div></li></ol></div><p>Once this is set, we can try creating a couple of test registries and modifying their properties.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note18"/>Note</h3><p>
<span class="strong"><strong>Challenge</strong></span>: As with the controller, the edit and new form can be combined into a single reusable form. To see the answer with the complete code and full breakdown, visit <a class="ulink" href="http://www.magedevguide.com/challenge/chapter3/4">http://www.magedevguide.com/challenge/chapter3/4</a>.</p></div></div></div><div class="section" title="SearchController blocks and views"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec37"/>SearchController blocks and views</h2></div></div></div><p>For our <code class="literal">SearchController</code>, we <a id="id259" class="indexterm"/>need a search template for our index, and for the<a id="id260" class="indexterm"/> results, we can actually reuse the registry list template simply by making a change to our controller:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">template</code> folder.</li><li class="listitem">Create a file named <code class="literal">search.phtml</code>.</li><li class="listitem">Add the following code located at <code class="literal">app/design/frontend/base/default/template/mdg/search.phtml</code>:<div class="informalexample"><pre class="programlisting">&lt;?php $helper = Mage::helper('mdg_giftregistry'); ?&gt;
&lt;form action="&lt;?php echo $this- &gt;getUrl('giftregistry/search/results/') ?&gt;" method="post" id="form-validate"&gt;
    &lt;fieldset&gt;
        &lt;?php echo $this-&gt;getBlockHtml('formkey')?&gt;
        &lt;ul class="form-list"&gt;
            &lt;li&gt;
                &lt;label for="type"&gt;Event type&lt;/label&gt;
                &lt;select name="type" id="type"&gt;
                    &lt;?php foreach($helper-&gt;getEventTypes() as $type): ?&gt;
                        &lt;option id="&lt;?php echo $type- &gt;getTypeId(); ?&gt;" value="&lt;?php echo $type-&gt;getCode(); ?&gt;"&gt;
                            &lt;?php echo $type-&gt;getName(); ?&gt;
                        &lt;/option&gt;
                    &lt;?php endforeach; ?&gt;
                &lt;/select&gt;
            &lt;/li&gt;
            &lt;li class="field"&gt;
                &lt;label class="giftreg" for="name"&gt;&lt;?php echo $this-&gt;__('Event Name') ?&gt;&lt;/label&gt;
                &lt;input type="text" name="name" id="name" value="" title="Event Name"/&gt;
            &lt;/li&gt;
            &lt;li class="field"&gt;
                &lt;label class="giftreg" for="location"&gt;&lt;?php echo $this-&gt;__('Event Location') ?&gt;&lt;/label&gt;
                &lt;input type="text" name="location" id="location" value="" title="Event Location"/&gt;
            &lt;/li&gt;
            &lt;li class="field"&gt;
                &lt;label class="giftreg" for="country"&gt;&lt;?php echo $this-&gt;__('Event Country') ?&gt;&lt;/label&gt;
                &lt;input type="text" name="country" id="country" value="" title="Event Country"/&gt;
            &lt;/li&gt;
        &lt;/ul&gt;
        &lt;div class="buttons-set"&gt;
            &lt;button type="submit" title="Save" class="button"&gt;
                    &lt;span&gt;
                        &lt;span&gt;&lt;?php echo $this-&gt;__('Save') ?&gt;&lt;/span&gt;
                    &lt;/span&gt;
            &lt;/button&gt;
        &lt;/div&gt;
    &lt;/fieldset&gt;
&lt;/form&gt;
&lt;script type="text/javascript"&gt;
    //&lt;![CDATA[
    var dataForm = new VarienForm('form-validate', true);
    //]]&gt;
&lt;/script&gt;</pre></div></li></ol></div><p>You will notice a few things:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We are<a id="id261" class="indexterm"/> using the helper model to populate <a id="id262" class="indexterm"/>the <code class="literal">Event</code> type IDs</li><li class="listitem" style="list-style-type: disc">We are posting directly to the search/results</li></ul></div><p>Now, let's make the appropriate change to our layout file.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">mdg_giftregistry.xml</code>.</li><li class="listitem">Add the following code inside <code class="literal">&lt;mdg_gifregistry_search_index&gt;</code> located at<span class="emphasis"><em> </em></span><code class="literal">app/design/frontend/base/default/layout/mdg_giftregistry.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;reference name="content"&gt;
    &lt;block name="giftregistry.search" type="core/template" template="mdg/search.phtml" as="giftregistry_search"/&gt;
&lt;/reference&gt;</pre></div></li></ol></div><p>For the search results, we don't need to create a new block type as we are passing the results collection directly to the block. In the layout, our changes will be minimal and we can reuse the list block to display the search registry results.</p><p>However, we do need to make a change in the controller. We need to change the function from <code class="literal">setResults()</code> to <code class="literal">setCustomerRegistries()</code> in the <code class="literal">SearchController</code> located at<span class="emphasis"><em> </em></span>
<code class="literal">app/code/local/Mdg/Giftregistry/controllers/SearchController.php</code>:</p><div class="informalexample"><pre class="programlisting">public function resultsAction()
{
    $this-&gt;loadLayout();
    if ($searchParams = $this-&gt;getRequest()- &gt;getParam('search_params')) {
        $results = Mage::getModel('mdg_giftregistry/entity')- &gt;getCollection();
        if($searchParams['type']){
            $results-&gt;addFieldToFilter('type_id', $searchParams['type']);
        }
        if($searchParams['date']){
            $results-&gt;addFieldToFilter('event_date', $searchParams['date']);
        }
        if($searchParams['location']){
            $results-&gt;addFieldToFilter('event_location', $searchParams['location']);
        }
        $this-&gt;getLayout()- &gt;getBlock('mdg_giftregistry.search.results')
            -&gt;setCustomerRegistries($results);
    }
    $this-&gt;renderLayout();
    return $this;
}</pre></div><p>Finally, let's <a id="id263" class="indexterm"/>update<a id="id264" class="indexterm"/> the layout files:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">mdg_giftregistry.xml</code> file.</li><li class="listitem">Add the following code inside <code class="literal">&lt;mdg_gifregistry_search_results&gt;</code>, located at <code class="literal">app/design/frontend/base/default/layout/mdg_giftregistry.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;reference name="content"&gt;
    &lt;block name="giftregistry.results" type="mdg_giftregistry/list" template="mdg/list.phtml"/&gt;
&lt;/reference&gt;</pre></div></li></ol></div><p>This will be the end of our <code class="literal">SearchController</code> templates. However, there is a problem; our search results are displaying the delete and edit links for a registry. We need a way to restrict these links only to the owner.</p><p>We can do this with the following helper function, located at <code class="literal">app/code/local/Mdg/Giftregistry/Helper/Data.php</code>:</p><div class="informalexample"><pre class="programlisting">public function isRegistryOwner($registryCustomerId)
{
    $currentCustomer = Mage::getSingleton('customer/session')- &gt;getCustomer();
    if($currentCustomer &amp;&amp; $currentCustomer-&gt;getId() == $registryCustomerId)
    {
        return true;
    }
    return false;
}</pre></div><p>Let's update our template to use the new <code class="literal">helper</code> method located at <code class="literal">app/design/frontend/base/default/template/mdg/list.phtml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
    $_collection = $this-&gt;getCustomerRegistries();
    $helper = Mage::helper('mdg_giftregistry')
?&gt;
&lt;div class="customer-list"&gt;
    &lt;?php if(!$_collection-&gt;count()): ?&gt;
        &lt;h2&gt;&lt;?php echo $this-&gt;__('You have no registries.') ?&gt;&lt;/h2&gt;
        &lt;a href="&lt;?php echo $this- &gt;getUrl('giftregistry/index/new') ?&gt;"&gt;
            &lt;?php echo $this-&gt;__('Click Here to create a new Gift Registry') ?&gt;
        &lt;/a&gt;
    &lt;?php else: ?&gt;
        &lt;ul&gt;
            &lt;?php foreach($_collection as $registry): ?&gt;
                &lt;li&gt;
                    &lt;h3&gt;&lt;?php echo $registry-&gt;getEventName(); ?&gt;&lt;/h3&gt;
                    &lt;p&gt;&lt;strong&gt;&lt;?php echo $this-&gt;__('Event Date:') ?&gt; &lt;?php echo $registry-&gt;getEventDate(); ?&gt;&lt;/strong&gt;&lt;/p&gt;
                    &lt;p&gt;&lt;strong&gt;&lt;?php echo $this-&gt;__('Event Location:') ?&gt; &lt;?php echo $registry- &gt;getEventLocation(); ?&gt;&lt;/strong&gt;&lt;/p&gt;
                    &lt;a href="&lt;?php echo $this- &gt;getUrl('giftregistry/view/view', array('_query' =&gt; array('registry_id' =&gt; $registry-&gt;getEntityId()))) ?&gt;"&gt;
                        &lt;?php echo $this-&gt;__('View Registry') ?&gt;
                    &lt;/a&gt;
                    &lt;?php if($helper-&gt;isRegistryOwner($registry- &gt;getCustomerId())): ?&gt;
                        &lt;a href="&lt;?php echo $this- &gt;getUrl('giftregistry/index/edit', array('_query' =&gt; array('registry_id' =&gt; $registry-&gt;getEntityId()))) ?&gt;"&gt;
                            &lt;?php echo $this-&gt;__('Edit Registry') ?&gt;
                        &lt;/a&gt;
                        &lt;a href="&lt;?php echo $this- &gt;getUrl('giftregistry/index/delete', array('_query' =&gt; array('registry_id' =&gt; $registry-&gt;getEntityId()))) ?&gt;"&gt;
                            &lt;?php echo $this-&gt;__('Delete Registry') ?&gt;
                        &lt;/a&gt;
                    &lt;?php endif; ?&gt;
                &lt;/li&gt;
            &lt;?php endforeach; ?&gt;
        &lt;/ul&gt;
    &lt;?php endif; ?&gt;
&lt;/div&gt;</pre></div></div><div class="section" title="ViewController blocks and views"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec38"/>ViewController blocks and views</h2></div></div></div><p>For our <code class="literal">ViewController</code>, we just need to<a id="id265" class="indexterm"/> create a new template file and a new entry<a id="id266" class="indexterm"/> in the <code class="literal">layout.xml</code> file:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the template directory.</li><li class="listitem">Create a template named <code class="literal">view.phtml</code>.</li><li class="listitem">Add the following code located at <code class="literal">app/design/frontend/base/default/template/mdg/view.phtml</code>:<div class="informalexample"><pre class="programlisting">&lt;?php $registry = Mage::registry('loaded_registry'); ?&gt;
&lt;h3&gt;&lt;?php echo $registry-&gt;getEventName(); ?&gt;&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;&lt;?php $this-&gt;__('Event Date:') ?&gt; &lt;?php echo $registry-&gt;getEventDate(); ?&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;?php $this-&gt;__('Event Location:') ?&gt; &lt;?php echo $registry-&gt;getEventLocation(); ?&gt;&lt;/strong&gt;&lt;/p&gt;</pre></div></li></ol></div><p>Update the layout XML file <code class="literal">&lt;mdg_gifregistry_view_view&gt;</code>:</p><div class="informalexample"><pre class="programlisting">&lt;reference name="content"&gt;
    &lt;block name="giftregistry.view" type="core/template" template="mdg/view.phtml" as="giftregistry_view"/&gt;
&lt;/reference&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note19"/>Note</h3><p>
<span class="strong"><strong>Challenge</strong></span>: Improve the view form to return an error if there is not an actual loaded registry. To see the answer with the complete code and full breakdown, visit <a class="ulink" href="http://www.magedevguide.com/challenge/chapter3/5">http://www.magedevguide.com/challenge/chapter3/5</a>.</p></div></div></div><div class="section" title="Adding products to the registry"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec39"/>Adding products to the registry</h2></div></div></div><p>We are almost at the end of the<a id="id267" class="indexterm"/> chapter and we are yet to cover how to add products <a id="id268" class="indexterm"/>to our registries. Due to space concerns in this book, I have decided to move this section to the website at <a class="ulink" href="http://www.magedevguide.com/chapter3/adding-products-registry">http://www.magedevguide.com/chapter3/adding-products-registry</a>.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec29"/>Summary</h1></div></div></div><p>In this chapter, we have covered a lot of ground. We have learned how to extend the frontend of Magento, and how to work with routes and controllers.</p><p>The Magento layout system allows us to modify and control blocks and the display on our store. We also started working with Magento data models and learned how to use them to handle and manipulate our data.</p><p>We have only touched the surface of frontend development and the data models. In the next chapter, we will expand a little more on configuration, models, and data, and we will explore and create an admin section on the Magento backend.</p></div></body></html>