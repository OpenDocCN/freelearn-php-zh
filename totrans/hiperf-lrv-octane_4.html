<html><head></head><body>
<div id="_idContainer037">
<h1 class="chapter-number" id="_idParaDest-58"><a id="_idTextAnchor065"/><span class="koboSpan" id="kobo.1.1">4</span></h1>
<h1 id="_idParaDest-59"><a id="_idTextAnchor066"/><span class="koboSpan" id="kobo.2.1">Building a Laravel Octane Application</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In the previous chapters, we focused on installing, configuring, and using some of the features provided by Laravel Octane. </span><span class="koboSpan" id="kobo.3.2">We looked at the difference between Swoole and RoadRunner, the two application servers supported by </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">Laravel Octane.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">In this chapter, we will focus on each feature of Laravel Octane to discover its potential and understand how it can be </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">used individually.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">The goal of this chapter is to analyze the functionality of Laravel Octane in a </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">realistic context.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">To do that, we will build a sample dashboard application covering several aspects, such as configuring the application, creating the database table schema, and generating </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">initial data.</span></span></p>
<p><span class="koboSpan" id="kobo.11.1">Then, we will go on to implement specific routes for dashboard delivery and implement the data retrieval logic in the controller and the query in </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">the model.</span></span></p>
<p><span class="koboSpan" id="kobo.13.1">Then we will create a page in the sample dashboard application, where we will collect information from multiple queries. </span><span class="koboSpan" id="kobo.13.2">When we have to implement queries for retrieving data, generally, we focus on the logic and the methods for filtering, sorting, and selecting data. </span><span class="koboSpan" id="kobo.13.3">In this chapter, however, we will keep the logic as simple as possible to allow you to focus on other aspects, such as loading data efficiently thanks to executing parallel tasks, and we will apply some strategies to reduce the response time as much as possible (running the tasks in parallel reduces the overall response </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">execution time).</span></span></p>
<p><span class="koboSpan" id="kobo.15.1">In designing the application architecture, we also need to consider the things that could </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">go wrong.</span></span></p>
<p><span class="koboSpan" id="kobo.17.1">In the examples in the previous chapter, we analyzed each feature by considering what is called the </span><strong class="bold"><span class="koboSpan" id="kobo.18.1">happy path</span></strong><span class="koboSpan" id="kobo.19.1">. </span><span class="koboSpan" id="kobo.19.2">The happy path</span><a id="_idIndexMarker202"/><span class="koboSpan" id="kobo.20.1"> is the default scenario that the user takes to achieve the desired result without encountering </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">any errors.</span></span></p>
<p><span class="koboSpan" id="kobo.22.1">In designing a real application, we must also think about all those cases that are not included in the happy path. </span><span class="koboSpan" id="kobo.22.2">For example, in the case of concurrent execution of heavy queries, we need to think about the case where the execution may return an unexpected result such as an empty result set, or when the execution of a query raises an exception. </span><span class="koboSpan" id="kobo.22.3">We need to consider that this single exception may also have an impact on other concurrent executions. </span><span class="koboSpan" id="kobo.22.4">This looks like a more real-life scenario (where things could go wrong because of some exceptions) and, in this chapter, we will try to also manage </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">the errors.</span></span></p>
<p><span class="koboSpan" id="kobo.24.1">Therefore, we will try to simulate a typical data-consuming application, where users’ request response controllers must execute operations as fast as possible, even in the face of a high </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">request load.</span></span></p>
<p><span class="koboSpan" id="kobo.26.1">The primary objective of this chapter is to guide you through drastically reducing the response time of your application with the help of multiple queries, concurrent execution in rendering a dashboard page, and by trying to apply Octane features in the application. </span><span class="koboSpan" id="kobo.26.2">We will walk through the routing, controller, models, queries, migrations, seeding, and the view template. </span><span class="koboSpan" id="kobo.26.3">We will involve some mechanisms provided by Octane, such as Octane Routes, chunk data loads, parallel tasks (for queries and HTTP requests), error and exception management, and </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">Octane Cache.</span></span></p>
<p><span class="koboSpan" id="kobo.28.1">In this chapter, we will cover </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.30.1">Installing and setting up </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">the application</span></span></li>
<li><span class="koboSpan" id="kobo.32.1">Importing the initial data (and suggestions on how to make </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">it efficiently)</span></span></li>
<li><span class="koboSpan" id="kobo.34.1">Querying multiple pieces of data from the database </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">in parallel</span></span></li>
<li><span class="koboSpan" id="kobo.36.1">Optimizing </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">the routes</span></span></li>
<li><span class="koboSpan" id="kobo.38.1">More examples of integrating </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">third-party APIs</span></span></li>
<li><span class="koboSpan" id="kobo.40.1">Improving speed with </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">Octane Cache</span></span></li>
</ul>
<h1 id="_idParaDest-60"><a id="_idTextAnchor067"/><span class="koboSpan" id="kobo.42.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.43.1">We are going to assume that you have PHP 8.0 or greater (8.1 or 8.2) and the Composer tool. </span><span class="koboSpan" id="kobo.43.2">If you want to use Laravel Sail (</span><a href="https://laravel.com/docs/9.x/sail"><span class="koboSpan" id="kobo.44.1">https://laravel.com/docs/9.x/sail</span></a><span class="koboSpan" id="kobo.45.1">), you need the Docker Desktop </span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">application (</span></span><a href="https://www.docker.com/products/docker-desktop"><span class="No-Break"><span class="koboSpan" id="kobo.47.1">https://www.docker.com/products/docker-desktop</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.48.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.49.1">We will also quickly recap the setup of Octane for our practical example. </span><span class="koboSpan" id="kobo.49.2">So, we will install all </span><span class="No-Break"><span class="koboSpan" id="kobo.50.1">tools needed.</span></span></p>
<p><span class="koboSpan" id="kobo.51.1">The source code and the configuration files of the examples described in the current chapter are available </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">here: </span></span><a href="https://github.com/PacktPublishing/High-Performance-with-Laravel-Octane/tree/main/octane-ch04"><span class="No-Break"><span class="koboSpan" id="kobo.53.1">https://github.com/PacktPublishing/High-Performance-with-Laravel-Octane/tree/main/octane-ch04</span></span></a></p>
<h1 id="_idParaDest-61"><a id="_idTextAnchor068"/><span class="koboSpan" id="kobo.54.1">Installing and setting up the dashboard application</span></h1>
<p><span class="koboSpan" id="kobo.55.1">To </span><a id="_idIndexMarker203"/><span class="koboSpan" id="kobo.56.1">demonstrate the power of Laravel Octane, we are going to build a dashboard </span><a id="_idIndexMarker204"/><span class="koboSpan" id="kobo.57.1">page to show event data filtered in different ways. </span><span class="koboSpan" id="kobo.57.2">We will keep it as simple as possible to avoid focusing on business functionalities, and we will keep focusing on how to apply techniques for improving performance while keeping the application reliable </span><span class="No-Break"><span class="koboSpan" id="kobo.58.1">and error-free.</span></span></p>
<h2 id="_idParaDest-62"><a id="_idTextAnchor069"/><span class="koboSpan" id="kobo.59.1">Installing your Laravel application</span></h2>
<p><span class="koboSpan" id="kobo.60.1">As shown</span><a id="_idIndexMarker205"/><span class="koboSpan" id="kobo.61.1"> in </span><a href="B17728_01.xhtml#_idTextAnchor015"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.62.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.63.1">, </span><em class="italic"><span class="koboSpan" id="kobo.64.1">Understanding the Laravel Web Application Architecture</span></em><span class="koboSpan" id="kobo.65.1">, you can install the Laravel application from scratch via the Laravel command, </span><span class="No-Break"><span class="koboSpan" id="kobo.66.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.67.1">
composer global requires laravel/installer</span></pre>
<p><span class="koboSpan" id="kobo.68.1">Once you have your Laravel command installed, you can create your application with the </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.70.1">
laravel new octane-ch04</span></pre>
<p><span class="koboSpan" id="kobo.71.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.72.1">laravel new</span></strong><span class="koboSpan" id="kobo.73.1"> command creates the directory with your application, so the next step is to enter the new directory to start customizing </span><span class="No-Break"><span class="koboSpan" id="kobo.74.1">the application:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.75.1">
cd octane-ch04</span></pre>
<h2 id="_idParaDest-63"><a id="_idTextAnchor070"/><span class="koboSpan" id="kobo.76.1">Adding a database</span></h2>
<p><span class="koboSpan" id="kobo.77.1">Now</span><a id="_idIndexMarker206"/><span class="koboSpan" id="kobo.78.1"> that we have created the application, we have to install and set up the database because our example application will need a database to store and retrieve the example data. </span><span class="koboSpan" id="kobo.78.2">So, to install and set up the database, we are going to do </span><span class="No-Break"><span class="koboSpan" id="kobo.79.1">the following:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.80.1">Install a MySQL </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">database server</span></span></li>
<li><span class="koboSpan" id="kobo.82.1">Execute migrations in Laravel (to apply schema definitions to </span><span class="No-Break"><span class="koboSpan" id="kobo.83.1">database tables)</span></span></li>
<li><span class="koboSpan" id="kobo.84.1">Install an application to manage and check the tables and the data of </span><span class="No-Break"><span class="koboSpan" id="kobo.85.1">the database</span></span></li>
</ol>
<h3><span class="koboSpan" id="kobo.86.1">Installing the database service</span></h3>
<p><span class="koboSpan" id="kobo.87.1">There are three</span><a id="_idIndexMarker207"/><span class="koboSpan" id="kobo.88.1"> ways to install the database server: via the official installer, via your local package manager, or via </span><span class="No-Break"><span class="koboSpan" id="kobo.89.1">Docker/Laravel Sail.</span></span></p>
<p><span class="koboSpan" id="kobo.90.1">The first one is to use the official installer provided by MySQL. </span><span class="koboSpan" id="kobo.90.2">You can download and execute the installer from the official website for your specific operating </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">system: </span></span><a href="https://dev.mysql.com/downloads/installer/"><span class="No-Break"><span class="koboSpan" id="kobo.92.1">https://dev.mysql.com/downloads/installer/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.93.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.94.1">Once you have downloaded the installer, you can </span><span class="No-Break"><span class="koboSpan" id="kobo.95.1">execute it.</span></span></p>
<p><span class="koboSpan" id="kobo.96.1">Another way is to use your system package manager. </span><span class="koboSpan" id="kobo.96.2">If you have macOS, my suggestion</span><em class="italic"> </em><span class="koboSpan" id="kobo.97.1">is to use Homebrew (see </span><a href="B17728_01.xhtml#_idTextAnchor015"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.98.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.99.1">, </span><em class="italic"><span class="koboSpan" id="kobo.100.1">Understanding the Laravel Web Application Architecture</span></em><span class="koboSpan" id="kobo.101.1">) and execute the </span><span class="No-Break"><span class="koboSpan" id="kobo.102.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.103.1">
brew install mysql</span></pre>
<p><span class="koboSpan" id="kobo.104.1">If you are using GNU/Linux, you can use the package manager provided by your GNU/Linux distribution. </span><span class="koboSpan" id="kobo.104.2">For example, for Ubuntu, you can execute </span><span class="No-Break"><span class="koboSpan" id="kobo.105.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.106.1">
sudo apt install mysql-server</span></pre>
<p><span class="koboSpan" id="kobo.107.1">If you don’t want to install or add the MySQL server to your local operating system, you can use a Docker image running in a Docker container. </span><span class="koboSpan" id="kobo.107.2">For that, we can use the </span><strong class="bold"><span class="koboSpan" id="kobo.108.1">Laravel Sail</span></strong><span class="koboSpan" id="kobo.109.1"> tool. </span><span class="koboSpan" id="kobo.109.2">If you are </span><a id="_idIndexMarker208"/><span class="koboSpan" id="kobo.110.1">familiar with Docker images, using a Docker image simplifies the installation of third-party software (such as the database). </span><span class="koboSpan" id="kobo.110.2">Laravel Sail simplifies the process of managing </span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">Docker images.</span></span></p>
<p><span class="koboSpan" id="kobo.112.1">Make sure that Laravel Sail is added to your application. </span><span class="koboSpan" id="kobo.112.2">In the project directory, add the Laravel Sail package to </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">your project:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.114.1">
composer require laravel/sail --dev</span></pre>
<p><span class="koboSpan" id="kobo.115.1">Then, execute the new command provided by Laravel Sail to add the Sail configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">for Docker:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.117.1">
php artisan sail:install</span></pre>
<p><span class="koboSpan" id="kobo.118.1">The execution of the preceding command will require you to select the services you need to activate via Laravel Sail. </span><span class="koboSpan" id="kobo.118.2">For now, the goal is to activate the MySQL service, so select the first option. </span><span class="koboSpan" id="kobo.118.3">On selecting the MySQL service, the MySQL Docker image will automatically </span><span class="No-Break"><span class="koboSpan" id="kobo.119.1">be downloaded:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer030">
<span class="koboSpan" id="kobo.120.1"><img alt="Figure 4.1: Installing Laravel Sail" src="image/Figure_4.01_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.121.1">Figure 4.1: Installing Laravel Sail</span></p>
<p><span class="koboSpan" id="kobo.122.1">Installing Laravel Sail, as well as downloading the MySQL Docker image, will add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.123.1">docker-compose.yml</span></strong><span class="koboSpan" id="kobo.124.1"> file to your project directory, and the PHPUnit configuration will be changed to use the new database instance. </span><span class="koboSpan" id="kobo.124.2">So, installing Laravel Sail helps you with the Docker configuration (creating the </span><strong class="source-inline"><span class="koboSpan" id="kobo.125.1">docker-compose.yml</span></strong><span class="koboSpan" id="kobo.126.1"> file with a preset configuration based on the choices provided as answers to the questions raised by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">sail:install</span></strong><span class="koboSpan" id="kobo.128.1"> command), and with the configuration of PHPUnit (creating the right PHPUnit configuration to</span><a id="_idIndexMarker209"/><span class="koboSpan" id="kobo.129.1"> use the new </span><span class="No-Break"><span class="koboSpan" id="kobo.130.1">database instance).</span></span></p>
<p><span class="koboSpan" id="kobo.131.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.132.1">docker-compose.yml</span></strong><span class="koboSpan" id="kobo.133.1"> file will contain </span><span class="No-Break"><span class="koboSpan" id="kobo.134.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.135.1">The main service to serve your </span><span class="No-Break"><span class="koboSpan" id="kobo.136.1">web application</span></span></li>
<li><span class="koboSpan" id="kobo.137.1">An additional service for the </span><span class="No-Break"><span class="koboSpan" id="kobo.138.1">MySQL server</span></span></li>
<li><span class="koboSpan" id="kobo.139.1">The right configuration for the services to use the same environment variables from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.140.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.141.1">env</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.142.1"> file</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.143.1">If you already have some services up and running on your local operating system and you want to avoid some conflicts (multiple services that use the same port), you can control some parameters used by Docker containers via </span><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">docker-compose.yml</span></strong><span class="koboSpan" id="kobo.145.1">, setting the following variables in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.147.1">env</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.148.1"> file:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.149.1">VITE_PORT</span></strong><span class="koboSpan" id="kobo.150.1">: This is the port used by Vite to serve the frontend part (JavaScript and CSS). </span><span class="koboSpan" id="kobo.150.2">The default is </span><strong class="source-inline"><span class="koboSpan" id="kobo.151.1">5173</span></strong><span class="koboSpan" id="kobo.152.1">; if you have Vite already up and running locally, you could use port </span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">5174</span></strong><span class="koboSpan" id="kobo.154.1"> to </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">avoid conflicts.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.156.1">APP_PORT</span></strong><span class="koboSpan" id="kobo.157.1">: This is the port used by the web server. </span><span class="koboSpan" id="kobo.157.2">By default, the port used by the local web server is port </span><strong class="source-inline"><span class="koboSpan" id="kobo.158.1">80</span></strong><span class="koboSpan" id="kobo.159.1">, but if you already have a local web server up and running, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.160.1">8080</span></strong><span class="koboSpan" id="kobo.161.1"> settings (</span><strong class="source-inline"><span class="koboSpan" id="kobo.162.1">APP_PORT=8080</span></strong><span class="koboSpan" id="kobo.163.1">) in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.164.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.165.1">env</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.166.1"> file.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.167.1">FORWARD_DB_PORT</span></strong><span class="koboSpan" id="kobo.168.1">: This is the port used by Laravel Sail to expose the MySQL service. </span><span class="koboSpan" id="kobo.168.2">By default, the port used by MySQL is </span><strong class="source-inline"><span class="koboSpan" id="kobo.169.1">3306</span></strong><span class="koboSpan" id="kobo.170.1">, but if it is already in use, you can set the port </span><span class="No-Break"><span class="koboSpan" id="kobo.171.1">via </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.172.1">FORWARD_DB_PORT=3307</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.173.1">.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.174.1">Once the </span><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">.env</span></strong><span class="koboSpan" id="kobo.176.1"> configuration is good for you, you can start the Docker containers via </span><span class="No-Break"><span class="koboSpan" id="kobo.177.1">Laravel Sail.</span></span></p>
<p><span class="koboSpan" id="kobo.178.1">To start Laravel Sail </span><a id="_idIndexMarker210"/><span class="koboSpan" id="kobo.179.1">and launch the Docker container, use the </span><span class="No-Break"><span class="koboSpan" id="kobo.180.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.181.1">
./vendor/bin/sail up -d</span></pre>
<p><span class="koboSpan" id="kobo.182.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.183.1">-d</span></strong><span class="koboSpan" id="kobo.184.1"> option allows you to execute Laravel Sail in the background, which is useful if you want to reuse the shell to launch </span><span class="No-Break"><span class="koboSpan" id="kobo.185.1">other commands.</span></span></p>
<p><span class="koboSpan" id="kobo.186.1">To check that your database is up and running, you can execute the </span><strong class="source-inline"><span class="koboSpan" id="kobo.187.1">php artisan db:show</span></strong><span class="koboSpan" id="kobo.188.1"> command </span><span class="No-Break"><span class="koboSpan" id="kobo.189.1">via </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">sail</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.191.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.192.1">
./vendor/bin/sail php artisan db:show</span></pre>
<p><span class="koboSpan" id="kobo.193.1">The first </span><a id="_idIndexMarker211"/><span class="koboSpan" id="kobo.194.1">time you execute the </span><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">db:show</span></strong><span class="koboSpan" id="kobo.196.1"> command, an additional package – the Doctrine </span><strong class="bold"><span class="koboSpan" id="kobo.197.1">Database Abstraction Layer</span></strong><span class="koboSpan" id="kobo.198.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.199.1">DBAL</span></strong><span class="koboSpan" id="kobo.200.1">) package – will be installed automatically in your Composer dependencies. </span><span class="koboSpan" id="kobo.200.2">The Doctrine DBAL package will add database inspection functionalities to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.201.1">artisan</span></strong><span class="koboSpan" id="kobo.202.1"> command. </span><span class="koboSpan" id="kobo.202.2">Once you run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.203.1">db:show</span></strong><span class="koboSpan" id="kobo.204.1"> command, this is what </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">you’ll see:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer031">
<span class="koboSpan" id="kobo.206.1"><img alt="Figure 4.2: Executing the db:show command via Sail" src="image/Figure_4.02_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.207.1">Figure 4.2: Executing the db:show command via Sail</span></p>
<p><span class="koboSpan" id="kobo.208.1">Now your database is up and running, so you can create your tables. </span><span class="koboSpan" id="kobo.208.2">We are going to execute migration to create the database tables. </span><span class="koboSpan" id="kobo.208.3">The database tables will contain your data – for example, </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">the events.</span></span></p>
<p><span class="koboSpan" id="kobo.210.1">A migration file</span><a id="_idIndexMarker212"/><span class="koboSpan" id="kobo.211.1"> is a</span><a id="_idIndexMarker213"/><span class="koboSpan" id="kobo.212.1"> file where you can define the structure of your database table. </span><span class="koboSpan" id="kobo.212.2">In the migration file, you can list the columns of your table and define the type of the columns (string, integer, date, </span><span class="No-Break"><span class="koboSpan" id="kobo.213.1">time, etc.).</span></span></p>
<h3><span class="koboSpan" id="kobo.214.1">Executing the migration</span></h3>
<p><span class="koboSpan" id="kobo.215.1">The Laravel </span><a id="_idIndexMarker214"/><span class="koboSpan" id="kobo.216.1">framework provides out-of-the-box migrations specific to standard functionalities such as user and credential management. </span><span class="koboSpan" id="kobo.216.2">That’s why after installing the framework in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.217.1">database/migrations</span></strong><span class="koboSpan" id="kobo.218.1"> directory you can find migration files already provided with the framework: the migrations to create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.219.1">users</span></strong><span class="koboSpan" id="kobo.220.1"> table, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">password resets</span></strong><span class="koboSpan" id="kobo.222.1"> table, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.223.1">failed jobs</span></strong><span class="koboSpan" id="kobo.224.1"> table, and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">personal access </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.226.1">tokens</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.227.1"> table.</span></span></p>
<p><span class="koboSpan" id="kobo.228.1">The migration files are stored in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.229.1">database/migrations</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.230.1"> directory.</span></span></p>
<p><span class="koboSpan" id="kobo.231.1">To execute the migration in the Docker container, you can execute the </span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">migrate</span></strong><span class="koboSpan" id="kobo.233.1"> command via the </span><span class="No-Break"><span class="koboSpan" id="kobo.234.1">command line:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.235.1">
./vendor/bin/sail php artisan migrate</span></pre>
<p><span class="koboSpan" id="kobo.236.1">This is what </span><span class="No-Break"><span class="koboSpan" id="kobo.237.1">you’ll see:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer032">
<span class="koboSpan" id="kobo.238.1"><img alt="Figure 4.3: Executing migrations" src="image/Figure_4.03_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.239.1">Figure 4.3: Executing migrations</span></p>
<p><span class="koboSpan" id="kobo.240.1">If you are not using Laravel Sail, and you are using the MySQL server installed in your local operating system (with Homebrew or your operating system packager or the MySQL server official installer), you can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.241.1">php artisan migrate</span></strong><span class="koboSpan" id="kobo.242.1"> without the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">sail</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.244.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.245.1">
php artisan migrate</span></pre>
<p><span class="koboSpan" id="kobo.246.1">The schema of the</span><a id="_idIndexMarker215"/><span class="koboSpan" id="kobo.247.1"> database and the tables are created thanks to the migrations. </span><span class="koboSpan" id="kobo.247.2">Now we can install the MySQL client to access </span><span class="No-Break"><span class="koboSpan" id="kobo.248.1">the database.</span></span></p>
<h3><span class="koboSpan" id="kobo.249.1">Installing MySQL client</span></h3>
<p><span class="koboSpan" id="kobo.250.1">To access the structure and the data of the database, it is recommended that you install a MySQL client. </span><span class="koboSpan" id="kobo.250.2">The MySQL client </span><a id="_idIndexMarker216"/><span class="koboSpan" id="kobo.251.1">allows you to access the structure, the schema, and the data and allows you to execute SQL queries to </span><span class="No-Break"><span class="koboSpan" id="kobo.252.1">extract data.</span></span></p>
<p><span class="koboSpan" id="kobo.253.1">You can choose one of the tools available; some are open source, and others are paid tools. </span><span class="koboSpan" id="kobo.253.2">The following shows some of the tools for managing MySQL structures </span><span class="No-Break"><span class="koboSpan" id="kobo.254.1">and data:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.255.1">Sequel Ace</span></strong><span class="koboSpan" id="kobo.256.1"> is open</span><a id="_idIndexMarker217"/><span class="koboSpan" id="kobo.257.1"> source, and is</span><a id="_idIndexMarker218"/><span class="koboSpan" id="kobo.258.1"> available for </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">macOS: </span></span><a href="https://github.com/Sequel-Ace/Sequel-Ace"><span class="No-Break"><span class="koboSpan" id="kobo.260.1">https://github.com/Sequel-Ace/Sequel-Ace</span></span></a></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.261.1">MySQL Workbench</span></strong><span class="koboSpan" id="kobo.262.1"> is the </span><a id="_idIndexMarker219"/><span class="koboSpan" id="kobo.263.1">official one and is available for all </span><a id="_idIndexMarker220"/><span class="No-Break"><span class="koboSpan" id="kobo.264.1">platforms: </span></span><a href="https://www.mysql.com/products/workbench/"><span class="No-Break"><span class="koboSpan" id="kobo.265.1">https://www.mysql.com/products/workbench/</span></span></a></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.266.1">TablePlus</span></strong><span class="koboSpan" id="kobo.267.1"> is</span><a id="_idIndexMarker221"/><span class="koboSpan" id="kobo.268.1"> available</span><a id="_idIndexMarker222"/><span class="koboSpan" id="kobo.269.1"> for Windows and macOS and supports a lot of </span><span class="No-Break"><span class="koboSpan" id="kobo.270.1">databases: </span></span><a href="https://tableplus.com/"><span class="No-Break"><span class="koboSpan" id="kobo.271.1">https://tableplus.com/</span></span></a></li>
</ul>
<p><span class="koboSpan" id="kobo.272.1">If you select </span><a id="_idIndexMarker223"/><span class="koboSpan" id="kobo.273.1">Sequel Ace or other tools, you have to set the right parameters during the initial connection, according to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.274.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">env</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.276.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.277.1">For example, the initial screen of Sequel Ace asks you for the hostname, the credential, the database name, and </span><span class="No-Break"><span class="koboSpan" id="kobo.278.1">the port:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer033">
<span class="koboSpan" id="kobo.279.1"><img alt="Figure 4.4: The Sequel Ace login screen" src="image/Figure_4.04_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.280.1">Figure 4.4: The Sequel Ace login screen</span></p>
<p><span class="koboSpan" id="kobo.281.1">As shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.282.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.283.1">.4</span></em><span class="koboSpan" id="kobo.284.1">, here</span><a id="_idIndexMarker224"/><span class="koboSpan" id="kobo.285.1"> are </span><span class="No-Break"><span class="koboSpan" id="kobo.286.1">the values:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.287.1">Host</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.289.1">127.0.0.1</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.290.1">Username</span></strong><span class="koboSpan" id="kobo.291.1">: The </span><strong class="source-inline"><span class="koboSpan" id="kobo.292.1">DB_USERNAME</span></strong><span class="koboSpan" id="kobo.293.1"> parameter in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.295.1">env</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.296.1"> file</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.297.1">Password</span></strong><span class="koboSpan" id="kobo.298.1">: The </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">DB_PASSWORD</span></strong><span class="koboSpan" id="kobo.300.1"> parameter in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.302.1">env</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.303.1"> file</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.304.1">Database</span></strong><span class="koboSpan" id="kobo.305.1">: The </span><strong class="source-inline"><span class="koboSpan" id="kobo.306.1">DB_DATABASE</span></strong><span class="koboSpan" id="kobo.307.1"> parameter in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">env</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.310.1"> file</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.311.1">Port</span></strong><span class="koboSpan" id="kobo.312.1">: The </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">FORWARD_DB_PORT</span></strong><span class="koboSpan" id="kobo.314.1"> parameter if you are using Laravel Sail, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.315.1">DB_PORT</span></strong><span class="koboSpan" id="kobo.316.1"> if you are not using a local </span><a id="_idIndexMarker225"/><span class="No-Break"><span class="koboSpan" id="kobo.317.1">Docker container</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.318.1">After installing the MySQL client, we’ll move on to talking about Sail versus the </span><span class="No-Break"><span class="koboSpan" id="kobo.319.1">local tools.</span></span></p>
<h2 id="_idParaDest-64"><a id="_idTextAnchor071"/><span class="koboSpan" id="kobo.320.1">Sail versus local tools</span></h2>
<p><span class="koboSpan" id="kobo.321.1">We looked at two methods for </span><a id="_idIndexMarker226"/><span class="koboSpan" id="kobo.322.1">using PHP, services, and tools: using Docker containers (Laravel Sail) and using a </span><span class="No-Break"><span class="koboSpan" id="kobo.323.1">local installation.</span></span></p>
<p><span class="koboSpan" id="kobo.324.1">Once Sail is set up, if you want to launch commands via Sail, you have to prefix your command with </span><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">./vendor/bin/sail</span></strong><span class="koboSpan" id="kobo.326.1">. </span><span class="koboSpan" id="kobo.326.2">For example, if you want to list the PHP modules that are installed, the following command will list all PHP modules installed on your local </span><span class="No-Break"><span class="koboSpan" id="kobo.327.1">operating system:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.328.1">
php -m</span></pre>
<p><span class="koboSpan" id="kobo.329.1">If you use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.330.1">php -m</span></strong><span class="koboSpan" id="kobo.331.1"> command with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.332.1">sail</span></strong><span class="koboSpan" id="kobo.333.1"> tool, as shown in the following, the PHP modules installed in the Docker container will </span><span class="No-Break"><span class="koboSpan" id="kobo.334.1">be shown:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.335.1">
./vendor/bin/sail php -m</span></pre>
<p><span class="koboSpan" id="kobo.336.1">The Laravel Sail image provides you with the Swoole extension already installed and configured, so now you can add Octane to </span><span class="No-Break"><span class="koboSpan" id="kobo.337.1">your application.</span></span></p>
<h2 id="_idParaDest-65"><a id="_idTextAnchor072"/><span class="koboSpan" id="kobo.338.1">Adding Octane to your application</span></h2>
<p><span class="koboSpan" id="kobo.339.1">To add Laravel Octane to </span><a id="_idIndexMarker227"/><span class="koboSpan" id="kobo.340.1">your application, you have to do </span><span class="No-Break"><span class="koboSpan" id="kobo.341.1">the following:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.342.1">Add the </span><span class="No-Break"><span class="koboSpan" id="kobo.343.1">Octane package</span></span></li>
<li><span class="koboSpan" id="kobo.344.1">Create Octane </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">configuration files</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.346.1">Information</span></p>
<p class="callout"><span class="koboSpan" id="kobo.347.1">We already covered the Octane setup with Laravel Sail and Swoole in </span><a href="B17728_03.xhtml#_idTextAnchor048"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.348.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.349.1">, </span><em class="italic"><span class="koboSpan" id="kobo.350.1">Using the Swoole Application Server</span></em><span class="koboSpan" id="kobo.351.1">. </span><span class="koboSpan" id="kobo.351.2">Let’s quickly recap all the steps for the Octane configuration needed by the example provided to you in the </span><span class="No-Break"><span class="koboSpan" id="kobo.352.1">current chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.353.1">So, first of all, in the project directory, we are going to add the Laravel Octane package with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">composer </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">require</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.356.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.357.1">
./vendor/bin/sail composer require laravel/octane</span></pre>
<p><span class="koboSpan" id="kobo.358.1">Then, we will create </span><a id="_idIndexMarker228"/><span class="koboSpan" id="kobo.359.1">Octane configuration files with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">octane:install</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.361.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.362.1">
./vendor/bin/sail php artisan octane:install</span></pre>
<p><span class="koboSpan" id="kobo.363.1">Now that we have installed Laravel Octane, we have to configure Laravel to start the Swoole </span><span class="No-Break"><span class="koboSpan" id="kobo.364.1">application server.</span></span></p>
<h2 id="_idParaDest-66"><a id="_idTextAnchor073"/><span class="koboSpan" id="kobo.365.1">Activating Swoole as the application server</span></h2>
<p><span class="koboSpan" id="kobo.366.1">If you are using</span><a id="_idIndexMarker229"/><span class="koboSpan" id="kobo.367.1"> Laravel Sail, you have to activate Swoole to serve your Laravel application. </span><span class="koboSpan" id="kobo.367.2">The default Laravel Sail configuration launches the classical </span><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">php artisan serve</span></strong><span class="koboSpan" id="kobo.369.1"> tool. </span><span class="koboSpan" id="kobo.369.2">So, the goal is to edit the configuration file where the </span><strong class="source-inline"><span class="koboSpan" id="kobo.370.1">artisan serve </span></strong><span class="koboSpan" id="kobo.371.1">command is defined and replace it with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">octane:start</span></strong><span class="koboSpan" id="kobo.373.1"> command. </span><span class="koboSpan" id="kobo.373.2">To do that, you have to copy the configuration file from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">vendor</span></strong><span class="koboSpan" id="kobo.375.1"> directory to a directory where you can edit it. </span><span class="koboSpan" id="kobo.375.2">Laravel Sail provides you a publishing command to copy and generate the configuration file via the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.376.1">sail:publish</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.377.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.378.1">
./vendor/bin/sail artisan sail:publish</span></pre>
<p><span class="koboSpan" id="kobo.379.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">publish</span></strong><span class="koboSpan" id="kobo.381.1"> command generates the Docker directory and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.382.1">supervisord.conf</span></strong><span class="koboSpan" id="kobo.383.1"> file. </span><span class="koboSpan" id="kobo.383.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.384.1">supervisord.conf</span></strong><span class="koboSpan" id="kobo.385.1"> file has the responsibility of launching the web service to accept the HTTP request and generate the HTTP response. </span><span class="koboSpan" id="kobo.385.2">With Laravel Sail, the command that runs the web service is placed in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.386.1">supervisord.conf</span></strong><span class="koboSpan" id="kobo.387.1"> file. </span><span class="koboSpan" id="kobo.387.2">Then, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.388.1">docker/8.1/supervisord.conf</span></strong><span class="koboSpan" id="kobo.389.1"> file (placed in the project directory), to launch Laravel Octane instead of the classical web server, replace the </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">artisan serve</span></strong><span class="koboSpan" id="kobo.391.1"> command with </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">artisan octane:start</span></strong><span class="koboSpan" id="kobo.393.1"> with all the </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1">correct parameters:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.395.1">
# command=/usr/bin/php -d variables_order=EGPCS /var/www/html/artisan serve --host=0.0.0.0 --port=80
command=/usr/bin/php -d variables_order=EGPCS /var/www/html/artisan octane:start --server=swoole --host=0.0.0.0 --port=80</span></pre>
<p><span class="koboSpan" id="kobo.396.1">With Laravel Sail, when you change any Docker configuration files, you must rebuild </span><span class="No-Break"><span class="koboSpan" id="kobo.397.1">the images:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.398.1">
./vendor/bin/sail build --no-cache</span></pre>
<p><span class="koboSpan" id="kobo.399.1">Then, restart </span><span class="No-Break"><span class="koboSpan" id="kobo.400.1">Laravel Sail:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.401.1">
./vendor/bin/sail stop
./vendor/bin/sail up -d</span></pre>
<p><span class="koboSpan" id="kobo.402.1">If you open your </span><a id="_idIndexMarker230"/><span class="koboSpan" id="kobo.403.1">browser to </span><strong class="source-inline"><span class="koboSpan" id="kobo.404.1">http://127.0.0.1:8080/</span></strong><span class="koboSpan" id="kobo.405.1">, you will see your Laravel application served </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">by Swoole.</span></span></p>
<h2 id="_idParaDest-67"><a id="_idTextAnchor074"/><span class="koboSpan" id="kobo.407.1">Verifying your configuration</span></h2>
<p><span class="koboSpan" id="kobo.408.1">Once you set up the </span><a id="_idIndexMarker231"/><span class="koboSpan" id="kobo.409.1">tools and services, my suggestion is to be aware of the configuration used by the tools. </span><span class="koboSpan" id="kobo.409.2">With the PHP command, you have some options to check the installed module (useful to check whether a module is loaded correctly, for example, to check whether the Swoole module is loaded), and an option to see the current configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.410.1">of PHP.</span></span></p>
<p><span class="koboSpan" id="kobo.411.1">To check whether a module is installed or not, you can use the PHP command with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.412.1">-</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.413.1">m</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.414.1"> option:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.415.1">
./vendor/bin/sail php -m</span></pre>
<p><span class="koboSpan" id="kobo.416.1">To check whether Swoole is correctly loaded, you can filter just the lines with Swoole as the name (case-insensitive). </span><span class="koboSpan" id="kobo.416.2">To filter the lines, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.417.1">grep</span></strong><span class="koboSpan" id="kobo.418.1"> command. </span><span class="koboSpan" id="kobo.418.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.419.1">grep</span></strong><span class="koboSpan" id="kobo.420.1"> command shows only the lines that match </span><span class="No-Break"><span class="koboSpan" id="kobo.421.1">specific criteria:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.422.1">
./vendor/bin/sail php -m | grep -i swoole</span></pre>
<p><span class="koboSpan" id="kobo.423.1">If you want to list all the PHP configurations, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.424.1">-</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.425.1">i</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.426.1"> option:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.427.1">
./vendor/bin/sail php -i</span></pre>
<p><span class="koboSpan" id="kobo.428.1">If you want to change something in your configuration, you might want to see where the configuration (</span><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">.ini</span></strong><span class="koboSpan" id="kobo.430.1">) files are located. </span><span class="koboSpan" id="kobo.430.2">To see where the </span><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">.ini</span></strong><span class="koboSpan" id="kobo.432.1"> files are located, filter just the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.433.1">ini</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.434.1"> string:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.435.1">
./vendor/bin/sail php -i | grep ini</span></pre>
<p><span class="koboSpan" id="kobo.436.1">You will see something </span><span class="No-Break"><span class="koboSpan" id="kobo.437.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.438.1">
Configuration File (php.ini) Path =&gt; /etc/php/8.1/cli
Loaded Configuration File =&gt; /etc/php/8.1/cli/php.ini
Scan this dir for additional .ini files =&gt; /etc/php/8.1/cli/conf.d
Additional .ini files parsed =&gt; /etc/php/8.1/cli/conf.d/10-mysqlnd.ini,</span></pre>
<p><span class="koboSpan" id="kobo.439.1">With the </span><strong class="source-inline"><span class="koboSpan" id="kobo.440.1">php -i</span></strong><span class="koboSpan" id="kobo.441.1"> command, you can obtain information about where the </span><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">php.ini</span></strong><span class="koboSpan" id="kobo.443.1"> file is located. </span><span class="koboSpan" id="kobo.443.2">If you are using Laravel Sail, you can execute the </span><span class="No-Break"><span class="koboSpan" id="kobo.444.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.445.1">
./vendor/bin/sail php -i | grep ini</span></pre>
<p><span class="koboSpan" id="kobo.446.1">You will see that there is a specific </span><strong class="source-inline"><span class="koboSpan" id="kobo.447.1">.ini</span></strong><span class="koboSpan" id="kobo.448.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">for Swoole:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.450.1">
/etc/php/8.1/cli/conf.d/25-swoole.ini</span></pre>
<p><span class="koboSpan" id="kobo.451.1">If you want to access that file to check it or edit it, you can jump into the running container via the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.452.1">shell</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.453.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.454.1">
./vendor/bin/sail shell</span></pre>
<p><span class="koboSpan" id="kobo.455.1">With this command, it will show the shell prompt of the running container, and you can show the content of the </span><span class="No-Break"><span class="koboSpan" id="kobo.456.1">file there:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.457.1">
less /etc/php/8.1/cli/conf.d/25-swoole.ini</span></pre>
<p><span class="koboSpan" id="kobo.458.1">The </span><a id="_idIndexMarker232"/><span class="koboSpan" id="kobo.459.1">command will show you the content of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.460.1">25-swoole.ini</span></strong><span class="koboSpan" id="kobo.461.1"> configuration file. </span><span class="koboSpan" id="kobo.461.2">The content of the file is </span><span class="No-Break"><span class="koboSpan" id="kobo.462.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.463.1">
extension=swoole.so</span></pre>
<p><span class="koboSpan" id="kobo.464.1">If you want to disable Swoole, you can add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.465.1">;</span></strong><span class="koboSpan" id="kobo.466.1"> character at the beginning of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.467.1">extension</span></strong><span class="koboSpan" id="kobo.468.1"> directive, </span><span class="No-Break"><span class="koboSpan" id="kobo.469.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.470.1">
; extension=swoole.so</span></pre>
<p><span class="koboSpan" id="kobo.471.1">With the </span><strong class="source-inline"><span class="koboSpan" id="kobo.472.1">;</span></strong><span class="koboSpan" id="kobo.473.1"> character at the beginning, the extension is </span><span class="No-Break"><span class="koboSpan" id="kobo.474.1">not loaded.</span></span></p>
<h2 id="_idParaDest-68"><a id="_idTextAnchor075"/><span class="koboSpan" id="kobo.475.1">Summarizing installation and setup</span></h2>
<p><span class="koboSpan" id="kobo.476.1">Before</span><a id="_idIndexMarker233"/><span class="koboSpan" id="kobo.477.1"> proceeding with implementation, let me summarize the </span><span class="No-Break"><span class="koboSpan" id="kobo.478.1">previous steps:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.479.1">We installed our </span><span class="No-Break"><span class="koboSpan" id="kobo.480.1">Laravel application.</span></span></li>
<li><span class="koboSpan" id="kobo.481.1">We added a </span><span class="No-Break"><span class="koboSpan" id="kobo.482.1">database service.</span></span></li>
<li><span class="koboSpan" id="kobo.483.1">We configured a MySQL client to access the </span><span class="No-Break"><span class="koboSpan" id="kobo.484.1">MySQL server.</span></span></li>
<li><span class="koboSpan" id="kobo.485.1">We added the Octane package </span><span class="No-Break"><span class="koboSpan" id="kobo.486.1">and configuration.</span></span></li>
<li><span class="koboSpan" id="kobo.487.1">We added Swoole as the </span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">application server.</span></span></li>
<li><span class="koboSpan" id="kobo.489.1">We checked</span><a id="_idIndexMarker234"/> <span class="No-Break"><span class="koboSpan" id="kobo.490.1">the configuration.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.491.1">So, now we can start using some Octane functionalities such as executing heavy tasks in a parallel and </span><span class="No-Break"><span class="koboSpan" id="kobo.492.1">async way.</span></span></p>
<h1 id="_idParaDest-69"><a id="_idTextAnchor076"/><span class="koboSpan" id="kobo.493.1">Creating a dashboard application</span></h1>
<p><span class="koboSpan" id="kobo.494.1">In an</span><a id="_idIndexMarker235"/><span class="koboSpan" id="kobo.495.1"> application, you can have multiple kinds of data stored in </span><span class="No-Break"><span class="koboSpan" id="kobo.496.1">multiple tables.</span></span></p>
<p><span class="koboSpan" id="kobo.497.1">Typically, on the product list page, you have to retrieve a list of products by executing a query to </span><span class="No-Break"><span class="koboSpan" id="kobo.498.1">retrieve products.</span></span></p>
<p><span class="koboSpan" id="kobo.499.1">Or, in a dashboard, maybe you could show multiple charts or tables to show some data from your database. </span><span class="koboSpan" id="kobo.499.2">If you want to show more charts on the same page, you have to perform more than one query on more than </span><span class="No-Break"><span class="koboSpan" id="kobo.500.1">one table.</span></span></p>
<p><span class="koboSpan" id="kobo.501.1">You might execute one query at a time; this means that the total time for retrieving all the useful information for composing the dashboard is the sum of the execution times of all the </span><span class="No-Break"><span class="koboSpan" id="kobo.502.1">queries involved.</span></span></p>
<p><span class="koboSpan" id="kobo.503.1">Running more than one query at the same time would reduce the total time to retrieve all </span><span class="No-Break"><span class="koboSpan" id="kobo.504.1">the information.</span></span></p>
<p><span class="koboSpan" id="kobo.505.1">To demonstrate this, we will create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.506.1">events</span></strong><span class="koboSpan" id="kobo.507.1"> table where we will store some events with a timestamp for </span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">the user.</span></span></p>
<h2 id="_idParaDest-70"><a id="_idTextAnchor077"/><span class="koboSpan" id="kobo.509.1">Creating an events table</span></h2>
<p><span class="koboSpan" id="kobo.510.1">When you are </span><a id="_idIndexMarker236"/><span class="koboSpan" id="kobo.511.1">creating a table in Laravel, you have to use a migration file. </span><span class="koboSpan" id="kobo.511.2">A migration file contains the logic to create the table and all fields. </span><span class="koboSpan" id="kobo.511.3">It contains all the instructions to define the structure of your table. </span><span class="koboSpan" id="kobo.511.4">To manage the logic for using the data stored in the table, you might need other things such as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.512.1">model</span></strong><span class="koboSpan" id="kobo.513.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.514.1">seeder</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.515.1"> classes.</span></span></p>
<p><span class="koboSpan" id="kobo.516.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.517.1">model</span></strong><span class="koboSpan" id="kobo.518.1"> class allows the developer to access the data and provides some methods for saving, deleting, loading, and </span><span class="No-Break"><span class="koboSpan" id="kobo.519.1">querying data.</span></span></p>
<p><span class="koboSpan" id="kobo.520.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.521.1">seeder</span></strong><span class="koboSpan" id="kobo.522.1"> class is used to fill the table with initial values or </span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">sample values.</span></span></p>
<p><span class="koboSpan" id="kobo.524.1">To create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">model</span></strong><span class="koboSpan" id="kobo.526.1"> class, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">seeder</span></strong><span class="koboSpan" id="kobo.528.1"> class, and the migration file, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">make:model</span></strong><span class="koboSpan" id="kobo.530.1"> command with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.531.1">m</span></strong><span class="koboSpan" id="kobo.532.1"> (create a migration file) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.533.1">s</span></strong><span class="koboSpan" id="kobo.534.1"> (create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">seeder</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.536.1">class) parameters:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.537.1">
php artisan make:model Event -ms</span></pre>
<p><span class="koboSpan" id="kobo.538.1">With the </span><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">make:model</span></strong><span class="koboSpan" id="kobo.540.1"> command and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.541.1">m</span></strong><span class="koboSpan" id="kobo.542.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">s</span></strong><span class="koboSpan" id="kobo.544.1"> parameters, three files </span><span class="No-Break"><span class="koboSpan" id="kobo.545.1">are created:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.546.1">The migration file is created in </span><strong class="source-inline"><span class="koboSpan" id="kobo.547.1">database/migration/</span></strong><span class="koboSpan" id="kobo.548.1">, with the name consisting of the timestamp as the prefix and </span><strong class="source-inline"><span class="koboSpan" id="kobo.549.1">create_events_table</span></strong><span class="koboSpan" id="kobo.550.1"> as the suffix, for </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">example, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.552.1">2022_08_22_210043_create_events_table.php</span></strong></span></li>
<li><span class="koboSpan" id="kobo.553.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.554.1">model</span></strong><span class="koboSpan" id="kobo.555.1"> class </span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.557.1">app/Models/Event.php</span></strong></span></li>
<li><span class="koboSpan" id="kobo.558.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.559.1">seeder</span></strong><span class="koboSpan" id="kobo.560.1"> class file </span><span class="No-Break"><span class="koboSpan" id="kobo.561.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.562.1">app/database/seeders/EventSeeder.php</span></strong></span></li>
</ul>
<h3><span class="koboSpan" id="kobo.563.1">Customizing the migration file</span></h3>
<p><span class="koboSpan" id="kobo.564.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.565.1">make:model</span></strong><span class="koboSpan" id="kobo.566.1"> command creates a</span><a id="_idIndexMarker237"/><span class="koboSpan" id="kobo.567.1"> template file for creating the table with basic fields such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.568.1">id</span></strong><span class="koboSpan" id="kobo.569.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.570.1">timestamps</span></strong><span class="koboSpan" id="kobo.571.1">. </span><span class="koboSpan" id="kobo.571.2">The developer must add the fields specific to the application. </span><span class="koboSpan" id="kobo.571.3">In the dashboard application, we are going to add </span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">these fields:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">user_id</span></strong><span class="koboSpan" id="kobo.574.1">: For the external reference with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.575.1">users</span></strong><span class="koboSpan" id="kobo.576.1"> table, a user could be related to </span><span class="No-Break"><span class="koboSpan" id="kobo.577.1">more events</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.578.1">type</span></strong><span class="koboSpan" id="kobo.579.1">: An event type could be </span><strong class="source-inline"><span class="koboSpan" id="kobo.580.1">INFO</span></strong><span class="koboSpan" id="kobo.581.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.582.1">WARNING</span></strong><span class="koboSpan" id="kobo.583.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.584.1">or </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">ALERT</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">description</span></strong><span class="koboSpan" id="kobo.587.1">: Text containing the description of </span><span class="No-Break"><span class="koboSpan" id="kobo.588.1">the event</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">value</span></strong><span class="koboSpan" id="kobo.590.1">: An integer from </span><strong class="source-inline"><span class="koboSpan" id="kobo.591.1">1</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.592.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.593.1">10</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">date</span></strong><span class="koboSpan" id="kobo.595.1">: The event date </span><span class="No-Break"><span class="koboSpan" id="kobo.596.1">and time</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.597.1">To create</span><a id="_idIndexMarker238"/><span class="koboSpan" id="kobo.598.1"> the table, an example of the migration file is </span><span class="No-Break"><span class="koboSpan" id="kobo.599.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.600.1">
&lt;?php
use App\Models\User;
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
return new class extends Migration
{
    /**
     * Run the migrations.
</span><span class="koboSpan" id="kobo.600.2">     *
     * @return void
     */
    public function up()
    {
        Schema::create('events',
                       function (Blueprint $table) {
            $table-&gt;id();
            $table-&gt;foreignIdFor(User::class)-&gt;index();
            $table-&gt;string('type', 30);
            $table-&gt;string('description', 250);
            $table-&gt;integer('value');
            $table-&gt;dateTime('date');
            $table-&gt;timestamps();
        });
    }
    /**
     * Reverse the migrations.
</span><span class="koboSpan" id="kobo.600.3">     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('events');
    }
};</span></pre>
<p><span class="koboSpan" id="kobo.601.1">You can list </span><a id="_idIndexMarker239"/><span class="koboSpan" id="kobo.602.1">the fields you want to add to the table in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.603.1">up()</span></strong><span class="koboSpan" id="kobo.604.1"> method. </span><span class="koboSpan" id="kobo.604.2">In the code, we are adding the foreign ID for the user table, the type, the description, the value, and the date. </span><span class="koboSpan" id="kobo.604.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.605.1">down()</span></strong><span class="koboSpan" id="kobo.606.1"> method typically is used to drop the table. </span><span class="koboSpan" id="kobo.606.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.607.1">up()</span></strong><span class="koboSpan" id="kobo.608.1"> method is called when the developer wants to execute the migrations, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">down()</span></strong><span class="koboSpan" id="kobo.610.1"> method is called when the developer wants to roll back </span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">the migration.</span></span></p>
<h2 id="_idParaDest-71"><a id="_idTextAnchor078"/><span class="koboSpan" id="kobo.612.1">Seeding data</span></h2>
<p><span class="koboSpan" id="kobo.613.1">With the </span><strong class="source-inline"><span class="koboSpan" id="kobo.614.1">seeder</span></strong><span class="koboSpan" id="kobo.615.1"> file, you </span><a id="_idIndexMarker240"/><span class="koboSpan" id="kobo.616.1">can create the initial data to fill the table. </span><span class="koboSpan" id="kobo.616.2">For testing purposes, you can fill the table with fake data. </span><span class="koboSpan" id="kobo.616.3">Laravel provides you with a great helper, </span><strong class="source-inline"><span class="koboSpan" id="kobo.617.1">fake()</span></strong><span class="koboSpan" id="kobo.618.1">, for creating </span><span class="No-Break"><span class="koboSpan" id="kobo.619.1">fake data.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.620.1">The fake() helper</span></p>
<p class="callout"><span class="koboSpan" id="kobo.621.1">For generating fake data, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.622.1">fake()</span></strong><span class="koboSpan" id="kobo.623.1"> helper uses the </span><strong class="bold"><span class="koboSpan" id="kobo.624.1">Faker</span></strong><span class="koboSpan" id="kobo.625.1"> library. </span><span class="koboSpan" id="kobo.625.2">The home page of the library</span><a id="_idIndexMarker241"/><span class="koboSpan" id="kobo.626.1"> is </span><span class="No-Break"><span class="koboSpan" id="kobo.627.1">at </span></span><a href="https://fakerphp.github.io/"><span class="No-Break"><span class="koboSpan" id="kobo.628.1">https://fakerphp.github.io/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.629.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.630.1">Now, we are going to create fake data for users </span><span class="No-Break"><span class="koboSpan" id="kobo.631.1">and events.</span></span></p>
<p><span class="koboSpan" id="kobo.632.1">To create fake users, you can create the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.633.1">app/database/seeders/UserSeeder.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.634.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.635.1">In the example, we will do </span><span class="No-Break"><span class="koboSpan" id="kobo.636.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.637.1">Generate a random name </span><span class="No-Break"><span class="koboSpan" id="kobo.638.1">via </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.639.1">fake()-&gt;firstName()</span></strong></span></li>
<li><span class="koboSpan" id="kobo.640.1">Generate a random email </span><span class="No-Break"><span class="koboSpan" id="kobo.641.1">via </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.642.1">fake()-&gt;email()</span></strong></span></li>
<li><span class="koboSpan" id="kobo.643.1">Generate a random hashed password </span><span class="No-Break"><span class="koboSpan" id="kobo.644.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.645.1">Hash::make(fake()-&gt;password())</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.646.1">We will generate 1,000 users, so we will use a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.647.1">for</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.648.1"> loop.</span></span></p>
<p><span class="koboSpan" id="kobo.649.1">You have to generate data and call </span><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">User::insert()</span></strong><span class="koboSpan" id="kobo.651.1"> to generate data in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.652.1">run()</span></strong><span class="koboSpan" id="kobo.653.1"> method of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.654.1">UserSeeder</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.655.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.656.1">
&lt;?php
namespace Database\Seeders;
use App\Models\User;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\Hash;
class UserSeeder extends Seeder
{
    /**
     * Run the database seeds.
</span><span class="koboSpan" id="kobo.656.2">     *
     * @return void
     */
    public function run()
    {
        $data = [];
        $passwordEnc = Hash::make(fake()-&gt;password());
        for ($i = 0; $i &lt; 1000; $i++) {
            $data[] =
            [
                'name' =&gt; fake()-&gt;firstName(),
                'email' =&gt; fake()-&gt;unique()-&gt;email(),
                'password' =&gt; $passwordEnc,
            ];
        }
        foreach (array_chunk($data, 100) as $chunk) {
            User::insert($chunk);
        }
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.657.1">With</span><a id="_idIndexMarker242"/><span class="koboSpan" id="kobo.658.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.659.1">UserSeeder</span></strong><span class="koboSpan" id="kobo.660.1"> class, we are going to create 1,000 users. </span><span class="koboSpan" id="kobo.660.2">Then, once we have the users in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.661.1">user</span></strong><span class="koboSpan" id="kobo.662.1"> table, we are going to create </span><span class="No-Break"><span class="koboSpan" id="kobo.663.1">100,000 events:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.664.1">
&lt;?php
namespace Database\Seeders;
use App\Models\Event;
use Illuminate\Database\Seeder;
use Illuminate\Support\Arr;
class EventSeeder extends Seeder
{
    /**
     * Run the database seeds.
</span><span class="koboSpan" id="kobo.664.2">     *
     * @return void
     */
    public function run()
    {
        $data = [];
        for ($i = 0; $i &lt; 100_000; $i++) {
            $data[] = [
                'user_id' =&gt; random_int(1, 1000),
                'type' =&gt; Arr::random(
                    [
                        'ALERT', 'WARNING', 'INFO',
                    ]
                ),
                'description' =&gt; fake()-&gt;realText(),
                'value' =&gt; random_int(1, 10),
                'date' =&gt; fake()-&gt;dateTimeThisYear(),
            ];
        }
        foreach (array_chunk($data, 100) as $chunk) {
            Event::insert($chunk);
        }
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.665.1">To create</span><a id="_idIndexMarker243"/><span class="koboSpan" id="kobo.666.1"> fake events, we need to fill the event fields using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">fake()</span></strong><span class="koboSpan" id="kobo.668.1"> helper. </span><span class="koboSpan" id="kobo.668.2">The fields filled for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.669.1">events</span></strong><span class="koboSpan" id="kobo.670.1"> table are </span><span class="No-Break"><span class="koboSpan" id="kobo.671.1">as follows:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.672.1">user_id</span></strong><span class="koboSpan" id="kobo.673.1">: We will generate a random number from </span><strong class="source-inline"><span class="koboSpan" id="kobo.674.1">1</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.675.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.676.1">1000</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.677.1">type</span></strong><span class="koboSpan" id="kobo.678.1">: We will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.679.1">Arr:random()</span></strong><span class="koboSpan" id="kobo.680.1"> helper from Laravel to select one of these values: </span><strong class="source-inline"><span class="koboSpan" id="kobo.681.1">'ALERT'</span></strong><span class="koboSpan" id="kobo.682.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.683.1">'WARNING'</span></strong><span class="koboSpan" id="kobo.684.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.685.1">or </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.686.1">'INFO'</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.687.1">description</span></strong><span class="koboSpan" id="kobo.688.1">: A random text from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">fake()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.690.1"> helper</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.691.1">value</span></strong><span class="koboSpan" id="kobo.692.1">: A random integer from </span><strong class="source-inline"><span class="koboSpan" id="kobo.693.1">1</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.694.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.695.1">10</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.696.1">date</span></strong><span class="koboSpan" id="kobo.697.1">: A date function provided by a </span><strong class="source-inline"><span class="koboSpan" id="kobo.698.1">fake()</span></strong><span class="koboSpan" id="kobo.699.1"> helper for generating a day from the current </span><span class="No-Break"><span class="koboSpan" id="kobo.700.1">year, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.701.1">dateTimeThisYear()</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.702.1">Like we did for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.703.1">users</span></strong><span class="koboSpan" id="kobo.704.1"> table, we are using the chunking approach to try to improve the speed of the execution of the data generator. </span><span class="koboSpan" id="kobo.704.2">For large arrays, the chunking approach allows the code to be more performant because it involves dividing the array into chunks and</span><a id="_idIndexMarker244"/><span class="koboSpan" id="kobo.705.1"> handling the chunks instead of each record individually. </span><span class="koboSpan" id="kobo.705.2">This reduces the number of insertions made to </span><span class="No-Break"><span class="koboSpan" id="kobo.706.1">the database.</span></span></p>
<h2 id="_idParaDest-72"><a id="_idTextAnchor079"/><span class="koboSpan" id="kobo.707.1">Improving the speed of the seed operation</span></h2>
<p><span class="koboSpan" id="kobo.708.1">Generating a</span><a id="_idIndexMarker245"/><span class="koboSpan" id="kobo.709.1"> lot of data requires thinking about the cost in terms of </span><em class="italic"><span class="koboSpan" id="kobo.710.1">time spent</span></em><span class="koboSpan" id="kobo.711.1"> on </span><span class="No-Break"><span class="koboSpan" id="kobo.712.1">the operations.</span></span></p>
<p><span class="koboSpan" id="kobo.713.1">The two most expensive operations used for data seeding (via the </span><strong class="source-inline"><span class="koboSpan" id="kobo.714.1">UserSeeder</span></strong><span class="koboSpan" id="kobo.715.1"> class) during the creation of the initial user data are </span><span class="No-Break"><span class="koboSpan" id="kobo.716.1">as follows:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.717.1">Hash::make()</span></strong><span class="koboSpan" id="kobo.718.1"> takes a fraction of a second because it is CPU-intensive. </span><span class="koboSpan" id="kobo.718.2">If you repeat this operation multiple times, in the end, it takes seconds to </span><span class="No-Break"><span class="koboSpan" id="kobo.719.1">be executed.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">array_chunk</span></strong><span class="koboSpan" id="kobo.721.1"> can help you reduce the number of calls to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.722.1">insert()</span></strong><span class="koboSpan" id="kobo.723.1"> method. </span><span class="koboSpan" id="kobo.723.2">Consider that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.724.1">insert()</span></strong><span class="koboSpan" id="kobo.725.1"> method can accept an array of items (multiple rows to insert). </span><span class="koboSpan" id="kobo.725.2">Using </span><strong class="source-inline"><span class="koboSpan" id="kobo.726.1">insert()</span></strong><span class="koboSpan" id="kobo.727.1"> with an array as an argument is much faster in the execution than calling </span><strong class="source-inline"><span class="koboSpan" id="kobo.728.1">insert()</span></strong><span class="koboSpan" id="kobo.729.1"> for every single row. </span><span class="koboSpan" id="kobo.729.2">Each </span><strong class="source-inline"><span class="koboSpan" id="kobo.730.1">insert()</span></strong><span class="koboSpan" id="kobo.731.1"> execution under the hood (at the database level) has to prepare the transaction operation for the insert, insert the row in the table, adjust all indexes and all metadata for the table, and close the transaction. </span><span class="koboSpan" id="kobo.731.2">In other words, each </span><strong class="source-inline"><span class="koboSpan" id="kobo.732.1">insert()</span></strong><span class="koboSpan" id="kobo.733.1"> operation has some overhead time that you have to consider when you want to call it multiple times. </span><span class="koboSpan" id="kobo.733.2">That means each </span><strong class="source-inline"><span class="koboSpan" id="kobo.734.1">insert()</span></strong><span class="koboSpan" id="kobo.735.1"> operation has an additional overhead cost to ensure that the operation is self-consistent. </span><span class="koboSpan" id="kobo.735.2">Reducing the number of such operations reduces the total time of the </span><span class="No-Break"><span class="koboSpan" id="kobo.736.1">additional operations.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.737.1">So, in order to improve the performance in data creation (seeding), we can make some assumptions and we can implement </span><span class="No-Break"><span class="koboSpan" id="kobo.738.1">these approaches:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.739.1">To create multiple users, it is fine to have the same password for all users. </span><span class="koboSpan" id="kobo.739.2">We don’t have to implement a sign-in process, we just need a list </span><span class="No-Break"><span class="koboSpan" id="kobo.740.1">of users.</span></span></li>
<li><span class="koboSpan" id="kobo.741.1">We can create an array of users, and then use the chunking approach for inserting chunks of data (for 1,000 users we insert 10 chunks of 100 </span><span class="No-Break"><span class="koboSpan" id="kobo.742.1">users each).</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.743.1">So, in the previous snippet of code for creating users, we used these two kinds of optimizations: reducing the number of hash calls and </span><span class="No-Break"><span class="koboSpan" id="kobo.744.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.745.1">array_chunk</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.746.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.747.1">In some scenarios, you have to insert and load a huge amount of data into the database. </span><span class="koboSpan" id="kobo.747.2">In this case, my suggestion is to load data using some specific features provided by the database, instead of trying to optimize </span><span class="No-Break"><span class="koboSpan" id="kobo.748.1">your code.</span></span></p>
<p><span class="koboSpan" id="kobo.749.1">For example, if you have a multitude of data to load and or transfer from another database, in the case of MySQL, there are </span><span class="No-Break"><span class="koboSpan" id="kobo.750.1">two tools.</span></span></p>
<p><span class="koboSpan" id="kobo.751.1">The first option is using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.752.1">INTO </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.753.1">OUTFILE</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.754.1"> option:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.755.1">
select * from events INTO OUTFILE '/var/lib/mysql-files/export-events.txt';</span></pre>
<p><span class="koboSpan" id="kobo.756.1">Before doing that, you have to be sure that MySQL is allowing you to perform </span><span class="No-Break"><span class="koboSpan" id="kobo.757.1">this operation.</span></span></p>
<p><span class="koboSpan" id="kobo.758.1">Because we will export a huge quantity of data in a directory, we have to list this directory as permitted in the </span><span class="No-Break"><span class="koboSpan" id="kobo.759.1">MySQL configuration.</span></span></p>
<p><span class="koboSpan" id="kobo.760.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.761.1">my.cnf</span></strong><span class="koboSpan" id="kobo.762.1"> file (the configuration file for MySQL), be sure that there is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.763.1">secure-file-priv</span></strong><span class="koboSpan" id="kobo.764.1"> directive. </span><span class="koboSpan" id="kobo.764.2">The value of this directive would be a directory where you can export and import </span><span class="No-Break"><span class="koboSpan" id="kobo.765.1">the file.</span></span></p>
<p><span class="koboSpan" id="kobo.766.1">If you are using Laravel Sail, </span><strong class="source-inline"><span class="koboSpan" id="kobo.767.1">secure-file-priv</span></strong><span class="koboSpan" id="kobo.768.1"> is already set to </span><span class="No-Break"><span class="koboSpan" id="kobo.769.1">a directory:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.770.1">
secure-file-priv=/var/lib/mysql-files</span></pre>
<p><span class="koboSpan" id="kobo.771.1">In the case of Homebrew, the configuration file is located in the </span><span class="No-Break"><span class="koboSpan" id="kobo.772.1">following: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.773.1">/opt/homebrew/etc/my.cnf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.774.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.775.1">For </span><a id="_idIndexMarker246"/><span class="koboSpan" id="kobo.776.1">example, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.777.1">my.cnf</span></strong><span class="koboSpan" id="kobo.778.1"> file could have </span><span class="No-Break"><span class="koboSpan" id="kobo.779.1">this structure:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.780.1">
[mysqld]
bind-address = 127.0.0.1
mysqlx-bind-address = 127.0.0.1
secure-file-priv = "/Users/roberto"</span></pre>
<p><span class="koboSpan" id="kobo.781.1">In this case, the directory for exporting data and files </span><span class="No-Break"><span class="koboSpan" id="kobo.782.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.783.1">"/Users/roberto"</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.784.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer034">
<span class="koboSpan" id="kobo.785.1"><img alt="Figure 4.5: The secure-file-priv directive of MySQL" src="image/Figure_4.05_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.786.1">Figure 4.5: The secure-file-priv directive of MySQL</span></p>
<p><span class="koboSpan" id="kobo.787.1">This</span><a id="_idIndexMarker247"/><span class="koboSpan" id="kobo.788.1"> directive exists for security reasons, so before making this edit, make your evaluation. </span><span class="koboSpan" id="kobo.788.2">In the case of the production environment, I disable that directive (set as an empty string). </span><span class="koboSpan" id="kobo.788.3">In local development environments, this configuration could be acceptable, or at least activate this option only when you </span><span class="No-Break"><span class="koboSpan" id="kobo.789.1">need it.</span></span></p>
<p><span class="koboSpan" id="kobo.790.1">After this configuration change, you have to reload the MySQL server. </span><span class="koboSpan" id="kobo.790.2">In the case of Homebrew, use </span><span class="No-Break"><span class="koboSpan" id="kobo.791.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.792.1">
brew services restart mysql</span></pre>
<p><span class="koboSpan" id="kobo.793.1">Now you can execute an </span><strong class="source-inline"><span class="koboSpan" id="kobo.794.1">artisan</span></strong><span class="koboSpan" id="kobo.795.1"> command (</span><strong class="source-inline"><span class="koboSpan" id="kobo.796.1">php artisan db</span></strong><span class="koboSpan" id="kobo.797.1">) to access the database. </span><span class="koboSpan" id="kobo.797.2">You don’t need to specify the database name, username, or password because the command uses the Laravel configuration (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.798.1">DB_</span></strong><span class="koboSpan" id="kobo.799.1"> parameters </span><span class="No-Break"><span class="koboSpan" id="kobo.800.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.801.1">.env</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.802.1">):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.803.1">
php artisan db</span></pre>
<p><span class="koboSpan" id="kobo.804.1">In the MySQL prompt that is shown after you launched the </span><strong class="source-inline"><span class="koboSpan" id="kobo.805.1">artisan db</span></strong><span class="koboSpan" id="kobo.806.1"> command, you can, for example, export data using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.807.1">SELECT</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.808.1"> syntax:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.809.1">
select * from events INTO OUTFILE '/Users/roberto/export-events.txt';</span></pre>
<p><span class="koboSpan" id="kobo.810.1">You will see that exporting thousands and thousands of records will take just a </span><span class="No-Break"><span class="koboSpan" id="kobo.811.1">few milliseconds.</span></span></p>
<p><span class="koboSpan" id="kobo.812.1">If you are using Laravel Sail, as usual, you have to launch </span><strong class="source-inline"><span class="koboSpan" id="kobo.813.1">php artisan</span></strong><span class="koboSpan" id="kobo.814.1"> through the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.815.1">sail</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.816.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.817.1">
./vendor/bin/sail php artisan db</span></pre>
<p><span class="koboSpan" id="kobo.818.1">In the MySQL Docker prompt use </span><span class="No-Break"><span class="koboSpan" id="kobo.819.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.820.1">
select * from events INTO OUTFILE '/var/lib/mysql-files/export-events.txt';</span></pre>
<p><span class="koboSpan" id="kobo.821.1">If you want to load a file that previously exported my </span><strong class="source-inline"><span class="koboSpan" id="kobo.822.1">SELECT</span></strong><span class="koboSpan" id="kobo.823.1"> statement, you can use </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.824.1">LOAD DATA</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.825.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.826.1">
LOAD DATA INFILE '/Users/roberto/export-events.txt' INTO TABLE events;</span></pre>
<p><span class="koboSpan" id="kobo.827.1">Again, you will see that this command will take a few milliseconds to import thousands and thousands </span><span class="No-Break"><span class="koboSpan" id="kobo.828.1">of records:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer035">
<span class="koboSpan" id="kobo.829.1"><img alt="Figure 4.6: With LOAD DATA, you can boost the loading data process" src="image/Figure_4.06_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.830.1">Figure 4.6: With LOAD DATA, you can boost the loading data process</span></p>
<p><span class="koboSpan" id="kobo.831.1">So, in the end, you have more than one way to boost the loading data process. </span><span class="koboSpan" id="kobo.831.2">I suggest using </span><strong class="source-inline"><span class="koboSpan" id="kobo.832.1">LOAD DATA</span></strong><span class="koboSpan" id="kobo.833.1"> when you have MySQL, and you can obtain data exported via </span><strong class="source-inline"><span class="koboSpan" id="kobo.834.1">SELECT</span></strong><span class="koboSpan" id="kobo.835.1">. </span><span class="koboSpan" id="kobo.835.2">Another scenario is when, as a developer, you receive a huge data file from someone else, and you can agree with the file format. </span><span class="koboSpan" id="kobo.835.3">Or, if you already know that you will have to load huge amounts of data multiple times for testing purposes, you could evaluate </span><a id="_idIndexMarker248"/><span class="koboSpan" id="kobo.836.1">creating a huge file once (for example, with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.837.1">fake()</span></strong><span class="koboSpan" id="kobo.838.1"> helper) and then use the file every time you want to seed the </span><span class="No-Break"><span class="koboSpan" id="kobo.839.1">MySQL database.</span></span></p>
<h2 id="_idParaDest-73"><a id="_idTextAnchor080"/><span class="koboSpan" id="kobo.840.1">Executing the migrations</span></h2>
<p><span class="koboSpan" id="kobo.841.1">Now, before</span><a id="_idIndexMarker249"/><span class="koboSpan" id="kobo.842.1"> implementing the query to retrieve data, we have to run the migration and </span><span class="No-Break"><span class="koboSpan" id="kobo.843.1">the seeders.</span></span></p>
<p><span class="koboSpan" id="kobo.844.1">So, in the previous sections, we covered how to create seeders and </span><span class="No-Break"><span class="koboSpan" id="kobo.845.1">migration files.</span></span></p>
<p><span class="koboSpan" id="kobo.846.1">To control which seeder has to be loaded and executed, you have to list the seeders in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.847.1">database/seeders/DatabaseSeeder.php</span></strong><span class="koboSpan" id="kobo.848.1"> file, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.849.1">run()</span></strong><span class="koboSpan" id="kobo.850.1"> method. </span><span class="koboSpan" id="kobo.850.2">You have to list the seeders in </span><span class="No-Break"><span class="koboSpan" id="kobo.851.1">this way:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.852.1">
        $this-&gt;call([
            UserSeeder::class,
            EventSeeder::class,
        ]);</span></pre>
<p><span class="koboSpan" id="kobo.853.1">To create tables and load data with one command, </span><span class="No-Break"><span class="koboSpan" id="kobo.854.1">use this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.855.1">
php artisan migrate --seed</span></pre>
<p><span class="koboSpan" id="kobo.856.1">If you already executed the migration and you want to recreate them from scratch, you can </span><span class="No-Break"><span class="koboSpan" id="kobo.857.1">use </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.858.1">migrate:refresh</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.859.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.860.1">
php artisan migrate:refresh --seed</span></pre>
<p><span class="koboSpan" id="kobo.861.1">Or you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.862.1">migrate:fresh</span></strong><span class="koboSpan" id="kobo.863.1"> command, which drops tables instead of executing </span><span class="No-Break"><span class="koboSpan" id="kobo.864.1">the rollback:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.865.1">
php artisan migrate:fresh --seed</span></pre>
<p class="callout-heading"><span class="koboSpan" id="kobo.866.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.867.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.868.1">migrate:refresh</span></strong><span class="koboSpan" id="kobo.869.1"> command will execute all </span><strong class="source-inline"><span class="koboSpan" id="kobo.870.1">down()</span></strong><span class="koboSpan" id="kobo.871.1"> functions of your migrations. </span><span class="koboSpan" id="kobo.871.2">Usually, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.872.1">down()</span></strong><span class="koboSpan" id="kobo.873.1"> method, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.874.1">dropIfExists()</span></strong><span class="koboSpan" id="kobo.875.1"> method (for dropping the table) is called, so your table will be cleaned and your data will be lost before being created again </span><span class="No-Break"><span class="koboSpan" id="kobo.876.1">from scratch.</span></span></p>
<p><span class="koboSpan" id="kobo.877.1">Now that </span><a id="_idIndexMarker250"/><span class="koboSpan" id="kobo.878.1">you have your tables and data created, we will load the data via a query from the controller. </span><span class="koboSpan" id="kobo.878.2">Let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.879.1">see how.</span></span></p>
<h2 id="_idParaDest-74"><a id="_idTextAnchor081"/><span class="koboSpan" id="kobo.880.1">The routing mechanism</span></h2>
<p><span class="koboSpan" id="kobo.881.1">As a practical </span><a id="_idIndexMarker251"/><span class="koboSpan" id="kobo.882.1">exercise, we want to build a dashboard. </span><span class="koboSpan" id="kobo.882.2">A dashboard</span><a id="_idIndexMarker252"/><span class="koboSpan" id="kobo.883.1"> collects some information from our </span><strong class="source-inline"><span class="koboSpan" id="kobo.884.1">events</span></strong><span class="koboSpan" id="kobo.885.1"> table. </span><span class="koboSpan" id="kobo.885.2">We have to run multiple queries to collect some data to render the dashboard </span><span class="No-Break"><span class="koboSpan" id="kobo.886.1">blade view.</span></span></p>
<p><span class="koboSpan" id="kobo.887.1">In the example, we will do </span><span class="No-Break"><span class="koboSpan" id="kobo.888.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.889.1">Define two routes for </span><strong class="source-inline"><span class="koboSpan" id="kobo.890.1">/dashboard</span></strong><span class="koboSpan" id="kobo.891.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.892.1">/dashboard-concurrent</span></strong><span class="koboSpan" id="kobo.893.1">. </span><span class="koboSpan" id="kobo.893.2">The first one is for sequential queries, and the second one is for </span><span class="No-Break"><span class="koboSpan" id="kobo.894.1">concurrent queries.</span></span></li>
<li><span class="koboSpan" id="kobo.895.1">Define a controller named </span><strong class="source-inline"><span class="koboSpan" id="kobo.896.1">DashboardController</span></strong><span class="koboSpan" id="kobo.897.1"> with two methods – </span><strong class="source-inline"><span class="koboSpan" id="kobo.898.1">index()</span></strong><span class="koboSpan" id="kobo.899.1"> (for the sequential queries) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.900.1">indexConcurrent()</span></strong><span class="koboSpan" id="kobo.901.1"> (for the </span><span class="No-Break"><span class="koboSpan" id="kobo.902.1">concurrent queries).</span></span></li>
<li><span class="koboSpan" id="kobo.903.1">Define four queries: one for counting the rows in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.904.1">events</span></strong><span class="koboSpan" id="kobo.905.1"> table, and three queries for retrieving the last five events that include a specific term in the description field (in the example we are looking for the strings that include the term </span><strong class="source-inline"><span class="koboSpan" id="kobo.906.1">something</span></strong><span class="koboSpan" id="kobo.907.1">), for each event type (</span><strong class="source-inline"><span class="koboSpan" id="kobo.908.1">'INFO'</span></strong><span class="koboSpan" id="kobo.909.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.910.1">'WARNING'</span></strong><span class="koboSpan" id="kobo.911.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.912.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">'ALERT'</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.914.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.915.1">Define </span><a id="_idIndexMarker253"/><span class="koboSpan" id="kobo.916.1">a view to show the result of </span><span class="No-Break"><span class="koboSpan" id="kobo.917.1">the </span></span><span class="No-Break"><a id="_idIndexMarker254"/></span><span class="No-Break"><span class="koboSpan" id="kobo.918.1">queries.</span></span></li>
</ul>
<h3><span class="koboSpan" id="kobo.919.1">Using the Octane routes</span></h3>
<p><span class="koboSpan" id="kobo.920.1">Octane </span><a id="_idIndexMarker255"/><span class="koboSpan" id="kobo.921.1">provides an implementation </span><a id="_idIndexMarker256"/><span class="koboSpan" id="kobo.922.1">of a </span><span class="No-Break"><span class="koboSpan" id="kobo.923.1">routing mechanism.</span></span></p>
<p><span class="koboSpan" id="kobo.924.1">The routing mechanism provided by Octane (</span><strong class="source-inline"><span class="koboSpan" id="kobo.925.1">Octane::route()</span></strong><span class="koboSpan" id="kobo.926.1">) is lighter than the classic Laravel routing mechanism (</span><strong class="source-inline"><span class="koboSpan" id="kobo.927.1">Route::get()</span></strong><span class="koboSpan" id="kobo.928.1">). </span><span class="koboSpan" id="kobo.928.2">The Octane routing mechanism is faster because it skips all the full features provided by Laravel routes such as middleware. </span><span class="koboSpan" id="kobo.928.3">Middleware is a way of adding functionalities when a route is invoked, but it takes time to call and manage this </span><span class="No-Break"><span class="koboSpan" id="kobo.929.1">software layer.</span></span></p>
<p><span class="koboSpan" id="kobo.930.1">To call Octane routes, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.931.1">Octane::route()</span></strong><span class="koboSpan" id="kobo.932.1"> method. </span><span class="koboSpan" id="kobo.932.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.933.1">route()</span></strong><span class="koboSpan" id="kobo.934.1"> method has three parameters. </span><span class="koboSpan" id="kobo.934.2">The first parameter is the HTTP method (for example </span><strong class="source-inline"><span class="koboSpan" id="kobo.935.1">'GET'</span></strong><span class="koboSpan" id="kobo.936.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.937.1">'POST'</span></strong><span class="koboSpan" id="kobo.938.1">, etc.), the second parameter is the path (such as ‘</span><strong class="source-inline"><span class="koboSpan" id="kobo.939.1">/dashboard</span></strong><span class="koboSpan" id="kobo.940.1">’), and the third parameter is a function that returns the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.941.1">Response</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.942.1"> object.</span></span></p>
<p><span class="koboSpan" id="kobo.943.1">Now that we understand the syntax differences between </span><strong class="source-inline"><span class="koboSpan" id="kobo.944.1">Route::get()</span></strong><span class="koboSpan" id="kobo.945.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.946.1">Octane::route()</span></strong><span class="koboSpan" id="kobo.947.1">, we can modify the last code snippet by replacing </span><strong class="source-inline"><span class="koboSpan" id="kobo.948.1">Route::get()</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.949.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.950.1">Octane::route()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.951.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.952.1">
use Laravel\Octane\Facades\Octane;
use Illuminate\Http\Response;
use App\Http\Controllers\DashboardController;
Octane::route('GET', '/dashboard', function() {
    return new Response(
      (new DashboardController)-&gt;index());
});
Octane::route('GET', '/dashboard-concurrent', function() {
    return new Response(
      (new DashboardController)-&gt;indexConcurrent());
});</span></pre>
<p><span class="koboSpan" id="kobo.953.1">If you want to test how much faster the Octane routing mechanism is than the Laravel routing mechanism, create two routes: the first one served by Octane, and the second one served by the Laravel route. </span><span class="koboSpan" id="kobo.953.2">You will see that the response is very fast because the application inherits all the benefits that come from all the Octane framework loader mechanisms, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.954.1">Octane::route</span></strong><span class="koboSpan" id="kobo.955.1"> also optimizes the routing part. </span><span class="koboSpan" id="kobo.955.2">The code creates two routes, </span><strong class="source-inline"><span class="koboSpan" id="kobo.956.1">/a</span></strong><span class="koboSpan" id="kobo.957.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.958.1">/b</span></strong><span class="koboSpan" id="kobo.959.1">. </span><span class="koboSpan" id="kobo.959.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.960.1">/a</span></strong><span class="koboSpan" id="kobo.961.1"> route is managed via the Octane routing mechanism, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.962.1">/b</span></strong><span class="koboSpan" id="kobo.963.1"> route is managed via the classic </span><span class="No-Break"><span class="koboSpan" id="kobo.964.1">routing mechanism:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.965.1">
Octane::route('GET', '/a', function () {
    return new Response(view('welcome'));
});
Route::get('/b', function () {
    return new Response(view('welcome'));
});</span></pre>
<p><span class="koboSpan" id="kobo.966.1">If you</span><a id="_idIndexMarker257"/><span class="koboSpan" id="kobo.967.1"> compare the two requests </span><a id="_idIndexMarker258"/><span class="koboSpan" id="kobo.968.1">by calling it via the browser and checking the response time, you will see that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.969.1">/a</span></strong><span class="koboSpan" id="kobo.970.1"> route is faster than the </span><strong class="source-inline"><span class="koboSpan" id="kobo.971.1">/b</span></strong><span class="koboSpan" id="kobo.972.1"> route (on my local machine, it is 50% faster) because </span><span class="No-Break"><span class="koboSpan" id="kobo.973.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.974.1">Octane::route()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.975.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.976.1">Now that the routes are set up, we can focus on </span><span class="No-Break"><span class="koboSpan" id="kobo.977.1">the controller.</span></span></p>
<h2 id="_idParaDest-75"><a id="_idTextAnchor082"/><span class="koboSpan" id="kobo.978.1">Creating the controller</span></h2>
<p><span class="koboSpan" id="kobo.979.1">Now we are</span><a id="_idIndexMarker259"/><span class="koboSpan" id="kobo.980.1"> going to create a controller, </span><strong class="source-inline"><span class="koboSpan" id="kobo.981.1">DashboardController</span></strong><span class="koboSpan" id="kobo.982.1">, with two methods: </span><strong class="source-inline"><span class="koboSpan" id="kobo.983.1">index()</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.984.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.985.1">indexConcurrent()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.986.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.987.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.988.1">app/Http/Controllers/</span></strong><span class="koboSpan" id="kobo.989.1"> directory, create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.990.1">DashboardController.php</span></strong><span class="koboSpan" id="kobo.991.1"> file with the </span><span class="No-Break"><span class="koboSpan" id="kobo.992.1">following content:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.993.1">
&lt;?php
namespace App\Http\Controllers;
class DashboardController extends Controller
{
    public function index()
    {
        return view('welcome');
    }
    public function indexConcurrent()
    {
        return view('welcome');
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.994.1">We just created the controller’s methods, so they are just loading the view. </span><span class="koboSpan" id="kobo.994.2">Now we are going to add some logic in the methods, creating a query in the model file and calling it from </span><span class="No-Break"><span class="koboSpan" id="kobo.995.1">the controllers.</span></span></p>
<h2 id="_idParaDest-76"><a id="_idTextAnchor083"/><span class="koboSpan" id="kobo.996.1">Creating the query</span></h2>
<p><span class="koboSpan" id="kobo.997.1">To allow the</span><a id="_idIndexMarker260"/><span class="koboSpan" id="kobo.998.1"> controller to load data, we are going to implement the </span><strong class="bold"><span class="koboSpan" id="kobo.999.1">query</span></strong><span class="koboSpan" id="kobo.1000.1">, the logic that retrieves data from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1001.1">events</span></strong><span class="koboSpan" id="kobo.1002.1"> table. </span><span class="koboSpan" id="kobo.1002.2">To do that, we are going to use the query scope mechanism provided by Laravel. </span><span class="koboSpan" id="kobo.1002.3">The query scope allows you to define the logic in the model and reuse it in </span><span class="No-Break"><span class="koboSpan" id="kobo.1003.1">your application.</span></span></p>
<p><span class="koboSpan" id="kobo.1004.1">The query scope we are going to implement will be placed in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1005.1">scopeOfType()</span></strong><span class="koboSpan" id="kobo.1006.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1007.1">Event</span></strong><span class="koboSpan" id="kobo.1008.1"> model class. </span><span class="koboSpan" id="kobo.1008.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1009.1">scopeOfType()</span></strong><span class="koboSpan" id="kobo.1010.1"> method allows you to extend the functionalities of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1011.1">Event</span></strong><span class="koboSpan" id="kobo.1012.1"> model and add a new </span><span class="No-Break"><span class="koboSpan" id="kobo.1013.1">method, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1014.1">ofType()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1015.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1016.1">
&lt;?php
namespace App\Models;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
class Event extends Model
{
    use HasFactory;
    /**
     * This is a simulation of a
     * complex query that is time-consuming
     *
     * @param  mixed  $query
     * @param  string  $type
     * @return mixed
     */
    public function scopeOfType($query, $type)
    {
        sleep(1);
        return $query-&gt;where('type', $type)
        -&gt;where('description', 'LIKE', '%something%')
        -&gt;orderBy('date')-&gt;limit(5);
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.1017.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1018.1">Event</span></strong><span class="koboSpan" id="kobo.1019.1"> model file is located in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1020.1">app/Models</span></strong><span class="koboSpan" id="kobo.1021.1"> directory. </span><span class="koboSpan" id="kobo.1021.2">The file </span><span class="No-Break"><span class="koboSpan" id="kobo.1022.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1023.1">Event.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1024.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1025.1">The query returns the event type defined as an argument (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1026.1">$type</span></strong><span class="koboSpan" id="kobo.1027.1">) and selects the rows where the description contains the word </span><strong class="source-inline"><span class="koboSpan" id="kobo.1028.1">something</span></strong><span class="koboSpan" id="kobo.1029.1"> (through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1030.1">'</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1031.1">LIKE'</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1032.1"> operator).</span></span></p>
<p><span class="koboSpan" id="kobo.1033.1">In the end, we are going to sort the data by date (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1034.1">orderBy</span></strong><span class="koboSpan" id="kobo.1035.1">) and limit it to five </span><span class="No-Break"><span class="koboSpan" id="kobo.1036.1">records (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1037.1">limit</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1038.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.1039.1">In order to</span><a id="_idIndexMarker261"/><span class="koboSpan" id="kobo.1040.1"> highlight the benefits of the optimizations we are going to implement, I am going to add a 1-second </span><strong class="source-inline"><span class="koboSpan" id="kobo.1041.1">sleep</span></strong><span class="koboSpan" id="kobo.1042.1"> function to simulate a </span><span class="No-Break"><span class="koboSpan" id="kobo.1043.1">time-consuming operation.</span></span></p>
<h2 id="_idParaDest-77"><a id="_idTextAnchor084"/><span class="koboSpan" id="kobo.1044.1">The DashboardController file</span></h2>
<p><span class="koboSpan" id="kobo.1045.1">Now we </span><a id="_idIndexMarker262"/><span class="koboSpan" id="kobo.1046.1">can open again the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1047.1">DashboardController</span></strong><span class="koboSpan" id="kobo.1048.1"> file and implement the logic to call the four queries – the first one for counting </span><span class="No-Break"><span class="koboSpan" id="kobo.1049.1">the events:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1050.1">
Event::count();</span></pre>
<p><span class="koboSpan" id="kobo.1051.1">The second one is for retrieving the events with the defined query via the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1052.1">ofType</span></strong><span class="koboSpan" id="kobo.1053.1"> function for events with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1054.1">'</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1055.1">INFO'</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1056.1"> type:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1057.1">
Event::ofType('INFO')-&gt;get();</span></pre>
<p><span class="koboSpan" id="kobo.1058.1">The third one is for retrieving the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1059.1">'</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1060.1">WARNING'</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1061.1"> event:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1062.1">
Event::ofType('WARNING')-&gt;get();</span></pre>
<p><span class="koboSpan" id="kobo.1063.1">The last one is for retrieving the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1064.1">'</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1065.1">ALERT'</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1066.1"> event:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1067.1">
Event::ofType('ALERT')-&gt;get();</span></pre>
<p><span class="koboSpan" id="kobo.1068.1">Let’s put it all together in the controller </span><strong class="source-inline"><span class="koboSpan" id="kobo.1069.1">index()</span></strong><span class="koboSpan" id="kobo.1070.1"> method to call the </span><span class="No-Break"><span class="koboSpan" id="kobo.1071.1">queries sequentially:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1072.1">
use App\Models\Event;
// …
public function index()
{
    $time = hrtime(true);
    $count = Event::count();
    $eventsInfo = Event::ofType('INFO')-&gt;get();
    $eventsWarning = Event::ofType('WARNING')-&gt;get();
    $eventsAlert = Event::ofType('ALERT')-&gt;get();
    $time = (hrtime(true) - $time) / 1_000_000;
    return view('dashboard.index',
        compact('count', 'eventsInfo', 'eventsWarning',
                'eventsAlert', 'time')
    );
}</span></pre>
<p><span class="koboSpan" id="kobo.1073.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1074.1">hrtime()</span></strong><span class="koboSpan" id="kobo.1075.1"> method is used for measuring the execution time of all </span><span class="No-Break"><span class="koboSpan" id="kobo.1076.1">four queries.</span></span></p>
<p><span class="koboSpan" id="kobo.1077.1">Then, after all the </span><a id="_idIndexMarker263"/><span class="koboSpan" id="kobo.1078.1">queries are executed, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1079.1">dashboard.index</span></strong><span class="koboSpan" id="kobo.1080.1"> view </span><span class="No-Break"><span class="koboSpan" id="kobo.1081.1">is called.</span></span></p>
<p><span class="koboSpan" id="kobo.1082.1">Now, in the same way, we will create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1083.1">indexConcurrent()</span></strong><span class="koboSpan" id="kobo.1084.1"> method, where the queries are executed in parallel via the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1085.1">Octane::concurrently()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1086.1"> method.</span></span></p>
<p><span class="koboSpan" id="kobo.1087.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1088.1">Octane::concurrently()</span></strong><span class="koboSpan" id="kobo.1089.1"> method has two parameters. </span><span class="koboSpan" id="kobo.1089.2">The first one is the array of tasks. </span><span class="koboSpan" id="kobo.1089.3">A task is an anonymous function. </span><span class="koboSpan" id="kobo.1089.4">The anonymous function can return a value. </span><span class="koboSpan" id="kobo.1089.5">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1090.1">concurrently()</span></strong><span class="koboSpan" id="kobo.1091.1"> method returns an array of values (the returned values of the task array). </span><span class="koboSpan" id="kobo.1091.2">The second parameter is the amount of time in milliseconds that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1092.1">concurrently()</span></strong><span class="koboSpan" id="kobo.1093.1"> waits for the completion of the task. </span><span class="koboSpan" id="kobo.1093.2">If a task takes more time than the second parameter (milliseconds), the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1094.1">concurrently()</span></strong><span class="koboSpan" id="kobo.1095.1"> function will raise a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1096.1">TaskTimeoutException</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1097.1"> exception.</span></span></p>
<p><span class="koboSpan" id="kobo.1098.1">The implementation </span><a id="_idIndexMarker264"/><span class="koboSpan" id="kobo.1099.1">of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1100.1">indexConcurrent()</span></strong><span class="koboSpan" id="kobo.1101.1"> method is located in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1102.1">DashboardController</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1103.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1104.1">
    public function indexConcurrent()
    {
        $time = hrtime(true);
        try {
            [$count,$eventsInfo,$eventsWarning,$eventsAlert] =
            Octane::concurrently([
                fn () =&gt; Event::count(),
                fn () =&gt; Event::ofType('INFO')-&gt;get(),
                fn () =&gt; Event::ofType('WARNING')-&gt;get(),
                fn () =&gt; Event::ofType('ALERT')-&gt;get(),
            ]);
        } catch (TaskTimeoutException $e) {
            return "Error: " . </span><span class="koboSpan" id="kobo.1104.2">$e-&gt;getMessage();
        }
        $time = (hrtime(true) - $time) / 1_000_000;
        return view('dashboard.index',
            compact('count', 'eventsInfo', 'eventsWarning',
                    'eventsAlert', 'time')
        );
    }</span></pre>
<p><span class="koboSpan" id="kobo.1105.1">To use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1106.1">TaskTimeoutException</span></strong><span class="koboSpan" id="kobo.1107.1"> correctly, you have to import </span><span class="No-Break"><span class="koboSpan" id="kobo.1108.1">the class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1109.1">
use Laravel\Octane\Exceptions\TaskTimeoutException;</span></pre>
<p><span class="koboSpan" id="kobo.1110.1">The last thing you </span><a id="_idIndexMarker265"/><span class="koboSpan" id="kobo.1111.1">have to implement to render the pages is </span><span class="No-Break"><span class="koboSpan" id="kobo.1112.1">the view.</span></span></p>
<h2 id="_idParaDest-78"><a id="_idTextAnchor085"/><span class="koboSpan" id="kobo.1113.1">Rendering the view</span></h2>
<p><span class="koboSpan" id="kobo.1114.1">In the </span><a id="_idIndexMarker266"/><span class="koboSpan" id="kobo.1115.1">controller, the last instruction of each method is returning </span><span class="No-Break"><span class="koboSpan" id="kobo.1116.1">the view:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1117.1">
return view('dashboard.index',
            compact('count', 'eventsInfo', 'eventsWarning',
                    'eventsAlert', 'time')
        );</span></pre>
<p><span class="koboSpan" id="kobo.1118.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1119.1">view()</span></strong><span class="koboSpan" id="kobo.1120.1"> function loads the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1121.1">resources/views/dashboard/index.blade.php</span></strong><span class="koboSpan" id="kobo.1122.1"> file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1123.1">dashboard.index</span></strong><span class="koboSpan" id="kobo.1124.1">). </span><span class="koboSpan" id="kobo.1124.2">To share data from the controller to the view, we are going to send some arguments to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1125.1">view()</span></strong><span class="koboSpan" id="kobo.1126.1"> function, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1127.1">$count</span></strong><span class="koboSpan" id="kobo.1128.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1129.1">$eventsInfo</span></strong><span class="koboSpan" id="kobo.1130.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1131.1">$eventsWarning</span></strong><span class="koboSpan" id="kobo.1132.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1133.1">$eventsAlert</span></strong><span class="koboSpan" id="kobo.1134.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.1135.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1136.1">$time</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1137.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1138.1">The view is an HTML template that uses Blade syntax to show variables such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1139.1">$count</span></strong><span class="koboSpan" id="kobo.1140.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1141.1">$eventsInfo</span></strong><span class="koboSpan" id="kobo.1142.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1143.1">$eventsWarning</span></strong><span class="koboSpan" id="kobo.1144.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1145.1">$eventsAlert</span></strong><span class="koboSpan" id="kobo.1146.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.1147.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1148.1">$time</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1149.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1150.1">
&lt;x-layout&gt;
    &lt;div&gt;
        Count : {{ $count }}
    &lt;/div&gt;
    &lt;div&gt;
        Time : {{ $time }} milliseconds
    &lt;/div&gt;
    @foreach ($eventsInfo as $e)
    &lt;div&gt;
        {{ $e-&gt;type }} ({{ $e-&gt;date }}): {{ $e-&gt;description }}
    &lt;/div&gt;
    @endforeach
    @foreach ($eventsWarning as $e)
    &lt;div&gt;
        {{ $e-&gt;type }} ({{ $e-&gt;date }}): {{ $e-&gt;description }}
    &lt;/div&gt;
    @endforeach
    @foreach ($eventsAlert as $e)
    &lt;div&gt;
        {{ $e-&gt;type }} ({{ $e-&gt;date }}): {{ $e-&gt;description }}
    &lt;/div&gt;
    @endforeach
&lt;/x-layout&gt;</span></pre>
<p><span class="koboSpan" id="kobo.1151.1">The view inherits</span><a id="_idIndexMarker267"/><span class="koboSpan" id="kobo.1152.1"> the layout (via the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1153.1">x-layout</span></strong><span class="koboSpan" id="kobo.1154.1"> directive) so you can create the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1155.1">resources/views/components/layout.blade.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1156.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1157.1">
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;{{ $title ?? </span><span class="koboSpan" id="kobo.1157.2">'Laravel Octane Example' }}
        &lt;/title&gt;
        &lt;meta charset="UTF-8"&gt;
        &lt;meta name="viewport" content="width=device-width,
          initial-scale=1.0"&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Laravel Octane Example&lt;/h1&gt;
        &lt;hr/&gt;
        {{ $slot }}
    &lt;/body&gt;
&lt;/html&gt;</span></pre>
<p><span class="koboSpan" id="kobo.1158.1">Now you have the data in your database, the query in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1159.1">model</span></strong><span class="koboSpan" id="kobo.1160.1"> class, and the controller that loads the data via the model and sends data to the view, and the view </span><span class="No-Break"><span class="koboSpan" id="kobo.1161.1">template file.</span></span></p>
<p><span class="koboSpan" id="kobo.1162.1">We also have two routes: the first one is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1163.1">/dashboard</span></strong><span class="koboSpan" id="kobo.1164.1"> with sequential queries, and the second one is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1165.1">/dashboard-concurrent</span></strong><span class="koboSpan" id="kobo.1166.1"> with </span><span class="No-Break"><span class="koboSpan" id="kobo.1167.1">parallel queries.</span></span></p>
<p><span class="koboSpan" id="kobo.1168.1">Just for this example, the query is forced to take 1 second (in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1169.1">model method).</span></span></p>
<p><span class="koboSpan" id="kobo.1170.1">If you open your browser at </span><strong class="source-inline"><span class="koboSpan" id="kobo.1171.1">http://127.0.0.1:8000/dashboard</span></strong><span class="koboSpan" id="kobo.1172.1">, you will see that each request takes more than 3 seconds (each query takes 1 second). </span><span class="koboSpan" id="kobo.1172.2">This is the sum of all the execution times of </span><span class="No-Break"><span class="koboSpan" id="kobo.1173.1">each query.</span></span></p>
<p><span class="koboSpan" id="kobo.1174.1">If you open</span><a id="_idIndexMarker268"/><span class="koboSpan" id="kobo.1175.1"> your browser at </span><strong class="source-inline"><span class="koboSpan" id="kobo.1176.1">http://127.0.0.1:8000/dashboard-concurrent</span></strong><span class="koboSpan" id="kobo.1177.1">, you will see that each request takes 1 second to be executed. </span><span class="koboSpan" id="kobo.1177.2">This is the maximum execution time of the most </span><span class="No-Break"><span class="koboSpan" id="kobo.1178.1">expensive query.</span></span></p>
<p><span class="koboSpan" id="kobo.1179.1">This means that you have to call multiple queries in your controller to retrieve data. </span><span class="koboSpan" id="kobo.1179.2">To render the page, you can use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1180.1">Octane::concurrently()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1181.1"> method.</span></span></p>
<p><span class="koboSpan" id="kobo.1182.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1183.1">Octane::concurrently()</span></strong><span class="koboSpan" id="kobo.1184.1"> method is also great in other scenarios (not just loading data </span><a id="_idIndexMarker269"/><span class="koboSpan" id="kobo.1185.1">from a database), such as making concurrent HTTP requests. </span><span class="koboSpan" id="kobo.1185.2">So, in the next section, we are going to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1186.1">Octane::concurrently()</span></strong><span class="koboSpan" id="kobo.1187.1"> method to retrieve data from HTTP calls (instead of retrieving data from a database). </span><span class="koboSpan" id="kobo.1187.2">Let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.1188.1">see how.</span></span></p>
<h1 id="_idParaDest-79"><a id="_idTextAnchor086"/><span class="koboSpan" id="kobo.1189.1">Making parallel HTTP requests</span></h1>
<p><span class="koboSpan" id="kobo.1190.1">Think about the scenario in </span><a id="_idIndexMarker270"/><span class="koboSpan" id="kobo.1191.1">which you have to add a new web page in your application, and to render the web page, you have to call more than one API because you need multiple pieces of data from multiple sources (list of products, list of news, list of links, etc.) for the same page. </span><span class="koboSpan" id="kobo.1191.2">In the scenario with one web page that needs data from multiple API calls, you could perform the HTTP requests simultaneously to reduce the response time of </span><span class="No-Break"><span class="koboSpan" id="kobo.1192.1">the page.</span></span></p>
<p><span class="koboSpan" id="kobo.1193.1">For this example, to simplify the explanation, we will avoid using the controller and the view. </span><span class="koboSpan" id="kobo.1193.2">We are going to collect JSON responses from APIs and then we will merge the responses into one JSON response. </span><span class="koboSpan" id="kobo.1193.3">The important aspect to focus on is the mechanism of calling HTTP requests to third-party HTTP services because our goal is to understand how to make the HTTPS </span><span class="No-Break"><span class="koboSpan" id="kobo.1194.1">call concurrently.</span></span></p>
<p><span class="koboSpan" id="kobo.1195.1">To simulate the HTTP service, we are going to create two </span><span class="No-Break"><span class="koboSpan" id="kobo.1196.1">new routes:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1197.1">api/sentence</span></strong><span class="koboSpan" id="kobo.1198.1">: An API endpoint that replies with a JSON with a </span><span class="No-Break"><span class="koboSpan" id="kobo.1199.1">random sentence</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1200.1">api/name</span></strong><span class="koboSpan" id="kobo.1201.1">: An API endpoint that replies with a JSON with a random </span><span class="No-Break"><span class="koboSpan" id="kobo.1202.1">first name</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1203.1">Both endpoint APIs implement a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1204.1">sleep()</span></strong><span class="koboSpan" id="kobo.1205.1"> function of 1 second to allow the client (who calls the endpoint) to wait for the answer. </span><span class="koboSpan" id="kobo.1205.2">This is a way to simulate a slow API and see the benefit we can obtain from parallel </span><span class="No-Break"><span class="koboSpan" id="kobo.1206.1">HTTP requests.</span></span></p>
<p><span class="koboSpan" id="kobo.1207.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1208.1">routes/web.php</span></strong><span class="koboSpan" id="kobo.1209.1"> file, you can add the two routes that implement </span><span class="No-Break"><span class="koboSpan" id="kobo.1210.1">the APIs:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1211.1">
Octane::route('GET', '/api/sentence', function () {
    sleep(1);
    return response()-&gt;json([
        'text' =&gt; fake()-&gt;sentence()
    ]);
});
Octane::route('GET', '/api/name', function () {
    sleep(1);
    return response()-&gt;json([
        'name' =&gt; fake()-&gt;name()
    ]);
});</span></pre>
<p><span class="koboSpan" id="kobo.1212.1">Now, using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1213.1">Http::get()</span></strong><span class="koboSpan" id="kobo.1214.1"> method to perform HTTP requests, you can implement the logic to retrieve data </span><a id="_idIndexMarker271"/><span class="koboSpan" id="kobo.1215.1">from two </span><span class="No-Break"><span class="koboSpan" id="kobo.1216.1">APIs sequentially:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1217.1">
Octane::route('GET', '/httpcall/sequence', function () {
    $time = hrtime(true);
    $sentenceJson =
      Http::get('http://127.0.0.1:8000/api/sentence')-&gt;
      json();
    $nameJson =
      Http::get('http://127.0.0.1:8000/api/name')-&gt;json();
    $time = hrtime(true) - $time;
    return response()-&gt;json(
        array_merge(
            $sentenceJson,
            $nameJson,
            ["time_ms" =&gt; $time / 1_000_000]
        )
        );
});</span></pre>
<p><span class="koboSpan" id="kobo.1218.1">Using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1219.1">Octane::concurrently()</span></strong><span class="koboSpan" id="kobo.1220.1">, you can now call the two </span><strong class="source-inline"><span class="koboSpan" id="kobo.1221.1">Http::get()</span></strong><span class="koboSpan" id="kobo.1222.1"> methods, using the </span><a id="_idIndexMarker272"/><span class="koboSpan" id="kobo.1223.1">HTTP request as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1224.1">Closure</span></strong><span class="koboSpan" id="kobo.1225.1"> (anonymous function), as we did for the </span><span class="No-Break"><span class="koboSpan" id="kobo.1226.1">database queries:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1227.1">
Octane::route('GET', '/httpcall/parallel', function () {
    $time = hrtime(true);
    [$sentenceJson, $nameJson] = Octane::concurrently([
        fn() =&gt;
          Http::get('http://127.0.0.1:8000/api/sentence')-&gt;
          json(),
        fn() =&gt;
          Http::get('http://127.0.0.1:8000/api/sequence')-&gt;
          json()
    ]
    );
    $time = hrtime(true) - $time;
    return response()-&gt;json(
        array_merge(
            $sentenceJson,
            $nameJson,
            ["time_ms" =&gt; $time / 1_000_000]
        )
        );
});</span></pre>
<p><span class="koboSpan" id="kobo.1228.1">If you open your browser to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1229.1">http://127.0.0.1:8000/httpcall/sequence</span></strong><span class="koboSpan" id="kobo.1230.1">, you will see that the response time is more than 2,000 milliseconds (the sum of the execution time of the two sleep functions, and some milliseconds for executing the </span><span class="No-Break"><span class="koboSpan" id="kobo.1231.1">HTTP connection).</span></span></p>
<p><span class="koboSpan" id="kobo.1232.1">If you open your browser to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1233.1">http://127.0.0.1:8000/httpcall/parallel</span></strong><span class="koboSpan" id="kobo.1234.1">, you will see that the response takes more than 1,000 milliseconds (the two HTTP requests are performed </span><span class="No-Break"><span class="koboSpan" id="kobo.1235.1">in parallel).</span></span></p>
<p><span class="koboSpan" id="kobo.1236.1">Using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1237.1">Octane::concurrently()</span></strong><span class="koboSpan" id="kobo.1238.1"> could help you save some total response time when making these examples with database</span><a id="_idIndexMarker273"/><span class="koboSpan" id="kobo.1239.1"> queries or fetching </span><span class="No-Break"><span class="koboSpan" id="kobo.1240.1">external resources.</span></span></p>
<h2 id="_idParaDest-80"><a id="_idTextAnchor087"/><span class="koboSpan" id="kobo.1241.1">Managing HTTP errors</span></h2>
<p><span class="koboSpan" id="kobo.1242.1">While executing</span><a id="_idIndexMarker274"/><span class="koboSpan" id="kobo.1243.1"> HTTP calls in parallel, you have to expect that, sometimes, the external service could answer with an error (for example, with an HTTP status code </span><strong class="source-inline"><span class="koboSpan" id="kobo.1244.1">500</span></strong><span class="koboSpan" id="kobo.1245.1">). </span><span class="koboSpan" id="kobo.1245.2">For better error management in the source code, we must also properly deal with the case where we get an empty response from the API, which typically results in a response with errors (for example the API returns a status </span><span class="No-Break"><span class="koboSpan" id="kobo.1246.1">code </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1247.1">500</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1248.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.1249.1">Here, we demonstrate that we are going to implement an API that returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.1250.1">500</span></strong><span class="koboSpan" id="kobo.1251.1"> as an HTTP status code (an internal server </span><span class="No-Break"><span class="koboSpan" id="kobo.1252.1">error message):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1253.1">
Octane::route('GET', '/api/error', function () {
    return response(
        status: 500
    );
});</span></pre>
<p><span class="koboSpan" id="kobo.1254.1">Then, we can call the API error route in one of our concurrent HTTP calls. </span><span class="koboSpan" id="kobo.1254.2">If we are not managing the error, we will receive an error such as </span><span class="No-Break"><span class="koboSpan" id="kobo.1255.1">this one:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer036">
<span class="koboSpan" id="kobo.1256.1"><img alt="Figure 4.7: The unmanaged error in the browser" src="image/Figure_4.07_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1257.1">Figure 4.7: The unmanaged error in the browser</span></p>
<p><span class="koboSpan" id="kobo.1258.1">So, we could improve our code by managing </span><span class="No-Break"><span class="koboSpan" id="kobo.1259.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1260.1">The exception that could come from the execution of concurrent </span><span class="No-Break"><span class="koboSpan" id="kobo.1261.1">HTTP calls</span></span></li>
<li><span class="koboSpan" id="kobo.1262.1">The empty response value with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1263.1">Null</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1264.1">coalescing operator</span></span></li>
<li><span class="koboSpan" id="kobo.1265.1">Initializing the arrays as an </span><span class="No-Break"><span class="koboSpan" id="kobo.1266.1">empty array</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1267.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1268.1">routes/web.php</span></strong><span class="koboSpan" id="kobo.1269.1"> file, we</span><a id="_idIndexMarker275"/><span class="koboSpan" id="kobo.1270.1"> can improve the API calls and make them </span><span class="No-Break"><span class="koboSpan" id="kobo.1271.1">more reliable:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1272.1">
Route::get('/httpcall/parallel-witherror', function () {
    $time = hrtime(true);
    $sentenceJson = [];
    $nameJson = [];
    try {
        [$sentenceJson, $nameJson] = Octane::concurrently([
            fn () =&gt; Http::get(
              'http://127.0.0.1:8000/api/sentence')-&gt;json()
              ?? </span><span class="koboSpan" id="kobo.1272.2">[],
            fn () =&gt; Http::get(
              'http://127.0.0.1:8000/api/error')-&gt;json() ??
</span><span class="koboSpan" id="kobo.1272.3">              [],
        ]
        );
    } catch (Exception $e) {
        // The error: $e-&gt;getMessage();
    }
    $time = hrtime(true) - $time;
    return response()-&gt;json(
        array_merge(
            $sentenceJson,
            $nameJson,
            ['time_ms' =&gt; $time / 1_000_000]
        )
    );
});</span></pre>
<p><span class="koboSpan" id="kobo.1273.1">In this way, if an exception is raised or we receive an HTTP error as a response, our software will manage </span><span class="No-Break"><span class="koboSpan" id="kobo.1274.1">these scenarios.</span></span></p>
<p><span class="koboSpan" id="kobo.1275.1">The suggestion </span><a id="_idIndexMarker276"/><span class="koboSpan" id="kobo.1276.1">is that even if you are focusing on performance aspects, you don’t have to lose focus on the behavior of the application and managing the unhappy </span><span class="No-Break"><span class="koboSpan" id="kobo.1277.1">paths correctly.</span></span></p>
<p><span class="koboSpan" id="kobo.1278.1">Now that we understand how to execute tasks in parallel, we can focus on caching the response to avoid calling external resources (database or web service) for </span><span class="No-Break"><span class="koboSpan" id="kobo.1279.1">every request.</span></span></p>
<h1 id="_idParaDest-81"><a id="_idTextAnchor088"/><span class="koboSpan" id="kobo.1280.1">Understanding the caching mechanism</span></h1>
<p><span class="koboSpan" id="kobo.1281.1">Laravel provides the </span><a id="_idIndexMarker277"/><span class="koboSpan" id="kobo.1282.1">developer with a strong mechanism </span><span class="No-Break"><span class="koboSpan" id="kobo.1283.1">for caching.</span></span></p>
<p><span class="koboSpan" id="kobo.1284.1">The caching mechanism can be used with a provider chosen from the database, Memcached, Redis, </span><span class="No-Break"><span class="koboSpan" id="kobo.1285.1">or DynamoDB.</span></span></p>
<p><span class="koboSpan" id="kobo.1286.1">Laravel’s caching mechanism allows data to be stored for later retrieval quickly </span><span class="No-Break"><span class="koboSpan" id="kobo.1287.1">and efficiently.</span></span></p>
<p><span class="koboSpan" id="kobo.1288.1">This is very useful in cases where retrieving data from an external service with a database or web service can be a time-consuming operation. </span><span class="koboSpan" id="kobo.1288.2">After information retrieval, storing the retrieved information in a cache mechanism is possible to make future information retrieval easier </span><span class="No-Break"><span class="koboSpan" id="kobo.1289.1">and faster.</span></span></p>
<p><span class="koboSpan" id="kobo.1290.1">So basically, a caching mechanism exposes two basic functionalities: caching of information and retrieval from the cache </span><span class="No-Break"><span class="koboSpan" id="kobo.1291.1">of information.</span></span></p>
<p><span class="koboSpan" id="kobo.1292.1">To properly retrieve information each time a cached item is used, it is appropriate to use a storage key. </span><span class="koboSpan" id="kobo.1292.2">This way, it is possible to cache a lot of information identified by a </span><span class="No-Break"><span class="koboSpan" id="kobo.1293.1">specific key.</span></span></p>
<p><span class="koboSpan" id="kobo.1294.1">Laravel’s caching mechanism, through the special </span><strong class="source-inline"><span class="koboSpan" id="kobo.1295.1">remember()</span></strong><span class="koboSpan" id="kobo.1296.1"> function, allows retrieving a piece of information tied to a specific key. </span><span class="koboSpan" id="kobo.1296.2">If this information has become obsolete because the storage time-to-live has been exceeded, or if the key is not cached, then the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1297.1">remember()</span></strong><span class="koboSpan" id="kobo.1298.1"> method allows calling an anonymous function that has the task of getting the data from the external resource, which can be the database or a web service. </span><span class="koboSpan" id="kobo.1298.2">Once the original data is retrieved, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1299.1">remember()</span></strong><span class="koboSpan" id="kobo.1300.1"> function automatically returns the data but, at the same time, also takes care of caching it with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1301.1">user-defined key.</span></span></p>
<p><span class="koboSpan" id="kobo.1302.1">Here is an example of using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1303.1">remember()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1304.1"> function:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1305.1">
use Illuminate\Support\Facades\Cache;
$secondsTimeToLive = 5;
$cacheKey= 'cache-key';
$value = Cache::remember($cacheKey, $secondsTimeToLive, function () {
    return Http::get('http://127.0.0.1:8000/api/sentence')
      -&gt;json() ?? </span><span class="koboSpan" id="kobo.1305.2">[];
});</span></pre>
<p><span class="koboSpan" id="kobo.1306.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1307.1">remember()</span></strong><span class="koboSpan" id="kobo.1308.1"> functionality applied to each HTTP request in the previous example can be implemented in an </span><span class="No-Break"><span class="koboSpan" id="kobo.1309.1">anonymous function:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1310.1">
$getHttpCached = function ($url) {
        $data = Cache::store('octane')-&gt;remember(
                'key-'.$url, 20, function () use ($url) {
            return Http::get(
              'http://127.0.0.1:8000/api/'.$url)-&gt;json() ??
</span><span class="koboSpan" id="kobo.1310.2">              [];
        });
        return $data;
    };</span></pre>
<p><span class="koboSpan" id="kobo.1311.1">The anonymous </span><a id="_idIndexMarker278"/><span class="koboSpan" id="kobo.1312.1">function can then be invoked by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1313.1">Octane::concurrently()</span></strong><span class="koboSpan" id="kobo.1314.1"> function for each </span><span class="No-Break"><span class="koboSpan" id="kobo.1315.1">concurrent task:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1316.1">
[$sentenceJson, $nameJson] = Octane::concurrently([
            fn () =&gt; $getHttpCached('sentence'),
            fn () =&gt; $getHttpCached('name'),
        ]
        );</span></pre>
<p><span class="koboSpan" id="kobo.1317.1">So, the final code in a route in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1318.1">routes/web.php</span></strong><span class="koboSpan" id="kobo.1319.1"> file is </span><span class="No-Break"><span class="koboSpan" id="kobo.1320.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1321.1">
Octane::route('GET','/httpcall/parallel-caching', function () {
    $getHttpCached = function ($url) {
        $data = Cache::store('octane')-&gt;remember(
                'key-'.$url, 20, function () use ($url) {
            return Http::get(
              'http://127.0.0.1:8000/api/'.$url)-&gt;json() ??
</span><span class="koboSpan" id="kobo.1321.2">              [];
        });
        return $data;
    };
    $time = hrtime(true);
    $sentenceJson = [];
    $nameJson = [];
    try {
        [$sentenceJson, $nameJson] = Octane::concurrently([
            fn () =&gt; $getHttpCached('sentence'),
            fn () =&gt; $getHttpCached('name'),
        ]
        );
    } catch (Exception $e) {
        // The error: $e-&gt;getMessage();
    }
    $time = hrtime(true) - $time;
    return response()-&gt;json(
        array_merge(
            $sentenceJson,
            $nameJson,
            ['time_ms' =&gt; $time / 1_000_000]
        )
    );
});</span></pre>
<p><span class="koboSpan" id="kobo.1322.1">The following are some considerations about </span><span class="No-Break"><span class="koboSpan" id="kobo.1323.1">the code:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1324.1">We used the Octane route (faster than </span><span class="No-Break"><span class="koboSpan" id="kobo.1325.1">Laravel routes).</span></span></li>
<li><span class="koboSpan" id="kobo.1326.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1327.1">$url</span></strong><span class="koboSpan" id="kobo.1328.1"> parameter of the anonymous function is used to create the cache key and to call the right API </span><span class="No-Break"><span class="koboSpan" id="kobo.1329.1">via </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1330.1">Http::get()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1331.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1332.1">We used the cache with Octane as the </span><span class="No-Break"><span class="koboSpan" id="kobo.1333.1">driver, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1334.1">Cache::store('octane')</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1335.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1336.1">We used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1337.1">remember()</span></strong><span class="koboSpan" id="kobo.1338.1"> function for </span><span class="No-Break"><span class="koboSpan" id="kobo.1339.1">the cache.</span></span></li>
<li><span class="koboSpan" id="kobo.1340.1">We set the time-to-live of the cache item at 20 seconds. </span><span class="koboSpan" id="kobo.1340.2">It means that after 20 seconds, the cache item is generated, and the code provided by the anonymous function </span><a id="_idIndexMarker279"/><span class="koboSpan" id="kobo.1341.1">will </span><span class="No-Break"><span class="koboSpan" id="kobo.1342.1">be called.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1343.1">This code improves the response time dramatically thanks to </span><span class="No-Break"><span class="koboSpan" id="kobo.1344.1">the cache.</span></span></p>
<p><span class="koboSpan" id="kobo.1345.1">However, the code could be </span><span class="No-Break"><span class="koboSpan" id="kobo.1346.1">more optimized.</span></span></p>
<p><span class="koboSpan" id="kobo.1347.1">We cache the result from each HTTP request. </span><span class="koboSpan" id="kobo.1347.2">But, we could cache the result provided by </span><strong class="source-inline"><span class="koboSpan" id="kobo.1348.1">Octane::concurrently</span></strong><span class="koboSpan" id="kobo.1349.1">. </span><span class="koboSpan" id="kobo.1349.2">So, instead of caching each HTTP request, we could cache the result that comes from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1350.1">Octane::concurrently()</span></strong><span class="koboSpan" id="kobo.1351.1">. </span><span class="koboSpan" id="kobo.1351.2">This allows us to save more time by avoiding the execution of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1352.1">Octane::concurrently()</span></strong><span class="koboSpan" id="kobo.1353.1"> if the value </span><span class="No-Break"><span class="koboSpan" id="kobo.1354.1">is cached.</span></span></p>
<p><span class="koboSpan" id="kobo.1355.1">In this case, we can move </span><strong class="source-inline"><span class="koboSpan" id="kobo.1356.1">Octane::concurrently()</span></strong><span class="koboSpan" id="kobo.1357.1"> in the body of the anonymous function called </span><span class="No-Break"><span class="koboSpan" id="kobo.1358.1">by </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1359.1">remember()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1360.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1361.1">
Octane::route('GET', '/httpcall/caching', function () {
    $time = hrtime(true);
    $sentenceJson = [];
    $nameJson = [];
    try {
        [$sentenceJson, $nameJson] =
        Cache::store('octane')-&gt;remember('key-checking',
                                          20, function () {
            return Octane::concurrently([
                fn () =&gt; Http::get(
                  'http://127.0.0.1:8000/api/sentence')-&gt;
                  json(),
                fn () =&gt; Http::get(
                 'http://127.0.0.1:8000/api/name')-&gt;json(),
            ]);
        });
    } catch (Exception $e) {
        // The error: $e-&gt;getMessage();
    }
    $time = hrtime(true) - $time;
    return response()-&gt;json(
        array_merge(
            $sentenceJson,
            $nameJson,
            ['time_ms' =&gt; $time / 1_000_000]
        )
    );
});</span></pre>
<p><span class="koboSpan" id="kobo.1362.1">In this case, from the log of the requests, you can see that the APIs are only called the first time, then the data is retrieved from the cache, and the execution time </span><span class="No-Break"><span class="koboSpan" id="kobo.1363.1">is reduced:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1364.1">
  200    GET /api/sentence ........ </span><span class="koboSpan" id="kobo.1364.2">18.57 mb 17.36 ms
  200    GET /api/name ............ </span><span class="koboSpan" id="kobo.1364.3">18.57 mb 17.36 ms
  200    GET /httpcall/caching .... </span><span class="koboSpan" id="kobo.1364.4">17.43 mb 59.82 ms
  200    GET /httpcall/caching ..... </span><span class="koboSpan" id="kobo.1364.5">17.64 mb 3.38 ms
  200    GET /httpcall/caching ..... </span><span class="koboSpan" id="kobo.1364.6">17.64 mb 2.36 ms
  200    GET /httpcall/caching ..... </span><span class="koboSpan" id="kobo.1364.7">17.64 mb 3.80 ms
  200    GET /httpcall/caching ..... </span><span class="koboSpan" id="kobo.1364.8">17.64 mb 3.30 ms</span></pre>
<p><span class="koboSpan" id="kobo.1365.1">The first call to the </span><a id="_idIndexMarker280"/><span class="koboSpan" id="kobo.1366.1">caching route takes around 60 milliseconds; the subsequent requests are much faster (around </span><span class="No-Break"><span class="koboSpan" id="kobo.1367.1">3 milliseconds)</span></span></p>
<p><span class="koboSpan" id="kobo.1368.1">If you try to do the same test by calling the HTTP requests sequentially and not using the cache, you will see higher values as response times. </span><span class="koboSpan" id="kobo.1368.2">You will also see that the API will be called every time, making the speed and the reliability of your application dependent on a third-party system because the reliability and the speed depend on the way the third-party system (that provides the APIs) creates </span><span class="No-Break"><span class="koboSpan" id="kobo.1369.1">the response.</span></span></p>
<p><span class="koboSpan" id="kobo.1370.1">For example, by calling HTTP requests sequentially, with no cache – even if the APIs are provided by Octane (so in a faster way) – you will obtain </span><span class="No-Break"><span class="koboSpan" id="kobo.1371.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1372.1">
  200    GET /api/sentence ........ </span><span class="koboSpan" id="kobo.1372.2">18.57 mb 15.22 ms
  200    GET /api/name ............. </span><span class="koboSpan" id="kobo.1372.3">18.68 mb 0.64 ms
  200    GET /httpcall/sequence ... </span><span class="koboSpan" id="kobo.1372.4">18.79 mb 60.81 ms
  200    GET /api/sentence ......... </span><span class="koboSpan" id="kobo.1372.5">18.69 mb 3.26 ms
  200    GET /api/name ............. </span><span class="koboSpan" id="kobo.1372.6">18.69 mb 1.68 ms
  200    GET /httpcall/sequence ... </span><span class="koboSpan" id="kobo.1372.7">18.94 mb 15.55 ms
  200    GET /api/sentence ......... </span><span class="koboSpan" id="kobo.1372.8">18.70 mb 1.30 ms
  200    GET /api/name ............. </span><span class="koboSpan" id="kobo.1372.9">18.70 mb 1.09 ms
  200    GET /httpcall/sequence .... </span><span class="koboSpan" id="kobo.1372.10">18.97 mb 9.52 ms
  200    GET /api/sentence ......... </span><span class="koboSpan" id="kobo.1372.11">18.71 mb 1.32 ms
  200    GET /api/name ............. </span><span class="koboSpan" id="kobo.1372.12">18.71 mb 1.05 ms
  200    GET /httpcall/sequence .... </span><span class="koboSpan" id="kobo.1372.13">19.00 mb 9.28 ms</span></pre>
<p><span class="koboSpan" id="kobo.1373.1">While you might think that this is not a great improvement or that these values are machine-dependent, a small improvement (our response time has gone from 10-15 milliseconds to 2-3 milliseconds) for a single request could have a big impact, especially if, in a production environment, you have a huge number of simultaneous requests. </span><span class="koboSpan" id="kobo.1373.2">The benefit of each small improvement for a single request is multiplied by the number of requests you might </span><a id="_idIndexMarker281"/><span class="koboSpan" id="kobo.1374.1">have in a production environment with many </span><span class="No-Break"><span class="koboSpan" id="kobo.1375.1">concurrent users.</span></span></p>
<p><span class="koboSpan" id="kobo.1376.1">Now that we understand a bit more about caching, we could refactor our dashboard by adding the cache for </span><span class="No-Break"><span class="koboSpan" id="kobo.1377.1">event retrieval.</span></span></p>
<h1 id="_idParaDest-82"><a id="_idTextAnchor089"/><span class="koboSpan" id="kobo.1378.1">Refactoring the dashboard</span></h1>
<p><span class="koboSpan" id="kobo.1379.1">We are </span><a id="_idIndexMarker282"/><span class="koboSpan" id="kobo.1380.1">going to create a new route, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1381.1">/dashboard-concurrent-cached</span></strong><span class="koboSpan" id="kobo.1382.1">, with the Octane route and we are going to call a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.1383.1">DashboardController</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1384.1">method, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1385.1">indexConcurrentCached()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1386.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1387.1">
// Importing Octane class
use Laravel\Octane\Facades\Octane;
// Importing Response class
use Illuminate\Http\Response;
// Importing the DashboardController class
use App\Http\Controllers\DashboardController;
Octane::route('GET', '/dashboard-concurrent-cached', function () {
    return new Response((new DashboardController)-&gt;
     indexConcurrentCached());
});</span></pre>
<p><span class="koboSpan" id="kobo.1388.1">In the controller </span><strong class="source-inline"><span class="koboSpan" id="kobo.1389.1">app/Http/Controllers/DashboardController.php</span></strong><span class="koboSpan" id="kobo.1390.1"> file, you can add </span><a id="_idIndexMarker283"/><span class="koboSpan" id="kobo.1391.1">the </span><span class="No-Break"><span class="koboSpan" id="kobo.1392.1">new method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1393.1">
public function indexConcurrentCached()
{
    $time = hrtime(true);
    try {
        [$count,$eventsInfo,$eventsWarning,$eventsAlert] =
        Cache::store('octane')-&gt;remember(
            key: 'key-event-cache',
            ttl: 20,
            callback: function () {
                return Octane::concurrently([
                    fn () =&gt; Event::count(),
                    fn () =&gt; Event::ofType('INFO')-&gt;get(),
                    fn () =&gt; Event::ofType('WARNING')-&gt;
                             get(),
                    fn () =&gt; Event::ofType('ALERT')-&gt;get(),
                ]);
            }
        );
    } catch (Exception $e) {
        return 'Error: '.$e-&gt;getMessage();
    }
    $time = (hrtime(true) - $time) / 1_000_000;
    return view('dashboard.index',
        compact('count', 'eventsInfo', 'eventsWarning',
                'eventsAlert', 'time')
    );
}</span></pre>
<p><span class="koboSpan" id="kobo.1394.1">In the new method, we</span><a id="_idIndexMarker284"/><span class="koboSpan" id="kobo.1395.1"> do </span><span class="No-Break"><span class="koboSpan" id="kobo.1396.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1397.1">Call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1398.1">remember()</span></strong><span class="koboSpan" id="kobo.1399.1"> method to store the values in </span><span class="No-Break"><span class="koboSpan" id="kobo.1400.1">the cache</span></span></li>
<li><span class="koboSpan" id="kobo.1401.1">Execute </span><strong class="source-inline"><span class="koboSpan" id="kobo.1402.1">Octane:concurrently</span></strong><span class="koboSpan" id="kobo.1403.1"> to parallelize </span><span class="No-Break"><span class="koboSpan" id="kobo.1404.1">the queries</span></span></li>
<li><span class="koboSpan" id="kobo.1405.1">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1406.1">'key-event-cache'</span></strong><span class="koboSpan" id="kobo.1407.1"> as the key name for the </span><span class="No-Break"><span class="koboSpan" id="kobo.1408.1">cache item</span></span></li>
<li><span class="koboSpan" id="kobo.1409.1">Use 20 seconds as the cache time-to-live (after 20 seconds, the queries will be executed and retrieve new values from </span><span class="No-Break"><span class="koboSpan" id="kobo.1410.1">the database)</span></span></li>
<li><span class="koboSpan" id="kobo.1411.1">Use the same query of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1412.1">/dashboard</span></strong><span class="koboSpan" id="kobo.1413.1"> route and the same blade view (to make a </span><span class="No-Break"><span class="koboSpan" id="kobo.1414.1">good comparison)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1415.1">Now, you can restart your Octane worker with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1416.1">php artisan octane:reload</span></strong><span class="koboSpan" id="kobo.1417.1"> if you are not using the automatic reloader (as explained in </span><a href="B17728_02.xhtml#_idTextAnchor036"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1418.1">Chapter 2</span></em></span></a><span class="koboSpan" id="kobo.1419.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1420.1">Configuring the RoadRunner Application Server</span></em><span class="koboSpan" id="kobo.1421.1">), and then access </span><span class="No-Break"><span class="koboSpan" id="kobo.1422.1">the following:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1423.1">http://127.0.0.1:8000/dashboard</span></strong><span class="koboSpan" id="kobo.1424.1"> to load the page with sequential queries and without a </span><span class="No-Break"><span class="koboSpan" id="kobo.1425.1">caching mechanism</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1426.1">http://127.0.0.1:8000/dashboard-concurrent-cached</span></strong><span class="koboSpan" id="kobo.1427.1"> to load the page with parallel</span><a id="_idIndexMarker285"/><span class="koboSpan" id="kobo.1428.1"> queries and with a </span><span class="No-Break"><span class="koboSpan" id="kobo.1429.1">caching mechanism</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1430.1">Now that we have implemented the logic and opened the pages, we are going to analyze </span><span class="No-Break"><span class="koboSpan" id="kobo.1431.1">the result.</span></span></p>
<h2 id="_idParaDest-83"><a id="_idTextAnchor090"/><span class="koboSpan" id="kobo.1432.1">The result</span></h2>
<p><span class="koboSpan" id="kobo.1433.1">The result that you can </span><a id="_idIndexMarker286"/><span class="koboSpan" id="kobo.1434.1">see is impressive as, from a response that took more than 200 milliseconds, you will now have a response that takes 3 or </span><span class="No-Break"><span class="koboSpan" id="kobo.1435.1">4 milliseconds.</span></span></p>
<p><span class="koboSpan" id="kobo.1436.1">The longer response is from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1437.1">/dashboard</span></strong><span class="koboSpan" id="kobo.1438.1">, where sequential queries are implemented without a cache. </span><span class="koboSpan" id="kobo.1438.2">The fastest responses come from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1439.1">/dashboard-concurrent-cached</span></strong><span class="koboSpan" id="kobo.1440.1">, which uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.1441.1">Octane::concurrently()</span></strong><span class="koboSpan" id="kobo.1442.1"> to execute the queries, and the result is cached for </span><span class="No-Break"><span class="koboSpan" id="kobo.1443.1">20 seconds:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1444.1">
  200    GET /dashboard ...... </span><span class="koboSpan" id="kobo.1444.2">19.15 mb 261.34 ms
  200    GET /dashboard ...... </span><span class="koboSpan" id="kobo.1444.3">19.36 mb 218.45 ms
  200    GET /dashboard ...... </span><span class="koboSpan" id="kobo.1444.4">19.36 mb 223.23 ms
  200    GET /dashboard ...... </span><span class="koboSpan" id="kobo.1444.5">19.36 mb 222.72 ms
  200    GET /dashboard-concurrent-cached .............................. </span><span class="koboSpan" id="kobo.1444.6">19.80 mb 112.64 ms
  200    GET /dashboard-concurrent-cached ................................ </span><span class="koboSpan" id="kobo.1444.7">19.81 mb 3.93 ms
  200    GET /dashboard-concurrent-cached ................................ </span><span class="koboSpan" id="kobo.1444.8">19.81 mb 3.69 ms
  200    GET /dashboard-concurrent-cached ................................ </span><span class="koboSpan" id="kobo.1444.9">19.81 mb 4.28 ms
  200    GET /dashboard-concurrent-cached ................................ </span><span class="koboSpan" id="kobo.1444.10">19.81 mb 4.62 ms</span></pre>
<p><span class="koboSpan" id="kobo.1445.1">When you are caching data in Octane Cache, you should also be aware of the cache configuration. </span><span class="koboSpan" id="kobo.1445.2">A wrong configuration could raise some errors in </span><span class="No-Break"><span class="koboSpan" id="kobo.1446.1">your application.</span></span></p>
<h1 id="_idParaDest-84"><a id="_idTextAnchor091"/><span class="koboSpan" id="kobo.1447.1">The cache configuration</span></h1>
<p><span class="koboSpan" id="kobo.1448.1">A typical </span><a id="_idIndexMarker287"/><span class="koboSpan" id="kobo.1449.1">exception that you might see when you start to use Octane Cache in a real scenario is something </span><span class="No-Break"><span class="koboSpan" id="kobo.1450.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1451.1">
Value [a:4:{i:0;i:100000;i:...] is too large for [value] column</span></pre>
<p><span class="koboSpan" id="kobo.1452.1">The solution to the error message above is to change the cache configuration by increasing the number of bytes allocated for storing the cache values. </span><span class="koboSpan" id="kobo.1452.2">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1453.1">config/octane.php</span></strong><span class="koboSpan" id="kobo.1454.1"> file, you can configure the cache for the number of rows and the number of bytes allocated for </span><span class="No-Break"><span class="koboSpan" id="kobo.1455.1">the cache.</span></span></p>
<p><span class="koboSpan" id="kobo.1456.1">By default, the configuration is </span><span class="No-Break"><span class="koboSpan" id="kobo.1457.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1458.1">
    'cache' =&gt; [
        'rows' =&gt; 1000,
        'bytes' =&gt; 10000,
    ],</span></pre>
<p><span class="koboSpan" id="kobo.1459.1">If you get the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1460.1">Value is too large</span></strong><span class="koboSpan" id="kobo.1461.1"> exception in your browser, you might have to increase the number of bytes in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1462.1">config/octane.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1463.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1464.1">
    'cache' =&gt; [
        'rows' =&gt; 1000,
        'bytes' =&gt; 100000,
    ],</span></pre>
<p><span class="koboSpan" id="kobo.1465.1">So now, using</span><a id="_idIndexMarker288"/><span class="koboSpan" id="kobo.1466.1"> Octane features, you can improve the response time and some aspects of </span><span class="No-Break"><span class="koboSpan" id="kobo.1467.1">your application.</span></span></p>
<h1 id="_idParaDest-85"><a id="_idTextAnchor092"/><span class="koboSpan" id="kobo.1468.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.1469.1">In this chapter, we built a very simple application that allowed us to cover multiple aspects of building a Laravel application, such as importing the initial data, optimizing the routing mechanism, integrating third-party data via HTTP requests, and using a cache mechanism via Octane Cache. </span><span class="koboSpan" id="kobo.1469.2">We also used some Laravel Octane features in order to reduce the page loading response time thanks to </span><span class="No-Break"><span class="koboSpan" id="kobo.1470.1">the following:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1471.1">Octane::route</span></strong><span class="koboSpan" id="kobo.1472.1"> for optimizing the routing </span><span class="No-Break"><span class="koboSpan" id="kobo.1473.1">resolution process</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1474.1">Octane::concurrently</span></strong><span class="koboSpan" id="kobo.1475.1"> for optimizing and starting </span><span class="No-Break"><span class="koboSpan" id="kobo.1476.1">parallel tasks</span></span></li>
<li><span class="koboSpan" id="kobo.1477.1">Octane Cache for adding a cache based on Swoole to </span><span class="No-Break"><span class="koboSpan" id="kobo.1478.1">our application</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1479.1">We learned how to execute queries and API calls concurrently and use the cache mechanism for reusing the content across </span><span class="No-Break"><span class="koboSpan" id="kobo.1480.1">the requests.</span></span></p>
<p><span class="koboSpan" id="kobo.1481.1">In the next chapter, we will take a look at some other aspects of performance that are not strictly provided by Octane but can affect your Octane </span><span class="No-Break"><span class="koboSpan" id="kobo.1482.1">optimization process.</span></span></p>
<p><span class="koboSpan" id="kobo.1483.1">We will also apply a different strategy for caching using the scheduled tasks provided by Octane and </span><span class="No-Break"><span class="koboSpan" id="kobo.1484.1">other optimizations.</span></span></p>
</div>
<div>
<div class="Content" id="_idContainer038">
</div>
</div>
</body></html>