<html><head></head><body><div class="chapter" title="Chapter&#xA0;1.&#xA0;Instant Yii 1.1 Application Development Starter"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Instant Yii 1.1 Application Development Starter</h1></div></div></div><p>Welcome to <span class="emphasis"><em>Instant Yii 1.1 Application Development Starter</em></span>. This book has been designed as a crash course in web application development with the Yii Framework. You will learn a step-by-step approach to building database-driven websites utilizing the features and extensions available in Yii.</p><p>This book contains the following sections:</p><p>
<span class="emphasis"><em>So, what is Yii?</em></span> – In this section, we'll start with a short review of what the Yii framework is, how it got started, and the overall benefits you'll get when you start using it.</p><p>
<span class="emphasis"><em>Installation</em></span> – In this section, we'll install Yii Framework and kickstart your first "Hello World" application with it.</p><p>
<span class="emphasis"><em>Getting started</em></span> – Given the automatically-generated example application, we extend it to be a rudimentary blog according to the blog example from the Yii website, while also learning a lot of the most important concepts in Yii along the way.</p><p>
<span class="emphasis"><em>Top 5 features you need to know about</em></span> – In this section, we continue the practical examples and we explore some not so obvious details and tricks of the framework, which can really help you in developing your application.</p><p>
<span class="emphasis"><em>People and places</em></span> – Lastly, we'll see where to seek help and how to get to know the quite vast Yii community.</p><div class="section" title="So, what is Yii?"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec03"/>So, what is Yii?</h1></div></div></div><p>Yii is an open source framework for web applications built with the PHP scripting language. It was first released late in 2008 to a world bustling with frameworks vying for market share. Although it entered the game somewhat late, this turned out to be an advantage as its creator, Qiang Xue, was able to include some of the best features of existing products in Yii. Also, the lessons he learned as a developer for the Prado framework helped him to build a superior solution. Today, Yii is widely heralded as one of the top PHP web frameworks. You can read more about it at <a class="ulink" href="http://www.yiiframework.com">http://www.yiiframework.com</a>.</p><p>As opposed to the <span class="strong"><strong>Content Management Systems</strong></span> (<span class="strong"><strong>CMS</strong></span>), it is not a complete skeleton of your website, which is configurable by some sort of graphical user interface. You have probably heard the names Joomla! and Drupal, which are particularly famous CMS examples in the PHP world.</p><p>On the contrary, Yii is called a framework because it has a set of built-in components. You, as a web application developer, can and definitely should freely use these to save your development time.</p><p>So, whether you just need a quick database app, some web services, or you have been tasked with building a whole corporate web portal, Yii will lay the groundwork and set you on the right path.</p><p>Probably the most important parts of Yii are the complete database access layer and the highly intricate page rendering system. It comes with pre-built smart UI controls like the data grids or something simpler like datepickers, ready to be used on web pages. Also, for many routine coding tasks there are a set of automatic code generators. All of this will be explained in further sections.</p><p>The Yii website also contains a huge number of user-contributed extensions to help you add functionality quickly. Applications built with the Yii clean organization style turn out highly extensible and easy to maintain.</p><p>Yii enforces a tried and true architecture for your application, known as <span class="strong"><strong>Model View Controller</strong></span> (<span class="strong"><strong>MVC</strong></span>). This structure utilizes object-oriented principles to make clean separations in code organization.</p><p>Controllers receive requests, instantiate and manipulate the models that do the real work, and finally render the views for interaction with the end user. This will be discussed in later sections to a greater depth; however, it'll be important to know that unlike in the original MVC definition, views in Yii are completely passive, being just the page templates and not the full-fledged classes.</p><div class="mediaobject"><img src="graphics/1684OS_01_01.jpg" alt="So, what is Yii?"/></div><p>Yii's speed is unmatched thanks to some intelligent design choices at the core level. Most frameworks lose performance when they load more functionality than required for a given request. Loading too many classes can mean more disk reads, as each class is generally stored in its own file, or at least more processing if scripts are cached. More classes generally also result in additional database transactions, and all of these operations are both time and resource consuming.</p><p>Yii sticks to a philosophy of lazy-loading, where it strives not to load classes until they are actually needed. The core framework also adds no additional tables to your database, and makes only the minimum number of requests required to fetch the data for a given action. When your app is ready for production, there are a number of caching options to take performance to the next level. To reduce file I/O, Yii has built-in components that encapsulate common data caching solutions such as APC, Memcached, XCache, and EAccelerator. It also has a few components to handle caching of computed application data for an appropriate amount of time, such as the result of a complex database query.</p><p>Nowadays, when a website allows users to post content, it runs the risk that some of that content might actually be malicious code. Probably the most frequent are <span class="strong"><strong>SQL Injection</strong></span>, <span class="strong"><strong>Cross-Site Scripting</strong></span> (<span class="strong"><strong>XSS</strong></span>), and <span class="strong"><strong>Cross-site Request Forgery</strong></span> (<span class="strong"><strong>CSRF</strong></span>) attacks. Of course, you can look up these terms in Wikipedia, but you can also look up the detailed review of all these types of attacks in the <span class="emphasis"><em>Web Application Hacker's Handbook</em></span>, by Stuttard Pinto, printed by Wiley in 2011. These are the common problems that website developers must address when accepting form data. Yii has built-in means to cope with them. All database interactions made properly by the Yii API sanitize user input automatically.</p><p>For dealing with user-generated content that will be rendered on the web pages, Yii encapsulates a project called <span class="strong"><strong>HTML Purifier</strong></span>, which can be applied to any input field and will filter out any malicious code, unless specified on a white list. The homepage of the project is <a class="ulink" href="http://htmlpurifier.org/">http://htmlpurifier.org/</a>, and it is included in the component.</p><p>For automatic protection from CSRF attacks of all your forms altogether, there is a single switch-in configuration. It will pass a random value to a user when they load a form. By having this value passed back, the interaction is validated.</p><p>All these features will be explained later in the <span class="emphasis"><em>Top features</em></span> section.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip01"/>Tip</h3><p>
<span class="strong"><strong>Downloading the example code</strong></span>
</p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.PacktPub.com">http://www.PacktPub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.PacktPub.com/support">http://www.PacktPub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div></div></div>
<div class="section" title="Installation"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec04"/>Installation</h1></div></div></div><p>Yii is a web application framework, so the first thing you need is a web server. Yii is capable of running on most common HTTP servers, but the platform of choice for project maintainers and testers is Apache on Linux. NGINX is also a good choice, and you can also run Yii on Windows servers with Apache or Microsoft's IIS server.</p><p>All instructions in this section assume the Linux (or Mac OS) environment with an Apache server.</p><div class="section" title="Server requirements"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec03"/>Server requirements</h2></div></div></div><p>As Yii is a PHP framework, the main dependency of Yii is PHP (version 5.1.0 or higher). Yii also makes use of a few key PHP extensions. These include PDO for MySQL or PostgreSQL, the DOM extension, Mcrypt for security, SOAP, and GD for image processing. For data caching, it requires either Memcache, APC, XCache, or EAccellerator, all of which are optional. Yii supports database solutions such as MySQL 4.1 or greater, PostgreSQL 7.3 and above, SQLite 2 and 3, Microsoft SQL Server 2000 or later, and Oracle. Depending on which database is selected for the project, the appropriate PHP extension will be required. Please note that you don't need a database at all to use Yii in your application, however, you'll definitely lose a lot of data persistence solutions built in the framework.</p></div><div class="section" title="Step 1 – Setting up Yii"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec04"/>Step 1 – Setting up Yii</h2></div></div></div><p>Let's start from the assumption that you already have the following things:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A running and configured web server such as Apache</li><li class="listitem" style="list-style-type: disc">A folder published as a webroot of a website accessible from your browser</li></ul></div><p>So the only thing you need to set up right now is a real website in this webroot folder. Properly doing this two things is surely out of scope of this book.</p><p>The place where you get the Yii framework bundle is the downloads section at the official website (direct URL is <a class="ulink" href="http://www.yiiframework.com/download">http://www.yiiframework.com/download</a>). For application development, you need a stable version packaged in the archive file. You don't need to get the sources of Yii from a GitHub or Subversion repository unless you want to fiddle with the framework itself.</p><p>The ideology behind Yii is that the framework itself lies outside of your application directory, preferably in some system directory with root user access only. The framework's folder should be configured so only your web server will have rights to read the files in it. This policy is to prevent the unwanted direct access to framework files by the request to web server. When you create your application, you also configure its real path to the Yii directory.</p><p>In short, for Linux systems with a web server running as the user <code class="literal">apache</code>, you can install Yii Version 1.1.13. e9e4a0 from the command line as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># cd /var/local/</strong></span>
<span class="strong"><strong># wget http://yii.googlecode.com/files/yii-1.1.13.e9e4a0.tar.gz</strong></span>
<span class="strong"><strong># tar –zxf yii-1.1.13.e9e4a0.tar.gz &amp;&amp; rm yii-1.1.13.e9e4a0.tar.gz</strong></span>
<span class="strong"><strong># chown -R apache yii-1.1.13.e9e4a0</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note01"/>Note</h3><p>Note that for working in a system folder like <code class="literal">/var/local</code>, you need to be a root user. Of course, you can use any directory you like.</p></div></div><p>Inside the resulting <code class="literal">yii</code> directory, you'll find three folders named as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">demos</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">framework</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">requirements</code></li></ul></div><p>The <code class="literal">requirements</code> folder is a helper to make a self test for your server setup. You can copy it to your webroot folder and access <code class="literal">http://your.website.address/requirements/index.php</code> from the web browser to see whether your system complies to the framework's requirements.</p><p>The <code class="literal">framework</code> folder is the Yii framework itself. You essentially only need its contents to use Yii in your application. From now on, we'll refer to the path under which Yii is installed as <code class="literal">path-to-yii</code>.</p></div><div class="section" title="Step 2 – Creating your project"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec05"/>Step 2 – Creating your project</h2></div></div></div><p>Once you have the framework installed on your machine, there is a command-line tool called <code class="literal">yiic</code> that is capable of building the skeleton application, among other quite numerous things. Open a console, navigate to your webroot, then run the autogenerator command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ path-to-yii/framework/yiic webapp sitename</strong></span>
</pre></div><p>The <code class="literal">sitename</code> token is the path to your new application. As you are already in your <code class="literal">webroot</code> folder, you just need to provide a name of a subfolder and not a full path to it.</p><p>This shell script is intended for use on Linux, so if you are on Windows, there is a <code class="literal">yiic.bat</code> file. Both scripts essentially run <code class="literal">framework/yiic.php</code> with the PHP command-line executable on your system, so the alternative method is to run it as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php path-to-yii/framework/yiic.php webapp sitename</strong></span>
</pre></div><p>Before you can visit your site, you must check the <code class="literal">index.php</code> file to make sure it points to the actual Yii installation folder.</p><p>Make sure you have a line that looks like this in <code class="literal">sitename</code>/<code class="literal">index.php</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$yii='path-to-yii/framework/yii.php';</strong></span>
</pre></div><p>You can now visit your site and see the basic hello world website with a homepage, about, contact, and a login page. As the application was created in a subfolder of your <code class="literal">webroot</code> folder, the URL should be like this: <code class="literal">http://your.website.address/sitename</code>.</p></div><div class="section" title="And that's it!!"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec06"/>And that's it!!</h2></div></div></div><p>Your application folder will contain the following structure under the <code class="literal">sitename</code> folder:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">assets</code>: Contains published resource files</li><li class="listitem" style="list-style-type: disc"><code class="literal">css</code>: Contains CSS files</li><li class="listitem" style="list-style-type: disc"><code class="literal">images</code>: Contains image files</li><li class="listitem" style="list-style-type: disc"><code class="literal">themes</code>: Contains application themes</li><li class="listitem" style="list-style-type: disc"><code class="literal">protected</code>: Contains protected application files</li></ul></div><p>The protected folder contains the following directories:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">commands</code>: Contains customized yiic commands</li><li class="listitem" style="list-style-type: disc"><code class="literal">components</code>: Contains reusable user components</li><li class="listitem" style="list-style-type: disc"><code class="literal">config</code>: Contains configuration files</li><li class="listitem" style="list-style-type: disc"><code class="literal">controllers</code>: Contains controller class files</li><li class="listitem" style="list-style-type: disc"><code class="literal">data</code>: Contains the sample database</li><li class="listitem" style="list-style-type: disc"><code class="literal">extensions</code>: Contains third-party extensions</li><li class="listitem" style="list-style-type: disc"><code class="literal">messages</code>: Contains translated messages</li><li class="listitem" style="list-style-type: disc"><code class="literal">models</code>: Contains model class files</li><li class="listitem" style="list-style-type: disc"><code class="literal">runtime</code>: Contains temporarily generated files</li><li class="listitem" style="list-style-type: disc"><code class="literal">tests</code>: Contains test scripts</li><li class="listitem" style="list-style-type: disc"><code class="literal">views</code>: Contains controller view and layout files</li></ul></div><p>The <code class="literal">views</code> folder contains the following directories:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">layouts</code>: Contains layout view files</li><li class="listitem" style="list-style-type: disc"><code class="literal">site</code>: Contains view files for the site controller</li></ul></div></div></div>
<div class="section" title="Quick start &#x2013; creating an application"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec05"/>Quick start – creating an application</h1></div></div></div><p>The Yii website contains, among its wonderful documentation, a tutorial on how to build a basic blog application, which is one of the included demos in the framework source. It's in <span class="strong"><strong>Tutorials</strong></span> | <span class="strong"><strong>The Yii Blog Tutorial</strong></span> section. The direct URL is <a class="ulink" href="http://www.yiiframework.com/doc/blog/">http://www.yiiframework.com/doc/blog/</a>.</p><p>Let's use this example while we explain the aspects of Yii-based applications. We will not repeat the complete example here, of course, because you can read it in full on the website.</p><div class="section" title="Step 1 – planning the workflow"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec07"/>Step 1 – planning the workflow</h2></div></div></div><p>When you write a real application, you should start with the requirements regarding application functionality. For the blog example, this is described in the Getting Started: Requirements Analysis section at the very beginning of the tutorial. The direct URL is <a class="ulink" href="http://www.yiiframework.com/doc/blog/1.1/en/start.requirements">http://www.yiiframework.com/doc/blog/1.1/en/start.requirements</a>.</p><p>After you have written all the desired features, you basically start implementing them one by one. Of course, in serious software development there's a lot of gotchas included, but overall it's the same.</p><p>The blog example is a database driven application, so we need to prepare a database schema beforehand. Here's what they came up with for the blog demo:</p><div class="mediaobject"><img src="graphics/1684OS_03_01.jpg" alt="Step 1 – planning the workflow"/></div><p>This image is a verbatim copy from the blog example demo. Note that there are two links missing. The posts table has a <code class="literal">tags</code> field, which is the storage area for tags written in raw and is not a foreign key to the <code class="literal">tags</code> table. Also, the <code class="literal">author</code> field in <code class="literal">comment</code> should really be the foreign key to the <code class="literal">user</code> table. Anyways, we'll not cover the actual database generation, but I suggest you do it yourself. The blog tutorial at the Yii website has all the relevant instructions addressed to total newbies.</p><p>Next in this section, we will see how easy it is with Yii to get a working user interface that will be able to manipulate our database.</p></div><div class="section" title="Step 2 – linking to the database from your app"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Step 2 – linking to the database from your app</h2></div></div></div><p>Once you design and physically create the database in some database management system like MySQL or maybe SQLite, you are ready to configure your app to point to this database. The skeleton app generated by the <code class="literal">./yiic webapp</code> command needs to be configured to point to this database. To do this, you need to set a <code class="literal">db</code> component in the main <code class="literal">config</code> file located at <code class="literal">protected/config/main.php</code>. There is a section that contains an array of components. Following is the setup for a MySQL database located at the same server as the web application itself. You will find a commented-out template for this already present when you generate your app:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>/protected/config/main.php</strong></span>

'components'=&gt;array(
    /* other components */
    'db'=&gt;array(
        'connectionString' =&gt; 'mysql:host=localhost;dbname=DB_NAME,
        'emulatePrepare' =&gt; true,
        'username' =&gt; YOUR_USERNAME,
        'password' =&gt; YOUR_PASSWORD,
        'charset' =&gt; 'utf8',
    ),
    /* other components */
),</pre></div><p>This is a default component having a <code class="literal">CDbConnection</code> class and is used by all of our ActiveRecord objects which we will create later. As with all application components, all configuration parameters correspond to the public properties of the component's class;so, you can check the API documentation for details.</p><p>By the way, you really need to understand more about the main application config. Read about it in the <span class="emphasis"><em>Definitive Guide to Yii</em></span> on the official website at <span class="strong"><strong>Fundamentals</strong></span> | <span class="strong"><strong>Application</strong></span> | <span class="strong"><strong>Application Configuration</strong></span>. The direct URL is <a class="ulink" href="http://www.yiiframework.com/doc/guide/1.1/en/basics.application#application-configuration">http://www.yiiframework.com/doc/guide/1.1/en/basics.application#application-configuration</a>.</p><p>Just remember that all configuration parameters are just properties of the <code class="literal">CWebApplication</code> object, which you can read about in the API documentation; the direct URL is <a class="ulink" href="http://www.yiiframework.com/doc/api/1.1/CWebApplication">http://www.yiiframework.com/doc/api/1.1/CWebApplication</a>.</p></div><div class="section" title="Step 3 – generating code automatically"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec09"/>Step 3 – generating code automatically</h2></div></div></div><p>Now that we have our app linked up to a fully built database, we can start using one of Yii's greatest features: automatic code generation. To get started, there are two types of code generation that are necessary:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Generate a model class based on the tables in your database</li><li class="listitem" style="list-style-type: disc">Run the CRUD generator that takes a model and sets up a corresponding controller and a set of views for basic listing, creating, viewing, updating, and deleting from the table</li></ul></div><div class="section" title="The console way"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec01"/>The console way</h3></div></div></div><p>There are two ways to go about automatic code generating. Originally, there was only the <code class="literal">yiic</code> tool used earlier to create the skeleton app. For the automatic code generation features, you would use the <code class="literal">yiic shell index.php</code> command, which would bring up a command-line interface where you could run subcommands for modeling and scaffolding.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ /usr/local/yii/framework/yiic shell index.php</strong></span>
<span class="strong"><strong>Yii Interactive Tool v1.1 (based on Yiiv1.1.13)</strong></span>
<span class="strong"><strong>Please type 'help' for help. Type 'exit' to quit.</strong></span>
<span class="strong"><strong>&gt;&gt; model Post tbl_post</strong></span>
<span class="strong"><strong>   generate models/Post.php</strong></span>
<span class="strong"><strong>   unchanged fixtures/tbl_post.php</strong></span>
<span class="strong"><strong>   generate unit/PostTest.php</strong></span>
<span class="strong"><strong>The following model classes are successfully generated:</strong></span>
<span class="strong"><strong>    Post</strong></span>
<span class="strong"><strong>If you have a 'db' database connection, you can test these models now with:</strong></span>
<span class="strong"><strong>    $model=Post::model()-&gt;find();</strong></span>
<span class="strong"><strong>    print_r($model);</strong></span>

<span class="strong"><strong>&gt;&gt; crud Post</strong></span>
<span class="strong"><strong>   generate PostController.php</strong></span>
<span class="strong"><strong>   generate PostTest.php</strong></span>
<span class="strong"><strong>mkdir /var/www/app/protected/views/post</strong></span>
<span class="strong"><strong>   generate create.php</strong></span>
<span class="strong"><strong>   generate update.php</strong></span>
<span class="strong"><strong>   generate index.php</strong></span>
<span class="strong"><strong>   generate view.php</strong></span>
</pre></div><p>As you can see, this is a quick and easy way to perform the <code class="literal">model</code> and <code class="literal">crud</code> actions. The <code class="literal">model</code> command produces just two files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For your actual model class</li><li class="listitem" style="list-style-type: disc">For unit tests</li></ul></div><p>The <code class="literal">crud</code> command creates your controller and view files.</p></div><div class="section" title="Gii"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec02"/>Gii</h3></div></div></div><p>Console tools may be the preferred option for some, but for developers who like to use graphical tools, there is now a solution for this, called <span class="strong"><strong>Gii</strong></span>.</p><p>To use Gii, it is necessary to turn it on in the main <code class="literal">config</code> file: <code class="literal">protected/config/main.php</code>. You will find the template for it already present, but it is commented out by default. Simply uncomment it, set your password, and decide from what hosts it may be accessed. The configuration looks like this:</p><div class="informalexample"><pre class="programlisting">'gii'=&gt;array(
    'class'=&gt;'system.gii.GiiModule',
    'password'=&gt;'giiPassword',

    // If removed, Gii defaults to localhost only.
    // Edit carefully to taste.
    'ipFilters'=&gt;array('127.0.0.1','::1'),

    // For development purposes,
    // a wildcard will allow access from anywhere.
    // 'ipFilters'=&gt;array('*'),
),</pre></div><p>Once Gii is configured, it can be accessed by navigating to the app URL with <code class="literal">?r=gii</code> after it, for example, <code class="literal">http://www.example.com/index.php?r=gii</code>. It will begin with a prompt asking for the password set in the <code class="literal">config</code> file. Once entered, it will display a list of generators. If the database is not set in the <code class="literal">config</code> file, you will see an error when you attempt to use one.</p><p>The most basic generator in Gii is the model generator. It asks for a table name from the database and a name to be used for the <code class="literal">PHP</code> class.</p><p>Note that we can specify a table name prefix, which will be ignored when generating the model class name. For instance, the blog demo's user table is <code class="literal">tbl_user</code>, where the <code class="literal">tbl_</code> is a prefix. This feature exists to support some setups, especially common in shared hosting environments, where a single database holds tables for several distinct applications. In such an environment, it's a common practice to prefix something to names of tables to avoid getting into naming conflict and to easily find tables relevant to some specific application. So, as these prefixes don't mean anything in the application itself, Gii offers a way to automatically ignore them. Model class names are being constructed from the remaining table names by the obvious rules:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Underscores are converted to uppercasing the next letter</li><li class="listitem" style="list-style-type: disc">The first letter of the class name is being uppercased as well</li></ul></div><p>The first step in getting your application off the ground is to generate models for all the entity tables in your database. Things such as bridge tables will not need models, as they simply relate two entities to one another rather than actually being a distinct thing. Bridge tables are being used for generating relations between models, expressed in the <code class="literal">relations</code> method in model class.</p><p>For the blog demo, the basic models are User, Post, Comment, Tag, and Lookup.</p><div class="mediaobject"><img src="graphics/1684OS_03_02.png.jpg" alt="Gii"/></div><p>The second phase of scaffolding is to generate the CRUD code for each of these models. This will create a controller and a series of view templates. The controller (for example, <code class="literal">PostController</code>) will handle routing to actions related to the given model. The view files represent everything needed to list and view entities, as well as the forms needed to create and update individual entities.</p><div class="mediaobject"><img src="graphics/1684OS_03_03.png.jpg" alt="Gii"/></div><p>For all the generators, you will start with a form where you fill in either a <span class="strong"><strong>Table Name</strong></span> field for the <span class="strong"><strong>Model Generator</strong></span> page, or a <span class="strong"><strong>Model Class</strong></span> field for the <span class="strong"><strong>Crud Generator</strong></span> page. Afterward, you will have to hit the <span class="strong"><strong>Preview</strong></span> button, which will show you exactly what files will be created. Finally, you must hit the <span class="strong"><strong>Generate</strong></span> button for the actions to take place.</p><div class="mediaobject"><img src="graphics/1684OS_03_04.png.jpg" alt="Gii"/></div></div></div><div class="section" title="Step 4 – looking at the components of Yii"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec10"/>Step 4 – looking at the components of Yii</h2></div></div></div><p>So now that you've seen the basics of what is being created here, let's take a deeper look at these components.</p><div class="section" title="Models"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec03"/>Models</h3></div></div></div><p>Yii's models are just PHP classes that extend from the <code class="literal">CModel</code> base class. The framework already contains two helper subclasses of <code class="literal">CModel</code>: <code class="literal">CFormModel</code> and <code class="literal">CActiveRecord</code>.</p><p>While <code class="literal">CFormModel</code> is just a semantic wrapper around the concept of a user-submitted HTML form, <code class="literal">CActiveRecord</code> is a complete implementation of an ActiveRecord design pattern.</p><p>It is a well known and commonly used pattern for database driven applications. Yii got a lot of inspiration in this area from the Rails framework for Ruby, which has what is widely considered to be one of the best implementations of ActiveRecord. As with any other design pattern (even MVC), you can read about it in the definitive book <span class="emphasis"><em>Design Patterns: Elements of Reusable Object-Oriented Software</em></span> by Ralph Johnson.</p><p>To make things simple, ActiveRecord is an object-oriented pattern that calls for a one-to-one mapping of database tables to classes (for example, <code class="literal">tbl_post</code> to <code class="literal">Post</code> model, <code class="literal">tbl_comment</code> to <code class="literal">Comment model</code>). In its original definition, ActiveRecord is not really a one-to-one mapping (one class can use any number of tables for storing data), but ActiveRecords in Yii work this way.</p><p>Instances of a model class will have properties that correspond to fields in the table, as well as methods that correspond to database transactions, such as save, delete, and various lookup options:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$post-&gt;title = 'Post Title';</strong></span>
<span class="strong"><strong>$post-&gt;body = 'Post body content';</strong></span>
<span class="strong"><strong>$post-&gt;save();</strong></span>
</pre></div><p>Almost all of our models will be the ancestors of the <code class="literal">CActiveRecord</code> class.</p><p>In the Yii blog demo, if we look at the <code class="literal">Post</code> model, we will see that it contains rules for each field based on the database constraints. It knows which fields are integer or text-based, as well as length and null requirements. These control the validations Yii will perform when attempting to save records.</p><div class="informalexample"><pre class="programlisting">/* protected/models/Post.php */
public function rules()
{
    // NOTE: you should only define rules for those 
    //attributes that will receive user inputs.
    return array(
        array('title, content, status', 'required'),
        array('status', 'in', 'range'=&gt;array(1,2,3)),
        array('title', 'length', 'max'=&gt;128),
        array('tags', 'match', 
            'pattern'=&gt;'/^[\w\s,]+$/', 
            'message'=&gt;'Tags can only contain word characters.'),
        array('tags', 'normalizeTags'),
        array('title, status', 'safe', 'on'=&gt;'search'),
    );
}</pre></div><p>Another important thing that Yii will set up based on the database table is any foreign key relationship it finds. For the blog demo, a post will have a single author that it belongs to and a number of comments that belong to the <code class="literal">Post</code>. As we can see in the following example, these relationships can be quite sophisticated. Just have a look at the official documentation for the <code class="literal">CActiveRecord.relations</code> method (<a class="ulink" href="http://www.yiiframework.com/doc/api/1.1/CActiveRecord#relations-detail">http://www.yiiframework.com/doc/api/1.1/CActiveRecord#relations-detail</a>). The comments have been filtered to only show approved comments and to retrieve comments with a particular sort order. Yii also allows statistical relationships, so you can get a count of related items such as the count of all the approved comments:</p><div class="informalexample"><pre class="programlisting">public function relations()
{
    // NOTE: you may need to adjust the relation name and the related
    // class name for the relations automatically generated below.
    return array(
        'author' =&gt; array(self::BELONGS_TO, 'User', 'author_id'),
        'comments' =&gt; array(self::HAS_MANY, 'Comment', 'post_id',
            'condition'=&gt;'comments.status='.Comment::STATUS_APPROVED,
            'order'=&gt;'comments.create_timeDESC'),
        'commentCount' =&gt; array(self::STAT, 'Comment', 'post_id',
            'condition'=&gt;'status='.Comment::STATUS_APPROVED),
    );
}</pre></div><p>Beyond rules and relationships, the model defaults to having a section for user-friendly labels for attributes, which default to being only slightly cleaner than the actual table names, but can be changed to fit your application needs:</p><div class="informalexample"><pre class="programlisting">public function attributeLabels()
{
    return array(
        'id' =&gt; 'Id',
        'title' =&gt; 'Title',
        'content' =&gt; 'Content',
        'tags' =&gt; 'Tags',
        'status' =&gt; 'Status',
        'create_time' =&gt; 'Create Time',
        'update_time' =&gt; 'Update Time',
        'author_id' =&gt; 'Author',
    );
}</pre></div><p>There is also a search method, which is intended for use on list pages.</p><p>Please note that this method is not important to the functionality of the model per se; it is just a helper method. It returns an instance of <code class="literal">CDataProvider</code>, which is used by virtually all list and table widgets in Yii; so, the authors of the framework decided to include this method in the model being autogenerated to further reduce the need to write scaffolding code. The developer can decide to feed hand crafted data providers to the widgets or instead use some other helpers.</p><p>Yii has widgets for displaying and paging through records, such as <code class="literal">CGridView</code> or <code class="literal">CListView</code>. These will use the search method to create a data provider object for this interaction. Again, you can customize the behavior of the way records are retrieved with this method. The <code class="literal">Post</code> model has been set to add some default sorting options and ignore some fields:</p><div class="informalexample"><pre class="programlisting">public function search()
{
    $criteria=new CDbCriteria;
    $criteria-&gt;compare('title',$this-&gt;title,true);
    $criteria-&gt;compare('status',$this-&gt;status);
    return new CActiveDataProvider('Post', array(
        'criteria'=&gt;$criteria,
        'sort'=&gt;array(
            'defaultOrder'=&gt;'status, update_time DESC',
        ),
    ));
}</pre></div></div><div class="section" title="Controllers"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec04"/>Controllers</h3></div></div></div><p>The job of a controller is to deal with incoming requests, identify the appropriate action method, and ultimately render a view to return to the user. When a request comes in to Yii, the URL dictates which controller and action has been called for. All requests are first handled by the <code class="literal">index.php</code> file in the root of your website. This file starts loading your application by instantiating Yii and referencing your configuration file. It then looks at the rest of the URL to determine which controller should run. There is a route parameter <code class="literal">r</code> that is checked. The appropriate use is <code class="literal">index.php?r=controller/action</code>.</p><p>By default, applications generated by the <code class="literal">./yiic webapp</code> console tool have a <code class="literal">SiteController</code> controller, which handles standard actions such as presenting a default homepage or dealing with login/logout actions. This controller will be called when you bring up your app without any URL parameters.</p><p>If we elaborate on that, then what is really happening is that when Yii gets a request without a controller specified, it will forward this request to the controller whose name is set in the <code class="literal">defaultController</code> configuration parameter (see <a class="ulink" href="http://www.yiiframework.com/doc/api/1.1/CWebApplication#defaultController-detail">http://www.yiiframework.com/doc/api/1.1/CWebApplication#defaultController-detail</a>), and it's default value is <code class="literal">site</code>.</p><p>As you probably guessed already, if the request doesn't specify the action, then the <code class="literal">defaultAction</code> will be called. Of course, it's defined not as the global configuration parameter but separately in each controller as its class property (see <a class="ulink" href="http://www.yiiframework.com/doc/api/1.1/CController#defaultAction-detail">http://www.yiiframework.com/doc/api/1.1/CController#defaultAction-detail</a>). The default value for the <code class="literal">defaultAction</code> property is <code class="literal">index</code>.</p><p>So, since site/index is the default behavior when no <code class="literal">r</code> parameter is given, going to <code class="literal">www.yoursite.com</code> is the equivalent of going to <code class="literal">www.yoursite.com/index.php?r=site/index</code>. By default, with a model such as <code class="literal">Post</code>, you would expect to see routes like this:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">www.yoursite.com/index.php?r=post/index</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">www.yoursite.com/index.php?r=post/create</code></li></ul></div><p>…and so on.</p><p>You can see that the actual blog demo does not follow this pattern though. Instead, its paths look like <code class="literal">www.yoursite.com/posts</code> and <code class="literal">www.yoursite.com/post/create</code>. Ultimately, you can make any kind of custom URLs with Yii. Later in this book, we will look at ways to change the way your URL looks, which are cleaner, but still resolve to the same thing.</p><p>If you take a look at one of your controller files in <code class="literal">protected/controllers/</code>, you will see that it has a number of methods that look like: <code class="literal">actionCreate</code>, <code class="literal">actionIndex</code>, <code class="literal">actionUpdate</code>, and so on. The second half of these names correspond to the action that would be in the URL. For example, in <code class="literal">PostController</code>, <code class="literal">actionCreate</code> corresponds to the URL <code class="literal">index.php?r=post/create</code>. The view and update actions expect an additional parameter for the ID of the specified entity. By default, this URL would look like <code class="literal">index.php?r=post/view&amp;id=1</code>, where <code class="literal">1</code> is the primary key ID of a single post.</p><p>All of this means that <code class="literal">actionLogin</code>, <code class="literal">actionLogout</code>, and other actions generated for you by Gii in <code class="literal">SiteController</code> are just example scaffolding, and if you need to, you can make a completely different structure of controllers and actions.</p><p>To better understand how these actions work, let us examine a couple of actions in detail. For most entities, one of the simplest actions is to view a single item, because it does only one thing, which is to respond to GET requests and show the view template. Other actions are more complicated due to the fact they can respond to GET or POST actions. For example, update will simply return the form if the method is GET, but when you post data to this same action, it attempts to save the item and redirect you to the view screen.</p><div class="informalexample"><pre class="programlisting">public function actionView($id)
{
    $model=$this-&gt;loadModel($id);
    $this-&gt;render('view',array(
        'model'=&gt;$model,
    ));
}</pre></div><p>What the preceding code does is that it starts by running the <code class="literal">loadModel()</code> method, which is found at the bottom of the controller code. This method looks for a URL parameter called <code class="literal">id</code> and does a lookup using ActiveRecord methods. It throws the 404 exception if it fails to find a corresponding record, which is appropriate since 404 is generally used for Page-Not-Found situations:</p><div class="informalexample"><pre class="programlisting">public function loadModel($id)
{
    $model=Post::model()-&gt;findByPk($id);
    if($model===null)
        throw new CHttpException(
            404,
            'The requested page does not exist.'
        );
    return $model;
}</pre></div><p>If a model is found, the action method continues and all it has left to do is pass that model on to the view with the render function:</p><div class="informalexample"><pre class="programlisting">public function actionUpdate($id)
{
    $model=$this-&gt;loadModel($id);

    if (isset($_POST['Post']))
    {
        $model-&gt;attributes=$_POST['Post'];
        if ($model-&gt;save())
            $this-&gt;redirect(array('view','id'=&gt;$model-&gt;id));
    }

    $this-&gt;render('update',array(
        'model'=&gt;$model,
    ));
}</pre></div><p>The Update action, unlike View, does two things. It will respond to both HTTP GET and POST requests. The middle section of the function pertains only to the condition of receiving a POST, so it will be skipped over. In the case of a regular GET, this looks identical to how the View behaves; it simply loads the model based on an expected ID parameter and renders a view file with that model. The interesting part is when you post the form contained on the Update view back to this action. In that case, the old model state is loaded, then its attributes are overwritten with values from the <code class="literal">$_POST</code> array, which contains the form body from the HTML. On the condition that this saves without violating any validation or rules set in the model class, the request is then forwarded to the View page, so see the newly-saved version of the item. If for some reason the save method fails, the code will fall through and render the Update form again. The only difference here is that since the model failed to save, it now contains information about the reasons why it has failed. <code class="literal">$model-&gt;getErrors()</code> will return an array of problems that prevented the save from succeeding. When the Update form is rendered again, these errors will appear at the top of the form, making it simple for the user to correct their mistakes.</p></div><div class="section" title="Views"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec05"/>Views</h3></div></div></div><p>Yii's views are typically put together with at least two parts. There is a main site <code class="literal">layout.php</code> view, which is a wrapper for different views when the controller's <code class="literal">render</code> method is called. The benefit of this is that your overall site design is contained in one place and individual views only need to consist of the relevant content for the body of the page. You can also have more than one standard layout such as a two or a three column format. You can also have a layout included in another layout, by means of the <code class="literal">beginContent</code> method; see <a class="ulink" href="http://www.yiiframework.com/doc/api/1.1/CBaseController#beginContent-detail">http://www.yiiframework.com/doc/api/1.1/CBaseController#beginContent-detail</a>. You'll find the layout file in <code class="literal">views/layouts</code>. You can also have a different layout assigned to different controllers; see <a class="ulink" href="http://www.yiiframework.com/doc/api/1.1/CController#layout-detail">http://www.yiiframework.com/doc/api/1.1/CController#layout-detail</a>. All other views should be contained within a folder that corresponds to the controller they belong to. By default, there are just two folders: <code class="literal">layouts</code> and <code class="literal">site</code>. For each additional model, your CRUD will create another folder.</p></div><div class="section" title="Recap"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec06"/>Recap</h3></div></div></div><p>At this point, we have talked about our database design and how to automatically generate ActiveRecord models for each of our important or entity-class tables. Then, we created controllers and views with the CRUD generator. At this point, we should have a basic database interface. Unfortunately, that's not quite a full-blown web application, because we are not writing the user interface for database administration here, but instead we are building a blog. We'll cover a lot of great features further on in this book, but one more really important step in getting started is to alter the authentication process to use your actual users table/model.</p></div><div class="section" title="User authentication"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec07"/>User authentication</h3></div></div></div><p>Now that the database is configured, one of the first steps you'll want to take is to make the site use your users table for authentication. The control for this is contained within the file <code class="literal">protected/components/UserIdentity.php</code>. By default, this file has two hard-coded user account/password combinations. Replace the content of this file with the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class UserIdentity extends CUserIdentity
{
    private $_id;

    public function authenticate()
    {
        $username=strtolower($this-&gt;username);
        $user=User::model()-&gt;find(
            'LOWER(username)=?',
            array($username)
        );
        if($user===null)
            $this-&gt;errorCode=self::ERROR_USERNAME_INVALID;
<span class="strong"><strong>        else if(!$user-&gt;validatePassword($this-&gt;password))</strong></span>
            $this-&gt;errorCode=self::ERROR_PASSWORD_INVALID;
        else
        {
            $this-&gt;_id=$user-&gt;id;
            $this-&gt;username=$user-&gt;username;
            $this-&gt;errorCode=self::ERROR_NONE;
        }
        return $this-&gt;errorCode==self::ERROR_NONE;
    }
 
    public function getId()
    {
        return $this-&gt;_id;
    }
}</pre></div><p>What you see in here is pretty standard code to authenticate users by login/password pairs stored in the database. If you follow the code, which is intimidating only at first glance, you see that it does the following:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Tries to find in the DB the record about user having the username specified.</li><li class="listitem">If no user with this username is recorded, it sets the error code to <code class="literal">ERROR_USERNAME_INVALID</code> and proceeds to the end of the procedure.</li><li class="listitem">If the user exists, validate password specified using whichever method is defined for validation in the user model.</li><li class="listitem">If validation is unsuccessful, set error code to  <code class="literal">ERROR_PASSWORD_INVALID</code> and proceed to the end of the procedure.</li><li class="listitem">If validation is successful, set the error code to  <code class="literal">ERROR_NONE</code> and proceed to the end of the procedure.</li><li class="listitem">The user is authenticated if the error code is <code class="literal">ERROR_NONE</code>.</li></ol></div><p>Note the highlighted line in the code. It means that we need to modify the user model as well. Put the two following functions into it:</p><div class="informalexample"><pre class="programlisting">    public function validatePassword($password)
    {
        return crypt($password, $this-&gt;password)===$this-&gt;password;
    }
 
    public function hashPassword($password)
    {
<span class="strong"><strong>        return crypt($password, $this-&gt;generateSalt());</strong></span>
    }</pre></div><p>The function named <code class="literal">validatePassword</code>, as we already saw, was used in the authentication process. The function named <code class="literal">hashPassword</code> should be used when the new user model is saved to the database.</p><p>The idea is as follows: we do not store whole passwords as plain text. We hash them using the built-in PHP function <code class="literal">crypt</code> and store these hashes instead. The implementation of <code class="literal">crypt</code> has a very important and useful property. When we pass it the desired password as the first argument, and the already made hash of the same password as the second argument (which is the <span class="emphasis"><em>salt</em></span> of the encryption), it produces the same hash as provided as the second argument. This property is exactly what is used in the <code class="literal">validatePassword()</code> function.</p><p>OK, now about what is the salt. For our purposes, you can just think of salt as a special string that tells <code class="literal">crypt</code> how exactly to encrypt the string provided. The exact rules are written in the official PHP documentation for <code class="literal">crypt</code>, accessible on the website here: <a class="ulink" href="http://www.php.net/manual/en/function.crypt.php">http://www.php.net/manual/en/function.crypt.php</a>.</p><p>So, there's still a <code class="literal">generateSalt</code> function that needs to be implemented. You can just use the following implementation verbatim:</p><div class="informalexample"><pre class="programlisting">/**
 * Generate a random salt in the crypt(3) standard Blowfish format.
 *
 * @param int $cost Cost parameter from 4 to 31.
 *
 * @throws Exception on invalid cost parameter.
 * @return string A Blowfish hash salt for use in PHP's crypt()
 */
private function generateSalt($cost = 13)
{
    if (!is_numeric($cost) || $cost &lt; 4 || $cost &gt; 31) {
        throw new Exception(
            "cost parameter must be between 4 and 31"
        );
    }
    $rand = array();
    for ($i = 0; $i &lt; 8; $i += 1) {
        $rand[] = pack('S', mt_rand(0, 0xffff));
    }
    $rand[] = substr(microtime(), 2, 6);
    $rand = sha1(implode('', $rand), true);
    $salt = '$2a$' . sprintf('%02d', $cost) . '$';
    $salt .= strtr(
        substr(base64_encode($rand), 0, 22), 
        array('+' =&gt; '.')
    );
    return $salt;
}</pre></div><p>This way you have the complete implementation of user authentication made using the current best practices in this field.</p><p>You should note, though, the precise reasons for this implementation.</p><p>First of all, we don't store the passwords as the user entered them. This is a security precaution in case the password database will be accessed by a malicious user.</p><p>Secondly, we use a pretty hardcore Blowfish algorithm, which is very, very slow to run. This is a second precaution in case the malicious user tries to guess the passwords using brute force, for example, encrypting some arbitrary strings the same way we did and comparing the result with the values in our database. If we used something fast, such as the MD5 algorithm, then it would be a lot easier on modern high-performance hardware.</p><p>You probably want to look at the detailed description of what's going on here on the relevant tutorial at the Yii website. This particular authentication scheme is described on the blog demo at <span class="strong"><strong>Initial Prototyping</strong></span> | <span class="strong"><strong>Authenticating User</strong></span>. The direct URL is <a class="ulink" href="http://www.yiiframework.com/doc/blog/1.1/en/prototype.auth">http://www.yiiframework.com/doc/blog/1.1/en/prototype.auth</a>.</p></div></div></div>
<div class="section" title="Top 5 features you need to know about"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec06"/>Top 5 features you need to know about</h1></div></div></div><p>As we saw in the previous section, it's easy to quickly set up forms and views for the basic CRUD operations. However, if you look more closely, you'll find that every form element is either a text box or a text area. That's fine for fields such as <code class="literal">Title</code> and <code class="literal">Body</code>, but not for other things such as foreign key relationships, date fields, and values for which you might want to use a more specialized widget, such as a slider. These alternative input choices are vital, because you obviously can't expect your users to set something like the category ID for a post by knowing the primary key of the category they want, or the exact date format you want to use.</p><div class="section" title="Basic security considerations"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec11"/>Basic security considerations</h2></div></div></div><p>For displaying user data, run it through the <code class="literal">CHtmlPurifier</code> filter:</p><div class="informalexample"><pre class="programlisting">&lt;?php $this-&gt;beginWidget('CHtmlPurifier'); ?&gt;
&lt;?php echo $model-&gt;content; ?&gt;
&lt;?php $this-&gt;endWidget(); ?&gt;</pre></div><p>When receiving user input, the easiest way to use it on a single field is illustrated as follows, and we will revisit this topic in the following section:</p><div class="informalexample"><pre class="programlisting">$p = new CHtmlPurifier();
$model-&gt;content = $p-&gt;purify($_POST['Model']['content']);</pre></div><p>The CSRF option goes into the components section of the <code class="literal">main.php</code> config file:</p><div class="informalexample"><pre class="programlisting">//protected/config/main.php
'components'=&gt;array(
  'request'=&gt;array(
    'enableCsrfValidation'=&gt;true,
  ),
);</pre></div></div><div class="section" title="Form components – CHtml, CActiveForm, and Zii"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec12"/>Form components – CHtml, CActiveForm, and Zii</h2></div></div></div><p>
<code class="literal">CHtml</code> is the basic helper class to output HTML tags. <code class="literal">CActiveForm</code> was added later to make it even easier to set up forms and bind model properties to input elements. Additionally, <code class="literal">CHtml</code> and <code class="literal">CActiveForm</code> contain a number of useful helper functions. Zii is a set of widgets for things such as menus, lists, and grid elements. Zii also provides wrappers for jQuery UI widgets such as Accordion, DatePicker, ProgressBar, Slider, Tabs, and so on. Let's take a look at how we can use these items to enhance CRUD forms.</p><p>The core form created by the CRUD generator (<code class="literal">_form.php</code>) will be used by both the Create and Update actions. In the <code class="literal">views/{controller}/</code> directory, you will find <code class="literal">create.php</code>, <code class="literal">update.php</code>, and <code class="literal">_form.php</code>. The Create and Update actions render <code class="literal">create.php</code> and <code class="literal">update.php</code> respectively, but what you will notice is that each of these is really just a wrapper for <code class="literal">_form.php</code>. Inside, they both contain a <code class="literal">renderPartial()</code> call, which pass the model to the <code class="literal">_form.php</code> view.</p><p>Whereas <code class="literal">render()</code> incorporates the site layout, <code class="literal">renderPartial()</code> only produces the content of the specified template.</p><p>This is something to keep in mind while building your forms. You can use <code class="literal">renderPartial</code> to separate out pieces of templates should you need to reuse them in multiple views, or if you wish to reduce the size of your individual view files.</p><p>Another useful tip when working with <code class="literal">_form.php</code> is to know whether or not you are on the Create or Update view. This determination can be easily made by checking the model property <code class="literal">isNewRecord</code>, as you will find they have done with the form submit button. This button will display different text based on whether you are adding a new item or saving changes to an existing one.</p><div class="informalexample"><pre class="programlisting">echo CHtml::submitButton($model-&gt;isNewRecord ? 'Create' : 'Save');</pre></div><p>So, let's say we have a simple blog system. Our posts only have <code class="literal">Title</code> and <code class="literal">Content</code> objects, but then we might also want a foreign key relationship to a category entity. The category CRUD form is simple if we only want a category name (and a primary key ID for referencing). This form will be generated ready to go out of the box, because all we need is a single text box for a category name. The heart of the category form would look like this:</p><div class="informalexample"><pre class="programlisting">&lt;div class="row"&gt;
&lt;?php 
    echo $form-&gt;labelEx($model,'name');
    echo $form-&gt;textField(
        $model, 'name',
        array('size'=&gt;60,'maxlength'=&gt;90)
    );
    echo $form-&gt;error($model,'name'); 
?&gt;
&lt;/div&gt;

&lt;div class="row buttons"&gt;
&lt;?php 
    echo CHtml::submitButton(
        $model-&gt;isNewRecord ? 'Create' : 'Save'
    );
?&gt;
&lt;/div&gt;</pre></div><p>Yii is smart enough to know that a primary key doesn't show up as a form element, so there's only one field in the form. We can use this CRUD immediately to populate a few categories for use on the POST form.</p><p>Moving on to the POST form, we'll probably want to use an HTML <code class="literal">select</code> element for this, unless there are only two or three, where radio buttons might make more sense.</p><p>Here's what the POST form looks like by default:</p><div class="informalexample"><pre class="programlisting">&lt;div class="row"&gt;
&lt;?php 
    echo $form-&gt;labelEx($model,'category_id');
    echo $form-&gt;textField($model,'category_id');
    echo $form-&gt;error($model,'category_id');
?&gt;
&lt;/div&gt;

&lt;div class="row"&gt;
&lt;?php 
    echo $form-&gt;labelEx($model,'title');
    echo $form-&gt;textField(
        $model, 'title',
        array('size'=&gt;60,'maxlength'=&gt;120)
    );
    echo $form-&gt;error($model,'title');
?&gt;
&lt;/div&gt;

&lt;div class="row"&gt;
&lt;?php 
    echo $form-&gt;labelEx($model,'cotent');
    echo $form-&gt;textArea(
        $model, 'content',
        array('rows'=&gt;6, 'cols'=&gt;50)
    ); 
    echo $form-&gt;error($model,'content'); 
?&gt;
&lt;/div&gt;

&lt;div class="row buttons"&gt;
&lt;?php 
    echo CHtml::submitButton(
        $model-&gt;isNewRecord ? 'Create' : 'Save'
    );
?&gt;
&lt;/div&gt;</pre></div><p>Notice how the first row is only using <code class="literal">textField</code> for category ID (<code class="literal">category_id</code>). This is what we want to fix.</p><p>You can use <code class="literal">CHtml</code> or <code class="literal">CActiveForm</code> to accomplish this, but as long as the option is available in <code class="literal">CActiveForm</code>, that is what we should use. The change is simple. In essence, all you need to do is swap <code class="literal">$form-&gt;textField</code> with <code class="literal">$form-&gt;dropDownList</code>. However, that's not quite enough. A drop-down list requires just a little bit more information. It would be safe enough for Yii to assume you want the primary key of the related model, but it has no way to know what field is the actual display field. Here's where we use one of the static <code class="literal">CHtml</code> helper methods to set up an associated array of keys and values to be used in the building of the select options.</p><p>The final product looks like the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php 
    echo $form-&gt;dropDownList(
        $model,'category_id', 
        CHtml::listData(
            Category::model()-&gt;findAll(),
            'id', 'name'
        )
     );
?&gt;</pre></div><p>
<code class="literal">CHtml::listData</code> expects an array of models. It doesn't matter how this is retrieved. If you need to filter these items, you may do so before passing the final result to this call. The next two parameters are the key and display values to be used for each option.</p><p>Now, the form should show a nice, clean select box showing all the available categories:</p><div class="mediaobject"><img src="graphics/1684OS_04_1.png.jpg" alt="Form components – CHtml, CActiveForm, and Zii"/></div><p>For the sake of argument, let's assume our posts can have a publish date field that we might use to prevent items from showing up on the list until the desired date. By default, this would show up as <code class="literal">textField</code>, just like the category ID. Replacing it with the Zii wrapper of the jQuery UI DatePicker, aptly named <code class="literal">CJuiDatePicker</code>, would look like the following code:</p><div class="informalexample"><pre class="programlisting">// replace this:
&lt;?php echo $form-&gt;textField($model, 'publish_date'); ?&gt;

// with this:
&lt;?php $this-&gt;widget('zii.widgets.jui.CJuiDatePicker',array(
            'model'=&gt;$model,
            'attribute'=&gt;'publish_date',
            'options'=&gt;array(
                'showAnim'=&gt;'fold',
            ),
            'htmlOptions'=&gt;array(
                'style'=&gt;'height:20px;'
            ),
        )); ?&gt;</pre></div><p>If you want to follow the ActiveForm style, you must specify the <code class="literal">model</code> and <code class="literal">attribute</code> options as shown in the preceding code. To simply pass a date value with your form, replace the model and attribute with a name value that will correspond to the input name.</p><p>Unfortunately, we're not quite done with the <code class="literal">date</code> field here. Dates are always a tricky subject on the web. Odds are, the default format that the picker gives you isn't the way your database will want to store it, or maybe it's not the display style desired for your applications. In most cases, you will need to address this on the server side when receiving posted values and when pushing dates out.</p><p>As far as displaying different date formats, this can easily be handled by adding the <code class="literal">dateFormat</code> element to the options array. For example, the default would be <code class="literal">03/16/2013</code> (the day this sentence was written). The date format for this is <code class="literal">mm/dd/yy</code>. If you don't want two column values for single digits and just the last two digits for the year, use <code class="literal">m/d/y</code>. Or, if you want something that looks like the MySQL date format, use <code class="literal">yy-mm-dd</code>. That will take care of the value you see when selecting something from the picker.</p><p>The specification that Yii uses for date formats is described here: <a class="ulink" href="http://www.unicode.org/reports/tr35/tr35-dates.html#Date_Format_Patterns">http://www.unicode.org/reports/tr35/tr35-dates.html#Date_Format_Patterns</a>. This is mentioned in the documentation for the <code class="literal">CDateFormatter</code> class.</p><p>However, two problems remain.</p><p>If you're not following the exact MySQL format, you'll want to reformat the date on the server side after a post. You would want to do this anyway, just to be safe, since users can still type in the field and post their own values.</p><p>There are two places where this will need to be addressed, because this form can be posted in two different ways, as discussed before—on Create and Update, so the date translation will have to be added to <code class="literal">actionCreate</code> and <code class="literal">actionUpdate</code>. In either case, the code is the same. After you get into the <code class="literal">if(isset($_POST)){}</code> block, you can expect this field might be filled out.</p><p>Use the PHP <code class="literal">date</code> function along with the string-to-time function to fix whatever value you received:</p><div class="informalexample"><pre class="programlisting">if (isset($_POST['Post2']))
{
    $model-&gt;attributes=$_POST['Post2'];
    $model-&gt;publish_date = date(
        'Y-m-d', 
        strtotime($model-&gt;publish_date)
    );
    if($model-&gt;save())
        $this-&gt;redirect(array('view','id'=&gt;$model-&gt;id));
}</pre></div><p>The second issue with dates that you will need to address is relevant on any views that show this field. This could be the update form, where you would want the field prepopulated with the display style date format, or the view and list screens. The easiest way to address this is to change it before you render the views. For example, the View action looks like this by default:</p><div class="informalexample"><pre class="programlisting">public function actionView($id)
{
    $this-&gt;render('view',array(
        'model'=&gt;$this-&gt;loadModel($id),
    ));
}</pre></div><p>We'll need to change the model before calling the render method, so we have to rearrange this a little bit while adding our date format fix. Something like this should do the trick:</p><div class="informalexample"><pre class="programlisting">public function actionView($id)
{
    $model = $this-&gt;loadModel($id);
    $model-&gt;publish_date = date('m/d/Y', strtotime($model-&gt;publish_date));
    $this-&gt;render('view',array(
        'model'=&gt;$model,
    ));
}</pre></div><p>This is essentially the same process we did for saving the posted value, just in reverse.</p><p>Note that you can put this logic for reformatting the date on a deeper level into the model code. Each Yii model has a pair of special methods, <code class="literal">afterFind</code> and <code class="literal">beforeSave</code>, which are fired by Yii automatically right after the model is populated with data from the database or just before saving the updated data to the database respectively. Utilizing these methods, you will not need to modify the <code class="literal">actionView</code> method at all, instead you'll need to add the following to the code of your post model:</p><div class="informalexample"><pre class="programlisting">/**
 * For displaying the model on pages, 
 * we convert publishing date to 'MM/DD/YYYY' format.
 */
public function afterFind() 
{
    $this-&gt;publish_date = date('m/d/Y', strtotime($this-&gt;publish_date));
}

/**
 * Publish date of Post is being stored in the MySQL in 'YYYY-MM-DD' format.
*/
public function beforeSave() 
{
    $this-&gt;publish_date = date(
        'Y-m-d', 
        strtotime($this-&gt;publish_date)
    );
}</pre></div><p>Of course, this has a catch. After you set up these two handlers, you will always convert your dates, even if you don't want or need to. When the conversion is at the hands of a controller, it can decide whether or not to do it.</p></div><div class="section" title="Adding custom views"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec13"/>Adding custom views</h2></div></div></div><p>Now that we've covered the basics of how the CRUD forms work, it's time to take a look at building more specialized interfaces. Unless you're strictly making a database application, odds are the basic CRUD functionality isn't going to be enough. There are a couple of ways to go about this. Every page needs to be an action within a controller, but controllers do not need to be tied specifically into a specific model. Whether or not you work within an existing controller or not depends on whether the new view really applies to an entity.</p><p>For example, if you allow users to submit posts that enter a pending state and must be approved by an administrator before being published, you might want a page that lists these pending posts and that has buttons for viewing and approving them. Something like this makes sense to keep within the <code class="literal">PostController</code>.</p><p>There are a few things to cover before we dig too far into this process. If we're adding an approved field to our <code class="literal">Post</code> model, it will show up on the <code class="literal">_form.php</code> file by default. We will want to hide it from non-administrator users, as well as use a checkbox input element instead of the text field it will insert by default. Since we haven't yet talked about using proper user access roles, we will rely on the standard Yii user accounts for permissions on this field. Later in this section, we will return to this example with proper role-based access checking.</p><p>In MySQL, you can set up the approved field as <code class="literal">approved tinyint(1) default 0</code>. That way, when not showing this field to non-administrator users, the posts will default to 0 (unapproved). Also, when changing the input field to a checkbox, it will work with values of 0 and 1.</p><div class="informalexample"><pre class="programlisting">&lt;?php
//quick and dirty hide for non-admin users
if (Yii::app()-&gt;user-&gt;name == 'admin') {
    echo CHtml::openTag('div', array('class' =&gt; 'row'));
        echo $form-&gt;labelEx($model,'approved');
        echo $form-&gt;checkBox($model,'approved');
        echo $form-&gt;error($model,'approved');
    echo CHtml::closeTag('div');
}
?&gt;</pre></div><p>By default, <code class="literal">PostController</code> contains an index page, which is a general, pageable list. To create a page that only deals with a particular type of post, we start by adding a new action to the <code class="literal">PostController</code>. Assuming our <code class="literal">Post</code> model also contains an approved property, we can use this to generate a filtered list of models to pass to the a pending view template.</p><p>In <code class="literal">PostController</code>, if we want this list to look like the index list but with a filter, the easiest thing to do is to copy the index action, rename it, and add some filtering. We can even use the same view script, but it's best to copy this over as well. So, <code class="literal">protected/views/post/index.php</code> should be copied to <code class="literal">protected/views/post/pending.php</code>. These views have breadcrumb and menu options that you may wish to have look different, so it makes the most sense to keep these files different.</p><div class="informalexample"><pre class="programlisting">public function actionPending()
{
    $dataProvider=new CActiveDataProvider('Post');
    $criteria = new CDbCriteria;
    $criteria-&gt;condition = 'approved=0';
    $dataProvider-&gt;criteria = $criteria;
    $this-&gt;render('pending',array(
        'dataProvider'=&gt;$dataProvider,
    ));
}</pre></div><p>The view template, in this case, is making use of a Zii widget called <code class="literal">CListView</code>, which makes use of <code class="literal">CActiveDataProvider</code> to get relevant models and to handle things like paging automatically. On the view template, it looks like this:</p><div class="informalexample"><pre class="programlisting">&lt;?php $this-&gt;widget('zii.widgets.CListView', array(
  'dataProvider'=&gt;$dataProvider,
  'itemView'=&gt;'_view',
)); ?&gt;</pre></div><p>Each item is then rendered via the <code class="literal">_view.php</code> template, which can be altered or duplicated to fit the needs of each different content type. By default, Yii views are very plain and generally only list properties in rows or tables. Even the actual <code class="literal">view.php</code> template, which is used by <code class="literal">actionView</code> to show a single entity, merely displays each field in an HTML table.</p><p>For listing rows of records with action buttons, the admin interface has a much better display. Instead of <code class="literal">CListView</code>, it uses <code class="literal">CGridView</code>. It also provides the ability to search on fields (columns in the display table), as well as possessing a more sophisticated advanced search form.</p><div class="informalexample"><pre class="programlisting">Yii::app()-&gt;clientScript-&gt;registerScript('search', "
$('.search-button').click(function(){
    $('.search-form').toggle();
    return false;
});
$('.search-form form').submit(function(){
    $('#post-grid').yiiGridView('update', {
        data: $(this).serialize()
    });
    return false;
});
");
?&gt;

&lt;h1&gt;Manage Posts&lt;/h1&gt;

&lt;p&gt;
You may optionally enter a comparison operator (&lt;b&gt;&amp;lt;&lt;/b&gt;, &lt;b&gt;&amp;lt;=&lt;/b&gt;, &lt;b&gt;&amp;gt;&lt;/b&gt;, &lt;b&gt;&amp;gt;=&lt;/b&gt;, &lt;b&gt;&amp;lt;&amp;gt;&lt;/b&gt;
or &lt;b&gt;=&lt;/b&gt;) at the beginning of each of your search values to specify how the comparison should be done.
&lt;/p&gt;

&lt;?php echo CHtml::link('Advanced Search','#',array('class'=&gt;'search-button')); ?&gt;
&lt;div class="search-form" style="display:none"&gt;
&lt;?php $this-&gt;renderPartial('_search',array(
  'model'=&gt;$model,
)); ?&gt;
&lt;/div&gt;&lt;!-- search-form --&gt;

&lt;?php $this-&gt;widget('zii.widgets.grid.CGridView', array(
    'id'=&gt;'post-grid',
    'dataProvider'=&gt;$model-&gt;search(),
    'filter'=&gt;$model,
    'columns'=&gt;array(
        'id',
        'cat_id',
        'title',
        'body',
        'approved',
        array(
            'class'=&gt;'CButtonColumn',
        ),
    ),
)); ?&gt;</pre></div><p>Let's assume you're not concerned with the advanced search for the pending posts view. We can copy the <code class="literal">admin.php</code> script over to <code class="literal">pending.php</code> (instead of copying <code class="literal">index.php</code> to <code class="literal">pending.php</code> as mentioned previously). This action uses the <code class="literal">$model-&gt;search()</code> method to get the DataProvider for this widget. For now, we can ignore that piece. We'll return to it later.</p><p>One thing to notice here in the <code class="literal">CGridView</code> widget is the columns list. You can choose which fields you want to have display. In a lot of cases, you might not want to show all the fields, or you may want them to show up differently. If the actual Post ID is not important, we can remove that item. Since category ID, as a number, doesn't tell us much, we can easily make that show the name field for the given ID. Another thing we're going to want to change is the last column. <code class="literal">CButtonColumn</code> defaults to giving us three buttons: <code class="literal">view</code>, <code class="literal">update</code>, and <code class="literal">delete</code>. The form we're trying to build is intended to allow an administrator to approve pending posts, so we really need an action button for doing the approving. We might also have this as an option in other places too, such as the view and update screens, so it might make sense to leave those buttons there. In any case, we must customize both the <code class="literal">CGridView</code> column list as well as <code class="literal">CButtonColumn</code> itself.</p><div class="informalexample"><pre class="programlisting">&lt;?php $this-&gt;widget('zii.widgets.grid.CGridView', array(
  'id'=&gt;'post-pending-grid',
  'dataProvider'=&gt;$model-&gt;search(),
  'columns'=&gt;array(
    array(
      'name'=&gt;'cat_id',
      'value'=&gt;'$data-&gt;category-&gt;name',
    ),
    'title',
    array(
      'class'=&gt;'CButtonColumn',
<span class="strong"><strong>      'template'=&gt;'{approve} {view} {update} {delete}',</strong></span>
<span class="strong"><strong>      'buttons'=&gt;array(</strong></span>
<span class="strong"><strong>        'approve' =&gt; array(</strong></span>
<span class="strong"><strong>          'url'=&gt;'', //need to set this</strong></span>
          'imageUrl'=&gt;Yii::app()-&gt;request-&gt;baseUrl
            .'/images/approve.png',
        ),
      ),
    ),
  ),
)); ?&gt;</pre></div><p>The highlighted lines are what's most important here. The <code class="literal">buttons</code> property tells the widget what buttons, to generate for this grid. In here, we have the <code class="literal">approve</code> button defined manually. You have three buttons, <code class="literal">update</code>, <code class="literal">view</code>, and <code class="literal">delete</code>, for free with any <code class="literal">CGridView</code>. The <code class="literal">template</code> property tells the widget in what order and what buttons to render. So, if you configure some custom buttons, as we did with <code class="literal">approve</code>, then you have to mention it in the <code class="literal">template</code> property. A full description of what parameters can be defined for each button can be found in the documentation for the <code class="literal">CButtonColumn.buttons</code> property at <a class="ulink" href="http://www.yiiframework.com/doc/api/1.1/CButtonColumn#buttons-detail">http://www.yiiframework.com/doc/api/1.1/CButtonColumn#buttons-detail</a>.</p><p>Note that we still need to properly configure the <code class="literal">url</code> property for our <code class="literal">approve</code> button.</p><p>Let's do the AJAX update for when a user clicks on the approve button. It will send a request to the <code class="literal">/post/approve</code> endpoint, which we will create shortly, and update the grid afterwards. Here's how we do it:</p><div class="informalexample"><pre class="programlisting">'buttons'=&gt;array(
    'approve' =&gt; array(
        'imageUrl'=&gt;Yii::app()-&gt;request-&gt;baseUrl.'/images/approve.png',
        'url'=&gt;'Yii::app()-&gt;createUrl("post/approve", array("id"=&gt;$data-&gt;id))',
<span class="strong"><strong>        'options' =&gt; array(</strong></span>
<span class="strong"><strong>            'ajax' =&gt; array(</strong></span>
<span class="strong"><strong>                'type' =&gt; 'post',</strong></span>
<span class="strong"><strong>                'url'=&gt;'js:$(this).attr("href")',</strong></span>
<span class="strong"><strong>                'success' =&gt; 'js:function(data) { $("#post-pending-grid"). yiiGridView('update'); }'</strong></span>
            )),
    ),
),</pre></div><p>After that, we write the simplest possible endpoint in our <code class="literal">PostController</code>:</p><div class="informalexample"><pre class="programlisting">public function actionApprove($id)
{
    $model= Post::model()-&gt;findByPk($id);
    if (!$model)
        throw new CHttpException(404);

    $model-&gt;approved = 1;
    $model-&gt;save();
}</pre></div><p>This just changes the approved status of the Post to <code class="literal">true</code> value and saves it. Note the common practice of checking whether we got the correct Post ID and throwing an exception if not.</p><p>For listing pending posts, we do the following:</p><div class="informalexample"><pre class="programlisting">public function actionPending()
{
    $model=new Post('search');
    $model-&gt;unsetAttributes();  // clear any default values
<span class="strong"><strong>    $model-&gt;approved = 0;</strong></span>
    if(isset($_GET['Post']))
        $model-&gt;attributes=$_GET['Post'];

    $this-&gt;render('pending',array(
        'model'=&gt;$model,
    ));
}</pre></div><p>This table will only show the post category by name and the title of the post. After you set the <code class="literal">approved</code> field to zero in this particular model instance, it'll be used as a filter for the grid view.</p></div><div class="section" title="Extensions"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec14"/>Extensions</h2></div></div></div><p>Another great feature of Yii, and the Yii community, is the library of user-contributed extensions that you will find on the Yii website (<a class="ulink" href="http://www.yiiframework.com/extensions/">http://www.yiiframework.com/extensions/</a>). There are currently over 1,100 extensions that make it easy to drop in specialized functionality. Extension categories include Authorization, Caching, Date and Time, File System, Mail, Security, User Interface, Validation, and a few others. In this section, we'll take a look at a couple of really good ones.</p><div class="section" title="TinyMCE"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec08"/>TinyMCE</h3></div></div></div><p>The most popular extension by far is <span class="strong"><strong>tinymce</strong></span>. This, as you might have guessed, is a wrapper for the <span class="strong"><strong>TinyMCE</strong></span> (<a class="ulink" href="http://www.tinymce.com/">http://www.tinymce.com/</a>) WYSIWYG editor. It attaches to a text area input and provides a toggle between the HTML view and a Preview mode, where styles appear as they would when published. Users are given controls, such as font selection/color, text alignment, bold/italic/underline, and so on.</p><p>To use the TinyMCE extension, you first download and extract it into the <code class="literal">protected/extensions</code> directory. After that, simply replace the single line of <code class="literal">_form.php</code> that normally calls for <code class="literal">textArea</code> with the following, which will yield the full set of controls:</p><div class="informalexample"><pre class="programlisting">&lt;?php $this-&gt;widget('application.extensions.tinymce.ETinyMce', array(
            'model'=&gt;$model,
            'attribute'=&gt;'content',
            'editorTemplate'=&gt;'full',
            'htmlOptions'=&gt;array('rows'=&gt;6, 'cols'=&gt;50, 'class'=&gt;'tinymce')
)); ?&gt;</pre></div><div class="mediaobject"><img src="graphics/1684OS_04_2.png.jpg" alt="TinyMCE"/></div></div><div class="section" title="MbMenu"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec09"/>MbMenu</h3></div></div></div><p>Another very sought after feature on most websites today is drop-down menus. <span class="strong"><strong>MbMenu</strong></span> provides an extension to the default Yii <code class="literal">CMenu</code> class, making it easy to plug in for existing projects. To get started, again, all you have to do is download and extract the extension into the <code class="literal">protected/extensions</code> folder. The main site menu is configured in <code class="literal">protected/views/layout/main.php</code>, so that is where we must go to make our changes.</p><p>By default, the menu looks like this:</p><div class="informalexample"><pre class="programlisting">&lt;div id="mainmenu"&gt;
  &lt;?php $this-&gt;widget('zii.widgets.CMenu',array(
    'items'=&gt;array(
      array(
        'label'=&gt;'Home', 
        'url'=&gt;array('/site/index')
      ),
      array(
        'label'=&gt;'About', 
        'url'=&gt;array('/site/page', 'view'=&gt;'about')
      ),
      array(
        'label'=&gt;'Contact', 
        'url'=&gt;array('/site/contact')
      ),
      array(
        'label'=&gt;'Login', 
        'url'=&gt;array('/site/login'), 
        'visible'=&gt;Yii::app()-&gt;user-&gt;isGuest
      ),
      array(
        'label'=&gt;'Logout ('.Yii::app()-&gt;user-&gt;name.')',
        'url'=&gt;array('/site/logout'), 
        'visible'=&gt;!Yii::app()-&gt;user-&gt;isGuest
      )
    ),
  )); ?&gt;
&lt;/div&gt;&lt;!-- mainmenu --&gt;</pre></div><p>To use MbMenu, we must change the widget to <code class="literal">application.extensions.mbmenu.MbMenu</code>. Then we may nest arrays of items within individual menu items following the same format <code class="literal">CMenu</code> used by default. Going with our example, we might want to first add a menu item for posts that links to the post index list. With the old <code class="literal">CMenu</code> way, we would just do this:</p><div class="informalexample"><pre class="programlisting">&lt;div id="mainmenu"&gt;
  &lt;?php $this-&gt;widget('zii.widgets.CMenu',array(
    'items'=&gt;array(
      array(
        'label'=&gt;'Home', 
        'url'=&gt;array('/site/index')
      ),
<span class="strong"><strong>      array(</strong></span>
<span class="strong"><strong>        'label'=&gt;'Posts', </strong></span>
<span class="strong"><strong>        'url'=&gt;array('/post/index')</strong></span>
<span class="strong"><strong>      ),</strong></span>
      array(
        'label'=&gt;'About', 
        'url'=&gt;array('/site/page', 'view'=&gt;'about')
      ),
      array(
        'label'=&gt;'Contact', 
        'url'=&gt;array('/site/contact')
      ),
      array(
        'label'=&gt;'Login', 
        'url'=&gt;array('/site/login'), 
        'visible'=&gt;Yii::app()-&gt;user-&gt;isGuest
      ),
      array(
        'label'=&gt;'Logout ('.Yii::app()-&gt;user-&gt;name.')',
        'url'=&gt;array('/site/logout'), 
        'visible'=&gt;!Yii::app()-&gt;user-&gt;isGuest
      )
    ),
  )); ?&gt;
&lt;/div&gt;&lt;!-- mainmenu --&gt;</pre></div><p>Now, let's say we want to add some of the CRUD actions and the pending list as submenu items. That would look like the following:</p><div class="informalexample"><pre class="programlisting">&lt;div id="mainMbMenu"&gt;
&lt;?php
  $this-&gt;widget('application.extensions.mbmenu.MbMenu', array(
    'items'=&gt;array(
      array(
        'label'=&gt;'Home', 
        'url'=&gt;array('/site/index')
      ),
      array(
       'label'=&gt;'Posts', 
       'url'=&gt;array('/post/index'),
       'items'=&gt;array(
          array(
            'label'=&gt;'All Posts', 
            'url'=&gt;array('/post/index')
          ),
          array(
            'label'=&gt;'Add Post', 
            'url'=&gt;array('/post/create'), 
            'visible'=&gt;!Yii::app()-&gt;user-&gt;isGuest
          ),
          array(
            'label'=&gt;'Pending', 
            'url'=&gt;array('/post/pending'), 
            'visible'=&gt;Yii::app()-&gt;user-&gt;name=='admin'
          ),
        ),
      ),
      array(
        'label'=&gt;'About', 
        'url'=&gt;array('/site/page', 'view'=&gt;'about')
      ),
      array(
        'label'=&gt;'Contact', 
        'url'=&gt;array('/site/contact')
      ),
      array(
        'label'=&gt;'Login', 
        'url'=&gt;array('/site/login'), 
        'visible'=&gt;Yii::app()-&gt;user-&gt;isGuest
      ),
      array(
        'label'=&gt;'Logout ('.Yii::app()-&gt;user-&gt;name.')',
        'url'=&gt;array('/site/logout'), 
        'visible'=&gt;!Yii::app()-&gt;user-&gt;isGuest
      )
    ),
  )); ?&gt;
&lt;/div&gt;&lt;!-- mainmenu --&gt;</pre></div><p>Note that this widget has its own CSS, so the ID of the wrapper <code class="literal">div</code> element should be changed from <code class="literal">mainmenu</code> to <code class="literal">mainMbMenu</code>. Also, we don't want non-admin users to see the menu option for the pending list or non-authenticated users to see the link to create a post, so we have to specify the visible condition.</p></div><div class="section" title="Yii-User and Yii-User-Management"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec10"/>Yii-User and Yii-User-Management</h3></div></div></div><p>These two extensions are among the most downloaded extensions. <span class="strong"><strong>Yii-User</strong></span> provides mechanisms for user registrations and all the issues that arise with that process, such as confirming e-mail, resetting passwords, and user profiles. <span class="strong"><strong>Yii-User-Management</strong></span> provides many more of the same features, but additionally includes groups, inter-user messaging, and user roles.</p></div><div class="section" title="Yii-Shop"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec11"/>Yii-Shop</h3></div></div></div><p>Yii-Shop is a fully-featured, internationalized shopping cart extension. It handles different types of products with variations, tax calculations, shipping and payment methods, as well as invoicing and delivery slips.</p></div><div class="section" title="Cal"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec12"/>Cal</h3></div></div></div><p>This is a great jQuery-based calendar extension. Use it to create and schedule events that display on a full-sized calendar.</p></div><div class="section" title="Fancybox"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec13"/>Fancybox</h3></div></div></div><p>Who doesn't like those modal pop-up image viewers? This one is perfect for fancy looking image galleries. It's a wrapper around the third-party application <span class="strong"><strong>Fancybox</strong></span>, located at <a class="ulink" href="http://fancyapps.com/fancybox/">http://fancyapps.com/fancybox/</a>.</p></div><div class="section" title="Other great extensions"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec14"/>Other great extensions</h3></div></div></div><p>There are so many great extensions available for Yii, and for the most part, they are as easy to drop in and use as the two examples illustrated earlier. In the next section, we'll be talking about another great extension that makes it easy to deal with one of the most important issues in web-based applications, namely access permissions.</p></div></div><div class="section" title="Role-based access control"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec15"/>Role-based access control</h2></div></div></div><p>A common practice in software applications for decades has been to assign permissions for specific actions to generalized roles. Users can be granted one or more roles, through which they will be enabled to perform certain functions. Given the blog example, general registered users might be given a role like visitor. That role would be linked to a limited set of possible actions. For instance, visitors might only be allowed to create comments for posts, but not posts themselves. Another role might be given to a select number of users who are actually allowed to create posts. This might be called <span class="strong"><strong>post creator</strong></span>. Roles often describe the intended behavior, and even if they are never publicly visible as part of the site, they serve to keep things simple on the administrative or programmatic side of things. A final, top-level role might be something like admin, which would probably handle things like enabling new users or approving posts. All-in-all, this process of granting permission for certain actions to user roles is known as <span class="strong"><strong>role-based access control</strong></span> (<span class="strong"><strong>RBAC</strong></span>), and it is very important in Yii.</p><div class="section" title="SRBAC"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec15"/>SRBAC</h3></div></div></div><p>One of the easiest ways to get going with role based access controls is this widely popular extension called <span class="strong"><strong>SRBAC</strong></span> (<a class="ulink" href="http://www.yiiframework.com/doc/guide/1.1/en/basics.module">http://www.yiiframework.com/doc/guide/1.1/en/basics.module</a>). This extension provides a graphical interface for configuring roles, tasks, and operations. Operations are assigned to tasks, tasks are assigned to roles, and finally, roles are assigned to users. At the lowest level, operations are a one-to-one mapping to an action. For example, viewing a post is <code class="literal">actionView</code> in the post controller. <code class="literal">PostView</code> is the operation that would be created to map to this action. Similarly, operations would be created for all actions in the <code class="literal">PostController</code>. By default, SRBAC will also set up two tasks for each controller. For Post, these would be <code class="literal">PostViewing</code> and <code class="literal">PostAdministrating</code>. View and Index are read-only operations, so they generally get lumped into <code class="literal">PostViewing</code>, whereas Create, Update, Delete, and Admin fit more reasonably in <code class="literal">PostAdministering</code>. You can always reserve administering for a few more important tasks, such as Delete or just Admin, but you'll probably want to create another task like <code class="literal">PostCreating</code> to fit in-between strictly view-only and actual creation/editing of content.</p><p>To make use of SRBAC with a particular controller, there are a few changes that need to be made. First, we must configure this extension, which is a slightly different process from the earlier examples. This is an older extension that follows a less used pattern for install. Instead of finding a home in the <code class="literal">protected/extensions</code> folder, the documentation states to place it in <code class="literal">protected/modules</code>, which doesn't exist by default, but can be created (<a class="ulink" href="http://www.yiiframework.com/doc/guide/1.1/en/basics.module">http://www.yiiframework.com/doc/guide/1.1/en/basics.module</a>).</p><p>Next, a few simple changes must be made to the main configuration file in <code class="literal">protected/config/main.php</code>. In the <code class="literal">import</code> section, add a line for <code class="literal">application.modules.srbac.controllers.SBaseController</code>.</p><p>In the modules section, where you'll find the configuration for Gii, add this:</p><div class="informalexample"><pre class="programlisting">'srbac' =&gt; array(
  'userclass'=&gt;'User',
  'userid'=&gt;'id',
  'username'=&gt;'username',
  'delimeter'=&gt;'@',
  'debug'=&gt;true,
  'pageSize'=&gt;10,
  'superUser' =&gt;'Authority',
  'css'=&gt;'srbac.css',
  'layout'=&gt;
  'application.views.layouts.main',
  'notAuthorizedView'=&gt; 'srbac.views.authitem.unauthorized',
  'alwaysAllowed'=&gt;array(
    'SiteLogin','SiteLogout','SiteIndex','SiteAdmin',
    'SiteError', 'SiteContact'),
  'userActions'=&gt;array('Show','View','List'),
  'listBoxNumberOfLines' =&gt; 15,
  'imagesPath' =&gt; 'srbac.images',
  'imagesPack'=&gt;'noia',
  'iconText'=&gt;true,
  'header'=&gt;'srbac.views.authitem.header',
  'footer'=&gt;'srbac.views.authitem.footer',
  'showHeader'=&gt;true,
  'showFooter'=&gt;true,
  'alwaysAllowedPath'=&gt;'srbac.components',
)</pre></div><p>These are some standard settings as expressed in the SRBAC documentation. A few things to note here are that you must specify exactly what your user class and username fields are. You'll find that at the top of the list. Also, you can set actions that should always be allowed in the <code class="literal">alwaysAllowed</code> item. This would be useful if you want anonymous users to see your <code class="literal">PostIndex</code> page. The last major thing to note is the <code class="literal">debug</code> option. It is very important to set this to <code class="literal">false</code> as soon as you have properly configured your roles. Most importantly, you will need to assign the Authority role to a user, as this is the only role allowed to administer SRBAC. If you set this to <code class="literal">false</code> before assigning that role, you will be locked out of further configuration of SRBAC rules. You can reset this to <code class="literal">true</code> if that is the case.</p><p>In the <code class="literal">components</code> section of your <code class="literal">main.php</code> config, you must set the <code class="literal">authManager</code> item to SRBAC:</p><div class="informalexample"><pre class="programlisting">'authManager'=&gt;array(
  'class'=&gt;'application.modules.srbac.components.SDbAuthManager',
  'connectionID'=&gt;'db',
  'itemTable'=&gt;'authitem',
  'assignmentTable'=&gt;'authassignment',
  'itemChildTable'=&gt;'authitemchild',
),</pre></div><p>SRBAC uses three database tables for rules; roles, tasks, and operations will go into the item table. The item child table deals with relationships between roles and tasks, and tasks and operations. The assignment table relates roles to users. These tables will be created during the install process, which will take place the first time you attempt to access SRBAC.</p><p>Once you have the SRBAC module in the <code class="literal">modules</code> folder and the config options set in <code class="literal">main.php</code>, you can visit your site <code class="literal">index.php?r=srbac</code>, and you should be taken to the install screen. This screen will show you a summary of the settings and will have an install button at the bottom. This action will create the tables necessary for using SRBAC in your application.</p><p>To set up rules for a particular controller, you must first make a few changes to the controller file. Instead of extending <code class="literal">Controller</code>, it must now extend <code class="literal">SBaseController</code>. By relying on a higher level controller, the checking for permission upon action request is abstracted away from you as a coder. It becomes something you don't need to think about, and it doesn't clutter up your code:</p><div class="informalexample"><pre class="programlisting">class PostController extends SBaseController</pre></div><p>At the top of your controller, under the <code class="literal">public $layout</code> setting, you'll need to set up a couple of quick variable definitions to avoid issues in your views:</p><div class="informalexample"><pre class="programlisting">public $layout='//layouts/column2';
public $breadcrumbs;
public $menu;</pre></div><p>Lastly, you can remove the <code class="literal">filters</code> and <code class="literal">accessRules</code> methods:</p><div class="informalexample"><pre class="programlisting">/**
 * @return array action filters
 */
public function filters()
{
    return array(
        'accessControl', // perform access control for CRUD operations
        'postOnly + delete', // we only allow deletion via POST request
    );
}

/**
 * Specifies the access control rules.
 * This method is used by the 'accessControl' filter.
 * @return array access control rules
 */
public function accessRules()
{
    return array(
        array('allow',  // allow all users to perform 'index' and 'view' actions
            'actions'=&gt;array('index','view'),
            'users'=&gt;array('*'),
        ),
        array('allow', // allow authenticated user to perform 'create' and 'update' actions
            'actions'=&gt;array('create','update'),
            'users'=&gt;array('@'),
        ),
        array('allow', // allow admin user to perform 'admin' and 'delete' actions
            'actions'=&gt;array('admin','delete', 'pending'),
            'users'=&gt;array('admin'),
        ),
        array('deny',  // deny all users
            'users'=&gt;array('*'),
        ),
    );
}</pre></div><p>Now you are ready to go back into SRBAC. If you go to the <span class="strong"><strong>Managing AuthItems</strong></span> section, you should see a link for <span class="strong"><strong>Autocreate Auth Items</strong></span>. This page will show you controllers that you are able to use to autogenerate tasks and operations. By clicking on the light bulb icon next to a listed controller, you should see on the right a list of all the operations that it can create as well as two default tasks that it wants to set up for you. You can selectively choose items or go with <span class="strong"><strong>Select All</strong></span>. For tasks, you can go with the two standard tasks of viewing and administering, and either stick with these, add more, or create entirely unique tasks for your controller.</p><div class="mediaobject"><img src="graphics/1684OS_04_3.png.jpg" alt="SRBAC"/></div><p>After autogenerating your tasks and operations, you'll want to set up a few roles. Go back to the primary <span class="strong"><strong>Auth Items</strong></span> screen and find the <span class="strong"><strong>Create</strong></span> button. Here is where you can create custom tasks and operations, but you will find this most useful for simply creating roles. Change the drop-down to role, give it a name, and hit <span class="strong"><strong>Create</strong></span> below. Note that you have to hit <span class="strong"><strong>Create</strong></span> on the left side before adding another role.</p><div class="mediaobject"><img src="graphics/1684OS_04_4.png.jpg" alt="SRBAC"/></div><p>At this point, we can go to the <span class="strong"><strong>Assign Roles to Users</strong></span> section. This is a simple, graphical way to add and remove assignments.</p><div class="mediaobject"><img src="graphics/1684OS_04_5.png.jpg" alt="SRBAC"/></div><p>With a few clicks, you can assign operations to tasks, tasks to roles, and roles to users. Make sure you add the Authority role to at least one user, as mentioned earlier, before you turn of SRBAC debug-mode in the <code class="literal">main.php</code> config file.</p><div class="mediaobject"><img src="graphics/1684OS_04_6.png.jpg" alt="SRBAC"/></div><p>SRBAC is useful in more situations than simply managing controller actions. When we set up the drop-down menu earlier, we restricted the pending menu option to be visible only to the admin user:</p><div class="informalexample"><pre class="programlisting">array(
  'label'=&gt;'Pending', 
  'url'=&gt;array('/post/pending'), 
  'visible'=&gt;Yii::app()-&gt;user-&gt;name=='admin'
),</pre></div><p>Now that we have roles, we can set up this restriction based on roles:</p><div class="informalexample"><pre class="programlisting">array(
  'label'=&gt;'Pending', 
  'url'=&gt;array('/post/pending'),
  'visible'=&gt;Yii::app()-&gt;user-&gt;checkAccess('Admin')
),</pre></div><p>At any point in our code, we can check to see if the current user has a particular authorization assignment. This could be a role, task, or operation. This is important because it's not enough to simply show the user a denied access message when they visit part of the app they shouldn't be using. It's better that they never find a link to it in the first place.</p></div></div></div>
<div class="section" title="People and places you should get to know"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec07"/>People and places you should get to know</h1></div></div></div><p>Finally, let's see where we can find more information about the Yii framework, as well as its community.</p><div class="section" title="Yii website"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec16"/>Yii website</h2></div></div></div><p>The framework website is, quite simply, the number one place to read more about Yii. Its URL is <a class="ulink" href="http://www.yiiframework.com">http://www.yiiframework.com</a>. As with any software tool, the API documentation section will be invaluable as you work through your development. The forums provide an excellent resource for getting help with specific issues you run into. There are a number of tutorials, as well as a wiki with examples to look at. The best outside resources are listed on the website as well, so this should absolutely be your first stop.</p></div><div class="section" title="API"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec17"/>API</h2></div></div></div><p>The Yii API documentation is probably the most beautiful and easy to use documentation ever published on the World Wide Web. The URL is <a class="ulink" href="http://www.yiiframework.com/doc/api/">http://www.yiiframework.com/doc/api/</a>. If you are going to seriously use Yii, you definitely should add it to your bookmarks, because you'll need it a lot.</p></div><div class="section" title="Tutorials and guides"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec18"/>Tutorials and guides</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The Yii website has a number of tutorials that are excellent. One of the best resources beyond the API itself is the <span class="emphasis"><em>Definitive Guide</em></span> found at <a class="ulink" href="http://www.yiiframework.com/doc/guide/">http://www.yiiframework.com/doc/guide/</a>. This guide is very thorough, covers all the important topics, and has a lot of important tips and code samples packed in.</li><li class="listitem" style="list-style-type: disc">The blog demo we based the book on is discussed in great length in the tutorials section of the Yii website. The URL is <a class="ulink" href="http://www.yiiframework.com/doc/blog/">http://www.yiiframework.com/doc/blog/</a>.</li><li class="listitem" style="list-style-type: disc">The wiki holds a lot of independent examples and code snippets that should come in handy (<a class="ulink" href="http://www.yiiframework.com/wiki/">http://www.yiiframework.com/wiki/</a>).</li><li class="listitem" style="list-style-type: disc">If you can't find an example of what you're trying to do in the wiki, the forums are also a great resource to search for previously solved solutions to problems. With Yii's popularity on the rise, the forums are increasingly active. This is an excellent place to get your questions answered.</li><li class="listitem" style="list-style-type: disc">One of the most comprehensive tutorials for Yii was done by Larry Ullman. He has written an excellent book on Yii, and has chosen to release much of the content publicly on his website <a class="ulink" href="http://www.larryullman.com/series/learning-the-yii-framework/">http://www.larryullman.com/series/learning-the-yii-framework/</a>.</li><li class="listitem" style="list-style-type: disc">There's another set of excellent screencasts produced by Jeffrey Winesett to help you get started at <a class="ulink" href="http://www.yiiframework.com/screencasts/">http://www.yiiframework.com/screencasts/</a></li></ul></div></div><div class="section" title="IRC"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec19"/>IRC</h2></div></div></div><p>You can find the Yii community on Freenode in the <code class="literal">#Yii</code> channel.</p></div><div class="section" title="Twitter"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec20"/>Twitter</h2></div></div></div><p>Follow updates and changes to the framework by following <code class="literal">@YiiFramework</code>.</p></div><div class="section" title="Facebook"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec21"/>Facebook</h2></div></div></div><p>Yii has even entered the Facebook world with a group for everything Yii-related (<a class="ulink" href="https://www.facebook.com/groups/61355672149/">https://www.facebook.com/groups/61355672149/</a>).</p><p>At the time of writing, there were several thousands of members.</p></div></div></body></html>