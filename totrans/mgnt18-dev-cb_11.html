<html><head></head><body><div class="chapter" title="Chapter&#xA0;11.&#xA0;Performance Optimization"><div class="titlepage"><div><div><h1 class="title"><a id="ch11"/>Chapter 11. Performance Optimization</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Exploring the limits of a website</li><li class="listitem" style="list-style-type: disc">Optimizing the database and MySQL configuration</li><li class="listitem" style="list-style-type: disc">Optimizing the Apache web server</li><li class="listitem" style="list-style-type: disc">Tuning the Magento configurations</li><li class="listitem" style="list-style-type: disc">Configuring APC and Memcached</li><li class="listitem" style="list-style-type: disc">Optimizing the PHP configurations</li><li class="listitem" style="list-style-type: disc">Analyzing the page speed</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec78"/>Introduction</h1></div></div></div><p>For athletes, seconds, milliseconds, or hundredths of seconds decide if they will win a competition or not. Every small aspect that improves the performance is a step in the right direction to win the competition.</p><p>For websites, it is the same. The faster your Magento store is, the better it is. Magento is not one of the most efficient systems when it comes to performance. Especially when you are working with a lot of products and attributes, a good setup improves the performance of your webshop.</p><p>The performance of a website has a lot of impact on your visitors. Some facts about this statement are listed as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The page speed has a significant influence on the page ranking in search engines such as Google</li><li class="listitem" style="list-style-type: disc">On an e-commerce site, every second costs 1 percent of the sales total</li><li class="listitem" style="list-style-type: disc">You get more visitors from search engines when you reduce the page size</li></ul></div><p>As you can see, performance is a key part to improve the SEO of your website. Customers will leave your website when it does not show a good performance.</p><p>Since you have finished the development, it is time to take a look at the performance of the whole system. In this chapter, we will explore, detect, and fix performance leaks in a Magento webshop by using many tools.</p><p>Some tools are delivered by Magento as standard, but we have to look at the whole picture. Two identical Magento installations can have different page speed results that are caused by the following reasons:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Hardware</li><li class="listitem" style="list-style-type: disc">Network</li><li class="listitem" style="list-style-type: disc">Load</li><li class="listitem" style="list-style-type: disc">Device of the client</li></ul></div></div></div>
<div class="section" title="Exploring the limits of a website"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec79"/>Exploring the limits of a website</h1></div></div></div><p>One of the first things you need to know are the limits of the current website. How much capacity has my website got? What is slowing down my site? We have to get an overview of all these aspects to arrive at a conclusion of which optimizations will have the most effect.</p><p>In this recipe, we will see some tools that help to create a view of the performance. Some of the tools are <a id="id552" class="indexterm"/>listed as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">ApacheBench</li><li class="listitem" style="list-style-type: disc">Siege</li><li class="listitem" style="list-style-type: disc">Magento Profiler</li><li class="listitem" style="list-style-type: disc">YSlow</li><li class="listitem" style="list-style-type: disc">PageSpeed</li><li class="listitem" style="list-style-type: disc">GTmetrix</li><li class="listitem" style="list-style-type: disc">WebPagetest</li></ul></div><p>We will do some tests with all these tools to work out the pitfalls of a Magento store. With these results, we can find out what kind of optimizations have the most effect.</p><p>Some optimizations are very easy and can have a large effect. Other optimizations are difficult and can have less effect. It is on you to decide what you want.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec200"/>Getting ready</h2></div></div></div><p>To start, it is recommended to install the following tools to do some performance tests on a Magento installation:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>ApacheBench</strong></span> (<span class="strong"><strong>ab</strong></span>): This tool is automatically installed with the Apache web server. When you have access to<a id="id553" class="indexterm"/> the command line interface, you can run the following command on a Linux server:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ab -h</strong></span>
</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Siege</strong></span>: We will do some performance<a id="id554" class="indexterm"/> tests with Siege that is installed on the same server as Magento. To see if it is installed, you can run the<a id="id555" class="indexterm"/> following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>siege -V</strong></span>
</pre></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Here, make sure that <code class="literal">V</code> is uppercase. When Siege is installed, you will see its version number as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_11_01.jpg" alt="Getting ready"/></div></li><li class="listitem" style="list-style-type: disc">If it is not installed, you can run the following command when you are using a Debian-based Linux distribution:<div class="informalexample"><pre class="programlisting">sudo apt-get install siege</pre></div></li><li class="listitem" style="list-style-type: disc">A second option is to download the installation file and install it by performing the following procedure:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To download the archive, run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>wget ftp://ftp.joedog.org/pub/siege/siege-latest.tar.gz</strong></span>
</pre></div></li><li class="listitem">To extract the archive, run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>tar xzf siege-latest.tar.gz</strong></span>
</pre></div></li><li class="listitem">Move the folder to the preferred location and change the directory.</li><li class="listitem">Install Siege with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo ./configure</strong></span>
</pre></div></li></ol></div></li></ul></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Magento Profile</strong></span>: This is a<a id="id556" class="indexterm"/> standard feature in Magento. You can enable it in your system's configuration.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>YSlow</strong></span>: This is a Firefox plugin that <a id="id557" class="indexterm"/>you can download and install from the Add-ons store.</li></ul></div><p>Because <span class="strong"><strong>GTMetrix</strong></span><a id="id558" class="indexterm"/> and <span class="strong"><strong>WebPagetest</strong></span> <a id="id559" class="indexterm"/>are online tools, we don't have to install them.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec201"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To get an idea of the response time under a load of concurrent users, we can use ApacheBench. We will perform <a id="id560" class="indexterm"/>a test with the following command and save the results to a CSV file:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ab -c 10 -n 50 -e apachebench.csv http://magento-dev.local/</strong></span>
</pre></div></li><li class="listitem">In the previous command, we did a load test with the following parameters:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">-c</code>: This parameter<a id="id561" class="indexterm"/> represents the number of concurrent users. In this test, there were always 10 requests running at the same time.</li><li class="listitem" style="list-style-type: disc"><code class="literal">-n</code>: This parameter represents<a id="id562" class="indexterm"/> the number of requests. In this case it is 50, so we will have 50 results in the file.</li><li class="listitem" style="list-style-type: disc"><code class="literal">-e</code>: This parameter <a id="id563" class="indexterm"/>represents the output file. The output is written to the given CSV file.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip41"/>Tip</h3><p>The <code class="literal">-g</code> option means the same as <code class="literal">-e</code> but <code class="literal">-g</code> will generate a<a id="id564" class="indexterm"/> <span class="strong"><strong>.tsv</strong></span> (<span class="strong"><strong>tab separated value</strong></span>) file, also known as a gnuplot file.</p></div></div></li></ul></div></li><li class="listitem">When you run the command, an output screen with the results will be printed as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_11_02.jpg" alt="How to do it..."/></div><p>This report shows the general statistics of the test. The specific results are saved in the CSV file.</p></li><li class="listitem">When you run the <a id="id565" class="indexterm"/><code class="literal">ab -h</code> command, you <a id="id566" class="indexterm"/>will see all the available options.</li><li class="listitem">Load testing with Siege.<p>Siege is another load<a id="id567" class="indexterm"/> testing tool like ApacheBench. The difference between Siege and<a id="id568" class="indexterm"/> ApacheBench is that <a id="id569" class="indexterm"/>Siege has more functions than ApacheBench. It is designed to do a stress test with a number of concurrent users. It has the ability to work with HTTP authentication, cookies, sessions, and more. When you write a good script, you can simulate a real stress situation.</p></li><li class="listitem">For a load test with Siege, we will use a text file, where we will set some URLs that will be used during the <a id="id570" class="indexterm"/>Siege load test. Doing a test with different URLs is better because you will test more pages on your website, which means that you can find more pitfalls. Create a <code class="literal">siege_url.txt</code> file and paste the following content in it:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/default/default/images/bkg_body.gif</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/default/default/images/logo.gif</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/default/default/images/ph_callout_left_top.gif</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/default/default/images/ph_callout_left_rebel.jpg</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/default/default/images/home_main_callout.jpg</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/index.php/electronics.html</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/index.php/electronics.html?cat=12</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/index.php/checkout/cart/add/product/46/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/index.php/checkout/cart/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/default/default/images/i_shipping.gif</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/default/default/images/i_discount.gif</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/default/default/images/btn_trash.gif</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/default/default/images/bkg_th.gif</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/default/default/images/i_msg-success.gif</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/default/default/images/btn_checkout.gif</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/index.php/checkout/onepage/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/js/varien/accordion.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/base/default/js/opcheckout.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/default/default/images/opc-ajax-loader.gif</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/skin/frontend/default/default/images/cvv.gif</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/index.php/checkout/onepage/progress/?toStep=billing</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/index.php/electronics/cameras/accessories/universal-camera-case</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/index.php/tag/product/list/tagId/185/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/index.php/tag/product/list/tagId/27/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">http://magento-dev.local/index.php/customer/account/login/</code></li></ul></div></li><li class="listitem">You can change the URLs so that they match your Magento configuration. Make sure that the domain matches your configuration and that the URLs exist.</li><li class="listitem">Run the following command to <a id="id571" class="indexterm"/>start the load test with 50 concurrent users:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>siege -c50 -i -t 1M -d 3 -f siege_url.txt</strong></span>
</pre></div></li><li class="listitem">The period for which this script will run depends on the webshop's performance. The output of the command is shown as follows:<div class="informalexample"><pre class="programlisting">~$ siege -c50 -i -t 1M -d 3 -f siege_url.txt
** SIEGE 2.70
** Preparing 50 concurrent users for battle.
The server is now under siege...
Lifting the server siege...      done.
Transactions:                   2001 hits
Availability:                 100.00 %
Elapsed time:                  59.48 secs
Data transferred:               0.49 MB
Response time:                  0.00 secs
Transaction rate:              33.64 trans/sec
Throughput:                     0.01 MB/sec
Concurrency:                    0.03
Successful transactions:          38
Failed transactions:               0
Longest transaction:            0.04
Shortest transaction:           0.00</pre></div><p>With the Siege <a id="id572" class="indexterm"/>
<code class="literal">-h</code> command, you can see all the available options.</p></li><li class="listitem">We continue with the configuration of Magento Profiler. To enable the Magento Profiler, open the <a id="id573" class="indexterm"/>backend and navigate to <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Advanced</strong></span> | <span class="strong"><strong>Developer</strong></span> | <span class="strong"><strong>Debug</strong></span>. Configure the <span class="strong"><strong>Profiler</strong></span> field<a id="id574" class="indexterm"/> as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_11_03.jpg" alt="How to do it..."/></div></li><li class="listitem">To see some more statistics, uncomment the following line in the <code class="literal">index.php</code> file:<div class="informalexample"><pre class="programlisting">Varien_Profiler::enable();</pre></div></li><li class="listitem">When you reload the frontend, you will see a grid as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_11_04.jpg" alt="How to do it..."/></div></li><li class="listitem">In the previous screenshot, you can see the execution time and memory that is used for each function that is <a id="id575" class="indexterm"/>executed. This can help you to find a performance leak.</li><li class="listitem">Next, we will install YSlow in Firefox.<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">YSlow is a Firefox plugin that is installed with Firebug</li></ul></div></li><li class="listitem">To open YSlow,<a id="id576" class="indexterm"/> open Firebug by pressing <span class="emphasis"><em>F12</em></span> or by clicking on the icon in the Add-ons bar.</li><li class="listitem">After Firebug starts, open the YSlow tab.</li><li class="listitem">Check that the <span class="strong"><strong>Ruleset</strong></span> dropdown is set to <span class="strong"><strong>YSlow(V2)</strong></span>.</li><li class="listitem">Start the test by clicking on the <span class="strong"><strong>Run Test</strong></span> button.</li><li class="listitem">YSlow performs some tests and then displays the results of these tests as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="graphics/3329OS_11_05.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec202"/>How it works...</h2></div></div></div><p>We started with ApacheBench, which is a tool that is installed with the Apache web server. This tool is designed to <a id="id577" class="indexterm"/>benchmark the HTTP requests.</p><p>We performed a test with a number of concurrent users. When you test with a load of 10 concurrent users, you will simulate a continuous load of 10 requests during the time of the test. When a request is finished, a new one is fired, so there are always 10 processes running.</p><p>When you limit the time of the test to 30 seconds, you can see how many successful requests your Apache server has finished during that time. This can give you a good idea of the capacity your web server has.</p><p>Siege is a tool similar to ApacheBench. The main difference is that Siege has more options than ApacheBench. In this recipe, <a id="id578" class="indexterm"/>we did a load test with a list of URLs. In this list, you can add products to the cart by creating POST requests to simulate a human flow on the webshop. Mostly, product pages are cached but session-specific flows, such as the checkout, can't be cached and will generate more load on your server.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip42"/>Tip</h3><p>With ApacheBench and Siege, you can create load on a website. While doing this on a remote website, it is possible that you will be blocked by a firewall because many requests from the same host appear like an attack.</p></div></div><p>The performance of a web page depends on many factors. YSlow has bundled the most important factors and runs a test with these factors. The parameters are bundled in rulesets. The ruleset we used is the YSlow (V2) that contains most of the checks. You can choose some others or create your own.</p><p>When the test runs, YSlow will check all the factors that are in the ruleset. For every factor, it will give a score. The average of all scores is multiplied by the weight of each factor. The weight depends on the impact of every factor on the performance of a website.</p><p>In the report generated by YSlow, suggestions are made to get a better score on every specific part. It is up to you to decide which option you will choose to optimize your site.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec203"/>There's more...</h2></div></div></div><p>When your site is on a public URL, you can use some online tools to show a report of your site's performance. These tools will look at your site and generate a report on it. It will make some suggestions just like YSlow does:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>WebPagetest</strong></span>: This<a id="id579" class="indexterm"/> tool can be found at <a class="ulink" href="http://www.webpagetest.org/">http://www.webpagetest.org/</a></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>GTmetrix</strong></span>: This tool <a id="id580" class="indexterm"/>can be found at <a class="ulink" href="http://gtmetrix.com/">http://gtmetrix.com/</a></li></ul></div></div></div>
<div class="section" title="Optimizing the database and MySQL configuration"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec80"/>Optimizing the database and MySQL configuration</h1></div></div></div><p>When scaling a Magento website, you will <a id="id581" class="indexterm"/>have one part that will be a hard job and that is the MySQL database. You can scale your shop with multiple servers but the database is a central storage of all the data of the website, which is not so easy to scale because <a id="id582" class="indexterm"/>everything needs to be in sync. In this recipe, we will optimize the Magento MySQL database and the MySQL server.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec204"/>Getting ready</h2></div></div></div><p>Log in to phpMyAdmin and <a id="id583" class="indexterm"/>navigate to the next page that shows the information about the database.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec205"/>How to do it...</h2></div></div></div><p>The first step is to optimize the table structures of the Magento database. Take a look at the following procedure:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">When you are in phpMyAdmin, click on the Magento database, and you will see the table overview.</li><li class="listitem">At the bottom of this page, click on the <span class="strong"><strong>check all</strong></span> button<a id="id584" class="indexterm"/>.</li><li class="listitem">When you click on the drop-down list, you can repair the table and optimize it, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_11_06.jpg" alt="How to do it..."/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip43"/>Tip</h3><p>Make sure you run this action for all the tables in the Magento database. It could happen that the list is separated and presented in multiple pages.</p></div></div></li><li class="listitem">When you have repaired and optimized everything, your MySQL database is optimized. You can also replicate the database with the Master/Slave setup as we have done in the <span class="emphasis"><em>Configuring a Master/Slave setup</em></span> recipe in <a class="link" href="ch05.html" title="Chapter 5. Database Concepts">Chapter 5</a>, <span class="emphasis"><em>Database Concepts</em></span>.</li></ol></div><p>The second step is the optimization of the MySQL server. Perform the following steps to optimize the MySQL server:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">A good server configuration starts with good hardware and the right operating system. To run Magento, it is recommended to use a dedicated server or a VPS. When you use a shared environment, the RAM and CPU load is shared among<a id="id585" class="indexterm"/> other users. With a VPS or dedicated server, you have a fixed number of CPUs and a fixed amount of RAM available.</li><li class="listitem">When your server is equipped with enough RAM, you can turn off the swapped devices. Sometimes, the swap option will be automatically used even if enough memory is available.</li><li class="listitem">In the <code class="literal">my.cnf</code> file, under the <code class="literal">[mysqld]</code> section, use the <code class="literal">skip-external-locking</code> parameter to avoid external locking.</li><li class="listitem">The following command<a id="id586" class="indexterm"/> is used to set the right value for <code class="literal">key_buffer</code> in the <code class="literal">MyISAM</code> tables. To see the configuration, run the following command on the MySQL prompt:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysql&gt; SHOW VARIABLES LIKE '%key_buffer%';</strong></span>
</pre></div></li><li class="listitem">We will set the key buffer size to 512 MB. We can do this by running the following command on the MySQL prompt:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysql&gt; SET GLOBAL key_buffer_size = 536870912;</strong></span>
</pre></div></li><li class="listitem">We will do the following optimization settings in the <code class="literal">my.cnf</code> file. This is the main configuration file of the MySQL server that is located in the <code class="literal">app/etc/mysql</code> folder:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the file and paste the following configuration under the <code class="literal">[mysqld]</code> section:<div class="informalexample"><pre class="programlisting">[mysqld]
key_buffer = 512M
max_allowed_packet = 64M
thread_stack = 192K
thread_cache_size = 32
table_cache = 512
query_cache_type = 1
query_cache_size = 52428800
tmp_table_size = 128M
expire_logs_days = 10
max_binlog_size = 100M
sort_buffer_size = 4M
read_buffer_size = 4M
read_rnd_buffer_size = 2M
myisam_sort_buffer_size = 64M
wait_timeout = 300
max_connections = 400</pre></div></li><li class="listitem">Save the file and restart your MySQL server. You can do this by running the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo service mysql restart</strong></span>
</pre></div></li></ol></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec206"/>How it works...</h2></div></div></div><p>While optimizing a MySQL server, you have to know the capabilities of your server and the traffic you expect. With these <a id="id587" class="indexterm"/>parameters, you can calculate a good value for the <code class="literal">key_buffer</code>, <code class="literal">query_cache</code>, and <code class="literal">table_cache</code>. Also, think<a id="id588" class="indexterm"/> about the <code class="literal">skip-external-locking</code> parameter.<a id="id589" class="indexterm"/> With this parameter, you can deny external locking.</p><p>With the following commands, you can view the MySQL server status:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Command</p>
</th><th style="text-align: left" valign="bottom">
<p>More information</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>mysql&gt; SHOW STATUS;<a id="id590" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>This command shows the current status of the MySQL server. This command is available in MySQL 5.0 and higher, and is the standard to show all the global variables.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>mysql&gt; SHOW VARIABLES;<a id="id591" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>All the MySQL variables are shown with this command.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>mysql&gt; SHOW INNODB STATUS;<a id="id592" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>This command lets you find out the current <code class="literal">INNODB</code> status.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>mysql&gt; SHOW GLOBAL STATUS;<a id="id593" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>This command shows the values of the load on the database server for all connections.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>mysql&gt; SHOW LOCAL STATUS;<a id="id594" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the same as the <code class="literal">SHOW GLOBAL STATUS</code> command, but the values are calculated on the current connection.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>mysql&gt; mysqladmin extended -i100 -r<a id="id595" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Use this command to view what is happening currently with the MySQL server.</p>
</td></tr></tbody></table></div><p>The database optimization is one of the key aspects to tune your Magento webshop. The database optimization amounts to 50 percent <a id="id596" class="indexterm"/>of a page load.</p></div></div>
<div class="section" title="Optimizing the Apache web server"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec81"/>Optimizing the Apache web server</h1></div></div></div><p>Magento recommends the use of Apache web server when you run a Magento website. There are some other web servers on the market, such as Nginx, but initially Magento was optimized to run on Apache.</p><p>The performance of the web server depends mostly<a id="id597" class="indexterm"/> on the hardware on which the server is running. Network card, RAM, disk, OS, and CPU are important hardware to think about when you are choosing a server.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec207"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first thing to think about is the OS on which the web server will run. It is highly recommended to use a Linux distribution. In the recipes of this book, we used an Ubuntu server (a Debian-based Linux distribution).<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip44"/>Tip</h3><p>Don't use a Windows server to run Magento. It will work but it is less efficient and can lead to issues with file permissions, code, and more.</p></div></div></li><li class="listitem">Update the OS to the latest stable version because the update software is faster and safer. Use Apache2 instead of the Apache1 series. Apache2 uses fewer CPU resources while delivering static content.</li><li class="listitem">Install only the required services on the web server. When a lot of services are installed, you will have background tasks that will use the resources of the server.</li><li class="listitem">Use XFS and ReiserFS as the filesystem for a better disk I/O.</li><li class="listitem">You have to configure the web server so that it never has to swap. When your web server begins to swap, all requests will be served slower. The first thing is to compare the volume of RAM on the server with the average memory load of a request and the number of requests. The second thing you can do is to configure the <code class="literal">MaxClients</code> setting. This setting controls the number of child processes when the server swaps.</li><li class="listitem">Look at the <code class="literal">HostnameLookups</code> setting and check if this is configured with the <code class="literal">Off</code> value.</li><li class="listitem">It is not recommended to use the <code class="literal">SymLinksIfOwnerMatch</code> setting. It is better to use <code class="literal">Options</code> <code class="literal">+FollowSymLinks</code> <code class="literal">+SymLinksIfOwnerMatch</code> for specified directories. For other locations, use the <code class="literal">Options</code> <code class="literal">+FollowSymLinks</code> setting<a id="id598" class="indexterm"/> to prevent that the system calls <code class="literal">lstat(2)</code>. The <code class="literal">lstat()</code> system calls are never cached.</li><li class="listitem">Don't use a wildcard syntax in the <code class="literal">DirectoryIndex</code> setting. The setting is shown as follows:<div class="informalexample"><pre class="programlisting">DirectoryIndex index</pre></div></li><li class="listitem">It is better to use <code class="literal">index.php</code> only because Magento uses <code class="literal">index.php</code> as the default index. This <a id="id599" class="indexterm"/>setting is shown as follows:<div class="informalexample"><pre class="programlisting">DirectoryIndex index.php</pre></div></li><li class="listitem">Enable the <code class="literal">deflate</code> and <code class="literal">header</code> Apache modules with the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo a2enmod deflate</strong></span>
<span class="strong"><strong>sudo a2enmod header</strong></span>
</pre></div></li><li class="listitem">Open the <code class="literal">.htaccess</code> file in the Magento root and go to the <code class="literal">mod_deflate</code> configuration tag. Uncomment some lines so that the block looks like the following code:<div class="informalexample"><pre class="programlisting">&lt;IfModule mod_deflate.c&gt;

############################################
## enable apache served files compression
## http://developer.yahoo.com/performance/rules.html#gzip

    # Insert filter on all content
    SetOutputFilter DEFLATE
    # Insert filter on selected content types only
    AddOutputFilterByType DEFLATE text/html text/plain text/xmltext/css text/javascript

    # Netscape 4.x has some problems...
    BrowserMatch ^Mozilla/4 gzip-only-text/html

    # Netscape 4.06-4.08 have some more problems
    BrowserMatch ^Mozilla/4\.0[678] no-gzip

    # MSIE masquerades as Netscape, but it is fine
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html

    # Don't compress images
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary

    # Make sure proxies don't deliver the wrong content
    Header append Vary User-Agent env=!dont-vary

&lt;/IfModule&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip45"/>Tip</h3><p>When you get an internal server error after the change, it is possible that the Apache <code class="literal">headers</code> module is not enabled. Run the <code class="literal">sudo a2enmod header</code> command and restart the server to fix this.</p></div></div></li><li class="listitem">Take a look at the <code class="literal">KeepAlive</code> setting of your Apache server. When this is on, the Apache server can<a id="id600" class="indexterm"/> serve multiple requests through the same TCP connection.</li><li class="listitem">Configure the <a id="id601" class="indexterm"/><span class="strong"><strong>MPM</strong></span> (<span class="strong"><strong>Multi-Processing Modules</strong></span>) for your case. The values of these configurations depend on the resources and load that you expect on your server.<div class="informalexample"><pre class="programlisting">StartServers 50
MinSpareServers 15
MaxSpareServers 30
MaxClients 225
MaxRequestsPerChild 4000</pre></div></li><li class="listitem">When you run some load tests again, you can compare the obtained results with the results before the optimization. Usually, you will see some differences.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec208"/>How it works...</h2></div></div></div><p>The performance of a web server depends on many factors. The key parts are the application, the hardware, the OS, and the network.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Application</strong></span>: The first thing is to ensure that your application is working efficiently with the resources of the <a id="id602" class="indexterm"/>server. If your application expects a lot of resources for a request, you can optimize it here.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Hardware</strong></span>: The second thing is <a id="id603" class="indexterm"/>the hardware of the server. You have to make sure that the resources of a server are high enough to serve the expected load and peaks.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>OS</strong></span>: The third thing is the OS and web server. Use a Linux server for Magento with an Apache or Nginx<a id="id604" class="indexterm"/> web server on it. Always use the latest version of the software because it is mostly faster and more secured.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Network</strong></span>: The last thing is the network. The web server sends the response through the network to the client. <a id="id605" class="indexterm"/>When that network is slow, the download time of a request will be long. Host your web server with a good network connection and host it in the same region as that of the target audience of your webshop. For example, host your website in Italy for an Italian website.</li></ul></div><p>Optimize the configurations of the system you are using. In this recipe, we did some optimizations to tweak the Apache web server by defining custom settings in the <code class="literal">.htaccess</code> file.</p><p>The last thing is the geographic location of your web server. It is better to locate your web server in the region where your target audience lives. Also, limit the size and number of HTTP requests.</p></div></div>
<div class="section" title="Tuning the Magento configurations"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec82"/>Tuning the Magento configurations</h1></div></div></div><p>Magento has some standard features for a better performance, such as caching and compilation. In this recipe, we will configure these features for a better performance of the setup.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec209"/>Getting ready</h2></div></div></div><p>Log in to the admin panel and navigate to the configuration page at <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Configuration</strong></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec210"/>How to do it...</h2></div></div></div><p>When you perform the following steps,<a id="id606" class="indexterm"/> your Magento installation will run a bit faster:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Uninstall or disable the extensions that you are not using.</li><li class="listitem">Enable all caching systems that Magento has. They are located at <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Cache Management</strong></span>.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip46"/>Tip</h3><p>When all caches are enabled, make sure you clear them when you are developing the code.</p></div></div></li><li class="listitem">Compile your Magento installation. You can do this by clicking on <span class="strong"><strong>Run Compilation Process</strong></span> on the compilation page at <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Tools</strong></span> | <span class="strong"><strong>Compilation</strong></span>. When the compilation is enabled, all the Magento classes are built in one directory where they will be loaded faster. Compilation can increase the speed by 25 to 50 percent.</li><li class="listitem">Disable the unused modules. You can do this by disabling the frontend output by navigating to <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Advanced</strong></span> | <span class="strong"><strong>Disable Modules Output</strong></span>. When you're not<a id="id607" class="indexterm"/> using the <code class="literal">Mage_Poll</code> module, you can disable it here.</li><li class="listitem">Disable some developer features because you don't need them on a live site. Go to <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Advanced</strong></span> | <span class="strong"><strong>Developers</strong></span> and configure it as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_11_07.jpg" alt="How to do it..."/></div></li><li class="listitem">Go to <span class="strong"><strong>Catalog</strong></span> | <span class="strong"><strong>Attributes</strong></span> | <span class="strong"><strong>Manage Attributes</strong></span>. When you click on an attribute, you can see the <span class="strong"><strong>Frontend Properties</strong></span> section. Set only those configuration parameters that you <a id="id608" class="indexterm"/>want to use in the frontend to <span class="strong"><strong>Yes</strong></span>.</li><li class="listitem">Go to <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Catalog</strong></span> and enable the flat catalog product and flat catalog category settings, as shown in the following screenshot. When enabled, a part of the EAV system will be converted to flat tables:</li></ol></div><div class="mediaobject"><img src="graphics/3329OS_11_08.jpg" alt="How to do it..."/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note11"/>Note</h3><p>You can find more information about the flat catalog settings in the <span class="emphasis"><em>Working with EAV tables</em></span> recipe of <a class="link" href="ch05.html" title="Chapter 5. Database Concepts">Chapter 5</a>, <span class="emphasis"><em>Database Concepts</em></span>.</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec211"/>How it works...</h2></div></div></div><p>The standard Magento configurations are not the best configurations for an optimal performance. Every option you enable<a id="id609" class="indexterm"/> has some impact on the flexibility of development and compatibility with platforms and modules.</p><p>When caching is enabled, you will have a better performance. However, you have to keep in mind that you will have to clear it frequently while developing the code, to see your changes in action.</p><p>Development features are useful when developing code because it contains interesting information. However, when your site is live, you don't need these features as it will slow down your website. It is recommended that you disable this.</p><p>Compilation is a process where Magento will copy all the classes from the <code class="literal">app/code</code> folder into the <code class="literal">includes</code> folder. When all the classes are located in one folder, it is faster to load a class instead of looking into all the different module's folders to load a class.</p><p>The advantage of compilation<a id="id610" class="indexterm"/> is that your<a id="id611" class="indexterm"/> site will be faster but a disadvantage is that you have to run the compilation process after every change in the code. When you use a module that doesn't follow the Magento standards, it can lead to errors when compilation is enabled.</p><p>The last thing is to enable the flat catalog product and flat catalog category. When you enable these features, Magento will use a flat table for loading products and categories instead of looking in the different EAV tables.</p><p>The disadvantages <a id="id612" class="indexterm"/>of using this is that you have to sync the data from the EAV tables to the flat tables. When working with a large amount of products and categories, the index process that syncs the data runs for a very long duration.</p></div></div>
<div class="section" title="Configuring APC and Memcached"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec83"/>Configuring APC and Memcached</h1></div></div></div><p>The cache system in Magento is based on cache parts of the HTML output and some configuration files. In this recipe, we will configure caching on the PHP level that you can do with APC and Memcached. APC will cache PHP files, while Memcached will cache objects.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec212"/>Getting ready</h2></div></div></div><p>When configuring APC and Memcached for our Magento store, we have to make sure that APC is installed on the server.</p><p>To install APC, follow<a id="id613" class="indexterm"/> these instructions:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">On a Debian-based Linux distribution, you can install APC with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install php-apc</strong></span>
</pre></div></li><li class="listitem">Follow the installer and APC will be available in your PHP configuration.</li><li class="listitem">To install Memcached, you can run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install php5-memcached</strong></span>
</pre></div></li><li class="listitem">To test if the extensions are correctly installed, you can use the <code class="literal">phpinfo()</code> command<a id="id614" class="indexterm"/>. This command gives you a graphical representation of all the available PHP settings.</li><li class="listitem">To see <code class="literal">phpinfo</code>, create a <code class="literal">phpinfo.php</code> file with the following content:<div class="informalexample"><pre class="programlisting">&lt;?php
phpinfo();</pre></div></li></ol></div><p>When you search on APC and Memcached, you will see a block that contains all the settings.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec213"/>How to do it...</h2></div></div></div><p>In the following steps, we will discuss the <a id="id615" class="indexterm"/>APC and Memcached <a id="id616" class="indexterm"/>configuration in Magento:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Make sure APC and Memcached are installed on the server. This is described in the previous section of this recipe.</li><li class="listitem">Open the <code class="literal">app/code/local.xml</code> file and add a <code class="literal">&lt;cache&gt;</code> block as a child of the <code class="literal">&lt;global&gt;</code> tag. Your <code class="literal">local.xml</code> file looks as follows:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;config&gt;
 &lt;global&gt;
    &lt;install&gt;
      &lt;date&gt;&lt;![CDATA[Mon,
      22 Jul 2013 18:12:54 +0000]]&gt;&lt;/date&gt;
    &lt;/install&gt;
    &lt;crypt&gt;
      &lt;key&gt;&lt;![CDATA[cac0174a5563885b926aa73723aeb870]]&gt;&lt;/key&gt;
    &lt;/crypt&gt;
    &lt;disable_local_modules&gt;false&lt;/disable_local_modules&gt;
    &lt;resources&gt;
      &lt;db&gt;
        &lt;table_prefix&gt;&lt;![CDATA[]]&gt;&lt;/table_prefix&gt;
      &lt;/db&gt;
      &lt;default_setup&gt;
        &lt;connection&gt;
          &lt;host&gt;&lt;![CDATA[localhost]]&gt;&lt;/host&gt;
          &lt;username&gt;&lt;![CDATA[root]]&gt;&lt;/username&gt;
          &lt;password&gt;&lt;![CDATA[root]]&gt;&lt;/password&gt;
          &lt;dbname&gt;&lt;![CDATA[magento_dev]]&gt;&lt;/dbname&gt;
          &lt;initStatements&gt;&lt;![CDATA
          [SET NAMES utf8]]&gt;&lt;/initStatements&gt;
          &lt;model&gt;&lt;![CDATA[mysql4]]&gt;&lt;/model&gt;
          &lt;type&gt;&lt;![CDATA[pdo_mysql]]&gt;&lt;/type&gt;
          &lt;pdoType&gt;&lt;![CDATA[]]&gt;&lt;/pdoType&gt;
          &lt;active&gt;1&lt;/active&gt;
        &lt;/connection&gt;
      &lt;/default_setup&gt;
    &lt;/resources&gt;
    &lt;session_save&gt;&lt;![CDATA[files]]&gt;&lt;/session_save&gt;
    <span class="strong"><strong>&lt;cache&gt;</strong></span>
<span class="strong"><strong>      &lt;backend&gt;apc&lt;/backend&gt;</strong></span>
<span class="strong"><strong>    &lt;/cache&gt;</strong></span>
  &lt;/global&gt;
  &lt;admin&gt;
    &lt;routers&gt;
      &lt;adminhtml&gt;
        &lt;args&gt;
          &lt;frontName&gt;&lt;![CDATA[admin]]&gt;&lt;/frontName&gt;
        &lt;/args&gt;
      &lt;/adminhtml&gt;
    &lt;/routers&gt;
  &lt;/admin&gt;
&lt;/config&gt;</pre></div></li><li class="listitem">Clear all the Magento caches and restart your Apache server. When you do a load test with ApacheBench, you will see that there is a big improvement in the performance:<div class="informalexample"><pre class="programlisting">ab -c 5 -n 100 http://magento-dev.local</pre></div></li><li class="listitem">The previous<a id="id617" class="indexterm"/> configuration enables the APC configuration for Magento. With the next configuration, we enable Memcached. We do this by<a id="id618" class="indexterm"/> adding a <code class="literal">&lt;cache&gt;</code> tag <a id="id619" class="indexterm"/>as a child of the<a id="id620" class="indexterm"/> <code class="literal">&lt;global&gt;</code> tag. With Memcached, the <code class="literal">local.xml</code> file will look as follows:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;config&gt;
  &lt;global&gt;
    &lt;install&gt;
      &lt;date&gt;&lt;![CDATA[Mon,
      22 Jul 2013 18:12:54 +0000]]&gt;&lt;/date&gt;
    &lt;/install&gt;
    &lt;crypt&gt;
      &lt;key&gt;&lt;![CDATA[cac0174a5563885b926aa73723aeb870]]&gt;&lt;/key&gt;
    &lt;/crypt&gt;
    &lt;disable_local_modules&gt;false&lt;/disable_local_modules&gt;
    &lt;resources&gt;
      &lt;db&gt;
        &lt;table_prefix&gt;&lt;![CDATA[]]&gt;&lt;/table_prefix&gt;
      &lt;/db&gt;
      &lt;default_setup&gt;
        &lt;connection&gt;
          &lt;host&gt;&lt;![CDATA[localhost]]&gt;&lt;/host&gt;
          &lt;username&gt;&lt;![CDATA[root]]&gt;&lt;/username&gt;
          &lt;password&gt;&lt;![CDATA[root]]&gt;&lt;/password&gt;
          &lt;dbname&gt;&lt;![CDATA[magento_dev]]&gt;&lt;/dbname&gt;
          &lt;initStatements&gt;&lt;![CDATA
          [SET NAMES utf8]]&gt;&lt;/initStatements&gt;
          &lt;model&gt;&lt;![CDATA[mysql4]]&gt;&lt;/model&gt;
          &lt;type&gt;&lt;![CDATA[pdo_mysql]]&gt;&lt;/type&gt;
          &lt;pdoType&gt;&lt;![CDATA[]]&gt;&lt;/pdoType&gt;
          &lt;active&gt;1&lt;/active&gt;
        &lt;/connection&gt;
      &lt;/default_setup&gt;
    &lt;/resources&gt;
    &lt;session_save&gt;&lt;![CDATA[files]]&gt;&lt;/session_save&gt;
<span class="strong"><strong>    &lt;cache&gt;</strong></span>
<span class="strong"><strong>      &lt;backend&gt;memcached&lt;/backend&gt;</strong></span>
<span class="strong"><strong>      &lt;slow_backend&gt;database&lt;/slow_backend&gt;</strong></span>
<span class="strong"><strong>      &lt;memcached&gt;</strong></span>
<span class="strong"><strong>        &lt;servers&gt;</strong></span>
<span class="strong"><strong>          &lt;server&gt;</strong></span>
<span class="strong"><strong>            &lt;host&gt;&lt;![CDATA[127.0.0.1]]&gt;&lt;/host&gt;</strong></span>
<span class="strong"><strong>            &lt;port&gt;&lt;![CDATA[11211]]&gt;&lt;/port&gt;</strong></span>
<span class="strong"><strong>            &lt;persistent&gt;&lt;![CDATA[1]]&gt;&lt;/persistent&gt;</strong></span>
<span class="strong"><strong>            &lt;weight&gt;&lt;![CDATA[2]]&gt;&lt;/weight&gt;</strong></span>
<span class="strong"><strong>            &lt;timeout&gt;&lt;![CDATA[10]]&gt;&lt;/timeout&gt;</strong></span>
<span class="strong"><strong>            &lt;retry_interval&gt;&lt;![CDATA[10]]&gt;&lt;/retry_interval&gt;</strong></span>
<span class="strong"><strong>            &lt;status&gt;&lt;![CDATA[1]]&gt;&lt;/status&gt;</strong></span>
<span class="strong"><strong>          &lt;/server&gt;</strong></span>
<span class="strong"><strong>        &lt;/servers&gt;</strong></span>
<span class="strong"><strong>        &lt;compression&gt;&lt;![CDATA[0]]&gt;&lt;/compression&gt;</strong></span>
<span class="strong"><strong>        &lt;cache_dir&gt;&lt;![CDATA[]]&gt;&lt;/cache_dir&gt;</strong></span>
<span class="strong"><strong>        &lt;hashed_directory_level&gt;&lt;![CDATA[]]&gt;</strong></span>
<span class="strong"><strong>        &lt;/hashed_directory_level&gt;</strong></span>
<span class="strong"><strong>        &lt;hashed_directory_umask&gt;&lt;![CDATA[]]&gt;</strong></span>
<span class="strong"><strong>        &lt;/hashed_directory_umask&gt;</strong></span>
<span class="strong"><strong>        &lt;file_name_prefix&gt;&lt;![CDATA[]]&gt;&lt;/file_name_prefix&gt;</strong></span>
<span class="strong"><strong>      &lt;/memcached&gt;</strong></span>
<span class="strong"><strong>    &lt;/cache&gt;</strong></span>
  &lt;/global&gt;
<span class="strong"><strong>  &lt;cache&gt;</strong></span>
<span class="strong"><strong>    &lt;backend&gt;apc&lt;/backend&gt;</strong></span>
<span class="strong"><strong>  &lt;/cache&gt;</strong></span>
  &lt;admin&gt;
    &lt;routers&gt;
      &lt;adminhtml&gt;
        &lt;args&gt;
          &lt;frontName&gt;&lt;![CDATA[admin]]&gt;&lt;/frontName&gt;
        &lt;/args&gt;
      &lt;/adminhtml&gt;
    &lt;/routers&gt;
  &lt;/admin&gt;
&lt;/config&gt;</pre></div></li><li class="listitem">The last thing is to store the <code class="literal">var/cache</code> folder in memory. We can do this by mounting the folder using TMPFS:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mount tmpfs /var/www/packt/magento-dev/var/cache -t tmpfs -o size=64m</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec214"/>How it works...</h2></div></div></div><p>
<span class="strong"><strong>APC</strong></span> (<span class="strong"><strong>Alternative PHP Cache</strong></span>) is an open source caching framework that optimizes the PHP code, compiles it, and caches it in the shared memory. Executing a precompiled code is faster than loading all the scripts. A <a id="id621" class="indexterm"/>common problem with APC is that you have to clear the APC cache before you see any code changes because some parts of the old code are cached.</p><p>Memcached is another caching system in PHP. Memcached will cache objects that will be used in the application later. Examples<a id="id622" class="indexterm"/> are database objects, sessions, and API calls. Memcached runs on a server, that is, in this example, the same server as the web server. By setting the Magento configuration, we connect to the local Memcached <a id="id623" class="indexterm"/>server that runs on port 11211.</p><p>In Magento, Memcached increases the performance. In the frontend, there is some effect but the largest effect is in the backend where Magento itself caches very few things.</p><p>The last thing was to mount the Magento <code class="literal">cache</code> folder in the memory. When enough memory is available, it is faster to store the cache files in the RAM memory. When they are located in the RAM, it is faster to load a cache file instead of reading it from the disk.</p></div></div>
<div class="section" title="Optimizing the PHP configurations"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec84"/>Optimizing the PHP configurations</h1></div></div></div><p>When you are not using an APC such as an accelerator, think about using a PHP accelerator; we will see how in this recipe. When a PHP script is requested, the script will be read and then it will be compiled in <a id="id624" class="indexterm"/>binary, which is called opcode. This compiled code will be executed by the PHP engine.</p><p>An opcode cache is simply a<a id="id625" class="indexterm"/> caching mechanism that saves the compiled code so that the code doesn't have to be compiled every time the script will run. In this recipe, we will optimize the <code class="literal">php.ini</code> settings for the best performance.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec215"/>Getting ready</h2></div></div></div><p>There are a lot of PHP accelerators on the market, such as APC, eAccelerator, XCache, Zend Accelerator<a id="id626" class="indexterm"/>, and Zend Platform. At the following URLs, you can find out more information about these accelerators:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>APC</strong></span>: This PHP accelerator can<a id="id627" class="indexterm"/> be found<a id="id628" class="indexterm"/> at <a class="ulink" href="http://pecl.php.net/package/APC">http://pecl.php.net/package/APC</a></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>eAccelerator</strong></span>: This<a id="id629" class="indexterm"/> PHP accelerator <a id="id630" class="indexterm"/>can be found at <a class="ulink" href="http://eaccelerator.net/">http://eaccelerator.net/</a></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>XCache</strong></span>: This PHP accelerator<a id="id631" class="indexterm"/> can be found <a id="id632" class="indexterm"/>at <a class="ulink" href="http://xcache.lighttpd.net/">http://xcache.lighttpd.net/</a></li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec216"/>How to do it...</h2></div></div></div><p>The following steps describe some measures that you can take to improve the PHP configuration:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use an efficient process manager, such as php-fpm, that runs on an impressive speed on FastCGI.</li><li class="listitem">Use the <code class="literal">realpath_cache_size</code> configuration setting to configure the size of the real path cache in PHP. On systems where PHP opens and closes a lot of files, this value needs to be increased. You can use the following setting for Magento:<div class="informalexample"><pre class="programlisting">realpath_cache_size=1M
realpath_cache_ttl=86400</pre></div></li><li class="listitem">The settings in the following table can improve the performance of the PHP settings:<div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Setting</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Recommended value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">max_execution_time</code>
<a id="id633" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>This setting sets the maximum time (in seconds) for which a process can live.</p>
</td><td style="text-align: left" valign="top">
<p>120</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">max_input_time</code>
<a id="id634" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>This property sets the time (in seconds) for which a script will wait for input data.</p>
</td><td style="text-align: left" valign="top">
<p>240</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">memory_limit</code>
<a id="id635" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>With this setting, you can set the amount of memory a process can consume.</p>
</td><td style="text-align: left" valign="top">
<p>For Magento, it is recommended to use 216 MB.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">output_buffering</code>
</p>
</td><td style="text-align: left" valign="top">
<p>With this<a id="id636" class="indexterm"/> setting, you can set the amount of bytes to buffer before sending the response to the client.</p>
</td><td style="text-align: left" valign="top">
<p>4096</p>
</td></tr></tbody></table></div></li><li class="listitem">The last thing is to disable some error reporting levels when your site is live. This can be done by using the following setting:<div class="informalexample"><pre class="programlisting">error_reporting = E_COMPILE_ERROR|E_ERROR|E_ CORE_ERROR</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec217"/>How it works...</h2></div></div></div><p>The values in the <code class="literal">php.ini</code> configuration depend mostly on the application that you are running and the load that the application will have on your system. If your application has some processes that will run for a long time (this is possible with the re-index process when you have a large number of products),<a id="id637" class="indexterm"/> it is required to increase the values of <code class="literal">max_execution_time</code> and <code class="literal">max_input_time</code>. This is the same for the <code class="literal">memory_limit</code> parameter<a id="id638" class="indexterm"/> where the recommended value for Magento is 216 MB.</p><p>Disabling the error reporting on a production system is recommended for warnings and notices but critical errors need to be reported because this information is required when solving the bug.</p></div></div>
<div class="section" title="Analyzing the page speed"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec85"/>Analyzing the page speed</h1></div></div></div><p>YSlow is a tool that analyzes the speed for a web page. It is a plugin that you can install in Firebug. While <a id="id639" class="indexterm"/>running a report, the site will be tested on some parameters. A report will be shown with an overall score of your website.</p><p>The test is based on a ruleset. You have the YSlow (V2) and YSlow (V1) ruleset. We will use the YSlow(V2) ruleset for this recipe, which has 22 rules. The complete page load (including images and static content) can<a id="id640" class="indexterm"/> be increased by 25 to 50 percent if you adhere to the following 22 rules:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Minimize HTTP requests</li><li class="listitem" style="list-style-type: disc">Use a Content Delivery Network</li><li class="listitem" style="list-style-type: disc">Avoid empty <code class="literal">src</code> or <code class="literal">href</code></li><li class="listitem" style="list-style-type: disc">Add an expires header or a cache-control header</li><li class="listitem" style="list-style-type: disc">Use Gzip for components</li><li class="listitem" style="list-style-type: disc">Put stylesheets at the top</li><li class="listitem" style="list-style-type: disc">Put scripts at the bottom</li><li class="listitem" style="list-style-type: disc">Avoid CSS expressions</li><li class="listitem" style="list-style-type: disc">Make JavaScript and CSS external</li><li class="listitem" style="list-style-type: disc">Reduce DNS lookups</li><li class="listitem" style="list-style-type: disc">Minify JavaScript and CSS</li><li class="listitem" style="list-style-type: disc">Avoid redirects</li><li class="listitem" style="list-style-type: disc">Remove duplicate scripts</li><li class="listitem" style="list-style-type: disc">Configure ETags</li><li class="listitem" style="list-style-type: disc">Make AJAX cacheable</li><li class="listitem" style="list-style-type: disc">Use GET for AJAX requests</li><li class="listitem" style="list-style-type: disc">Reduce the number of DOM elements</li><li class="listitem" style="list-style-type: disc">No 404 errors</li><li class="listitem" style="list-style-type: disc">Reduce the cookie size</li><li class="listitem" style="list-style-type: disc">Use cookie-free domains for components</li><li class="listitem" style="list-style-type: disc">Avoid filters</li><li class="listitem" style="list-style-type: disc">Do not scale images in HTML</li><li class="listitem" style="list-style-type: disc">Make <code class="literal">favicon.ico</code> small and cacheable</li></ul></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec218"/>How to do it...</h2></div></div></div><p>Perform the following steps to see what we can do with a YSlow result:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Run the YSlow test on the current <a id="id641" class="indexterm"/>web page. On a standard Magento webshop, the test normally returns an overall C score.</li><li class="listitem">The first thing is to make fewer HTTP requests. You can fix this by enabling CSS and JS merging. For an optimal score, it is recommended to use sprites so that you have only one background image.</li><li class="listitem">To optimize the background image, <a id="id642" class="indexterm"/>you can use an image optimization tool such as Yahoo's Smush.it<a id="id643" class="indexterm"/>. When you upload the <code class="literal">images</code> folder of your theme <a id="id644" class="indexterm"/>and run it, you can download the optimized version as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_11_09.jpg" alt="How to do it..."/></div></li><li class="listitem">You can download the optimized images and replace them in the <code class="literal">skin</code> folder.</li><li class="listitem">The next bad point in the test<a id="id645" class="indexterm"/> is adding the expires header. We can fix this by modifying some rules in the <code class="literal">.htaccess</code> file<a id="id646" class="indexterm"/>.</li><li class="listitem">The following code <a id="id647" class="indexterm"/>shows how to add the <code class="literal">expire</code> headers to the static content of the website:<div class="informalexample"><pre class="programlisting">&lt;IfModule mod_expires.c&gt;

############################################
## Add default Expires header
## http://developer.yahoo.com/performance/rules.html#expires

  ExpiresDefault "access plus 1 year"

  ExpiresDefault
  ExpiresActive On
  ExpiresByType image/gif
  ExpiresByType image/jpg
  ExpiresByType image/jpeg
  ExpiresByType image/png
  ExpiresByType image/x-icon
  ExpiresByType text/css
  ExpiresByType application/x-javascript

&lt;/IfModule&gt;

############################################</pre></div></li><li class="listitem">With the following code, we will compress some file types:<div class="informalexample"><pre class="programlisting">&lt;IfModule mod_deflate.c&gt;

############################################
## enable apache served files compression
## http://developer.yahoo.com/performance/rules.html#gzip

  # Insert filter on all content
  SetOutputFilter DEFLATE
  # Insert filter on selected content types only
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript

  # Netscape 4.x has some problems...
  BrowserMatch ^Mozilla/4 gzip-only-text/html

  # Netscape 4.06-4.08 have some more problems
  BrowserMatch ^Mozilla/4\.0[678] no-gzip

  # MSIE masquerades as Netscape, but it is fine
  BrowserMatch \bMSIE !no-gzip !gzip-only-text/html

  # Don't compress images
  SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary

  # Make sure proxies don't deliver the wrong content
  Header append Vary User-Agent env=!dont-vary

&lt;/IfModule&gt;</pre></div></li><li class="listitem">The last step is to use a CDN network to host your static images. You can use an existing CDN provider<a id="id648" class="indexterm"/> to host the static files of your site, but you can create a subdomain <code class="literal">static.magento-dev.local</code>, which also<a id="id649" class="indexterm"/> points to the Magento root and configures Magento to use this subdomain for static content. You can do this in the backend by navigating to <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>General</strong></span> | <span class="strong"><strong>Web</strong></span><a id="id650" class="indexterm"/>, as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="graphics/3329OS_11_10.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec219"/>How it works...</h2></div></div></div><p>The documentation of all the 22 rules of YSlow is available on their website. If you want more information about <a id="id651" class="indexterm"/>a rule, visit the following page that contains<a id="id652" class="indexterm"/> all the information:</p><p>
<a class="ulink" href="http://developer.yahoo.com/performance/rules.html">http://developer.yahoo.com/performance/rules.html</a>
</p></div></div></body></html>