<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;PHP and MySQL"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. PHP and MySQL</h1></div></div></div><p>In the previous chapter, we discussed PHP as a language for server-side programming. Its main use is to generate HTML dynamically to create web pages that are delivered to the client by the web server, as well as to store, retrieve, and manipulate data on the server. We have used files as the containers for that data, but we have given more than one hint that as soon as the amount of data becomes large and/or complex, we want to use a database instead.</p><p>In this final chapter of the first part of the book, we introduce MySQL, a database of choice for many who do web development. You may have heard of the LAMP stack. This is the<a id="id520" class="indexterm"/> M in <span class="strong"><strong>LAMP</strong></span> (<span class="strong"><strong>Linux/Apache/MySQL/PHP</strong></span>).</p><p>Before diving into MySQL itself, and the way to interface with it in PHP (hence the title of this chapter), we would like to give you a casual introduction to databases in general.</p><div class="section" title="Databases"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec50"/>Databases</h1></div></div></div><p>A database is nothing more than a collection of data, usually organized in some structured way. We use<a id="id521" class="indexterm"/> databases everyday although we might not think of them as databases. Take a phone directory, for instance. It contains a lot of data. The data itself consists of names, addresses, and, of course, phone numbers, typically sorted by last name. This paper database has many disadvantages, though. Once it is printed, it will be incomplete and out of date. And if we want to look up the phone numbers of all the people that live in the same street, we would not know where to start. But it is a database, alright.</p><div class="section" title="Relational databases"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec90"/>Relational databases</h2></div></div></div><p>The term<a id="id522" class="indexterm"/> <span class="strong"><strong>relational databases</strong></span> dates<a id="id523" class="indexterm"/> back to an article written in 1970 by Edgar Frank Codd, working at IBM at the time, called <span class="emphasis"><em>A Relational Model of Data for Large Shared Data Banks</em></span>.</p><p>It presents a model that shows the relationships between the different elements of data and heavily uses tables. In each of those tables, there are several fields or columns that can contain data of various types (strings, numbers, dates, and so on). Entries in those tables are called <span class="strong"><strong>rows</strong></span><a id="id524" class="indexterm"/>, and the first column in each row is an index or primary key, a number, which is usually not changed after it has been created.</p><p>So there can be a table <a id="id525" class="indexterm"/>containing customer information. The index represents the customer ID, and all the other columns or fields are classical things, such as first name, last name, address, and so on. You can easily create other tables and choose what they can contain. Let's assume that we are going to sell books. We could have a table with book information, starting with a book ID, book title, author, category (fiction or non-fiction, or more categories), ISBN number, price, whether it is hardcover, softcover, or an eBook, and so on.</p><p>You could have a separate table for categories; one for authors too, and then, of course, a table for your order information. If you organize your data like this and use the customer, category, and book ID in your order information, you only need to change things in one place in your database when, for example, the customer changes address. The database you are going to learn about in this chapter works as we just described.</p><p>The workflow we are proposing is a two-step process. In the first step, we design how we want our tables to look and whether they should be part of a single database or several. Next, we are going to program our application, our website if you like, to use a database and its tables instead of a flat file.</p><p>To achieve all of this, you need to learn quite a few new things. It should not come as a surprise that one of those things is yet another programming language: <span class="strong"><strong>SQL</strong></span>.</p></div></div></div>
<div class="section" title="SQL"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec51"/>SQL</h1></div></div></div><p>Many people believe that SQL stands for <span class="strong"><strong>Standard Query Language</strong></span>, but actually it doesn't - it is just plain SQL. However, it is a<a id="id526" class="indexterm"/> language, and is some kind of a standard used to perform queries on a database. It is also one of those few programming languages that have been around for many years and is not going away soon. I started working with C when people thought of it as new, but even then it was developed ten years prior.</p><p>SQL is used to query a database and can be thought of as a command-line language, that is, things that are typed in a computer console. Here is an example:</p><div class="informalexample"><pre class="programlisting">SELECT * FROM CRIMINALS WHERE NAME = "JONES" AND BIRTHYEAR  &gt; "1965";</pre></div><p>Here is another example:</p><div class="informalexample"><pre class="programlisting">SELECT  LAST, FIRST, ADDRES FROM CRIMINALS WHERE BIRTHYEAR &gt; "1965";</pre></div><p>If this reminds you of scenes from <span class="emphasis"><em>The Streets of San Francisco</em></span>, or any other crime series of the seventies, you are absolutely right. What they were doing on these computer screens was looking up things in a database, and that was mostly the only thing computers were used for. In our example, <code class="literal">CRIMINALS</code> is the name of a table and the <code class="literal">SELECT</code> command is used to look up all records where (hence <code class="literal">WHERE</code>) a certain condition is met.</p><p>There is no need to<a id="id527" class="indexterm"/> learn the complete language: with just a few commands and condition clauses, we will have enough knowledge to create programs that can do the basic operations with a database, as soon as we have created our <a id="id528" class="indexterm"/>database(s) and tables. That set of basic operations is often referred to as <span class="strong"><strong>CRUD</strong></span> (<span class="strong"><strong>Create, Read, Update</strong></span>,<span class="strong"><strong> and Delete</strong></span>). In SQL, we can handle this with just five commands: <code class="literal">SELECT</code>, <code class="literal">INSERT</code>, <code class="literal">CREATE</code>, <code class="literal">UPDATE</code>, and <code class="literal">DELETE</code>. To accommodate getting data to come out of two tables rather than just one, you will learn another useful SQL feature called <code class="literal">INNER JOIN</code>.</p><p>To avoid repetition, we will teach the basics of these commands in the MySQL section.</p></div>
<div class="section" title="MySQL"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec52"/>MySQL</h1></div></div></div><p>You do not have to be a mechanic to drive a car, but there has to be an engine under the hood or it will not move. To run an application that uses a database, there has to be a database engine under the hood. Database servers used to be dedicated computers; chances are Karl Malden<a id="id529" class="indexterm"/> and Michael Douglas used a database server in the TV series I mentioned earlier.</p><p>Today, database servers are usually software packages. Oracle Corporation specializes in database software; Microsoft has several SQL Server products. These packages can be installed on dedicated computers to function solely as a database server, but we can also install them on the same computer that acts as a Web Server, as well as on our own development system. The package we are going to use is called <span class="strong"><strong>MySQL</strong></span>.</p><p>MySQL is open source, which means free, database server that was created by a Swedish company acquired by Sun Microsystems, which was in turn acquired by Oracle.</p><p>If you have installed a bundle such as <span class="strong"><strong>XAMPP</strong></span> or <span class="strong"><strong>WAMPSERVER</strong></span> (<a class="ulink" href="http://wampserver.com">wampserver.com</a>) for Windows, then you already have MySQL. If not, you<a id="id530" class="indexterm"/> can download it from <a class="ulink" href="http://mysql.com">mysql.com</a>. Installation is very straightforward. Afterwards, you may have to go in your computer settings to make sure that the MySQL server is fired up each time the system is started. Like UNIX systems, MySQL has the concept of users, and the most powerful is <span class="strong"><strong>root</strong></span>. MySQL is installed without a password for root. You want to change that right away. You can do this with the <code class="literal">mysqladmin</code> command. For everything else, we will use a tool or program it <a id="id531" class="indexterm"/>ourselves. Here is the command to change the root password:</p><div class="informalexample"><pre class="programlisting">mysqladmin -u root password <span class="strong"><strong>yourchoiceofpassword</strong></span>
</pre></div></div>
<div class="section" title="phpMyAdmin"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec53"/>phpMyAdmin</h1></div></div></div><p>
<code class="literal">phpMyAdmin</code> is an open source utility written in PHP to help you administer your MySQL database(s). You do not <a id="id532" class="indexterm"/>have to use it, as there are other options, but I made it part of my workflow to create users, databases, and tables, and even populate tables initially. This is the equivalent of the set of SQL statements that SQL buffs call <a id="id533" class="indexterm"/>
<span class="strong"><strong>schema statements</strong></span>.</p><p>I also use <code class="literal">phpMyAdmin</code> to occasionally remove or change a table row. <code class="literal">phpMyAdmin</code> is part of XAMPP, so if you do not use XAMPP, you will have to download it first. It should be straightforward to use once you grasp the concepts that follow. In a worst case scenario, you can grab some articles off the Web. There is even an entire book on <code class="literal">phpMyAdmin</code> by Packt Publishing.</p><div class="section" title="Creating databases"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec91"/>Creating databases</h2></div></div></div><p>You could do everything with a single database and just add tables for each project. However, if your<a id="id534" class="indexterm"/> projects are sufficiently distinct and rather large, it is better to create a different database for each project. <code class="literal">phpMyAdmin</code> lets you do that without the need for SQL commands.</p></div><div class="section" title="Creating and managing users"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec92"/>Creating and managing users</h2></div></div></div><p>We already mentioned a<a id="id535" class="indexterm"/> root password. Root is a user that can do everything. When your program accesses the database, you do not want anybody to accidentally erase <a id="id536" class="indexterm"/>any data in a database. That is why we create other users in MySQL, with just enough CRUD privileges for your database. All you want to allow is to create, read, update, and delete (which is what CRUD stands for) records in a specific database. For that purpose, you create users, give them passwords, and assign privileges. Once again, thanks to <code class="literal">phpMyAdmin</code>, you still do not have to learn SQL commands.</p></div><div class="section" title="Creating and managing database tables"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec93"/>Creating and managing database tables</h2></div></div></div><p>Properly planning the tables that your database will contain is essential for success. It is best to first draft things on a piece of paper. Once you are close to what you want, you can create tables for your database using <code class="literal">phpMyAdmin</code>. You give the table a name, after specifying which database it belongs to, and start listing all the columns, or fields, their names, type, and possibly their maximum length, with the index as <code class="literal">primary key</code> first.</p><p>Once you have set that up, you can<a id="id537" class="indexterm"/> even start propagating those tables with data. For a bookstore webshop application, you can use the tool to enter the information<a id="id538" class="indexterm"/> on all the books you sell; the application itself will take care of adding customer data and order data to your database. <code class="literal">customers</code> and <code class="literal">orders</code> are of course candidates for tables. With <code class="literal">phpMyAdmin</code> you will always at least create the structure of your table, but it may be your web application that fills it with data. Here are two<a id="id539" class="indexterm"/> examples of tables: <span class="strong"><strong>books</strong></span> and<a id="id540" class="indexterm"/> <span class="strong"><strong>authors</strong></span>.</p><p>The books table will have the following data:</p><div class="mediaobject"><img src="graphics/3816_06_01.jpg" alt="Creating and managing database tables"/></div><p>The authors table<a id="id541" class="indexterm"/> will have the following data:</p><div class="mediaobject"><img src="graphics/3816_06_02.jpg" alt="Creating and managing database tables"/></div><p>So, how do we get from<a id="id542" class="indexterm"/> the application to the database? This brings us back to<a id="id543" class="indexterm"/> PHP and the <span class="strong"><strong>mysqli</strong></span> object.</p></div></div>
<div class="section" title="MySQLi in PHP"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec54"/>MySQLi in PHP</h1></div></div></div><p>Although we omitted this on purpose in  <a class="link" href="ch05.html" title="Chapter 5. PHP">Chapter 5</a>, <span class="emphasis"><em>PHP</em></span>, PHP has features found in object-oriented programming languages. So, rather than write functions, you can instead create objects and write <a id="id544" class="indexterm"/>methods for them. This is exactly how the PHP programming interface to MySQL works: there is one dedicated object, <span class="emphasis"><em>mysqli</em></span>, and a number of methods. With these methods, you can connect to a database, submit queries, fetch the result, and finally close the connection.</p><p>Consider that we have<a id="id545" class="indexterm"/> a web application that is an online bookstore. The name of our database is <code class="literal">bookstore</code>, for which we created a user <code class="literal">bookuser</code>, with <code class="literal">book**4u</code> as the password. The database itself contains at a minimum the table's books and authors.</p><p>Let's write our first PHP program using MySQL now.</p><div class="section" title="Connecting to the database"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec94"/>Connecting to the database</h2></div></div></div><p>First we need to <a id="id546" class="indexterm"/>connect to the database. To do so, we need to identify which database we want to connect to, on which host the database server is running, and which database user we want to use. The host will almost always be <code class="literal">localhost</code>. So, here is the beginning of our program:</p><div class="informalexample"><pre class="programlisting">&lt;?php
$database = "bookstore";
$user = "bookuser";
$password = 'book**4u';  // I want to make sure asterixes do not get expanded
$host = "localhost";
$mysqli = new mysqli();     // create a mysqli object
$mysqli-&gt;connect($host, $user, $password, $database);
$mysqli-&gt;set_charset("utf8");  // Make sure we  get data back encoded as UTF-8
?&gt;</pre></div><p>We probably want to call the statement that calls the connect method from a function  so that we can add some intelligence to give the user meaningful information when, for some reason, the connection to the database fails.</p><p>The statement about the character set is extremely important. I am an I18N guy, so I will spare you the details; I will even spare you from explaining what I18N stands for. UTF-8 is a code set that covers how letters used in many different languages are translated into numbers. This line<a id="id547" class="indexterm"/> helps you confirm that data is stored the proper way in your database.</p><p>Next, when your data is retrieved and needs to be displayed on a screen it may have to be translated into another codeset. But this way, you at least know which way you are storing your own data.</p></div><div class="section" title="Our first SQL query, really!"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec95"/>Our first SQL query, really!</h2></div></div></div><p>In plain SQL, the simplest query to get something back from a database, stored in our table <code class="literal">books</code>, would be:</p><div class="informalexample"><pre class="programlisting">SELECT * FROM books WHERE 1;</pre></div><p>This is what <a id="id548" class="indexterm"/>
<code class="literal">phpMyAdmin</code> will suggest as the default SQL query. It can even be shorter:</p><div class="informalexample"><pre class="programlisting">SELECT * FROM books;</pre></div><p>Notice that the query ends in a semicolon and that we do not mention the name of the database. We did that when we made the connection. All SQL keywords are in uppercase. Our <code class="literal">WHERE</code> clause is the simplest imaginable, as it is always true. We just added it to help us in the examples. The <code class="literal">*</code> tells the server to get me all columns. If you only want the title and the price, you would use:</p><div class="informalexample"><pre class="programlisting">SELECT title, price FROM books WHERE 1;</pre></div><p>Now we are going to translate this into a pair of PHP statements. Before you read on, I suggest (assuming that you have created a database and a books table and put some books in it) that you go into <code class="literal">phpMyAdmin</code>, select our database, click on the <span class="strong"><strong>SQL</strong></span> tab, type in the above query, and <a id="id549" class="indexterm"/>examine the result.</p></div><div class="section" title="Writing a MySQL query in PHP"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec96"/>Writing a MySQL query in PHP</h2></div></div></div><p>Our first MySQL<a id="id550" class="indexterm"/> query in PHP is quite simple. We are going to turn the query into a PHP string and call the <code class="literal">query</code> method to get the result:</p><div class="informalexample"><pre class="programlisting">&lt;?php
$sql = 'SELECT title, price FROM books WHERE 1;';
$result = $mysqli-&gt;query($sql);
?&gt;</pre></div></div><div class="section" title="Fetching the result"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec97"/>Fetching the result</h2></div></div></div><p>Now, if we typed in everything correctly—at first you may have mistakenly omitted one of the semicolons on either side of the closing single quote—MySQL will have returned the title and price<a id="id551" class="indexterm"/> of every single book in our table. It has done so by returning an object that we named <code class="literal">$result</code>, which we can apply a few methods to.</p><p>The simplest one will give us the number of rows that were found, the most powerful one being <code class="literal">fetch_assoc()</code>, which will create for us an associative array that we can instantly use in a while loop. So, here is how we can generate an HTML table with a list of all book titles and prices with just a few lines of code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
$numbooks = $result-&gt;num_rows;
$htmlstring = '&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Book title&lt;/th&gt;&lt;th&gt;Price&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;';
while ($row = $result-&gt;fetch_assoc())
{
$htmlstring .= '&lt;tr&gt;&lt;td&gt;'.$row['title'].'&lt;/td&gt;&lt;td&gt;'.$row['price'].'&lt;/td&gt;&lt;/tr&gt;';
}
$htmlstring .= '&lt;/tbody&gt;&lt;/table&gt;';
echo $htmlstring;
?&gt;</pre></div><p>The keys of the associative array are simply the names of the columns in the table.</p></div><div class="section" title="Obtaining data from more than one table"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec98"/>Obtaining data from more than one table</h2></div></div></div><p>Let's assume we do not want the list of all books, but just those by a single author. We want all the books by John Muir, so here is the SQL:</p><div class="informalexample"><pre class="programlisting">SELECT title, price FROM books WHERE author_id = ??? ;</pre></div><p>Wait a minute! How<a id="id552" class="indexterm"/> can we tell which <code class="literal">author_id</code> John Muir has? We cannot. Of John Muir, we know the first and last name, and these are stored in the <code class="literal">authors</code> table. So here comes the most profoundly difficult query of the entire chapter:</p><div class="informalexample"><pre class="programlisting">SELECT title, price FROM books b INNER JOIN authors a WHERE b.author_id = a.author_id AND aname = "Muir" and afirst = "John";</pre></div><p>Alternatively, we could also use:</p><div class="informalexample"><pre class="programlisting">SELECT title, price FROM books b INNER JOIN authors a WHERE b.author_id = a.author_id AND a.aname = "Muir" and a.afirst = "John";</pre></div><p>Notice the subtle difference? We used <code class="literal">a</code> and <code class="literal">b</code> as a shorthand notation for authors and books. Because we chose our field names wisely, there are no identical names showing up in other tables. If that were the case, we would need to specify the table name followed by a dot, as we did in the second example. Otherwise, an error message complaining about ambiguity would occur.</p><p>The results of the query are all titles and prices of books where the <code class="literal">author_id</code> in the table books is the same as the <code class="literal">author_id</code> under <code class="literal">authors</code>, and in that one, it matches the ones with <code class="literal">aname</code> set to Muir and <code class="literal">afirst</code> set to John. Notice that it is possible to get results of two different John Muirs back with this query.</p><p>This is how you can obtain data out of several tables. There are nuances, such as <code class="literal">LEFT JOIN</code> and <code class="literal">RIGHT JOIN</code>, but they are beyond the scope of this book.</p></div></div>
<div class="section" title="Adding data"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec55"/>Adding data</h1></div></div></div><p>We mentioned using <code class="literal">phpMyAdmin</code> to propagate our tables. Once our application is running, we need to know <a id="id553" class="indexterm"/>how to add a date using PHP code, for instance, to add an order to the system. We will provide an example that adds a book to the books table. All the strings we use can, of course, be replaced by PHP variables. The SQL command we need here is <code class="literal">INSERT</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
$insertsql = 'INSERT INTO books  (title, author_id, price) VALUES ("My new book", "3", "38);'
$mysqli-&gt;query($insertsql);
$newestbook = $mysqli-&gt;insert_id;
?&gt;</pre></div><p>This will automatically add a row to your table, create your primary key with a value one higher than all others, insert the title, <code class="literal">author_id</code>, and insert the price into that row. All other fields will get the default value you specified while building your tables with <code class="literal">phpMyAdmin</code>.</p><p>The <code class="literal">insert_id</code> function is<a id="id554" class="indexterm"/> quite handy if you want to retrieve the value of the newly created primary <a id="id555" class="indexterm"/>key. We will use this now to change the price from <code class="literal">38</code> to <code class="literal">39</code>.</p><div class="section" title="Updating data"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec99"/>Updating data</h2></div></div></div><p>Let's assume that we want to<a id="id556" class="indexterm"/> change the price of a book or add information we did not enter when we issued the <code class="literal">INSERT</code> command to add data. This is where the <code class="literal">UPDATE</code> command is used. The syntax goes like this:</p><div class="informalexample"><pre class="programlisting">&lt;?php
$updatesql =  'UPDATE  books SET price="39" WHERE book_id='"'.$newestbook.'";';
$mysqli-&gt;query($updatesql);
?&gt;</pre></div><p>This will change the price of the book we just added from <code class="literal">38</code> to <code class="literal">39</code>.</p><p>You can find a very comprehensive online manual of all the MySQL commands on <a class="ulink" href="http://mysql.com">mysql.com</a>, <a class="ulink" href="http://php.net">php.net</a>, and many other websites; just search on Google for <code class="literal">mysql UPDATE</code> and it will be right there. This is why we are only giving you the basics in this chapter.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec56"/>Summary</h1></div></div></div><p>In this chapter, we explained how to add a database to the overall web development picture. Our database engine of choice is MySQL, as it is open source, has a PHP programming interface, and is available on all platforms. We introduced another programming language, SQL, and then explained how this fits into the MySQL/PHP picture.</p><p>To create and manage a database, including adding initial data to your tables, we talked about using <code class="literal">phpMyAdmin</code>, a great tool that we recommend adding to your workflow.</p><p>This chapter also concludes the first part of this book, which covers what I call classical web development. We walked through all the classical components, languages in particular, that people have been using to develop websites, and simple web applications: HTML, CSS, JavaScript, PHP, and MySQL.</p><p>In the second part of the book, we will take it a step further and show you how to write shorter code, use a single web page instead of millions to get the job done, and write everything in a smarter, different way so that your site or app will look great on all devices, from desktop to tablet to smartphone.</p></div></body></html>