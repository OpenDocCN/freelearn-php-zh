<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Testing and Quality Assurance"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Testing and Quality Assurance</h1></div></div></div><p>So far, we have covered all the steps required to create a Magento extension:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Magento fundamentals</li><li class="listitem" style="list-style-type: disc">Frontend development</li><li class="listitem" style="list-style-type: disc">Backend development</li><li class="listitem" style="list-style-type: disc">Extending and working with APIs</li></ul></div><p>However, we omitted a critical step in the development of any extension or custom code: testing and quality assurance. Despite the fact that Magento is a complex platform, it lacks any out-of-the-box testing.</p><p>For this reason, proper testing and quality assurance is often overlooked by most of the Magento developers, either due to a lack of information, or because of the large overhead of some of the testing tools, and while there are not many tools available for running a proper test with Magento, the ones that exist are of very high quality.</p><p>In this chapter, we will take a look at the different options available to test our Magento code, and we will also build some very basic tests for our custom extension.</p><p>So, let's go over the topics covered in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The different testing frameworks and tools available for Magento</li><li class="listitem" style="list-style-type: disc">The importance of testing our Magento code</li><li class="listitem" style="list-style-type: disc">How to set up, install, and use Ecomdev PHPUnit extension</li><li class="listitem" style="list-style-type: disc">How to set up, install, and use Magento Mink to run functional tests</li></ul></div><div class="section" title="Testing Magento"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec40"/>Testing Magento</h1></div></div></div><p>Before <a id="id379" class="indexterm"/>we start writing any test, it is important that we understand the concepts related to testing and, more particularly, to each of the available methodologies.</p><div class="section" title="Unit testing"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec55"/>Unit testing</h2></div></div></div><p>The <a id="id380" class="indexterm"/>idea behind unit testing is to write tests for certain areas (units) of our code, so that we can<a id="id381" class="indexterm"/> verify that the code works as expected and the function is returning expected values.</p><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>" In computer programming, unit testing is a method by which individual units of source code, sets of one or more computer program modules together with associated control data, usage procedures, and operating procedures, are tested to determine if they are fit for use."</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>Wikipedia</em></span></span></td></tr></table></div><p>Another advantage of writing unit tests is that by doing this, we are more likely to write code that is easier to test.</p><p>This means that our code tends to be broken down into smaller but more specialized functions. As we continue to write more and more tests, we start building a test suite that can be run against our codebase every time we introduce any changes or functionalities; this is known as <a id="id382" class="indexterm"/>
<span class="strong"><strong>regression testing</strong></span>.</p></div><div class="section" title="Regression testing"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec56"/>Regression testing</h2></div></div></div><p>Regression testing <a id="id383" class="indexterm"/>mostly refers to the practice of rerunning existing test suites after making code changes to verify that a new functionality is not introducing new bugs.</p><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"Regression testing is a type of software testing that seeks to uncover new software bugs, or regressions, in existing functional and non-functional areas of a system after changes, such as enhancements, patches or configuration changes, have been made to them."</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>Wikipedia</em></span></span></td></tr></table></div><p>In the particular case of a Magento store or any e-commerce site, we want to perform regression testing on critical features of the store, such as checkout, customer registration, adding to the cart, and so on.</p></div><div class="section" title="Functional testing"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec57"/>Functional testing</h2></div></div></div><p>Functional testing <a id="id384" class="indexterm"/>is more concerned with testing<a id="id385" class="indexterm"/> and verifying that the application returns the appropriated output based on a specific input rather than what happens internally.</p><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"Functional testing is a type of black box testing that bases its test cases on the specifications of the software component under test. Functions are tested by feeding them input and examining the output, and internal program structure is rarely considered."</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>Wikipedia</em></span></span></td></tr></table></div><p>This is especially important for e-commerce websites like ours, where we want to test the site as the<a id="id386" class="indexterm"/> customer would experience it.</p></div><div class="section" title="Test-driven development"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec58"/>Test-driven development</h2></div></div></div><p>A testing <a id="id387" class="indexterm"/>methodology that has gained popularity in <a id="id388" class="indexterm"/>recent years and is now coming to Magento is known as <span class="strong"><strong>TDD</strong></span> or <span class="strong"><strong>test-driven development</strong></span>.</p><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"Test-driven development (TDD) is a software development process that relies on the repetition of a very short development cycle: first the developer writes an (initially failing) automated test case that defines a desired improvement or new function, then produces the minimum amount of code to pass that test and finally refactors the new code to acceptable standards."</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>Wikipedia</em></span></span></td></tr></table></div><p>The basic concept behind TDD is to first write a failing test, and then write only enough code to pass the test; this generates very short development cycles and helps streamline the code.</p><p>A more complete approach is often referred to as the <a id="id389" class="indexterm"/>
<span class="strong"><strong>red-green-refactor cycle</strong></span>. The idea behind it is as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Red</strong></span>: This writes a small amount of test code—often, no more than a few lines</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Green</strong></span>: This writes a small amount of production code—only enough code to make sure the test passes</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Refactor</strong></span>: This cleans up the mess and improves the code. Now that we have a working test, we can make changes with confidence.</li></ul></div><p>An illustration of the red-green-refactor cycle is as follows:</p><div class="mediaobject"><img src="graphics/4195OS_06_01.jpg" alt="Test-driven development"/></div><p>Ideally, you want to start the development of your modules and extensions using TDD in Magento. We omitted this in previous chapters due the fact that it would add unnecessary complexity and confuse the reader.</p><p>For a complete tutorial on TDD with Magento from scratch, refer to <a class="ulink" href="http://magedevguide.com/getting-started-with-tdd">http://magedevguide.com/getting-started-with-tdd</a>.</p></div></div></div>
<div class="section" title="Tools and testing frameworks"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec41"/>Tools and testing frameworks</h1></div></div></div><p>As mentioned previously, there are several frameworks and tools available to test PHP and Magento code:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Ecomdev_PHPUnit</code>: This <a id="id390" class="indexterm"/>extension is just amazing. The developers at Ecomdev created an extension that integrates PHPUnit with Magento and also adds Magento-specific assertions to PHPUnit without having to modify core files or affect the database.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Magento_Mink</code>: Mink<a id="id391" class="indexterm"/> is a PHP library for the Behat framework that allows you to write functional and acceptance tests; Mink also allows you to write tests that simulate user behavior and browser interaction.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Magento_TAF</code>: This<a id="id392" class="indexterm"/> stands for <span class="strong"><strong>Magento Test Automation Framework</strong></span> and is the<a id="id393" class="indexterm"/> official testing tool provided by Magento. It includes over 1,000 functional tests and is very powerful. Unfortunately, it has a major drawback; it has a large overhead and a steep learning curve.</li></ul></div><div class="section" title="Unit testing with PHPUnit"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec59"/>Unit testing with PHPUnit</h2></div></div></div><p>Before<a id="id394" class="indexterm"/> <code class="literal">Ecomdev_PHPUnit</code>, testing Magento with PHPUnit was problematic and really not very practical. Out of the different methods that were available, almost all required core code modifications or made developers jump through hoops to set up basic PHPUnits.</p><div class="section" title="Installing Ecomdev_PHPUnit"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec03"/>Installing Ecomdev_PHPUnit</h3></div></div></div><p>The <a id="id395" class="indexterm"/>easiest way to install <code class="literal">Ecomdev_PHPUnit</code> is to grab a copy directly from the GitHub repository. Let's write the following command on our console:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>git clone git://github.com/IvanChepurnyi/EcomDev_PHPUnit.git</strong></span>
</pre></div><p>Now, copy the file to your Magento root folder.</p><p>Composer and Modman are alternative options available for installation; for more information on each, refer to <a class="ulink" href="http://magedevguide.com/module-managers">http://magedevguide.com/module-managers</a>.</p><p>Finally, we need to set the configuration to instruct the PHPUnit extension which database is to be used; <code class="literal">local.xml.phpunit</code> is a new file added by <code class="literal">Ecomdev_PHPUnit</code>, and it holds all the extension-specific configurations and specifies the name of the test database.</p><p>The file location is <code class="literal">app/etc/local.xml.phpunit</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;config&gt;
    &lt;global&gt;
        &lt;resources&gt;
            &lt;default_setup&gt;
                &lt;connection&gt;
                   &lt;dbname&gt;&lt;![CDATA[magento_unit_tests]]&gt;&lt;/dbname&gt;
                &lt;/connection&gt;
            &lt;/default_setup&gt;
        &lt;/resources&gt;
    &lt;/global&gt;
    &lt;default&gt;
        &lt;web&gt;
            &lt;seo&gt;
                &lt;use_rewrites&gt;1&lt;/use_rewrites&gt;
            &lt;/seo&gt;
            &lt;secure&gt;
                &lt;base_url&gt;[change me]&lt;/base_url&gt;
            &lt;/secure&gt;
            &lt;unsecure&gt;
                &lt;base_url&gt;[change me]&lt;/base_url&gt;
            &lt;/unsecure&gt;
            &lt;url&gt;
                &lt;redirect_to_base&gt;0&lt;/redirect_to_base&gt;
            &lt;/url&gt;
        &lt;/web&gt;
    &lt;/default&gt;
    &lt;phpunit&gt;
        &lt;allow_same_db&gt;0&lt;/allow_same_db&gt;
    &lt;/phpunit&gt;
&lt;/config&gt;</pre></div><p>You will <a id="id396" class="indexterm"/>need to create a new database to run tests, and replace the example configuration values in the <code class="literal">local.xml.phpunit</code> file.</p><p>By default, this extension does not allow you to run the test on the same database. Keeping the test database separate from the development and production allows us to run our test with confidence.</p></div><div class="section" title="Setting up the configuration for our extension"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec04"/>Setting up the configuration for our extension</h3></div></div></div><p>Now<a id="id397" class="indexterm"/> that we have the PHPUnit extension installed and set up, we need to prepare our gift registry extension to run unit tests. This can be done by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">Giftregistry</code> extension of the <code class="literal">config.xml</code> file.</li><li class="listitem">Add the following code to this file located at <code class="literal">app/code/local/Mdg/Giftregistry/etc/config.xml</code>:<div class="informalexample"><pre class="programlisting">…
&lt;phpunit&gt;
        &lt;suite&gt;
            &lt;modules&gt;
                    &lt;Mdg_Giftregistry/&gt;
            &lt;/modules&gt;
         &lt;/suite&gt;
&lt;/phpunit&gt;
…</pre></div></li></ol></div><p>This new configuration node allows the PHPUnit extension to recognize the extension and run the matching tests.</p><p>We also<a id="id398" class="indexterm"/> need to create a new directory called <code class="literal">Test</code> alongside the module directory that we will use to place all our test files. One of the advantages of using <code class="literal">Ecomdev_PHPUnit</code> as compared to previous methods is that this extension follows the Magento standards.</p><p>This means that we have to keep the same module directory structure inside the <code class="literal">Test</code> folder:</p><div class="informalexample"><pre class="programlisting">Test/
Model/
Block/
Helper/
Controller/
Config/</pre></div><p>Based on the naming convention for each test case, the class would be named as follows:</p><div class="informalexample"><pre class="programlisting">[Namespace]_[Module Name]_Test_[Group Directory]_[Entity Name]</pre></div><p>Each test class must extend one of the following three base test classes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">EcomDev_PHPUnit_Test_Case</code>: This is used to test helpers, models, and blocks</li><li class="listitem" style="list-style-type: disc"><code class="literal">EcomDev_PHPUnit_Test_Case_Config</code>: This is used to test the module configuration</li><li class="listitem" style="list-style-type: disc"><code class="literal">EcomDev_PHPUnit_Test_Case_Controller</code>: This is used to test the layout rendering process and the controller logic</li></ul></div><p>A reference is available at <a class="ulink" href="http://www.ecomdev.org/wp-content/uploads/2011/05/EcomDev_PHPUnit-0.2.0-Manual.pdf">http://www.ecomdev.org/wp-content/uploads/2011/05/EcomDev_PHPUnit-0.2.0-Manual.pdf</a>.</p></div><div class="section" title="The anatomy of a test case"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec05"/>The anatomy of a test case</h3></div></div></div><p>Before<a id="id399" class="indexterm"/> jumping ahead and trying to create our first test, let's break down one of the examples provided by <code class="literal">Ecomdev_PHPUnit</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class EcomDev_Example_Test_Model_Product extends EcomDev_PHPUnit_Test_Case
{
    /**
     * Product price calculation test
     *
     * @test
     * @loadFixture
     * @doNotIndexAll
     * @dataProvider dataProvider
     */
    public function priceCalculation($productId, $storeId)
    {
        $storeId = Mage::app()-&gt;getStore($storeId)-&gt;getId();
        $product = Mage::getModel('catalog/product')
            -&gt;setStoreId($storeId)
            -&gt;load($productId);
        $expected = $this-&gt;expected('%s-%s', $productId, $storeId);
        $this-&gt;assertEquals(
            $expected-&gt;getFinalPrice(),
            $product-&gt;getFinalPrice()
        );
        $this-&gt;assertEquals(
            $expected-&gt;getPrice(),
            $product-&gt;getPrice()
        );
    }
}</pre></div><p>The first<a id="id400" class="indexterm"/> important thing to notice in the example test class is the comment annotations:</p><div class="informalexample"><pre class="programlisting">…
/**
     * Product price calculation test
     *
     * @test
     * @loadFixture
     * @doNotIndexAll
     * @dataProvider dataProvider
     */
…</pre></div><p>These annotations are used by the PHPUnit extension to identify which class functions are tests, and also allow us to set up specific settings to run each test. Let's take a look at some of the available annotations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">@test</code>: This<a id="id401" class="indexterm"/> identifies a class function as a PHPUnit test</li><li class="listitem" style="list-style-type: disc"><code class="literal">@loadFixture</code>: This<a id="id402" class="indexterm"/> specifies the use of fixtures</li><li class="listitem" style="list-style-type: disc"><code class="literal">@loadExpectation</code>: This <a id="id403" class="indexterm"/>specifies the use of expectations</li><li class="listitem" style="list-style-type: disc"><code class="literal">@doNotIndexAll</code>: By adding<a id="id404" class="indexterm"/> this annotation, we are telling PHPUnit test that it should not run any index after loading the fixtures</li><li class="listitem" style="list-style-type: disc"><code class="literal">@doNotIndex [index_code]</code>: By adding <a id="id405" class="indexterm"/>this annotation, we can instruct PHPUnit not to run a specific index</li></ul></div><p>So now, you <a id="id406" class="indexterm"/>are probably a bit confused. Fixtures? Expectations? What are these?</p><p>
<span class="strong"><strong>Fixtures</strong></span> are <span class="strong"><strong>Yet Another Markup Language</strong></span> (<span class="strong"><strong>YAML</strong></span>) files<a id="id407" class="indexterm"/> that represent databases or configuration entities.</p><p>
<span class="strong"><strong>Expectations</strong></span><a id="id408" class="indexterm"/> are useful if we don't want to have hardcoded values in our tests and are also specified in YAML values.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note32"/>Note</h3><p>For more information about the <a id="id409" class="indexterm"/>YAML markup, refer to <a class="ulink" href="http://magedevguide.com/yaml">http://magedevguide.com/yaml</a>.</p></div></div><p>So, as we can see, fixtures provide the data for to be processed by the tests, and expectations are used to check whether the results returned by the test are what we are expecting to see.</p><p>Fixtures and expectations are stored inside each <code class="literal">Test</code> type directory. By following the preceding example, we would have a new directory called <code class="literal">Product/</code>. Inside it, we need a new directory for expectations and one for our fixtures.</p><p>Let's take a look at the revised folder structure:</p><div class="informalexample"><pre class="programlisting">Test/
Model/    
    Product.php
    Product/
        expectations/
        fixtures/
Block/
Helper/
Controller/
Config/</pre></div><p>The following illustration demonstrates the use of fixtures, expectations, and test cases:</p><div class="mediaobject"><img src="graphics/4195OS_06_02.jpg" alt="The anatomy of a test case"/></div></div><div class="section" title="Creating a unit test"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec06"/>Creating a unit test</h3></div></div></div><p>For <a id="id410" class="indexterm"/>our first unit test, let's create a very basic test that allows us to test the gift registry models that we previously created.</p><p>As we mentioned earlier, <code class="literal">Ecomdev_PHPUnit</code> uses a separate database to run all the tests. For this, we need to create a new fixture that will provide all the data for our test case:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">Test/Model</code> folder.</li><li class="listitem">Create a new folder called <code class="literal">Registry</code>.</li><li class="listitem">Inside the <code class="literal">Registry</code> folder, create a new folder called <code class="literal">fixtures</code>.</li><li class="listitem">Create a new file called <code class="literal">registryList.yaml</code> at <code class="literal">app/code/local/Mdg/Giftregistry/Test/Model/fixtures/registryList.yaml</code> and paste the following code in it:<div class="informalexample"><pre class="programlisting">scope:
  website: # Initialize websites
    - website_id: 2
      code: default
      name: Test Website
      default_group_id: 2
  group: # Initializes store groups
    - group_id: 2
      website_id: 2
      name: Test Store Group
      default_store_id: 2
      root_category_id: 2 # Default Category
  store: # Initializes store views
    - store_id: 2
      website_id: 2
      group_id: 2
      code: default
      name: Default Test Store
      is_active: 1
eav:
   customer_customer:
     - entity_id: 1
       entity_type_id: 3
       website_id: 2
       email: test@magentotest.com
       group_id: 2
       store_id: 2
       is_active: 1
   mdg_giftregistry_entity:
     - entity_id: 1
       customer_id: 1
       type_id: 2
       website_id: 2
       event_date: 12/12/2012
       event_country: Canada
       event_location: Dundas Square
       created_at: 21/12/2012
     - entity_id: 2
       customer_id: 1
       type_id: 3
       website_id: 2
       event_date: 01/01/2013
       event_country: Canada
       event_location: Eaton Center
       created_at: 21/12/2012</pre></div></li></ol></div><p>This<a id="id411" class="indexterm"/> might not look like it, but we are adding a lot of information with this fixture, and are creating the following fixture data:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A website scope</li><li class="listitem" style="list-style-type: disc">A store group</li><li class="listitem" style="list-style-type: disc">A store view</li><li class="listitem" style="list-style-type: disc">A customer record</li><li class="listitem" style="list-style-type: disc">Two gift registries</li></ul></div><p>Using fixtures, we are creating data on the fly that will be available for our test case. This gives us the consistency to run the test multiple times against the same data and the flexibility to easily change it.</p><p>Now, you <a id="id412" class="indexterm"/>might be wondering how the PHPUnit extension knows how to pair a test case with a specific fixture.</p><p>There are two ways in which the extension loads fixtures: one is by specifying the fixture inside the comment annotations, and if the fixture name is not specified, the extension searches a fixture with the same name as the test case function being executed.</p><p>With this knowledge, let's create our first test case:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">Test/Model</code> folder.</li><li class="listitem">Create a new test class called <code class="literal">Registry.php</code>.</li><li class="listitem">Add the following base code to this file located at <code class="literal">app/code/local/Mdg/Giftregistry/Test/Model/Registry.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Test_Model_Registry extends EcomDev_PHPUnit_Test_Case
{
    /**
     * Listing available registries
     *
     * @test
     * @loadFixture
     * @doNotIndexAll
     * @dataProvider dataProvider
     */
    public function registryList()
    {

    }
}</pre></div></li></ol></div><p>We just created the base function, but we have not added any logic yet. Before we do that, let's take a look at what actually constitutes a test case.</p><p>Test cases work using assertions to evaluate and test our code. Assertions are special functions that our test cases inherit from the parent <code class="literal">TestCase</code> class. Among the default assertions available, we have:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">assertEquals()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertGreaterThan()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertGreaterThanOrEqual()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertLessThan()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertLessThanOrEqual()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertTrue()</code></li></ul></div><p>Now, these <a id="id413" class="indexterm"/>default assertions are great if we want to check variables' values, search for an array key, check attributes, and so on. However, testing Magento code using only this type of assertions can prove difficult or even impossible. This is where <code class="literal">Ecomdev_PHPUnit</code> comes to the rescue.</p><p>Not only has this extension integrated PHPUnit with Magento cleanly and by following their standards, but it also adds Magento-specific assertions to the PHPUnit tests. Let's take a look at some of the assertions added by the extension:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">assertEventDispatched()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertBlockAlias()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertModelAlias()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertHelperAlias()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertModuleCodePool()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertModuleDepends()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertConfigNodeValue()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertLayoutFileExists()</code></li></ul></div><p>These are only a few of the assertions available, and as you can see, they give a lot of power to build comprehensive tests.</p><p>Now that we know a little more about how PHPUnit test cases work, let's proceed to create our first Magento <code class="literal">TestCase</code> class:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">Registry.php</code> test case class that we created earlier.</li><li class="listitem">Add the following code to the <code class="literal">registryList()</code> function.<p>The file location is <code class="literal">app/code/local/Mdg/Giftregistry/Test/Model/Registry.php</code>:</p><div class="informalexample"><pre class="programlisting">    /**
     * Listing available registries
     *
     * @test
     * @loadFixture
     * @doNotIndexAll
     * @dataProvider dataProvider
     */
    public function registryList()
    {
        $registryList = Mage::getModel('mdg_giftregistry/entity')-&gt;getCollection();
        $this-&gt;assertEquals(
            2,
            $registryList-&gt;count()
        );
    }</pre></div></li></ol></div><p>This is a <a id="id414" class="indexterm"/>very basic test; the only thing that we are doing is loading a registry collection—in this case, all the registries available—and then running an assertion to check whether the collection count matches.</p><p>However, this is not very useful. It would be even better if we were able to load only the registries that belong to a specific user (our test user) and check the collection size. That said, let's change the code a little bit in the file located at <code class="literal">app/code/local/Mdg/Giftregistry/Test/Model/Registry.php</code>:</p><div class="informalexample"><pre class="programlisting">    /**
     * Listing available registries
     *
     * @test
     * @loadFixture
     * @doNotIndexAll
     * @dataProvider dataProvider
     */
    public function registryList()
    {
        $customerId = 1;
        $registryList = Mage::getModel('mdg_giftregistry/entity')
-&gt;getCollection()
-&gt;addFieldToFilter('customer_id', $customerId);
        $this-&gt;assertEquals(
            2,
            $registryList-&gt;count()
        );
    }</pre></div><p>Just by changing a few lines of code, we created a test that allows us to verify that our registry collections are working properly, and are correctly linked to a customer record.</p><p>Run the following command in your shell:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ phpunit</strong></span>
</pre></div><p>If everything went as expected, we should see the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>PHPUnit 3.4 by Sebastian Bergmann</strong></span>
<span class="strong"><strong>.</strong></span>
<span class="strong"><strong>Time: 1 second</strong></span>
<span class="strong"><strong>Tests: 1, Assertions: 1, Failures 0</strong></span>
</pre></div><p>You can also run <code class="literal">$ phpunit –colors</code> for a nicer output.</p><p>Now, we <a id="id415" class="indexterm"/>only need a test to verify that the registry items are working properly:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">Registry.php</code> test case class that we created earlier.</li><li class="listitem">Add the following code to the <code class="literal">registryItemsList()</code> function to the Registry.php file located at <code class="literal">app/code/local/Mdg/Giftregistry/Test/Model/Registry.php</code>:<div class="informalexample"><pre class="programlisting">    /**
     * Listing available items for a specific registry
     *
     * @test
     * @loadFixture
     * @doNotIndexAll
     * @dataProvider dataProvider
     */
    public function registryItemsList()
    {
        $customerId = 1;
        $registry   = Mage::getModel('mdg_giftregistry/entity')
-&gt;loadByCustomerId($customerId);

        $registryItems = $registry-&gt;getItems();
        $this-&gt;assertEquals(
            3,
            $registryItems-&gt;count()
        );
    }</pre></div></li></ol></div><p>We will also need a new fixture for our new test case:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">Test/Model</code> folder.</li><li class="listitem">Open the <code class="literal">Registry</code> folder.</li><li class="listitem">Create a <a id="id416" class="indexterm"/>new file called <code class="literal">registryItemsList.yaml</code> located at <code class="literal">app/code/local/Mdg/Giftregistry/Test/Model/fixtures/ registryItemsList.yaml</code>:<div class="informalexample"><pre class="programlisting">scope:
  website: # Initialize websites
    - website_id: 2
      code: default
      name: Test Website
      default_group_id: 2
  group: # Initializes store groups
    - group_id: 2
      website_id: 2
      name: Test Store Group
      default_store_id: 2
      root_category_id: 2 # Default Category
  store: # Initializes store views
    - store_id: 2
      website_id: 2
      group_id: 2
      code: default
      name: Default Test Store
      is_active: 1
eav:
   customer_customer:
     - entity_id: 1
       entity_type_id: 3
       website_id: 2
       email: test@magentotest.com
       group_id: 2
       store_id: 2
       is_active: 1
   mdg_giftregistry_entity:
     - entity_id: 1
       customer_id: 1
       type_id: 2
       website_id: 2
       event_date: 12/12/2012
       event_country: Canada
       event_location: Dundas Square
       created_at: 21/12/2012
   mdg_giftregistry_item:
     - item_id: 1
       registry_id: 1
       product_id: 1
     - item_id: 2
       registry_id: 1
       product_id: 2
     - item_id: 3
       registry_id: 1
       product_id: 3 </pre></div></li></ol></div><p>Let's run our test suite:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$phpunit --colors</strong></span>
</pre></div><p>We should see both tests pass:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>PHPUnit 3.4 by Sebastian Bergmann</strong></span>
<span class="strong"><strong>.</strong></span>
<span class="strong"><strong>Time: 4 second</strong></span>
<span class="strong"><strong>Tests: 2, Assertions: 2, Failures 0</strong></span>
</pre></div><p>Finally, let's <a id="id417" class="indexterm"/>replace our hardcoded variables with proper expectations.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the module <code class="literal">Test/Model</code> folder.</li><li class="listitem">Open the <code class="literal">Registry</code> folder.</li><li class="listitem">Inside the <code class="literal">Registry</code> folder, create a new folder called <code class="literal">expectations</code>.</li><li class="listitem">Create a new file called <code class="literal">registryList.yaml</code> at <code class="literal">app/code/local/Mdg/Giftregistry/Test/Model/expectations/registryList.yaml</code>:<div class="informalexample"><pre class="programlisting">count: 2</pre></div></li></ol></div><p>Wasn't that easy? Well, it was so easy that we will do it again for the <code class="literal">registryItemsList</code> test case:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the module <code class="literal">Test/Model</code> folder.</li><li class="listitem">Open the <code class="literal">Registry</code> folder.</li><li class="listitem">Create a new file called <code class="literal">registryItemsList.yaml</code> inside the <code class="literal">expectations</code> folder.<p>The file location is <code class="literal">app/code/local/Mdg/Giftregistry/Test/Model/expectations/registryItemsList.yaml</code>:</p><div class="informalexample"><pre class="programlisting">count: 3</pre></div></li></ol></div><p>Finally, the last thing that we need to do is update our test case class to use the expectations. Make <a id="id418" class="indexterm"/>sure that the update file located at <code class="literal">app/code/local/Mdg/Giftregistry/Test/Model/Registry.php</code> has the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Test_Model_Registry extends EcomDev_PHPUnit_Test_Case
{
    /**
     * Product price calculation test
     *
     * @test
     * @loadFixture
     * @doNotIndexAll
     * @dataProvider dataProvider
     */
    public function registryList()
    {
        $customerId = 1;
        $registryList = Mage::getModel('mdg_giftregistry/entity')
                -&gt;getCollection()
                -&gt;addFieldToFilter('customer_id', $customerId);
        $this-&gt;assertEquals(
            $this-&gt;_getExpectations()-&gt;getCount(),$this-&gt;_getExpectations()-&gt;getCount(),
            $registryList-&gt;count()
        );
    }
    /**
     * Listing available items for a specific registry
     *
     * @test
     * @loadFixture
     * @doNotIndexAll
     * @dataProvider dataProvider
     */
    public function registryItemsList()
    {
        $customerId = 1;
        $registry   = Mage::getModel('mdg_giftregistry/entity')- &gt;loadByCustomerId($customerId);

        $registryItems = $registry-&gt;getItems();
        $this-&gt;assertEquals(
            $this-&gt;_getExpectations()-&gt;getCount(),
            $registryItems-&gt;count()
        );
    }
}</pre></div><p>The only<a id="id419" class="indexterm"/> change here is that we are replacing the hardcoded value inside our assertions with the expectations values. If we ever need to make any changes, we don't need to change our code; we can just update the expectations and fixtures.</p></div></div><div class="section" title="Functional testing with Mink"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec60"/>Functional testing with Mink</h2></div></div></div><p>So far, we <a id="id420" class="indexterm"/>have learned how to run unit tests against our code. While unit tests are great to test individual parts of our code and the logic, when it comes to large applications such as Magento, it is important to test from the user perspective.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note33"/>Note</h3><p>Functional testing mostly involves black box testing, and is not concerned about the source code of the application.</p></div></div><p>In order to perform functional testing, we can<a id="id421" class="indexterm"/> use <span class="strong"><strong>Mink</strong></span>. Mink is a simple PHP library that can virtualize a web browser. Mink works using different drivers; it supports the following drivers out of the box:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">GoutteDriver</code>: Goutte<a id="id422" class="indexterm"/> is a pure-php headless browser, written by the creator of the Symfony framework</li><li class="listitem" style="list-style-type: disc"><code class="literal">SahiDriver</code>: Sahi <a id="id423" class="indexterm"/>is a new JS browser controller that is quickly replacing Selenium</li><li class="listitem" style="list-style-type: disc"><code class="literal">ZombieDriver</code>: This <a id="id424" class="indexterm"/>is a browser emulator written in Node.js, and is currently limited to only one browser (Chromium)</li><li class="listitem" style="list-style-type: disc"><code class="literal">SeleniumDriver</code>: This <a id="id425" class="indexterm"/>is currently the most popular browser driver; the original version relies on a third-party server to run the tests</li><li class="listitem" style="list-style-type: disc"><code class="literal">Selenium2Driver</code>: The<a id="id426" class="indexterm"/> current version of Selenium is fully supported in Python, Ruby, Java, and C#</li></ul></div><div class="section" title="Magento Mink installation and setup"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec07"/>Magento Mink installation and setup</h3></div></div></div><p>Using Mink with <a id="id427" class="indexterm"/>Magento is extremely easy, thanks to Johann Reinke, who created a Magento extension that facilitates Mink's integration with Magento.</p><p>We will install this extension using <code class="literal">modgit</code>, a module manager inspired by Modman. Modgit allow us to deploy Magento extensions directly from a GitHub repository without creating symlinks.</p><p>Installing modgit can be achieved with three lines of commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>wget -O modgit https://raw.github.com/jreinke/modgit/master/modgit</strong></span>
<span class="strong"><strong>chmod +x modgit</strong></span>
<span class="strong"><strong>sudo mv modgit /usr/local/bin</strong></span>
</pre></div><p>Wasn't that easy? Now, we can proceed to install Magento Mink, which is even easier thanks to modgit:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the Magento root directory.</li><li class="listitem">Run the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>modgit init</strong></span>
<span class="strong"><strong>modgit -e README.md clone mink https://github.com/jreinke/magento-mink.git</strong></span>
</pre></div></li></ol></div><p>That's it; modgit will take care of installing the file for us directly from the GitHub repository.</p></div></div></div>
<div class="section" title="Creating our first test"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec42"/>Creating our first test</h1></div></div></div><p>Mink tests <a id="id428" class="indexterm"/>are also stored in the <code class="literal">Test</code> folder; let's create the base skeleton of our Mink test class:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">Test</code> folder in our module root.</li><li class="listitem">Create a new directory called <code class="literal">Mink</code>.</li><li class="listitem">Inside the <code class="literal">Mink</code> directory, create a new PHP class called <code class="literal">Registry.php</code>.</li><li class="listitem">Copy the following code at the <code class="literal">Registry.php</code> file, located at <code class="literal">app/code/local/Mdg/Giftregistry/Test/Mink/Registry.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php
class Mdg_Giftregistry_Test_Mink_Registry extends JR_Mink_Test_Mink 
{   
    public function testAddProductToRegistry()
    {
        $this-&gt;section('TEST ADD PRODUCT TO REGISTRY');
        $this-&gt;setCurrentStore('default');
        $this-&gt;setDriver('goutte');
        $this-&gt;context();
 
        // Go to homepage
        $this-&gt;output($this-&gt;bold('Go To the Homepage'));
        $url = Mage::getStoreConfig('web/unsecure/base_url');
        $this-&gt;visit($url);
        $category = $this-&gt;find('css', '#nav .nav-1-1 a');
        if (!$category) {
            return false;
        }

        // Go to the Login page
        $loginUrl = $this-&gt;find('css', 'ul.links li.last a');
        if ($loginUrl) {
            $this-&gt;visit($loginUrl-&gt;getAttribute('href'));
        }
 
        $login = $this-&gt;find('css', '#email');
        $pwd = $this-&gt;find('css', '#pass');
        $submit = $this-&gt;find('css', '#send2');

        if ($login &amp;&amp; $pwd &amp;&amp; $submit) {
            $email = 'user@example.com';
            $password = 'password';
            $this-&gt;output(sprintf("Try to authenticate '%s' with password '%s'", $email, $password));
            $login-&gt;setValue($email);
            $pwd-&gt;setValue($password);
            $submit-&gt;click();
            $this-&gt;attempt(
                $this-&gt;find('css', 'div.welcome-msg'),
                'Customer successfully logged in',
                'Error authenticating customer'
            );
        }
 
        // Go to the category page
        $this-&gt;output($this-&gt;bold('Go to the category list'));
        $this-&gt;visit($category-&gt;getAttribute('href'));
        $product = $this-&gt;find('css', '.category-products li.first a');
        if (!$product) {
            return false;
        }
 
        // Go to product view
        $this-&gt;output($this-&gt;bold('Go to product view'));
        $this-&gt;visit($product-&gt;getAttribute('href'));
        $form = $this-&gt;find('css', '#product_registry_form');
        if ($form) {
            $addToCartUrl = $form-&gt;getAttribute('action');
            $this-&gt;visit($addToCartUrl);
            $this-&gt;attempt(
                $this-&gt;find('css', '#btn-add-giftregistry'),
                'Product added to gift registry successfully',
                'Error adding product to gift registry'
            );
        }
    }
}</pre></div></li></ol></div><p>Just at first glance, you<a id="id429" class="indexterm"/> can tell that this functional test is quite different from the unit tests that we built previously. Although it seems like a lot of code it is quite simple, the previous test is even broken down in code blocks. Let's break down what the previous test is doing:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Set up the browser driver and the current store.</li><li class="listitem">Go to the home page and check for a valid category link.</li><li class="listitem">Try to log in as a test user.</li><li class="listitem">Go to a <code class="literal">category</code> page.</li><li class="listitem">Open the first product in that category.</li><li class="listitem">Try to add the product to the customer gift registry.</li></ol></div><p>This test makes a few assumptions and expects a valid customer with an existing gift registry.</p><p>There are some considerations that we have to keep in mind when creating Mink tests:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Each test class must extend <code class="literal">JR_Mink_Test_Mink</code></li><li class="listitem" style="list-style-type: disc">Each test function must start with the <code class="literal">test</code> keyword</li></ul></div><p>Finally, the<a id="id430" class="indexterm"/> only thing that we have to do is run our tests. We can do this by going to the command line and running the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php shell/mink.php</strong></span>
</pre></div><p>If everything was successful, we should see a something similar to the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>---------------------- SCRIPT START ---------------------------------</strong></span>
<span class="strong"><strong>Found 1 file</strong></span>
<span class="strong"><strong>-------------- TEST ADD PRODUCT TO REGISTRY -------------------------</strong></span>
<span class="strong"><strong>Switching to store 'default'</strong></span>
<span class="strong"><strong>Now using Goutte driver</strong></span>
<span class="strong"><strong>----------------------------------- CONTEXT ------------------------------------</strong></span>
<span class="strong"><strong>website: base, store: default</strong></span>
<span class="strong"><strong>Cache info:</strong></span>
<span class="strong"><strong>config            Disabled  N/A       Configuration</strong></span>
<span class="strong"><strong>layout            Disabled  N/A       Layouts</strong></span>
<span class="strong"><strong>block_html        Disabled  N/A       Blocks HTML output</strong></span>
<span class="strong"><strong>translate         Disabled  N/A       Translations</strong></span>
<span class="strong"><strong>collections       Disabled  N/A       Collections Data</strong></span>
<span class="strong"><strong>eav               Disabled  N/A       EAV types and attributes</strong></span>
<span class="strong"><strong>config_api        Disabled  N/A       Web Services Configuration</strong></span>
<span class="strong"><strong>config_api2       Disabled  N/A       Web Services Configuration</strong></span>
<span class="strong"><strong>ecomdev_phpunit   Disabled  N/A       Unit Test Cases</strong></span>

<span class="strong"><strong>Go To the Homepage [OK]</strong></span>
<span class="strong"><strong>Try to authenticate user@example.com with password password [OK]</strong></span>
<span class="strong"><strong>Go to the category list [OK]</strong></span>
<span class="strong"><strong>Go to product view [OK]</strong></span>
<span class="strong"><strong>Product added to gift registry successfully</strong></span>
</pre></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec43"/>Summary</h1></div></div></div><p>In this chapter, we went over the basics of Magento testing. The purpose of this chapter was not to build complex tests or dive too deep, but get our feet wet and get a clear idea of what we can do to test our extensions.</p><p>We covered several important topics in this chapter and learned that having proper test suites and tools can save us from future headaches and improve the quality of our code.</p></div></body></html>