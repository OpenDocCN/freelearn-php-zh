<html><head></head><body>
<div id="_idContainer060">
<h1 class="chapter-number" id="_idParaDest-262"><a id="_idTextAnchor291"/><span class="koboSpan" id="kobo.1.1">9</span></h1>
<h1 id="_idParaDest-263"><a id="_idTextAnchor292"/><span class="koboSpan" id="kobo.2.1">Creating Custom Entity Types</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In </span><a href="B18548_06.xhtml#_idTextAnchor217"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.4.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.5.1">, </span><em class="italic"><span class="koboSpan" id="kobo.6.1">Accessing and Working with Entities</span></em><span class="koboSpan" id="kobo.7.1">, we explored manipulating individual entities. </span><span class="koboSpan" id="kobo.7.2">This chapter covers creating custom entity types for custom data models. </span><strong class="bold"><span class="koboSpan" id="kobo.8.1">Entities</span></strong><span class="koboSpan" id="kobo.9.1"> in Drupal are made up of different entity types. </span><strong class="bold"><span class="koboSpan" id="kobo.10.1">Entity types</span></strong><span class="koboSpan" id="kobo.11.1"> are defined as annotated plugins. </span><span class="koboSpan" id="kobo.11.2">Each entity is an instance of its entity type class. </span><span class="koboSpan" id="kobo.11.3">Entity types can also be enhanced to have different classes based on their bundle. </span><span class="koboSpan" id="kobo.11.4">You will learn how to implement your own custom entity in </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.13.1">In this chapter, we will go through the </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.15.1">Using custom classes for </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">entity bundles</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">Creating a configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">entity type</span></span></li>
<li><span class="koboSpan" id="kobo.19.1">Creating a content </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">entity type</span></span></li>
<li><span class="koboSpan" id="kobo.21.1">Creating a bundle for a content </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">entity type</span></span></li>
<li><span class="koboSpan" id="kobo.23.1">Implementing access control for </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">an entity</span></span></li>
<li><span class="koboSpan" id="kobo.25.1">Providing a custom </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">storage handler</span></span></li>
</ul>
<h1 id="_idParaDest-264"><a id="_idTextAnchor293"/><span class="koboSpan" id="kobo.27.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.28.1">This chapter will require a custom module that is not installed. </span><span class="koboSpan" id="kobo.28.2">Drupal will not register a new entity type or update entity types automatically for already-installed modules. </span><span class="koboSpan" id="kobo.28.3">The </span><em class="italic"><span class="koboSpan" id="kobo.29.1">There’s more…</span></em><span class="koboSpan" id="kobo.30.1"> section of the recipes will explain how to install or update entity types for </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">already-installed modules.</span></span></p>
<p><span class="koboSpan" id="kobo.32.1">In the following recipes, the module name is </span><strong class="source-inline"><span class="koboSpan" id="kobo.33.1">mymodule</span></strong><span class="koboSpan" id="kobo.34.1">. </span><span class="koboSpan" id="kobo.34.2">Replace instances of </span><strong class="source-inline"><span class="koboSpan" id="kobo.35.1">mymodule</span></strong><span class="koboSpan" id="kobo.36.1"> with your module name as appropriate in your code. </span><span class="koboSpan" id="kobo.36.2">You can find the full code used in this chapter on </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">GitHub: </span></span><a href="https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp09"><span class="No-Break"><span class="koboSpan" id="kobo.38.1">https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp09</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.39.1">.</span></span></p>
<h1 id="_idParaDest-265"><a id="_idTextAnchor294"/><span class="koboSpan" id="kobo.40.1">Using custom classes for entity bundles</span></h1>
<p><span class="koboSpan" id="kobo.41.1">Each entity is </span><a id="_idIndexMarker495"/><span class="koboSpan" id="kobo.42.1">instantiated with its entity type class. </span><span class="koboSpan" id="kobo.42.2">A </span><strong class="bold"><span class="koboSpan" id="kobo.43.1">Node</span></strong><span class="koboSpan" id="kobo.44.1"> entity </span><a id="_idIndexMarker496"/><span class="koboSpan" id="kobo.45.1">will be an instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.46.1">\Drupal\node\Entity\Node</span></strong><span class="koboSpan" id="kobo.47.1"> and a </span><strong class="bold"><span class="koboSpan" id="kobo.48.1">Taxonomy Term</span></strong><span class="koboSpan" id="kobo.49.1"> entity will be an instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.50.1">\Drupal\taxonomy\Entity\Term</span></strong><span class="koboSpan" id="kobo.51.1"> regardless of the entity’s bundle. </span><span class="koboSpan" id="kobo.51.2">Drupal allows altering entity information to provide alternative classes when an entity of a specific bundle is instantiated. </span><span class="koboSpan" id="kobo.51.3">Entity bundles are often used for different specific business logic. </span><span class="koboSpan" id="kobo.51.4">This feature allows the creation of classes with specific business logic associated with fields on </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">the bundle.</span></span></p>
<p><span class="koboSpan" id="kobo.53.1">In this recipe, we will create an entity bundle class to be used when there is a </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.54.1">Recipe</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.55.1"> node.</span></span></p>
<h2 id="_idParaDest-266"><a id="_idTextAnchor295"/><span class="koboSpan" id="kobo.56.1">Getting started</span></h2>
<p><span class="koboSpan" id="kobo.57.1">In this recipe, we will be using the </span><strong class="bold"><span class="koboSpan" id="kobo.58.1">Recipe</span></strong><span class="koboSpan" id="kobo.59.1"> content type provided by the Umami </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">demo installation.</span></span></p>
<h2 id="_idParaDest-267"><a id="_idTextAnchor296"/><span class="koboSpan" id="kobo.61.1">How to do it…</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.62.1">First, we need to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.63.1">src/Entity</span></strong><span class="koboSpan" id="kobo.64.1"> directory in the module’s directory. </span><span class="koboSpan" id="kobo.64.2">This will translate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.65.1">\Drupal\mymodule\Entity</span></strong><span class="koboSpan" id="kobo.66.1"> namespace, which is where we will create our </span><span class="No-Break"><span class="koboSpan" id="kobo.67.1">bundle class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.68.1">
mkdir -p src/Entity</span></pre></li>
<li><span class="koboSpan" id="kobo.69.1">Create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.70.1">Recipe.php</span></strong><span class="koboSpan" id="kobo.71.1"> in the newly created directory so that we can define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.72.1">Recipe</span></strong><span class="koboSpan" id="kobo.73.1"> class to use for our </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.74.1">Recipe</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.75.1"> nodes.</span></span></li>
<li><span class="koboSpan" id="kobo.76.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.77.1">Recipe</span></strong><span class="koboSpan" id="kobo.78.1"> class will extend </span><strong class="source-inline"><span class="koboSpan" id="kobo.79.1">\Drupal\node\Entity\Node</span></strong><span class="koboSpan" id="kobo.80.1">. </span><span class="koboSpan" id="kobo.80.2">Bundle classes must extend the class for its </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">entity type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.82.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.83.1">
namespace Drupal\mymodule\Entity;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.84.1">
use Drupal\node\Entity\Node;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.85.1">
class Recipe extends Node {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.86.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.87.1">If a bundle class does not extend the class for an entity type, Drupal will throw a </span><strong class="source-inline"><span class="koboSpan" id="kobo.88.1">BundleClassInheritanceException</span></strong><span class="koboSpan" id="kobo.89.1"> exception when processing entity </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">type definitions.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.91.1">By default, the </span><strong class="bold"><span class="koboSpan" id="kobo.92.1">Recipe</span></strong><span class="koboSpan" id="kobo.93.1"> content type comes with various fields, including a </span><strong class="bold"><span class="koboSpan" id="kobo.94.1">Tags</span></strong><span class="koboSpan" id="kobo.95.1"> field for referencing multiple taxonomy terms. </span><span class="koboSpan" id="kobo.95.2">We will create a method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.96.1">getTags</span></strong><span class="koboSpan" id="kobo.97.1"> to</span><a id="_idIndexMarker497"/><span class="koboSpan" id="kobo.98.1"> return</span><a id="_idIndexMarker498"/><span class="koboSpan" id="kobo.99.1"> those referenced </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">term entities:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.101.1">
class Recipe extends Node {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.102.1">
  public function getTags(): array {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.103.1">
    /** @var \Drupal\Core\Field\EntityReferenceField</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.104.1">
        ItemListInterface $field_tags */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.105.1">
    $field_tags = $this-&gt;get('field_tags');</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.106.1">
    return $field_tags-&gt;referencedEntities();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.107.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.108.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.109.1">Entity reference fields implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.110.1">EntityReferenceFieldItemListInterface</span></strong><span class="koboSpan" id="kobo.111.1">, which defines the </span><strong class="source-inline"><span class="koboSpan" id="kobo.112.1">referencedEntities</span></strong><span class="koboSpan" id="kobo.113.1"> method. </span><span class="koboSpan" id="kobo.113.2">This loads and returns all referenced </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">entity objects.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.115.1">With the bundle class defined, we must implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.116.1">hook_entity_bundle_info_alter</span></strong><span class="koboSpan" id="kobo.117.1"> to register our bundle class for the </span><strong class="bold"><span class="koboSpan" id="kobo.118.1">Recipe</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.119.1">content type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.120.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.121.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.122.1">
 * Implements hook_entity_bundle_info_alter().</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.123.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.124.1">
function mymodule_entity_bundle_info_alter(&amp;$bundles) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.125.1">
  $bundles ['node']['recipe']['label'] = t('Recipe');</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.126.1">
  $bundles['node']['recipe']['class'] = Drupal\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.127.1">
    mymodule\Entity\Recipe::class;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.128.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.129.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.130.1">$bundles</span></strong><span class="koboSpan" id="kobo.131.1"> argument</span><a id="_idIndexMarker499"/><span class="koboSpan" id="kobo.132.1"> is</span><a id="_idIndexMarker500"/><span class="koboSpan" id="kobo.133.1"> an array of entity type bundles, keyed by entity type. </span><span class="koboSpan" id="kobo.133.2">To register an entity bundle, you set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.134.1">class</span></strong><span class="koboSpan" id="kobo.135.1"> key for that bundle as your bundle class’s </span><span class="No-Break"><span class="koboSpan" id="kobo.136.1">class name.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.137.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.138.1">getTags</span></strong><span class="koboSpan" id="kobo.139.1"> method can then be used in a </span><strong class="bold"><span class="koboSpan" id="kobo.140.1">Twig</span></strong><span class="koboSpan" id="kobo.141.1"> template for </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.142.1">Recipe</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.143.1"> content:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.144.1">
{% for tag in node.getTags %}</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.145.1">
  &lt;div&gt;Tag: {{ tag.label }}&lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.146.1">
{% endfor %}</span></pre></li>
</ol>
<h2 id="_idParaDest-268"><a id="_idTextAnchor297"/><span class="koboSpan" id="kobo.147.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.148.1">When an entity record is loaded from the database, the values are passed to its entity class. </span><span class="koboSpan" id="kobo.148.2">Content entity types support bundles and thus allow defining classes for each bundle, which extend the entity </span><span class="No-Break"><span class="koboSpan" id="kobo.149.1">type class.</span></span></p>
<p><span class="koboSpan" id="kobo.150.1">This is handled in the entity storage </span><strong class="source-inline"><span class="koboSpan" id="kobo.151.1">\Drupal\Core\Entity\ContentEntityStorageBase</span></strong><span class="koboSpan" id="kobo.152.1"> base class and its</span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1"> getEntityClass</span></strong><span class="koboSpan" id="kobo.154.1"> method. </span><span class="koboSpan" id="kobo.154.2">This method returns the class that should be used when mapping the database records into an instantiated entity object. </span><span class="koboSpan" id="kobo.154.3">This logic is contained in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">\</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.156.1">Drupal\Core\Entity\EntityStorageBase::mapFromStorageRecords</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.157.1"> method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.158.1">
foreach ($records as $record) {
  $entity_class = $this-&gt;getEntityClass()</span><strong class="bold"><span class="koboSpan" id="kobo.159.1">;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.160.1">  /** @var \Drupal\Core\Entity\EntityInterface $entity */</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.161.1">  </span></strong><span class="koboSpan" id="kobo.162.1">$entity = new $entity_class($record</span><strong class="bold"><span class="koboSpan" id="kobo.163.1">, </span></strong><span class="koboSpan" id="kobo.164.1">$this-&gt;
    entityTypeId)</span><strong class="bold"><span class="koboSpan" id="kobo.165.1">;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.166.1">  </span></strong><span class="koboSpan" id="kobo.167.1">$entities[$entity-&gt;id()] = $entity</span><strong class="bold"><span class="koboSpan" id="kobo.168.1">;</span></strong><span class="koboSpan" id="kobo.169.1">
}</span></pre>
<p><span class="koboSpan" id="kobo.170.1">Whenever an</span><a id="_idIndexMarker501"/><span class="koboSpan" id="kobo.171.1"> entity </span><a id="_idIndexMarker502"/><span class="koboSpan" id="kobo.172.1"> entity is loaded, assertions can be made to check the instance of an entity object to verify its bundle and access specific methods for that bundle class. </span><span class="koboSpan" id="kobo.172.2">These methods are also </span><a id="_idIndexMarker503"/><span class="koboSpan" id="kobo.173.1">allowed in Twig template markup. </span><span class="koboSpan" id="kobo.173.2">Twig templates are covered in </span><a href="B18548_10.xhtml#_idTextAnchor319"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.174.1">Chapter 10</span></em></span></a><span class="koboSpan" id="kobo.175.1">, </span><em class="italic"><span class="koboSpan" id="kobo.176.1">Theming and </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.177.1">Frontend Development</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.178.1">.</span></span></p>
<h2 id="_idParaDest-269"><a id="_idTextAnchor298"/><span class="koboSpan" id="kobo.179.1">See also</span></h2>
<ul>
<li><span class="koboSpan" id="kobo.180.1">The change record for Drupal 9.3.0 introducing the bundle class </span><span class="No-Break"><span class="koboSpan" id="kobo.181.1">feature: </span></span><a href="https://www.drupal.org/node/3191609 "><span class="No-Break"><span class="koboSpan" id="kobo.182.1">https://www.drupal.org/node/3191609</span></span></a></li>
</ul>
<h1 id="_idParaDest-270"><a id="_idTextAnchor299"/><span class="koboSpan" id="kobo.183.1">Creating a configuration entity type</span></h1>
<p><span class="koboSpan" id="kobo.184.1">In this recipe, we</span><a id="_idIndexMarker504"/><span class="koboSpan" id="kobo.185.1"> will create a configuration entity type called </span><strong class="source-inline"><span class="koboSpan" id="kobo.186.1">Announcement</span></strong><span class="koboSpan" id="kobo.187.1">. </span><span class="koboSpan" id="kobo.187.2">This will provide a </span><strong class="bold"><span class="koboSpan" id="kobo.188.1">configuration entity</span></strong><span class="koboSpan" id="kobo.189.1"> that allows you to create, edit, and delete messages that can be displayed on the site for </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">important announcements.</span></span></p>
<p><span class="koboSpan" id="kobo.191.1">Configuration entities do not interact with Drupal’s Field API and do not have a user interface to add fields. </span><span class="koboSpan" id="kobo.191.2">They have properties defined on their class like models in other frameworks. </span><span class="koboSpan" id="kobo.191.3">However, configuration entities do not have dedicated tables in the database. </span><span class="koboSpan" id="kobo.191.4">They are stored in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.192.1">config</span></strong><span class="koboSpan" id="kobo.193.1"> table as serialized data. </span><span class="koboSpan" id="kobo.193.2">The purpose of a configuration entity is for configuration. </span><span class="koboSpan" id="kobo.193.3">Examples of configuration entities are view displays, form displays, and </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">contact forms.</span></span></p>
<h2 id="_idParaDest-271"><a id="_idTextAnchor300"/><span class="koboSpan" id="kobo.195.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.196.1">First, we need to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.197.1">src/Entity</span></strong><span class="koboSpan" id="kobo.198.1"> directory in the module’s directory. </span><span class="koboSpan" id="kobo.198.2">This will translate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">\Drupal\mymodule\Entity</span></strong><span class="koboSpan" id="kobo.200.1"> namespace and allow for entity </span><span class="No-Break"><span class="koboSpan" id="kobo.201.1">type discovery:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.202.1">
mkdir -p src/Entity</span></pre></li>
<li><span class="koboSpan" id="kobo.203.1">Create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">Announcement.php</span></strong><span class="koboSpan" id="kobo.205.1"> in the newly created directory so that we can </span><a id="_idIndexMarker505"/><span class="koboSpan" id="kobo.206.1">define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">Announcement</span></strong><span class="koboSpan" id="kobo.208.1"> class for our </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">entity type.</span></span></li>
<li><span class="koboSpan" id="kobo.210.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.211.1">Announcement</span></strong><span class="koboSpan" id="kobo.212.1"> class will extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.213.1">\Drupal\Core\Config\Entity\ConfigEntityBase</span></strong><span class="koboSpan" id="kobo.214.1"> class and define our entity </span><span class="No-Break"><span class="koboSpan" id="kobo.215.1">type’s properties:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.216.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.217.1">
namespace Drupal\mymodule\Entity;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.218.1">
use Drupal\Core\Config\Entity\ConfigEntityBase;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.219.1">
class Announcement extends ConfigEntityBase {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.220.1">
  public string $label = '';</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.221.1">
  public string $message = '';</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.222.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.223.1">We extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.224.1">ConfigEntityBase</span></strong><span class="koboSpan" id="kobo.225.1"> class, which implements </span><strong class="source-inline"><span class="koboSpan" id="kobo.226.1">\Drupal\Core\Config\Entity\ConfigEntityInterface</span></strong><span class="koboSpan" id="kobo.227.1"> and satisfies all required method implementations so that we only need to define our properties. </span><span class="koboSpan" id="kobo.227.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.228.1">label</span></strong><span class="koboSpan" id="kobo.229.1"> property will contain the description of the announcement, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">message</span></strong><span class="koboSpan" id="kobo.231.1"> property will contain the </span><span class="No-Break"><span class="koboSpan" id="kobo.232.1">announcement’s text.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.233.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.234.1">Typically, properties of an entity type are protected and use methods to set and get values. </span><span class="koboSpan" id="kobo.234.2">To simplify the code in this recipe, we are using </span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">public properties.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.236.1">Next, we will </span><a id="_idIndexMarker506"/><span class="koboSpan" id="kobo.237.1">write the plugin annotation in a class documentation block for our </span><span class="No-Break"><span class="koboSpan" id="kobo.238.1">entity type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.239.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.240.1">
 * @ConfigEntityType(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.241.1">
 *   id = "announcement",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.242.1">
 *   label = "Announcement",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.243.1">
 *   entity_keys = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.244.1">
 *     "id" = "id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.245.1">
 *     "label" = "label"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.246.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.247.1">
 *   config_export = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.248.1">
 *     "id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.249.1">
 *     "label",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.250.1">
 *     "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.251.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.252.1">
 *   admin_permission = "administer announcement",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.253.1">
 * )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.254.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.255.1">
class Announcement extends ConfigEntityBase {</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.256.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">@ConfigEntityType</span></strong><span class="koboSpan" id="kobo.258.1"> symbol specifies that this is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">ConfigEntityType</span></strong><span class="koboSpan" id="kobo.260.1"> annotation. </span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">id</span></strong><span class="koboSpan" id="kobo.262.1"> is the entity type ID, used to retrieve the entity type’s storage and other handlers. </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">label</span></strong><span class="koboSpan" id="kobo.264.1"> is the human-readable name of the entity type. </span><span class="koboSpan" id="kobo.264.2">The values in </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">entity_keys</span></strong><span class="koboSpan" id="kobo.266.1"> instruct Drupal what the </span><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">id</span></strong><span class="koboSpan" id="kobo.268.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">label</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.270.1">properties are.</span></span></p>
<p><span class="koboSpan" id="kobo.271.1">When specifying </span><strong class="source-inline"><span class="koboSpan" id="kobo.272.1">config_export</span></strong><span class="koboSpan" id="kobo.273.1">, we are telling the configuration management system what properties are exportable when our entity type is exported. </span><strong class="source-inline"><span class="koboSpan" id="kobo.274.1">admin_permission</span></strong><span class="koboSpan" id="kobo.275.1"> specifies the permission name required to manage </span><a id="_idIndexMarker507"/><span class="koboSpan" id="kobo.276.1">the </span><span class="No-Break"><span class="koboSpan" id="kobo.277.1">entity type.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.278.1">Next, we will add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.279.1">handlers</span></strong><span class="koboSpan" id="kobo.280.1"> key to </span><span class="No-Break"><span class="koboSpan" id="kobo.281.1">our annotation:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.282.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.283.1">
 * @ConfigEntityType(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.284.1">
 *   id = "announcement",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.285.1">
 *   label = "Announcement",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.286.1">
 *   entity_keys = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.287.1">
 *     "id" = "id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.288.1">
 *     "label" = "label"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.289.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.290.1">
 *   config_export = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.291.1">
 *     "id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.292.1">
 *     "label",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.293.1">
 *     "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.294.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.295.1">
 *   admin_permission = "administer announcement",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.296.1">
 *   handlers = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.297.1">
 *     "list_builder" = "Drupal\mymodule</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.298.1">
            \AnnouncementListBuilder",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.299.1">
 *     "form" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.300.1">
 *       "default" = "Drupal\mymodule</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.301.1">
            \AnnouncementForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.302.1">
 *       "delete" = "Drupal\Core\Entity</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.303.1">
            \EntityDeleteForm"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.304.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.305.1">
 *     "route_provider" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.306.1">
 *       "html" = "Drupal\Core\Entity\Routing</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.307.1">
            \AdminHtmlRouteProvider",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.308.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.309.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.310.1">
 * )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.311.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.312.1">
class Announcement extends ConfigEntityBase {</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.313.1">The handlers </span><a id="_idIndexMarker508"/><span class="koboSpan" id="kobo.314.1">array specifies classes that provide the functionality for Drupal to interact with our entity type. </span><span class="koboSpan" id="kobo.314.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.315.1">list_builder</span></strong><span class="koboSpan" id="kobo.316.1"> class, which we will create, is used to show a table of entities for our entity type. </span><span class="koboSpan" id="kobo.316.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">form</span></strong><span class="koboSpan" id="kobo.318.1"> handlers specify the form classes to be used when creating, editing, or deleting an entity. </span><span class="koboSpan" id="kobo.318.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.319.1">route_provider</span></strong><span class="koboSpan" id="kobo.320.1"> handler is an array of handlers that will generate routes for our </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">entity type.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.322.1">Lastly, for our entity type’s annotation, we will provide link templates that </span><strong class="source-inline"><span class="koboSpan" id="kobo.323.1">route_provider</span></strong><span class="koboSpan" id="kobo.324.1"> will use to build routes for our </span><span class="No-Break"><span class="koboSpan" id="kobo.325.1">entity type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.326.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.327.1">
 * @ConfigEntityType(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.328.1">
 *   id = "announcement",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.329.1">
 *   label = "Announcement",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.330.1">
 *   entity_keys = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.331.1">
 *     "id" = "id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.332.1">
 *     "label" = "label"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.333.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.334.1">
 *   config_export = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.335.1">
 *     "id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.336.1">
 *     "label",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.337.1">
 *     "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.338.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.339.1">
 *   admin_permission = "administer announcement",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.340.1">
 *   handlers = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.341.1">
 *     "list_builder" = "Drupal\mymodule</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.342.1">
            \AnnouncementListBuilder",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.343.1">
 *     "form" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.344.1">
 *       "default" = "Drupal\mymodule</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.345.1">
            \AnnouncementForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.346.1">
 *       "delete" = "Drupal\Core\Entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.347.1">
            EntityDeleteForm"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.348.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.349.1">
 *     "route_provider" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.350.1">
 *       "html" = "Drupal\Core\Entity\Routing\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.351.1">
            AdminHtmlRouteProvider",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.352.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.353.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.354.1">
 *   links = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.355.1">
 *     "collection" = "/admin/config/system/</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.356.1">
            announcements",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.357.1">
 *     "add-form" = "/admin/config/system/</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.358.1">
            announcements/add",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.359.1">
 *     "delete-form" = "/admin/config/system/</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.360.1">
          announcements/manage/{announcement}/delete",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.361.1">
 *     "edit-form" = "/admin/config/system/</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.362.1">
          announcements/manage/{announcement}",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.363.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.364.1">
 * )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.365.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.366.1">
class Announcement extends ConfigEntityBase {</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.367.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">links</span></strong><span class="koboSpan" id="kobo.369.1"> array defines </span><a id="_idIndexMarker509"/><span class="koboSpan" id="kobo.370.1">keys expected from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.371.1">html</span></strong><span class="koboSpan" id="kobo.372.1"> route provider, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">collection</span></strong><span class="koboSpan" id="kobo.374.1"> (list), </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">add-form</span></strong><span class="koboSpan" id="kobo.376.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">delete-form</span></strong><span class="koboSpan" id="kobo.378.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">edit-form</span></strong><span class="koboSpan" id="kobo.380.1">. </span><span class="koboSpan" id="kobo.380.2">The route provider will generate routes for the </span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">given paths.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.382.1">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">AnnouncementListBuilder</span></strong><span class="koboSpan" id="kobo.384.1"> class defined in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">list_builder</span></strong><span class="koboSpan" id="kobo.386.1"> handler by creating an </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">AnnouncementListBuilder.php</span></strong><span class="koboSpan" id="kobo.388.1"> file in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">src</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.390.1"> directory:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.391.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.392.1">
namespace Drupal\mymodule;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.393.1">
use Drupal\Core\Config\Entity\ConfigEntityListBuilder;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.394.1">
use Drupal\Core\Entity\EntityInterface;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.395.1">
class AnnouncementListBuilder extends</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.396.1">
    ConfigEntityListBuilder {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.397.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.398.1">
 * Builds the header row for the entity listing.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.399.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.400.1">
 * @return array</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.401.1">
 *   A render array structure of header strings.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.402.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.403.1">
 * @see \Drupal\Core\Entity</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.404.1">
        \EntityListBuilder::render()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.405.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.406.1">
    public function buildHeader() </span></pre><pre class="source-code"><span class="koboSpan" id="kobo.407.1">
  {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.408.1">
      $header['label'] = $this-&gt;t('Label');</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.409.1">
      return $header + parent::buildHeader();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.410.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.411.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.412.1">
 * Builds a row for an entity in the entity listing.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.413.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.414.1">
 * @param \Drupal\Core\Entity\EntityInterface $entity</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.415.1">
 *   The entity for this row of the list.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.416.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.417.1">
 * @return array</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.418.1">
 *   A render array structure of fields for this</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.419.1">
        entity.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.420.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.421.1">
 * @see \Drupal\Core\Entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.422.1">
      EntityListBuilder::render()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.423.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.424.1">
  public function buildRow(EntityInterface $entity) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.425.1">
    $row['label'] = $entity-&gt;label();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.426.1">
    return $row + parent::buildRow($entity);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.427.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.428.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.429.1">Our </span><strong class="source-inline"><span class="koboSpan" id="kobo.430.1">AnnouncementListBuilder</span></strong><span class="koboSpan" id="kobo.431.1"> class extends </span><strong class="source-inline"><span class="koboSpan" id="kobo.432.1">\Drupal\Core\Config\Entity\ConfigEntityListBuilder</span></strong><span class="koboSpan" id="kobo.433.1">, which provides all </span><a id="_idIndexMarker510"/><span class="koboSpan" id="kobo.434.1">the required methods to build our table of entities. </span><span class="koboSpan" id="kobo.434.2">We override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.435.1">buildHeader</span></strong><span class="koboSpan" id="kobo.436.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.437.1">buildRow</span></strong><span class="koboSpan" id="kobo.438.1"> methods to ensure entity labels </span><span class="No-Break"><span class="koboSpan" id="kobo.439.1">are displayed.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.440.1">Now, we will create the entity form that is used for creating and editing our entity type. </span><span class="koboSpan" id="kobo.440.2">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">AnnouncementForm</span></strong><span class="koboSpan" id="kobo.442.1"> class, defined as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">default</span></strong><span class="koboSpan" id="kobo.444.1"> form handler, by creating an </span><strong class="source-inline"><span class="koboSpan" id="kobo.445.1">AnnouncementForm.php</span></strong><span class="koboSpan" id="kobo.446.1"> file in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.447.1">src</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.448.1"> directory:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.449.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.450.1">
namespace Drupal\mymodule;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.451.1">
use Drupal\Core\Entity\EntityForm;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.452.1">
use Drupal\Core\Form\FormStateInterface;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.453.1">
use Drupal\mymodule\Entity\Announcement;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.454.1">
class AnnouncementForm extends EntityForm {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.455.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.456.1">
 * Gets the actual form array to be built.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.457.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.458.1">
 * @see \Drupal\Core\Entity\EntityForm::processForm()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.459.1">
 * @see \Drupal\Core\Entity\EntityForm::afterBuild()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.460.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.461.1">
  public function form(array $form, FormStateInterface</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.462.1">
    $form_state) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.463.1">
    $form = parent::form($form, $form_state);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.464.1">
    /** @var \Drupal\mymodule\Entity\Announcement</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.465.1">
        $entity */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.466.1">
    $entity = $this-&gt;entity;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.467.1">
    $form['label'] = [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.468.1">
      '#type' =&gt; 'textfield',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.469.1">
      '#title' =&gt; $this-&gt;t('Label'),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.470.1">
      '#required' =&gt; TRUE,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.471.1">
      '#default_value' =&gt; $entity-&gt;label,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.472.1">
    ];</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.473.1">
    $form['id'] = [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.474.1">
      '#type' =&gt; 'machine_name',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.475.1">
      '#default_value' =&gt; $entity-&gt;id(),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.476.1">
      '#disabled' =&gt; !$entity-&gt;isNew(),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.477.1">
      '#machine_name' =&gt; [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.478.1">
        'exists' =&gt; [Announcement::class, 'load'],</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.479.1">
      ],</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.480.1">
    ];</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.481.1">
    $form['message'] = [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.482.1">
      '#type' =&gt; 'textarea',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.483.1">
      '#title' =&gt; $this-&gt;t('Message'),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.484.1">
      '#required' =&gt; TRUE,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.485.1">
      '#default_value' =&gt; $entity-&gt;message,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.486.1">
    ];</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.487.1">
    return $form;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.488.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.489.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.490.1">
 * Form submission handler for the 'save' action.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.491.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.492.1">
 * Normally this method should be overridden to</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.493.1">
    provide specific messages to</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.494.1">
 * the user and redirect the form after the entity has</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.495.1">
      been saved.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.496.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.497.1">
 * @param array $form</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.498.1">
 *   An associative array containing the structure of</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.499.1">
        the form.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.500.1">
 * @param \Drupal\Core\Form\FormStateInterface</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.501.1">
        $form_state</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.502.1">
 *   The current state of the form.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.503.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.504.1">
 * @return int</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.505.1">
 *   Either SAVED_NEW or SAVED_UPDATED, depending on</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.506.1">
        the operation performed.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.507.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.508.1">
  public function save(array $form, FormStateInterface</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.509.1">
    $form_state) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.510.1">
    $result = parent::save($form, $form_state);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.511.1">
    if ($result === SAVED_NEW) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.512.1">
      $this-&gt;messenger()-&gt;addMessage('The announcement</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.513.1">
          has been created.');</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.514.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.515.1">
    else {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.516.1">
      $this-&gt;messenger()-&gt;addMessage('The announcement</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.517.1">
          has been updated.');</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.518.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.519.1">
    $form_state-&gt;setRedirectUrl($this-&gt;entity-&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.520.1">
        toUrl('collection'));</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.521.1">
    return $result;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.522.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.523.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.524.1">We override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">form</span></strong><span class="koboSpan" id="kobo.526.1"> method to add our form elements. </span><span class="koboSpan" id="kobo.526.2">We define a text field for our </span><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">label</span></strong><span class="koboSpan" id="kobo.528.1"> property followed by a </span><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">machine_name</span></strong><span class="koboSpan" id="kobo.530.1"> element for </span><strong class="source-inline"><span class="koboSpan" id="kobo.531.1">id</span></strong><span class="koboSpan" id="kobo.532.1">. </span><span class="koboSpan" id="kobo.532.2">This element will transliterate and convert the </span><strong class="source-inline"><span class="koboSpan" id="kobo.533.1">label</span></strong><span class="koboSpan" id="kobo.534.1"> value into a storage-friendly value to serve as the entity’s identifier. </span><span class="koboSpan" id="kobo.534.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">message</span></strong><span class="koboSpan" id="kobo.536.1"> property uses a normal text </span><span class="No-Break"><span class="koboSpan" id="kobo.537.1">area element.</span></span></p>
<p><span class="koboSpan" id="kobo.538.1">We also override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">save</span></strong><span class="koboSpan" id="kobo.540.1"> method to provide messages about the changes that have been made. </span><span class="koboSpan" id="kobo.540.2">We also ensure the user is redirected back to the collection page for </span><span class="No-Break"><span class="koboSpan" id="kobo.541.1">the entity.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.542.1">To make our </span><a id="_idIndexMarker511"/><span class="koboSpan" id="kobo.543.1">announcements accessible from the administrative pages, we need to define a menu link. </span><span class="koboSpan" id="kobo.543.2">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.544.1">mymodule.links.menu.yml</span></strong><span class="koboSpan" id="kobo.545.1"> file and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.546.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.547.1">
mymodule.announcements:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.548.1">
  title: 'Announcements'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.549.1">
  parent: system.admin_config_system</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.550.1">
  description: 'Manage announcements.'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.551.1">
  route_name: entity.announcement.collection</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.552.1">This registers a menu link for the specified </span><strong class="source-inline"><span class="koboSpan" id="kobo.553.1">route_name</span></strong><span class="koboSpan" id="kobo.554.1"> under the </span><span class="No-Break"><span class="koboSpan" id="kobo.555.1">specified </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.556.1">parent</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.557.1">.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.558.1">Next, we will define an action link. </span><span class="koboSpan" id="kobo.558.2">In Drupal, action links are buttons on pages generally used to bring the user to a form. </span><span class="koboSpan" id="kobo.558.3">Our action link will add an </span><strong class="bold"><span class="koboSpan" id="kobo.559.1">Add announcement</span></strong><span class="koboSpan" id="kobo.560.1"> link from the collection route. </span><span class="koboSpan" id="kobo.560.2">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.561.1">mymodule.links.action.yml</span></strong><span class="koboSpan" id="kobo.562.1"> file and add </span><span class="No-Break"><span class="koboSpan" id="kobo.563.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.564.1">
announcement.add:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.565.1">
  route_name: entity.announcement.add_form</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.566.1">
  title: 'Add announcement'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.567.1">
  appears_on:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.568.1">
    - entity.announcement.collection</span></pre></li>
</ol>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">route_name</span></strong><span class="koboSpan" id="kobo.570.1"> matches the route name generated by our route provider for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.571.1">add-form</span></strong><span class="koboSpan" id="kobo.572.1"> link. </span><span class="koboSpan" id="kobo.572.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">appears_on</span></strong><span class="koboSpan" id="kobo.574.1"> array specifies what routes the action link should </span><span class="No-Break"><span class="koboSpan" id="kobo.575.1">render on.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.576.1">Now that we have provided our entity type and its handlers, we need to create a schema file that describes our configuration entity’s properties. </span><span class="koboSpan" id="kobo.576.2">We must create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.577.1">config/schema</span></strong><span class="koboSpan" id="kobo.578.1"> directory, which is where the schema file </span><span class="No-Break"><span class="koboSpan" id="kobo.579.1">will reside:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.580.1">
mkdir -p config/schema</span></pre></li>
<li><span class="koboSpan" id="kobo.581.1">Create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.582.1">mymodule.schema.yml</span></strong><span class="koboSpan" id="kobo.583.1"> to contain the schema definition</span><a id="_idIndexMarker512"/><span class="koboSpan" id="kobo.584.1"> for our configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.585.1">entity’s properties:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.586.1">
mymodule.announcement.*:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.587.1">
  type: config_entity</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.588.1">
  label: 'Announcement'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.589.1">
  mapping:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.590.1">
    id:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.591.1">
      type: string</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.592.1">
      label: 'ID'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.593.1">
    label:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.594.1">
      type: label</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.595.1">
      label: 'Label'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.596.1">
    message:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.597.1">
      type: text</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.598.1">
      label: 'Text'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.599.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.600.1">mymodule.announcement.*</span></strong><span class="koboSpan" id="kobo.601.1"> key instructs Drupal that all of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.602.1">announcement</span></strong><span class="koboSpan" id="kobo.603.1"> configuration entities apply to this schema. </span><span class="koboSpan" id="kobo.603.2">The key is built by taking the module name, which provides the entity type and the entity </span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">type’s ID.</span></span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.605.1">Before installing the module, we must define the permission specified in </span><strong class="source-inline"><span class="koboSpan" id="kobo.606.1">admin_permission</span></strong><span class="koboSpan" id="kobo.607.1">. </span><span class="koboSpan" id="kobo.607.2">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.608.1">mymodule.permissions.yml</span></strong><span class="koboSpan" id="kobo.609.1"> file and add </span><span class="No-Break"><span class="koboSpan" id="kobo.610.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.611.1">
administer announcement:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.612.1">
  title: 'Administer announcements'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.613.1">Defining the permission in the entity type’s annotation does not register it as a permission with</span><a id="_idIndexMarker513"/> <span class="No-Break"><span class="koboSpan" id="kobo.614.1">Drupal automatically.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.615.1">Install the module. </span><span class="koboSpan" id="kobo.615.2">On the </span><strong class="bold"><span class="koboSpan" id="kobo.616.1">Configuration</span></strong><span class="koboSpan" id="kobo.617.1"> page, you will now see </span><strong class="bold"><span class="koboSpan" id="kobo.618.1">Announcements</span></strong><span class="koboSpan" id="kobo.619.1">, which allows you to create announcement </span><span class="No-Break"><span class="koboSpan" id="kobo.620.1">configuration entities.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer055">
<span class="koboSpan" id="kobo.621.1"><img alt="Figure 9.1 – The Announcements link on the configuration page" src="image/Figure_9.01_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.622.1">Figure 9.1 – The Announcements link on the configuration page</span></p>
<h2 id="_idParaDest-272"><a id="_idTextAnchor301"/><span class="koboSpan" id="kobo.623.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.624.1">Entity types are plugins in Drupal. </span><span class="koboSpan" id="kobo.624.2">The entity type manager provides discovery of entity types and accesses their handlers. </span><span class="koboSpan" id="kobo.624.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.625.1">ConfigEntityType</span></strong><span class="koboSpan" id="kobo.626.1"> plugin type’s class is </span><strong class="source-inline"><span class="koboSpan" id="kobo.627.1">\Drupal\Core\Config\Entity\ConfigEntityType</span></strong><span class="koboSpan" id="kobo.628.1">. </span><span class="koboSpan" id="kobo.628.2">This class sets up the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.629.1">storage</span></strong><span class="koboSpan" id="kobo.630.1"> handler to </span><strong class="source-inline"><span class="koboSpan" id="kobo.631.1">\Drupal\Core\Config\Entity\ConfigEntityStorage</span></strong><span class="koboSpan" id="kobo.632.1"> and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.633.1">entity_keys</span></strong><span class="koboSpan" id="kobo.634.1"> entries for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.635.1">uuid</span></strong><span class="koboSpan" id="kobo.636.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.637.1">langcode</span></strong><span class="koboSpan" id="kobo.638.1"> properties, which are defined in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.639.1">ConfigEntityBase</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.640.1"> class.</span></span></p>
<p><span class="koboSpan" id="kobo.641.1">Entity types are expected to define permission for administration, via the </span><strong class="source-inline"><span class="koboSpan" id="kobo.642.1">admin_permission</span></strong><span class="koboSpan" id="kobo.643.1"> annotation value. </span><span class="koboSpan" id="kobo.643.2">The de facto pattern is to use the word </span><strong class="source-inline"><span class="koboSpan" id="kobo.644.1">administer</span></strong><span class="koboSpan" id="kobo.645.1"> and then the entity type ID. </span><span class="koboSpan" id="kobo.645.2">That is why our permission name is </span><strong class="source-inline"><span class="koboSpan" id="kobo.646.1">administered announcement</span></strong><span class="koboSpan" id="kobo.647.1"> and not </span><strong class="source-inline"><span class="koboSpan" id="kobo.648.1">administer announcements</span></strong><span class="koboSpan" id="kobo.649.1">. </span><span class="koboSpan" id="kobo.649.2">More about entity type permissions and access is covered in the </span><em class="italic"><span class="koboSpan" id="kobo.650.1">Implementing access control for an </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.651.1">entity</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.652.1"> recipe.</span></span></p>
<p><span class="koboSpan" id="kobo.653.1">The entity system is integrated with the routing system to invoke registered </span><strong class="source-inline"><span class="koboSpan" id="kobo.654.1">route_provider</span></strong><span class="koboSpan" id="kobo.655.1"> handlers. </span><span class="koboSpan" id="kobo.655.2">Our entity type uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.656.1">AdminHtmlRouteProvider</span></strong><span class="koboSpan" id="kobo.657.1"> class, which extends the </span><strong class="source-inline"><span class="koboSpan" id="kobo.658.1">DefaultHtmlRouteProvider</span></strong><span class="koboSpan" id="kobo.659.1"> class and ensures each route is rendered</span><a id="_idIndexMarker514"/><span class="koboSpan" id="kobo.660.1"> with the </span><span class="No-Break"><span class="koboSpan" id="kobo.661.1">administrative theme.</span></span></p>
<h2 id="_idParaDest-273"><a id="_idTextAnchor302"/><span class="koboSpan" id="kobo.662.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.663.1">In the following sections, we’ll cover more information about defining configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.664.1">entity types.</span></span></p>
<h3><span class="koboSpan" id="kobo.665.1">Registering a configuration entity for an installed module</span></h3>
<p><span class="koboSpan" id="kobo.666.1">When a module is</span><a id="_idIndexMarker515"/><span class="koboSpan" id="kobo.667.1"> first installed, Drupal also installs the entity type. </span><span class="koboSpan" id="kobo.667.2">If a module is already installed, we need to use the entity definition update manager to do so. </span><span class="koboSpan" id="kobo.667.3">This is accomplished by writing an update hook in the module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.668.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.669.1">install</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.670.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.671.1">The following update hook would install the announcement entity type on a Drupal site that already has the providing </span><span class="No-Break"><span class="koboSpan" id="kobo.672.1">module installed:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.673.1">
function mymodule_update_10001() {
  /** @var \Drupal\Core\Entity\EntityDefinition
    UpdateManager $edum */
  $edum = \Drupal::service
     ('entity.definition_update_manager');
  $definition = $edum-&gt;getEntityType('announcement');
  $edum-&gt;installEntityType($definition);
}</span></pre>
<p><span class="koboSpan" id="kobo.674.1">The entity definition update manager allows retrieving entity type definitions that have not yet been </span><a id="_idIndexMarker516"/><span class="koboSpan" id="kobo.675.1">installed with its </span><strong class="source-inline"><span class="koboSpan" id="kobo.676.1">getEntityType</span></strong><span class="koboSpan" id="kobo.677.1"> method. </span><span class="koboSpan" id="kobo.677.2">This definition must then be passed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.678.1">installEntityType</span></strong><span class="koboSpan" id="kobo.679.1"> to properly install the new </span><span class="No-Break"><span class="koboSpan" id="kobo.680.1">entity type.</span></span></p>
<h3><span class="koboSpan" id="kobo.681.1">Generating configuration entity types with Drush</span></h3>
<p><strong class="bold"><span class="koboSpan" id="kobo.682.1">Drush</span></strong><span class="koboSpan" id="kobo.683.1"> provides</span><a id="_idIndexMarker517"/><span class="koboSpan" id="kobo.684.1"> code-generation</span><a id="_idIndexMarker518"/><span class="koboSpan" id="kobo.685.1"> tools to automate the steps taken in this chapter. </span><span class="koboSpan" id="kobo.685.2">The following command will begin the </span><span class="No-Break"><span class="koboSpan" id="kobo.686.1">code-generation process:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.687.1">
php vendor/bin/drush generate entity:configuration</span></pre>
<p><span class="koboSpan" id="kobo.688.1">The command will prompt for a module name that should provide the entity type, the entity types label, and its ID. </span><span class="koboSpan" id="kobo.688.2">The code generated will differ from that described in this recipe as the code generation is improved. </span><span class="koboSpan" id="kobo.688.3">For instance, at the time of writing, it generates </span><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">routing.yml</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.690.1">overusing </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.691.1">route_provider</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer056">
<span class="koboSpan" id="kobo.693.1"><img alt="Figure 9.2 – Output from Drush code generation" src="image/Figure_9.02_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.694.1">Figure 9.2 – Output from Drush code generation</span></p>
<h3><span class="koboSpan" id="kobo.695.1">Available data types for schema definitions</span></h3>
<p><span class="koboSpan" id="kobo.696.1">Drupal core </span><a id="_idIndexMarker519"/><span class="koboSpan" id="kobo.697.1">provides its own configuration information. </span><span class="koboSpan" id="kobo.697.2">There is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.698.1">core.data_types.schema.yml</span></strong><span class="koboSpan" id="kobo.699.1"> file located at </span><strong class="source-inline"><span class="koboSpan" id="kobo.700.1">core/config/schema</span></strong><span class="koboSpan" id="kobo.701.1">. </span><span class="koboSpan" id="kobo.701.2">These are the base types of data that the core provides and can be used when making configuration schema. </span><span class="koboSpan" id="kobo.701.3">The file contains YAML definitions of data types and the class that </span><span class="No-Break"><span class="koboSpan" id="kobo.702.1">represents them:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.703.1">
boolean:
  label: 'Boolean'
  class: '\Drupal\Core\TypedData\Plugin\DataType
    \BooleanData'
email:
  label: 'Email'
  class: '\Drupal\Core\TypedData\Plugin\DataType\Email'
string:
  label: 'String'
  class: '\Drupal\Core\TypedData\Plugin\DataType
    \StringData'</span></pre>
<p><span class="koboSpan" id="kobo.704.1">When a configuration schema definition specifies an attribute that has email for its type, that value is then handled by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.705.1">\Drupal\Core\TypedData\Plugin\DataType\Email</span></strong><span class="koboSpan" id="kobo.706.1"> class. </span><span class="koboSpan" id="kobo.706.2">Data types are a form of plugins, and each plugin’s annotation specifies constraints for validation. </span><span class="koboSpan" id="kobo.706.3">This is built around </span><a id="_idIndexMarker520"/><span class="koboSpan" id="kobo.707.1">the </span><a id="_idIndexMarker521"/><span class="koboSpan" id="kobo.708.1">Symfony </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.709.1">Validator</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.710.1"> component.</span></span></p>
<h2 id="_idParaDest-274"><a id="_idTextAnchor303"/><span class="koboSpan" id="kobo.711.1">See also</span></h2>
<ul>
<li><a href="B18548_04.xhtml#_idTextAnchor131"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.712.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.713.1">, </span><em class="italic"><span class="koboSpan" id="kobo.714.1">Extending Drupal with </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.715.1">Custom Code</span></em></span></li>
<li><a href="B18548_08.xhtml#_idTextAnchor264"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.716.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.717.1">, </span><em class="italic"><span class="koboSpan" id="kobo.718.1">Plug and Play </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.719.1">with Plugins</span></em></span></li>
<li><a href="B18548_07.xhtml#_idTextAnchor240"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.720.1">Chapter 7</span></em></span></a><span class="koboSpan" id="kobo.721.1">, </span><em class="italic"><span class="koboSpan" id="kobo.722.1">Creating forms with the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.723.1">Form API</span></em></span></li>
<li><span class="koboSpan" id="kobo.724.1">Refer to configuration schema/metadata </span><span class="No-Break"><span class="koboSpan" id="kobo.725.1">at </span></span><a href="https://www.drupal.org/node/1905070 "><span class="No-Break"><span class="koboSpan" id="kobo.726.1">https://www.drupal.org/node/1905070</span></span></a></li>
</ul>
<h1 id="_idParaDest-275"><a id="_idTextAnchor304"/><span class="koboSpan" id="kobo.727.1">Creating a content entity type</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.728.1">Content entities</span></strong><span class="koboSpan" id="kobo.729.1"> provide </span><a id="_idIndexMarker522"/><span class="koboSpan" id="kobo.730.1">base field definitions and configurable fields with the </span><strong class="bold"><span class="koboSpan" id="kobo.731.1">Field UI</span></strong><span class="koboSpan" id="kobo.732.1"> module. </span><span class="koboSpan" id="kobo.732.2">There is also support for revisions and translations with content entities. </span><span class="koboSpan" id="kobo.732.3">Display modes, both form and view, are available for content entities to control how the fields are edited and displayed. </span><span class="koboSpan" id="kobo.732.4">When an entity does not specify bundles, there is automatically one bundle instance with the same name as </span><span class="No-Break"><span class="koboSpan" id="kobo.733.1">the entity.</span></span></p>
<p><span class="koboSpan" id="kobo.734.1">In this recipe, we will create a custom content entity that does not specify a bundle. </span><span class="koboSpan" id="kobo.734.2">We will create a </span><strong class="bold"><span class="koboSpan" id="kobo.735.1">Message</span></strong><span class="koboSpan" id="kobo.736.1"> entity that can serve as a content entity for </span><span class="No-Break"><span class="koboSpan" id="kobo.737.1">generic messages.</span></span></p>
<h2 id="_idParaDest-276"><a id="_idTextAnchor305"/><span class="koboSpan" id="kobo.738.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.739.1">First, we need to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.740.1">src/Entity</span></strong><span class="koboSpan" id="kobo.741.1"> directory in the module’s directory. </span><span class="koboSpan" id="kobo.741.2">This will translate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.742.1">\Drupal\mymodule\Entity</span></strong><span class="koboSpan" id="kobo.743.1"> namespace and allow for entity </span><span class="No-Break"><span class="koboSpan" id="kobo.744.1">type discovery:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.745.1">
mkdir -p src/Entity</span></pre></li>
<li><span class="koboSpan" id="kobo.746.1">Create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.747.1">Message.php</span></strong><span class="koboSpan" id="kobo.748.1"> in the newly created directory so that we can define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.749.1">Message</span></strong><span class="koboSpan" id="kobo.750.1"> class for our </span><span class="No-Break"><span class="koboSpan" id="kobo.751.1">entity type.</span></span></li>
<li><span class="koboSpan" id="kobo.752.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.753.1">Message</span></strong><span class="koboSpan" id="kobo.754.1"> class </span><a id="_idIndexMarker523"/><span class="koboSpan" id="kobo.755.1">will extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.756.1">\</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.757.1">Drupal\Core\Entity\ContentEntityBase</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.758.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.759.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.760.1">
namespace Drupal\mymodule\Entity;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.761.1">
use Drupal\Core\Entity\ContentEntityBase;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.762.1">
use Drupal\Core\Entity\EntityTypeInterface;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.763.1">
use Drupal\Core\Field\BaseFieldDefinition;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.764.1">
class Message extends ContentEntityBase {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.765.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.766.1">We extend </span><strong class="source-inline"><span class="koboSpan" id="kobo.767.1">ContentEntityBase</span></strong><span class="koboSpan" id="kobo.768.1">, which implements </span><strong class="source-inline"><span class="koboSpan" id="kobo.769.1">\Drupal\Core\Entity\ContentEntityInterface</span></strong><span class="koboSpan" id="kobo.770.1"> and satisfies all </span><span class="No-Break"><span class="koboSpan" id="kobo.771.1">required methods.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.772.1">Content entities do not define class properties for their values but instead rely on field definitions. </span><span class="koboSpan" id="kobo.772.2">We must define the base fields for our content </span><span class="No-Break"><span class="koboSpan" id="kobo.773.1">entity type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.774.1">
class Message extends ContentEntityBase {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.775.1">
  public static function baseFieldDefinitions</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.776.1">
     (EntityTypeInterface $entity_type) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.777.1">
    $fields = parent::baseFieldDefinitions</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.778.1">
       ($entity_type);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.779.1">
    $fields['title'] = BaseFieldDefinition</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.780.1">
        ::create('string')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.781.1">
      -&gt;setLabel(t('Title'))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.782.1">
      -&gt;setRequired(TRUE)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.783.1">
      -&gt;setDisplayOptions('form', [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.784.1">
        'type' =&gt; 'string_textfield',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.785.1">
      ])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.786.1">
      -&gt;setDisplayConfigurable('form', TRUE)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.787.1">
      -&gt;setDisplayOptions('view', [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.788.1">
        'label' =&gt; 'hidden',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.789.1">
        'type' =&gt; 'string',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.790.1">
      ])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.791.1">
      -&gt;setDisplayConfigurable('view', TRUE);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.792.1">
    $fields['content'] = BaseFieldDefinition</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.793.1">
        ::create('text_long')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.794.1">
      -&gt;setLabel(t('Content'))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.795.1">
      -&gt;setRequired(TRUE)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.796.1">
      -&gt;setDescription(t('Content of the message'))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.797.1">
      -&gt;setDisplayOptions('form', [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.798.1">
        'type' =&gt; 'text_textarea',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.799.1">
      ])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.800.1">
      -&gt;setDisplayConfigurable('form', TRUE)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.801.1">
      -&gt;setDisplayOptions('view', [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.802.1">
        'label' =&gt; 'hidden',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.803.1">
        'type' =&gt; 'text_default',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.804.1">
      ])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.805.1">
      -&gt;setDisplayConfigurable('view', TRUE);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.806.1">
    return $fields;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.807.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.808.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.809.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.810.1">baseFieldDefinitions</span></strong><span class="koboSpan" id="kobo.811.1"> method defines the fields the content entity has. </span><span class="koboSpan" id="kobo.811.2">It must return an array of field definitions, generated </span><span class="No-Break"><span class="koboSpan" id="kobo.812.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.813.1">BaseFieldDefinition</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.814.1">.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.815.1">Next, we will write the</span><a id="_idIndexMarker524"/><span class="koboSpan" id="kobo.816.1"> plugin annotation in a class documentation block for our content </span><span class="No-Break"><span class="koboSpan" id="kobo.817.1">entity type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.818.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.819.1">
 * Defines the message entity class.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.820.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.821.1">
 * @ContentEntityType(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.822.1">
 *   id = "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.823.1">
 *   label = @Translation("Message"),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.824.1">
 *   base_table = "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.825.1">
 *   entity_keys = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.826.1">
 *     "id" = "message_id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.827.1">
 *     "label" = "title",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.828.1">
 *     "uuid" = "uuid"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.829.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.830.1">
 *   admin_permission = "administer message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.831.1">
 *   field_ui_base_route =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.832.1">
        "entity.message.collection",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.833.1">
 * )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.834.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.835.1">
class Message extends ContentEntityBase {</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.836.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.837.1">@ContentEntityType</span></strong><span class="koboSpan" id="kobo.838.1"> symbol specifies that this is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.839.1">ContentEntityType</span></strong><span class="koboSpan" id="kobo.840.1"> annotation. </span><strong class="source-inline"><span class="koboSpan" id="kobo.841.1">id</span></strong><span class="koboSpan" id="kobo.842.1"> is the entity type ID, used to retrieve the entity type’s storage and other handlers. </span><strong class="source-inline"><span class="koboSpan" id="kobo.843.1">label</span></strong><span class="koboSpan" id="kobo.844.1"> is the human-readable name of the entity type. </span><strong class="source-inline"><span class="koboSpan" id="kobo.845.1">base_table</span></strong><span class="koboSpan" id="kobo.846.1"> is the database table name to be used for the entity type. </span><span class="koboSpan" id="kobo.846.2">The values in </span><strong class="source-inline"><span class="koboSpan" id="kobo.847.1">entity_keys</span></strong><span class="koboSpan" id="kobo.848.1"> instruct Drupal what the </span><strong class="source-inline"><span class="koboSpan" id="kobo.849.1">id</span></strong><span class="koboSpan" id="kobo.850.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.851.1">label</span></strong><span class="koboSpan" id="kobo.852.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.853.1">uuid</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.854.1">properties are.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.855.1">admin_permission</span></strong><span class="koboSpan" id="kobo.856.1"> specifies the permission name required to manage the entity type. </span><strong class="source-inline"><span class="koboSpan" id="kobo.857.1">field_ui_base_route</span></strong><span class="koboSpan" id="kobo.858.1"> contains a route name that the </span><strong class="bold"><span class="koboSpan" id="kobo.859.1">Field UI</span></strong><span class="koboSpan" id="kobo.860.1"> will </span><a id="_idIndexMarker525"/><span class="koboSpan" id="kobo.861.1">use to provide field </span><span class="No-Break"><span class="koboSpan" id="kobo.862.1">management interfaces.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.863.1">Next, we will add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.864.1">handlers</span></strong><span class="koboSpan" id="kobo.865.1"> key to </span><span class="No-Break"><span class="koboSpan" id="kobo.866.1">our annotation:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.867.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.868.1">
 * Defines the message entity class.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.869.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.870.1">
 * @ContentEntityType(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.871.1">
 *   id = "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.872.1">
 *   label = @Translation("Message"),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.873.1">
 *   base_table = "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.874.1">
 *   entity_keys = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.875.1">
 *     "id" = "message_id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.876.1">
 *     "label" = "title",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.877.1">
 *     "uuid" = "uuid"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.878.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.879.1">
 *   admin_permission = "administer message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.880.1">
 *   field_ui_base_route =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.881.1">
        "entity.message.collection",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.882.1">
 *   handlers = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.883.1">
 *     "list_builder" = "Drupal\mymodule\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.884.1">
            MessageListBuilder",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.885.1">
 *     "form" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.886.1">
 *       "default" = "Drupal\mymodule\MessageForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.887.1">
 *       "delete" = "Drupal\Core\Entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.888.1">
            ContentEntityDeleteForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.889.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.890.1">
 *     "route_provider" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.891.1">
 *       "html" = "Drupal\Core\Entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.892.1">
            Routing\DefaultHtmlRouteProvider",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.893.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.894.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.895.1">
 * )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.896.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.897.1">
class Message extends ContentEntityBase {</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.898.1">The handlers array</span><a id="_idIndexMarker526"/><span class="koboSpan" id="kobo.899.1"> specifies classes that provide the functionality for Drupal to interact with our entity type. </span><span class="koboSpan" id="kobo.899.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.900.1">list_builder</span></strong><span class="koboSpan" id="kobo.901.1"> class, which we will create, is used to show a table of entities for our entity type. </span><span class="koboSpan" id="kobo.901.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.902.1">form</span></strong><span class="koboSpan" id="kobo.903.1"> handlers specify the form classes to be used when creating, editing, or deleting an entity. </span><span class="koboSpan" id="kobo.903.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.904.1">route_provider</span></strong><span class="koboSpan" id="kobo.905.1"> handler is an array of handlers that will generate routes for our </span><span class="No-Break"><span class="koboSpan" id="kobo.906.1">entity type.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.907.1">For our entity type’s annotation, we will provide link templates that </span><strong class="source-inline"><span class="koboSpan" id="kobo.908.1">route_provider</span></strong><span class="koboSpan" id="kobo.909.1"> will use </span><a id="_idIndexMarker527"/><span class="koboSpan" id="kobo.910.1">to build routes for our </span><span class="No-Break"><span class="koboSpan" id="kobo.911.1">entity type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.912.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.913.1">
 * Defines the message entity class.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.914.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.915.1">
 * @ContentEntityType(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.916.1">
 *   id = "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.917.1">
 *   label = @Translation("Message"),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.918.1">
 *   base_table = "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.919.1">
 *   entity_keys = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.920.1">
 *     "id" = "message_id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.921.1">
 *     "label" = "title",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.922.1">
 *     "uuid" = "uuid"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.923.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.924.1">
 *   admin_permission = "administer message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.925.1">
 *   field_ui_base_route =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.926.1">
        "entity.message.collection",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.927.1">
 *   handlers = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.928.1">
 *     "list_builder" = "Drupal\mymodule</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.929.1">
            \MessageListBuilder",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.930.1">
 *     "form" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.931.1">
 *       "default" = "Drupal\mymodule\MessageForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.932.1">
 *       "delete" = "Drupal\Core\Entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.933.1">
            ContentEntityDeleteForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.934.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.935.1">
 *     "route_provider" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.936.1">
 *       "html" = "Drupal\Core\Entity\Routing</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.937.1">
            \DefaultHtmlRouteProvider",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.938.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.939.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.940.1">
 *   links = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.941.1">
 *     "canonical" = "/messages/{message}",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.942.1">
 *     "add-form" = "/messages/add",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.943.1">
 *     "edit-form" = "/messages/{message}/edit",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.944.1">
 *     "delete-form" = "/messages/{message}/delete",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.945.1">
 *     "collection" = "/admin/structure/messages"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.946.1">
 * },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.947.1">
 * )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.948.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.949.1">
class Message extends ContentEntityBase {</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.950.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.951.1">links</span></strong><span class="koboSpan" id="kobo.952.1"> array</span><a id="_idIndexMarker528"/><span class="koboSpan" id="kobo.953.1"> defines keys expected from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.954.1">html</span></strong><span class="koboSpan" id="kobo.955.1"> route provider, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.956.1">collection</span></strong><span class="koboSpan" id="kobo.957.1"> (list), </span><strong class="source-inline"><span class="koboSpan" id="kobo.958.1">add-form</span></strong><span class="koboSpan" id="kobo.959.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.960.1">delete-form</span></strong><span class="koboSpan" id="kobo.961.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.962.1">edit-form</span></strong><span class="koboSpan" id="kobo.963.1">. </span><span class="koboSpan" id="kobo.963.2">The route provider will generate routes for the </span><span class="No-Break"><span class="koboSpan" id="kobo.964.1">given paths.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.965.1">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.966.1">MessageListBuilder</span></strong><span class="koboSpan" id="kobo.967.1"> class defined in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.968.1">list_builder</span></strong><span class="koboSpan" id="kobo.969.1"> handler by creating a </span><strong class="source-inline"><span class="koboSpan" id="kobo.970.1">MessageListBuilder.php</span></strong><span class="koboSpan" id="kobo.971.1"> file in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.972.1">src</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.973.1"> directory:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.974.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.975.1">
namespace Drupal\mymodule;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.976.1">
use Drupal\Core\Entity\EntityInterface;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.977.1">
use Drupal\Core\Entity\EntityListBuilder;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.978.1">
class MessageListBuilder extends EntityListBuilder {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.979.1">
  public function buildHeader() {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.980.1">
    $header['title'] = $this-&gt;t('Title');</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.981.1">
    return $header + parent::buildHeader();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.982.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.983.1">
  public function buildRow(EntityInterface $entity) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.984.1">
    $row['title'] = $entity-&gt;toLink();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.985.1">
    return $row + parent::buildRow($entity);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.986.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.987.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.988.1">Our </span><strong class="source-inline"><span class="koboSpan" id="kobo.989.1">MessageListBuilder</span></strong><span class="koboSpan" id="kobo.990.1"> class extends </span><strong class="source-inline"><span class="koboSpan" id="kobo.991.1">\Drupal\Core\Entity\EntityListBuilder</span></strong><span class="koboSpan" id="kobo.992.1">, which provides all the required</span><a id="_idIndexMarker529"/><span class="koboSpan" id="kobo.993.1"> methods to build our table of entities. </span><span class="koboSpan" id="kobo.993.2">We override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.994.1">builderHeader</span></strong><span class="koboSpan" id="kobo.995.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.996.1">buildRow</span></strong><span class="koboSpan" id="kobo.997.1"> methods to ensure entity labels are displayed and linked to view </span><span class="No-Break"><span class="koboSpan" id="kobo.998.1">the entity.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.999.1">Now, we will create the entity form that is used for creating and editing our entity type. </span><span class="koboSpan" id="kobo.999.2">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1000.1">MessageForm</span></strong><span class="koboSpan" id="kobo.1001.1"> class defined as the default form handler by creating a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1002.1">MessageForm.php</span></strong><span class="koboSpan" id="kobo.1003.1"> file in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1004.1">src</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1005.1"> directory:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1006.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1007.1">
namespace Drupal\mymodule;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1008.1">
use Drupal\Core\Entity\ContentEntityForm;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1009.1">
use Drupal\Core\Form\FormStateInterface;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1010.1">
class MessageForm extends ContentEntityForm {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1011.1">
  public function save(array $form, FormStateInterface</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1012.1">
    $form_state) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1013.1">
    $result = parent::save($form, $form_state);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1014.1">
    if ($result === SAVED_NEW) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1015.1">
      $this-&gt;messenger()-&gt;addMessage('The message has</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1016.1">
        been created.');</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1017.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1018.1">
    else {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1019.1">
      $this-&gt;messenger()-&gt;addMessage('The message has</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1020.1">
        been updated.');</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1021.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1022.1">
    $form_state-&gt;setRedirectUrl($this-&gt;entity-&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1023.1">
        toUrl('collection'));</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1024.1">
    return $result;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1025.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1026.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1027.1">We override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1028.1">save</span></strong><span class="koboSpan" id="kobo.1029.1"> method to provide messages about the changes that have been made. </span><span class="koboSpan" id="kobo.1029.2">We ensure the user is redirected back to the collection page for the entity. </span><span class="koboSpan" id="kobo.1029.3">All other processing of field values is handled in the base </span><span class="No-Break"><span class="koboSpan" id="kobo.1030.1">form class.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1031.1">To make our messages accessible from the administrative area on the </span><strong class="bold"><span class="koboSpan" id="kobo.1032.1">Structure</span></strong><span class="koboSpan" id="kobo.1033.1"> page, we need to define a menu link. </span><span class="koboSpan" id="kobo.1033.2">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1034.1">mymodule.links.menu.yml</span></strong><span class="koboSpan" id="kobo.1035.1"> file and add </span><span class="No-Break"><span class="koboSpan" id="kobo.1036.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1037.1">
mymodule.messages:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1038.1">
  title: 'Messages'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1039.1">
  parent: system.admin_structure</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1040.1">
  description: 'Manage messages.'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1041.1">
  route_name: entity.message.collection</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1042.1">This registers a menu</span><a id="_idIndexMarker530"/><span class="koboSpan" id="kobo.1043.1"> link for the specified </span><strong class="source-inline"><span class="koboSpan" id="kobo.1044.1">route_name</span></strong><span class="koboSpan" id="kobo.1045.1"> under the </span><span class="No-Break"><span class="koboSpan" id="kobo.1046.1">specified </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1047.1">parent</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1048.1">.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.1049.1">Next, we will define an action link. </span><span class="koboSpan" id="kobo.1049.2">In Drupal, action links are buttons on pages generally used to bring the user to a form. </span><span class="koboSpan" id="kobo.1049.3">Our action link will add an </span><strong class="bold"><span class="koboSpan" id="kobo.1050.1">Add message</span></strong><span class="koboSpan" id="kobo.1051.1"> link from the collection route. </span><span class="koboSpan" id="kobo.1051.2">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1052.1">mymodule.links.action.yml</span></strong><span class="koboSpan" id="kobo.1053.1"> file and add </span><span class="No-Break"><span class="koboSpan" id="kobo.1054.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1055.1">
message.add:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1056.1">
  route_name: entity.message.add_form</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1057.1">
  title: 'Add message'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1058.1">
  appears_on:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1059.1">
    - entity.message.collection</span></pre></li>
</ol>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1060.1">route_name</span></strong><span class="koboSpan" id="kobo.1061.1"> matches the route name generated by our route provider for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1062.1">add-form</span></strong><span class="koboSpan" id="kobo.1063.1"> link. </span><span class="koboSpan" id="kobo.1063.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1064.1">appears_on</span></strong><span class="koboSpan" id="kobo.1065.1"> array specifies what routes the action link should </span><span class="No-Break"><span class="koboSpan" id="kobo.1066.1">render on.</span></span></p>
<ol>
<li value="12"><span class="koboSpan" id="kobo.1067.1">To display the field management tabs from the </span><strong class="bold"><span class="koboSpan" id="kobo.1068.1">Field UI</span></strong><span class="koboSpan" id="kobo.1069.1">, we must create </span><strong class="source-inline"><span class="koboSpan" id="kobo.1070.1">mymodule.links.task.yml</span></strong><span class="koboSpan" id="kobo.1071.1"> to register our route entity collection route as the </span><span class="No-Break"><span class="koboSpan" id="kobo.1072.1">root task:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1073.1">
entity.message.collection_tab:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1074.1">
  route_name: entity.message.collection</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1075.1">
  base_route: system.admin_content</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1076.1">
  title: 'Messages'</span></pre></li>
<li><span class="koboSpan" id="kobo.1077.1">Before installing the module, we must define the permission specified in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1078.1">admin_permission</span></strong><span class="koboSpan" id="kobo.1079.1">. </span><span class="koboSpan" id="kobo.1079.2">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1080.1">mymodule.permissions.yml</span></strong><span class="koboSpan" id="kobo.1081.1"> file and add </span><span class="No-Break"><span class="koboSpan" id="kobo.1082.1">the </span></span><span class="No-Break"><a id="_idIndexMarker531"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1083.1">following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1084.1">
administer message:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1085.1">
  title: 'Administer messages'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1086.1">Defining the permission in the entity type’s annotation does not register it as a permission with </span><span class="No-Break"><span class="koboSpan" id="kobo.1087.1">Drupal automatically.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.1088.1">Install the module. </span><span class="koboSpan" id="kobo.1088.2">On the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1089.1">Structure</span></strong><span class="koboSpan" id="kobo.1090.1"> page, you will now see </span><strong class="source-inline"><span class="koboSpan" id="kobo.1091.1">Messages</span></strong><span class="koboSpan" id="kobo.1092.1">, which allows you to create message </span><span class="No-Break"><span class="koboSpan" id="kobo.1093.1">content entities.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer057">
<span class="koboSpan" id="kobo.1094.1"><img alt="Figure 9.3 – Messages collection, with field management tabs" src="image/Figure_9.03_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1095.1">Figure 9.3 – Messages collection, with field management tabs</span></p>
<h2 id="_idParaDest-277"><a id="_idTextAnchor306"/><span class="koboSpan" id="kobo.1096.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.1097.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1098.1">ContentEntityType</span></strong><span class="koboSpan" id="kobo.1099.1"> plugin type’s class is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1100.1">\Drupal\Core\Entity\ContentEntityType</span></strong><span class="koboSpan" id="kobo.1101.1">. </span><span class="koboSpan" id="kobo.1101.2">This class sets up the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1102.1">storage</span></strong><span class="koboSpan" id="kobo.1103.1"> handler to be </span><strong class="source-inline"><span class="koboSpan" id="kobo.1104.1">\Drupal\Core\Entity\Sql\SqlContentEntityStorage</span></strong><span class="koboSpan" id="kobo.1105.1">, which controls </span><a id="_idIndexMarker532"/><span class="koboSpan" id="kobo.1106.1">storing the entity in the database. </span><span class="koboSpan" id="kobo.1106.2">It also specifies a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1107.1">view_builder</span></strong><span class="koboSpan" id="kobo.1108.1"> handler, which is used to render entities, to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1109.1">\</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1110.1">Drupal\Core\Entity\EntityViewBuilder</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1111.1"> class.</span></span></p>
<p><span class="koboSpan" id="kobo.1112.1">Entity types are expected to define permission for administration, via the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1113.1">admin_permission</span></strong><span class="koboSpan" id="kobo.1114.1"> annotation value. </span><span class="koboSpan" id="kobo.1114.2">The de facto pattern is to use the word </span><strong class="source-inline"><span class="koboSpan" id="kobo.1115.1">administer</span></strong><span class="koboSpan" id="kobo.1116.1"> and then the entity type ID. </span><span class="koboSpan" id="kobo.1116.2">That is why our permission name is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1117.1">administer announcement</span></strong><span class="koboSpan" id="kobo.1118.1"> and not </span><strong class="source-inline"><span class="koboSpan" id="kobo.1119.1">administer announcements</span></strong><span class="koboSpan" id="kobo.1120.1">. </span><span class="koboSpan" id="kobo.1120.2">More about entity type permissions and access is covered in the </span><em class="italic"><span class="koboSpan" id="kobo.1121.1">Implementing access control for an </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1122.1">entity</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1123.1"> recipe.</span></span></p>
<p><span class="koboSpan" id="kobo.1124.1">When defining base field definitions, their view and form display mode configuration is defined in code. </span><span class="koboSpan" id="kobo.1124.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1125.1">setDisplayOptions</span></strong><span class="koboSpan" id="kobo.1126.1"> method provides the default display options that should be used for the field. </span><span class="koboSpan" id="kobo.1126.2">Calling </span><strong class="source-inline"><span class="koboSpan" id="kobo.1127.1">setDisplayConfigurable</span></strong><span class="koboSpan" id="kobo.1128.1"> with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1129.1">TRUE</span></strong><span class="koboSpan" id="kobo.1130.1"> allows controlling the field with the </span><strong class="bold"><span class="koboSpan" id="kobo.1131.1">Field UI</span></strong><span class="koboSpan" id="kobo.1132.1"> interface for managing view and form </span><span class="No-Break"><span class="koboSpan" id="kobo.1133.1">display modes.</span></span></p>
<h2 id="_idParaDest-278"><a id="_idTextAnchor307"/><span class="koboSpan" id="kobo.1134.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.1135.1">We will discuss </span><a id="_idIndexMarker533"/><span class="koboSpan" id="kobo.1136.1">how to add additional functionality to our </span><span class="No-Break"><span class="koboSpan" id="kobo.1137.1">content entity.</span></span></p>
<h3><span class="koboSpan" id="kobo.1138.1">Registering a content entity for an installed module</span></h3>
<p><span class="koboSpan" id="kobo.1139.1">When a</span><a id="_idIndexMarker534"/><span class="koboSpan" id="kobo.1140.1"> module is first installed, Drupal will also install the entity type. </span><span class="koboSpan" id="kobo.1140.2">If a module is already installed, we need to use the entity definition update manager to do so. </span><span class="koboSpan" id="kobo.1140.3">This is accomplished by writing an update hook in the module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1141.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1142.1">install</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1143.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.1144.1">The following update hook would install the message entity type on a Drupal site that already has the providing </span><span class="No-Break"><span class="koboSpan" id="kobo.1145.1">module installed:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1146.1">
function mymodule_update_10001() {
  /** @var \Drupal\Core\Entity\
        EntityDefinitionUpdateManager $edum */
  $edum = \Drupal::service
     ('entity.definition_update_manager');
  $definition = $edum-&gt;getEntityType('message');
  $edum-&gt;installEntityType($definition);
}</span></pre>
<p><span class="koboSpan" id="kobo.1147.1">The entity definition update manager allows retrieving entity type definitions that have not yet been installed with its </span><strong class="source-inline"><span class="koboSpan" id="kobo.1148.1">getEntityType</span></strong><span class="koboSpan" id="kobo.1149.1"> method. </span><span class="koboSpan" id="kobo.1149.2">This definition must then be passed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1150.1">installEntityType</span></strong><span class="koboSpan" id="kobo.1151.1"> to properly install the new </span><span class="No-Break"><span class="koboSpan" id="kobo.1152.1">entity type.</span></span></p>
<h3><span class="koboSpan" id="kobo.1153.1">Generating configuration entity types with Drush</span></h3>
<p><span class="koboSpan" id="kobo.1154.1">Drush provides </span><a id="_idIndexMarker535"/><span class="koboSpan" id="kobo.1155.1">code-generation tools to automate the steps taken in this chapter. </span><span class="koboSpan" id="kobo.1155.2">The following command will begin the </span><span class="No-Break"><span class="koboSpan" id="kobo.1156.1">code-generation process:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1157.1">
php vendor/bin/drush generate entity:content</span></pre>
<p><span class="koboSpan" id="kobo.1158.1">The command will prompt for a module name that should provide the entity type, the entity types label, and its ID. </span><span class="koboSpan" id="kobo.1158.2">It allows configuring the entity type to be translatable and support revisions, discussed in the following sections. </span><span class="koboSpan" id="kobo.1158.3">The code generated will differ from what’s </span><a id="_idIndexMarker536"/><span class="koboSpan" id="kobo.1159.1">described in this recipe as the code generation </span><span class="No-Break"><span class="koboSpan" id="kobo.1160.1">is improved.</span></span></p>
<h3><span class="koboSpan" id="kobo.1161.1">Tabs for View, Edit, and Delete</span></h3>
<p><span class="koboSpan" id="kobo.1162.1">When </span><a id="_idIndexMarker537"/><span class="koboSpan" id="kobo.1163.1">editing</span><a id="_idIndexMarker538"/><span class="koboSpan" id="kobo.1164.1"> content, you may have</span><a id="_idIndexMarker539"/><span class="koboSpan" id="kobo.1165.1"> used the </span><strong class="bold"><span class="koboSpan" id="kobo.1166.1">View</span></strong><span class="koboSpan" id="kobo.1167.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1168.1">Edit</span></strong><span class="koboSpan" id="kobo.1169.1">, or </span><strong class="bold"><span class="koboSpan" id="kobo.1170.1">Delete</span></strong><span class="koboSpan" id="kobo.1171.1"> tabs. </span><span class="koboSpan" id="kobo.1171.2">These are defined in a module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1172.1">links.task.yml</span></strong><span class="koboSpan" id="kobo.1173.1">, like the one defined to enable the </span><strong class="bold"><span class="koboSpan" id="kobo.1174.1">Field UI</span></strong><span class="koboSpan" id="kobo.1175.1"> in this recipe. </span><span class="koboSpan" id="kobo.1175.2">The following definitions will add the same tabs to the content entity type defined in </span><span class="No-Break"><span class="koboSpan" id="kobo.1176.1">this recipe:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1177.1">
entity.message.canonical:
  route_name: entity.message.canonical
  base_route: entity.message.canonical
  title: 'View'
entity.message.edit_form:
  route_name: entity.message.edit_form
  base_route: entity.message.canonical
  title: Edit
entity.message.delete_form:
  route_name: entity.message.delete_form
  base_route: entity.message.canonical
  title: Delete
  weight: 10</span></pre>
<h3><span class="koboSpan" id="kobo.1178.1">Allowing a content entity type to be translatable</span></h3>
<p><span class="koboSpan" id="kobo.1179.1">One of </span><a id="_idIndexMarker540"/><span class="koboSpan" id="kobo.1180.1">Drupal’s major features is its ability to handle multilingual content, as we’ll cover in </span><a href="B18548_11.xhtml#_idTextAnchor354"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1181.1">Chapter 11</span></em></span></a><span class="koboSpan" id="kobo.1182.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1183.1">Multilingual and Internationalization</span></em><span class="koboSpan" id="kobo.1184.1">. </span><span class="koboSpan" id="kobo.1184.2">For a content entity to be translatable, it must provide a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1185.1">langcode</span></strong><span class="koboSpan" id="kobo.1186.1"> entity key and mark its base fields as </span><span class="No-Break"><span class="koboSpan" id="kobo.1187.1">being translatable.</span></span></p>
<p><span class="koboSpan" id="kobo.1188.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1189.1">Message</span></strong><span class="koboSpan" id="kobo.1190.1"> entity’s updated </span><strong class="source-inline"><span class="koboSpan" id="kobo.1191.1">entity_keys</span></strong><span class="koboSpan" id="kobo.1192.1"> annotation would look like </span><span class="No-Break"><span class="koboSpan" id="kobo.1193.1">the following:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1194.1">*   entity_keys = {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1195.1">*     "id" = "message_id",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1196.1">*     "label" = "title",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1197.1">*     "uuid" = "uuid",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1198.1">*     "langcode" = "langcode",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1199.1">*   </span></strong><strong class="bold"><span class="koboSpan" id="kobo.1200.1">},</span></strong></pre>
<p><span class="koboSpan" id="kobo.1201.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1202.1">ContentEntityBase</span></strong><span class="koboSpan" id="kobo.1203.1"> class will check whether this </span><strong class="source-inline"><span class="koboSpan" id="kobo.1204.1">langcode</span></strong><span class="koboSpan" id="kobo.1205.1"> entity key exists and automatically generate a </span><span class="No-Break"><span class="koboSpan" id="kobo.1206.1">language field.</span></span></p>
<p><span class="koboSpan" id="kobo.1207.1">By default, fields are not translatable. </span><span class="koboSpan" id="kobo.1207.2">To mark a field as being translatable, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1208.1">setTranslatable</span></strong><span class="koboSpan" id="kobo.1209.1"> method on the field definition object must be called. </span><span class="koboSpan" id="kobo.1209.2">The following code </span><a id="_idIndexMarker541"/><span class="koboSpan" id="kobo.1210.1">makes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1211.1">title</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1212.1">field translatable:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1213.1">
$fields['title'] = BaseFieldDefinition::</span><strong class="bold"><span class="koboSpan" id="kobo.1214.1">create</span></strong><span class="koboSpan" id="kobo.1215.1">('string')
  -&gt;setLabel(t('Title'))
  -&gt;setRequired(TRUE)
</span><strong class="bold"><span class="koboSpan" id="kobo.1216.1">  -&gt;setTranslatable(TRUE)</span></strong></pre>
<h3><span class="koboSpan" id="kobo.1217.1">Allowing a content entity type to support revisions</span></h3>
<p><span class="koboSpan" id="kobo.1218.1">Drupal has </span><a id="_idIndexMarker542"/><span class="koboSpan" id="kobo.1219.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1220.1">Content Moderation and Workspaces</span></strong><span class="koboSpan" id="kobo.1221.1"> module to provide advanced content management workflows using revisions, as we covered in </span><a href="B18548_03.xhtml#_idTextAnchor101"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1222.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.1223.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1224.1">Displaying Content through Views</span></em><span class="koboSpan" id="kobo.1225.1">. </span><span class="koboSpan" id="kobo.1225.2">For a content entity to support revisions, it must provide additional information in its entity type annotation and mark base fields as </span><span class="No-Break"><span class="koboSpan" id="kobo.1226.1">supporting revisions.</span></span></p>
<p><span class="koboSpan" id="kobo.1227.1">Content entity types that support revisions must define </span><strong class="source-inline"><span class="koboSpan" id="kobo.1228.1">revision_table</span></strong><span class="koboSpan" id="kobo.1229.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1230.1">revision_metadata_keys</span></strong><span class="koboSpan" id="kobo.1231.1">. </span><span class="koboSpan" id="kobo.1231.2">These are similar to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1232.1">base_table</span></strong><span class="koboSpan" id="kobo.1233.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1234.1">entity_keys</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1235.1">, respectively:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1236.1">*   revision_table = "message_revision",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1237.1">*   show_revision_ui = TRUE,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1238.1">*   revision_metadata_keys = {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1239.1">*     "revision_user" = "revision_uid",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1240.1">*</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1241.1">     "revision_created" = "revision_timestamp",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1242.1">*     "revision_log_message" = "revision_log"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1243.1">*   },</span></strong></pre>
<p><span class="koboSpan" id="kobo.1244.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1245.1">show_revision_ui</span></strong><span class="koboSpan" id="kobo.1246.1"> key controls whether the entity form displays the revision log whenever modifying </span><span class="No-Break"><span class="koboSpan" id="kobo.1247.1">an entity.</span></span></p>
<p><span class="koboSpan" id="kobo.1248.1">The content entity type must implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.1249.1">\Drupal\Core\Entity\RevisionLogInterface</span></strong><span class="koboSpan" id="kobo.1250.1"> and can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1251.1">\Drupal\Core\Entity\RevisionLogEntityTrait</span></strong><span class="koboSpan" id="kobo.1252.1"> trait to automatically create the </span><a id="_idIndexMarker543"/><span class="koboSpan" id="kobo.1253.1">required base fields and methods for </span><span class="No-Break"><span class="koboSpan" id="kobo.1254.1">revision support:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1255.1">
class Message extends ContentEntityBase {
  use RevisionLogEntityTrait</span><strong class="bold"><span class="koboSpan" id="kobo.1256.1">;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1257.1">  </span></strong><span class="koboSpan" id="kobo.1258.1">public static function baseFieldDefinitions
     (EntityTypeInterface $entity_type) {
    $fields = parent::</span><strong class="bold"><span class="koboSpan" id="kobo.1259.1">baseFieldDefinitions</span></strong><span class="koboSpan" id="kobo.1260.1">($entity_type)</span><strong class="bold"><span class="koboSpan" id="kobo.1261.1">;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1262.1">    </span></strong><span class="koboSpan" id="kobo.1263.1">// Add the revision metadata fields.
</span><span class="koboSpan" id="kobo.1263.2">    $fields += static::</span><strong class="bold"><span class="koboSpan" id="kobo.1264.1">revisionLogBaseFieldDefinitions</span></strong><span class="koboSpan" id="kobo.1265.1">
         ($entity_type)</span><strong class="bold"><span class="koboSpan" id="kobo.1266.1">;</span></strong></pre>
<p><span class="koboSpan" id="kobo.1267.1">Finally, fields must be flagged as </span><span class="No-Break"><span class="koboSpan" id="kobo.1268.1">supporting revisions:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1269.1">
$fields['title'] = BaseFieldDefinition::</span><strong class="bold"><span class="koboSpan" id="kobo.1270.1">create</span></strong><span class="koboSpan" id="kobo.1271.1">('string')
  -&gt;setLabel(t('Title'))
  -&gt;setRequired(TRUE)
</span><strong class="bold"><span class="koboSpan" id="kobo.1272.1">  -&gt;setRevisionable(TRUE)</span></strong></pre>
<h1 id="_idParaDest-279"><a id="_idTextAnchor308"/><span class="koboSpan" id="kobo.1273.1">Creating a bundle for a content entity type</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.1274.1">Bundles</span></strong><span class="koboSpan" id="kobo.1275.1"> allow</span><a id="_idIndexMarker544"/><span class="koboSpan" id="kobo.1276.1"> you to have different variations</span><a id="_idIndexMarker545"/><span class="koboSpan" id="kobo.1277.1"> of a content entity. </span><span class="koboSpan" id="kobo.1277.2">All bundles share the same base field definitions but not configured fields. </span><span class="koboSpan" id="kobo.1277.3">This allows each bundle to have its own custom fields. </span><span class="koboSpan" id="kobo.1277.4">Display modes are also dependent on a specific bundle. </span><span class="koboSpan" id="kobo.1277.5">This allows each bundle to have its own configuration for the form mode and </span><span class="No-Break"><span class="koboSpan" id="kobo.1278.1">view mode.</span></span></p>
<p><span class="koboSpan" id="kobo.1279.1">Using the custom entity from the preceding recipe, we will add a configuration entity to act as the bundle. </span><span class="koboSpan" id="kobo.1279.2">This will allow you to have different message types for multiple custom </span><span class="No-Break"><span class="koboSpan" id="kobo.1280.1">field configurations.</span></span></p>
<h2 id="_idParaDest-280"><a id="_idTextAnchor309"/><span class="koboSpan" id="kobo.1281.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.1282.1">Create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1283.1">MessageType.php</span></strong><span class="koboSpan" id="kobo.1284.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1285.1">src/Entity</span></strong><span class="koboSpan" id="kobo.1286.1"> directory so that we can define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1287.1">MessageType</span></strong><span class="koboSpan" id="kobo.1288.1"> class for our configuration entity type that will provide bundles for our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1289.1">Message</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1290.1"> entity.</span></span></li>
<li><span class="koboSpan" id="kobo.1291.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1292.1">MessageType</span></strong><span class="koboSpan" id="kobo.1293.1"> class will extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1294.1">\Drupal\Core\Config\Entity\ConfigEntityBundleBase</span></strong><span class="koboSpan" id="kobo.1295.1"> class and define our entity </span><span class="No-Break"><span class="koboSpan" id="kobo.1296.1">type’s properties:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1297.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1298.1">
namespace Drupal\mymodule\Entity;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1299.1">
use Drupal\Core\Config\Entity\ConfigEntityBundleBase;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1300.1">
class MessageType extends ConfigEntityBundleBase {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1301.1">
  public string $label = '';</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1302.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1303.1">We extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1304.1">ConfigEntityBundleBase</span></strong><span class="koboSpan" id="kobo.1305.1"> class. </span><span class="koboSpan" id="kobo.1305.2">This is a class that extends </span><strong class="source-inline"><span class="koboSpan" id="kobo.1306.1">ConfigEntityBase</span></strong><span class="koboSpan" id="kobo.1307.1"> and provides various enhancements for configuration entity types that are used to provide bundles for a content entity type. </span><span class="koboSpan" id="kobo.1307.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1308.1">label</span></strong><span class="koboSpan" id="kobo.1309.1"> property will contain the label of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1310.1">message type.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1311.1">Next, we will</span><a id="_idIndexMarker546"/><span class="koboSpan" id="kobo.1312.1"> write</span><a id="_idIndexMarker547"/><span class="koboSpan" id="kobo.1313.1"> the plugin annotation in a class documentation block for our </span><span class="No-Break"><span class="koboSpan" id="kobo.1314.1">entity type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1315.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1316.1">
 * @ConfigEntityType(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1317.1">
 *   id = "message_type",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1318.1">
 *   label = "Message type",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1319.1">
 *   config_prefix = "message_type",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1320.1">
 *   bundle_of = "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1321.1">
 *   entity_keys = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1322.1">
 *     "id" = "id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1323.1">
 *     "label" = "label"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1324.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1325.1">
 *   config_export = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1326.1">
 *     "id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1327.1">
 *     "label",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1328.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1329.1">
 *   admin_permission = "administer message_type",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1330.1">
*/</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1331.1">
class MessageType extends ConfigEntityBundleBase {</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1332.1">The annotation definition is just like other configuration entities, except for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1333.1">bundle_of</span></strong><span class="koboSpan" id="kobo.1334.1"> key. </span><span class="koboSpan" id="kobo.1334.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1335.1">bundle_of</span></strong><span class="koboSpan" id="kobo.1336.1"> key defines the entity type that this configuration entity type provides bundles for and denotes this as a bundle configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.1337.1">entity type.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1338.1">Next, we </span><a id="_idIndexMarker548"/><span class="koboSpan" id="kobo.1339.1">will </span><a id="_idIndexMarker549"/><span class="koboSpan" id="kobo.1340.1">add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1341.1">handlers</span></strong><span class="koboSpan" id="kobo.1342.1"> key to </span><span class="No-Break"><span class="koboSpan" id="kobo.1343.1">our annotation:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1344.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1345.1">
 * @ConfigEntityType(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1346.1">
 *   id = "message_type",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1347.1">
 *   label = @Translation("Message type"),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1348.1">
 *   config_prefix = "message_type",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1349.1">
 *   bundle_of = "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1350.1">
 *   entity_keys = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1351.1">
 *     "id" = "id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1352.1">
 *     "label" = "label"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1353.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1354.1">
 *   config_export = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1355.1">
 *     "id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1356.1">
 *     "label",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1357.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1358.1">
 *   admin_permission = "administer message_type",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1359.1">
 *   handlers = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1360.1">
 *     "list_builder" = "Drupal\mymodule\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1361.1">
         MessageTypeListBuilder",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1362.1">
 *     "form" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1363.1">
 *       "default" = "Drupal\mymodule</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1364.1">
            \MessageTypeForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1365.1">
 *       "delete" = "Drupal\Core\Entity</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1366.1">
            \EntityDeleteForm"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1367.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1368.1">
 *     "route_provider" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1369.1">
 *       "html" = "Drupal\Core\Entity\Routing</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1370.1">
            \AdminHtmlRouteProvider",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1371.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1372.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1373.1">
 * )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1374.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1375.1">
class MessageType extends ConfigEntityBundleBase {</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1376.1">We define the entity type’s handlers just as we did in the </span><em class="italic"><span class="koboSpan" id="kobo.1377.1">Creating a configuration entity type</span></em><span class="koboSpan" id="kobo.1378.1"> recipe, but with our specific </span><strong class="source-inline"><span class="koboSpan" id="kobo.1379.1">form</span></strong><span class="koboSpan" id="kobo.1380.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1381.1">list_builder</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1382.1"> handlers.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1383.1">Lastly, for our entity </span><a id="_idIndexMarker550"/><span class="koboSpan" id="kobo.1384.1">type’s </span><a id="_idIndexMarker551"/><span class="koboSpan" id="kobo.1385.1">annotation, we will provide link templates that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1386.1">route_provider</span></strong><span class="koboSpan" id="kobo.1387.1"> will use to build routes for the </span><span class="No-Break"><span class="koboSpan" id="kobo.1388.1">entity type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1389.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1390.1">
 * @ConfigEntityType(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1391.1">
 *   id = "message_type",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1392.1">
 *   label = @Translation("Message type"),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1393.1">
 *   config_prefix = "message_type",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1394.1">
 *   bundle_of = "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1395.1">
 *   entity_keys = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1396.1">
 *     "id" = "id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1397.1">
 *     "label" = "label"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1398.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1399.1">
 *   config_export = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1400.1">
 *     "id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1401.1">
 *     "label",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1402.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1403.1">
 *   admin_permission = "administer message_type",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1404.1">
 *   handlers = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1405.1">
 *     "list_builder" = "Drupal\mymodule\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1406.1">
        MessageTypeListBuilder",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1407.1">
 *     "form" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1408.1">
 *       "default" = "Drupal\mymodule\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1409.1">
            MessageTypeForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1410.1">
 *       "delete" = "Drupal\Core\Entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1411.1">
            EntityDeleteForm"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1412.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1413.1">
 *     "route_provider" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1414.1">
 *       "html" = "Drupal\Core\Entity\Routing</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1415.1">
            \AdminHtmlRouteProvider",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1416.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1417.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1418.1">
 *   links = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1419.1">
 *     "collection" = "/admin/structure/message-</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1420.1">
        types",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1421.1">
 *     "add-form" = "/admin/structure/message-</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1422.1">
          types/add",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1423.1">
 *     "delete-form" = "/admin/structure/message-</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1424.1">
          types/{message_type}/delete",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1425.1">
 *     "edit-form" = "/admin/structure/message-</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1426.1">
          types/{message_type}/edit",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1427.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1428.1">
 * )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1429.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1430.1">
class MessageType extends ConfigEntityBundleBase {</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1431.1">This defines routes for our entity </span><span class="No-Break"><span class="koboSpan" id="kobo.1432.1">at </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1433.1">/admin/structure/message-types</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1434.1">.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1435.1">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1436.1">MessageTypeListBuilder</span></strong><span class="koboSpan" id="kobo.1437.1"> class defined in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1438.1">list_builder</span></strong><span class="koboSpan" id="kobo.1439.1"> handler</span><a id="_idIndexMarker552"/><span class="koboSpan" id="kobo.1440.1"> by creating</span><a id="_idIndexMarker553"/><span class="koboSpan" id="kobo.1441.1"> a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1442.1">MessageTypeListBuilder.php</span></strong><span class="koboSpan" id="kobo.1443.1"> file in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1444.1">src</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1445.1"> directory:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1446.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1447.1">
namespace Drupal\mymodule;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1448.1">
use Drupal\Core\Config\Entity\ConfigEntityListBuilder;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1449.1">
use Drupal\Core\Entity\EntityInterface;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1450.1">
class MessageTypeListBuilder extends</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1451.1">
    ConfigEntityListBuilder {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1452.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1453.1">
 * Builds the header row for the entity listing.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1454.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1455.1">
 * @return array</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1456.1">
 *   A render array structure of header strings.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1457.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1458.1">
 * @see \Drupal\Core\Entity\EntityListBuilder</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1459.1">
    ::render()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1460.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1461.1">
  public function buildHeader() {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1462.1">
    $header['label'] = $this-&gt;t('Label');</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1463.1">
    return $header + parent::buildHeader();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1464.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1465.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1466.1">
 * Builds a row for an entity in the entity listing.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1467.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1468.1">
 * @param \Drupal\Core\Entity\EntityInterface $entity</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1469.1">
 *   The entity for this row of the list.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1470.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1471.1">
 * @return array</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1472.1">
 *   A render array structure of fields for this</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1473.1">
        entity.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1474.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1475.1">
 * @see \Drupal\Core\Entity\EntityListBuilder</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1476.1">
    ::render()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1477.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1478.1">
  public function buildRow(EntityInterface $entity) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1479.1">
    $row['label'] = $entity-&gt;label();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1480.1">
    return $row + parent::buildRow($entity);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1481.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1482.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.1483.1">Next, we will create the entity form that is used for creating and editing the entity type. </span><span class="koboSpan" id="kobo.1483.2">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1484.1">MessageTypeForm</span></strong><span class="koboSpan" id="kobo.1485.1"> class defined as the default form handler</span><a id="_idIndexMarker554"/><span class="koboSpan" id="kobo.1486.1"> by</span><a id="_idIndexMarker555"/><span class="koboSpan" id="kobo.1487.1"> creating </span><strong class="source-inline"><span class="koboSpan" id="kobo.1488.1">MessageTypeForm.php</span></strong><span class="koboSpan" id="kobo.1489.1"> file in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1490.1">src</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1491.1"> directory:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1492.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1493.1">
namespace Drupal\mymodule;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1494.1">
use Drupal\Core\Entity\BundleEntityFormBase;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1495.1">
use Drupal\Core\Form\FormStateInterface;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1496.1">
use Drupal\mymodule\Entity\MessageType;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1497.1">
class MessageTypeForm extends BundleEntityFormBase {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1498.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1499.1">
 * Gets the actual form array to be built.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1500.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1501.1">
 * @see \Drupal\Core\Entity\EntityForm::processForm()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1502.1">
 * @see \Drupal\Core\Entity\EntityForm::afterBuild()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1503.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1504.1">
  public function form(array $form, FormStateInterface</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1505.1">
    $form_state) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1506.1">
    $form = parent::form($form, $form_state);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1507.1">
    /** @var \Drupal\mymodule\Entity\MessageType</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1508.1">
        $entity */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1509.1">
    $entity = $this-&gt;entity;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1510.1">
    $form['label'] = [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1511.1">
      '#type' =&gt; 'textfield',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1512.1">
      '#title' =&gt; $this-&gt;t('Label'),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1513.1">
      '#required' =&gt; TRUE,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1514.1">
      '#default_value' =&gt; $entity-&gt;label,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1515.1">
    ];</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1516.1">
    $form['id'] = [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1517.1">
      '#type' =&gt; 'machine_name',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1518.1">
      '#default_value' =&gt; $entity-&gt;id(),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1519.1">
      '#machine_name' =&gt; [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1520.1">
        'exists' =&gt; [MessageType::class, 'load'],</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1521.1">
      ],</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1522.1">
    ];</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1523.1">
    return $this-&gt;protectBundleIdElement($form);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1524.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1525.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1526.1">
 * Form submission handler for the 'save' action.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1527.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1528.1">
 * Normally this method should be overridden to provide specific messages to</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1529.1">
 * the user and redirect the form after the entity has</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1530.1">
      been saved.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1531.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1532.1">
 * @param array $form</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1533.1">
 *   An associative array containing the structure of</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1534.1">
        the form.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1535.1">
 * @param \Drupal\Core\Form\FormStateInterface</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1536.1">
      $form_state</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1537.1">
 *   The current state of the form.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1538.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1539.1">
 * @return int</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1540.1">
 *   Either SAVED_NEW or SAVED_UPDATED, depending on</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1541.1">
        the operation performed.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1542.1">
 */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1543.1">
  public function save(array $form, FormStateInterface</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1544.1">
    $form_state) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1545.1">
    $result = parent::save($form, $form_state);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1546.1">
    if ($result === SAVED_NEW) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1547.1">
      $this-&gt;messenger()-&gt;addMessage('The message type</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1548.1">
        has been created.');</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1549.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1550.1">
    else {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1551.1">
      $this-&gt;messenger()-&gt;addMessage('The message type</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1552.1">
        has been updated.');</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1553.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1554.1">
    $form_state-&gt;setRedirectUrl($this-&gt;entity-&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1555.1">
        toUrl('collection'));</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1556.1">
    return $result;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1557.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1558.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1559.1">We extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1560.1">BundleEntityFormBase</span></strong><span class="koboSpan" id="kobo.1561.1"> form class, which is a special base class for configuration entity types that are used as bundles. </span><span class="koboSpan" id="kobo.1561.2">It provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1562.1">protectBundleIdElement</span></strong><span class="koboSpan" id="kobo.1563.1"> method, which prevents changes to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1564.1">entity ID.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.1565.1">To make the </span><a id="_idIndexMarker556"/><span class="koboSpan" id="kobo.1566.1">message</span><a id="_idIndexMarker557"/><span class="koboSpan" id="kobo.1567.1"> types accessible from the administrative pages, we need to define a menu link. </span><span class="koboSpan" id="kobo.1567.2">Add the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1568.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1569.1">mymodule.links.menu.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1570.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1571.1">
mymodule.message_types:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1572.1">
  title: 'Message types'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1573.1">
  parent: system.admin_structure</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1574.1">
  description: 'Manage message types.'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1575.1">
  route_name: entity.message_type.collection</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1576.1">This registers a menu link for the specified </span><strong class="source-inline"><span class="koboSpan" id="kobo.1577.1">route_name</span></strong><span class="koboSpan" id="kobo.1578.1"> under the </span><span class="No-Break"><span class="koboSpan" id="kobo.1579.1">specified </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1580.1">parent</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1581.1">.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.1582.1">Next, we need to update the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1583.1">mymodule.links.action.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1584.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1585.1">
message.add:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1586.1">
  route_name: entity.message.add_page</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1587.1">
  title: 'Add message'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1588.1">
  appears_on:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1589.1">
    - entity.message.collection</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1590.1">
message_type.add:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1591.1">
  route_name: entity.message_type.add_form</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1592.1">
  title: 'Add message type'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1593.1">
  appears_on:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1594.1">
    - entity.message_type.collection</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1595.1">Now that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1596.1">Message</span></strong><span class="koboSpan" id="kobo.1597.1"> entity type has bundles, we must use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1598.1">add_page</span></strong><span class="koboSpan" id="kobo.1599.1"> route for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1600.1">message.add</span></strong><span class="koboSpan" id="kobo.1601.1"> task so that a message type can be chosen when creating a message. </span><span class="koboSpan" id="kobo.1601.2">We add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1602.1">message_type.add</span></strong><span class="koboSpan" id="kobo.1603.1"> to display an </span><strong class="bold"><span class="koboSpan" id="kobo.1604.1">Add message type</span></strong><span class="koboSpan" id="kobo.1605.1"> button on the message type </span><span class="No-Break"><span class="koboSpan" id="kobo.1606.1">collection page.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1607.1">We must add</span><a id="_idIndexMarker558"/><span class="koboSpan" id="kobo.1608.1"> a</span><a id="_idIndexMarker559"/><span class="koboSpan" id="kobo.1609.1"> task link for the message type’s edit form route so that the </span><strong class="bold"><span class="koboSpan" id="kobo.1610.1">Field UI</span></strong><span class="koboSpan" id="kobo.1611.1"> tabs appear correctly. </span><span class="koboSpan" id="kobo.1611.2">Add the following to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1612.1">mymodule.links.task.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1613.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1614.1">
entity.message_type.edit_form:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1615.1">
  route_name: entity.message_type.edit_form</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1616.1">
  base_route: entity.message_type.edit_form</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1617.1">
  title: Edit</span></pre></li>
<li><span class="koboSpan" id="kobo.1618.1">We must define the permission defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1619.1">admin_permission</span></strong><span class="koboSpan" id="kobo.1620.1"> annotation key. </span><span class="koboSpan" id="kobo.1620.2">Add the following to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1621.1">mymodule.permissions.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1622.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1623.1">
administer message_types:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1624.1">
  title: 'Administer message types'</span></pre></li>
<li><span class="koboSpan" id="kobo.1625.1">We must define the configuration schema for our configuration entity type. </span><span class="koboSpan" id="kobo.1625.2">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1626.1">mymodule.schema.yml</span></strong><span class="koboSpan" id="kobo.1627.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1628.1">config/schema</span></strong><span class="koboSpan" id="kobo.1629.1"> directory to contain the </span><span class="No-Break"><span class="koboSpan" id="kobo.1630.1">schema definition:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1631.1">
mymodule.message_type.*:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1632.1">
  type: config_entity</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1633.1">
  label: 'Message type settings'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1634.1">
  mapping:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1635.1">
    id:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1636.1">
      type: string</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1637.1">
      label: 'Machine-readable name'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1638.1">
    label:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1639.1">
      type: label</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1640.1">
      label: 'Label'</span></pre></li>
<li><span class="koboSpan" id="kobo.1641.1">Next, we need </span><a id="_idIndexMarker560"/><span class="koboSpan" id="kobo.1642.1">to </span><a id="_idIndexMarker561"/><span class="koboSpan" id="kobo.1643.1">update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1644.1">Message</span></strong><span class="koboSpan" id="kobo.1645.1"> entity type’s annotation to use our bundled </span><span class="No-Break"><span class="koboSpan" id="kobo.1646.1">entity type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1647.1">
/**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1648.1">
 * Defines the message entity class.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1649.1">
 *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1650.1">
 * @ContentEntityType(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1651.1">
 *   id = "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1652.1">
 *   label = @Translation("Message"),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1653.1">
 *   base_table = "message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1654.1">
 *   entity_keys = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1655.1">
 *     "id" = "message_id",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1656.1">
 *     "label" = "title",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1657.1">
 *     "uuid" = "uuid",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1658.1">
 *     "bundle" = "type",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1659.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1660.1">
 *   admin_permission = "administer message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1661.1">
 *   bundle_entity_type = "message_type",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1662.1">
 *   field_ui_base_route =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1663.1">
        "entity.message_type.edit_form",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1664.1">
 *   handlers = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1665.1">
 *     "list_builder" = "Drupal\mymodule\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1666.1">
            MessageListBuilder",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1667.1">
 *     "form" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1668.1">
 *       "default" = "Drupal\mymodule\MessageForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1669.1">
 *       "delete" = "Drupal\Core\Entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1670.1">
            ContentEntityDeleteForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1671.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1672.1">
 *     "route_provider" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1673.1">
 *       "html" = "Drupal\Core\Entity\Routing\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1674.1">
            DefaultHtmlRouteProvider",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1675.1">
 *     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1676.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1677.1">
 *   links = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1678.1">
 *     "canonical" = "/messages/{message}",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1679.1">
 *     "add-page" = "/messages/add",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1680.1">
 *     "add-form" = "/messages/add/{message_type}",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1681.1">
 *     "edit-form" = "/messages/{message}/edit",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1682.1">
 *     "delete-form" = "/messages/{message}/delete",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1683.1">
 *     "collection" = "/admin/structure/messages"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1684.1">
 *   },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1685.1">
 * )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1686.1">
 */</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1687.1">We add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1688.1">bundle_entity_type</span></strong><span class="koboSpan" id="kobo.1689.1"> key and give it the identifier of our configuration entity type, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1690.1">message_type</span></strong><span class="koboSpan" id="kobo.1691.1">. </span><span class="koboSpan" id="kobo.1691.2">We then move the </span><strong class="bold"><span class="koboSpan" id="kobo.1692.1">Field UI</span></strong><span class="koboSpan" id="kobo.1693.1"> base route to the message type edit form route by </span><span class="No-Break"><span class="koboSpan" id="kobo.1694.1">changing </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1695.1">field_ui_base_route</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1696.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1697.1">The links are also modified to support bundles. </span><span class="koboSpan" id="kobo.1697.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1698.1">add-page</span></strong><span class="koboSpan" id="kobo.1699.1"> link has been added, which is a landing page to select a bundle when creating a message. </span><span class="koboSpan" id="kobo.1699.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1700.1">add-form</span></strong><span class="koboSpan" id="kobo.1701.1"> link has been updated to contain a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1702.1">message_type</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1703.1"> parameter.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.1704.1">Install the</span><a id="_idIndexMarker562"/><span class="koboSpan" id="kobo.1705.1"> module. </span><span class="koboSpan" id="kobo.1705.2">On the </span><strong class="bold"><span class="koboSpan" id="kobo.1706.1">Structure</span></strong><span class="koboSpan" id="kobo.1707.1"> page, you </span><a id="_idIndexMarker563"/><span class="koboSpan" id="kobo.1708.1">will now see </span><strong class="bold"><span class="koboSpan" id="kobo.1709.1">Message Types</span></strong><span class="koboSpan" id="kobo.1710.1"> alongside </span><strong class="bold"><span class="koboSpan" id="kobo.1711.1">Messages</span></strong><span class="koboSpan" id="kobo.1712.1">, allowing you to manage the message types and their </span><span class="No-Break"><span class="koboSpan" id="kobo.1713.1">field configuration.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer058">
<span class="koboSpan" id="kobo.1714.1"><img alt="Figure 9.4 – Message type form and tabs overview" src="image/Figure_9.04_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1715.1">Figure 9.4 – Message type form and tabs overview</span></p>
<h2 id="_idParaDest-281"><a id="_idTextAnchor310"/><span class="koboSpan" id="kobo.1716.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.1717.1">Content entity types have bundles as a way to segment the entity type into specific types. </span><span class="koboSpan" id="kobo.1717.2">Bundles can merely be a string value on a content entity or, more commonly, a reference to a configuration entity, like in this recipe. </span><span class="koboSpan" id="kobo.1717.3">When a content entity type does not define bundles, it is considered to have a single bundle with the same name as the </span><span class="No-Break"><span class="koboSpan" id="kobo.1718.1">entity type.</span></span></p>
<p><span class="koboSpan" id="kobo.1719.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.1720.1">Field UI</span></strong><span class="koboSpan" id="kobo.1721.1"> module is designed to allow managing custom fields on a bundle. </span><span class="koboSpan" id="kobo.1721.2">When a content entity type uses bundles, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1722.1">field_ui_base_route</span></strong><span class="koboSpan" id="kobo.1723.1"> must point to the edit form route of the configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.1724.1">entity type.</span></span></p>
<p><span class="koboSpan" id="kobo.1725.1">Internally, Drupal uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1726.1">bundle_entity_type</span></strong><span class="koboSpan" id="kobo.1727.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1728.1">bundle_of</span></strong><span class="koboSpan" id="kobo.1729.1"> keys to automatically get information about the related entity types, such as building the Field </span><span class="No-Break"><span class="koboSpan" id="kobo.1730.1">UI forms.</span></span></p>
<p><span class="koboSpan" id="kobo.1731.1">When using the</span><a id="_idIndexMarker564"/><span class="koboSpan" id="kobo.1732.1"> code</span><a id="_idIndexMarker565"/><span class="koboSpan" id="kobo.1733.1"> generation commands in Drush, generating a content entity type provides an option to generate a configuration entity type </span><span class="No-Break"><span class="koboSpan" id="kobo.1734.1">for bundles.</span></span></p>
<h1 id="_idParaDest-282"><a id="_idTextAnchor311"/><span class="koboSpan" id="kobo.1735.1">Implementing access control for an entity</span></h1>
<p><span class="koboSpan" id="kobo.1736.1">All entity types </span><a id="_idIndexMarker566"/><span class="koboSpan" id="kobo.1737.1">have an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1738.1">access</span></strong><span class="koboSpan" id="kobo.1739.1"> handler used to control whether a user has access to create, read, update, or delete an entity. </span><span class="koboSpan" id="kobo.1739.2">Both configuration and content entity types default to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1740.1">\Drupal\Core\Entity\EntityAccessControlHandler</span></strong><span class="koboSpan" id="kobo.1741.1"> class as their access handler. </span><span class="koboSpan" id="kobo.1741.2">This handler, however, only supports checking the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1742.1">admin_permission</span></strong><span class="koboSpan" id="kobo.1743.1"> of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1744.1">entity type.</span></span></p>
<p><span class="koboSpan" id="kobo.1745.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.1746.1">Entity API</span></strong><span class="koboSpan" id="kobo.1747.1"> module is a contributed project used to build enhancements on the Entity system in Drupal core and improve the developer experience with creating and maintaining custom entity types. </span><span class="koboSpan" id="kobo.1747.2">It provides a permission provider to generate create, read, update, and delete permissions for an entity type. </span><span class="koboSpan" id="kobo.1747.3">To complement the permission provider, it also has an access handler that supports the </span><span class="No-Break"><span class="koboSpan" id="kobo.1748.1">generated permissions.</span></span></p>
<p><span class="koboSpan" id="kobo.1749.1">In this recipe, we will use the permission provider and access handlers from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1750.1">Entity API</span></strong><span class="koboSpan" id="kobo.1751.1"> module for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1752.1">Message</span></strong><span class="koboSpan" id="kobo.1753.1"> entity type created previously in </span><span class="No-Break"><span class="koboSpan" id="kobo.1754.1">this chapter.</span></span></p>
<h2 id="_idParaDest-283"><a id="_idTextAnchor312"/><span class="koboSpan" id="kobo.1755.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.1756.1">This recipe uses entity handler classes provided by the </span><strong class="bold"><span class="koboSpan" id="kobo.1757.1">Entity API</span></strong><span class="koboSpan" id="kobo.1758.1"> module. </span><span class="koboSpan" id="kobo.1758.2">You must add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1759.1">Entity API</span></strong><span class="koboSpan" id="kobo.1760.1"> module and install it to use the entity handler classes </span><span class="No-Break"><span class="koboSpan" id="kobo.1761.1">it provides:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1762.1">
composer require drupal/entity
php vendor/bin/drush en entity --yes</span></pre>
<h2 id="_idParaDest-284"><a id="_idTextAnchor313"/><span class="koboSpan" id="kobo.1763.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.1764.1">First, we </span><a id="_idIndexMarker567"/><span class="koboSpan" id="kobo.1765.1">need to update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1766.1">mymodule.info.yml</span></strong><span class="koboSpan" id="kobo.1767.1"> file to mark the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1768.1">Entity API</span></strong><span class="koboSpan" id="kobo.1769.1"> module as </span><span class="No-Break"><span class="koboSpan" id="kobo.1770.1">a dependency:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1771.1">
name: My Module</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1772.1">
type: module</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1773.1">
description: This is an example module from the Drupal</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1774.1">
  Development Cookbook!</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1775.1">
core_version_requirement: '&gt;=10'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1776.1">
dependencies:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1777.1">
  - entity:entity</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1778.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1779.1">dependencies</span></strong><span class="koboSpan" id="kobo.1780.1"> array contains namespaced module names. </span><span class="koboSpan" id="kobo.1780.2">Drupal utilizes this pattern to support projects that contain submodules and act as </span><span class="No-Break"><span class="koboSpan" id="kobo.1781.1">a mono-repository.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1782.1">We must update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1783.1">Message</span></strong><span class="koboSpan" id="kobo.1784.1"> entity type’s annotation to specify that permissions for the entity type should be granular </span><span class="No-Break"><span class="koboSpan" id="kobo.1785.1">per bundle:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1786.1">
*   admin_permission = "administer message",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1787.1">
*   permission_granularity = "bundle",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1788.1">
*   bundle_entity_type = "message_type",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1789.1">
*   field_ui_base_route =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1790.1">
        "entity.message_type.edit_form",</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1791.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1792.1">permission_granularity</span></strong><span class="koboSpan" id="kobo.1793.1"> key tells the system what permissions should be generated and whether access should be checked by just the entity type or also take into consideration the bundle. </span><span class="koboSpan" id="kobo.1793.2">This way, there could be permissions for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1794.1">Announcement</span></strong><span class="koboSpan" id="kobo.1795.1"> messages but not </span><strong class="source-inline"><span class="koboSpan" id="kobo.1796.1">Bulletin</span></strong><span class="koboSpan" id="kobo.1797.1"> messages for a specific </span><span class="No-Break"><span class="koboSpan" id="kobo.1798.1">user role.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1799.1">Next, we add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1800.1">permission_provider</span></strong><span class="koboSpan" id="kobo.1801.1"> handler, which will generate our permissions. </span><span class="koboSpan" id="kobo.1801.2">Note that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1802.1">{...}</span></strong><span class="koboSpan" id="kobo.1803.1"> indicates the same code from the previous section, removed for readability for what we are </span><span class="No-Break"><span class="koboSpan" id="kobo.1804.1">adding here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1805.1">
*   handlers = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1806.1">
*     "list_builder" = "Drupal\mymodule\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1807.1">
        MessageListBuilder",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1808.1">
*     "form" = {...},</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1809.1">
*     "route_provider" = {...},</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1810.1">
*     "permission_provider" = "\Drupal\entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1811.1">
        EntityPermissionProvider",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1812.1">
*   },</span></pre></li>
<li><span class="koboSpan" id="kobo.1813.1">Then, we </span><a id="_idIndexMarker568"/><span class="koboSpan" id="kobo.1814.1">provide the access handler, which supports our </span><span class="No-Break"><span class="koboSpan" id="kobo.1815.1">generated permissions:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1816.1">
*   handlers = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1817.1">
*     "list_builder" = "Drupal\mymodule\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1818.1">
        MessageListBuilder",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1819.1">
*     "form" = {...},</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1820.1">
*     "route_provider" = {...},</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1821.1">
*     "permission_provider" = "\Drupal\entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1822.1">
        EntityPermissionProvider",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1823.1">
*     "access" = "\Drupal\entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1824.1">
        EntityAccessControlHandler",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1825.1">
*   },</span></pre></li>
<li><span class="koboSpan" id="kobo.1826.1">We will add one more handler, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1827.1">query_access</span></strong><span class="koboSpan" id="kobo.1828.1"> handler to implement our access controls when querying </span><span class="No-Break"><span class="koboSpan" id="kobo.1829.1">for entities:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1830.1">
*   handlers = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1831.1">
*     "list_builder" = "Drupal\mymodule\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1832.1">
        MessageListBuilder",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1833.1">
*     "form" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1834.1">
*       "default" = "Drupal\mymodule\MessageForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1835.1">
*       "delete" = "Drupal\Core\Entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1836.1">
          ContentEntityDeleteForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1837.1">
*     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1838.1">
*     "route_provider" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1839.1">
*       "html" = "Drupal\Core\Entity\Routing\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1840.1">
          DefaultHtmlRouteProvider",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1841.1">
*     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1842.1">
*     "permission_provider" = "\Drupal\entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1843.1">
        EntityPermissionProvider",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1844.1">
*     "access" = "\Drupal\entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1845.1">
          EntityAccessControlHandler",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1846.1">
*     "query_access" = "\Drupal\entity\QueryAccess\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1847.1">
        QueryAccessHandler",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1848.1">
*   },</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1849.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1850.1">query_access</span></strong><span class="koboSpan" id="kobo.1851.1"> handler</span><a id="_idIndexMarker569"/><span class="koboSpan" id="kobo.1852.1"> ensures that entities returned from an entity query are accessible to </span><span class="No-Break"><span class="koboSpan" id="kobo.1853.1">the user.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1854.1">The permission provider also generates the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1855.1">admin_permission</span></strong><span class="koboSpan" id="kobo.1856.1"> specified on the entity type. </span><span class="koboSpan" id="kobo.1856.2">You may remove the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1857.1">administer message</span></strong><span class="koboSpan" id="kobo.1858.1"> permission </span><span class="No-Break"><span class="koboSpan" id="kobo.1859.1">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1860.1">mymodule.permissions.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1861.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1862.1">Rebuild Drupal’s caches, or install the module if it is not yet installed. </span><span class="koboSpan" id="kobo.1862.2">You will see the generated permissions on the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1863.1">Permissions</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1864.1"> form.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer059">
<span class="koboSpan" id="kobo.1865.1"><img alt="Figure 9.5 – Permissions form for a message type" src="image/Figure_9.05_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1866.1">Figure 9.5 – Permissions form for a message type</span></p>
<h2 id="_idParaDest-285"><a id="_idTextAnchor314"/><span class="koboSpan" id="kobo.1867.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.1868.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.1869.1">Entity API</span></strong><span class="koboSpan" id="kobo.1870.1"> module</span><a id="_idIndexMarker570"/><span class="koboSpan" id="kobo.1871.1"> dynamically generates permissions by finding all entity types that use its </span><strong class="source-inline"><span class="koboSpan" id="kobo.1872.1">permission_provider</span></strong><span class="koboSpan" id="kobo.1873.1"> handler. </span><span class="koboSpan" id="kobo.1873.2">The permission provider then inspects the entity type and creates the correct permissions that may be needed. </span><span class="koboSpan" id="kobo.1873.3">For instance, if the entity type implements </span><strong class="source-inline"><span class="koboSpan" id="kobo.1874.1">\Drupal\Core\Entity\EntityPublishedInterface</span></strong><span class="koboSpan" id="kobo.1875.1">, it will generate permission to allow viewing unpublished entities of that entity type. </span><span class="koboSpan" id="kobo.1875.2">The permissions are based on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1876.1">permission_granularity</span></strong><span class="koboSpan" id="kobo.1877.1"> value in the entity type annotation. </span><span class="koboSpan" id="kobo.1877.2">The default value is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1878.1">entity_type</span></strong><span class="koboSpan" id="kobo.1879.1">. </span><span class="koboSpan" id="kobo.1879.2">When using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1880.1">entity_type</span></strong><span class="koboSpan" id="kobo.1881.1">, there is one set of permissions for working with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1882.1">entity type.</span></span></p>
<p><span class="koboSpan" id="kobo.1883.1">The correlating </span><strong class="source-inline"><span class="koboSpan" id="kobo.1884.1">access</span></strong><span class="koboSpan" id="kobo.1885.1"> handler has logic to match the create, read, update, and delete permissions provided by the permission provider. </span><span class="koboSpan" id="kobo.1885.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1886.1">query_access</span></strong><span class="koboSpan" id="kobo.1887.1"> handler adds access checks when querying for entities based on the current user’s permissions. </span><span class="koboSpan" id="kobo.1887.2">When using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1888.1">EntityPublishedInterface</span></strong><span class="koboSpan" id="kobo.1889.1">, this ensures unpublished entities are not exposed to users without permission to </span><span class="No-Break"><span class="koboSpan" id="kobo.1890.1">view them.</span></span></p>
<p><span class="koboSpan" id="kobo.1891.1">This allows you to implement robust access control for your custom entity type without having to write</span><a id="_idIndexMarker571"/><span class="koboSpan" id="kobo.1892.1"> your own </span><span class="No-Break"><span class="koboSpan" id="kobo.1893.1">access logic.</span></span></p>
<h2 id="_idParaDest-286"><a id="_idTextAnchor315"/><span class="koboSpan" id="kobo.1894.1">There’s more...</span></h2>
<p><span class="koboSpan" id="kobo.1895.1">This recipe showed how to provide permission-based access to entities. </span><span class="koboSpan" id="kobo.1895.2">The next section will show how you can control access to specific fields </span><span class="No-Break"><span class="koboSpan" id="kobo.1896.1">as well.</span></span></p>
<h3><span class="koboSpan" id="kobo.1897.1">Controlling access to entity fields</span></h3>
<p><span class="koboSpan" id="kobo.1898.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1899.1">checkFieldAccess</span></strong><span class="koboSpan" id="kobo.1900.1"> method in </span><a id="_idIndexMarker572"/><span class="koboSpan" id="kobo.1901.1">the core’s entity access control handler can be overridden to control access to specific entity fields when modifying an entity. </span><span class="koboSpan" id="kobo.1901.2">Without being overridden by a child class, the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.1902.1">\Drupal\Core\Entity\EntityAccessControlHandler</span></strong><span class="koboSpan" id="kobo.1903.1"> class will always return an allowed access result. </span><span class="koboSpan" id="kobo.1903.2">The method receives the </span><span class="No-Break"><span class="koboSpan" id="kobo.1904.1">following parameters:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1905.1">The view and </span><span class="No-Break"><span class="koboSpan" id="kobo.1906.1">edit operations</span></span></li>
<li><span class="koboSpan" id="kobo.1907.1">The current </span><span class="No-Break"><span class="koboSpan" id="kobo.1908.1">field’s definition</span></span></li>
<li><span class="koboSpan" id="kobo.1909.1">The user session to </span><span class="No-Break"><span class="koboSpan" id="kobo.1910.1">check against</span></span></li>
<li><span class="koboSpan" id="kobo.1911.1">A possible list of field </span><span class="No-Break"><span class="koboSpan" id="kobo.1912.1">item values</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1913.1">Entity types can implement their own access control handlers and override this method to provide granular control over the modification of their base fields. </span><span class="koboSpan" id="kobo.1913.2">A good example would be the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1914.1">User</span></strong><span class="koboSpan" id="kobo.1915.1"> module and </span><span class="No-Break"><span class="koboSpan" id="kobo.1916.1">its </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1917.1">\Drupal\user\UserAccessControlHandler</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1918.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1919.1">User entities have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1920.1">pass</span></strong><span class="koboSpan" id="kobo.1921.1"> field that is used for the user’s current password. </span><span class="koboSpan" id="kobo.1921.2">There is also a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1922.1">created</span></strong><span class="koboSpan" id="kobo.1923.1"> field that records when the user was added to </span><span class="No-Break"><span class="koboSpan" id="kobo.1924.1">the site.</span></span></p>
<p><span class="koboSpan" id="kobo.1925.1">For the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1926.1">pass</span></strong><span class="koboSpan" id="kobo.1927.1"> field, it returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.1928.1">denied</span></strong><span class="koboSpan" id="kobo.1929.1"> if the operation is a view, but allows access if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1930.1">$operation</span></strong><span class="koboSpan" id="kobo.1931.1"> argument passed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1932.1">checkFieldAccess</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1933.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1934.1">edit</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1935.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1936.1">
      case 'pass':
        // Allow editing the password, but not viewing it.
</span><span class="koboSpan" id="kobo.1936.2">        return ($operation == 'edit') ? </span><span class="koboSpan" id="kobo.1936.3">AccessResult::
            allowed() : AccessResult::forbidden();</span></pre>
<p><span class="koboSpan" id="kobo.1937.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1938.1">created</span></strong><span class="koboSpan" id="kobo.1939.1"> field uses</span><a id="_idIndexMarker573"/><span class="koboSpan" id="kobo.1940.1"> the opposite logic. </span><span class="koboSpan" id="kobo.1940.2">When a user logs in, the site can be viewed but cannot </span><span class="No-Break"><span class="koboSpan" id="kobo.1941.1">be edited:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1942.1">
      case 'created':
    // Allow viewing the created date, but not editing it.
</span><span class="koboSpan" id="kobo.1942.2">        return ($operation == 'view') ? </span><span class="koboSpan" id="kobo.1942.3">AccessResult
            ::allowed() : AccessResult::neutral();</span></pre>
<h1 id="_idParaDest-287"><a id="_idTextAnchor316"/><span class="koboSpan" id="kobo.1943.1">Providing a custom storage handler</span></h1>
<p><span class="koboSpan" id="kobo.1944.1">Storage handlers </span><a id="_idIndexMarker574"/><span class="koboSpan" id="kobo.1945.1">control the loading, saving, and deleting of an entity. </span><span class="koboSpan" id="kobo.1945.2">Content entity types have the default storage handler of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1946.1">\Drupal\Core\Entity\Sql\SqlContentEntityStorage</span></strong><span class="koboSpan" id="kobo.1947.1">. </span><span class="koboSpan" id="kobo.1947.2">Configuration entity types have the default storage handler of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1948.1">\Drupal\Core\Config\Entity\ConfigEntityStorage</span></strong><span class="koboSpan" id="kobo.1949.1">. </span><span class="koboSpan" id="kobo.1949.2">These classes can be extended to implement alternative methods and set as the entity type’s </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1950.1">storage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1951.1"> handler.</span></span></p>
<p><span class="koboSpan" id="kobo.1952.1">In this recipe, we will create a method for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1953.1">Message</span></strong><span class="koboSpan" id="kobo.1954.1"> entity type created previously in this chapter to load all messages of a </span><span class="No-Break"><span class="koboSpan" id="kobo.1955.1">specific type.</span></span></p>
<h2 id="_idParaDest-288"><a id="_idTextAnchor317"/><span class="koboSpan" id="kobo.1956.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.1957.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1958.1">MessageStorage</span></strong><span class="koboSpan" id="kobo.1959.1"> class in the module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1960.1">src</span></strong><span class="koboSpan" id="kobo.1961.1"> directory. </span><span class="koboSpan" id="kobo.1961.2">This class will extend the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1962.1">SqlContentEntityStorage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1963.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1964.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1965.1">
namespace Drupal\mymodule;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1966.1">
use Drupal\Core\Entity\Sql\SqlContentEntityStorage;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1967.1">
class MessageStorage extends SqlContentEntityStorage {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1968.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1969.1">The default storage for content entity types is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1970.1">SqlContentEntityStorage</span></strong><span class="koboSpan" id="kobo.1971.1"> class, which is why we extend </span><span class="No-Break"><span class="koboSpan" id="kobo.1972.1">that class.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1973.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1974.1">loadMultipleByType</span></strong><span class="koboSpan" id="kobo.1975.1"> method; using this method, we will provide a simple way </span><a id="_idIndexMarker575"/><span class="koboSpan" id="kobo.1976.1">to load all messages of a </span><span class="No-Break"><span class="koboSpan" id="kobo.1977.1">specific bundle:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1978.1">
public function loadMultipleByType(string $type): array {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1979.1">
  $message_ids = $this-&gt;getQuery()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1980.1">
    -&gt;accessCheck(TRUE)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1981.1">
    -&gt;condition('type', $type)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1982.1">
    -&gt;execute();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1983.1">
  return $this-&gt;loadMultiple($message_ids);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1984.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1985.1">The method performs an entity query with access checks. </span><span class="koboSpan" id="kobo.1985.2">It performs a condition on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1986.1">type</span></strong><span class="koboSpan" id="kobo.1987.1"> field for the bundle value and then passes any returned entity IDs to be loaded </span><span class="No-Break"><span class="koboSpan" id="kobo.1988.1">and returned.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1989.1">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1990.1">Message</span></strong><span class="koboSpan" id="kobo.1991.1"> entity type’s annotation to specify the customized </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1992.1">storage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1993.1"> handler:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1994.1">
*   handlers = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1995.1">
*     "list_builder" = "Drupal\mymodule\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1996.1">
        MessageListBuilder",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1997.1">
*     "form" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1998.1">
*       "default" = "Drupal\mymodule\MessageForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1999.1">
*       "delete" = "Drupal\Core\Entity\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.2000.1">
            ContentEntityDeleteForm",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.2001.1">
*     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.2002.1">
*     "route_provider" = {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.2003.1">
*       "html" = "Drupal\Core\Entity\Routing\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.2004.1">
            DefaultHtmlRouteProvider",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.2005.1">
*     },</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.2006.1">
*     "storage" = "\Drupal\mymodule\MessageStorage",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.2007.1">
*   },</span></pre></li>
<li><span class="koboSpan" id="kobo.2008.1">You can now </span><a id="_idIndexMarker576"/><span class="koboSpan" id="kobo.2009.1">programmatically interact with your message entities using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2010.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2011.1">
$messages = \Drupal::entityTypeManager()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.2012.1">
  -&gt;getStorage('message')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.2013.1">
  -&gt;loadMultipleByType('alert');</span></pre></li>
</ol>
<h2 id="_idParaDest-289"><a id="_idTextAnchor318"/><span class="koboSpan" id="kobo.2014.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.2015.1">Extending </span><strong class="source-inline"><span class="koboSpan" id="kobo.2016.1">SqlContentEntityStorage</span></strong><span class="koboSpan" id="kobo.2017.1"> ensures that our entity type’s storage matches the requirements for content entity storage in the database and allows adding custom methods for </span><span class="No-Break"><span class="koboSpan" id="kobo.2018.1">loading entities.</span></span></p>
<p><span class="koboSpan" id="kobo.2019.1">When the entity type storage is retrieved from the entity type manager, the methods may </span><span class="No-Break"><span class="koboSpan" id="kobo.2020.1">be used.</span></span></p>
</div>
</body></html>