<html><head></head><body><div class="appendix" title="Appendix&#xA0;B.&#xA0;Blueprint &#x2013; Creating an Events Calendar Add-on"><div class="titlepage"><div><div><h1 class="title"><a id="appB"/>Appendix B. Blueprint – Creating an Events Calendar Add-on</h1></div></div></div><p>Many add-ons that developers have to create end up combining dashboard interfaces and custom block types to not only provide great editing capabilities on the backend of the site, but also unique and powerful interfaces on the frontend of the website. A common request on websites is the ability to have an events calendar. This blueprint here is going to combine much of the knowledge that we gained in the prior chapters to create an events calendar add-on. The add-on will have a CRUD interface on the dashboard as well as a custom block type to display the events.</p><div class="section" title="Before we begin..."><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec165"/>Before we begin...</h1></div></div></div><p>Before we begin, we should note that the blueprint in this chapter is based on a fresh installation of concrete5, with all of the sample content loaded. This will give us some nice pages and a clean design to work with.</p><p>The complete working code for this add-on is available for free from the book's website. Feel free to download that as a starting point or to solve any problems you may run into.</p></div></div>
<div class="section" title="Creating the package"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec166"/>Creating the package</h1></div></div></div><p>Let's get moving. First, we will <a id="id635" class="indexterm"/>create the package's directory. Add a new directory in <code class="literal">/packages</code> called <code class="literal">cookbook_events</code>. Inside this directory, create the package's controller file.</p><div class="section" title="The package controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec572"/>The package controller</h2></div></div></div><p>You may be familiar with <a id="id636" class="indexterm"/>package controllers already; they tell concrete5 about the package, as well as provide functionality for developers to perform advanced tasks.</p><p>Enter the following code in <code class="literal">controller.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
defined('C5_EXECUTE') or die(_("Access Denied."));
class CookbookEventsPackage extends Package {
    protected $pkgHandle = 'cookbook_events';
    protected $appVersionRequired = '5.6.0.0';
    protected $pkgVersion = '0.9.0';
    public function getPackageName() {
        return t('Cookbook Events');
    }
    public function getPackageDescription() {
        return t('A calendar of events for our website.');
    }
}</pre></div><p>Notice the use of the <code class="literal">defined or die</code> statement at the top of the file. This is required at the top of every PHP file in the package, otherwise concrete5 will reject your add-on if you submit it to the marketplace.</p><p>Also, note the use of the <code class="literal">t()</code> function <a id="id637" class="indexterm"/>around the package name and description strings. This will allow translators to offer translations of these strings in an easy and consistent way.</p><p>We are setting the minimum concrete5 Version to 5.6.0. as we are using some CSS styles that don't fully work on older versions of concrete5. With a little extra work, however, we could support older versions.</p></div><div class="section" title="The package database XML file"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec573"/>The package database XML file</h2></div></div></div><p>Our package will need to create a <a id="id638" class="indexterm"/>database table to store the event data. Rather than executing raw SQL, the preferred methodology is to create a <code class="literal">db.xml</code> file that contains all of the tables and fields to be created. concrete5 will read this file when the package is installed and will perform the necessary database operations.</p><p>Create the <code class="literal">db.xml</code> file at <code class="literal">/packages/cookbook_events/db.xml</code>.</p><p>Enter the following XML <a id="id639" class="indexterm"/>code in the file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;schema version="0.3"&gt;
   &lt;table name="CookbookEvents"&gt;
      &lt;field name="id" type="I"&gt;
         &lt;key /&gt;
         &lt;unsigned /&gt;
         &lt;autoincrement /&gt;
      &lt;/field&gt;
      &lt;field name="title" type="C" size="255"&gt;&lt;/field&gt;
      &lt;field name="event_date" type="T"&gt;&lt;/field&gt;
      &lt;field name="location" type="C" size="255"&gt;&lt;/field&gt;
      &lt;field name="description" type="X2"&gt;&lt;/field&gt;
      &lt;field name="created_by" type="I"&gt;&lt;/field&gt;
      &lt;field name="created_at" type="T"&gt;&lt;/field&gt;
   &lt;/table&gt;
&lt;/schema&gt;</pre></div><p>Save this file. This tells concrete5 to create a table named <code class="literal">CookbookEvents</code>, with fields for a title, date, location, description, and some meta data. The use of <code class="literal">db.xml</code> also makes future database upgrades easier when your add-on is updated.</p><p>You may recall that this XML file makes use of the ADOdb XML schema format, or <span class="strong"><strong>AXMLS</strong></span>. You can learn <a id="id640" class="indexterm"/>more about AXMLS and the different field types at <a class="ulink" href="http://phplens.com/lens/adodb/docs-datadict.htm#xmlschema">http://phplens.com/lens/adodb/docs-datadict.htm#xmlschema</a>.</p></div><div class="section" title="The model"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec574"/>The model</h2></div></div></div><p>Now that we know what our database <a id="id641" class="indexterm"/>table looks like, let's create the model that we will use to <a id="id642" class="indexterm"/>interact with the table.</p><p>Create a new file at <code class="literal">/packages/cookbook_events/models/cookbook_event.php</code>.</p><p>Create the <code class="literal">model</code> class and specify the name of the database table:</p><div class="informalexample"><pre class="programlisting">&lt;?php
defined('C5_EXECUTE') or die(_("Access Denied."));
class CookbookEvent extends Model {
   var $_table = 'CookbookEvents';
    public function getDate() {
        return date(DATE_APP_GENERIC_MDY_FULL, strtotime($this-&gt;event_date));
    }
}</pre></div><p>Notice how we named the class <code class="literal">CookbookEvent</code> rather than just <code class="literal">Event</code>. This is to prevent collisions with other classes. Since <code class="literal">Event</code> is a fairly common name for a class, it is possible that there could be a conflict. It's always a good idea to make your class names as unique as possible, while still following <a id="id643" class="indexterm"/>convention and being easy to understand.</p><p>We also added a function to return a <a id="id644" class="indexterm"/>formatted version of the event's date. This will come in handy later.</p></div><div class="section" title="Single page controllers"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec575"/>Single page controllers</h2></div></div></div><p>In order for our add-on to have <a id="id645" class="indexterm"/>interfaces on the dashboard, we will need to create a few single pages with controllers.</p><p>Create a file in <code class="literal">/packages/cookbook_events/controllers/dashboard/cookbook_events.php</code>. This is the root controller file for the <a id="id646" class="indexterm"/>add-on. Give it a basic class file:</p><div class="informalexample"><pre class="programlisting">&lt;?php
defined('C5_EXECUTE') or die(_("Access Denied."));
class DashboardCookbookEventsController extends Controller {
    public function on_start() {
        $this-&gt;redirect('/dashboard/cookbook_events/list');
    }
}</pre></div><p>The <code class="literal">on_start</code> function will make sure that if anyone visits this page, they will be redirected to the default view showing the events listing. Let's create the controller for that view now.</p><p>Now create a new directory at <code class="literal">/packages/cookbook_events/controllers/dashboard/cookbook_events/</code>. Add two files to this directory: <code class="literal">add.php</code> and <code class="literal">list.php</code>.</p><p>In <code class="literal">list.php</code>, add the following class:</p><div class="informalexample"><pre class="programlisting">&lt;?php
defined('C5_EXECUTE') or die(_("Access Denied."));
class DashboardCookbookEventsListController extends Controller {   
}</pre></div><p>Great! Now in <code class="literal">add.php</code>, add another class:</p><div class="informalexample"><pre class="programlisting">&lt;?php
defined('C5_EXECUTE') or die(_("Access Denied."));
class DashboardCookbookEventsAddController extends Controller {
}</pre></div><p>Looking good! Our single pages have <a id="id647" class="indexterm"/>basic controllers now, but they still need view files.</p></div><div class="section" title="Single page views"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec576"/>Single page views</h2></div></div></div><p>Create the root view file <a id="id648" class="indexterm"/>for our interface at <code class="literal">/packages/cookbook_events/single_pages/cookbook_events.php</code>. Leave this file empty. Create a directory at <code class="literal">/packages/cookbook_events/single_pages/cookbook_events</code>. Add the two files, <code class="literal">add.php</code> and <code class="literal">list.php</code>, to this directory. We <a id="id649" class="indexterm"/>can leave these blank for now.</p></div><div class="section" title="The event list block type"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec577"/>The event list block type</h2></div></div></div><p>Before we can install our <a id="id650" class="indexterm"/>package, we need to make sure that the block type exists as well. This will allow us to automatically install the block type during the package's installation.</p><p>This block type that we are creating <a id="id651" class="indexterm"/>will show a list of the events that have been entered into the database. It will act as a basic agenda view for the site's events.</p><p>Create a new directory at <code class="literal">/packages/cookbook_events/blocks</code>. Now, create another directory in there called <code class="literal">cookbook_events</code>.</p><p>The first file that we will want to add to our block is the controller. Create <code class="literal">controller.php</code> in the block's directory.</p><p>Enter the following code in <code class="literal">controller.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php defined('C5_EXECUTE') or die(_("Access Denied."));
class CookbookEventsBlockController extends BlockController {
    protected $btTable = "btCookbookEvents";
    protected $btInterfaceWidth = "350";
    protected $btInterfaceHeight = "300";
    public function getBlockTypeName() {
        return t('Events List');
    }
    public function getBlockTypeDescription() {
        return t('A list of events!');
    }
}</pre></div><p>Notice that we remembered to include the required <code class="literal">defined or die</code> statement at the top of the file. We'll continue prefixing our class names with <code class="literal">Cookbook</code> to allow our classes to avoid conflicting with existing classes.</p><p>We also defined the name of the <a id="id652" class="indexterm"/>database table that this block type will use. Let's create that table now using the database XML format.</p></div><div class="section" title="The block's database XML file"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec578"/>The block's database XML file</h2></div></div></div><p>Create a new file in the block <a id="id653" class="indexterm"/>directory named <code class="literal">db.xml</code>. Enter the following <a id="id654" class="indexterm"/>code in the XML file:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;schema version="0.3"&gt;
   &lt;table name="btCookbookEvents"&gt;
      &lt;field name="bID" type="I"&gt;
         &lt;key /&gt;
         &lt;unsigned /&gt;
      &lt;/field&gt;
      &lt;field name="item_limit" type="I"&gt;&lt;/field&gt;
   &lt;/table&gt;
&lt;/schema&gt;</pre></div><p>This XML code will tell concrete5 to create a new table with two fields: a unique ID to identify the block, and a field to store how many events we want to display.</p></div><div class="section" title="The block view files"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec579"/>The block view files</h2></div></div></div><p>If you recall from earlier chapters, <a id="id655" class="indexterm"/>blocks have three views that can be activated: add, edit, and view. Create <code class="literal">add.php</code>, <code class="literal">edit.php</code>, and <code class="literal">view.php</code> to represent each of these views. <a id="id656" class="indexterm"/>In our block, <code class="literal">add.php</code> and <code class="literal">edit.php</code> will show the same HTML, so we will create a fourth file for these views to share named <code class="literal">form.php</code>. Also, add a <code class="literal">view.css</code> file that will be used to apply styles to the frontend of the block.</p><p>Leave these files empty for now, as we are ready to install our block!</p></div></div>
<div class="section" title="Installing the package"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec167"/>Installing the package</h1></div></div></div><p>Open the package <a id="id657" class="indexterm"/>controller (located at <code class="literal">/packages/cookbook_events/controller.php</code>) in your code editor. Add a new method to the controller class named <code class="literal">install</code>. It should look like the following code snippet:</p><div class="informalexample"><pre class="programlisting">public function install() {
    $pkg = parent::install();
    // Add the dashboard pages
    $mainPage = SinglePage::add('/dashboard/cookbook_events', $pkg);
    $listPage = SinglePage::add('/dashboard/cookbook_events/list', $pkg);
    $addPage = SinglePage::add('/dashboard/cookbook_events/add', $pkg);
    // install the block type
    BlockType::installBlockTypeFromPackage('cookbook_events', $pkg); 
}</pre></div><p>What's going on here? Well, if you recall, we created three single pages with controllers to be used for the dashboard interface. These pages will need to be added to the site map, so we hook into the package's installation routine to make sure that they get installed when the package is installed.</p><p>Next, we also install the block type. This will ensure that our block is available to use on the frontend of the website.</p><p>When concrete5 installs the package, <a id="id658" class="indexterm"/>it will run our package's <code class="literal">db.xml</code> file, creating the database tables defined in there. This will allow our package to remain completely portable, and it can be installed in any concrete5 website.</p><p>Let's install the package now.</p><div class="section" title="Installing the package to the dashboard"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec580"/>Installing the package to the dashboard</h2></div></div></div><p>Visit the package installation <a id="id659" class="indexterm"/>page on your concrete5 site, <a id="id660" class="indexterm"/>located at <code class="literal">/dashboard/extend/install/</code>. You should see the events package awaiting installation, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/4548OS_AppB_01.jpg" alt="Installing the package to the dashboard"/></div><p>Click on the <span class="strong"><strong>Install</strong></span> button on the package. If all goes well, the package will be installed! We should have some new pages on the dashboard, so visit <code class="literal">/dashboard/cookbook_events</code>.</p><p>Did you notice what happened? <a id="id661" class="indexterm"/>When we visit the <code class="literal">/dashboard/cookbook_events</code> page, it redirects us to <code class="literal">/dashboard/cookbook_events/list/</code>. This is intentional. The way that the dashboard is organized requires add-ons to have a <a id="id662" class="indexterm"/>parent page. That will allow our <span class="strong"><strong>Event List</strong></span> and <span class="strong"><strong>Add Event</strong></span> single pages to appear in the dashboard menu correctly.</p><p>This list page is still completely empty. Let's add some HTML to it and fill it out.</p></div></div>
<div class="section" title="Creating the list single page"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec168"/>Creating the list single page</h1></div></div></div><p>First, we will add some logic to the list page's controller file. Open <code class="literal">/packages/cookbook_events/controllers/dashboard/cookbook_events/list.php</code> in your code editor.</p><p>Add a view method to the <a id="id663" class="indexterm"/>controller class:</p><div class="informalexample"><pre class="programlisting">public function view() {
    Loader::model('cookbook_event', 'cookbook_events');
    $event = new CookbookEvent();
    $events = $event-&gt;find('1=1 ORDER BY event_date');
    $this-&gt;set('events', $events);
}
public function delete($id = null) {
    if ($id) {
        Loader::model('cookbook_event', 'cookbook_events');
        $event = new CookbookEvent();
        $event-&gt;load('id = ?', $id);
        $event-&gt;delete();
        $this-&gt;redirect('/dashboard/cookbook_events/list?deleted');
    }
}</pre></div><p>Remember that <code class="literal">view()</code> is one of the automatic callback functions that gets executed when the single page is viewed. Here, we are loading the <code class="literal">model</code> class that we created and are using it to find all instances of the events in the database. We then send the array of event objects to the view, using <code class="literal">$this-&gt;set()</code>.</p><p>We also added a function to delete events from the system, using the <code class="literal">model</code> class and active record.</p><div class="section" title="Creating the list view"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec581"/>Creating the list view</h2></div></div></div><p>Let's open up the view and add <a id="id664" class="indexterm"/>some HTML to it. Open <code class="literal">/packages/cookbook_events/single_pages/dashboard/cookbook_events/list.php</code> in your editor.</p><p>Add the following HTML code to the view file:</p><div class="informalexample"><pre class="programlisting">&lt;?php defined('C5_EXECUTE') or die(_("Access Denied.")); ?&gt;
&lt;div class="ccm-ui"&gt;
   
   &lt;?php if (isset($_GET['success'])): ?&gt;
      &lt;div class="alert-message"&gt;
         &lt;?php echo t('The event was saved successfully!') ?&gt;
      &lt;/div&gt;
   &lt;?php endif; ?&gt;
   &lt;?php if (isset($_GET['deleted'])): ?&gt;
      &lt;div class="alert-message"&gt;
         &lt;?php echo t('The event was deleted successfully!') ?&gt;
      &lt;/div&gt;
   &lt;?php endif; ?&gt;
   &lt;div class="ccm-pane"&gt;
      &lt;?php
         $dashboard = Loader::helper('concrete/dashboard');
         echo $dashboard-&gt;getDashboardPaneHeader(t('Events'));
      ?&gt;
      &lt;div class="ccm-pane-body"&gt;
         &lt;?php if (!empty($events)): ?&gt;
            &lt;table class="table table-striped table-bordered"&gt;
               &lt;tr&gt;
                  &lt;th&gt;&lt;?php echo t('Event ID') ?&gt;&lt;/th&gt;
                  &lt;th&gt;&lt;?php echo t('Date') ?&gt;&lt;/th&gt;
                  &lt;th&gt;&lt;?php echo t('Title') ?&gt;&lt;/th&gt;
                  &lt;th&gt;&lt;?php echo t('Location') ?&gt;&lt;/th&gt;
                  &lt;th&gt;&lt;?php echo t('Actions') ?&gt;&lt;/th&gt;
               &lt;/tr&gt;
               &lt;?php foreach ($events as $event): ?&gt;
                  &lt;tr class="event-row"&gt;
                     &lt;td&gt;&lt;?php echo $event-&gt;id ?&gt;&lt;/td&gt;
                     &lt;td&gt;&lt;?php echo $event-&gt;getDate() ?&gt;&lt;/td&gt;
                     &lt;td&gt;&lt;?php echo $event-&gt;title ?&gt;&lt;/td&gt;
                     &lt;td&gt;&lt;?php echo $event-&gt;location ?&gt;&lt;/td&gt;
                     &lt;td&gt;
                        &lt;a href="&lt;?php echo $this-&gt;url('/dashboard/cookbook_events/add/edit/', $event-&gt;id) ?&gt;" class="btn"&gt;&lt;?php echo t('Edit') ?&gt;&lt;/a&gt;
                        &lt;a href="&lt;?php echo $this-&gt;action('delete', $event-&gt;id) ?&gt;" class="btn danger delete"&gt;&lt;?php echo t('Delete') ?&gt;&lt;/a&gt;
                     &lt;/td&gt;
                  &lt;/tr&gt;
               &lt;?php endforeach; ?&gt;
            &lt;/table&gt;
         &lt;?php else: ?&gt;
            &lt;p&gt;
               &lt;?php echo t('There are no events! Add one now.'); ?&gt;
            &lt;/p&gt;
         &lt;?php endif; ?&gt;
      &lt;/div&gt;
      &lt;div class="ccm-pane-footer"&gt;&lt;/div&gt;
   &lt;/div&gt;
&lt;/div&gt;</pre></div><p>There's a lot here, but it's actually not too complex. First, we make sure to include the <code class="literal">defined or die</code> statement at the top of the file. Next, we output the header of the dashboard pane. This includes the controls to navigate around our add-on, as well as add the page to the main dashboard menu.</p><p>A little further down, we check to see if there's anything in the <code class="literal">$events</code> array. If there are, we can show the list of events in an HTML table. If there aren't, we will show a message to the user that there are no events in the system.</p><p>Next, we create an HTML table to <a id="id665" class="indexterm"/>hold the events. The table has five columns: the event ID, the event date, the title, location, and a column for some actions to be performed on the event.</p><p>Once we begin looping through the events array, we will output one table row for each event in the system. Each column in the event row will output the corresponding field on the event. Notice the use of the date getter function to output a nicely formatted date.</p><p>The last column contains the buttons to edit and delete an event. We added an additional CSS class of <code class="literal">.delete</code> to the <span class="strong"><strong>Delete</strong></span> button that will allow us to use JavaScript to display a confirmation message. Let's save this file and refresh the page:</p><div class="mediaobject"><img src="graphics/4548OS_AppB_02.jpg" alt="Creating the list view"/></div><p>Looking good, except we don't <a id="id666" class="indexterm"/>have any events in our system yet. Let's create the form to add events.</p></div></div>
<div class="section" title="Creating the add form single page"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec169"/>Creating the add form single page</h1></div></div></div><p>Open <code class="literal">/packages/cookbook_events/controllers/dashboard/cookbook_events/add.php</code> in your code <a id="id667" class="indexterm"/>editor. Let's add a few functions to this class:</p><div class="informalexample"><pre class="programlisting">public function edit($id = null) {
   if ($id) {
      // in edit mode, load the event to be edited
       Loader::model('cookbook_event', 'cookbook_events');
      $event = new CookbookEvent();
      $event-&gt;load('id = ?', $id);
      // pass the event object to the view as an array
      $this-&gt;set('data', (array) $event);
   }
}

public function save() {
   $data = $_POST;
   // verify that all required fields have been filled out
   $val = Loader::helper('validation/form');
   $val-&gt;setData($data);
   $val-&gt;addRequired('title', t('Please enter a title.'));
   $passed = $val-&gt;test();
   if (!$passed) {
      $this-&gt;set('errors', $val-&gt;getError()-&gt;getList());
   }
   else {
      $dth = Loader::helper('form/date_time');
      Loader::model('cookbook_event', 'cookbook_events');
      $event = new CookbookEvent();
      if ($data['id']) {
         $event-&gt;load('id = ?', $data['id']);
      }
      $event-&gt;title = $data['title'];
      $event-&gt;event_date = $dth-&gt;translate('event_date');
      if ($data['location']) {
         $event-&gt;location = $data['location'];
      }
      if ($data['description']) {
         $event-&gt;description = $data['description'];
      }
      if (!$data['id']) {
         $user = new User();
         $event-&gt;created_by = $user-&gt;getUserID();
         $event-&gt;created_at = date('Y-m-d H:i:s');
      }
      $event-&gt;save();
      
      $this-&gt;redirect('/dashboard/cookbook_events/list?success');
   }
}</pre></div><p>First, we added a function to provide editing capabilities to this form. Essentially, if an ID is provided in the URL, we will use the event model to load the corresponding event and send it to the view as an array. We <a id="id668" class="indexterm"/>use an array because if the array is empty, the view will not produce errors as it would with an object.</p><p>Next, we define the function to actually save the new event. We use the Validation helper to verify that the required fields have been filled out. After that, we begin populating the event object to be saved to the database. One important thing to notice here is that we check for the presence of an event ID in the <code class="literal">POST</code> data. This is to allow us to edit an existing event, rather than create a <a id="id669" class="indexterm"/>duplicate one. We also use this area to set the metadata for the event, such as the ID of the user that added it, and the timestamp of when it was created.</p><p>Finally, we save the event object to <a id="id670" class="indexterm"/>the database and redirect the user back to the event list, displaying a success message.</p><div class="section" title="The form view file"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec582"/>The form view file</h2></div></div></div><p>Of course, we still need to write the <a id="id671" class="indexterm"/>other half of this single page, the view. Let's open <code class="literal">/packages/cookbook_events/single_pages/dashboard/cookbook_events/add.php</code> and add the following HTML and PHP code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php 
   defined('C5_EXECUTE') or die(_("Access Denied."));
   $form = Loader::helper('form');
   $dth = Loader::helper('form/date_time');
   
   Loader::element('editor_init');
   Loader::element('editor_config');
?&gt;
&lt;div class="ccm-ui"&gt;
   &lt;?php if (!empty($errors)): ?&gt;
      &lt;div class="alert-message block-message error"&gt;
         &lt;strong&gt;&lt;?php echo t('There were some problems saving the event.') ?&gt;&lt;/strong&gt;
         &lt;ul style="margin-top: 5px;"&gt;
            &lt;?php foreach ($errors as $e): ?&gt;
               &lt;li&gt;&lt;?php echo $e ?&gt;&lt;/li&gt;
            &lt;?php endforeach ?&gt;
         &lt;/ul&gt;
      &lt;/div&gt;
   &lt;?php endif; ?&gt;
   &lt;div class="ccm-pane"&gt;
      &lt;?php
         $dashboard = Loader::helper('concrete/dashboard');
         echo $dashboard-&gt;getDashboardPaneHeader(t('Add Event'));
      ?&gt;
      &lt;form action=&lt;?php echo $this-&gt;action('save') ?&gt; method="POST"&gt;
         &lt;div class="ccm-pane-body"&gt;
            &lt;table class="table table-striped table-bordered"&gt;
               &lt;tr&gt;
                  &lt;td class="form-label"&gt;
                     &lt;?php echo t('Event Title') ?&gt;
                     &lt;span class="req"&gt;*&lt;/span&gt;
                  &lt;/td&gt;
                  &lt;td&gt;
                     &lt;?php echo $form-&gt;text('title', $data['title']) ?&gt;
                  &lt;/td&gt;
               &lt;/tr&gt;
               &lt;tr&gt;
                  &lt;td class="form-label"&gt;
                     &lt;?php echo t('Event Date') ?&gt;
                     &lt;span class="req"&gt;*&lt;/span&gt;
                  &lt;/td&gt;
                  &lt;td&gt;
                     &lt;?php echo $dth-&gt;datetime('event_date', $data['event_date']) ?&gt;
                  &lt;/td&gt;
               &lt;/tr&gt;
               &lt;tr&gt;
                  &lt;td class="form-label"&gt;
                     &lt;?php echo t('Location') ?&gt;
                  &lt;/td&gt;
                  &lt;td&gt;
                     &lt;?php echo $form-&gt;text('location', $data['location']) ?&gt;
                  &lt;/td&gt;
               &lt;/tr&gt;
               &lt;tr&gt;
                  &lt;td class="form-label"&gt;
                     &lt;?php echo t('Description') ?&gt;
                  &lt;/td&gt;
                  &lt;td&gt;
                     &lt;?php
                        Loader::element('editor_controls');
                        echo $form-&gt;textarea('description', $data['description'], array('style' =&gt; 'width:100%;', 'class' =&gt; 'ccm-advanced-editor'));
                     ?&gt;
                  &lt;/td&gt;
               &lt;/tr&gt;
            &lt;/table&gt;
         &lt;/div&gt;
         &lt;div class="ccm-pane-footer"&gt;
            &lt;div class="pull-right"&gt;
               &lt;input type="submit" class="btn primary" value="&lt;?php echo t('Save Event') ?&gt;"&gt;
               &lt;a href="&lt;?php echo $this-&gt;url('/dashboard/cookbook_events/list') ?&gt;" class="btn"&gt;&lt;?php echo t('Cancel') ?&gt;&lt;/a&gt;
            &lt;/div&gt;
         &lt;/div&gt;
         &lt;?php if (!empty($data)): ?&gt;
            &lt;input type="hidden" name="id" value="&lt;?php echo $data['id'] ?&gt;"&gt;
         &lt;?php endif; ?&gt;
      &lt;/form&gt;
   &lt;/div&gt;
&lt;/div&gt;</pre></div><p>Whoa, that's a lot of code! Don't worry, it's not as complex as it looks. At the top of the file, we of course add our <code class="literal">defined or die</code> statement, and then load two helpers, the Form helper and the Date field helper.</p><p>As our event's description field can <a id="id672" class="indexterm"/>contain HTML formatting, we will need to use a WYSIWYG editor. That editor needs some special JavaScript on the page before it can load, so we output that right away using the <code class="literal">editor_init</code> and <code class="literal">editor_config</code> elements.</p><p>Next, we begin our output by displaying any errors that occurred in the save procedure (for example, if the title field was left empty). After that, we use concrete5's Dashboard helper to output the header of the page, including the native page controls.</p><p>After that, we will define the form, setting the action of the form to use the <code class="literal">save</code> function in this page's controller and setting the HTTP method to <code class="literal">POST</code>.</p><p>Inside the form, we use a table to give our form a simple layout. We output fields for title, location, date, and description. <a id="id673" class="indexterm"/>At the bottom of the page, we display some buttons to save the data or to cancel and return to the events listing. Let's take a look at this form in our browser now!</p><div class="mediaobject"><img src="graphics/4548OS_AppB_03.jpg" alt="The form view file"/></div><p>That looks great! Let's add a bunch of <a id="id674" class="indexterm"/>events to the site now, using this form.</p></div></div>
<div class="section" title="Adding events to the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec170"/>Adding events to the database</h1></div></div></div><p>Fill out the <span class="strong"><strong>Add Event</strong></span> form that <a id="id675" class="indexterm"/>comes up with a couple of events to add to <a id="id676" class="indexterm"/>the database:</p><div class="mediaobject"><img src="graphics/4548OS_AppB_04.jpg" alt="Adding events to the database"/></div><p>Once you have a few events entered, your list view should look something like the following:</p><div class="mediaobject"><img src="graphics/4548OS_AppB_05.jpg" alt="Adding events to the database"/></div><p>Looking great! Let's click on the <span class="strong"><strong>Delete</strong></span> button <a id="id677" class="indexterm"/>on one of these events. It works, but users don't have any chance to <a id="id678" class="indexterm"/>cancel that action if they change their mind. We should use JavaScript to ask users if they are sure they want to delete the event.</p></div>
<div class="section" title="Adding a delete confirmation"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec171"/>Adding a delete confirmation</h1></div></div></div><p>Let's add a new JavaScript file <a id="id679" class="indexterm"/>to <code class="literal">/packages/cookbook_events/js/list.js</code>. Add some JavaScript (using the jQuery library) to listen to the clicks on the <span class="strong"><strong>Delete</strong></span> button:</p><div class="informalexample"><pre class="programlisting">$(document).ready(function() {
   $('.delete').on('click', function(e) {
      return confirm('Are you sure you want to delete this item?');
   });
});</pre></div><p>Next, we need to make sure this script is included on our list page. Open up the controller for the list page located at <code class="literal">/packages/cookbook_events/controllers/dashboard/cookbook_events/list.php</code>.</p><p>Add a new function to include the JavaScript file on the page:</p><div class="informalexample"><pre class="programlisting">public function on_before_render() {
    $html = Loader::helper('html');
    $this-&gt;addHeaderItem($html-&gt;javascript('list.js', 'cookbook_events'));
}</pre></div><p>This function will use the HTML helper <a id="id680" class="indexterm"/>to automatically add the <code class="literal">&lt;script&gt;</code> tag to the page's <code class="literal">&lt;head&gt;</code> area.</p><p>Now, if you try to delete an event, you should see a confirmation dialog, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/4548OS_AppB_06.jpg" alt="Adding a delete confirmation"/></div><p>Perfect! We can consider the backend of the add-on to be complete! All that is left to do is displaying events on the frontend.</p></div>
<div class="section" title="Creating the custom block type"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec172"/>Creating the custom block type</h1></div></div></div><p>If you recall, we created some boilerplate <a id="id681" class="indexterm"/>files for our block type, but it doesn't actually do anything. We will want to create a block that shows a list of the events entered into the database.</p><p>First, let's add the HTML form to <code class="literal">form.php</code> that will be displayed whenever site editors add or edit the block on the site:</p><div class="informalexample"><pre class="programlisting">&lt;?php
defined('C5_EXECUTE') or die(_("Access Denied.")); 
$form = Loader::helper('form');
?&gt;
&lt;div class="ccm-ui"&gt;
   &lt;table class="table table-striped table-bordered"&gt;
      &lt;tr&gt;
         &lt;td&gt;
            &lt;?php echo t('Maximum events to show') ?&gt;
         &lt;/td&gt;
         &lt;td&gt;
            &lt;?php echo $form-&gt;text('item_limit', $item_limit) ?&gt;
         &lt;/td&gt;
      &lt;/tr&gt;
   &lt;/table&gt;
&lt;/div&gt;</pre></div><p>Great! Let's include this file in both <code class="literal">add.php</code> and <code class="literal">edit.php</code>. Add the following to each of those files:</p><div class="informalexample"><pre class="programlisting">&lt;?php 
defined('C5_EXECUTE') or die(_("Access Denied.")); 
include('form.php');</pre></div><p>Alright! All we have to do now is create the frontend view of the block. Open <code class="literal">view.php</code> in your code editor and enter the following HTML and PHP code:</p><div class="informalexample"><pre class="programlisting">&lt;?php defined('C5_EXECUTE') or die(_("Access Denied.")); ?&gt;
&lt;h1 class="events-title"&gt;&lt;?php echo t('Events Calendar') ?&gt;&lt;/h1&gt;
&lt;div class="events-list"&gt;
   &lt;?php if (!empty($events)): ?&gt;
      &lt;?php foreach ($events as $event): ?&gt;
         &lt;div class="event-item"&gt;
            &lt;h2&gt;&lt;?php echo $event-&gt;title ?&gt;&lt;/h2&gt;
            &lt;div class="event-date"&gt;
               &lt;?php echo $event-&gt;getDate() ?&gt;
               &lt;?php if ($event-&gt;location): ?&gt;
                  @ &lt;?php echo $event-&gt;location ?&gt;
               &lt;?php endif; ?&gt;
            &lt;/div&gt;
            &lt;?php if ($event-&gt;description): ?&gt;
               &lt;div class="event-description"&gt;
                  &lt;?php echo $event-&gt;description ?&gt;
               &lt;/div&gt;
            &lt;?php endif; ?&gt;
         &lt;/div&gt;
      &lt;?php endforeach; ?&gt;
   &lt;?php else: ?&gt;
      &lt;p&gt;&lt;?php echo t('There are no events!') ?&gt;&lt;/p&gt;
   &lt;?php endif; ?&gt;
&lt;/div&gt;</pre></div><p>That looks great! Here we are essentially looping through the <code class="literal">$events</code> array and displaying a row for each event. We <a id="id682" class="indexterm"/>again make use of the <code class="literal">getDate()</code> function on the <a id="id683" class="indexterm"/>event model to output a clean and friendly date.</p><p>Finally, let's add some simple CSS styles to <code class="literal">view.css</code>:</p><div class="informalexample"><pre class="programlisting">h1.events-title {
    margin-bottom: 30px !important;
}
.event-item {
    padding: 20px 0;
    border-bottom: 1px solid #ddd;
}
.event-item:last-child {
    border-bottom: 0;
}
.event-item p {
    margin: 0 !important;
}
.event-date {
    font-size: 12px;
    color: #888;
}</pre></div><p>Nice! Now we are ready to see it in action!</p></div>
<div class="section" title="Adding the block to a page"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec173"/>Adding the block to a page</h1></div></div></div><p>Create a new <a id="id684" class="indexterm"/>page <a id="id685" class="indexterm"/>on the site to hold the events:</p><div class="mediaobject"><img src="graphics/4548OS_AppB_07.jpg" alt="Adding the block to a page"/></div><p>Add a new block to <a id="id686" class="indexterm"/>this page. <a id="id687" class="indexterm"/>Scroll down to the bottom of the blocks list to see the block that we have created:</p><div class="mediaobject"><img src="graphics/4548OS_AppB_08.jpg" alt="Adding the block to a page"/></div><p>Fill out the form to add <a id="id688" class="indexterm"/>the block to the <a id="id689" class="indexterm"/>page. Set a limit for the amount of events to be displayed.</p><div class="mediaobject"><img src="graphics/4548OS_AppB_09.jpg" alt="Adding the block to a page"/></div><p>Now publish the <a id="id690" class="indexterm"/>changes on the page. You <a id="id691" class="indexterm"/>should see a handsome list of events!</p><div class="mediaobject"><img src="graphics/4548OS_AppB_10.jpg" alt="Adding the block to a page"/></div></div>
<div class="section" title="Wrapping up"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec174"/>Wrapping up</h1></div></div></div><p>Wow, we accomplished a lot! We started with absolutely nothing and built a fully functioning events calendar add-on. This add-on could be expanded to show alternate templates for the events, or to include advanced functionality such as hiding events that have already occurred, or giving each event its own page in the site map.</p><p>Hopefully this exercise has helped you get ideas on how to create packages for any need or situation.</p></div></body></html>