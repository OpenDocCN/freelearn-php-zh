<html><head></head><body><div class="appendix" title="Appendix&#xA0;A.&#xA0;An Arsenal of Tools"><div class="titlepage"><div><div><h1 class="title"><a id="appA"/>Appendix A. An Arsenal of Tools</h1></div></div></div><p>Laravel comes with several utilities that help you perform specific tasks, such as sending e-mails, queuing functions, and manipulating files. It ships with a ton of handy utilities that it uses internally; the good news is that you can also use them in your applications. This chapter will present the most useful utilities so you do not end up rewriting a function that already exists in the framework!</p><p>The structure of this <a id="id294" class="indexterm"/>chapter is partly based on <span class="emphasis"><em>Jesse O'Brien's</em></span> cheat sheet, which is accessible at <a class="ulink" href="http://cheats.jesse-obrien.ca/">http://cheats.jesse-obrien.ca/</a>. The examples are based on Laravel's tests as well as its official documentation and API.</p><div class="section" title="Array helpers"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec48"/>Array helpers</h1></div></div></div><p>Arrays are the bread and <a id="id295" class="indexterm"/>butter of any web application that deals with data. PHP already offers nearly 80 functions to perform various operations on arrays, and Laravel complements them with a handful of practical functions that are inspired by certain functions found in Python and Ruby.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>Several of Laravel's classes, including Eloquent collections, implement the PHP <code class="literal">ArrayAccess</code> interface. This means that you can use them like a normal array in your code and, for instance, iterate over the items in a <code class="literal">foreach</code> loop or use them with the array functions described here.</p></div></div><p>Most of the functions <a id="id296" class="indexterm"/>support a <span class="strong"><strong>dot notation</strong></span> to refer to nested values, which is similar to JavaScript objects. For example, rather than writing <code class="literal">$arr['foo']['bar']['baz']</code>, you can use the <code class="literal">array_get</code> helper and write <code class="literal">array_get($arr, 'foo.bar.baz');</code>.</p><p>In the following usage examples, we will use three dummy arrays and assume that they are reset for each example:</p><div class="informalexample"><pre class="programlisting">$associative = [
  'foo' =&gt; 1,
  'bar' =&gt; 2,
];
$multidimensional = [
  'foo' =&gt; [
      'bar' =&gt; 123,
  ],
];
$list_key_values = [
  ['foo' =&gt; 'bar'], 
  ['foo' =&gt; 'baz'],
];</pre></div><div class="section" title="The usage examples of array helpers"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec74"/>The usage examples of array helpers</h2></div></div></div><p>We will now take a look at <a id="id297" class="indexterm"/>how we can use Laravel's array helper functions to extract and manipulate the values of those arrays:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To retrieve a value with a fallback value if the key does not exist, we use the <code class="literal">array_get</code> function as follows:<div class="informalexample"><pre class="programlisting">array_get($multidimensional, 'foo.bar', 'default');
// Returns 123</pre></div><p>This is helpful if you are referencing an array key that may or may not exist (that is, in an array of request data). If the key does not exist, then the default value will be returned instead.</p></li><li class="listitem" style="list-style-type: disc">To remove a value from an array using the dot notation, we use the <code class="literal">array_forget</code> function as follows:<div class="informalexample"><pre class="programlisting">array_forget($multidimensional, 'foo.bar');
// $multidimensional == ['foo' =&gt; []];</pre></div></li><li class="listitem" style="list-style-type: disc">To remove a value from an array and return it, we use the <code class="literal">array_pull</code> function as follows:<div class="informalexample"><pre class="programlisting">array_pull($multidimensional, 'foo.bar');
// Returns 123 and removes the value from the array</pre></div></li><li class="listitem" style="list-style-type: disc">To set a nested value using the dot notation, we use the <code class="literal">array_set</code> function as follows:<div class="informalexample"><pre class="programlisting">array_set($multidimensional, 'foo.baz', '456');
// $multidimensional == ['foo' =&gt; ['bar' =&gt; 123, 'baz' =&gt; '456']];</pre></div></li><li class="listitem" style="list-style-type: disc">To flatten a multidimensional associative array, we use the <code class="literal">array_dot</code> function as follows:<div class="informalexample"><pre class="programlisting">array_dot($multidimensional);
// Returns ['foo.bar' =&gt; 123];
array_dot($list_key_values);
// Returns ['0.foo' =&gt; 'bar', '1.foo' =&gt; 'baz'];</pre></div></li><li class="listitem" style="list-style-type: disc">To return all of the keys and their values from the array except for the ones that are specified, we use the <code class="literal">array_except</code> function as follows:<div class="informalexample"><pre class="programlisting">array_except($associative, ['foo']);
// Returns ['bar' =&gt; 2];</pre></div></li><li class="listitem" style="list-style-type: disc">To only extract some <a id="id298" class="indexterm"/>keys from an array, we use the <code class="literal">array_only</code> function as follows:<div class="informalexample"><pre class="programlisting">array_only($associative, ['bar']);
// Returns ['bar' =&gt; 2];</pre></div></li><li class="listitem" style="list-style-type: disc">To return a flattened array containing all of the nested values (the keys are dropped), we use the <code class="literal">array_fetch</code> function as follows:<div class="informalexample"><pre class="programlisting">array_fetch($list_key_values, 'foo');
// Returns ['bar', 'baz'];</pre></div></li><li class="listitem" style="list-style-type: disc">To iterate over the array and return the first value for which the closure returns true, we use the <code class="literal">array_first</code> function as follows:<div class="informalexample"><pre class="programlisting">array_first($associative, function($key, $value) {
   return $key == 'foo';
});
// Returns 1</pre></div></li><li class="listitem" style="list-style-type: disc">To generate a one-dimensional array containing only the values that are found in a multidimensional array, we use the <code class="literal">array_flatten</code> function as follows:<div class="informalexample"><pre class="programlisting">array_flatten($multidimensional);
// Returns [123]</pre></div></li><li class="listitem" style="list-style-type: disc">To extract an array of values from a list of key-value pairs, we use the <code class="literal">array_pluck</code> function as follows:<div class="informalexample"><pre class="programlisting">array_pluck($list_key_values, 'foo');
// Returns ['bar', 'baz'];</pre></div></li><li class="listitem" style="list-style-type: disc">To get the first or last item of an array (this also works with the values returned by functions), we use the <code class="literal">head</code> and <code class="literal">last</code> functions as follows:<div class="informalexample"><pre class="programlisting">head($array); // Aliases to reset($array)
last($array); // Aliases to end($array)</pre></div></li></ul></div></div></div></div>
<div class="section" title="String and text manipulation"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec49"/>String and text manipulation</h1></div></div></div><p>The string manipulation <a id="id299" class="indexterm"/>functions are found in the <code class="literal">Illuminate\Support</code> <a id="id300" class="indexterm"/>namespace and are callable on the <code class="literal">Str</code> object.</p><p>Most of the functions also have shorter <code class="literal">snake_case</code> aliases. For example, the <code class="literal">Str::endsWith()</code> method is identical to the global <code class="literal">ends_with()</code> function. We are free to use whichever one we prefer in our application.</p><div class="section" title="Boolean functions"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec75"/>Boolean functions</h2></div></div></div><p>The following functions <a id="id301" class="indexterm"/>return the <code class="literal">true</code> or <code class="literal">false</code> values:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">is</code> method checks whether a value matches a pattern. The asterisk can be used as a wildcard character as shown here:<div class="informalexample"><pre class="programlisting">Str::is('projects/*', 'projects/php/'); // Returns true</pre></div></li><li class="listitem" style="list-style-type: disc">The <code class="literal">contains</code> method, as shown in the following code, checks whether a string contains a given substring:<div class="informalexample"><pre class="programlisting">Str::contains('Getting Started With Laravel', 'Python');
// returns false</pre></div></li><li class="listitem" style="list-style-type: disc">The <code class="literal">startsWith</code> and <code class="literal">endsWith</code> methods, as shown in the following code, check whether a string starts or ends with one or more substrings:<div class="informalexample"><pre class="programlisting">Str::startsWith('.gitignore', '.git'); // Returns true
Str::endsWith('index.php', ['html', 'php']); // Returns true</pre></div></li></ul></div><p>As you can see from the preceding examples, these methods are handy for validation filenames and similar data.</p></div><div class="section" title="Transformation functions"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec76"/>Transformation functions</h2></div></div></div><p>In some cases, you need to <a id="id302" class="indexterm"/>transform a string before displaying it to the user or using it in a URL. Laravel provides the following helpers to achieve this:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">This function generates a URL-friendly string:<div class="informalexample"><pre class="programlisting">Str::slug('A/B testing is fun!');
// Returns "ab-testing-is-fun"</pre></div></li><li class="listitem" style="list-style-type: disc">This function generates a title where every word is capitalized:<div class="informalexample"><pre class="programlisting">Str::title('getting started with laravel');
// Returns 'Getting Started With Laravel'</pre></div></li><li class="listitem" style="list-style-type: disc">This function caps a string with an instance of a given character:<div class="informalexample"><pre class="programlisting">Str::finish('/one/trailing/slash', '/');
Str::finish('/one/trailing/slash/', '/');
// Both will return '/one/trailing/slash/'</pre></div></li><li class="listitem" style="list-style-type: disc">This function limits the number of <span class="strong"><strong>characters</strong></span> in a string:<div class="informalexample"><pre class="programlisting">Str::limit($value, $limit = 100, $end = '...')</pre></div></li><li class="listitem" style="list-style-type: disc">This function limits the number of <span class="strong"><strong>words</strong></span> in a string:<div class="informalexample"><pre class="programlisting">Str::words($value, $words = 100, $end = '...')</pre></div></li></ul></div></div><div class="section" title="Inflection functions"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec77"/>Inflection functions</h2></div></div></div><p>The following functions <a id="id303" class="indexterm"/>help you find out the plural or singular form of a word, even if it is irregular:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">This function finds out the plural form of a word:<div class="informalexample"><pre class="programlisting">Str::plural('cat');
// Returns 'cats'
Str::plural('fish');
// Returns 'fish'
Str::plural('monkey');
// Returns 'monkeys'
</pre></div></li><li class="listitem" style="list-style-type: disc">This function finds out the singular form of a word:<div class="informalexample"><pre class="programlisting">Str::singular('elves');
// Returns 'elf'</pre></div></li></ul></div></div></div>
<div class="section" title="Dealing with files"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec50"/>Dealing with files</h1></div></div></div><p>Laravel 5 includes the <a id="id304" class="indexterm"/>excellent <span class="strong"><strong>Flysystem</strong></span> project for interacting with files <a id="id305" class="indexterm"/>both in the application filesystem, as well as popular cloud-based storage solutions such as <span class="strong"><strong>Amazon Simple Storage Service</strong></span> (<span class="strong"><strong>Amazon S3</strong></span>) and <span class="strong"><strong>Rackspace</strong></span>. Filesystems are configured as <span class="emphasis"><em>disks</em></span> in the <code class="literal">config/filesystems.php</code> file. You can then use a consistent API to manage files, whether they are located locally or in an external cloud store.</p><p>Calling methods directly on the <code class="literal">Storage</code> façade will call those methods on the default disk as follows:</p><div class="informalexample"><pre class="programlisting">Storage::exists('foo.txt');</pre></div><p>You can also explicitly specify the disk to perform actions on, in case you have more than one disk configured, as follows:</p><div class="informalexample"><pre class="programlisting">Storage::disk('local')-&gt;exists('foo.txt');</pre></div><p>You can read and write data to files as follows:</p><div class="informalexample"><pre class="programlisting">Storage::put('foo.txt', $contents);
$contents = Storage::get('foo.txt');</pre></div><p>You can also prepend or append data instead as follows:</p><div class="informalexample"><pre class="programlisting">Storage::prepend('foo.txt', 'Text to prepend.');
Storage::append('foo.txt', 'Text to append.');</pre></div><p>You can copy and move files with the aptly-named methods as follows:</p><div class="informalexample"><pre class="programlisting">Storage::copy($source, $destination);
Storage::move($source, $destination);</pre></div><p>And you can also delete files, either one at a time or multiple files in one go, by supplying an array of files to delete, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">Storage::delete('foo.txt');
Storage::delete(['foo.txt', 'bar.txt']);</pre></div><p>There are also various other helpful methods that allow you to retrieve useful information about a file as follows:</p><div class="informalexample"><pre class="programlisting">Storage::size('foo.txt');
Storage::lastModified('foo.txt');</pre></div><p>Apart from working with <a id="id306" class="indexterm"/>files, you can work with directories. To list all files within a particular directory use the following code:</p><div class="informalexample"><pre class="programlisting">Storage::files('path/to/directory');</pre></div><p>The preceding code will only list files in the current directory. If you wanted to list all files recursively (that is, files in the current directory and any subdirectories), then you can use the <code class="literal">allFiles</code> method as follows:</p><div class="informalexample"><pre class="programlisting">Storage::allFiles('path/to/directory');</pre></div><p>You can create directories as follows:</p><div class="informalexample"><pre class="programlisting">Storage::makeDirectory('path/to/directory');</pre></div><p>And you can also delete directories as follows:</p><div class="informalexample"><pre class="programlisting">Storage::deleteDirectory('path/to/directory');</pre></div><div class="section" title="File uploads"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec78"/>File uploads</h2></div></div></div><p>Handling file uploads is <a id="id307" class="indexterm"/>easy in Laravel 5. The first step is to create a form that will send files when submitted:</p><div class="informalexample"><pre class="programlisting">{!! Form::open(['files' =&gt; true) !!}</pre></div><p>This will set the <code class="literal">enctype</code> attribute to <code class="literal">multipart/form-data</code>. You then need an HTML <code class="literal">file</code> input:</p><div class="informalexample"><pre class="programlisting">{!! Form::file('avatar') !!}</pre></div><p>On submission, you can access the file from the <code class="literal">Request</code> object in your controller actions as follows:</p><div class="informalexample"><pre class="programlisting">public function store(Request $request){$file = $request-&gt;file('avatar');}</pre></div><p>From here, you will normally move the file to a directory of your choice:</p><div class="informalexample"><pre class="programlisting">public function store(Request $request)
{
  $file = $request-&gt;file('avatar');
  <span class="strong"><strong>$file-&gt;move(storage_path('uploads/avatars'));</strong></span>
}</pre></div><p>In the preceding example, <code class="literal">$file</code> is an instance of the <code class="literal">Symfony\Component\HttpFoundation\File\UploadedFile</code> class, which provides a number of handy methods for <a id="id308" class="indexterm"/>interacting with the uploaded file.</p><p>You can get the full path to the file as follows:</p><div class="informalexample"><pre class="programlisting">$path = $request-&gt;file('avatar')-&gt;getRealPath();</pre></div><p>You can get the name of the file as uploaded by the user as follows:</p><div class="informalexample"><pre class="programlisting">$name = $request-&gt;file('avatar')-&gt;getClientOriginalName();</pre></div><p>You can also retrieve just the extension of the original file as follows:</p><div class="informalexample"><pre class="programlisting">$ext = $request-&gt;file('avatar')-&gt;getClientOriginalExtension();</pre></div></div></div>
<div class="section" title="Sending e-mails"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec51"/>Sending e-mails</h1></div></div></div><p>Laravel's <code class="literal">Mail</code> class <a id="id309" class="indexterm"/>extends the popular Swift Mailer package, which makes sending e-mails a breeze. The e-mail templates are loaded in the same way as views, which means you can use the Blade syntax and inject data into your templates:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To inject some data into a template located inside <code class="literal">resources/views/email/view.blade.php</code>, we use the following function:<div class="informalexample"><pre class="programlisting">Mail::send('email.view', $data, function($message) {});</pre></div></li><li class="listitem" style="list-style-type: disc">To send both an HTML and a plain text version, we use the following function:<div class="informalexample"><pre class="programlisting">Mail::send(array('html.view', 'text.view'), $data, $callback);</pre></div></li><li class="listitem" style="list-style-type: disc">To delay the e-mail by 5 minutes (this requires a queue), we use the following function:<div class="informalexample"><pre class="programlisting">Mail::later(5, 'email.view', $data, function($message) {});</pre></div></li></ul></div><p>Inside the $<code class="literal">callback</code> closure that receives the message object, we can call the following methods to alter the message that is to be sent:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$message-&gt;subject('Welcome to the Jungle');</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$message-&gt;from('email@example.com', 'Mr. Example');</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$message-&gt;to('email@example.com', 'Mr. Example');</code></li></ul></div><p>Some of the less common methods include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$message-&gt;sender('email@example.com', 'Mr. Example');</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$message-&gt;returnPath('email@example.com');</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$message-&gt;cc('email@example.com', 'Mr. Example');</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$message-&gt;bcc('email@example.com', 'Mr. Example');</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$message-&gt;replyTo('email@example.com', 'Mr. Example');</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$message-&gt;priority(2);</code></li></ul></div><p>To attach or embed files, you can use the following methods:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$message-&gt;attach('path/to/attachment.txt');</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$message-&gt;embed('path/to/attachment.jpg');</code></li></ul></div><p>If you already have the <a id="id310" class="indexterm"/>data in memory, and you do not want to create additional files, you can use either the <code class="literal">attachData</code> or the <code class="literal">embedData</code> method as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$message-&gt;attachData($data, 'attachment.txt');</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$message-&gt;embedData($data, 'attachment.jpg');</code></li></ul></div><p>Embedding is generally done with image files, and you can use either the <code class="literal">embed</code> or the <code class="literal">embedData</code> method directly inside the body of a message, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">&lt;p&gt;Product Screenshot:&lt;/p&gt;
&lt;p&gt;{!! $message-&gt;embed('screenshot.jpg') !!}&lt;/p&gt;</pre></div></div>
<div class="section" title="Easier date and time handling with Carbon"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec52"/>Easier date and time handling with Carbon</h1></div></div></div><p>Laravel <a id="id311" class="indexterm"/>bundles Carbon (<a class="ulink" href="https://github.com/briannesbitt/Carbon">https://github.com/briannesbitt/Carbon</a>), which extends and augments PHP's native <code class="literal">DateTime</code> object <a id="id312" class="indexterm"/>with more expressive methods. Laravel uses it mainly to <a id="id313" class="indexterm"/>provide more expressive methods on the date and time properties (<code class="literal">created_at</code>, <code class="literal">updated_at</code>, and <code class="literal">deleted_at</code>) of an Eloquent object. However, since the library is already there, it would be a shame not to use it elsewhere in the code of your application.</p><div class="section" title="Instantiating Carbon objects"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec79"/>Instantiating Carbon objects</h2></div></div></div><p>Carbon objects are <a id="id314" class="indexterm"/>meant to be instantiated like normal <code class="literal">DateTime</code> objects. They do, however, support a handful of more expressive methods:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Carbon objects can be instantiated using the default constructor that will use the current date and time as follows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$now = new Carbon();</code></li></ul></div></li><li class="listitem" style="list-style-type: disc">They can be instantiated using the current date and time in a given timezone as follows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$jetzt = new Carbon('Europe/Berlin');</code></li></ul></div></li><li class="listitem" style="list-style-type: disc">They can be instantiated using expressive methods as follows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$yesterday = Carbon::yesterday();</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$demain = Carbon::tomorrow('Europe/Paris');</code></li></ul></div></li><li class="listitem" style="list-style-type: disc">They can be <a id="id315" class="indexterm"/>instantiated using exact parameters as follows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Carbon::createFromDate($year, $month, $day, $tz);</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Carbon::createFromTime($hour, $minute, $second, $tz);</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Carbon::create($year, $month, $day, $hour, $minute, $second, $tz);</code></li></ul></div></li></ul></div></div><div class="section" title="Outputting user-friendly timestamps"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec80"/>Outputting user-friendly timestamps</h2></div></div></div><p>We can generate <a id="id316" class="indexterm"/>human-readable, relative timestamps such as <span class="emphasis"><em>5 minutes ago</em></span>, <span class="emphasis"><em>last week</em></span>, or <span class="emphasis"><em>in a year</em></span> with the <code class="literal">diffForHumans()</code> method as follows:</p><div class="informalexample"><pre class="programlisting">$post = App\Post::find(123);
echo $post-&gt;created_at-&gt;diffForHumans(); </pre></div></div><div class="section" title="Boolean methods"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec81"/>Boolean methods</h2></div></div></div><p>Carbon also provides a <a id="id317" class="indexterm"/>handful of simple and expressive <a id="id318" class="indexterm"/>methods that will come in handy in your controllers and views:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$date-&gt;isWeekday();</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$date-&gt;isWeekend();</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$date-&gt;isYesterday();</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$date-&gt;isToday();</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$date-&gt;isTomorrow();</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$date-&gt;isFuture();</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$date-&gt;isPast();</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$date-&gt;isLeapYear();</code></li></ul></div></div><div class="section" title="Carbon for Eloquent DateTime properties"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec82"/>Carbon for Eloquent DateTime properties</h2></div></div></div><p>To be able to call <a id="id319" class="indexterm"/>Carbon's methods on attributes stored as <code class="literal">DATE</code> or <code class="literal">DATETIME</code> types in the database, you need to list them in a <code class="literal">$dates</code> property in the model:</p><div class="informalexample"><pre class="programlisting">class Post extends Model {
  // ...
  protected $dates = [
    'published_at',
    'deleted_at',
  ];
}
</pre></div><p>You don't need to include <code class="literal">created_at</code> or <code class="literal">updated_at</code>, as these are automatically treated as dates.</p></div></div>
<div class="section" title="Don't wait any longer with queues"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec53"/>Don't wait any longer with queues</h1></div></div></div><p>Queues allow you to defer the <a id="id320" class="indexterm"/>execution of functions without blocking the script. They can be used to run all sorts of functions, from e-mailing a large number of users to generating PDF reports.</p><p>Laravel 5 is compatible with the following queue drivers:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Beanstalkd, with the <code class="literal">pda/pheanstalk</code> package</li><li class="listitem" style="list-style-type: disc">Amazon SQS, with the <code class="literal">aws/aws-sdk-php</code> package</li><li class="listitem" style="list-style-type: disc">IronMQ, with the <code class="literal">iron-io/iron_mq</code> package</li></ul></div><p>Each queue system has its advantages. Beanstalkd can be installed on your own server; Amazon SQS might be more cost-effective and require less maintenance, as will IronMQ, which is also cloud-based. The latter also lets you set up <span class="emphasis"><em>push queues</em></span>, which are great if you cannot run background jobs on your server.</p><div class="section" title="Creating a command and pushing it onto the queue"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec83"/>Creating a command and pushing it onto the queue</h2></div></div></div><p>Jobs come in the form of <a id="id321" class="indexterm"/>commands. Commands can be either self-handling or not. In the latter case, a corresponding handler class would take the data from the command class and then act upon it.</p><p>Command classes reside in the <code class="literal">app/Commands</code> directory, and command handler classes can be found in the <code class="literal">app/Handlers/Commands</code> directory. Classes for a command and its handler can be generated with an Artisan command as follows:</p><div class="informalexample"><pre class="programlisting">$ php artisan make:command CommandName --handler --queued</pre></div><p>The <code class="literal">--handler</code> option tells Artisan to create a handler class (omitting this option would create a self-handling command class only), and the <code class="literal">--queued</code> option designates that this should be added to the queue, instead of being handled synchronously.</p><p>You can then use the <code class="literal">Queue</code> façade to add the command to the queue:</p><div class="informalexample"><pre class="programlisting">Queue::push(new SendConfirmationEmail($order));</pre></div><p>Alternatively, you can dispatch commands using the <span class="strong"><strong>command bus</strong></span>. The command bus is set up by default in controllers using the <code class="literal">DispatchesCommands</code> trait. This means in your controller actions you <a id="id322" class="indexterm"/>could use the <code class="literal">dispatch</code> method:</p><div class="informalexample"><pre class="programlisting">public function purchase(Product $product)
{
  // Create order
  <span class="strong"><strong>$this-&gt;dispatch(new SendConfirmationEmail($order));</strong></span>
}</pre></div><p>Commands are simple classes that contain the data needed to execute an action—the handler then performs the actual processing at a later stage using the data provided by the command. An example may be sending a confirmation e-mail after an order is placed. The command for this will look like the following:</p><div class="informalexample"><pre class="programlisting">&lt;?php namespace App\Commands;

use App\Order;
use Illuminate\Contracts\Queue\ShouldBeQueued; 
use Illuminate\Queue\InteractsBeQueued;
use Illuminate\Queue\SerializesModels; 

class SendConfirmationEmail extends Command implements ShouldBeQueued {

  use InteractsWithQueue, SerializesModels;

  public $order;

  public function __construct(Order $order) {
    $this-&gt;order = $order;
  }
}</pre></div><p>The handler—when executed by the queue—will then perform the actual sending of the e-mail, passing the order to the <a id="id323" class="indexterm"/>e-mail template to display the details of the customer's purchase as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?php namespace App\Handlers\Commands;

use App\Commands\SendConfirmationEmail;
use Illuminate\Contracts\Mail\Mailer;
use Illuminate\Queue\InteractsWithQueue;

class SendConfirmationEmailHandler {

  public function __construct(Mailer $mail) {
    $this-&gt;mail = $mail;
  }

  public function handle(SendConfirmationEmail $command) {
    $order = $command-&gt;order;
    $data = compact('order');
    $this-&gt;mail-&gt;send('emails.order.confirmation', $data, function($message) use ($order) {
      $message-&gt;subject('Your order confirmation');
      $message-&gt;to(
        $order-&gt;customer-&gt;email,
        $order-&gt;customer-&gt;name
      );
    });
  }
}</pre></div><p>As command handlers are resolved via the service container, we can type-hint dependencies. In the preceding case, we need the mailer service, so we type-hint the contract to get an implementation. We can then use the mailer to send an e-mail to the customer using the order data received from the command class.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>The <code class="literal">app/Commands</code> directory will be renamed <code class="literal">app/Jobs</code> from Laravel 5.1 to indicate it is primarily for queued jobs.</p></div></div></div><div class="section" title="Listening to a queue and executing jobs"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec84"/>Listening to a queue and executing jobs</h2></div></div></div><p>The following are <a id="id324" class="indexterm"/>the functions used for listening to a queue and executing <a id="id325" class="indexterm"/>jobs:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We can listen to the default queue as follows:<div class="informalexample"><pre class="programlisting">$ php artisan queue:listen</pre></div></li><li class="listitem" style="list-style-type: disc">We can specify the connection on which to listen as follows:<div class="informalexample"><pre class="programlisting">$ php artisan queue:listen connection</pre></div></li><li class="listitem" style="list-style-type: disc">We can specify multiple connections in the order of their priority as follows:<div class="informalexample"><pre class="programlisting">$ php artisan queue:listen important,not-so-important</pre></div></li></ul></div><p>The <code class="literal">queue:listen</code> <a id="id326" class="indexterm"/>command has to run in the background in order to process the <a id="id327" class="indexterm"/>jobs as they arrive from the queue. To make sure that it runs permanently, you have to use a process control system such as <span class="strong"><strong>forever</strong></span> (<a class="ulink" href="https://github.com/nodejitsu/forever">https://github.com/nodejitsu/forever</a>) or <span class="strong"><strong>supervisor</strong></span> (<a class="ulink" href="http://supervisord.org/">http://supervisord.org/</a>).</p></div><div class="section" title="Getting notified when a job fails"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec85"/>Getting notified when a job fails</h2></div></div></div><p>To get notified when a <a id="id328" class="indexterm"/>job fails, we use the following functions and commands:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The following event listener is used for finding the failed jobs:<div class="informalexample"><pre class="programlisting">Queue::failing(function($job, $data) {
  // Send email notification
});</pre></div></li><li class="listitem" style="list-style-type: disc">Any of the failed jobs can be stored in a database table and viewed with the following commands:<div class="informalexample"><pre class="programlisting">$ php artisan queue:failed-table // Create the table 
$ php artisan queue:failed // View the failed jobs</pre></div></li></ul></div></div><div class="section" title="Queues without background processes"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec86"/>Queues without background processes</h2></div></div></div><p>Push queues do not <a id="id329" class="indexterm"/>require a background process but they only work with the <code class="literal">iron.io</code> driver. Push queues will call an endpoint in your application when a job is received, rather than to a queue that is handled by a constantly-running worker process. This is handy if you do not have the ability to define the processes, which run on your application's server (such as is the case on shared hosting packages). After signing up for an account on <code class="literal">iron.io</code> and adding your credentials to <code class="literal">app/config/queue.php</code>, you use them by defining a <code class="literal">POST</code> route that receives all the incoming jobs. This route calls <code class="literal">Queue::marshal()</code>, which is the method responsible for firing the correct job handler:</p><div class="informalexample"><pre class="programlisting">Route::post('queue/receive', function() {
  return Queue::marshal();
});</pre></div><p>This route then needs to be registered as a subscriber with the <code class="literal">queue:subscribe</code> command:</p><div class="informalexample"><pre class="programlisting">$ php artisan queue:subscribe queue_name http://yourapp.example.com/queue/receive</pre></div><p>Once the URL is subscribed on <a class="ulink" href="http://iron.io/">http://iron.io/</a>, any newly created jobs with <code class="literal">Queue::push()</code> will be <a id="id330" class="indexterm"/>sent from Iron back to your application via a <code class="literal">POST</code> request.</p></div></div>
<div class="section" title="Where to go next?"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec54"/>Where to go next?</h1></div></div></div><p>The following is a <a id="id331" class="indexterm"/>list of the resources and sites that you can visit to keep up with the latest changes in Laravel:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://twitter.com/laravelphp">http://twitter.com/laravelphp</a> on Twitter for regular updates</li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://laravel.com/docs">http://laravel.com/docs</a> for the complete documentation</li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://laravel.com/api">http://laravel.com/api</a> for the browsable API</li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://laracasts.com">http://laracasts.com</a> for screencast tutorials</li></ul></div></div></body></html>