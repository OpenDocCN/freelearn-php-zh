<html><head></head><body><div class="chapter" title="Chapter&#xA0;11.&#xA0;SEO, Caching, and Logging"><div class="titlepage"><div><div><h1 class="title"><a id="ch11"/>Chapter 11. SEO, Caching, and Logging</h1></div></div></div><p>In this chapter, you will learn:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using SEO-friendly URLs in CodeIgniter</li><li class="listitem" style="list-style-type: disc">Using CodeIgniter caching</li><li class="listitem" style="list-style-type: disc">Logging errors with CodeIgniter</li><li class="listitem" style="list-style-type: disc">Benchmarking your application</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec99"/>Introduction</h1></div></div></div><p>In this chapter, we'll be taking a look at various caching recipes, which can be used with CodeIgniter. We'll be using the CodeIgniter caching functionality to help us store a data feed and database results--although the data feed and database results are really only there as a means to show you how to get data into CodeIgniter, so it can cache it--the data input can be anything you wish. We'll also look at ways to implement SEO-friendly URLs using CodeIgniter routing.</p></div></div>
<div class="section" title="Using SEO-friendly URLs in CodeIgniter"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec100"/>Using SEO-friendly URLs in CodeIgniter</h1></div></div></div><p>At some point, you might want to <a id="id723" class="indexterm"/>alter how CodeIgniter handles the routing of URLs <a id="id724" class="indexterm"/>to controllers. By default, CodeIgniter splits a URL into several different parts. You obviously have the domain section of the URL (<code class="literal">www.domain.com</code>), but after that there are (usually, but not always) up to three more items, each separated by a forward slash. The first item is the controller, the second is the function (or method, if you want) in the controller, and the third is a parameter that you will pass to the function in the controller.  </p><p>So, a standard URL in CodeIgniter might look like <code class="literal">www.domain.com/users/edit/1</code>. So, user number <code class="literal">1</code> is being edited using the <code class="literal">edit</code> function in the <code class="literal">users</code> controller--that seems simple enough and I'm sure you're familiar with it.</p><p>However, there may be times when you wish this to change. It is possible to alter what is displayed in the URL in the web browser's address bar to show something different from <code class="literal">controller/function/data</code>. It is possible to set up a rule in the <code class="literal">config/routes</code>.php file, which will map a URL to a controller, but hide this from the address bar; for example, you may have a controller named <code class="literal">bulletin</code>, which you wish to be displayed as <code class="literal">news</code> in the URL.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec217"/>How to do it...</h2></div></div></div><p>We're going to create one file and amend another file, by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">/path/to/codeigniter/application/controllers/shop.php</code> file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Shop extends CI_Controller {
  function __construct() {
    parent::__construct();
  }

  public function index() {
    echo 'Controller: ' . __CLASS__ . ', Method: ' . __FUNCTION__;
  }

  public function product() {
    echo 'Controller: ' . __CLASS__ . ', Method: ' . __FUNCTION__;
    echo '&lt;br /&gt;';
    echo 'Product ID: ' . $this-&gt;uri-&gt;segment(2);
  }

  public function all() {
    echo 'Controller: ' . __CLASS__ . ', Method: ' . __FUNCTION__;
  }
}</pre></div></li><li class="listitem">Open the <code class="literal">/path/to/codeigniter/config/routes.php</code> file in your editor and amend accordingly (the changes are highlighted):<div class="informalexample"><pre class="programlisting">$route['default_controller'] = "default_controller";
$route['404_override'] = '';

<span class="strong"><strong>$route['item/(:any)'] = "shop/product";</strong></span>
<span class="strong"><strong>$route['item'] = "shop/all";</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec218"/>How it works...</h2></div></div></div><p>Take a <a id="id725" class="indexterm"/>look at the <a id="id726" class="indexterm"/>following lines in the <code class="literal">config/routes.php</code> file:</p><div class="informalexample"><pre class="programlisting">$route['item/(:any)'] = "shop/product";
$route['item'] = "shop/all";</pre></div><p>Now, think of them as being made up of a left and a right, in that before the <code class="literal">=</code> sign is left and anything after the <code class="literal">=</code> sign is right; the left maps to the right and the value in the left will be mapped to the value in the right.</p><p>In the preceding example, any URL whose controller name begins with <code class="literal">item</code> will be mapped to the <code class="literal">shop</code> controller. Let's look at each rule in turn:</p><p>By typing the name of the route into your browser (for example, <code class="literal">http://www.your_web_site_name.com/item</code>), the <code class="literal">item</code> command will cause CodeIgniter to call the <code class="literal">shop</code> <a id="id727" class="indexterm"/>controller, and within that controller the <code class="literal">public function all()</code> method. Because we defined it in the routes file, you will see this in your browser by typing <code class="literal">item</code> into the URL. CodeIgniter maps the requested URL to the path defined in the route rule, and (in our example) calls the <code class="literal">shop</code> controller, which using <code class="literal">__CLASS__</code> and <code class="literal">__FUNCTION__</code> will write the following output to the browser:</p><div class="mediaobject"><img src="graphics/2308OS_11_01.jpg" alt="How it works..."/></div><p>Now, take a look at the URL in the browser address bar, it will still display the item, but the text on the screen says it's the <code class="literal">shop</code> controller that is being called. We have now mapped the URL to a controller and the user is none the wiser.</p><p>Now, let's look at the other route rule--<code class="literal">:any</code>. <a id="id728" class="indexterm"/>By typing the name of the route into your browser (for example, <code class="literal">http://www.your_web_site_name.com/item/123456</code>), the <code class="literal">item/123456</code> command will cause CodeIgniter to call the <code class="literal">shop</code> controller and <code class="literal">public function product()</code> because we defined it in the routes file. In <code class="literal">public function product()</code>, we echo out not only the <code class="literal">__CLASS__</code> and <code class="literal">__FUNCTION__ </code> names, but also the second segment of the URI:</p><div class="informalexample"><pre class="programlisting">$this-&gt;uri-&gt;segment(2);</pre></div><p>Which, in this case, is the ID of the product (<code class="literal">12356</code>), so you will see the following screenshot in the browser:</p><div class="mediaobject"><img src="graphics/2308OS_11_02.jpg" alt="How it works..."/></div><p>The key to this route is the <code class="literal">(:any)</code> flag in the route mapping rule; <code class="literal">(:any)</code> tells CodeIgniter that the second segment in the URI, whatever it is, should map to the <code class="literal">product</code> function of the <code class="literal">shop</code> controller. As we're the ones building the code, we will know that the second URI segment in the URL is a product ID, which we can use to query the database for the details of that product.</p></div></div>
<div class="section" title="Using CodeIgniter caching"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec101"/>Using CodeIgniter caching</h1></div></div></div><p>You can use CodeIgniter <a id="id729" class="indexterm"/>caching to cache (or temporarily store)  practically anything. As an example of caching with <a id="id730" class="indexterm"/>CodeIgniter, we're going to cache an RSS feed. We could, of course, cache anything we wanted; however, caching an RSS feed is a good place to start. Working with RSS is quite simple and the recipe can easily be converted to cache feeds from other sources, such as a call to Twitter, for example.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec219"/>How to do it...</h2></div></div></div><p>We're going to <a id="id731" class="indexterm"/>create the <code class="literal">/path/to/codeigniter/application/controllers/rss_cache.php</code> file.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the preceding file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Rss_cache extends CI_Controller {
  function __construct() {
    parent::__construct();
    $this-&gt;load-&gt;helper('url');
    $this-&gt;load-&gt;helper('xml');
    $this-&gt;load-&gt;driver('cache', array('adapter' =&gt; 'apc'));
  }

  public function index() {
    $raw_feed = '&lt;?xml version = "1.0" encoding = "ISO-8859-1" ?&gt;
    &lt;rss version="2.0"&gt;
    &lt;channel&gt;
      &lt;title&gt;RSS Feed&lt;/title&gt;
        &lt;link&gt;http://www.domain.com&lt;/link&gt;
        &lt;description&gt;General Description&lt;/description&gt;
      &lt;item&gt;
        &lt;title&gt;RSS Item 1 Title&lt;/title&gt;
        &lt;link&gt;http://www.domain1.com/link1&lt;/link&gt;
        &lt;description&gt;Description of First Item&lt;/description&gt;
      &lt;/item&gt;
      &lt;item&gt;
        &lt;title&gt;RSS Item 2 Title&lt;/title&gt;
        &lt;link&gt;http://www.domain2.com/link2&lt;/link&gt;
        &lt;description&gt;Description of Second Item&lt;/description&gt;
      &lt;/item&gt;
      &lt;item&gt;
        &lt;title&gt;RSS Item 3 Title&lt;/title&gt;
        &lt;link&gt;http://www.domain3.com/link3&lt;/link&gt;
        &lt;description&gt;Description of Third Item&lt;/description&gt;
      &lt;/item&gt;
    &lt;/channel&gt;
    &lt;/rss&gt;';

    $feed = new SimpleXmlElement($raw_feed);

    if (!$cached_feed = $this-&gt;cache-&gt;get('rss')) {
      foreach ($feed-&gt;channel-&gt;item as $item) {
        $cached_feed . = $item-&gt;title . '&lt;br /&gt;' . $item-&gt;description . '&lt;br /&gt;&lt;br /&gt;';
      }

        $this-&gt;cache-&gt;save('rss', $cached_feed, 7);
    }

    echo $this-&gt;cache-&gt;get('rss');
    
  }

  public function clear_cache() {
    $this-&gt;cache-&gt;clean();
    redirect('rss_cache');
  }
}
?&gt;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec220"/>How it works...</h2></div></div></div><p>First, let's look at the <a id="id732" class="indexterm"/>constructor. <a id="id733" class="indexterm"/>We're loading one helper and one driver, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">function __construct() {
  parent::__construct();
  $this-&gt;load-&gt;helper('url');
  $this-&gt;load-&gt;driver('cache', array('adapter' =&gt; 'apc'));
}</pre></div><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip14"/>Tip</h3><p>To use APC, you'll need to ensure that APC is installed on the environment you're working on. If not, you'll need to install it. To do this, visit <a class="ulink" href="http://www.php.net/manual/en/apc.setup.php">http://www.php.net/manual/en/apc.setup.php</a> for more details.</p></div></div><p>The URL helper is there as we're using the <a id="id734" class="indexterm"/>
<code class="literal">redirect()</code> function and the cache driver is there to provide support to help us cache out data, in this case it's helping us cache data from the RSS feed--however, it really can be anything.</p><p>
<code class="literal">public function index()</code> first defines the <code class="literal">$rss_feed</code> variable with the hardcoded RSS feed; this is for illustration purposes really. In reality, you will fetch the feed using:</p><div class="informalexample"><pre class="programlisting">$raw_feed = file_get_contents('http://www.domain.com/rss_feed_url');</pre></div><p>However, it is convenient to hardcode it for this recipe, as by hard coding you will see the structure of the feed and know what it should "look" like</p><p>The feed has a simple structure containing <a id="id735" class="indexterm"/>only three items. The <code class="literal">$raw_feed</code> variable is passed to the PHP <code class="literal">SimpleXMLElement</code> class, which returns an object (<code class="literal">$feed</code>) for us to work with.</p><p>We then use CodeIgniter to check if there <a id="id736" class="indexterm"/>exists in cache an item named <code class="literal">rss</code>; if not, we'll loop through the <code class="literal">$feed</code> object, pulling out the title and description for each item in the RSS feed, and concatenate to a string, which is named <code class="literal">$cached_feed</code>.</p><div class="informalexample"><pre class="programlisting">if (!$cached_feed = $this-&gt;cache-&gt;get('rss')) {
  foreach ($feed-&gt;channel-&gt;item as $item) {
    $cached_feed .= $item-&gt;title . '&lt;br /&gt;' . $item-&gt;description . '&lt;br /&gt;&lt;br /&gt;';
  }
    $this-&gt;cache-&gt;save('rss', $cached_feed, 30);
}</pre></div><p>The <code class="literal">$cached_feed</code> string is saved to the cache with the name <code class="literal">rss</code> for a period of 30 seconds (for more on caching durations, refer to the following code):</p><div class="informalexample"><pre class="programlisting">$this-&gt;cache-&gt;save('rss', $cached_feed, 30);</pre></div><p>Once all items in the RSS feed have been processed, we'll echo out the cache item <code class="literal">rss</code>, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">echo $this-&gt;cache-&gt;get('rss');</pre></div><p>You should get something similar to the following output in your browser:</p><div class="informalexample"><pre class="programlisting">RSS Item 1 Title
Description of First Item
RSS Item 2 Title
Description of Second Item
RSS Item 3 Title
Description of Third Item</pre></div><p>Why 30 seconds? Because it'll be a good length of time for you to go to your browser, run the script, see the preceding output, and quickly dash back to the code in your text editor to change something in the feed (such as the title element of the third item to <code class="literal">Gigantic Elephants</code>). Click on <span class="strong"><strong>Save</strong></span>, and go back to the browser to refresh, which after 30 seconds (30 seconds since you first ran <code class="literal">rss_cache</code>) should give you the following output:</p><div class="informalexample"><pre class="programlisting">RSS Item 1 Title
Description of First Item
RSS Item 2 Title
Description of Second Item
Gigantic Elephants
Description of Third Item</pre></div><p>Should 30 seconds be too long for you to wait, you can always manually clear the cache by running <code class="literal">public function clear_cache()</code>, which will call the CodeIgniter <code class="literal">$this-&gt;cache-&gt;clean()</code> function and redirect us back to the <code class="literal">rss_cache</code> controller where the whole process will begin again.</p><p>Alternatively, you can decrease the <a id="id737" class="indexterm"/>length of time a cache stays valid from 30 seconds to, say, 10 seconds (but in reality, you'll want it to be a length of time that you feel is right for your server or data).</p><p>So now, you can see how to store data in the cache, it doesn't have to be XML or an RSS feed, it really could be data from any source: a database query (although CodeIgniter has specific database caching methods for that), a feed from a social link (such as a Twitter feed, or from Instagram), or even financial <a id="id738" class="indexterm"/>data such as the value of the FTSE fetched every 5 minutes (or however long you set it).</p><div class="section" title="Problems you may encounter"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec19"/>Problems you may encounter</h3></div></div></div><p>If you're developing on a MAC using MAMP, the chances are the the default caching method is XCache. CodeIgniter doesn't have a driver to work with XCache and you'll either need to write your own driver (go on be brave), or (as I did) change your caching engine to APC.</p><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip15"/>Tip</h3><p>
<span class="strong"><strong>APC</strong></span> (<span class="strong"><strong>Alternative PHP Caching</strong></span>) is a <a id="id739" class="indexterm"/>caching service, which in this case is provided by MAMP.</p></div></div><p>You'll need to tell MAMP to use APC rather than XCache. To do this, open your MAMP control panel and click on <span class="strong"><strong>Preferences</strong></span>, then click on the <span class="strong"><strong>PHP</strong></span> tab. You should now see a section named <span class="strong"><strong>PHP extensions</strong></span>. In that section should be a drop-down list (this is probably set to XCache); choose APC from this list, and click on the <span class="strong"><strong>OK</strong></span> button. MAMP will restart, and after this you should be good to go.</p></div></div></div>
<div class="section" title="Logging errors with CodeIgniter"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec102"/>Logging errors with CodeIgniter</h1></div></div></div><p>Logging errors which occur within <a id="id740" class="indexterm"/>your CodeIgniter application doesn't have to be limited to looking at the PHP or Apache logs; you can enable CodeIgniter to handle and log errors and other behaviors and events at certain points in your code using CodeIgniter's <a id="id741" class="indexterm"/>logging functionality. This facility can be particularly useful (if you set it up correctly) to track a user's journey and progress through the system and should something go wrong with whatever they're doing, you can look in the logs and trace what they did and when, and get a better idea of what (if at all) went wrong and hopefully think about how to prevent it from occurring again.</p><p>In this recipe, we're going to look at using the logging functionality within CodeIgniter and to track if something goes wrong with an operation.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec221"/>Getting ready</h2></div></div></div><p>We'll need to set the log reporting level in the config file so that CodeIgniter knows which level of logging messages to report on. The log's folder should also have write access, so perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">/path/to/codeigniter/application/config/config.php</code> file and find the following line:<div class="informalexample"><pre class="programlisting">$config['log_threshold'] = 0;</pre></div><p>You can change the value of the <code class="literal">log_threshold</code> config array element to one of the five states, as shown in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>State</p>
</th><th style="text-align: left" valign="bottom">
<p>Usage</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">0</code>
</p>
</td><td style="text-align: left" valign="top">
<p>-</p>
</td><td style="text-align: left" valign="top">
<p>CodeIgniter will not log anything.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">1</code>
</p>
</td><td style="text-align: left" valign="top"><p>
</p><div class="informalexample"><pre class="programlisting">log_message('error', 'Some Text')</pre></div>
</td><td style="text-align: left" valign="top">
<p>CodeIgniter will log error messages.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">2</code>
</p>
</td><td style="text-align: left" valign="top">
    <p>
</p><div class="informalexample"><pre class="programlisting">log_message('debug', 'Some Text')</pre></div><p>
    </p>
</td><td style="text-align: left" valign="top">
<p>CodeIgniter will log debugging messages.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">3</code>
</p>
</td><td style="text-align: left" valign="top">
 <p>
</p><div class="informalexample"><pre class="programlisting">log_message('info', 'Some Text');</pre></div><p>
 </p>
</td><td style="text-align: left" valign="top">
<p>CodeIgniter will log information messages.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">4</code>
</p>
</td><td style="text-align: left" valign="top">
<p>All of the above</p>
</td><td style="text-align: left" valign="top">
<p>CodeIgniter will log everything.</p>
</td></tr></tbody></table></div><p>For our recipe, I have set the value to <code class="literal">4</code> as I want to log any error messages or information messages that CodeIgniter might generate for me.</p></li><li class="listitem">Look for the line:<div class="informalexample"><pre class="programlisting">$config['log_path'] = '/path/to/log/folder/';.</pre></div><p>Ensure that <code class="literal">/path/to/log/folder/</code> is set correctly in <code class="literal">$config[' log_path']</code> and that the <a id="id742" class="indexterm"/>folder specified has write permissions (otherwise, CodeIgniter cannot write a log file to that folder).</p></li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec222"/>How to do it...</h2></div></div></div><p>We're going to use (as it was convenient) the <span class="emphasis"><em>Using CodeIgniter caching</em></span> recipe, mentioned earlier in this chapter, and alter it in such a way as to apply CodeIgniter logging. In this recipe, we've changed its name to <code class="literal">cache_log.php</code> (to keep it separate from <code class="literal">rss_cache.php</code>). So, if you haven't already done so (don't forget to <a id="id743" class="indexterm"/>change the name, highlighted in the following code):</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">/path/to/codeigniter/application/controllers/cache_log.php</code> file and add the following code to it (the changes are highlighted):<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Cache_log extends CI_Controller {
  function __construct() {
    parent::__construct();
    $this-&gt;load-&gt;helper('url');
    $this-&gt;load-&gt;helper('xml');
    $this-&gt;load-&gt;driver('cache', array('adapter' =&gt; 'apc'));
  }

  public function index() {
    $raw_feed = '&lt;?xml version="1.0" encoding="ISO-8859-1" ?&gt;
    &lt;rss version="2.0"&gt;
    &lt;channel&gt;
      &lt;title&gt;RSS Feed&lt;/title&gt;
        &lt;link&gt;http://www.domain.com&lt;/link&gt;
        &lt;description&gt;General Description&lt;/description&gt;
      &lt;item&gt;
        &lt;title&gt;RSS Item 1 Title&lt;/title&gt;
        &lt;link&gt;http://www.domain1.com/link1&lt;/link&gt;
        &lt;description&gt;Description of First Item&lt;/description&gt;
      &lt;/item&gt;
      &lt;item&gt;
        &lt;title&gt;RSS Item 2 Title&lt;/title&gt;
        &lt;link&gt;http://www.domain2.com/link2&lt;/link&gt;
        &lt;description&gt;Description of Second Item&lt;/description&gt;
      &lt;/item&gt;
      &lt;item&gt;
        &lt;title&gt;RSS Item 3 Title&lt;/title&gt;
        &lt;link&gt;http://www.domain3.com/link3&lt;/link&gt;
        &lt;description&gt;Description of Third Item&lt;/description&gt;
      &lt;/item&gt;
    &lt;/channel&gt;
    &lt;/rss&gt;';

    $feed = new SimpleXmlElement($raw_feed);

<span class="strong"><strong>    if (!$feed) {</strong></span>
<span class="strong"><strong>      log_message('error', 'Unable to instantiate SimpleXmlElement.');</strong></span>
<span class="strong"><strong>    } else {</strong></span>
<span class="strong"><strong>      log_message('info', 'SimpleXmlElement was instantiated correctly.');</strong></span>
<span class="strong"><strong>    }</strong></span>

<span class="strong"><strong>    if (!$cached_feed = $this-&gt;cache-&gt;get('rss')) {</strong></span>
<span class="strong"><strong>      foreach ($feed-&gt;channel-&gt;item as $item) {</strong></span>
<span class="strong"><strong>        $cached_feed .= $item-&gt;title . '&lt;br /&gt;' .$item-&gt;description . '&lt;br /&gt;&lt;br /&gt;';</strong></span>
<span class="strong"><strong>      }</strong></span>

<span class="strong"><strong>        $this-&gt;cache-&gt;save('rss', $cached_feed, 7);</strong></span>
<span class="strong"><strong>        log_message('info', 'Cache item saved.');</strong></span>
<span class="strong"><strong>    }</strong></span>

    echo $this-&gt;cache-&gt;get('rss');
    
  }

  public function clear_cache() {
<span class="strong"><strong>    if (!$this-&gt;cache-&gt;clean()) {</strong></span>
<span class="strong"><strong>      log_message('error', 'Unable to clear Cache.');</strong></span>
<span class="strong"><strong>    } else {</strong></span>
<span class="strong"><strong>      log_message('info', 'Cache cleared.');</strong></span>
<span class="strong"><strong>    }</strong></span>

    redirect('rss_cache');
  }
}
?&gt;</pre></div><p>If all goes well you <a id="id744" class="indexterm"/>shouldn't have any errors, but you should <a id="id745" class="indexterm"/>have some <code class="literal">DEBUG</code> data in the config file. When you  open that file you should see something similar to:</p><div class="informalexample"><pre class="programlisting">&lt;?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed'); ?&gt;

DEBUG - 2013-09-24 19:46:11 --&gt; Config Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; Hooks Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; Utf8 Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; UTF-8 Support Enabled
DEBUG - 2013-09-24 19:46:11 --&gt; URI Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; Router Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; Output Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; Security Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; Input Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; XSS Filtering completed
DEBUG - 2013-09-24 19:46:11 --&gt; XSS Filtering completed
DEBUG - 2013-09-24 19:46:11 --&gt; XSS Filtering completed
DEBUG - 2013-09-24 19:46:11 --&gt; CRSF cookie Set
DEBUG - 2013-09-24 19:46:11 --&gt; Global POST and COOKIE data sanitized
DEBUG - 2013-09-24 19:46:11 --&gt; Language Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; Loader Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; Database Driver Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; Session Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; Helper loaded: string_helper
DEBUG - 2013-09-24 19:46:11 --&gt; Encrypt Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; Session routines successfully run
DEBUG - 2013-09-24 19:46:11 --&gt; XML-RPC Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; Controller Class Initialized
DEBUG - 2013-09-24 19:46:11 --&gt; Helper loaded: url_helper
DEBUG - 2013-09-24 19:46:11 --&gt; Helper loaded: xml_helper
<span class="strong"><strong>INFO  - 2013-09-24 19:46:11 --&gt; SimpleXmlElement was instantiated correctly.</strong></span>
<span class="strong"><strong>INFO  - 2013-09-24 19:46:11 --&gt; Cache item saved.</strong></span>
DEBUG - 2013-09-24 19:46:11 --&gt; Final output sent to browser
DEBUG - 2013-09-24 19:46:11 --&gt; Total execution time: 0.0280</pre></div><p>You can see the info items we set in the code written in the log; I've highlighted them so that they stand out.</p></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec223"/>How it works...</h2></div></div></div><p>You can see that we have added some conditional statements on various stages of the controller's execution, checking for the <a id="id746" class="indexterm"/>return value of certain CodeIgniter functions (the changes are highlighted in the previous code). Depending on that returned value (either <code class="literal">TRUE</code> or <code class="literal">FALSE</code>), we will write to the logs using the CodeIgniter <code class="literal">log_message()</code> function, but let's take a closer look at those messages and when each of them is triggered.</p><p>First off, we'll try to instantiate a new <code class="literal">SimpleXmlElement()</code> object. If <a id="id747" class="indexterm"/>we get a returned object, an info message is written to the log (<code class="literal">SimpleXmlElement()</code> was <a id="id748" class="indexterm"/>instantiated correctly). If there was an error, we write an error message to the log (unable to instantiate <code class="literal">SimpleXmlElement()</code>); take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">$feed = new SimpleXmlElement($raw_feed);

if (!$feed) {
  log_message('error', 'Unable to instantiate SimpleXmlElement.');
} else {
  log_message('info', 'SimpleXmlElement was instantiated correctly.');
}</pre></div><p>You can see that we're using CodeIgniter's logging functionality to write messages to the log file, and define those messages as either errors or info; this can be helpful in debugging the user's journey as you'll know what is a genuine error, and what is information entered by you to help you in the logs.</p><div class="section" title="Logging style"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec20"/>Logging style</h3></div></div></div><p>I find it useful to write my <a id="id749" class="indexterm"/>log messages like the following code snippet:</p><div class="informalexample"><pre class="programlisting"> log_message('info', ' **** ' . __LINE__ . ' – This is a message.');</pre></div><p>In the preceding code snippet, we're defining the message as info, but we begin the message with four asterisks (<code class="literal">****</code>). This'll make the message stand out in the logs as we're viewing them, next comes the <code class="literal">__LINE__</code> argument (to let you know where in the script it was triggered), followed by the actual message--here it is the unimaginative--<code class="literal">' - This is a message</code>.'</p><p>You may wish to <a id="id750" class="indexterm"/>add <code class="literal">__FILE__</code>, <code class="literal">__CLASS__</code>, or <code class="literal">__FUNCTION__</code> for greater accuracy, depending on your needs.</p></div></div></div>
<div class="section" title="Benchmarking your application"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec103"/>Benchmarking your application</h1></div></div></div><p>Benchmarking can be useful for <a id="id751" class="indexterm"/>you as it can let you know how your application is coping with the task of computing all your code. It can let you know where in your application something is slow, either because of memory constraints or perhaps because of a particularly computational intensive block of code. Using this information, you can identify whether there are any bottlenecks and if you are able to clear them, perhaps by reprogramming or allocating extra resources. Here's how it's done.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec224"/>Getting ready</h2></div></div></div><p>Many web applications will be linked to some sort of database and as an example of benchmarking database connectivity, we're going to query a database. To do that, we will obviously need a database to connect to. Copy the following MySQL code into your database:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `bench_table` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `firstname` varchar(50) NOT NULL,
  `lastname` varchar(50) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=3 ;

INSERT INTO `bench_table` (`id`, `firstname`, `lastname`) VALUES
(1, 'Rob', 'Foster'),
(2, 'Lucy', 'Welsh');</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec225"/>How to do it...</h2></div></div></div><p>We're going to create the following two files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/bench.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/bench_model.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">bench.php</code> controller file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Bench extends CI_Controller {
  function __construct() {
    parent::__construct();
    $this-&gt;load-&gt;helper('url');
    $this-&gt;load-&gt;model('bench_model');
    $this-&gt;load-&gt;database();
  }

  public function index() {
    // Who's in the database?
    $this-&gt;benchmark-&gt;mark('bm1_start');
    foreach ($this-&gt;bench_model-&gt;get_people()-&gt;result() as $row) {
      echo $row-&gt;firstname . ' ' . $row-&gt;lastname . '&lt;br /&gt;';
    }
    $this-&gt;benchmark-&gt;mark('bm1_end');

    // Write some more people to the database	
    $this-&gt;benchmark-&gt;mark('bm2_start');
    $data = array(
      array('firstname' =&gt; 'George',
          'lastname' =&gt; 'Foster'),
      array('firstname' =&gt; 'Jackie',
           'lastname' =&gt; 'Foster'),
      array('firstname' =&gt; 'Antony',
          'lastname' =&gt; 'Welsh'),
      array('firstname' =&gt; 'Rowena',
          'lastname' =&gt; 'Welsh'),
      array('firstname' =&gt; 'Peter',
          'lastname' =&gt; 'Foster'),
      array('firstname' =&gt; 'Jenny',
          'lastname' =&gt; 'Foster'),
      array('firstname' =&gt; 'Oliver',
          'lastname' =&gt; 'Welsh'),
      array('firstname' =&gt; 'Harrison',
          'lastname' =&gt; 'Foster'),
      array('firstname' =&gt; 'Felicity',
          'lastname' =&gt; 'Foster')
      );

    $result = $this-&gt;bench_model-&gt;add_to_db($data);
    $this-&gt;benchmark-&gt;mark('bm2_end');

    if ($result) {
      // Who's in the database now?
      $this-&gt;benchmark-&gt;mark('bm3_start');
      foreach ($this-&gt;bench_model-&gt;get_people()-&gt;result() as $row) {
        echo $row-&gt;firstname . ' ' . $row-&gt;lastname . '&lt;br /&gt;';
      }
      $this-&gt;benchmark-&gt;mark('bm3_end');
    } else {
      echo 'Cannot write to database.';
    }

    echo '&lt;br /&gt; ---- BENCHMARK POINT STATS ---- &lt;br /&gt;';
    echo 'BM1 (S) to BM1 (E): ' . $this-&gt;benchmark-&gt;elapsed_time('bm1_start','bm1_end') . '&lt;br /&gt;';
    echo 'BM2 (S) to BM2 (E): ' . $this-&gt;benchmark-&gt;elapsed_time('bm2_start','bm2_end') . '&lt;br /&gt;';
    echo 'BM3 (S) to BM3 (E): ' . $this-&gt;benchmark-&gt;elapsed_time('bm3_start','bm3_end') . '&lt;br /&gt;';
  }
}
?&gt;</pre></div></li><li class="listitem">Create <a id="id752" class="indexterm"/>the <code class="literal">bench_model.php</code> model file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Bench_model extends CI_Model {
    function __construct() {
        parent::__construct();
    }

    function get_people() {
        $query = $this-&gt;db-&gt;get('bench_table');
        return $query;
    }

    function add_to_db($data) {
        if ($this-&gt;db-&gt;insert_batch('bench_table', $data)) {
            return TRUE;
        } else {
            return FALSE;
        }
    }
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec226"/>How it works...</h2></div></div></div><p>If you run the controller bench in your browser, you should see the following output on the screen:</p><div class="informalexample"><pre class="programlisting">Rob Foster
Lucy Welsh
Rob Foster
Lucy Welsh
George Foster
Jackie Foster
Antony Welsh
Rowena Welsh
Peter Foster
Jenny Foster
Oliver Welsh
Harrison Foster
Felicity Foster
---- BENCHMARK POINT STATS ---- 
BM1 (S) to BM1 (E): 0.0004
<span class="strong"><strong>BM2 (S) to BM2 (E): 0.0010</strong></span>
BM3 (S) to BM3 (E): 0.0005</pre></div><p>The output is a loop of the contents of the <code class="literal">bench_table</code> database table followed by the benchmark statistics. I've highlighted the stats for the <code class="literal">batch_insert()</code> operation.</p><p>
<code class="literal">BM1 (S)</code> is the start of the BM1 <a id="id753" class="indexterm"/>benchmark, and <code class="literal">BM1 (E)</code> is the end of the BM1 benchmark.</p><p>You can see that it took significantly longer to perform the <code class="literal">batch_insert()</code> operation than the two read operations (the actual processing times will be different in your application and probably each time you run the controller; however, the BM2 item will almost always be longer, but the times will differ depending on the system you're using).</p><p>If this were a more complex situation, <a id="id754" class="indexterm"/>we could use this information to locate bottlenecks in the code and hope to fix them to ensure a more streamlined application.</p><p>So, what's happening in the code? There's no library or other resource to load as the benchmark system is always loaded by CodeIgniter and is always available for use.</p><p>When we run the bench controller, <code class="literal">public function index()</code> is called and immediately runs the <code class="literal">get_people()</code> function of <code class="literal">bench_model</code>. This performs an Active Record <code class="literal">SELECT</code> operation on the <code class="literal">bench_table</code> database table, returning the result object to the controller. This is looped over and we echo out each row to display a list of rows in the database before the <a id="id755" class="indexterm"/>
<code class="literal">batch_insert()</code> operation:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$this-&gt;benchmark-&gt;mark('bm1_start');</strong></span>
foreach ($this-&gt;bench_model-&gt;get_people()-&gt;result() as $row) {
  echo $row-&gt;firstname . ' ' . $row-&gt;lastname . '&lt;br /&gt;';
}
<span class="strong"><strong>$this-&gt;benchmark-&gt;mark('bm1_end');</strong></span>
</pre></div><p>The keen-eyed amongst you will also notice the highlighted lines, we've defined the start and end points for CodeIgniter to pay attention to. The first we've named <code class="literal">bm1_start</code> and the second we've named <code class="literal">bm1_stop</code>. We can call them anything we like, but that's what I've decided to call them.</p><p>We then perform the <code class="literal">batch_ insert</code> operation, as <a id="id756" class="indexterm"/>shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$this-&gt;benchmark-&gt;mark('bm2_start');</strong></span>
$data = array(
  array('firstname' =&gt; 'George',
      'lastname' =&gt; 'Foster'),
  array('firstname' =&gt; 'Jackie',
      'lastname' =&gt; 'Foster'),
  array('firstname' =&gt; 'Antony',
      'lastname' =&gt; 'Welsh'),
  array('firstname' =&gt; 'Rowena',
      'lastname' =&gt; 'Welsh'),
  array('firstname' =&gt; 'Peter',
      'lastname' =&gt; 'Foster'),
  array('firstname' =&gt; 'Jenny',
      'lastname' =&gt; 'Foster'),
  array('firstname' =&gt; 'Oliver',
      'lastname' =&gt; 'Welsh'),
  array('firstname' =&gt; 'Harrison',
      'lastname' =&gt; 'Foster'),
  array('firstname' =&gt; 'Felicity',
      'lastname' =&gt; 'Foster')
  );

  $result = $this-&gt;bench_model-&gt;add_to_db($data);
<span class="strong"><strong>$this-&gt;benchmark-&gt;mark('bm2_end');</strong></span>
</pre></div><p>We're defining a multidimensional array with the details of people we want to add to the database and sending it to the <a id="id757" class="indexterm"/>
<code class="literal">insert_batch()</code> function of <code class="literal">bench_model</code>; now the keen eyed among you will again notice the highlighted lines. These are the bm2 start and end points. If the <code class="literal">batch_insert()</code> operation <a id="id758" class="indexterm"/>returns <code class="literal">TRUE</code> (it is inserted into the database correctly), we then call the <code class="literal">get_people()</code> model function again, which will return all the records from the database:</p><div class="informalexample"><pre class="programlisting">if ($result) {
  // Who's in the database now?
<span class="strong"><strong>  $this-&gt;benchmark-&gt;mark('bm3_start');</strong></span>
  foreach ($this-&gt;bench_model-&gt;get_people()-&gt;result() as $row) {
    echo $row-&gt;firstname . ' ' . $row-&gt;lastname . '&lt;br /&gt;';
  }
<span class="strong"><strong>  $this-&gt;benchmark-&gt;mark('bm3_end');</strong></span>
} else {
  echo 'Cannot write to database.';
}</pre></div><p>Again, here we define (as highlighted in the previous code) the bm3 start and end points. That completes our database operations and we move over to reporting of the benchmarks.</p><p>We ask CodeIgniter to tell us the execution time between points:</p><div class="informalexample"><pre class="programlisting">echo '&lt;br /&gt; ---- BENCHMARK POINT STATS ---- &lt;br /&gt;';
echo 'BM1 (S) to BM1 (E): ' . $this-&gt;benchmark-&gt;elapsed_time('bm1_start','bm1_end') . '&lt;br /&gt;';
echo 'BM2 (S) to BM2 (E): ' . $this-&gt;benchmark-&gt;elapsed_time('bm2_start','bm2_end') . '&lt;br /&gt;';
echo 'BM3 (S) to BM3 (E): ' . $this-&gt;benchmark-&gt;elapsed_time('bm3_start','bm3_end') . '&lt;br /&gt;';</pre></div><p>For each bm1, bm2, and bm3, we want to know the time between the points specified using the <code class="literal">$this-&gt;benchmark-&gt;elapsed_time()</code> function. This function takes two arguments: a start point and an end point. <a id="id759" class="indexterm"/>For this recipe, we have asked CodeIgniter to report the time elapsed between each bm# point (where # is the number 1, 2, or 3), but if we wish to we can write this:</p><div class="informalexample"><pre class="programlisting">echo 'BM1 (S) to BM2 (E): ' . $this-&gt;benchmark-&gt;elapsed_time('bm1_start','bm2_end') . '&lt;br /&gt;'</pre></div><p>The previous code will report the <a id="id760" class="indexterm"/>elapsed time between <code class="literal">bm1_start</code> and <code class="literal">bm2_end</code> (or from the beginning of the first <code class="literal">get_people()</code> query to the end of the <code class="literal">batch_insert()</code> query).</p><p>Think of each <code class="literal">$this-&gt;benchmark-&gt;mark('bm2_end');</code> as a checkpoint, and you can use <code class="literal">$this-&gt;benchmark-&gt;elapsed_time('checkpoint_1','checkpoint_2')</code> to return the time elapsed between them.</p></div></div></body></html>