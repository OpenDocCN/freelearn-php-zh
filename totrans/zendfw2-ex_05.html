<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Chat and E-mail"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Chat and E-mail</h1></div></div></div><p>
<span class="emphasis"><em>In any web application development, there will be very high dependency on client-side scripts primarily including JavaScript and CSS. The MVC model of Zend Framework provides basic support of controlling the output that is sent across to the browser. The view helper classes in Zend Framework 2 offer maximum control over the content that gets rendered in the client browser.</em></span>
</p><p>In this chapter we will focus on building a simple group chat and e-mail component which will make use of various frontend capabilities of Zend Framework 2.0. Some of the important topics covered in this chapter include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using external JavaScript libraries in the Zend Framework 2 application</li><li class="listitem" style="list-style-type: disc">Implementing a simple group chat application using Zend Framework 2 and JavaScript</li><li class="listitem" style="list-style-type: disc">Using Zend\Mail to send e-mails</li><li class="listitem" style="list-style-type: disc">Introduction to the Zend Framework event manager</li></ul></div><div class="section" title="Layouts and views"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec46"/>Layouts and views</h1></div></div></div><p>Zend Framework MVC uses layouts<a id="id418" class="indexterm"/> and views to render pages in the web <a id="id419" class="indexterm"/>browser; the overall page content is controlled by the layout specification, and the view level information is contained in the views. The concept is to minimize the amount of redundant HTML code that needs to be generated for each of these views.</p><p>By using layouts, the application can have a consistent user interface, which is also easy to customize; the views offer the flexibility to modify the targeted content and allow customization to the maximum possible extent. This is also known as <span class="emphasis"><em>two-step</em></span> view.</p><p>When a new view is generated, the appropriate layout is identified from the layout definitions in the <code class="literal">view_manager</code> configuration and the view is rendered with that layout.</p><div class="mediaobject"><img src="graphics/1929OS_05_01.jpg" alt="Layouts and views"/></div><p>The preceding schematic explains how the layout and view are combined to form an HTML page, so for each and every view, the view part changes and the layout part remains static.</p><div class="section" title="View helpers"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec46"/>View helpers</h2></div></div></div><p>Zend Framework 2 offers a wide range of view helpers that help us perform complex operations<a id="id420" class="indexterm"/> on views; if the included helpers are not sufficient, you can define your own custom helper by implementing the interface <code class="literal">Zend\View\HelperInterface</code>.</p><p>In this section, we will quickly review some of the included helpers in Zend Framework 2.</p><div class="section" title="The URL helper"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec03"/>The URL helper</h3></div></div></div><p>The syntax for this<a id="id421" class="indexterm"/> helper is <code class="literal">url($name, $urlParams, $routeOptions = array(), $reuseMatchedParams = array())</code>.</p><p>The URL helper<a id="id422" class="indexterm"/> is used to generate the URL for a specific route. The route's segment match parameters can be passed over the URL helper to form a URL based on the route option; for example, see the following:</p><div class="informalexample"><pre class="programlisting">&lt;a href="&lt;?php <span class="strong"><strong>$this-&gt;url('users/upload-manager', array('action'=&gt;'edit', 'id' =&gt;  10));</strong></span>"&gt;Edit&lt;/a&gt;</pre></div><p>This code will generate <code class="literal">&lt;a href="/users/upload-manager/edit/10"&gt;Edit&lt;/a&gt;</code> if the route<a id="id423" class="indexterm"/> definition<a id="id424" class="indexterm"/> is as follows:</p><div class="informalexample"><pre class="programlisting">'route' =&gt; '/user-manager[/:action[/:id]]'</pre></div></div><div class="section" title="The BasePath helper"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec04"/>The BasePath helper</h3></div></div></div><p>The syntax<a id="id425" class="indexterm"/> for this helper is <code class="literal">basePath()</code>.</p><p>The <code class="literal">BasePath</code> helper <a id="id426" class="indexterm"/>returns the base URL of the view, this can be used by developers to prepend to their custom URLs and form links for various resources.</p></div><div class="section" title="The JSON helper"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec05"/>The JSON helper</h3></div></div></div><p>The syntax <a id="id427" class="indexterm"/>for this helper is <code class="literal">json($jsonData = array())</code>.</p><p>The JSON helper<a id="id428" class="indexterm"/> is used to render PHP arrays as JSON-encoded data. Most AJAX libraries classify JSON content by its content header, and this helper also sets the content type header to <code class="literal">application/json</code>.</p></div></div><div class="section" title="Concrete placeholder implementations"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec47"/>Concrete placeholder implementations</h2></div></div></div><p>Zend Framework makes use of placeholder helpers to perform some standard operations on the HTML <code class="literal">head</code> sections including adding/removing references to new JavaScript libraries,<a id="id429" class="indexterm"/> linking with new styles, adding and cross referencing scripts, and adding/removing HTML <code class="literal">head</code> section's <code class="literal">meta</code> content.</p><p>This is achieved by the following list of helpers called as <span class="strong"><strong>concrete placeholder helpers</strong></span>. The reason why they are called placeholder helpers is because the helpers themselves don't make any changes to the way in which the content is rendered. For example, if you add <code class="literal">&lt;?php echo $this-&gt;headLink(); ?&gt;</code> to the HTML code, this won't do anything, until you add something to the <code class="literal">headLink</code> helper by using <code class="literal">appendStylesheet</code> or some other function.</p><div class="section" title="The HeadLink helper"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec06"/>The HeadLink helper</h3></div></div></div><p>The <code class="literal">HeadLink</code> <a id="id430" class="indexterm"/>helper is used to modify the <code class="literal">&lt;link&gt;</code> tag in the HTML <code class="literal">head</code> section; this helper<a id="id431" class="indexterm"/> is used to attach or manage external <a id="id432" class="indexterm"/>CSSs.</p><p>Some of <a id="id433" class="indexterm"/>the most-used functions in this helper are listed<a id="id434" class="indexterm"/> as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">appendStylesheet($href, $media, $conditionalStylesheet, $extras)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">offsetSetStylesheet</code><a id="id435" class="indexterm"/><code class="literal">($index, $href, $media, $conditionalStylesheet, $extras)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">prependStylesheet</code><a id="id436" class="indexterm"/><code class="literal">($href, $media, $conditionalStylesheet, $extras)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">setStylesheet($href, $media, $conditionalStylesheet, $extras)</code></li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note07"/>Note</h3><p>To render the <code class="literal">Link</code> tags in an HTML layout/view, use the following script:</p><div class="informalexample"><pre class="programlisting">&lt;?php echo $this-&gt;headLink(); ?&gt;</pre></div></div></div></div><div class="section" title="The HeadMeta helper"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec07"/>The HeadMeta helper</h3></div></div></div><p>The <a id="id437" class="indexterm"/>
<code class="literal">HeadMeta</code> helper is used to modify <a id="id438" class="indexterm"/>the <code class="literal">&lt;meta&gt;</code> tag in the HTML <code class="literal">head</code> section; this helper is used to manipulate the HTML <code class="literal">meta</code> information.</p><p>Some of the<a id="id439" class="indexterm"/> most-used functions in this helper are listed<a id="id440" class="indexterm"/> as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">appendName($keyValue, $content, $conditionalName)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">offsetSetName($index, $keyValue, $content, $conditionalName)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">prependName($keyValue, $content, $conditionalName)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">setName($keyValue, $content, $modifiers)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">appendHttpEquiv($keyValue, $content, $conditionalHttpEquiv)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">offsetSetHttpEquiv($index, $keyValue, $content, $conditionalHttpEquiv)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">prependHttpEquiv($keyValue, $content, $conditionalHttpEquiv)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">setHttpEquiv($keyValue, $content, $modifiers)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">setCharset($charset)</code></li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>To render the <code class="literal">meta</code> tags<a id="id441" class="indexterm"/> in an HTML layout/view, use the following script:</p><div class="informalexample"><pre class="programlisting">&lt;?php echo $this-&gt;headMeta(); ?&gt;</pre></div></div></div></div><div class="section" title="The HeadScript helper"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec08"/>The HeadScript helper</h3></div></div></div><p>The <a id="id442" class="indexterm"/>
<code class="literal">HeadScript</code> helper is used to modify <a id="id443" class="indexterm"/>the <code class="literal">&lt;script&gt;</code> tag<a id="id444" class="indexterm"/> in the HTML <code class="literal">head</code> section; this helper is used to attach external JavaScript and also add the <code class="literal">&lt;script&gt;</code> tags to the HTML <code class="literal">head</code> section.</p><p>Some of the<a id="id445" class="indexterm"/> most-used functions in this helper are listed <a id="id446" class="indexterm"/>as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">appendFile($src, $type = 'text/javascript', $attrs = array())</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">offsetSetFile($index, $src, $type = 'text/javascript', $attrs = array())</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">prependFile($src, $type = 'text/javascript', $attrs = array())</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">setFile($src, $type = 'text/javascript', $attrs = array())</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">appendScript($script, $type = 'text/javascript', $attrs = array())</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">offsetSetScript($index, $script, $type = 'text/javascript', $attrs = array())</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">prependScript($script, $type = 'text/javascript', $attrs = array())</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">setScript($script, $type = 'text/javascript', $attrs = array())</code></li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>To render the <code class="literal">Script</code> tags in an HTML layout/view use the following script:</p><div class="informalexample"><pre class="programlisting">&lt;?php echo $this-&gt;headScript(); ?&gt;</pre></div></div></div></div><div class="section" title="The HeadStyle helper"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec09"/>The HeadStyle helper</h3></div></div></div><p>The<a id="id447" class="indexterm"/> <code class="literal">HeadStyle</code> helper is used to modify<a id="id448" class="indexterm"/> the <code class="literal">&lt;style&gt;</code> tag in HTML <code class="literal">head</code> section; this helper is used to add internal styles by adding the <code class="literal">&lt;style&gt;</code> tags to the HTML <code class="literal">head</code> section.</p><p>Some of the <a id="id449" class="indexterm"/>most-<a id="id450" class="indexterm"/>used functions in this helper are listed as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">appendStyle($content, $attributes = array())</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">offsetSetStyle($index, $content, $attributes = array())</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">prependStyle($content, $attributes = array())</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">setStyle($content, $attributes = array())</code></li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>To render the <code class="literal">Style</code> tags in an HTML layout/view use the following script:</p><div class="informalexample"><pre class="programlisting">&lt;?php echo $this-&gt;headStyle(); ?&gt;</pre></div></div></div></div><div class="section" title="The HeadTitle helper"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec10"/>The HeadTitle helper</h3></div></div></div><p>The <a id="id451" class="indexterm"/>
<code class="literal">HeadTitle</code> helper is used to render<a id="id452" class="indexterm"/> title in the <code class="literal">&lt;title&gt;</code> tags on the HTML <code class="literal">head</code> section; multiple calls to a <code class="literal">headTitle()</code><a id="id453" class="indexterm"/> helper create a list of titles which are rendered when tag is outputted in the layout/view. The optional parameter <code class="literal">$setType</code> can be set to override the pre-existing array of titles, the default is <code class="literal">APPEND</code>, it can be overridden to <code class="literal">PREPEND</code> or <code class="literal">SET</code>(overwrite).</p><p>The<a id="id454" class="indexterm"/> syntax<a id="id455" class="indexterm"/> for this helper is <code class="literal">headTitle($title, $setType = null);</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note11"/>Note</h3><p>To render the <code class="literal">Title</code> tags in an HTML layout/view, use the following script:</p><div class="informalexample"><pre class="programlisting">&lt;?php echo $this-&gt;headTitle(); ?&gt;</pre></div></div></div></div></div></div></div>
<div class="section" title="Time for action &#x2013; using jQuery UI in a simple page"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec47"/>Time for action – using jQuery UI in a simple page</h1></div></div></div><p>In this <a id="id456" class="indexterm"/>task we will be converting<a id="id457" class="indexterm"/> some of our existing pages to make use of the jQuery UI library and render buttons in that page using jQuery UI:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">View the existing application home page as shown in the following screenshot; our next task is to convert the <span class="strong"><strong>Login</strong></span> and <span class="strong"><strong>Register</strong></span> links to render as jQuery UI buttons:<div class="mediaobject"><img src="graphics/1929OS_05_02.jpg" alt="Time for action – using jQuery UI in a simple page"/><div class="caption"><p>Existing application home page</p></div></div></li><li class="listitem">Replace the <span class="strong"><strong>Login</strong></span> and <span class="strong"><strong>Register</strong></span> links in the <code class="literal">index</code> view (<code class="literal">module/Users/view/users/index/index.html</code>), and add the <code class="literal">ui-button</code> class<a id="id458" class="indexterm"/> to the links as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">&lt;a href="/users/login"<span class="strong"><strong> class='ui-button</strong></span>'&gt;Login&lt;/a&gt;
&lt;a href="/users/register"<span class="strong"><strong> class='ui-button</strong></span>'&gt;Register&lt;/a&gt;</pre></div></li><li class="listitem">Add external references to jQuery UI towards the beginning of the view:<div class="informalexample"><pre class="programlisting">// Attached jQuery UI Scripts
$this-&gt;headScript()
-&gt;appendFile('http://code.jquery.com/jquery-1.8.3.js','text/javascript');

$this-&gt;headScript()
-&gt;appendFile('http://code.jquery.com/ui/1.10.0/jquery-ui.js','text/javascript');

// Attach jQuery UI Styles 
$this-&gt;headLink()-&gt;appendStylesheet('http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css');</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip25"/>Tip</h3><p>
<span class="strong"><strong>Referencing custom JavaScript libraries</strong></span>
</p><p>Instead<a id="id459" class="indexterm"/> of directly referencing the external scripts, you can also optionally download the scripts to the <code class="literal">/public</code> folder in your application and pass relative links as parameters to the <code class="literal">appendFile</code><a id="id460" class="indexterm"/> and <code class="literal">appendStylesheet</code><a id="id461" class="indexterm"/> functions. You can also make use of the <code class="literal">basePath()</code><a id="id462" class="indexterm"/> helper to prepend the base URL.</p></div></div></li><li class="listitem">Add a <a id="id463" class="indexterm"/>UI initialization script to apply the button look and feel to both the links:<div class="informalexample"><pre class="programlisting">// UI Initializer for buttons
$this-&gt;headScript()-&gt;appendScript(
'$(function() {
    $("a.ui-button").button();
  });', 'text/javascript');</pre></div></li><li class="listitem">Preview the home page in the browser now, and you will be able to see that both the <span class="strong"><strong>Login</strong></span><a id="id464" class="indexterm"/> and <span class="strong"><strong>Register</strong></span> buttons are styled using jQuery UI as<a id="id465" class="indexterm"/> shown in the following screenshot:<div class="mediaobject"><img src="graphics/1929OS_05_03.jpg" alt="Time for action – using jQuery UI in a simple page"/></div></li></ol></div><p>A <span class="strong"><strong>View Source</strong></span> link<a id="id466" class="indexterm"/> on the index page will reveal the application of <code class="literal">headScript()</code><a id="id467" class="indexterm"/> as shown <a id="id468" class="indexterm"/>in the following<a id="id469" class="indexterm"/> code:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
...
...
&lt;script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;
    //&lt;!--
    $(function() {
   $("a.ui-button").button();
  });
    //--&gt;
&lt;/script&gt;
...
...
&lt;/html&gt;</pre></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec48"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We have<a id="id470" class="indexterm"/> made use of Zend <a id="id471" class="indexterm"/>Framework's view helpers to connect to the external JavaScript library; <a id="id472" class="indexterm"/>we then added custom JavaScript to the HTML <code class="literal">head</code> section <a id="id473" class="indexterm"/>using the <code class="literal">headScript()</code> view helper.</p><p>Now we have integrated our application with an external JavaScript; in the next exercise we will learn a little bit more on how scripts can be added to the HTML <code class="literal">head</code> section.</p></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec49"/>Have a go hero</h2></div></div></div><p>Before we move on to building the <span class="strong"><strong>Group Chat</strong></span> interface, here is a simple task for you to complete. Now that you have understood how to link external JavaScript libraries, you can download jQuery UI from its website, extract it to the <code class="literal">public/</code> folder, and modify the previously listed page to use the downloaded version of jQuery UI.</p><p>jQuery UI<a id="id474" class="indexterm"/> can be downloaded from <a class="ulink" href="http://jqueryui.com/">http://jqueryui.com/</a>.</p></div></div>
<div class="section" title="Building a simple group chat"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec48"/>Building a simple group chat</h1></div></div></div><p>Our<a id="id475" class="indexterm"/> next task is to build a simple group chat application that allows multiple users to log in to our system and chat with each other. The backend for this tool is pretty straightforward. We need to create a table that will store all user messages and render them in a separate view; we will create a simple form that will allow users to send messages.</p></div>
<div class="section" title="Time for action &#x2013; creating a simple group chat application"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec49"/>Time for action – creating a simple group chat application</h1></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create<a id="id476" class="indexterm"/> a new <code class="literal">chat_messages</code> table to store all user messages:<div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS chat_messages (
  id INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
  user_id INT NOT NULL,
  message VARCHAR( 255 ) NOT NULL ,  
  stamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)</pre></div></li><li class="listitem">Create a controller for group chat in <code class="literal">CommunicationApp/module/Users/src/Users/Controller/GroupChatController.php</code>.</li><li class="listitem">Make necessary changes to <code class="literal">CommunicationApp/module/Users/config/module.config.php</code> and add the new controller to invokables and routes:<div class="informalexample"><pre class="programlisting">// Invokable
'Users\Controller\GroupChat' =&gt; 'Users\Controller\GroupChatController',

// Route
'group-chat' =&gt; array(
  'type'    =&gt; 'Segment',
  'options' =&gt; array(
    'route'    =&gt; '/group-chat[/:action[/:id]]',
    'constraints' =&gt; array(
      'action'     =&gt; '[a-zA-Z][a-zA-Z0-9_-]*',
      'id'     =&gt; '[a-zA-Z0-9_-]*',
    ),
    'defaults' =&gt; array(
      'controller' =&gt; 'Users\Controller\GroupChat',
      'action'     =&gt; 'index',
    ),
  ),
),</pre></div></li><li class="listitem">Create<a id="id477" class="indexterm"/> a new view in <code class="literal">CommunicationApp/module/Users/view/users/group-chat/index.phtml</code>:<div class="informalexample"><pre class="programlisting">&lt;?php 
$this-&gt;headScript()-&gt;appendScript(
'$(function() {
    $( "#btnRefresh" )
      .click(function( event ) {
  document.getElementById("messageListFrame").contentWindow.location.reload(true);
   })
  });', 'text/javascript');
 
$this-&gt;headStyle()-&gt;appendStyle('
  #userName { width:100px; margin-top:10px; display: inline}
  #messageText { width:700px; margin-top:10px;}
');
?&gt;
&lt;h3&gt;Group Chat&lt;/h3&gt;
&lt;iframe src="&lt;?php echo $this-&gt;url('users/group-chat', array( 
                        'action' =&gt;  'messageList' 
                    )) ?&gt;" width="80%" height="400px" id="messageListFrame"&gt;&lt;/iframe&gt;

&lt;?php 
// Render the opening tag
echo $this-&gt;form()-&gt;openTag($form);

// ...loop through and render the form elements...
echo '&lt;label id="userName"&gt;'. $userName .': &lt;/label&gt;';
foreach ($form as $element) {
    echo $this-&gt;formElement($element);       // &lt;-- Magic!
    echo $this-&gt;formElementErrors($element);
}

// Render the closing tag
echo $this-&gt;form()-&gt;closeTag();
?&gt;</pre></div></li><li class="listitem">Add <a id="id478" class="indexterm"/>the <code class="literal">messageList</code> action<a id="id479" class="indexterm"/> to <code class="literal">GroupChatController - CommunicationApp/module/Users/src/Users/Controller/GroupChatController.php</code>; this action will query the <code class="literal">chat_messages</code> table and get all the records from that table and pass that on to the view:<div class="informalexample"><pre class="programlisting">public function messageListAction()
{
  $userTable = $this-&gt;getServiceLocator()-&gt;get('UserTable');
  $chatMessageTG = $this-&gt;getServiceLocator()-&gt;get('ChatMessagesTableGateway');
  $chatMessages = $chatMessageTG-&gt;select();
  
  $messageList = array();
  foreach($chatMessages as $chatMessage) {
    $fromUser = $userTable-&gt;getUser($chatMessage-&gt;user_id);
    $messageData = array();
    $messageData['user'] = $fromUser-&gt;name;
    $messageData['time'] = $chatMessage-&gt;stamp;
    $messageData['data'] = $chatMessage-&gt;message;
    $messageList[] = $messageData;
  }
  
  $viewModel  = new ViewModel(array('messageList' =&gt; $messageList));
  $viewModel-&gt;setTemplate('users/group-chat/message-list');
  $viewModel-&gt;setTerminal(true);    
  return $viewModel;
}</pre></div></li><li class="listitem">Create<a id="id480" class="indexterm"/> a simple message listing view, <code class="literal">CommunicationApp/module/Users/view/users/group-chat/message-list.phtml</code>, which will list messages from the <code class="literal">$messageList</code> array:<div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;body&gt;
&lt;section id="messages" &gt;
  &lt;?php foreach ($messageList as $mesg) : ?&gt;
  &lt;div class="message" style="clear:both;"&gt;
    &lt;span class='msg-time'&gt;
  [&lt;?php echo $this-&gt;escapeHtml($mesg['time']);?&gt;]
    &lt;/span&gt; 
    &lt;span class='msg-user'&gt; 
  &lt;?php echo $this-&gt;escapeHtml($mesg['user']);?&gt;: 
    &lt;/span&gt;
    &lt;span class='msg-data'&gt;
  &lt;?php echo $this-&gt;escapeHtml($mesg['data']);?&gt;
    &lt;/span&gt;
  &lt;/div&gt;
  &lt;?php endforeach; ?&gt; 
&lt;/section&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">Create a<a id="id481" class="indexterm"/> method called <code class="literal">sendMessage()</code>, which is called<a id="id482" class="indexterm"/> when a user sends a message to store the message in the database, as shown in the following code. This needs to be placed in the group chat controller <code class="literal">CommunicationApp/module/Users/src/Users/Controller/GroupChatController.php</code>.<div class="informalexample"><pre class="programlisting">protected function sendMessage($messageTest $fromUserId)
{
  $chatMessageTG = $this-&gt;getServiceLocator()
                    -&gt;get('ChatMessagesTableGateway');
  $data = array(
    'user_id' =&gt; $fromUserId,
    'message'  =&gt; $messageTest,
    'stamp' =&gt; NULL
  );
  $chatMessageTG-&gt;insert($data);
  return true;
}</pre></div></li><li class="listitem">Modify the <code class="literal">indexAction</code> function<a id="id483" class="indexterm"/> to display a <code class="literal">Send Message</code> form and to call <code class="literal">sendMessage()</code> on form submission. This needs <a id="id484" class="indexterm"/>to be placed in the group chat controller <code class="literal">CommunicationApp/module/Users/src/Users/Controller/GroupChatController.php</code>.<div class="informalexample"><pre class="programlisting">public function indexAction(
{
  $user = $this-&gt;getLoggedInUser();	
  $request = $this-&gt;getRequest();
  if ($request-&gt;isPost()) {
    $messageTest = $request-&gt;getPost()-&gt;get('message');
    $fromUserId = $user-&gt;id;
    $this-&gt;sendMessage($messageTest, $fromUserId);
    // to prevent duplicate entries on refresh
    return $this-&gt;redirect()-&gt;toRoute('users/group-chat');
  }
  
  //Prepare Send Message Form
  $form    = new \Zend\Form\Form();
  
  $form-&gt;add(array(
    'name' =&gt; 'message',
    'attributes' =&gt; array(
      'type'  =&gt; 'text',
      'id' =&gt; 'messageText',
      'required' =&gt; 'required'
    ),
    'options' =&gt; array(
      'label' =&gt; 'Message',
    ),
  ));
  
  $form-&gt;add(array(
          'name' =&gt; 'submit',
          'attributes' =&gt; array(
              'type'  =&gt; 'submit',
              'value' =&gt; 'Send'
          ),
  ));
  
  $form-&gt;add(array(
    'name' =&gt; 'refresh',
    'attributes' =&gt; array(
      'type'  =&gt; 'button',
      'id' =&gt; 'btnRefresh',
      'value' =&gt; 'Refresh'
    ),
  ));
  
  $viewModel  = new ViewModel(array('form' =&gt; $form, 
                              'userName' =&gt; $user-&gt;name));
  return $viewModel;
}</pre></div></li><li class="listitem">To <a id="id485" class="indexterm"/>test the changes, log in to the browser from two different computers or two different browsers using different credentials, and test the <span class="strong"><strong>Group Chat</strong></span> interface.<div class="mediaobject"><img src="graphics/1929OS_05_04.jpg" alt="Time for action – creating a simple group chat application"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec50"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We <a id="id486" class="indexterm"/>have now successfully implemented a <span class="strong"><strong>Group Chat</strong></span> interface using Zend Framework; the interface is effective for multiple people chatting with each other in a group. Our next task will need to build a mechanism to send e-mails to other users in the system; for that we will be exhaustively using the Zend Framework's mailing capabilities.</p></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec51"/>Have a go hero</h2></div></div></div><p>Here is a simple exercise for you to try before you move on to the next section. In the <span class="strong"><strong>Group Chat</strong></span> interface, we have a <span class="strong"><strong>Refresh</strong></span> button<a id="id487" class="indexterm"/> that reloads the <code class="literal">iframe</code> tag<a id="id488" class="indexterm"/>. Write some JavaScript and attach it to the view, which will reload the IFrame every five seconds.</p></div></div>
<div class="section" title="Sending mails"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec50"/>Sending mails</h1></div></div></div><p>Zend Framework offers the <code class="literal">Zend\Mail</code> library to send and receive e-mails. In this section,<a id="id489" class="indexterm"/> we will cover the basics of Zend Framework's mailing capabilities, and will also implement a simple mailing script.</p><p>
<code class="literal">Zend\Mail</code><a id="id490" class="indexterm"/> supports both plain text and MIME complaint multipart e-mail messages. The framework by default supports Sendmail, SMTP, and File transports; new transports can be implemented using <code class="literal">Zend\Mail\Transport\TransportInterface</code>.</p><div class="section" title="Zend\Mail\Transport"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec52"/>Zend\Mail\Transport</h2></div></div></div><p>The <code class="literal">Mail</code> transport<a id="id491" class="indexterm"/> is used<a id="id492" class="indexterm"/> to send the e-mail message to recipients; <code class="literal">Zend\Mail</code> supports <a id="id493" class="indexterm"/>the following transports:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Sendmail using <code class="literal">Zend\Mail\Transport\Sendmail</code></li><li class="listitem" style="list-style-type: disc">SMTP using <code class="literal">Zend\Mail\Transport\Smtp</code></li><li class="listitem" style="list-style-type: disc">File Transport using <code class="literal">Zend\Mail\Transport\File</code></li></ul></div><p>The <code class="literal">Mail</code> transport<a id="id494" class="indexterm"/> implements the <code class="literal">send()</code> method;<a id="id495" class="indexterm"/> this <a id="id496" class="indexterm"/>method accepts an object of type <a id="id497" class="indexterm"/>
<code class="literal">Zend\Mail\Message</code> as the parameter; this object (<code class="literal">Zend\Mail\Message</code>) contains <a id="id498" class="indexterm"/>all the necessary information for an e-mail message; the message is sent using the transport.</p></div><div class="section" title="Zend\Mail\Message"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec53"/>Zend\Mail\Message</h2></div></div></div><p>
<code class="literal">Zend\Mail\Message</code> is used to compose the mail message in Zend Framework; this object takes <a id="id499" class="indexterm"/>various parameters including the from<a id="id500" class="indexterm"/> address, to address, subject, and body. If the message is a MIME complaint multipart message, then the body of the message can be set to a <code class="literal">Zend\Mime\Message</code> mail message<a id="id501" class="indexterm"/> object using the <code class="literal">setBody()</code> method, and the message can be sent. Some of the most frequently-used methods in <code class="literal">Zend\Mail\Message</code> are listed as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">setFrom()</code><a id="id502" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">setHeaders</code><a id="id503" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">setTo()</code><a id="id504" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">addCc()</code><a id="id505" class="indexterm"/> and <code class="literal">addBcc()</code><a id="id506" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">setSubject()</code><a id="id507" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">setBody()</code><a id="id508" class="indexterm"/></li></ul></div></div><div class="section" title="Zend\Mime\Message and Zend\Mime\Part"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec54"/>Zend\Mime\Message and Zend\Mime\Part</h2></div></div></div><p>For<a id="id509" class="indexterm"/> sending HTML or multi-part content, each <a id="id510" class="indexterm"/>message part is defined as a <code class="literal">Zend\Mime\Part</code> object <a id="id511" class="indexterm"/>along with its type and associated to<a id="id512" class="indexterm"/> the <code class="literal">Zend\Mime\Message</code> object using the <code class="literal">setParts()</code> method<a id="id513" class="indexterm"/>. The <code class="literal">Zend\Mime\Message</code> object is assigned to the <code class="literal">Zend\Mail\Message</code> object <a id="id514" class="indexterm"/>using the <code class="literal">setBody()</code> method.</p></div></div>
<div class="section" title="Time for action &#x2013; creating a simple e-mail form"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec51"/>Time for action – creating a simple e-mail form</h1></div></div></div><p>In this <a id="id515" class="indexterm"/>activity, we will be creating an e-mail form making use of Zend's mailing capabilities:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a simple e-mail form with input fields for subject, message content, and addressee.</li><li class="listitem">Set up a new controller to display the form and write the necessary views.</li><li class="listitem">Modify the controller so that it references the <code class="literal">Zend\Mail</code> namespace.<div class="informalexample"><pre class="programlisting">use Zend\Mail;</pre></div></li><li class="listitem">Create a <a id="id516" class="indexterm"/>new controller method that does the actual e-mailing; this can be placed within our group chat controller (<code class="literal">CommunicationApp/module/Users/src/Users/Controller/GroupChatController.php</code>) using the following code:<div class="informalexample"><pre class="programlisting">protected function sendOfflineMessage($msgSubj, 
                         $msgText, $fromUserId, $toUserId)
{
  $userTable = $this-&gt;getServiceLocator()
                               -&gt;get('UserTable');

  $fromUser = $userTable-&gt;getUser($fromUserId);
  $toUser = $userTable-&gt;getUser($toUserId);
  
  $mail = new Mail\Message();
  $mail-&gt;setFrom($fromUser-&gt;email, $fromUser-&gt;name);
  $mail-&gt;addTo($toUser-&gt;email, $toUser-&gt;name);
  $mail-&gt;setSubject($msgSubj);
  $mail-&gt;setBody($msgText);
  
  $transport = new Mail\Transport\Sendmail();
  $transport-&gt;send($mail);
  
  return true;
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip26"/>Tip</h3><p>The <code class="literal">Sendmail</code> transport (<code class="literal">Zend\Mail\Transport\Sendmail</code>) is available in Linux <a id="id517" class="indexterm"/>by default and can be used for sending e-mail messages. Windows users can make use of SMTP transport (<code class="literal">Zend\Mail\Transport\Smtp</code>) to connect an SMTP server to send e-mail messages. The following reference link provides a quick<a id="id518" class="indexterm"/> example on using SMTP transport:</p><p>
<a class="ulink" href="https://packages.zendframework.com/docs/latest/manual/en/modules/zend.mail.transport.html#zend-mail-transport-quick-start-smtp-usage">https://packages.zendframework.com/docs/latest/manual/en/modules/zend.mail.transport.html#zend-mail-transport-quick-start-smtp-usage</a>
</p></div></div></li><li class="listitem">Preview the form in a web browser and test if the e-mail is being received; a message similar to the following one would be received by the recipient:<div class="mediaobject"><img src="graphics/1929OS_05_06.jpg" alt="Time for action – creating a simple e-mail form"/></div><div class="mediaobject"><img src="graphics/1929OS_05_10.jpg" alt="Time for action – creating a simple e-mail form"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec55"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We have <a id="id519" class="indexterm"/>used the <code class="literal">Zend\Mail</code> object<a id="id520" class="indexterm"/> to send e-mails within the system using the <code class="literal">Sendmail</code> mail transport; we have also learned about how to send HTML or multi-part mail messages.</p></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec56"/>Have a go hero</h2></div></div></div><p>Before moving on to the next section, try to implement the e-mailing form for sending out HTML e-mails.</p></div></div>
<div class="section" title="Zend\EventManager"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec52"/>Zend\EventManager</h1></div></div></div><p>Zend Framework 2 is an event-driven framework; the event manager allows you to attach events to almost any functionality. There are three main terms used in Zend Framework's event management, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Event manager</strong></span>: The<a id="id521" class="indexterm"/> <code class="literal">EventManager</code> object<a id="id522" class="indexterm"/> is the object that holds a collection of listeners and their relative events</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Listener</strong></span>: The<a id="id523" class="indexterm"/> listener is the callback that<a id="id524" class="indexterm"/> reacts to the triggered event</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Event</strong></span>: The event <a id="id525" class="indexterm"/>is the action that is triggered<a id="id526" class="indexterm"/> by the event manager</li></ul></div><p>The event manager provides <code class="literal">attach()</code><a id="id527" class="indexterm"/> and <code class="literal">trigger()</code> to create and trigger <a id="id528" class="indexterm"/>events respectively. Mostly we will be depending on MVC events for various operation, and the sequence of execution of MVC application events is described in the following diagram:</p><div class="mediaobject"><img src="graphics/1929OS_05_09.jpg" alt="Zend\EventManager"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip27"/>Tip</h3><p>The article at the following link explains the sequence of events in a ZF2 application:</p><p>
<a class="ulink" href="http://akrabat.com/zend-framework-2/a-list-of-zf2-events/">http://akrabat.com/zend-framework-2/a-list-of-zf2-events/</a>
</p></div></div><p>Flow of events<a id="id529" class="indexterm"/> for successful execution is as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><code class="literal">Zend\Mvc\Application</code>: <span class="strong"><strong>Bootstrap</strong></span></li><li class="listitem"><code class="literal">Zend\Mvc\Application</code>: <span class="strong"><strong>Route</strong></span></li><li class="listitem"><code class="literal">Zend\Mvc\Application</code>: <span class="strong"><strong>Dispatch</strong></span></li><li class="listitem"><code class="literal">Zend\Mvc\Controller\ActionController</code>: <span class="strong"><strong>Dispatch</strong></span> (if controller extends this class)</li><li class="listitem"><code class="literal">Zend\Mvc\Application</code>: <span class="strong"><strong>Render</strong></span></li><li class="listitem"><code class="literal">Zend\View\View</code>: <span class="strong"><strong>Renderer</strong></span></li><li class="listitem"><code class="literal">Zend\View\View</code>: <span class="strong"><strong>Response</strong></span></li><li class="listitem"><code class="literal">Zend\Mvc\Application</code>: <span class="strong"><strong>Finish</strong></span></li></ol></div><p>In case of errors during dispatch (or) route, the flow of events will be as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><code class="literal">Zend\Mvc\Application</code>: <span class="strong"><strong>Dispatch.error</strong></span></li><li class="listitem"><code class="literal">Zend\Mvc\Application</code>: <span class="strong"><strong>Render</strong></span></li><li class="listitem"><code class="literal">Zend\View\View</code>: <span class="strong"><strong>Renderer</strong></span></li><li class="listitem"><code class="literal">Zend\View\View</code>: <span class="strong"><strong>Response</strong></span></li><li class="listitem"><code class="literal">Zend\Mvc\Application</code>: <span class="strong"><strong>Finish</strong></span></li></ol></div><p>In our <a id="id530" class="indexterm"/>next activity, we will try to set a new layout for multiple controllers using the shared event manager in Zend Framework.</p></div>
<div class="section" title="Time for action &#x2013; setting module layout using ZF events"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec53"/>Time for action – setting module layout using ZF events</h1></div></div></div><p>Perform <a id="id531" class="indexterm"/>the following<a id="id532" class="indexterm"/> steps for setting the module layout using ZF events:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new layout for the <span class="strong"><strong>My Account</strong></span> page and save it under <code class="literal">CommunicationApp/module/Users/view/layout/myaccount-layout.phtml</code>.</li><li class="listitem">Add the layout to the <code class="literal">CommunicationApp/module/Users/config/module.config.php</code> file under <code class="literal">view_manager -&gt; template_map</code>:<div class="informalexample"><pre class="programlisting">'layout/myaccount' =&gt; __DIR__ . '/../view/layout/myaccount-layout.phtml',</pre></div></li><li class="listitem">Open the <code class="literal">CommunicationApp/module/Users/module.php</code> file and add references to <code class="literal">MvcEvent</code>:<div class="informalexample"><pre class="programlisting">use Zend\Mvc\MvcEvent;</pre></div></li><li class="listitem">Overwrite the <code class="literal">onBootStrap()</code> method<a id="id533" class="indexterm"/> with the following code:<div class="informalexample"><pre class="programlisting">public function onBootstrap($e)
{
  $eventManager  = $e-&gt;getApplication()-&gt;getEventManager();
  $moduleRouteListener = new ModuleRouteListener();
  $moduleRouteListener-&gt;attach($eventManager);
  
  $sharedEventManager = $eventManager-&gt;getSharedManager(); // The shared event manager
  $sharedEventManager-&gt;attach(__NAMESPACE__, MvcEvent::EVENT_DISPATCH, function($e) {
    $controller = $e-&gt;getTarget(); // The controller which is dispatched
    $controllerName = $controller-&gt;getEvent()
           -&gt;getRouteMatch()-&gt;getParam('controller');
    if (!in_array($controllerName, 
              array('Users\Controller\Index', 'Users\Controller\Register', 'Users\Controller\Login'))) {
      $controller-&gt;layout('layout/myaccount');
    }
  });
}</pre></div></li><li class="listitem">Open<a id="id534" class="indexterm"/> the <span class="strong"><strong>Communication Application</strong></span> page in any web browser; make a note of the layout:<div class="mediaobject"><img src="graphics/1929OS_05_07.jpg" alt="Time for action – setting module layout using ZF events"/></div></li><li class="listitem">Log<a id="id535" class="indexterm"/> in to the<a id="id536" class="indexterm"/> application and see the new layout being applied:<div class="mediaobject"><img src="graphics/1929OS_05_08.jpg" alt="Time for action – setting module layout using ZF events"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec57"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We have used the Zend Framework event manager to attach a listener to the <code class="literal">Dispatch</code> event of<a id="id537" class="indexterm"/> the module. So every time the controller is dispatched, this event is triggered. The callback checks if the controller is valid and if the controller is not among the list of controllers<a id="id538" class="indexterm"/> that have the <code class="literal">default</code> layout, <a id="id539" class="indexterm"/>then the <code class="literal">myaccount</code> layout is applied to these controllers.</p></div><div class="section" title="Pop quiz – chat and e-mail"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec58"/>Pop quiz – chat and e-mail</h2></div></div></div><p>Q1. Which of the following helpers can be used to define/attach CSS styles inside the HTML <code class="literal">head</code> section?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><code class="literal">HeadLink</code></li><li class="listitem"><code class="literal">HeadScript</code></li><li class="listitem"><code class="literal">HeadCss</code></li><li class="listitem"><code class="literal">HeadStyle</code></li></ol></div><p>Q2. Which of the following are valid mail transports supported by Zend Framework 2?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><code class="literal">Zend\Mail\Transport\Pop</code></li><li class="listitem"><code class="literal">Zend\Mail\Transport\Smtp</code></li><li class="listitem"><code class="literal">Zend\Mail\Transport\Imap</code></li><li class="listitem"><code class="literal">Zend\Mail\Transport\File</code></li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec54"/>Summary</h1></div></div></div><p>We have covered a wide range of topics in this chapter; first we learned about making use of external JavaScripts. Next we created a simple group chat application and then we learned about <code class="literal">Zend\Mail</code> and implemented a simple mailing form. Towards the end, we learned about events and how to make use of these events in Zend Framework. In the next chapter we will be working on media sharing using Zend Framework by working with various media-sharing APIs.</p></div></body></html>