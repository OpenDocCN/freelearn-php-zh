<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Extending the Core"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Extending the Core</h1></div></div></div><p>In this chapter, you will learn:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using CodeIgniter Sparks</li><li class="listitem" style="list-style-type: disc">Creating PDFs with the DOMPDF Spark</li><li class="listitem" style="list-style-type: disc">Creating Hooks in CodeIgniter</li><li class="listitem" style="list-style-type: disc">Clearing dead sessions from the database</li><li class="listitem" style="list-style-type: disc">Extending your controllers</li><li class="listitem" style="list-style-type: disc">Uploading a file with FTP</li><li class="listitem" style="list-style-type: disc">Making your own configuration files and using the settings</li><li class="listitem" style="list-style-type: disc">Creating libraries and giving them access to CodeIgniter resources</li><li class="listitem" style="list-style-type: disc">Using the language class – switching languages on the go</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec80"/>Introduction</h1></div></div></div><p>CodeIgniter does pretty much most of what you need it to do right out of the box; but there are going to be times when you have to extend or alter the standard setup—whether it's creating Hooks so you don't have to hack the core (you really don't want to hack the core), or installing Sparks to add extra functionality and scope for new features—there are many ways to extend and build on CodeIgniter to get more out of it.</p></div></div>
<div class="section" title="Using CodeIgniter Sparks"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec81"/>Using CodeIgniter Sparks</h1></div></div></div><p>Not too long ago, if you wanted to <a id="id534" class="indexterm"/>install an extension or some external software for <a id="id535" class="indexterm"/>CodeIgniter, you had to hunt it down. You'd need to search for what you were looking for on the Internet and if you were lucky, you would find a blog or someone's personal site, perhaps even a GitHub account or Google code repository where you could download and install a package. Sometimes it worked, sometimes it didn't and whatever you downloaded it almost always needed some level of editing or re-writing.</p><p>Fast forward to, now! Thankfully, we have Sparks. Think of Sparks as extensions you can use with CodeIgniter. They're kept in one place (so you don't have to hunt them down across the Internet) at <a class="ulink" href="http://www.getsparks.org">http://www.getsparks.org</a>.</p><p>We touched on Sparks in <a class="link" href="ch01.html" title="Chapter 1. CodeIgniter Basics">Chapter 1</a>, <span class="emphasis"><em>CodeIgniter Basics</em></span>, however, let's go into more detail and get you to install and use a <a id="id536" class="indexterm"/>couple of Sparks which I have found useful over time.</p><p>So, if you haven't installed it until now, install Sparks in your CodeIgniter instance. Either go to <a class="link" href="ch01.html" title="Chapter 1. CodeIgniter Basics">Chapter 1</a>, <span class="emphasis"><em>CodeIgniter Basics</em></span>, for instructions on how to do this, or follow the instructions on the GetSparks website.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec171"/>Getting ready</h2></div></div></div><p>First, you need to navigate to the top level (or root) of your CodeIgniter directory.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec172"/>How to do it...</h2></div></div></div><p>If you are using MAC or Linux, <a id="id537" class="indexterm"/>download CodeIgniter Sparks as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">On the command line, navigate to the root of your CodeIgniter application, and type:<div class="informalexample"><pre class="programlisting">php -r "$(curl -fsSL http://getsparks.org/go-sparks)"</pre></div><p>This will download and install CodeIgniter Sparks to your specific CodeIgniter instance.</p></li></ol></div><p>If you are using Windows, then you will need to download Sparks and unpack manually. To do follow these instructions or check out the instructions on the GetSparks website for the latest version:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a folder named <code class="literal">tools</code> in the top level (root) of your CodeIgniter directory.</li><li class="listitem">Go to the following URL: <a class="ulink" href="http://getsparks.org/install">http://getsparks.org/install</a>.</li><li class="listitem">Go to the <span class="strong"><strong>Normal Installation</strong></span> section and download the Sparks package.</li><li class="listitem">Unpack the download into the <code class="literal">tools</code> folder you created in step 1.</li><li class="listitem">Download the <a id="id538" class="indexterm"/><code class="literal">Loader</code> class extension from: <a class="ulink" href="http://getsparks.org/static/install/MY_Loader.php.txt">http://getsparks.org/static/install/MY_Loader.php.txt</a>.</li><li class="listitem">Rename the <code class="literal">MY_Loader.php.txt</code> file, to <code class="literal">MY_Loader.php</code>, and move it to the <code class="literal">application/core/MY_Loader.php</code> directory in your CodeIgniter application.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec173"/>How it works...</h2></div></div></div><p>Sparks is downloaded to the <code class="literal">/path/to/codeigniter/tools</code> folder of your CodeIgniter instance ready for use. You can install any Spark you wish by issuing the following command:</p><div class="informalexample"><pre class="programlisting">php tools/spark install [version] spark-name</pre></div><p>Here, <code class="literal">[version]</code> is the specific version <a id="id539" class="indexterm"/>of the Spark. It is optional, and if you omit it, Sparks will automatically select the latest <a id="id540" class="indexterm"/>version. <code class="literal">spark-name</code> is the name of the Spark you wish to download.</p></div></div>
<div class="section" title="Creating PDFs with the DOMPDF Spark"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec82"/>Creating PDFs with the DOMPDF Spark</h1></div></div></div><p>The DOMPDF Spark is a <a id="id541" class="indexterm"/>great bit of kit; it's simple to set up and can <a id="id542" class="indexterm"/>handle most things. It works by grabbing the output of a HTML template file (which you previously created)—you can pass variables to the HTML just as you would with a normal view file—and DOMPDF will create a PDF file from that formatted HTML code.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec174"/>Getting ready</h2></div></div></div><p>As this recipe requires the DOMPDF Spark, we'll need to install that into our CodeIgniter instance before we do anything else. To install it, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Grab the DOMPDF Spark from <a class="ulink" href="http://getsparks.org">getsparks.org</a> and install it. Open a terminal window, navigate to your CodeIgniter application directory, and type the following code:<div class="informalexample"><pre class="programlisting">php tools/spark install dompdf</pre></div><p>That will download the DOMPDF Spark. The DOMPDF Spark may have been downloaded, but you'll need to do some installation to get it going.</p><p>In the <code class="literal">/path/to/codeigniter/sparks/dompdf/[version-number]/helpers</code> folder (where <code class="literal">[version-number]</code> is the version of the Spark), there is a folder and a file. These are as follows (in bold):</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/sparks/dompdf/0.5.3/helpers/dompdf/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/sparks/dompdf/0.5.3/helpers/dompdf_helper.php</code></li></ul></div></li><li class="listitem">Copy this folder and file into the <code class="literal">helpers</code> folder of your CodeIgniter application (<code class="literal">/path/to/codeigniter/application/helpers</code>).</li><li class="listitem">We're also going to need a database table in order for our model to work, so go ahead, and type the following code into your database:<div class="informalexample"><pre class="programlisting">CREATE TABLE `users` (
  `user_id` int(11) NOT NULL AUTO_INCREMENT,
  `user_firstname` varchar(255) NOT NULL,
  `user_lastname` varchar(255) NOT NULL,
  `user_email` varchar(255) NOT NULL,
  PRIMARY KEY (`user_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=3 ;

INSERT INTO `users` (`user_id`, `user_firstname`, `user_lastname`, `user_email`) VALUES
(1, 'Rob', 'Foster', 'rf@domain.com'),
(2, 'Lucy', 'Welsh', 'lw@domain.com');</pre></div></li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec175"/>How to do it...</h2></div></div></div><p>We're going to create the following three files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/makepdf.php</code>: This controller will load the <a id="id543" class="indexterm"/>DOMPDF extension and output our PDF.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/makepdf_model.php</code>: We'll use this model to get <a id="id544" class="indexterm"/>information <a id="id545" class="indexterm"/>from the database that is necessary to pass to the view file <code class="literal">view_all_users</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/makepdf/view_all_users.php</code>: <a id="id546" class="indexterm"/>This file contains the HTML and markup for how we wish the PDF to look. It also contains <a id="id547" class="indexterm"/>some PHP code, which echoes out some data gathered from the model.</li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First add the following code to the <code class="literal">makepdf </code>controller:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed');

class Makepdf extends CI_Controller {
    function __construct() {
        parent::__construct();
        $this-&gt;load-&gt;helper('file');
        $this-&gt;load-&gt;helper('dompdf');
        $this-&gt;load-&gt;model('Makepdf_model');
    }

    function index() {
        $data['query'] = $this-&gt;Makepdf_model-&gt;get_all_users();
        $filename = 'List-of-users';
        $html = $this-&gt;load-&gt;view('makepdf/view_all_users', $data, true);
        pdf_create($html, $filename);
    }
}</pre></div></li><li class="listitem">Then add the following <a id="id548" class="indexterm"/>code to the <code class="literal">makepdf_model</code> model:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed');

class Makepdf_model extends CI_Model {

    function __construct() {
        parent::__construct();
    }

    function get_all_users() {
        $query = $this-&gt;db-&gt;get('users');
        return $query;
    }
}</pre></div></li><li class="listitem">Finally, add the <a id="id549" class="indexterm"/>following <a id="id550" class="indexterm"/>code to the <code class="literal">makepdf/view_all_users.php</code> view:<div class="informalexample"><pre class="programlisting">&lt;table&gt;
&lt;tr&gt;
    &lt;td&gt;First Name&lt;/td&gt;
    &lt;td&gt;Last Name&lt;/td&gt;
    &lt;td&gt;Email&lt;/td&gt;
&lt;/tr&gt;
    &lt;?php foreach($query-&gt;result() as $row) : ?&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;?php echo $row-&gt;user_firstname ; ?&gt;&lt;/td&gt;
            &lt;td&gt;&lt;?php echo $row-&gt;user_lastname ; ?&gt;&lt;/td&gt;
            &lt;td&gt;&lt;?php echo $row-&gt;user_email ; ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
    &lt;?php endforeach ; ?&gt;
&lt;/table&gt;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec176"/>How it works...</h2></div></div></div><p>In the constructor of our <code class="literal">makepdf</code> <a id="id551" class="indexterm"/>controller, we load the <code class="literal">dompdf</code> helper. We place the <code class="literal">dompdf_helper.php</code> file and the <code class="literal">dompdf</code> folder in the <code class="literal">helpers</code> folder of our CodeIgniter application installed earlier on in the <span class="emphasis"><em>Getting ready</em></span> section of this recipe.</p><p>
<code class="literal">private function index()</code> <a id="id552" class="indexterm"/>then calls the <code class="literal">Makepdf_model</code> <a id="id553" class="indexterm"/>function, <code class="literal">get_all_users()</code>. This model function runs a simple select operation on the users table and stores it in the <code class="literal">$data['query']</code> array, we will come back to this in a moment. The <a id="id554" class="indexterm"/>
<code class="literal">$filename</code> variable is assigned the string <code class="literal">List-of-users</code>, but if you wanted, you could change this to anything you wanted, you can even add today's date if required, which would look like the following code snippet:</p><div class="informalexample"><pre class="programlisting">$filename = 'List-of-users-for'.date("d-m-Y", time())</pre></div><p>Anyway, back to the story. We <a id="id555" class="indexterm"/>then use the standard CodeIgniter method a view file and pass the <code class="literal">$data</code> array to it: $html = $this-&gt;load-&gt;view('makepdf/view_all_users', $data, true). Remember this <code class="literal">$data</code> <a id="id556" class="indexterm"/>array contains our database query of users. Instead of letting CodeIgniter render the view as it would normally, we catch the now processed HTML to a <code class="literal">$html</code> variable, which is passed to the <a id="id557" class="indexterm"/>
<code class="literal">dompdf</code> function, <a id="id558" class="indexterm"/>
<code class="literal">pdf_createalong</code>, with the <a id="id559" class="indexterm"/>
<code class="literal">$filename</code> variable.</p><p>If you load the controller in your browser, <a id="id560" class="indexterm"/>you should automatically be prompted to download the PDF.</p><p>You can see how this can easily be adapted to output a wide and varied HTML designs, from invoices to, purchase orders to, address contacts. Just amend the model query to pull out what you need to know from the database and alter the HTML to display that information, and there you go.</p></div></div>
<div class="section" title="Creating Hooks in CodeIgniter"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec83"/>Creating Hooks in CodeIgniter</h1></div></div></div><p>There you are, quite happily using <a id="id561" class="indexterm"/>some framework or CMS to run a website, and you've just been asked to get it to do something which it was not originally designed. You begrudgingly agreed and start to work out how to implement what's been asked. You decide that you'll amend the core system files of whatever platform you've been stuck with because it's quick and easy, and because your boss used terms such as "quick wins" and "cost efficient". </p><p>Anyway, the requested functionality works and everyone's happy—except the poor person (that may still be you) who comes along a few months later to upgrade the platform to the latest version and…<span class="emphasis"><em>BANG</em></span>! That amendment you made to the system core, forget it! It's been lost by overwriting it with the new files from the upgrade. Now, that crazy thing you were asked to implement no longer works and you're left trying to remember what you did to get it working. Then before anyone notices, it's missing, and you're left thinking. "oh God why can't I just go home!"</p><p>Well cheer up! You're using CodeIgniter and that should never happen to you (providing you use Hooks of course). You can still hack the core if you wish—go ahead, hack away, see if I care—but you'll kick yourself when you have to upgrade. I'm only thinking about your stress levels.</p><p>Hooks allow you to override the behavior of CodeIgniter at specific points at its execution without the need to make changes to the CodeIgniter core files. Fantastic! That means that with CodeIgniter, you can implement any number of ludicrous management change requests and it won't affect you on upgrade day one bit. Hooks work in a specific order. What does that mean? Well, it means that CodeIgniter works in a specific order, that is to say, when CodeIgniter runs, it loads <a id="id562" class="indexterm"/>specific parts of itself in a set order. This order is always the same, and you can set a Hook to execute at any one of the steps.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec177"/>Getting ready</h2></div></div></div><p>First, you need to tell CodeIgniter that it should allow Hooks to run. Open the <code class="literal">/application/config/config.php</code> file and ensure that the setting for <code class="literal">enable_hooks</code> is <code class="literal">TRUE</code>, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">$config['enable_hooks'] = TRUE;</pre></div><p>You'll also have to decide the best time for your Hook to run. There are seven points in the execution of CodeIgniter where you can set your Hook to run, as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">pre_system</code>: This is the <a id="id563" class="indexterm"/>earliest place you can set a Hook to run. Only <a id="id564" class="indexterm"/>Benchmarking and Hooks are brought into play at this stage</li><li class="listitem" style="list-style-type: disc"><code class="literal">pre_controller</code>: This <a id="id565" class="indexterm"/>is <a id="id566" class="indexterm"/>executed before any of your controllers are called</li><li class="listitem" style="list-style-type: disc"><code class="literal">post_controller_constructor</code>: <a id="id567" class="indexterm"/>This makes your Hooks run after a controller constructor but <a id="id568" class="indexterm"/>before any controller functions are called</li><li class="listitem" style="list-style-type: disc"><code class="literal">post_controller</code>: This <a id="id569" class="indexterm"/>makes your Hook run after the controller has <a id="id570" class="indexterm"/>finished executing</li><li class="listitem" style="list-style-type: disc"><code class="literal">display_override</code>: This <a id="id571" class="indexterm"/>will override the CodeIgniter <a id="id572" class="indexterm"/><code class="literal">display()</code> <a id="id573" class="indexterm"/>function--this is when CodeIgniter tried to render view files or other output to screen</li><li class="listitem" style="list-style-type: disc"><code class="literal">cache_override</code>: This <a id="id574" class="indexterm"/>overrides the <code class="literal">_display_cache()</code> <a id="id575" class="indexterm"/>function,you can use this if you wanted to implement custom caching functionality</li><li class="listitem" style="list-style-type: disc"><code class="literal">post_system</code>: This is to be <a id="id576" class="indexterm"/>called once the normal operation has <a id="id577" class="indexterm"/>finished (that is, after the system has finished its execution of the current request)</li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec178"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Define an execution point for your hook. Once you've decided the point to run your Hook, you'll need to tell CodeIgniter when to run the hook. You do this, by defining the correct information in the <code class="literal">$hook</code> array in the <code class="literal">config/hooks.php</code> file. <p>The key of the <code class="literal">$hook</code> array specifies the execution point --that is when you want the hook to run (see the list mentioned in the Getting ready section of this recipe). In the following example, the array key is <code class="literal">post_controller</code>, which means that the hook is executed after the controller has finished executing. The <a id="id578" class="indexterm"/>
<code class="literal">$hook</code> array now looks like the following.</p><div class="informalexample"><pre class="programlisting">$hook['post_controller'] = array(
    'class'    =&gt; 'Class_name',
    'function' =&gt; 'function_name',
    'filename' =&gt; 'file_name_of_hook.php',
    'filepath' =&gt; 'path_to_hook',
    'params'   =&gt; array(param1, param2, param3 ... etc)
    );</pre></div><p>So what does all the preceding code <a id="id579" class="indexterm"/>mean then? Let' have a look at the following table to understand the preceding code better:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Array element</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">class</code>
</p>
</td><td style="text-align: left" valign="top">
<p>It is the name of the class, which is in the file defined in the <code class="literal">filename</code> element.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">function</code>
</p>
</td><td style="text-align: left" valign="top">
<p>It is the name of the function in the class.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">filename</code>
</p>
</td><td style="text-align: left" valign="top">
<p>It is the name of the file which contains the class.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">filepath</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the location of the file defined in the array element <code class="literal">filename</code>, normally the folder <code class="literal">hooks</code>,  but you can add subfolders or move it to a different location if you wish.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">params</code>
</p>
</td><td style="text-align: left" valign="top">
<p>They are any arguments you wish to pass to the <code class="literal">function</code> element of your <code class="literal">Hook</code> class. Separate each argument by a comma.</p>
</td></tr></tbody></table></div></li><li class="listitem">You then need to create your hook class, as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">&lt;?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Class_name {
  function function_name () {
  }
}</pre></div><p>You put the code for your hook in this class, obviously change <code class="literal">Class_name</code> to something more useful for you, and the function <code class="literal">function_name()</code> is obviously an example--change this name too.</p></li></ol></div><p>Should you need to  gain access to CodeIgniter <a id="id580" class="indexterm"/>resources in your hook, you can do so by accessing the main CodeIgniter object, using the CodeIgniter get_instance() function shown in  the following code:</p><div class="informalexample"><pre class="programlisting">function function_name () {
  $CI = &amp; get_instance();
  $CI-&gt;load-&gt;thing_to_load();
}</pre></div><p>Here, <code class="literal">thing_to_load</code> <a id="id581" class="indexterm"/>is the name of <a id="id582" class="indexterm"/>your model, or library, and so on. There you have it--hooks are simple really, decide on an execution point, create a class to contain the code for your hook, and away you go!</p></div></div>
<div class="section" title="Clearing dead sessions from the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec84"/>Clearing dead sessions from the database</h1></div></div></div><p>You may have found that CodeIgniter sometimes does not successfully <a id="id583" class="indexterm"/>remove sessions from the sessions table in the database. Unused sessions are instead cleared of their <code class="literal">user_data field</code>, but that the row remains in the sessions table.</p><p>I have often had to write specific database queries to clear sessions. I usually put these queries in the <code class="literal">My_Controller</code> class(refer to the <span class="emphasis"><em>Extending your controllers</em></span> recipe in this chapter); however, I have recently begun to use Hooks to perform this. Then it's always working in the background and I don't need to think about it.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec179"/>Getting ready</h2></div></div></div><p>We're going to amend the following file:</p><p>
<code class="literal">/path/to/codeigniter/application/config/config.php</code>
</p><p>Open the <code class="literal">/application/config/config.php</code> file and ensure that the setting for <code class="literal">enable_hooks</code> is <code class="literal">TRUE</code>, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">$config['enable_hooks'] = TRUE;</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec180"/>How to do it...</h2></div></div></div><p>We're going create  and amend <a id="id584" class="indexterm"/>the following file:</p><p>
<code class="literal">/path/to/codeigniter/application/hooks/clear_sessions.php</code>
</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the preceding file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Clear_sessions {
  function clear_now() {
    $CI =&amp; get_instance();
    $query = $CI-&gt;db-&gt;query("DELETE FROM `ci_sessions` WHERE `user_data` = '' ");
  }
}</pre></div><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip12"/>Tip</h3><p>We're using the default CodeIgniter sessions table name, that is, <code class="literal">ci_sessions</code>. In your application, you'll need to  substitute this value with the name of your sessions table (assuming you've changed it from <code class="literal">ci_sessions</code>).</p></div></div></li><li class="listitem">Open the <code class="literal">/path/to/codeigniter/application/config/hooks.php</code> file and add the following code to it:<div class="informalexample"><pre class="programlisting">$hook['post_controller'] = array(
    'class'    =&gt; 'Clear_sessions',
    'function' =&gt; 'clear_now',
    'filename' =&gt; 'clear_sessions.php',
    'filepath' =&gt; 'hooks'
    );</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec181"/>How it works...</h2></div></div></div><p>We have defined a class (<code class="literal">Clear_sessions</code>) in the <a id="id585" class="indexterm"/>
<code class="literal">clear_sessions.php</code> file into which we'll put all the logic we need for the Hook to perform its task. Within that class, we have the <a id="id586" class="indexterm"/>
<code class="literal">clear_now()</code> function. <a id="id587" class="indexterm"/>CodeIgniter knows that it is to run the <code class="literal">clear_now()</code> function, in the <code class="literal">Clear_sessions</code> class, in the <code class="literal">clear_sessions.php</code> file, because we defined this in the <code class="literal">hooks.php config</code> file, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">$hook['post_controller'] = array(
    'class'    =&gt; 'Clear_sessions',
    'function' =&gt; 'clear_now',
    'filename' =&gt; 'clear_sessions.php',
    'filepath' =&gt; 'hooks'
    );</pre></div><p>We told CodeIgniter the location of the <code class="literal">clear_sessions.php</code> file with the <code class="literal">filepath</code> element of the preceding array. CodeIgniter will run this Hook at the <code class="literal">post_controller</code> stage of execution, that is to say, after a controller has been run. So, that's how CodeIgniter knows what hook to execute and when; but what of the function of the hook? What does that do?</p><p>Let's look at the following code line:</p><div class="informalexample"><pre class="programlisting">$CI =&amp; get_instance();</pre></div><p>This gives us access to the main CodeIgniter object, which is defined as <code class="literal">$CI</code> (for CodeIgniter). Using this object, we have access to the database functions and settings. We'll use this <code class="literal">$CI</code> object to run a database query, as <a id="id588" class="indexterm"/>shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">$query = $CI-&gt;db-&gt;query("DELETE FROM `ci_sessions` WHERE `user_data` = '' ");</pre></div><p>The preceding code line deletes any sessions from the table (named here as the default CodeIgniter sessions table ci_sessions) whose <code class="literal">user_data</code> is empty (<span class="emphasis"><em>not</em></span> not null just empty).</p><p>All spent sessions that CodeIgniter <a id="id589" class="indexterm"/>hasn't cleaned up properly should now be gone from the sessions table, leaving active sessions alone.</p></div></div>
<div class="section" title="Extending your controllers"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec85"/>Extending your controllers</h1></div></div></div><p>Inheritance is a wonderful thing; allowing you to define conceptual layers, or levels within an application, that is, allowing child classes to share traits and attributes of parent classes allows applications to model real-world examples more accurately and intuitively than standard procedural programming.</p><p>In CodeIgniter, the default design structure for your application is that the controller you create extends the main CodeIgniter controller. For example, in the following code, we have a <code class="literal">Signin </code>controller, which extends the main CodeIgniter controller, <code class="literal">CI_Controller</code>:</p><div class="informalexample"><pre class="programlisting">class Signin extends CI_Controller {
}</pre></div><p>Your <code class="literal">Signin</code> controller will inherit the properties of the <code class="literal">CI_Controller</code>. However, CodeIgniter also allows you to parachute in a stage between the <code class="literal">CI_Controller</code> and the controller you create, you can slot in a middle layer. This middle step is named <code class="literal">My_Controller</code>. The new MY_Controller will extend the CI_Controller (inheriting everything as it goes) and any normal application-specific controller you create (users, login, invoice, and so on) will inherit from the new MY_Controller. It is defined as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">class MY_Controller extends CI_Controller {
}</pre></div><p>Now, your <code class="literal">Signin</code> class must be amended to inherit from your <code class="literal">MY_Controller</code> rather than CodeIgniter's <code class="literal">CI_Controller</code> as follows:</p><div class="informalexample"><pre class="programlisting">class Signin extends MY_Controller {
}</pre></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec182"/>How to do it...</h2></div></div></div><p>We're going to create the following <a id="id590" class="indexterm"/>two files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/core/MY_Controller.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/days.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">/path/to/codeigniter/application/core/MY_Controller.php</code> file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed');
class MY_Controller extends CI_Controller {
    function __construct() {
        parent::__construct();
        $this-&gt;load-&gt;helper('array');
    }
}</pre></div></li><li class="listitem">Next, create the <code class="literal">/path/to/codeigniter/application/controllers/days.php</code> file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed');

class Days extends MY_Controller {
    function __construct() {
        parent::__construct();
    }

    function index() {
        $days = array("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday");
        echo random_element($days);
    }
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec183"/>How it works...</h2></div></div></div><p>This is mostly Inheritance. Your child classes are inheriting attributes from parent classes. However, specifically here, we are demonstrating how to load the array helper in the <code class="literal">MY_Controller class</code> and have the <code class="literal">Days</code> controller inherit the helper resource in order to execute the array helper function, <code class="literal">random_element()</code>.</p><p>There are so many uses for this, for example, you could check to see if the user was logged in your <code class="literal">MY_Controller Class</code>, this would mean that you would only have to write this once rather than in every controller. Or you could go further and have an authenticated controller and unauthenticated controller <a id="id591" class="indexterm"/>extending <code class="literal">MY_Controller</code>. The <code class="literal">MY_Controller</code> file would call any files and perform any tasks common to authenticated and unauthenticated users, While, the authenticated controller would perform login checks, and so on.</p></div></div>
<div class="section" title="Uploading a file with FTP"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec86"/>Uploading a file with FTP</h1></div></div></div><p>Every now and again, you'll be <a id="id592" class="indexterm"/>asked to generate a file—perhaps from a database export, or maybe some system logs. Most of the time, you'll be asked to e-mail that file to <a id="id593" class="indexterm"/>some location, but sometimes, you'll be asked to upload it to an FTP folder the client has access to. We're going to take a recipe from a previous chapter (<span class="emphasis"><em>Generating a CSV from a database result</em></span> from <a class="link" href="ch06.html" title="Chapter 6. Working with Databases">Chapter 6</a>, <span class="emphasis"><em>Working with Databases</em></span>), and adapt it so that it uploads to an FTP location rather than stream an output.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec184"/>Getting ready</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We're going to be pulling some values from a database. To do that, we'll need a table to pull data from. The following is the schema for that table. Copy the following into your database:<div class="informalexample"><pre class="programlisting">CREATE TABLE `users` (
  `user_id` int(11) NOT NULL AUTO_INCREMENT,
  `user_firstname` varchar(255) NOT NULL,
  `user_lastname` varchar(255) NOT NULL,
  `user_email` varchar(255) NOT NULL,
  PRIMARY KEY (`user_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=3 ;# MySQL returned an empty result set (i.e. zero rows).

INSERT INTO `users` (`user_id`, `user_firstname`, `user_lastname`, `user_email`) VALUES
(1, 'Rob', 'Foster', 'rf@domain.com'),
(2, 'Lucy', 'Welsh', 'lw@domain.com');# 2 rows affected.</pre></div></li><li class="listitem">Go to <a class="link" href="ch06.html" title="Chapter 6. Working with Databases">Chapter 6</a>, <span class="emphasis"><em>Working with Databases</em></span>, and copy out the code from the <span class="emphasis"><em>Generating a CSV from a database result</em></span> recipe; then return here for further instructions.</li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec185"/>How to do it...</h2></div></div></div><p>We're going to amend one file from the <span class="emphasis"><em>Generating a CSV from a database result</em></span> recipe, that is, <code class="literal">/path/to/codeigniter/application/controllers/export.php</code>. This is the export controller from <a class="link" href="ch06.html" title="Chapter 6. Working with Databases">Chapter 6</a>, <span class="emphasis"><em>Working with Databases</em></span>. We're going to use it as the basis for this recipe. It will grab some <a id="id594" class="indexterm"/>data from the database that eventually generates a CSV for us.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">export.php</code> for editing and amend it to reflect the following code snippet (changes are highlighted):<div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Export extends CI_Controller {
  function __construct() {
    parent::__construct();
    $this-&gt;load-&gt;helper('url');
    $this-&gt;load-&gt;helper('file');
    $this-&gt;load-&gt;library('ftp');
    $this-&gt;load-&gt;dbutil();
  }

  public function index() {
    redirect('export/csv');
  }

  public function csv() {
    $query = $this-&gt;db-&gt;query("SELECT * FROM users");

    $delimiter = ",";
    $newline = "\r\n";

    $data = $this-&gt;dbutil-&gt;csv_from_result($query, $delimiter, $newline);
    $filename = 'myfile.csv';
    $path = './'.$filename;	

    if (! write_file($path, $data)) {
      echo 'Cannot write file - permissions maybe?';
      exit;
    }

    $config['hostname'] = 'your-hostname';
    $config['username'] = 'your-username';
    $config['password'] = 'your-password';
    $config['debug'] = TRUE;

    $this-&gt;ftp-&gt;connect($config);
    $this-&gt;ftp-&gt;upload($path, '/dir_on_ftp/'.$filename, 'ascii', 0755);
    $this-&gt;ftp-&gt;close();
  }
}</pre></div><p>There are some variables <a id="id595" class="indexterm"/>here that you should change to reflect the settings of your FTP environment such as:</p><div class="informalexample"><pre class="programlisting">$config['hostname'] = 'ftp.example.com';
$config['username'] = 'your-username';
$config['password'] = 'your-password';</pre></div><p>...and the string <code class="literal">dir_on_ftp</code> in:</p><div class="informalexample"><pre class="programlisting">$this-&gt;ftp-&gt;upload($path, '/dir_on_ftp/'.$filename, 'ascii', 0755);</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec186"/>How it works...</h2></div></div></div><p>As you would expect from a new recipe, there are some changes in the normal export controller that we've used in <a class="link" href="ch06.html" title="Chapter 6. Working with Databases">Chapter 6</a>, <span class="emphasis"><em>Working with Databases</em></span>. These changes are necessary to support the FTP helper in <a id="id596" class="indexterm"/>its job of uploading a file to an FTP server. Let's take a look at what's going on.</p><p>First, we load the helpers we'll need--url, file, and FTP--in the Exporter controllers constructor to ensure that this export controller has the right support necessary to make the file transfer. </p><div class="informalexample"><pre class="programlisting">function __construct() {
    parent::__construct();
    $this-&gt;load-&gt;helper('url');
    $this-&gt;load-&gt;helper('file');
    $this-&gt;load-&gt;library('ftp');    
    $this-&gt;load-&gt;dbutil();    
  }</pre></div><p>Everything then follows the functionality of the previous controller (from <a class="link" href="ch06.html" title="Chapter 6. Working with Databases">Chapter 6</a>,<span class="emphasis"><em> Working with Databases</em></span>) ,that is, fetching a result set from the database table <a id="id597" class="indexterm"/>and using the CodeIgniter <a id="id598" class="indexterm"/>
<code class="literal">dbutil</code> function, <code class="literal">csv_from_result()</code>, to generate a file for us. It's placed on the server by <code class="literal">write_file()</code> using the location defined in <code class="literal">$path</code>.</p><p>Then the FTP functionality kicks in. We define the login settings for the FTP server we want to write the file to--you can and probably should put these in your own config file (also explained in this chapter, see the <span class="emphasis"><em>Making your own configuration files and using the settings </em></span>recipe), but for now, we'll define them here as it's easier to explain one thing at a time. The settings are fairly obvious until you see the <code class="literal">$config['debug']</code> array setting. <code class="literal">debug</code> allows error reports to be displayed to you, the developer. Obviously, in a live production environment, you definitely want that set to be <code class="literal">FALSE</code> to prevent any sensitive and important information being shown.</p><p>Anyways, using the login settings that we have defined in our <code class="literal">$config</code> array, we attempt to connect to the FTP server and try to upload a file, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">$this-&gt;ftp-&gt;connect($config);
$this-&gt;ftp-&gt;upload($path, '/dir_on_ftp/'.$filename, 'ascii', 0755);</pre></div><p>If all goes well, the file should be uploaded to your server. Log in with an FTP client and take a look to see if it's there--if it's not check that you're using the correct FTP settings and that the path you're writing to on the FTP server is writable and actually exists, that is, that the path defined here in bold exists:</p><div class="informalexample"><pre class="programlisting">$this-&gt;ftp-&gt;upload($path, '<span class="strong"><strong>/dir_on_ftp/</strong></span>'.$filename, 'ascii', 0755);</pre></div><p>An interesting point is the two function <a id="id599" class="indexterm"/>arguments at the end of the preceding <a id="id600" class="indexterm"/>
<code class="literal">upload()</code> function: <code class="literal">ascii</code> and <code class="literal">0755</code>. These state that we're encoding the file transfer as <code class="literal">ascii</code> (which is plain text) and setting its file permissions to <code class="literal">0755</code>. This can also be defined in the config array if you wish.</p></div></div>
<div class="section" title="Creating libraries and giving them access to CodeIgniter resources"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec87"/>Creating libraries and giving them access to CodeIgniter resources</h1></div></div></div><p>CodeIgniter allows you to create <a id="id601" class="indexterm"/>your own libraries and helpers in circumstances where you don't want or need to place code in controllers or models. Why would you place code in a library and not a helper? Well, some people become quite agitated by the reasoning for this  and I'm sure that if you thought hard enough about it, you could come up with some strict rules that defines when a bit of code is a helper or a library. But life is far too short. As long as the code is well documented and is maintainable, stable, and secure, you can do whatever you like. However, as a general rule of thumb:</p><p>
<span class="emphasis"><em>A library is for code which requires access to other resources, such as needing access to a database, or to an external system (perhaps through cURL), whereas a helper is a smaller bit of code which performs a specific task (such as checking a string being a valid e-mail or </em></span>for a valid <span class="emphasis"><em>URL, for example).</em></span>
</p><p>I'm sure there are better definitions, but this one works for me; and I'm sure there will be times when you may want a helper to have access to a database or other resource; and I'm sure there will be times when a library doesn't need access to these resources. My point is, just make sure the code is documented and maintainable and don't get bogged down in conceptual design augments.</p><p>Having said that, let's look at creating a library and giving it access to CodeIgniter resources (because, by default, it won't).</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec187"/>Getting ready</h2></div></div></div><p>We're going to access a database <a id="id602" class="indexterm"/>through a library; however, to do that we'll need a database to access (of course), so copy the following code into your database:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `person` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `first_name` varchar(50) NOT NULL,
  `last_name` varchar(50) NOT NULL,
  `email` varchar(255) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=5 ;

INSERT INTO `person` (`id`, `first_name`, `last_name`, `email`) VALUES
(1, 'Rob', 'Foster', 'rfoster@dudlydog.com'),
(2, 'Lucy', 'Welsh', 'lwelsh@cocopopet.com'),
(3, 'Chloe', 'Graves', 'cgraves@mia-cat.com'),
(4, 'Claire', 'Strickland', 'cstrickland@an-other-domain.com');</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec188"/>How to do it...</h2></div></div></div><p>We're going to <a id="id603" class="indexterm"/>create the <a id="id604" class="indexterm"/>following three files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/call_lib.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/libraries/lib_to_call.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/lib_model.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">call_lib.php</code> controller and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed');

class Call_lib extends CI_Controller {
  function __construct() {
    parent::__construct();
    $this-&gt;load-&gt;library('lib_to_call');
    $this-&gt;load-&gt;database();
  }

  public function index() {
    $result = $this-&gt;lib_to_call-&gt;get_users();

    echo '&lt;pre&gt;';
      var_dump($result-&gt;result());
    echo '&lt;/pre&gt;';
  }
}</pre></div></li><li class="listitem">Create the <code class="literal">lib_to_call.php</code> library and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed'); 

class Lib_to_call {
    public function get_users() {
<span class="strong"><strong>        $CI =&amp; get_instance();</strong></span>
<span class="strong"><strong>        $CI-&gt;load-&gt;model('Lib_model');        </strong></span>
<span class="strong"><strong>         return $CI-&gt;Lib_model-&gt;get();</strong></span>
    }
}</pre></div></li><li class="listitem">Then create the <code class="literal">lib_model.php</code> model and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Lib_model extends CI_Model {
    function __construct() {
        parent::__construct();
    }

    function get() {
        $query = $this-&gt;db-&gt;get('person');
        return $query;
    }
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec189"/>How it works...</h2></div></div></div><p>In looking at how to give your <a id="id605" class="indexterm"/>libraries access to CodeIgniter resources, we're going to run through the preceding recipe. It's connecting to a model; however, it can be any type of <a id="id606" class="indexterm"/>CodeIgniter resource such as a Hook or a helper, and so on.</p><p>First, the <code class="literal">call_lib.php</code> controller loads in its constructor the <code class="literal">lib_to_call</code> library, as follows:</p><div class="informalexample"><pre class="programlisting">    function __construct() {
        parent::__construct();
        $this-&gt;load-&gt;library('lib_to_call');
    }</pre></div><p>This makes the library available to the entire controller.</p><p>We then call <code class="literal">public function index()</code>, which calls the library function, <code class="literal">get_users()</code>, storing the returned results in the <code class="literal">$result</code> variable. Let's look at what the library function, <code class="literal">get_users()</code>, is doing, this is where we allow the library to get access to CodeIgniter resources.</p><p>Look at the following highlighted lines in the <code class="literal">lib_to_call</code> library:</p><div class="informalexample"><pre class="programlisting">class Lib_to_call {
    public function get_users() {
<span class="strong"><strong>        $CI =&amp; get_instance();</strong></span>
<span class="strong"><strong>        $CI-&gt;load-&gt;model('Lib_model');</strong></span>
<span class="strong"><strong>        return $CI-&gt;Lib_model-&gt;get();</strong></span>
    }
}</pre></div><p>We're using the PHP function, <code class="literal">get_instance()</code>, to get our hands on a copy by reference (that means we're using the initial object rather than a copy of it) or the CodeIgniter object. This object has access to the entire CodeIgniter system and its resources. We store this object in a local variable named <code class="literal">$CI</code> (standing for CodeIgniter). We can now call any CodeIgniter resource we like, just as we would from a controller, except that instead of using <code class="literal">$this</code> (as we would <a id="id607" class="indexterm"/>in a controller), we use <code class="literal">$CI</code>. So, to call a model or helper in a controller, we will do the following:</p><div class="informalexample"><pre class="programlisting">$this-&gt;load-&gt;helper('helper_name');
$this-&gt;load-&gt;model('model_name');</pre></div><p>But to call helpers and models in the library, we now do the following:</p><div class="informalexample"><pre class="programlisting">$CI-&gt;load-&gt;helper('helper_name');
$CI-&gt;load-&gt;model('model_name');</pre></div><p>The model we've now loaded will <a id="id608" class="indexterm"/>query the database with Active Record, returning all rows in the table to the library, which in turn returns it to the controller for processing. In this case (to demonstrate that it worked), we <code class="literal">var_dump()</code> the result. If all goes well, this recipe should output as follows:</p><div class="informalexample"><pre class="programlisting">array(4) {
  [0]=&gt;
  object(stdClass)#19 (4) {
    ["id"]=&gt;
    string(1) "1"
    ["first_name"]=&gt;
    string(3) "Rob"
    ["last_name"]=&gt;
    string(6) "Foster"
    ["email"]=&gt;
    string(20) "rfoster@dudlydog.com"
  }
  [1]=&gt;
  object(stdClass)#20 (4) {
    ["id"]=&gt;
    string(1) "2"
    ["first_name"]=&gt;
    string(4) "Lucy"
    ["last_name"]=&gt;
    string(5) "Welsh"
    ["email"]=&gt;
    string(20) "lwelsh@cocopopet.com"
  }
  [2]=&gt;
  object(stdClass)#21 (4) {
    ["id"]=&gt;
    string(1) "3"
    ["first_name"]=&gt;
    string(5) "Chloe"
    ["last_name"]=&gt;
    string(6) "Graves"
    ["email"]=&gt;
    string(19) "cgraves@mia-cat.com"
  }
  [3]=&gt;
  object(stdClass)#22 (4) {
    ["id"]=&gt;
    string(1) "4"
    ["first_name"]=&gt;
    string(6) "Claire"
    ["last_name"]=&gt;
    string(10) "Strickland"
    ["email"]=&gt;
    string(31) "cstrickland@an-other-domain.com"
  }
}</pre></div><p>The preceding recipe access a <a id="id609" class="indexterm"/>database as a means of demonstrating how to gain access to  a CodeIgniter super object from within a library. However, helpers, Hooks, and other elements can also be accessed. By using <code class="literal">$CI =&amp; get_instance()</code>, we can gain <a id="id610" class="indexterm"/>access to the main CodeIgniter object. By using <code class="literal">$CI</code> rather than <code class="literal">$this</code>, this will give us access to all of CodeIgniter's resources, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">$CI =&amp; get_instance();
$CI-&gt;load-&gt;model('Lib_model');
return $CI-&gt;Lib_model-&gt;get();</pre></div></div></div>
<div class="section" title="Making your own configuration files and using the settings"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec88"/>Making your own configuration files and using the settings</h1></div></div></div><p>It's a great idea to have configuration <a id="id611" class="indexterm"/>settings in the same file—the benefits are obvious—so rather than having settings hidden in controllers, modules, helpers, libraries, or (God forbid) in views, you can put them in one location and refer to them from there. CodeIgniter comes with its own configuration files in the <code class="literal">config</code> folder; however, you can add your own files to the <code class="literal">config</code> folder and refer to them in your code. It's pretty handy and easy to do; let's take a look.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec190"/>How to do it...</h2></div></div></div><p>We're going to create the following two files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/config_settings.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/config/my_config_file.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">config_settings.php</code> controller, open it for editing, and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Config_settings extends CI_Controller {
  function __construct() {
    parent::__construct();
<span class="strong"><strong>    $this-&gt;config-&gt;load('my_config_file');</strong></span>
  }

  public function index() {
    echo $this-&gt;config-&gt;item('first_config_item');

    for($i = 0; $i &lt; $this-&gt;config-&gt;item('stop_at'); $i++) {
      echo $i . '&lt;br /&gt;';
    }
  }
}</pre></div></li><li class="listitem">Create the config file, <code class="literal">my_config_file.php</code>, open it for editing, and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

$config['first_config_item'] = "This is my config setting, there are many like it but this one is mine&lt;br /&gt;";
$config['stop_at'] = 10;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec191"/>How it works...</h2></div></div></div><p>To be honest, there are so many situations where putting information in a config file is useful that make it pointless writing a specific recipe for you, as the chances of it being the recipe you need are slim to none. So, <a id="id612" class="indexterm"/>this is just a proof of concept; it is there for you as a guide of the basic two files: a config file and another file (a controller) to grab information from it.</p><p>Take a look at the constructor in the controller, <code class="literal">Config_settings</code>. This is where we define the name of the config file. You can call it whatever you like (as long as the name isn't already taken by another config file). Here, I've called it <code class="literal">my_config_file</code>; it's a bit 1995, but it's good enough for the explanation and I'm sure you get the idea.</p><p>The next thing to happen is that <a id="id613" class="indexterm"/>
<code class="literal">public function index()</code> is executed, which does two things: prints out a string of text (the text is set in our config file) and iterates through a <code class="literal">for()</code> loop, only stopping when it reaches the value specified in our <code class="literal">my_config_file</code>.</p><p>These two approaches show you how to work with config values: either echoing out to screen or using that value in some sort of structure.</p></div></div>
<div class="section" title="Using the language class &#x2013; switching language on the go"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec89"/>Using the language class – switching language on the go</h1></div></div></div><p>Once you have developed your <a id="id614" class="indexterm"/>site to accommodate multiple languages, you'll obviously want to allow people to switch between them. For example, to switch from English to French, or French to German, or whatever region or language you're developing for. This can be handled in several ways, but in this example, we're going to use the CodeIgniter <code class="literal">Session</code> class to swap from one language to another.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec192"/>Getting ready</h2></div></div></div><p>We're going to use the <code class="literal">Session</code> class to store the user's language preference, which means, we'll need to use CodeIgniter sessions. This will require some configuration.</p><p>We'll be editing the following files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/config/config.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/config/database.php</code></li></ul></div><p>The following are the config settings:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Find the following config values in the <code class="literal">path/to/codeigniter/application/config/config.php</code> file and amend them to reflect the following values:<div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Config Item</p>
</th><th style="text-align: left" valign="bottom">
<p>Data Type</p>
</th><th style="text-align: left" valign="bottom">
<p>Change to Value</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_cookie_name']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">String</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">ci_session</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id615" class="indexterm"/>is the name of the cookie written to the user's computer.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_expiration']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">Integer</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">7200</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the number <a id="id616" class="indexterm"/>of seconds a session should remain active, after no user activity, before becoming void.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_expire_on_close']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">Boolean (True/False)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TRUE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This specifies <a id="id617" class="indexterm"/>that if the user closes their browser the session becomes void.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_encrypt_cookie']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">Boolean (True/False)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TRUE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This specifies <a id="id618" class="indexterm"/>if the cookie should be encrypted on the user's computer. For security purposes this should be set to <code class="literal">TRUE</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_use_database']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">Boolean (True/False)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TRUE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This specifies <a id="id619" class="indexterm"/>weather or not to store sessions in the database. For security purposes this should be set to <code class="literal">TRUE</code>. You will also need to create the session table, the code for which can be found in the upcoming page.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_table_name']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">String</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">sessions</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This specifies <a id="id620" class="indexterm"/>the name of the database table used to store session data. In this recipe, I have called the sessions table simple sessions; however, you can keep the original i_sessions--just make sure you amend the SQL accordingly.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_match_ip']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">Boolean (True/False)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TRUE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This specifies <a id="id621" class="indexterm"/>whether CodeIgniter should monitor the IP address of requests <a id="id622" class="indexterm"/>and against that of the <code class="literal">session_id</code>. If the IP of an incoming request doesn't match the previous values, the session is disallowed.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_match_useragent']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">Boolean (True/False)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TRUE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This specifies <a id="id623" class="indexterm"/>whether CodeIgniter should monitor the user agent address of requests and against that of the <code class="literal">session_id</code>. If the user agent of an incoming request doesn't match the previous values, the session is disallowed. </p>
</td></tr></tbody></table></div></li><li class="listitem">Find the following config values in the <code class="literal">path/to/codeigniter/application/config/database.php</code> file and amend them to reflect the correct settings <a id="id624" class="indexterm"/>to enable you to connect to your database:<div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Config Item</p>
</th><th style="text-align: left" valign="bottom">
<p>Data Type</p>
</th><th style="text-align: left" valign="bottom">
<p>Change to Value</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$db['default']['hostname']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">String</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">localhost</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id625" class="indexterm"/>hostname of your database. This is usually either <code class="literal">localhost</code> or an IP address</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$db['default']['username']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">String</code>
</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>The <a id="id626" class="indexterm"/>username you wish to use to connect to your database</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$db['default']['password']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">String</code>
</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>The <a id="id627" class="indexterm"/>password used to connect to your database</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$db['default']['database']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">String</code>
</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>The <a id="id628" class="indexterm"/>name of the database which you wish to connect to</p>
</td></tr></tbody></table></div></li><li class="listitem">We will be storing the user's language preference in the session, and the sessions are stored in the database table, <code class="literal">sessions</code>. The following is the schema for the sessions table. Using a method of your choice (command line, <code class="literal">phpMyAdmin</code>, and so on), enter the following MySQL schema into your database:<div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `sessions` (
  `session_id` varchar(40) COLLATE utf8_bin NOT NULL DEFAULT '0',
  `ip_address` varchar(16) COLLATE utf8_bin NOT NULL DEFAULT '0',
  `user_agent` varchar(120) COLLATE utf8_bin DEFAULT NULL,
  `last_activity` int(10) unsigned NOT NULL DEFAULT '0',
  `user_data` text COLLATE utf8_bin NOT NULL,
  PRIMARY KEY (`session_id`),
  KEY `last_activity_idx` (`last_activity`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;</pre></div></li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec193"/>How to do it...</h2></div></div></div><p>We're going to create the following language file:</p><p>
<code class="literal">/path/to/codeigniter/application/language/french/fr_lang.php</code>
</p><p>...and amend the following two files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/lang.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/lang/lang.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Amend <code class="literal">/path/to/codeigniter/application/controllers/lang.php</code> to reflect the <a id="id629" class="indexterm"/>following code snippet:<div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');
class Lang extends CI_Controller {
    function __construct() {
        parent::__construct();
        $this-&gt;load-&gt;helper('form');
        $this-&gt;load-&gt;helper('url');
        $this-&gt;load-&gt;helper('language');
        $this-&gt;load-&gt;helper('security');
        
        // Check for empty language values in the session
        if ($this-&gt;session-&gt;userdata('filename') == '' || $this-&gt;session-&gt;userdata('language') == '') {
            $change_lang = array(
               'language'   =&gt; 'english',
               'filename'   =&gt; 'en',
            );

            $this-&gt;session-&gt;set_userdata($change_lang);
            $this-&gt;lang-&gt;load($this-&gt;session-&gt;userdata('filename'), $this-&gt;session-&gt;userdata('language'));
        } else { // Default language
            $this-&gt;lang-&gt;load($this-&gt;session-&gt;userdata('filename'), $this-&gt;session-&gt;userdata('language'));
        }
    }

    public function index() {
        redirect('lang/submit');
    }

    public function submit() {
        $this-&gt;load-&gt;library('form_validation');
        $this-&gt;form_validation-&gt;set_error_delimiters('', '&lt;br /&gt;');

        // Set validation rules
        $this-&gt;form_validation-&gt;set_rules('email', $this-&gt;lang-&gt;line('form_email'), 'required|min_length[1]|max_length[50]|valid_email');

        // Begin validation
        if ($this-&gt;form_validation-&gt;run() == FALSE) {
            $this-&gt;load-&gt;view('lang/lang');
        }
    }

public function change_language() {
        $lang = xss_clean($this-&gt;uri-&gt;segment(3));

        switch ($lang) {
                case "en":
                        $language = 'english';
                        $filename = 'en';

                        break;
                case "fr":
                        $language = 'french';
                        $filename = 'fr';
                        break;
                default:
                    break;
        }

        $change_lang = array(
           'language'   =&gt; $language,
           'filename'   =&gt; $filename,
        );

        $this-&gt;session-&gt;set_userdata($change_lang);

        redirect('lang/index');
    }
}</pre></div></li><li class="listitem">Amend <code class="literal">/path/to/codeigniter/application/views/lang/lang.php</code> to reflect the following <a id="id630" class="indexterm"/>code snippet:<div class="informalexample"><pre class="programlisting">&lt;html&gt;
    &lt;body&gt;

        &lt;?php echo anchor('lang/change_language/fr', 'French'); ?&gt;
        &amp;nbsp;
        &lt;?php echo anchor('lang/change_language/en', 'English'); ?&gt;

        &lt;h2&gt;&lt;?php echo $this-&gt;lang-&gt;line('form_title'); ?&gt;&lt;/h2&gt;
        &lt;?php echo form_open('lang/submit'); ?&gt;
        &lt;?php echo $this-&gt;lang-&gt;line('form_email'); ?&gt;
        &lt;?php echo form_input(array('name' =&gt; 'email', 'id' =&gt; 'email', 'value' =&gt; '', 'maxlength' =&gt; '100', 'size' =&gt; '50', 'style' =&gt; 'width:10%')); ?&gt;

        &lt;?php echo form_submit('', $this-&gt;lang-&gt;line('form_submit_button')); ?&gt;
        &lt;?php echo form_close(); ?&gt;

    &lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">Copy the following code into the <code class="literal">/path/to/codeigniter/application/system/language/french/fr_lang.php</code> file:<div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');
$lang['form_title'] = "Titre du formulaire en anglais";
$lang['form_email'] = "Votre E-Mail: ";
$lang['form_submit_button'] = "Suggérer";</pre></div></li><li class="listitem">Finally, add the following code <a id="id631" class="indexterm"/>into the <code class="literal">/path/to/codeigniter/application/system/language/engligh/en_lang.php</code> file:<div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');
$lang['form_title'] = "Form title in English";
$lang['form_email'] = "Email: ";
$lang['form_submit_button'] = "Submit";</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec194"/>How it works...</h2></div></div></div><p>This is an extension of the earlier language recipe. The only thing we're doing different is adding support for switching values in <code class="literal">$this-&gt;lang-&gt;load('', '');</code>. We're using CodeIgniter's session functionality to store the switched values. Thus, as we're passing the required language as a value in the URL, we'll want to use the CodeIgniter security method, <code class="literal">xss_clean()</code>, <a id="id632" class="indexterm"/>to mitigate against cross-site scripting.</p><p>So, in the constructor, we have the following code:</p><div class="informalexample"><pre class="programlisting">// Check for empty language values in the session
if ($this-&gt;session-&gt;userdata('filename') == '' || $this-&gt;session-&gt;userdata('language') == '') {
     $change_lang = array(
     'language'   =&gt; 'english',
     'filename'   =&gt; 'en',
     );

    $this-&gt;session-&gt;set_userdata($change_lang);
    $this-&gt;lang-&gt;load($this-&gt;session-&gt;userdata('filename'), $this-&gt;session-&gt;userdata('language'));
} else { // Default language
    $this-&gt;lang-&gt;load($this-&gt;session-&gt;userdata('filename'), $this-&gt;session-&gt;userdata('language')); 
}</pre></div><p>This will look to see whether there are any language <a id="id633" class="indexterm"/>variables set in a session. If there are not, we define the language in the <code class="literal">$change_lang</code> array and pass it to the <code class="literal">$this-&gt;lang-&gt;load('', '');</code> function, as follows:</p><div class="informalexample"><pre class="programlisting">$this-&gt;lang-&gt;load($this-&gt;session-&gt;userdata('filename'), $this-&gt;session-&gt;userdata('language'));</pre></div><p>From there, <code class="literal">public function index()</code> is loaded and immediately redirects to <code class="literal">public function submit()</code>, which <a id="id634" class="indexterm"/>displays the HTML form.</p><p>We've amended the HTML form, adding the following two anchor tags:</p><div class="informalexample"><pre class="programlisting">&lt;?php echo anchor('lang/change_language/fr', 'French'); ?&gt;
&amp;nbsp;
&lt;?php echo anchor('lang/change_language/en', 'English'); ?&gt;</pre></div><p>If a user clicks on either one of these links (French or English) in their browser, <code class="literal">public function change_language()</code> is run. We then grab and sanitize the third parameter of the URL with <code class="literal">$lang = xss_clean($this-&gt;uri-&gt;segment(3));</code> and pass it through a PHP Switch/Case statement, looking for either <code class="literal">en</code> or <code class="literal">fr</code>, assigning the <code class="literal">$language</code> and <code class="literal">$filename</code> variables as we go with the correct details (the default loads English).</p><p>Next, we load the <code class="literal">$language</code> and <code class="literal">$filename</code> variables into the <code class="literal">$change_lang</code> array and write to the session with <code class="literal">$this-&gt;session-&gt;set_userdata($change_lang);</code>. We finish by redirecting back to <code class="literal">public function index()</code>, which will send us back to the beginning with a new language loaded.</p></div></div></body></html>