<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;The Backoffice Module (Part 2)"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. The Backoffice Module (Part 2)</h1></div></div></div><p>In this chapter, we will develop the remaining sections of the Backoffice module so that we can get a fully functional administration area. This chapter covers the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">User CRUD</li><li class="listitem" style="list-style-type: disc">Article CRUD</li></ul></div><div class="section" title="User CRUD"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec50"/>User CRUD</h1></div></div></div><p>We have already<a id="id514" class="indexterm"/> developed part of the code needed for this function, but we will rewrite part of it because, in the meantime, we have made changes to the database that will affect the functionality of our application. What we are going to develop next is similar to the previous CRUD sections. Let's start with the API controller.</p><div class="section" title="Creating the controller (API)"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec70"/>Creating the controller (API)</h2></div></div></div><p>As we did <a id="id515" class="indexterm"/>in <a class="link" href="ch07.html" title="Chapter 7. The Backoffice Module (Part 1)">Chapter 7</a>, <span class="emphasis"><em>The Backoffice Module (Part 1)</em></span>, with hashtag and category, we will need to create a controller for the user. Create a new file in <code class="literal">modules/Api/Controller/</code> and name it <code class="literal">UsersController.php</code>. Then, write the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Api\Controllers;

class UsersController extends BaseController{
  public function updateAction($id) {
    try {
      $manager = $this-&gt;getDI()-&gt;get('core_user_manager');

      if ($this-&gt;request-&gt;getHeader('CONTENT_TYPE') == 'application/json') {
        $data = $this-&gt;request-&gt;getJsonRawBody(true);
      } else {
        $data = $this-&gt;request-&gt;getPut();
      }

      if (count($data) == 0) {
        throw new \Exception('Please provide data', 400);
      }

      $st_data = array_merge($data, ['id' =&gt; $id]);
      $result  = $manager-&gt;restUpdate($st_data);

      return $this-&gt;render($result);
    } catch (\Exception $e) {
      return $this-&gt;render([
        'code' =&gt; $e-&gt;getCode(),
        'message' =&gt; $e-&gt;getMessage(),
      ], $e-&gt;getCode());
    }
  }

  public function createAction() {
    try {
      $manager   = $this-&gt;getDI()-&gt;get('core_user_manager');

      if ($this-&gt;request-&gt;getHeader('CONTENT_TYPE') == 'application/json') {
        $data = $this-&gt;request-&gt;getJsonRawBody(true);
      } else {
        $data = $this-&gt;request-&gt;getPost();
      }

      if (count($data) == 0) {
        throw new \Exception('Please provide data', 400);
      }

      $st_output = $manager-&gt;restCreate($data);

      return $this-&gt;render($st_output);
    } catch (\Exception $e) {
      return $this-&gt;render([
        'code' =&gt; $e-&gt;getCode(),
        'message' =&gt; $e-&gt;getMessage(),
      ], 500);
    }
  }
}</pre></div><p>As you can see, there are not many differences between this controller and the other controllers except for the parameters' binding. We have omitted the <code class="literal">list()</code>, <code class="literal">get()</code>, and <code class="literal">delete()</code> methods, but you can find them in the source code for this chapter.</p><p>We will now<a id="id516" class="indexterm"/> move on to the creation of the controller in <code class="literal">Backoffice</code>.</p></div><div class="section" title="The user controller from the Backoffice module"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec71"/>The user controller from the Backoffice module</h2></div></div></div><p>Create a new<a id="id517" class="indexterm"/> file in <code class="literal">modules/Backoffice/Controller/</code> and name it <code class="literal">UserController.php</code>. Then, write the following code in it:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Backoffice\Controllers;

class UserController extends BaseController{
  public function createAction() {
    if (!$this-&gt;request-&gt;isPost()) {
      return $this-&gt;response-&gt;redirect('user/list');
    }

    $manager = $this-&gt;getDI()-&gt;get('core_user_manager');
    $form    = $manager-&gt;getForm();

    if ($form-&gt;isValid($this-&gt;request-&gt;getPost())) {
      try {
        $manager   = $this-&gt;getDI()-&gt;get('core_user_manager');
        $post_data = $this-&gt;request-&gt;getPost();

        $manager-&gt;create($post_data);
        $this-&gt;flashSession-&gt;success('Object was created successfully');

        return $this-&gt;response-&gt;redirect('user/list');
      } catch (\Exception $e) {
        $this-&gt;flash-&gt;error($e-&gt;getMessage());

        return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'add']);
      }
    } else {
      foreach ($form-&gt;getMessages() as $message) {
        $this-&gt;flash-&gt;error($message-&gt;getMessage());
      }

      return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'add', 'controller' =&gt; 'user']);
    }
  }

  public function updateAction() {
    if (!$this-&gt;request-&gt;isPost()) {
      return $this-&gt;response-&gt;redirect('user/list');
    }

    $manager    = $this-&gt;getDI()-&gt;get('core_user_manager');
    $object_id  = $this-&gt;persistent-&gt;get('id');
    $object     = $manager-&gt;findFirstById($object_id);
    $form       = $manager-&gt;getForm($object);

    if ($form-&gt;isValid($this-&gt;request-&gt;getPost())) {
      try {
        $manager = $this-&gt;getDI()-&gt;get('core_user_manager');
        $manager-&gt;update(array_merge($this-&gt;request-&gt;getPost(), ['id' =&gt; $object_id]));
        $this-&gt;flashSession-&gt;success('Object was updated successfully');

        return $this-&gt;response-&gt;redirect('user/list');
      } catch (\Exception $e) {
        $this-&gt;flash-&gt;error($e-&gt;getMessage());

        return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'edit']);
      }
    } else {
      foreach ($form-&gt;getMessages() as $message) {
        $this-&gt;flash-&gt;error($message-&gt;getMessage());
      }

      return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'edit', 'controller' =&gt; 'user']);
    }
  }
}</pre></div><p>The methods that <a id="id518" class="indexterm"/>require more attention are <code class="literal">updateAction()</code> and <code class="literal">createAction()</code>, where we validate a user form and assign the data to the right action within the manager.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note22"/>Note</h3><p>The <code class="literal">addAction()</code>, <code class="literal">deleteAction()</code>, and <code class="literal">listAction()</code> methods have been intentionally left out, but you can find them in the source code of this chapter.</p></div></div></div><div class="section" title="The user form"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec72"/>The user form</h2></div></div></div><p>You have <a id="id519" class="indexterm"/>already learned how and why we use forms. We will create a form that will help us render and validate the data required for user creation. Create a new file in <code class="literal">modules/Core/Forms/</code> and name it <code class="literal">UserForm.php</code>. Then, write the following code in it:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Forms;

use Phalcon\Forms\Form;
use Phalcon\Forms\Element\Text;
use Phalcon\Forms\Element\Password;
use Phalcon\Forms\Element\Submit;
use Phalcon\Forms\Element\Select;
use Phalcon\Forms\Element\Hidden;
use Phalcon\Validation\Validator\PresenceOf;
use Phalcon\Validation\Validator\Email;
use Phalcon\Validation\Validator\StringLength;
use Phalcon\Validation\Validator\Identical;

use App\Core\Models\AclRoles;

class UserForm extends Form {
  private $edit;

  public function initialize($entity = null, $options = null) {
    if (isset($options['edit']) &amp;&amp; $options['edit'] === true) {
      $this-&gt;edit = true;
    }

    // First name
    $user_first_name = new Text('user_first_name', array(
      'placeholder' =&gt; 'First name',
    ));

    $user_first_name-&gt;addValidators(array(
      new PresenceOf(array(
        'message' =&gt; 'First name is required',
      ))
    ));

    $this-&gt;add($user_first_name);

    // Last name
    $user_last_name = new Text('user_last_name', array(
      'placeholder' =&gt; 'Last name',
    ));

    $user_last_name-&gt;addValidators(array(
      new PresenceOf(array(
        'message' =&gt; 'Last name is required',
      ))
    ));

    $this-&gt;add($user_last_name);

    // Email
    $user_email = new Text('user_email', array(
      'placeholder' =&gt; 'Email',
    ));

    $user_email-&gt;addValidators(array(
      new PresenceOf(array(
        'message' =&gt; 'The e-mail is required',
      )),
      new Email(array(
        'message' =&gt; 'The e-mail is not valid',
      )),
    ));

    $this-&gt;add($user_email);

    //Password
    $user_password = new Password('user_password', array(
      'placeholder' =&gt; 'Password',
    ));

    $user_password-&gt;addValidators(array(
      new PresenceOf(array(
        'message' =&gt; 'Password is required'
      )),
      new StringLength(array(
        'min' =&gt; 8,
        'messageMinimum' =&gt; 'Password is too short. Minimum 8 characters'
      ))
    ));

    $this-&gt;add($user_password);

    // User is active
    $this-&gt;add(new Select('user_is_active', array(
      1 =&gt; 'Yes',
      0 =&gt; 'No'
    )));

    // User location
    $user_profile_location = new Text('user_profile_location', array(
      'placeholder' =&gt; 'Location',
    ));

    if (true === $this-&gt;edit) {
      $user_profile_location-&gt;setDefault($entity-&gt;profile-&gt;getUserProfileLocation());
    }

    $this-&gt;add($user_profile_location);

    // User role
    $user_acl_role = new Select('user_acl_role', AclRoles::find(), array(
      'using' =&gt; array('name', 'name')
    ));

    $this-&gt;add($user_acl_role);

    //CSRF
    $csrf = new Hidden('csrf');

    $csrf-&gt;addValidator(
      new Identical(array(
        'value' =&gt; $this-&gt;security-&gt;getSessionToken(),
        'message' =&gt; 'CSRF validation failed',
      ))
    );

    $this-&gt;add($csrf);

    $this-&gt;add(new Submit('save', array(
      'class' =&gt; 'btn btn-lg btn-primary btn-block',
    )));
  }
}</pre></div><p>In this form, you<a id="id520" class="indexterm"/> may notice a few new things:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We use <code class="literal">Phalcon\Validation\Validator\StringLength</code> to validate the length of the password.</li><li class="listitem" style="list-style-type: disc">We use a new form element, <code class="literal">Phalcon\Forms\Element\Select</code>, to generate the <code class="literal">select</code> form elements.</li><li class="listitem" style="list-style-type: disc">We use <code class="literal">Phalcon\Validation\Validator\Email</code> to validate the e-mail address field.</li><li class="listitem" style="list-style-type: disc">We assign the results of <code class="literal">App\Core\Models\AclRoles</code> as the second parameter of the <code class="literal">select</code> element, <code class="literal">user_acl_role</code>. The second parameter for this field is an array that instructs <code class="literal">Phalcon\Forms\Element\Select</code> to use the field's name when generating the HTML code. Normally, we would use the field's ID and name, or something similar. But in this particular case, the <code class="literal">acl_roles</code> table does not have an ID.</li></ul></div></div><div class="section" title="The user manager"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec73"/>The user manager</h2></div></div></div><p>You might already have part of<a id="id521" class="indexterm"/> the user manager, or perhaps you have created it in its entirety. Just in case you didn't, create it now. Create a new file in <code class="literal">modules/Core/Managers/</code> and name it <code class="literal">UserManager.php</code>. Then, write the following code in it:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Managers;

use App\Core\Models\User;
use App\Core\Models\UserRole;
use App\Core\Models\AclRoles;
use App\Core\Models\UserProfile;

use App\Core\Forms\UserForm;

class UserManager extends BaseManager{
  public function getForm($entity = null, $options = null) {
    return new UserForm($entity, $options);
  }

  public function create($data, $user_role = 'Guest') {
    $security = $this-&gt;getDI()-&gt;get('security');

    if (isset($data['user_acl_role'])) {
      $user_role = $data['user_acl_role'];
    }

    $user = new User();
    $user-&gt;setUserFirstName($data['user_first_name']);
    $user-&gt;setUserLastName($data['user_last_name']);
    $user-&gt;setUserEmail($data['user_email']);
    $user-&gt;setUserPassword($security-&gt;hash($data['user_password']));
    $user-&gt;setUserIsActive($data['user_is_active']);

    $o_acl_role  = AclRoles::findFirstByName($user_role);

    if (!$o_acl_role) {
      throw new \Exception("Role $user_role does not exists");
    };

    $o_user_role[0] = new UserRole();
    $o_user_role[0]-&gt;setUserRole($user_role);

    $user-&gt;roles = $o_user_role;

    $profile = new UserProfile();
    $profile-&gt;setUserProfileLocation($data['user_profile_location']);

    $user-&gt;profile = $profile;

    return $this-&gt;save($user, 'create');
  }
}</pre></div><p>The <code class="literal">create()</code> method <a id="id522" class="indexterm"/>requires two parameters. The first parameter, <code class="literal">$data</code>, is an array with the values needed to create our new object. The second parameter is <code class="literal">$user_role</code>, with a default value. Going further, we check whether the <code class="literal">$data</code> array has a key named <code class="literal">user_acl_role</code>. If the key exists, we overwrite the default value of the <code class="literal">$user_role</code> parameter. Finally, we assign values to each of the <code class="literal">$user</code> objects and save them:</p><div class="informalexample"><pre class="programlisting">public function update(array $data) {
  $object = User::findFirstById($data['id']);

  if (!$object) {
    throw new \Exception('Object not found');
  }

  $security = $this-&gt;getDI()-&gt;get('security');

  $object-&gt;setUserFirstName($data['user_first_name']);
  $object-&gt;setUserLastName($data['user_last_name']);
  $object-&gt;setUserEmail($data['user_email']);
  $object-&gt;setUserPassword($security-&gt;hash($data['user_password']));
  $object-&gt;setUserIsActive($data['user_is_active']);

  $o_acl_role  = AclRoles::findFirstByName($data['user_acl_role']);

  if (!$o_acl_role) {
    throw new \Exception("Role $user_role does not exists");
  };

  $o_user_role[0] = new UserRole();
  $o_user_role[0]-&gt;setUserRole($data['user_acl_role']);

  $object-&gt;roles = $o_user_role;

  $object-&gt;profile-&gt;setUserProfileLocation($data['user_profile_location']);

  return $this-&gt;save($object, 'update');
}</pre></div><p>The <code class="literal">update()</code> method is <a id="id523" class="indexterm"/>similar to the <code class="literal">create()</code> method, except that we first check whether the object that we want to update exists. The <code class="literal">delete()</code> method, shown as follows, will simply search for an object by ID; if the object exists, we delete it:</p><div class="informalexample"><pre class="programlisting">public function delete($id) {
  $object = User::findFirstById($id);

  if (!$object) {
    throw new \Exception('Object not found');
  }

  if (false === $object-&gt;delete()) {
    foreach ($object-&gt;getMessages() as $message) {
      $error[] = (string) $message;
    }

    throw new \Exception(json_encode($error));
  }
  return true;
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note23"/>Note</h3><p>Again, the <code class="literal">find()</code>, <code class="literal">findFirstById()</code>, and <code class="literal">findFirst()</code> methods have been intentionally left out, but you can find them in the source code of this chapter.</p></div></div><p>Let's pay attention<a id="id524" class="indexterm"/> to the <code class="literal">create()</code> and <code class="literal">update()</code> methods and how we store the relations of the profiles and roles. Because the relation between the user and the roles is <span class="emphasis"><em>1 - N</em></span>, to store the values correctly, we use array notation for the <code class="literal">$o_user_role</code> variable. Otherwise, saving will fail. For the password, we make use of Phalcon's built-in security module, and we encrypt it by using the <code class="literal">$security-&gt;hash()</code> method.</p></div></div></div>
<div class="section" title="User templates"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec51"/>User templates</h1></div></div></div><p>The final step is to create <a id="id525" class="indexterm"/>the templates. Switch to <code class="literal">modules/Backoffice/Views/Default</code> and create a new directory named <code class="literal">user</code>. In this new directory, create the four needed files: <code class="literal">add.volt</code>, <code class="literal">delete.volt</code>, <code class="literal">edit.volt</code>, and <code class="literal">list.volt</code>. There is nothing new to explain about these templates, so we are just going to write the code for them.</p><p>The code for <code class="literal">add.volt</code> is as follows<code class="literal">:</code></p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
&lt;h1&gt;Add&lt;/h1&gt;
&lt;hr&gt;
&lt;div class="panel panel-default"&gt;
  &lt;div class="panel-body"&gt;
    &lt;form method="post" action="{{ url('user/create') }}"&gt;
      &lt;h4&gt;User details&lt;/h4&gt;
      &lt;hr&gt;
        &lt;div class="form-group"&gt;
          &lt;label for="user_first_name"&gt;First name&lt;/label&gt;
            {{ form.render('user_first_name', {'class':'form-control'}) }}
        &lt;/div&gt;
        &lt;div class="form-group"&gt;
          &lt;label for="user_last_name"&gt;Last name&lt;/label&gt;
            {{ form.render('user_last_name', {'class':'form-control'}) }}
        &lt;/div&gt;
        &lt;div class="form-group"&gt;
          &lt;label for="user_email"&gt;Email&lt;/label&gt;
            {{ form.render('user_email', {'class':'form-control'}) }}
        &lt;/div&gt;
        &lt;div class="form-group"&gt;
          &lt;label for="user_password"&gt;Password&lt;/label&gt;
            {{ form.render('user_password', {'class':'form-control'}) }}
        &lt;/div&gt;
        &lt;div class="form-group"&gt;
          &lt;label for="user_is_active"&gt;Is active&lt;/label&gt;
            {{ form.render('user_is_active', {'class':'form-control'}) }}
        &lt;/div&gt;
        &lt;h4&gt;User profile&lt;/h4&gt;
        &lt;hr&gt;
        &lt;div class="form-group"&gt;
          &lt;label for="user_profile_location"&gt;Location&lt;/label&gt;
            {{ form.render('user_profile_location', {'class':'form-control'}) }}
        &lt;/div&gt;
        &lt;h4&gt;User role&lt;/h4&gt;
        &lt;hr&gt;
        &lt;div class="form-group"&gt;
          &lt;label for="user_acl_role"&gt;Role&lt;/label&gt;
            {{ form.render('user_acl_role', {'class':'form-control'}) }}
          &lt;/div&gt;
        {{ form.render('save', {'value':'Save'}) }}
      {{ form.render('csrf', {'value':security.getToken()}) }}
    &lt;/form&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% endblock %}</pre></div><p>Here is the <a id="id526" class="indexterm"/>code for <code class="literal">delete.volt</code>:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
&lt;h1&gt;Confirm deletion&lt;/h1&gt;
&lt;h3&gt;Are you sure you want to delete the selected element?&lt;/3&gt;
&lt;hr&gt;
&lt;div class="panel panel-default"&gt;
  &lt;div class="panel-body"&gt;
    &lt;form method="post" action="{{ url('user/delete/' ~ id) }}" class="form-inline"&gt;
      &lt;input type="submit" value="Yes, delete" class="btn btn-sm btn-danger btn-block"&gt;
          &lt;a href="{{ url('user/list') }}" class="btn btn-lg btn-default btn-block"&gt;Cancel&lt;/a&gt;
        &lt;/form&gt;
    &lt;/div&gt;
&lt;/div&gt;
{% endblock %}</pre></div><p>The <code class="literal">edit.volt</code> file<a id="id527" class="indexterm"/> is nearly the same as <code class="literal">add.volt</code>. Just replace the <code class="literal">form</code> action and point it to <code class="literal">user/update</code>:</p><div class="informalexample"><pre class="programlisting">&lt;form method="post" action="{{ url('user/update') }}"&gt;</pre></div><p>The code for <code class="literal">list.volt</code> is as follows:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
&lt;div class="pull-left"&gt;
  &lt;h1&gt;Users&lt;/h1&gt;
&lt;/div&gt;
&lt;div class="pull-right"&gt;
  &lt;a class="btn btn-success" href="{{ url('user/add') }}" aria-label="Left Align"&gt;
    &lt;span class="glyphicon glyphicon-plus" aria-hidden="true"&gt;&lt;/span&gt; New
  &lt;/a&gt;
&lt;/div&gt;
&lt;div class="clearfix"&gt;&lt;/div&gt;
&lt;hr&gt;
&lt;div class="panel panel-default"&gt;
  &lt;div class="panel-body"&gt;
    &lt;table class="table table-striped"&gt;
      &lt;thead&gt;
      &lt;tr&gt;
        &lt;th&gt;#&lt;/th&gt;
        &lt;th&gt;Name&lt;/th&gt;
        &lt;th&gt;Email&lt;/th&gt;
        &lt;th&gt;Location&lt;/th&gt;
        &lt;th&gt;Created at&lt;/th&gt;
        &lt;th&gt;Options&lt;/th&gt;
      &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody&gt;
        {% for record in records['items'] %}
          &lt;tr&gt;
            &lt;th scope="row"&gt;{{ record['id'] }}&lt;/th&gt;
              &lt;td&gt;{{ record['user_first_name'] }} {{ record['user_last_name'] }}&lt;/td&gt;
              &lt;td&gt;{{ record['user_email'] }}&lt;/td&gt;
              &lt;td&gt;{{ record['user_profile']['user_profile_location'] }}&lt;/td&gt;
              &lt;td&gt;{{ record['user_created_at'] }}&lt;/td&gt;
              &lt;td&gt;
                &lt;a class="btn btn-default btn-xs" href="{{ url('user/edit/' ~ record['id']) }}" aria-label="Left Align"&gt;
                &lt;span class="glyphicon glyphicon-pencil" aria-hidden="true"&gt;
                &lt;/span&gt;
              &lt;/a&gt;
              &lt;a class="btn btn-danger btn-xs" href="{{ url('user/delete/' ~ record['id']) }}" aria-label="Left Align"&gt;
                &lt;span class="glyphicon glyphicon-trash" aria-hidden="true"&gt;&lt;/span&gt;
              &lt;/a&gt;
            &lt;/td&gt;
          &lt;/tr&gt;
            {% else %}
          &lt;tr&gt;
              &lt;td colspan="4"&gt;There are no records in your database&lt;/td&gt;
          &lt;/tr&gt;
        {% endfor %}
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% if (records['total_pages'] &gt; 1) %}
{% include 'common/paginator' with {'page_url' : url('user/list'), 'stack' : records} %}
{% endif %}
{% endblock %}</pre></div><p>And we are done with User<a id="id528" class="indexterm"/> CRUD! You should be able to access the <code class="literal">Users</code> section in Backoffice (<code class="literal">http://www.learning-phalcon.localhost/backoffice/user/list</code>) and see a list of existing users. Now that we have enabled CRUD for all the sections that are required for adding an article, we will continue with the last part of this chapter—Article CRUD.</p></div>
<div class="section" title="Article CRUD"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec52"/>Article CRUD</h1></div></div></div><p>We partially wrote some code <a id="id529" class="indexterm"/>for this part. It is probably working for you, but you will be changing mostly everything in it. The API controller has already been developed, so we can move directly on to <code class="literal">ArticleManager</code> to refactor it.</p><div class="section" title="The Controller (API)"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec74"/>The Controller (API)</h2></div></div></div><p>The code for<a id="id530" class="indexterm"/> this controller is similar to that of the rest of the controllers. Let's see what it looks like. Open the file located at <code class="literal">modules/Api/Controllers/ArticlesController.php</code>, clear its content, and write the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Api\Controllers;

class ArticlesController extends BaseController{
  public function updateAction($id) {
    try {
      $manager = $this-&gt;getDI()-&gt;get('core_article_manager');

      if ($this-&gt;request-&gt;getHeader('CONTENT_TYPE') == '       application/json') {
        $data = $this-&gt;request-&gt;getJsonRawBody(true);
      } else {
        $data = $this-&gt;request-&gt;getPut();
      }

      if (count($data) == 0) {
        throw new \Exception('Please provide data', 400);
      }

      $st_inputData = array(
        'article_user_id' =&gt; $data['article_user_id'],
        'article_is_published' =&gt; $data['article_is_published'],
        'translations' =&gt; [
          $data['article_translation_lang'] =&gt; [
            'article_translation_short_title' =&gt;
                $data['article_translation_short_title'],
            'article_translation_long_title' =&gt;
                $data['article_translation_long_title'],
            'article_translation_description' =&gt;
                $data['article_translation_description'],
            'article_translation_slug' =&gt; $data[
                'article_translation_slug'],
            'article_translation_lang' =&gt; $data[
                'article_translation_lang'],
          ],
        ],
        'categories' =&gt; $data['categories'],
        'hashtags' =&gt; $data['hashtags']
      );

      $result = $manager-&gt;restUpdate(array_merge(
        $st_inputData, ['id' =&gt; $id]));

      return $this-&gt;render($result);
    } catch (\Exception $e) {
      return $this-&gt;render([
        'code' =&gt; $e-&gt;getCode(),
        'message' =&gt; $e-&gt;getMessage(),
      ], $e-&gt;getCode());
    }
 }

  public function createAction() {
    try {
      $manager   = $this-&gt;getDI()-&gt;get('core_article_manager');

      if ($this-&gt;request-&gt;getHeader('CONTENT_TYPE') ==
        'application/json') {
        $data = $this-&gt;request-&gt;getJsonRawBody(true);
      } else {
        $data = $this-&gt;request-&gt;getPost();
      }
      if (count($data) == 0) {
        throw new \Exception('Please provide data', 400);
      }

      $st_inputData = array(
        'article_user_id' =&gt; $data['article_user_id'],
        'article_is_published' =&gt; $data['article_is_published'],
        'translations' =&gt; [
          $data['article_translation_lang'] =&gt; [
            'article_translation_short_title' =&gt; 
              $data['article_translation_short_title'],
            'article_translation_long_title' =&gt;
              $data['article_translation_long_title'],
            'article_translation_description' =&gt;
              $data['article_translation_description'],
            'article_translation_slug' =&gt;
              $data['article_translation_slug'],
            'article_translation_lang' =&gt;
              $data['article_translation_lang'],
          ],
        ],
        'categories' =&gt; $data['categories'],
        'hashtags' =&gt; $data['hashtags']
      );

      $st_output = $manager-&gt;restCreate($st_inputData);

      return $this-&gt;render($st_output);
    } catch (\Exception $e) {
      return $this-&gt;render([
        'code' =&gt; $e-&gt;getCode(),
        'message' =&gt; $e-&gt;getMessage(),
      ], $e-&gt;getCode());
    }
  }
}</pre></div><p>The only important <a id="id531" class="indexterm"/>thing to pay attention to in this controller is the data structure that we expect for <code class="literal">createAction()</code> and <code class="literal">updateAction()</code>. Let's continue with the next controller.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note24"/>Note</h3><p>The <code class="literal">addAction()</code>, <code class="literal">deleteAction()</code>, and <code class="literal">listAction()</code> methods have been intentionally left out, but you can find them in the source code of this chapter.</p></div></div></div><div class="section" title="The Article controller from the Backoffice module"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec75"/>The Article controller from the Backoffice module</h2></div></div></div><p>Switch to<a id="id532" class="indexterm"/> the <code class="literal">modules/Backoffice/Controllers/</code> folder, create a new file named <code class="literal">ArticleController.php</code>, and write the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Backoffice\Controllers;

class ArticleController extends BaseController {
  public function createAction() {
    if (!$this - &gt; request - &gt; isPost()) {
      return $this - &gt; response - &gt; redirect('article/list');
    }
    $manager = $this - &gt; getDI() - &gt; get('core_article_manager');
    $form = $manager - &gt; getForm();
    if ($form - &gt; isValid($this - &gt; request - &gt; getPost())) {
      try {
        $manager = $this - &gt; getDI() - &gt; get('core_article_manager');
        $post_data = $this - &gt; request - &gt; getPost();
        $data = array_merge($post_data,
          ['article_user_id ' =&gt; $this-&gt;auth-&gt;getUserId()]);

      $manager - &gt; create($data);
      $this - &gt; flashSession - &gt; success('Object was created 
        successfully ');
        return $this - &gt; response - &gt; redirect('article/list');
      } catch (\Exception $e) {
        $this - &gt; flash - &gt; error($e - &gt; getMessage());
        return $this - &gt; dispatcher - &gt; forward(['action' =&gt;
          'add'
        ]);
      }
    } else {
      foreach($form - &gt; getMessages() as $message) {
        $this - &gt; flash - &gt; error($message - &gt; getMessage());
      }
      return $this - &gt; dispatcher - &gt; forward(['action' =&gt; 'add',
        'controller' =&gt; 'article'
      ]);
    }
  }
  public function updateAction() {
    if (!$this - &gt; request - &gt; isPost()) {
      return $this - &gt; response - &gt; redirect('article/list');
    }
    $manager = $this - &gt; getDI() - &gt; get('core_article_manager');
    $object_id = $this - &gt; persistent - &gt; get('id');
    $object = $manager - &gt; findFirstById($object_id);
    $form = $manager - &gt; getForm($object);
    if ($form - &gt; isValid($this - &gt; request - &gt; getPost())) {
      try {
        $manager = $this - &gt; getDI() - &gt; get('core_article_manager ');
        $post_data = $this - &gt; request - &gt; getPost();
        $data = array_merge(
          $post_data, ['article_user_id' =&gt; $this - &gt; auth - &gt; getUserId(), 'id' =&gt; $object_id]);
        $manager - &gt; update($data);
        $this - &gt; flashSession - &gt; success('Object was updated successfully ');

        return $this - &gt; response - &gt; redirect('article/list');
      } catch (\Exception $e) {
        $this - &gt; flash - &gt; error($e - &gt; getMessage());
        return $this - &gt; dispatcher - &gt; forward(['action' =&gt;
          'edit'
        ]);
      }
    } else {
      foreach($form - &gt; getMessages() as $message) {
        $this - &gt; flash - &gt; error($message - &gt; getMessage());
      }
      return $this - &gt; dispatcher - &gt; forward(['action' =&gt; 'edit',
        'controller' =&gt; 'category'
      ]);
    }
  }
}</pre></div><p>Take a <a id="id533" class="indexterm"/>look at <code class="literal">createAction()</code> and <code class="literal">updateAction()</code>. Here, we use the ID of the authenticated user when we set the value for the <code class="literal">article_user_id</code> field.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note25"/>Note</h3><p>Again, methods such as <code class="literal">addAction()</code>, <code class="literal">deleteAction()</code>, and <code class="literal">listAction()</code> have been intentionally left out, but you can find them in the source code of this chapter.</p></div></div></div><div class="section" title="The Article form"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec76"/>The Article form</h2></div></div></div><p>This form is<a id="id534" class="indexterm"/> similar to the one for categories. Let's see what it looks like. Create a new file named <code class="literal">ArticleForm.php</code> in the <code class="literal">modules/Core/Forms</code> directory, and write this code in it:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Forms;

use Phalcon\Forms\Form;
use Phalcon\Forms\Element\Text;
use Phalcon\Forms\Element\TextArea;
use Phalcon\Forms\Element\Select;
use Phalcon\Forms\Element\Submit;
use Phalcon\Forms\Element\Hidden;
use Phalcon\Validation\Validator\Identical;

use App\Core\Models\CategoryTranslation;
use App\Core\Models\Hashtag;

class ArticleForm extends Form {
  private $edit = false;
  public function initialize($entity = null, $options = null) {
    if (isset($options['edit']) &amp;&amp; $options['edit'] === true) {
      $this-&gt;edit = true;
    }
    $locales = $this-&gt;getDI()-&gt;get('config')-&gt;i18n-&gt;locales-&gt;
        toArray();
    foreach ($locales as $locale =&gt; $name) {
      if (true === $this-&gt;edit) {
        $translations = $entity-&gt;getTranslations([
            "article_translation_lang = '$locale'"])-&gt;toArray();
      }
      $article_translation_short_title[$locale] = new Text 
      ("translations[$locale][article_translation_short_title]", [
        'value' =&gt; $this-&gt;edit === true ? $translations[0]
        ['article_translation_short_title'] : null
      ]);
      $article_translation_long_title[$locale] = new Text 
      ("translations[$locale][article_translation_long_title]", [
        'value' =&gt; $this-&gt;edit === true ? $translations[0]
        ['article_translation_long_title'] : null
      ]);
      $article_translation_description[$locale] = new TextArea 
      ("translations[$locale][article_translation_description]", [
        'value' =&gt; $this-&gt;edit === true ? $translations[0]
        ['article_translation_description'] : null
      ]);
      $article_translation_slug[$locale] = new Text ( 
        "translations[$locale][article_translation_slug]", [
        'value' =&gt; $this-&gt;edit === true ? $translations[0]
        ['article_translation_slug'] : null
      ]);
      $article_translation_lang[$locale] = new Hidden ( 
        "translations[$locale][article_translation_lang]", [
        'value' =&gt; $locale
      ]);
      $this-&gt;add( $article_translation_short_title[$locale] );
      $this-&gt;add( $article_translation_long_title[$locale] );
      $this-&gt;add( $article_translation_description[$locale] );
      $this-&gt;add( $article_translation_slug[$locale] );
      $this-&gt;add( $article_translation_lang[$locale] );
    }
    // Categories
    $categories = new Select('categories[]',
      CategoryTranslation::find([
          "category_translation_lang = 'en'"]), [
          'using' =&gt; [
            'category_translation_category_id',
            'category_translation_name'
          ],
          'multiple' =&gt; true
        ]);
        if ($this-&gt;edit === true) {
          $categories_defaults = array();
          foreach ($entity-&gt;getCategories(["columns" =&gt;
              ["id"]]) as $category) {
            $categories_defaults[] = $category-&gt;id;
        }
        $categories-&gt;setDefault($categories_defaults);
      }
      $this-&gt;add($categories);
      // Hash tags
      $hashtags = new Select('hashtags[]', Hashtag::find(), [
        'using' =&gt; ['id', 'hashtag_name'],
        'multiple' =&gt; true
      ]);
      if ($this-&gt;edit === true) {
        $hashtags_defaults = array();
        foreach ($entity-&gt;getHashtags(["columns" =&gt;
            ["id"]]) as $hashtag) {
          $hashtags_defaults[] = $hashtag-&gt;id;
        }
        $hashtags-&gt;setDefault($hashtags_defaults);
      }
      $this-&gt;add($hashtags);
      // Is published
      $this-&gt;add(new Select('article_is_published', array(
          1 =&gt; 'Yes',
          0 =&gt; 'No'
      )));
      //CSRF
      $csrf = new Hidden('csrf');
      $csrf-&gt;addValidator(
        new Identical(array(
          'value' =&gt; $this-&gt;security-&gt;getSessionToken(),
          'message' =&gt; 'CSRF validation failed',
        ))
      );
      $this-&gt;add($csrf);
      $this-&gt;add(new Submit('save', array(
      'class' =&gt; 'btn btn-lg btn-primary btn-block',
    )));
  }
}</pre></div><p>We manage the Article<a id="id535" class="indexterm"/> translation in the same way as we did for categories. As for the article hashtags and article categories, when we edit a record, we must somehow retrieve the existing ones and assign them as defaults in the form.</p><p>We have created the controllers, managers, and forms. What we need now are the templates. Switch to <code class="literal">modules/Backoffice/Views/Default/article/</code> and create the three missing files: <code class="literal">add.volt</code>, <code class="literal">delete.volt</code>, and <code class="literal">edit.volt</code>. Here is the code for each of them.</p><p>The code for <code class="literal">add.volt</code> is as follows:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
&lt;h1&gt;Add&lt;/h1&gt;
&lt;hr&gt;
&lt;div class="panel panel-default"&gt;
  &lt;div class="panel-body"&gt;
    &lt;form method="post" action="{{ url('article/create') }}"&gt;
      {% for locale, name in locales %}
      &lt;h3&gt;Article ({{ name }})&lt;/h3&gt;
      &lt;hr&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="article_translation_short_title"&gt;Title
        &lt;/label&gt;
        {{ form.render('translations['~locale~']
        [article_translation_short_title]', {'class':'form-control'}) }}
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="article_translation_long_title"&gt;
            Long title&lt;/label&gt;
        {{ form.render('translations['~locale~']
          [article_translation_long_title]',
          {'class':'form-control'}) }}
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="article_translation_description"&gt;Description
        &lt;/label&gt;
        {{ form.render('translations['~locale~']
          [article_translation_description]',
          {'class':'form-control', 'rows': 8}) }}
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="article_translation_slug"&gt;Slug
        &lt;/label&gt;
        {{ form.render('translations['~locale~']
          [article_translation_slug]',
          {'class':'form-control'}) }}
      &lt;/div&gt;
      {{ form.render('translations['~locale~']
        [article_translation_lang]') }}
        {% endfor %}
      &lt;div class="form-group"&gt;
    &lt;label for="article_is_published"&gt;Is published
    &lt;/label&gt;
    {{form.render('article_is_published',
    {'class':'formcontrol'}) }}
    &lt;/div&gt;
    &lt;h3&gt;Categories&lt;/h3&gt;
    &lt;hr&gt;
    &lt;div class="form-group"&gt;
    &lt;label for="categories"&gt;Select one or more 
    categories&lt;/label&gt;
    {{ form.render('categories[]', {'class':'formcontrol'}) }}
    &lt;/div&gt;
    &lt;h3&gt;Hash tags&lt;/h3&gt;
    &lt;hr&gt;
    &lt;div class="form-group"&gt;
    &lt;label for="hashtags"&gt;Select one or more hash tags
    &lt;/label&gt;
      {{form.render('hashtags[]',
      {'class':'form-control'})}}
    &lt;/div&gt;
    {{form.render('save', {'value':'Save'}) }}
    {{form.render('csrf', {'value':security.getToken()}) }}
  &lt;/form&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% endblock %}</pre></div><p>After you have created this file, try to access <code class="literal">http://www.learning-phalcon.localhost/backoffice/article/add</code>. You should see the form.</p><p>The code in <code class="literal">edit.volt</code> is the same as that for <code class="literal">add.volt</code>. Copy it and change its form action to <code class="literal">article/update</code> instead of <code class="literal">article/create</code>.</p><p>The <code class="literal">delete.volt</code> file has the same content as all the <code class="literal">delete.volt</code> files that we have created so far. Just copy the content from any of them and change the <code class="literal">links</code> actions to point to <code class="literal">article/delete</code>.</p><p>We have already<a id="id536" class="indexterm"/> created the <code class="literal">list.volt</code> file, but we will need to delete its contents and write the following code in it:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %} {% block body %}
&lt;div class="pull-left"&gt;
    &lt;h1&gt;Articles&lt;/h1&gt;
&lt;/div&gt;
&lt;div class="pull-right"&gt;
    &lt;a class="btn btn-success" href="{{ url('article/add') }}" aria-label="Left Align"&gt;
        &lt;span class="glyphicon glyphicon-plus" aria-hidden="true"&gt;&lt;/span&gt; New
    &lt;/a&gt;
&lt;/div&gt;
&lt;div class="clearfix"&gt;&lt;/div&gt;
&lt;hr&gt;
&lt;div class="table-responsive"&gt;

  &lt;table class="table table-striped"&gt;
    &lt;thead&gt;
      &lt;tr&gt;
        &lt;th&gt;#&lt;/th&gt;
        &lt;th&gt;Title&lt;/th&gt;
        &lt;th&gt;Is published&lt;/th&gt;
        &lt;th&gt;Author&lt;/th&gt;
        &lt;th&gt;Created at&lt;/th&gt;
        &lt;th&gt;Options&lt;/th&gt;
      &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
    {% for record in records['items'] %}
      &lt;tr&gt;
        &lt;td&gt;{{record['id'] }}&lt;/td&gt;
        &lt;td&gt;{{record['article_translations'][0]
          ['article_translation_short_title'] }}&lt;/td&gt;
        &lt;td&gt;{{record['article_is_published'] }}&lt;/td&gt;
        &lt;td&gt;{{record['article_author']['user_first_name']}} 
               {{record['article_author']['user_last_name']}}
       &lt;/td&gt;
        &lt;td&gt;{{ record['article_created_at'] }}&lt;/td&gt;
        &lt;td&gt;
          &lt;a class="btn btn-default btn-xs"
            href="{{url('article/edit/' ~ record['id']) }}"
            aria-label="Left Align"&gt;
            &lt;span class="glyphicon glyphicon-pencil"
              ariahidden="true"&gt;&lt;/span&gt;
          &lt;/a&gt;
          &lt;a class="btn btn-danger btn-xs"
            href="{{url('article/delete/' ~ record['id']) }}"
            aria-label="Left Align"&gt;
            &lt;span class="glyphicon glyphicon-trash"
              ariahidden="true"&gt;&lt;/span&gt;
          &lt;/a&gt;
        &lt;/td&gt;
      &lt;/tr&gt;
      {% else %}
      &lt;tr&gt;
        &lt;td colspan="4"&gt;There are no records in your
          database&lt;/td&gt;
      &lt;/tr&gt;
      {% endfor %}
    &lt;/tbody&gt;
  &lt;/table&gt;
&lt;/div&gt;
{% if (records['total_pages'] &gt; 1) %}
{% include 'common/paginator' with {'page_url' : url('article/list'), 'stack' : records} %}
{% endif %}
{% endblock %}</pre></div><p>By now, you<a id="id537" class="indexterm"/> should have a completely functional administration area. We will close this chapter in a few minutes, but before that, we will prettify the UI (user interface) a little. Let's start this process by adding the name of the authenticated user to the top of the page.</p><p>Open the <code class="literal">modules/Backoffice/Controller/BaseControllers.php</code> file and append the following code to the <code class="literal">afterExecuteRoute()</code> method:</p><div class="informalexample"><pre class="programlisting">$this-&gt;view-&gt;identity = $this-&gt;getDI()-&gt;get('auth')-&gt;getIdentity();</pre></div><p>In this way, we assign the identity of our authenticated user to the views. Next, open the <code class="literal">modules/Backoffice/Views/Default/common/topbar.volt</code> template file and append the following code before the <code class="literal">"Sign out" &lt;li&gt;</code> tag:</p><div class="informalexample"><pre class="programlisting">&lt;li class="disabled"&gt;&lt;a href="#"&gt;Welcome, {{ identity['name'] }}&lt;/a&gt;&lt;/li&gt;</pre></div><p>You can now refresh the page, and you should see the name of the authenticated user, as shown here:</p><div class="mediaobject"><img src="graphics/B03522_08_01.jpg" alt="The Article form"/></div><p>Next, instead<a id="id538" class="indexterm"/> of having a default blank page, let's transform it into a simple dashboard. Open <code class="literal">modules/Backoffice/Controller/IndexController.php</code> and modify the <code class="literal">indexAction()</code> method with the following code:</p><div class="informalexample"><pre class="programlisting">public function indexAction() {
  $total_articles = $this-&gt;getDI()-&gt;get('core_article_manager')-&gt;find()-&gt;count();
  $total_users = $this-&gt;getDI()-&gt;get('core_user_manager')-&gt;find()-&gt;count();
  $total_categories = $this-&gt;getDI()-&gt;get('core_category_manager')-&gt;find()-&gt;count();
  $total_hashtags = $this-&gt;getDI()-&gt;get('core_hashtag_manager')-&gt;find()-&gt;count();
  $this-&gt;view-&gt;setVar('dashboard', [
    'total_articles' =&gt; $total_articles,
    'total_users' =&gt; $total_users,
    'total_categories' =&gt; $total_categories,
    'total_hashtags' =&gt; $total_hashtags,
  ]);
}</pre></div><p>As you can see, we<a id="id539" class="indexterm"/> simply count the total number of articles, users, hashtags, and categories. The template code for <code class="literal">modules/Backoffice/Views/Default/index/index.volt</code> can look like this:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
&lt;div class="row"&gt;
  &lt;div class="col-md-6 col-xs-6 text-center"&gt;
    &lt;h1&gt;{{ dashboard['total_articles'] }}
      &lt;span class="glyphicon glyphicon-align-justify"&gt;
      &lt;/span&gt;
    &lt;/h1&gt;
    &lt;small&gt;Articles&lt;/small&gt;
  &lt;/div&gt;
  &lt;div class="col-md-6 col-xs-6 text-center"&gt;
    &lt;h1&gt;{{ dashboard['total_categories'] }}
      &lt;span class="glyphicon glyphicon-th"&gt;
      &lt;/span&gt;
    &lt;/h1&gt;
    &lt;small&gt;Categories&lt;/small&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;div class="row"&gt;
  &lt;div class="col-md-6 col-xs-6 text-center"&gt;
    &lt;h1&gt;{{ dashboard['total_hashtags'] }}
    &lt;span class="glyphicon glyphicon-tag"&gt;
    &lt;/span&gt;&lt;/h1&gt;
    &lt;small&gt;Tags&lt;/small&gt;
  &lt;/div&gt;
  &lt;div class="col-md-6 col-xs-6 text-center"&gt;
  &lt;h1&gt;{{ dashboard['total_users'] }}
    &lt;span class="glyphicon glyphicon-user"&gt;
    &lt;/span&gt;
  &lt;/h1&gt;
  &lt;small&gt;Users&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
{% endblock %}</pre></div><p>If you refresh the page, you should be able to see the result of this simple dashboard, as shown here:</p><div class="mediaobject"><img src="graphics/B03522_08_02.jpg" alt="The Article form"/></div></div><div class="section" title="The Article manager"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec77"/>The Article manager</h2></div></div></div><p>Open the file <a id="id540" class="indexterm"/>located at <code class="literal">modules/Core/Manager/ArticleManager.php</code>, clear its contents, and write the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Managers;

use App\Core\Models\Article;
use App\Core\Models\ArticleTranslation;
use App\Core\Models\ArticleCategoryArticle;
use App\Core\Models\ArticleHashtagArticle;
use App\Core\Models\Category;
use App\Core\Models\Hashtag;
use App\Core\Models\User;</pre></div><p>In these first lines, we insert all the files that we need for the CRUD operations:</p><div class="informalexample"><pre class="programlisting">class ArticleManager extends BaseManager
{
    private $default_data = array(
        'article_user_id' =&gt; 1,
        'article_is_published' =&gt; 0,
        'translations' =&gt; array(
            'en' =&gt; array(
                'article_translation_short_title' =&gt; 'Short title',
                'article_translation_long_title' =&gt; 'Long title',
                'article_translation_description' =&gt; 'Description',
                'article_translation_slug' =&gt; '',
                'article_translation_lang' =&gt; 'en',
            ),
        ),
        'categories' =&gt; array(),
        'hashtags' =&gt; array()
    );</pre></div><p>We added <code class="literal">$default_data</code> as a <a id="id541" class="indexterm"/>private variable to avoid code repetition. We will use it for both the <code class="literal">create()</code> and <code class="literal">update()</code> methods:</p><div class="informalexample"><pre class="programlisting">    public function getForm($entity = null, $options = null)
    {
        return new ArticleForm($entity, $options);
    }


    public function create($input_data)
    {
        $data = $this-&gt;prepareData($input_data);

        $article = new Article();
        $article-&gt;setArticleIsPublished($data[
  'article_is_published']);

        $articleTranslations = array();

        foreach ($data['translations'] as $lang =&gt; $translation) {
            $tmp = new ArticleTranslation();
            $tmp-&gt;assign($translation);
            array_push($articleTranslations, $tmp);
        }

        if (count($data['categories']) &gt; 0) {
            $article-&gt;categories = Category::find([
                "id IN (".implode(',', $data['categories']).")",
            ])-&gt;filter(function ($category) {
                return $category;
            });
        }

        if (count($data['hashtags']) &gt; 0) {
            $article-&gt;hashtags = Hashtag::find([
                "id IN (".implode(',', $data['hashtags']).")",
            ])-&gt;filter(function ($hashtag) {
                return $hashtag;
            });
        }

        $user = User::findFirstById((int) $data['article_user_id']);

        if (!$user) {
            throw new \Exception('User not found', 404);
        }

        $article-&gt;setArticleUserId($data['article_user_id']);

        $article-&gt;translations = $articleTranslations;

        return $this-&gt;save($article, 'create');
    }</pre></div><p>Let's try to understand<a id="id542" class="indexterm"/> the <code class="literal">create()</code> method. First, we call the <code class="literal">prepareData()</code> method. This a helper and we also use it for <code class="literal">update()</code>. Next, we initiate a new article object and set the flag for the <code class="literal">article_is_published</code> field. An article needs translations and hashtags and we must assign a user to it. We do this by initializing a new object for each translation and hashtag. In the case of a user, we need to check whether the user exists in our database:</p><div class="informalexample"><pre class="programlisting">    public function update($input_data)
    {
        $article = Article::findFirstById($input_data['id']);

        if (!$article) {
            throw new \Exception('Article not found', 404);
        }

        $data = $this-&gt;prepareData($input_data);

        $article-&gt;setArticleIsPublished($data['article_is_published']);
        $article-&gt;setArticleUpdatedAt(new \Phalcon\Db\RawValue('NOW()'));


        foreach ($data['translations'] as $lang =&gt; $translation) {
            $article-&gt;getTranslations()-&gt;filter(function($t) use($lang, $translation){

                if ($t-&gt;getArticleTranslationLang() == $lang) {
                    $t-&gt;assign($translation);
                    $t-&gt;update();
                }
            });
        }

        $results = ArticleCategoryArticle::findByArticleId($input_data['id']);

        if ($results) {
            $results-&gt;delete();
        }

        if (count($data['categories']) &gt; 0) {
            $article-&gt;categories = Category::find([
              "id IN (".implode(',', $data['categories']).")",])-&gt;filter(function ($category) {
                return $category;
            });
        }

        $results = ArticleHashtagArticle::findByArticleId(
  $input_data['id']);

        if ($results) {
            $results-&gt;delete();
        }

        if (count($data['hashtags']) &gt; 0) {
            $article-&gt;hashtags = Hashtag::find([
                "id IN (".implode(',', $data['hashtags']).")",
            ])-&gt;filter(function ($hashtag) {
                return $hashtag;
            });
        }

        $user = User::findFirstById((int) $data['article_user_id']);

        if (!$user) {
            throw new \Exception('User not found', 404);
        }

        $article-&gt;setArticleUserId($data['article_user_id']);

        return $this-&gt;save($article, 'update');
    }</pre></div><p>In the preceding code, the <code class="literal">update()</code> method follows the same logic as the <code class="literal">create()</code> method. But in the following<a id="id543" class="indexterm"/> code, we first need to delete the existing relations of the hashtags and categories, and create new ones. This method also checks whether the article exists in our database:</p><div class="informalexample"><pre class="programlisting">    public function delete($id)
    {
        $article = Article::findFirstById($id);

        if (!$article) {
            throw new \Exception('Article not found', 404);
        }

        if (false === $article-&gt;delete()) {
            foreach ($article-&gt;getMessages() as $message) {
                $error[] = (string) $message;
            }

            throw new \Exception(json_encode($error));
        }

        return true;
    }

    private function prepareData($input_data)
    {
        $data = array_merge($this-&gt;default_data, $input_data);

        if (!is_array($data['categories'])) {
            $data['categories'] = $data['categories'] != '' ?
  array_map('trim', explode(',', $data['categories'])) : null;

        } else {
            $data['categories'] = implode(',', $data['categories']);
        }

        if (!is_array($data['hashtags'])) {
            $data['hashtags'] = $data['hashtags'] != '' ?
  array_map('trim', explode(',', $data['hashtags'])) : null;

        } else {
            $data['hashtags'] = implode(',', $data['hashtags']);
        }

        return $data;
    }
}</pre></div><p>The <code class="literal">prepareData()</code> method is a helper that will help us to avoid code repetition in the <code class="literal">update()</code> and <code class="literal">create()</code> methods.</p><p>Take a look at the <code class="literal">create()</code> and <code class="literal">update()</code> methods. We expect the categories and hashtags to be <a id="id544" class="indexterm"/>comma-separated values of IDs. If these fields contain values, we use the <code class="literal">array_map()</code> method and apply a trim operation to each ID. In the case of <code class="literal">update()</code>, we always delete the existing hashtags and categories and add them again (or add new ones). I use this approach because Phalcon's ORM doesn't do it automatically.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note26"/>Note</h3><p><span class="strong"><strong>Important note</strong></span></p><p>In the official documentation, it says you can delete related records in this manner:</p><div class="informalexample"><pre class="programlisting">$robots-&gt;getParts()-&gt;delete();</pre></div><p>When using many-to-many relations, as in our case, if you execute the preceding code for categories or hashtags, you will end up deleting the hashtag and the category only. This will not remove the relation from the intermediate model. Also, there is another method for updating related records that is not supported anymore due to some strange functionality, but it can still be found in the official documentation. Don't use it:</p><div class="informalexample"><pre class="programlisting">$robots-&gt;getParts()-&gt;update($data, function($part) {
    if ($part-&gt;type == Part::TYPE_BASIC) {
        return false;
    }
    return true;
});</pre></div></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec53"/>Summary</h1></div></div></div><p>We're finally done with this module. In general, there are infinite approaches to writing code. In this chapter, I used an approach that I think is easy to understand. Feel free to be different and code the way you like. This book is not intended to teach you coding, but to teach you Phalcon. You might have noticed that for an API, we don't use any validations. You can practice a little and connect your forms to the API.</p><p>In the next chapter, we will switch to the <code class="literal">Frontend</code> module, where we will make some small modifications to the API. We will also try to implement a search engine based on Elasticsearch (<a class="ulink" href="https://www.elastic.co/products/elasticsearch">https://www.elastic.co/products/elasticsearch</a>).</p></div></body></html>