<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;The Backoffice Module (Part 1)"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. The Backoffice Module (Part 1)</h1></div></div></div><p>Unless you are developing a static website, you will need a section/module where an administrator can add and manage content, such as articles, categories, and users. This is where <code class="literal">Backoffice</code> comes into the picture. In this chapter, we will develop parts of the <span class="strong"><strong>CRUD</strong></span> (<span class="strong"><strong>Create</strong></span>, <span class="strong"><strong>Read</strong></span>, <span class="strong"><strong>Update</strong></span>, and <span class="strong"><strong>Delete</strong></span>)<a id="id430" class="indexterm"/> operations needed to administrate our website. We will also use part of the API that we developed in <a class="link" href="ch05.html" title="Chapter 5. The API Module">Chapter 5</a>, <span class="emphasis"><em>The API Module</em></span>. We will play more with forms and validations. We will cover this chapter in two parts, namely:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Hashtag CRUD</li><li class="listitem" style="list-style-type: disc">Category CRUD</li></ul></div><div class="section" title="Editing the main layout"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec45"/>Editing the main layout</h1></div></div></div><p>Let's start this chapter with<a id="id431" class="indexterm"/> some modifications to the main layout. Edit the main layout located at <code class="literal">modules/Backoffice/Views/Default/layout.volt</code> and add the following code:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
&lt;meta charset="utf-8"&gt;
&lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
&lt;title&gt;{% block pageTitle %}Learning Phalcon{% endblock %}&lt;/title&gt;

{{ assets.outputCss('headerCss') }}
{% block css %}{% endblock %}

&lt;!--[if lt IE 9]&gt;
      &lt;script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"&gt;&lt;/script&gt;
      &lt;script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"&gt;&lt;/script&gt;
&lt;![endif]--&gt;
&lt;/head&gt;
&lt;body&gt;
  {% include 'common/topbar.volt' %}
    &lt;div class="container-fluid"&gt;
      &lt;div class="row"&gt;
        &lt;div class="col-sm-3 col-md-2 sidebar"&gt;
        {% include 'common/sidebar.volt' %}
        &lt;/div&gt;
        &lt;div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main"&gt;
          {% block body %}
          &lt;h1 class="page-header"&gt;Dashboard&lt;/h1&gt;
          &lt;h2 class="sub-header"&gt;Section title&lt;/h2&gt;
          &lt;div class="table-responsive"&gt;

          &lt;/div&gt;
          {% endblock %}
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    {{ assets.outputJs('footerJs') }}
  {% block javascripts %} {% endblock %}
&lt;/body&gt;
&lt;/html&gt;</pre></div><p>You can see that we are <a id="id432" class="indexterm"/>using <code class="literal">include</code> to include two new files: <code class="literal">topbar.volt</code> and <code class="literal">sidebar.volt</code>. In Volt, you can use the <code class="literal">include</code> method or the <code class="literal">partial()</code> method. The main difference between <code class="literal">partial</code> and <code class="literal">include</code> is that a <code class="literal">partial</code> method is included in the runtime but an <code class="literal">include</code> file compiles the content and returns it as part of the view that was included. I prefer <code class="literal">include</code> because it improves performance. If you need to assign variables to a file that will be included, you need to avoid the file extension. Here is an example:</p><div class="informalexample"><pre class="programlisting">{% include 'common/sidebar' with {'categories': categories} %}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip21"/>Tip</h3><p>You can<a id="id433" class="indexterm"/> read more about <code class="literal">include</code> at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/volt.html#include">http://docs.phalconphp.com/en/latest/reference/volt.html#include</a>.</p></div></div><p>The code for the two new files is the same code that resided in the main layout earlier but with a small modification for the sidebar. Let's create the folder and the files. Go to <code class="literal">modules/Backoffice/Views/Default/</code> and create a new folder named <code class="literal">common</code>. In this new folder, create two new files named <code class="literal">sidebar.volt</code> and <code class="literal">topbar.volt</code> with the following code.</p><div class="section" title="common/topbar.volt"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec53"/>common/topbar.volt</h2></div></div></div><p>Here is the code for the <a id="id434" class="indexterm"/>navigation bar that can be found at the top of the page. It contains a link to the home page and a link that is used to sign out:</p><div class="informalexample"><pre class="programlisting">&lt;nav class="navbar navbar-inverse navbar-fixed-top" role="navigation"&gt;
  &lt;div class="container-fluid"&gt;
    &lt;div class="navbar-header"&gt;
      &lt;button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"&gt;
        &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
      &lt;/button&gt;
      &lt;a class="navbar-brand" href="{{ url('') }}"&gt;Learning Phalcon&lt;/a&gt;
    &lt;/div&gt;
    &lt;div id="navbar" class="navbar-collapse collapse"&gt;
      &lt;ul class="nav navbar-nav navbar-right"&gt;
        &lt;li&gt;&lt;a href="{{ url('auth/signout') }}"&gt;Sign out&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/nav&gt;</pre></div></div><div class="section" title="common/sidebar.volt"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec54"/>common/sidebar.volt</h2></div></div></div><p>The following is the code for<a id="id435" class="indexterm"/> the sidebar (the left menu) and the code that contains the links to different controllers from our application:</p><div class="informalexample"><pre class="programlisting">{% set c_name = dispatcher.getControllerName() %} 
&lt;ul class="nav nav-sidebar"&gt; 
  &lt;li{% if c_name == 'article' %} class="active"{% endif %}&gt;
    &lt;a href="{{ url('article/list') }}"&gt;Articles&lt;/a&gt;&lt;/li&gt; 
  &lt;li{% if c_name == 'category' %} class="active"{% endif %}&gt;
    &lt;a href="{{ url('category/list') }}"&gt;Categories&lt;/a&gt;&lt;/li&gt; 
  &lt;li{% if c_name == 'hashtag' %} class="active"{% endif %}&gt;
    &lt;a href="{{ url('hashtag/list') }}"&gt;Hashtags&lt;/a&gt;&lt;/li&gt; 
  &lt;li{% if c_name == 'user' %} class="active"{% endif %}&gt;
    &lt;a href="{{ url('user/list') }}"&gt;Users&lt;/a&gt;&lt;/li&gt; 
&lt;/ul&gt;</pre></div><p>There is something <a id="id436" class="indexterm"/>new about these two files. We are making use of a method named <code class="literal">url()</code>, the sidebar has incorporated some logic, and we notice that the dispatcher from DI is available without the need to assign it from a controller.</p><p>By default, Volt has access to a number of methods. The <code class="literal">url()</code> method, which uses the URL service, is one of them. For a list of supported methods, you can check out the official documentation at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/volt.html#functions">http://docs.phalconphp.com/en/latest/reference/volt.html#functions</a>. Sometimes, you need special functions that <a id="id437" class="indexterm"/>are not accessible from Volt. In such a case, you will need to extend the Volt engine and implement your own methods. How do you extend Volt?</p><p>In our case, we can do it directly in the <code class="literal">voltService</code> DI, which can be found in <code class="literal">config/services.php</code>, for example, we want to add a method named <code class="literal">randomGen()</code> that generates a number of random strings, and it's located in <code class="literal">modules/Core/Library/Util.php</code>. The <code class="literal">voltService</code> DI will look like this:</p><div class="informalexample"><pre class="programlisting">$di['voltService'] = function ($view, $di) use ($config) {
  $volt = new \Phalcon\Mvc\View\Engine\Volt($view, $di);
  // ... code
  $compiler = $volt-&gt;getCompiler();
  $compiler-&gt;addFunction('randomGen', function($resolvedArgs, $exprArgs) {
    return 'App\Core\Library\Util::randomGen(' . $resolvedArgs . ')';
  });
  //...code

  return $volt;
};</pre></div><p>We will be able to call this method in Volt by using the following syntax:</p><div class="informalexample"><pre class="programlisting">{{ randomGen(5) }}</pre></div><p>The preceding method will generate five random strings.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note20"/>Note</h3><p>You can learn more about <a id="id438" class="indexterm"/>extending Volt at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/volt.html#extending-volt">http://docs.phalconphp.com/en/latest/reference/volt.html#extending-volt</a>.</p></div></div><p>In the sidebar file (<code class="literal">sidebar.volt</code>), we use <code class="literal">IF</code> statements to check the name of the current controller. The name is available through the dispatcher, and we assign it to a variable named <code class="literal">c_name</code>. The equivalent PHP code for our <code class="literal">IF</code> statements and <code class="literal">set</code> is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?php
$c_name = $this-&gt;dispatcher-&gt;getControllerName();

if (c_name == 'article') {
   // Link is active
}</pre></div><p>Of course, there are <a id="id439" class="indexterm"/>other ways of generating the code for this menu, but try to use Volt as much as you can, so that you get used to the syntax. Now that we have made a few modifications, let's access <code class="literal">http://www.learning-phalcon.localhost/backoffice/</code>. If there are no errors, you should see the same things as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_07_01.jpg" alt="common/sidebar.volt"/></div></div></div></div>
<div class="section" title="Cleaning the Core module"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec46"/>Cleaning the Core module</h1></div></div></div><p>Let's also <a id="id440" class="indexterm"/>clean our <code class="literal">Core</code> module. We will use this folder as a collection of libraries instead of using it as a module. First, remove the following files:</p><div class="informalexample"><pre class="programlisting">modules/Core/Config/config.php
modules/Core/Config/services.php
modules/Core/Controllers/IndexController.php
modules/Core/Module.php</pre></div><p>Then remove these lines from <code class="literal">modules/Bootstrap.php</code>:</p><div class="informalexample"><pre class="programlisting">'core' =&gt; array(
    'className' =&gt; 'App\Core\Module',
    'path' =&gt; __DIR__.'/Core/Module.php',
),</pre></div><p>Now we have a<a id="id441" class="indexterm"/> clean core and our bootstrap will not register it as part of our modules any more. We will make modifications to <code class="literal">modules/Core/Controllers/BaseController.php</code> and <code class="literal">modules/Backoffice/Controllers/BaseController.php</code> so that this controller will extend <code class="literal">modules/Core/Controllers/BaseController.php</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the <code class="literal">modules/Api/Controllers/BaseController.php</code> file:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Api\Controllers;

use Phalcon\Http\Response;

class BaseController extends \App\Core\Controllers\BaseController
{
  // code
}</pre></div></li><li class="listitem" style="list-style-type: disc">In the <code class="literal">modules/Backoffice/Controllers/BaseController.php</code> file:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Backoffice\Controllers;

class BaseController extends \App\Core\Controllers\BaseController
{
  // code
}</pre></div></li></ul></div><p>These modifications help us reuse some code in all our modules.</p></div>
<div class="section" title="Hashtag CRUD"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec47"/>Hashtag CRUD</h1></div></div></div><p>The reason we leave <a id="id442" class="indexterm"/>articles at the end is that when we implement it, we will need to assign hashtags, categories, and users to it. Before going further, we will make a slight modification to <code class="literal">layout.volt</code> and <code class="literal">BaseController</code>. We will remove this line from <code class="literal">BaseController.php</code>:</p><div class="informalexample"><pre class="programlisting">-&gt;addCss($assets_dir.'default/bower_components/bootstrap/dist/css/bootstrap.min.css')</pre></div><p>Also, we will add this line to <code class="literal">layout.volt</code>, right before <code class="literal">{{</code> <code class="literal">assets.outputCss('headerCss')</code> <code class="literal">}}</code>:</p><div class="informalexample"><pre class="programlisting">{{stylesheetLink('../assets/default/bower_components/bootstrap/dist/css/bootstrap.min.css') }}</pre></div><p>We are doing this because the CSS for bootstrap is already minified, and if we do it again, the bootstrap fonts will not be rendered correctly. Remember to apply the same modification to <code class="literal">layout_simple.volt</code>.</p><p>In <a class="link" href="ch05.html" title="Chapter 5. The API Module">Chapter 5</a>, <span class="emphasis"><em>The API Module</em></span>, when we developed the API module, one of our tasks was to create the rest of the required models and managers. They included the <a id="id443" class="indexterm"/>hashtag manager and models. If you didn't do this, don't worry. You have it in the source code. Here, I will show you just the part of the code that we need in order to develop CRUD operations for hashtags. The first thing that you have to do is create the controller in the API module, if you haven't done so already.</p><div class="section" title="The hashtag controller within the API module"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec55"/>The hashtag controller within the API module</h2></div></div></div><p>All the methods found in this<a id="id444" class="indexterm"/> controller<a id="id445" class="indexterm"/> follow the same logic:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We retrieve an <a id="id446" class="indexterm"/>instance of the hashtag manager</li><li class="listitem" style="list-style-type: disc">We get parameters from the request object</li><li class="listitem" style="list-style-type: disc">We call its specific API method and send the response</li></ul></div><p>Let's write the code for this controller. We will start with <code class="literal">listAction()</code>. All the methods are written between the <code class="literal">try{}-catch(){}</code> statements:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Api\Controllers;

class HashtagsController extends BaseController{
  public function listAction() {
  try {
    $manager = $this-&gt;getDI()-&gt;get('core_hashtag_manager');
    $page    = $this-&gt;request-&gt;getQuery('p', 'int', 0);

    $st_output = $manager-&gt;restGet([], [], $page);

    return $this-&gt;render($st_output);
  } catch (\Exception $e) {
    return $this-&gt;render([
      'code' =&gt; $e-&gt;getCode(),
      'message' =&gt; $e-&gt;getMessage(),
    ], $e-&gt;getCode());
  }
}</pre></div><p>This method calls <a id="id447" class="indexterm"/>the hashtag manager<a id="id448" class="indexterm"/> and it reads the page number from<a id="id449" class="indexterm"/> the request. Next, we output the result of the <code class="literal">$manager-&gt;restGet()</code> method, which is an array of records with <a id="id450" class="indexterm"/>
<span class="strong"><strong>pagination</strong></span>:</p><div class="informalexample"><pre class="programlisting">public function getAction($id) {
  try {
    $manager = $this-&gt;getDI()-&gt;get('core_hashtag_manager');

    $st_output = $manager-&gt;restGet([
      'id = :id:',
      'bind' =&gt; [
        'id' =&gt; $id,
      ],
    ]);

    return $this-&gt;render($st_output);
  } catch (\Exception $e) {
    return $this-&gt;render([
      'code' =&gt; $e-&gt;getCode(),
      'message' =&gt; $e-&gt;getMessage(),
    ], $e-&gt;getCode());
  }
}</pre></div><p>This method is mostly similar to <code class="literal">listAction()</code>, the difference being that it will only return one record. Notice that we bind the ID of the requested object to the <code class="literal">$manager-&gt;restGet()</code> method:</p><div class="informalexample"><pre class="programlisting">public function updateAction($id) {
  try {
    $manager = $this-&gt;getDI()-&gt;get('core_hashtag_manager');

    if ($this-&gt;request-&gt;getHeader('CONTENT_TYPE') == 'application/json') {
      $data = $this-&gt;request-&gt;getJsonRawBody(true);
    } else {
      $data = [$this-&gt;request-&gt;getPut()];
    }

    if (count($data[0]) == 0) {
      throw new \Exception('Please provide data', 400);
    }

    $result = $manager-&gt;restUpdate($id, $data);

    return $this-&gt;render($result);
  } catch (\Exception $e) {
    return $this-&gt;render([
      'code' =&gt; $e-&gt;getCode(),
      'message' =&gt; $e-&gt;getMessage(),
    ], $e-&gt;getCode());
  }
}</pre></div><p>This method calls the <a id="id451" class="indexterm"/>hashtag manager <a id="id452" class="indexterm"/>and it reads the page number and<a id="id453" class="indexterm"/> content from the request. If the body that we are posting is in the JSON format, we will read it with <code class="literal">getJsonRawBody()</code>. The <code class="literal">true</code> parameter is used to convert data into arrays. If we don't have data, we throw an exception. Next, we output the result of the <code class="literal">$manager-&gt;restUpdate()</code> method:</p><div class="informalexample"><pre class="programlisting">public function deleteAction($id) {
  try {
    $manager = $this-&gt;getDI()-&gt;get('core_hashtag_manager');

    $st_output = $manager-&gt;restDelete($id);

    return $this-&gt;render($st_output);
  } catch (\Exception $e) {
    return $this-&gt;render([
      'code' =&gt; $e-&gt;getCode(),
      'message' =&gt; $e-&gt;getMessage(),
    ], $e-&gt;getCode());
  }
}</pre></div><p>The <code class="literal">deleteAction()</code> method simply calls <code class="literal">$manager-&gt;restDelete()</code> with the ID of the object as the argument. If the object is found, it will be deleted:</p><div class="informalexample"><pre class="programlisting">public function createAction() {
  try {
    $manager   = $this-&gt;getDI()-&gt;get('core_hashtag_manager');

    if ($this-&gt;request-&gt;getHeader('CONTENT_TYPE') == 'application/json') {
      $data = $this-&gt;request-&gt;getJsonRawBody(true);
    } else {
      $data = $this-&gt;request-&gt;getPost();
    }

    if (count($data) == 0) {
      throw new \Exception('Please provide data', 400);
    }

    $st_output = $manager-&gt;restCreate($data);

    return $this-&gt;render($st_output);
  } catch (\Exception $e) {
    return $this-&gt;render([
      'code' =&gt; $e-&gt;getCode(),
      'message' =&gt; $e-&gt;getMessage(),
    ], $e-&gt;getCode());
    }
  }
}</pre></div><p>This method is<a id="id454" class="indexterm"/> similar to <code class="literal">updateAction()</code>, but<a id="id455" class="indexterm"/> instead of updating an object, it <a id="id456" class="indexterm"/>creates it.</p><p>The routing is missing, so we are going to add it to <code class="literal">modules/Api/Config.routing.php</code>. We will create a new routing group for hashtags:</p><div class="informalexample"><pre class="programlisting">$hashtags = new \Phalcon\Mvc\Router\Group([
    'module' =&gt; 'api',
    'controller' =&gt; 'hashtags',
]);

$hashtags-&gt;setPrefix($versions['v1'].'/hashtags');

$hashtags-&gt;addGet('',         ['action' =&gt; 'list']);
$hashtags-&gt;addGet('/{id}',    ['action' =&gt; 'get']);
$hashtags-&gt;addPut('/{id}',    ['action' =&gt; 'update']);
$hashtags-&gt;addDelete('/{id}', ['action' =&gt; 'delete']);
$hashtags-&gt;addPost('',        ['action' =&gt; 'create']);

$router-&gt;mount($hashtags);</pre></div><p>If everything is okay, you can now insert a few records into the hashtag table and call the API to get the records by using the following command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ curl -i -X GET -H "Content-Type:application/json" -H "APIKEY:6y825Oei113X3vbz78Ck7Fh7k3xF68Uc0lki41GKs2Z73032T4z8m1I81648JcrY"  -H "TOKEN:mySecretToken" 'http://learning-phalcon.localhost/api/v1/hashtags'</strong></span>
</pre></div><p>The output of the command<a id="id457" class="indexterm"/> line should be similar to what is<a id="id458" class="indexterm"/> shown in the <a id="id459" class="indexterm"/>following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_07_02.jpg" alt="The hashtag controller within the API module"/></div><p>This cURL <a id="id460" class="indexterm"/>command <a id="id461" class="indexterm"/>makes a request to <code class="literal">/api/v1/hashtags</code>. The <code class="literal">-H</code> <a id="id462" class="indexterm"/>option is used to send header information; in our case, we send the token and the API key.</p></div><div class="section" title="A common method to reduce code duplication"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec56"/>A common method to reduce code duplication</h2></div></div></div><p>Let's create a<a id="id463" class="indexterm"/> method in <code class="literal">modules/Core/Controllers/BaseController.php</code> that will help us get data from our API. This method will be available within the controllers that extend it:</p><div class="informalexample"><pre class="programlisting">public function apiGet($uri, $params = []) {
  $config   = $this-&gt;getDI()-&gt;get('config')-&gt;toArray();
  $uri      = $config['apiUrl'].$uri;
  $curl     = new \Phalcon\Http\Client\Provider\Curl();
  $response = $curl-&gt;get($uri, $params, ["APIKEY:".$config['apiKeys'][0]]);

    if ($response-&gt;header-&gt;statusCode != 200) {
  throw new \Exception('API error: '.$response-&gt;header-&gt;status);
    }

    return json_decode($response-&gt;body, true);
}</pre></div></div><div class="section" title="Retrieving the data"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec57"/>Retrieving the data</h2></div></div></div><p>To get the<a id="id464" class="indexterm"/> data, we just need to provide the URL and extra parameters, if needed. With the help of Phalcon's built-in cURL provider, we make the call. Next, we create a hashtag controller in the <code class="literal">Backoffice</code> module. It will look like this:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Backoffice\Controllers;

class HashtagController extends BaseController {
  public function indexAction() {
    return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'list']);
  }

  /**
  * Hashtags list
  */
  public function listAction() {
    $page = $this-&gt;request-&gt;getQuery('p', 'int', 1);

    try {
      $hashtags = $this-&gt;apiGet('hashtags?p='.$page);

      $this-&gt;view-&gt;hashtags = $hashtags;
    } catch (\Exception $e) {
      $this-&gt;flash-&gt;error($e-&gt;getMessage());
    }
  }
}</pre></div><p>As you can <a id="id465" class="indexterm"/>see, the only thing that we do here is call the API's URL, and it returns an array of paginated items.</p></div><div class="section" title="The layout structure"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec58"/>The layout structure</h2></div></div></div><p>Creating the layout for this <a id="id466" class="indexterm"/>listing is quite simple. Go to <code class="literal">modules/Backoffice/Views/Default</code> and create a new folder named <code class="literal">hashtag</code>. In this new folder, create a new file named <code class="literal">list.volt</code> with the following content:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
&lt;div class="pull-left"&gt;
    &lt;h1&gt;Hashtags&lt;/h1&gt;
&lt;/div&gt;
&lt;div class="pull-right"&gt;
  &lt;a class="btn btn-success" href="{{ url('hashtag/add') }}" aria-label="Left Align"&gt;
    &lt;span class="glyphicon glyphicon-plus" aria-hidden="true"&gt;&lt;/span&gt; New
  &lt;/a&gt;
&lt;/div&gt;
&lt;div class="clearfix"&gt;&lt;/div&gt;
&lt;hr&gt;
&lt;div class="panel panel-default"&gt;
  &lt;div class="panel-body"&gt;
    &lt;table class="table table-striped"&gt;
      &lt;thead&gt;
        &lt;tr&gt;
          &lt;th&gt;#&lt;/th&gt;
          &lt;th&gt;Hashtag&lt;/th&gt;
          &lt;th&gt;Created at&lt;/th&gt;
          &lt;th&gt;Options&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody&gt;
        {% for hashtag in hashtags['items'] %}
        &lt;tr&gt;
          &lt;th scope="row"&gt;{{ hashtag['id'] }}&lt;/th&gt;
            &lt;td&gt;{{ hashtag['hashtag_name'] }}&lt;/td&gt;
            &lt;td&gt;{{ hashtag['hashtag_created_at'] }}&lt;/td&gt;
            &lt;td&gt;
              &lt;a class="btn btn-default btn-xs" href="#" aria-label="Left Align"&gt;
                &lt;span class="glyphicon glyphicon-pencil" aria-hidden="true"&gt;&lt;/span&gt;
              &lt;/a&gt;
              &lt;a class="btn btn-danger btn-xs" href="#" aria-label="Left Align"&gt;
                &lt;span class="glyphicon glyphicon-trash" aria-hidden="true"&gt;&lt;/span&gt;
              &lt;/a&gt;
              &lt;/td&gt;
            &lt;/tr&gt;
            {% else %}
            &lt;tr&gt;
              &lt;td colspan="4"&gt;There are no hashtags in your database&lt;/td&gt;
            &lt;/tr&gt;
        {% endfor %}
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% if (hashtags['total_pages'] &gt; 1) %}
{% include 'common/paginator' with {'page_url' : url('hashtag/list'), 'stack' : hashtags} %}
{% endif %}
{% endblock %}</pre></div><p>Before ending the block of<a id="id467" class="indexterm"/> the code for the list template, we include another template named <code class="literal">paginator</code>. This is the paginator that will help us navigate through records. Create a file named <code class="literal">paginator.volt</code> in <code class="literal">modules/Backoffce/Views/Default/common/</code> and write this code in it:</p><div class="informalexample"><pre class="programlisting">&lt;nav&gt;
  &lt;ul class="pager"&gt;
    &lt;li class="previous {% if (stack['current'] &lt; 2) %}disabled{% endif %}"&gt;&lt;a href="{{ page_url ~ '?p=' ~ stack['before'] }}"&gt;&lt;span aria-hidden="true"&gt;&amp;larr;&lt;/span&gt; Previous&lt;/a&gt;&lt;/li&gt;

    &lt;li class="next {% if (stack['current'] == stack['total_pages']) %}disabled{% endif %}"&gt;&lt;a href="{{ page_url ~ '?p=' ~ stack['next'] }}"&gt;Next &lt;span aria-hidden="true"&gt;&amp;rarr;&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip22"/>Tip</h3><p>The preceding code makes use of the <a id="id468" class="indexterm"/>paginator variables that are already available (see <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/pagination.html">http://docs.phalconphp.com/en/latest/reference/pagination.html</a>).</p></div></div><p>Now, you can <a id="id469" class="indexterm"/>authenticate and access the hashtags listing at <code class="literal">http://www.learning-phalcon.localhost/backoffice/hashtag/list</code>. You should be able to see something similar to what is shown in the next screenshot:</p><div class="mediaobject"><img src="graphics/B03522_07_03.jpg" alt="The layout structure"/></div><p>Let's continue with the rest of the actions (create, delete, and update). There are several ways to achieve this, but we will <span class="emphasis"><em>not</em></span> make use of our API for create and update, mainly because of the time needed to cover all the aspects, and also because doing it the "old normal way" is faster. However, you can play with the idea and try to migrate these two actions to be API-driven.</p></div><div class="section" title="The hashtag form"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec59"/>The hashtag form</h2></div></div></div><p>For <a id="id470" class="indexterm"/>create and update, I like to <a id="id471" class="indexterm"/>use forms because it's easier to maintain the code and also to validate it. We will start with the <code class="literal">create</code> action by writing the code for the create form (the same form will be used for update). Switch to <code class="literal">modules/Core/Forms</code> and create a new file named <code class="literal">HashtagForm.php</code> with the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Forms;

use Phalcon\Forms\Form;
use Phalcon\Forms\Element\Text;
use Phalcon\Forms\Element\Submit;
use Phalcon\Forms\Element\Hidden;
use Phalcon\Validation\Validator\PresenceOf;
use Phalcon\Validation\Validator\Identical;

class HashtagForm extends Form {
  public function initialize() {
    $hashtag_name = new Text('hashtag_name', array(
      'placeholder' =&gt; 'Name',
    ));

    $hashtag_name-&gt;addValidators(array(
      new PresenceOf(array(
        'message' =&gt; 'Name is required',
      ))
    ));

    $this-&gt;add($hashtag_name);

    //CSRF
    $csrf = new Hidden('csrf');

    $csrf-&gt;addValidator(
      new Identical(array(
        'value' =&gt; $this-&gt;security-&gt;getSessionToken(),
        'message' =&gt; 'CSRF validation failed',
      ))
    );

    $this-&gt;add($csrf);

    $this-&gt;add(new Submit('add', array(
      'class' =&gt; 'btn btn-lg btn-primary btn-block',
    )));
  }
}</pre></div><p>Our new form is <a id="id472" class="indexterm"/>quite simple. We have three elements: the name of the<a id="id473" class="indexterm"/> hashtag, a <code class="literal">csrf</code> field, and a <span class="strong"><strong>Submit</strong></span> button. We validate the name and the <code class="literal">csrf</code> field with the help of two validators: <code class="literal">PresenceOf</code> and <code class="literal">Identical</code>.</p></div><div class="section" title="The hashtag controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec60"/>The hashtag controller</h2></div></div></div><p>We continue by<a id="id474" class="indexterm"/> writing the code for the <code class="literal">create</code><a id="id475" class="indexterm"/> action and for the template.  Open <code class="literal">modules/Backoffice/Controllers/HashtagController.php</code> and add these two methods:</p><div class="informalexample"><pre class="programlisting">public function addAction() {
  $manager = $this-&gt;getDI()-&gt;get('core_hashtag_manager');
  $this-&gt;view-&gt;form = $manager-&gt;getForm();
}

public function createAction() {
  if (!$this-&gt;request-&gt;isPost()) {
    return $this-&gt;response-&gt;redirect('hashtag/list');
  }

  $manager = $this-&gt;getDI()-&gt;get('core_hashtag_manager');
  $form    = $manager-&gt;getForm();

  if ($form-&gt;isValid($this-&gt;request-&gt;getPost())) {
    try {
      $manager = $this-&gt;getDI()-&gt;get('core_hashtag_manager');
      $manager-&gt;create($this-&gt;request-&gt;getPost());
      $this-&gt;flashSession-&gt;success('Object was created successfully');

      return $this-&gt;response-&gt;redirect('hashtag/list');
    } catch (\Exception $e) {
      $this-&gt;flash-&gt;error($e-&gt;getMessage());
      return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'add']);
    }
  } else {
    foreach ($form-&gt;getMessages() as $message) {
      $this-&gt;flash-&gt;error($message-&gt;getMessage());
    }
    return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'add', 'controller' =&gt; 'hashtag']);
  }
}</pre></div><p>The <code class="literal">addAction()</code> method<a id="id476" class="indexterm"/> simply renders the form we just created. The<a id="id477" class="indexterm"/> processes of creation and validation take place in the <code class="literal">createAction()</code> method. This method accepts only <code class="literal">POST</code> data, as you can see in the first two lines. When you're working on a big project, you might want to use custom routes, just as we did in the API module.</p></div><div class="section" title="The hashtag manager"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec61"/>The hashtag manager</h2></div></div></div><p>You might notice a new<a id="id478" class="indexterm"/> method named <code class="literal">getForm()</code> in the hashtag manager. This<a id="id479" class="indexterm"/> method returns an instance of <code class="literal">HashtagForm</code> and it looks like this:</p><div class="informalexample"><pre class="programlisting">use App\Core\Forms\HashtagForm;
class HashtagManager extends BaseManager{
  ...
  public function getForm($entity = null, $options = null) {
    return new HashtagForm($entity, $options);
  }
  ...
}</pre></div><p>If you have already created the hashtag manager, you should have a <code class="literal">create()</code> method similar to this one:</p><div class="informalexample"><pre class="programlisting">public function create(array $st_inputData)
{
    $st_defaultData = [
        'hashtag_name' =&gt; new \Phalcon\Db\RawValue('NULL')
    ];

    $st_data = array_merge($st_defaultData, $st_inputData);

    $hashtag = new Hashtag();
    $hashtag-&gt;setHashtagName($st_data['hashtag_name']);

    return $this-&gt;save($hashtag, 'create');
}</pre></div></div><div class="section" title="The View template for the add() method"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec62"/>The View template for the add() method</h2></div></div></div><p>We also need to <a id="id480" class="indexterm"/>write the code for the template. Create a new file named <code class="literal">add.volt</code> in <code class="literal">modules/Backoffice/Views/Default/hashtag</code> and add the following code:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
&lt;h1&gt;Add&lt;/h1&gt;
&lt;hr&gt;
&lt;div class="panel panel-default"&gt;
  &lt;div class="panel-body"&gt;
    &lt;form method="post" action="{{ url('hashtag/create') }}"&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="hashtag_name"&gt;Name&lt;/label&gt;
        {{ form.render('hashtag_name', {'class':'form-control'}) }}
      &lt;/div&gt;
    {{ form.render('add', {'value':'Add'}) }}
    {{ form.render('csrf', {'value':security.getToken()}) }}
    &lt;/form&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% endblock %}</pre></div><p>Our template extends <code class="literal">layout.volt</code> and renders the hashtag form elements. At this point, you should be able to add a new hashtag from your<a id="id481" class="indexterm"/> <code class="literal">Backoffice</code> module. Open <code class="literal">http://www.learning-phalcon.localhost/backoffice/hashtag/add</code>, fill in the name for the hashtag, and click on the <span class="strong"><strong>Add</strong></span> button, like this:</p><div class="mediaobject"><img src="graphics/B03522_07_04.jpg" alt="The View template for the add() method"/></div><p>If the hashtag was <a id="id482" class="indexterm"/>saved correctly, you will be redirected to a hashtags list page, otherwise an error message will be shown.</p></div><div class="section" title="Improving the database table structure and adding validation"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec63"/>Improving the database table structure and adding validation</h2></div></div></div><p>Now that we can <a id="id483" class="indexterm"/>add hashtags, we will <a id="id484" class="indexterm"/>face a problem, because we are able to add duplicated hashtags. To fix this, we will make a small change to our hashtags table and implement a new validator in the hashtag model.</p><p>The change that we will apply to this table is meant to make the <code class="literal">name</code> field unique. Do this by executing the following SQL query against your database:</p><div class="informalexample"><pre class="programlisting">ALTER TABLE hashtag ADD UNIQUE (hashtag_name);</pre></div><p>If you try to add a new hashtag, you will get an <span class="strong"><strong>Integrity constraint violation</strong></span> error. This is good enough to avoid duplicates in your database, but you will need to implement a more human-friendly error by making use of <code class="literal">Phalcon\Mvc\Model\Validator\Uniqueness</code>. Open the hashtag model and append the following code:</p><div class="informalexample"><pre class="programlisting">public function validation(){
  $this-&gt;validate(new Uniqueness([
    "field" =&gt; "hashtag_name",
    "message" =&gt; "This hashtag already exists",
  ]));

  return $this-&gt;validationHasFailed() != true;
}</pre></div><p>This is it! If you try to <a id="id485" class="indexterm"/>add the same hashtag, you will get an <a id="id486" class="indexterm"/>error message saying <span class="strong"><strong>This hashtag already exists</strong></span>. We can now continue with the edit/update methods for the hashtags.</p></div><div class="section" title="Editing hashtags"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec64"/>Editing hashtags</h2></div></div></div><p>Editing follows the <a id="id487" class="indexterm"/>same workflow as creating, except that we need to search for an <a id="id488" class="indexterm"/>existing object to edit. Let's first create the <code class="literal">update()</code> method in <code class="literal">modules/Core/Managers/HashtagManager.php</code>:</p><div class="informalexample"><pre class="programlisting">public function update(array $st_inputData){
  $st_defaultData = [
    'hashtag_name' =&gt; new \Phalcon\Db\RawValue('NULL')
  ];

  $st_data = array_merge($st_defaultData, $st_inputData);

  $hashtag = Hashtag::findFirstById($st_data['id']);

  if (!$hashtag) {
    throw new \Exception('Object not found');
  }

  $hashtag-&gt;setHashtagName($st_data['hashtag_name']);

  return $this-&gt;save($hashtag, 'update');
}</pre></div><p>As you can see, there are only two differences between <code class="literal">update()</code> and <code class="literal">create()</code>. One is that we searched for a hashtag based on its ID, and the second is that we changed the second parameter from <code class="literal">$this-&gt;save()</code> to <code class="literal">update</code>. The template is the same as that for the <code class="literal">create()</code> method. Create a new file named <code class="literal">edit.volt</code> in <code class="literal">modules/Backoffice/Views/Default/hashtag</code> with the following code:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
&lt;h1&gt;Edit&lt;/h1&gt;
&lt;hr&gt;
&lt;div class="panel panel-default"&gt;
  &lt;div class="panel-body"&gt;
    &lt;form method="post" action="{{ url('hashtag/update') }}"&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="hashtag_name"&gt;Name&lt;/label&gt;
        {{ form.render('hashtag_name', {'class':'form-control'})}}
          &lt;/div&gt;
          {{ form.render('save', {'value':'Save'}) }}
          {{ form.render('csrf', {'value':security.getToken()})}}
    &lt;/form&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% endblock %}</pre></div><p>The only<a id="id489" class="indexterm"/> modification<a id="id490" class="indexterm"/> that we have done here is that we changed the <code class="literal">&lt;h1&gt;</code> title from <code class="literal">Add</code> to <code class="literal">Edit</code>. We can now switch to <code class="literal">HashtagController</code> and create two new methods, <code class="literal">editAction()</code> and <code class="literal">updateAction()</code>:</p><div class="informalexample"><pre class="programlisting">public function editAction($id){
  $manager = $this-&gt;getDI()-&gt;get('core_hashtag_manager');
  $hashtag = $manager-&gt;findFirstById($id);

  if (!$hashtag) {
    $this-&gt;flashSession-&gt;error('Object not found');
    return $this-&gt;response-&gt;redirect('hashtag/list');
  }

  $this-&gt;persistent-&gt;set('id', $id);

  $this-&gt;view-&gt;form = $manager-&gt;getForm($hashtag);
}</pre></div><p>In this method, we search for an object and output an error message if we can't find it. If it is found, we save the ID in a persistent bag (when using persistent bags, data is temporarily saved in the session and removed the first time you get the variable) and then assign the object to the form to be rendered. The <code class="literal">updateAction()</code> method looks like this:</p><div class="informalexample"><pre class="programlisting">public function updateAction(){
  if (!$this-&gt;request-&gt;isPost()) {
    return $this-&gt;response-&gt;redirect('hashtag/list');
  }

  $manager    = $this-&gt;getDI()-&gt;get('core_hashtag_manager');
  $hashtag_id = $this-&gt;persistent-&gt;get('id');
  $hashtag    = $manager-&gt;findFirstById($hashtag_id);
  $form       = $manager-&gt;getForm($hashtag);

  if ($form-&gt;isValid($this-&gt;request-&gt;getPost())) {
    try {
      $manager = $this-&gt;getDI()-&gt;get('core_hashtag_manager');
      $manager-&gt;update([
        'hashtag_name' =&gt; $this-&gt;request-&gt;getPost('hashtag_name',['string','trim']),
        'id' =&gt; $hashtag_id
      ]);
      $this-&gt;flashSession-&gt;success('Object was updated successfully');

      return $this-&gt;response-&gt;redirect('hashtag/list');
    } catch (\Exception $e) {
      $this-&gt;flash-&gt;error($e-&gt;getMessage());
      return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'edit']);
    }
  } else {
    foreach ($form-&gt;getMessages() as $message) {
      $this-&gt;flash-&gt;error($message-&gt;getMessage());
    }
    return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'edit', 'controller' =&gt; 'hashtag']);
  }
}</pre></div><p>The main difference<a id="id491" class="indexterm"/> between<a id="id492" class="indexterm"/> this method and the <code class="literal">createAction()</code> method is that we get the object ID from the persistent bag and search for it. The final step is to create a link from the listing page to the edit page. Update <code class="literal">list.volt</code> and replace the current <code class="literal">edit</code> link with this code:</p><div class="informalexample"><pre class="programlisting">&lt;a class="btn btn-default btn-xs" href="{{ url('hashtag/edit/' ~ hashtag['id']) }}" aria-label="Left Align"&gt;
    &lt;span class="glyphicon glyphicon-pencil" aria-hidden="true"&gt;&lt;/span&gt;
&lt;/a&gt;</pre></div><p>This is it! You can now access <code class="literal">http://www.learning-phalcon.localhost/backoffice/hashtag/list</code>, click on the <span class="strong"><strong>Edit</strong></span> button of an existing record, and try to edit (change the name).</p></div><div class="section" title="Deleting hashtags"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec65"/>Deleting hashtags</h2></div></div></div><p>We can move<a id="id493" class="indexterm"/> forward<a id="id494" class="indexterm"/> and write the code for the last step in this process—deletion. Deletion is very simple and quick. We will use an intermediate page so that a user can confirm when they want to delete an object. Let's start by writing the code for the template. Create a new file named <code class="literal">delete.volt</code> in the <code class="literal">hashtag</code> folder and write this code:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
&lt;h1&gt;Confirm deletion&lt;/h1&gt;
&lt;h3&gt;Are you sure you want to delete the selected element?&lt;/3&gt;
&lt;hr&gt;
&lt;div class="panel panel-default"&gt;
  &lt;div class="panel-body"&gt;
    &lt;form method="post" action="{{ url('hashtag/delete/' ~ id) }}" class="form-inline"&gt;
    &lt;input type="submit" value="Yes, delete" class="btn btn-sm btn-danger btn-block"&gt;
    &lt;a href="{{ url('hashtag/list') }}" class="btn btn-lg btn-default btn-block"&gt;Cancel&lt;/a&gt;
      &lt;/form&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% endblock %}</pre></div><p>This template has a simple form. When a user clicks on the <span class="strong"><strong>Yes, delete</strong></span> button, the actual deletion takes place. Switch to <code class="literal">HashtagController.php</code> and create a method named <code class="literal">deleteAction()</code>:</p><div class="informalexample"><pre class="programlisting">public function deleteAction($id){
  if ($this-&gt;request-&gt;isPost()) {
    try {
      $manager = $this-&gt;getDI()-&gt;get('core_hashtag_manager');
      $manager-&gt;delete($id);
      $this-&gt;flashSession-&gt;success('Item has been deleted successfully');
    } catch (\Exception $e) {
      $this-&gt;flash-&gt;error($e-&gt;getMessage());
    }

    return $this-&gt;response-&gt;redirect('hashtag/list');
  }
  $this-&gt;view-&gt;id = $id;
}</pre></div><p>By default, the <code class="literal">deleteAction($id)</code> method only renders its template (<code class="literal">delete.volt</code>). When we confirm the deletion, we make a post and delete the record. If you haven't already written the code for the <code class="literal">delete()</code> method from manager, here is what it should look like:</p><div class="informalexample"><pre class="programlisting">public function delete($id){
  $object = Hashtag::findFirstById($id);

  if (!$object) {
    throw new \Exception('Hashtag not found');
  }

  if (false === $object-&gt;delete()) {
    foreach ($object-&gt;getMessages() as $message) {
      $error[] = (string) $message;
    }

    throw new \Exception(json_encode($error));
  }

  return true;
}</pre></div><p>In the final step, we <a id="id495" class="indexterm"/>need to <a id="id496" class="indexterm"/>update the <code class="literal">list.volt</code> template to create a link to the delete page. Open <code class="literal">hashtag/list.volt</code> and replace the <code class="literal">delete</code> link with this one:</p><div class="informalexample"><pre class="programlisting">&lt;a class="btn btn-danger btn-xs" href="{{ url('hashtag/delete/' ~ hashtag['id']) }}" aria-label="Left Align"&gt;
    &lt;span class="glyphicon glyphicon-trash" aria-hidden="true"&gt;&lt;/span&gt;
&lt;/a&gt;</pre></div><p>This is pretty much all there is to know about deleting. You can test it by clicking on the <span class="strong"><strong>Delete</strong></span> link from the list. You should see exactly the same output as presented in the next screenshot:</p><div class="mediaobject"><img src="graphics/B03522_07_05.jpg" alt="Deleting hashtags"/></div><p>If you click on <a id="id497" class="indexterm"/>
<span class="strong"><strong>Cancel</strong></span>, you should be redirected to the listing page. If you click on <span class="strong"><strong>Yes, delete</strong></span> and there are no errors, you will be redirected to the listing page and the following <a id="id498" class="indexterm"/>success message will be shown: <span class="strong"><strong>Item has been deleted successfully</strong></span>. We will now continue with CRUD development for categories.</p></div></div>
<div class="section" title="Category CRUD"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec48"/>Category CRUD</h1></div></div></div><p>When we created the <a id="id499" class="indexterm"/>architecture for category tables, we added a <code class="literal">category_translation</code> table. We will alter this table and add a unique index to avoid duplicates for the same country code and category ID. Execute the following query:</p><div class="informalexample"><pre class="programlisting">ALTER TABLE  `learning_phalcon`.`category_translation` ADD UNIQUE (
`category_translation_category_id` ,
`category_translation_lang`
) COMMENT  '';</pre></div><p>We will add a new array to the <code class="literal">config/config.php</code> global configuration file that will hold information about <code class="literal">i18n</code>:</p><div class="informalexample"><pre class="programlisting">'i18n' =&gt; [
  'locales' =&gt; [ //ISO 639-1: two-letter codes, one per language
    'en' =&gt; 'English'
  ]
]</pre></div><div class="section" title="The Category form"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec66"/>The Category form</h2></div></div></div><p>We will now create the form <a id="id500" class="indexterm"/>for the add/edit categories. Create a new file in <code class="literal">modules/Core/Forms/</code>, name it <code class="literal">CategoryForm.php</code>, and write the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Forms;

use Phalcon\Forms\Form;
use Phalcon\Forms\Element\Text;
use Phalcon\Forms\Element\Select;
use Phalcon\Forms\Element\Submit;
use Phalcon\Forms\Element\Hidden;
use Phalcon\Validation\Validator\Identical;

class CategoryForm extends Form{
  private $edit = false;

  public function initialize($entity = null, $options = null) {
    if (isset($options['edit']) &amp;&amp; $options['edit'] === true) {
      $this-&gt;edit = true;
    }

    $locales = $this-&gt;getDI()-&gt;get('config')-&gt;i18n-&gt;locales-&gt;toArray();

    foreach ($locales as $locale =&gt; $name) {

      if (true === $this-&gt;edit) {
        $translations = $entity-&gt;getTranslations(["category_translation_lang = '$locale'"])-&gt;toArray();
      }

      $category_name[$locale] = new Text ("translations[$locale][category_translation_name]", [
          'value' =&gt; $this-&gt;edit === true ? $translations[0]['category_translation_name'] : null
      ]);

      $category_slug[$locale] = new Text ("translations[$locale][category_translation_slug]", [
          'value' =&gt; $this-&gt;edit === true ? $translations[0]['category_translation_slug'] : null
      ]);

      $category_lang[$locale] = new Hidden ( "translations[$locale][category_translation_lang]", [
          'value' =&gt; $locale
      ]);

      $this-&gt;add( $category_name[$locale] );
      $this-&gt;add( $category_slug[$locale] );
      $this-&gt;add( $category_lang[$locale] );
    }

    //CSRF
    $csrf = new Hidden('csrf');

    $csrf-&gt;addValidator(
      new Identical(array(
        'value' =&gt; $this-&gt;security-&gt;getSessionToken(),
        'message' =&gt; 'CSRF validation failed',
      ))
    );

    $this-&gt;add($csrf);

    $this-&gt;add(new Submit('save', array(
      'class' =&gt; 'btn btn-lg btn-primary btn-block',
    )));
  }
}</pre></div><p>In this form, we<a id="id501" class="indexterm"/> automatically add the required fields based on the available locales. If we edit a record, we need to retrieve the translations and assign the correct values to each field. We use the array naming style for easy processing. This means that the name of the generated field will look like this: <code class="literal">translations[en][category_translation_name]</code>.</p><p>Next, we need to assign the available locales to the view. Open <code class="literal">BaseController.php</code> from <code class="literal">modules/Backoffice/Controllers/</code> and append the following line to the <code class="literal">afterExecuteRoute()</code> method:</p><div class="informalexample"><pre class="programlisting">$this-&gt;view-&gt;locales = $this-&gt;getDI()-&gt;get('config')-&gt;i18n-&gt;locales-&gt;toArray();</pre></div></div><div class="section" title="Creating the Category templates"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec67"/>Creating the Category templates</h2></div></div></div><p>Let's see how our <a id="id502" class="indexterm"/>templates will look. Create a new folder in <code class="literal">modules/Backoffice/Views/Default</code> and name it <code class="literal">category</code>. In this new folder, create the <code class="literal">list.volt</code>, <code class="literal">add.volt</code>, <code class="literal">edit.volt</code>, and <code class="literal">delete.volt</code> template files. The following sections contain the code for each file.</p><div class="section" title="list.volt"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec11"/>list.volt</h3></div></div></div><p>Usually, listing is pretty <a id="id503" class="indexterm"/>much the same for any section. Here is the <code class="literal">list.volt</code> template file for <code class="literal">Category</code>:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
&lt;div class="pull-left"&gt;
  &lt;h1&gt;Categories&lt;/h1&gt;
&lt;/div&gt;
&lt;div class="pull-right"&gt;
  &lt;a class="btn btn-success" href="{{ url('category/add') }}" aria-label="Left Align"&gt;
    &lt;span class="glyphicon glyphicon-plus" aria-hidden="true"&gt;&lt;/span&gt; New
  &lt;/a&gt;
&lt;/div&gt;
&lt;div class="clearfix"&gt;&lt;/div&gt;
&lt;hr&gt;
&lt;div class="panel panel-default"&gt;
  &lt;div class="panel-body"&gt;
    &lt;table class="table table-striped"&gt;
      &lt;thead&gt;
        &lt;tr&gt;
          &lt;th&gt;#&lt;/th&gt;
          &lt;th&gt;Category&lt;/th&gt;
          &lt;th&gt;Slug&lt;/th&gt;
          &lt;th&gt;Created at&lt;/th&gt;
          &lt;th&gt;Options&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
    &lt;tbody&gt;
    {% for record in records['items'] %}
      &lt;tr&gt;
        &lt;th scope="row"&gt;{{ record['id'] }}&lt;/th&gt;
          &lt;td&gt;{{ record['category_translations'][0]['category_translation_name'] }}&lt;/td&gt;
          &lt;td&gt;{{ record['category_translations'][0]['category_translation_slug'] }}&lt;/td&gt;
          &lt;td&gt;{{ record['category_created_at'] }}&lt;/td&gt;
          &lt;td&gt;
            &lt;a class="btn btn-default btn-xs" href="{{ url('category/edit/' ~ record['id']) }}" aria-label="Left Align"&gt;
              &lt;span class="glyphicon glyphicon-pencil" aria-hidden="true"&gt;&lt;/span&gt;
            &lt;/a&gt;
            &lt;a class="btn btn-danger btn-xs" href="{{ url('category/delete/' ~ record['id']) }}" aria-label="Left Align"&gt;
              &lt;span class="glyphicon glyphicon-trash" aria-hidden="true"&gt;&lt;/span&gt;
            &lt;/a&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
          {% else %}
        &lt;tr&gt;
          &lt;td colspan="4"&gt;There are no records in your database&lt;/td&gt;
        &lt;/tr&gt;
          {% endfor %}
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% if (records['total_pages'] &gt; 1) %}
{% include 'common/paginator' with {'page_url' : url('category/list'), 'stack' : records} %}
{% endif %}
{% endblock %}</pre></div></div><div class="section" title="add.volt"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec12"/>add.volt</h3></div></div></div><p>The only important thing to notice in<a id="id504" class="indexterm"/> this template is how we render the elements. We loop through the <code class="literal">locales</code> variable that we assigned from <code class="literal">BaseController.php</code>, and for each locale, we render the element:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
&lt;h1&gt;Add&lt;/h1&gt;
&lt;hr&gt;
&lt;div class="panel panel-default"&gt;
  &lt;div class="panel-body"&gt;
    &lt;form method="post" action="{{ url('category/create') }}"&gt;
      {% for locale, name in locales %}
        &lt;h4&gt;Category ({{ name }})&lt;/h4&gt;
        &lt;div class="form-group"&gt;
          &lt;label for="category_name"&gt;Name&lt;/label&gt;{{ form.render('translations['~locale~'][category_translation_name]', {'class':'form-control'}) }}
        &lt;/div&gt;
        &lt;div class="form-group"&gt;
          &lt;label for="category_slug"&gt;Slug&lt;/label&gt;
            {{ form.render('translations['~locale~'][category_translation_slug]', {'class':'form-control'}) }}
        &lt;/div&gt;
        {{ form.render('translations['~locale~'][category_translation_lang]') }}
        {% endfor %}
        {{ form.render('save', {'value':'Save'}) }}
        {{ form.render('csrf', {'value':security.getToken()}) }}
    &lt;/form&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% endblock %}</pre></div></div><div class="section" title="edit.volt"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec13"/>edit.volt</h3></div></div></div><p>The <code class="literal">edit.volt</code> file is mostly the same <a id="id505" class="indexterm"/>as <code class="literal">add.volt</code>. We just need to change the form action to <code class="literal">{{ url('category/update') }}</code>. If you know that you're not going to develop a complex system, you can use the same file for add/edit. Personally, I prefer to use two separate files because it happened to me many times that the complexity of editing was very high compared to adding.</p></div><div class="section" title="delete.volt"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec14"/>delete.volt</h3></div></div></div><p>This is the simplest template, but for the same <a id="id506" class="indexterm"/>reason as for add/edit, I prefer to keep these files separate:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
&lt;h1&gt;Confirm deletion&lt;/h1&gt;
&lt;h3&gt;Are you sure you want to delete the selected element?&lt;/3&gt;
&lt;hr&gt;
&lt;div class="panel panel-default"&gt;
  &lt;div class="panel-body"&gt;
    &lt;form method="post" action="{{ url('category/delete/' ~ id) }}" class="form-inline"&gt;
      &lt;input type="submit" value="Yes, delete" class="btn btn-sm btn-danger btn-block"&gt;
      &lt;a href="{{ url('category/list') }}" class="btn btn-lg btn-default btn-block"&gt;Cancel&lt;/a&gt;
    &lt;/form&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% endblock %}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note21"/>Note</h3><p>If you want, and if you <a id="id507" class="indexterm"/>don't have any complex operations, you can create a <code class="literal">delete.volt</code> file in the <code class="literal">common/</code> folder and include it from there for all sections. Here is an example of how you can do so:</p><div class="informalexample"><pre class="programlisting">{% extends 'layout.volt' %}
{% block body %}
{% include 'common/delete' with {'url':url('category/delete/' ~ id)} %}
{% endblock %}</pre></div></div></div></div></div><div class="section" title="Creating the Category controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec68"/>Creating the Category controller</h2></div></div></div><p>Now that we have the<a id="id508" class="indexterm"/> code for the templates, let's create the controller. Switch to <code class="literal">modules/Backoffice/Controllers/</code> and create a new file named <code class="literal">CategoryController.php</code> with the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Backoffice\Controllers;

class CategoryController extends BaseController{
  public function indexAction() {
    return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'list']);
  }

  public function listAction() {
    $page = $this-&gt;request-&gt;getQuery('p', 'int', 1);

    try {
      $records = $this-&gt;apiGet('categories?p='.$page);

      $this-&gt;view-&gt;records = $records;
    } catch (\Exception $e) {
      $this-&gt;flash-&gt;error($e-&gt;getMessage());
    }
  }

  public function addAction() {
    $manager = $this-&gt;getDI()-&gt;get('core_category_manager');
    $this-&gt;view-&gt;form = $manager-&gt;getForm();
  }

  public function editAction($id) {
    $manager = $this-&gt;getDI()-&gt;get('core_category_manager');
    $object  = $manager-&gt;findFirstById($id);

    if (!$object) {
      $this-&gt;flashSession-&gt;error('Object not found');
      return $this-&gt;response-&gt;redirect('category/list');
    }

    $this-&gt;persistent-&gt;set('id', $id);

    $this-&gt;view-&gt;form = $manager-&gt;getForm($object,['edit' =&gt; true]);
  }

  public function createAction() {
    if (!$this-&gt;request-&gt;isPost()) {
      return $this-&gt;response-&gt;redirect('category/list');
    }

    $manager = $this-&gt;getDI()-&gt;get('core_category_manager');
    $form    = $manager-&gt;getForm();

    if ($form-&gt;isValid($this-&gt;request-&gt;getPost())) {
      try {
        $manager   = $this-&gt;getDI()-&gt;get('core_category_manager');
        $post_data = $this-&gt;request-&gt;getPost();
        $data      = array_merge($post_data, ['category_is_active' =&gt; 1]);

        $manager-&gt;create($data);
        $this-&gt;flashSession-&gt;success('Object was created successfully');

        return $this-&gt;response-&gt;redirect('category/list');
      } catch (\Exception $e) {
        $this-&gt;flash-&gt;error($e-&gt;getMessage());
        return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'add']);
      }
    } else {
      foreach ($form-&gt;getMessages() as $message) {
        $this-&gt;flash-&gt;error($message-&gt;getMessage());
      }
      return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'add', 'controller' =&gt; 'category']);
    }
  }

  public function updateAction() {
    if (!$this-&gt;request-&gt;isPost()) {
      return $this-&gt;response-&gt;redirect('category/list');
    }

    $manager    = $this-&gt;getDI()-&gt;get('core_category_manager');
    $object_id  = $this-&gt;persistent-&gt;get('id');
    $object     = $manager-&gt;findFirstById($object_id);
    $form       = $manager-&gt;getForm($object);

    if ($form-&gt;isValid($this-&gt;request-&gt;getPost())) {
      try {
        $manager = $this-&gt;getDI()-&gt;get('core_category_manager');
        $manager-&gt;update(array_merge($this-&gt;request-&gt;getPost(), ['id' =&gt; $object_id]));
        $this-&gt;flashSession-&gt;success('Object was updated successfully');

        return $this-&gt;response-&gt;redirect('category/list');
      } catch (\Exception $e) {
        $this-&gt;flash-&gt;error($e-&gt;getMessage());
        return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'edit']);
      }
    } else {
      foreach ($form-&gt;getMessages() as $message) {
        $this-&gt;flash-&gt;error($message-&gt;getMessage());
      }
      return $this-&gt;dispatcher-&gt;forward(['action' =&gt; 'edit', 'controller' =&gt; 'category']);
    }
  }
  public function deleteAction($id) {
    if ($this-&gt;request-&gt;isPost()) {
      try {
        $manager = $this-&gt;getDI()-&gt;get('core_category_manager');
        $manager-&gt;delete($id);
        $this-&gt;flashSession-&gt;success('Object has been deleted successfully');
      } catch (\Exception $e) {
        $this-&gt;flashSession-&gt;error($e-&gt;getMessage());
      }

      return $this-&gt;response-&gt;redirect('category/list');
    }

    $this-&gt;view-&gt;id = $id;
  }
}</pre></div><p>If you check out the <code class="literal">updateAction()</code> and <code class="literal">createAction()</code> methods, you will notice that we use <code class="literal">$post_data</code> as it is. We can do it this way because the form fields have the array-style name, so<a id="id509" class="indexterm"/> we send the data in exactly the same format that the manager expects.</p><p>The <code class="literal">editAction()</code> method renders the form to edit a record. Notice the second parameter from <code class="literal">$manager-&gt;getForm()</code>. It is an array containing the <code class="literal">edit</code> key and the <code class="literal">true</code> value, which we use in <code class="literal">CategoryForm.php</code>.</p></div><div class="section" title="Creating the Category manager"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec69"/>Creating the Category manager</h2></div></div></div><p>We are missing the <a id="id510" class="indexterm"/>manager. Create a new file named <code class="literal">CategoryManager.php</code> in <code class="literal">modules/Core/Managers/CategoryManager.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Managers;

use App\Core\Models\Category;
use App\Core\Models\CategoryTranslation;
use App\Core\Forms\CategoryForm;

class CategoryManager extends BaseManager{
  public function getForm($entity = null, $options = null) {
    return new CategoryForm($entity, $options);
  }

  public function find($parameters = null) {
    return Category::find($parameters);
  }

  public function findFirst($parameters = null) {
    return Category::findFirst($parameters);
  }

  public function findFirstById($id) {
    return Category::findFirstById($id);
  }

  public function create(array $input_data) {
    $default_data = array('translations' =&gt; array(
      'en' =&gt; array(
        'category_translation_name' =&gt; 'Category name',
        'category_translation_slug' =&gt; '',
        'category_translation_lang' =&gt; 'en',
      ),
    ),
    'category_is_active' =&gt; 0,);

    $data = array_merge($default_data, $input_data);

    $category = new Category();
    $category-&gt;setCategoryIsActive($data['category_is_active']);

    $categoryTranslations = array();

    foreach ($data['translations'] as $lang =&gt; $translation) {
      $tmp = new CategoryTranslation();
      $tmp-&gt;assign($translation);
      array_push($categoryTranslations, $tmp);
    }

    $category-&gt;translations = $categoryTranslations;

    return $this-&gt;save($category, 'create');
  }

  public function update(array $st_inputData) {
    $st_defaultData = array('translations' =&gt; array(
      'en' =&gt; array(
        'category_translation_name' =&gt; 'Category name',
        'category_translation_slug' =&gt; '',
        'category_translation_lang' =&gt; 'en',
      ),
    ));

    $st_data = array_merge($st_defaultData, $st_inputData);

    $object = Category::findFirstById($st_data['id']);

    if (!$object) {
      throw new \Exception('Object not found');
    }

    foreach ($st_data['translations'] as $locale =&gt; $values) {
      $translation = $object-&gt;getTranslations(["category_translation_lang = '$locale'"]);
      $translation[0]-&gt;setCategoryTranslationName($values['category_translation_name']);
      $translation[0]-&gt;setCategoryTranslationSlug($values['category_translation_slug']);
      $translation[0]-&gt;setCategoryTranslationLang($values['category_translation_lang']);
      $this-&gt;save($translation[0], 'update');
    }

    return $this-&gt;save($object, 'update');
  }

  public function delete($id) {
    $object = Category::findFirstById($id);

    if (!$object) {
      throw new \Exception('Object not found');
    }

    if (false === $object-&gt;delete()) {
      foreach ($object-&gt;getMessages() as $message) {
        $error[] = (string) $message;
      }

      throw new \Exception(json_encode($error));
    }

    return true;
  }
}</pre></div><p>We need to enable <a id="id511" class="indexterm"/>this manager. Add the following code to <code class="literal">config/managers.php</code>:</p><div class="informalexample"><pre class="programlisting">$di['core_category_manager'] = function () {
    return new \App\Core\Managers\CategoryManager();
};</pre></div><p>That's all! You can now access <code class="literal">http://www.learning-phalcon.localhost/backoffice/category/list</code> and you should see something similar to this:</p><div class="mediaobject"><img src="graphics/B03522_07_06.jpg" alt="Creating the Category manager"/></div><p>If you don't have any <a id="id512" class="indexterm"/>records, click on the <span class="strong"><strong>+ New</strong></span> button to create a new category. This action will render the template for <code class="literal">add.volt</code> and you will see the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_07_07.jpg" alt="Creating the Category manager"/></div><p>This is it! You can <a id="id513" class="indexterm"/>check out the source code for this chapter and play with the API with different categories. Note that the API documentation is always available in <code class="literal">docs/api/index.html</code>.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec49"/>Summary</h1></div></div></div><p>In this chapter, we developed a functional CRUD for hashtags and categories. You learned how to make API calls and render form elements dynamically.</p><p>In the next chapter, we will focus on completing the <code class="literal">Backoffice</code> module (developing CRUD for articles and users). We will continue to develop this module by writing code for the user and article CRUD.</p></div></body></html>