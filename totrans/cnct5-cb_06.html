<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Creating CRUD Interfaces"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Creating CRUD Interfaces</h1></div></div></div><p>In this chapter we will cover the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating controller files for single pages on the dashboard</li><li class="listitem" style="list-style-type: disc">Creating view files for single pages on the dashboard</li><li class="listitem" style="list-style-type: disc">Adding single pages to the dashboard</li><li class="listitem" style="list-style-type: disc">Creating a form to create items</li><li class="listitem" style="list-style-type: disc">Saving data to the database from a controller</li><li class="listitem" style="list-style-type: disc">Creating a view to display a list of database items</li><li class="listitem" style="list-style-type: disc">Adding editing capabilities to create a form</li><li class="listitem" style="list-style-type: disc">Creating a delete action</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec109"/>Introduction</h1></div></div></div><p>One of the features that has made concrete5 such an increasingly popular choice as a content management system is the fact that it allows developers to customize it quickly and easily. A common task when customizing content management systems is to create customized interfaces to allow site editors edit special content in a consistent manner.</p><p>Consider a website that manages a list of books in the database. Sure, a site editor could simply maintain this list as a typical block of content, but this can be tedious, and the results aren't guaranteed to be consistent. This is where creating CRUD interfaces can be beneficial.</p><p>CRUD (short for create, read, <a id="id411" class="indexterm"/>update, and delete) interfaces can easily be added to concrete5 to allow users to easily manage custom data in the database. In this chapter, we will learn how to create CRUD interfaces in the concrete5 dashboard. Combining the different recipes in this chapter will result in a fully functional CRUD to manage blog posts.</p><p>CRUD interfaces largely revolve around <a id="id412" class="indexterm"/>
<span class="strong"><strong>single pages</strong></span>. Single pages in concrete5 are just like regular pages, except that they can have a PHP controller file and a separate view file, allowing for advanced functionality. This allows developers to use MVC conventions and keep their code organized. Single pages are also considered to be more permanent than regular pages, as they aren't added or removed as frequently.</p><div class="section" title="A note about the data in this chapter"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec383"/>A note about the data in this chapter</h2></div></div></div><p>The chapter will revolve around managing simple blog posts in the database. To work with this data, execute the following SQL code on your database. The code will also be available for download on the book's website.</p><div class="informalexample"><pre class="programlisting">CREATE TABLE BlogPosts (
  id int(11) unsigned NOT NULL AUTO_INCREMENT,
  title varchar(255) NOT NULL DEFAULT '',
  content longtext NOT NULL,
  post_date datetime NOT NULL,
  PRIMARY KEY (id)
);
INSERT INTO BlogPosts (id, title, content, post_date)
VALUES
  (1,'Hello World','This is my first post!','2013-05-01 13:05:00'),
  (2,'Another Sample Post','Some more great content.','2013-05-10 14:42:00');</pre></div></div></div></div>
<div class="section" title="Creating controller files for single pages on the dashboard"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec110"/>Creating controller files for single pages on the dashboard</h1></div></div></div><p>The first step in creating single <a id="id413" class="indexterm"/>pages for use on the dashboard is to create the controller files for each page. Since we will be creating pages to <a id="id414" class="indexterm"/>add, edit, and list the blog posts, we will need to add two single pages to the dashboard, a default view (which will list the blog posts) and an add view (which will be a form to add and edit posts).</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec384"/>Getting ready</h2></div></div></div><p>The names of files and directories are important; concrete5 will need them to match up with the path that displays in the URL of the site. For example, if we want our list of blog posts to appear at <code class="literal">http://example.com/dashboard/posts</code>, we will have to be conscious of that fact when naming files and classes. In this recipe, we will add single pages to <code class="literal">/dashboard/posts</code> and <code class="literal">/dashboard/posts/add</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec385"/>How to do it...</h2></div></div></div><p>The steps for creating controller files for simple pages on the dashboard are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Using your operating system's file manager (or your favorite FTP tool or text editor), create a <a id="id415" class="indexterm"/>directory in <code class="literal">/controllers</code> called <code class="literal">dashboard/</code>.</li><li class="listitem">Now, add a file called <code class="literal">posts.php</code>.</li><li class="listitem">Next, add a new directory <a id="id416" class="indexterm"/>called <code class="literal">posts/</code> in <code class="literal">/controllers/dashboard</code>.</li><li class="listitem">Add the controller file for the add/edit form in <code class="literal">/controllers/dashboard/posts/add.php</code>.</li><li class="listitem">Your files and directories should look like the following screenshot:<div class="mediaobject"><img src="graphics/4548_06_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Open the <code class="literal">/controllers/dashboard/posts.php</code> file in your preferred code editor.</li><li class="listitem">Declare the controller class, extending the core controller class, as shown in the following code snippet. Save this file and close it.<div class="informalexample"><pre class="programlisting">class DashboardPostsController extends Controller {
}</pre></div></li><li class="listitem">Open the file in <code class="literal">/controllers/dashboard/posts/add.php</code>.</li><li class="listitem">Declare the class for <a id="id417" class="indexterm"/>the form <a id="id418" class="indexterm"/>controller, being sure to extend the core controller as well, as shown in the following code snippet. Close this file and save it.<div class="informalexample"><pre class="programlisting">class DashboardPostsAddController extends Controller {
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec386"/>How it works...</h2></div></div></div><p>concrete5 makes use of the convention over configuration concept when it comes to single pages. Developers simply have to remember how concrete5 expects files to appear and then concrete5 will do all of the work in terms of loading classes and instantiating them. As a result, file and directory names, as well as the class names of the controllers are important. The files we have created here will (eventually) be available at <code class="literal">http://example.com/dashboard/posts</code> and <code class="literal">http://example.com/dashboard/posts/add</code>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec387"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating view files for single pages on the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding single pages to the dashboard</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Creating view files for single pages on the dashboard"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec111"/>Creating view files for single pages on the dashboard</h1></div></div></div><p>Single pages <a id="id419" class="indexterm"/>need <a id="id420" class="indexterm"/>both controller and view files. Adhering to MVC design principles dictates that the presentation code (HTML) should be separate from the controller logic. Adding view files is very similar to adding controllers, which we learned in the previous recipe.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec388"/>Getting ready</h2></div></div></div><p>Just how it was when we added controllers, the file and directory names are important here as well.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec389"/>How to do it...</h2></div></div></div><p>The steps for creating <a id="id421" class="indexterm"/>view <a id="id422" class="indexterm"/>files for simple pages are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new directory in <code class="literal">/single_pages</code> called <code class="literal">dashboard/</code>.</li><li class="listitem">Add a file called <code class="literal">posts.php</code> in <code class="literal">/single_pages/dashboard/posts.php</code>.</li><li class="listitem">Add a directory called <code class="literal">posts/</code> in <code class="literal">/single_pages/dashboard</code>.</li><li class="listitem">Now, create a file called <code class="literal">add.php</code> in <code class="literal">/single_pages/dashboard/posts/</code>.</li><li class="listitem">The contents of your <code class="literal">single_pages/</code> directory should look like the following screenshot:<div class="mediaobject"><img src="graphics/4548_06_02.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec390"/>How it works...</h2></div></div></div><p>The file and <a id="id423" class="indexterm"/>directory names <a id="id424" class="indexterm"/>should conform to how the pages will appear in the sitemap and in the URLs. The files and directories in this recipe would produce single pages at <code class="literal">http://example.com/dashboard/posts</code> and <code class="literal">http://example.com/dashboard/posts/add</code>. The make it PHP files that we added do not need to contain anything yet.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec391"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating controller files for single pages on the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding single pages to the dashboard</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Adding single pages to the dashboard"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec112"/>Adding single pages to the dashboard</h1></div></div></div><p>Once the controller and <a id="id425" class="indexterm"/>
<a id="id426" class="indexterm"/>view files have been created in the concrete5 filesystem, there is still one more step that needs to be performed before we can visit these pages in the browser and begin adding custom CRUD logic. The pages must be added in the concrete5 sitemap so that the CMS knows the pages exist and can direct requests to them.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec392"/>Getting ready</h2></div></div></div><p>Before you can add single pages to the site, the view and controller files must exist in the filesystem. Refer to the previous two recipes on how to do this correctly.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec393"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to the single pages manager of the dashboard by visiting <code class="literal">/dashboard/pages/single</code> (you may be asked to log in). The page will look like the following screenshot:<div class="mediaobject"><img src="graphics/4548_06_03.jpg" alt="How to do it..."/></div></li><li class="listitem">Type the path of the posts page (<code class="literal">/dashboard/posts</code>) and click on <span class="strong"><strong>Add</strong></span>.</li><li class="listitem">Type the path of the add page (<code class="literal">/dashboard/posts/add</code>) and click on <span class="strong"><strong>Add</strong></span>.</li><li class="listitem">The pages have now been added and can be viewed by visiting their respective URLs.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec394"/>How it works...</h2></div></div></div><p>concrete5 will verify whether the controller and view files exist, and then will add the new single page to the sitemap. <a id="id427" class="indexterm"/>
<a id="id428" class="indexterm"/>This makes the page available to access via URL, and if the page is stored on the dashboard, concrete5 will automatically perform access control checks on the user.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec395"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating controller files for single pages on the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating view files for single pages on the dashboard</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Creating a form to create items"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec113"/>Creating a form to create items</h1></div></div></div><p>Now that we know how to <a id="id429" class="indexterm"/>
<a id="id430" class="indexterm"/>add bare bones single pages to the dashboard, we can create the real CRUD interfaces. The first interface that we will program is the form for creating and editing blog posts.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec396"/>Getting ready</h2></div></div></div><p>First, you will need to make sure that you know how to add controller and view files for the single pages. Refer to the first three recipes in this chapter for guidance on how to do that.</p><p>Our blog posts in this chapter will have three fields: <code class="literal">title</code>, <code class="literal">content</code>, and <code class="literal">post date</code>. The <code class="literal">title</code> and <code class="literal">content</code> fields will be set by the user with the form in this recipe, and the <code class="literal">post date</code> will be set by our controller once the form has been submitted.</p><p>To keep this chapter on point, much of the irrelevant HTML surrounding our form has been omitted. Refer to the book's website to see the complete HTML code if you are having trouble with the markup of your form.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec397"/>How to do it...</h2></div></div></div><p>The steps for creating a form to create items are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/single_pages/dashboard/posts/add.php</code> in your preferred code editor.</li><li class="listitem">We will make use of the form helper, so load that helper at the top of the file.<div class="informalexample"><pre class="programlisting">&lt;?php $form = Loader::helper('form') ?&gt;</pre></div></li><li class="listitem">Wrap everything in a <code class="literal">div</code> tag with the class of <code class="literal">ccm-ui</code> so our form will take advantage of the Bootstrap styles included in concrete5.<div class="informalexample"><pre class="programlisting">&lt;div class="ccm-ui"&gt;</pre></div></li><li class="listitem">Use the Dashboard helper to output the appropriate HTML for the header of the form.<div class="informalexample"><pre class="programlisting">&lt;?php
   $dashboard = Loader::helper('concrete/dashboard');
   echo $dashboard-&gt;getDashboardPaneHeader('Title');
?&gt;</pre></div></li><li class="listitem">Set the form's <code class="literal">action</code> to the <code class="literal">save</code> function of the controller and make sure it is sending the data as a <code class="literal">POST</code> request.<div class="informalexample"><pre class="programlisting">&lt;form action="&lt;?php echo $this-&gt;action('save') ?&gt;" method="POST"&gt;</pre></div></li><li class="listitem">Echo the input for the <code class="literal">title</code> field.<div class="informalexample"><pre class="programlisting">&lt;?php echo $form-&gt;text('title') ?&gt;</pre></div></li><li class="listitem">Echo the input for the <code class="literal">content</code> field.<div class="informalexample"><pre class="programlisting">&lt;?php echo $form-&gt;textarea('content') ?&gt;</pre></div></li><li class="listitem">Create the submit button.<div class="informalexample"><pre class="programlisting">&lt;input class="btn btn-primary" type="submit" value="Save"&gt;</pre></div></li><li class="listitem">Create a cancel button and have it take the user back to the posts listing when clicked.<div class="informalexample"><pre class="programlisting">&lt;a href="&lt;?php echo $this-&gt;url('/dashboard/posts') ?&gt;" class="btn"&gt;Cancel&lt;/a&gt;</pre></div></li><li class="listitem">Save the <code class="literal">add.php</code> view <a id="id431" class="indexterm"/><a id="id432" class="indexterm"/>file, as it is time to move to the controller.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec398"/>How it works...</h2></div></div></div><p>The <code class="literal">add.php</code> view file is an interface for a concrete5 <code class="literal">View</code> object. As a result, the <code class="literal">$this</code> keyword is set to an instance of the <code class="literal">View</code> class. Using functions such as <code class="literal">action</code> and <code class="literal">url</code> on the <code class="literal">$this</code> keyword will generate URLs that are aware of the concrete5 site's settings, such as if the site has pretty URLs enabled, or if the site is located in a sub-directory.</p><p>Using the Form helper, we can quickly output the fields that we need to display on the form. The Form helper will be even more useful when we add the ability to edit data, which will happen later in this chapter.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec399"/>There's more...</h2></div></div></div><p>As mentioned at the beginning of this chapter, most of the boilerplate HTML surrounding the form here was left out of the chapter. Please download the complete source code from the book's website if you wish to see how the entire page is structured.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec400"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating controller files for single pages on the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating view files for single pages on the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding single pages to the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Loading a helper class</em></span> recipe in <a class="link" href="ch04.html" title="Chapter 4. Using the Core Helpers">Chapter 4</a>, <span class="emphasis"><em>Using the Core Helpers</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating custom forms with the Form helper</em></span> recipe in <a class="link" href="ch04.html" title="Chapter 4. Using the Core Helpers">Chapter 4</a>, <span class="emphasis"><em>Using the Core Helpers</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Saving data to the database from a controller</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Saving data to the database from a controller"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec114"/>Saving data to the database from a controller</h1></div></div></div><p>Once you have the HTML (and related helper PHP) for your form created, it is time to make that form do something. <a id="id433" class="indexterm"/>
<a id="id434" class="indexterm"/>In the previous recipe, we set the action of our HTML form to the <code class="literal">save</code> action of the <a id="id435" class="indexterm"/>controller. In this recipe, we will write the code of that save action, so that our blog posts will be stored in the database once the save button is clicked.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec401"/>Getting ready</h2></div></div></div><p>This recipe is continuing the chapter's theme of creating a CRUD interface for managing simple blog posts. Make sure the previous recipes in this chapter have been completed before working on this part. Also, make sure that the database table specified in the chapter introduction exists.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec402"/>How to do it...</h2></div></div></div><p>The steps for saving data to the database from a controller are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new model in <code class="literal">/models/blog_post.php</code>.</li><li class="listitem">Open <code class="literal">/models/blog_post.php</code> in your code editor and create the <code class="literal">BlogPost</code> class.<div class="informalexample"><pre class="programlisting">class BlogPost extends Model {
   var $_table = 'BlogPosts';
}</pre></div></li><li class="listitem">Open <code class="literal">/controllers/dashboard/posts/add.php</code> in your preferred code or text editor.</li><li class="listitem">Define the <code class="literal">save</code> function.<div class="informalexample"><pre class="programlisting">public function save() {
}</pre></div></li><li class="listitem">In the <code class="literal">save</code> function, load the <code class="literal">BlogPost</code> model.<div class="informalexample"><pre class="programlisting">Loader::model('blog_post');</pre></div></li><li class="listitem">Create a new instance of the <code class="literal">BlogPost</code> model.<div class="informalexample"><pre class="programlisting">$post = new BlogPost();</pre></div></li><li class="listitem">Set the <code class="literal">title</code> to the value that was submitted in the HTTP <code class="literal">POST</code> request.<div class="informalexample"><pre class="programlisting">$post-&gt;title = $this-&gt;post('title');</pre></div></li><li class="listitem">Set the <code class="literal">content</code> to the value that was submitted in the form <code class="literal">POST</code> request.<div class="informalexample"><pre class="programlisting">$post-&gt;content = $this-&gt;post('content');</pre></div></li><li class="listitem">Set the <code class="literal">post date</code> to the current date/time.<div class="informalexample"><pre class="programlisting">$post-&gt;post_date = date('YYYY-MM-DD H:i:s');</pre></div></li><li class="listitem">Save the model.<div class="informalexample"><pre class="programlisting">$post-&gt;save();</pre></div></li><li class="listitem">Redirect the user to the listing of the posts, which will indicate that the save was successful.<div class="informalexample"><pre class="programlisting">$this-&gt;redirect('/dashboard/posts');</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec403"/>How it works...</h2></div></div></div><p>The <code class="literal">save</code> function is run whenever an <a id="id436" class="indexterm"/>HTTP request (<code class="literal">GET</code> or <code class="literal">POST</code>) is made to <code class="literal">/dashboard/posts/add/save</code>, <a id="id437" class="indexterm"/>
<a id="id438" class="indexterm"/>and that is exactly where the HTML form sends its data when it is submitted. We load the <code class="literal">BlogPost</code> model and set each of its attributes, finally saving the new item to the database and redirecting the user to the post listing.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec404"/>There's more...</h2></div></div></div><p>In real life usage, you would want to use the Validation Helper to make sure that users have filled out the form correctly and that both the title and content fields were not empty.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec405"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating controller files for single pages on the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating view files for single pages on the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding single pages to the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a form to create items</em></span> recipe</li><li class="listitem" style="list-style-type: disc"><a class="link" href="ch05.html" title="Chapter 5. Working with Databases and Models">Chapter 5</a>, <span class="emphasis"><em>Working with Databases and Models</em></span></li></ul></div></div></div>
<div class="section" title="Creating a view to display a list of database items"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec115"/>Creating a view to display a list of database items</h1></div></div></div><p>Now that we can add <a id="id439" class="indexterm"/>items to our <a id="id440" class="indexterm"/>database, it sure would be nice to have an interface to show what items already exist in our table, and to add, edit, and delete those items from there.</p><p>In this recipe, we will handle the Read aspect of CRUD interfaces by creating an HTML table that lists all of the blog posts stored in the database, as well as provide buttons to edit and delete those items.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec406"/>Getting ready</h2></div></div></div><p>As with the rest of the recipes in this chapter, we will be dealing with simple blog posts. Make sure that the previous recipes have been completed prior to working with this recipe, otherwise there may be a step missing!</p><p>Some of the boilerplate HTML in this recipe has been omitted from this chapter in order to keep the focus on the code <a id="id441" class="indexterm"/>that is important to know. The website for this book does contain a complete source code <a id="id442" class="indexterm"/>download that will allow you to explore the entire HTML code in this interface.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec407"/>How to do it...</h2></div></div></div><p>The steps for creating a view to display a list of database items are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/controllers/dashboard/posts.php</code> in your preferred text editor.</li><li class="listitem">Define the <code class="literal">view</code> function, which will automatically get run when the page loads.<div class="informalexample"><pre class="programlisting">public function view() {
}</pre></div></li><li class="listitem">In the <code class="literal">view</code> function, load the <code class="literal">BlogPost</code> model.<div class="informalexample"><pre class="programlisting">Loader::model('blog_post');</pre></div></li><li class="listitem">Create a new instance of <code class="literal">BlogPost</code>.<div class="informalexample"><pre class="programlisting">$post = new BlogPost();</pre></div></li><li class="listitem">Find all of the blog posts by passing a truthy condition (1=1) to the <code class="literal">find</code> function.<div class="informalexample"><pre class="programlisting">$posts = $post-&gt;find('1=1');</pre></div></li><li class="listitem">Set a variable called <code class="literal">$posts</code> on the view that is equal to the results of the model query.<div class="informalexample"><pre class="programlisting">$this-&gt;set('posts', $posts);</pre></div></li><li class="listitem">Save the controller file.</li><li class="listitem">Open the posts index view which is located at <code class="literal">/single_pages/dashboard/posts.php</code></li><li class="listitem">Make sure to create a <code class="literal">div</code> tag that has a class of <code class="literal">ccm-ui</code> in order to make use of the built-in Bootstrap styles.<div class="informalexample"><pre class="programlisting">&lt;div class="ccm-ui"&gt;</pre></div></li><li class="listitem">Use the Dashboard helper to generate the HTML for the header section.<div class="informalexample"><pre class="programlisting">&lt;?php
  $dashboard = Loader::helper('concrete/dashboard');
  echo $dashboard-&gt;getDashboardPaneHeader('Blog Posts');
?&gt;</pre></div></li><li class="listitem">Create a table to hold the posts.<div class="informalexample"><pre class="programlisting">&lt;table class="table table-striped table-bordered"&gt;</pre></div></li><li class="listitem">We will need headings for the four columns we will be displaying.<div class="informalexample"><pre class="programlisting">&lt;th&gt;ID&lt;/th&gt;
&lt;th&gt;Title&lt;/th&gt;
&lt;th&gt;Post Date&lt;/th&gt;
&lt;th&gt;Actions&lt;/th&gt;</pre></div></li><li class="listitem">Loop through the <code class="literal">$posts</code> variable that was set in the controller and output each row of posts. The last <a id="id443" class="indexterm"/><a id="id444" class="indexterm"/>column will contain the buttons to edit or delete each post.<div class="informalexample"><pre class="programlisting">&lt;?php foreach ($posts as $post): ?&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;?php echo $post-&gt;id ?&gt;&lt;/td&gt;
    &lt;td&gt;&lt;?php echo $post-&gt;title ?&gt;&lt;/td&gt;
    &lt;td&gt;&lt;?php echo date('DATE_APP_GENERIC_MDY_FULL,strtotime($post-&gt;post_date)) ?&gt;&lt;/td&gt;
    &lt;td&gt;
      &lt;a href="&lt;?php echo $this-&gt;url('/dashboard/posts/add/edit/', $post-&gt;id) ?&gt;" class="btn"&gt;Edit&lt;/a&gt;
      &lt;a href="&lt;?php echo $this-&gt;action('/dashboard/posts/delete/', $post-&gt;id) ?&gt;" class="btn danger"&gt;Delete&lt;/a&gt;
    &lt;/td&gt;
   &lt;/tr&gt;
&lt;?php endforeach; ?&gt;</pre></div></li><li class="listitem">Save the view file.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec408"/>How it works...</h2></div></div></div><p>When an HTTP <code class="literal">GET</code> or <code class="literal">POST</code> request is made to <code class="literal">/dashboard/posts/</code>, the <code class="literal">view</code> function on the posts controller is automatically executed. In this function, we load data from the <code class="literal">BlogPost</code> model, and then send that data to the view. This allows us to keep the real business logic out of our view files and create more reusable and maintainable code.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec409"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating controller files for single pages on the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating view files for single pages on the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding single pages to the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a form to create items</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Saving data to the database from a controller</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Adding editing capabilities to create a form"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec116"/>Adding editing capabilities to create a form</h1></div></div></div><p>Now that we have added the <a id="id445" class="indexterm"/>ability to create and view items, it is time for the third facet of CRUD interfaces: editing. In this recipe, we will implement the logic <a id="id446" class="indexterm"/>necessary to be able to edit items using the form that we created in the recipe <span class="emphasis"><em>Creating a form to create item</em></span>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec410"/>Getting ready</h2></div></div></div><p>As with the rest of the recipes in this chapter, this recipe revolves around the concept of managing simple blog posts, each with a title, a block of content text, and a post date. Make sure that the previous recipes have been completed before embarking on this latest journey! The MySQL data for this recipe is also included at the beginning of this chapter as well as on the book's website.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec411"/>How to do it...</h2></div></div></div><p>The steps for adding editing capabilities to create a form are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the controller file for the add form (located at <code class="literal">/controllers/dashboard/posts/add.php</code>).</li><li class="listitem">Declare the <code class="literal">edit</code> function, with a single parameter for the <code class="literal">ID</code> parameter of the post to edit.<div class="informalexample"><pre class="programlisting">public function edit($id) {
}</pre></div></li><li class="listitem">In the <code class="literal">edit</code> function, load the <code class="literal">blog post</code> model.<div class="informalexample"><pre class="programlisting">Loader::model('blog_post');</pre></div></li><li class="listitem">Create a new instance of the <code class="literal">model</code> class.<div class="informalexample"><pre class="programlisting">$post = new BlogPost();</pre></div></li><li class="listitem">Load the <code class="literal">post</code> object using the <code class="literal">ID</code> parameter that was passed in via the edit URL.<div class="informalexample"><pre class="programlisting">$post-&gt;load('id = ?', $id);</pre></div></li><li class="listitem">Set the <code class="literal">post</code> <a id="id447" class="indexterm"/>variable to the view, casting the <code class="literal">post</code> object into an array to prevent the add form from breaking when there is no post object set.<div class="informalexample"><pre class="programlisting">$this-&gt;set($post, (array) $post);</pre></div></li><li class="listitem">In the <code class="literal">save</code> function <a id="id448" class="indexterm"/>of the controller, add the following code just below <code class="literal">$post = new BlogPost()</code>;<div class="informalexample"><pre class="programlisting">if ($this-&gt;post('id')) {
  $post-&gt;load('id = ?', $this-&gt;post('id'));
}</pre></div></li><li class="listitem">Change the <code class="literal">save</code> function call to use the <code class="literal">replace</code> function.<div class="informalexample"><pre class="programlisting">$post-&gt;replace();</pre></div></li><li class="listitem">Save the controller file.</li><li class="listitem">Open the <code class="literal">view</code> file, located at <code class="literal">/single_pages/dashboard/posts/add.php</code></li><li class="listitem">Add a second <a id="id449" class="indexterm"/>parameter <a id="id450" class="indexterm"/>to the <code class="literal">title</code> input that will populate the field with the post's title if it exists.<div class="informalexample"><pre class="programlisting">&lt;?php echo $form-&gt;text('title', $post['title']) ?&gt;</pre></div></li><li class="listitem">Add a second parameter to the <code class="literal">content</code> input that will pre-fill the contents when the form is in edit mode.<div class="informalexample"><pre class="programlisting">&lt;?php echo $form-&gt;textarea('content', $post['content']) ?&gt;</pre></div></li><li class="listitem">Just below the closing table tag, add the following snippet to add a hidden input when the form is in edit mode:<div class="informalexample"><pre class="programlisting">&lt;?php if ($post['id']): ?&gt;
   &lt;?php echo $form-&gt;hidden('id', $post['id']) ?&gt;
&lt;?php endif; ?&gt;</pre></div></li><li class="listitem">Save the <code class="literal">view</code> file.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec412"/>How it works...</h2></div></div></div><p>When a request is made to the URL <code class="literal">/dashboard/posts/add/edit/&lt;id&gt;</code>, concrete5 will automatically fire the <code class="literal">edit</code> function of the controller and pass the <code class="literal">ID</code> parameter as the first parameter. Then we can load the corresponding model and send the data to the view. We need to cast the post data into an array so that the form will still work even if it is not in edit mode.</p><p>We also add a little snippet to the <code class="literal">save</code> function to make sure that if there is an ID included in the <code class="literal">POST</code> request, then we need to save an existing post rather than create a new one. By changing the <code class="literal">save</code> function call to <code class="literal">replace</code>, we are telling the model to create a brand new record if one does not exist, otherwise it will simply update the existing model.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec413"/>There's more...</h2></div></div></div><p>In real life usage, it would <a id="id451" class="indexterm"/>be smart to <a id="id452" class="indexterm"/>check the <code class="literal">ID</code> parameter in the edit function to make sure that it is set. Also, it would be a good idea to handle requests in which a post is loaded that doesn't exist.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec414"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating controller files for single pages on the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating view files for single pages on the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding single pages to the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a form to create items</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Saving data to the database from a controller</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Creating a delete action"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec117"/>Creating a delete action</h1></div></div></div><p>The final pillar of the CRUD <a id="id453" class="indexterm"/>interface is the ability to delete items. In concrete5, this is a little bit more simple than the other CRUD tasks, as deleting items typically doesn't require a visual component. In this recipe, we will delete a blog post and simply redirect the user back to the index view of the posts.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec415"/>Getting ready</h2></div></div></div><p>We will continue working with the concept of simple blog posts. This recipe assumes that you have completed the previous recipes in this chapter and have the appropriate database tables created.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec416"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the controller file located at <code class="literal">/controllers/dashboard/posts.php</code>.</li><li class="listitem">Declare a new function called <code class="literal">delete</code> that has one parameter, <code class="literal">$id</code>.<div class="informalexample"><pre class="programlisting">public function delete($id) {
}</pre></div></li><li class="listitem">In the <code class="literal">delete</code> function, load the <code class="literal">blog posts</code> model.<div class="informalexample"><pre class="programlisting">Loader::model('blog_post');</pre></div></li><li class="listitem">Create a new instance of the model.<div class="informalexample"><pre class="programlisting">$post = new BlogPost();</pre></div></li><li class="listitem">Load the post by its ID.<div class="informalexample"><pre class="programlisting">$post-&gt;load('id = ?', $id);</pre></div></li><li class="listitem">Delete the post by calling the <code class="literal">delete</code> function.<div class="informalexample"><pre class="programlisting">$post-&gt;delete();</pre></div></li><li class="listitem">Redirect the user back to the posts index.<div class="informalexample"><pre class="programlisting">$this-&gt;redirect('/dashboard/posts');</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec417"/>How it works...</h2></div></div></div><p>When a request is made to <code class="literal">/dashboard/posts/delete/&lt;id&gt;</code>, the <code class="literal">delete</code> function of the posts controller is executed. In this <a id="id454" class="indexterm"/>controller, we simply load a post by its ID, and then call the built-in <code class="literal">delete</code> function of the model. Then, we just redirect users back to the post listing.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec418"/>There's more...</h2></div></div></div><p>It would be wise to verify that the post with the specified ID exists before deleting. Also, most users would expect some kind of confirmation dialogue before performing such a destructive action, so that would be a nice thing to add in a real life situation.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec419"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating controllers for single pages on the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating view files for single pages on the dashboard</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding single pages to the dashboard</em></span> recipe</li></ul></div></div></div></body></html>