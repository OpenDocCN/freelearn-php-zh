<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Ajax"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Ajax</h1></div></div></div><p>To some, Ajax is the name of a Dutch soccer team out of Amsterdam. To web developers, Ajax (also <span class="strong"><strong>Asynchronous JavaScript And XML</strong></span> (<span class="strong"><strong>AJAX</strong></span>)) is the collective name for a number of web techniques used on the client side to asynchronously retrieve data from the server. I started this chapter with this heavily <a id="id613" class="indexterm"/>loaded sentence because I always like to explain an acronym when I use it.</p><p>The A (asynchronous) is almost always present, the J (JavaScript) is a sure thing, as we are talking client side, but the X (XML) is not mandatory. Usually <span class="strong"><strong>JSON</strong></span> is used as the data format between client and server. We will discuss both XML and JSON in <a class="link" href="ch10.html" title="Chapter 10. XML and JSON">Chapter 10</a>, <span class="emphasis"><em>XML and JSON</em></span>. In our examples, we will use the already familiar HTML format instead.</p><p>Using these techniques, a website can be modified after data is retrieved in the background, and parts of the screen can be updated without having to load a brand new page. This way, our website will begin to behave more like a desktop application, so we can safely call it a web application.</p><p>Unless properly managed, Ajax has its drawbacks. As it is all implemented using JavaScript, the desired behavior will not occur if JavaScript is switched off. In 2015, this should not be a concern. There are other drawbacks, but not without solutions to address them. That we will do, without delay, in <a class="link" href="ch09.html" title="Chapter 9. The History API – Not Forgetting Where We Are">Chapter 9</a>, <span class="emphasis"><em>The History API–Not Forgetting Where We Are</em></span>.</p><div class="section" title="XMLHttpRequest"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec64"/>XMLHttpRequest</h1></div></div></div><p>The Ajax technologies rely on the <a id="id614" class="indexterm"/>
<span class="strong"><strong>XMLHttpRequest</strong></span> (<span class="strong"><strong>XHR</strong></span>) object that can be used in JavaScript code. It is used to send HTTP or HTTPS requests to a web server and load the server response data back into the script. As is the case with many other web technologies, implementations of XMLHttpRequest differ in various browsers. Here, again, jQuery will come to the rescue. By using jQuery and the Ajax related methods it comes with, those incompatibilities do not have<a id="id615" class="indexterm"/> any cause for concern.</p></div></div>
<div class="section" title="Ajax and jQuery"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec65"/>Ajax and jQuery</h1></div></div></div><p>There are several <a id="id616" class="indexterm"/>methods that come with jQuery that you can use to make what we like to refer to as Ajax calls. The most complete one is, not surprisingly, called .<code class="literal">ajax()</code>. We<a id="id617" class="indexterm"/> will start with a simple one.</p><p>Many Ajax-based sites are<a id="id618" class="indexterm"/> like that—an omnipresent menu on top, some other navigation in a footer at the bottom, and a center piece with constantly changing content. We cannot stress early enough that when we use Ajax the way we describe here, and our website is called <code class="literal">index.php</code>, no matter how often the content of the center piece changes, our current web page will still be <code class="literal">index.php</code>.</p><p>So, let's assume that we have a website with a main menu on top, and some basic content in the middle, inside a <code class="literal">&lt;div&gt;</code> with the id <code class="literal">varicontent</code>. It does not really matter what is inside <code class="literal">#varicontent</code> on the initial load—it is typically a nice photo banner—this is the chapter that explains what goes on when we change its content and replace it with something different.</p><div class="section" title="jQuery Ajax methods"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec112"/>jQuery Ajax methods</h2></div></div></div><p>We will walk you through some of the most useful jQuery methods to use Ajax, from the very simple to more <a id="id619" class="indexterm"/>complex. Imagine a corporate website of a company that organizes seminars and exhibits. The home page, and all pages for that matter, as we never leave the page, contains a menu that visitors can use to navigate and select the topic of their choice.</p><p>So, let's show some code first - just a snippet to illustrate how it is done:</p><div class="informalexample"><pre class="programlisting">&lt;div id="mainmenu"&gt;
&lt;ul class="dropdown"&gt;
&lt;li&gt;&lt;a class="htmla" href="oldsite/information.html"
id="information" &gt;Information&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a id="seminars" class="htmla agenda" href="oldsite/seminars.php"&gt;
Seminars&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="htmla" id="exhibits"  href="oldsite/exhibits.php"&gt;Exhibits&lt;/a&gt;&lt;/li&gt;

&lt;/ul&gt;
&lt;/div&gt;
&lt;div id="varicontent"&gt;
&lt;!-- code for things on the home page, maybe a photo banner --&gt;
&lt;/div&gt;</pre></div><div class="section" title="$.load() method"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec46"/>$.load() method</h3></div></div></div><p>We will use the <code class="literal">load()</code> method to<a id="id620" class="indexterm"/> load not an entirely new page, but exactly the HTML we need in the section of the page where we want to replace<a id="id621" class="indexterm"/> the content:</p><div class="informalexample"><pre class="programlisting">$("#mainmenu").on("click", "a.htmla", function(e){
e.preventDefault();
var topic = $(this).attr("id");
updateHTMLContent(topic);
});

function updateHTMLContent(topic) {
var loadfile = "./content/" + topic + ".html";

$('#varicontent').load(loadfile);
}</pre></div><p>In the sample code just given, we address any menu items that we have given the class <code class="literal">htmla</code>. The intent is to replace the content of what is inside <code class="literal">#varicontent</code> with the HTML that is inside a file that resides on the server. Notice that there is a <code class="literal">href</code> attribute in the example as well. We intend not to use it, but it can be present if we want a fallback plan in case JavaScript is not supported. We will readdress that when we discuss <span class="strong"><strong>progressive enhancement</strong></span>. In the<a id="id622" class="indexterm"/> example, we include a link to a file located in a folder called <code class="literal">oldsite</code>.</p><p>So, in the preceding code, we have an event handler for when an <code class="literal">&lt;a&gt;</code> tag with the class <code class="literal">htmla</code> is clicked. The first thing we do is to actually prevent users going to the link specified in the <code class="literal">href</code> tag that would cause a brand new page to be loaded. The following line takes care of that:</p><div class="informalexample"><pre class="programlisting">e.preventDefault();</pre></div><p>Instead, we are going to use the jQuery Ajax method <code class="literal">.load()</code>. We use the value of the ID of the anchor to determine what the name of the file is, and then we call the function <code class="literal">updateHTMLcontent()</code>.</p><p>Inside that function, we call <code class="literal">load()</code>, which will make the necessary Ajax calls underneath to go and fetch the contents of the file. Then, we replace <code class="literal">#varicontent &lt;div&gt;</code> with that content. Now, that part of the screen is updated, but we remain on the same page, and the rest of the screen is left intact.</p></div><div class="section" title="$.post()"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec47"/>$.post()</h3></div></div></div><p>In the previous example, all we needed to do was to load some HTML. What if we want to execute PHP code on the server to<a id="id623" class="indexterm"/> dynamically create HTML and want to insert that inside our page? This is where the <code class="literal">.ajax()</code> method fits in, and in particular, the two special cases of <code class="literal">.ajax()</code>, <code class="literal">.post()</code>, and <code class="literal">.get()</code>.</p><p>As you may have<a id="id624" class="indexterm"/> guessed, the difference is, just as with HTML forms, the way that values are passed along to the server - whether as POST variables or as GET variables. Let's use the example of the second menu item, which contains an <code class="literal">&lt;a&gt;</code> tag of the class <code class="literal">agenda</code>. Like the previous example, we first prevent the browser from loading the file that is specified in the <code class="literal">href</code> attribute. This time, we grab the value of the ID of the parent:</p><div class="informalexample"><pre class="programlisting">$("#mainmenu").on("click", "a.agenda", function(e){
e.preventDefault();
var nav = $(this).attr("id");
updateAgendaContent(nav);

});

function updateAgendaContent(nav) {

$.post("./showagendalist.php", { nav: nav},
 function(data){

$('#varicontent').replaceWith(data);

} );
}</pre></div><p>Now, we are asking the server to go and find the PHP file <code class="literal">showagendalist.php</code> on the server and pass it some values as POST variables, or just one, as in our example. The PHP code will be executed on the server and whatever it generates, we can catch inside a function. We will use this to insert inside the appropriate part of our page using the convenient JavaScript method <code class="literal">replaceWith()</code>. The default format expected back is HTML, but we can also use other formats, such as JSON and XML, which we will discuss in <a class="link" href="ch10.html" title="Chapter 10. XML and JSON">Chapter 10</a>, <span class="emphasis"><em>XML and JSON</em></span>.</p><p>Here is an example of what this PHP code could be like:</p><div class="informalexample"><pre class="programlisting">&lt;?php
$today = time();
$nav = $_POST['nav'];
switch ($nav)
{

  case "seminars":
  $sql = 'SELECT * FROM seminars;';
  break;
  .
       /* ...  */
  default:
  break;
}

$mysqli = dbConnect($host, $usr, $pwd, $dbname) ;
date_default_timezone_set('Europe/Brussels');
$mysqli-&gt;set_charset("utf8");
$htmlstring = '&lt;div id="varicontent"  &gt;&lt;div class="row"&gt;';

$result = $mysqli-&gt;query($sql);

while ($row= $result-&gt;fetch_assoc()
{

$htmlstring .= '&lt;div class="agendaentry"&gt;';
$htmlstring .=  '&lt;h5 class='title"&gt;'.$row['title'].'&lt;/h5&gt;';
$htmlstring .= '&lt;div class="summary" &gt;'.'$row['summary'].'&lt;/div&gt;';

$htmlstring .= '&lt;div class=" body"&gt;'.$row['body'].'&lt;/div&gt;';
$htmlstring .= '&lt;/div&gt;';
}

$htmlstring .= '&lt;/div&gt;';  //row
$htmlstring .= '&lt;/div&gt;'; //varicontent

echo $htmlstring;
?&gt;</pre></div><p>In the preceding PHP code, we look at the value of the single POST variable <code class="literal">$POST['nav']</code> to determine which section of the agenda the visitor has selected from the menu. The name <a id="id625" class="indexterm"/>of that section has to somehow match a table in our database. Next, we pull out all articles<a id="id626" class="indexterm"/> from our database, assuming that there is a column for <code class="literal">title</code>, stored as text, and <code class="literal">summary</code> and <code class="literal">body</code> as HTML. We then generate the entire HTML for all the articles. The final statement is an <code class="literal">echo</code> statement of the entire HTML generated.</p><p>This is a practical example to show how Ajax works, but not practical at all in a real-life application. There are two reasons why the content inside <code class="literal">#varicontent &lt;div&gt;</code> will quickly become too large: not only do we show the entire content of each article, we also show all of them.</p><p>Rather than show the entire content of each article, we should only show the title and the summary, not the<a id="id627" class="indexterm"/> body text. Inside our generated HTML, we can have an <code class="literal">&lt;input&gt;</code> of the type <code class="literal">hidden</code> to carry the ID of the article, and we then turn the title into an anchor tag so that it becomes clickable. The jQuery event handler behind this anchor <a id="id628" class="indexterm"/>will trigger another Ajax call, and our <code class="literal">#varicontent &lt;div&gt;</code> that contains a list of article titles and summaries will be replaced by the complete content of single article upon clicking. But, yet again, we remain on the same page.</p><p>Even doing this is not going to be sufficient. Once the number of articles becomes large, the length of our <code class="literal">#varicontent</code> section is going to become unpleasantly long. To overcome this, we need to apply some kind of pagination and only show a given number of articles at a time. We will discuss a framework that has a <a id="id629" class="indexterm"/>
<span class="strong"><strong>pagination</strong></span> widget in <a class="link" href="ch13.html" title="Chapter 13. Foundation – A Responsive CSS/JavaScript Framework">Chapter 13</a>, <span class="emphasis"><em>Foundation - A Responsive CSS/JavaScript Framework</em></span>. In the following sample code , we have already taken into account an extra parameter we need, <code class="literal">offset</code>. The updated code to accommodate these changes follows later. We left out the <code class="literal">switch</code> statement in the PHP code. The only difference in the existing JavaScript code is that now <code class="literal">UpdateAgendaContent()</code> will take an extra argument for the offset. We only include the extra bits for the additional Ajax call.</p><p>The updated PHP is this snippet:</p><div class="informalexample"><pre class="programlisting">&lt;?php
$nav = $_POST['nav'];
if (isset($_POST['offset']))
{
$offset = $_POST['offset'];
}
else {
  $offset = 0;
}

$sql = 'SELECT * FROM seminars  LIMIT '.$offset.',10;';
$mysqli = dbConnect($host, $usr, $pwd, $dbname) ;
date_default_timezone_set('Europe/Brussels');
$mysqli-&gt;set_charset("utf8");

$htmlstring = '&lt;div id="varicontent"  &gt;&lt;div class="row"&gt;;
$result = $mysqli-&gt;query($sql);

while ($row = $result-&gt;fetch_assoc())
{

$htmlstring .= '&lt;div class="agendaentry"&gt;';

$htmlstring .=  '&lt;h5 class="title"&gt;&lt;a class="aid"&gt;'.$row['title'].'&lt;input type="hidden" name="aid" value="'.$row['a_id'].'"&gt;&lt;/input&gt;&lt;/a&gt;&lt;/h5&gt;';
$htmlstring .= 
'&lt;div class="summary" &gt;'.$row['summary'].'&lt;/div&gt;';
$htmlstring .= '&lt;/div&gt;'; // agendaentry
}
$htmlstring .= '&lt;/div&gt;';  //row
$htmlstring .= '&lt;/div&gt;'; //varicontent
echo $htmlstring;
?&gt;</pre></div><p>Additional<a id="id630" class="indexterm"/> JavaScript code:</p><div class="informalexample"><pre class="programlisting">function updateAgendaContent(nav, offset) {

$.post("./showagendalist.php", { nav: nav, offset:offset}
 function(data){

  $('#varicontent').replaceWith(data);
  $("#varicontent").on("click", "a.aid", function(){
  var aid = $(this).parent().find('input').val();
  updateArticleContent (aid);
  });

} );
}

function updateArticleContent (aid)
{
 $.post("./showarticle.php", { aid: aid },
  function(data){
  $('#varicontent').replaceWith(data);

 } );


}</pre></div><p>Note that we have now added an event handler inside the <code class="literal">updateAgendaContent()</code> function to trigger the right things happening when a visitor clicks on an article title. This is often necessary as, like in our example of the HTML tag, we want to trigger the event that did not exist on the<a id="id631" class="indexterm"/> page prior to the Ajax call.</p></div><div class="section" title="$.ajax()"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec48"/>$.ajax()</h3></div></div></div><p>As we mentioned, the <code class="literal">$.post()</code> method (and there is a <code class="literal">$.get()</code> as well) is a special case of the <code class="literal">$.ajax()</code> method. The ones we used take fewer arguments than <code class="literal">.ajax()</code>, as some of them are<a id="id632" class="indexterm"/> predefined (not surprisingly, POST or GET), so, once again, jQuery makes things easier for us to write. To conclude this chapter, we will give you a<a id="id633" class="indexterm"/> summary on how the <code class="literal">.ajax()</code> methods can be used. Please check the full jQuery documentation for more details. It will be worth reading.</p><p>The overall syntax is:</p><div class="informalexample"><pre class="programlisting">$.ajax({name:value, name:value, ... })</pre></div><p>These parameters specify one or more name/value pairs. Here is an overview of the most commonly used parameters and their meanings:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>data</strong></span>: This is data to <a id="id634" class="indexterm"/>be sent to the server. It is converted to a query string, if it is not already a string. It can be passed as an object, a string, or an array.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>dataType</strong></span>: This is the data<a id="id635" class="indexterm"/> type expected of the server response. It can be XML, HTML, text, JSON, or script. In our examples, we assumed HTML.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>url</strong></span>: This specifies the URL to<a id="id636" class="indexterm"/> send the request to. The default is the current page.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>error(xhr,status,error)</strong></span>: This is a<a id="id637" class="indexterm"/> function to be run if the request fails.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>success(result,status,xhr)</strong></span>: This is a<a id="id638" class="indexterm"/> function to be run when the request succeeds.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>type</strong></span>: This specifies the<a id="id639" class="indexterm"/> type of request (GET or POST).</li></ul></div><p>So, the <code class="literal">$.post()</code> call in our last example is:</p><div class="informalexample"><pre class="programlisting">$.post("./showarticle.php", { aid: aid },
  function(data){
  $('#varicontent').replaceWith(data);

 } );</pre></div><p>It could also have been written as:</p><div class="informalexample"><pre class="programlisting">$.ajax({

type: "POST",
url: "./showarticle.php",

succes: function(data){
  $('#varicontent').replaceWith(data);
}
data:{ aid: aid },
dataType: "html"

 } );</pre></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec66"/>Summary</h1></div></div></div><p>In this chapter, we introduced Ajax, a collection of web techniques to asynchronously collect data from the server. It is used to update only parts of the screen on websites and web applications, rather than loading an entirely new page each time.</p><p>Ajax techniques are based on the XMLHttpRequest object, but thanks to jQuery and its <code class="literal">$.ajax()</code> methods, you learned how to use Ajax in your applications without having to know anything about that object. We used the <code class="literal">$.load</code> and <code class="literal">$.post</code> methods in our examples to replace parts of our screen with HTML that is either stored or generated on the server.</p><p>Ajax can be used with other data formats, such as XML and JSON. It also has potential drawbacks, because now that we constantly update the page without actually leaving it, it will be perceived as different pages by the visitor of our site, particularly when they press the browser's back button.</p><p>These two topics: making the back key do what is expected of it, and using different data formats between the client and server are the subject matter of our next two chapters.</p></div></body></html>