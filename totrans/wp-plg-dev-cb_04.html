<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">The Power of Custom Post Types</h1>
                </header>
            
            <article>
                
<p>This chapter covers one of the most powerful features of WordPress, custom post types, through the following topics:</p>
<ul>
<li>Creating a custom post type</li>
<li>Adding a new section to the custom post type editor</li>
<li>Displaying single custom post type items using custom layout</li>
<li>Displaying custom post type data in shortcodes</li>
<li>Adding custom categories for custom post types</li>
<li>Adding custom fields to categories</li>
<li>Hiding the category editor from the custom post type editor</li>
<li>Displaying additional columns in the custom post list page</li>
<li>Adding filters for custom categories to the custom post list page</li>
<li>Adding Quick Edit fields for custom categories</li>
<li>Updating a page title to include custom post data using plugin filters</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article>
                
<p>Building on its history of openness and ease of use, WordPress reached new heights in customization when it introduced custom post types.</p>
<p>Custom post types are new categories of items that are created by using the WordPress API and that appear in the WordPress administration interface as complete new sections, next to the default Posts and Pages sections. These custom items can be used to store any type of information, including events, bug reports, recipes, movie reviews, and many more.</p>
<p>When using custom post types to implement this kind of functionality, developers are able to take advantage of WordPress internal content editing capabilities, including its powerful text editor and user-friendly media uploader. Custom post types also simplify data management for developers, since all of the information related to these new entries is stored in the site database using the existing table structures. Finally, custom post types can leverage the established theme and template system to display the information that site administrators store in these new content types.</p>
<p>If you have ever taken a peek at the MySQL database behind a WordPress site, you know that posts, pages, attachments, revisions, and navigation menu items share the same tables. In essence, all of these data elements are custom post types, with some of them using the standard text editor, while others, such as the navigation menus, have a custom management interface. Each of these types of items also has a different mechanism to be displayed on a site.</p>
<p>Using custom post types opens up endless possibilities to tailor the functionality of a WordPress installation and provide a custom solution to end users without needing to invest a large amount of time re-inventing the wheel. This chapter covers all facets of creating custom post types through the creation of a Book Review system, including the creation of new types of elements, displaying the newly stored information on the website, and customizing the environment to create an editor with unique capabilities.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a custom post type</h1>
                </header>
            
            <article>
                
<p>The initial creation of a custom post type is extremely easy. It only requires a single function to be called from an action hook callback. Once in place, a lot of functionality immediately becomes available to administrators and site visitors. This recipe shows how to create a new custom post type that will be used to store Book Reviews.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have access to a WordPress development environment, either on your local computer or a remote server, where you will be able to load your new plugin files.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the WordPress plugin directory of your development installation.</li>
<li>Create a new directory called <kbd>ch4-book-reviews</kbd>.</li>
<li>Navigate to this directory and create a new text file called <kbd>ch4-book-reviews.php</kbd>.</li>
<li>Open the new file in a code editor and add an appropriate header at the top of the plugin file, naming the plugin <kbd>Chapter 4 - Book Reviews</kbd>.</li>
<li>Add the following line of code to register a function that will be executed during the initialization phase every time WordPress generates a page:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'init', 'ch4_br_create_book_post_type' ); </pre>
<ol start="6">
<li>Add the following code block to provide an implementation for the <kbd>ch4_br_create_book_post_type</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_create_book_post_type() { <br/>    register_post_type( 'book_reviews', <br/>        array( <br/>            'labels' =&gt; array( <br/>                'name' =&gt; 'Book Reviews', <br/>                'singular_name' =&gt; 'Book Review', <br/>                'add_new' =&gt; 'Add New', <br/>                'add_new_item' =&gt; 'Add New Book Review', <br/>                'edit' =&gt; 'Edit', <br/>                'edit_item' =&gt; 'Edit Book Review', <br/>                'new_item' =&gt; 'New Book Review', <br/>                'view' =&gt; 'View', <br/>                'view_item' =&gt; 'View Book Review', <br/>                'search_items' =&gt; 'Search Book Reviews', <br/>                'not_found' =&gt; 'No Book Reviews found', <br/>                'not_found_in_trash' =&gt;  <br/>                    'No Book Reviews found in Trash', <br/>                'parent' =&gt; 'Parent Book Review'                     <br/>            ), <br/>            'public' =&gt; true, <br/>            'menu_position' =&gt; 20, <br/>            'supports' =&gt;  <br/>                array( 'title', 'editor', 'comments', <br/>                       'thumbnail', 'custom-fields' ), <br/>            'taxonomies' =&gt; array( '' ), <br/>            'menu_icon' =&gt;  <br/>                plugins_url( 'book-reviews.png', __FILE__ ), <br/>            'has_archive' =&gt; true,<br/>            'exclude_from_search' =&gt; true <br/>        ) <br/>    ); <br/>} </pre>
<ol start="7">
<li>Save and close the plugin file.</li>
<li>Find and download a PNG format book icon measuring 24 x 24 pixels from a site, such as IconArchive (<a href="http://www.iconarchive.com"><span class="URLPACKT">http://www.iconarchive.com</span></a>), resize it to 20 x 20 pixels, and save it as <kbd>book-reviews.png</kbd> in the plugin directory.</li>
<li>Navigate to the Plugins management page and <span class="packt_screen">Activate</span> the <kbd>Chapter 4 - Book Reviews</kbd> plugin.</li>
<li>Click on the newly available <span class="packt_screen">Book</span> <span class="packt_screen">Reviews</span> menu item, located under the <span class="packt_screen">Pages</span> section, to see the Book Review creation and management interface.</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="193" width="635" class="image-border" src="assets/01ea80ec-5a51-4f57-86c2-9c0ec0b879f0.png"/></div>
<ol start="11">
<li>Click on the <span class="packt_screen">Add</span> <span class="packt_screen">New</span> button, next to the section title, to display the Book Review editor featuring the complete WordPress text editor, the custom fields editor, comments control, publishing controls, and the featured image section.</li>
<li>Fill in the new entry by specifying the Book Review title (for example, <kbd>WordPress Plugin Development Cookbook</kbd>) and a short description.</li>
<li>Scroll to the <span class="packt_screen">Custom</span> <span class="packt_screen">Fields</span> section and type <kbd>book_author</kbd> as the <span class="packt_screen">Name</span> of the field and <kbd>Yannick Lefebvre</kbd> as the <span class="packt_screen">Value</span>. Click <span class="packt_screen">Add</span> <span class="packt_screen">Custom</span> <span class="packt_screen">Field</span> to create a second field.</li>
</ol>
<div class="packt_infobox">If some custom fields already exist in your WordPress installation (from other plugin data entry), you will need to click on <span class="packt_screen">Enter new</span> before being able to set the Name to <kbd>book_author</kbd>.</div>
<ol start="14">
<li>Set the <span class="packt_screen">Name</span> of the second field to <kbd>book_rating</kbd> and its <span class="packt_screen">Value</span> to <kbd>5</kbd>.</li>
<li>Find and download a book cover image from a website such as Google Images (<a href="https://images.google.com">https://<span class="URLPACKT">images.google.com</span></a>) or Packt (<a href="https://www.packtpub.com">https://<span class="URLPACKT">www.packtpub.com</span></a>).</li>
<li>Click on the <span class="packt_screen">Set</span> <span class="packt_screen">featured</span> <span class="packt_screen">image</span> link located in the right-hand sidebar of the editing interface.</li>
<li>Click on <span class="packt_screen">Select</span> <span class="packt_screen">Files</span> to pick the image that you downloaded to your computer and have WordPress upload it to the <kbd>wp-content/uploads</kbd> folder of your site.</li>
<li>Once the file is uploaded and WordPress displays information about it, look at the bottom of the media upload dialog and click on the <span class="packt_screen">Set</span> <span class="packt_screen">featured</span> <span class="packt_screen">image</span> link to associate it with the <span class="packt_screen">Book Review</span> that you are creating.</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="354" width="198" class="image-border" src="assets/64748c33-ebf0-42ea-bc16-422e02a3e563.png"/></div>
<ol start="19">
<li><span>Click on the</span> <span class="packt_screen">Publish</span> <span>button to save this first <span class="packt_screen">Book Review</span>.</span></li>
<li>Visit the <span class="packt_screen">Permalinks</span> section of the <span class="packt_screen">Settings</span> menu and click on the <span class="packt_screen">Save Changes</span> button (without changing your <span class="packt_screen">Permalinks</span> settings).</li>
<li>Go back to the Book Review you created and click on the <span class="packt_screen">View</span> <span class="packt_screen">Book</span> <span class="packt_screen">Review</span> button to see the newly created content in your web browser.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>By making a call to the <kbd>register_post_type</kbd> function, the entire WordPress environment becomes aware of the existence of this new post type. This awareness includes the creation of a dedicated section to create and edit posts of this type and the ability to process web page requests for Book Reviews.</p>
<p>As mentioned at the beginning of this recipe, the function is quite simple to use and only requires two arguments:</p>
<pre>register_post_type( $post_type, $args ); </pre>
<p>The first argument is a text string that indicates the name of the post type. Please note when choosing this name that it will be used as the default value for the permalinks of all items that use the new type, and that it should be unique enough to avoid potential conflicts with other plugins.</p>
<p>The second argument is an array of properties that specify the characteristics of the new post type and determine how this type will be edited.</p>
<p>In this specific example, the first element of the properties array is actually another array, which contains a number of labels. These labels indicate the text strings that should be displayed when managing items created under the new post type. For example, if we look at the screenshot before step 11, the message <span class="packt_screen">No Book Reviews</span> <span class="packt_screen">found</span> came directly from the definition of the <kbd>not_found</kbd> label in this array.</p>
<p>The second argument, named <kbd>public</kbd>, determines whether the post type's administration interface should be shown to manage it and if visitors should be able to view single items. Next is the <kbd>menu_position</kbd> member of the configuration array, indicating the desired position of the new element in the administration menu. In this example, a value of 20 indicates that it should be displayed following to the <span class="packt_screen">Pages</span> menu item. Visit the WordPress Codex (<a href="https://codex.wordpress.org/Function_Reference/register_post_type"><span class="URLPACKT">https://codex.wordpress.org/Function_Reference/register_post_type</span></a>) for a full list of potential values for this parameter and their associated positions.</p>
<p>The <kbd>supports</kbd> parameter is another array that indicates which parts of the content editor should be displayed for items that use the custom post type. In this case, we left out some sections, such as <kbd>author</kbd>, <kbd>excerpt</kbd>, <kbd>trackbacks</kbd>, <kbd>revisions</kbd>, <kbd>page-attributes</kbd>, and <kbd>post-formats</kbd>, as they were not desirable for Book Reviews.</p>
<p>The next few parameters in the configuration array indicate that we do not want to define custom taxonomies at this time, and specify the path and name of the image file that should be displayed next to the post type's name in the administration menu. Finally, the last two arguments determines whether WordPress should present an archive listing page for the new type when users visit the <kbd>/book_reviews</kbd> page on the site and whether or not book reviews should be excluded from search results.</p>
<p>There are actually many other parameters that can be included in the configuration array to get more precise control over some aspects of the new custom post type. Please visit the WordPress Codex (<a href="https://codex.wordpress.org/Function_Reference/register_post_type">https://codex.wordpress.org/Function_Reference/register_post_type</a>) to learn more about them.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>While the internal post type name is used by default to generate post permalinks, it can actually be overridden to create better-looking URLs.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Changing the custom post type permalinks slug</h1>
                </header>
            
            <article>
                
<p>An optional member of the custom post type configuration is the <kbd>rewrite</kbd> parameter. It can be defined as follows:</p>
<pre>'rewrite' =&gt; array( 'slug' =&gt; 'awesome-book-reviews' ) </pre>
<p>Although this may seem very simple, the permalinks will only change over after you go to the <span class="packt_screen">Permalinks</span> section and <span class="packt_screen">Save Changes</span>, as we did in the recipe. Alternatively, it is possible to make calls from the WordPress rewrite module to programmatically request for the permalinks configuration to be rebuilt. As this is not something that should be done every time WordPress displays a page, but would be too early to do when a plugin gets initialized or upgraded, a good place to call these functions would be within the plugin options storage function. You might even decide to give administrators the ability to specify their own slug in a plugin configuration page. The code to reset the permalinks rules is as follows:</p>
<pre>global $wp_rewrite; <br/>$wp_rewrite-&gt;flush_rules(); </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding a new section to the custom post type editor</h1>
                </header>
            
            <article>
                
<p>While the custom post editor that has been put in place so far is functional, it is not the friendliest of user interfaces, especially with the custom fields section, where users need to type or select the names of each field as they create new items. A cleaner approach is to create a custom interface using the meta box mechanism that we saw in the previous chapter to display all the data associated with Book Reviews.</p>
<p>This recipe shows how to create a meta box that will be associated with a custom post type and how to save the information that is entered in that new interface.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Creating a custom post type</em> recipe to have a starting point for this recipe, and the resulting plugin should still be active in your development site. Alternatively, you can get the resulting code (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v1.php</kbd>) from the code bundle downloaded from the Packt website (<a href="https://www.packtpub.com/support"><span class="URLPACKT">https://www.packtpub.com/support</span></a>) and rename the file <kbd>ch4-book-reviews.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol start="1">
<li>Navigate to the <kbd>ch4-book-reviews</kbd> folder of the WordPress plugin directory of your development installation.</li>
<li>Open the <kbd>ch4-book-reviews.php</kbd> file in a code editor.</li>
<li>Add the following line of code after the existing functions to register a function to be called when the administration interface is visited:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'admin_init', 'ch4_br_admin_init' ); </pre>
<ol start="4">
<li>Add the following code section to provide an implementation for the <kbd>ch4_br_admin_init</kbd> function and register a meta box to be associated with the <kbd>book_reviews</kbd> post type:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_admin_init() { <br/>    add_meta_box( 'ch4_br_review_details_meta_box',  <br/>                  'Book Review Details', <br/>                  'ch4_br_display_review_details_meta_box', <br/>                  'book_reviews', 'normal', 'high' ); <br/>} </pre>
<ol start="5">
<li>Insert this function to implement the <kbd>ch4_br_display_review_details_meta_box</kbd> function and render the meta box contents:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_display_review_details_meta_box( $book_review ) {  <br/>    // Retrieve current author and rating based on review ID <br/>    $book_author = <br/>          esc_html( get_post_meta( $book_review-&gt;ID, <br/>                                   'book_author', true ) ); <br/>    $book_rating = <br/>          intval( get_post_meta( $book_review-&gt;ID,<br/>                                 'book_rating', true ) ); <br/>    ?&gt; <br/>    &lt;table&gt; <br/>        &lt;tr&gt; <br/>            &lt;td style="width: 100%"&gt;Book Author&lt;/td&gt; <br/>            &lt;td&gt;&lt;input type="text" size="80" <br/>                       name="book_review_author_name" <br/>                       value="&lt;?php echo $book_author; ?&gt;" /&gt;&lt;/td&gt; <br/>        &lt;/tr&gt; <br/>        &lt;tr&gt; <br/>            &lt;td style="width: 150px"&gt;Book Rating&lt;/td&gt; <br/>            &lt;td&gt; <br/>                &lt;select style="width: 100px" <br/>                        name="book_review_rating"&gt; <br/>                &lt;!-- Loop to generate items in dropdown list --&gt;<br/>                &lt;?php<br/>                for ( $rating = 5; $rating &gt;= 1; $rating -- ) { ?&gt; <br/>                &lt;option value="&lt;?php echo $rating; ?&gt;"<br/>                &lt;?php echo selected( $rating, $book_rating ); ?&gt;&gt;<br/>                &lt;?php echo $rating; ?&gt; stars <br/>                &lt;?php } ?&gt; <br/>                &lt;/select&gt; <br/>            &lt;/td&gt; <br/>        &lt;/tr&gt; <br/>    &lt;/table&gt; <br/> &lt;?php } </pre>
<ol start="6">
<li>Add the following code segment to register a function that will be called when posts are saved to the database:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'save_post', 'ch4_br_add_book_review_fields', 10, 2 ); </pre>
<ol start="7">
<li>Add an implementation for the <kbd>ch4_br_add_book_review_fields</kbd> function defined in the previous <kbd>add_action</kbd> call:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_add_book_review_fields( $book_review_id,<br/>                                        $book_review ) { <br/>    // Check post type for book reviews <br/>    if ( 'book_reviews' == $book_review-&gt;post_type ) { <br/>        // Store data in post meta table if present in post data <br/>        if ( isset( $_POST['book_review_author_name'] ) ) {<br/>            update_post_meta( $book_review_id, 'book_author', <br/>                sanitize_text_field( <br/>                    $_POST['book_review_author_name'] ) ); <br/>        } <br/>         <br/>        if ( isset( $_POST['book_review_rating'] ) &amp;&amp; <br/>             !empty( $_POST['book_review_rating'] ) ) {            <br/>            update_post_meta( $book_review_id, 'book_rating', <br/>                intval( $_POST['book_review_rating'] ) ); <br/>        } <br/>    } <br/>} </pre>
<ol start="8">
<li>Find the <kbd>ch4_br_create_book_post_type</kbd> function, where the new book type was originally created, and remove the <kbd>custom-fields</kbd> element from the <kbd>supports</kbd> array:</li>
</ol>
<pre style="padding-left: 30px">   'supports' =&gt; array( 'title', 'editor', 'comments', 'thumbnail' ), </pre>
<ol start="9">
<li>Save and close the plugin file.</li>
<li>Open the previously created Book Review to see the new <span class="packt_screen">Book Review Details</span> meta box, containing a text field to specify the author and a drop-down list for the rating:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="126" width="631" class="image-border" src="assets/5237db71-726c-4529-b963-f2b23b86295c.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>This recipe uses the WordPress built-in meta box system to create a clean interface that will allow users to manage fields specific to custom post types without having to use the cumbersome default <span class="packt_screen">Custom</span> <span class="packt_screen">Fields</span> editor. As we saw in <a href="0346c3c6-27ee-45fb-bfd6-df398e04b2b4.xhtml"><span class="ChapterrefPACKT">Chapter</span> <span class="ChapterrefPACKT">3</span></a>, <em>User Settings and Administration Pages</em>, custom meta boxes can be created using the <kbd>add_meta_box</kbd> function. In addition to declaring the meta box and associating it with the custom post type, <kbd>add_meta_box</kbd> defines a callback that is responsible for rendering the contents of the box.</p>
<p>The next section of the recipe implements the function that renders the meta box content. As we can see, this box receives an object variable that contains information about the Book Review that is being displayed in the post editor. Using this object, our code retrieves the post ID and uses it to query the site database for a book author and rating associated with the entry. Once the custom field data has been retrieved from the database, it can be used to render the author and rating fields onscreen. When new Book Reviews are created, both calls to <kbd>get_post_meta</kbd> will return an empty string, resulting in the display of an empty text field and the last entry in the drop-down list.</p>
<p>The <kbd>get_post_meta</kbd> function is used to retrieve data that was stored in the custom fields section of the post editor and has three parameters:</p>
<pre>get_post_meta( $post_id, $field_name, $single ); </pre>
<p>The first parameter is the post ID, which can easily be retrieved using the <kbd>get_the_ID()</kbd> template function. This ID is used to identify the post to which the custom information is associated. The second argument is the custom field name, which should match the name specified when it is created in the post editor. The third and final argument indicates whether the return value should be a single value or an array of values. If set to <kbd>false</kbd>, it will produce an array containing a single element even if the custom field only contains a single value. In most cases, it should be set to <kbd>true</kbd> to receive a single value that can be accessed directly.</p>
<p>The last steps of this recipe take care of registering a function that will be called when posts of all types are saved or deleted by the site administrator. Since it will deal with all types of data, the saving callback must first check the type of the received post data. If it's a Book Review, the code proceeds to check if the received data is valid and stores the information in the post meta data table. In this recipe, the parameters for the <kbd>update_post_meta</kbd> function are similar to the <kbd>get_post_meta</kbd> function, except for the third argument, which is used to specify the data to be stored.</p>
<p>One last detail that should be mentioned about this recipe is the use of the fourth parameter of the <kbd>add_action</kbd> function when associating a callback to the <kbd>save_post</kbd> action hook. This argument indicates that two arguments will be received by the registered callback. If this argument is not set, the callback function will never receive that second piece of data.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Creating a custom post type</em> recipe</li>
<li>The <em>Formatting admin pages using meta boxes</em> recipe in <a href="0346c3c6-27ee-45fb-bfd6-df398e04b2b4.xhtml"><span class="ChapterrefPACKT">Chapter 3</span></a>, <em>User Settings and Administration Pages</em></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Displaying single custom post type items using a custom layout</h1>
                </header>
            
            <article>
                
<p>When displaying an entry created in our new custom post type, the default layout offered by our current site theme may not always be able to pleasantly display the information it contains. In most cases, you will be able to see the main post content, but not any of the custom fields data that is associated with the post.</p>
<p>This recipe shows how to create a custom layout to display all the elements that we stored in the Book Review created in the previous recipe.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Adding a new section to the custom post type editor</em> recipe to have a starting point for this recipe <span>and the resulting plugin should still be active in your development site</span>. Alternatively, you can get the resulting code (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v2.php</kbd>) from the downloaded code bundle and rename the file <kbd>ch4-book-reviews.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the <kbd>ch4-book-reviews</kbd> folder of the WordPress plugin directory of your development installation.</li>
<li>Open the <kbd>ch4-book-reviews.php</kbd> file in a code editor.</li>
<li>Add the following line of code after the existing functions to register a function to be called when WordPress is deciding which theme template to use to render content:</li>
</ol>
<pre style="padding-left: 60px">add_filter( 'template_include', 'ch4_br_template_include', 1 ); </pre>
<ol start="4">
<li>Add the following code section to provide an implementation for the <kbd>ch4_br_template_include</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_template_include( $template_path ) {      <br/>    if ( 'book_reviews' == get_post_type() ) { <br/>        if ( is_single() ) { <br/>            // checks if the file exists in the theme first, <br/>            // otherwise install content filter <br/>            if ( $theme_file = locate_template( array<br/>                 ( 'single-book_reviews.php' ) ) ) { <br/>                $template_path = $theme_file; <br/>            } else { <br/>                add_filter( 'the_content',<br/>                            'ch4_br_display_single_book_review',<br/>                            20 ); <br/>            } <br/>        } <br/>    } <br/>    return $template_path; <br/>} </pre>
<ol start="5">
<li>Add the following code section to implement the <kbd>ch4_br_display_single_book_review</kbd> function to display Book Reviews, including their custom fields:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_display_single_book_review( $content ) {<br/>    if ( !empty( get_the_ID() ) ) {<br/>        // Display featured image in right-aligned floating div<br/>        $content = '&lt;div style="float: right; margin: 10px"&gt;';<br/>        $content .= get_the_post_thumbnail( get_the_ID(),<br/>                                            'medium' );<br/>        $content .= '&lt;/div&gt;';<br/><br/><span>        </span>$content .= '&lt;div class="entry-content"&gt;';<span> </span><br/><br/>        // Display Author Name<br/>        $content .= '&lt;strong&gt;Author: &lt;/strong&gt;';<br/>        $content .= esc_html( get_post_meta( get_the_ID(),<br/>                                             'book_author', <br/>                                             true ) );<br/>        $content .= '&lt;br /&gt;';<br/><br/>        // Display yellow stars based on rating --&gt;<br/>        $content .= '&lt;strong&gt;Rating: &lt;/strong&gt;';<br/><br/>        $nb_stars = intval( get_post_meta( get_the_ID(),<br/>                                           'book_rating', <br/>                                           true ) );<br/><br/>        for ( $star_counter = 1; $star_counter &lt;= 5; <br/>                  $star_counter++ ) {<br/>            if ( $star_counter &lt;= $nb_stars ) {<br/>                $content .= '&lt;img src="' . <br/>                            plugins_url( 'star-icon.png', <br/>                                         __FILE__ ) . '" <br/>                            /&gt;';<br/>            } else {<br/>                $content .= '&lt;img src="' .<br/>                            plugins_url( 'star-icon-grey.png',<br/>                                         __FILE__ ) <br/>                            . '" /&gt;';<br/>            }<br/>        }<br/><br/>        // Display book review contents<br/>        $content .= '&lt;br /&gt;&lt;br /&gt;';<br/>        $content .= get_the_content( get_the_ID() );<br/>        $content .= '&lt;/div&gt;';<br/><br/>        return $content;<br/>    }<br/>} </pre>
<ol start="6">
<li>Save and close the plugin file.</li>
<li>Find and download a PNG format pixel star icon measuring 32 x 32 pixels from a site such as IconArchive (<a href="http://www.iconarchive.com"><span class="URLPACKT">http://www.iconarchive.com</span></a>), and save it as <kbd>star-icon.png</kbd> in the plugin directory.</li>
<li>Create a grayscale version of the star icon using any graphic processing tool (for example, the free multi-platform XnViewMP tool, found at <a href="http://www.xnview.com/en/">http://www.xnview.com/en/</a>) and save it as <kbd>star-icon-grey.png</kbd>.</li>
<li>Go to the <span class="packt_screen">Book Reviews</span> management page and click on the <span class="packt_screen">View</span> link under the existing entry created in the previous recipe to see the content rendered using the new template.</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="231" width="297" class="image-border" src="assets/28bb9f2c-e3fb-411b-96c0-775e634890c3.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>When rendering any web page, the default WordPress functionality is to search the current theme directory for an applicable template suitable for the content at hand. In the case of a single custom post type item, such as a Book Review, it first looks for a single item template named <kbd>single-&lt;post-type-name&gt;.php</kbd>, where the latter part is the actual post type name. If it does not find this file, it defaults to the general single item template. In the first recipe of this chapter, the template that was used to show the Book Review was the default single item template, simply named <kbd>single.php</kbd>.</p>
<p>To add better support for our new post type, this recipe associates a function with the <kbd>template_include</kbd> filter hook to change that behavior. More specifically, we use the <kbd>locate_template</kbd> function to check whether the user provided a template for the <kbd>book_reviews</kbd> post type in the theme directory. If no template is found, we register a filter to overwrite the page contents with our own layout. This gives users the flexibility to use our predefined layout or to provide their own.</p>
<p>The rest of the recipe implements our fallback filter function for Book Review content. This code makes use of many WordPress template functions, such as <kbd>get_the_ID()</kbd> and <kbd>get_the_content()</kbd>, as well as the <kbd>get_post_meta</kbd> function, to display various elements of the current item, including the book author and its rating, as well as the main post content and the featured image.</p>
<p>To help users build their own theme template for your custom post type, you should provide code snippets in your plugin documentation, showing how to retrieve your custom post type's custom fields.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Creating a custom post type</em> recipe</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Displaying custom post type data in shortcodes</h1>
                </header>
            
            <article>
                
<p>To help visitors navigate through the items added using our new custom post type, we will need to display a list of all the book reviews on the site, along with navigation elements to be able to handle large numbers of items. While WordPress offers a built-in mechanism to list post items in the form of the archive page, it is not easy for a plugin to be able to modify the layout of the resulting page in a consistent way across all possible user themes. A better solution to display a list of custom post type items is to create a shortcode that will display one or more posts in any place selected by the user, including a page, a post, or even on the site's front page.</p>
<p>This recipe shows how to create a shortcode that will retrieve and display five book reviews at a time with accompanying navigation links.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Displaying single custom post type items using a custom layout</em> recipe to have a starting point for this recipe, <span>and the resulting plugin should still be active in your development site</span>. Alternatively, you can get the resulting code (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v3.php</kbd>) from the downloaded code bundle and rename the file <kbd>ch4-book-reviews.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the <kbd>ch4-book-reviews</kbd> folder of the WordPress plugin directory of your development installation.</li>
<li>Open the <kbd>ch4-book-reviews.php</kbd> file in a code editor.</li>
<li>Add the following line of code after the existing functions to register a function that declares the new shortcode:</li>
</ol>
<pre style="padding-left: 60px">add_shortcode( 'book-review-list', 'ch4_br_book_review_list' ); </pre>
<ol start="4">
<li>Add the following code section to provide an implementation for the <kbd>ch4_br_book_review_list</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_book_review_list() { <br/>    // Preparation of query array to retrieve 5 book reviews <br/>    $query_params = array( 'post_type' =&gt; 'book_reviews', <br/>                           'post_status' =&gt; 'publish', <br/>                           'posts_per_page' =&gt; 5 );<br/><br/>    // Execution of post query <br/>    $book_review_query = new WP_Query; <br/>    $book_review_query-&gt;query( $query_params );<br/><br/>    // Check if any posts were returned by the query <br/>    if ( $book_review_query-&gt;have_posts() ) { <br/>        // Display posts in table layout <br/>        $output = '&lt;table&gt;';<br/><br/>        $output .= '&lt;tr&gt;&lt;th style="width: 350px"&gt;&lt;strong&gt;'; <br/>        $output .= 'Title&lt;/strong&gt;&lt;/th&gt;'; <br/>        $output .= '&lt;th&gt;&lt;strong&gt;Author&lt;/strong&gt;&lt;/th&gt;&lt;/tr&gt;';<br/><br/>        // Cycle through all items retrieved <br/>        while ( $book_review_query-&gt;have_posts() ) { <br/>            $book_review_query-&gt;the_post();<br/><br/>            $output .= '&lt;tr&gt;&lt;td&gt;&lt;a href="' . get_permalink(); <br/>            $output .= '"&gt;'; <br/>            $output .= get_the_title( get_the_ID() ) . '&lt;/a&gt;&lt;/td&gt;'; <br/>            $output .= '&lt;td&gt;'; <br/>            $output .= esc_html( get_post_meta( get_the_ID(), <br/>                                                'book_author',<br/>                                                true ) ); <br/>            $output .= '&lt;/td&gt;&lt;/tr&gt;'; <br/>        }<br/><br/>        $output .= '&lt;/table&gt;'; <br/>         <br/>        // Display page navigation links <br/>        if ( $book_review_query-&gt;max_num_pages &gt; 1 ) { <br/>            $output .= '&lt;nav id="nav-below"&gt;'; <br/>            $output .= '&lt;div class="nav-previous"&gt;'; <br/>            $output .= get_next_posts_link ( <br/>                '&lt;span class="meta-nav"&gt;&amp;larr;&lt;/span&gt;' .<br/>                ' Older reviews',<br/>                $book_review_query-&gt;max_num_pages ); <br/>            $output .= '&lt;/div&gt;'; <br/>            $output .= '&lt;div class="nav-next"&gt;'; <br/>            $output .= get_previous_posts_link( <br/>                  'Newer reviews ' .<br/>                  '&lt;span class="meta-nav"&gt;&amp;rarr;&lt;/span&gt;', <br/>                  $book_review_query-&gt;max_num_pages ); <br/>            $output .= '&lt;/div&gt;'; <br/>            $output .= '&lt;/nav&gt;'; <br/>        }<br/><br/>        // Reset post data query <br/>        wp_reset_postdata(); <br/>    }<br/><br/>    return $output; <br/>} </pre>
<ol start="5">
<li>Save the plugin file.</li>
<li>Create a new page and insert the shortcode <kbd>[book-review-list]</kbd>.</li>
<li><span class="packt_screen">Publish</span> and <span class="packt_screen">View</span> the page to see that a list of Book Reviews will be displayed in place of the shortcode.</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="244" width="662" class="image-border" src="assets/3308719d-7b79-4184-ae00-70e01c961f47.png"/></div>
<ol start="8">
<li>If more than five Book Reviews exist in the system, click on the navigation links that are displayed. You will see that the URL in the browser address bar changes, but the list of entries shows the same first five items as before.</li>
<li>Back in the <kbd>ch4-book-reviews.php</kbd> file, add the following highlighted code near the top of <kbd>ch4_br_book_review_list</kbd>, right after the line initializing the value of the <kbd>$query_params</kbd> variable:</li>
</ol>
<pre style="padding-left: 60px">// Preparation of query string to retrieve 5 book reviews <br/>$query_params = array( 'post_type' =&gt; 'book_reviews', <br/>                       'post_status' =&gt; 'publish', <br/>                       'posts_per_page' =&gt; 5 ); <br/> <br/><strong>// Retrieve page query variable, if present </strong><br/><strong>$page_num = ( get_query_var( 'paged' ) ? <br/>              get_query_var( 'paged' ) : 1 ); </strong><br/> <br/><strong>// If page number is higher than 1, add to query array </strong><br/><strong>if ( $page_num != 1 ) {</strong><br/><strong>    $query_params['paged'] = $page_num; </strong><br/><strong>}</strong></pre>
<ol start="10">
<li>Save and close the plugin file. Refresh the page that includes our new shortcode and use the navigation links to see that the list of items now changes properly.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>As we saw in <a href="0346c3c6-27ee-45fb-bfd6-df398e04b2b4.xhtml"><span class="ChapterrefPACKT">Chapter</span> <span class="ChapterrefPACKT">3</span></a>, <em>User Settings and Administration Pages</em>, shortcodes are text elements that can be inserted in any page and post, that will be replaced with the content generated by the plugin when they are found. The registered callback function must prepare the output and send it back as a return value at the end of its execution.</p>
<p>The first part of the <kbd>ch4_br_book_review_list</kbd> function takes care of preparing a query array to be passed to a new instance of the <kbd>WP_Query</kbd> class. This class allows developers to easily extract information from the site database's post table. In this example, the parameters that are being set in the query are the internal post type name (<kbd>post_type</kbd>), the status of the items that we want to display (<kbd>post_status</kbd>), and the number of items that should be retrieved at a time (<kbd>posts_per_page</kbd>).</p>
<p>Once the query string is in place, we create a global variable called <kbd>book_review_query</kbd> and assign to it a new instance of a <kbd>WP_Query</kbd> object. Once created, we initialize it using the query string that was just assembled. If posts are found by the object, we output HTML code to create a table and use a <kbd>while</kbd> loop to cycle through all the items found and display their title and author using a code similar to the previous two recipes.</p>
<p>As part of this recipe, we have seen that if more entries exist for the custom post type than the value specified with the <kbd>posts_per_page</kbd> query argument, navigation controls are added under the table of entries but will not work correctly, since we manually created the query string. To rectify the situation, we use the <kbd>get_query_var</kbd> function to see if a page number was requested. If that is the case, and the page number is not <kbd>1</kbd>, we add that number to our query parameters.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>As mentioned in the beginning of this recipe, there may be instances where a list of custom post type items needs to be displayed as part of a theme template. The following section shows how to get shortcode content to be displayed as part of a template file.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">do_shortcode function</h1>
                </header>
            
            <article>
                
<p>The <kbd>do_shortcode</kbd> function can be called from any theme template file, for the front page or any other section of the site, to render content associated with a shortcode. It takes a single argument, the shortcode string including any parameters. To display the content created in this recipe, we would simply need to call the following:</p>
<pre style="padding-left: 30px">&lt;?php echo do_shortcode( '[book-review-list]' ); ?&gt; </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding custom categories for custom post types</h1>
                </header>
            
            <article>
                
<p>To keep items organized on a site, administrators often use the built-in WordPress categories and terms to identify similar items. Looking back at the <span class="packt_screen">Book Reviews</span> system that we have been putting in place so far in this chapter, a type of categorization that would be helpful is a book type (for example, Science Fiction, Documentary, Fiction, Poetry, and so on).</p>
<p>This recipe shows how to create a new category (known as a <strong>taxonomy</strong> in the WordPress backend) and associate it with the Book Review custom post type.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Displaying custom post type data in shortcodes</em> recipe, to have a starting point for this recipe, <span>and the resulting plugin should still be active in your development site</span>. Alternatively, you can get the resulting code (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v4.php</kbd>) from the downloaded code bundle and rename the file <kbd>ch4-book-reviews.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the <kbd>ch4-book-reviews</kbd> folder of the WordPress plugin directory of your development installation.</li>
<li>Open the <kbd>ch4-book-reviews.php</kbd> file in a code editor.</li>
<li>Find the <kbd>ch4_br_create_book_post_type</kbd> function and add the following code after the existing call to <kbd>register_post_type</kbd> to create the new taxonomy:</li>
</ol>
<pre style="padding-left: 60px">register_taxonomy( <br/>    'book_reviews_book_type',       <br/>    'book_reviews',                  <br/>    array( <br/>        'labels' =&gt; array( <br/>            'name' =&gt; 'Book Type', <br/>            'add_new_item' =&gt; 'Add New Book Type', <br/>            'new_item_name' =&gt; 'New Book Type Name'<br/>        ), <br/>        'show_ui' =&gt; true, <br/>        'show_tagcloud' =&gt; false, <br/>        'hierarchical' =&gt; true <br/>    )<br/>); </pre>
<ol start="4">
<li>Save and close the plugin file.</li>
<li>Open the previously created Book Reviews to see the newly added <span class="packt_screen">Book</span> <span class="packt_screen">Type</span> meta box on the right-hand side of the post editor.</li>
<li>Click on the <span class="packt_screen"><span class="packt_screen">+ Add</span> <span class="packt_screen">New</span> <span class="packt_screen">Book</span> <span class="packt_screen">Type</span></span> link to create a new item and assign it as the current item's type. Click on the <span class="packt_screen">Update</span> button in the top-right section of the post editor to save the review:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="130" width="202" class="image-border" src="assets/5fdd254e-2b3c-4aa0-8ad8-7802dccc2fbe.png"/></div>
<ol start="7">
<li>Look at the left-hand administration menu to see that a new menu item was added to manage book types, leading to an editor similar to the post and page category editor:</li>
</ol>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="102" width="126" class="image-border" src="assets/3dc5a5f2-54e9-488f-a9c7-d6f260bb6686.png"/></div>
<ol start="8">
<li>Back in the plugin file, add the following code to the <kbd>ch4_br_display_single_book_review</kbd> function after the section displaying the rating to display the book type:</li>
</ol>
<pre style="padding-left: 60px">$book_types = wp_get_post_terms( get_the_ID(), <br/>                                'book_reviews_book_type' ); <br/> <br/>$content .= '&lt;br /&gt;&lt;strong&gt;Type: &lt;/strong&gt;';<br/><br/>if ( $book_types ) { <br/>    $first_entry = true; <br/>    for ( $i = 0; $i &lt; count( $book_types ); $i++ ) { <br/>        if ( !$first_entry ) {<br/>            $content .= ', ';<br/>        }<br/>        $content .= $book_types[$i]-&gt;name; <br/>        $first_entry = false; <br/>    } <br/>} else {<br/>    $content .= 'None Assigned';<br/>}</pre>
<ol start="9">
<li>Save and close the template file.</li>
<li>Visit a Book Review page to see the book type displayed under the rating.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>The <kbd>register_taxonomy</kbd> function is used to create a new type of category in WordPress and associate it to a post type. It has three parameters:</p>
<pre>register_taxonomy( $taxonomy_name, $post_type, $options );  </pre>
<p>The first argument is a unique identifier for the taxonomy. The second parameter is the post type that it should be associated with, which should match the type declared with the <kbd>register_post_type</kbd> function. The third argument is an array of parameters that determine how the new taxonomy will behave.</p>
<p>In this example, we have set a few taxonomy options, including a first item called <strong>labels</strong> that contains an array of text strings that will be used in the interface when referring to the new taxonomy. We also specified a second element, called <kbd>show_ui</kbd>, which controls the display of the taxonomy meta box in the post editor and the presence of a link to access the taxonomy editor in the administration menu. Next is an option called <kbd>show_tagcloud</kbd>, which we set to <kbd>false</kbd> to avoid displaying a tag cloud of all taxonomy values. Finally, the last item in the options array is called <kbd>hierarchical</kbd>. When set to <kbd>true</kbd>, taxonomy items will be able to have parent/child relationships and will be accessible as a list of checkboxes in the post editor. If set to <kbd>false</kbd>, all taxonomies are organized as a flat list and can be selected using an interface similar to the tag window in the post and page editor.</p>
<p>There are many more options available for the <kbd>register_taxonomy</kbd> function, as can be seen if you visit the WordPress Codex website (<a href="https://codex.wordpress.org/Function_Reference/register_taxonomy">https://codex.wordpress.org/Function_Reference/register_taxonomy</a>), but the ones found here are the essential ones to define a basic taxonomy.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Creating a custom post type</em> recipe</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding custom fields to categories</h1>
                </header>
            
            <article>
                
<p>In addition to specifying names for categories, it may be useful to attach additional information to custom taxonomies created in a WordPress plugin. For example, we may want to assign custom colors to categories that will be used when they are displayed, or we might want to identify the categories of content that are only accessible to paying members on a website.</p>
<p>This recipe shows how to display additional fields in the taxonomy editor and how to store the additional data in the site's database.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Adding custom categories for custom post types</em> recipe to have a starting point for this recipe, <span>and the resulting plugin should still be active in your development site</span>. Alternatively, you can get the resulting code (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v5.php</kbd>) from the downloaded code bundle and rename the file <kbd>ch4-book-reviews.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the <kbd>ch4-book-reviews</kbd> folder of the WordPress plugin directory of your development installation.</li>
<li>Open the <kbd>ch4-book-reviews.php</kbd> file in a code editor.</li>
<li>Add the following lines of code after the existing functions to assign a function to two action hooks that will be called when users create or edit taxonomy items:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'book_reviews_book_type_edit_form_fields', <br/>            'ch4_br_book_type_new_fields', 10, 2 );<br/>add_action( 'book_reviews_book_type_add_form_fields',<br/>            'ch4_br_book_type_new_fields', 10, 2 );</pre>
<ol start="4">
<li>Add the following code section to provide an implementation for the <kbd>ch4_br_book_type_new_fields</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_book_type_new_fields( $tag ) {<br/>    $mode = 'new';<br/><br/>    if ( is_object( $tag ) ) {<br/>        $mode = 'edit';<br/>        $book_cat_color = get_term_meta( $tag-&gt;term_id, <br/>                                         'book_type_color',<br/>                                         true );<br/>    }<br/>    $book_cat_color = empty( $book_cat_color ) ? <br/>                          '#' : $book_cat_color;<br/><br/>    if ( 'edit' == $mode ) {<br/>        echo '&lt;tr class="form-field"&gt;';<br/>        echo '&lt;th scope="row" valign="top"&gt;';<br/>    } elseif ( 'new' == $mode ) {<br/>        echo '&lt;div class="form-field"&gt;';<br/>    } ?&gt;<br/><br/>    &lt;label for="tag-category-url"&gt;Color&lt;/label&gt;<br/>    &lt;?php if ( 'edit' == $mode ) {<br/>        echo '&lt;/th&gt;&lt;td&gt;';<br/>    } ?&gt;<br/><br/>    &lt;input type="text" id="book_type_color" <br/>           name="book_type_color"<br/>           value="&lt;?php echo $book_cat_color; ?&gt;" /&gt;<br/>    &lt;p class="description"&gt;Color associated with book type <br/>                           (e.g. #199C27 or #CCC)&lt;/p&gt;<br/><br/>    &lt;?php if ( 'edit' == $mode ) {<br/>        echo '&lt;/td&gt;&lt;/tr&gt;'; <br/>    } elseif ( 'new' == $mode ) {<br/>        echo '&lt;/div&gt;';<br/>    }<br/>}</pre>
<ol start="5">
<li>Add the following lines of code at the end of the file to assign a function that will be called when users create or update taxonomy items:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'edited_book_reviews_book_type',<br/>            'ch4_br_save_book_type_new_fields', 10, 2 );<br/>add_action( 'created_book_reviews_book_type',<br/>            'ch4_br_save_book_type_new_fields', 10, 2 );</pre>
<ol start="6">
<li>Add the following code section to provide an implementation for the <kbd>ch4_br_save_book_type_new_fields</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_save_book_type_new_fields( $term_id, $tt_id ) {<br/>    if ( !$term_id ) {<br/>        return;<br/>    }<br/><br/>    if ( isset( $_POST['book_type_color'] ) <br/>             &amp;&amp; ( '#' == $_POST['book_type_color'] <br/>         || preg_match( '/#([a-f0-9]{3}){1,2}\b/i', <br/>                        $_POST['book_type_color'] ) ) ) {<br/>        $returnvalue = update_term_meta( $term_id, <br/>                           'book_type_color', <br/>                           $_POST['book_type_color'] );<br/>    }<br/>}</pre>
<ol start="7">
<li>Save and close the plugin file.</li>
<li>Edit one of the <span class="packt_screen">Book Type</span> entries created in the previous recipe to see the newly added Color field. Enter a color code and <span class="packt_screen">Update</span> the entry to see the data saved:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="107" width="435" class="image-border" src="assets/7ffdbf28-2768-49b2-a96d-7da40cb89367.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>This recipe uses many variable name action hooks to register functions to be called when users create or modify book types in the taxonomy editor. The first two calls to <kbd>add_action</kbd> refer to the <kbd>&lt;taxonomy&gt;_edit_forms_fields</kbd> and <kbd>&lt;taxonomy&gt;_add_form_fields</kbd> hooks. While you might expect to see two different functions associated with each of these action hooks, we actually register the same function in both cases, since rendering an additional field is similar in both cases. That being said, part of the function we register checks to see whether it receives a valid object as a parameter to know how it should render the new field so that it fits on the page if the user is creating a new category or editing an existing one.</p>
<p>We use a similar technique with the <kbd>edited_&lt;taxonomy&gt;</kbd> and <kbd>created_&lt;taxonomy&gt;</kbd> action hooks, which are respectively called when you first save a new taxonomy and update an existing one. In this case, the code does not have any significant differences depending on the action, since we only need to validate and save the incoming value for the new field.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Adding custom categories for custom post types</em> recipe</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Hiding the category editor from the custom post type editor</h1>
                </header>
            
            <article>
                
<p>As we saw in the previous recipe, when we associate a new taxonomy with the Book Review custom post type, the <kbd>show_ui</kbd> option controls the visibility of the taxonomy assignment meta box and the admin menu link to the taxonomy editor. In some cases, it is desirable to give users access to the full taxonomy editor, but only let editors choose from a controlled drop-down list when they create new entries in the custom post type editor.</p>
<p>This recipe shows how to hide the taxonomy interface from the post editor and how to update the custom post type meta box created in the previous recipe to assign a type to new Book Reviews and save this information in the site's database.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Adding custom fields to categories</em> recipe to have a starting point for this recipe, <span>and the resulting plugin should still be active in your development site</span>. Alternatively, you can get the resulting code (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v6.php</kbd>) from the downloaded code bundle and rename the file <kbd>ch4-book-reviews.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the <kbd>ch4-book-reviews</kbd> folder of the WordPress plugin directory of your development installation.</li>
<li>Open the <kbd>ch4-book-reviews.php</kbd> file in a code editor.</li>
<li>Find the call to the <kbd>register_taxonomy</kbd> function within the <kbd>ch4_br_create_book_post_type</kbd> function and add a new member to the configuration array named <kbd>meta_box_cb</kbd> with a value set to <kbd>false</kbd> highlighted in bold:</li>
</ol>
<pre style="padding-left: 30px">   'show_tagcloud' =&gt; false, <br/>   <strong>'meta_box_cb' =&gt; false,</strong><br/>   'hierarchical' =&gt; true</pre>
<ol start="4">
<li>Save the plugin and edit a Book Review to see that the <span class="packt_screen">Book</span> <span class="packt_screen">Type</span> taxonomy box is no longer displayed.</li>
<li>Locate the <kbd>ch4_br_display_review_details_meta_box</kbd> function in the code and add the following code within the existing table rendering code to add a new row containing a drop-down selection box for the book type:</li>
</ol>
<pre style="padding-left: 60px">&lt;tr&gt; <br/>    &lt;td&gt;Book Type&lt;/td&gt; <br/>    &lt;td&gt; <br/>    &lt;?php <br/>        // Retrieve array of types assigned to post <br/>        $assigned_types = wp_get_post_terms( $book_review-&gt;ID, <br/>                              'book_reviews_book_type' ); <br/>                 <br/>        // Retrieve array of all book types in system <br/>        $book_types = get_terms( 'book_reviews_book_type', <br/>                                 array( 'orderby' =&gt; 'name',<br/>                                        'hide_empty' =&gt; 0) ); <br/> <br/>        if ( $book_types ) { <br/>            echo '&lt;select name="book_review_book_type"'; <br/>            echo ' style="width: 400px"&gt;'; <br/> <br/>            foreach ( $book_types as $book_type ) {                 <br/>                echo '&lt;option value="' . $book_type-&gt;term_id;<br/>                echo '" '; <br/>                if ( !empty( $assigned_types ) ) {            <br/>                    selected( $assigned_types[0]-&gt;term_id, <br/>                              $book_type-&gt;term_id );<br/>                }<br/>                echo '&gt;' . esc_html( $book_type-&gt;name ); <br/>                echo '&lt;/option&gt;'; <br/>            }         <br/> <br/>            echo '&lt;/select&gt;'; <br/>        } ?&gt; <br/>    &lt;/td&gt; <br/>&lt;/tr&gt; </pre>
<ol start="6">
<li>Find the <kbd>ch4_br_add_book_review_fields</kbd> function and add the following code segment within the if statement, checking to see whether the post type is a Book Review, to save the selected book type in the site's database upon the submission of the post:</li>
</ol>
<pre style="padding-left: 60px">if ( isset( $_POST['book_review_book_type'] ) <br/>     &amp;&amp; !empty( $_POST['book_review_book_type'] ) ) { <br/>    wp_set_post_terms( $book_review-&gt;ID, <br/>                       intval( $_POST['book_review_book_type'] ), <br/>                       'book_reviews_book_type' ); <br/>} </pre>
<ol start="7">
<li>Save and close the plugin file.</li>
<li>Open a previously created Book Review to see the updated <span class="packt_screen">Book Review Details</span> meta box containing a new drop-down list to specify <span class="packt_screen">Book</span> <span class="packt_screen">Type</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="151" width="610" class="image-border" src="assets/8591c232-6446-4dac-8954-c9286a02c172.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>This recipe uses one of the many parameters of the <kbd>register_taxonomy</kbd> function to remove the ability for book review creators and editors to create new book types and creates a drop-down list to be able to assign a single book type to reviews.</p>
<p>In this process, the recipe makes use of three functions related to storing and retrieving taxonomy entries related to posts. The first, <kbd>wp_get_post_terms</kbd>, retrieves an array of terms associated with a post based on its ID and the name of the taxonomy. The second, <kbd>wp_set_post_terms</kbd>, assigns a term to a post based on its ID and the taxonomy name. Finally, <kbd>get_terms</kbd> retrieves an array of all the terms in the taxonomy, ordered based on the query string found in the second argument.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Adding custom categories for custom post types</em> recipe</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Displaying additional columns in the custom post list page</h1>
                </header>
            
            <article>
                
<p>After customizing the post editor to give content creators a tailored environment to create and edit custom post type entries, this recipe turns its efforts toward the Book Reviews management page, where all the entries for this type are listed. By default, custom post type listings are quite simple and only show the title, publication date, and the number of comments for each item. To make it easier to identify, sort, and find data in this management page, WordPress offers a number of customization capabilities, starting with the ability to change the columns that are displayed.</p>
<p>This recipe shows how to add and remove columns in the post management page, as well as make sorting in new columns possible.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Hiding the category editor from the custom post type editor</em> recipe to have a starting point for this recipe, <span>and the resulting plugin should still be active in your development site</span>. Alternatively, you can get the resulting code (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v7.php</kbd>) from the downloaded code bundle and rename the file to <kbd>ch4-book-reviews.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the <kbd>ch4-book-reviews</kbd> folder of the WordPress plugin directory of your development installation.</li>
<li>Open the <kbd>ch4-book-reviews.php</kbd> file in a code editor.</li>
<li>Add the following line of code after the existing functions to register a function to be called when the <span class="packt_screen">Book Reviews</span> listings page is being prepared:</li>
</ol>
<pre style="padding-left: 60px">add_filter( 'manage_edit-book_reviews_columns',<br/>            'ch4_br_add_columns' ); </pre>
<ol start="4">
<li>Add the following code section to provide an implementation for the <kbd>ch4_br_add_columns</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_add_columns( $columns ) { <br/>    $columns['book_reviews_author'] = 'Author'; <br/>    $columns['book_reviews_rating'] = 'Rating'; <br/>    $columns['book_reviews_type'] = 'Type'; <br/> <br/>    unset( $columns['comments'] ); <br/> <br/>    return $columns; <br/>} </pre>
<ol start="5">
<li>Add the following line of code to assign a function to be called when the columns data is being retrieved for each row in the post listing:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'manage_posts_custom_column', <br/>            'ch4_br_populate_columns' ); </pre>
<ol start="6">
<li>Insert the following code segment to provide an implementation for the <kbd>ch4_br_populate_columns</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_populate_columns( $column ) { <br/>    if ( 'book_reviews_author' == $column ) { <br/>        $book_author = esc_html( get_post_meta( get_the_ID(), <br/>                                                'book_author', <br/>                                                true ) ); <br/>        echo $book_author; <br/>    } elseif ( 'book_reviews_rating' == $column ) { <br/>        $book_rating = get_post_meta( get_the_ID(), 'book_rating', <br/>                                      true ); <br/>        echo $book_rating . ' stars'; <br/>    } elseif ( 'book_reviews_type' == $column ) {<br/>        $book_types = wp_get_post_terms( get_the_ID(), <br/>                          'book_reviews_book_type' );                 <br/>        if ( $book_types ) {<br/>            $book_cat_color = get_term_meta( <br/>                                  $book_types[0]-&gt;term_id,<br/>                                  'book_type_color', true );<br/><br/>            if ( '#' != $book_cat_color ) {<br/>                echo '&lt;span style="background-color: ';<br/>                echo $book_cat_color . '; ';<br/>                echo 'color: #fff; padding: 6px;"&gt;';<br/>                echo $book_types[0]-&gt;name . '&lt;/span&gt;';<br/>            } else {<br/>                echo $book_types[0]-&gt;name;<br/>            }<br/>        } else {<br/>            echo 'None Assigned'; <br/>        }<br/>    } <br/>} </pre>
<ol start="7">
<li>Save the plugin file and navigate to the <span class="packt_screen">Book</span> <span class="packt_screen">Reviews</span> listing page to see that the list of columns has been altered and that data stored in the post custom fields is now displayed for each item in the list.</li>
<li>Back in the code editor, add the following code at the end of the plugin file to register a function to be called when WordPress identifies columns that will be sortable for the Book Reviews custom post type:</li>
</ol>
<pre style="padding-left: 60px">add_filter( 'manage_edit-book_reviews_sortable_columns', <br/>            'ch4_br_author_column_sortable' ); </pre>
<ol start="9">
<li>Append the following code to provide an implementation for the <kbd>ch4_br_author_column_sortable</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_author_column_sortable( $columns ) { <br/>    $columns['book_reviews_author'] = 'book_reviews_author'; <br/>    $columns['book_reviews_rating'] = 'book_reviews_rating'; <br/> <br/>    return $columns; <br/>} </pre>
<ol start="10">
<li>Add the following block of code to register a function that will be called when data is requested to display post lists:</li>
</ol>
<pre style="padding-left: 60px">add_filter( 'request', 'ch4_br_column_ordering' ); </pre>
<ol start="11">
<li>Insert the following code segment to implement the <kbd>ch4_br_column_ordering</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_column_ordering( $vars ) { <br/>    if ( !is_admin() ) {<br/>        return $vars;<br/>    }<br/><br/>    if ( isset( $vars['orderby'] ) &amp;&amp;  <br/>         'book_reviews_author' == $vars['orderby'] ) { <br/>        $vars = array_merge( $vars, array( <br/>            'meta_key' =&gt; 'book_author', <br/>            'orderby' =&gt; 'meta_value' ) ); <br/>    } elseif ( isset( $vars['orderby'] ) &amp;&amp;  <br/>               'book_reviews_rating' == $vars['orderby'] ) { <br/>        $vars = array_merge( $vars, array( <br/>                                 'meta_key' =&gt; 'book_rating', <br/>                                 'orderby' =&gt; 'meta_value_num' ) ); <br/>    } <br/>    return $vars; <br/>} </pre>
<ol start="12">
<li>Save and close the plugin file.</li>
<li>Refresh the <span class="packt_screen">Book</span> <span class="packt_screen">Reviews</span> listing to see that the <span class="packt_screen">Author</span> and <span class="packt_screen">Rating</span> column headers are links that can be clicked to sort these columns:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="image-border" src="assets/c2bed1d5-cf0b-4069-bf7d-994e74269711.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>Customizing the post listings page requires an intricate mix of action and filter hooks to achieve the final goal. The first function we registered is associated with the variable filter name <kbd>manage_edit-&lt;post_type&gt;_columns</kbd>, where <kbd>&lt;post_type&gt;</kbd> is replaced with the internal post type name. When the registered function is called, it receives the default column list that will be shown while listing Book Reviews entries as an argument. Using this data, it proceeds to add three columns for <kbd>author</kbd>, <kbd>rating</kbd>, and <kbd>type</kbd> and removes the <kbd>comments</kbd> column from the array. Once finished, it returns the modified array.</p>
<p>The second part of the recipe registers the function that will be responsible for populating the new columns. Since this function gets called when any custom post type column is rendered, the code checks which column is currently requested before echoing the requested data to the browser. The function makes calls to <kbd>get_the_ID()</kbd> to get the index of the currently displayed row and to be able to find its associated data using <kbd>get_post_meta</kbd> and <kbd>wp_get_post_terms</kbd>.</p>
<p>At this point in the recipe, the new columns are visible in the <span class="packt_screen">Book Reviews</span> management page and data is displayed for each of them. The purpose of the rest of the recipe is to make the <kbd>author</kbd> and <kbd>rating</kbd> columns sortable. This is done by first registering a function with the variable filter name <kbd>manage_edit-&lt;post_type&gt;_sortable_columns</kbd>, where <kbd>&lt;post_type&gt;</kbd> is replaced with the post type name. When the function is executed, it adds two items to the array of columns that will be sorted. This takes care of making the column header links that can be clicked for sorting, associated with the appropriate URLs.</p>
<p>The last function that is registered is associated with the request filter and takes care of adding elements to the query array based on the variables that came through in the query URL.</p>
<p>The final result allows administrators to easily reorder <span class="packt_screen">Book</span> <span class="packt_screen">Reviews</span> based on these two columns which can be sorted, as well as to see information about each entry's type.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Adding custom categories for custom post types</em> recipe</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding filters for custom categories to the custom post list page</h1>
                </header>
            
            <article>
                
<p>A second customization method for the custom post listings is to create a drop-down box that will allow administrators to only display items that belong to a single category at a time. This can help significantly reduce the number of entries that are shown to quickly find the desired entry.</p>
<p>This recipe shows how to add a filter mechanism based on the Book Review type to the listings page.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Displaying additional columns in the custom post list page</em> recipe to have a starting point for this recipe <span>and the resulting plugin should still be active in your development site</span>. Alternatively, you can get the resulting code (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v8.php</kbd>) from the downloaded code bundle and rename the file <kbd>ch4-book-reviews.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the <kbd>ch4-book-reviews</kbd> folder of the WordPress plugin directory of your development installation.</li>
<li>Open the <kbd>ch4-book-reviews.php</kbd> file in a code editor.</li>
<li>Add the following line of code after the existing functions to register a function to be called when WordPress is preparing the filter drop-down boxes for the post listings:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'restrict_manage_posts',<br/>            'ch4_br_book_type_filter_list' ); </pre>
<ol start="4">
<li>Add the following code section to provide an implementation for the <kbd>ch4_br_book_type_filter_list</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_book_type_filter_list() { <br/>    $screen = get_current_screen(); <br/>    global $wp_query; <br/>    if ( 'book_reviews' == $screen-&gt;post_type ) { <br/>        wp_dropdown_categories( array( <br/>            'show_option_all' =&gt;  'Show All Book Types', <br/>            'taxonomy'        =&gt;  'book_reviews_book_type', <br/>            'name'            =&gt;  'book_reviews_book_type', <br/>            'orderby'         =&gt;  'name', <br/>            'selected'        =&gt;  <br/>            ( isset( $wp_query-&gt;query['book_reviews_book_type'] )         <br/>              ? $wp_query-&gt;query['book_reviews_book_type'] : '' ), <br/>            'hierarchical'    =&gt;  false, <br/>            'depth'           =&gt;  3, <br/>            'show_count'      =&gt;  false, <br/>            'hide_empty'      =&gt;  true, <br/>            ) ); <br/>    } <br/>} </pre>
<ol start="5">
<li>Insert the following line of code to register a function that will be called when the post display query is being prepared:</li>
</ol>
<pre style="padding-left: 60px">add_filter( 'parse_query', 'ch4_br_perform_book_type_filtering' );</pre>
<ol start="6">
<li>Implement the <kbd>ch4_br_perform_book_type_filtering</kbd> function with the following code segment:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_perform_book_type_filtering( $query ) {<br/>    $qv = &amp;$query-&gt;query_vars; <br/> <br/>    if ( isset( $qv['book_reviews_book_type'] ) &amp;&amp;<br/>         !empty( $qv['book_reviews_book_type'] ) &amp;&amp; <br/>         is_numeric( $qv['book_reviews_book_type'] ) ) { <br/>        $term = get_term_by( 'id', <br/>                             $qv['book_reviews_book_type'], <br/>                             'book_reviews_book_type' );     <br/>        $qv['book_reviews_book_type'] = $term-&gt;slug; <br/>    } <br/>} </pre>
<ol start="7">
<li>Save and close the plugin file.</li>
<li>Visit the <span class="packt_screen">Book Reviews</span> listings to see the new dropdown to restrict what book types are displayed:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="106" width="940" class="image-border" src="assets/d297246f-28c6-4c7c-92a1-864c089152ac.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>This recipe starts by registering an action callback that will be executed when WordPress renders the various filter controls that are available for each post type listing. When the function is called, it retrieves a global variable to know the post type that is currently being displayed and determine if it should show the book type filter list. It also accesses the global post query variable to see if a book type filter is already in place and sets the correct drop-down list entry to be selected, if there is one.</p>
<p>The callback then proceeds to use the <kbd>wp_dropdown_categories</kbd> function to display a list of all of the taxonomy items registered for book types. This utility function expects to receive an array of parameters that determine which taxonomy list to display, the name of the drop-down list field name, and the label to be displayed for the option to show all the types. This array should also contain a few parameters to determine the order in which the items should be displayed, specify the item to set as selected, indicate the maximum depth to show for hierarchical taxonomies, and determine whether or not items count and empty items be shown.</p>
<p>Once the new book type selection list is in place, selecting an entry and clicking on the <span class="packt_screen">Filter</span> button triggers a refresh of the web page and leads to the second registered callback that was put in place after being executed. The filter function receives the current WordPress post query object and starts by first getting a pointer to the query variables that are stored inside of the query object. With this in hand, it moves on to verify that a book type is part of the query variables and that it is numeric. If the result is positive, it replaces the numeric value with the textual name for the selected book type so that the query can take place.</p>
<p>Once all of this code is executed, users are able to quickly filter which book types should be displayed in the <span class="packt_screen">Book Reviews</span> management page. They are also still able to use the column sorting mechanism implemented in the previous recipe.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Adding custom categories for custom post types</em> recipe</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding Quick Edit fields for custom categories</h1>
                </header>
            
            <article>
                
<p>A great feature of WordPress is the ability for site editors to quickly make changes to any post in the admin section by clicking on the Quick Edit link associated with any of the items shown. While our custom post type taxonomy appears in the Quick Edit section, it is not a drop-down list of choices as we had in the book review editor. Also, the author and rating fields do not appear in any way in the Quick Edit section.</p>
<p>This recipe shows how to add custom fields while quickly editing book reviews. As you perform the following steps, you will see that some of the code that we put in place is not as cleanly written as code from previous recipes, since the WordPress Quick Edit customization infrastructure is not as well-formed as other areas of the platform.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Adding filters for custom categories to the custom post list page</em> recipe to have a starting point for this recipe, <span>and the resulting plugin should still be active in your development site</span>. Alternatively, you can get the resulting code (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v9.php</kbd>) from the downloaded code bundle and rename the file <kbd>ch4-book-reviews.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the <kbd>ch4-book-reviews</kbd> folder of the WordPress plugin directory of your development installation.</li>
<li>Open the <kbd>ch4-book-reviews.php</kbd> file in a code editor.</li>
<li>Find the call to the <kbd>register_taxonomy</kbd> function within the <kbd>ch4_br_create_book_post_type</kbd> function and add a new member to the configuration array named <kbd>show_in_quick_edit</kbd> with a value set to <kbd>false</kbd> highlighted in bold:</li>
</ol>
<pre style="padding-left: 60px">'show_tagcloud' =&gt; false, <br/>'meta_box_cb' =&gt; false,<br/><strong>'show_in_quick_edit' =&gt; false,</strong><br/>'hierarchical' =&gt; true,</pre>
<ol start="4">
<li>Add the following line of code after the existing functions to register a function to be called when WordPress is preparing to render the contents of the <span class="packt_screen">Quick Edit</span> section:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'quick_edit_custom_box',<br/>            'ch4_br_display_custom_quickedit_link', 10, 2 );</pre>
<ol start="5">
<li>Add the following code section to provide an implementation for the <kbd>ch4_br_display_custom_quickedit_link</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_display_custom_quickedit_link( $column_name, <br/>                                               $post_type ) {<br/>    if ( 'book_reviews' == $post_type ) {<br/>        switch ( $column_name ) {<br/>            case 'book_reviews_author': ?&gt;<br/>                &lt;fieldset class="inline-edit-col-right"&gt;<br/>                &lt;div class="inline-edit-col"&gt;<br/>                   &lt;label&gt;&lt;span class="title"&gt;Author&lt;/span&gt;&lt;/label&gt;<br/>                   &lt;input type="text"       <br/>                          name='book_reviews_author_input'<br/>                          id='book_reviews_author_input' value=""&gt;<br/>                &lt;/div&gt;<br/>                &lt;?php break;<br/>            case 'book_reviews_rating': ?&gt;<br/>                &lt;div class="inline-edit-col"&gt;<br/>                    &lt;label&gt;<br/>                        &lt;span class="title"&gt;Rating&lt;/span&gt;<br/>                    &lt;/label&gt;<br/>                    &lt;select name='book_reviews_rating_input'<br/>                            id='book_reviews_rating_input'&gt;<br/>                    &lt;?php // Generate all items of drop-down list <br/>                    for ( $rating = 5; $rating &gt;= 1; $rating -- ) {<br/>                    ?&gt;  &lt;option value="&lt;?php echo $rating; ?&gt;"&gt;<br/>                        &lt;?php echo $rating; ?&gt; stars <br/>                    &lt;?php } ?&gt; <br/>                    &lt;/select&gt;<br/>                &lt;/div&gt;<br/>                &lt;?php break;<br/>            case 'book_reviews_type': ?&gt;<br/>                &lt;div class="inline-edit-col"&gt;<br/>                    &lt;label&gt;&lt;span class="title"&gt;Type&lt;/span&gt;&lt;/label&gt;<br/>                    &lt;?php<br/>                    $terms = get_terms( array( 'taxonomy' =&gt; <br/>                                        'book_reviews_book_type',<br/>                                        'hide_empty' =&gt; false ) );<br/>                    ?&gt;<br/>                    &lt;select name='book_reviews_type_input'<br/>                            id='book_reviews_type_input'&gt;<br/>                    &lt;?php foreach ($terms as $index =&gt; $term) {<br/>                        echo '&lt;option ';<br/>                        echo 'class="book_reviews_type-option"';<br/>                        echo 'value="' . $term-&gt;term_id . '"';<br/>                        selected( 0, $index );<br/>                        echo '&gt;' . $term-&gt;name. '&lt;/option&gt;';<br/>                    } ?&gt;<br/>                    &lt;/select&gt;<br/>                &lt;/div&gt;<br/>            &lt;?php break;<br/>        } <br/>    } <br/>}</pre>
<ol start="6">
<li>Add the following line of code to register a function to be called when WordPress is rendering the footer of the administration pages:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'admin_footer', 'ch4_br_quick_edit_js' );</pre>
<ol start="7">
<li>Implement the <kbd>ch4_br_quick_edit_js</kbd> function with the following code snippet:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_quick_edit_js() {<br/>    global $current_screen;<br/>    if ( ( 'edit-book_reviews' !== $current_screen-&gt;id ) ||<br/>         ( 'book_reviews' !== $current_screen-&gt;post_type ) ) {<br/>        return;<br/>    } ?&gt;<br/><br/>    &lt;script type="text/javascript"&gt;<br/>    function set_inline_book_reviews( reviewArray ) {<br/>        // revert Quick Edit menu so that it refreshes properly<br/>        inlineEditPost.revert();<br/>        var inputBookAuthor = <br/>            document.getElementById('book_reviews_author_input');<br/>        inputBookAuthor.value = reviewArray[0];<br/> <br/>        var inputRating =<br/>            document.getElementById('book_reviews_rating_input');<br/>        for (i = 0; i &lt; inputRating.options.length; i++) {<br/>            if ( inputRating.options[i].value == reviewArray[1] ) {<br/>                inputRating.options[i].setAttribute( 'selected',<br/>                                                     'selected' );<br/>            } else {<br/>                inputRating.options[i].removeAttribute( <br/>                    'selected' );<br/>            }<br/>        } <br/> <br/>        var inputBookType =<br/>            document.getElementById('book_reviews_type_input');<br/>        for (i = 0; i &lt; inputBookType.options.length; i++) {<br/>            if ( inputBookType.options[i].value == <br/>                     reviewArray[2] ) {<br/>                inputBookType.options[i].setAttribute( 'selected',<br/>                    'selected' );<br/>            } else {<br/>                inputBookType.options[i].removeAttribute( <br/>                    'selected' );<br/>            }<br/>        } <br/>    }<br/>&lt;/script&gt;<br/>&lt;?php }</pre>
<ol start="8">
<li>Add the following code to register a function to replace the original Quick Edit code that is generated for each post in the book reviews page:</li>
</ol>
<pre style="padding-left: 60px">add_filter( 'post_row_actions', 'ch4_br_quick_edit_link', 10, 2 );</pre>
<ol start="9">
<li>Add the following block of code to provide an implementation for the <kbd>ch4_br_quick_edit_link</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_quick_edit_link( $act, $post ) {<br/>    global $current_screen;<br/>    $post_id = '';<br/><br/>    if ( ( isset( $current_screen ) &amp;&amp; <br/>           $current_screen-&gt;id != 'edit-book_reviews' &amp;&amp;<br/>           $current_screen-&gt;post_type != 'book_reviews' ) <br/>         || ( isset( $_POST['screen'] ) &amp;&amp;<br/>              $_POST['screen'] != 'edit-book_reviews' ) ) {<br/>        return $act;<br/>    }<br/><br/>    if ( !empty( $post-&gt;ID ) ) {<br/>        $post_id = $post-&gt;ID;<br/>    } elseif ( isset( $_POST['post_ID'] ) ) {<br/>        $post_id = intval( $_POST['post_ID'] );<br/>    }<br/><br/>    if ( !empty( $post_id ) ) {<br/>        $book_author = esc_html( get_post_meta( $post_id, <br/>                                     'book_author', true ) ); <br/>        $book_rating = esc_html( get_post_meta( $post_id, <br/>                                     'book_rating', true ) );<br/>        $book_reviews_types = wp_get_post_terms( $post_id, <br/>                                     'book_reviews_book_type',<br/>                                     array( 'fields' =&gt; 'all' ) );<br/>        if ( empty( $book_reviews_types ) ) {<br/>            $book_reviews_types[0] = <br/>                (object) array( 'term_id' =&gt; 0 );<br/>        }<br/> <br/>        $idx = 'inline hide-if-no-js';<br/>        $act[$idx] = '&lt;a href="#" class="editinline"  ';<br/>        $act[$idx] .= " onclick=\"var reviewArray = new Array('";<br/>        $act[$idx] .= "{$book_author}', '{$book_rating}', ";<br/>        $act[$idx] .= "'{$book_reviews_types[0]-&gt;term_id}');";<br/>        $act[$idx] .= "set_inline_book_reviews( reviewArray )\"&gt;";<br/>        $act[$idx] .= __( 'Quick&amp;nbsp;Edit' );<br/>        $act[$idx] .= '&lt;/a&gt;';<br/>    }<br/>    return $act;<br/>}</pre>
<ol start="10">
<li>Add the following function call to register a function that will be executed when post data is updated from the <span class="packt_screen">Quick Edit</span> section:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'save_post', 'ch4_br_save_quick_edit_data', 10, 2 );</pre>
<ol start="11">
<li>Provide an implementation for the <kbd>ch4_br_save_quick_edit_data</kbd> function with the following block of code:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_save_quick_edit_data( $ID = false, <br/>                                      $post = false ) {<br/>    // Do not save if auto-saving, not book reviews, no permissions<br/>    if ( ( defined( 'DOING_AUTOSAVE' ) &amp;&amp; DOING_AUTOSAVE ) ||<br/>         ( isset( $_POST['post_type'] ) <br/>           &amp;&amp; 'book_reviews' != $_POST['post_type'] ) ||<br/>         !current_user_can( 'edit_page', $ID ) ) {<br/>        return $ID;<br/>    }<br/><br/>    $post = get_post( $ID );<br/>    if ( !empty( $post ) &amp;&amp; 'revision' != $post-&gt;post_type ) {<br/>        if ( isset( $_POST['book_reviews_author_input'] ) ) {<br/>            update_post_meta( $ID, 'book_author', <br/>                sanitize_text_field( <br/>                    $_POST['book_reviews_author_input'] ) ); <br/>        }<br/> <br/>        if ( isset( $_POST['book_reviews_rating_input'] ) ) {<br/>            update_post_meta( $ID, 'book_rating', <br/>                intval( $_POST['book_reviews_rating_input'] ) ); <br/>        }<br/> <br/>        if ( isset( $_POST['book_reviews_type_input'] ) ) {<br/>            $term = term_exists( <br/>                intval( $_POST['book_reviews_type_input'] ),<br/>                        'book_reviews_book_type' );<br/>            if ( !empty( $term ) ) {<br/>                wp_set_object_terms( $ID, <br/>                    intval( $_POST['book_reviews_type_input'] ), <br/>                            'book_reviews_book_type' );<br/>            }<br/>        }<br/>    } <br/>}</pre>
<ol start="12">
<li>Save and close the plugin file.</li>
<li>Visit the <span class="packt_screen">Book Reviews</span> listings page and click on <span class="packt_screen">Quick Edit</span> to see the newly added <span class="packt_screen">Author</span>, <span class="packt_screen">Rating</span>, and <span class="packt_screen">Type</span> fields.</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="200" width="498" class="image-border" src="assets/f64a179a-1272-44dd-bc7e-7f849ada47ca.png"/></div>
<ol start="14">
<li>Change the values in these fields and save them using the <span class="packt_screen">Update</span> button. You will see that the values get updated in the Book Reviews list, accordingly.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>While the Quick Edit box is a great tool that WordPress users appreciate, customizing it is a bit tricky in current versions of WordPress. While we could easily add data to each individual item in sections, such as the post editor, for our new custom post type, the Quick Edit section requires more work to add custom fields. The root of the issue stems from the fact that there is really only a single instance of the Quick Edit section that gets rendered as part of the edit page. That section is hidden at first, then appears, and moves to the correct position when a user clicks on the Quick Edit link. With this in mind, we cannot assign proper values to custom fields in the Quick Edit box and, therefore, need to store hidden information as each item gets listed to be able to update each field appropriately based on which item is being edited.</p>
<p>The first section of our recipe code starts off by rendering a text input field and two drop-down lists within the Quick Edit section. You will notice that we do not set the value of the text field or set options to be selected in the select lists. Another interesting point with this callback is that it sends us the same list of columns that we used in the <em>Displaying additional columns in the custom post list page</em> recipe. This means that if we wanted to add fields other than the ones we have added to the post table, we would still have to place these field names in the list of columns and then use some tricks to hide them from the table.</p>
<p>Once these extra fields are in place, we will add the code to the admin page footer of the book review editor to create a Javascript function that we will call when it is time to update our new custom fields in the Quick Edit section. The function receives an array of data, then locates the custom fields in the page using the <kbd>document.getElementById</kbd> function, and updates their values based on the incoming data array.</p>
<p>The next block of code we added creates a new Quick Edit link to replace the original one for each book review item. The new link not only enables users to display the Quick Edit section, but also embeds values for each item within the <kbd>onclick</kbd> Javascript code along with a call to the function that we added to the footer so that a new set of values is assigned to each field when the user decides to quickly edit a book review.</p>
<p>Finally, we store data from our custom fields when the user clicks on the <span class="packt_screen">Update</span> button. Interestingly, we do this by registering a second callback for the <kbd>save_post</kbd> action. This means that both of our functions will be called when posts are saved. However, this second saving function checks for a number of conditions to be true before actually saving values, and the names of the fields that it saves are different than the save function we put in place for the post editor.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Updating page title to include custom post data using plugin filters</h1>
                </header>
            
            <article>
                
<p>A last customization touch that can be put in place to support our Book Reviews custom post type is to add custom information about the posts in the title bar when displaying them. For example, we could add the author's name next to the book title.</p>
<p>This recipe shows how to use the <kbd>document_title_parts</kbd> filter to alter the post title for Book Reviews.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Adding Quick Edit fields for custom categories</em> recipe to have a starting point for this recipe, <span>and the resulting plugin should still be active in your development site</span>. Alternatively, you can get the resulting code (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v10.php</kbd>) from the downloaded code bundle and rename the file <kbd>ch4-book-reviews.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the <kbd>ch4-book-reviews</kbd> folder of the WordPress plugin directory of your development installation.</li>
<li>Open the <kbd>ch4-book-reviews.php</kbd> file in a code editor.</li>
<li>Add the following line of code after the existing functions to register a function to be called when WordPress prepares the text to be displayed in the browser's title bar:</li>
</ol>
<pre style="padding-left: 60px">add_filter( 'document_title_parts', <br/>            'ch4_br_format_book_review_title' ); </pre>
<ol start="4">
<li>Add the following code section to provide an implementation for the <kbd>ch4_br_format_book_review_title</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch4_br_format_book_review_title( $the_title ) { <br/>    if ( 'book_reviews' == get_post_type() &amp;&amp; is_single() ) { <br/>        $book_author = esc_html( get_post_meta( get_the_ID(),  <br/>                                   'book_author', true ) );<br/>        if ( !empty( $book_author ) ) {<br/>            $the_title['title'] .= ' by ' . $book_author;<br/>        }<br/>    } <br/> <br/>    return $the_title; <br/>} </pre>
<ol start="5">
<li>Save and close the plugin file.</li>
</ol>
<p> </p>
<ol start="6">
<li>Visit a Book Review page. You will see that the book's author is now displayed after the name in the title:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="75" width="689" class="image-border" src="assets/6cc02387-21db-4f4a-84cc-39733dc9dbeb.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>The <kbd>document_title_parts</kbd> filter allows plugins to modify or completely replace the page title contents. In this case, the code of the function that we associated with the filter hook receives the title that WordPress intends to display as an array. It then proceeds to check whether the item that is being prepared for display is a Book Review and whether or not it is a single item. While the first condition is something obvious to check for, the <kbd>is_single</kbd> verification is done to make sure that the code does not try to add a book author to the Book Reviews archive listing page.</p>


            </article>

            
        </section>
    </body></html>