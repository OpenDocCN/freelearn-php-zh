<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Creating E-commerce Features"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Creating E-commerce Features</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Amending configuration settings to run sessions in a database</li><li class="listitem" style="list-style-type: disc">Creating a basic cart</li><li class="listitem" style="list-style-type: disc">Adding and searching by product categories</li><li class="listitem" style="list-style-type: disc">Saving the cart to the database</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec24"/>Introduction</h1></div></div></div><p>The <code class="literal">Cart</code> class in CodeIgniter <a id="id96" class="indexterm"/>provides basic shopping cart functionality, such as adding items, amending the cart, displaying cart details, and removing items within the cart. In this chapter, we'll look at creating a simple shop using the CodeIgniter <code class="literal">Cart</code> class.</p></div></div>
<div class="section" title="Amending configuration settings to run sessions in a database"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec25"/>Amending configuration settings to run sessions in a database</h1></div></div></div><p>"Why do I need to <a id="id97" class="indexterm"/>do this; I'm not <a id="id98" class="indexterm"/>using sessions at the moment and besides, I have already covered sessions in another recipe?" I know; I hear you; but the CodeIgniter <code class="literal">Cart</code> class makes use of sessions in order to build a cart for the customer or user. We'll go over sessions here with the <code class="literal">Cart</code> class in mind. If you've already implemented sessions, you can probably skip this recipe.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec37"/>Getting ready</h2></div></div></div><p>Before we launch into the cart example, we need to do a little housekeeping. First, we'll alter some config settings, which will allow CodeIgniter to save Cart information to the database, and then we'll create a simple database schema to handle products, and so on.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec38"/>How to do it...</h2></div></div></div><p>There are some configuration changes we need to apply before we start, they are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the, <code class="literal">application/config/config.php </code>file, in a text editor and make the following amendments:<div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Config variable</p>
</th><th style="text-align: left" valign="bottom">
<p>Value</p>
</th><th style="text-align: left" valign="bottom">
<p>Explanation</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['encryption_key'] = ''</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">Alphanumeric</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies the encryption key CodeIgniter should use when encrypting sessions. The value can be alphanumeric and you must decide on a string for its value.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_encrypt_cookie']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TRUE/FALSE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies whether or not to encrypt the sessions in the database; for this example, it should be set to <code class="literal">TRUE</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_use_database]</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TRUE/FALSE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies whether or not to store sessions in the database; for this example, it should be set to <code class="literal">TRUE</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_table_name']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">Alphanumeric</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The name of the table in the database that is used to store sessions. For this example, it should be set to <code class="literal">sess_cart</code>.</p>
</td></tr></tbody></table></div></li><li class="listitem">There are some tables <a id="id99" class="indexterm"/>required to <a id="id100" class="indexterm"/>support this recipe, and also some dummy data. Copy the following SQL code into your database:<div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `sessions` (
  `session_id` varchar(40) COLLATE utf8_bin NOT NULL DEFAULT '0',
  `ip_address` varchar(16) COLLATE utf8_bin NOT NULL DEFAULT '0',
  `user_agent` varchar(120) COLLATE utf8_bin DEFAULT NULL,
  `last_activity` int(10) unsigned NOT NULL DEFAULT '0',
  `user_data` text COLLATE utf8_bin NOT NULL,
  PRIMARY KEY (`session_id`),
  KEY `last_activity_idx` (`last_activity`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

CREATE TABLE IF NOT EXISTS `products` (
  `product_id` int(11) NOT NULL AUTO_INCREMENT,
  `product_name` varchar(255) NOT NULL,
  `product_code` int(11) NOT NULL,
  `product_description` varchar(255) NOT NULL,
  `category_id` int(11) NOT NULL,
  `product_price` int(11) NOT NULL,
  PRIMARY KEY (`product_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=3;

INSERT INTO `products` (`product_id`, `product_name`, `product_code`, `product_description`, `category_id`, `product_price`) VALUES
(1, 'Running Shoes', 423423, 'These are some shoes', 2, 50),
(2, 'Hawaiian Shirt', 34234, 'This is a shirt', 1, 25);

CREATE TABLE IF NOT EXISTS `categories` (
  `cat_id` int(11) NOT NULL AUTO_INCREMENT,
  `cat_name` varchar(50) NOT NULL,
  PRIMARY KEY (`cat_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=3;

INSERT INTO `categories` (`cat_id`, `cat_name`) VALUES
(1, 'Shirts'),
(2, 'Footware');</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec39"/>How it works…</h2></div></div></div><p>Okay so what have we just <a id="id101" class="indexterm"/>made? The following <a id="id102" class="indexterm"/>is a description of both tables:</p><div class="section" title="Categories table"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec05"/>Categories table</h3></div></div></div><p>The categories table stores <a id="id103" class="indexterm"/>information about the category groups that each product (in the products table) is associated with. They are as follows:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Item name</p>
</th><th style="text-align: left" valign="bottom">
<p>Attributes</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cat_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">INTEGER(11)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Table primary key.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cat_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">VARCHAR(50)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Name of the category.</p>
</td></tr></tbody></table></div></div><div class="section" title="Products table"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec06"/>Products table</h3></div></div></div><p>The products table stores information <a id="id104" class="indexterm"/>about each product for sale in the cart. It is linked to the categories table by the foreign key (<code class="literal">category_id</code>). The following is the product table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Item name</p>
</th><th style="text-align: left" valign="bottom">
<p>Attributes</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">product_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">INTEGER(11)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Table primary key</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">product_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">VARCHAR(125)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Name of the product</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">product_code</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">INTEGER(11)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>A code for the product, which could be used as an internal stock code</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">product_description</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">VARCHAR(255)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Detailed description of the product</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">category_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">INTEGER(11)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The products category ID()as a foreign key from the category table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">product_price</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">INTEGER(11)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The value of the product.</p>
</td></tr></tbody></table></div></div></div></div>
<div class="section" title="Creating a basic cart"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec26"/>Creating a basic cart</h1></div></div></div><p>In this section, we will be <a id="id105" class="indexterm"/>creating the basic files necessary to run a cart. Later in the chapter, we will be adding greater functionality to it, but first let's prepare. We will be creating the following four files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/controllers/shop.php</code>: This controller will handle any customer interaction between the views and the model, such as handling any forms and controlling the customer's journey through the cart.</li><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/models/shop_model.php</code>: This model will handle any database interaction between the controller and the database. It will contain functions to fetch products and, product categories, and later in the chapter, to save the cart to the database.</li><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/views/shop/display_cart.php</code>: This view will display a summary of a customer's cart at any one time, and allow that customer to amend the quantities of items in their cart.</li><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/views/shop/view_products.php</code>: This view will display products from the <code class="literal">cart.products</code> table in the database, and provide options to allow the customer to add items to their cart.</li></ul></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec40"/>How to do it...</h2></div></div></div><p>We're going to create the following four files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/shop.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/shop_model.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/shop/display_cart.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/shop/display_products.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Copy the following <a id="id106" class="indexterm"/>code into the, <code class="literal">/path/to/codeigniter/application/controllers/shop.php </code>file: <div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Shop extends CI_Controller {
    function __construct() {
        parent::__construct();
        $this-&gt;load-&gt;library('cart');
        $this-&gt;load-&gt;helper('form');
        $this-&gt;load-&gt;helper('url');
        $this-&gt;load-&gt;helper('security');
        $this-&gt;load-&gt;model('Shop_model');
    }

    public function index() {
        $data['query'] = $this-&gt;Shop_model-&gt;get_all_products();
        $this-&gt;load-&gt;view('shop/display_products', $data);
    }

    public function add() {
        $product_id = $this-&gt;uri-&gt;segment(3);
        $query = $this-&gt;Shop_model-&gt;get_product_details($product_id);
        foreach($query-&gt;result() as $row) {
            $data = array(
                'id'   =&gt; $row-&gt;product_id,
                'qty' =&gt; 1,
                'price'  =&gt; $row-&gt;product_price,
                'name' =&gt; $row-&gt;product_name,
             );
        }

        $this-&gt;cart-&gt;insert($data);
        $this-&gt;load-&gt;view('shop/display_cart', $data);
    }

    public function update_cart() {
        $data = array();
        $i = 0;

        foreach($this-&gt;input-&gt;post() as $item) {
                $data[$i]['rowid']  = $item['rowid'];
                $data[$i]['qty']    = $item['qty'];
                $i++;
        }

        $this-&gt;cart-&gt;update($data);
        redirect('shop/display_cart');
    }

    public function display_cart() {
        $this-&gt;load-&gt;view('shop/display_cart');
    }

    public function clear_cart() {
        $this-&gt;cart-&gt;destroy();
        redirect('index');
    }
}</pre></div></li><li class="listitem">Then copy the following <a id="id107" class="indexterm"/>code to the, <code class="literal">/path/to/codeigniter/application/models/shop_model.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Shop_model extends CI_Model {

    function __construct() {
        parent::__construct();
        $this-&gt;load-&gt;helper('url');
    }

    public function get_product_details($product_id) {
        $this-&gt;db-&gt;where('product_id', $product_id);
        $query = $this-&gt;db-&gt;get('products');
        return $query;
    }

    public function get_all_products() {
        $query = $this-&gt;db-&gt;get('products');
        return $query;
    }
}</pre></div></li><li class="listitem">Then copy the following <a id="id108" class="indexterm"/>code to the, <code class="literal">path/to/codeigniter/application/views/shop/display_cart.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php echo form_open('shop/update_cart'); ?&gt;

&lt;table cellpadding="6" cellspacing="1" style="width:50%" border="1"&gt;

  &lt;tr&gt;
    &lt;th&gt;Quantity&lt;/th&gt;
    &lt;th&gt;Description&lt;/th&gt;
    &lt;th&gt;Item Price&lt;/th&gt;
    &lt;th&gt;Sub-Total&lt;/th&gt;
  &lt;/tr&gt;

  &lt;?php $i = 1; ?&gt;

  &lt;?php foreach ($this-&gt;cart-&gt;contents() as $items): ?&gt;

    &lt;?php echo form_hidden($i . '[rowid]', $items['rowid']); ?&gt;

    &lt;tr&gt;
      &lt;td&gt;&lt;?php echo form_input(array('name' =&gt; $i . '[qty]', 'value' =&gt; $items['qty'], 'maxlength' =&gt; '3', 'size' =&gt; '5')); ?&gt;&lt;/td&gt;
      &lt;td&gt;
        &lt;?php echo $items['name']; ?&gt;

        &lt;?php if ($this-&gt;cart-&gt;has_options($items['rowid']) == TRUE): ?&gt;

          &lt;p&gt;
            &lt;?php foreach ($this-&gt;cart-&gt;product_options($items['rowid']) as $option_name =&gt; $option_value): ?&gt;

              &lt;strong&gt;&lt;?php echo $option_name; ?&gt;:&lt;/strong&gt; &lt;?php echo $option_value; ?&gt;&lt;br/&gt;

            &lt;?php endforeach; ?&gt;
          &lt;/p&gt;

        &lt;?php endif; ?&gt;

      &lt;/td&gt;
      &lt;td&gt;&lt;?php echo $this-&gt;cart-&gt;format_number($items['price']); ?&gt;&lt;/td&gt;
      &lt;td&gt;$&lt;?php echo $this-&gt;cart-&gt;format_number($items['subtotal']); ?&gt;&lt;/td&gt;
    &lt;/tr&gt;

    &lt;?php $i++; ?&gt;

  &lt;?php endforeach; ?&gt;

  &lt;tr&gt;
    &lt;td colspan="2"&gt; &lt;/td&gt;
    &lt;td&gt;&lt;strong&gt;Total&lt;/strong&gt;&lt;/td&gt;
    &lt;td&gt;$&lt;?php echo $this-&gt;cart-&gt;format_number($this-&gt;cart-&gt;total()); ?&gt;&lt;/td&gt;
  &lt;/tr&gt;

&lt;/table&gt;

&lt;p&gt;&lt;?php echo form_submit('', 'Update Cart'); ?&gt;&lt;/p&gt;
&lt;?php echo form_close() ; ?&gt;</pre></div></li><li class="listitem">Finally, copy the following <a id="id109" class="indexterm"/>code to the, <code class="literal">path/to/codeigniter/application/views/shop/display_products.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;body&gt;
    &lt;table&gt;
    &lt;?php foreach ($query-&gt;result() as $row) : ?&gt;
        &lt;tr&gt;
        &lt;td&gt;&lt;?php echo $row-&gt;product_id ; ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo $row-&gt;product_name ; ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo $row-&gt;product_description ; ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo anchor('shop/add/'.$row-&gt;product_id, 'Add to cart') ; ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
    &lt;?php endforeach ; ?&gt;
    &lt;/table&gt;
&lt;/body&gt;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec41"/>How it works...</h2></div></div></div><p>Okay, there's a lot going on here; so rather than discussing what's going on in each file, we'll break it down into user actions. <a id="id110" class="indexterm"/>There are several actions users can perform when interacting with the cart. The most common are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">User browses the catalogue</li><li class="listitem" style="list-style-type: disc">User adds an item to the cart</li><li class="listitem" style="list-style-type: disc">User updates or removes items in the cart</li></ul></div><div class="section" title="User browses the catalogue"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec07"/>User browses the catalogue</h3></div></div></div><p>
<code class="literal">public function index()</code> in <code class="literal">controllers/shop.php</code> loads all the <a id="id111" class="indexterm"/>products from the database by calling the <code class="literal">$this-&gt;Cart_model-&gt;get_all_products()</code> function from <code class="literal">Shop_model</code>, and passes it to the, <code class="literal">views/shop/display_products.php view</code>, via <code class="literal">$this-&gt;load-&gt;view('shop/display_products', $data)</code>.</p></div><div class="section" title="User adds an item to the cart"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec08"/>User adds an item to the cart</h3></div></div></div><p>User clicks on the <span class="strong"><strong>Add to cart</strong></span> <a id="id112" class="indexterm"/>link in the, <code class="literal">views/shop/display_products.php </code>file, <a id="id113" class="indexterm"/>next to the item they wish to purchase, which calls <code class="literal">public function add()</code> in <code class="literal">controllers/shop.php</code>. <code class="literal">public function add()</code> fetches the product ID passed to it in the URL by <code class="literal">$this-&gt;uri-&gt;segment(3)</code> . Using this, <code class="literal">$product_id</code> looks up the product details from the database by <code class="literal">$this-&gt;Shop_model-&gt;get_product_details($product_id)</code>. This data is then written to the cart by <code class="literal">$this-&gt;cart-&gt;insert($data)</code>. Finally, the user is redirected to the cart with <code class="literal">$this-&gt;load-&gt;view('shop/display_cart', $data)</code> so they can view their item in the cart and make any amendments if they wish to.</p></div><div class="section" title="User updates or removes items in the cart"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec09"/>User updates or removes items in the cart</h3></div></div></div><p>This covers two actions: adding more <a id="id114" class="indexterm"/>items to the cart or completely removing an item or all items <a id="id115" class="indexterm"/>from the cart. They are described as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Adding to or subtracting items from the cart</strong></span>: When the user views their cart, he they see a table with the quantities of each item in their cart to the left. The <a id="id116" class="indexterm"/>user can change the quantity of items by <a id="id117" class="indexterm"/>changing the values in this textbox. If the user increases or decreases the current quantity of a <a id="id118" class="indexterm"/>particular item and presses the, <span class="strong"><strong>Update Cart </strong></span>button, then we run the shop controller <a id="id119" class="indexterm"/>function, <code class="literal">update_cart()</code>. <code class="literal">update_cart()</code> loops through the post array looking at each item and its new or desired quantity. It will track each item with the rowed value in the <code class="literal">$data</code> array, ensuring that the correct item is updated with the correct new quantity.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Removing items from the cart</strong></span>: This <a id="id120" class="indexterm"/>functions the same way as adding or removing <a id="id121" class="indexterm"/>items as previously described. However, the difference is that if the quantity chosen by the user is <code class="literal">0 (zero)</code>, then CodeIgniter will remove the item completely from the cart.</li></ul></div></div></div></div>
<div class="section" title="Adding and searching by product categories"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec27"/>Adding and searching by product categories </h1></div></div></div><p>From a customer perspective, <a id="id122" class="indexterm"/>it is useful to be able to narrow down your catalogue by viewing products by category, such as shoes, shirts, coats, and so on. If you <a id="id123" class="indexterm"/>wish to add this functionality, you'll need to amend the <a id="id124" class="indexterm"/>database. If you require this feature, copy the code in the following <span class="emphasis"><em>Getting ready</em></span> <a id="id125" class="indexterm"/>section.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec42"/>Getting ready</h2></div></div></div><p>In order to support searching and filtering by categories, we'll need to add a categories table. If you haven't already done this during the <span class="emphasis"><em>Getting ready</em></span> section earlier in the chapter, create the following table in your database:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `categories` (
  `cat_id` int(11) NOT NULL AUTO_INCREMENT,
  `cat_name` varchar(50) NOT NULL,
  PRIMARY KEY (`cat_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=3;

INSERT INTO `categories` (`cat_id`, `cat_name`) VALUES
(1, 'Shirts'),
(2, 'Footware');</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec43"/>How to do it...</h2></div></div></div><p>We'll now need to make amendments to the following files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/views/shop/display_products.php</code>: This added a small menu allowing the user to click on different categories; the results will be filtered accordingly.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/views/shop/display_cart.php</code>: This added a small menu allowing the user to click <a id="id126" class="indexterm"/>on different categories; the results will be filtered accordingly.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/shop.php</code>: This added code that will display categories <a id="id127" class="indexterm"/>and also look for a user's category choice in a form submission.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/shop_model.php</code>: This added the code that, pulls categories <a id="id128" class="indexterm"/>from the database according to a category ID.</li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Copy the following code <a id="id129" class="indexterm"/>at the top of the, <code class="literal">path/to/codeigniter/application/views/shop/display_cart.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php echo form_open('shop/index') ; ?&gt;
  &lt;select name="cat"&gt;
    &lt;?php foreach ($cat_query-&gt;result() as $cat_row) : ?&gt;
       &lt;option value="&lt;?php echo $cat_row-&gt;cat_id;?&gt;"&gt;&lt;?php echo $cat_row-&gt;cat_name;?&gt;&lt;/option&gt;
    &lt;?php endforeach ; ?&gt;
 &lt;/select&gt;
&lt;?php echo form_submit('', 'Search') ; ?&gt;
    &lt;?php echo form_close() ; ?&gt;</pre></div></li><li class="listitem">Copy the following code at the top of the, <code class="literal">path/to/codeigniter/application/views/shop/display_products.php </code>file:<div class="informalexample"><pre class="programlisting">    &lt;?php echo form_open('shop/index') ; ?&gt;
        &lt;select name="cat"&gt;
            &lt;?php foreach ($cat_query-&gt;result() as $cat_row) : ?&gt;
                &lt;option value="&lt;?php echo $cat_row-&gt;cat_id;?&gt;"&gt;&lt;?php echo $cat_row-&gt;cat_name;?&gt;&lt;/option&gt;
            &lt;?php endforeach ; ?&gt;
        &lt;/select&gt;
    &lt;?php echo form_submit('', 'Search') ; ?&gt;
    &lt;?php echo form_close() ; ?&gt;</pre></div></li><li class="listitem">Replace <code class="literal">public function index()</code> in the shop controller with the following:<div class="informalexample"><pre class="programlisting">    public function index() {
        $this-&gt;load-&gt;library('form_validation');
        $this-&gt;form_validation-&gt;set_error_delimiters('', '&lt;br /&gt;');

        if ($this-&gt;input-&gt;post()) {
            $category_id = $this-&gt;input-&gt;post('cat');
        } else {
            $category_id = null;
        }

        $this-&gt;form_validation-&gt;set_rules('cat', 'Category', 'required|min_length[1]|max_length[125]|integer');
     
        if ($this-&gt;form_validation-&gt;run() == FALSE) {
            $data['query'] = $this-&gt;Shop_model-&gt;get_all_products($category_id);
            $data['cat_query'] = $this-&gt;Shop_model-&gt;get_all_categories();
            $this-&gt;load-&gt;view('shop/display_products', $data); 
        } else {
            $data['query'] = $this-&gt;Shop_model-&gt;get_all_products($category_id);
            $data['cat_query'] = $this-&gt;Shop_model-&gt;get_all_categories();
            $this-&gt;load-&gt;view('shop/display_products', $data);
        }
    }</pre></div></li><li class="listitem">Replace the <a id="id130" class="indexterm"/>shop <a id="id131" class="indexterm"/>controller <a id="id132" class="indexterm"/>function, <code class="literal">add()</code>, with <a id="id133" class="indexterm"/>the following code (the changes are highlighted):<div class="informalexample"><pre class="programlisting">public function add() {
        $product_id = $this-&gt;uri-&gt;segment(3);
        $query = $this-&gt;Shop_model-&gt;get_product_details($product_id);
        foreach($query-&gt;result() as $row) {
            $data = array(
                'id' =&gt; $row-&gt;product_id,
                'qty' =&gt; 1,
                'price' =&gt; $row-&gt;product_price,
                'name' =&gt; $row-&gt;product_name,
             );
        }

        $this-&gt;cart-&gt;insert($data);
<span class="strong"><strong>        $data['cat_query'] = $this-&gt;Shop_model-&gt;get_all_categories();</strong></span>

        $this-&gt;load-&gt;view('shop/display_cart', $data);
    }</pre></div></li><li class="listitem">Replace the controller <a id="id134" class="indexterm"/>function, <code class="literal">displat_cart()</code>, with the <a id="id135" class="indexterm"/>following code (the changes are highlighted):<div class="informalexample"><pre class="programlisting">public function display_cart() {
<span class="strong"><strong>        $data['cat_query'] = $this-&gt;Shop_model-&gt;get_all_categories();</strong></span>
        $this-&gt;load-&gt;view('shop/display_cart', $data);
    }</pre></div></li><li class="listitem">Replace <code class="literal">public function get_all_products()</code> in the <code class="literal">shop_model</code> with the following code:<div class="informalexample"><pre class="programlisting">public function get_all_products($category_id = null) {
        if ($category_id) {
            $this-&gt;db-&gt;where('category_id', $category_id);
        }
        $query = $this-&gt;db-&gt;get('products');
        return $query;
    }</pre></div></li><li class="listitem">Add the following function, <code class="literal">get_all_categories()</code>, to the <code class="literal">shop_model</code> as follows:<div class="informalexample"><pre class="programlisting">public function get_all_categories() {
        $query = $this-&gt;db-&gt;get('categories');
        return $query;
    }</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec44"/>How it works...</h2></div></div></div><p>We've amended <code class="literal">public function index()</code> so that we can filter the user's browsing results by <code class="literal">$category_id</code> (which is the primary key of each category in the database). If the page is being loaded for the first time (not as a submission), then the code:</p><div class="informalexample"><pre class="programlisting">  if ($this-&gt;input-&gt;post()) { 
            $category_id = $this-&gt;input-&gt;post('cat'); 
        } else { 
            $category_id = null; 
        }</pre></div><p>will automatically set <code class="literal">$category_id</code> to null so <code class="literal">$this-&gt;Shop_model-&gt;get_all_products($category_id)</code> will return all products regardless of <code class="literal">category_id</code>. However, if <code class="literal">$category_id</code> is passed with a form submission, then <code class="literal">$this-&gt;Shop_model-&gt;get_all_products($category_id)</code> will return only the products that are assigned to that category.</p></div></div>
<div class="section" title="Saving the cart to the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec28"/>Saving the cart to the database</h1></div></div></div><p>Before your customers are <a id="id136" class="indexterm"/>ready to proceed to payment, you need to take their details for payment, delivery, and your own records, and then move their cart that is in the session table to a specific table that will store orders.</p><p>Once the order has been saved and the <a id="id137" class="indexterm"/>customer details are supplied, a unique order code is generated and stored in <code class="literal">orders.order_fulfilment_code</code>. This can be used by a payment provider (for example, PayPal, GoCardless, Stripe, and so on) to keep track of the payment processing through their system and back into yours.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec45"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, create the following tables in your database:<div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `customer` (
  `cust_id` int(11) NOT NULL AUTO_INCREMENT,
  `cust_first_name` varchar(125) NOT NULL,
  `cust_last_name` varchar(125) NOT NULL,
  `cust_email` varchar(255) NOT NULL,
  `cust_created_at` int(11) NOT NULL,
  `cust_address` text NOT NULL COMMENT 'card holder address',
  PRIMARY KEY (`cust_id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;

CREATE TABLE `orders` (
  `order_id` int(11) NOT NULL AUTO_INCREMENT,
  `cust_id` int(11) NOT NULL,
  `order_details` text NOT NULL,
  `order_created_at` int(11) NOT NULL,
  `order_closed` int(1) NOT NULL COMMENT '0 = open, 1 = closed',
  `order_fulfilment_code` varchar(255) NOT NULL COMMENT 'the unique code sent to a payment provider',
  `order_delivery_address` text NOT NULL,
  PRIMARY KEY (`order_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1;</pre></div></li><li class="listitem">Now that we have created the <a id="id138" class="indexterm"/>database tables to store your customers and orders, let's create the files to support this new functionality. We're going to create the following two files:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/cust.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/cart_model.php</code></li></ul></div></li><li class="listitem">Create the, <code class="literal">/path/to/codeigniter/application/controllers/cust.php</code> <a id="id139" class="indexterm"/>controller and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Cust extends CI_Controller {
    function __construct() {
        parent::__construct();
        $this-&gt;load-&gt;library('cart');
        $this-&gt;load-&gt;helper('form');
        $this-&gt;load-&gt;helper('url');
        $this-&gt;load-&gt;helper('security');
        $this-&gt;load-&gt;model('Shop_model');
    }

    public function index() {
        redirect('cust/user_details');
    }

    public function user_details() {
        $this-&gt;load-&gt;library('form_validation');
        $this-&gt;form_validation-&gt;set_error_delimiters();
 
        // Set validation rules
        $this-&gt;form_validation-&gt;set_rules('first_name', 'First Name', 'required|min_length[1]|max_length[125]');
        $this-&gt;form_validation-&gt;set_rules('last_name', 'Last Name', 'required|min_length[1]|max_length[125]');
        $this-&gt;form_validation-&gt;set_rules('email', 
          'Email Address', 'required|min_length[1]|max_length[255]|valid_email');
        $this-&gt;form_validation-&gt;set_rules('email_confirm', 'Comfirmation Email Address', 
            'required|min_length[1]|max_length[255]|valid_email|matches[email]');
        $this-&gt;form_validation-&gt;set_rules('payment_address', 'Payment Address', 'required|min_length[1]|max_length[1000]');
        $this-&gt;form_validation-&gt;set_rules('delivery_address', 'Delivery Address', 'min_length[1]|max_length[1000]');
            
        // Begin validation
        if ($this-&gt;form_validation-&gt;run() == FALSE) {
            $this-&gt;load-&gt;view('shop/user_details');
        } else {
            $cust_data = array(
            'cust_first_name' =&gt; $this-&gt;input-&gt;post('cust_first_name'),
            'cust_last_name' =&gt; $this-&gt;input-&gt;post('cust_last_name'),
            'cust_email'=&gt; $this-&gt;input-&gt;post('cust_email'),
            'cust_address'  =&gt; $this-&gt;input-&gt;post('payment_address'),
            'cust_created_at' =&gt; time());
                    
            $payment_code = mt_rand();
                    
            $order_data = array(
            'order_details' =&gt; serialize($this-&gt;cart-&gt;contents()),
            'order_delivery_address' =&gt; $this-&gt;input-&gt;post('delivery_address'),
            'order_created_at' =&gt; time(),
            'order_closed' =&gt; '0',
            'order_fulfilment_code' =&gt; $payment_code,
            'order_delivery_address' =&gt; $this-&gt;input-&gt;post('payment_address'));
                    
            if ($this-&gt;Shop_model-&gt;save_cart_to_database($cust_data, $order_data)) {
                echo 'Order and Customer saved to DB';
            } else {
                echo 'Could not save to DB';
            }
        }
    }
}</pre></div></li><li class="listitem">Add <code class="literal">public function save_cart_to_db()</code> to the <code class="literal">models/shop_model.php</code> model as follows:<div class="informalexample"><pre class="programlisting">    public function save_cart_to_database($cust_data, $order_data) {
        $this-&gt;db-&gt;insert('customer', $cust_data);
        $order_data['cust_id'] = $this-&gt;db-&gt;insert_id();
        if ($this-&gt;db-&gt;insert('orders', $order_data)) {
            return true;
        } else {
            return false;
        }
    }</pre></div></li><li class="listitem">Amend the, <code class="literal">views/shop/display_cart.php </code>file. At the top of the page, add the following line:<div class="informalexample"><pre class="programlisting">&lt;?php echo anchor('cust/user_details', 'Proceed to checkout') ; ?&gt;</pre></div></li><li class="listitem">Create the <code class="literal">filepath/to/codeigniter/application/views/shop/user_details.php</code> file and add the <a id="id140" class="indexterm"/>following code into it:<div class="informalexample"><pre class="programlisting">&lt;body&gt;
    &lt;?php echo validation_errors(); ?&gt;
    &lt;?php echo form_open('/cust/user_details') ; ?&gt;
        &lt;?php echo form_input(array('name' =&gt; 'first_name', 'value' =&gt; 'First Name', 'maxlength' =&gt; '125', 'size' =&gt; '50')); ?&gt;&lt;br /&gt;
        &lt;?php echo form_input(array('name' =&gt; 'last_name', 'value' =&gt; 'Last Name', 'maxlength' =&gt; '125', 'size' =&gt; '50')); ?&gt;&lt;br /&gt;
        &lt;?php echo form_input(array('name' =&gt; 'email', 'value' =&gt; 'Email Address', 'maxlength' =&gt; '255', 'size' =&gt; '50')); ?&gt;&lt;br /&gt;
        &lt;?php echo form_input(array('name' =&gt; 'email_confirm', 'value' =&gt; 'Confirm Email', 'maxlength' =&gt; '255', 'size' =&gt; '50')); ?&gt;&lt;br /&gt;
        &lt;?php echo form_textarea(array('name' =&gt; 'payment_address', 'value' =&gt; 'Payment Address', 'rows' =&gt; '6', 'cols' =&gt; '40', 'size' =&gt; '50')); ?&gt;&lt;br /&gt;
        &lt;?php echo form_submit('', 'Enter') ; ?&gt;&lt;br /&gt;
        &lt;?php echo form_close() ; ?&gt;
    &lt;/form&gt;
&lt;/body&gt;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec46"/>How it works...</h2></div></div></div><p>To explain what's happening here, <a id="id141" class="indexterm"/>let's look at this from the customer's perspective. The customer has taken a look around the store and has selected a few items and placed them into the cart. The next step is to convert that cart into an order. So, the user clicks on <span class="strong"><strong>View Cart</strong></span> to view the products they wish to order (we've already covered this, so we won't go into it again.) When the user clicks on <span class="strong"><strong>Proceed to checkout</strong></span>, the public <a id="id142" class="indexterm"/>function, <code class="literal">user_details()</code>, is called, which displays <code class="literal">views/shop/user_details.php</code> to the customer. This asks them to enter some information; in this case, their name, e-mail address, payment, delivery address, and so on. On successfully submitting the form (that is, no validation errors), their order is moved from the cart to the database and matched with their submitted user details.</p><p>A tracking code is also created with the line, <code class="literal">$payment_code = mt_rand()</code>, which can be used to track the payment through a payment providers system.</p></div></div></body></html>