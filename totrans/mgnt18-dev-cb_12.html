<html><head></head><body><div class="chapter" title="Chapter&#xA0;12.&#xA0;Debugging and Unit Testing"><div class="titlepage"><div><div><h1 class="title"><a id="ch12"/>Chapter 12. Debugging and Unit Testing</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Getting started with Xdebug</li><li class="listitem" style="list-style-type: disc">Debugging with FirePHP</li><li class="listitem" style="list-style-type: disc">Installing PHPUnit</li><li class="listitem" style="list-style-type: disc">Creating a Magento test case</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec86"/>Introduction</h1></div></div></div><p>Debugging a website in an efficient way is one of the most important jobs of PHP developers. These<a id="id653" class="indexterm"/> days, a website is a lot more than some simple HTML pages. In a Magento web shop, you have a lot of complex business logic that is used in the flow of an e-commerce transaction.</p><p>Debugging in PHP is not out of the box like in other programming languages. There are many ways to configure a <a id="id654" class="indexterm"/>PHP debugger (Xdebug) with a good code editor such as NetBeans. With some extra tools such as FirePHP and the Zend Wildfire plugin, debugging is much easier.</p><p>Another part of debugging is <a id="id655" class="indexterm"/>automated tests. While working with objects and functions, there are many ways to write some tests that you can run on a set of configured functions. A report will show you the information about the passed and failed tests.</p></div></div>
<div class="section" title="Getting started with Xdebug"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec87"/>Getting started with Xdebug</h1></div></div></div><p>The most common way of debugging a PHP application is to use some functions such as <a id="id656" class="indexterm"/>
<code class="literal">echo</code>, <a id="id657" class="indexterm"/>
<code class="literal">die()</code>, <a id="id658" class="indexterm"/>
<code class="literal">var_dump()</code>,<a id="id659" class="indexterm"/>and <code class="literal">print_r()</code>. In Magento, you can use the <code class="literal">Mage::log()</code> statement to print some logs to a file, but this isn't a real debugger.</p><p>With a real debugger, you can break the script and look at the variables and values they have. You can also change values, go further, skip statements, and more.</p><p>In PHP, you can configure Xdebug to debug your PHP script or application. In this recipe, we will see how to install Xdebug in the development environment and how we can integrate it with an IDE.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec220"/>Getting ready</h2></div></div></div><p>In this recipe, we will start an Xdebug session with the NetBeans IDE. Open NetBeans and set the <span class="strong"><strong>Magento</strong></span> project as <span class="strong"><strong>Main Project</strong></span>. Make sure all the URLs are configured correctly in the <span class="strong"><strong>Property</strong></span> settings of the project.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec221"/>How to do it...</h2></div></div></div><p>The following steps show you how<a id="id660" class="indexterm"/> you can install Xdebug on your development server:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We will install Xdebug with the PHP <code class="literal">pear</code> library. Make sure it is installed. If not, run the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install php5-dev</strong></span>
<span class="strong"><strong>sudo apt-get install php-pear</strong></span>
</pre></div></li><li class="listitem">The next step is to install the <code class="literal">xdebug</code> library. You can do this with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo pecl install xdebug</strong></span>
</pre></div></li><li class="listitem">This command gives the following output:<div class="mediaobject"><img src="graphics/3329OS_12_01.jpg" alt="How to do it..."/></div></li><li class="listitem">As you can read in the screenshot, we have to locate the <code class="literal">xdebug.so</code> file in the <code class="literal">php.ini</code> file. To find out the path of the <code class="literal">xdebug.so</code> file, run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>find / -name 'xdebug.so'</strong></span>
</pre></div></li><li class="listitem">When you have the path, add the following line in the <code class="literal">php.ini</code> file. Open the file with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo nano /etc/php5/apache2/php.ini</strong></span>
</pre></div></li><li class="listitem">Also, do the same for the <code class="literal">cli/php.ini</code> file:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo nano /etc/php5/cli/php.ini</strong></span>
</pre></div></li><li class="listitem">Paste the<a id="id661" class="indexterm"/> following line of code at the end:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>zend_extension="/usr/lib/php5/20100525/xdebug.so"</strong></span>
</pre></div><p>Make sure the path matches the path of the <code class="literal">xdebug.so</code> file on your server.</p></li><li class="listitem">Restart the Apache server with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo service apache2 restart</strong></span>
</pre></div></li><li class="listitem">To test if Xdebug is<a id="id662" class="indexterm"/> correctly installed, you can check it with <code class="literal">phpinfo()</code> in the browser or you can run the following command that checks the <code class="literal">phpinfo()</code> page using the command prompt:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php -i | grep xdebug</strong></span>
</pre></div></li><li class="listitem">The previous command gives the following output:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>xdebug</strong></span>
<span class="strong"><strong>xdebug support =&gt; enabled</strong></span>
<span class="strong"><strong>xdebug.auto_trace =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.cli_color =&gt; 0 =&gt; 0</strong></span>
<span class="strong"><strong>xdebug.collect_assignments =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.collect_includes =&gt; On =&gt; On</strong></span>
<span class="strong"><strong>xdebug.collect_params =&gt; 0 =&gt; 0</strong></span>
<span class="strong"><strong>xdebug.collect_return =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.collect_vars =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.coverage_enable =&gt; On =&gt; On</strong></span>
<span class="strong"><strong>xdebug.default_enable =&gt; On =&gt; On</strong></span>
<span class="strong"><strong>xdebug.dump.COOKIE =&gt; no value =&gt; no value</strong></span>
<span class="strong"><strong>xdebug.dump.ENV =&gt; no value =&gt; no value</strong></span>
<span class="strong"><strong>xdebug.dump.FILES =&gt; no value =&gt; no value</strong></span>
<span class="strong"><strong>xdebug.dump.GET =&gt; no value =&gt; no value</strong></span>
<span class="strong"><strong>xdebug.dump.POST =&gt; no value =&gt; no value</strong></span>
<span class="strong"><strong>xdebug.dump.REQUEST =&gt; no value =&gt; no value</strong></span>
<span class="strong"><strong>xdebug.dump.SERVER =&gt; no value =&gt; no value</strong></span>
<span class="strong"><strong>xdebug.dump.SESSION =&gt; no value =&gt; no value</strong></span>
<span class="strong"><strong>xdebug.dump_globals =&gt; On =&gt; On</strong></span>
<span class="strong"><strong>xdebug.dump_once =&gt; On =&gt; On</strong></span>
<span class="strong"><strong>xdebug.dump_undefined =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.extended_info =&gt; On =&gt; On</strong></span>
<span class="strong"><strong>xdebug.file_link_format =&gt; no value =&gt; no value</strong></span>
<span class="strong"><strong>xdebug.idekey =&gt; no value =&gt; no value</strong></span>
<span class="strong"><strong>xdebug.max_nesting_level =&gt; 100 =&gt; 100</strong></span>
<span class="strong"><strong>xdebug.overload_var_dump =&gt; On =&gt; On</strong></span>
<span class="strong"><strong>xdebug.profiler_aggregate =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.profiler_append =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.profiler_enable =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.profiler_enable_trigger =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.profiler_output_dir =&gt; /tmp =&gt; /tmp</strong></span>
<span class="strong"><strong>xdebug.profiler_output_name =&gt; cachegrind.out.%p =&gt; cachegrind.out.%p</strong></span>
<span class="strong"><strong>xdebug.remote_autostart =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.remote_connect_back =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.remote_cookie_expire_time =&gt; 3600 =&gt; 3600</strong></span>
<span class="strong"><strong>xdebug.remote_enable =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.remote_handler =&gt; dbgp =&gt; dbgp</strong></span>
<span class="strong"><strong>xdebug.remote_host =&gt; localhost =&gt; localhost</strong></span>
<span class="strong"><strong>xdebug.remote_log =&gt; no value =&gt; no value</strong></span>
<span class="strong"><strong>xdebug.remote_mode =&gt; req =&gt; req</strong></span>
<span class="strong"><strong>xdebug.remote_port =&gt; 9000 =&gt; 9000</strong></span>
<span class="strong"><strong>xdebug.scream =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.show_exception_trace =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.show_local_vars =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.show_mem_delta =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.trace_enable_trigger =&gt; Off =&gt; Off</strong></span>
<span class="strong"><strong>xdebug.trace_format =&gt; 0 =&gt; 0</strong></span>
<span class="strong"><strong>xdebug.trace_options =&gt; 0 =&gt; 0</strong></span>
<span class="strong"><strong>xdebug.trace_output_dir =&gt; /tmp =&gt; /tmp</strong></span>
<span class="strong"><strong>xdebug.trace_output_name =&gt; trace.%c =&gt; trace.%c</strong></span>
<span class="strong"><strong>xdebug.var_display_max_children =&gt; 128 =&gt; 128</strong></span>
<span class="strong"><strong>xdebug.var_display_max_data =&gt; 512 =&gt; 512</strong></span>
<span class="strong"><strong>xdebug.var_display_max_depth =&gt; 3 =&gt; 3</strong></span>
</pre></div></li><li class="listitem">The next step<a id="id663" class="indexterm"/> is to configure the NetBeans Xdebug integration. To make NetBeans work with Xdebug, we have to add the following configuration at the end of the <code class="literal">php.ini</code> file:<div class="informalexample"><pre class="programlisting">xdebug.remote_enable=1
xdebug.remote_handler=dbgp
xdebug.remote_mode=req
xdebug.remote_host=localhost
xdebug.remote_port=9000
xdebug.idekey="netbeans-xdebug"</pre></div></li><li class="listitem">Restart your Apache server and look at the <code class="literal">phpinfo()</code>page to see if the Xdebug settings have been applied.</li><li class="listitem">The next step is to check your NetBeans debug settings. Navigate to <span class="strong"><strong>Tools</strong></span> | <span class="strong"><strong>Options</strong></span> and configure it as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_12_02.jpg" alt="How to do it..."/></div></li><li class="listitem">The next step<a id="id664" class="indexterm"/> is to check if the project URL has the right value. Open the <span class="strong"><strong>Project Properties</strong></span> and go to <span class="strong"><strong>Run Configuration</strong></span>. Make sure the <span class="strong"><strong>Project URL</strong></span> field has the right value as shown the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_12_03.jpg" alt="How to do it..."/></div></li><li class="listitem">We are now ready to start the first debug session. To start it, we have to click on the debug button that is near the run button. You can also use the shortcut <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>F5</em></span>.</li><li class="listitem">When starting<a id="id665" class="indexterm"/> a debug session, a new tab will be added in the browser with a URL like the following:<p>
<code class="literal">http://magento-dev.local/?XDEBUG_SESSION_START=netbeans-xdebug</code>
</p></li><li class="listitem">The web page doesn't load because the debugger is interrupting the process. To continue, we have to use the debugger controls in NetBeans.</li><li class="listitem">When you add a breakpoint in the <code class="literal">index.php</code> file on line 87, <code class="literal">Mage::run($mageRunCode, $mageRunType)</code>, and continue with the debugger, you will see the variable values as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_12_04.jpg" alt="How to do it..."/></div></li><li class="listitem">When you<a id="id666" class="indexterm"/> continue with the breakpoint, you will see that the page will be loaded.</li><li class="listitem">The debug session stays alive until you hit the stop button in NetBeans. When you browse to other pages on your website, the debugger will continue as long as the session is alive.</li><li class="listitem">To stop the debug session, click on the stop button in NetBeans. A browser page will be opened with the message that the session has stopped.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec222"/>How it works...</h2></div></div></div><p>Xdebug needs<a id="id667" class="indexterm"/> to be installed on the server where you want to debug it. In this recipe, the server used is the local debug server.</p><p>We installed Xdebug using PEAR. PEAR is an application repository for PHP plugins. With PEAR, we downloaded and installed the <code class="literal">xdebug</code> library.</p><p>When Xdebug was installed on the server, we configured the <code class="literal">php.ini</code> file to use the <code class="literal">xdebug</code> library. <a id="id668" class="indexterm"/>We added some settings to make the Xdebug configuration compatible with NetBeans.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip47"/>Tip</h3><p>When using Xdebug on a remote server, make sure you can connect to the server trough port 9000. This is mostly disabled on the firewall of the server and your local PC.</p></div></div><p>When the server was configured properly, we checked the configurations in NetBeans and started the debug session. When this session was started, we were able to debug the Magento application like a debugger does it.</p><p>The debugger enables <a id="id669" class="indexterm"/>advanced debugging features such as the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting breakpoints</li><li class="listitem" style="list-style-type: disc">Executing the code statement-by-statement</li><li class="listitem" style="list-style-type: disc">Skipping parts of code</li><li class="listitem" style="list-style-type: disc">Browsing and changing variable names</li></ul></div></div></div>
<div class="section" title="Debugging with FirePHP"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec88"/>Debugging with FirePHP</h1></div></div></div><p>FirePHP is a plugin that you can install in Firefox. It is integrated in the Firebug console that makes it easy to use as a debugging tool. On the server, FirePHP also needs to be installed. We can do<a id="id670" class="indexterm"/> that easily with the PEAR repository, like we did with Xdebug in the previous recipe.</p><p>To debug with FirePHP, <a id="id671" class="indexterm"/>we need another PHP library. This is the Zend Wildfire plugin in the Zend Framework. Magento is built on the Zend Framework, so the Wildfire plugin is standard installed. </p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec223"/>Getting ready</h2></div></div></div><p>
<span class="strong"><strong>FirePHP</strong></span> is a plugin that runs in <span class="strong"><strong>Firebug</strong></span><a id="id672" class="indexterm"/>. To make them work, we need to install Firebug and FirePHP as Firefox add-ons using the following links:</p><p>
<a class="ulink" href="https://addons.mozilla.org/us/firefox/addon/firebug/">https://addons.mozilla.org/us/firefox/addon/firebug/</a>
</p><p>
<a class="ulink" href="https://addons.mozilla.org/us/firefox/addon/firephp/">https://addons.mozilla.org/us/firefox/addon/firephp/</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec224"/>How to do it...</h2></div></div></div><p>The following steps describe how we can use FirePHP in a Magento project:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Make sure all the Firefox plugins are installed.</li><li class="listitem">Open your Magento project<a id="id673" class="indexterm"/> in your IDE such as NetBeans.</li><li class="listitem">Open the <code class="literal">index.php</code> file and add the following code in it at the end of the file:<div class="informalexample"><pre class="programlisting">// ------------------------------------------------------
// Zend Wildfire log function
// ------------------------------------------------------
/**
 * Logs variables to the Firebug Console
 * via HTTP response headers and the FirePHP Firefox Extension.
 *
 * @param mixed $var The variable to log.
 * @param string $label OPTIONAL Label to prepend to the log
  event.
 * @param string $style OPTIONAL Style of the log event.
 * @param array $options OPTIONAL Options to change how messages
  are processed and sent
 * @return boolean Returns TRUE if the variable was added to the
  response headers or buffered.
 * @throws Zend_Wildfire_Exception
 */
function logFirePHP($var, $label = 'Magento vars', $style = 'INFO', $options = array()) {
    if (Mage::getIsDeveloperMode()) {
        $httpRequest = new Zend_Controller_Request_Http();
        $httpResponse = new Zend_Controller_Response_Http();
        $channel = Zend_Wildfire_Channel_HttpHeaders::getInstance();
        $channel-&gt;setRequest($httpRequest);
        $channel-&gt;setResponse($httpResponse);
        ob_start();
        Zend_Wildfire_Plugin_FirePhp::send($var, $label, $style, $options);
        $channel-&gt;flush();
        $httpResponse-&gt;sendHeaders();
    } else {
        return null;
    }
}
// ------------------------------------------------------
// End Zend Wildfire function
// ------------------------------------------------------</pre></div></li><li class="listitem">Save the file <code class="literal">index.php</code>.</li><li class="listitem">Enable the Magento <span class="strong"><strong>Profiler</strong></span> and the Magento developer mode.</li><li class="listitem">We prepared the <a id="id674" class="indexterm"/>Magento installation to work with FirePHP. To log something through it, we can use the function <code class="literal">logFirePHP()</code> to print something in the log. Open the file <code class="literal">app/design/frontend/base/default/template/catalog/product/view.phtml</code>.</li><li class="listitem">Add the following code at the end of the file:<div class="informalexample"><pre class="programlisting">&lt;?php logFirePHP($_product-&gt;debug()) ?&gt;</pre></div></li><li class="listitem">When you open a product detail page and the Firebug console, you should have an output similar to the one shown in the following screenshot:</li></ol></div><div class="mediaobject"><img src="graphics/3329OS_12_05.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec225"/>How it works...</h2></div></div></div><p>FirePHP is a<a id="id675" class="indexterm"/> logging tool that shows log messages in the Firebug console. We create the log messages with the function <code class="literal">logFirePHP()</code> that we added in the <code class="literal">index.php</code> file. </p><p>When using the <code class="literal">logFirePHP()</code> function, a header will be added to the HTTP request. FirePHP will pick up these headers and print them in the Firebug console.</p><p>With the function <a id="id676" class="indexterm"/>
<code class="literal">logFirePHP()</code>, we can set the log message in the first parameter. This can be any variable such as a string, an array, an object, or something else.</p><p>The second parameter is the name of the log message that will show up in the Firebug console.</p><p>The last parameter is the type of log message. You can show a message with the following options:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">LOG</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">INFO</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">WARN</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ERROR</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">EXCEPTION</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">TRACE</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">TABLE</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">DUMP</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">GROUP_START</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">GROUP_END</code></li></ul></div></div></div>
<div class="section" title="Installing PHPUnit"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec89"/>Installing PHPUnit</h1></div></div></div><p>When we want to start with <span class="strong"><strong>unit testing</strong></span> in PHP, we need a tool that is called <a id="id677" class="indexterm"/>
<span class="strong"><strong>PHPUnit</strong></span>. When PHPUnit is installed, <a id="id678" class="indexterm"/>we can start loading tests with the <code class="literal">phpunit</code> command in the command<a id="id679" class="indexterm"/> line.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec226"/>Getting ready</h2></div></div></div><p>Before installing PHPUnit, make sure PEAR is installed on your server. If it is not done, you can do this by running the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install php-pear</strong></span>
</pre></div><p>You can also install it using a file. You can find information about this procedure by navigating to the following URL:</p><p>
<a class="ulink" href="http://pear.php.net/manual/en/installation.php">http://pear.php.net/manual/en/installation.php</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec227"/>How to do it...</h2></div></div></div><p>Follow the next steps to install PHPUnit on your development server:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To install PHPUnit,<a id="id680" class="indexterm"/> we have to use a custom PEAR channel. We need to register the PHPUnit PEAR channel before we can install PHPUnit over PEAR. With the next command, we will add the extra channel to the PEAR environment:<div class="informalexample"><pre class="programlisting">sudo pear channel-discover pear.phpunit.de</pre></div></li><li class="listitem">The PHPUnit channel depends on some other channels. We need to discover the channel <code class="literal">components.ez.no</code> too:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo pear channel-discover components.ez.no</strong></span>
</pre></div></li><li class="listitem">The last channel that we have to discover is the <span class="strong"><strong>Symfony Components</strong></span><a id="id681" class="indexterm"/> PEAR channel. With the following command, we will discover the channel <code class="literal">pear.symfony-project.com</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo pear channel-discover pear.symfony-project.com</strong></span>
<span class="strong"><strong>sudo pear channel-discover pear.symfony.com</strong></span>
</pre></div></li><li class="listitem">When we have discovered all <a id="id682" class="indexterm"/>the required channels, it is<a id="id683" class="indexterm"/> time to install the <code class="literal">PHPUnit</code> library. We can do this by running the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo pear install phpunit/PHPUnit</strong></span>
</pre></div></li><li class="listitem">The result of this command will end with the following lines:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>install ok: channel://pear.phpunit.de/File_Iterator-1.3.4</strong></span>
<span class="strong"><strong>install ok: channel://pear.phpunit.de/Text_Template-1.1.4</strong></span>
<span class="strong"><strong>install ok: channel://pear.phpunit.de/PHP_Timer-1.0.5</strong></span>
<span class="strong"><strong>install ok: channel://pear.phpunit.de/PHP_TokenStream-1.2.1</strong></span>
<span class="strong"><strong>install ok: channel://pear.phpunit.de/PHP_CodeCoverage-1.2.13</strong></span>
<span class="strong"><strong>install ok: channel://pear.phpunit.de/PHPUnit_MockObject-1.2.3</strong></span>
<span class="strong"><strong>install ok: channel://pear.symfony.com/Yaml-2.3.6</strong></span>
<span class="strong"><strong>install ok: channel://pear.phpunit.de/PHPUnit-3.7.28</strong></span>
</pre></div></li><li class="listitem">When running this command, the installer will download and prepare all the required packages so that you can use them.</li><li class="listitem">The last thing is to install the CLI component for PHP. This is most probably installed; if it is not installed, we have to run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install php5-cli</strong></span>
</pre></div></li><li class="listitem">The last thing to do is to test that everything we have installed works. To test this, we can run the command <code class="literal">phpunit --version</code><a id="id684" class="indexterm"/>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ phpunit –version</strong></span>

<span class="strong"><strong>PHPUnit 3.7.28 by Sebastian Bergmann.</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec228"/>How it works...</h2></div></div></div><p>As part of the xUnit, PHPUnit is the<a id="id685" class="indexterm"/> most popular framework for PHP unit testing. The xUnit framework contains unit testing frameworks for many programming languages, such as the JUnit for Java.</p><p>To install<a id="id686" class="indexterm"/> the PHPUnit libraries<a id="id687" class="indexterm"/>, we used the PEAR installer (which is an extension of PHP) for downloading and installing extra plugins. To add more plugins, we can add extra channels to PEAR like we did while installing PHPUnit.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec229"/>There's more...</h2></div></div></div><p>When you want to install the <code class="literal">PHPUnit</code> library without PEAR, you can do it by using the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first thing to do is to download the library files that you can find by navigating to the following URL <a class="ulink" href="http://pear.phpunit.de/get/">http://pear.phpunit.de/get/</a>.</li><li class="listitem">Extract the files in the<a id="id688" class="indexterm"/> <code class="literal">include_path</code> function that is defined in the <code class="literal">php.ini</code> configuration.</li><li class="listitem">The next step is to configure the PHPUnit script. First move the <code class="literal">phpunit.php</code> file to <code class="literal">phpunit</code>.</li><li class="listitem">Open the file and replace the string <code class="literal">@php_bin@</code> with your PHP bin path. Usually, this is <code class="literal">/usr/bin/php</code>.</li><li class="listitem">Copy the file to a location that is in your Linux <code class="literal">PATH</code>. Be sure to make the script executable.</li><li class="listitem">The last thing to do is to change something in the <code class="literal">PHPUnit/Util/PHP.php</code> file. Open this file and change the <code class="literal">@php_bin@</code> string with you PHP bin path. Usually, this is <code class="literal">/usr/bin/php</code>.</li><li class="listitem">You can now run the <code class="literal">phpunit</code> command.</li></ol></div></div></div>
<div class="section" title="Creating a Magento test case"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec90"/>Creating a Magento test case</h1></div></div></div><p>For the last recipe of this chapter, <a id="id689" class="indexterm"/>we will write an automated test with PHPUnit. PHPUnit is the unit testing framework that we have installed in the previous chapter.</p><p>Unit testing is a key part of <span class="strong"><strong>Test Driven Development </strong></span>(<span class="strong"><strong>TDD</strong></span>).<a id="id690" class="indexterm"/> With TDD, we will write the test case first, and then we will write the code that returns the expected values that we defined in the test case.</p><p>With Magento, which is based <a id="id691" class="indexterm"/>on the Zend Framework and built with TDD, it is possible to write unit tests with PHPUnit for a custom or existing module. In this recipe, we will see all the steps that you have to perform for a custom unit test.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec230"/>Getting ready</h2></div></div></div><p>In this recipe, we will create a unit test for the <code class="literal">Packt_Helloworld</code> module that we created and extended<a id="id692" class="indexterm"/> in <a class="link" href="ch04.html" title="Chapter 4. Creating a Module">Chapter 4</a>, <span class="emphasis"><em>Creating a Module</em></span>, <span class="emphasis"><em>Chapter 6</em></span>, <a class="link" href="ch06.html" title="Chapter 6. Databases and Modules">Chapter 6</a>, <span class="emphasis"><em>Databases and Modules</em></span>, <a class="link" href="ch07.html" title="Chapter 7. Magento Backend">Chapter 7</a>, <span class="emphasis"><em>Magento Backend</em></span>, and <a class="link" href="ch08.html" title="Chapter 8. Event Handlers and Cronjobs">Chapter 8</a>, <span class="emphasis"><em>Event Handlers and Cronjobs</em></span>.</p><p>If you don't have the complete code, you can download it from the Packt Publishing website <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec231"/>How to do it...</h2></div></div></div><p>Follow these<a id="id693" class="indexterm"/> steps to create a unit test for Magento:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a folder named<code class="literal"> unit-tests</code> in your Magento root.</li><li class="listitem">Create an <code class="literal">autoload.php</code> file in the <code class="literal">unit-tests</code> folder.</li><li class="listitem">Open the <code class="literal">autoload.php</code> file and add the following content in it:<div class="informalexample"><pre class="programlisting">&lt;?php

ini_set('include_path', ini_get('include_path') . PATH_SEPARATOR . dirname(__FILE__) . '/../app' . PATH_SEPARATOR . dirname(__FILE__));

//Set custom memory limit
ini_set('memory_limit', '512M');

//Include Magento libraries
require_once 'Mage.php';

//Start the Magento application
Mage::app('default');

//Avoid issues "Headers already send"
session_start(); </pre></div></li><li class="listitem">Create a <code class="literal">phpunit.xml</code> file in the <code class="literal">unit-tests</code> folder with the following content:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;phpunit backupGlobals="false"
         backupStaticAttributes="false"
         colors="true"
         convertErrorsToExceptions="true"
         convertNoticesToExceptions="true"
         convertWarningsToExceptions="true"
         processIsolation="false"
         stopOnFailure="false"
         syntaxCheck="true"
         bootstrap="./autoload.php"&gt;
    &lt;testsuite name="Magento Unit Test"&gt;
        &lt;directory&gt;./&lt;/directory&gt;
    &lt;/testsuite&gt;
    &lt;filter&gt;
        &lt;whitelist&gt;
            &lt;directory&gt;../app/code/local&lt;/directory&gt;
        &lt;/whitelist&gt;
    &lt;/filter&gt;
&lt;/phpunit&gt; </pre></div></li><li class="listitem">The next step is to <a id="id694" class="indexterm"/>create a folder tree as shown in<a id="id695" class="indexterm"/> the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_12_06.jpg" alt="How to do it..."/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip48"/>Tip</h3><p>Instead of creating all the folders manually, you can also run the following Linux command in your terminal: <code class="literal">mkdir -p app/code/local/Packt/Helloworld/Model/</code>.</p></div></div></li><li class="listitem">In the folder <code class="literal">app/code/local/Packt/Helloworld/Model/</code>, create a new PHP file called <code class="literal">SubscriptionTest.php</code>.</li><li class="listitem">In the <code class="literal">SubscriptionTest.php</code> file, add the <a id="id696" class="indexterm"/>following <a id="id697" class="indexterm"/>content:<div class="informalexample"><pre class="programlisting">&lt;?php
class SubscriptionTest extends PHPUnit_Framework_TestCase {

    protected $_subscriptionInstance;

    public function setUp() {
        echo 'Start unit test for method: ' . $this-&gt;getName();
        
        Mage::app('default');
        
        $this-&gt;_subscriptionInstance = Mage::getModel('helloworld/subscription');
    }

    protected function tearDown() {
        
    }

    public function testGetAllSubscriptions() {
        $subscriptions = $this-&gt;_subscriptionInstance-&gt;getCollection();
        
        //Check if $subscriptions is instance of the collection class
        $this-&gt;assertInstanceOf('Packt_Helloworld_Model_Resource_Subscription_Collection', $subscriptions);
    }

} </pre></div></li><li class="listitem">To start the unit test, open the terminal and navigate to the <code class="literal">unit-tests</code> directory of your Magento installation using the following command:<div class="informalexample"><pre class="programlisting">cd /var/www/magento-dev/unit-tests</pre></div></li><li class="listitem">In the <code class="literal">unit-tests</code> folder, run the<a id="id698" class="indexterm"/> <code class="literal">phpunit</code> command. This will give you an output as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_12_07.jpg" alt="How to do it..."/></div></li><li class="listitem">When you see the message <code class="literal">OK (1 test, 1 assertion)</code>, the test has passed. </li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec232"/>How it works...</h2></div></div></div><p>We started this recipe<a id="id699" class="indexterm"/> by creating all the required folders for the unit test. We created the following files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">autoload.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">phpunit.xml</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">SubscriptionTest.php </code></li></ul></div><p>The bootstrap of the <a id="id700" class="indexterm"/>
<code class="literal">phpunit</code> command is configured in the <code class="literal">phpunit.xml</code> file. In this file, at the beginning of the command, we can configure some parameters that are important. We have configured the loader file <code class="literal">autoload.php</code> and some other values of global variables and error-reporting variables.</p><p>In the <code class="literal">phpunit.xml</code> file, we configured the <code class="literal">autoload.php</code> file first in order to run it. In this file, we set the <code class="literal">include</code> path with the path of the Magento application, some PHP settings, and the inclusion of the <code class="literal">Mage.php</code> file.</p><p>The unit test itself is written in the <code class="literal">SubscriptionTest.php</code> file. In this file, we created a class that extends the <code class="literal">PHPUnit_Framework_Testcase</code> class. This parent class contains all the logic for the unit test and the generic functions.</p><p>In the <a id="id701" class="indexterm"/>
<code class="literal">setup()</code> function, we can write some code to bootstrap the test. In this case, we created an instance of the subscriptions collection.</p><p>The unit test is in the <a id="id702" class="indexterm"/>
<code class="literal">testGetAllSubscriptions()</code> method. The <code class="literal">phpunit</code> command will run all the <code class="literal">test*</code> functions in that class. In this function, we used the function <code class="literal">assertInstanceOf()</code> to see if the type of the class matches the value that is set in the first parameter.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec233"/>There's more...</h2></div></div></div><p>In this case, we used the assertion function<a id="id703" class="indexterm"/> <code class="literal">assertInstanceOf()</code> that will look at the instance type of the variable. <a id="id704" class="indexterm"/>There are many more assertion functions that you can use with PHPUnit. For example, a function that compares a number and a function to check for null values. </p><p>A full list of the assertion methods can be found at the following URL:</p><p>
<a class="ulink" href="http://phpunit.de/manual/3.7/en/writing-tests-for-phpunit.html#writing-tests-for-phpunit.assertions">http://phpunit.de/manual/3.7/en/writing-tests-for-phpunit.html#writing-tests-for-phpunit.assertions</a>
</p></div></div></body></html>