<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Working with Databases and Models"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Working with Databases and Models</h1></div></div></div><p>In this chapter, we will cover the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Configuring database credentials</li><li class="listitem" style="list-style-type: disc">Loading the database object</li><li class="listitem" style="list-style-type: disc">Retrieving data from the database</li><li class="listitem" style="list-style-type: disc">Writing data to the database</li><li class="listitem" style="list-style-type: disc">Guarding against SQL injections with prepared statements</li><li class="listitem" style="list-style-type: disc">Creating a custom model class</li><li class="listitem" style="list-style-type: disc">Reading from the database with active record</li><li class="listitem" style="list-style-type: disc">Writing to the database with active record</li><li class="listitem" style="list-style-type: disc">Updating a database record with active record</li><li class="listitem" style="list-style-type: disc">Searching the database using active record</li><li class="listitem" style="list-style-type: disc">Deleting objects using active record and model classes</li><li class="listitem" style="list-style-type: disc">Defining relationships with active record</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec97"/>Introduction</h1></div></div></div><p>Web applications get a great deal of their capabilities from being connected to a database. concrete5 is a <span class="strong"><strong>LAMP</strong></span> application (runs on Linux, Apache, MySQL, and PHP). MySQL is the database that concrete5 uses, which is the most popular open source database in the world.</p><p>In this chapter, we will discover the ways to interact with the database in concrete5, both with plain SQL queries, and with the more object-oriented active record approach. We will learn how to safeguard against SQL injection attacks, create custom model classes, and query the database using objects and active record.</p><p>This chapter will use some basic SQL queries, so some familiarity with writing database queries is recommended.</p><div class="section" title="Configuring database credentials"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec332"/>Configuring database credentials</h2></div></div></div><p>Before we are able to read and <a id="id358" class="indexterm"/>write to the database, we need to make sure concrete5 has the correct database credentials. Typically these credentials are set during installation, but if you are moving a concrete5 to another server or changing the username or password of the concrete5 user, it is important to know how to configure database access.</p><p>In this recipe, we will act as though we are specifying the credentials from scratch. This will allow us to explore each value that is stored in the database.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec333"/>How to do it...</h2></div></div></div><p>Have a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/config/site.php</code> in your preferred code editor.</li><li class="listitem">Specify the host name of the database server. In many instances, this is simply <code class="literal">localhost</code>:<div class="informalexample"><pre class="programlisting">define('DB_SERVER', 'localhost');</pre></div></li><li class="listitem">Set the username that concrete5 will use to connect to the database:<div class="informalexample"><pre class="programlisting">define('DB_USERNAME', 'user');</pre></div></li><li class="listitem">Set the password for that users:<div class="informalexample"><pre class="programlisting">define('DB_PASSWORD', 'password');</pre></div></li><li class="listitem">Finally, specify the name of the database that concrete5 will connect to:<div class="informalexample"><pre class="programlisting">define('DB_DATABASE', 'concrete5');</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec334"/>How it works...</h2></div></div></div><p>The <code class="literal">site.php</code> file is automatically loaded by concrete5 when the site is accessed. Developers can define configuration constants here using PHP's <code class="literal">define</code> function. The first parameter of the <code class="literal">define</code> function is the constant's name, do <span class="emphasis"><em>not</em></span> change this. The second parameter, however, should contain the corresponding value for the particular setting.</p><p>Make sure that the user that you choose for concrete5 has sufficient access to the database and is allowed to perform all of the necessary queries.</p><p>Improperly configured database settings in this file will result in the website displaying an error.</p></div></div></div>
<div class="section" title="Loading the database object"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec98"/>Loading the database object</h1></div></div></div><p>At the heart of performing queries on the database in concrete5, is the database object. The database object exposes several <a id="id359" class="indexterm"/>methods that allow developers to perform queries on the database.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec335"/>How to do it...</h2></div></div></div><p>Have a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We will need a place to play around with some test code. Open <code class="literal">/config/site_post.php</code> which will serve us well in your code editor.</li><li class="listitem">Write the following code snippet to load the database object:<div class="informalexample"><pre class="programlisting">$db = Loader::db();</pre></div></li><li class="listitem">Now that the database object is loaded, take a look at some of the methods that it exposes:<div class="informalexample"><pre class="programlisting">$methods = get_class_methods($db);</pre></div></li><li class="listitem">Dump the array of methods to the screen:<div class="informalexample"><pre class="programlisting">var_dump($methods);
exit;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec336"/>How it works...</h2></div></div></div><p>concrete5 will use the database settings from your configuration file (likely located at <code class="literal">/config/site.php</code>) and connect to the database, returning an object containing several useful methods for interacting with the database.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec337"/>There's more...</h2></div></div></div><p>If you'd like to connect to a database other than the one specified in <code class="literal">site.php</code>, you can pass in the new database credentials as parameters to the database loader, as shown in the following:</p><div class="informalexample"><pre class="programlisting">$db = Loader::db('host', 'user', 'password', 'database');</pre></div></div></div>
<div class="section" title="Retrieving data from the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec99"/>Retrieving data from the database</h1></div></div></div><p>Once you have loaded the <a id="id360" class="indexterm"/>database object, you can perform queries against it. <a id="id361" class="indexterm"/>In this recipe, we will select the contents of the <code class="literal">Users</code> table, and echo out each username.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec338"/>Getting ready</h2></div></div></div><p>Make sure you understand how to write database queries with SQL before diving into writing queries by hand in <a id="id362" class="indexterm"/>concrete5. There are dozens of MySQL resources available online and in print that go far <a id="id363" class="indexterm"/>beyond the scope of this book!</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec339"/>How to do it...</h2></div></div></div><p>Have a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Load the database object:<div class="informalexample"><pre class="programlisting">$db = Loader::db();</pre></div></li><li class="listitem">Write the query to select from the <code class="literal">Users</code> table:<div class="informalexample"><pre class="programlisting">$query = 'SELECT * FROM Users';</pre></div></li><li class="listitem">Execute the query:<div class="informalexample"><pre class="programlisting">$results = $db-&gt;getAll($query);</pre></div></li><li class="listitem">Loop through the results and echo each user's username:<div class="informalexample"><pre class="programlisting">foreach ($results as $user) {
   echo $user['uName'].'&lt;br /&gt;';
}
 exit;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec340"/>How it works...</h2></div></div></div><p>This function works as you'd expect, but it takes a little of the tedium out of performing raw database queries with PHP and MySQL. Calling <code class="literal">getAll</code> function on the database object returns an array of all of the results. Each result is also an array, with keys that correspond to each column in the row.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec341"/>There's more...</h2></div></div></div><p>If you are performing a <a id="id364" class="indexterm"/>query where <a id="id365" class="indexterm"/>you are only selecting one column and expect one result (for instance, a <code class="literal">COUNT</code> query) you can use the <code class="literal">getOne</code> method to get the exact value that you need as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">$count = $db-&gt;getOne('SELECT COUNT(*) FROM Users');</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec342"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Writing data to the database</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Writing data to the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec100"/>Writing data to the database</h1></div></div></div><p>Of course, the majority of queries that can be performed on a MySQL database don't return any data. What if a developer needs to insert a row into a table? For that, we can use the <code class="literal">execute</code> method of the database object.</p><p>In this recipe, we will insert a new <a id="id366" class="indexterm"/>row into a table called <code class="literal">CustomTable</code>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec343"/>Getting ready</h2></div></div></div><p>We will want to insert some rows to the database here, but we don't want to mess anything up in the normal <a id="id367" class="indexterm"/>concrete5 database tables. Create a dummy table to run some queries on by executing the following statement on your MySQL database (this SQL file is also included with the free code download from this book's website):</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `CustomTable` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(255) DEFAULT NULL,
  `country` varchar(255) DEFAULT '',
  PRIMARY KEY (`id`)
);</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec344"/>How to do it...</h2></div></div></div><p>Have a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/config/site_post.php</code> in your code editor.</li><li class="listitem">Load the database object:<div class="informalexample"><pre class="programlisting">$db = Loader::db();</pre></div></li><li class="listitem">Write the <code class="literal">INSERT</code> query:<div class="informalexample"><pre class="programlisting">$query = 'INSERT INTO CustomTable (name, country) VALUES ("John Doe", "US")';</pre></div></li><li class="listitem">Execute the <code class="literal">INSERT</code> query:<div class="informalexample"><pre class="programlisting">$db-&gt;execute($query);</pre></div></li><li class="listitem">Output a success message, so that you know the update worked:<div class="informalexample"><pre class="programlisting">echo 'done!';
exit;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec345"/>How it works...</h2></div></div></div><p>The <code class="literal">execute</code> function allows a developer to run, literally, any query that the user has permission to run. In this case, we are simply executing a statement to add a new row to a custom table.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec346"/>There's more...</h2></div></div></div><p>The <code class="literal">execute</code> <a id="id368" class="indexterm"/>function can be <a id="id369" class="indexterm"/>used to run any arbitrary query on the database. For example, if we <a id="id370" class="indexterm"/>want to <code class="literal">TRUNCATE</code> (empty) the contents of <code class="literal">CustomTable</code>, we could write the following code snippet:</p><div class="informalexample"><pre class="programlisting">$query = 'TRUNCATE CustomTable';
$db-&gt;execute($query);</pre></div></div></div>
<div class="section" title="Guarding against SQL injections using prepared statements"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec101"/>Guarding against SQL injections using prepared statements</h1></div></div></div><p>A major source of security headaches in web applications has been SQL injection attacks. <span class="strong"><strong>SQL injections</strong></span> can occur when user-supplied data is not properly escaped and sanitized before being inserted into an SQL command. Malicious users could use this as an opportunity to run arbitrary <a id="id371" class="indexterm"/>commands on the <a id="id372" class="indexterm"/>database, either exposing sensitive data, or performing destructive actions such as altering or removing data.</p><p>Fortunately, this is an easy problem to solve. Indeed, one could manually sanitize all user input before concatenating those inputs into SQL queries, but that is tedious and prone to human error (forgetting to sanitize one portion of the application could still leave it vulnerable to attack). The preferred way to guard against SQL injection is to use prepared statements.</p><p>Prepared statements (or parameterized statements) are just like regular SQL queries. The only difference is, instead of directly inserting the user-supplied parameters into the query, the database will run the base query and the parameter portions at separate times. Therefore, prepared statements will not be vulnerable to SQL injections.</p><p>When running queries that contain user-supplied data, it is important to use only prepared statements.</p><p>The database object in concrete5 supports prepared statements, and in this recipe, we will create a prepared statement which allow guests to search the <code class="literal">Users</code> table by username and get that user's email address in return.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec347"/>Getting ready</h2></div></div></div><p>This recipe will assume that your concrete5 system has a user with the username of <code class="literal">admin</code>. Feel free to adjust this code to make it suit your environment.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec348"/>How to do it...</h2></div></div></div><p>Have a <a id="id373" class="indexterm"/>look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/config/site_post.php</code> in your code editor.</li><li class="listitem">Load the database object:<div class="informalexample"><pre class="programlisting">$db = Loader::db();</pre></div></li><li class="listitem">Create our prepared statement:<div class="informalexample"><pre class="programlisting">$query = 'SELECT * FROM Users WHERE uName = ?';</pre></div></li><li class="listitem">Store the value that the user provided on an HTML form. We will pretend it was equal to <code class="literal">admin</code>:<div class="informalexample"><pre class="programlisting">$username = 'admin';</pre></div></li><li class="listitem">Run the prepared query, with the statement as the first parameter, and the filter value as the second:<div class="informalexample"><pre class="programlisting">$results = $db-&gt;getAll($query, $db-&gt;getAll($query, $db-&gt;getAll($query, $db-&gt;getAll($query, $db-&gt;getAll($query, </pre></div></li><li class="listitem">Loop through the results and echo out each user's email address (there should be only one):<div class="informalexample"><pre class="programlisting">foreach ($results as $user) {
   echo $user['uEmail'] . '&lt;br /&gt;';
}
exit;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec349"/>How it works...</h2></div></div></div><p>Prepared statements are a feature of the database management system, in this case, MySQL. The database object in concrete5 utilizes this native feature to make it easy to use in a single-line function. <a id="id374" class="indexterm"/>This is because the query is prepared and executed before the parameters are applied; there is no <a id="id375" class="indexterm"/>risk of SQL injection. In addition to the security benefits, prepared statements are a great way to improve the performance on queries that are run several times.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec350"/>There's more...</h2></div></div></div><p>The database object supports executing prepared statements with more than one parameter. In these instances, simply <a id="id376" class="indexterm"/>provide the <a id="id377" class="indexterm"/>parameters in an array, with each value in the same order that it is specified in the query. Have a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">$sql = 'INSERT INTO CustomTable (name, country) VALUES (?, ?)';
$values = array('John Doe', 'US');
$db-&gt;execute($sql, $values);</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec351"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Learn more about prepared statements in PHP at <a class="ulink" href="http://php.net/manual/en/mysqli.quickstart.prepared-statements.php">http://php.net/manual/en/mysqli.quickstart.prepared-statements.php</a></li></ul></div></div></div>
<div class="section" title="Creating a custom model class"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec102"/>Creating a custom model class</h1></div></div></div><p>Writing SQL commands is a quick and easy way to interact with the database in concrete5, but it isn't the best way. <a id="id378" class="indexterm"/>Since concrete5 is an <span class="strong"><strong>MVC</strong></span> (<span class="strong"><strong>Model View Controller</strong></span>) application, all data actions should really live in models. A <span class="strong"><strong>model</strong></span> is a representation of an object that exists in the database, which will contain methods to read and write data to that object and have it persist in the database.</p><p>In this recipe, we will create a new table called <code class="literal">Books</code>, which will contain several book records. We will then create a <code class="literal">Book</code> model that will represent book data within the database.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec352"/>Getting ready</h2></div></div></div><p>concrete5 follows specific conventions in the naming of database tables. If you open the concrete5 database in an SQL query browser (such as phpMyAdmin or Sequel Pro on OS X), you will see that each of the tables begins with a capital letter and subsequent words in the table name are also camel-cased. In addition, tables should be plural in concrete5, since they contain multiple instances of items. Models should be singular, since they represent an individual item in the database (most of the time). Therefore, the new table that we will create will be called <code class="literal">Books</code> and the model will be called <code class="literal">Book</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec353"/>How to do it...</h2></div></div></div><p>Have a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, create the <code class="literal">Books</code> table that we will be using for the new <code class="literal">Book</code> model. We recommend using a database browser tool such as phpMyAdmin, MySQL Workbench, Sequel Pro (OS X), or Heidi SQL (Windows). The query can also be performed from the following:<div class="informalexample"><pre class="programlisting">CREATE TABLE `Books` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `title` varchar(255) NOT NULL DEFAULT '',
  `author` varchar(255) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`)
);</pre></div></li><li class="listitem">Create a new file for the <code class="literal">Book</code> model. In <code class="literal">/models</code> folder, create a file called <code class="literal">book.php</code>.</li><li class="listitem">Add the <code class="literal">defined</code> or <code class="literal">die</code> statement to the top of the file. This is required on all PHP files in concrete5 to <a id="id379" class="indexterm"/>prevent scripts from getting executed on their own:<div class="informalexample"><pre class="programlisting">&lt;?php
defined('C5_EXECUTE') or die("Access Denied.");</pre></div></li><li class="listitem">Create the class definition for the <code class="literal">Book</code> model, extending the core <code class="literal">Model</code> class.<div class="informalexample"><pre class="programlisting">class Book extends Model {
  
}</pre></div></li><li class="listitem">Add a method to create a new book, accepting a title, and author name as parameters:<div class="informalexample"><pre class="programlisting">public function createBook($title, $author) {
  $db = Loader::db();
       $this-&gt;title = $title;
   $this-&gt;author = $author;
       $query = 'INSERT INTO Books (title, author) VALUES (?, ?)';
   $values = array($title, $author);
       $db-&gt;execute($query, $values);
   $this-&gt;id = mysql_insert_id();
       return $this-&gt;id;
}</pre></div></li><li class="listitem">Add another method to load a book by its ID:<div class="informalexample"><pre class="programlisting">public function loadById($id) {
   $db = Loader::db();
   $query = 'SELECT * FROM Books WHERE id = ?';
       $books = $db-&gt;getAll($query, $id);
     // get the first result (there should be only one)
   $book = $books[0];
       // set each property of the result to the current object
   $this-&gt;id = $book['id'];
   $this-&gt;title = $book['title'];
   $this-&gt;author = $book['author'];
}</pre></div></li><li class="listitem">Finally, add a method to get a book's title:<div class="informalexample"><pre class="programlisting">public function getTitle() {
   return $this-&gt;title;
}</pre></div></li><li class="listitem"> Save <code class="literal">book.php</code>. Now that the <code class="literal">Book</code> model has been created and saved, let's try using it to write to and read <a id="id380" class="indexterm"/>from the database. To keep things simple, we will just stick this code in <code class="literal">/config/site_post.php</code>.</li><li class="listitem">Load the <code class="literal">Book</code> model using the <code class="literal">Loader</code> class:<div class="informalexample"><pre class="programlisting">Loader::model('book');</pre></div></li><li class="listitem">Create a new instance of <code class="literal">Book</code>:<div class="informalexample"><pre class="programlisting">$book = new Book();</pre></div></li><li class="listitem">Add a new book to the database using the <code class="literal">createBook</code> function we declared previously:<div class="informalexample"><pre class="programlisting">$book-&gt;createBook('concrete5 Cookbook', 'David Strack');</pre></div></li><li class="listitem">Get the book's title using the function that we declared.<div class="informalexample"><pre class="programlisting">$title = $book-&gt;getTitle();</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec354"/>How it works...</h2></div></div></div><p>Let's walk through the code that we just wrote. First, we made sure to create a table in the database called <code class="literal">Books</code>. This table has three columns, an <code class="literal">ID</code> field (which auto-increments every time a row is created), a <code class="literal">title</code> field, and an <code class="literal">author</code> field.</p><p>Next, we created a class called <code class="literal">Book</code> in <code class="literal">/models/book.php</code>. This class will represent an instance of an individual record in the <code class="literal">Books</code> table. The class extends the core <code class="literal">Model</code> class (which is just a basic implementation defined in <code class="literal">/concrete/core/libraries/model.php</code>). We then added a method to add new books to the database. The <code class="literal">createBook</code> method first loaded the database object, then it assigned the <code class="literal">title</code> and <code class="literal">author</code> to the current <code class="literal">Book</code> object. After performing the <code class="literal">INSERT</code> query, the method sets the book's <code class="literal">ID</code> using the <code class="literal">mysql_insert_id()</code> function. Finally, the function returns the new <code class="literal">ID</code> of the row we just added.</p><p>The <code class="literal">loadById</code> function was added next. This function will accept an <code class="literal">ID</code> as the parameter, and then perform a <code class="literal">SELECT</code> query on the database to find the corresponding row. Notice that in this demonstration we never actually verified that the record exists. In real-world use, you will want to make sure to account for that. Once we have the <code class="literal">Book</code> object loaded, we assign the three properties (<code class="literal">ID</code>, <code class="literal">title</code>, and <code class="literal">author</code>) to the class object.</p><p>Finally, we added a simple getter function to return the title of the book. Note that this function will only work after the <code class="literal">Book</code> class has been loaded, either by calling <code class="literal">loadById</code>, or by creating a new book with the <code class="literal">createBook</code> function.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec355"/>There's more...</h2></div></div></div><p>It should be pretty clear that by <a id="id381" class="indexterm"/>creating models to handle data object, developers can save a ton of work and keep their code clean. Rather than having SQL statements spread all over the code, all of the database-related logic is contained in the model. This allows for fast and easy creation and access of database rows.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec356"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Loading the database object</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Retrieving data from the database</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Writing data to the database</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Guarding against SQL injections with prepared statements</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Reading from the database with active record"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec103"/>Reading from the database with active record</h1></div></div></div><p>Now that we have created a <code class="literal">Model</code> class, it is easy to see how this can be a huge benefit to developers, wanting to <a id="id382" class="indexterm"/>keep their codebase clean and maintainable. However, we can take this one step further using active record. The reality is, the tasks <a id="id383" class="indexterm"/>in the previous recipe could have been performed with less than half of the code that was written.</p><p>If you are familiar with frameworks such as Ruby on Rails or CakePHP, then you may have some experience with active record already. <span class="strong"><strong>Active record</strong></span> is a convention of using classes that contain create, update, read, and delete functionality, as well as properties mapped to a record in the database.</p><p>In this recipe, we will explore how to use active record to load models from the database.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec357"/>Getting ready</h2></div></div></div><p>We will be using the same <code class="literal">Books</code> table in the database from the previous recipe. If you need to create this table, run the following SQL on your database:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `Books` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `title` varchar(255) NOT NULL DEFAULT '',
  `author` varchar(255) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`)
);</pre></div><p>Also, make sure that a record with the ID of <code class="literal">1</code> exists in that table. If you ran through the previous recipe, it should exist already.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec358"/>How to do it...</h2></div></div></div><p>Have a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">If the record with the <a id="id384" class="indexterm"/>ID of <code class="literal">1</code> doesn't exist, <a id="id385" class="indexterm"/>create a <code class="literal">Book</code> class in <code class="literal">/models/book.php</code>.</li><li class="listitem">Make sure the contents of <code class="literal">book.php</code> look like the following:<div class="informalexample"><pre class="programlisting">&lt;?php
defined('C5_EXECUTE') or die("Access Denied.");
class Book extends Model {
   public $_table = 'Books';
   public function getTitle() {
      return $this-&gt;title;
   }
}</pre></div></li><li class="listitem">Now, let's write a little code to make this model come to life. For this demo, we will just be writing the code in <code class="literal">/config/site_post.php</code> since it is just temporary dummy code.</li><li class="listitem">Load the model:<div class="informalexample"><pre class="programlisting">Loader::model('book');</pre></div></li><li class="listitem">Create a new instance of the <code class="literal">Book</code> class:<div class="informalexample"><pre class="programlisting">$book = new Book();</pre></div></li><li class="listitem">Load the book with the ID of <code class="literal">1</code>:<div class="informalexample"><pre class="programlisting">$book-&gt;load('id = ?', '1');</pre></div></li><li class="listitem">Get the book's title:<div class="informalexample"><pre class="programlisting">$title = $book-&gt;getTitle();</pre></div></li><li class="listitem">Output the title to the screen:<div class="informalexample"><pre class="programlisting">echo $title;
exit;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec359"/>How it works...</h2></div></div></div><p>As you can see, the <code class="literal">Book</code> model contained no SQL, yet it was still able to perform a lookup on the database and load the book with the ID of <code class="literal">1</code>. The <code class="literal">Book</code> class extends the <code class="literal">Model</code> class, which extends the <code class="literal">ADOdb_Active_Record</code> class. The <code class="literal">ADOdb_Active_Record</code> class <a id="id386" class="indexterm"/>implements several functions to provide typical read, update, create, and delete functionality.</p><p>One important change to note is that early in the class body, we added a member variable called <code class="literal">$_table</code>. If we would have left that out, everything still would have worked. The <code class="literal">ADOdb_Active_Record</code> <a id="id387" class="indexterm"/>class actually does some basic inflection (converting the singular class name (<code class="literal">Book</code>) into the plural database table name (<code class="literal">Books</code>)). However, the inflection is essentially only good at adding <code class="literal">s</code> to the end of class names and that's about it. More complex pluralizations can <a id="id388" class="indexterm"/>fail, so it's a good idea to always specify the table name.</p><p>The <code class="literal">load</code> function of the <code class="literal">ADOdb_Active_Record</code> class expects the same syntax that one would find in an SQL <code class="literal">WHERE</code> statement. <a id="id389" class="indexterm"/>Writing <code class="literal">load('id = ?')</code> is equivalent to writing the following prepared statement:</p><div class="informalexample"><pre class="programlisting">SELECT * FROM Books WHERE id = ?</pre></div><p>The <code class="literal">load</code> function then assigns all of the properties to the object. It's clear how this can eliminate a lot of code when performing simple <span class="strong"><strong>CRUD</strong></span> tasks in concrete5.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec360"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a custom model class</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Guarding against SQL injections with prepared statements</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Writing to the database with active record"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec104"/>Writing to the database with active record</h1></div></div></div><p>Active record can also be used to <a id="id390" class="indexterm"/>write to the database. In this recipe, <a id="id391" class="indexterm"/>we will use the <code class="literal">Book</code> class created in the previous recipe to add a new book record to the database.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec361"/>Getting ready</h2></div></div></div><p>Make sure that the <code class="literal">Book</code> model and <code class="literal">Books</code> table have been created. Refer to the <span class="emphasis"><em>Reading from the database with active record</em></span> recipe to see how that class should be created.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec362"/>How to do it...</h2></div></div></div><p>Have a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We will enter the code in <code class="literal">/config/site_post.php</code>, so open that file in your code editor.</li><li class="listitem">Load the model:<div class="informalexample"><pre class="programlisting">Loader::model('book');</pre></div></li><li class="listitem">Create a new instance of the <code class="literal">Book</code> class:<div class="informalexample"><pre class="programlisting">$book = new Book();</pre></div></li><li class="listitem">Set the title of the book:<div class="informalexample"><pre class="programlisting">$book-&gt;title = 'The Wind in the Willows';</pre></div></li><li class="listitem">Set the author of the book:<div class="informalexample"><pre class="programlisting">$book-&gt;author = 'Kenneth Grahame';</pre></div></li><li class="listitem">Save the new book data:<div class="informalexample"><pre class="programlisting">$book-&gt;save();
exit;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec363"/>How it works...</h2></div></div></div><p>After setting the <code class="literal">title</code> and <code class="literal">author</code> <a id="id392" class="indexterm"/>properties to the <code class="literal">Book</code> object, <a id="id393" class="indexterm"/>calling the <code class="literal">save</code> function will automatically save the item to the database, and creating a new row.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec364"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a custom model class</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Reading from the database with active record</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Updating a database record with active record"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec105"/>Updating a database record with active record</h1></div></div></div><p>Updating database items is very <a id="id394" class="indexterm"/>similar to creating them. In this <a id="id395" class="indexterm"/>recipe, we will load a book with the ID of <code class="literal">1</code> and change its title.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec365"/>Getting ready</h2></div></div></div><p>This recipe uses the same <code class="literal">Book</code> model and <code class="literal">Books</code> table from the previous, the <span class="emphasis"><em>Reading from the database with active record</em></span> recipe. Make sure those files are in place before beginning this recipe.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec366"/>How to do it...</h2></div></div></div><p>Have a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/config/site_post.php</code> in your code editor.</li><li class="listitem">Load the model:<div class="informalexample"><pre class="programlisting">Loader::model('book');</pre></div></li><li class="listitem">Create a new instance of the book class:<div class="informalexample"><pre class="programlisting">$book = new Book();</pre></div></li><li class="listitem">Load the book by its ID:<div class="informalexample"><pre class="programlisting">$book-&gt;load('id = ?', '1');</pre></div></li><li class="listitem">Change the title of the book:<div class="informalexample"><pre class="programlisting">$book-&gt;title = 'New Title';</pre></div></li><li class="listitem">Save the changes to the database:<div class="informalexample"><pre class="programlisting">$book-&gt;update();
exit;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec367"/>How it works...</h2></div></div></div><p>Once the book record is <a id="id396" class="indexterm"/>loaded, the <a id="id397" class="indexterm"/>
<code class="literal">ID</code> property of the object is set. The <code class="literal">Model</code> class uses this <code class="literal">ID</code> to update the correct record when <code class="literal">update</code> is called. If the <code class="literal">ID</code> of the object doesn't exist or isn't set when <code class="literal">update</code> is called, a new record will be created.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec368"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a custom model class</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Reading from the database with active record</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Searching the database using active record"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec106"/>Searching the database using active record</h1></div></div></div><p> Often, web applications <a id="id398" class="indexterm"/>will need to retrieve multiple records. <a id="id399" class="indexterm"/>In this recipe, we will continue working with the concepts of <code class="literal">Books</code> stored in the database and retrieve an array of all of the books in the database.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec369"/>Getting ready</h2></div></div></div><p>Like the other recipes before this one, we are using the same <code class="literal">Book</code> model and <code class="literal">Books</code> table from the previous, the <span class="emphasis"><em>Reading from the database with active record</em></span> recipe. Make sure those files are in place before beginning this recipe.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec370"/>How to do it...</h2></div></div></div><p>Have a look at the <a id="id400" class="indexterm"/>following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/config/site_post.php</code> in your code editor.</li><li class="listitem">Load the model:<div class="informalexample"><pre class="programlisting">Loader::model('book');</pre></div></li><li class="listitem">Create a new instance of the <code class="literal">Book</code> model:<div class="informalexample"><pre class="programlisting">$book = new Book();</pre></div></li><li class="listitem">Find all of the book records:<div class="informalexample"><pre class="programlisting">$books = $book-&gt;find('1=1');</pre></div></li><li class="listitem">Loop through the array and echo each book's title:<div class="informalexample"><pre class="programlisting">foreach ($books as $b) {
   echo $b-&gt;getTitle().'&lt;br /&gt;';
}
exit;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec371"/>How it works...</h2></div></div></div><p>The <code class="literal">find</code> function of the <code class="literal">Model</code> <a id="id401" class="indexterm"/>class searches the database and returns the resulting objects in an array. Since the <code class="literal">find</code> function is already including <code class="literal">WHERE</code> in the query, we need to filter by a truth condition to find all of the records, so <code class="literal">1=1</code> does the job here.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec372"/>There's more...</h2></div></div></div><p>The <code class="literal">find</code> function also <a id="id402" class="indexterm"/>supports using prepared statements to search the table. Here, we will look for books that have <code class="literal">'concrete5'</code> in the title: Have a look at the following:</p><div class="informalexample"><pre class="programlisting">$books = $book-&gt;find('title LIKE "%?%"', 'concrete5');</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec373"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a custom model class</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Reading from the database with active record</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Deleting objects using active record and model classes"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec107"/>Deleting objects using active record and model classes</h1></div></div></div><p>The final facet of <a id="id403" class="indexterm"/>CRUD <a id="id404" class="indexterm"/>actions with active record is <a id="id405" class="indexterm"/>deleting entries. In this recipe, we will load a book with the ID of <code class="literal">1</code> and <a id="id406" class="indexterm"/>delete it from the database.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec374"/>Getting ready</h2></div></div></div><p>We will be using the same <code class="literal">Book</code> model and <code class="literal">Books</code> table from the previous the <span class="emphasis"><em>Reading from the database with active record</em></span> recipe. Make sure that file is in place before beginning this recipe.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec375"/>How to do it...</h2></div></div></div><p>Have a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/config/site_post.php</code> in your code editor.</li><li class="listitem">Load the model:<div class="informalexample"><pre class="programlisting">Loader::model('book');</pre></div></li><li class="listitem">Create a new instance of the model:<div class="informalexample"><pre class="programlisting">$book = new Book();</pre></div></li><li class="listitem">Load the book with the ID of <code class="literal">1</code>.<div class="informalexample"><pre class="programlisting">$book-&gt;load('id = ?', '1');</pre></div></li><li class="listitem">Delete that book:<div class="informalexample"><pre class="programlisting">$book-&gt;delete();
exit;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec376"/>How it works...</h2></div></div></div><p>Calling the <code class="literal">delete</code> function of the <code class="literal">Model</code> class will run the <code class="literal">DELETE</code> query on the database, permanently deleting the record associated with that item. Using your preferred SQL browsing tool, you can see that the record has been removed from the database.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec377"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a custom model class</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Reading from the database with active record</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Defining relationships with active record"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec108"/>Defining relationships with active record</h1></div></div></div><p>The primary feature of relational <a id="id407" class="indexterm"/>database systems (such as MySQL) is the ability to link data to other bits of data using relationships. Consider a database that stores states and cities in the United States. Each state can have many cities, but each city belongs to only one state. These relationships, "has many" and "belongs to", are definable using concrete5's active record support.</p><p>In this recipe, we will link two tables, <code class="literal">States</code> and <code class="literal">Cities</code>, and use the relationships to retrieve the related data.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec378"/>Getting ready</h2></div></div></div><p>First, we will need to create tables for both <code class="literal">Cities</code> and <code class="literal">States</code>. Use the following SQL to populate those tables (this SQL is <a id="id408" class="indexterm"/>also available for download from the book's website):</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `Cities` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL DEFAULT '',
  `state_id` int(11) NOT NULL,
  PRIMARY KEY (`id`)
);
INSERT INTO `Cities` (`id`, `name`, `state_id`)
VALUES
  (1,'New York',2),
  (2,'Buffalo',2),
  (3,'Green Bay',1),
  (4,'Chicago',3),
  (5,'San Francisco',4),
  (6,'San Diego',4),
  (7,'Oakland',4);
CREATE TABLE `States` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`)
);
INSERT INTO `States` (`id`, `name`)
VALUES
  (1,'Wisconsin'),
  (2,'New York'),
  (3,'Illinois'),
  (4,'California');</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec379"/>How to do it...</h2></div></div></div><p>Have a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a model for state in <code class="literal">/models/state.php</code>:<div class="informalexample"><pre class="programlisting">class State extends Model {}</pre></div></li><li class="listitem">Create a model for <code class="literal">city</code> in <code class="literal">/models/city.php</code>:<div class="informalexample"><pre class="programlisting">class City extends Model {}</pre></div></li><li class="listitem">At the bottom of the <code class="literal">state</code> model file (outside of the class body), define the relationship to <code class="literal">city</code>:<div class="informalexample"><pre class="programlisting">Model::ClassHasMany('State', 'Cities','state_id');</pre></div></li><li class="listitem">Save both of these <a id="id409" class="indexterm"/>class files.</li><li class="listitem">Now, we will get the cities that belong to California (state with ID = <code class="literal">4</code>).</li><li class="listitem">Open <code class="literal">/config/site_post.php</code> in your code editor, so that we can run some code.</li><li class="listitem">Load the <code class="literal">state</code> <a id="id410" class="indexterm"/>model:<div class="informalexample"><pre class="programlisting">Loader::model('state');</pre></div></li><li class="listitem">Create a new instance of the <code class="literal">state</code> model:<div class="informalexample"><pre class="programlisting">$state = new State();</pre></div></li><li class="listitem">Load the <code class="literal">state</code> with the ID of <code class="literal">4</code> (California in our data example):<div class="informalexample"><pre class="programlisting">$state-&gt;load('id = ?', '4');</pre></div></li><li class="listitem">Get the state's cities using the active record relationship:<div class="informalexample"><pre class="programlisting">$cities = $state-&gt;Cities;</pre></div></li><li class="listitem">Loop through the cities and output each city's name:<div class="informalexample"><pre class="programlisting">foreach ($cities as $city) {
   echo $city-&gt;name .'&lt;br /&gt;';
}
exit;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec380"/>How it works...</h2></div></div></div><p>The static function called <code class="literal">ClassHasMany</code> on the <code class="literal">Model</code> class accepts three parameters. The first parameter is the name of the class that we are assigning this relationship to (in this case, <code class="literal">State</code>). The second parameter is the name of the database table that contains the child content. The third column is the name of the foreign key, which will be used to determine which rows are children of the parent class.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec381"/>There's more...</h2></div></div></div><p>One can also declare <code class="literal">belongs to</code> relationships in a similar manner.</p><div class="informalexample"><pre class="programlisting">Model::ClassBelongsTo('City','State','state_id','id');</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec382"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a custom model class</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Reading from the database with active record</em></span> recipe</li></ul></div></div></div></body></html>