<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Creating a Simple Store"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Creating a Simple Store</h1></div></div></div><p>
<span class="emphasis"><em>Over the last few years e-commerce has evolved from just online advertisements to providing fully functional shopping experiences online. More and more products and services are being made available online everyday through the use of various online payment systems. The role of e-commerce applications and payment gateways has become crucial in this environment.</em></span>
</p><p>In this<a id="id749" class="indexterm"/> chapter we will be building a simple online store to demonstrate the process involved in setting up a simple shopping cart. We will be using PayPal Express Checkout as our payment processer during this example. Some of the key topics that will be covered in this chapter include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting up a shopping cart</li><li class="listitem" style="list-style-type: disc">Creating a online store administration interface</li><li class="listitem" style="list-style-type: disc">Configuring Zend Framework 2.0 for PayPal</li><li class="listitem" style="list-style-type: disc">An introduction to PayPal Express Checkout</li><li class="listitem" style="list-style-type: disc">The implementation of PayPal Express Checkout</li></ul></div><div class="section" title="Shopping cart"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec74"/>Shopping cart</h1></div></div></div><p>One of the<a id="id750" class="indexterm"/> first things that have to be designed while setting up an online store is the shopping cart. The shopping cart should ideally allow the end user to choose and add multiple products to the cart and be able to check out from the website.</p><p>The checkout process<a id="id751" class="indexterm"/> is outlined as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Customer visits the product listing page.</li><li class="listitem">Customer selects a product; he/she is taken to the product detail page.</li><li class="listitem">Customer then chooses to purchase the product; customer is expected to add the desired quantity to the cart.</li><li class="listitem">Customer is redirected to the shopping cart page; here the customer may make any changes to the order if necessary.</li><li class="listitem">Customer<a id="id752" class="indexterm"/> chooses the mode of payment and enters the payment information.</li><li class="listitem">If successful, the customer is presented with an option to update the shipping details.</li><li class="listitem">Customer then confirms the order.</li><li class="listitem">The order is received at the retailer; the retailer then goes ahead and processes the order.</li></ol></div><p>So let's get started and create our store front; our next step will be to design a table structure which will support this store. For this we create the following two tables:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">store_products</code>: This<a id="id753" class="indexterm"/> table will store all product related information</li><li class="listitem" style="list-style-type: disc"><code class="literal">store_orders</code>: This <a id="id754" class="indexterm"/>table will store all order-related information</li></ul></div></div></div>
<div class="section" title="Time for action &#x2013; creating a store front"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec75"/>Time for action – creating a store front</h1></div></div></div><p>For simplicity, we will shorten the <code class="literal">Checkout</code> process by skipping some steps. We have modified<a id="id755" class="indexterm"/> the process so that we can only have one product<a id="id756" class="indexterm"/> per order; we will also skip the updating of shipping details and the customer order confirmation steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create tables to hold the products and orders data:<div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS store_products (
  id int(11) NOT NULL AUTO_INCREMENT,
  name varchar(255) NOT NULL,
  desc varchar(255) NOT NULL,
  cost float(9,2) NOT NULL,
  PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS store_orders (
  id int(11) NOT NULL AUTO_INCREMENT,
  store_product_id int(11) NOT NULL,
  qty int(11) NOT NULL,
  total float(9,2) NOT NULL,
  status enum('new', 'completed', 
        'shipped', 'cancelled')  DEFAULT NULL,
  stamp timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  first_name varchar(255) DEFAULT NULL,
  last_name varchar(255) DEFAULT NULL,
  email varchar(255) DEFAULT NULL,
  ship_to_street varchar(255) DEFAULT NULL,
  ship_to_city varchar(255) DEFAULT NULL,
  ship_to_state varchar(2) DEFAULT NULL,
  ship_to_zip int(11) DEFAULT NULL,
  PRIMARY KEY (id)
);</pre></div></li><li class="listitem">Create<a id="id757" class="indexterm"/> entities for <code class="literal">StoreOrder</code> and <code class="literal">StoreProduct</code>, and <a id="id758" class="indexterm"/>also create necessary table gateway objects for data access.</li><li class="listitem">Create <a id="id759" class="indexterm"/>a <code class="literal">StoreController</code> controller, which will be used as our shopping cart.</li><li class="listitem"><code class="literal">StoreController</code> will support the following actions:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">indexAction()</code>: This<a id="id760" class="indexterm"/> action<a id="id761" class="indexterm"/> will list all products in the website</li><li class="listitem" style="list-style-type: disc"><code class="literal">productDetailAction()</code>: This<a id="id762" class="indexterm"/> will display the details<a id="id763" class="indexterm"/> of a specific product; this will also allow the customer to add a product to the cart</li><li class="listitem" style="list-style-type: disc"><code class="literal">shoppingCartAction()</code>: This<a id="id764" class="indexterm"/> action is used to render<a id="id765" class="indexterm"/> the shopping cart before leaving for the payment processing page</li><li class="listitem" style="list-style-type: disc"><code class="literal">paypalExpressCheckoutAction()</code>: This action will redirect the user to the PayPal Express Checkout page</li><li class="listitem" style="list-style-type: disc"><code class="literal">paymentConfirmAction()</code>: This <a id="id766" class="indexterm"/>action will handle <a id="id767" class="indexterm"/>the redirection from PayPal Express Checkout back to the shopping cart upon successful payment</li><li class="listitem" style="list-style-type: disc"><code class="literal">paymentCancelAction()</code>: This action will handle the redirection from<a id="id768" class="indexterm"/> PayPal <a id="id769" class="indexterm"/>Express Checkout back to the shopping cart upon failed payment</li></ul></div></li><li class="listitem">Create the necessary views to display the content of the shopping cart.</li><li class="listitem">Add the necessary methods to <code class="literal">StoreOrder</code> to calculate the order total upon adding items to the orders.</li><li class="listitem">The final user interface should look like the following screenshot. The product listing page lists all products in the website/category; in this case, the two test products<a id="id770" class="indexterm"/> are listed in the following<a id="id771" class="indexterm"/> screenshot:</li></ol></div><div class="mediaobject"><img src="graphics/1929OS_08_01.jpg" alt="Time for action – creating a store front"/></div><p>The product detail page allows users to view details of a product, and also add the specified quantity to the shopping cart:</p><div class="mediaobject"><img src="graphics/1929OS_08_02.jpg" alt="Time for action – creating a store front"/></div><p>The <a id="id772" class="indexterm"/>
<span class="strong"><strong>Shopping Cart</strong></span> page lists all products that are<a id="id773" class="indexterm"/> added to the cart along with their unit price, quantity, and subtotal:</p><div class="mediaobject"><img src="graphics/1929OS_08_03.jpg" alt="Time for action – creating a store front"/></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec74"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We have created a shopping cart interface for our new store; we will be modifying this interface<a id="id774" class="indexterm"/> further in order to add support for the payment <a id="id775" class="indexterm"/>processor. But before we get to that stage, let's create a simple store administration interface to enable us to manage the store and orders.</p></div></div>
<div class="section" title="The store administration"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec76"/>The store administration</h1></div></div></div><p>The store administration user interface is used to check the status of orders once they are created <a id="id776" class="indexterm"/>and also to manage the list of products that are available for sale in the store. There are two key aspects for the store administration user interface:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The administrator should be able to add, remove, and manage products</li><li class="listitem" style="list-style-type: disc">The administrator should be able manage order and change statuses using this interface</li></ul></div></div>
<div class="section" title="Time for action &#x2013; creating the Store Admin interface"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec77"/>Time for action – creating the Store Admin interface</h1></div></div></div><p>Perform <a id="id777" class="indexterm"/>the following steps for creating the <code class="literal">Store Admin</code> interface:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create<a id="id778" class="indexterm"/> a new controller for store administration, and name it <code class="literal">StoreAdminController</code>.</li><li class="listitem">This controller will have the following basic actions:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">indexAction()</code>: Used <a id="id779" class="indexterm"/>for<a id="id780" class="indexterm"/> listing all products</li><li class="listitem" style="list-style-type: disc"><code class="literal">addProductAction()</code>: Used <a id="id781" class="indexterm"/>for adding a <a id="id782" class="indexterm"/>new product</li><li class="listitem" style="list-style-type: disc"><code class="literal">deleteProductAction()</code>: Used <a id="id783" class="indexterm"/>for deleting <a id="id784" class="indexterm"/>an existing product</li><li class="listitem" style="list-style-type: disc"><code class="literal">listOrdersAction()</code>: Used <a id="id785" class="indexterm"/>for <a id="id786" class="indexterm"/>listing all orders</li><li class="listitem" style="list-style-type: disc"><code class="literal">viewOrderAction()</code>: Used<a id="id787" class="indexterm"/> for viewing a specific <a id="id788" class="indexterm"/>order</li><li class="listitem" style="list-style-type: disc"><code class="literal">updateOrderStatusAction()</code>: Used<a id="id789" class="indexterm"/> for updating<a id="id790" class="indexterm"/> order status</li></ul></div></li><li class="listitem">Create the necessary views, and map the actions accordingly.</li><li class="listitem">Open phpMyadmin and create test records in both the <code class="literal">store_products</code> and <code class="literal">store_orders</code> tables to test the functionality for the administration UI.</li><li class="listitem">Open your favorite browser, log in to the application, and open the <span class="strong"><strong>eStore Admin</strong></span> interface. The interface should look like the following one.<p>The <span class="strong"><strong>Manage Products</strong></span> page lets you add, remove, and edit products from the administration interface:</p><div class="mediaobject"><img src="graphics/1929OS_08_04.jpg" alt="Time for action – creating the Store Admin interface"/></div></li></ol></div><p>The orders listing page lists all orders placed in the store and allows you to view orders and <a id="id791" class="indexterm"/>modify their statuses:</p><div class="mediaobject"><img src="graphics/1929OS_08_05.jpg" alt="Time for action – creating the Store Admin interface"/></div><p>A screenshot of the <span class="strong"><strong>Order Information</strong></span> page listing the order information and providing options to change their status is shown as follows:</p><div class="mediaobject"><img src="graphics/1929OS_08_06.jpg" alt="Time for action – creating the Store Admin interface"/></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec75"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>The store administration UI is now ready, and our next step is to set up PayPal Express checkout<a id="id792" class="indexterm"/> and to integrate it with our store, which will enable our user to make payments using PayPal. Before we move on to the next section, the following section gives you a simple task to try out.</p></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec76"/>Have a go hero</h2></div></div></div><p>Now that you know how to integrate search into a Zend Framework 2.0 application, try to add free text search functionality for the <span class="strong"><strong>Manage Products</strong></span> section of our store application.</p></div></div>
<div class="section" title="Payments with PayPal"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec78"/>Payments with PayPal</h1></div></div></div><p>PayPal<a id="id793" class="indexterm"/> is the most commonly used payment processor across the world; one <a id="id794" class="indexterm"/>of the key contributors to PayPal's success is its easy-to-use API and exhaustive documentation that supports this payment gateway. For any new merchant, PayPal offers a wide range of options for setting up their payment processor, the most important being the types of integrations that are offered. PayPal offers various products under Payment Processing; some of them include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Express Checkout</li><li class="listitem" style="list-style-type: disc">PayPal Payments Standards (Website Payments Standards) </li><li class="listitem" style="list-style-type: disc">PayPal Payments Pro (Website Payments Pro)</li></ul></div><p>We will <a id="id795" class="indexterm"/>be working with Express Checkout in this chapter, since it is the most basic implementation method of PayPal.</p><div class="section" title="PayPal and Zend Framework 2.0"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec77"/>PayPal and Zend Framework 2.0</h2></div></div></div><p>At the<a id="id796" class="indexterm"/> time of writing this book, there were no native<a id="id797" class="indexterm"/> packages that were offered by Zend Framework which supported PayPal integration. There are always third-party options that support this integration. In this example, we have made use of one such third party package called <code class="literal">SpeckPaypal</code>.</p></div></div>
<div class="section" title="Time for action &#x2013; setting up PayPal"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec79"/>Time for action – setting up PayPal</h1></div></div></div><p>Perform<a id="id798" class="indexterm"/> the following steps for setting up PayPal:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <a class="ulink" href="https://packagist.org/">https://packagist.org/</a>, search <a id="id799" class="indexterm"/>for <code class="literal">speckpaypal</code>.</li><li class="listitem">Get the repository details.</li><li class="listitem">Modify <a id="id800" class="indexterm"/>the application's Composer configuration file to include the <code class="literal">speckpaypal</code> repository:<div class="informalexample"><pre class="programlisting">"require": {
    "php": "&gt;=5.3.3",
    "zendframework/zendframework": "2.0.*",
    "webino/webino-image-thumb": "1.0.0",
    "zendframework/zendgdata": "2.*",
<span class="strong"><strong>    "speckcommerce/speck-paypal": "dev-master"</strong></span>
}</pre></div></li><li class="listitem">Update the project dependencies using the Composer update:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>.</strong></span>
<span class="strong"><strong>Loading composer repositories with package information</strong></span>
<span class="strong"><strong>Updating dependencies</strong></span>
<span class="strong"><strong>  - Removing zendframework/zendframework (2.0.7)</strong></span>
<span class="strong"><strong>  - Installing zendframework/zendframework (2.0.8)</strong></span>
<span class="strong"><strong>    Downloading: 100%</strong></span>

<span class="strong"><strong>  - Installing speckcommerce/speck-paypal (dev-master d951518)</strong></span>
<span class="strong"><strong>    Cloning d951518fd2c98148da5609e23a41697e6cfca06e</strong></span>

<span class="strong"><strong>Writing lock file</strong></span>
<span class="strong"><strong>Generating autoload files</strong></span>
</pre></div></li><li class="listitem">Now we will need API credentials for accessing PayPal Express Checkout. This<a id="id801" class="indexterm"/> can<a id="id802" class="indexterm"/> be accessed by logging into <a class="ulink" href="https://developer.paypal.com">https://developer.paypal.com</a> with your PayPal credentials.</li><li class="listitem">Open <span class="strong"><strong>Sandbox Accounts</strong></span> from <span class="strong"><strong>Applications</strong></span>.</li><li class="listitem">Choose the appropriate merchant account and select <span class="strong"><strong>API Credentials</strong></span> in <span class="strong"><strong>Profile</strong></span>.<div class="mediaobject"><img src="graphics/1929OS_08_07.jpg" alt="Time for action – setting up PayPal"/></div></li><li class="listitem">Make a note of the API credentials.</li><li class="listitem">Now <a id="id803" class="indexterm"/>create a new configuration in the <code class="literal">config</code> file (<code class="literal">CommunicationApp/module/Users/config/module.config.php</code>) in the module's configuration file and name the array index <code class="literal">speck-paypal-api</code>:<div class="informalexample"><pre class="programlisting">  'speck-paypal-api' =&gt; array(
    'username'  =&gt; '',
    'password'  =&gt; '',
    'signature' =&gt; '',
    'endpoint'  =&gt; 'https://api-3t.sandbox.paypal.com/nvp'
  )</pre></div></li><li class="listitem">Different PayPal services have different end points. For Express Checkout in Sandbox this is <code class="literal">https://api-3t.sandbox.paypal.com/nvp</code>; if you are switching live/production environment, this needs to be changed to <code class="literal">https://api-3t.paypal.com/nvp</code>.</li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec78"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>Now we have configured PayPal and SpeckPaypal in our application, our next step is to test <a id="id804" class="indexterm"/>receiving payments using PayPal Express Checkout.</p></div></div>
<div class="section" title="PayPal Express Checkout"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec80"/>PayPal Express Checkout </h1></div></div></div><p>PayPal Express Checkout allows sellers to receive credit card / PayPal payments on their websites by redirecting them to PayPal Express Checkout for secure web payment and returning them back to the merchant's website once the transaction is completed.</p><p>The workflow <a id="id805" class="indexterm"/>is explained as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Customer on the <span class="strong"><strong>Shopping Cart</strong></span> page chooses to pay by <span class="strong"><strong>PayPal Express Checkout</strong></span>; the<a id="id806" class="indexterm"/> merchant calls the <code class="literal">SetExpressCheckout</code><a id="id807" class="indexterm"/> API call and gets the payment token.</li><li class="listitem">Using the Payment token, the customer is redirected to the PayPal Express Checkout login page; here the customer can enter his/her PayPal login information or get a new PayPal account.</li><li class="listitem">On the next page, the customer is presented with a <span class="strong"><strong>Review</strong></span> option to review the payment<a id="id808" class="indexterm"/> information before proceeding to continue the checkout with the merchant.</li><li class="listitem">Now the customer is redirected back to the merchant page; the merchant then calls the <code class="literal">GetExpressCheckoutDetails</code> API call and gets the customer information. <a id="id809" class="indexterm"/>The customer reviews the order and confirms the order. The merchant then completes the payment request using the <code class="literal">DoExpressCheckoutPayment</code> API call.</li><li class="listitem">The customer is shown the transaction results along with the order summary.<div class="mediaobject"><img src="graphics/1929OS_08_08.jpg" alt="PayPal Express Checkout"/><div class="caption"><p>PayPal Express Checkout—overview</p></div></div></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip31"/>Tip</h3><p>
<span class="strong"><strong>More about PayPal Express Checkout</strong></span>
</p><p>You <a id="id810" class="indexterm"/>can read more about PayPal Express<a id="id811" class="indexterm"/> Checkout at the PayPal website <a class="ulink" href="https://www.paypal.com/webapps/mpp/express-checkout">https://www.paypal.com/webapps/mpp/express-checkout</a>.</p><p>Developer <a id="id812" class="indexterm"/>documentation on PayPal Express Checkout<a id="id813" class="indexterm"/> is available at:</p><p>
<a class="ulink" href="https://developer.paypal.com/webapps/developer/docs/classic/express-checkout/integration-guide/ECGettingStarted/">https://developer.paypal.com/webapps/developer/docs/classic/express-checkout/integration-guide/ECGettingStarted/</a>.</p></div></div></div>
<div class="section" title="Time for action &#x2013; accepting payments using PayPal"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec81"/>Time for action – accepting payments using PayPal</h1></div></div></div><p>Preform<a id="id814" class="indexterm"/> the following <a id="id815" class="indexterm"/>steps for accepting payments using PayPal:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Now <a id="id816" class="indexterm"/>add a button on the <span class="strong"><strong>Shopping Cart</strong></span> page (optionally with Checkout by PayPal Image). This button<a id="id817" class="indexterm"/> should link to the <code class="literal">paypalExpressCheckoutAction()</code> function.</li><li class="listitem">Add a method in the store controller which will be used to generate the PayPal request:<div class="informalexample"><pre class="programlisting">protected function getPaypalRequest()
{
  $config  = $this-&gt;getServiceLocator()-&gt;get('config');
  $paypalConfig = new \SpeckPaypal\Element\Config(
              $config['speck-paypal-api']);
   
  $adapter = new \Zend\Http\Client\Adapter\Curl();
  $adapter-&gt;setOptions(array(
    'curloptions' =&gt; array(
      CURLOPT_SSL_VERIFYPEER =&gt; false,
    )
  ));
   
  $client = new \Zend\Http\Client;
  $client-&gt;setMethod('POST');
  $client-&gt;setAdapter($adapter);
   
  $paypalRequest = new \SpeckPaypal\Service\Request;
  $paypalRequest-&gt;setClient($client);
  $paypalRequest-&gt;setConfig($paypalConfig);
  
  return $paypalRequest;
}</pre></div></li><li class="listitem">Modify the <code class="literal">paypalExpressCheckoutAction()</code> function to send the order information<a id="id818" class="indexterm"/> to PayPal and redirect<a id="id819" class="indexterm"/> the <a id="id820" class="indexterm"/>user to PayPal Express<a id="id821" class="indexterm"/> Checkout:<div class="informalexample"><pre class="programlisting">public function paypalExpressCheckoutAction()
{
  $request = $this-&gt;getRequest();
  $orderId = $request-&gt;getPost()-&gt;get('orderId');
  
  $orderTable = $this-&gt;getServiceLocator()-&gt;get('StoreOrdersTable');
  $order = $orderTable-&gt;getOrder($orderId);
   
  $paypalRequest = $this-&gt;getPaypalRequest();
  
  $paymentDetails = new \SpeckPaypal\Element\PaymentDetails
  (array('amt' =&gt; $order-&gt;total
  ));
  $express = new \SpeckPaypal\Request\SetExpressCheckout(
      array('paymentDetails' =&gt; $paymentDetails)
  );
 
  $express-&gt;setReturnUrl(
    'http://comm-app.local/users/store/paymentConfirm');
  $express-&gt;setCancelUrl(
    'http://comm-app.local/users/store/paymentCancel');
  
  // Send Order information to PayPal   
  $response = $paypalRequest-&gt;send($express);
  $token = $response-&gt;getToken();
  
  $paypalSession = new \Zend\Session\Container('paypal');
  $paypalSession-&gt;tokenId = $token; 
  $paypalSession-&gt;orderId = $orderId;


  // Redirect user to PayPal Express Checkout
  $this-&gt;redirect()-&gt;toUrl('https://www.sandbox.paypal.com/webscr?cmd=_express-checkout&amp;token=' . $token);
}</pre></div></li><li class="listitem">Add a <a id="id822" class="indexterm"/>method to handle successful<a id="id823" class="indexterm"/> payment<a id="id824" class="indexterm"/> from Express Checkout—<code class="literal">paymentConfirmAction()</code>;<a id="id825" class="indexterm"/> this<a id="id826" class="indexterm"/> method will capture the payment information from PayPal, confirm the payment, and then update the order status in our system using the code as shown in the following list:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Capture payment information from PayPal:<div class="informalexample"><pre class="programlisting">
<code class="literal">// To capture Payer Information from PayPal</code>
<code class="literal">$paypalSession = new \Zend\Session\Container('paypal');</code>
<code class="literal">$paypalRequest = $this-&gt;getPaypalRequest();</code>

<span class="strong"><strong>$expressCheckoutInfo =  </strong></span>
<span class="strong"><strong>        new \SpeckPaypal\Request\GetExpressCheckoutDetails();</strong></span>
<code class="literal">$expressCheckoutInfo-&gt;setToken($paypalSession-&gt;tokenId);</code>
<code class="literal">$response = $paypalRequest-&gt;send($expressCheckoutInfo);</code>
</pre></div></li><li class="listitem" style="list-style-type: disc">Confirm order with PayPal:<div class="informalexample"><pre class="programlisting">
<code class="literal">//To capture express payment</code>
<code class="literal">$orderTable = $this-&gt;getServiceLocator()-&gt;get('StoreOrdersTable');</code>
<code class="literal">$order = $orderTable-&gt;getOrder($paypalSession-&gt;orderId);</code>
<code class="literal">$paymentDetails = new \SpeckPaypal\Element\PaymentDetails(array(</code>
<code class="literal">  'amt' =&gt; $order-&gt;total</code>
<code class="literal">));</code>

<code class="literal">$token = $response-&gt;getToken();</code>
<code class="literal">$payerId = $response-&gt;getPayerId();</code>

<span class="strong"><strong>$captureExpress = new \SpeckPaypal\Request\DoExpressCheckoutPayment(</strong></span>
<span class="strong"><strong>  array(</strong></span>
<span class="strong"><strong>      'token'             =&gt; $token,</strong></span>
<span class="strong"><strong>      'payerId'           =&gt; $payerId,</strong></span>
<span class="strong"><strong>      'paymentDetails'    =&gt; $paymentDetails</strong></span>
<span class="strong"><strong>  ));</strong></span>
<code class="literal">$confirmPaymentResponse = $paypalRequest-&gt;send($captureExpress);</code>
</pre></div></li><li class="listitem" style="list-style-type: disc">Save order with updated shipping/billing information:<div class="informalexample"><pre class="programlisting">
<code class="literal">//To Save Order Information</code>
<code class="literal">$order-&gt;first_name = $response-&gt;getFirstName();</code>
<code class="literal">$order-&gt;last_name = $response-&gt;getLastName();</code>
<code class="literal">$order-&gt;ship_to_street = $response-&gt;getShipToStreet();</code>
<code class="literal">$order-&gt;ship_to_city = $response-&gt;getShipToCity();</code>
<code class="literal">$order-&gt;ship_to_state = $response-&gt;getShipToState();</code>
<code class="literal">$order-&gt;ship_to_zip = $response-&gt;getShipToZip();</code>
<code class="literal">$order-&gt;email = $response-&gt;getEmail();</code>
<code class="literal">$order-&gt;store_order_id = $paypalSession-&gt;orderId;</code>
<code class="literal">$order-&gt;status = 'completed';</code>
<code class="literal">$orderTable-&gt;saveOrder($order);</code>
</pre></div></li></ul></div></li><li class="listitem">Finally<a id="id827" class="indexterm"/> add <a id="id828" class="indexterm"/>a method to handle<a id="id829" class="indexterm"/> failed payment from Express <a id="id830" class="indexterm"/>Checkout—<code class="literal">paymentCancelAction()</code>:<div class="informalexample"><pre class="programlisting">public function paymentCancelAction()
{
  $paypalSession = new \Zend\Session\Container('paypal');
   
  $storeOrdersTG = $this-&gt;getServiceLocator()
                      -&gt;get('StoreOrdersTableGateway');
  $storeOrdersTG-&gt;update(
            array('status' =&gt; 'cancelled'), 
            array('id' =&gt; $paypalSession-&gt;orderId));
  $paypalSession-&gt;orderId = NULL;
  $paypalSession-&gt;tokenId = NULL;  
  $view = new ViewModel();
  return $view;
}</pre></div></li><li class="listitem">Now <a id="id831" class="indexterm"/>log in to <a class="ulink" href="https://developer.paypal.com">https://developer.paypal.com</a> again.</li><li class="listitem">Generate <a id="id832" class="indexterm"/>a new sandbox account of type <code class="literal">PERSONAL</code>.</li><li class="listitem">Now access the store and try to purchase using the newly created Sandbox account. The final store should look like the following screenshot:<div class="mediaobject"><img src="graphics/1929OS_08_09.jpg" alt="Time for action – accepting payments using PayPal"/></div><p>After<a id="id833" class="indexterm"/> choosing the checkout from <a id="id834" class="indexterm"/>the<a id="id835" class="indexterm"/> <span class="strong"><strong>Shopping Cart</strong></span> page, you will<a id="id836" class="indexterm"/> be redirected to the <span class="strong"><strong>Pay with my</strong></span><a id="id837" class="indexterm"/>
<span class="strong"><strong> PayPal account</strong></span> login page as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/1929OS_08_10.jpg" alt="Time for action – accepting payments using PayPal"/></div><p>A screenshot of the PayPal Express Checkout's order reviewing page is shown<a id="id838" class="indexterm"/> in the following screenshot; <a id="id839" class="indexterm"/>this<a id="id840" class="indexterm"/> page is used to review<a id="id841" class="indexterm"/> the payment that is being made to the merchant from the customer's PayPal account:</p><div class="mediaobject"><img src="graphics/1929OS_08_11.jpg" alt="Time for action – accepting payments using PayPal"/></div><p>Once <a id="id842" class="indexterm"/>the order is successfully placed, the <a id="id843" class="indexterm"/>user<a id="id844" class="indexterm"/> is redirected to the<a id="id845" class="indexterm"/> order confirmation page  as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/1929OS_08_12.jpg" alt="Time for action – accepting payments using PayPal"/></div></li><li class="listitem">Now<a id="id846" class="indexterm"/> log<a id="id847" class="indexterm"/> in<a id="id848" class="indexterm"/> to<a id="id849" class="indexterm"/> the Sandbox site for the merchant account to see if the payments are credited:<div class="mediaobject"><img src="graphics/1929OS_08_13.jpg" alt="Time for action – accepting payments using PayPal"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec79"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We just used PayPal Express Checkout to receive payments in our web application and complete<a id="id850" class="indexterm"/> the simple store application. As you<a id="id851" class="indexterm"/> can see, the PayPal<a id="id852" class="indexterm"/> API <a id="id853" class="indexterm"/>makes it relatively easy to set up the payment gateway.</p></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec80"/>Have a go hero</h2></div></div></div><p>In your next task, make use of the <code class="literal">DoDirectPayment</code><a id="id854" class="indexterm"/> API call to directly make a payment on the website without having to redirect the user to the PayPal website and back again.</p></div><div class="section" title="Pop quiz – creating a simple store"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec81"/>Pop quiz – creating a simple store</h2></div></div></div><p>Q1. Which of the following methods is used to send the initial payment information for PayPal redirection?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><code class="literal">RedirectExpressCheckout</code></li><li class="listitem"><code class="literal">SetExpressCheckout</code></li><li class="listitem"><code class="literal">GetExpressCheckoutDetails</code></li><li class="listitem"><code class="literal">DoExpressCheckoutPayment</code></li></ol></div><p>Q2. Which of the following fields is needed for requesting payment information from PayPal?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><code class="literal">token</code></li><li class="listitem"><code class="literal">payerId</code></li><li class="listitem"><code class="literal">paymentDetails</code></li><li class="listitem"><code class="literal">orderID</code></li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec82"/>Summary</h1></div></div></div><p>In this chapter we have learned the basics of setting up a simple store online and trying to receive payments using PayPal. As you can see from the previous example, Zend Framework's use of modules simplifies application development by giving developers the ability to download and install external third-party modules based on their integration needs. In the next chapter, we will be working on HTML5 development with Zend Framework 2.0.</p></div></body></html>