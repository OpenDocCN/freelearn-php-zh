<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Using Phalcon's Features"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Using Phalcon's Features</h1></div></div></div><p>It's time to add some features to our blog and learn more about Phalcon's functionality in the process. There is still a lot to do to get our blog up-to-speed. Users' passwords are still in plain text, and anyone, whether they are a user or not, can browse to a user's page and view the passwords. So, we need to set up at least some sort of security and user-access control. We have a comments table, yet we don't have any way to comment. And a blog is not a blog without an RSS feed and the ability to ping feed aggregators.</p><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How to hash passwords with Phalcon</li><li class="listitem" style="list-style-type: disc">How to use view helpers and view partials</li><li class="listitem" style="list-style-type: disc">How to set cookies</li><li class="listitem" style="list-style-type: disc">How to control the user's access</li><li class="listitem" style="list-style-type: disc">How to cache data in our application</li><li class="listitem" style="list-style-type: disc">How to use Phalcon's event manager</li><li class="listitem" style="list-style-type: disc">How to route application requests</li></ul></div><div class="section" title="Hashing passwords with Phalcon"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec41"/>Hashing passwords with Phalcon</h1></div></div></div><p>First, let's at least get the passwords hashed. Hashing is a process by which a password is converted into a fixed length bit string or a hash that cannot be reverse-engineered to retrieve the password, but any<a id="id232" class="indexterm"/> change in the entered password will change the resulting hash. So, for a more secure application, we are going to generate a hash from the password that a user enters and store that value in the database. Then, when the user tries to log in again, we will generate a hash from the entered password and compare<a id="id233" class="indexterm"/> it to the value of the hash in the database.</p><p>Fortunately, this is easy to do with Phalcon. The security component is automatically loaded in the Phalcon services' container. So, open up the <code class="literal">UsersController.php</code> file and find the <code class="literal">createAction</code> function<a id="id234" class="indexterm"/>; then, find the line where the password is set.</p><div class="informalexample"><pre class="programlisting">$user-&gt;password = $this-&gt;request-&gt;getPost("password");</pre></div><p>Then, simply replace it with the following two lines of code:</p><div class="informalexample"><pre class="programlisting">$password = $this-&gt;request-&gt;getPost("password");
$user-&gt;password = $this-&gt;security-&gt;hash($password);</pre></div><p>Now, when we create a user, the password will be hashed and saved to the database. We also want to save the password again as a hash if we edit. So, we find the same line of code in the <code class="literal">saveAction</code> function<a id="id235" class="indexterm"/> <a id="id236" class="indexterm"/>and replace it with the previous two lines of code to hash the password.</p><p>Now, all we need to do is edit our <code class="literal">loginAction</code> function. Our initial function was kind of clunky. So, we are going<a id="id237" class="indexterm"/> to replace it with something a little more streamlined. The new <code class="literal">loginAction</code> function will look like the following code snippet:</p><div class="informalexample"><pre class="programlisting">public function loginAction() {

        if ($this-&gt;request-&gt;isPost()) {
            $username = $this-&gt;request-&gt;getPost('username');
            $password = $this-&gt;request-&gt;getPost('password');

            $user = Users::findFirstByUsername($username);
            if ($user &amp;&amp; $this-&gt;security-&gt;checkHash($password, $user-&gt;password)) {
                $this-&gt;session-&gt;set("user_id", $user-&gt;id);
                $this-&gt;cookies-&gt;set('user_id', $user-&gt;id);
                $this-&gt;session-&gt;set('auth', array(
                    'id' =&gt; $user-&gt;id,
                    'name' =&gt; $user-&gt;name
                ));
                $this-&gt;flash-&gt;success("Welcome " . $user-&gt;name);
            }else{
                $this-&gt;flash-&gt;error("Username and Password combination not found");
            }
        }
        return $this-&gt;dispatcher-&gt;forward(
            array(
                "controller" =&gt; "posts",
                "action" =&gt; "index"
            )
        );
    }</pre></div><p>Instead of searching for the user in the database, we try to instantiate the user using the <code class="literal">findFirstByFieldname</code> function,<a id="id238" class="indexterm"/> where <code class="literal">Fieldname</code> can be replaced with the column in the database we are querying. If we do find a user by searching for the username, we use security services' <code class="literal">checkHash</code> function to compare the hash in the database with the hash we just generated off of the entered password. If there is a match, we go through the process of setting the <code class="literal">user_id</code> variable in the session and creating a welcome message.</p><p>The Phalcon security<a id="id239" class="indexterm"/> component uses the bcrypt hash algorithm, which gives us a high level of security. This component is loaded in Phalcon by default, but it can also be configured manually to tweak <a id="id240" class="indexterm"/>the "slowness" of the bcrypt algorithm. You can learn more about this component at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/security.html">http://docs.phalconphp.com/en/latest/reference/security.html</a>.</p></div></div>
<div class="section" title="Using Phalcon view helpers"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec42"/>Using Phalcon view helpers</h1></div></div></div><p>We can also add some security by changing the password fields on the forms to true password fields. So, find<a id="id241" class="indexterm"/> the following files in the <code class="literal">users</code> folder located at <code class="literal">app/views</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">new.volt</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">index.volt</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">edit.volt</code></li></ul></div><p>And find the following line of code:</p><div class="informalexample"><pre class="programlisting">{{ text_field("password", "size" : 30) }}</pre></div><p>Replace the preceding code with the following line of code:</p><div class="informalexample"><pre class="programlisting">{{ password_field("password", "size" : 30) }}</pre></div><p>Now, passwords will be masked when they are entered in the field.</p><p>As we learned in <a class="link" href="ch03.html" title="Chapter 3. Using Phalcon Models, Views, and Controllers">Chapter 3</a>, <span class="emphasis"><em>Using Phalcon Models, Views, and Controllers</em></span>, the Volt template engine is a very thin wrapper that is wrapped around PHP code, which Phalcon compiles to the actual PHP code. To <a id="id242" class="indexterm"/>call a Phalcon tag helper in Volt, we just use the uncamelized version of the function.</p><div class="section" title="Using dynamic title tags"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec34"/>Using dynamic title tags</h2></div></div></div><p>Let's replace some of the HTML markup we wrote with some view helpers. A powerful view helper is the one for the <a id="id243" class="indexterm"/>document title. Right now, we have a hardcoded <code class="literal">title</code> tag in our main layout which gives the same title to every page. So, open up the <code class="literal">index.volt</code> file located at <code class="literal">app/views</code> and find the following line of code:</p><div class="informalexample"><pre class="programlisting">&lt;title&gt;Phalcon Blog&lt;/title&gt;</pre></div><p>Replace the preceding code with the following line of code:</p><div class="informalexample"><pre class="programlisting">{{ get_title() }}</pre></div><p>Now, the only problem is that our page has no title because we haven't set it yet. It would probably be a good idea to keep the title of our blog on every page. We could hardcode that or open up the <code class="literal">ControllerBase.php</code> file located at <code class="literal">app/controllers</code> and add the following function to the <code class="literal">ControllerBase</code> class:</p><div class="informalexample"><pre class="programlisting">public function initialize() {
        $this-&gt;tag-&gt;setTitle("Phalcon Blog");
}</pre></div><p>Now, we have our<a id="id244" class="indexterm"/> global title back again. But we want each blog post to have the title of the post in the title also. So, if we have a blog post called Hello World, we want our title to be Hello World: Phalcon Blog. It's easy to do this. Open up the <code class="literal">PostController.php </code>file located at<code class="literal"> app/controllers</code> and add the following line of code to the end of the <code class="literal">showAction</code> function:</p><div class="informalexample"><pre class="programlisting">$this-&gt;tag-&gt;prependTitle($post-&gt;title . " - ");</pre></div><p>The title of a blog post is displayed before the blog title if you visit a blog post page. Now, if you want, you can add your own title to each action in each controller.</p></div><div class="section" title="Setting the doctype"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec35"/>Setting the doctype</h2></div></div></div><p>By setting the document type with Phalcon, you affect all the tags that it generates with tag helpers, so they <a id="id245" class="indexterm"/>conform to your chosen standard. We are going to use HTML5. Add the following line of code to the <code class="literal">initialize</code> function in the <code class="literal">ControllerBase.php</code> file located at <code class="literal">app/controllers</code>:</p><div class="informalexample"><pre class="programlisting">$this-&gt;tag-&gt;setDoctype(\Phalcon\Tag::HTML5);</pre></div><p>Now, the document type will be set globally in each controller. Find the following line of code at the top of the <code class="literal">index.html</code> file located at <code class="literal">app/views</code>:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;</pre></div><p>And replace the preceding code with the following line of code:</p><div class="informalexample"><pre class="programlisting">{{ get_doctype() }}</pre></div><p>Now, you can be sure that Phalcon will output tags that follow whatever standard you choose. To learn about the other document standards, you can visit <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/tags.html#document-type-of-content">http://docs.phalconphp.com/en/latest/reference/tags.html#document-type-of-content</a>.</p></div><div class="section" title="Adding JavaScript and CSS with view helpers"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec36"/>Adding JavaScript and CSS with view helpers</h2></div></div></div><p>We originally just hardcoded the CSS and JavaScript links in the head of our main layout file. This works for now, <a id="id246" class="indexterm"/>but if we move our project, we <a id="id247" class="indexterm"/>may have to change these links. Phalcon has script and CSS tag helpers that will make our job<a id="id248" class="indexterm"/> a little easier. We can replace the<a id="id249" class="indexterm"/> CSS links in the head of the <code class="literal">index.phtml</code> file located at <code class="literal">app/views</code> with the following code snippet:</p><div class="informalexample"><pre class="programlisting">{{ stylesheet_link("css/bootstrap/bootstrap.min.css") }}
{{ stylesheet_link("css/bootstrap/bootstrap-responsive.min.css") }}</pre></div><p>We put the JavaScript links at the bottom of the file with the following lines of code:</p><div class="informalexample"><pre class="programlisting">{{ javascript_include("js/jquery.min.js") }}
{{ javascript_include("js/bootstrap.min.js") }}</pre></div><p>We will explore more view helpers as we read through this chapter. To learn more about Phalcon tag helpers, visit <a class="ulink" href="http://docs.phalconphp.com/en/latest/api/Phalcon_Tag.html">http://docs.phalconphp.com/en/latest/api/Phalcon_Tag.html</a>.</p></div></div>
<div class="section" title="Setting cookies"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec43"/>Setting cookies</h1></div></div></div><p>Now we can log in and have <a id="id250" class="indexterm"/>secure passwords, but every time the browser is closed, we have to log in again. It would be nice to be able to log in to our blog and stay logged in for a few days at least. It is time to set a cookie.</p><p>We are going to change the way we do this as we go through this chapter, but for now, it is very easy to set a cookie that will keep us logged in with very little code. First, we need to set up an encryption key because we will want to decrypt a cookie before setting it and decrypt it while retrieving it. We want to keep it that way, but in order to do this, we need to give it a key. So, go to <a class="ulink" href="http://randomkeygen.com/">http://randomkeygen.com/</a> to generate a random string of digits. Then, open up the <code class="literal">config.ini</code> file located at <code class="literal">app/config</code> and add your key in the application section and call it <code class="literal">encryptKey</code>, shown as follows:</p><div class="informalexample"><pre class="programlisting">[application]
controllersDir = /home/eristoddle/Dropbox/xampp/htdocs/phalconBlog/app/controllers/
modelsDir = /home/eristoddle/Dropbox/xampp/htdocs/phalconBlog/app/models/
viewsDir = /home/eristoddle/Dropbox/xampp/htdocs/phalconBlog/app/views/
pluginsDir = ../app/plugins/
libraryDir = ../app/library/
baseUri = /phalconBlog/
cacheDir = ../app/cache/
encryptKey = 2tx6]GD}532q4x_</pre></div><p>Then, open up the <code class="literal">services.php</code> file located at <code class="literal">app/config</code> and add the following code snippet to the bottom of the<a id="id251" class="indexterm"/> file in order to set the encryption key:</p><div class="informalexample"><pre class="programlisting">$di-&gt;set(
    'crypt', function () use ($config) {
        $crypt = new Phalcon\Crypt();
        $crypt-&gt;setKey($config-&gt;application-&gt;encryptKey);
        return $crypt;
    }
);</pre></div><p>Now, our cookies are ready to go. They were available earlier, but had we used them, they would have thrown an error about requiring an encryption key. Now, find the <code class="literal">loginAction</code> function<a id="id252" class="indexterm"/> in the <code class="literal">UsersController.php</code> file located at <code class="literal">app/controllers</code> and add the following line of code:</p><div class="informalexample"><pre class="programlisting">$this-&gt;cookies-&gt;set('user_id', $user-&gt;id);</pre></div><p>Add it right after you set the <code class="literal">user_id</code> variable in the session:</p><div class="informalexample"><pre class="programlisting">$this-&gt;session-&gt;set("user_id", $user-&gt;id);</pre></div><p>Now, open up the <code class="literal">PostsController.php</code> file located at <code class="literal">app/controllers</code> and find the part of the <code class="literal">createAction</code> function<a id="id253" class="indexterm"/> where we check the <code class="literal">user_id</code> variable in the session. Now, we are going to check for cookies first and then set the <code class="literal">user_id</code> variable in the session if we find a <code class="literal">user_id</code> cookie:</p><div class="informalexample"><pre class="programlisting">if ($this-&gt;cookies-&gt;has('user_id')) {
            $this-&gt;session-&gt;set('user_id', $this-&gt;cookies-&gt;get('user_id'));
        }
        if ($this-&gt;session-&gt;has("user_id")) {
            return $this-&gt;dispatcher-&gt;forward(
                array(
                    "controller" =&gt; "users",
                    "action" =&gt; "search"
                )
            );
        }</pre></div><p>And that's about all that we have to do to retrofit our code to add cookies. To learn more about cookie management with Phalcon, see <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/cookies.html">http://docs.phalconphp.com/en/latest/reference/cookies.html</a>.</p><p>Now, we should be able to log out and log in again, close the browser, and still be logged in. However, this is not really all that we want when it comes to controlling users. We want to be able to seamlessly control everything they access. Currently, our application has holes, and to plug them, we need to copy and paste code to implement the same <code class="literal">user_id</code> variable check everywhere we need it's functionality. Fortunately, we won't have to do this. Phalcon provides a service that helps us control user access.</p></div>
<div class="section" title="Controlling user access"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec44"/>Controlling user access</h1></div></div></div><p>An <span class="strong"><strong>access control list</strong></span> (<span class="strong"><strong>ACL</strong></span>)<a id="id254" class="indexterm"/> uses roles to control access to resources. <code class="literal">Phalcon\Acl</code> provides this functionality for us. With it, we can assign roles to the different types of visitors on our blog, and then use these roles to set up permissions on each action in each of our controllers. For our purposes,<a id="id255" class="indexterm"/> we are only going to create two roles, users and guests. A user will simply be a visitor that is logged in, a guest, or anyone else. We are only going to give guest access to perform the following actions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">View the index page:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">View the posts' index page</li><li class="listitem" style="list-style-type: disc">Comment on a post</li><li class="listitem" style="list-style-type: disc">View the users' index, which will be a login page, when a visitor is not logged in</li></ul></div></li><li class="listitem" style="list-style-type: disc">Log in</li></ul></div><p>A logged in user can do everything. To put <code class="literal">Phalcon\Acl</code> to use in our application, we are going to create a simple Phalcon plugin. Phalcon Developer Tools already added our <code class="literal">plugins</code> folder and created the <code class="literal">pluginsDir</code> setting in the <code class="literal">config.ini</code> file. However, we still need to add the <code class="literal">plugins</code> directory to our loader. Open the <code class="literal">loader.php</code> file located at <code class="literal">app/config</code> and add the <code class="literal">plugins</code> directory to your loader.</p><div class="informalexample"><pre class="programlisting">$loader-&gt;registerDirs(
    array(
        $config-&gt;application-&gt;controllersDir,
        $config-&gt;application-&gt;modelsDir,
        $config-&gt;application-&gt;pluginsDir
    )
)-&gt;register();</pre></div><p>What we want to create is a plugin that will hook into Phalcon's event manager. Using the event manager, we can attach listeners to various Phalcon events. Create a new file called <code class="literal">Security.php</code> in the <code class="literal">app/plugins</code> folder and add the following code snippet at the top of the file:</p><div class="informalexample"><pre class="programlisting">&lt;?php

use Phalcon\Events\Event,
    Phalcon\Mvc\User\Plugin,
    Phalcon\Mvc\Dispatcher,
    Phalcon\Acl;

class Security extends Plugin {

    public function __construct($dependencyInjector) {
        $this-&gt;_dependencyInjector = $dependencyInjector;
    }</pre></div><p>We extend <code class="literal">Phalcon\Plugin</code>. Our constructor must accept a dependency injector instance. Then, we need to create a function<a id="id256" class="indexterm"/> that will add our ACL to our persistent variables. We will call it <code class="literal">getAcl</code>.</p><div class="informalexample"><pre class="programlisting">    public function getAcl() {
        if (!isset($this-&gt;persistent-&gt;acl)) {

            $acl = new Phalcon\Acl\Adapter\Memory();
            $acl-&gt;setDefaultAction(Phalcon\Acl::DENY);

            $roles = array(
                'users' =&gt; new Phalcon\Acl\Role('Users'),
                'guests' =&gt; new Phalcon\Acl\Role('Guests')
            );
            foreach ($roles as $role) {
                $acl-&gt;addRole($role);
            }

            $private = array(
                'comments' =&gt; array('index', 'edit', 'delete', 'save'),
                'posts' =&gt; array('new', 'edit', 'save', 'create', 'delete'),
                'users' =&gt; array('search', 'new', 'edit', 'save', 'create', 'delete', 'logout')
            );
            foreach ($private as $resource =&gt; $actions) {
                $acl-&gt;addResource(new Phalcon\Acl\Resource($resource), $actions);
            }

            $public = array(
                'index' =&gt; array('index'),
                'posts' =&gt; array('index', 'search', 'show', 'comment'),
                'users' =&gt; array('login', 'index')
            );
            foreach ($public as $resource =&gt; $actions) {
                $acl-&gt;addResource(new Phalcon\Acl\Resource($resource), $actions);
            }

            foreach ($roles as $role) {
                foreach ($public as $resource =&gt; $actions) {
                    foreach ($actions as $action) {
                        $acl-&gt;allow($role-&gt;getName(), $resource, $action);
                    }
                }
            }

            foreach ($private as $resource =&gt; $actions) {
                foreach ($actions as $action) {
                    $acl-&gt;allow('Users', $resource, $action);
                }
            }

            $this-&gt;persistent-&gt;acl = $acl;
        }

        return $this-&gt;persistent-&gt;acl;
    }</pre></div><p>First, the code checks if we already have an ACL instance. If not, we create one. We then set the <code class="literal">DefaultAction</code> function<a id="id257" class="indexterm"/> to deny access for security reasons. The next bit of code creates the roles, that is, users and guests, in our ACL. We then load all of the resources we want to be private into a variable <a id="id258" class="indexterm"/>and then add them all as resources. We will do the same for the resources that we want to be public. Then, we loop through the roles, giving both the roles access to the public resources. Then, we loop through the private resources and give access to users but not to guests. Finally, we set our new ACL to be persistent and return it.</p><p>This function just builds the structure of our ACL. We still need to actually control the access, and we will do that with a function that will fire before dispatch. Add the following function at the bottom of the file:</p><div class="informalexample"><pre class="programlisting">    public function beforeDispatch(Event $event, Dispatcher $dispatcher) {

        $user = $this-&gt;session-&gt;get('user_id');
        if (!$user) {
            $role = 'Guests';
        } else {
            $role = 'Users';
        }

        $controller = $dispatcher-&gt;getControllerName();
        $action = $dispatcher-&gt;getActionName();
        $acl = $this-&gt;getAcl();

        $allowed = $acl-&gt;isAllowed($role, $controller, $action);
        if ($allowed != Acl::ALLOW) {
            $this-&gt;flash-&gt;error("You don't have access to this module");
            $dispatcher-&gt;forward(
                array(
                    'controller' =&gt; 'index',
                    'action' =&gt; 'index'
                )
            );
            return false;
        }

    }

}</pre></div><p>This function accepts an event instance<a id="id259" class="indexterm"/> and a dispatcher instance. We check if the visitor is logged in and set their role. Then, we set a variable to our controller name and one to the action name. We call our <code class="literal">getAcl</code> function<a id="id260" class="indexterm"/> to get our ACL, and we also call <code class="literal">$acl-&gt;isAllowed()</code>, passing the role of the visitor and the names of our controller and action. This will return true if the role is allowed access to the current resource. If the user is not allowed access, we set an error message and forward them to the index of our blog.</p><p>Now, we need to hook into the standard dispatcher, attach this new <code class="literal">Security</code> plugin<a id="id261" class="indexterm"/> to our events manager, and set this as the event manager for our dispatcher. Open the <code class="literal">services.php</code> file located at <code class="literal">app/config</code> and add the following code snippet to the bottom of the file:</p><div class="informalexample"><pre class="programlisting">$di-&gt;set('dispatcher', function() use ($di) {
    $eventsManager = $di-&gt;getShared('eventsManager');
    $security = new Security($di);
    $eventsManager-&gt;attach('dispatch', $security);
    $dispatcher = new Phalcon\Mvc\Dispatcher();
    $dispatcher-&gt;setEventsManager($eventsManager);
    return $dispatcher;
});</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>To learn more about using <code class="literal">Phalcon\Acl</code>, visit <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/acl.html">http://docs.phalconphp.com/en/latest/reference/acl.html</a>. And to learn more about <a id="id262" class="indexterm"/>Phalcon's event manager, visit <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/events.html">http://docs.phalconphp.com/en/latest/reference/events.html</a>.</p></div></div></div>
<div class="section" title="Applying the finishing touches to our application"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec45"/>Applying the finishing touches to our application</h1></div></div></div><p>Phalcon Developer Tools can help out a lot, but let's face it, most of the code you are going to write for your application is from scratch. Our blog still doesn't have comments or a feed, so it is really not much of a blog. Adding these is going to be a manual job, but Phalcon makes it easy.</p><div class="section" title="Adding comments"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec37"/>Adding comments</h2></div></div></div><p>Now, let's give visitors the ability to comment on our posts. Earlier, we needed a user-access control so that we could limit moderating comments to logged-in users. But now, we need a place to do it. We are going to build a very simple comment-moderation system. We could use Phalcon Developer Tools or Phalcon web tools to generate our CRUD scaffolding for us, but in this case, we would almost be taking out more of the generated code than we'd be leaving in, but we can use the other controllers and views we generated as a guide.</p><p>For comments, we need to add a<a id="id263" class="indexterm"/> form to comment on the posts showing an action view, and we also need to display comments that have been published under each post. We also need a place to list all comments, and a form to edit them and set them to be published.</p><p>Comments are already related to posts. We just need to modify a few things to make this relationship functional. Open the <code class="literal">show.volt</code> file located at <code class="literal">app/views/posts</code>. At the bottom of the file, add the following code snippet:</p><div class="informalexample"><pre class="programlisting">&lt;div class="comments"&gt;
    &lt;h3&gt;Comments&lt;/h3&gt;
    &lt;div class="comment"&gt;
    {% for comments in post.comments if comments.publish == true %}
        &lt;div&gt;{{ comments.body }}&lt;/div&gt;
        &lt;div&gt;&lt;a href="{{ comments.url }}"&gt;{{ comments.name }}&lt;/a&gt;&lt;/div&gt;
    {% endfor %}
    &lt;/div&gt;
    &lt;h3&gt;Leave a Comment&lt;/h3&gt;
    &lt;div&gt;
        {{ form("posts/comment", "method":"post") }}
        {{ hidden_field("posts_id", "value" : post.id) }}
        &lt;div&gt;
            &lt;label for="title"&gt;Comment&lt;/label&gt;
            {{ text_area("body") }}
        &lt;/div&gt;
        &lt;div&gt;
            &lt;label for="title"&gt;Name&lt;/label&gt;
            {{ text_field("name") }}
        &lt;/div&gt;
        &lt;div&gt;
            &lt;label for="title"&gt;Email&lt;/label&gt;
            {{ text_field("email") }}
        &lt;/div&gt;
        &lt;div&gt;
            &lt;label for="title"&gt;Website&lt;/label&gt;
            {{ text_field("url") }}
        &lt;/div&gt;
        {{ submit_button("Comment", "class" : "btn") }}
        {{ end_form() }}
    &lt;/div&gt;
&lt;/div&gt;</pre></div><p>Right below the post, we loop through the comments that are related to that post, and if we set them to publish, <a id="id264" class="indexterm"/>we print the comment. Below that, we have the comment form, making sure that we have a hidden field that picks up the ID of the post. We make this form post to posts/comment, <a id="id265" class="indexterm"/>which means that we now need a <code class="literal">commentAction</code> function<a id="id266" class="indexterm"/> in our <code class="literal">Posts</code> controller. Open the <code class="literal">PostsController.php</code> file located at <code class="literal">app/controllers</code> and add the following function:</p><div class="informalexample"><pre class="programlisting">public function commentAction(){
        $comment = new Comments();
        $comment-&gt;posts_id = $this-&gt;request-&gt;getPost("posts_id");
        $comment-&gt;body = $this-&gt;request-&gt;getPost("body");
        $comment-&gt;name = $this-&gt;request-&gt;getPost("name");
        $comment-&gt;email = $this-&gt;request-&gt;getPost("email");
        $comment-&gt;url = $this-&gt;request-&gt;getPost("url");
        $comment-&gt;submitted = date("Y-m-d H:i:s");
        $comment-&gt;publish = 0;
        $comment-&gt;save();

        $this-&gt;flash-&gt;success("Your comment has been submitted.");

        return $this-&gt;dispatcher-&gt;forward(
            array(
                "controller" =&gt; "posts",
                "action" =&gt; "show",
                "params" =&gt; array($comment-&gt;posts_id)
            )
        );
}</pre></div><p>It's pretty simple. We create an instance of the <code class="literal">Comments</code> object from the <code class="literal">POST</code> variable, set the submitted date, and set the publish value to 0, which will represent false in our database. Then, we set a success message and forward the user back to the <code class="literal">Posts</code> show action, setting the ID to<a id="id267" class="indexterm"/> the ID of the post that was just commented on.</p><p>Now, we need a way to <a id="id268" class="indexterm"/>moderate our comments. First, we need a <code class="literal">Comments</code> controller. So, create a <code class="literal">CommentsController.php</code> file at <code class="literal">app/controllers</code> and make sure to include <code class="literal">Paginator</code>, because we will be using it.</p><div class="informalexample"><pre class="programlisting">use Phalcon\Paginator\Adapter\Model as Paginator;</pre></div><p>Then, we need our <code class="literal">CommentsController</code> class.</p><div class="informalexample"><pre class="programlisting">class CommentsController extends ControllerBase {
  //Actions will go here
}</pre></div><p>And inside the <code class="literal">CommentsController</code> class<a id="id269" class="indexterm"/>, we need actions for indexing, editing, saving, and deleting. Our <a id="id270" class="indexterm"/>
<code class="literal">indexAction</code> function returns a paginated result of all comments.</p><div class="informalexample"><pre class="programlisting">    public function indexAction() {
        $numberPage = $this-&gt;request-&gt;getQuery("page", "int", 1);

        $comments = Comments::query()
            -&gt;order("submitted DESC")
            -&gt;execute();

        $paginator = new Paginator(array(
            "data" =&gt; $comments,
            "limit" =&gt; 10,
            "page" =&gt; $numberPage
        ));

        $this-&gt;view-&gt;page = $paginator-&gt;getPaginate();
    }</pre></div><p>Our <code class="literal">editAction</code> function<a id="id271" class="indexterm"/> prepares a single comment for use in the edit form, when we are moderating a comment, by setting it to be published.</p><div class="informalexample"><pre class="programlisting">    public function editAction($id) {

        if (!$this-&gt;request-&gt;isPost()) {

            $comment = Comments::findFirstByid($id);
            if (!$comment) {
                $this-&gt;flash-&gt;error("comment was not found");
                return $this-&gt;dispatcher-&gt;forward(
                    array(
                        "controller" =&gt; "comments",
                        "action" =&gt; "index"
                    )
                );
            }

            $this-&gt;view-&gt;id = $comment-&gt;id;

            $this-&gt;tag-&gt;setDefault("id", $comment-&gt;id);
            $this-&gt;tag-&gt;setDefault("body", $comment-&gt;body);
            $this-&gt;tag-&gt;setDefault("name", $comment-&gt;name);
            $this-&gt;tag-&gt;setDefault("email", $comment-&gt;email);
            $this-&gt;tag-&gt;setDefault("url", $comment-&gt;url);
            $this-&gt;tag-&gt;setDefault("submitted", $comment-&gt;submitted);
            $this-&gt;tag-&gt;setDefault("publish", $comment-&gt;publish);
            $this-&gt;tag-&gt;setDefault("posts_id", $comment-&gt;posts_id);

        }
    }</pre></div><p>The <code class="literal">saveAction</code> function <a id="id272" class="indexterm"/>saves<a id="id273" class="indexterm"/> an edited<a id="id274" class="indexterm"/> comment after we moderate it.</p><div class="informalexample"><pre class="programlisting">    public function saveAction() {

        if (!$this-&gt;request-&gt;isPost()) {
            return $this-&gt;dispatcher-&gt;forward(
                array(
                    "controller" =&gt; "comments",
                    "action" =&gt; "index"
                )
            );
        }

        $id = $this-&gt;request-&gt;getPost("id");

        $comment = Comments::findFirstByid($id);
        if (!$comment) {
            $this-&gt;flash-&gt;error("comment does not exist " . $id);
            return $this-&gt;dispatcher-&gt;forward(
                array(
                    "controller" =&gt; "comments",
                    "action" =&gt; "index"
                )
            );
        }

        $comment-&gt;id = $this-&gt;request-&gt;getPost("id");
        $comment-&gt;body = $this-&gt;request-&gt;getPost("body");
        $comment-&gt;name = $this-&gt;request-&gt;getPost("name");
        $comment-&gt;email = $this-&gt;request-&gt;getPost("email", "email");
        $comment-&gt;url = $this-&gt;request-&gt;getPost("url");
        $comment-&gt;publish = $this-&gt;request-&gt;getPost("publish");


        if (!$comment-&gt;save()) {

            foreach ($comment-&gt;getMessages() as $message) {
                $this-&gt;flash-&gt;error($message);
            }

            return $this-&gt;dispatcher-&gt;forward(
                array(
                    "controller" =&gt; "comments",
                    "action" =&gt; "edit",
                    "params" =&gt; array($comment-&gt;id)
                )
            );
        }

        $this-&gt;flash-&gt;success("comment was updated successfully");
        return $this-&gt;dispatcher-&gt;forward(
            array(
                "controller" =&gt; "comments",
                "action" =&gt; "index"
            )
        );

    }</pre></div><p>The <a id="id275" class="indexterm"/>
<code class="literal">deleteAction</code> function gets<a id="id276" class="indexterm"/> rid of our <a id="id277" class="indexterm"/>comment spam.</p><div class="informalexample"><pre class="programlisting">    public function deleteAction($id) {

        $comment = Comments::findFirstByid($id);
        if (!$comment) {
            $this-&gt;flash-&gt;error("comment was not found");
            return $this-&gt;dispatcher-&gt;forward(
                array(
                    "controller" =&gt; "comments",
                    "action" =&gt; "index"
                )
            );
        }

        if (!$comment-&gt;delete()) {

            foreach ($comment-&gt;getMessages() as $message) {
                $this-&gt;flash-&gt;error($message);
            }

            return $this-&gt;dispatcher-&gt;forward(
                array(
                    "controller" =&gt; "comments",
                    "action" =&gt; "search"
                )
            );
        }

        $this-&gt;flash-&gt;success("comment was deleted successfully");
        return $this-&gt;dispatcher-&gt;forward(
            array(
                "controller" =&gt; "comments",
                "action" =&gt; "index"
            )
        );
    }</pre></div><p>Now, we just need views. First, we need the view for our <code class="literal">indexAction</code> function.<a id="id278" class="indexterm"/> So, create a file called <code class="literal">index.volt</code> in the <code class="literal">comments</code> folder located at <code class="literal">app/views</code> and insert the following code snippet in it:</p><div class="informalexample"><pre class="programlisting">{{ content() }}
&lt;h1&gt;Comments&lt;/h1&gt;
&lt;table class="browse" align="center"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;Body&lt;/th&gt;
            &lt;th&gt;Name&lt;/th&gt;
            &lt;th&gt;Email&lt;/th&gt;
            &lt;th&gt;Url&lt;/th&gt;
            &lt;th&gt;Submitted&lt;/th&gt;
            &lt;th&gt;Publish&lt;/th&gt;
         &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
    {% if page.items is defined %}
    {% for comment in page.items %}
        &lt;tr&gt;
            &lt;td&gt;{{ comment.body }}&lt;/td&gt;
            &lt;td&gt;{{ comment.name }}&lt;/td&gt;
            &lt;td&gt;{{ comment.email }}&lt;/td&gt;
            &lt;td&gt;{{ comment.url }}&lt;/td&gt;
            &lt;td&gt;{{ comment.submitted }}&lt;/td&gt;
            &lt;td&gt;{{ comment.publish }}&lt;/td&gt;
            &lt;td&gt;{{ link_to("comments/edit/"~comment.id, "Edit") }}&lt;/td&gt;
            &lt;td&gt;{{ link_to("comments/delete/"~comment.id, "Delete") }}&lt;/td&gt;
        &lt;/tr&gt;
    {% endfor %}
    {% endif %}
    &lt;/tbody&gt;
    &lt;tbody&gt;&lt;tr&gt;&lt;td colspan="2" align="right"&gt;
        &lt;table align="center"&gt;
            &lt;tr&gt;
                &lt;td&gt;{{ link_to("comments/search", "First") }}&lt;/td&gt;
                &lt;td&gt;{{ link_to("comments/search?page="~page.before, "Previous") }}&lt;/td&gt;
                &lt;td&gt;{{ link_to("comments/search?page="~page.next, "Next") }}&lt;/td&gt;
                &lt;td&gt;{{ link_to("comments/search?page="~page.last, "Last") }}&lt;/td&gt;
                &lt;td&gt;{{ page.current~"/"~page.total_pages }}&lt;/td&gt;
            &lt;/tr&gt;
        &lt;/table&gt;
    &lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;
&lt;/table&gt;</pre></div><p>Then, the view that will be used when we edit our posts<a id="id279" class="indexterm"/>. Save<a id="id280" class="indexterm"/> the following code snippet as <code class="literal">edit.volt</code> at <code class="literal">app/views/comments</code>:</p><div class="informalexample"><pre class="programlisting">{{ content() }}
{{ link_to("comments", "Go Back") }}

&lt;div align="center"&gt;
    &lt;h1&gt;Edit comments&lt;/h1&gt;
&lt;/div&gt;

&lt;div&gt;
    {{ form("comments/save", "method":"post") }}
        &lt;label for="body"&gt;Body&lt;/label&gt;{{ text_area("body") }}
        &lt;label for="name"&gt;Name&lt;/label&gt;{{ text_field("name") }}
        &lt;label for="email"&gt;Email&lt;/label&gt;{{ text_field("email") }}
        &lt;label for="url"&gt;Url&lt;/label&gt;{{ text_field("url") }}
        &lt;label for="publish"&gt;Publish&lt;/label&gt;
        {{ radio_field("publish", "value" : 1) }} Yes
        {{ radio_field("publish", "value" : 0) }} No
        {{ hidden_field("id") }}
        {{ submit_button("Save", "class" : "btn") }}
    {{ end_form() }}
&lt;/div&gt;</pre></div><p>Now, we can comment on posts and moderate them if we are logged in as a user.</p></div><div class="section" title="Adding feeds"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec38"/>Adding feeds</h2></div></div></div><p>A blog is not really a blog without a way to syndicate our posts. Fortunately, it is going to be pretty simple to add a feed to our blog. Let's put our feed at <code class="literal">http://localhost/phalconBlog/posts/feed</code>. This means that we need a new <code class="literal">feedAction</code> function in our posts controller. So,<a id="id281" class="indexterm"/> open the <code class="literal">PostsController.php</code> file located at <code class="literal">app/controllers</code> and add the following function:</p><div class="informalexample"><pre class="programlisting">public function feedAction() {
    $posts = Posts::find(
        array(
            'order' =&gt; 'published DESC',
            'limit' =&gt; 10
        )
    );

    $rss_posts = array();
    foreach ($posts as $post){
        $post-&gt;rss_date = date("D, d M Y H:i:s O", strtotime($post-&gt;published));
        $rss_posts[] = $post;
    }
    $this-&gt;view-&gt;posts = $rss_posts;

    $this-&gt;view-&gt;setRenderLevel(Phalcon\Mvc\View::LEVEL_ACTION_VIEW);
}</pre></div><p>Here, we retrieve only 10 posts ordered by the published date in descending order using <code class="literal">Posts::find</code>. As the date format in an RSS feed is very specific and doesn't match the MySQL datetime format, we loop through our records, converting the published date and adding this date to each <code class="literal">post</code> object. We then send the array of objects to the view. At the end of the function,<a id="id282" class="indexterm"/> we set the render level of the view. In this case, we don't want our main layout or post layout to render. We only want the specialized template that we are about to create to render, so we set our level to <code class="literal">LEVEL_ACTION_VIEW</code>. The following six levels are available:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">LEVEL_NO_RENDER</code>: This does not render any view</li><li class="listitem" style="list-style-type: disc"><code class="literal">LEVEL_ACTION_VIEW</code>: This renders the view associated with the action</li><li class="listitem" style="list-style-type: disc"><code class="literal">LEVEL_BEFORE_TEMPLATE</code>: This generates the views before the controller's layout</li><li class="listitem" style="list-style-type: disc"><code class="literal">LEVEL_LAYOUT</code>: This generates the controller's layout</li><li class="listitem" style="list-style-type: disc"><code class="literal">LEVEL_AFTER_TEMPLATE</code>: This generates the views after the controller is laid out</li><li class="listitem" style="list-style-type: disc"><code class="literal">LEVEL_MAIN_LAYOUT</code>: This generates the main layout</li></ul></div><p>Create a new file in the <code class="literal">posts</code> folder at <code class="literal">app/views</code>, call it <code class="literal">feed.volt</code>, and insert the following code snippet inside the <code class="literal">feed.volt</code> file:</p><div class="informalexample"><pre class="programlisting">{{'&lt;?xml version="1.0" encoding="UTF-8" ?&gt;'}}

&lt;rss version="2.0"&gt;
    &lt;channel&gt;
        &lt;title&gt;{{ config.blog.title }}&lt;/title&gt;
        &lt;description&gt;This is a demonstration of the Phalcon framework&lt;/description&gt;
        &lt;link&gt;{{ config.blog.url }}&lt;/link&gt;
        {% for post in posts %}
            &lt;item&gt;
                &lt;title&gt;{{ post.title|e }}&lt;/title&gt;
                &lt;description&gt;{{ post.excerpt|e }}&lt;/description&gt;
                &lt;link&gt;{{ config.blog.url }}{{ url("posts/show/"~post.id) }}&lt;/link&gt;
                &lt;guid&gt;{{ config.blog.url }}{{ url("posts/show/"~post.id) }}&lt;/guid&gt;
                &lt;pubDate&gt;{{ post.rss_date }}&lt;/pubDate&gt;
            &lt;/item&gt;
        {% endfor %}
    &lt;/channel&gt;
&lt;/rss&gt;</pre></div><p>We wrap the XML tag at the top of the Volt template tag to hide <code class="literal">&lt;?</code> from the Volt template engine. We add some necessary RSS elements including a title, description, and a link for our blog. Note that since we loaded our configuration into the DI container, we have access to the settings we created there for our blog's title and URL. The next step is to loop through the posts.<a id="id283" class="indexterm"/> This part is similar to the code in the <code class="literal">index.volt</code> file. But you may notice <code class="literal">|e</code> behind the title and the excerpt of the post. This is the Phalcon HTML escaping filter being called from Volt so that our feed will remain valid with any characters that may be in our content. We are generating XML and using the <code class="literal">rss_date</code> attribute that we created in our <code class="literal">feedAction</code> function<a id="id284" class="indexterm"/>.</p><p>The last step we need to do is add the link for RSS autodiscovery to the head of our pages. So, open the <code class="literal">index.volt</code> file located at <code class="literal">app/views</code> and add the following code snippet between the head tags:</p><div class="informalexample"><pre class="programlisting">{{ tag_html(
            "link",
            [
                "rel": "alternate",
                "type": "application/rss+xml",
                "title": "RSS Feed for Phalcon Blog",
                "href": config.application.baseUri~"posts/feed"
            ],
             true,
             true,
             true)
 }}</pre></div><p>Here, we use the generic <code class="literal">tagHtml()</code> tag helper to generate the link for us, which becomes <code class="literal">tag_html()</code> in Volt. The first parameter is the name of the tag. The second parameter is an array of the tag's attributes. Note that the <code class="literal">href</code> parameter<a id="id285" class="indexterm"/> uses the <code class="literal">baseUri</code> configuration setting and <code class="literal">~</code>, which is a character used in Volt to concatenate strings together. The third parameter is a Boolean we set to true because we want this to be a self-closing tag. We set the fourth parameter to true because we only want to generate the start tag. Finally, we set the fifth parameter to true because we want an end-of-line character generated after the tag.</p><p>Now, we can start telling the rest of the Internet about our new blog.</p></div></div>
<div class="section" title="Sending update pings"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec46"/>Sending update pings</h1></div></div></div><p>In order to ping sites such as <a class="ulink" href="http://weblogs.com">http://weblogs.com</a> and notify them that we have a new post, we are going to <a id="id286" class="indexterm"/>do a little more refactoring. It seems we used the title of our blog in the HTML title tag. We have to use it again in the function that we'll write to ping. So, instead of hardcoding the title in two places that have to be edited, if we change the title, it would be better to create a configuration setting. So, add the following code snippet to the <code class="literal">config.ini</code> file located at <code class="literal">app/config</code>:</p><div class="informalexample"><pre class="programlisting">[blog]
title = Phalcon Blog
url = <code class="literal">http://localhost</code>
</pre></div><p>As we are now going to use this setting in a controller, we need to have access to it there. To do this, we can add it to the Dependency Injection container. This can be done by adding these lines of code to the bottom of the <code class="literal">services.php</code> file located at <code class="literal">app/config</code>:</p><div class="informalexample"><pre class="programlisting">$di-&gt;set('config', $config);</pre></div><p>Now, we can open<a id="id287" class="indexterm"/> the <code class="literal">ControllerBase.php</code> file located at <code class="literal">app/controllers</code> and set our title tag with our configuration setting.</p><div class="informalexample"><pre class="programlisting">$this-&gt;tag-&gt;setTitle($this-&gt;config-&gt;blog-&gt;title);</pre></div><p>We can create a new function in our <code class="literal">PostsController.php</code> file to ping the feed aggregator sites for us.</p><div class="informalexample"><pre class="programlisting">private function sendPings(){
        $request = '&lt;?xml version="1.0" encoding="iso-8859-1"?&gt;
                    &lt;methodCall&gt;
                    &lt;methodName&gt;weblogUpdates.ping&lt;/methodName&gt;
                    &lt;params&gt;
                     &lt;param&gt;
                      &lt;value&gt;
                       &lt;string&gt;'.$this-&gt;config-&gt;blog-&gt;title.'&lt;/string&gt;
                      &lt;/value&gt;
                     &lt;/param&gt;
                     &lt;param&gt;
                      &lt;value&gt;
                       &lt;string&gt;'.$this-&gt;config-&gt;blog-&gt;url.$this-&gt;url-&gt;get('posts/feed').'&lt;/string&gt;
                      &lt;/value&gt;
                     &lt;/param&gt;
                    &lt;/params&gt;
                    &lt;/methodCall&gt;';

        $ping_urls = array(
            'http://blogsearch.google.com/ping/RPC2',
            'http://rpc.weblogs.com/RPC2',
            'http://ping.blo.gs/'
        );
        foreach($ping_urls as $ping_url){
            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, $ping_url);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true );
            curl_setopt($ch, CURLOPT_POST, true );
            curl_setopt($ch, CURLOPT_POSTFIELDS, trim($request));
            $results = curl_exec($ch);
        }
        curl_close($ch);
    }</pre></div><p>The <code class="literal">$request</code> variable<a id="id288" class="indexterm"/> is the XML we are going to post to the services. Now that we've added the configuration settings to our Dependency Injection container, we can access the blog's title setting with <code class="literal">$this-&gt;config-&gt;blog-&gt;title</code> and the URL setting with <code class="literal">$this-&gt;config-&gt;blog-&gt;url</code>. The <code class="literal">$ping_urls</code> array contains the URLs of services we are going to ping. You <a id="id289" class="indexterm"/>can add more services to this array if you like. Then, we use PHP <code class="literal">curl</code> to ping.</p><p>Now, in the <code class="literal">createAction</code> function<a id="id290" class="indexterm"/>, find the following line of code:</p><div class="informalexample"><pre class="programlisting">$this-&gt;flash-&gt;success("post was created successfully");</pre></div><p>Add the following line of code before the preceding code:</p><div class="informalexample"><pre class="programlisting">$this-&gt;sendPings();</pre></div><p>Another feature we could add to this function is a way of logging the results of our pings, so we then have a way of debugging what is actually happening as our function doesn't return a status.</p><p>Now, it's time to add another variable to the application section of the configuration file.</p><div class="informalexample"><pre class="programlisting">logsDir = ../app/logs/</pre></div><p>Now, we need to add a service to log the results of our pings in the Dependency Injection container. Open up the <code class="literal">services.php</code> file located at <code class="literal">app/config</code> and add the following lines of code:</p><div class="informalexample"><pre class="programlisting">//Logging
$di-&gt;set(
    'pingLogger', function () use ($config){
        $logger = new \Phalcon\Logger\Adapter\File($config-&gt;application-&gt;logsDir.'ping.log');
        return $logger;
    }
);</pre></div><p>This will enable us to access our <code class="literal">pingLogger</code> service in the <code class="literal">sendPings</code> function<a id="id291" class="indexterm"/> we just created. So, after we set the <code class="literal">$result</code> variable, we can then log the URL we pinged along with the response we received. We check if the result is false, indicating that <code class="literal">curl</code> failed, and then change the <code class="literal">$result</code> variable to reflect that error.</p><div class="informalexample"><pre class="programlisting">$result = curl_exec($ch);
if($result === false){
       $result = "Curl Error";
}
$this-&gt;pingLogger-&gt;log($ping_url.PHP_EOL.$result);</pre></div></div>
<div class="section" title="Using view partials"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec47"/>Using view partials</h1></div></div></div><p>We have explored layouts and cascading views. We also have the option to use partials in Phalcon. Using partial templates<a id="id292" class="indexterm"/> allows us to reuse the same functionality in various parts of our application. A couple of places in which we may want to use partials are the navigation bar and the sidebar. Right now, our main layout does a lot of stuff. There is not much on the navigation bar or the sidebar. But as we add more functionalities, they might become more complex, and keeping them in separate files will help us to organize and simplify our code.</p><p>You can create a folder to hold your partial views wherever you choose. You can even put them in your <code class="literal">views</code> folder located at <code class="literal">app</code> if you choose. But, to keep our templates more organized, let's create a folder called <code class="literal">partials</code> inside of the <code class="literal">views</code> folder located at<code class="literal"> app</code>. Now, open the <code class="literal">index.volt</code> file located at <code class="literal">app/views</code>. We are going to cut the sidebar out of this file and paste it in a new file called <code class="literal">sidebar.volt</code>, which we are going to save in our new <code class="literal">partials</code> folder. The content of that file should look like the following code snippet:</p><div class="informalexample"><pre class="programlisting">&lt;div class="span3"&gt;
    &lt;div class="well"&gt;
        {{ form("posts/search", "method":"post", "autocomplete" : "off", "class" : "form-inline") }}
            &lt;div class="input-append"&gt;
                {{ text_field("body", "class" : "input-medium") }}
                {{ submit_button("Search", "class" : "btn") }}
            &lt;/div&gt;
        {{ end_form() }}
    &lt;/div&gt;
&lt;/div&gt;</pre></div><p>We will replace this in the <code class="literal">index.volt</code> file with the following line of code:</p><div class="informalexample"><pre class="programlisting">{{ partial("partials/sidebar") }}</pre></div><p>This is the code we would use with Volt. If we were using PHP templates, we would use <code class="literal">&lt;?php $this-&gt;partial("partials/sidebar"); ?&gt;</code>. Note that we don't add the file extension to the <code class="literal">path</code> parameter. Make sure to do this with your <code class="literal">partials</code> folder. Adding the extension will cause an error.</p><p>Now, you can cut the <code class="literal">div</code> tag with the <code class="literal">navbar</code> class in the <code class="literal">index.phtml</code> file located at <code class="literal">app/views</code>, paste it into a file called <code class="literal">navbar.volt</code>, save it in your <code class="literal">partials</code> folder, and replace the <code class="literal">div</code> tag with the following line of code:</p><div class="informalexample"><pre class="programlisting">{{ partial("partials/navbar") }}</pre></div><p>Now, the different types of functionalities are separated in your application. You may find other places in your <a id="id293" class="indexterm"/>application where you may want to use partials, such as in the header or the footer. To learn more about Phalcon, visit <a class="ulink" href="http://docs.phalconphp.com/en/latest/index.html">http://docs.phalconphp.com/en/latest/index.html</a>.</p></div>
<div class="section" title="Caching in Phalcon"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec48"/>Caching in Phalcon</h1></div></div></div><p>Caching can speed up and save resources on a site that gets a lot of traffic or does a lot of intense repeatable database queries, but this should only be implemented where actually needed. In other words, our <a id="id294" class="indexterm"/>blog, in its current iteration, probably doesn't need a cache, but we are going to take a look at caching in Phalcon and add caching to a part of our blog just to get a handle on how it works.</p></div>
<div class="section" title="Setting up a cache service"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec49"/>Setting up a cache service</h1></div></div></div><p>In Phalcon, the cache consists<a id="id295" class="indexterm"/> of two parts, a frontend cache that handles cache expiration and transformation, and the backend cache that handles the reads and writes when requested to by the frontend. Here is an example of a cache service. We could simply add this to our <code class="literal">service.php</code> file located at <code class="literal">app/config</code>.</p><div class="informalexample"><pre class="programlisting">$di-&gt;set(
    'viewCache', function () use ($config) {

        //Cache for one day
        $frontCache = new \Phalcon\Cache\Frontend\Data(array(
            "lifetime" =&gt; 86400
        ));

        //Set file cache
        $cache = new Phalcon\Cache\Backend\File($frontCache, array(
            "cacheDir" =&gt; $config-&gt;application-&gt;cacheDir
        ));

        return $cache;
    }
);</pre></div><p>We are pretty used to setting up new Phalcon services by now. In this new service, we use the configuration variable so that it can use our cache directory setting. We give the frontend cache a lifetime of one day and feed this variable to our backend cache along with the location of our cache directory.</p><p>We used a file-based cache in this service. It is not the fastest of caching mechanisms and is probably the slowest, <a id="id296" class="indexterm"/>but it is easy to set up and requires no other software. However, you are not limited to file-based backends with Phalcon. As long as you have the required software and PHP extensions installed, you can use any one of the following as a backend cache in Phalcon:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">File<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Memcached</li><li class="listitem" style="list-style-type: disc">APC</li><li class="listitem" style="list-style-type: disc">MongoDB</li><li class="listitem" style="list-style-type: disc">Xcache</li></ul></div></li></ul></div><p>Phalcon has a variety of frontend cache adapters too. In the code for our cache service, we specified a data adapter that serializes our data before saving it, but you can also use one of the following frontend adapters<a id="id297" class="indexterm"/>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Output</li><li class="listitem" style="list-style-type: disc">JSON</li><li class="listitem" style="list-style-type: disc">IgBinary</li><li class="listitem" style="list-style-type: disc">Base64</li><li class="listitem" style="list-style-type: disc">None</li></ul></div><div class="section" title="Using a Phalcon cache"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec39"/>Using a Phalcon cache</h2></div></div></div><p>Now that we have our cache service set up, we can use it wherever we need it. First, you need a cache key. All Phalcon caches<a id="id298" class="indexterm"/> use a key to store and access cached data. It needs to be unique to that piece of data. A good place for a function to <a id="id299" class="indexterm"/>generate keys for the cache in our application would be in the <code class="literal">ControllerBase.php</code> file located at <code class="literal">app/controllers</code>. We can add the following function to the <code class="literal">ControllerBase</code> class<a id="id300" class="indexterm"/> so that all of our controllers inherit it:</p><div class="informalexample"><pre class="programlisting">public function createKey($controller, $action, $parameters = array())
{
        return urlencode($controller.$action.serialize($parameters));
}</pre></div><p>This function will simply create a unique key for us. So, now we test the function using our cache by opening <a id="id301" class="indexterm"/>up the <code class="literal">PostController.php</code> file located at <code class="literal">app/controllers</code> and modifying the <code class="literal">showAction</code> function<a id="id302" class="indexterm"/>. We can access the cache service we created by adding the following line of code at the beginning of the function:</p><div class="informalexample"><pre class="programlisting">$cache = $this-&gt;di-&gt;get("viewCache");</pre></div><p>Then, by executing the following line of code, you can access the cached content or start the cache:</p><div class="informalexample"><pre class="programlisting">$key = $this-&gt;createKey('posts', 'show', array($id));
$post = $cache-&gt;get($key);</pre></div><p>Then, we check if we have content, and if we don't, we get it from the database and save it in the cache using our key.</p><div class="informalexample"><pre class="programlisting">if ($post === null) {
            $post = Posts::findFirstByid($id);
            $cache-&gt;save($key, $post);
}</pre></div><p>The rest of the function remains the same.</p><div class="informalexample"><pre class="programlisting">$this-&gt;tag-&gt;prependTitle($post-&gt;title . " - ");
$this-&gt;view-&gt;post = $post;</pre></div><p>Open up one of your blog's posts in the browser and refresh the page. You will find the cache file in the <code class="literal">cache</code> folder located at <code class="literal">app</code>. Inside the file, serialized data will be present, representing the <code class="literal">$post</code> object. To learn more about using caching in Phalcon, visit <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/cache.html">http://docs.phalconphp.com/en/latest/reference/cache.html</a>.</p><p>You can also cache data at the model level. The mechanism is the same. Try to access the cached data by a key. Check if there is data. If not, execute the database call to retrieve the data and cache it. Then, return the result. To learn about caching in the ORM, visit <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/models-cache.html">http://docs.phalconphp.com/en/latest/reference/models-cache.html</a>.</p></div></div>
<div class="section" title="Routing in Phalcon"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec50"/>Routing in Phalcon</h1></div></div></div><p>Before we take a look at other application structures in Phalcon, especially the micro application, we should take a <a id="id303" class="indexterm"/>look at routing. Up to now, we just have the routes in our application; just magically map to our controllers and the actions in them and let Phalcon do all of the thinking about routing for us. This is because with the single MVC structure that <a id="id304" class="indexterm"/>we are using, the routing is in MVC mode. We also have the option of match-only mode. You will notice that our blog application has an index page that does nothing. It still has the default Phalcon message. The bulk of our site currently resides at <code class="literal">http://localhost/phalconBlog/posts</code>. Well, a hacky way to fix this that we are going to use to learn about routing in Phalcon is to use a router. So, we need<a id="id305" class="indexterm"/> to add another service to our Dependency Injection container. Open up the <code class="literal">services.php</code> file located at <code class="literal">app/config</code> and add the following lines of code at the bottom:</p><div class="informalexample"><pre class="programlisting">$di-&gt;set(
    'router', function () {
        $router = new Router();
        $router-&gt;add(
            "/", array(
                'controller' =&gt; 'posts',
                'action' =&gt; 'index',
            )
        );
        return $router;
    }
);</pre></div><p>When we add a route to the MVC router, the first parameter is the path and the second is any array that maps this<a id="id306" class="indexterm"/> path to a module, controller, and an action.</p><p>Match-only mode routing is used in the micro application example coming up. To learn more about routing in Phalcon, visit <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/routing.html">http://docs.phalconphp.com/en/latest/reference/routing.html</a>.</p></div>
<div class="section" title="Other project types of Phalcon"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec51"/>Other project types of Phalcon</h1></div></div></div><p>We created one type of application in Phalcon, a single MVC application. But, the type of application structure does not fit<a id="id307" class="indexterm"/> all types of projects. We will now take a look at a few other types of applications you can build with Phalcon. Of course, Phalcon being a very loosely-coupled framework, you are not limited by just these structures, and you can structure your projects however you choose.</p><div class="section" title="Multimodule applications"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec40"/>Multimodule applications</h2></div></div></div><p>As an application grows in size, it may be easy to organize the code into modules. Instead of an <code class="literal">app</code> folder in a project, <a id="id308" class="indexterm"/>you have multiple folders under an <code class="literal">apps</code> folder, each having their own sets of models, views, and controllers. Routing in <a id="id309" class="indexterm"/>MVC mode is already set up to handle modules. There are only a few extra steps involved. To learn more about Phalcon multimodule applications, visit <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/applications.html#multi-module">http://docs.phalconphp.com/en/latest/reference/applications.html#multi-module</a>.</p></div><div class="section" title="Micro applications"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec41"/>Micro applications</h2></div></div></div><p>For even simpler <a id="id310" class="indexterm"/>applications than the one we wrote, using a micro framework structure may make more sense. A <a id="id311" class="indexterm"/>micro application in Phalcon can be as simple as the following code snippet:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$app = new Phalcon\Mvc\Micro();

$app-&gt;get(
    '/user/{name}', function ($name) {
        echo "&lt;h1&gt;Hi $name!&lt;/h1&gt;";
    }
);

$app-&gt;get(
    '/api/user/{name}', function ($name) {
        echo json_encode(array("message" =&gt; "Hi ". $name));
    }
);

$app-&gt;handle();</pre></div><p>There is not much to this application. First, we create an instance of <code class="literal">Phalcon\MVC\Micro</code> and then we defined our routes. So, when a visitor visits the <code class="literal">/user/Stephan</code> page of the application, they are greeted with <span class="strong"><strong>Hi Stephan</strong></span>. The second route shows one of the perfect uses of a micro application for an API. Most simple APIs don't need complex controllers. This example is here to show you how small a working Phalcon application can be. It uses routing in the match-only mode. As a micro application grows in size, you can use more of the features it supports, including models, redirects, and services. To learn more about Phalcon micro applications, visit <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/micro.html">http://docs.phalconphp.com/en/latest/reference/micro.html</a>.</p></div><div class="section" title="Command-line applications"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec42"/>Command-line applications</h2></div></div></div><p>Sometimes, you may not need a complete web application to get the job done. For scripts that you run from a <a id="id312" class="indexterm"/>command line or cron, you just need a <a id="id313" class="indexterm"/>simple structure to organize the functionality of your code. A Phalcon command-line application's structure can start as small as the following code snippet:</p><div class="informalexample"><pre class="programlisting">app/
  tasks/
  cli.php</pre></div><p>The bootstrap file is <code class="literal">cli.php</code>, and it starts out in pretty much the same manner that all command-line <a id="id314" class="indexterm"/>applications start in Phalcon.</p><div class="informalexample"><pre class="programlisting">&lt;?php

use Phalcon\DI\FactoryDefault\CLI as CliDI,
    Phalcon\CLI\Console as ConsoleApp;

//Using the CLI factory default services container
$di = new CliDI();

// Define the application path
defined('APPLICATION_PATH')
  || define('APPLICATION_PATH', realpath(dirname(__FILE__)));

//Register the autoloader
$loader = new \Phalcon\Loader();
$loader-&gt;registerDirs(
    array(
        APPLICATION_PATH . '/tasks'
    )
);
$loader-&gt;register();

// Load the config
$config = include APPLICATION_PATH . '/config/config.ini';
$di-&gt;set('config', $config);

//Create a console application
$console = new ConsoleApp();
$console-&gt;setDI($di);


//Process console arguments
$arguments = array();
$params = array();

foreach($argv as $k =&gt; $arg) {
    if($k == 1) {
        $arguments['task'] = $arg;
    } elseif($k == 2) {
        $arguments['action'] = $arg;
    } elseif($k &gt;= 3) {
        $params[] = $arg;
    }
}
if(count($params) &gt; 0) {
    $arguments['params'] = $params;
}

// define global constants for the current task and action
define('CURRENT_TASK', (isset($argv[1]) ? $argv[1] : null));
define('CURRENT_ACTION', (isset($argv[2]) ? $argv[2] : null));

try {
    // handle incoming arguments
    $console-&gt;handle($arguments);
}
catch (\Phalcon\Exception $e) {
    echo $e-&gt;getMessage();
    exit(255);
}</pre></div><p>All that bootstrap file has to do is process <a id="id315" class="indexterm"/>commands and choose the right task and action. We are storing our tasks in the <code class="literal">tasks</code> folder. A <a id="id316" class="indexterm"/>command-line application must have at least a <code class="literal">mainTask</code> and <code class="literal">mainAction</code>. So, we can add this file to the <code class="literal">tasks</code> folder and name it <code class="literal">MainTask.php</code>.</p><div class="informalexample"><pre class="programlisting">&lt;?php

class mainTask extends \Phalcon\CLI\Task
{

    public function mainAction() {
        echo "I am a task that doesn't do much";
    }

    public function anotherAction(array $params) {
        foreach($params as $p){
            echo "Hi, my name is ".$p.PHP_EOL;
        }
    }
}</pre></div><p>The <code class="literal">mainAction</code> function<a id="id317" class="indexterm"/> of the main task will be run while executing the following command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php app/cli.php</strong></span>
</pre></div><p>To call a specific task and action, just assign the task as the first parameter, the action as the second, and any of the <a id="id318" class="indexterm"/>parameters (<code class="literal">tom</code>, <code class="literal">dick</code>, and <code class="literal">harry</code>) can be handled by the action function called <a id="id319" class="indexterm"/>
<code class="literal">Executing</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php app/cli.php main another tom dick harry</strong></span>
</pre></div><p>The output is as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Hi, my name is tom</strong></span>
<span class="strong"><strong>Hi, my name is dick</strong></span>
<span class="strong"><strong>Hi, my name is harry</strong></span>
</pre></div><p>To learn more about creating<a id="id320" class="indexterm"/> command-line applications with Phalcon, visit <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/cli.html">http://docs.phalconphp.com/en/latest/reference/cli.html</a>.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec52"/>Summary</h1></div></div></div><p>In this chapter, we learned more about what we can do with the Phalcon framework while adding features to our blog application. It is not the most feature-packed blog, but we showed how to use Phalcon tag helpers to set our document type and generate dynamic titles for our pages. We also explained how to control user access, hash passwords, and set cookies in Phalcon. Then, we broke up our views into reusable bit-sized pieces using view partials. Just in case our blog ever gets any traffic, we dabbled a bit with caching in Phalcon. We also learned how to use routing in Phalcon. Finally, we learned other structures we can use for a Phalcon application. To learn more about Phalcon, visit <a class="ulink" href="http://phalconphp.com">http://phalconphp.com</a>.</p></div></body></html>