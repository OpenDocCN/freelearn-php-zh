<html><head></head><body>
		<div>
			<div class="Content" id="_idContainer172">
			</div>
		</div>
		<div class="Content" id="_idContainer173">
			<h1 id="_idParaDest-251"><a id="_idTextAnchor258"/>7. Data Persistence</h1>
		</div>
		<div class="Content" id="_idContainer216">
			<p class="callout-heading">Overview</p>
			<p class="callout">By the end of this chapter, you will be able to perform filesystem-related operations (read, write, copy, move, and remove); read big files line by line and read CSV files one record at a time; download files via the browser using PHP; connect to MySQL RDBMS using PHP; create a database and a table, and insert records into a MySQL database using PHP; query, update, and delete data from MySQL DB using PHP; and secure MySQL queries using prepared statements in PHP.</p>
			<h1 id="_idParaDest-252"><a id="_idTextAnchor259"/>Introduction</h1>
			<p>In the previous chapter, we saw how to deal with user input using PHP superglobals and applied sanitization and validation in order to secure the application. We also learned how to keep the user's session on the server and built a small application. In that application, we used the session to store data, which vanished with every session destroyed (or logout).</p>
			<p>In this chapter, we will learn how we can store and read persistent data using PHP. Specifically, we will learn how to handle file I/O (open, read, and write) and disk operations (change the current directory, create a new file/directory, remove a file or directory, and so on). This is useful when you would like to use the filesystem for precious application logs, to generate all kinds of reports, to handle uploaded user images, and so on. We will also learn how to connect to a MySQL database and how to query the data, insert new records, and update or delete data from the database. This is helpful when you want to store data in a structured way, which can then be easily accessed by many other applications; for instance, user-specific data, such as a first name, a last name, an email address, and password hashes. And not only this – most probably, your application will perform data manipulation, on the data which will be stored somewhere to have it ready to read on request. This kind of data might represent elements of the business domain and could include product lists, prices, discount coupons, orders, subscriptions, and suchlike. We will deal with security in this chapter as well. Hence, we'll learn how we can protect our database against potentially malicious user input.</p>
			<h1 id="_idParaDest-253"><a id="_idTextAnchor260"/>File I/O Handling</h1>
			<p>Filesystem operations are some of the most important in programming. We can enumerate session data storage in PHP; user-uploaded files, generated report files, cached data, logs – all of them utilize the filesystem. Of course, there are many other alternatives for persistent storage, but knowing how to operate the filesystem in a language is especially important due to its availability. It is basically present anywhere and can be used immediately.</p>
			<p>Working with the filesystem, sometimes, you might want to read or write into a file that is stored in a known location relative to the script file location. For example, for a script that is created in the <strong class="source-inline">/app/demo/</strong> directory that wants to read files from <strong class="source-inline">source/</strong> relative to its location (in other words, <strong class="source-inline">/app/demo/source/</strong>), it would be better to know the script location.</p>
			<p>This is different to the current working directory, because you may run the script from other locations as well. For example, if the current working directory is <strong class="source-inline">/root</strong>, you can run the script providing one of the following is present: the relative path, <strong class="source-inline">php ../app/demo/the-script.php</strong>, or the absolute path, <strong class="source-inline">php /app/demo/the-script.php</strong>. In this case, the current working directory is <strong class="source-inline">/root</strong>, while the script directory is <strong class="source-inline">/app/demo</strong>.</p>
			<p>This leads to the next point. PHP offers some "magic constants"; values of which change across the scripts depending on where are they used. The list of magic constants is as follows: </p>
			<div>
				<div class="IMG---Figure" id="_idContainer174">
					<img alt="Figure 7.1: Magic constants and their descriptions&#13;&#10;" src="image/C14196_07_01.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.1: Magic constants and their descriptions</p>
			<p>In our case, we would want to make use of the <strong class="source-inline">__DIR__</strong> constant in the script. The directory the script would have to look into would be <strong class="source-inline">$lookupDir = __DIR__ . '/source';</strong>.</p>
			<h2 id="_idParaDest-254"><a id="_idTextAnchor261"/>Reading Files with PHP</h2>
			<p>Dealing with files in PHP is one of the easiest things to do. PHP has several functions to handle file operations for creating, reading, and updating/editing. No additional installation is needed to use PHP filesystem functions.</p>
			<h2 id="_idParaDest-255"><a id="_idTextAnchor262"/>A Simple File Read</h2>
			<p>One of the simplest functions to use for reading a file is <strong class="source-inline">file_get_contents()</strong>. This function can be used to fetch all the content of a file and put it into a variable, for example. The syntax is as follows:</p>
			<p class="source-code">file_get_contents (string $filename [, bool $use_include_path = FALSE [, resource $context [, int $offset = 0 [, int $maxlen ]]]])</p>
			<ul>
				<li><strong class="source-inline">$filename</strong>: The first argument is required and should be a valid file path to read from.</li>
				<li><strong class="source-inline">use_include_path</strong>: This is optional and tells <strong class="source-inline">file_get_contents</strong> to look for <strong class="source-inline">$Filename</strong> in the <strong class="source-inline">include_path</strong> list of directories. </li>
				<li><strong class="source-inline">$context</strong>: This is optional and is a valid context resource created with <strong class="source-inline">stream_context_create()</strong>.</li>
				<li><strong class="source-inline">$offset</strong>:  This is optional. The offset count begins on the original stream.</li>
				<li><strong class="source-inline">$maxlen</strong>: This is an optional argument and denotes the maximum length of the data that is to be read. By default, it reads until the end of the file.</li>
			</ul>
			<p>The <strong class="source-inline">file_get_contents()</strong> function reads the file content into memory before giving any output, until the entire file has been read. This is a drawback that makes this function unsuitable for use when the input file size is not known. In the case of large files, let's say in excess of 1 GB, the PHP process would very quickly fill the allocated RAM memory, and this would make the script crash. Therefore, this function is only suitable for use when the expected file size is smaller than the <strong class="source-inline">memory_limit</strong> configuration entry in PHP.</p>
			<h2 id="_idParaDest-256"><a id="_idTextAnchor263"/>Exercise 7.1: A Simple File Read (All at Once)</h2>
			<p>Let's say you are required to develop a script that will be able to import a short list of users from a CSV format file into a current application.</p>
			<p>First, let's prepare the environment:</p>
			<ol>
				<li>Create a <strong class="source-inline">sample</strong> directory in the current working directory.</li>
				<li>Download the CSV file called <strong class="source-inline">users_list.csv</strong> from the code repository and put it into the <strong class="source-inline">sample</strong> directory. </li>
				<li>In this exercise, we will invoke <strong class="source-inline">file_get_contents()</strong> by providing the path to the CSV file:<p class="source-code">&lt;?php echo file_get_contents(__DIR__ . '/sample/users_list.csv');</p><p>We are invoking the <strong class="source-inline">file_get_contents()</strong> function, specifying the file path, and what we are receiving is the full file content. For the file path, we are using the <strong class="source-inline">__DIR__</strong> magic constant, which gets replaced with the file directory path at compile time.</p><p>Save the preceding PHP script in a file called <strong class="source-inline">file_get_contents.php</strong> in the parent directory of the <strong class="source-inline">sample</strong> directory.</p></li>
				<li>Run <strong class="source-inline">php file_get_contents.php</strong> in your Terminal:</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer175">
					<img alt="Figure 7.2: Printing contents of the file&#13;&#10;" src="image/C14196_07_02.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.2: Printing contents of the file</p>
			<p>You will get the CSV file output, as above.</p>
			<h2 id="_idParaDest-257"><a id="_idTextAnchor264"/>Reading Files with the fread Function</h2>
			<p>As discussed previously, the <strong class="source-inline">file_get_contents()</strong> function is not suitable for use on large files, since the entire file content is first read into memory, before any output, which would make the script very inefficient in terms of resource usage, as well as in terms of performance.</p>
			<p>In the following exercise, we will explore some functions that will allow us to parse large files, keeping the system memory safe. This means we will use a technique that will allow us to read chunks of the file content at a time, which can be achieved using a group of PHP built-in functions, and a data stream PHP <em class="italic">resource</em>. A resource in PHP is a reference to the external resource; in our case, it will be a reference to a data stream resource (for example, a system file, or a URL).</p>
			<p><strong class="source-inline">fopen()</strong> is one of PHP's built-in functions, used to create stream resources in PHP. To achieve greater flexibility with regard to working with files (or any other data stream), we will use the <strong class="source-inline">fopen()</strong> function. The <strong class="source-inline">fopen()</strong> function accepts two required arguments, <strong class="source-inline">$filename</strong> being the first argument, and the access mode being the second one. The access mode describes the stream resource access type (read, write, read and write) and resolves to a set of instructions while creating the stream. It can have one of the following values:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer176">
					<img alt="" src="image/C14196_07_03.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.3: Different access modes and their descriptions</p>
			<p>You will notice the "file pointer" concept in the preceding table. You can think about this simple yet powerful concept in the same way as the cursor in a text file. So, for example, if we deal with the stream resource of a file with the <strong class="source-inline">Learning PHP fundamentals</strong> content, having the file pointer on position nine means it is located right before the word PHP. Reading the stream from that position until the end would result in the <strong class="source-inline">PHP fundamentals</strong> output.</p>
			<p>The <strong class="source-inline">fopen()</strong> function returns a file pointer resource or <strong class="source-inline">false</strong> if the operation fails.</p>
			<p>To read from the data stream, we will use the <strong class="source-inline">fread()</strong> function. This function requires two parameters, a resource variable being the first, and the length of bytes to read. It returns the read string or Boolean as <strong class="source-inline">false</strong> in the event of failure.</p>
			<p>Other functions that can be used to read from stream resources are <strong class="source-inline">fgets()</strong> and <strong class="source-inline">fgetcsv()</strong>, to name a couple. <strong class="source-inline">fgets()</strong> returns a line from the file pointer; it requires the stream resource as the first parameter and accepts the optional read length (bytes) as the second parameter. <strong class="source-inline">fgetcsv()</strong> is similar to <strong class="source-inline">fgets()</strong> – it returns a line of data as an array containing the read CSV fields, except this line is parsed data as CSV (meaning more than one line of string data might be read, since one CSV field can contain multiline data). The <strong class="source-inline">fgetcsv()</strong> function accepts several parameters, but the required stream resource (the first parameter) is often enough to do a good job of parsing and returning CSV line data.</p>
			<p>While reading from a stream, we might want to know when the end-of-file is hit. We can use the <strong class="source-inline">feof()</strong> function for this, which will test for the file pointer's presence at the end of the file (EOF). This function returns <strong class="source-inline">true</strong> if the file pointer is at EOF or errors occurred. It returns <strong class="source-inline">false</strong> otherwise.</p>
			<p class="callout-heading">Note </p>
			<p class="callout"><strong class="source-inline">feof()</strong> returns <strong class="source-inline">false</strong> for invalid streams as well, so it is recommended to test your stream resource before invoking <strong class="source-inline">feof()</strong>.</p>
			<h2 id="_idParaDest-258"><a id="_idTextAnchor265"/>Exercise 7.2: Reading Files with the fread Function</h2>
			<p>Let's suppose you are asked to optimize your user's import script in order to work with large data files of the magnitude of tens of gigabytes:</p>
			<ol>
				<li value="1">Create an <strong class="source-inline">fread.php</strong> file and insert the following content.</li>
				<li>First, we define the file path, and then use it when calling <strong class="source-inline">fopen()</strong> to get the file pointer resource. We check whether <strong class="source-inline">fopen()</strong> has returned the expected resource (not <strong class="source-inline">false</strong>). In the case of failure, the script will exit:<p class="source-code">&lt;?php</p><p class="source-code">$filePath = __DIR__ . '/sample/users_list.csv';</p><p class="source-code">$fileResource = fopen($filePath, 'r');</p><p class="source-code">if ($fileResource === false) {</p><p class="source-code">    exit(sprintf('Cannot read [%s] file.', $filePath));</p><p class="source-code">}</p></li>
				<li>Now, we will make use of the <strong class="source-inline">fread()</strong> function, which will read the file in chunks, allowing us to operate on small chunks of data in turn until the file is read completely. Next, we define the length to read, in bytes. <p class="callout-heading">Note </p><p class="callout">To fine-tune this value, you should test it with a specific size range of files, depending on the usage. </p><p>We also define the <strong class="source-inline">iterations</strong> variable, to learn about the number of cycles when the file was read using the specified read length. Note that defining the <strong class="source-inline">$iterations</strong> variable is not necessary for production-grade code. We are including it here purely for educational purposes:</p><p class="source-code">$readLength = 64;</p><p class="source-code">$iterations = 0;</p></li>
				<li>Read from the <strong class="source-inline">$fileResource</strong> resource using <strong class="source-inline">fread()</strong> and test for EOF with <strong class="source-inline">feof()</strong> in the <strong class="source-inline">while</strong> loop:<p class="source-code">while (!feof($fileResource)) {</p><p class="source-code">    $iterations++;</p><p class="source-code">    $chunk = fread($fileResource, $readLength);</p><p class="source-code">    echo $chunk;</p><p class="source-code">}</p></li>
				<li>Finally, we close the file pointer resource, as we no longer need it, and print the number of iterations:<p class="source-code">fclose($fileResource);</p><p class="source-code">echo sprintf("\n%d iteration(s)", $iterations);</p></li>
				<li>Run the file in your Terminal using the <strong class="source-inline">php fread.php</strong> command. The output will be as follows:</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer177">
					<img alt="Figure 7.4: File output using fread file()&#13;&#10;" src="image/C14196_07_04.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.4: File output using fread file()</p>
			<p>Since the file contains 65 characters and the chunk size was set to 64, the file was read twice. This means that, at the first iteration, <strong class="source-inline">fread()</strong> filled the memory with 64 bytes of data that was then returned and the occupied memory was freed; at the second iteration, <strong class="source-inline">fread()</strong> filled the memory with 1 byte (the remaining file content) before it returned this and freed the memory. The advantages of this approach are that we can operate with small pieces of content at a time, at each read iteration, using a small amount of memory resources, rather than loading the whole file in memory and then iterating and processing content line by line.</p>
			<h2 id="_idParaDest-259"><a id="_idTextAnchor266"/>Benchmark File Reading</h2>
			<p>In previous examples, we saw the difference between the two approaches to reading a file, but here, you will evaluate metrics to benchmark each of the file reading methods.</p>
			<p>We will use the same scripts but will add a number of measurements.</p>
			<p>We will make use of the <strong class="source-inline">memory_get_peak_usage()</strong> function to retrieve the peak memory usage at some point, as the name suggests. This function accepts one optional argument, set to <strong class="source-inline">false</strong> by default when its value is not specified; you should set it to <strong class="source-inline">true</strong> when you want the allocated memory to be reported (which we will do in the following exercises), rather than the actual memory usage.</p>
			<p>In the following exercises, we will make use of the <strong class="source-inline">DIRECTORY_SEPARATOR</strong> constant, which exists in PHP implicitly, and which is set with the directory separator as follows:</p>
			<ul>
				<li>Windows: the "\" character</li>
				<li>Non-Windows: the "/" character</li>
			</ul>
			<h2 id="_idParaDest-260"><a id="_idTextAnchor267"/>Exercise 7.3: Benchmark File Reading</h2>
			<p>In this exercise, we will evaluate metrics to benchmark each of the file reading methods:</p>
			<ol>
				<li value="1">First, we will need a pretty big file, and we will generate it with the <strong class="source-inline">dd</strong> command.<p class="callout-heading">Note </p><p class="callout"><strong class="source-inline">dd</strong> is a command-line utility for Unix and Unix-like operating systems that exists in any of these distributions.</p></li>
				<li>Run the following command to generate a file in <strong class="source-inline">sample/test-256-mb.txt</strong> that is full of zeroes, 256 MB in size:<p class="source-code">dd if=/dev/zero of=sample/test-256-mb.txt count=1024 bs=262144</p><p>This file will most likely terminate the script that uses <strong class="source-inline">file_get_contents()</strong> to read it, since most PHP installations, by default, do not allow a memory limit of more than 128 MB per process. This limit is stored in the <strong class="source-inline">php.ini</strong> configuration file by default, under the <strong class="source-inline">memory_limit</strong> parameter, as previously indicated. Hence, we will create another file, 10 MB in size, using <strong class="source-inline">dd if=/dev/zero of=sample/test-10-mb.txt count=1024 bs=10240</strong>.</p></li>
				<li>Create <strong class="source-inline">file_get_contents-memory.php</strong> with the following content:<p class="source-code">&lt;?php file_get_contents(__DIR__ . DIRECTORY_SEPARATOR . $argv[1]);</p><p class="source-code">echo sprintf("--\nmemory %.2fMB\n--\n", memory_get_peak_usage(true)   / 1024 / 1024);</p><p>Here, we are making use of the first command-line argument (<strong class="source-inline">$argv[1]</strong>), which will be the file path to read, relative to the script path. We are adding the memory peak metric as well, using the <strong class="source-inline">memory_get_peak_usage()</strong> function.</p></li>
				<li>Run the following command to check the resource usage:<p class="source-code"> time php file_get_contents-memory.php sample/test-10-mb.txt </p><p> You should essentially get the following output:</p><p class="source-code">--</p><p class="source-code">memory 12.01MB</p><p class="source-code">--</p><p class="source-code">real    0m 0.03s</p><p class="source-code">user    0m 0.02s</p><p class="source-code">sys     0m 0.01s</p><p class="callout-heading">Note </p><p class="callout">We have used the <strong class="source-inline">time</strong> Linux command here, which will run the command and print the resource usage.</p><p>The memory value of 12.01 MB in this example output is reported by the <strong class="source-inline">memory_get_peak_usage()</strong> function and it shows us that this is the RAM memory amount necessary for a PHP script to read a 10 MB file.</p></li>
				<li>Let's now run the same script, but for the bigger file:<p class="source-code">time php file_get_contents-memory.php sample/test-256-mb.txt. </p><p>In the output, we will see an error message like this:</p><p class="source-code">PHP Fatal error: Allowed memory size of 134217728 bytes exhausted (tried to allocate 268443680 bytes) in /app/file_get_contents-memory.php on line 1</p><p>As expected, trying to read a 256 MB file into memory fails because the limit of 128 MB per process is exceeded.</p></li>
				<li>Now, let's check the other approach, using <strong class="source-inline">fread()</strong> to read chunks of data from the file one at a time. Create a file called <strong class="source-inline">fread-memory.php</strong> and insert the following content. We store the <strong class="source-inline">$filePath</strong> variable based on the user's first input argument and we create the resource for that file path, stored under the <strong class="source-inline">$fileResource</strong> variable:<p class="source-code">&lt;?php</p><p class="source-code">$filePath = __DIR__ . DIRECTORY_SEPARATOR . $argv[1];</p><p class="source-code">$fileResource = fopen($filePath, 'r');</p></li>
				<li>If the resource is invalid, the script will be terminated:<p class="source-code">if ($fileResource === false) {</p><p class="source-code">    exit(sprintf('Cannot read [%s] file.', $filePath));</p><p class="source-code">}</p></li>
				<li>We store the second input argument in the <strong class="source-inline">$readLength</strong> variable, which will take the value of the second input argument, with a fallback to <strong class="source-inline">4096</strong> if the second argument is not present. This is the length in bytes that the <strong class="source-inline">fread()</strong> function will use to read from <strong class="source-inline">$fileResource</strong>. We also initiate the <strong class="source-inline">$iterations</strong> variable with a start value of zero:<p class="source-code">$readLength = $argv[2] ?? 4096;</p><p class="source-code">$iterations = 0;</p></li>
				<li>We read the entire file using the <strong class="source-inline">while</strong> loop, as in the previous exercise. The difference here is that the output of the <strong class="source-inline">fread()</strong> function is not used. For each iteration, we increment the <strong class="source-inline">$iterations</strong> variable as well:<p class="source-code">while (!feof($fileResource)) {</p><p class="source-code">    $iterations++;</p><p class="source-code">    fread($fileResource, $readLength);</p><p class="source-code">}</p></li>
				<li>Finally, we close the stream and print the number of iterations performed and the memory usage necessary to read the file:<p class="source-code">fclose($fileResource);</p><p class="source-code">echo sprintf("--\n%d iteration(s): memory %.2fMB\n--\n", $iterations,   memory_get_peak_usage(true) / 1024 / 1024);</p><p>What has changed from the previous <strong class="source-inline">file_get_contents-memory.php</strong> script is that we are reading chunks of data one at a time from the file, using the <strong class="source-inline">$readLength</strong> variable.</p></li>
				<li>Now, let's run some tests, reading the 10 MB file:<p class="source-code"> time php fread-memory.php sample/test-10-mb.txt </p><p>The output is as follows:</p><p class="source-code">--</p><p class="source-code">2561 iteration(s): memory 2.00MB</p><p class="source-code">--</p><p class="source-code">real    0m 0.05s</p><p class="source-code">user    0m 0.02s</p><p class="source-code">sys     0m 0.02s</p><p>As we can see, to read the entire 10 MB file, it took 2,561 read iterations of 4 KB (the second <strong class="source-inline">script</strong> argument is missing, and the default 4,096 bytes are set for the <strong class="source-inline">$readLength</strong> variable). The total duration of the script was 0.05 seconds, compared to 0.03 seconds when using <strong class="source-inline">file_get_contents()</strong>. The main difference to note is the memory usage – 2 MB, which is the minimum the PHP script allocates per process, compared to 12.01 MB when using the <strong class="source-inline">file_get_contents()</strong> function.</p></li>
				<li>What about reading a chunk of 1 MB instead of the default 4 KB? Let's run the following command with 1,048,576 bytes (which are the equivalent of 1 MB): <p class="source-code">time php fread-memory.php sample/test-10-mb.txt 1048576</p><p>The output is now as follows:</p><p class="source-code">--</p><p class="source-code">11 iteration(s): memory 4.00MB</p><p class="source-code">--</p><p class="source-code">real    0m 0.03s</p><p class="source-code">user    0m 0.02s</p><p class="source-code">sys     0m 0.01s</p><p>Now, the entire 10 MB file read used only 11 iterations, with a peak of 4 MB of RAM memory. This time, the script took 0.03 seconds, as in the case of using the <strong class="source-inline">file_get_contents()</strong> function.</p></li>
				<li>And now, let's read the big file, which could not be read using <strong class="source-inline">file_get_contents()</strong>. Run the following command:<p class="source-code">time php fread-memory.php sample/test-256-mb.txt </p><p>The output is as follows:</p><p class="source-code">--</p><p class="source-code">65537 iteration(s): memory 2.00MB</p><p class="source-code">--</p><p class="source-code">real    0m 0.30s</p><p class="source-code">user    0m 0.16s</p><p class="source-code">sys     0m 0.13s</p><p>In this case, the read length is 4 KB, and the complete file read required 65,537 iterations, using a peak of 2 MB of memory. The script took 0.3 seconds to read the entire file, which is not bad, but could be improved by increasing the read length to a bigger value; and this is what we will do in the next step.</p></li>
				<li>Now, run the same command, specifying the chunk size of 1 MB: <p class="source-code">time php fread-memory.php sample/test-256-mb.txt 1048576 </p><p>The output is now this:</p><p class="source-code">--</p><p class="source-code">257 iteration(s): memory 4.00MB</p><p class="source-code">--</p><p class="source-code">real    0m 0.08s</p><p class="source-code">user    0m 0.02s</p><p class="source-code">sys     0m 0.05s</p></li>
			</ol>
			<p>As expected, the time needed to read the entire 256 MB file decreased (from 0.3 seconds to 0.08 seconds), since the read length is higher (1 MB versus 4 KB, resulting in peak memory usage of 4 MB versus 2 MB), and the number of iterations required decreased to 257.</p>
			<p>Now, having a look at this data, we can come up with our own ideas as to what is happening behind the scenes. In the case of <strong class="source-inline">file_get_contents()</strong>, a peak of 12.01 MB memory is used reading the 10 MB file; that's because the whole file was loaded into memory using this approach. The 256 MB file caused the script shutdown because the limit of 128 MB was hit.</p>
			<p>On the other hand, it seems the <strong class="source-inline">fread</strong> approach did pretty well, both in terms of duration and memory usage. Reading the 10 MB file in chunks of 4 KB, the script uses 2 MB of memory, compared to 12 MB in the case of <strong class="source-inline">file_get_contents</strong>, while the read time is significantly bigger (0.05 for <strong class="source-inline">fread()</strong> versus 0.03 for <strong class="source-inline">file_get_contents()</strong>). Reading the same file though, but in chunks of 1 MB, we get similar results in terms of performance, but we still use much less memory than in the case of <strong class="source-inline">file_get_contents</strong> (4 MB versus 12 MB).</p>
			<p>Now, what happens when we increase the scale a bit? Reading the 256 MB file was not possible with <strong class="source-inline">file_get_contents()</strong> on account of exhausted memory. But look at the second approach – not only is the file read entirely but also, only 2 MB of memory is used for this process! It takes about 0.3 seconds to read, which is not very satisfactory, but let's see what happens when the read length is increased and, therefore, the number of iterations is decreased. We get much better results now – a read time of 0.08 seconds and a memory peak of 4 MB.</p>
			<p>As you can see, the convenient way – using <strong class="source-inline">file_get_contents()</strong> – is more suitable for small or very small files, whereas dealing with large files requires you to use different approaches, such as <strong class="source-inline">fread()</strong>, which reads chunks of data; <strong class="source-inline">fgets()</strong>, which gets an entire line at a time from the file pointer; and <strong class="source-inline">fgetcsv()</strong>, which is similar to <strong class="source-inline">fgets()</strong> but, in addition, parses the CSV string line into an array with data.</p>
			<h2 id="_idParaDest-261"><a id="_idTextAnchor268"/>Reading Files Line by Line</h2>
			<p>As indicated earlier, there are more ways to perform optimized reading from big files. In the following exercise, you will learn how to use PHP to read a file line by line. This helps especially when one entry record corresponds to one line, as in access or error logs, for example, so that reading the file allows one data record to be processed at a time. </p>
			<h2 id="_idParaDest-262"><a id="_idTextAnchor269"/>Exercise 7.4: Reading Files Line by Line</h2>
			<p>In this exercise, we will open a file and read it line by line:</p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">fgets.php</strong> and add the following content. As in the previous example, we define the file path and get the file pointer. In the event of failure, the script will exit with an error message: <p class="source-code">&lt;?php</p><p class="source-code">$filePath = __DIR__ . '/sample/users_list.csv';</p><p class="source-code">$fileResource = fopen($filePath, 'r');</p><p class="source-code">if ($fileResource === false) {</p><p class="source-code">    exit(sprintf('Cannot read [%s] file.', $filePath));</p><p class="source-code">}</p></li>
				<li>Next, we initialize the <strong class="source-inline">$lineNumber</strong> variable with the value <strong class="source-inline">0</strong>. And then, as in the case of <strong class="source-inline">fread()</strong>, we perform iterations to read the data in slices. This time, using <strong class="source-inline">fgets()</strong>, we will get one line at a time. The line is then numbered and printed to output. At the end, we close the file resource pointer, since we no longer need it:<p class="source-code">$lineNumber = 0;</p><p class="source-code">while (!feof($fileResource)) {</p><p class="source-code">    $lineNumber++;</p><p class="source-code">    $line = fgets($fileResource);</p><p class="source-code">    echo sprintf("Line %d: %s", $lineNumber, $line);</p><p class="source-code">}</p><p class="source-code">fclose($fileResource);</p><p class="source-code">echo PHP_EOL;</p></li>
				<li>Run the preceding script using the command-line tool, <strong class="source-inline">php fgets.php</strong>. The output will look like this:<p class="source-code">Line 1: John,Smith,2019-03-31T10:20:30Z</p><p class="source-code">Line 2: Alice,Smith,2019-02-28T12:13:14Z</p><p class="source-code">Line 3:</p><p>As you will notice, we have a line without content – that is actually an empty line in a CSV file. Please pay attention when dealing with file lines when trying to process data; check for a non-empty line at least before proceeding with processing.</p></li>
			</ol>
			<h2 id="_idParaDest-263"><a id="_idTextAnchor270"/>Reading CSV Files</h2>
			<p>The previous example shows a handy way to read one line at a time from a file. It turns out in our case that it's about a CSV file, a very simple one, with a comma as a delimiter, and that's pretty much it. But what if you have to deal with a complicated CSV document? Luckily, PHP provides a built-in function for that, called <strong class="source-inline">fgetcsv()</strong>. Using it, we can get one record at a time; that's right, one record, not one line, as the record can be spread over several lines, containing enclosed data (for example, multiline data wrapped between quotes).</p>
			<h2 id="_idParaDest-264"><a id="_idTextAnchor271"/>Exercise 7.5: Reading CSV Files</h2>
			<p>In this exercise, we will read the data from CSV files:</p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">fgetcsv.php</strong> and add the following content. As before, we declare the file path and get the file pointer. In the event of an error, the script will exit with an error message:<p class="source-code">&lt;?php</p><p class="source-code">$filePath = __DIR__ . '/sample/users_list_enclosed.csv';</p><p class="source-code">$fileResource = fopen($filePath, 'r');</p><p class="source-code">if ($fileResource === false) {</p><p class="source-code">    exit(sprintf('Cannot read [%s] file.', $filePath));</p><p class="source-code">}</p></li>
				<li>Then, we initialize the <strong class="source-inline">$recordNumber</strong> variable with the value <strong class="source-inline">0</strong>; we will need it to print to output for each line. And we read one CSV record at a time using the <strong class="source-inline">fgetcsv()</strong> function, in a <strong class="source-inline">while</strong> loop, printing the record number and its content:<p class="source-code">$recordNumber = 0;</p><p class="source-code">while (!feof($fileResource)) {</p><p class="source-code">    $recordNumber++;</p><p class="source-code">    $line = fgetcsv($fileResource);</p><p class="source-code">    echo sprintf("Line %d: %s", $recordNumber, print_r($line, true));</p><p class="source-code">}</p><p class="source-code">fclose($fileResource);</p><p class="source-code">echo PHP_EOL;</p></li>
				<li>Create a file called <strong class="source-inline">users_list_enclosed.csv</strong> inside the <strong class="source-inline">sample/</strong> directory with the following content:<p class="source-code">John,Smith,2019-03-31T10:20:30Z,"4452 Norma Lane</p><p class="source-code">Alexandria</p><p class="source-code">71302 Louisiana"</p><p class="source-code">Alice,Smith,2019-02-28T12:13:14Z,"4452 Norma Lane</p><p class="source-code">Alexandria</p><p class="source-code">71302 Louisiana"</p></li>
				<li>Run the script with <strong class="source-inline">php fgetcsv.php</strong> and the output will look like this:</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer178">
					<img alt="Figure 7.5: Printing the arrays&#13;&#10;" src="image/C14196_07_05.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.5: Printing the arrays</p>
			<p>As you will notice, the <strong class="source-inline">fgetcsv()</strong> function does a very good job, parsing the CSV entries for us correctly. It does not matter whether the CSV content has a custom delimiter, enclosure, or escape character; all these parameters can be passed as function arguments to <strong class="source-inline">fgetcsv()</strong> to make the parser understand the format and perform the appropriate parsing</p>
			<h2 id="_idParaDest-265"><a id="_idTextAnchor272"/>Downloading a File with PHP</h2>
			<p>We saw how we can make the script read the files using a variety of means in order to allow us to <em class="italic">do something</em> with that content. But there is also downloading, when we need the file to be read by the script and sent back to the user, as a response to the HTTP request, and we don't want the PHP process to overload the memory by doing this, something along the lines of reading in chunks and sending the user small pieces at a time. Fortunately, there is a function for that, which is called <strong class="source-inline">readfile()</strong>. This function reads the file and writes it directly to the output buffer. The <strong class="source-inline">readfile()</strong> function requires only the file path to read from. The other optional arguments are a Boolean, which tells the function to search for the file in the <strong class="source-inline">include_path</strong> of PHP, and a context stream resource as a third argument.</p>
			<p>A context stream is a set of options for a specific wrapper (a piece of code that builds other code) that modify or enhance the behavior of a stream. For example, when we want to read a remote file, using FTP, we pass the file path as the first argument of the <strong class="source-inline">readfile()</strong> function, and a valid FTP context stream variable as a third argument. We will not use context streams in the following exercises.</p>
			<h2 id="_idParaDest-266"><a id="_idTextAnchor273"/>Exercise 7.6: Downloading a File</h2>
			<p>In this exercise, we will download a file and save it to the specified destination using PHP:</p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">download.php</strong> and insert the following content. First, we define the existing file path, and then proceed to set headers, where we make use of the <strong class="source-inline">filesize()</strong> function to return the file size in bytes for the file being downloaded, and <strong class="source-inline">basename()</strong>, which returns the last component of the path; in other words, it will cut the directory structure except for the file name. Finally, we call <strong class="source-inline">readfile()</strong> so that PHP can send the file back to the server and client, as a response to the HTTP request:<p class="source-code">&lt;?php</p><p class="source-code">$filePath = 'sample/users_list.csv';</p><p class="source-code">header('Content-Type: text/csv');</p><p class="source-code">header('Content-Length: ' . filesize($filePath));</p><p class="source-code">header(sprintf('Content-Disposition: attachment; filename="%s"', basename($filePath)));</p><p class="source-code">readfile($filePath);</p><p>Make sure you have started the built-in server in this directory (which is <strong class="source-inline">/app</strong> in my case) running <strong class="source-inline">php -S 127.0.0.1</strong> in your Terminal, and that the file exists. </p></li>
				<li>Then, access the script at <strong class="source-inline">http://127.0.0.1:8080/download.php</strong>. You should then see a pop-up box asking where to save the CSV file, or it will save the file automatically to a set destination, depending on your browser's configuration:</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer179">
					<img alt="Figure 7.6: Downloading the CSV file&#13;&#10;" src="image/C14196_07_06.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.6: Downloading the CSV file</p>
			<p class="callout-heading">Note</p>
			<p class="callout">One should check whether the file exists on disk or not and treat each case accordingly. When the file is missing, <strong class="source-inline">readfile()</strong> will output nothing and the browser might receive the output of the PHP script  (output of <strong class="source-inline">download.php</strong> in our case).</p>
			<h2 id="_idParaDest-267"><a id="_idTextAnchor274"/>Writing a File with PHP</h2>
			<p>Writing files with PHP is possible using a variety of methods, the majority involving the <strong class="source-inline">fwrite()</strong> and <strong class="source-inline">file_put_contents()</strong> built-in functions.</p>
			<p>The <strong class="source-inline">fwrite()</strong> function accepts two required arguments, the first is the file pointer, and the second one is the string to write to the file. The function returns the number of bytes written or the Boolean <strong class="source-inline">false</strong> in the event of failure.</p>
			<p><strong class="source-inline">file_put_contents()</strong> is the equivalent of calling the <strong class="source-inline">fopen()</strong>, <strong class="source-inline">fwrite()</strong>, and <strong class="source-inline">fclose()</strong> sequence.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">When a file is written several times in a single PHP process, the <strong class="source-inline">fwrite()</strong> method is preferred, for performance reasons, since the stream resource is reused, and the file open and close operations (<strong class="source-inline">fopen()</strong> and <strong class="source-inline">fclose()</strong>) are avoided for each write as it happens with the <strong class="source-inline">file_put_contents()</strong> function. A good example of using <strong class="source-inline">fwrite()</strong> over <strong class="source-inline">file_put_contents()</strong> is the case of file loggers, when a PHP process might write several times in the same file during its lifetime.</p>
			<p>The first required argument is the filename, and the second one is the data to write to the file. The data can be a string, a resource stream, or a single dimension array of strings, rows of which are written in sequence. The third argument is optional and accepts the flags for a write operation. This can be any combination of the following values:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer180">
					<img alt="Figure 7.7: Different flags for file_put_contents() function, and their descriptions&#13;&#10;" src="image/C14196_07_07.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.7: Different flags for file_put_contents() function, and their descriptions</p>
			<p>When using the <strong class="source-inline">fwrite</strong> method, we may want to use the same data stream resource to read from; for example, to move the pointer at the beginning of the file after writing, or to read the last N bytes of data. In this case, we would use the <strong class="source-inline">fseek()</strong> function. This function sets the file pointer (remember the cursor analogy before?) to a specific position. The function signature is as follows:</p>
			<p class="source-code">fseek(resource $handle, int $offset [, int $whence = SEEK_SET ]) : int</p>
			<p>The new position, measured in bytes, is obtained by adding an offset to the position specified by <strong class="source-inline">$whence</strong>.</p>
			<p><strong class="source-inline">$whence</strong> values can be:</p>
			<ul>
				<li><strong class="source-inline">SEEK_SET</strong> – Sets the position of the file pointer equal to <strong class="source-inline">offset</strong> bytes. This is the default option if none was specified.</li>
				<li><strong class="source-inline">SEEK_CUR</strong> – Sets the position of the file pointer equal to the current location plus <strong class="source-inline">offset</strong>.</li>
				<li><strong class="source-inline">SEEK_END</strong> – Sets the position of the file pointer equal to EOF plus <strong class="source-inline">offset</strong>.</li>
			</ul>
			<h2 id="_idParaDest-268"><a id="_idTextAnchor275"/>Exercise 7.7: Writing to Files</h2>
			<p>In the following exercise, we will perform write operations in files using both of the <strong class="source-inline">fwrite()</strong> and <strong class="source-inline">file_put_contents()</strong> functions described previously: </p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">write.php</strong> and insert the following content:<p class="source-code">&lt;?php</p><p class="source-code">$fileFwrite = 'sample/write-with-fwrite.txt';</p><p class="source-code">$fp = fopen($fileFwrite, 'w+');</p><p class="source-code">$written = fwrite($fp, 'File written with fwrite().' . PHP_EOL);</p><p>First, we define the file path to write to, and then we open the file pointer using the <strong class="source-inline">fopen()</strong> function. </p><p class="callout-heading">Note </p><p class="callout">Always make sure to have the directory structure created before trying to open or put content into a file. Following our example, you should make sure the <strong class="source-inline">sample/</strong> directory exists in the current working directory.</p></li>
				<li>Next, we attempt to write to the file using the <strong class="source-inline">fwrite()</strong> function, storing the output in the <strong class="source-inline">$written</strong> variable:<p class="source-code">if (false === $written) {</p><p class="source-code">    echo 'Error writing with fwrite.' . PHP_EOL;</p><p class="source-code">} else {</p><p class="source-code">    echo sprintf("&gt; Successfully written %d bytes to [%s] with fwrite():", $written, $fileFwrite) . PHP_EOL;</p><p class="source-code">    fseek($fp, 0);</p><p class="source-code">    echo fread($fp, filesize($fileFwrite)) . PHP_EOL;</p><p class="source-code">}</p><p>If the write fails (<strong class="source-inline">$written</strong> is the Boolean <strong class="source-inline">false</strong>), then we print an error message and continue the script. Otherwise, we print the success message, indicating the number of bytes written. After that, in order to read from the file, we move the pointer at the beginning of the file, at position zero, using the <strong class="source-inline">fseek()</strong> function. Then, we just print the file content to test the written data.</p></li>
				<li>To test the second approach, we define the <strong class="source-inline">write-with-fpc.txt</strong> file inside the <strong class="source-inline">sample/</strong> directory, and then call the <strong class="source-inline">file_put_contents()</strong> function in an attempt to write to the file, and store the output in the same <strong class="source-inline">$written</strong> variable:<p class="source-code">$fileFpc = 'sample/write-with-fpc.txt';</p><p class="source-code">$written = file_put_contents($fileFpc, 'File written with file_put_contents().' . PHP_EOL);</p></li>
				<li>As in the previous example, if we failed to write to the file, then we print an error message and continue the script. In the case of a successful write, we print the message indicating the number of bytes written into the file followed by the actual file content:<p class="source-code">if (false === $written) {</p><p class="source-code">    echo 'Error writing with fwrite.' . PHP_EOL;</p><p class="source-code">} else {</p><p class="source-code">    echo sprintf("&gt; Successfully written %d bytes to [%s] with file_put_contents():", $written, $fileFwrite) . PHP_EOL;</p><p class="source-code">    echo file_get_contents($fileFpc) . PHP_EOL;</p><p class="source-code">}</p><p class="callout-heading">Note</p><p class="callout">The whole script can be referred at <a href="https://packt.live/2MCkeOJ">https://packt.live/2MCkeOJ</a>.</p></li>
				<li>Run the script from the command line with <strong class="source-inline">php write.php</strong>. The output should look like this: </li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer181">
					<img alt="Figure 7.8: Writing into files using different methods&#13;&#10;" src="image/C14196_07_08.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.8: Writing into files using different methods</p>
			<p>In this exercise, we wrote string sequences in two different files using two different methods – <strong class="source-inline">file_put_contents()</strong> and <strong class="source-inline">fwrite()</strong>.</p>
			<p>Congratulations! You just managed to write files using PHP.</p>
			<h2 id="_idParaDest-269"><a id="_idTextAnchor276"/>Exercise 7.8: Appending Content in Files</h2>
			<p>We have seen how it is possible to write fresh content in files, but often, you just want to add to an existing file – think about some sort of log, for example. In this exercise, you will learn how it is possible to append content to a file, using PHP:</p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">write-append.php</strong> and use the code from the previous exercise with two minor modifications. First, we want to change the <strong class="source-inline">fopen()</strong> mode, from <strong class="source-inline">w+</strong> to <strong class="source-inline">a+</strong> (from write and read to write-append and read):<p class="source-code">$fp = fopen($fileFwrite, 'a+');</p></li>
				<li>Add the third parameter to the <strong class="source-inline">file_put_contents()</strong> function – the <strong class="source-inline">FILE_APPEND</strong> constant:<p class="source-code">$written = file_put_contents($fileFpc, 'File written with file_put_contents().' . PHP_EOL, FILE_APPEND);</p></li>
				<li>Run the script from the command-line interface with <strong class="source-inline">php write-append.php</strong> and you will get the following result:</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer182">
					<img alt="Figure 7.9: Result of the script&#13;&#10;" src="image/C14196_07_09.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.9: Result of the script</p>
			<p>Running the script over and over again will print you the same success message, and, with each run, the number of sentences will increase in each file, due to the <strong class="source-inline">append</strong> instruction.</p>
			<p>Appending content in files is very useful in the case of logging and generating content in files in order to perform further downloads, to name but a couple of use cases.</p>
			<h2 id="_idParaDest-270"><a id="_idTextAnchor277"/>Other Filesystem Functions</h2>
			<p>PHP offers generous support when it comes to handling filesystems. All of the functions can be explored at <a href="https://packt.live/2MAsLmw">https://packt.live/2MAsLmw</a>. In addition, we will cover some of the most widely used filesystem functions in PHP.</p>
			<h2 id="_idParaDest-271"><a id="_idTextAnchor278"/>Deleting a File with PHP</h2>
			<p><strong class="source-inline">unlink()</strong> is the delete files function. It requires the file path as the first parameter and accepts an optional context stream. It returns <strong class="source-inline">TRUE</strong> if the file is deleted successfully, or <strong class="source-inline">FALSE</strong> otherwise.</p>
			<p>Before deleting a file, it is good to check first whether the file path points to an actual file, and, to achieve this, we can use the <strong class="source-inline">is_file()</strong> function. This function requires only the file path as the first parameter. It returns <strong class="source-inline">TRUE</strong> if a file is located and is a regular file, otherwise <strong class="source-inline">FALSE</strong>.</p>
			<h2 id="_idParaDest-272"><a id="_idTextAnchor279"/>Exercise 7.9: Deleting a File with PHP</h2>
			<p>When working with file content in PHP, it is highly likely that you will want to clean some older files. In this exercise, we will write code to delete a file using PHP:</p>
			<ol>
				<li value="1">Create an empty file called <strong class="source-inline">to-delete.txt</strong> in the <strong class="source-inline">sample/</strong> directory. This is the file we will delete with PHP.</li>
				<li>Create a file called <strong class="source-inline">delete.php</strong>, and insert the following code:<p class="source-code">&lt;?php</p><p class="source-code">$filepath = 'sample/to-delete.txt';</p><p class="source-code">if (is_file($filepath)) {</p><p class="source-code">    if (unlink($filepath)) {</p><p class="source-code">        echo sprintf('The [%s] file was deleted.', $filepath) . PHP_EOL;</p><p class="source-code">    } else {</p><p class="source-code">        echo sprintf('The [%s] file cannot be deleted.', $filepath) .           PHP_EOL;</p><p class="source-code">    }</p><p class="source-code">} else {</p><p class="source-code">    sprintf('The [%s] file does not exist.', $filepath) . PHP_EOL;</p><p class="source-code">}</p><p>In this script, we check whether the file exists and is a regular file, using the <strong class="source-inline">is_file()</strong> function. In the case of a regular file, next, we test the file deletion; that is, the output of the <strong class="source-inline">unlink()</strong> function that is responsible for this, and then print the appropriate message based on the output. If the file does not exist, a message providing a notification of this will be printed.</p></li>
				<li>Run the script in the command-line interface. With <strong class="source-inline">php delete.php</strong>, you will notice the following output:<p class="source-code">The [sample/to-delete.txt] file was deleted.</p><p>Running the script again will print the following:</p><p class="source-code">The [sample/to-delete.txt] file does not exist.</p><p>This means the <strong class="source-inline">delete</strong> operation was indeed executed successfully.</p></li>
			</ol>
			<p>In this exercise, when running the script for the first time, all the conditions were met in order to run file deletion, and the file was indeed deleted. When running the script for the second time, the script cannot find the file for the specified path, so the script returns the <strong class="source-inline">file does not exist</strong> message immediately, prior to exiting.</p>
			<h2 id="_idParaDest-273"><a id="_idTextAnchor280"/>Moving Files with PHP</h2>
			<p>On occasion, you may need to move files to a new location, for example, to the archive. This might be the case with a database data dump or log files, to name but two. PHP provides a function for moving functionality, called <strong class="source-inline">rename()</strong>, which requires the actual file path as a first argument, and the target file path as a second argument. This function returns <strong class="source-inline">TRUE</strong> if successful and <strong class="source-inline">FALSE</strong> in the event of failure, and can be used for both files and directories. </p>
			<p>Sometimes, the target directory might not yet exist and, in these cases, it is supposed to be created with the script. There is a function for creating directories, called <strong class="source-inline">mkdir()</strong>, which accepts the following arguments: the directory path to create, the mode (which is <strong class="source-inline">0777</strong>, by default, meaning full permissions for any user), a recursive directory creation instruction, and the context resource.</p>
			<h2 id="_idParaDest-274"><a id="_idTextAnchor281"/>Exercise 7.10: Creating Directories and Moving Files to the Archive</h2>
			<p>In this exercise, you will move a file to your local server, using PHP. Let's say you are assigned the task of creating a script that will move generated log files to an "archive location," on a daily basis:</p>
			<ol>
				<li value="1">Create an empty file called <strong class="source-inline">to-move.txt</strong>. This is the file we will move using PHP, considering it to be the generated log file.</li>
				<li>Create a file called <strong class="source-inline">move.php</strong> and insert the following content. First, we define the file path to move and the target directory that the file should be moved to. Then, we check whether the file path exists and is a regular file and, in the event of failure, the script will print an error message and will stop the execution:<p class="source-code">&lt;?php</p><p class="source-code">$filePath = 'sample/to-move.txt';</p><p class="source-code">$targetDirectory = 'sample/archive/2019';</p><p class="source-code">if (!is_file($filePath)) {</p><p class="source-code">    echo sprintf('The [%s] file does not exist.', $filePath) . PHP_EOL;</p><p class="source-code">    return;</p><p class="source-code">}</p></li>
				<li>Then, we check whether the target directory exists and is a directory, and if there's no such directory, then we will try to create one. A message is printed in this regard, letting you know that the directory is being created. Then, the <strong class="source-inline">mkdir()</strong> function is used to create the target directory, in a recursive fashion (setting the third parameter to <strong class="source-inline">true</strong> will instruct the script to create any parent directory if it's missing). If the action fails, then an error message is printed and the script stops the execution. Otherwise, the successful message, <strong class="source-inline">Done</strong>, is printed:<p class="source-code">if (!is_dir($targetDirectory)) {</p><p class="source-code">    echo sprintf('The target directory [%s] does not exist. Will create...       ', $targetDirectory);</p><p class="source-code">    if (!mkdir($targetDirectory, 0777, true)) {</p><p class="source-code">        echo sprintf('The target directory [%s] cannot be created.',           $targetDirectory) . PHP_EOL;</p><p class="source-code">        return;</p><p class="source-code">    }</p><p class="source-code">    echo 'Done.' . PHP_EOL;</p><p class="source-code">}</p></li>
				<li>Next, we will define the target file path, and this will comprise the target directory and the file base name. Then, the <strong class="source-inline">move</strong> process is effected by using the <strong class="source-inline">rename()</strong> function. A message is printed for both a successful or a failed operation:<p class="source-code">$targetFilePath = $targetDirectory . DIRECTORY_SEPARATOR .   basename($filePath);</p><p class="source-code">if (rename($filePath, $targetFilePath)) {</p><p class="source-code">    echo sprintf('The [%s] file was moved in [%s].', basename($filePath),       $targetDirectory) . PHP_EOL;</p><p class="source-code">} else {</p><p class="source-code">    echo sprintf('The [%s] file cannot be moved in [%s].',       basename($filePath), $targetDirectory) . PHP_EOL;</p><p class="source-code">}</p><p class="callout-heading">Note</p><p class="callout">The complete script file can be referred at : <a href="https://packt.live/35wmDmK">https://packt.live/35wmDmK</a>.</p></li>
				<li>Run the script in the command-line interface, with <strong class="source-inline">php move.php</strong>. The output, during the first run, should look like this:<p class="source-code">The target directory [sample/archive/2019] does not exist. Will create... Done.</p><p class="source-code">The [to-move.txt] file was moved in [sample/archive/2019].</p><p>Checking the file tree, you will notice that the file has indeed moved:</p></li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer183">
					<img alt="Figure 7.10: Screenshot of the file tree&#13;&#10;" src="image/C14196_07_10.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.10: Screenshot of the file tree</p>
			<p>In addition to this, when running the script for the second time, you should get the following output:</p>
			<p class="source-code">The [sample/to-move.txt] file does not exist.</p>
			<p>In this exercise, you succeeded in moving a file from one location to another, using PHP with its built-in filesystem functions, validating the input as well, so as to make sure that you were not attempting to move a non-existent file.</p>
			<h2 id="_idParaDest-275"><a id="_idTextAnchor282"/>Copying Files Using PHP</h2>
			<p>Copying files is yet another straightforward task for which PHP offers support. The <strong class="source-inline">copy()</strong> function accepts two required arguments – the source file path and the destination path, and an optional one – the stream context. Using the <strong class="source-inline">copy()</strong> function is very useful in scenarios such as choosing your profile picture from a list of available pictures on the server (in this case, you want to leave the picture list intact, so you will only want to create a copy of the selected picture), or restoring files copied from a backup (again, you want to leave the original files intact, so <strong class="source-inline">copy()</strong> is again appropriate in this case).</p>
			<p class="callout-heading">Note </p>
			<p class="callout">Using the <strong class="source-inline">copy()</strong> function, if the destination file exists already, it will be overwritten.</p>
			<h2 id="_idParaDest-276"><a id="_idTextAnchor283"/>Exercise 7.11: Copying Files</h2>
			<p>You are required to write a script that will copy specific files to a backup location. The copied files should have the <strong class="source-inline">.bak</strong> extension prepended:</p>
			<ol>
				<li value="1">Create an empty file called <strong class="source-inline">to-copy.txt</strong> inside the <strong class="source-inline">sample</strong> directory.</li>
				<li>Create the <strong class="source-inline">copy.php</strong> file with the following content:<p class="source-code">&lt;?php</p><p class="source-code">$sourceFilePath = 'sample/to-copy.txt';</p><p class="source-code">$targetFilePath = 'sample/to-copy.txt.bak';</p><p class="source-code">if (!is_file($sourceFilePath)) {</p><p class="source-code">    echo sprintf('The [%s] file does not exist.', $sourceFilePath) .       PHP_EOL;</p><p class="source-code">    return;</p><p class="source-code">}</p><p>First, we define the source and target file paths, and then check whether the source file exists. If the source file does not exist, an error message is printed and the execution of the script stops.</p></li>
				<li>Next, we try to copy the file, using the <strong class="source-inline">copy()</strong> function. An appropriate message is printed, based on the <strong class="source-inline">copy()</strong> function response:<p class="source-code">if (copy($sourceFilePath, $targetFilePath)) {</p><p class="source-code">    echo sprintf('The [%s] file was copied as [%s].', $sourceFilePath,       $targetFilePath) . PHP_EOL;</p><p class="source-code">} else {</p><p class="source-code">    echo sprintf('The [%s] file cannot be copied as [%s].',       $sourceFilePath, $targetFilePath) . PHP_EOL;</p><p class="source-code">}</p><p class="callout-heading">Note</p><p class="callout">The complete script can be referred at <a href="https://packt.live/2plXtXu">https://packt.live/2plXtXu</a>.</p></li>
				<li>Run the file in the command-line interface, with <strong class="source-inline">php copy.php</strong>, and check the results; in the event of a successful <strong class="source-inline">copy</strong> operation, you should get the following output:<div class="IMG---Figure" id="_idContainer184"><img alt="Figure 7.11: Copying file successfully&#13;&#10;" src="image/C14196_07_11.jpg"/></div><p class="figure-caption">Figure 7.11: Copying file successfully</p></li>
				<li>Change <strong class="source-inline">$sourceFilePath</strong> in the script to a non-existent file path (for example, <strong class="source-inline">wrong-file-path.txt</strong>) and run the script again. The output will be as follows:</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer185">
					<img alt="Figure 7.12: Trying to copy a nonexistent file&#13;&#10;" src="image/C14196_07_12.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.12: Trying to copy a nonexistent file</p>
			<p>As you can see, copying files with PHP turns out to be a pretty straightforward process. </p>
			<p>In this exercise, you learned how to deal with files using PHP, starting with file create and write, and continuing with append, rewrite and delete, and copy and move, and then reading large files line by line and sending files to download.</p>
			<h1 id="_idParaDest-277"><a id="_idTextAnchor284"/>Databases</h1>
			<p>In the previous section, we saw how we can use PHP to manipulate and store data in files. But when an application relies on structured data, it gets pretty complicated using the filesystem, especially when the application grows, and so does your data. Imagine a social media website, with tons of relationships between the data, including post comments, interests, friendships, groups, and a plethora of other linked data. Also, as your application grows, scalability is an important factor. This is when you want to use a database, to be able to query the data in different ways – ordered, filtered, partial data, combined data (joined), and, at the same time, in a very performant way. A <strong class="bold">database management system</strong> (<strong class="bold">DBMS</strong>) is used for performing operations on database data (create, read, update, and delete). Also, since different types of data are related to other data types in a database, you may want accuracy, consistency, and reliability for your data storage. In this case, you would prefer a relational DBMS. </p>
			<p>MySQL is a <strong class="bold">Relational Database Management System</strong> (<strong class="bold">RDBMS</strong>) and is the most commonly used with PHP. It is very fast, reliable, easy to use (it uses <strong class="bold">Structured Query Language</strong> (<strong class="bold">SQL</strong>) queries), and it's free to use. It suits a wide range of applications, from small to large. It's very powerful, fast, secure, and scalable.</p>
			<p>A MySQL database stores data in tables, just like any other relational database. A table is composed of related data, organized in rows (records) and columns (record fields).</p>
			<p>PHP supports a wide variety of databases, such as MySQL, PostgreSQL, SQLite, MongoDB, MSSQL, and others, but, in this chapter, we will work with MySQL, as it's by far the most widely used database management system with PHP.</p>
			<h2 id="_idParaDest-278"><a id="_idTextAnchor285"/>GUI Clients</h2>
			<p>Often, graphical user interface (GUI or "desktop applications") clients are very useful when it comes to performing miscellaneous operations in a database, such as verifying data, altering tables or columns, exporting or importing data, and migrating a database.</p>
			<p>For MySQL, three clients are recommended:</p>
			<ul>
				<li>MySQL Workbench: a desktop application; cross-platform; can be downloaded from <a href="https://packt.live/32iaZd6">https://packt.live/32iaZd6</a></li>
				<li>PhpMyAdmin: a browser application; can be downloaded from <a href="https://packt.live/2McXnu9">https://packt.live/2McXnu9</a></li>
				<li>Adminer: a lightweight browser application; can be downloaded from <a href="https://packt.live/35yBTzB">https://packt.live/35yBTzB</a></li>
			</ul>
			<p>In addition, for screenshots, I'll use Workbench to test the data in MySQL Server, but any of these tools could be used.</p>
			<h2 id="_idParaDest-279"><a id="_idTextAnchor286"/>Connecting to MySQL</h2>
			<p>To use MySQL Server with PHP, some extensions need to be installed. Usually, an extension is a component that exposes an <strong class="bold">Application Programming Interface</strong> (<strong class="bold">API</strong>) to the user, and which is used to perform specific tasks; in our case, a database-specific extension will be used to connect to MySQL, query update, and delete data, among other operations. In PHP, the two most commonly used extensions when working with MySQL are the <strong class="source-inline">mysqli</strong> and <strong class="source-inline">PDO</strong> extensions. These are very similar in terms of functionality and syntax, and, unless you need a specific feature from one of the extensions, choosing an extension to work with should not cause any difficulties. Just pick one.</p>
			<p>Since PDO appears to be the most widely used option, we will pick this extension for further exercises.</p>
			<p><strong class="bold">PHP Data Objects</strong> (<strong class="bold">PDO</strong>) is a lightweight and lean interface for accessing databases with PHP.</p>
			<p>To continue, make sure you have MySQL installed, as described in the preface. Furthermore, consider the MySQL server listening on <strong class="source-inline">127.0.0.1</strong>, port <strong class="source-inline">3306</strong>, with the username set to <strong class="source-inline">php-user</strong> and the password set as <strong class="source-inline">php-pass</strong>. </p>
			<p class="callout-heading">Note</p>
			<p class="callout">For Windows OS, the database username php-user in code snippets for chapter 7 will need to be replaced with php_user. This is because the Windows installer for MySQL does not allow hyphens in usernames.</p>
			<p>Make sure you have the <strong class="source-inline">PDO</strong> extension and the <strong class="source-inline">pdo_mysql</strong> driver installed to facilitate the establishment of connections and send queries to the MySQL Server. </p>
			<p class="callout-heading">Note</p>
			<p class="callout">The <strong class="source-inline">pdo_mysql</strong> driver is an extension that provides an interface to the aforementioned PDO extension. This driver is a component that makes communication with the MySQL Server possible, translating instructions between the two parties.</p>
			<p>Checking for an enabled PHP extension in the Terminal is possible by running <strong class="source-inline">php -m</strong> to list all installed and enabled extensions or <strong class="source-inline">php -m | grep -i pdo</strong> to list only those entries that match the <strong class="source-inline">pdo</strong> string fragment. The latter should output these two entries:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer186">
					<img alt="" src="image/C14196_07_13.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.13: Checking for the enabled extensions</p>
			<p class="callout-heading">Note</p>
			<p class="callout"><strong class="source-inline">grep</strong> is a Unix function that searches for text in files or in string input, and returns the matching lines in output by default. The <strong class="source-inline">|</strong> (pipe) token is used to forward the previous command's output (<strong class="source-inline">php -m</strong>) to the next command, as input.</p>
			<p>In order to proceed further, let's create a new directory where we will write the database-related exercises (for example, <strong class="source-inline">database</strong>).</p>
			<h2 id="_idParaDest-280"><a id="_idTextAnchor287"/>Connecting to MySQL</h2>
			<p>Connections to MySQL are initiated by instantiating the PDO object. This accepts the database source (DSN) as the first argument, and optionally, the username, password, and PDO options, if required.</p>
			<p>The syntax is as follows:</p>
			<p class="source-code">PDO::__construct(string $dsn [, string $username [, string $password [, array   $options ]]])</p>
			<p>Parameters:</p>
			<ul>
				<li>Data Source Name: <strong class="bold">Data Source Name</strong> (<strong class="bold">DSN</strong>) specifies the details required to connect to the database; for a MySQL connection, the prefix is <strong class="source-inline">mysql:</strong> followed by a list of key-value pairs separated by semicolons; these elements will be listed here.</li>
				<li>username: the username used to connect to the database.</li>
				<li>password: the password used to authenticate the username.</li>
				<li>options: an associative array of MySQL (driver-specific) connection options.</li>
			</ul>
			<p>The DSN allows the following elements:</p>
			<ul>
				<li>host: the hostname where the database is located.</li>
				<li>port: the database server listens to this port number.</li>
				<li>dbname: the name of the database.</li>
				<li>charset: the character set for the connection (the data will be transferred using this character set).</li>
				<li>unix_socket: The MySQL Unix socket; to be used as an alternative to the host and port connection type.</li>
			</ul>
			<p>By way of good practice, it is recommended to set the connection character set to <strong class="source-inline">utf8mb4</strong>; that will save you from further difficulties if you have to store and fetch UTF-8 characters using this connection (and you will have to, at some point). </p>
			<p>One of the methods of the <strong class="source-inline">PDO</strong> class is <strong class="source-inline">getAttribute()</strong>, which returns a database connection attribute, such as server information and the connection status. The <strong class="source-inline">PDO::getAttribute()</strong> method requires and accepts only one parameter, the integer type; that is, one of the <strong class="source-inline">PDO::ATTR_*</strong> constants. For a complete list of PDO attributes and other constants, visit the official documentation page at <a href="https://www.php.net/manual/en/pdo.constants.php">https://www.php.net/manual/en/pdo.constants.php</a>.</p>
			<h2 id="_idParaDest-281"><a id="_idTextAnchor288"/>Exercise 7.12: Connecting to MySQL</h2>
			<p>In this exercise, you will connect to a MySQL server using PDO.</p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">connect.php</strong> and add the following content. In our script, we first define the DSN for our MySQL database, pointing the host to <strong class="source-inline">127.0.0.1</strong> and the port to <strong class="source-inline">3306</strong>:<p class="source-code">&lt;?php</p><p class="source-code">$dsn = "mysql:host=127.0.0.1;port=3306;charset=utf8mb4";</p></li>
				<li>Next, we set the PDO options, under the <strong class="source-inline">$options</strong> variable, where we specify the fetch mode, to have all the records fetched as an associative array by default. We would also want to set the error mode to <strong class="source-inline">Exceptions</strong>, to make it easier to handle query errors, but for now, we will make use of the <strong class="source-inline">PDO::errorCode()</strong> and <strong class="source-inline">PDO::errorInfo()</strong> methods:<p class="source-code">$options = [</p><p class="source-code">    PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_ASSOC,</p><p class="source-code">//    PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_EXCEPTION,</p><p class="source-code">];</p><p class="callout-heading">Note</p><p class="callout">We will learn about exceptions and error handling in the next chapter.</p></li>
				<li>In the next line, we invoke the <strong class="source-inline">PDO</strong> object, thereby creating a connection to the database, using the DSN defined previously, the username, password, and the aforementioned <strong class="source-inline">PDO</strong> option. If the connection is unsuccessful, an exception will be thrown (of the <strong class="source-inline">PDOException</strong> type) and the execution of the script will stop:<p class="source-code">$pdo = new PDO($dsn, "php-user", "php-pass", $options);</p></li>
				<li>In the final step, we want to print the connection info, using the <strong class="source-inline">PDO::getAttribute()</strong> method:<p class="source-code">echo sprintf(</p><p class="source-code">        "Connected to MySQL server v%s, on %s",</p><p class="source-code">        $pdo-&gt;getAttribute(PDO::ATTR_SERVER_VERSION),</p><p class="source-code">        $pdo-&gt;getAttribute(PDO::ATTR_CONNECTION_STATUS)</p><p class="source-code">    ) . PHP_EOL;</p></li>
				<li>Run the file in the command-line interface with <strong class="source-inline">php connect.php</strong>. When the connection is successful, the output will look like this:<p class="source-code">Connected to MySQL server v5.7.23, on 127.0.0.1 via TCP/IP</p><p>In the event of a connection failure, the output will look like this:</p><p class="source-code">PHP Fatal error: Uncaught PDOException: SQLSTATE[HY000] [1045] Access denied for user 'php-user'@'127.0.0.1' (using password: YES) in /app/connect.php:8</p><p class="source-code">Stack trace:</p><p class="source-code">#0 /app/connect.php(8): PDO-&gt;__construct('mysql:host=127....', 'php-user', 'wrongpwd', Array)</p><p class="source-code">#1 {main}</p><p class="source-code">  thrown in /app/connect.php on line 8</p><p>In the event of a connection failure, it would be better to treat the error and fall back gracefully to a nice-looking error page, providing a user-friendly error message. In this case, though, we will leave the script as it is now because PHP exceptions will be covered in the next chapter.</p></li>
			</ol>
			<p>Here, you made a connection to MySQL, with a username and password, using PDO, and you set some options as well, for the <strong class="source-inline">PDO</strong> object. You also printed the server version and connection status, from the PDO connection attributes. </p>
			<h2 id="_idParaDest-282"><a id="_idTextAnchor289"/>Creating a Database</h2>
			<p>Now that we have learned how to establish a connection with a MySQL Server, let's move forward and see how we can create a database.</p>
			<p>To do this, we will have to run SQL queries; this is where we get to use the <strong class="source-inline">PDO</strong> methods.</p>
			<p>We will invoke the <strong class="source-inline">PDO::exec()</strong> method to send the SQL queries to MySQL Server. It requires and accepts only one parameter: the SQL query string, and returns the Boolean <strong class="source-inline">false</strong> in the event of an error, or the number of affected rows in the event of success.</p>
			<p>Warning: Since this function can return a Boolean <strong class="source-inline">false</strong> and also <strong class="source-inline">0</strong> (zero), which evaluates to <strong class="source-inline">false</strong>, make sure you use the <strong class="source-inline">===</strong> or <strong class="source-inline">!==</strong> operator when testing the result, so as to avoid false positives when checking for errors.</p>
			<p>In the event of a query failure (<strong class="source-inline">PDO::exec()</strong> returns <strong class="source-inline">false</strong>), we may invoke the <strong class="source-inline">PDO::errorInfo()</strong> method to get the error codes and the error message. This method returns a numeric array containing the following data:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer187">
					<img alt="Figure 7.14: Description of the type of data in the array returned by the PDO::errorInfo()&#13;&#10;" src="image/C14196_07_14.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.14: Description of the type of data in the array returned by the PDO::errorInfo()</p>
			<p>The query to run in order to create a new database has the following syntax:</p>
			<p><strong class="source-inline">CREATE SCHEMA db_name</strong>, where <strong class="source-inline">db_name</strong> should be replaced with the name of the database you want to create. </p>
			<p class="callout-heading">Note </p>
			<p class="callout">The <strong class="source-inline">CREATE SCHEMA</strong> string is an SQL statement. It can be executed in a SQL server using any SQL client. The syntax and more information can be found on the official documentation page at <a href="https://packt.live/32ewQSK">https://packt.live/32ewQSK</a>.</p>
			<h2 id="_idParaDest-283"><a id="_idTextAnchor290"/>Exercise 7.13: Creating a Database</h2>
			<p>In this exercise, we will create a database and run queries:</p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">connection-no-db.php</strong> and insert the following code:<p class="source-code">&lt;?php</p><p class="source-code">$dsn = "mysql:host=127.0.0.1;port=3306;charset=utf8mb4";</p><p class="source-code">$options = [</p><p class="source-code">    PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_ASSOC,</p><p class="source-code">];</p><p class="source-code">$pdo = new PDO($dsn, "php-user", "php-pass", $options);</p><p class="source-code">return $pdo;</p><p>This is similar to what we did in the previous exercise, except that instead of printing the connection information, we return the <strong class="source-inline">PDO</strong> instance. In this file, we do not specify a database name, since we have not yet created one.</p></li>
				<li>Create a file called <strong class="source-inline">create-schema.php</strong> and insert the following code. First, we require the <strong class="source-inline">PDO</strong> instance from the <strong class="source-inline">connection-no-db.php</strong> file we created previously:<p class="source-code">&lt;?php</p><p class="source-code">/** @var PDO $pdo */</p><p class="source-code">$pdo = require 'connection-no-db.php';</p><p>Then, we write our SQL query under the <strong class="source-inline">$sql</strong> variable, which will create a database with the name <strong class="source-inline">demo</strong>: </p><p class="source-code">$dbname = 'demo';</p><p class="source-code">$sql = "CREATE SCHEMA $dbname";</p></li>
				<li>Run the query using the <strong class="source-inline">PDO::exec()</strong> method, and check for successful statement execution (the result is not a Boolean <strong class="source-inline">false</strong>). In the event of success, we print a simple success message. In the event of an error, we print the error message:<p class="source-code">if ($pdo-&gt;exec($sql) !== false) {</p><p class="source-code">    echo "The database '$dbname' was successfully created." . PHP_EOL;</p><p class="source-code">} else {</p><p class="source-code">    list(, , $driverErrMsg) = $pdo-&gt;errorInfo();</p><p class="source-code">    echo "Error creating the database: $driverErrMsg" . PHP_EOL;</p><p class="source-code">}</p></li>
				<li>Run the code from the command-line interface with <strong class="source-inline">php create-schema.php</strong>. When running the code for the very first time, you will get the following output:<div class="IMG---Figure" id="_idContainer188"><img alt="Figure 7.15: Creating a schema successfully&#13;&#10;" src="image/C14196_07_15.jpg"/></div></li>
			</ol>
			<p class="figure-caption">Figure 7.15: Creating a schema successfully</p>
			<p>Running the code successively, you will get the following error message:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer189">
					<img alt="Figure 7.16: Error in creating the schema&#13;&#10;" src="image/C14196_07_16.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.16: Error in creating the schema</p>
			<p>In this exercise, you learned how we can create a database and how to test for the successful execution of the SQL statement, <strong class="source-inline">CREATE SCHEMA</strong>.</p>
			<h2 id="_idParaDest-284"><a id="_idTextAnchor291"/>Creating a Table</h2>
			<p>Let's now see how we can create a table that will actually hold the data in an organized way. We will use the <strong class="source-inline">CREATE TABLE</strong> SQL statement to achieve this. The syntax of this statement is more complex and also involves table column definitions.</p>
			<p>Standard <strong class="source-inline">CREATE TABLE</strong> syntax is as follows:</p>
			<p class="source-code">CREATE TABLE [IF NOT EXISTS] tbl_name</p>
			<p class="source-code">(</p>
			<p class="source-code">  col_name data_type [NOT NULL | NULL] [DEFAULT default_value] [AUTO_INCREMENT]    [UNIQUE [KEY]] [[PRIMARY] KEY]</p>
			<p class="source-code">  ...</p>
			<p class="source-code">)</p>
			<p>The parameters are as follows:</p>
			<ul>
				<li><strong class="source-inline">tbl_name</strong>: The table name to be created.</li>
				<li><strong class="source-inline">col_name</strong>: The column name.</li>
				<li><strong class="source-inline">data_type</strong>: The type of data the column holds, such as date, timestamp, integer, string, and JSON. More information can be found at <a href="https://packt.live/32CWosP">https://packt.live/32CWosP</a>.</li>
				<li><strong class="source-inline">default_value</strong>: The default value when the <strong class="source-inline">insert</strong> statement provides no data for this row column.</li>
			</ul>
			<p>A sample <strong class="source-inline">CREATE TABLE</strong> query can be as follows:</p>
			<p class="source-code">CREATE TABLE users</p>
			<p class="source-code">(</p>
			<p class="source-code">    id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,</p>
			<p class="source-code">    email VARCHAR(254) NOT NULL UNIQUE,</p>
			<p class="source-code">    signup_time DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL</p>
			<p class="source-code">)</p>
			<p>In this statement, we point to the table name – <strong class="source-inline">users</strong>, with three columns, as follows:</p>
			<ul>
				<li><strong class="source-inline">id</strong>: An integer type; not null; a primary key with auto-incrementing; these constraints tell MySQL that the column is a primary key, meaning that it is unique in the table and will be used to identify unique records in the table. The <strong class="source-inline">AUTO_INCREMENT</strong> keyword tells MySQL that we want this value to be set automatically with an "auto-increment" value, which is the next higher integer after the last inserted record ID, when we do not specify it in our <strong class="source-inline">INSERT</strong> statements. This is helpful because we can execute <strong class="source-inline">INSERT</strong> statements without knowing which should be the next ID value.</li>
				<li><strong class="source-inline">email</strong>: A variable-length character type with a maximum length of 254; not null; and unique among the records. In respect to this rule, when inserting another record with the same "<strong class="source-inline">email</strong>" value, the statement will be rejected by MySQL Server and an error will be returned.</li>
				<li><strong class="source-inline">signup_time</strong>: A datetime type; defaulting to the current time; not null. Not specifying this value in the <strong class="source-inline">insert</strong> query will result in the current datetime value being set by MySQL Server.<p class="callout-heading">Warning</p><p class="callout">Be aware that the "current datetime" will be the value set using the MySQL Server time zone offset, which may differ from the application server. For example, when you deploy your application on a server from a data center that is located in a different time zone to yours, it is possible that the system time zone of the remote server is set to the local time zone offset. You may want to make sure that your server's settings do not apply time offset – using the UTC time zone, or you may want to use a timestamp value instead of a human-readable date.</p></li>
			</ul>
			<p>You can find the full syntax and more information at <a href="https://packt.live/2MAGloG">https://packt.live/2MAGloG</a>.</p>
			<h2 id="_idParaDest-285"><a id="_idTextAnchor292"/>Exercise 7.14: Creating the Table</h2>
			<p>In this exercise, we will learn how to select a database with PDO, and how to create a table using the <strong class="source-inline">PDO</strong> instance:</p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">create-table.php</strong> and insert the following code. What we do, after getting the <strong class="source-inline">PDO</strong> instance, is to define the <strong class="source-inline">CREATE TABLE</strong> statement:<p class="source-code">&lt;?php</p><p class="source-code">/** @var PDO $pdo */</p><p class="source-code">$pdo = require 'connection-no-db.php';</p><p class="source-code">$createStmt = "CREATE TABLE users</p><p class="source-code">(</p><p class="source-code">    id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,</p><p class="source-code">    email VARCHAR(254) NOT NULL UNIQUE,</p><p class="source-code">    signup_time DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL</p><p class="source-code">)";</p><p>After executing the statement, in the event of failure, the error message will be printed and execution or the script will stop. Otherwise, a success message will be printed to output:</p><p class="source-code">if ($pdo-&gt;exec($createStmt) === false) {</p><p class="source-code">    list(, , $driverErrMsg) = $pdo-&gt;errorInfo();</p><p class="source-code">    echo "Error creating the users table: $driverErrMsg" . PHP_EOL;</p><p class="source-code">    return;</p><p class="source-code">}</p><p class="source-code">echo "The users table was successfully created.";</p></li>
				<li>Run the script in the command-line interface with <strong class="source-inline">php create-table.php</strong>. Expect the following error output:<div class="IMG---Figure" id="_idContainer190"><img alt="Figure 7.17: Error in creating the table&#13;&#10;" src="image/C14196_07_17.jpg"/></div><p class="figure-caption">Figure 7.17: Error in creating the table</p><p>We get an error message, indicating that no database is selected. What we understand from this statement is that a MySQL server can store several databases, and, when executing a statement, we should indicate the database we want to run it into. To achieve this, we should either include the database name inside the SQL statements (for example, <strong class="source-inline">CREATE TABLE demo.users</strong> ...) or specify the database name inside DSN, before creating the connection to MySQL Server.</p></li>
				<li>Copy the <strong class="source-inline">connection-no-db.php</strong> file to <strong class="source-inline">connection.php</strong> and add the database name to DSN, inside the <strong class="source-inline">connection.php</strong> file. Replace the <strong class="source-inline">$dsn</strong> variable with the following value:<p class="source-code">$dsn = "mysql:host=mysql-host;port=3306;dbname=demo;charset=utf8mb4";</p><p class="callout-heading">Note </p><p class="callout">We will require this <strong class="source-inline">connection.php</strong> file further, in all exercises, to reuse the code instead of typing this block of code in every file where we use the database connection.</p></li>
				<li>Require the <strong class="source-inline">connection.php</strong> file in the <strong class="source-inline">create-table.php</strong> script, instead of <strong class="source-inline">connection-no-db.php</strong>:<p class="source-code">$pdo = require 'connection.php';</p></li>
				<li>Let's run our script once more: <strong class="source-inline">php create-table.php</strong>. Expect the following output:</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer191">
					<img alt="Figure 7.18: Creating tables successfully&#13;&#10;" src="image/C14196_07_18.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.18: Creating tables successfully</p>
			<p>Great! You successfully created the first table in the <strong class="source-inline">demo</strong> database.</p>
			<p>In this exercise, you learned how to select a database at connection time, and how to create a table in a SQL database. Notice that the queries begin with an action (<strong class="source-inline">CREATE</strong>) followed by the object type (schema/database or table), followed by the object definition where required. Also, you probably noticed that the column names are followed by the date type declaration (integer, string, date, and so on) and then by additional constraints (<strong class="source-inline">NOT NULL</strong>, <strong class="source-inline">PRIMARY KEY</strong>, <strong class="source-inline">UNIQUE</strong>, and so on). </p>
			<p>As you can see, SQL statements are pretty descriptive and easy to learn and remember. So, let's advance with more exciting examples!</p>
			<h2 id="_idParaDest-286"><a id="_idTextAnchor293"/>Inserting Data into a MySQL Database Table</h2>
			<p>Since we already know how to create a table in a MySQL database, let's add some data to it. </p>
			<p>Before inserting data into a table, we must craft the script in such a way that the data to be inserted will match the table's column definition. This means we will not be able to store strings in a column defined with an integer data type. In such cases, MySQL Server will reject the query and will respond with an error. Also bear in mind, since most of the data will come from user input, that you should always validate it before sending it to a database server, and, at the same time, escape it properly, so as to avoid another security issue, called SQL injection, covered later in the chapter. </p>
			<p>Standard <strong class="source-inline">INSERT</strong> statement syntax is as follows:</p>
			<p class="source-code">INSERT INTO tbl_name</p>
			<p class="source-code">  (col_name [, col_name] ...) </p>
			<p class="source-code">  VALUES (value_list) [, (value_list)] ...</p>
			<p>Where <strong class="source-inline">value_list</strong> is:</p>
			<p class="source-code">value [, value] ...</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The number of values specified in <strong class="source-inline">value_list</strong> should match the <strong class="source-inline">col_name</strong> count. The complete syntax of the <strong class="source-inline">INSERT</strong> statement can be found on the official documentation page at <a href="https://packt.live/32fXkmP">https://packt.live/32fXkmP</a>.</p>
			<p>An example <strong class="source-inline">INSERT</strong> query may appear as follows:</p>
			<p class="source-code">INSERT INTO employees (email, first_name, last_name)</p>
			<p class="source-code">  VALUES ('john.smith@mail.com','John','Smith'),</p>
			<p class="source-code">         ('jane.smith@mail.com','Jane','Smith')</p>
			<p>In this case, two rows will be inserted in the <strong class="source-inline">employees</strong> table, setting the values from <strong class="source-inline">VALUES</strong> to the corresponding position column from the column list; for example, <strong class="source-inline">john.smith@mail.com</strong> is assigned to the <strong class="source-inline">email</strong> column, and the <strong class="source-inline">John</strong> value is assigned to the <strong class="source-inline">first_name</strong> column.</p>
			<h2 id="_idParaDest-287"><a id="_idTextAnchor294"/>Exercise 7.15: Inserting Data into a Table</h2>
			<p>In this exercise, we will become familiar with the <strong class="source-inline">INSERT</strong> statement, learning how we can add data to a table:</p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">insert.php</strong>. After getting the <strong class="source-inline">PDO</strong> instance, we store the <strong class="source-inline">INSERT</strong> statement under the <strong class="source-inline">$insertStmt</strong> variable. This statement inserts the value <strong class="source-inline">john.smith@mail.com</strong> into the <strong class="source-inline">email</strong> column of the <strong class="source-inline">users</strong> table. We did not specify the ID value; therefore, it must be set automatically with the <strong class="source-inline">auto_increment</strong> value, which, for the first entry, would be <strong class="source-inline">1</strong>. We are also missing the <strong class="source-inline">signup_time</strong> column, which, by default, will set the time when the record was added. Add the following code to the <strong class="source-inline">insert.php</strong> file:<p class="source-code">&lt;?php</p><p class="source-code">/** @var PDO $pdo */</p><p class="source-code">$pdo = require 'connection.php';</p><p class="source-code">$insertStmt = "INSERT INTO users (email) VALUES ('john.smith@mail.com')";</p></li>
				<li>If the statement execution fails, the script will print the error message and will not continue further; otherwise, the success message will be printed, including the ID of the row that was just inserted, using the <strong class="source-inline">PDO::lastInsertId()</strong> method:<p class="source-code">if ($pdo-&gt;exec($insertStmt) === false) {</p><p class="source-code">    list(, , $driverErrMsg) = $pdo-&gt;errorInfo();</p><p class="source-code">    echo "Error inserting into the users table: $driverErrMsg" . PHP_EOL;</p><p class="source-code">    return;</p><p class="source-code">}</p><p class="source-code">echo "Successfully inserted into users table the record with id " .   $pdo-&gt;lastInsertId() . PHP_EOL;</p></li>
				<li>Run the script with <strong class="source-inline">php insert.php</strong>. The first output will be as follows:<div class="IMG---Figure" id="_idContainer192"><img alt="Figure 7.19: Inserting a record into the table&#13;&#10;" src="image/C14196_07_19.jpg"/></div><p class="figure-caption">Figure 7.19: Inserting a record into the table</p></li>
				<li>Run the script once more. Now, you should expect the following response in the output:<div class="IMG---Figure" id="_idContainer193"><img alt="Figure 7.20: Duplicate entry error&#13;&#10;" src="image/C14196_07_20.jpg"/></div><p class="figure-caption">Figure 7.20: Duplicate entry error</p><p>This proves that the previous script execution succeeded, and that the <strong class="source-inline">UNIQUE</strong> constraint in the email column is working as expected.</p></li>
				<li>Let's now look at the data in the <strong class="source-inline">users</strong> table, using the Workbench client:</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer194">
					<img alt="Figure 7.21: Checking the data in DB using the Workbench client&#13;&#10;" src="image/C14196_07_21.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.21: Checking the data in DB using the Workbench client</p>
			<p>As expected, we have a single row, with <strong class="source-inline">id = 1</strong>, <strong class="source-inline">john.smith@mail.com</strong> for the <strong class="source-inline">email</strong> column, and the signup time set by MySQL Server at the time of the row insertion.</p>
			<p>Congratulations on adding in the initial data to a database table! It was pretty easy. Now, knowing that we should work with user input, we must ensure that the script will run the queries in complete safety, avoiding SQL injection, which may lead to data leaks and system compromise.</p>
			<h2 id="_idParaDest-288"><a id="_idTextAnchor295"/>SQL Injection</h2>
			<p>So, what is SQL injection anyway? SQL injection is one of the most common vulnerabilities in the wild web nowadays. It is a technique used to steal data, gain control of users' accounts, or destroy a database, and is performed by sending malicious query chunks via HTML form inputs.</p>
			<p>To better understand this, here is a simple example of how you can drop a table using the SQL injection technique, given a query that accepts user input without sanitizing and/or validating it:</p>
			<p class="source-code">$rawInput = $_POST['email'];</p>
			<p class="source-code">$query = "INSERT INTO users (email) VALUES ($rawInput)";</p>
			<p>When the email input value is <strong class="source-inline">""); DROP TABLE users; /**</strong>, then the query will become: </p>
			<p class="source-code">INSERT INTO users (email) VALUES (""); DROP TABLE users; /**)</p>
			<p>What happens is easy to understand; the <strong class="source-inline">INSERT</strong> statement is executed, adding an empty value to the <strong class="source-inline">email</strong> column, and then the query to drop the table is executed, making the <strong class="source-inline">users</strong> table vanish, while the <strong class="source-inline">/**)</strong> part is ignored, since <strong class="source-inline">/**</strong> marks the beginning of a comment in a SQL query.</p>
			<h2 id="_idParaDest-289"><a id="_idTextAnchor296"/>Prepared Statements</h2>
			<p>In order to prevent SQL injection, we should escape the input data. PDO offers an alternative –so-called <strong class="source-inline">prepared statements</strong> (the <strong class="source-inline">PDOStatement</strong> class). These statements are templates and look like regular SQL queries, with the difference that, instead of values, they contain placeholders, which will be replaced with escaped values at execution time. The placeholders' mapping is done using the <strong class="source-inline">PDOStatement::bindParam()</strong> method, or by providing the mapping at execution time, as an argument of the <strong class="source-inline">PDOStatement::execute()</strong> method.</p>
			<p>There are two types of placeholders:</p>
			<ul>
				<li>Positional placeholders, <strong class="source-inline">?</strong> <p>Query example:</p><p class="source-code">INSERT INTO users (email) VALUES (?);</p></li>
				<li>Named placeholders, with names prepended with a colon, <strong class="source-inline">:</strong><p>Query example:</p><p class="source-code">INSERT INTO users (email) VALUES (:email);</p></li>
			</ul>
			<p>The use of prepared statements offers major benefits:</p>
			<ul>
				<li>The parameters of prepared statements should not be quoted, as this is handled by PDO automatically, while it will also handle the escaping of values when necessary. This means that you can be sure that no SQL injection is possible using prepared statements with placeholders.</li>
				<li>The query is sent and parsed only once by MySQL Server, meaning that the same statement can be executed many times, sending only the placeholders' data. This results in faster execution times and lower bandwidth usage.<p class="callout-heading">Note </p><p class="callout">By default, PDO will emulate prepared statements as support for databases that don't have this feature and, if you want to benefit from genuine prepared statements in MySQL Server, you should set <strong class="source-inline">PDO::ATTR_EMULATE_PREPARES</strong> to <strong class="source-inline">false</strong> in the connection options.</p></li>
			</ul>
			<p>Emulating prepared statements means that the query will not be sent to the server and checked when <strong class="source-inline">PDO::prepare()</strong> is invoked. Instead, PDO will escape the bind parameters from <strong class="source-inline">PDO::execute()</strong>, and will make the placeholders' replacements on its own. Then, the raw SQL query is sent to the database server, meaning that, this way, you do not benefit from performance optimizations that the database could carry out when using prepared statements that are then executed many times.</p>
			<h2 id="_idParaDest-290"><a id="_idTextAnchor297"/>Using Prepared Statements</h2>
			<p>To obtain a prepared statement, you must invoke the <strong class="source-inline">PDO::prepare()</strong> method, providing the statement as a first argument. The output is an instance of the <strong class="source-inline">PDOStatement</strong> class (the prepared statement), which is then used to bind parameters' values and execute the statement.</p>
			<p><strong class="source-inline">PDO::bindParam()</strong> is used to bind prepared statements' parameters, and has the following syntax:</p>
			<p class="source-code">PDOStatement::bindParam(mixed $parameter, mixed &amp;$variable [, int $data_type =   PDO::PARAM_STR [, int $length [, mixed $driver_options ]]])</p>
			<p>Accepted input parameters:</p>
			<ul>
				<li><strong class="source-inline">parameter</strong>: The parameter identifier; for a prepared statement using named placeholders, this will be a parameter name of the form <strong class="source-inline">:name</strong>. For a prepared statement using question mark placeholders, this will be the one-indexed position of the parameter.</li>
				<li><strong class="source-inline">variable</strong>: The name of the PHP variable to bind to the SQL statement parameter; be aware that this parameter is passed by reference, meaning that if we modify the variable before we execute the statement, the new value will be sent to the server when <strong class="source-inline">PDO::execute()</strong> is invoked.</li>
				<li><strong class="source-inline">data_type</strong>: The data type for the parameter using the <strong class="source-inline">PDO::PARAM_* </strong>constants; for example, <strong class="source-inline">PDO::PARAM_INT</strong>.</li>
				<li><strong class="source-inline">length</strong>: The length of the data type. To indicate that a parameter is an <strong class="source-inline">OUT</strong> parameter from a stored procedure, you must explicitly set the length.</li>
				<li><strong class="source-inline">driver_options</strong>: Self-explanatory.</li>
			</ul>
			<p>The <strong class="source-inline">PDO::bindParam()</strong> method returns <strong class="source-inline">true</strong> if successful, otherwise <strong class="source-inline">false</strong>.</p>
			<p>To execute the prepared statement, use the <strong class="source-inline">PDO::execute()</strong> method. The syntax is the following:</p>
			<p class="source-code">PDOStatement::execute([array $input_parameters])</p>
			<p>The only accepted parameter is an optional <strong class="source-inline">$input_parameters</strong> array with values for the statement placeholders. All values of the array are treated as <strong class="source-inline">PDO::PARAM_STR</strong>.</p>
			<p>This method returns <strong class="source-inline">true</strong> if successful, otherwise <strong class="source-inline">false</strong>.</p>
			<p>The following is a sample query using a prepared statement with positional placeholders:</p>
			<p class="source-code">$stmt = $pdo-&gt;prepare("INSERT INTO users (email) VALUES (?)");</p>
			<p class="source-code">$stmt-&gt;bindParam(1, $email);</p>
			<p class="source-code">$email = 'first@mail.com';</p>
			<p class="source-code">$stmt-&gt;execute();</p>
			<p class="source-code">$email = 'second@mail.com';</p>
			<p class="source-code">$stmt-&gt;execute();</p>
			<p>Or it can be written as follows:</p>
			<p class="source-code">$stmt = $pdo-&gt;prepare("INSERT INTO users (email) VALUES (?)");</p>
			<p class="source-code">$stmt-&gt;execute(['first@mail.com']);</p>
			<p class="source-code">$stmt-&gt;execute(['second@mail.com']);</p>
			<p>The following is a sample query using a prepared statement with named placeholders:</p>
			<p class="source-code">stmt = $pdo-&gt;prepare("INSERT INTO users (email) VALUES (:email)");</p>
			<p class="source-code">$stmt-&gt;bindParam(':email', $email);</p>
			<p class="source-code">$email = 'first@mail.com';</p>
			<p class="source-code">$stmt-&gt;execute();</p>
			<p class="source-code">$email = 'second@mail.com';</p>
			<p class="source-code">$stmt-&gt;execute();</p>
			<p>Or it could be written as follows: </p>
			<p class="source-code">$stmt = $pdo-&gt;prepare("INSERT INTO users (email) VALUES (:email)");</p>
			<p class="source-code">$stmt-&gt;bindParam(':email', $email);</p>
			<p class="source-code">$stmt-&gt;execute([':email' =&gt; 'first@mail.com']);</p>
			<p class="source-code">$stmt-&gt;execute([':email' =&gt; 'second@mail.com']);</p>
			<p>Notice that the <strong class="source-inline">$email</strong> variable is assigned to the <strong class="source-inline">:email</strong> placeholder only once, while its data changes twice, each change being followed by the execution of the statement. Each statement will send the current value of the <strong class="source-inline">$email</strong> variable, at that point of execution, this being possible as a result of using the variable reference in the <strong class="source-inline">PDO::bindParam()</strong> method, rather than passing the variable by value.</p>
			<h2 id="_idParaDest-291"><a id="_idTextAnchor298"/>Exercise 7.16: Inserting Data Using Prepared Statements</h2>
			<p>In this exercise, you will create a script that inserts new user emails from user input, using prepared statements:</p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">insert-prepared.php</strong> and add the following code. As before, we get the <strong class="source-inline">PDO</strong> instance, and then its <strong class="source-inline">prepare()</strong> method, providing the query template. In return, we get an instance of <strong class="source-inline">PDOStatement</strong>, which we store in the <strong class="source-inline">$insertStmt</strong> variable:<p class="source-code">&lt;?php</p><p class="source-code">/** @var PDO $pdo */</p><p class="source-code">$pdo = require 'connection.php';</p><p class="source-code">$insertStmt = $pdo-&gt;prepare("INSERT INTO users (email) VALUES (:email)");</p></li>
				<li>Then, we invoke the <strong class="source-inline">execute()</strong> method of <strong class="source-inline">PDOStatement</strong>, providing the placeholder-value map. In this case, the value will be the first argument provided to the script at execution time. We check the result and, if unsuccessful, an error message is printed and the execution of the script stops. Otherwise, a successful message is printed:<p class="source-code">if ($insertStmt-&gt;execute([':email' =&gt; $argv[1] ?? null]) === false) {</p><p class="source-code">    list(, , $driverErrMsg) = $insertStmt-&gt;errorInfo();</p><p class="source-code">    echo "Error inserting into the users table: $driverErrMsg" . PHP_EOL;</p><p class="source-code">    return;</p><p class="source-code">}</p><p class="source-code">echo "Successfully inserted into users table" . PHP_EOL;</p></li>
				<li>Run the script with <strong class="source-inline">php insert-prepared.php john.smith@mail.com</strong>. The output should be as follows:<div class="IMG---Figure" id="_idContainer195"><img alt="Figure 7.22: Duplicate entry error&#13;&#10;" src="image/C14196_07_22.jpg"/></div><p class="figure-caption">Figure 7.22: Duplicate entry error</p><p>This is an expected error, because we have already added this email before, and the <strong class="source-inline">UNIQUE</strong> keyword ensures that no other entries will be added that have the same email address. For a table definition, please refer to <em class="italic">Exercise 7.14</em>, <em class="italic">Creating the Table</em>.</p></li>
				<li>Run the script with <strong class="source-inline">php insert-prepared.php jane.smith@mail.com</strong>. This time, you should expect an output message similar to this:<div class="IMG---Figure" id="_idContainer196"><img alt="Figure 7.23: Record inserted&#13;&#10;" src="image/C14196_07_23.jpg"/></div><p class="figure-caption">Figure 7.23: Record inserted</p><p>Let's check the records using Workbench:</p><div class="IMG---Figure" id="_idContainer197"><img alt="Figure 7.24: Records displayed by Workbench&#13;&#10;" src="image/C14196_07_24.jpg"/></div><p class="figure-caption">Figure 7.24: Records displayed by Workbench</p><p>It looks good. You have successfully run a prepared statement with PDO. You will notice that the ID of <strong class="source-inline">jane.smith@mail.com</strong> is not <strong class="source-inline">2</strong>, but <strong class="source-inline">5</strong>. This is because the prepared statements that ran before, even the failed ones, increased the <strong class="source-inline">AUTO_INCREMENT</strong> value. </p></li>
				<li>Let's check the protection against SQL injection by running the script that includes the malicious query chunk: <p class="source-code">php insert-prepared.php '""); DROP TABLE users; /**' </p><p>The output is similar to this:</p></li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer198">
					<img alt="Figure 7.25: Record inserted&#13;&#10;" src="image/C14196_07_25.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.25: Record inserted</p>
			<p>Let's check the results using Workbench:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer199">
					<img alt="Figure 7.26: Displaying all records with the Workbench client&#13;&#10;" src="image/C14196_07_26.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.26: Displaying all records with the Workbench client</p>
			<p>They look good. We are protected against SQL injection, but ended up with corrupt data, since the input was not validated nor sanitized before the query ran. Please refer to the <em class="italic">Sanitizing and Validating the User Input</em> section of <em class="italic">Chapter 6</em>, <em class="italic">Using HTTP</em>.</p>
			<h2 id="_idParaDest-292"><a id="_idTextAnchor299"/>Fetching Data from MySQL</h2>
			<p>So far, you have learned how to create a database and a table, and also how to insert data into tables, in a secure manner. Now, it's time to fetch and display some data using PHP.</p>
			<p>To accomplish this, we use the <strong class="source-inline">SELECT</strong> statement, which has the following minimal syntax:</p>
			<p class="source-code">SELECT column1 [, column2 …] FROM table</p>
			<p>The preceding query would return all the records from the table since no limitation is set. It is therefore recommended (if not mandatory in some cases) to use the <strong class="source-inline">LIMIT</strong> clause in one of its forms:</p>
			<ul>
				<li><strong class="source-inline">LIMIT row_count</strong>: will return the first <strong class="source-inline">row_count</strong> rows</li>
				<li><strong class="source-inline">LIMIT offset</strong>, <strong class="source-inline">row_count</strong>: will return <strong class="source-inline">row_count</strong> rows starting with the <strong class="source-inline">offset</strong> position (for example, <strong class="source-inline">LIMIT 20, 10</strong> will return <strong class="source-inline">10</strong> rows starting with position <strong class="source-inline">20</strong>; another example, <strong class="source-inline">LIMIT 0, 10</strong> is equivalent to <strong class="source-inline">LIMIT 10</strong>, since the offset is zero by default)</li>
				<li><strong class="source-inline">LIMIT row_count OFFSET</strong> <strong class="source-inline">offset</strong>: identical to <strong class="source-inline">LIMIT</strong> <strong class="source-inline">offset</strong>, <strong class="source-inline">row_count</strong> </li>
			</ul>
			<p>A part of the <strong class="source-inline">LIMIT</strong> clause, the <strong class="source-inline">SELECT</strong> statement is rich in clauses that can be used to filter, join, group, or sort data. You can check the <strong class="source-inline">SELECT</strong> statement syntax of the official documentation page at <a href="https://dev.mysql.com/doc/refman/5.7/en/select.html">https://dev.mysql.com/doc/refman/5.7/en/select.html</a>.</p>
			<p>A very simple <strong class="source-inline">SELECT</strong> statement looks like this:</p>
			<p class="source-code">SELECT * FROM employees LIMIT 10;</p>
			<p>This statement queries the first 10 records from the <strong class="source-inline">employees</strong> table.</p>
			<p class="callout-heading">Note </p>
			<p class="callout">Using an asterisk, <strong class="source-inline">*</strong>, instead of column names in <strong class="source-inline">SELECT</strong> statements will make MySQL perform an additional lookup query to retrieve the column list of the queried table, and replace the <strong class="source-inline">*</strong> in the original query with this list of columns. This has a performance impact on SQL queries, which is not significant for low-traffic applications; yet it is considered good practice to specify the column list instead of <strong class="source-inline">*</strong>, irrespective of the project size or the estimated traffic load. </p>
			<p>Now, let's examine, step by step, how we can get the data we want from a MySQL database, using various examples.</p>
			<h2 id="_idParaDest-293"><a id="_idTextAnchor300"/>Exercise 7.17: Fetching Data from MySQL</h2>
			<p>In this exercise, you will learn how you can query data from a MySQL database in the most simplistic way, getting a slice of records in the result set, filtering the data, and ordering the data by a specific column:</p>
			<ol>
				<li value="1">Create the <strong class="source-inline">select-all.php</strong> file and add the following code. We get the <strong class="source-inline">PDO</strong> instance and store the <strong class="source-inline">SELECT</strong> query in the <strong class="source-inline">$statement</strong> variable. Then, we invoke the <strong class="source-inline">query()</strong> method of the <strong class="source-inline">PDO</strong> object instance, and will either get as output a Boolean <strong class="source-inline">false</strong>, in the event of failure, or an instance of <strong class="source-inline">PDOStatement</strong> if successful:<p class="source-code">&lt;?php</p><p class="source-code">/** @var PDO $pdo */</p><p class="source-code">$pdo = require 'connection.php';</p><p class="source-code">$statement = "SELECT * FROM users";</p><p class="source-code">$result = $pdo-&gt;query($statement);</p></li>
				<li>In the event of a query failure, we print the error message and interrupt the script execution. Otherwise, we print the <strong class="source-inline">All records</strong> line and iterate over all the result set records and print them, joining the record data using the tab delimiter:<p class="source-code">if ($result === false) {</p><p class="source-code">    list(, , $driverErrMsg) = $pdo-&gt;errorInfo();</p><p class="source-code">    echo "Error querying the users table: $driverErrMsg" . PHP_EOL;</p><p class="source-code">    return;</p><p class="source-code">}</p><p class="source-code">echo "All records" . PHP_EOL;</p><p class="source-code">while ($record = $result-&gt;fetch()) {</p><p class="source-code">    echo implode("\t", $record) . PHP_EOL;</p><p class="source-code">}</p></li>
				<li>We repeat the operation with a slightly modified query, adding the <strong class="source-inline">LIMIT</strong> clause (and, without checking for query failure anymore), and we then print the <strong class="source-inline">Use LIMIT 2</strong> line followed by all the records in the result set:<p class="source-code">$result = $pdo-&gt;query("SELECT * FROM users LIMIT 2");</p><p class="source-code">echo PHP_EOL . "Use LIMIT 2" . PHP_EOL;</p><p class="source-code">while ($record = $result-&gt;fetch()) {</p><p class="source-code">    echo implode("\t", $record) . PHP_EOL;</p><p class="source-code">}</p></li>
				<li>We run another query, using the <strong class="source-inline">WHERE</strong> clause to filter the result set and only return the records with an ID value greater than <strong class="source-inline">3</strong>. Then, we print the <strong class="source-inline">Use WHERE id &gt; 3</strong> line followed by all the records in the result set:<p class="source-code">$result = $pdo-&gt;query("SELECT * FROM users WHERE id &gt; 3");</p><p class="source-code">echo PHP_EOL . "Use WHERE id &gt; 3" . PHP_EOL;</p><p class="source-code">while ($record = $result-&gt;fetch()) {</p><p class="source-code">    echo implode("\t", $record) . PHP_EOL;</p><p class="source-code">}</p></li>
				<li>Lastly, we run one more query, using the <strong class="source-inline">ORDER BY</strong> clause to sort the output by the <strong class="source-inline">id</strong> column in descending order. We print the <strong class="source-inline">Use ORDER BY id DESC</strong> line, followed by all the records in the result set:<p class="source-code">$result = $pdo-&gt;query("SELECT * FROM users ORDER BY id DESC");</p><p class="source-code">echo PHP_EOL . "Use ORDER BY id DESC" . PHP_EOL;</p><p class="source-code">while ($record = $result-&gt;fetch()) {</p><p class="source-code">    echo implode("\t", $record) . PHP_EOL;</p><p class="source-code">}</p><p class="callout-heading">Note</p><p class="callout">The final file can be referred at <a href="https://packt.live/31daUWP">https://packt.live/31daUWP</a>.</p></li>
				<li>Run the script with <strong class="source-inline">php select-all.php</strong>. Expect the following output:</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer200">
					<img alt="Figure 7.27: Fetching the records using different conditions&#13;&#10;" src="image/C14196_07_27.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.27: Fetching the records using different conditions</p>
			<p>Congratulations! You successfully fetched data from the MySQL database in different ways: sorting, filtering, and slicing the entire data in the table.</p>
			<p>By now, we have got a glimpse into the power of a database. This is just the beginning.</p>
			<h2 id="_idParaDest-294"><a id="_idTextAnchor301"/>Updating Records in MySQL</h2>
			<p>To update records in MySQL, the <strong class="source-inline">UPDATE</strong> statement is used. This is usually used together with the <strong class="source-inline">WHILE</strong> clause to filter the rows to which the update is applied.</p>
			<p class="callout-heading">Warning</p>
			<p class="callout">Not using <strong class="source-inline">WHERE</strong> in an <strong class="source-inline">UPDATE</strong> statement will cause the update to apply to all records in the table.</p>
			<p>The <strong class="source-inline">PDOStatement::rowCount()</strong> method returns the number of rows affected by the last <strong class="source-inline">INSERT</strong>, <strong class="source-inline">UPDATE</strong>, or <strong class="source-inline">DELETE</strong> statement executed by the corresponding <strong class="source-inline">PDOStatement</strong> object.</p>
			<h2 id="_idParaDest-295"><a id="_idTextAnchor302"/>Exercise 7.18: Updating Records in MySQL</h2>
			<p>In this exercise, you will learn how to perform an update to a MySQL database <strong class="source-inline">users</strong> table, setting the email <strong class="source-inline">john.doe@mail.com</strong> for a record with incorrect data in the email column (ID 6 in our case):</p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">update.php</strong> and add the following code. First, we get the <strong class="source-inline">PDO</strong> instance and update parameters. We need the record <strong class="source-inline">id</strong>, which has to be updated, and this value will be retrieved from the first input argument of the script, defaulting to <strong class="source-inline">0</strong> (zero). We also need the updated value for the <strong class="source-inline">email</strong> column, which will be retrieved from the second input argument of the script. Note that these values can be retrieved from the <strong class="source-inline">$_POST</strong> superglobal, when the update action is performed using an HTML form in a web page:<p class="source-code">&lt;?php</p><p class="source-code">/** @var PDO $pdo */</p><p class="source-code">$pdo = require 'connection.php';</p><p class="source-code">$updateId = $argv[1] ?? 0;</p><p class="source-code">$updateEmail = $argv[2] ?? '';</p></li>
				<li>Then, we prepare the <strong class="source-inline">UPDATE</strong> statement using two placeholders – <strong class="source-inline">id</strong> and <strong class="source-inline">email</strong>:<p class="source-code">$updateStmt = $pdo-&gt;prepare("UPDATE users SET email = :email WHERE   id = :id");</p></li>
				<li>We execute the <strong class="source-inline">UPDATE</strong> statement, providing the placeholders' values map in an argument, and test the result; if unsuccessful, the error message will be displayed and the script will return (ending the execution). Otherwise, the success message is displayed:<p class="source-code">if ($updateStmt-&gt;execute([':id' =&gt; $updateId, ':email' =&gt; $updateEmail])   === false) {</p><p class="source-code">    list(, , $driverErrMsg) = $updateStmt-&gt;errorInfo();</p><p class="source-code">    echo "Error running the query: $driverErrMsg" . PHP_EOL;</p><p class="source-code">    return;</p><p class="source-code">}</p><p class="source-code">echo sprintf("The query ran successfully. %d row(s) were affected.",   $updateStmt-&gt;rowCount()) . PHP_EOL;</p></li>
				<li>Run the script with <strong class="source-inline">php update.php 6 john.doe@mail.com</strong> and check the result. The expected output is as follows:<div class="IMG---Figure" id="_idContainer201"><img alt="Figure 7.28: Updating a record&#13;&#10;" src="image/C14196_07_28.jpg"/></div><p class="figure-caption">Figure 7.28: Updating a record</p></li>
				<li>Let's check the result in Workbench:<div class="IMG---Figure" id="_idContainer202"><img alt="Figure 7.29: Displaying database table data using the Workbench client&#13;&#10;" src="image/C14196_07_29.jpg"/></div><p class="figure-caption">Figure 7.29: Displaying database table data using the Workbench client</p><p>The email for the record with the <strong class="source-inline">id</strong> 6 was changed to the value provided. It looks great! Note that if you have another <strong class="source-inline">id</strong> for the record with incorrect data in the <strong class="source-inline">email</strong> field, then you should use that <strong class="source-inline">id</strong> in <em class="italic">step 2</em> when running the command.</p></li>
				<li>Now, let's see what happens when we run the <strong class="source-inline">UPDATE</strong> query for an <strong class="source-inline">ID</strong> that does not exist: <p class="source-code">php update.php 16 john.doe@mail.com; </p><p>Expect the following output:</p></li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer203">
					<img alt="Figure 7.30: Output of the UPDATE query&#13;&#10;" src="image/C14196_07_30.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.30: Output of the UPDATE query</p>
			<p>We end up with no row being affected by this query, and the logic seems pretty straightforward: the <strong class="source-inline">UPDATE</strong> statement filters the rows to update, using the conditions from the <strong class="source-inline">WHERE</strong> clause; in our case, filtering by <strong class="source-inline">id=16</strong> resulted in no rows qualifying for an update.</p>
			<p class="callout-heading">Note </p>
			<p class="callout">Trying to update a record column value with the same, identical value will result in no count for the affected row aggregation; in other words, <strong class="source-inline">PDOStatement::rowCount()</strong> will return <strong class="source-inline">0</strong> (zero).</p>
			<h2 id="_idParaDest-296"><a id="_idTextAnchor303"/>Deleting Records from MySQL</h2>
			<p>To delete records from MySQL, we should use the <strong class="source-inline">DELETE</strong> statement. This is often (if not always) used together with the <strong class="source-inline">WHERE</strong> clause to indicate matching records to delete.</p>
			<p class="callout-heading">Warning</p>
			<p class="callout">Failure to provide the <strong class="source-inline">WHERE</strong> clause in a <strong class="source-inline">DELETE</strong> statement will cause all records to be deleted from the table.</p>
			<p>Usually, in the <strong class="source-inline">WHERE</strong> clause of a <strong class="source-inline">DELETE</strong> statement, the id columns are used. This is the case when a precisely indicated row is deleted. But the <strong class="source-inline">WHERE</strong> clause can be used to its full potential in <strong class="source-inline">DELETE</strong> statements as well. Let's say we want to delete records using a partial match for string columns. To achieve this, we will use the <strong class="source-inline">LIKE</strong> operator, which is simple, yet powerful, pattern matching. With this operator, we can use two wildcards:</p>
			<ul>
				<li><strong class="source-inline">_</strong> (underscore): matches exactly one character </li>
				<li><strong class="source-inline">%</strong> (percent): matches any number of characters, including no characters</li>
			</ul>
			<p>For example, <strong class="source-inline">LIKE</strong> <strong class="source-inline">php_</strong> will match the <strong class="source-inline">php7</strong> column value but will not match <strong class="source-inline">php</strong> or <strong class="source-inline">php70</strong>.</p>
			<p>On the other hand, <strong class="source-inline">LIKE</strong> "<strong class="source-inline">php7%</strong>" will match <strong class="source-inline">php7</strong>, <strong class="source-inline">php70</strong>, but will not match <strong class="source-inline">php</strong>.</p>
			<p>To know how many records were deleted, we will use the <strong class="source-inline">PDOStatement::rowCount()</strong> method mentioned before.</p>
			<h2 id="_idParaDest-297"><a id="_idTextAnchor304"/>Exercise 7.19: Deleting Records from MySQL</h2>
			<p>In this exercise, you will learn how to delete records from MySQL using a partial match in the <strong class="source-inline">WHERE</strong> clause: </p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">delete.php</strong>.</li>
				<li>First, we get the <strong class="source-inline">PDO</strong> instance, as usual, then retrieve the string to match from the input argument, and then we prepare the <strong class="source-inline">DELETE</strong> statement using the <strong class="source-inline">:partialMatch</strong> placeholder:<p class="source-code">&lt;?php</p><p class="source-code">/** @var PDO $pdo */</p><p class="source-code">$pdo = require 'connection.php';</p><p class="source-code">$partialMatch = $argv[1] ?? '';</p><p class="source-code">$deleteStmt = $pdo-&gt;prepare("DELETE FROM users WHERE   email LIKE :partialMatch");</p></li>
				<li>We then execute the statement by passing the string from input and, in the event of an execution failure, we print the error message. Note that the <strong class="source-inline">:partialMatch</strong> pattern value is the <strong class="source-inline">$partialMatch</strong> variable value enclosed with <strong class="source-inline">%</strong>, meaning we will look for a match anywhere in the column value, be it at the beginning, the end, or somewhere inside the string value:<p class="source-code">if ($deleteStmt-&gt;execute([':partialMatch' =&gt; "%$partialMatch%"]) ===   false) {</p><p class="source-code">    list(, , $driverErrMsg) = $deleteStmt-&gt;errorInfo();</p><p class="source-code">    echo "Error deleting from the users table: $driverErrMsg" . PHP_EOL;</p><p class="source-code">    return;</p><p class="source-code">}</p></li>
				<li>If the statement executed successfully, then we want to know how many records were affected (deleted), and we will use the <strong class="source-inline">PDOStatement::rowCount()</strong> method for that. We store the value inside the <strong class="source-inline">$rowCount</strong> variable for further usage, and evaluate its value. If the value is <strong class="source-inline">0</strong> (zero), it means no records were deleted, and an appropriate message will be printed to output, including the lookup term (the partial match string). Otherwise, the success message will be printed, indicating the number of rows deleted for the lookup term:<p class="source-code">if($rowCount = $deleteStmt-&gt;rowCount()){</p><p class="source-code">    echo sprintf("Successfully deleted %d records matching '%s' from users       table.", $rowCount, $partialMatch) . PHP_EOL;</p><p class="source-code">} else {</p><p class="source-code">    echo sprintf("No records matching '%s' were found in users table.",       $partialMatch) . PHP_EOL;</p><p class="source-code">}</p><p class="callout-heading">Note</p><p class="callout">The full script can be referred at <a href="https://packt.live/2MCeswE">https://packt.live/2MCeswE</a>.</p></li>
				<li>Run the file with <strong class="source-inline">php delete.php smith</strong>, and expect the following output:<div class="IMG---Figure" id="_idContainer204"><img alt="Figure 7.31: Deleting records&#13;&#10;" src="image/C14196_07_31.jpg"/></div><p class="figure-caption">Figure 7.31: Deleting records</p></li>
				<li>Run the preceding command once again. Now, you should expect the following output:<div class="IMG---Figure" id="_idContainer205"><img alt="Figure 7.32: Error deleting data&#13;&#10;" src="image/C14196_07_32.jpg"/></div><p class="figure-caption">Figure 7.32: Error deleting data</p></li>
				<li>Check the records using Workbench:</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer206">
					<img alt="Figure 7.33: Displaying database table data using the Workbench client&#13;&#10;" src="image/C14196_07_33.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.33: Displaying database table data using the Workbench client</p>
			<p>All the records matching <strong class="source-inline">smith</strong> have gone.</p>
			<p>You successfully completed the deletion of records from the database table by matching them using the <strong class="source-inline">LIKE</strong> operator. For a complete list of operators, refer at <a href="https://packt.live/2OHMB0B">https://packt.live/2OHMB0B</a>.</p>
			<h2 id="_idParaDest-298"><a id="_idTextAnchor305"/>The Singleton Pattern</h2>
			<p>The <strong class="bold">singleton pattern</strong> is a software design pattern that limits the instantiation of a class to a single instance. The idea of this pattern is to make the class itself responsible for its instantiation, which can be achieved by hiding the constructor method (for example, changing its visibility to <strong class="source-inline">private</strong>) and by defining a public static method that returns the sole instance of the class.</p>
			<p>This is useful when precisely one object (the first instance) is needed to perform actions across the application. For a database connection class, this is particularly useful since it does not only limit multiple instantiations of the class but also avoids repetitive connection and disconnection operations with the MySQL Server, making the first established connection available across the application for the lifetime of a single request-response cycle.</p>
			<p>To test (or demonstrate) the singleton implementation in PHP, a simple script file would be sufficient:</p>
			<p class="source-code-heading">DatabaseSingleton.php</p>
			<p class="source-code">1  &lt;?php</p>
			<p class="source-code">2 </p>
			<p class="source-code">3  class DatabaseSingleton</p>
			<p class="source-code">4 {</p>
			<p class="source-code">5      private function __construct()</p>
			<p class="source-code">6      {</p>
			<p class="source-code">7          //$this-&gt;pdo = new PDO(...);</p>
			<p class="source-code">8      }</p>
			<p class="source-code">9 </p>
			<p class="source-code">10     public static function instance()</p>
			<p class="source-code">11     {</p>
			<p class="source-code">12         static $instance;</p>
			<p class="source-code">13         if (is_null($instance)) {</p>
			<p class="source-code">14             $instance = new static;</p>
			<p class="source-code">15         }</p>
			<p class="source-code">16         return $instance;</p>
			<p class="source-code">17     }</p>
			<p class="source-code">18 }</p>
			<p class="source-code-link"><a href="https://packt.live/35w4dCz">https://packt.live/35w4dCz</a></p>
			<p>Running the preceding script would always return the following:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer207">
					<img alt="Figure 7.34: Screenshot of the output&#13;&#10;" src="image/C14196_07_34.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.34: Screenshot of the output</p>
			<p class="callout-heading">Note </p>
			<p class="callout">When comparing objects using the identity operator (<strong class="source-inline">===</strong>), object variables are identical if, and only if, they refer to the same instance of the same class.</p>
			<p>So far in this chapter, you have learned how to use a database, starting with the connection, creating a database and tables, before moving on to adding, querying, updating, and deleting records, and then to securing queries by using prepared statements and anonymous or named placeholders. Undoubtedly, MySQL has much more to offer—it merits an entire book, but the essentials were all briefly covered here.</p>
			<h2 id="_idParaDest-299"><a id="_idTextAnchor306"/>Activity 7.1: Contact Management Application</h2>
			<p>You are required to build a website where users can create an account and then log in to manage a private list of contacts. The website will make use of databases to store user login data, as well as to store each user's contacts.</p>
			<p>Along with the database functionality that you have learned in this chapter, you will be required to use functionality from previous chapters in order to build the website (for example, conditionals from <em class="italic">Chapter 3</em>, <em class="italic">Control Statements</em>; functions from <em class="italic">Chapter 4</em>, <em class="italic">Functions</em>; OOP from <em class="italic">Chapter 5</em>, <em class="italic">Object-Oriented Programming</em>; and form validation from <em class="italic">Chapter 6</em>, <em class="italic">Using HTTP</em>). You may need to refer to previous chapters for a reminder of how to implement the required functionality.</p>
			<p>The required pages are as follows:</p>
			<ul>
				<li>Home page</li>
				<li>Login and Sign up pages</li>
				<li>Profile page</li>
				<li>Contacts list and add/edit contact form page</li>
			</ul>
			<p><strong class="bold">Layout and Briefing</strong></p>
			<p>The layout is as shown: </p>
			<ul>
				<li>The home page</li>
			</ul>
			<div>
				<div class="IMG---Figure" id="_idContainer208">
					<img alt="Figure 7.35: Home page layout&#13;&#10;" src="image/C14196_07_35.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.35: Home page layout</p>
			<p>There is a horizontal navigation bar at the top of the page, featuring the website title on the left, and the <strong class="source-inline">Login</strong> button on the right. After a successful login, the <strong class="source-inline">Login</strong> button will be replaced by the username, which will link to the Profile page, the Contacts page link, and the Logout link.</p>
			<p>The content is a message with two call-to-action links: <strong class="source-inline">Sign up</strong> and <strong class="source-inline">Login</strong>.</p>
			<p>The Login page will look as follows:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer209">
					<img alt="Figure 7.36: Authentication layout&#13;&#10;" src="image/C14196_07_36.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.36: Authentication layout</p>
			<p>The login is based on the username and password, so the content is a simple login form, with <strong class="source-inline">Username</strong> and <strong class="source-inline">Password</strong> fields, and a <strong class="source-inline">Login</strong> button. The last sentence is a <strong class="source-inline">Sign up</strong> call-to-action link.</p>
			<p>After logging in, the user is redirected to the <strong class="source-inline">Profile</strong> page.</p>
			<p>The Sign up page will look as follows:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer210">
					<img alt="Figure 7.37: Sign up page layout&#13;&#10;" src="image/C14196_07_37.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.37: Sign up page layout</p>
			<p>The content is the <strong class="source-inline">Sign up</strong> form, with the following inputs:</p>
			<ul>
				<li><strong class="source-inline">Username</strong></li>
				<li><strong class="source-inline">Password</strong></li>
				<li><strong class="source-inline">Password</strong><strong class="bold"> verify</strong></li>
			</ul>
			<p>The username is required to be at least three characters long, and just alphanumeric. The password should be at least six characters long and should be verified by a second password input at signup. Any form error should be displayed under the input where the data came from, for example:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer211">
					<img alt="Figure 7.38: Validation error&#13;&#10;" src="image/C14196_07_38.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.38: Validation error</p>
			<p>The registered accounts should also retain the signup date. After signing up, the user is redirected to the Profile page:</p>
			<p>The Profile page will look as follows:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer212">
					<img alt="Figure 7.39: Profile page layout&#13;&#10;" src="image/C14196_07_39.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.39: Profile page layout</p>
			<p>This will contain a greeting, the profile data, and the session login time. While the username and signup date are stored in the database, the session login time can be stored in the current session.</p>
			<p>The Contacts page will look as follows:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer213">
					<img alt="Figure 7.40: Contact page layout&#13;&#10;" src="image/C14196_07_40.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.40: Contact page layout</p>
			<p>The content is split into two: the contacts list and the contact add/edit form:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer214">
					<img alt="Figure 7.41: Edit and delete options for data&#13;&#10;" src="image/C14196_07_41.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.41: Edit and delete options for data</p>
			<p>The contacts list will list the contact records, each record having the <strong class="source-inline">Edit</strong> and <strong class="source-inline">Delete</strong> links. If the list is empty, then display the appropriate message instead of rendering the empty table.</p>
			<p>The contact form will have the following field names:</p>
			<ul>
				<li><strong class="source-inline">Name</strong>: required; at least two characters</li>
				<li><strong class="source-inline">Phone</strong>: optional; must only allow <strong class="source-inline">+-() 1234567890</strong></li>
				<li><strong class="source-inline">Email</strong>: required; must be validated</li>
				<li><strong class="source-inline">Address</strong>: optional; maximum 255 characters<p>It should look similar to the following:</p></li>
			</ul>
			<div>
				<div class="IMG---Figure" id="_idContainer215">
					<img alt="Figure 7.42: Contact form&#13;&#10;" src="image/C14196_07_42.jpg"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.42: Contact form</p>
			<p>Error messages for invalid data should be placed under the inputs from which the data emanated.</p>
			<p>Accessing the Contacts page, the form is ready to use to create new contacts. Once the <strong class="bold">Edit</strong> button of a contact is pressed, then the contact info will be filled in the form; submitting the form updates the existing contact.</p>
			<p>When an authenticated user accesses the Home page, Login page, or Sign up page, they will be redirected to the Profile page.</p>
			<p>The default page title is <strong class="source-inline">Contacts list</strong>.</p>
			<p>Now, where should you start? While, in most cases, frameworks are used to simplify the "getting started" process of each project, and since we will cover the frameworks in a later chapter, let's stick with our bootstrap example. Therefore, let's have the previous activity as a starting point for this one (please refer to the activity in <em class="italic">Chapter 6</em>, <em class="italic">Using</em> <em class="italic">HTTP</em>). Since the code of the current activity will change, you may want to create a copy of the code from the previous activity.</p>
			<p>That having been said, I'll give you some guidelines here and there.</p>
			<p><strong class="bold">Steps to perform</strong>:</p>
			<p>Let's see what is needed for the new requirements, compared to the previous activity: </p>
			<ol>
				<li value="1">First, there are some new pages, such as Sign up and the Con<a id="_idTextAnchor307"/>tacts list page, that require a template and the request handler (the function that will handle the HTTP requests for a particular URI).  </li>
				<li>The Sign up handler will redirect authenticated users to the Profile page. Otherwise, it will print the signup form template and, in the case of a <strong class="source-inline">POST</strong> request, will handle the form. After successful signup, the user is authenticated and redirected to the Profile page.</li>
				<li>The Contacts handler first checks whether there is an authenticated user on the website; if not, it sends them the login form. This handler will print the current list of contacts and the Contact add/edit form. Also, this handler will be responsible for processing the submitted contact form data, and for deleting contact entries as well. </li>
				<li>To ensure this new functionality, a database is necessary, so it would be appropriate to use PDO with MySQL RDBMS; perhaps consider using a database component, to keep the <strong class="source-inline">PDO</strong> instance, and perform specific <strong class="source-inline">PDO</strong> operations in dedicated methods (functions). </li>
				<li>Since authentication is performed during login and after signup, now would be a good time to save the data authentication in a single place, such as a new component that we can call <strong class="source-inline">Auth</strong>, which may take care of other commonly used authentication-related tasks. The <strong class="source-inline">Auth</strong> component would deal mainly with the PHP session, setting the authenticated user ID and login timestamp in the session, getting the session login timestamp from the session, getting the user based on the user ID stored in the current session, and other authentication-related tasks.</li>
				<li>Then, since we will have to use a user's data across the website, it would probably be a good idea to create a model class (for example, <strong class="source-inline">User</strong>); this will contain a single row of data from the database, and may bundle some related functionality (such as checking the input password against the existing password hash). We will have the contacts in the database as well, but since we're only printing the contacts in a table or form, without using them for anything more across the website, maybe we can skip the Contact model. </li>
				<li>On top of this, some handlers will require some refactoring; for example, in the login handler, the data source should be changed, from an inline-defined array to a database. In the profile handler, all the profile picture lists and upload functionality will go away, together with the Support contact functionality – now, it will be a simple page displaying a user's data from the database. </li>
			</ol>
			<p>Here are the steps to perform the activity: </p>
			<ol>
				<li value="1"><strong class="source-inline">Create</strong> the new page templates – the Sign up and Contacts list pages.</li>
				<li>Create the request handlers for the Sign up and Contact pages.</li>
				<li>Add the <strong class="source-inline">Database</strong> component, where the <strong class="source-inline">PDO</strong> object will be invoked to operate with the MySQL server. </li>
				<li>Add the <strong class="source-inline">Auth</strong> component, which will take care of other commonly used authentication-related tasks (for example, check whether the user is logged in).</li>
				<li>Create the <strong class="source-inline">User</strong> class, as a table row model (in the <strong class="source-inline">src/models/</strong> directory), which will bundle some related functionality (such as checking the input password against the existing password hash).</li>
				<li>Refactor the login handler to use the database as a data source for users.</li>
				<li>Refactor the profile handler to only fetch the user from the database and then send it to the template.<p class="callout-heading">Note</p><p class="callout">The solution for this activity can be found on page 534.</p></li>
			</ol>
			<h1 id="_idParaDest-300"><a id="_idTextAnchor308"/>Summary</h1>
			<p>In this chapter, you learned how to handle files with PHP, which includes creating, writing, reading, and other filesystem-related operations. You also performed some basic, yet powerful, operations against a MySQL database server, creating a database structure and inserting, modifying, and deleting data. Although it might look a bit complex or overwhelming at the beginning, remember: it's like riding a bike – once practiced enough, until you get comfortable with it, you will never forget it (and it will actually get you from point A to point B way faster). In the next chapter, we will cover the concept of error handling, which is essential to identify potential problems in an application, and prevent important details leaking out to your users in the form of nasty error messages.</p>
		</div>
	</body></html>