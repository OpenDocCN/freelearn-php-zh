<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Using Collections to Enhance Results"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Using Collections to Enhance Results</h1></div></div></div><p>Until now, I told you everything about models and how to create relationships between them. I explained you how to query your data and relationships and even to specify complex conditions and constraints. However, I have never told you anything about what Eloquent's outputs are. Yes, sometimes, I mentioned an <span class="emphasis"><em>array</em></span> or just the word <span class="emphasis"><em>results</em></span>. Don't worry; it wasn't wrong, but there is something more under the hood.</p><p>Well, in this chapter, I will discuss collections. When retrieving your results from a query (using, for instance, <code class="literal">get()</code> or <code class="literal">all()</code>), you are getting a collection. That's the right term to use.</p><p>Basically, you can think of a collection as an array of results but with some extra utility methods. In fact, when you use a collection, you are using an instance of the <code class="literal">Collection</code> class under <code class="literal">Illuminate\Database\Eloquent</code>.</p><p>This class implements the <code class="literal">AggregateIterator</code> interface that lets you treat a collection like an array. You can use collections to perform many operations, sometimes complex operations as well. First of all, you will see how to perform some basic research operations and checks with collections.</p><p>Then, we will see some results transformation methods. Do you remember, in <a class="link" href="ch03.html" title="Chapter 3. The Most Important Element – the Model!">Chapter 3</a>, <span class="emphasis"><em>The Most Important Element – the Model!</em></span>, I had told you about the automatic transformation in JSON of a model result? Great! It's one of these methods.</p><p>Straight after, we will go a little deeper; after all, a collection is made up of elements. We will work with these elements. With a collection, obviously, you can iterate through its elements. There are some dedicated methods for iterations. Also, you will learn how to filter a collection in an easy way, just as many things in Eloquent are easy. Finally, we will talk about sorting operations on collections and how to deal with them. So, nothing of this really is essential, but it will help you to better understand how Eloquent works in every single way.</p><p>Are you ready? Here are the topics to cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Basic collection operations</li><li class="listitem" style="list-style-type: disc">Transforming collections</li><li class="listitem" style="list-style-type: disc">Iterating and filtering</li><li class="listitem" style="list-style-type: disc">Sorting</li></ul></div><div class="section" title="Basic collection operations"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec34"/>Basic collection operations</h1></div></div></div><p>Let's start <a id="id178" class="indexterm"/>with some really basic methods. For a better understanding of what you are going to do, I <span class="emphasis"><em>strongly suggest that you try on your project</em></span> every single method from the following list:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The first is <code class="literal">contains()</code>. It returns true or false if a record with a certain ID is included in the collection.<p>Here's an example:</p><div class="informalexample"><pre class="programlisting">  $books = \App\Book::all();

  if($books-&gt;contains(3))
  {
    return 'yeah, book 3 is here!';
  }</pre></div><p>All you have to do, here, is to specify the ID as a parameter.</p></li><li class="listitem" style="list-style-type: disc">As I told you earlier, you can use a collection as an array. So, if you want to get the third element in a collection, you can use this:<div class="informalexample"><pre class="programlisting">  $book = $books[2];</pre></div></li><li class="listitem" style="list-style-type: disc">However, if you don't like this syntax for some reason, you can use <code class="literal">get()</code> in an alternative way, like this:<div class="informalexample"><pre class="programlisting">  $book = $books-&gt;get(2);</pre></div></li><li class="listitem" style="list-style-type: disc">With this <span class="emphasis"><em>powered</em></span> syntax, you can also specify a default value if the desired index doesn't exist:<div class="informalexample"><pre class="programlisting">  $book = $books-&gt;get(2, "Not Found!");</pre></div></li><li class="listitem" style="list-style-type: disc">Obviously, you can check the existence of a specific element, if you want, with <code class="literal">has()</code>:<div class="informalexample"><pre class="programlisting">  if($books-&gt;has(3))
  {
    $book = $books-&gt;get(3);
  }</pre></div></li><li class="listitem" style="list-style-type: disc">As the opposite of <code class="literal">get()</code>, you can add an element with a specific index using <code class="literal">put()</code>:<div class="informalexample"><pre class="programlisting">  $book = new Book;
  // other attributes assignment here...

  $books-&gt;put(2, $book);</pre></div><p>As you may imagine, the first argument is the desired index, and the second argument is the value.</p></li><li class="listitem" style="list-style-type: disc">Another<a id="id179" class="indexterm"/> cool method is <code class="literal">prepend()</code>, which you can use to prepend an element to a certain collection. Here's the syntax:<div class="informalexample"><pre class="programlisting">  $firstBook = new Book;
  // other attributes assignment here...

  $books-&gt;prepend($book);</pre></div></li><li class="listitem" style="list-style-type: disc">If you want to get an array with all the primary keys, you can use a dedicated <code class="literal">modelKeys()</code> method!<div class="informalexample"><pre class="programlisting">  $books = \App\Book::all();

  $primaryKeys = $books-&gt;modelKeys();</pre></div><p>It's not over yet; actually, there are many methods you can use for many different things.</p></li><li class="listitem" style="list-style-type: disc">An example is <code class="literal">random()</code>, which extracts a single random item from the specified collection:<div class="informalexample"><pre class="programlisting">  $books = \App\Book::all();

  $randomBook = $books-&gt;random();</pre></div></li><li class="listitem" style="list-style-type: disc">Also, you can use <code class="literal">keys()</code> or <code class="literal">values()</code> to get arrays for only keys or values, respectively.<div class="informalexample"><pre class="programlisting">  $books = \App\Book::all();

  $keysArray = $books-&gt;keys();
  $valuesArray = $books-&gt;values();</pre></div></li><li class="listitem" style="list-style-type: disc">What? You want to treat your collection as a stack? No problem, <code class="literal">pop()</code> and <code class="literal">push()</code> are here to help!<div class="informalexample"><pre class="programlisting">  // let's get the last item!
  $books = \App\Books::all();
  $lastBook = $books-&gt;pop();

  // lets' add a new item ad the end!
  $book = new Book;
  // other attributes assignment here...

  $books-&gt;push($book);</pre></div></li><li class="listitem" style="list-style-type: disc">Now, what <a id="id180" class="indexterm"/>about searching for an item in a collection using syntax similar to the <code class="literal">here()</code> you called on models? Take a look at this:<div class="informalexample"><pre class="programlisting">    $books = \App\Book::all();
    
    $book = $books-&gt;where('title', 'Michael Strogoff');</pre></div><p>Note that this method returns another category. This means that you can use many chained calls of <code class="literal">where()</code>. Here's another example that gives a better idea:</p><div class="informalexample"><pre class="programlisting">  $books = \App\Book::all();

  $book = $categories-&gt;where('year', 1876)-&gt;where('page_count', 254);</pre></div></li><li class="listitem" style="list-style-type: disc">Let's close this first part of our chapter with <code class="literal">perPage</code>, which is a really intuitive method that gets a certain number of items, and all you have to do is to specify the page and number of items you want per page.<p>The syntax is something like this:</p><div class="informalexample"><pre class="programlisting">  $books = \App\Book::all();

  $secondPageBooks = $books-&gt;perPage(2, 10);</pre></div><p>With this simple call, you are getting 10 books, starting from the second page. I think this is a great example of expressive syntax of methods that Eloquent (and Laravel) offers.</p></li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note35"/>Note</h3><p>If you want to know <a id="id181" class="indexterm"/>more about the <code class="literal">Collection</code> class and what it offers, take a look at <a class="ulink" href="http://laravel.com/api/5.0/Illuminate/Database/Eloquent/Collection.html">http://laravel.com/api/5.0/Illuminate/Database/Eloquent/Collection.html</a> or look directly at the code in <code class="literal">Illuminate\Database\Eloquent\Collection</code> and <code class="literal">Illuminate\Support\Collection</code> classes.</p></div></div></div></div>
<div class="section" title="Transforming collections"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec35"/>Transforming collections</h1></div></div></div><p>Quite often, Eloquent<a id="id182" class="indexterm"/> automatically takes a collection to transform it into something that you can output in a better way. For example, here is the code that I am using to show a list of a magazine website's news categories:</p><div class="informalexample"><pre class="programlisting">  $categories = \App\Category::all();
   return $categories;</pre></div><p>This is the corresponding output:</p><div class="informalexample"><pre class="programlisting">  [
    {
      id: 1,
      name: "Editorial",
      slug: "editorial",
      description: "Qui est quo asperiores aliquid vitae possimus. Dolor consequuntur similique voluptatem a laborum dolorem ea repellendus. Aspernatur ducimus quis dolorum consequatur vel nam at. Aut omnis rem laborum.",
      created_at: "2015-04-21 10:14:37",
      updated_at: "2015-04-21 10:14:37"
    },
    {
      id: 2,
      name: "Interview",
      slug: "interview",
      description: "Rerum deleniti rerum aliquid laudantium id non voluptatum. Aut quia distinctio consequatur velit natus inventore sunt iusto. Non totam quis quam sint et.",
      created_at: "2015-04-21 10:14:37",
      updated_at: "2015-04-21 10:14:37"
    },
    {
      id: 3,
      name: "Reportage",
      slug: "reportage",
      description: "Adipisci et veritatis excepturi ullam explicabo. Eos dolore quas a vero. Optio voluptatem accusamus ex optio. Rerum rem quaerat qui maiores.",
      created_at: "2015-04-21 10:14:37",
      updated_at: "2015-04-21 10:14:37"
    }
  ]</pre></div><p>However, now consider the following code:</p><div class="informalexample"><pre class="programlisting">  $categories = \App\Category::all();
   return $categories;</pre></div><p>Then, let's change the code to this:</p><div class="informalexample"><pre class="programlisting">$categories = \App\Category::all();
dd($categories);</pre></div><p>This is<a id="id183" class="indexterm"/> what happens:</p><div class="informalexample"><pre class="programlisting">  Collection {#152
    #items: array:3 [
      0 =&gt; Category {#155
        #connection: null
        #table: null
        #primaryKey: "id"
        #perPage: 15
        +incrementing: true
        +timestamps: true
        #attributes: array:6 [
          "id" =&gt; 1
          "name" =&gt; "News"
          "slug" =&gt; "news"
          "description" =&gt; "Qui est quo asperiores aliquid vitae possimus. Dolor consequuntur similique voluptatem a laborum dolorem ea repellendus. Aspernatur ducimus quis dolorum consequatur vel nam at. Aut omnis rem laborum."
          "created_at" =&gt; "2015-04-21 10:14:37"
          "updated_at" =&gt; "2015-04-21 10:14:37"
        ]
        #original: array:6 [
          "id" =&gt; 1
          "name" =&gt; "News"
          "slug" =&gt; "news"
          "description" =&gt; "Qui est quo asperiores aliquid vitae possimus. Dolor consequuntur similique voluptatem a laborum dolorem ea repellendus. Aspernatur ducimus quis dolorum consequatur vel nam at. Aut omnis rem laborum."
          "created_at" =&gt; "2015-04-21 10:14:37"
          "updated_at" =&gt; "2015-04-21 10:14:37"
        ]
        #relations: []
        #hidden: []
        #visible: []
        #appends: []
        #fillable: []
        #guarded: array:1 [
          0 =&gt; "*"
        ]
        #dates: []
        #casts: []
        #touches: []
        #observables: []
        #with: []
        #morphClass: null
        +exists: true
      }
      1 =&gt; Category {#156 ...}
      2 =&gt; Category {#157 ...}
    ]
  }</pre></div><p>Wait, wait; what? Just <a id="id184" class="indexterm"/>changing a <code class="literal">dd()</code> call with a return? Well, you can see this magic using two special methods: <code class="literal">toArray</code> and <code class="literal">toJSON</code>. You can also use them manually, if you need, just like this:</p><div class="informalexample"><pre class="programlisting">  $books = \App\Book::all();

  $toArray = $books-&gt;toArray();
  $toJson = $books-&gt;toJson();</pre></div><p>Cool, right?</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note36"/>Note</h3><p>The <code class="literal">dd()</code> function I used before is a Laravel utility. It's a mix of the native PHP <code class="literal">var_dump()</code> and <code class="literal">die()</code>. To be more precise, it shows the value of a certain object or variable, and then stops the script.</p></div></div></div>
<div class="section" title="Iterating and filtering"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec36"/>Iterating and filtering</h1></div></div></div><p>Sometimes you will need something more than passing a collection in to a view, or a simple <code class="literal">toArray()</code> call. An Eloquent collection has many methods that you can use to filter and iterate through its elements. Let's see something in action!</p><div class="section" title="Iterating"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec53"/>Iterating</h2></div></div></div><p>First of all, let's <a id="id185" class="indexterm"/>begin with simple iteration. You can call the <code class="literal">each()</code> method to<a id="id186" class="indexterm"/> iterate the elements of a certain collection:</p><div class="informalexample"><pre class="programlisting">  $books = \App\Book::all();

  $books-&gt;each(function($book)
  {
    echo $book-&gt;title;
  });</pre></div><p>All you have to do is to pass as the first (and only) argument a closure with a single parameter: the<a id="id187" class="indexterm"/> single item to be used. In this example, I just printed all the titles.</p></div><div class="section" title="Filtering"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec54"/>Filtering</h2></div></div></div><p>If you <a id="id188" class="indexterm"/>want to filter your collection in a more complex way, you<a id="id189" class="indexterm"/> can use <code class="literal">filter()</code>. Let's take an example: I want to select every book that was printed after 1840.</p><div class="informalexample"><pre class="programlisting">  $books = \App\Book:all();

  $books-&gt;filter(function($book)
  {
    if($book-&gt;year &gt; 1840)
      return true;
    else
      return false;
  });</pre></div><p>The syntax is really similar to the previous example. You have a closure as a parameter, with a single argument passed; that is, the collection item.</p><p>However, this time you will have to check your conditions and return true or false if you want to include (or not) this item in the <code class="literal">result</code> collection.</p><p>So, in this specific case, the current <code class="literal">$book</code> value was printed after 1840? Great, come in. Not printed after 1840? Bye bye!</p></div></div>
<div class="section" title="Sorting"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec37"/>Sorting</h1></div></div></div><p>Finally, you<a id="id190" class="indexterm"/> can sort data using a certain field. The methods you must<a id="id191" class="indexterm"/> use, this time, are <code class="literal">sortBy</code> and <code class="literal">sortByDesc</code>. I think you are quite smart enough to understand what they do, right?</p><p>However, here are some examples:</p><div class="informalexample"><pre class="programlisting">  // ordering books by title, ascending
  $books = $books-&gt;sortBy(function($book)
  {
      return $book-&gt;title;
  });

  // ordering books by creation date, descending;
  $books = $books-&gt;sortByDesc(function($book)
  {
      return $book-&gt;created_at;
  });</pre></div><p>Also, you can use a shortcut if<a id="id192" class="indexterm"/> your closure logic is really simple, such as<a id="id193" class="indexterm"/> the earlier examples:</p><div class="informalexample"><pre class="programlisting">  $books = $books-&gt;sortBy('title');
  $books = $books-&gt;sortByDesc('created_at');</pre></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec38"/>Summary</h1></div></div></div><p>Let's be clear; in my opinion, knowing every single method of a collection isn't really indispensable. However, it can be really useful in some situations where you need a certain method to do something very specific. How can I say it? The more things you know, the better you are!</p><p>Now, let's move on! After this little break, it's time to go down in to the world of events!</p></div></body></html>