<html><head></head><body>
<div id="_idContainer041">
<h1 class="chapter-number" id="_idParaDest-162"><a id="_idTextAnchor172"/><span class="koboSpan" id="kobo.1.1">5</span></h1>
<h1 id="_idParaDest-163"><a id="_idTextAnchor173"/><span class="koboSpan" id="kobo.2.1">Creating Custom Pages</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, we will make custom pages with controllers. </span><span class="koboSpan" id="kobo.3.2">A controller is a class that contains a method used to build a page when Drupal is accessed at a specific path. </span><span class="koboSpan" id="kobo.3.3">Creating custom pages allows you to extend Drupal beyond just the content pages. </span><span class="koboSpan" id="kobo.3.4">This chapter will cover the process of creating custom pages, receiving dynamic values from paths, and serving JSON or file </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">download responses.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">In this chapter, we will learn about the </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.7.1">Defining a controller to provide a </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">custom page</span></span></li>
<li><span class="koboSpan" id="kobo.9.1">Using </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">route parameters</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">Creating a dynamic </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">redirect page</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Creating a </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">JSON response</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Serving files </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">for download</span></span></li>
</ul>
<h1 id="_idParaDest-164"><a id="_idTextAnchor174"/><span class="koboSpan" id="kobo.17.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.18.1">This chapter requires an existing custom module installed on your Drupal site. </span><span class="koboSpan" id="kobo.18.2">This custom module will contain the controllers created throughout this recipe. </span><a href="B18548_04.xhtml#_idTextAnchor131"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.19.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.20.1">, </span><em class="italic"><span class="koboSpan" id="kobo.21.1">Extending Drupal with Custom Code</span></em><span class="koboSpan" id="kobo.22.1">, covers how to create a custom module. </span><span class="koboSpan" id="kobo.22.2">You can find the full code used in this chapter on </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">GitHub: </span></span><a href="https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp05"><span class="No-Break"><span class="koboSpan" id="kobo.24.1">https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp05</span></span></a></p>
<h1 id="_idParaDest-165"><a id="_idTextAnchor175"/><span class="koboSpan" id="kobo.25.1">Defining a controller to provide a custom page</span></h1>
<p><span class="koboSpan" id="kobo.26.1">Whenever</span><a id="_idIndexMarker281"/><span class="koboSpan" id="kobo.27.1"> an HTTP request is made to a Drupal site, the path for the URL is routed to a controller. </span><span class="koboSpan" id="kobo.27.2">Controllers are responsible for returning the response for a path that has been defined as a route. </span><span class="koboSpan" id="kobo.27.3">Generally, these controllers return render arrays for Drupal’s render system to convert </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">into HTML.</span></span></p>
<p><span class="koboSpan" id="kobo.29.1">In this recipe, we will define a controller that returns a render array to display a message on </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">the page.</span></span></p>
<h2 id="_idParaDest-166"><a id="_idTextAnchor176"/><span class="koboSpan" id="kobo.31.1">How to do it…</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.32.1">First, we need to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.33.1">src/Controller</span></strong><span class="koboSpan" id="kobo.34.1"> directory in the module’s directory. </span><span class="koboSpan" id="kobo.34.2">We will put our controller class in this directory, which gives our </span><strong class="source-inline"><span class="koboSpan" id="kobo.35.1">controller</span></strong><span class="koboSpan" id="kobo.36.1"> class the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.37.1">Controller</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.38.1"> namespace:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.39.1">
mkdir -p src/Controller</span></pre></li>
<li><span class="koboSpan" id="kobo.40.1">Create</span><a id="_idIndexMarker282"/><span class="koboSpan" id="kobo.41.1"> a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.42.1">HelloWorldController.php</span></strong><span class="koboSpan" id="kobo.43.1"> in the controller directory. </span><span class="koboSpan" id="kobo.43.2">This will hold our </span><strong class="source-inline"><span class="koboSpan" id="kobo.44.1">HelloWorldController</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.45.1">controller class.</span></span></li>
<li><span class="koboSpan" id="kobo.46.1">Our </span><strong class="source-inline"><span class="koboSpan" id="kobo.47.1">HelloWorldController</span></strong><span class="koboSpan" id="kobo.48.1"> class will extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.49.1">ControllerBase</span></strong><span class="koboSpan" id="kobo.50.1"> base class provided by </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">Drupal core:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.52.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.53.1">
namespace Drupal\mymodule\Controller;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.54.1">
use Drupal\Core\Controller\ControllerBase;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.55.1">
class HelloWorldController extends ControllerBase {</span><a id="_idTextAnchor177"/></pre><pre class="source-code"><span class="koboSpan" id="kobo.56.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.57.1">Following PSR-4 autoloading conventions, our class is in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.58.1">\Drupal\mymodule\Controller</span></strong><span class="koboSpan" id="kobo.59.1"> namespace, which Drupal is able to determine as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.60.1">src/Controller</span></strong><span class="koboSpan" id="kobo.61.1"> directory in our module. </span><span class="koboSpan" id="kobo.61.2">As per PSR-4, the filename and class name must also be </span><span class="No-Break"><span class="koboSpan" id="kobo.62.1">the same.</span></span></p>
<p><span class="koboSpan" id="kobo.63.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.64.1">\Drupal\Core\Controller\ControllerBase</span></strong><span class="koboSpan" id="kobo.65.1"> class provides a handful of utility methods that could </span><span class="No-Break"><span class="koboSpan" id="kobo.66.1">be leveraged.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.67.1">Next, we will create a method that returns a render array to display a string of text. </span><span class="koboSpan" id="kobo.67.2">Add the following method to our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.68.1">HelloWorldController</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.69.1"> class:</span></span><pre class="source-code">
<a id="_idTextAnchor178"/><span class="koboSpan" id="kobo.70.1">  /**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.71.1">
   * Returns markup for our custom page.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.72.1">
   *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.73.1">
   * @returns array</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.74.1">
   *   The render array.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.75.1">
   */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.76.1">
  public function page(): array {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.77.1">
    return [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.78.1">
      '#markup' =&gt; '&lt;p&gt;Hello world!&lt;/p&gt;'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.79.1">
    ];</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.80.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.81.1">The</span><a id="_idIndexMarker283"/><span class="koboSpan" id="kobo.82.1"> page method returns a render array that the Drupal rendering system will parse. </span><span class="koboSpan" id="kobo.82.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.83.1">#markup</span></strong><span class="koboSpan" id="kobo.84.1"> key denotes a value that does not have any additional rendering or theming and allows basic </span><span class="No-Break"><span class="koboSpan" id="kobo.85.1">HTML elements.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.86.1">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.87.1">mymodule.routing.yml</span></strong><span class="koboSpan" id="kobo.88.1"> file in your module’s directory. </span><span class="koboSpan" id="kobo.88.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.89.1">routing.yml</span></strong><span class="koboSpan" id="kobo.90.1"> file is provided by modules to </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">define routes.</span></span></li>
<li><span class="koboSpan" id="kobo.92.1">The first step in defining a route is to provide a name for the route, which is used as its identifier for URL generation and </span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">other purposes:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.94.1">
mymodule.hello_world</span></pre></li>
<li><span class="koboSpan" id="kobo.95.1">Give the route </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">a path:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.97.1">
mymodule.hello_world:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.98.1">
  path: /hello-world</span></pre></li>
<li><span class="koboSpan" id="kobo.99.1">Next, we register the path with our controller. </span><span class="koboSpan" id="kobo.99.2">This is done using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.100.1">defaults</span></strong><span class="koboSpan" id="kobo.101.1"> key where we provide the controller and </span><span class="No-Break"><span class="koboSpan" id="kobo.102.1">page titl</span><a id="_idTextAnchor179"/><span class="koboSpan" id="kobo.103.1">e:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.104.1">
mymodule.hello_world:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.105.1">
  path: /hello-world</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.106.1">
  defaults:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.107.1">
    _controller: Drupal\mymodule\Controller\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.108.1">
        HelloWorldController::page</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.109.1">
    _title: 'Hello world!'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.110.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">_controller</span></strong><span class="koboSpan" id="kobo.112.1"> key is the fully qualified class name with the class method to be used. </span><span class="koboSpan" id="kobo.112.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.113.1">_title</span></strong><span class="koboSpan" id="kobo.114.1"> key provides the page title to </span><span class="No-Break"><span class="koboSpan" id="kobo.115.1">be displayed.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.116.1">Lastly, define</span><a id="_idIndexMarker284"/><span class="koboSpan" id="kobo.117.1"> a requirements key to specify the </span><span class="No-Break"><span class="koboSpan" id="kobo.118.1">access requirements:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.119.1">
mymodule.hello_world:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.120.1">
  path: /hello-world</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.121.1">
  defaults:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.122.1">
    _controller: Drupal\mymodule\Controller\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.123.1">
        HelloWorldController::page</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.124.1">
    _title: 'Hello world!</span><a id="_idTextAnchor180"/><span class="koboSpan" id="kobo.125.1">'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.126.1">
  requirements:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.127.1">
    _permission: 'access content'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.128.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.129.1">_permission</span></strong><span class="koboSpan" id="kobo.130.1"> option tells the routing system to verify the current user has specific permission in order to view </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">a page.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.132.1">Drupal caches its routing information. </span><span class="koboSpan" id="kobo.132.2">We must rebuild Drupal’s caches in order for it to be aware of the module’s </span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">new route:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.134.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.135.1">Go to </span><strong class="source-inline"><span class="koboSpan" id="kobo.136.1">/hello-world</span></strong><span class="koboSpan" id="kobo.137.1"> on your Drupal site and view your </span><span class="No-Break"><span class="koboSpan" id="kobo.138.1">custom page:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer039">
<span class="koboSpan" id="kobo.139.1"><img alt="Figure 5.1 – The /hello-world page" src="image/Figure_5.1_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.140.1">Figure 5.1 – The /hello-world page</span></p>
<h2 id="_idParaDest-167"><a id="_idTextAnchor181"/><span class="koboSpan" id="kobo.141.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.142.1">Drupal’s</span><a id="_idIndexMarker285"/><span class="koboSpan" id="kobo.143.1"> routing is built on top of Symfony’s routing component. </span><span class="koboSpan" id="kobo.143.2">Each route has a method in a controller class that returns a response. </span><span class="koboSpan" id="kobo.143.3">Most commonly, the returned response is a render array. </span><span class="koboSpan" id="kobo.143.4">Other recipes in this chapter will show you how to return response objects directly. </span><span class="koboSpan" id="kobo.143.5">The routes are collected into Drupal’s </span><span class="No-Break"><span class="koboSpan" id="kobo.144.1">routing system.</span></span></p>
<p><span class="koboSpan" id="kobo.145.1">When an HTTP request comes to Drupal, the system tries to match the path to known routes. </span><span class="koboSpan" id="kobo.145.2">If a route is found, the route’s definition is used to deliver the page. </span><span class="koboSpan" id="kobo.145.3">If a route cannot be found, a 404 page is displayed. </span><span class="koboSpan" id="kobo.145.4">If a route is found, Drupal performs access checks based on the requirements key. </span><span class="koboSpan" id="kobo.145.5">If the requirements key conditions fail, then Drupal may return a 403 page or </span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">404 page.</span></span></p>
<p><span class="koboSpan" id="kobo.147.1">After the controller has returned the response, Drupal checks whether the value is a render array or a response from Symfony’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.148.1">HttpFoundation</span></strong><span class="koboSpan" id="kobo.149.1"> component. </span><span class="koboSpan" id="kobo.149.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.150.1">onViewRenderArray</span></strong><span class="koboSpan" id="kobo.151.1"> method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.152.1">MainContentViewSubscriber</span></strong><span class="koboSpan" id="kobo.153.1"> class checks whether the controller response is an array. </span><span class="koboSpan" id="kobo.153.2">If it is, the renderer is then resolved and </span><a id="_idIndexMarker286"/><span class="koboSpan" id="kobo.154.1">converts the render array into an HTML response. </span><span class="koboSpan" id="kobo.154.2">Otherwise, it allows the returned response object to </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">be handled.</span></span></p>
<p><span class="koboSpan" id="kobo.156.1">When writing controllers, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">ControllerBase</span></strong><span class="koboSpan" id="kobo.158.1"> base class is not required; but it does provide simplified access to common services without setting up </span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">dependency injection.</span></span></p>
<h2 id="_idParaDest-168"><a id="_idTextAnchor182"/><span class="koboSpan" id="kobo.160.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.161.1">In the following sections, we will cover more items </span><span class="No-Break"><span class="koboSpan" id="kobo.162.1">about routes.</span></span></p>
<h3><span class="koboSpan" id="kobo.163.1">Route requirements</span></h3>
<p><span class="koboSpan" id="kobo.164.1">Routes </span><a id="_idIndexMarker287"/><span class="koboSpan" id="kobo.165.1">can define different access requirements through the requirements key. </span><span class="koboSpan" id="kobo.165.2">Multiple validators can be added. </span><span class="koboSpan" id="kobo.165.3">However, there must be one that provides a true result, or else the route will return 403, access denied. </span><span class="koboSpan" id="kobo.165.4">This is true if the route defines no </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">requirement validators.</span></span></p>
<p><span class="koboSpan" id="kobo.167.1">Route </span><a id="_idIndexMarker288"/><span class="koboSpan" id="kobo.168.1">requirement validators are defined by implementing </span><strong class="source-inline"><span class="koboSpan" id="kobo.169.1">\Drupal\Core\Routing\Access\AccessInterface</span></strong><span class="koboSpan" id="kobo.170.1">. </span><span class="koboSpan" id="kobo.170.2">The following list shows some of the common requirement validators defined throughout </span><span class="No-Break"><span class="koboSpan" id="kobo.171.1">Drupal core:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.172.1">_access: 'TRUE'</span></strong><span class="koboSpan" id="kobo.173.1">: This always grants access to the route. </span><span class="koboSpan" id="kobo.173.2">Be careful when granting this instead of a permission or role check, as this means anyone can access </span><span class="No-Break"><span class="koboSpan" id="kobo.174.1">the route.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">_entity_access</span></strong><span class="koboSpan" id="kobo.176.1">: This validates that the current user can perform an entity operation. </span><span class="koboSpan" id="kobo.176.2">For example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.177.1">node.update</span></strong><span class="koboSpan" id="kobo.178.1"> verifies the user can update the node in the </span><span class="No-Break"><span class="koboSpan" id="kobo.179.1">URL parameters.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">_permission</span></strong><span class="koboSpan" id="kobo.181.1">: This checks whether the current user has the </span><span class="No-Break"><span class="koboSpan" id="kobo.182.1">provided permissions.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.183.1">_user_is_logged_in</span></strong><span class="koboSpan" id="kobo.184.1">: This validates that the user is logged in. </span><span class="koboSpan" id="kobo.184.2">The value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.185.1">'TRUE'</span></strong><span class="koboSpan" id="kobo.186.1"> requires the user to be logged in and </span><strong class="source-inline"><span class="koboSpan" id="kobo.187.1">'FALSE'</span></strong><span class="koboSpan" id="kobo.188.1"> is for the user to be logged out. </span><span class="koboSpan" id="kobo.188.2">An</span><a id="_idIndexMarker289"/><span class="koboSpan" id="kobo.189.1"> example of </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">'FALSE'</span></strong><span class="koboSpan" id="kobo.191.1"> is for the user </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">login page.</span></span></li>
</ul>
<h3><span class="koboSpan" id="kobo.193.1">Providing dynamic routes</span></h3>
<p><span class="koboSpan" id="kobo.194.1">The</span><a id="_idIndexMarker290"/><span class="koboSpan" id="kobo.195.1"> routing system allows modules to define routes programmatically. </span><span class="koboSpan" id="kobo.195.2">This can be accomplished by providing a </span><strong class="source-inline"><span class="koboSpan" id="kobo.196.1">routing_callbacks</span></strong><span class="koboSpan" id="kobo.197.1"> key that defines a class and method that will return an array of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">\</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">Symfony\Component\Routing\Route</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.200.1"> objects.</span></span></p>
<p><span class="koboSpan" id="kobo.201.1">In the module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.202.1">routing.yml</span></strong><span class="koboSpan" id="kobo.203.1"> file, you will define the routing callbacks key and </span><span class="No-Break"><span class="koboSpan" id="kobo.204.1">relate</span><a id="_idTextAnchor183"/><span class="koboSpan" id="kobo.205.1">d class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.206.1">
route_callbacks:
  - 'Drupal\mymodule\Routing\CustomRoutes::routes'</span></pre>
<p><span class="koboSpan" id="kobo.207.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">Drupal\mymodule\Routing\CustomRoutes</span></strong><span class="koboSpan" id="kobo.209.1"> class will then have a method named routes, which returns an array of </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">route objects:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.211.1">
&lt;?php
namespace Drupal\mymodule\Routing;
use Symfony\Component\Routing\Route;
class CustomRoutes {
  public function routes() {
    $routes = [];
    // Create mypage route programmatically
    $routes['mymodule.hello_world'] = new Route(
      // Path definition
      '/hello-world',
      // Route defaults
      [
        '_controller' =&gt;
        '\Drupal\mymodule\Controller\
            HelloWorldController::page',
        '_title' =&gt; 'Hello world',
      ],
      // Route requirements
      [
        '_permission' =&gt; 'access content',
      ]
    );
    return $routes;
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.212.1">If a </span><a id="_idIndexMarker291"/><span class="koboSpan" id="kobo.213.1">module provides a class that interacts with routes, the best practice is to place it in the routing portion of the module’s namespace. </span><span class="koboSpan" id="kobo.213.2">This helps you identify </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">its purpose.</span></span></p>
<p><span class="koboSpan" id="kobo.215.1">The invoked method is expected to return an array of initiated route objects. </span><span class="koboSpan" id="kobo.215.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">Route</span></strong><span class="koboSpan" id="kobo.217.1"> class </span><a id="_idIndexMarker292"/><span class="koboSpan" id="kobo.218.1">takes the </span><span class="No-Break"><span class="koboSpan" id="kobo.219.1">following arguments:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">path</span></strong><span class="koboSpan" id="kobo.221.1">: This is the path for </span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">the route.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.223.1">defaults</span></strong><span class="koboSpan" id="kobo.224.1">: This is the array of defaults for the route and </span><span class="No-Break"><span class="koboSpan" id="kobo.225.1">its controller.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.226.1">requirements</span></strong><span class="koboSpan" id="kobo.227.1">: This is an array of validators to make sure the route </span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">is accessible.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.229.1">options</span></strong><span class="koboSpan" id="kobo.230.1">: This is an array that can be passed and used optionally to hold metadata about </span><span class="No-Break"><span class="koboSpan" id="kobo.231.1">the route.</span></span></li>
</ul>
<h3><span class="koboSpan" id="kobo.232.1">Altering existing routes</span></h3>
<p><span class="koboSpan" id="kobo.233.1">When </span><a id="_idIndexMarker293"/><span class="koboSpan" id="kobo.234.1">the routing system is being rebuilt, an event is dispatched to alter the discovered routes. </span><span class="koboSpan" id="kobo.234.2">This involves implementing an event subscriber. </span><span class="koboSpan" id="kobo.234.3">Drupal provides a base class to ease this implementation. </span><span class="koboSpan" id="kobo.234.4">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.235.1">\Drupal\Core\Routing\RouteSubscriberBase</span></strong><span class="koboSpan" id="kobo.236.1"> implements the required interface methods and subscribes to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.237.1">RoutingEvents::ALTER</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.238.1"> event.</span></span></p>
<p><span class="koboSpan" id="kobo.239.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.240.1">src/Routing/RouteSubscriber.php</span></strong><span class="koboSpan" id="kobo.241.1"> file for your module to hold the route </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.242.1">subscriber</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.243.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.244.1">
&lt;?php
namespace Drupal\mymodule\Routing;
use Drupal\Core\Routing\RouteSubscriberBase;
use Symfony\Component\Routing\RouteCollection;
class RouteSubscriber extends RouteSubscriberBase {
  /**
   * {@inheritdoc}
   */
  public function alterRoutes(RouteCollection $collection) {
    // Change path of mymodule.hello_world to just 'hello'
    if ($route = $collection-&gt;get('mymodule.hello_world')) {
      $route-&gt;setPath('/hello')</span><a id="_idTextAnchor184"/><span class="koboSpan" id="kobo.245.1">;
    }
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.246.1">The preceding code extends </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">RouteSubscriberBase</span></strong><span class="koboSpan" id="kobo.248.1"> and implements the </span><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">alterRoutes</span></strong><span class="koboSpan" id="kobo.250.1"> method. </span><span class="koboSpan" id="kobo.250.2">We fetch the route object from the route collection, if it exists, and </span><a id="_idIndexMarker294"/><span class="koboSpan" id="kobo.251.1">change the path from </span><strong class="source-inline"><span class="koboSpan" id="kobo.252.1">/hello-world</span></strong><span class="koboSpan" id="kobo.253.1"> to </span><span class="No-Break"><span class="koboSpan" id="kobo.254.1">just </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">/hello</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.256.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.257.1">Then, we must register the event subscriber in the </span><span class="No-Break"><span class="koboSpan" id="kobo.258.1">module’s </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">mymodule.s</span><a id="_idTextAnchor185"/><span class="koboSpan" id="kobo.260.1">ervices.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.261.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.262.1">
services:
  mymodule.route_subscriber:
    class: Drupal\mymodule\Routing\RouteSubscriber
    tags:
      - { name: event_subscriber }</span></pre>
<p><span class="koboSpan" id="kobo.263.1">After adding this change, clear the Drupal cache. </span><span class="koboSpan" id="kobo.263.2">This makes Drupal aware of our event subscriber so that it can react to the dispatch of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">RoutingEvents::ALTER</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.265.1"> event.</span></span></p>
<h2 id="_idParaDest-169"><a id="_idTextAnchor186"/><span class="koboSpan" id="kobo.266.1">See also</span></h2>
<ul>
<li><span class="koboSpan" id="kobo.267.1">The Symfony Routing </span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">component: </span></span><a href="https://symfony.com/doc/current/create_framework/routing.html"><span class="No-Break"><span class="koboSpan" id="kobo.269.1">https://symfony.com/doc/current/create_framework/routing.html</span></span></a></li>
</ul>
<h1 id="_idParaDest-170"><a id="_idTextAnchor187"/><span class="koboSpan" id="kobo.270.1">Using route parameters</span></h1>
<p><span class="koboSpan" id="kobo.271.1">In the previous recipe, we </span><a id="_idIndexMarker295"/><span class="koboSpan" id="kobo.272.1">defined a route and controller that responded to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">/hello-world</span></strong><span class="koboSpan" id="kobo.274.1"> path. </span><span class="koboSpan" id="kobo.274.2">A route can add variables to the path, called route parameters, so that the controller can handle </span><span class="No-Break"><span class="koboSpan" id="kobo.275.1">different URLs.</span></span></p>
<p><span class="koboSpan" id="kobo.276.1">In this recipe, we will create a route that takes a user ID as a route parameter to display information about </span><span class="No-Break"><span class="koboSpan" id="kobo.277.1">that user.</span></span></p>
<h2 id="_idParaDest-171"><a id="_idTextAnchor188"/><span class="koboSpan" id="kobo.278.1">Getting started</span></h2>
<p><span class="koboSpan" id="kobo.279.1">This recipe uses the route created in the </span><em class="italic"><span class="koboSpan" id="kobo.280.1">Defining a controller</span></em><span class="koboSpan" id="kobo.281.1"> recipe to provide a </span><span class="No-Break"><span class="koboSpan" id="kobo.282.1">custom page.</span></span></p>
<h2 id="_idParaDest-172"><a id="_idTextAnchor189"/><span class="koboSpan" id="kobo.283.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.284.1">First, remove the </span><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">src/Routing/RouteSubscriber.php</span></strong><span class="koboSpan" id="kobo.286.1"> file and </span><strong class="source-inline"><span class="koboSpan" id="kobo.287.1">mymodule.services.yml</span></strong><span class="koboSpan" id="kobo.288.1"> from the previous section and clear the Drupal cache, so it does not interfere with what we are about </span><span class="No-Break"><span class="koboSpan" id="kobo.289.1">to do.</span></span></li>
<li><span class="koboSpan" id="kobo.290.1">Next, edit </span><strong class="source-inline"><span class="koboSpan" id="kobo.291.1">routing.yml</span></strong><span class="koboSpan" id="kobo.292.1"> so that we can add a route parameter of </span><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">user</span></strong><span class="koboSpan" id="kobo.294.1"> to </span><span class="No-Break"><span class="koboSpan" id="kobo.295.1">the path:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.296.1">
  path: /hello-world/{user}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.297.1">Route parameters are wrapped with an opening bracket (</span><strong class="source-inline"><span class="koboSpan" id="kobo.298.1">{</span></strong><span class="koboSpan" id="kobo.299.1">) and a closing </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1">bracket (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">}</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">).</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.303.1">Next, we</span><a id="_idIndexMarker296"/><span class="koboSpan" id="kobo.304.1"> will update the requirements key to specify that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.305.1">user</span></strong><span class="koboSpan" id="kobo.306.1"> parameter should be an integer for a user ID, and that the current user has access to view </span><span class="No-Break"><span class="koboSpan" id="kobo.307.1">other profiles:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.308.1">
  requirements:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.309.1">
    u</span><a id="_idTextAnchor190"/><span class="koboSpan" id="kobo.310.1">ser: '\d+'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.311.1">
    _entity_access: 'user.view'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.312.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">user</span></strong><span class="koboSpan" id="kobo.314.1"> key under requirements represents the same route parameter. </span><span class="koboSpan" id="kobo.314.2">The routing system allows you to provide regular expressions to validate the value of a route parameter. </span><span class="koboSpan" id="kobo.314.3">This validates the user parameter as any </span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">digit value.</span></span></p>
<p><span class="koboSpan" id="kobo.316.1">We then use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">_entity_access</span></strong><span class="koboSpan" id="kobo.318.1"> requirement to verify the current user has access to perform the view operation on the entity </span><span class="No-Break"><span class="koboSpan" id="kobo.319.1">type user.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.320.1">Then, we add a new options key to the route definition so that we can identify what type of value the user route </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">p</span><a id="_idTextAnchor191"/><span class="koboSpan" id="kobo.322.1">arameter is:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.323.1">
  options:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.324.1">
    parameters:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.325.1">
      user:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.326.1">
        type: 'entity:user'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.327.1">This defines the user route parameter as being of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">entity:user</span></strong><span class="koboSpan" id="kobo.329.1"> type. </span><span class="koboSpan" id="kobo.329.2">Drupal will use this to convert the ID value into a user object for </span><span class="No-Break"><span class="koboSpan" id="kobo.330.1">our controller.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.331.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.332.1">src/Controller/HelloWorldController.php</span></strong><span class="koboSpan" id="kobo.333.1"> file so that the page method can be updated to receive the user route </span><span class="No-Break"><span class="koboSpan" id="kobo.334.1">parameter value.</span></span></li>
<li><span class="koboSpan" id="kobo.335.1">Update the page method to receive the user route parameter as a user object in its </span><span class="No-Break"><span class="koboSpan" id="kobo.336.1">method</span><a id="_idTextAnchor192"/><span class="koboSpan" id="kobo.337.1"> parameters:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.338.1">
  /**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.339.1">
   * Returns markup for our custom page.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.340.1">
   *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.341.1">
   * @param \Drupal\user\UserInterface $user</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.342.1">
   *   The user parameter.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.343.1">
   *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.344.1">
   * @returns array</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.345.1">
   *   The render array.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.346.1">
   */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.347.1">
  public function page(UserInterface $user): array {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.348.1">
    return [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.349.1">
      '#markup' =&gt; '&lt;p&gt;Hello world!&lt;/p&gt;'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.350.1">
    ];</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.351.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.352.1">The </span><a id="_idIndexMarker297"/><span class="koboSpan" id="kobo.353.1">routing system passes route parameter values to the method based on parameter names for the method. </span><span class="koboSpan" id="kobo.353.2">Our parameter’s definition specifies that Drupal should convert the ID in the URL into a </span><span class="No-Break"><span class="koboSpan" id="kobo.354.1">user object.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.355.1">Let’s adjust the returned text from </span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">Hello world!</span></strong><span class="koboSpan" id="kobo.357.1"> to replace “world” with the email of the </span><span class="No-Break"><span class="koboSpan" id="kobo.358.1">user object:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.359.1">
    return [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.360.1">
      '#markup' =&gt; sprintf('&lt;p&gt;Hello %s!&lt;/p&gt;',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.361.1">
         $user-&gt;getEmail()),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.362.1">
    ];</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.363.1">We use </span><strong class="source-inline"><span class="koboSpan" id="kobo.364.1">sprintf</span></strong><span class="koboSpan" id="kobo.365.1"> to return a formatted string that contains the user’s </span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">email address.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.367.1">Drupal caches its routing information. </span><span class="koboSpan" id="kobo.367.2">We must rebuild Drupal’s caches in order for it to be aware of the changes to the module’s </span><span class="No-Break"><span class="koboSpan" id="kobo.368.1">new route:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.369.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.370.1">When</span><a id="_idIndexMarker298"/><span class="koboSpan" id="kobo.371.1"> you visit </span><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">/hello-world</span></strong><span class="koboSpan" id="kobo.373.1">, the route’s old path without a route parameter, Drupal will return a 404 error for page </span><span class="No-Break"><span class="koboSpan" id="kobo.374.1">not found.</span></span></li>
<li><span class="koboSpan" id="kobo.375.1">When you visit </span><strong class="source-inline"><span class="koboSpan" id="kobo.376.1">/hello-world/1</span></strong><span class="koboSpan" id="kobo.377.1">, the page will display our formatted text with the user’s </span><span class="No-Break"><span class="koboSpan" id="kobo.378.1">email address:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer040">
<span class="koboSpan" id="kobo.379.1"><img alt="Figure 5.2 – The formatted text with the user’s email address" src="image/Figure_5.2_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.380.1">Figure 5.2 – The formatted text with the user’s email address</span></p>
<h2 id="_idParaDest-173"><a id="_idTextAnchor193"/><span class="koboSpan" id="kobo.381.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.382.1">As discussed in</span><a id="_idIndexMarker299"/><span class="koboSpan" id="kobo.383.1"> the previous recipe, the routing system compares the path from the incoming HTTP request. </span><span class="koboSpan" id="kobo.383.2">The path is then matched against registered routes. </span><span class="koboSpan" id="kobo.383.3">When a route does not contain route parameters, the match is simple. </span><span class="koboSpan" id="kobo.383.4">To accomplish route matching based on an incoming path from a URL, the route has a matching pattern compiled. </span><span class="koboSpan" id="kobo.383.5">This matching pattern converts the route path and its route patterns into a regular expression that can be matched against the path from the </span><span class="No-Break"><span class="koboSpan" id="kobo.384.1">incoming URL.</span></span></p>
<p><span class="koboSpan" id="kobo.385.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.386.1">Drupal\Core\Routing\RouteCompiler</span></strong><span class="koboSpan" id="kobo.387.1"> class extends the </span><strong class="source-inline"><span class="koboSpan" id="kobo.388.1">RouteCompiler</span></strong><span class="koboSpan" id="kobo.389.1"> from Symfony’s routing component. </span><span class="koboSpan" id="kobo.389.2">When a route is compiled, the route’s path is converted into a regular expression that is used to compare it against the path from the incoming URL. </span><span class="koboSpan" id="kobo.389.3">Given our route path of </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">/hello-world/{user}</span></strong><span class="koboSpan" id="kobo.391.1"> with a requirement of </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">\d+</span></strong><span class="koboSpan" id="kobo.393.1">, here is the compiled regular expression the user route parameter matching the regular expression used to match </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1">our route:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.395.1">
#^/hello\-world/(?P&lt;user&gt;\d+)$#sDu</span></pre>
<p><span class="koboSpan" id="kobo.396.1">When this regular expression is evaluated through </span><strong class="source-inline"><span class="koboSpan" id="kobo.397.1">preg_match</span></strong><span class="koboSpan" id="kobo.398.1">, the matches will return an associated array of matches. </span><span class="koboSpan" id="kobo.398.2">If the path from the incoming URL matches, then the matches array will contain a key of user with the value found in </span><span class="No-Break"><span class="koboSpan" id="kobo.399.1">the path.</span></span></p>
<p><span class="koboSpan" id="kobo.400.1">Drupal’s </span><a id="_idIndexMarker300"/><span class="koboSpan" id="kobo.401.1">routing system has a concept of parameter converters that transform route parameter values from their value raw. </span><span class="koboSpan" id="kobo.401.2">With the route’s definition of </span><strong class="source-inline"><span class="koboSpan" id="kobo.402.1">options.parameters.user</span></strong><span class="koboSpan" id="kobo.403.1"> as </span><strong class="source-inline"><span class="koboSpan" id="kobo.404.1">entity:user</span></strong><span class="koboSpan" id="kobo.405.1">, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">\Drupal\Core\ParamConverter\EntityConverter</span></strong><span class="koboSpan" id="kobo.407.1"> class converts the user ID into a loaded </span><span class="No-Break"><span class="koboSpan" id="kobo.408.1">user object.</span></span></p>
<p><span class="koboSpan" id="kobo.409.1">After the route has been matched and the parameters converted, they are matched against the defined parameters for the controller method. </span><span class="koboSpan" id="kobo.409.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.410.1">ArgumentResolver</span></strong><span class="koboSpan" id="kobo.411.1"> from Symfony’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.412.1">HttpKernel</span></strong><span class="koboSpan" id="kobo.413.1"> uses reflection to assemble the correct argument order before calling the controller to handle </span><span class="No-Break"><span class="koboSpan" id="kobo.414.1">the request.</span></span></p>
<h2 id="_idParaDest-174"><a id="_idTextAnchor194"/><span class="koboSpan" id="kobo.415.1">See also</span></h2>
<ul>
<li><span class="koboSpan" id="kobo.416.1">Symfony’s documentation for the HttpKernel component and argument </span><span class="No-Break"><span class="koboSpan" id="kobo.417.1">resolving: </span></span><a href="https://symfony.com/doc/current/components/http_kernel.html#4-getting-the-controller-arguments"><span class="No-Break"><span class="koboSpan" id="kobo.418.1">https://symfony.com/doc/current/components/http_kernel.html#4-getting-the-controller-arguments</span></span></a></li>
<li><span class="koboSpan" id="kobo.419.1">Symfony’s documentation for the routing component and route </span><span class="No-Break"><span class="koboSpan" id="kobo.420.1">parameters: </span></span><a href="https://symfony.com/doc/current/routing.html#route-parameters"><span class="No-Break"><span class="koboSpan" id="kobo.421.1">https://symfony.com/doc/current/routing.html#route-parameters</span></span></a></li>
</ul>
<h1 id="_idParaDest-175"><a id="_idTextAnchor195"/><span class="koboSpan" id="kobo.422.1">Creating a dynamic redirect page</span></h1>
<p><span class="koboSpan" id="kobo.423.1">Controllers for routes</span><a id="_idIndexMarker301"/><span class="koboSpan" id="kobo.424.1"> in Drupal can return request objects provided by the Symfony </span><strong class="source-inline"><span class="koboSpan" id="kobo.425.1">HttpFoundation</span></strong><span class="koboSpan" id="kobo.426.1"> component instead of a render array. </span><span class="koboSpan" id="kobo.426.2">When a response object is returned, the render system is bypassed and the response object is </span><span class="No-Break"><span class="koboSpan" id="kobo.427.1">handled directly.</span></span></p>
<p><span class="koboSpan" id="kobo.428.1">In this recipe, we will create a route that redirects authenticated users to the homepage and anonymous users to the user </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">login form.</span></span></p>
<h2 id="_idParaDest-176"><a id="_idTextAnchor196"/><span class="koboSpan" id="kobo.430.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.431.1">First, we need to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.432.1">src/Controller</span></strong><span class="koboSpan" id="kobo.433.1"> directory in the module’s directory. </span><span class="koboSpan" id="kobo.433.2">We will put our controller class in this directory, which gives our controller class the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.434.1">Controller</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.435.1"> namespace:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.436.1">
mkdir -p src/Controller</span></pre></li>
<li><span class="koboSpan" id="kobo.437.1">Create a </span><a id="_idIndexMarker302"/><span class="koboSpan" id="kobo.438.1">file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">RedirectController.php</span></strong><span class="koboSpan" id="kobo.440.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">Controller</span></strong><span class="koboSpan" id="kobo.442.1"> directory. </span><span class="koboSpan" id="kobo.442.2">This will hold our </span><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">RedirectController</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.444.1">controller class.</span></span></li>
<li><span class="koboSpan" id="kobo.445.1">Our </span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">RedirectController</span></strong><span class="koboSpan" id="kobo.447.1"> class will extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">ControllerBase</span></strong><span class="koboSpan" id="kobo.449.1"> base class provided by </span><span class="No-Break"><span class="koboSpan" id="kobo.450.1">Drupal core:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.451.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.452.1">
namespace Drupal\mymodule\Controller;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.453.1">
use Drupal\Core\Controller\ControllerBase;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.454.1">
class RedirectController extend</span><a id="_idTextAnchor197"/><span class="koboSpan" id="kobo.455.1">s ControllerBase {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.456.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.457.1">Following PSR-4 autoloading conventions, our class is in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.458.1">\Drupal\mymodule\Controller</span></strong><span class="koboSpan" id="kobo.459.1"> namespace, which Drupal can determine as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.460.1">src/Controller</span></strong><span class="koboSpan" id="kobo.461.1"> directory in our module. </span><span class="koboSpan" id="kobo.461.2">As per PSR-4, the filename and class name must also be </span><span class="No-Break"><span class="koboSpan" id="kobo.462.1">the same.</span></span></p>
<p><span class="koboSpan" id="kobo.463.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.464.1">\Drupal\Core\Controller\ControllerBase</span></strong><span class="koboSpan" id="kobo.465.1"> class provides a handful of utility methods that can </span><span class="No-Break"><span class="koboSpan" id="kobo.466.1">be leveraged.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.467.1">Next, we will create a method that checks whether the current user is logged in or not. </span><span class="koboSpan" id="kobo.467.2">Update</span><a id="_idIndexMarker303"/><span class="koboSpan" id="kobo.468.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.469.1">RedirectController</span></strong><span class="koboSpan" id="kobo.470.1"> class to include the </span><span class="No-Break"><span class="koboSpan" id="kobo.471.1">following method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.472.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.473.1">
namespace Drupal\mymodule\Controller;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.474.1">
use Drupal\Core\Controller\ControllerBase;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.475.1">
use Symfony\Component\HttpFoundation\RedirectResponse;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.476.1">
class RedirectController extends ControllerBase {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.477.1">
  /**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.478.1">
   * Returns redirect to home or user login form.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.479.1">
   *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.480.1">
   * @return \Symfony\Component\HttpFoundation\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.481.1">
        RedirectResponse</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.482.1">
   *   The redirect response.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.483.1">
   */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.484.1">
  public function page(): RedirectResponse {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.485.1">
    if ($this-&gt;currentUser()-&gt;isAuthenticated()) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.486.1">
      // Redirect to the homepage.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.487.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.488.1">
    else {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.489.1">
      // Redirect to the user l</span><a id="_idTextAnchor198"/><span class="koboSpan" id="kobo.490.1">ogin form.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.491.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.492.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.493.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.494.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">ControllerBase</span></strong><span class="koboSpan" id="kobo.496.1"> class provides a </span><strong class="source-inline"><span class="koboSpan" id="kobo.497.1">currentUser</span></strong><span class="koboSpan" id="kobo.498.1"> method that accesses the current user object. </span><span class="koboSpan" id="kobo.498.2">We can call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.499.1">isAuthenticated</span></strong><span class="koboSpan" id="kobo.500.1"> method to check whether the user is logged in </span><span class="No-Break"><span class="koboSpan" id="kobo.501.1">or not.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.502.1">Next, we</span><a id="_idIndexMarker304"/><span class="koboSpan" id="kobo.503.1"> will update the code to return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.504.1">RedirectResponse</span></strong><span class="koboSpan" id="kobo.505.1"> object to a URL that is generated from a </span><span class="No-Break"><span class="koboSpan" id="kobo.506.1">route name:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.507.1">
  public function page(): RedirectResponse {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.508.1">
    if ($this-&gt;currentUser()-&gt;isAuthenticated()) {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.509.1">
      $route_name = '&lt;front&gt;';</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.510.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.511.1">
    else {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.512.1">
      $route_name = 'user.login';</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.513.1">
    }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.514.1">
    $url = \Drupal\Core\Url::fromRoute($route_name);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.515.1">
    return new RedirectResponse</span><a id="_idTextAnchor199"/><span class="koboSpan" id="kobo.516.1">($url-&gt;toString());</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.517.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.518.1">We set the route name in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.519.1">$route_name</span></strong><span class="koboSpan" id="kobo.520.1"> variable. </span><span class="koboSpan" id="kobo.520.2">While </span><strong class="source-inline"><span class="koboSpan" id="kobo.521.1">&lt;front&gt;</span></strong><span class="koboSpan" id="kobo.522.1"> is not a typical path, it is a route name available to route to the appropriate path that is set as the homepage. </span><span class="koboSpan" id="kobo.522.2">Drupal core defines special slugs such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">&lt;front&gt;</span></strong><span class="koboSpan" id="kobo.524.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">&lt;none&gt;</span></strong><span class="koboSpan" id="kobo.526.1"> for convenience in routing. </span><span class="koboSpan" id="kobo.526.2">See the core </span><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">Url</span></strong><span class="koboSpan" id="kobo.528.1"> class for </span><span class="No-Break"><span class="koboSpan" id="kobo.529.1">more information.</span></span></p>
<p><span class="koboSpan" id="kobo.530.1">We then construct a new URL object with the static </span><strong class="source-inline"><span class="koboSpan" id="kobo.531.1">fromRoute</span></strong><span class="koboSpan" id="kobo.532.1"> method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.533.1">\Drupal\Core\Url</span></strong><span class="koboSpan" id="kobo.534.1"> class. </span><span class="koboSpan" id="kobo.534.2">We then return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">RedirectResponse</span></strong><span class="koboSpan" id="kobo.536.1"> object that redirects to our URL. </span><span class="koboSpan" id="kobo.536.2">We have to get the string for the URL using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.537.1">toString</span></strong><span class="koboSpan" id="kobo.538.1"> method on the </span><span class="No-Break"><span class="koboSpan" id="kobo.539.1">URL object.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.540.1">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.541.1">mymodule.routing.yml</span></strong><span class="koboSpan" id="kobo.542.1"> file in your module’s directory. </span><span class="koboSpan" id="kobo.542.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">routing.yml</span></strong><span class="koboSpan" id="kobo.544.1"> file is provided by modules to </span><span class="No-Break"><span class="koboSpan" id="kobo.545.1">define routes.</span></span></li>
<li><span class="koboSpan" id="kobo.546.1">The first </span><a id="_idIndexMarker305"/><span class="koboSpan" id="kobo.547.1">step in defining a route is to provide a name for the route, which is used as its identifier for URL generation and </span><span class="No-Break"><span class="koboSpan" id="kobo.548.1">other purposes:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.549.1">
mymodule.user_redirect</span></pre></li>
<li><span class="koboSpan" id="kobo.550.1">Give the route </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">a path:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.552.1">
mymodule.user_redirect:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.553.1">
  path: /user-redirect</span></pre></li>
<li><span class="koboSpan" id="kobo.554.1">Next, we register the path with our controller. </span><span class="koboSpan" id="kobo.554.2">This is done with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.555.1">defaults</span></strong><span class="koboSpan" id="kobo.556.1"> key where we provide </span><span class="No-Break"><span class="koboSpan" id="kobo.557.1">the controller:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.558.1">
mymodule.user_redirect:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.559.1">
  path: /user-redirect</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.560.1">
  defaults:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.561.1">
    _controller: Drupal\mymodule\Controller\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.562.1">
        RedirectController::page</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.563.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.564.1">_controller</span></strong><span class="koboSpan" id="kobo.565.1"> key is the fully qualified class name with the class method to </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">be used.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.567.1">Lastly, define a requirements key to specify the access requirements. </span><span class="koboSpan" id="kobo.567.2">We want the route to always be accessible since we handle authenticate</span><a id="_idTextAnchor200"/><span class="koboSpan" id="kobo.568.1">d and </span><span class="No-Break"><span class="koboSpan" id="kobo.569.1">anonymous users:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.570.1">
mymodule.user_redirect:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.571.1">
  path: /user-redirect</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.572.1">
  defaults:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.573.1">
    _controller: Drupal\mymodule\Controller\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.574.1">
        RedirectController::page</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.575.1">
  requirements:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.576.1">
    _access: 'TRUE'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.577.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.578.1">_access</span></strong><span class="koboSpan" id="kobo.579.1"> option allows us to specify that a route is </span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">always accessible.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.581.1">Drupal </span><a id="_idIndexMarker306"/><span class="koboSpan" id="kobo.582.1">caches its routing information. </span><span class="koboSpan" id="kobo.582.2">We must rebuild Drupal’s caches in order for it to be aware of the module’s </span><span class="No-Break"><span class="koboSpan" id="kobo.583.1">new route:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.584.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.585.1">Go to </span><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">/user-redirect</span></strong><span class="koboSpan" id="kobo.587.1"> on your Drupal site as an anonymous user and you will be redirected to the user login form. </span><span class="koboSpan" id="kobo.587.2">If you are authenticated, you will be redirected to </span><span class="No-Break"><span class="koboSpan" id="kobo.588.1">the homepage.</span></span></li>
</ol>
<h2 id="_idParaDest-177"><a id="_idTextAnchor201"/><span class="koboSpan" id="kobo.589.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.590.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.591.1">RedirectResponse</span></strong><span class="koboSpan" id="kobo.592.1"> object comes from Symfony’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.593.1">HttpFoundation</span></strong><span class="koboSpan" id="kobo.594.1"> component and represents an HTTP redirect response. </span><span class="koboSpan" id="kobo.594.2">When converted into a response sent from the web server, it will set the location header to the URL provided. </span><span class="koboSpan" id="kobo.594.3">It also passes one of the valid 3xx HTTP status codes. </span><span class="koboSpan" id="kobo.594.4">The redirect response defaults to the HTTP status code of 302 Found. </span><span class="koboSpan" id="kobo.594.5">A 302 redirect is intended to be temporary and not cacheable by </span><span class="No-Break"><span class="koboSpan" id="kobo.595.1">the browser.</span></span></p>
<p><span class="koboSpan" id="kobo.596.1">Drupal can generate URLs from a given route name. </span><span class="koboSpan" id="kobo.596.2">As we have learned in previous recipes, route names are used to identify a specific path, controller, and other information. </span><span class="koboSpan" id="kobo.596.3">When invoking </span><strong class="source-inline"><span class="koboSpan" id="kobo.597.1">toString</span></strong><span class="koboSpan" id="kobo.598.1">, the URL object invokes the URL generator to convert the route</span><a id="_idIndexMarker307"/><span class="koboSpan" id="kobo.599.1"> name into </span><span class="No-Break"><span class="koboSpan" id="kobo.600.1">a URL.</span></span></p>
<h2 id="_idParaDest-178"><a id="_idTextAnchor202"/><span class="koboSpan" id="kobo.601.1">See also</span></h2>
<ul>
<li><span class="koboSpan" id="kobo.602.1">The HTTP/1.1 RFC Redirection 3xx </span><span class="No-Break"><span class="koboSpan" id="kobo.603.1">specification: </span></span><a href="https://datatracker.ietf.org/doc/html/rfc2616#section-10.3"><span class="No-Break"><span class="koboSpan" id="kobo.604.1">https://datatracker.ietf.org/doc/html/rfc2616#section-10.3</span></span></a></li>
</ul>
<h1 id="_idParaDest-179"><a id="_idTextAnchor203"/><span class="koboSpan" id="kobo.605.1">Creating a JSON response</span></h1>
<p><span class="koboSpan" id="kobo.606.1">Routes</span><a id="_idIndexMarker308"/><span class="koboSpan" id="kobo.607.1"> can also return </span><strong class="bold"><span class="koboSpan" id="kobo.608.1">JavaScript Object Notation</span></strong><span class="koboSpan" id="kobo.609.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.610.1">JSON</span></strong><span class="koboSpan" id="kobo.611.1">) responses. </span><span class="koboSpan" id="kobo.611.2">A JSON response is often used for building API routes since it is an interchange format that is supported by all programming languages. </span><span class="koboSpan" id="kobo.611.3">This allows exposing data to be consumed by a </span><span class="No-Break"><span class="koboSpan" id="kobo.612.1">third-party consumer.</span></span></p>
<p><span class="koboSpan" id="kobo.613.1">In this recipe, we will create a route that returns a JSON response containing information about the </span><span class="No-Break"><span class="koboSpan" id="kobo.614.1">Drupal site.</span></span></p>
<h2 id="_idParaDest-180"><a id="_idTextAnchor204"/><span class="koboSpan" id="kobo.615.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.616.1">First, we need to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.617.1">src/Controller</span></strong><span class="koboSpan" id="kobo.618.1"> directory in the module’s directory. </span><span class="koboSpan" id="kobo.618.2">We will put our controller class in this directory, which gives our controller class the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.619.1">Controller</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.620.1"> namespace:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.621.1">
mkdir -p src/Contr</span><a id="_idTextAnchor205"/><span class="koboSpan" id="kobo.622.1">oller</span></pre></li>
<li><span class="koboSpan" id="kobo.623.1">Create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.624.1">SiteInfoController.php</span></strong><span class="koboSpan" id="kobo.625.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.626.1">Controller</span></strong><span class="koboSpan" id="kobo.627.1"> directory. </span><span class="koboSpan" id="kobo.627.2">This will hold our </span><strong class="source-inline"><span class="koboSpan" id="kobo.628.1">SiteInfoController</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.629.1">controller class.</span></span></li>
<li><span class="koboSpan" id="kobo.630.1">Our </span><strong class="source-inline"><span class="koboSpan" id="kobo.631.1">SiteInfoController</span></strong><span class="koboSpan" id="kobo.632.1"> class will extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.633.1">ControllerBase</span></strong><span class="koboSpan" id="kobo.634.1"> base class provided by </span><span class="No-Break"><span class="koboSpan" id="kobo.635.1">Drupal core:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.636.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.637.1">
namespace Drupal\mymodule\Controller;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.638.1">
use Drupal\Core\Controller\ControllerBase;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.639.1">
use Symfony\Component\HttpFoundation\JsonResponse;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.640.1">
class SiteInfoController </span><a id="_idTextAnchor206"/><span class="koboSpan" id="kobo.641.1">extends ControllerBase {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.642.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.643.1">Following PSR-4 autoloading conventions, our class is in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.644.1">\Drupal\mymodule\Controller</span></strong><span class="koboSpan" id="kobo.645.1"> namespace, which Drupal can determine as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.646.1">src/Controller</span></strong><span class="koboSpan" id="kobo.647.1"> directory in our module. </span><span class="koboSpan" id="kobo.647.2">As per PSR-4, the filename and class name must also be </span><span class="No-Break"><span class="koboSpan" id="kobo.648.1">the same.</span></span></p>
<p><span class="koboSpan" id="kobo.649.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">\Drupal\Core\Controller\ControllerBase</span></strong><span class="koboSpan" id="kobo.651.1"> class provides a handful of utility methods that can </span><span class="No-Break"><span class="koboSpan" id="kobo.652.1">be leveraged.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.653.1">Next, we</span><a id="_idIndexMarker309"/><span class="koboSpan" id="kobo.654.1"> will create a method that returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.655.1">JsonResponse</span></strong><span class="koboSpan" id="kobo.656.1"> object. </span><span class="koboSpan" id="kobo.656.2">Add the following method to our</span><a id="_idTextAnchor207"/> <span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.657.1">SiteInfoController</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.658.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.659.1">
   /**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.660.1">
   * Returns site info in a JSON response.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.661.1">
   *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.662.1">
   * @return \Symfony\Component\HttpFoundation\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.663.1">
        JsonResponse</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.664.1">
   *   The JSON response.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.665.1">
   */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.666.1">
  public function page(): JsonResponse {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.667.1">
    return new JsonResponse();</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.668.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.669.1">The page method returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.670.1">JsonResponse</span></strong><span class="koboSpan" id="kobo.671.1"> object. </span><span class="koboSpan" id="kobo.671.2">This ensures the </span><strong class="source-inline"><span class="koboSpan" id="kobo.672.1">Content-Type</span></strong><span class="koboSpan" id="kobo.673.1"> header for the response is set </span><span class="No-Break"><span class="koboSpan" id="kobo.674.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.675.1">application/json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.676.1">.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.677.1">Let’s add content to our response object with data from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.678.1">system.sit</span><a id="_idTextAnchor208"/><span class="koboSpan" id="kobo.679.1">e</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.680.1">configuration object:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.681.1">
  /**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.682.1">
   * Returns site info in a JSON response.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.683.1">
   *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.684.1">
   * @return \Symfony\Component\HttpFoundation\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.685.1">
        JsonResponse</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.686.1">
   *   The JSON response.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.687.1">
   */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.688.1">
  public function page(): JsonResponse {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.689.1">
    $config = $this-&gt;config('system.site');</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.690.1">
    return new JsonResponse([</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.691.1">
      'name' =&gt; $config-&gt;get('name'),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.692.1">
      'slogan' =&gt; $config-&gt;get('slogan'),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.693.1">
      'email' =&gt; $config-&gt;get('mail')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.694.1">
    ]);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.695.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.696.1">We use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.697.1">config</span></strong><span class="koboSpan" id="kobo.698.1"> method provided by </span><strong class="source-inline"><span class="koboSpan" id="kobo.699.1">ControllerBase</span></strong><span class="koboSpan" id="kobo.700.1"> to retrieve the </span><strong class="source-inline"><span class="koboSpan" id="kobo.701.1">system.site</span></strong><span class="koboSpan" id="kobo.702.1"> configuration object. </span><span class="koboSpan" id="kobo.702.2">Then, we provide an associative array of data to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.703.1">JsonResponse</span></strong><span class="koboSpan" id="kobo.704.1"> object. </span><span class="koboSpan" id="kobo.704.2">The array will be converted into JSON when the response </span><span class="No-Break"><span class="koboSpan" id="kobo.705.1">is sent.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.706.1">Create </span><a id="_idIndexMarker310"/><span class="koboSpan" id="kobo.707.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.708.1">mymodule.routing.yml</span></strong><span class="koboSpan" id="kobo.709.1"> file in your module’s directory. </span><span class="koboSpan" id="kobo.709.2">This file is provided by modules to </span><span class="No-Break"><span class="koboSpan" id="kobo.710.1">define routes.</span></span></li>
<li><span class="koboSpan" id="kobo.711.1">The first step in defining a route is to provide a name for the route, which is used as its identifier for URL generation and </span><span class="No-Break"><span class="koboSpan" id="kobo.712.1">other purposes:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.713.1">
mymodule.site_info</span></pre></li>
<li><span class="koboSpan" id="kobo.714.1">Give the route </span><span class="No-Break"><span class="koboSpan" id="kobo.715.1">a path:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.716.1">
mymodule.site_info:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.717.1">
  path: /site-info</span></pre></li>
<li><span class="koboSpan" id="kobo.718.1">Next, we register the path with our controller. </span><span class="koboSpan" id="kobo.718.2">This is done with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.719.1">defaults</span></strong><span class="koboSpan" id="kobo.720.1"> key where we provide the controller and </span><span class="No-Break"><span class="koboSpan" id="kobo.721.1">page title:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.722.1">
mymodule.site_info:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.723.1">
  path: /site-info</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.724.1">
  defaults:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.725.1">
    _controller: Drupal\mymodule\Controller\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.726.1">
        SiteInfoController::page</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.727.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.728.1">_controller</span></strong><span class="koboSpan" id="kobo.729.1"> key is the fully qualified class name with the class method to </span><span class="No-Break"><span class="koboSpan" id="kobo.730.1">be used.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.731.1">Lastly, define a requirements key to speci</span><a id="_idTextAnchor209"/><span class="koboSpan" id="kobo.732.1">fy the </span><span class="No-Break"><span class="koboSpan" id="kobo.733.1">access requirements:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.734.1">
mymodule.site_info:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.735.1">
  path: /site-info</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.736.1">
  defaults:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.737.1">
    _controller: Drupal\mymodule\Controller\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.738.1">
        SiteInfoController::page</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.739.1">
  requirements:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.740.1">
    _access: 'TRUE'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.741.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.742.1">_access</span></strong><span class="koboSpan" id="kobo.743.1"> option allows the route to always </span><span class="No-Break"><span class="koboSpan" id="kobo.744.1">be accessible.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.745.1">Drupal caches its routing information. </span><span class="koboSpan" id="kobo.745.2">We must rebuild Drupal’s caches in order for it to be aware of the module’s </span><span class="No-Break"><span class="koboSpan" id="kobo.746.1">new route:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.747.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.748.1">Go to </span><strong class="source-inline"><span class="koboSpan" id="kobo.749.1">/site-info</span></strong><span class="koboSpan" id="kobo.750.1"> on your Drupal site, and you should receive a JSON response like </span><a id="_idIndexMarker311"/><span class="No-Break"><span class="koboSpan" id="kobo.751.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.752.1">
{</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.753.1">
  "name": "Drupal Development Cookbook",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.754.1">
  "slogan": "Practical recipes to harness the power of</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.755.1">
    Drupal 10.",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.756.1">
  "email": "admin@example.com"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.757.1">
}</span></pre></li>
</ol>
<h2 id="_idParaDest-181"><a id="_idTextAnchor210"/><span class="koboSpan" id="kobo.758.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.759.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.760.1">JsonResponse</span></strong><span class="koboSpan" id="kobo.761.1"> object</span><a id="_idIndexMarker312"/><span class="koboSpan" id="kobo.762.1"> is used to represent a JSON </span><a id="_idIndexMarker313"/><span class="koboSpan" id="kobo.763.1">response. </span><span class="koboSpan" id="kobo.763.2">Its constructor receives an array or object of data and passes it to PHP’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.764.1">json_encode</span></strong><span class="koboSpan" id="kobo.765.1"> function for you. </span><span class="koboSpan" id="kobo.765.2">It sets the response’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.766.1">Content-Type</span></strong><span class="koboSpan" id="kobo.767.1"> header to </span><span class="No-Break"><span class="koboSpan" id="kobo.768.1">be </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.769.1">application/json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.770.1">.</span></span></p>
<h2 id="_idParaDest-182"><a id="_idTextAnchor211"/><span class="koboSpan" id="kobo.771.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.772.1">The JSON response controller can be enhanced to leverage the harness-caching capabilities </span><span class="No-Break"><span class="koboSpan" id="kobo.773.1">of Drupal.</span></span></p>
<h3><span class="koboSpan" id="kobo.774.1">Caching JSON responses with Drupal</span></h3>
<p><span class="koboSpan" id="kobo.775.1">Drupal </span><a id="_idIndexMarker314"/><span class="koboSpan" id="kobo.776.1">also provides </span><strong class="source-inline"><span class="koboSpan" id="kobo.777.1">\Drupal\Core\Cache\CacheableJsonResponse</span></strong><span class="koboSpan" id="kobo.778.1">. </span><span class="koboSpan" id="kobo.778.2">This extends </span><strong class="source-inline"><span class="koboSpan" id="kobo.779.1">JsonResponse</span></strong><span class="koboSpan" id="kobo.780.1"> and allows the response to be cached by Drupal’s page caching. </span><span class="koboSpan" id="kobo.780.2">However, you will want to make the </span><strong class="source-inline"><span class="koboSpan" id="kobo.781.1">system.site</span></strong><span class="koboSpan" id="kobo.782.1"> configuration object a cacheable dependency of the response. </span><span class="koboSpan" id="kobo.782.2">That way the response cache is invalidated if that configuration object </span><span class="No-Break"><span class="koboSpan" id="kobo.783.1">is changed.</span></span></p>
<p><span class="koboSpan" id="kobo.784.1">The code would be updated with </span><span class="No-Break"><span class="koboSpan" id="kobo.785.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.786.1">
class SiteInfoController extends ControllerBase {
  /**
   * Returns site info in a JSON response.
</span><span class="koboSpan" id="kobo.786.2">   *
   * @return \Symfony\Component\HttpFoundation\JsonResponse
   *   The JSON response.
</span><span class="koboSpan" id="kobo.786.3">   */
  public function page(): JsonResponse {
    $config = $this-&gt;config('system.site');
    $response = new \Drupal\Core\Cache\
        CacheableJsonResponse([
      'name' =&gt; $config-&gt;get('name'),
      'slogan' =&gt; $config-&gt;get('slogan'),
      'email' =&gt; $config-&gt;get('mail')
    ]);
    $response-&gt;addCacheableDependency($config);
    return $response;
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.787.1">The main </span><a id="_idIndexMarker315"/><span class="koboSpan" id="kobo.788.1">difference is that we do not directly return the response object. </span><span class="koboSpan" id="kobo.788.2">We set the configuration object as a cacheable </span><span class="No-Break"><span class="koboSpan" id="kobo.789.1">dependency, first.</span></span></p>
<h2 id="_idParaDest-183"><a id="_idTextAnchor212"/><span class="koboSpan" id="kobo.790.1">See also</span></h2>
<ul>
<li><a href="B18548_12.xhtml#_idTextAnchor383"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.791.1">Chapter 12</span></em></span></a><span class="koboSpan" id="kobo.792.1">, </span><em class="italic"><span class="koboSpan" id="kobo.793.1">Building APIs </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.794.1">with Drupal</span></em></span></li>
</ul>
<h1 id="_idParaDest-184"><a id="_idTextAnchor213"/><span class="koboSpan" id="kobo.795.1">Serving files for download</span></h1>
<p><span class="koboSpan" id="kobo.796.1">Routes </span><a id="_idIndexMarker316"/><span class="koboSpan" id="kobo.797.1">can be used to serve file downloads with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.798.1">BinaryFileResponse</span></strong><span class="koboSpan" id="kobo.799.1"> response object. </span><span class="koboSpan" id="kobo.799.2">Using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.800.1">BinaryFileResponse</span></strong><span class="koboSpan" id="kobo.801.1"> to serve a file for download allows you to keep the original file’s URL private or to send dynamic content as a </span><span class="No-Break"><span class="koboSpan" id="kobo.802.1">file download.</span></span></p>
<p><span class="koboSpan" id="kobo.803.1">In this recipe, we will create a route that provides a download for </span><span class="No-Break"><span class="koboSpan" id="kobo.804.1">a PDF.</span></span></p>
<h2 id="_idParaDest-185"><a id="_idTextAnchor214"/><span class="koboSpan" id="kobo.805.1">Getting started</span></h2>
<p><span class="koboSpan" id="kobo.806.1">This recipe uses a PDF file that is located in the same directory as the module. </span><span class="koboSpan" id="kobo.806.2">You can use any other available file type, such as a text file. </span><span class="koboSpan" id="kobo.806.3">A test PDF can be found on the World Wide Web Consortium website </span><span class="No-Break"><span class="koboSpan" id="kobo.807.1">at </span></span><a href="https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf"><span class="No-Break"><span class="koboSpan" id="kobo.808.1">https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.809.1">.</span></span></p>
<h2 id="_idParaDest-186"><a id="_idTextAnchor215"/><span class="koboSpan" id="kobo.810.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.811.1">First, we need to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.812.1">src/Controller</span></strong><span class="koboSpan" id="kobo.813.1"> directory in the module’s directory. </span><span class="koboSpan" id="kobo.813.2">We will put our controller class in this directory, which gives our controller class the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.814.1">Controller</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.815.1"> namespace:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.816.1">
mkdir -p src/Controller</span></pre></li>
<li><span class="koboSpan" id="kobo.817.1">Create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.818.1">DownloadController.php</span></strong><span class="koboSpan" id="kobo.819.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.820.1">Controller</span></strong><span class="koboSpan" id="kobo.821.1"> directory. </span><span class="koboSpan" id="kobo.821.2">This will hold our </span><strong class="source-inline"><span class="koboSpan" id="kobo.822.1">DownloadController</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.823.1">controller class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.824.1">
&lt;?php</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.825.1">
namespace Drupal\mymodule\Controller;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.826.1">
class SiteInfoController {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.827.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.828.1">Following PSR-4 autoloading conventions, our class is in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.829.1">\Drupal\mymodule\Controller</span></strong><span class="koboSpan" id="kobo.830.1"> namespace, which Drupal is able to determine as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.831.1">src/Controller</span></strong><span class="koboSpan" id="kobo.832.1"> directory in our module. </span><span class="koboSpan" id="kobo.832.2">As per PSR-4, the filename and class name must also be </span><span class="No-Break"><span class="koboSpan" id="kobo.833.1">the same.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.834.1">Next, we</span><a id="_idIndexMarker317"/><span class="koboSpan" id="kobo.835.1"> will create a method that returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.836.1">BinaryFileResponse</span></strong><span class="koboSpan" id="kobo.837.1"> object. </span><span class="koboSpan" id="kobo.837.2">Add the following method to our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.838.1">DownloadController</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.839.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.840.1">
  /**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.841.1">
   * Downloads a file.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.842.1">
   *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.843.1">
   * @return \Symfony\Component\HttpFoundation\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.844.1">
        BinaryFileResponse</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.845.1">
   *   The file response.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.846.1">
   */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.847.1">
  public function page(): BinaryFileResponse {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.848.1">
    // File paths are relative to the document root</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.849.1">
         (web.)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.850.1">
    $file_path = 'modules/custom/mymodule/dummy.pdf';</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.851.1">
    $response = new BinaryFileResponse($file_path);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.852.1">
    $response-&gt;setContentDisposition('attachment',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.853.1">
        basename($file_path));</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.854.1">
    return $response;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.855.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.856.1">The page method returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.857.1">BinaryFileResponse</span></strong><span class="koboSpan" id="kobo.858.1"> object. </span><span class="koboSpan" id="kobo.858.2">We define a file path where our PDF exists. </span><span class="koboSpan" id="kobo.858.3">The file path may be relative to Drupal’s document root (web). </span><span class="koboSpan" id="kobo.858.4">Our module’s directory is </span><strong class="source-inline"><span class="koboSpan" id="kobo.859.1">modules/custom/mymodule</span></strong><span class="koboSpan" id="kobo.860.1"> relative to the document root. </span><span class="koboSpan" id="kobo.860.2">We set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.861.1">Content-Disposition</span></strong><span class="koboSpan" id="kobo.862.1"> header to attachment and specify a filename so that the file automatically downloads. </span><span class="koboSpan" id="kobo.862.2">We use PHP’s basename function to get the filename from </span><span class="No-Break"><span class="koboSpan" id="kobo.863.1">the path.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.864.1">The </span><a id="_idIndexMarker318"/><span class="koboSpan" id="kobo.865.1">controller is almost ready. </span><span class="koboSpan" id="kobo.865.2">We should also provide a </span><strong class="source-inline"><span class="koboSpan" id="kobo.866.1">Content-Type</span></strong><span class="koboSpan" id="kobo.867.1"> header for the response. </span><span class="koboSpan" id="kobo.867.2">Using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.868.1">file.mime_type.guesser</span></strong><span class="koboSpan" id="kobo.869.1"> service, we can get the correct </span><span class="No-Break"><span class="koboSpan" id="kobo.870.1">header value:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.871.1">
  /**</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.872.1">
   * Downloads a file.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.873.1">
   *</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.874.1">
   * @return \Symfony\Component\HttpFoundation\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.875.1">
        BinaryFileResponse</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.876.1">
   *   The file response.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.877.1">
   */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.878.1">
  public function page(): BinaryFileResponse {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.879.1">
    // File paths are relative to the document root</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.880.1">
         (web.)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.881.1">
    $file_path = 'modules/custom/mymodule/dummy.pdf';</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.882.1">
    /** @var \Drupal\Core\File\MimeType\</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.883.1">
        MimeTypeGuesser $guesser */</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.884.1">
    $guesser = \Drupal::service</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.885.1">
         ('file.mime_type.guesser');</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.886.1">
    $mime_type = $guesser-&gt;guessMimeType($file_path);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.887.1">
    $response = new BinaryFileResponse($file_path);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.888.1">
    $response-&gt;headers-&gt;set('Content-Type',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.889.1">
        $mimetype);</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.890.1">
    $response-&gt;setContentDisposition('attachment',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.891.1">
        basename($file_path));</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.892.1">
    return $response;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.893.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.894.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.895.1">file.mime_type.guesser</span></strong><span class="koboSpan" id="kobo.896.1"> service is used to determine the appropriate MIME type for a file based on its extension. </span><span class="koboSpan" id="kobo.896.2">In this case, it would </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.897.1">return application/pdf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.898.1">.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.899.1">Create </span><strong class="source-inline"><span class="koboSpan" id="kobo.900.1">mymodule.routing.yml</span></strong><span class="koboSpan" id="kobo.901.1"> file in your module’s directory. </span><span class="koboSpan" id="kobo.901.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.902.1">routing.yml</span></strong><span class="koboSpan" id="kobo.903.1"> file is provided by modules to </span><span class="No-Break"><span class="koboSpan" id="kobo.904.1">define routes.</span></span></li>
<li><span class="koboSpan" id="kobo.905.1">The</span><a id="_idIndexMarker319"/><span class="koboSpan" id="kobo.906.1"> first step in defining a route is to provide a name for the route, which is used as its identifier for URL generation and </span><span class="No-Break"><span class="koboSpan" id="kobo.907.1">other purposes:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.908.1">
mymodule.pdf_download</span></pre></li>
<li><span class="koboSpan" id="kobo.909.1">Give the route </span><span class="No-Break"><span class="koboSpan" id="kobo.910.1">a path:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.911.1">
mymodule.pdf_download:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.912.1">
  path: /pdf-download</span></pre></li>
<li><span class="koboSpan" id="kobo.913.1">Next, we register the path with our controller. </span><span class="koboSpan" id="kobo.913.2">This is done with the defaults key where we provide the controller and </span><span class="No-Break"><span class="koboSpan" id="kobo.914.1">page title:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.915.1">
mymodule.pdf_download:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.916.1">
  path: /pdf-download</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.917.1">
  defaults:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.918.1">
    _controller: Drupal\mymodule\Controller</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.919.1">
        \DownloadController::page</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.920.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.921.1">_controller</span></strong><span class="koboSpan" id="kobo.922.1"> key is the fully qualified class name with the class method to </span><span class="No-Break"><span class="koboSpan" id="kobo.923.1">be used.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.924.1">Lastly, define</span><a id="_idIndexMarker320"/><span class="koboSpan" id="kobo.925.1"> a requirements key to specify the </span><span class="No-Break"><span class="koboSpan" id="kobo.926.1">access requirements:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.927.1">
mymodule.pdf_download:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.928.1">
  path: /pdf-download</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.929.1">
  defaults:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.930.1">
    _controller: Drupal\mymodule\Controller</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.931.1">
        \DownloadController::page</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.932.1">
  requirements:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.933.1">
    _user_is_logged_in: 'TRUE'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.934.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.935.1">_user_is_logged_in</span></strong><span class="koboSpan" id="kobo.936.1"> option requires a user to be authenticated to access </span><span class="No-Break"><span class="koboSpan" id="kobo.937.1">the route.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.938.1">Drupal caches its routing information. </span><span class="koboSpan" id="kobo.938.2">We must rebuild Drupal’s caches in order for it to be aware of the module’s </span><span class="No-Break"><span class="koboSpan" id="kobo.939.1">new route:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.940.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.941.1">Go to </span><strong class="source-inline"><span class="koboSpan" id="kobo.942.1">/pdf-download</span></strong><span class="koboSpan" id="kobo.943.1"> on your Drupal site, and you will be prompted to download the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.944.1">dummy.pdf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.945.1"> file.</span></span></li>
</ol>
<h2 id="_idParaDest-187"><a id="_idTextAnchor216"/><span class="koboSpan" id="kobo.946.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.947.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.948.1">BinaryFileResponse</span></strong><span class="koboSpan" id="kobo.949.1"> stores information about the file until the response is prepared to be sent. </span><span class="koboSpan" id="kobo.949.2">When the response is prepared to be sent, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.950.1">Content-Length</span></strong><span class="koboSpan" id="kobo.951.1"> header is populated based on the file size. </span><span class="koboSpan" id="kobo.951.2">Then, when the response is sent, the contents of the file are streamed to the visitor via the </span><span class="No-Break"><span class="koboSpan" id="kobo.952.1">web server.</span></span></p>
</div>
</body></html>