<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Log in to the App"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Log in to the App</h1></div></div></div><p>This chapter will explain how to set up login authentication and authorization. Logging in is a fundamental step to protect our application and you will learn how to reach these goals from scratch, using the web management free extension that is broadly available on the Internet.</p><p>We will cover the following topics in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating a user login:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For example: creating login form to access</li></ul></div></li><li class="listitem" style="list-style-type: disc">Configure a user authorization<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For example: creating an access control filter to authorize</li></ul></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Role Based Access Control</strong></span> (<span class="strong"><strong>RBAC</strong></span>)<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For example: configuring RBAC to set permissions for users</li></ul></div></li><li class="listitem" style="list-style-type: disc">Mixing <span class="strong"><strong>Access Control Filter</strong></span> (<span class="strong"><strong>ACF</strong></span>) and RBAC<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For example: managing users' roles to access rooms, reservations, and customers</li></ul></div></li></ul></div><p>The first step will be creating an authenticated access to our app using a database table to manage users and associate it to the Yii user component, through a user model that extends <code class="literal">IdentityInterface</code>. We will provide an example of how to use it: building a login form to authenticate the user.</p><p>The next step will be to control what actions a user can perform, using ACF and RBAC. We will follow some examples using ACF and RBAC, and in the latter case we will build a complete authorization manager from scratch.</p><div class="section" title="Creating a user login"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec59"/>Creating a user login</h1></div></div></div><p>The application's<a id="id363" class="indexterm"/> security starts with two well distinguished phases of the same user login: authentication and authorization.</p><p>The first one, authentication, is the process of verifying a user's identity, usually using a username and password, or email and password, process. Authentication is completed when the user has been recognized and their state has been preserved for further requests.</p><p>The second one, authorization, is the process of verifying that the user has the permission to execute a specific action.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note50"/>Note</h3><p>Since http requests are stateless, we need to preserve the login status, which means that there is no data context sharing among them. This limit is solved by sessions, mainly files where the web server stores the data. A filename is used as a session identifier and passed to the browser through a cookie or URL parameter of links contained in the HTML response. In this way, the browser keeps the session active by sending the session identifier to the web server through a cookie or a parameter in the request URL, and the web server knows which file contains the session data.</p><p>A database table can be used instead of files with the same functionalities.</p></div></div><p>Yii2 implements authentication through the <code class="literal">yii\web\User</code> component, which manages the user authentication status and also contains a reference to the <code class="literal">identityClass</code> that represents the concrete object that we are referring to.</p><p>An <code class="literal">identityClass</code> class<a id="id364" class="indexterm"/> should implement five methods:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">findIdentity()</code>: This<a id="id365" class="indexterm"/> method looks for an instance of an identity class using the ID provided as parameter. It is commonly used when we need to keep the login status via a session.</li><li class="listitem" style="list-style-type: disc"><code class="literal">findIdentityByAccessToken()</code>: This one looks for an instance of the identity class using the <a id="id366" class="indexterm"/>access token provided by the parameter. It is commonly used when we need to authenticate using a single secret token.</li><li class="listitem" style="list-style-type: disc"><code class="literal">getId()</code>: This<a id="id367" class="indexterm"/> one returns the ID of the identity instance.</li><li class="listitem" style="list-style-type: disc"><code class="literal">getAuthKey()</code>: This <a id="id368" class="indexterm"/>method returns the key used to verify the cookie-based login when the login has been completed using a cookie sent by the  browser (when <span class="strong"><strong>Remember me</strong></span> is checked during the login).</li><li class="listitem" style="list-style-type: disc"><code class="literal">validateAuthKey()</code>: This<a id="id369" class="indexterm"/> method <a id="id370" class="indexterm"/>verifies that the provided <code class="literal">authKey</code> passed as a parameter is correct (in the cookie-based login).</li></ul></div><p>Often the <code class="literal">identityClass</code> class corresponds to a record of the <code class="literal">User</code> database table. For this reason, usually the <code class="literal">identityClass</code> class implements <code class="literal">IdentityInterface</code> and extends <code class="literal">ActiveRecord</code>.</p><p>It is now time to implement authentication. The first thing to do is to configure <code class="literal">yii\web\User</code> components and its <code class="literal">identityClass</code>. Open the <code class="literal">basic/config/web.php</code> file and add the <code class="literal">user</code> property to <code class="literal">components</code> if it does not already exist:</p><div class="informalexample"><pre class="programlisting">    'components' =&gt; [
        …
        …
        'user' =&gt; [
            'identityClass' =&gt; 'app\models\User',
        ],
    ],</pre></div><p>Next, we have to <a id="id371" class="indexterm"/>create a database table where we store the users' records:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `user` (
 `id` int(11) NOT NULL AUTO_INCREMENT,
 `username` varchar(255) NOT NULL,
 `auth_key` varchar(32) NOT NULL,
 `password_hash` varchar(255) NOT NULL,
 `access_token` varchar(100) DEFAULT NULL,
 PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note51"/>Note</h3><p>Notice that we do not have a password field, but we have a <code class="literal">password_hash</code> field. This because passwords are stored using the hashing method. In models, we will have a setter <code class="literal">setPassword()</code> method that gets plain text passwords to fill in the <code class="literal">password_hash</code> field.</p></div></div><p>Finally, let's update the <code class="literal">basic/models/User</code> class that handles the login status by implementing <code class="literal">IdentityInterface</code> and connect it to the <code class="literal">user</code> table of database. This is a common implementation for <code class="literal">basic/models/User</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\models;

use Yii;
use yii\base\NotSupportedException;
use yii\db\ActiveRecord;
use yii\web\IdentityInterface;

class User extends ActiveRecord implements IdentityInterface
{
    public static function tableName()
    {
        return 'user';
    }

    public static function findIdentity($id)
    {
        return static::findOne(['id' =&gt; $id]);
    }

    public static function findIdentityByAccessToken($token, $type = null)
    {
        return static::findOne(['access_token' =&gt; $token]);
    }

    public static function findByUsername($username)
    {
        return static::findOne(['username' =&gt; $username]);
    }

    public function getId()
    {
        return $this-&gt;getPrimaryKey();
    }

    public function getAuthKey()
    {
        return $this-&gt;auth_key;
    }

    public function validateAuthKey($authKey)
    {
        return $this-&gt;getAuthKey() === $authKey;
    }

    public function validatePassword($password)
    {
        return Yii::$app-&gt;security-&gt;validatePassword($password, $this-&gt;password_hash);
    }

    public function setPassword($password)
    {
        $this-&gt;password_hash = Yii::$app-&gt;security-&gt;generatePasswordHash($password);
    }

    public function generateAuthKey()
    {
        $this-&gt;auth_key = Yii::$app-&gt;security-&gt;generateRandomString();
    }

}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note52"/>Note</h3><p>If our application also uses a cookie-based authentication, we need to fill in the <code class="literal">auth_key</code> field too, as this will be passed to the client in the http response. It is convenient to populate the <code class="literal">auth_key</code> field automatically when a new user is inserted by overriding the <code class="literal">beforeSave()</code> method in the <code class="literal">\app\models\User</code> model:</p><div class="informalexample"><pre class="programlisting">    public function beforeSave($insert)
    {
        if (parent::beforeSave($insert)) {
            if ($this-&gt;isNewRecord) {
                $this-&gt;auth_key = \Yii::$app-&gt;security-&gt;generateRandomString();
            }
            return true;
        }
        return false;
    }</pre></div></div></div><p>User components<a id="id372" class="indexterm"/> provide methods to log in, log out, and access the <code class="literal">identityClass</code>, and they verify the effectiveness of the user authentication.</p><p>To verify whether the user is well authenticated, use the following:</p><div class="informalexample"><pre class="programlisting">// whether the current user is a guest (not authenticated)
$isGuest = Yii::$app-&gt;user-&gt;isGuest;</pre></div><p>When a user is authenticated and we have an instance of the <code class="literal">\app\models\User</code> model, we could complete the authentication by calling:</p><div class="informalexample"><pre class="programlisting">// find a user identity with the specified username.
// note that you may want to check the password if needed
$userModel = User::findOne(['username' =&gt; $username]);

// logs in the user
Yii::$app-&gt;user-&gt;login($userModel);</pre></div><p>Then, when we <a id="id373" class="indexterm"/>need to access the identity class:</p><div class="informalexample"><pre class="programlisting">// access to identity class that it is equivalent to $userModel
$identity = Yii::$app-&gt;user-&gt;identity;</pre></div><p>Finally, to log the user out:</p><div class="informalexample"><pre class="programlisting">Yii::$app-&gt;user-&gt;logout();</pre></div><div class="section" title="Example – a login form to access"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec39"/>Example – a login form to access</h2></div></div></div><p>In this example, we will create a <a id="id374" class="indexterm"/>login form and complete the user authentication. To proceed it is necessary to create a <code class="literal">user</code> database table from a SQL query, as described in the previous paragraph.</p><p>To add a user, just insert a new record in the <code class="literal">user</code> table, with <code class="literal">foo</code> as the username and <code class="literal">foopassword</code> as the password:</p><div class="informalexample"><pre class="programlisting">INSERT INTO `user` (
`username` ,
`password_hash` ,
)
VALUES (
'foo',
'$2a$12$hL0rmIMjxhLqI.xr7jD1FugNWEgZNh62HuJj5.y34XBUfBWB4cppW'
);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note53"/>Note</h3><p>A password is hashed using the bcrypt method and cost with value 12, available on the Internet through a quick Google search.</p></div></div><p>Then, create a new controller named <code class="literal">MyAuthentication</code> in <code class="literal">basic/controllers/MyAuthenticationController.php</code> and ensure it contains two actions: <code class="literal">actionLogin</code> and <code class="literal">actionLogout</code>.</p><p>The <code class="literal">actionLogin</code> method gets the username and password data from <code class="literal">$_POST</code> and uses an <code class="literal">$error</code> variable to pass an error description to the view. If the username and password data is filled in, the user will be found in the database table and the inserted password will be validated, and after that the user will be logged in.</p><p>Finally, <code class="literal">actionLogout</code> simply logs the user out from the session and redirects the browser to the login page:</p><div class="informalexample"><pre class="programlisting">&lt;?php

namespace app\controllers;

use Yii;
use yii\web\Controller;

use app\models\User;


class MyAuthenticationController extends Controller
{
    public function actionLogin()
    {
        $error = null;
        
        $username = Yii::$app-&gt;request-&gt;post('username', null);
        $password = Yii::$app-&gt;request-&gt;post('password', null);
        
        $user = User::findOne(['username' =&gt; $username]);
        
        if(($username!=null)&amp;&amp;($password!=null))
        {
            if($user != null)
            {
                if($user-&gt;validatePassword($password))
                {
                    Yii::$app-&gt;user-&gt;login($user);
                }
                else {
                    $error = 'Password validation failed!';
                }
            }
            else
            {
                $error = 'User not found';
            }
        }
        
        return $this-&gt;render('login', ['error' =&gt; $error]);
    }
    public function actionLogout()
    {
        Yii::$app-&gt;user-&gt;logout();
        return $this-&gt;redirect(['login']);
    }
    
}</pre></div><p>Now, create the view with this<a id="id375" class="indexterm"/> content in <code class="literal">basic/views/my-authentication/login.php</code>. Before a user can log in, a form with the username and password to be filled in will be displayed. When the username and password match an entry in the user database table, a confirmation message and a logout button will be displayed:</p><div class="informalexample"><pre class="programlisting">&lt;?php
use \yii\bootstrap\ActiveForm;
use \yii\helpers\Html;
use \yii\bootstrap\Alert;
?&gt;

&lt;?php
if($error != null) {
    echo Alert::widget([ 'options' =&gt; [ 'class' =&gt; 'alert-danger' ], 'body' =&gt; $error ]);    
}
?&gt;

&lt;?php if(Yii::$app-&gt;user-&gt;isGuest) { ?&gt;

    &lt;?php ActiveForm::begin(); ?&gt;
    
    &lt;div class="form-group"&gt;
    &lt;?php echo Html::label('Username', 'username'); ?&gt;
    &lt;?php echo Html::textInput('username', '', ['class' =&gt; 'form-control']); ?&gt;
    &lt;/div&gt;
    
    &lt;div class="form-group"&gt;
    &lt;?php echo Html::label('Password', 'password'); ?&gt;
    &lt;?php echo Html::passwordInput('password', '', ['class' =&gt; 'form-control']); ?&gt;
    &lt;/div&gt;
    
    &lt;?php echo Html::submitButton('Login', ['class' =&gt; 'btn btn-primary']); ?&gt;

    &lt;?php ActiveForm::end(); ?&gt;
   
&lt;?php } else { ?&gt;
    
    &lt;h2&gt;You are authenticated!&lt;/h2&gt;
    &lt;br /&gt;&lt;br /&gt;
    &lt;?php echo Html::a('Logout',  ['my-authentication/logout'], ['class' =&gt; 'btn btn-warning']); ?&gt;
        
&lt;?php } ?&gt;</pre></div><p>Test it by pointing the <a id="id376" class="indexterm"/>browser to <code class="literal">http://hostname/basic/web/my-authentication/login</code> and after filling out the form with <code class="literal">foo</code> as the username and <code class="literal">foopassword</code> as the password, this should be displayed:</p><div class="mediaobject"><img src="graphics/B04656_08_01.jpg" alt="Example – a login form to access"/><div class="caption"><p>Login form to access</p></div></div><p>After clicking on the <span class="strong"><strong>Login</strong></span> button, you should see:</p><div class="mediaobject"><img src="graphics/B04656_08_02.jpg" alt="Example – a login form to access"/><div class="caption"><p>Successful authentication</p></div></div><p>This method does not<a id="id377" class="indexterm"/> provide error handling for the fields, because we are not using a model to create form fields. If we had created a form model with username and password fields, we could have added rules validation to this model and seen input error handling (such as missing field value, wrong field length, and so on). Fortunately, Yii2 has a login form model ready to use in <code class="literal">basic/models/LoginForm.php</code>.</p><p>If we had wanted to use this model, we would have created a new action named <code class="literal">actionLoginWithForm</code> in <code class="literal">MyAuthenticationController</code> that handles login fields through the model instead of parameters from <code class="literal">$_POST</code>:</p><div class="informalexample"><pre class="programlisting">    public function actionLoginWithModel()
    {
        $error = null;
        
        $model = new \app\models\LoginForm();
        if ($model-&gt;load(Yii::$app-&gt;request-&gt;post())) {
            if(($model-&gt;validate())&amp;&amp;($model-&gt;user != null))
            {
                Yii::$app-&gt;user-&gt;login($model-&gt;user);
            }
            else
            {
                $error = 'Username/Password error';
            }
        }
        
        return $this-&gt;render('login-with-model', ['model' =&gt; $model, 'error' =&gt; $error]);
    }</pre></div><p>This is the content of <code class="literal">basic/views/my-authentication/login-with-model.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
use \yii\bootstrap\ActiveForm;
use \yii\helpers\Html;
use \yii\bootstrap\Alert;
?&gt;

&lt;?php
if($error != null) {
    echo Alert::widget([ 'options' =&gt; [ 'class' =&gt; 'alert-danger' ], 'body' =&gt; $error ]);    
}
?&gt;
&lt;?php if(Yii::$app-&gt;user-&gt;isGuest) { ?&gt;

    &lt;?php $form = ActiveForm::begin([
        'id' =&gt; 'login-form',
    ]); ?&gt;

    &lt;?= $form-&gt;field($model, 'username') ?&gt;

    &lt;?= $form-&gt;field($model, 'password')-&gt;passwordInput() ?&gt;

    &lt;div class="form-group"&gt;
        &lt;?= Html::submitButton('Login', ['class' =&gt; 'btn btn-primary', 'name' =&gt; 'login-button']) ?&gt;
    &lt;/div&gt;

    &lt;?php ActiveForm::end(); ?&gt;
   
&lt;?php } else { ?&gt;
    &lt;h2&gt;You are authenticated!&lt;/h2&gt;
    &lt;br /&gt;&lt;br /&gt;
    &lt;?php echo Html::a('Logout',  ['my-authentication/logout'], ['class' =&gt; 'btn btn-warning']); ?&gt;    
&lt;?php } ?&gt;    </pre></div><p>We can look at the <a id="id378" class="indexterm"/>output by pointing our browser to <code class="literal">http://hostname/basic/web/my-authentication/login-with-model</code>.</p><p>If we try to submit the form without filling out all the fields, we will immediately get errors because they are activated by the form client-side validation:</p><div class="mediaobject"><img src="graphics/B04656_08_03.jpg" alt="Example – a login form to access"/><div class="caption"><p>Login error using the model</p></div></div><p>We can customize the <code class="literal">LoginForm</code> model class as we want if standard behavior is not enough for<a id="id379" class="indexterm"/> our purposes.</p></div></div></div>
<div class="section" title="Configuring user authorization"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec60"/>Configuring user authorization</h1></div></div></div><p>Yii has two <a id="id380" class="indexterm"/>methods to authorize users: ACF and RBAC.</p><p>The first one, ACF, is used in applications that require a minimal and simple access control. Basically, its behavior is based on five parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">allow</code>: This parameter specifies whether this is an allow or deny rule; possible values are <code class="literal">allow</code> or <code class="literal">deny</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">actions</code>: This parameter specifies which actions this rule matches, and they are declared using an array of string</li><li class="listitem" style="list-style-type: disc"><code class="literal">roles</code>: This parameter specifies which user roles this rule matches; possible values are <code class="literal">?</code>' and <code class="literal">@</code>, which mean respectively guest user and authenticated user</li><li class="listitem" style="list-style-type: disc"><code class="literal">ips</code>: This parameter specifies which client IP address this rule matches; the IP address that can contain <code class="literal">*</code> as a wildcard</li><li class="listitem" style="list-style-type: disc"><code class="literal">verbs</code>: This parameter specifies which verb (request method) this rules matches</li></ul></div><p>By default, if no rule matches, access will be denied.</p><p>ACF is enabled by overwriting the <code class="literal">behaviors()</code> method of <code class="literal">Controller</code> and populating its <code class="literal">access</code> property with the content of some (or every one) of the preceding parameters.</p><div class="informalexample"><pre class="programlisting">    public function behaviors()
    {
        return [
            'access' =&gt; [
                'class' =&gt; AccessControl::className(),
                'only' =&gt; ['login', 'logout', 'signup', 'index'],
                'rules' =&gt; [
                    [
                        'allow' =&gt; true,
                        'actions' =&gt; ['login', 'signup', 'index'],
                        'roles' =&gt; ['?'],
                    ],
                    [
                        'allow' =&gt; true,
                        'actions' =&gt; ['logout'],
                        'roles' =&gt; ['@'],
                    ],
                ],
            ],
        ];
    }</pre></div><p>In this example, the <code class="literal">login</code>, <code class="literal">logout</code>, <code class="literal">signup</code>, and <code class="literal">index</code> actions are enabled for guest users (all users) and the logout action is enabled only for authenticated ones.</p><p>ACF has many other parameters that can be defined, such as <code class="literal">controllers</code> , to define which controllers this rule matches (if it is empty, this means all controllers); <code class="literal">matchCallback</code> whose value is a PHP callable function called to verify whether this rule can be applied or not; and finally <code class="literal">denyCallback</code>, whose value is a PHP callable function used when this rule will deny access.</p><p>When a rule is denied, there are two different behaviors according to the role of the user. If a guest is denied, a denied rule will call the <code class="literal">yii\web\User::loginRequired()</code> method to redirect the user's browser to the login page; if the user is authenticated, it will throw a <code class="literal">yii\web\ForbiddenHttpException</code> exception.</p><p>This behavior can be customized using the <code class="literal">denyCallback</code> property mentioned earlier, and by defining the correct callable PHP function.</p><p>Obviously, any detail about the logged in user is not considered by this type of authorization. During configuration in the <code class="literal">behaviors()</code> method, in fact, no detail about the user ever appears (for example, <code class="literal">role</code>). So we cannot define more precisely which conditions a user can execute or not a controller action.</p><p>ACF suggests only <a id="id381" class="indexterm"/>if we have to limit access to an authenticated user, without needing some other details to allow the controller action to be executed.</p><p>But in all those cases in which it is enough to limit access based on the condition that the user is logged in or not, it is the best approach. In the REST API with limited access (where only the authenticated users are able to make calls), ACF is probably the best solution.</p><div class="section" title="Example – creating an ACF to authorize the users"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec40"/>Example – creating an ACF to authorize the users</h2></div></div></div><p>Now let's look at how to create an<a id="id382" class="indexterm"/> ACF to authorize the user to display or<a id="id383" class="indexterm"/> not display the page content.</p><p>We have two actions: <code class="literal">actionPrivatePage</code> and <code class="literal">actionPublicPage</code>. The first one is accessible only from an authenticated user and the second one is publically accessible.</p><p>In <code class="literal">MyAuthenticationController.php</code>, let's add the <code class="literal">behaviors()</code> method with the following content:</p><div class="informalexample"><pre class="programlisting">    public function behaviors()
    {
        return [
            'access' =&gt; [
                'class' =&gt; AccessControl::className(),
                'only' =&gt; ['public-page', 'private-page'],
                'rules' =&gt; [
                    [
                        'allow' =&gt; true,
                        'actions' =&gt; ['public-page'],
                        'roles' =&gt; ['?'],
                    ],
                    [
                        'allow' =&gt; true,
                        'actions' =&gt; ['private-page'],
                        'roles' =&gt; ['@'],

                    ],
                ],
                
                // Callable function when user is denied
                'denyCallback' =&gt; function($rule, $data) {
                        $this-&gt;redirect(['login']);
                }
            ],
        ];
    }</pre></div><p>This method applies an <a id="id384" class="indexterm"/>ACF to only two actions, <code class="literal">actionPublicPage</code> and <code class="literal">actionPrivatePage</code> (based only on the property value) and restricts<a id="id385" class="indexterm"/> access for private pages that specify the roles as <code class="literal">@</code>.</p><p>Then, we added the <code class="literal">denyCallback</code> property to indicate how the behavior should appear when access is denied to the user. In this case, we set it so that the user should be redirected to the <code class="literal">login</code> action of <code class="literal">MyAuthenticationController</code>.</p></div><div class="section" title="RBAC"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec41"/>RBAC</h2></div></div></div><p>RBAC<a id="id386" class="indexterm"/> is the right choice when we need more granularity of authorization controls.</p><p>RBAC involves two parts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The first one is to build up the RBAC authorization data</li><li class="listitem" style="list-style-type: disc">The second one is to use the authorization data to perform further access controls</li></ul></div><p>We'll start now <a id="id387" class="indexterm"/>by building up the RBAC authorization data. RBAC can be initialized in two ways: through PhpManager, instancing the <code class="literal">yii\rbac\PhpManager</code> component that will store RBAC data in the <code class="literal">@app/rbac</code> folder, and through DbManager, instancing the <code class="literal">yii\rbac\DbManager</code> component, which will use four database tables to store its data.</p><p>We need to configure the <code class="literal">authManager</code> application component in the main configuration file using one of the authorization managers, <code class="literal">yii\rbac\PhpManager</code> or <code class="literal">yii\rbac\DbManager</code>.</p><p>The following code shows how to configure <code class="literal">authManager</code> in <code class="literal">basic/config/web.php</code> using the <code class="literal">yii\rbac\PhpManager</code> class:</p><div class="informalexample"><pre class="programlisting">return [
    // ...
    'components' =&gt; [
        'authManager' =&gt; [
            'class' =&gt; 'yii\rbac\PhpManager',
        ],
        // ...
    ],
];</pre></div><p>The following code shows how to configure <code class="literal">authManager</code> in <code class="literal">basic/config/web.php</code> using the <code class="literal">yii\rbac\DbManager</code> class:</p><div class="informalexample"><pre class="programlisting">return [
    // ...
    'components' =&gt; [
        'authManager' =&gt; [
            'class' =&gt; 'yii\rbac\DbManager,
        ],
        // ...
    ],
];</pre></div><p>Both these methods are based on three objects: <code class="literal">permissions</code>, <code class="literal">roles</code>, and <code class="literal">rules</code>. The <code class="literal">permissions</code> method represents actions that can be controlled; <code class="literal">roles</code> are a set of permissions to which the target can be enabled or less; and <code class="literal">rules</code> are extra validations that will be executed when a permission is checked. Finally, <code class="literal">permissions</code> or <code class="literal">roles</code> can be assigned to users and identified by the <code class="literal">IdentityInterface::getId()</code> value of the <code class="literal">Yii::$app-&gt;user</code> component.</p><p>When access permissions do not change, we could create a console command to launch in case, or once, permissions are changed. However, we will not discuss that now as you will see the console command in-depth in the next chapters.</p><p>Instead, we will <a id="id388" class="indexterm"/>write permissions using a fake action to only execute permissions, roles, and assignments settings.</p><p>In <code class="literal">basic/controllers/MyAuthenticationController.php</code>, add this action named <code class="literal">actionInitializeAuthorizations</code>:</p><div class="informalexample"><pre class="programlisting">    public function actionInitializeAuthorizations()
    {
        $auth = Yii::$app-&gt;authManager;
        
        // Reset all
        $auth-&gt;removeAll();
        
        // add "createReservation" permission
        $permCreateReservation = $auth-&gt;createPermission('createReservation');
        $permCreateReservation-&gt;description = 'Create a reservation';
        $auth-&gt;add($permCreateReservation);

        // add "updatePost" permission
        $permUpdateReservation = $auth-&gt;createPermission('updateReservation');
        $permUpdateReservation-&gt;description = 'Update reservation';
        $auth-&gt;add($permUpdateReservation);

        // add "operator" role and give this role the "createReservation" permission
        $roleOperator = $auth-&gt;createRole('operator');
        $auth-&gt;add($roleOperator);
        $auth-&gt;addChild($roleOperator, $permCreateReservation);

        // add "admin" role and give this role the "updateReservation" permission
        // as well as the permissions of the "operator" role
        $roleAdmin = $auth-&gt;createRole('admin');
        $auth-&gt;add($roleAdmin);
        $auth-&gt;addChild($roleAdmin, $permUpdateReservation);
        $auth-&gt;addChild($roleAdmin, $roleOperator);

        // Assign roles to users. 1 and 2 are IDs returned by IdentityInterface::getId()
        // usually implemented in your User model.
        $auth-&gt;assign($roleOperator, 2);
        $auth-&gt;assign($roleAdmin, 1);
    }</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note54"/>Note</h3><p>Before calling this action from your browser, make sure that the folder in <code class="literal">basic/rbac</code> already exists and that it is writable.</p></div></div><p>In order to start<a id="id389" class="indexterm"/> this action from the beginning, two permissions and two roles are created, then the <code class="literal">createReservation</code> permission is added as a child to the operator role and the <code class="literal">updateReservation</code> permission is added as a child to the admin role, together to the operator role.</p><p>If we check the <code class="literal">createReservation</code> permission for the user with the <code class="literal">roleOperator</code> role, it will be successfully confirmed. The same happens if we check the user with <code class="literal">adminOperator</code>. But when we check the <code class="literal">updateReservation</code> permission on the user with the <code class="literal">roleOperator</code> role, it will be denied since that permission is not assigned to that specific role.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note55"/>Note</h3><p>Permissions and role names can be chosen without restrictions, because they are used as parameters when checking permissions.</p></div></div><p>Now let's point our browser to <code class="literal">http://hostname/basic/my-authentication/initialize-authorizations</code> in order to launch the permissions creation.</p><p>The content of files created through this action in the <code class="literal">basic/rbac</code> folder are simply arrays. This is the content of the <code class="literal">items.php</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?php
return [
    'createReservation' =&gt; [
        'type' =&gt; 2,
        'description' =&gt; 'Create a reservation',
    ],
    'updateReservation' =&gt; [
        'type' =&gt; 2,
        'description' =&gt; 'Update reservation',
    ],
    'operator' =&gt; [
        'type' =&gt; 1,
        'children' =&gt; [
            'createReservation',
        ],
    ],
    'admin' =&gt; [
        'type' =&gt; 1,
        'children' =&gt; [
            'updateReservation',
            'operator',
        ],
    ],
];</pre></div><p>This is the content of <code class="literal">assignments.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
return [
    2 =&gt; [
        'operator',
    ],
    1 =&gt; [
        'admin',
    ],
];</pre></div><p>Finally, to<a id="id390" class="indexterm"/> check the user authorization, it is enough to call the <code class="literal">yii\web\User::can()</code> method:</p><div class="informalexample"><pre class="programlisting">if (\Yii::$app-&gt;user-&gt;can()) {
    // create reservation permission is enabled to current user
}</pre></div><div class="section" title="Example – configuring RBAC to set permissions for users"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec01"/>Example – configuring RBAC to set permissions for users</h3></div></div></div><p>In this example, we will <a id="id391" class="indexterm"/>create a user permissions management system from scratch, based on RBAC. We will create a new controller named <code class="literal">AuthorizationManagerController</code> in <code class="literal">basic/controllers/AuthorizationManagerController.php</code> that will display all the users and all the available permissions and roles from the database. This example is based on the user database table already used in the previous paragraphs.</p><p>Let's take a look at its structure again:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `user` (
 `id` int(11) NOT NULL AUTO_INCREMENT,
 `username` varchar(255) COLLATE utf8_unicode_ci NOT NULL,
 `auth_key` varchar(32) COLLATE utf8_unicode_ci NOT NULL,
 `password_hash` varchar(255) COLLATE utf8_unicode_ci NOT NULL,
 `access_token` varchar(100) COLLATE utf8_unicode_ci DEFAULT NULL,
 PRIMARY KEY (`id`)
)</pre></div><p>We will truncate the database table and insert these records, five items, to be used in the next examples:</p><div class="informalexample"><pre class="programlisting">TRUNCATE user;

INSERT INTO `user` (`id`, `username`, `auth_key`, `password_hash`, `access_token`) VALUES
(1, 'foo', '', '$2a$12$hL0rmIMjxhLqI.xr7jD1FugNWEgZNh62HuJj5.y34XBUfBWB4cppW', NULL),
(2, 'userA', '', '$2a$12$hL0rmIMjxhLqI.xr7jD1FugNWEgZNh62HuJj5.y34XBUfBWB4cppW', NULL),
(3, 'userB', '', '$2a$12$hL0rmIMjxhLqI.xr7jD1FugNWEgZNh62HuJj5.y34XBUfBWB4cppW', NULL),
(4, 'userC', '', '$2a$12$hL0rmIMjxhLqI.xr7jD1FugNWEgZNh62HuJj5.y34XBUfBWB4cppW', NULL),
(5, 'admin', '', '$2a$12$hL0rmIMjxhLqI.xr7jD1FugNWEgZNh62HuJj5.y34XBUfBWB4cppW', NULL);</pre></div><p>Now that we have <a id="id392" class="indexterm"/>data to work with, we can pass to write code.</p><p>The first method to create in this controller is <code class="literal">initializeAuthorizations()</code>, which has to initialize all the available authorizations in the system:</p><div class="informalexample"><pre class="programlisting">    &lt;?php

namespace app\controllers;

use Yii;
use yii\web\Controller;
use yii\filters\AccessControl;
use app\models\User;
use app\models\LoginForm;

class MyAuthenticationController extends Controller
{
  
public function initializeAuthorizations()
    {
        $auth = Yii::$app-&gt;authManager;
        
        $permissions = [
            'createReservation' =&gt; array('desc' =&gt; 'Create a reservation'),
            'updateReservation' =&gt; array('desc' =&gt; 'Update reservation'),
            'deleteReservation' =&gt; array('desc' =&gt; 'Delete reservation'),
            
            'createRoom' =&gt; array('desc' =&gt; 'Create a room'),
            'updateRoom' =&gt; array('desc' =&gt; 'Update room'),
            'deleteRoom' =&gt; array('desc' =&gt; 'Delete room'),

            'createCustomer' =&gt; array('desc' =&gt; 'Create a customer'),
            'updateCustomer' =&gt; array('desc' =&gt; 'Update customer'),
            'deleteCustomer' =&gt; array('desc' =&gt; 'Delete customer'),
        ];
        
        $roles = [
            'operator' =&gt; array('createReservation', 'createRoom', 'createCustomer'),
        ];
        
        // Add all permissions
        foreach($permissions as $keyP=&gt;$valueP)
        {
            $p = $auth-&gt;createPermission($keyP);
            $p-&gt;description = $valueP['desc'];
            $auth-&gt;add($p);
            
            // add "operator" role and give this role the "createReservation" permission
            $r = $auth-&gt;createRole('role_'.$keyP);
            $r-&gt;description = $valueP['desc'];
            $auth-&gt;add($r);
            if( false == $auth-&gt;hasChild($r, $p)) $auth-&gt;addChild($r, $p);
        }
        
        // Add all roles
        foreach($roles as $keyR=&gt;$valueR)
        {
            $r = $auth-&gt;createRole($keyR);
            $r-&gt;description = $keyR;
            $auth-&gt;add($r);
            
            foreach($valueR as $permissionName)
            {
             if( false == $auth-&gt;hasChild($r, $auth-&gt;getPermission($permissionName))) $auth-&gt;addChild($r, $auth-&gt;getPermission($permissionName));
            }
            
        }
                
        // Add all permissions to admin role
        $r = $auth-&gt;createRole('admin');
        $r-&gt;description = 'admin';
        $auth-&gt;add($r);
        foreach($permissions as $keyP=&gt;$valueP)
        {
            if( false == $auth-&gt;hasChild($r, $auth-&gt;getPermission($permissionName))) $auth-&gt;addChild($r, $auth-&gt;getPermission($keyP));
        }
    }
}</pre></div><p>At the top of this<a id="id393" class="indexterm"/> method, we created a permissions and roles list, then we assigned them to the Yii authorization component. Take care to ensure that, after calling this method for the first time, you check whether any children already exist by calling the <code class="literal">hasChild</code> method on every <code class="literal">addChild()</code> insert attempt.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note56"/>Note</h3><p>We have created a role for each permission, because <code class="literal">assign()</code> and <code class="literal">revoke()</code> take a role and not a permission as a first parameter, so we are required to replicate a role for every permission.</p></div></div><p>Next, we can create <code class="literal">actionIndex()</code>, which launches the previous initialize authorizations, getting all the users and populating an array with all the permissions assigned to every user. This is the content of the <code class="literal">actionIndex()</code> method:</p><div class="informalexample"><pre class="programlisting">    public function actionIndex()
    {
        $auth = Yii::$app-&gt;authManager;
        
        // Initialize authorizations
        $this-&gt;initializeAuthorizations();

        // Get all users        
        $users = User::find()-&gt;all();
        
        // Initialize data
        $rolesAvailable = $auth-&gt;getRoles();
        $rolesNamesByUser = [];
        
        // For each user, fill $rolesNames with name of roles assigned to user
        foreach($users as $user)
        {
            $rolesNames = [];
            
            $roles = $auth-&gt;getRolesByUser($user-&gt;id);
            foreach($roles as $r)
            {
                $rolesNames[] = $r-&gt;name;
            }
            
            $rolesNamesByUser[$user-&gt;id] = $rolesNames;
        }
        
        return $this-&gt;render('index', ['users' =&gt; $users, 'rolesAvailable' =&gt; $rolesAvailable, 'rolesNamesByUser' =&gt; $rolesNamesByUser]);
    }</pre></div><p>Follow the content of the <a id="id394" class="indexterm"/>index action view in <code class="literal">basic/views/authorization-manager/index.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;
?&gt;

&lt;table class="table"&gt;
    &lt;tr&gt;
        &lt;td&gt;User&lt;/td&gt;
        &lt;?php foreach($rolesAvailable as $r) { ?&gt;
            &lt;td&gt;&lt;?php echo $r-&gt;description ?&gt;&lt;/td&gt;
        &lt;?php } ?&gt;
    &lt;/tr&gt;
    
    &lt;?php foreach($users as $u) { ?&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;?php echo $u-&gt;username ?&gt;&lt;/td&gt;
            
            &lt;?php foreach($rolesAvailable as $r) { ?&gt;
                &lt;td align="center"&gt;
                &lt;?php if(in_array($r-&gt;name, $rolesNamesByUser[$u-&gt;id])) { ?&gt;
                  &lt;?php echo Html::a('Yes', ['remove-role', 'userId' =&gt; $u-&gt;id, 'roleName' =&gt; $r-&gt;name]); ?&gt;
                &lt;?php } else { ?&gt;
                    &lt;?php echo Html::a('No', ['add-role', 'userId' =&gt; $u-&gt;id, 'roleName' =&gt; $r-&gt;name]); ?&gt;
                &lt;?php } ?&gt;
                &lt;/td&gt;
            &lt;?php } ?&gt;
        &lt;/tr&gt;
    &lt;?php } ?&gt;
    
&lt;/table&gt;</pre></div><p>This loops for each<a id="id395" class="indexterm"/> user's content of the <code class="literal">$rolesAvailable</code> array. To see this output, point your browser to <code class="literal">http://hostname/basic/web/authorization-manager/index</code>:</p><div class="mediaobject"><img src="graphics/B04656_08_04.jpg" alt="Example – configuring RBAC to set permissions for users"/><div class="caption"><p>Users/Permissions table</p></div></div><p>Every permission status is a link to the actions of adding a role or removing a role (depending on the current status).</p><p>Now we must create the last two actions: add a role and revoke a role to the user:</p><div class="informalexample"><pre class="programlisting">    public function actionAddRole($userId, $roleName)
    {
        $auth = Yii::$app-&gt;authManager;
        
        $auth-&gt;assign($auth-&gt;getRole($roleName), $userId);
        
        return $this-&gt;redirect(['index']);
    }
    
    public function actionRemoveRole($userId, $roleName)
    {
        $auth = Yii::$app-&gt;authManager;
        
        $auth-&gt;revoke($auth-&gt;getRole($roleName), $userId);
        
        return $this-&gt;redirect(['index']);
    }</pre></div></div></div></div>
<div class="section" title="Mixing ACF and RBAC"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec61"/>Mixing ACF and RBAC</h1></div></div></div><p>ACF contains a <a id="id396" class="indexterm"/>property named <code class="literal">role</code> that is usually filled with <code class="literal">?</code> to indicate that access is available for all users, and <code class="literal">@</code> to indicate that access is restricted to authenticated ones. But there is a third option that refers its content to the role name of the RBAC system.</p><p>For each controller, therefore, it is enough to overwrite <code class="literal">behaviors()</code> by specifying the roles that can access the actions inside the controller and then to associate users to the role, in order to allow or deny access.</p><div class="section" title="Example – managing users' roles to access rooms, reservations, and customers"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec42"/>Example – managing users' roles to access rooms, reservations, and customers</h2></div></div></div><p>In this example, we will <a id="id397" class="indexterm"/>show you how to manage the access to the controller actions using ACF and RBAC.</p><p>We will use the <code class="literal">foo</code> user to simulate an authenticated user for <code class="literal">RoomsController</code>. The first thing to do is to extend the <code class="literal">behaviors()</code> method of <code class="literal">RoomsController</code> in <code class="literal">basic/controller/RoomsController.php</code> with this content:</p><div class="informalexample"><pre class="programlisting">Use yii\filters\AccessControl;

    public function behaviors()
    {
        return [
            'access' =&gt; [
                'class' =&gt; AccessControl::className(),
                'rules' =&gt; [
                    [
                        'allow' =&gt; true,
                        'actions' =&gt; ['create'],
                        'roles' =&gt; ['operator'],
                    ],
                    [
                        'allow' =&gt; true,
                        'actions' =&gt; ['index'],
                    ],                    
                ],
                
            ],
        ];
    }</pre></div><p>With this code, we will guarantee access to the <code class="literal">create</code> action only to users with the <code class="literal">operator</code> role, while the <code class="literal">index</code> action access is given to all users and all other actions are denied to everyone.</p><p>So, if we try to browse to <code class="literal">http://hostname/basic/web/rooms/create</code>, we should see an error page with a forbidden error. This is because we are trying to access a page with insufficient permissions.</p><p>Now, we can execute the authentication simply by going to <code class="literal">http://hostname/basic/web/my-authentication/login</code> and typing <code class="literal">foo</code> as the username and <code class="literal">foopassword</code> as the password, since we already created a user with these credentials in the database in the previous chapter. We should see a successfully logged in page.</p><p>The last thing to <a id="id398" class="indexterm"/>do is to assign the <code class="literal">operator</code> role to the <code class="literal">foo</code> user. We can use the authorization manager just created in <code class="literal">http://hostname/basic/web/authorization-manager/index</code>. Now, click on the cell referring to the <code class="literal">foo</code> user and the <code class="literal">operator</code> role. In this way, we have assigned the <code class="literal">operator</code> role to the <code class="literal">foo</code> user.</p><p>Finally, we can refresh the rooms creation page at <code class="literal">http://hostname/basic/web/rooms/create</code>. We can see now the create action page of the rooms controller.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec62"/>Summary</h1></div></div></div><p>In this chapter, you learned how to apply user authentication and authorization to an app. The first step was to create an authenticated access to the application. For this purpose, we created a database table to manage users and associated it to the Yii user component through a user model that extends <code class="literal">IdentityInterface</code>.</p><p>The first example in this chapter was building a login form to authenticate the user. The next step was to control which actions a user can perform or not, and this was the case for the authorization phase too. As you saw, Yii provides two solutions for this matter: ACF and RBAC. We configured a controller to use ACF and then you saw how RBAC is a more powerful tool to manage user authorization with more granularity. Finally, we built an authorization manager all by ourselves.</p><p>In the next chapter, we will cover topics such as installing and using an advanced template and having multiple apps in the same context.</p></div></body></html>