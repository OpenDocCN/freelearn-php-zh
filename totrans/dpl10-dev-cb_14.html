<html><head></head><body>
<div id="_idContainer127">
<h1 class="chapter-number" id="_idParaDest-418"><a id="_idTextAnchor452"/><span class="koboSpan" id="kobo.1.1">14</span></h1>
<h1 id="_idParaDest-419"><a id="_idTextAnchor453"/><span class="koboSpan" id="kobo.2.1">Migrating External Data into Drupal</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Whether you have been developing for a while or just getting started in your career, one very common situation you will encounter is the need to bring in data from an external source. </span><span class="koboSpan" id="kobo.3.2">This can include migrating from older versions of Drupal, migrating from sites not based on Drupal, different database engines, static HTML files, or incorporating data from CSV or HTTP APIs with JSON </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">or XML.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">No matter the scenario, Drupal contains several powerful tools to solve these needs with the core Migrate module. </span><span class="koboSpan" id="kobo.5.2">Under the hood, it also contains a powerful plugin system that allows you to extend and define your own data source or process plugin, as well as a healthy ecosystem of contributed modules to enhance the migration experience </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">in Drupal.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">In this chapter, we will look at the Migrate module in Drupal 10, and you will learn how to achieve </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.9.1">Migrating from a previous version </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">of Drupal</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">Migrating data from a </span><strong class="bold"><span class="koboSpan" id="kobo.12.1">comma-separated value</span></strong><span class="koboSpan" id="kobo.13.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.14.1">CSV</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">) file</span></span></li>
<li><span class="koboSpan" id="kobo.16.1">Migrating data from a remote </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">HTTP API</span></span></li>
<li><span class="koboSpan" id="kobo.18.1">Writing a custom migration </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">source plugin</span></span></li>
<li><span class="koboSpan" id="kobo.20.1">Writing a custom process plugin </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">for migrations</span></span></li>
</ul>
<h1 id="_idParaDest-420"><a id="_idTextAnchor454"/><span class="koboSpan" id="kobo.22.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.23.1">You can find the full code used in this chapter on GitHub: </span><a href="https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp14"><span class="koboSpan" id="kobo.24.1">https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp14</span></a></p>
<h1 id="_idParaDest-421"><a id="_idTextAnchor455"/><span class="koboSpan" id="kobo.25.1">Migrating from a previous version of Drupal</span></h1>
<p><span class="koboSpan" id="kobo.26.1">Drupal</span><a id="_idIndexMarker874"/><span class="koboSpan" id="kobo.27.1"> ships with a couple of core modules that assist you in updating your site from Drupal 6 or 7 to Drupal 10. </span><span class="koboSpan" id="kobo.27.2">The architecture between previous versions of Drupal before version 8 was radically different in design, and you cannot upgrade from 6 or 7 the same way you can from 8 </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">or 9.</span></span></p>
<p><span class="koboSpan" id="kobo.29.1">To mitigate the challenges of upgrading from Drupal 6 or 7, the Migrate Drupal module helps prepare a new environment for your older Drupal database to migrate to and is included in the core release of </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">Drupal 10.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.31.1">Custom modules, custom themes, and custom Drush commands</span></p>
<p class="callout"><span class="koboSpan" id="kobo.32.1">An important thing to note about upgrading from versions of Drupal prior to version 8 is that you will need to </span><em class="italic"><span class="koboSpan" id="kobo.33.1">manually</span></em><span class="koboSpan" id="kobo.34.1"> port custom modules, custom theme(s), and custom Drush commands you may have created. </span><span class="koboSpan" id="kobo.34.2">There are no tools to automate this, and they </span><em class="italic"><span class="koboSpan" id="kobo.35.1">will not work</span></em><span class="koboSpan" id="kobo.36.1"> until you have ported them to be compatible with Drupal 10. </span><span class="koboSpan" id="kobo.36.2">This must be done prior to upgrading, or you may encounter several errors while attempting to migrate or review </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">your progress.</span></span></p>
<h2 id="_idParaDest-422"><a id="_idTextAnchor456"/><span class="koboSpan" id="kobo.38.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.39.1">Before </span><a id="_idIndexMarker875"/><span class="koboSpan" id="kobo.40.1">you perform any migration from an older version of Drupal, it is important to have prepared </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.42.1">A working environment running </span><span class="No-Break"><span class="koboSpan" id="kobo.43.1">Drupal 10</span></span></li>
<li><span class="koboSpan" id="kobo.44.1">A copy of the Drupal 6/7 database to use in </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">the upgrade</span></span></li>
<li><span class="koboSpan" id="kobo.46.1">An inventory of modules and theme(s) used on the site you are </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">migrating from</span></span></li>
<li><span class="koboSpan" id="kobo.48.1">A database server that has both the Drupal 10 database and the old Drupal </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">6/7 database</span></span></li>
<li><span class="koboSpan" id="kobo.50.1">The database credentials needed to connect to the Drupal 6/7 database in </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">your server</span></span></li>
<li><span class="koboSpan" id="kobo.52.1">A copy of all public and private files from the old site in a place accessible by the </span><span class="No-Break"><span class="koboSpan" id="kobo.53.1">new site</span></span></li>
<li><span class="koboSpan" id="kobo.54.1">Enabling the Migrate Drupal and Migrate Drupal UI module in your Drupal </span><span class="No-Break"><span class="koboSpan" id="kobo.55.1">10 site</span></span></li>
<li><span class="koboSpan" id="kobo.56.1">A </span><em class="italic"><span class="koboSpan" id="kobo.57.1">database backup</span></em><span class="koboSpan" id="kobo.58.1"> of your current Drupal </span><span class="No-Break"><span class="koboSpan" id="kobo.59.1">10 installation</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.60.1">We will walk through these steps in the </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">next section.</span></span></p>
<p><span class="koboSpan" id="kobo.62.1">It is likely that </span><a id="_idIndexMarker876"/><span class="koboSpan" id="kobo.63.1">you will need to iterate on the migration before it is complete, especially with old, complex sites. </span><span class="koboSpan" id="kobo.63.2">So, before you proceed, make sure you take a </span><em class="italic"><span class="koboSpan" id="kobo.64.1">database backup</span></em><span class="koboSpan" id="kobo.65.1"> of your Drupal 10 site. </span><span class="koboSpan" id="kobo.65.2">That way, if something goes wrong during the migration, you can restore the database, make changes, and try again. </span><span class="koboSpan" id="kobo.65.3">This is much faster than having to completely reinstall Drupal 10 to start the migration over. </span><span class="koboSpan" id="kobo.65.4">Always keep a clean database backup available. </span><span class="No-Break"><span class="koboSpan" id="kobo.66.1">Let’s begin!</span></span></p>
<h2 id="_idParaDest-423"><a id="_idTextAnchor457"/><span class="koboSpan" id="kobo.67.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.68.1">With your new Drupal 10 site installed and ready, the first step you need to take is to review the modules you were using in your Drupal 6/7 site. </span><span class="koboSpan" id="kobo.68.2">You should log in to the site you are migrating from and go to the module list section of the admin. </span><span class="koboSpan" id="kobo.68.3">You can also get this list using the Drush command-line tool if </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">you prefer.</span></span></p>
<p><span class="koboSpan" id="kobo.70.1">Write down the list of contributed modules and themes that are in use in the old Drupal site. </span><span class="koboSpan" id="kobo.70.2">You are going to have to evaluate the following questions </span><span class="No-Break"><span class="koboSpan" id="kobo.71.1">per module:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.72.1">Do I still need this module on </span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">Drupal 10?</span></span></li>
<li><span class="koboSpan" id="kobo.74.1">Has the contributed module moved to </span><span class="No-Break"><span class="koboSpan" id="kobo.75.1">the core?</span></span></li>
<li><span class="koboSpan" id="kobo.76.1">Does the contributed module have a Drupal 10 version available? </span><span class="koboSpan" id="kobo.76.2">If not, do I still need it? </span><span class="koboSpan" id="kobo.76.3">Is there an alternative module with </span><span class="No-Break"><span class="koboSpan" id="kobo.77.1">similar functionality?</span></span></li>
<li><span class="koboSpan" id="kobo.78.1">Does this module provide an upgrade path and migration integration to move data from a previous version </span><span class="No-Break"><span class="koboSpan" id="kobo.79.1">of Drupal?</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.80.1">Keeping an inventory like this is required when upgrading from versions of Drupal prior to </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">version 8.</span></span></p>
<p><span class="koboSpan" id="kobo.82.1">As you go down the list and answer each question, you can update your Drupal 10 site by selecting the module you need with Composer. </span><span class="koboSpan" id="kobo.82.2">The idea is that you get the Drupal 10 environment ready first by making the modules and themes available that were being used in the previous </span><span class="No-Break"><span class="koboSpan" id="kobo.83.1">Drupal site.</span></span></p>
<p><span class="koboSpan" id="kobo.84.1">Some modules, such as views, have been moved into Drupal core and do not have a contributed version available. </span><span class="koboSpan" id="kobo.84.2">Others, such as Pathauto, have newer versions available for Drupal and also include migration plugins. </span><span class="koboSpan" id="kobo.84.3">These migration plugins are used automatically by the Migrate Drupal module when migrating your </span><span class="No-Break"><span class="koboSpan" id="kobo.85.1">old site.</span></span></p>
<p><span class="koboSpan" id="kobo.86.1">Not all modules have compatible versions for Drupal 10, unfortunately. </span><span class="koboSpan" id="kobo.86.2">This can happen when they are replaced by a competing module (Field Collections versus Paragraphs, for example) or the maintainer(s) decided not to port the module beyond Drupal 7. </span><span class="koboSpan" id="kobo.86.3">If you find that there is a module in your Drupal 6/7 site you absolutely need for your Drupal 10 site, you have limited options in this case. </span><span class="koboSpan" id="kobo.86.4">You can do </span><span class="No-Break"><span class="koboSpan" id="kobo.87.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.88.1">Check the module issue queue to see whether a newer version has been </span><span class="No-Break"><span class="koboSpan" id="kobo.89.1">worked on</span></span></li>
<li><span class="koboSpan" id="kobo.90.1">Check the module yourself and with your development team to assess how hard porting it </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">would be</span></span></li>
<li><span class="koboSpan" id="kobo.92.1">See whether an alternative module exists for Drupal 10 that is similar and make the configuration changes you need (it may be possible to provide a migration path </span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">as well)</span></span></li>
<li><span class="koboSpan" id="kobo.94.1">Use a tool such as </span><a id="_idIndexMarker877"/><span class="koboSpan" id="kobo.95.1">Drupal Module Upgrader (</span><a href="https://www.drupal.org/project/drupalmoduleupgrader"><span class="koboSpan" id="kobo.96.1">https://www.drupal.org/project/drupalmoduleupgrader</span></a><span class="koboSpan" id="kobo.97.1">) to help you figure out how to port </span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">the module</span></span></li>
<li><span class="koboSpan" id="kobo.99.1">Consult the official Drupal Slack channel, Drupal Stack Exchange website, and/or a development agency to help you port the functionality to Drupal 10 if you or your</span><a id="_idIndexMarker878"/><span class="koboSpan" id="kobo.100.1"> team are </span><span class="No-Break"><span class="koboSpan" id="kobo.101.1">unable to</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.102.1">Choosing to port the module?</span></p>
<p class="callout"><span class="koboSpan" id="kobo.103.1">If you do wind up porting the module to Drupal 10, be sure to contribute the work back to the community on </span><a href="https://Drupal.org"><span class="koboSpan" id="kobo.104.1">Drupal.org</span></a><span class="koboSpan" id="kobo.105.1">. </span><span class="koboSpan" id="kobo.105.2">Not only is it a good learning experience on how to develop a module and learn the new APIs of Drupal 10, but paying it forward also helps other people who may be stuck too. </span><span class="koboSpan" id="kobo.105.3">You can request to be a maintainer of the module and ensure bug fixes and feature enhancements </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">are published.</span></span></p>
<p><span class="koboSpan" id="kobo.107.1">Now that you have gone through the list of modules, begin adding the ones you need to your Drupal 10 site </span><span class="No-Break"><span class="koboSpan" id="kobo.108.1">with Composer:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.109.1">
composer require drupal/(module_name):^VERSION</span></pre>
<p><span class="koboSpan" id="kobo.110.1">Once you have all the required modules and theme(s), be sure to enable them. </span><span class="koboSpan" id="kobo.110.2">Don’t worry about configuring all of the added modules; the migration will take care of that for you. </span><span class="koboSpan" id="kobo.110.3">If they are not enabled, the migration process won’t see or use any migration plugins they may</span><a id="_idIndexMarker879"/><span class="koboSpan" id="kobo.111.1"> have, and you may not get all of your data </span><span class="No-Break"><span class="koboSpan" id="kobo.112.1">migrated across.</span></span></p>
<p><span class="koboSpan" id="kobo.113.1">If these modules contain migration plugins for Drupal 6/7, these will be incorporated when running a migration into your Drupal 10 </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">site automatically.</span></span></p>
<h3><span class="koboSpan" id="kobo.115.1">Running the Drupal migration</span></h3>
<p><span class="koboSpan" id="kobo.116.1">Now that our environment is ready</span><a id="_idIndexMarker880"/><span class="koboSpan" id="kobo.117.1"> and we have all the modules we need, let’s proceed with </span><span class="No-Break"><span class="koboSpan" id="kobo.118.1">the migration.</span></span></p>
<p><span class="koboSpan" id="kobo.119.1">Navigate to </span><strong class="source-inline"><span class="koboSpan" id="kobo.120.1">/upgrade</span></strong><span class="koboSpan" id="kobo.121.1">. </span><span class="koboSpan" id="kobo.121.2">You will be greeted with </span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">this screen:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer119">
<span class="koboSpan" id="kobo.123.1"><img alt="Figure 14.1 – The Upgrade screen provides a wizard for upgrading from older versions" src="image/Figure_14.1_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.124.1">Figure 14.1 – The Upgrade screen provides a wizard for upgrading from older versions</span></p>
<p><span class="koboSpan" id="kobo.125.1">The Migrate Drupal UI module provides this interface to help you perform the migration from within the administrative section. </span><span class="koboSpan" id="kobo.125.2">Review the preparation steps one last time, and then </span><span class="No-Break"><span class="koboSpan" id="kobo.126.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.127.1">Continue</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.128.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.129.1">On the next </span><a id="_idIndexMarker881"/><span class="koboSpan" id="kobo.130.1">screen, we need to set which version of Drupal we are migrating from, as well as the database credentials required to connect to the old database. </span><span class="koboSpan" id="kobo.130.2">If you are unsure of what to enter for the database host or credentials, check the platform documentation of what to use (Lando, DDEV, Docksal, etc.) to connect to a </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">second database.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer120">
<span class="koboSpan" id="kobo.132.1"><img alt="Figure 14.2 – The migrate wizard will prompt for the database credentials of the previous version of Drupal" src="image/Figure_14.2_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.133.1">Figure 14.2 – The migrate wizard will prompt for the database credentials of the previous version of Drupal</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.134.1">Where is the option for Drupal 8 or 9?</span></p>
<p class="callout"><span class="koboSpan" id="kobo.135.1">If you are updating from Drupal 8 or 9, you do not need to leverage Migrate Drupal or this interface. </span><span class="koboSpan" id="kobo.135.2">Instead, you should proceed with the regular update process for Drupal to go from Drupal 8 or 9 to Drupal 10. </span><span class="koboSpan" id="kobo.135.3">If you are migrating partial data from a Drupal 8 or 9 site and starting over in Drupal 10, you will need to write your own migration script(s). </span><span class="koboSpan" id="kobo.135.4">See the later sections in this chapter </span><span class="No-Break"><span class="koboSpan" id="kobo.136.1">for examples.</span></span></p>
<h3><span class="koboSpan" id="kobo.137.1">Setting the public/private files source</span></h3>
<p><span class="koboSpan" id="kobo.138.1">On the bottom of the previous</span><a id="_idIndexMarker882"/><span class="koboSpan" id="kobo.139.1"> screen, you can set the source for any public and private files that were uploaded to the </span><span class="No-Break"><span class="koboSpan" id="kobo.140.1">old site.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer121">
<span class="koboSpan" id="kobo.141.1"><img alt="Figure 14.3 – You can specify where the uploaded files are located on the old site so that the migration can locate them" src="image/Figure_14.3_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.142.1">Figure 14.3 – You can specify where the uploaded files are located on the old site so that the migration can locate them</span></p>
<p><span class="koboSpan" id="kobo.143.1">You have the option of either setting a local path to the files or adding a URL to a </span><span class="No-Break"><span class="koboSpan" id="kobo.144.1">public website.</span></span></p>
<p><span class="koboSpan" id="kobo.145.1">The migration will source the files from their old paths, so if your files were previously uploaded to </span><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">sites/default/files</span></strong><span class="koboSpan" id="kobo.147.1">, you need to supply them in the same location. </span><span class="koboSpan" id="kobo.147.2">For the value of the public files, you then enter </span><strong class="source-inline"><span class="koboSpan" id="kobo.148.1">/var/www/web</span></strong><span class="koboSpan" id="kobo.149.1">, the location of the web root for </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">your site.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.151.1">Document root</span></p>
<p class="callout"><span class="koboSpan" id="kobo.152.1">Note that, in some cases, the webroot can be named </span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">docroot</span></strong><span class="koboSpan" id="kobo.154.1"> instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">web</span></strong><span class="koboSpan" id="kobo.156.1">. </span><span class="koboSpan" id="kobo.156.2">This can vary depending on your setup of Lando, DDEV, Docksal, and so on, and/or vary if you use a managed hosting provider such as Acquia, Pantheon, or </span><strong class="bold"><span class="koboSpan" id="kobo.157.1">Platform.sh</span></strong><span class="koboSpan" id="kobo.158.1">. </span><span class="koboSpan" id="kobo.158.2">If unsure, check the documentation that applies in </span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">your case.</span></span></p>
<p><span class="koboSpan" id="kobo.160.1">You can do the same for </span><span class="No-Break"><span class="koboSpan" id="kobo.161.1">private files.</span></span></p>
<p><span class="koboSpan" id="kobo.162.1">If you choose to use a web address instead, this will also work. </span><span class="koboSpan" id="kobo.162.2">However, running a migration that pulls files across the internet may result in a migration taking a lot longer than you expect. </span><span class="koboSpan" id="kobo.162.3">Also, you risk knocking your live website offline with several file requests. </span><span class="koboSpan" id="kobo.162.4">While you can opt for this route, it is generally not advised for </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">larger migrations.</span></span></p>
<p><span class="koboSpan" id="kobo.164.1">When you</span><a id="_idIndexMarker883"/><span class="koboSpan" id="kobo.165.1"> have added all the applicable settings, click </span><strong class="bold"><span class="koboSpan" id="kobo.166.1">Review Upgrade</span></strong><span class="koboSpan" id="kobo.167.1">. </span><span class="koboSpan" id="kobo.167.2">This screen will display a list of items that will be upgraded and is the final step before executing </span><span class="No-Break"><span class="koboSpan" id="kobo.168.1">the migration.</span></span></p>
<h3><span class="koboSpan" id="kobo.169.1">Running the migration</span></h3>
<p><span class="koboSpan" id="kobo.170.1">At this</span><a id="_idIndexMarker884"/><span class="koboSpan" id="kobo.171.1"> point, the system is now performing the migration from the old version of Drupal to Drupal 10. </span><span class="koboSpan" id="kobo.171.2">The batch process will run until it completes (or encounters an error). </span><span class="koboSpan" id="kobo.171.3">Depending on the size and build of your old site, this can take a while. </span><span class="koboSpan" id="kobo.171.4">You may leave the computer and take a break; just be sure to leave the browser </span><span class="No-Break"><span class="koboSpan" id="kobo.172.1">window open.</span></span></p>
<p><span class="koboSpan" id="kobo.173.1">If the migration has an error, the process won’t complete. </span><span class="koboSpan" id="kobo.173.2">While unfortunate, this can happen, depending on how complex your previous site was. </span><span class="koboSpan" id="kobo.173.3">At this point, you should review the site logs to see what the errors were. </span><span class="koboSpan" id="kobo.173.4">These can be addressed and the migration can be performed again. </span><span class="koboSpan" id="kobo.173.5">You may need to adjust some migration settings, you may need a patch for a module (to support the migration), or it may be some other kind of </span><span class="No-Break"><span class="koboSpan" id="kobo.174.1">error altogether.</span></span></p>
<p><span class="koboSpan" id="kobo.175.1">Remember the database backup we made of the Drupal 10 site in preparation? </span><span class="koboSpan" id="kobo.175.2">After addressing what you found in the site logs, go ahead and restore the database. </span><span class="koboSpan" id="kobo.175.3">You should be able to go back to the first upgrade screen and start the migration over, which is faster than setting up Drupal 10 again </span><span class="No-Break"><span class="koboSpan" id="kobo.176.1">from scratch.</span></span></p>
<p><span class="koboSpan" id="kobo.177.1">If everything</span><a id="_idIndexMarker885"/><span class="koboSpan" id="kobo.178.1"> went fine, the migration will finish and you will have migrated your old Drupal site to </span><span class="No-Break"><span class="koboSpan" id="kobo.179.1">Drupal 10!</span></span></p>
<h3><span class="koboSpan" id="kobo.180.1">Migration complete!</span></h3>
<p><span class="koboSpan" id="kobo.181.1">When it has completed, take a look around your admin. </span><span class="koboSpan" id="kobo.181.2">You should see familiar items, such as content types, taxonomy, media types, user roles, uploaded files, redirects, and other items from your previous site, as well as all of your content and user </span><span class="No-Break"><span class="koboSpan" id="kobo.182.1">accounts restored.</span></span></p>
<p><span class="koboSpan" id="kobo.183.1">Do note that certain items such as view configurations cannot be automatically migrated. </span><span class="koboSpan" id="kobo.183.2">This is due to the complex nature of views themselves. </span><span class="koboSpan" id="kobo.183.3">Fortunately, views are very easy to build out in the admin, and you can always tackle that once you verify the migration </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">was successful.</span></span></p>
<h2 id="_idParaDest-424"><a id="_idTextAnchor458"/><span class="koboSpan" id="kobo.185.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.186.1">Drupal core contains dozens of plugins and migration paths to migrate from older Drupal 6 or 7 installations. </span><span class="koboSpan" id="kobo.186.2">These help explain to newer versions of Drupal how to access, transform, and save data into the new system </span><span class="No-Break"><span class="koboSpan" id="kobo.187.1">during migration.</span></span></p>
<p><span class="koboSpan" id="kobo.188.1">For example, the core Filter module has existed in several versions of Drupal. </span><span class="koboSpan" id="kobo.188.2">However, its schema, configuration, and data structure have changed over the years. </span><span class="koboSpan" id="kobo.188.3">It does not map 1:1 with Drupal 10. </span><span class="koboSpan" id="kobo.188.4">If you look in the module directory at </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1">core/modules/filter</span></strong><span class="koboSpan" id="kobo.190.1">, you will notice a directory called </span><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">migrations</span></strong><span class="koboSpan" id="kobo.192.1">. </span><span class="koboSpan" id="kobo.192.2">There are a handful of files in here that help Drupal understand how to map old filters from Drupal 6 and 7 into your new Drupal 10 installation. </span><span class="koboSpan" id="kobo.192.3">You can see an example of this </span><span class="No-Break"><span class="koboSpan" id="kobo.193.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.194.1">d7_filter_format.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.195.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.196.1">
id: d7_filter_format
label: Filter format configuration
migration_tags:
  - Drupal 7
  - Configuration
source:
  plugin: d7_filter_format
process:
  format: format
  status: status
  name: name
  cache: cache
  weight: weight
  filters:
    plugin: sub_process
    source: filters
    key: '@id'
    process:
      id:
        plugin: filter_id
        bypass: true
        source: name
        map:
          editor_caption: filter_caption
          editor_align: filter_align
      settings:
        plugin: filter_settings
        source: settings
      status:
        plugin: default_value
        default_value: true
      weight: weight
destination:
  plugin: entity:filter_format</span></pre>
<p><span class="koboSpan" id="kobo.197.1">Without getting too deep into the details just yet, this definition helps the migration process understand how to transform and move the filter and filter settings coming into Drupal 10. </span><span class="koboSpan" id="kobo.197.2">Files like these are loaded and used automatically when using the Migrate Drupal module, and you can see several examples of them spread around </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">Drupal core.</span></span></p>
<p><span class="koboSpan" id="kobo.199.1">Contributed modules can provide these as well. </span><span class="koboSpan" id="kobo.199.2">This is how we are able to migrate from older versions of Drupal without losing data. </span><span class="koboSpan" id="kobo.199.3">Most popular contributed modules will migrate fine with no problems, but some modules do not include files. </span><span class="koboSpan" id="kobo.199.4">You can check the issue queue(s) for help, but it is also possible to write your own in a custom </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">module too.</span></span></p>
<p><span class="koboSpan" id="kobo.201.1">We will look at custom migration source and migration process plugins in </span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">later sections.</span></span></p>
<h1 id="_idParaDest-425"><a id="_idTextAnchor459"/><span class="koboSpan" id="kobo.203.1">Migrating data from CSV file(s)</span></h1>
<p><span class="koboSpan" id="kobo.204.1">From time to</span><a id="_idIndexMarker886"/><span class="koboSpan" id="kobo.205.1"> time, you will encounter the </span><a id="_idIndexMarker887"/><span class="koboSpan" id="kobo.206.1">need to migrate data into Drupal, which comes in various formats. </span><span class="koboSpan" id="kobo.206.2">One such popular format is </span><strong class="bold"><span class="koboSpan" id="kobo.207.1">CSV</span></strong><span class="koboSpan" id="kobo.208.1">, or a </span><strong class="bold"><span class="koboSpan" id="kobo.209.1">comma-separated value</span></strong><span class="koboSpan" id="kobo.210.1">. </span><span class="koboSpan" id="kobo.210.2">CSV files can be exported from various database clients and spreadsheet software and make an excellent data source candidate </span><span class="No-Break"><span class="koboSpan" id="kobo.211.1">for migrations.</span></span></p>
<h2 id="_idParaDest-426"><a id="_idTextAnchor460"/><span class="koboSpan" id="kobo.212.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.213.1">From here, we are going to need to add two modules to migrate from CSV files. </span><span class="koboSpan" id="kobo.213.2">Using Composer, download the </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">following modules:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.215.1">Migrate </span><a id="_idIndexMarker888"/><span class="No-Break"><span class="koboSpan" id="kobo.216.1">Plus (</span></span><a href="https://www.drupal.org/project/migrate_plus"><span class="No-Break"><span class="koboSpan" id="kobo.217.1">https://www.drupal.org/project/migrate_plus</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.218.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.219.1">Migrate</span><a id="_idIndexMarker889"/> <span class="No-Break"><span class="koboSpan" id="kobo.220.1">Tools (</span></span><a href="https://www.drupal.org/project/migrate_tools"><span class="No-Break"><span class="koboSpan" id="kobo.221.1">https://www.drupal.org/project/migrate_tools</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.222.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.223.1">Migrate </span><a id="_idIndexMarker890"/><span class="koboSpan" id="kobo.224.1">Source </span><span class="No-Break"><span class="koboSpan" id="kobo.225.1">CSV (</span></span><a href="https://www.drupal.org/project/migrate_source_csv"><span class="No-Break"><span class="koboSpan" id="kobo.226.1">https://www.drupal.org/project/migrate_source_csv</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.227.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.228.1">You will also need to create a custom module where we will place our migration definitions, source plugins, and process plugin classes. </span><span class="koboSpan" id="kobo.228.2">At this point, you should be familiar with creating a custom module. </span><span class="koboSpan" id="kobo.228.3">Consult the previous chapters if you need </span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">to refresh.</span></span></p>
<h2 id="_idParaDest-427"><a id="_idTextAnchor461"/><span class="koboSpan" id="kobo.230.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.231.1">When you </span><a id="_idIndexMarker891"/><span class="koboSpan" id="kobo.232.1">have to perform </span><a id="_idIndexMarker892"/><span class="koboSpan" id="kobo.233.1">migrations in Drupal that cannot use Migrate Drupal, you have to write your own migration YAML configuration files in a custom module. </span><span class="koboSpan" id="kobo.233.2">This is because the Migrate Drupal module is specifically for migrating in from older versions of Drupal, treating that old version of Drupal as </span><span class="No-Break"><span class="koboSpan" id="kobo.234.1">the </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.235.1">source</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.237.1">In this case, the CSV file(s) will be the </span><em class="italic"><span class="koboSpan" id="kobo.238.1">source</span></em><span class="koboSpan" id="kobo.239.1"> of the migration. </span><span class="koboSpan" id="kobo.239.2">Every migration consists of three </span><span class="No-Break"><span class="koboSpan" id="kobo.240.1">main parts:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.241.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.242.1">source</span></strong><span class="koboSpan" id="kobo.243.1">: This is the</span><a id="_idIndexMarker893"/><span class="koboSpan" id="kobo.244.1"> provider of data consumed by </span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">the migration.</span></span></li>
<li><span class="koboSpan" id="kobo.246.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.247.1">destination</span></strong><span class="koboSpan" id="kobo.248.1">: This is </span><a id="_idIndexMarker894"/><span class="koboSpan" id="kobo.249.1">where each record will be migrated into and stored – typically, an entity (node, user, media, </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">taxonomy, etc.).</span></span></li>
<li><span class="koboSpan" id="kobo.251.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.252.1">process</span></strong><span class="koboSpan" id="kobo.253.1">: This </span><a id="_idIndexMarker895"/><span class="koboSpan" id="kobo.254.1">pipeline defines how source data is transformed and saved for a migration item. </span><span class="koboSpan" id="kobo.254.2">Here, you can define various fields and properties on the </span><em class="italic"><span class="koboSpan" id="kobo.255.1">destination</span></em><span class="koboSpan" id="kobo.256.1"> and use a number of </span><em class="italic"><span class="koboSpan" id="kobo.257.1">process</span></em><span class="koboSpan" id="kobo.258.1"> plugins to make the </span><em class="italic"><span class="koboSpan" id="kobo.259.1">source</span></em><span class="koboSpan" id="kobo.260.1"> data fit into the field(s) the way you want (or the way Drupal may require it </span><span class="No-Break"><span class="koboSpan" id="kobo.261.1">to be).</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.262.1">Before we proceed, let’s look at a quick example of a migration definition for migrating from a </span><span class="No-Break"><span class="koboSpan" id="kobo.263.1">CSV file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.264.1">
id: redirects
migration_tags: {}
migration_dependencies: {}
migration_group: default 
label: Old website redirects.
</span><span class="koboSpan" id="kobo.264.2">sourc</span><a id="_idTextAnchor462"/><span class="koboSpan" id="kobo.265.1">e:
  plugin: csv
  path: data/redirects.csv
  ids: [id]
  constants:
    uid: 1
    status: 301
destination:
  plugin:</span><a id="_idTextAnchor463"/><span class="koboSpan" id="kobo.266.1"> 'entity:redirect'
process:
  redirect_source: old_path
  redirect_redirect: new_path
  uid: constants/uid
  status_code: constants/status</span></pre>
<p><span class="koboSpan" id="kobo.267.1">Let’s assume</span><a id="_idIndexMarker896"/><span class="koboSpan" id="kobo.268.1"> we need to use a CSV file to </span><a id="_idIndexMarker897"/><span class="koboSpan" id="kobo.269.1">migrate in URLs from an old website and store them in Drupal as redirects, using the Redirect contributed module (</span><a href="https://www.drupal.org/project/redirect"><span class="koboSpan" id="kobo.270.1">https://www.drupal.org/project/redirect</span></a><span class="koboSpan" id="kobo.271.1">). </span><span class="koboSpan" id="kobo.271.2">By doing so, we can ensure URLs that existed on the old site can successfully redirect to their new URLs in Drupal so that we don’t </span><span class="No-Break"><span class="koboSpan" id="kobo.272.1">lose visitors.</span></span></p>
<p><span class="koboSpan" id="kobo.273.1">In order to do this, we’ve defined a migration definition file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.274.1">migrate_plus.migration.redirects.yml</span></strong><span class="koboSpan" id="kobo.275.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.276.1">config/install</span></strong><span class="koboSpan" id="kobo.277.1"> directory of our custom module. </span><span class="koboSpan" id="kobo.277.2">This is for migrations that need the Migrate Plus contributed module to execute (as Migrate Source </span><span class="No-Break"><span class="koboSpan" id="kobo.278.1">CSV does).</span></span></p>
<p><span class="koboSpan" id="kobo.279.1">Here, you can clearly see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.280.1">source</span></strong><span class="koboSpan" id="kobo.281.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">destination</span></strong><span class="koboSpan" id="kobo.283.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">process</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.285.1"> sections.</span></span></p>
<p><span class="koboSpan" id="kobo.286.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.287.1">source</span></strong><span class="koboSpan" id="kobo.288.1"> section tells the migration that we are going to use the CSV plugin (provided by the Migrate Source CSV module), a path to the CSV file itself, the ID keys (what Migrate will use to track unique row values), and some constant values to use in the </span><span class="No-Break"><span class="koboSpan" id="kobo.289.1">process pipeline.</span></span></p>
<p><span class="koboSpan" id="kobo.290.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.291.1">destination</span></strong><span class="koboSpan" id="kobo.292.1"> section tells the migration we want to save data using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">entity:redirect</span></strong><span class="koboSpan" id="kobo.294.1"> plugin. </span><span class="koboSpan" id="kobo.294.2">This plugin ensures migrated values are saved as </span><span class="No-Break"><span class="koboSpan" id="kobo.295.1">Redirect entities.</span></span></p>
<p><span class="koboSpan" id="kobo.296.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.297.1">process</span></strong><span class="koboSpan" id="kobo.298.1"> section maps fields and properties on the entity to data values in the migration source. </span><span class="koboSpan" id="kobo.298.2">In this case, </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">redirect_source</span></strong><span class="koboSpan" id="kobo.300.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">redirect_redirect</span></strong><span class="koboSpan" id="kobo.302.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">uid</span></strong><span class="koboSpan" id="kobo.304.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.305.1">status_code</span></strong><span class="koboSpan" id="kobo.306.1"> are being mapped to </span><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">old_url</span></strong><span class="koboSpan" id="kobo.308.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">new_url</span></strong><span class="koboSpan" id="kobo.310.1"> in our CSV file, and constant values are used for </span><strong class="source-inline"><span class="koboSpan" id="kobo.311.1">uid</span></strong><span class="koboSpan" id="kobo.312.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">status_code</span></strong><span class="koboSpan" id="kobo.314.1"> (defined in the preceding </span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">source section).</span></span></p>
<p><span class="koboSpan" id="kobo.316.1">The CSV file</span><a id="_idIndexMarker898"/><span class="koboSpan" id="kobo.317.1"> under </span><strong class="source-inline"><span class="koboSpan" id="kobo.318.1">/data/redirects.csv</span></strong><span class="koboSpan" id="kobo.319.1"> of the module contains all of the data for the migration. </span><span class="koboSpan" id="kobo.319.2">The file contains </span><span class="No-Break"><span class="koboSpan" id="kobo.320.1">the</span></span><span class="No-Break"><a id="_idIndexMarker899"/></span><span class="No-Break"><span class="koboSpan" id="kobo.321.1"> following:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-1">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.322.1">ID</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.323.1">old_path</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.324.1">new_path</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.325.1">1</span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.326.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.327.1">foo</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.329.1">node/1</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.330.1">2</span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.332.1">foo/bar</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">node/2</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.335.1">3</span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">foo/bar/baz</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.339.1">node/3</span></strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.340.1">Table 14.1 – The CSV file under /data/redirects.csv</span></p>
<p><span class="koboSpan" id="kobo.341.1">The CSV file contains a few hundred records like the </span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">preceding one.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.343.1">What about the alias?</span></p>
<p class="callout"><span class="koboSpan" id="kobo.344.1">When migrating redirects the URLs into Drupal, the destination (in this case, </span><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">new_path</span></strong><span class="koboSpan" id="kobo.346.1">) needs to be the Drupal entity path (</span><strong class="source-inline"><span class="koboSpan" id="kobo.347.1">/node/1</span></strong><span class="koboSpan" id="kobo.348.1">, for example). </span><span class="koboSpan" id="kobo.348.2">Drupal will save the redirect correctly. </span><span class="koboSpan" id="kobo.348.3">If you have Pathauto auto-alias patterns in place, they will be generated when the migration saves each row of data. </span><span class="koboSpan" id="kobo.348.4">With the redirect contributed module installed, a 301 redirect will be created and related to the node we are redirecting </span><span class="No-Break"><span class="koboSpan" id="kobo.349.1">to automatically.</span></span></p>
<p><span class="koboSpan" id="kobo.350.1">When we enable our custom module, the migration appears in the list of migrations in the admin section under </span><strong class="bold"><span class="koboSpan" id="kobo.351.1">Structure</span></strong><span class="koboSpan" id="kobo.352.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.353.1">Migrations</span></strong><span class="koboSpan" id="kobo.354.1">. </span><span class="koboSpan" id="kobo.354.2">Any migration that you define will appear in this section. </span><span class="koboSpan" id="kobo.354.3">You can run migrations from this interface, or you can do it from the command line using Drush, courtesy of the </span><strong class="bold"><span class="koboSpan" id="kobo.355.1">Migrate Tools</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.356.1">contributed </span></span><span class="No-Break"><a id="_idIndexMarker900"/></span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">module.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer122">
<span class="koboSpan" id="kobo.358.1"><img alt="Figure 14.4 – The Migrations screen lists all registered migrations in Drupal and the tasks you can perform with them" src="image/Figure_14.4_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.359.1">Figure 14.4 – The Migrations screen lists all registered migrations in Drupal and the tasks you can perform with them</span></p>
<p><span class="koboSpan" id="kobo.360.1">Then, we can execute </span><span class="No-Break"><span class="koboSpan" id="kobo.361.1">the migration:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer123">
<span class="koboSpan" id="kobo.362.1"><img alt="Figure 14.5 – A migration running in the admin, displaying a progress meter" src="image/Figure_14.5_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.363.1">Figure 14.5 – A migration running in the admin, displaying a progress meter</span></p>
<p><span class="koboSpan" id="kobo.364.1">We can see</span><a id="_idIndexMarker901"/><span class="koboSpan" id="kobo.365.1"> that redirects are now</span><a id="_idIndexMarker902"/><span class="koboSpan" id="kobo.366.1"> showing up in Drupal that were migrated from the </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">CSV file:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer124">
<span class="koboSpan" id="kobo.368.1"><img alt="Figure 14.6 – The migration created all the URL redirects we expect from our CSV file" src="image/Figure_14.6_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.369.1">Figure 14.6 – The migration created all the URL redirects we expect from our CSV file</span></p>
<h3><span class="koboSpan" id="kobo.370.1">Migrating into nodes from CSV</span></h3>
<p><span class="koboSpan" id="kobo.371.1">Suppose for a </span><a id="_idIndexMarker903"/><span class="koboSpan" id="kobo.372.1">second that we have another CSV file that contains data we want to migrate into a node type in Drupal. </span><span class="koboSpan" id="kobo.372.2">What might the migration definition look like? </span><span class="koboSpan" id="kobo.372.3">Not all that </span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">different actually!</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.374.1">
id: chapter14csvnodes
label: Old website articles.
</span><span class="koboSpan" id="kobo.374.2">source:
  plugin: csv
  path: /data/articles.csv
  ids: [id]
  constants:
    uid: 1
destination:
  plugin: 'entity:node'
  default_bundle: article
process:
  title: old_title
  body/value: old_body
  body/format:
    plugin: default_value
    default_value: full_html
  uid: constants/uid
  field_one: old_field_one
  field_two: old_field_two
  created:
    plugin: format_date
    from_format: 'Y-m-d\TH:i:sP'
    to_format: 'U'
    source: created_date</span></pre>
<p><span class="koboSpan" id="kobo.375.1">Using the CSV</span><a id="_idIndexMarker904"/><span class="koboSpan" id="kobo.376.1"> source plugin again, we made a few modifications, and </span><a id="_idIndexMarker905"/><span class="koboSpan" id="kobo.377.1">now we have</span><a id="_idIndexMarker906"/><span class="koboSpan" id="kobo.378.1"> another migration defined that is ready to use. </span><span class="koboSpan" id="kobo.378.2">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">destination</span></strong><span class="koboSpan" id="kobo.380.1"> section, we swapped </span><strong class="source-inline"><span class="koboSpan" id="kobo.381.1">entity:redirect</span></strong><span class="koboSpan" id="kobo.382.1"> for </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">entity:node</span></strong><span class="koboSpan" id="kobo.384.1">, and also provided the node type (</span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">bundle</span></strong><span class="koboSpan" id="kobo.386.1">) that we want to save the migrated </span><span class="No-Break"><span class="koboSpan" id="kobo.387.1">data to.</span></span></p>
<p><span class="koboSpan" id="kobo.388.1">Under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">process</span></strong><span class="koboSpan" id="kobo.390.1"> section, we’ve added specific node properties and fields from the Article node type that we want to map migrated data to. </span><span class="koboSpan" id="kobo.390.2">There are also examples here of process plugins that have configurations attached about how we want to handle </span><span class="No-Break"><span class="koboSpan" id="kobo.391.1">the data.</span></span></p>
<p><span class="koboSpan" id="kobo.392.1">You will see a mapping like this in a </span><span class="No-Break"><span class="koboSpan" id="kobo.393.1">migration file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.394.1">
field_one: old_field_one</span></pre>
<p><span class="koboSpan" id="kobo.395.1">This is a shorthand for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">get</span></strong><span class="koboSpan" id="kobo.397.1"> plugin provided by the Migrate module. </span><span class="koboSpan" id="kobo.397.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.398.1">get</span></strong><span class="koboSpan" id="kobo.399.1"> plugin uses the provided value as-is from the source to store in Drupal. </span><span class="koboSpan" id="kobo.399.2">The longer way to write out using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.400.1">get</span></strong><span class="koboSpan" id="kobo.401.1"> plugin would be </span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.403.1">
field_one:
  plugin: get
  source: old_field_one</span></pre>
<p><span class="koboSpan" id="kobo.404.1">The created</span><a id="_idIndexMarker907"/><span class="koboSpan" id="kobo.405.1"> property shows off another process plugin, </span><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">format_date</span></strong><span class="koboSpan" id="kobo.407.1">. </span><span class="koboSpan" id="kobo.407.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.408.1">format_date</span></strong><span class="koboSpan" id="kobo.409.1"> process plugin allows you to take a date and format it before</span><a id="_idIndexMarker908"/><span class="koboSpan" id="kobo.410.1"> saving it to Drupal. </span><span class="koboSpan" id="kobo.410.2">In</span><a id="_idIndexMarker909"/><span class="koboSpan" id="kobo.411.1"> the preceding example, it is converting a date-time value to a timestamp, which is how Drupal stores create and change dates </span><span class="No-Break"><span class="koboSpan" id="kobo.412.1">on nodes.</span></span></p>
<p><span class="koboSpan" id="kobo.413.1">How </span><span class="No-Break"><span class="koboSpan" id="kobo.414.1">it works…</span></span></p>
<p><span class="koboSpan" id="kobo.415.1">The </span><em class="italic"><span class="koboSpan" id="kobo.416.1">Migrate Source CSV</span></em><span class="koboSpan" id="kobo.417.1"> module provides a CSV source plugin that takes care of parsing and reading provided CSV files for you, parsing out headers and records. </span><span class="koboSpan" id="kobo.417.2">This makes it possible to create a migration definition and quickly map records to destinations </span><span class="No-Break"><span class="koboSpan" id="kobo.418.1">in Drupal.</span></span></p>
<p><span class="koboSpan" id="kobo.419.1">There are dozens of migrate process plugins just like these that you can use in your migrations to make the process easier. </span><span class="koboSpan" id="kobo.419.2">For a full list of plugins that you can use, consult the </span><span class="No-Break"><span class="koboSpan" id="kobo.420.1">online documentation:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.421.1">Migrate process</span><a id="_idIndexMarker910"/> <span class="No-Break"><span class="koboSpan" id="kobo.422.1">plugins (</span></span><a href="https://www.drupal.org/docs/8/api/migrate-api/migrate-process-plugins/list-of-core-migrate-process-plugins"><span class="No-Break"><span class="koboSpan" id="kobo.423.1">https://www.drupal.org/docs/8/api/migrate-api/migrate-process-plugins/list-of-core-migrate-process-plugins</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.424.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.425.1">Migrate Plus</span><a id="_idIndexMarker911"/><span class="koboSpan" id="kobo.426.1"> process </span><span class="No-Break"><span class="koboSpan" id="kobo.427.1">plugins (</span></span><a href="https://www.drupal.org/docs/8/api/migrate-api/migrate-process-plugins/list-of-core-migrate-process-plugins"><span class="No-Break"><span class="koboSpan" id="kobo.428.1">https://www.drupal.org/docs/8/api/migrate-api/migrate-process-plugins/list-of-core-migrate-process-plugins</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.429.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.430.1">There are </span><a id="_idIndexMarker912"/><span class="koboSpan" id="kobo.431.1">other contributed modules</span><a id="_idIndexMarker913"/><span class="koboSpan" id="kobo.432.1"> that add more process plugins, but between them, the core Migrate and contributed Migrate Plus modules cover nearly all that you will need to do migrations. </span><span class="koboSpan" id="kobo.432.2">When there is no process plugin that meets the needs of converting data during a migration, you can make your own. </span><span class="koboSpan" id="kobo.432.3">See the section on creating process plugins later in </span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">the chapter.</span></span></p>
<h1 id="_idParaDest-428"><a id="_idTextAnchor464"/><span class="koboSpan" id="kobo.434.1">Migrating data from an HTTP API</span></h1>
<p><span class="koboSpan" id="kobo.435.1">CSV files and SQL </span><a id="_idIndexMarker914"/><span class="koboSpan" id="kobo.436.1">databases are not the only data source you can use for</span><a id="_idIndexMarker915"/><span class="koboSpan" id="kobo.437.1"> migrations. </span><span class="koboSpan" id="kobo.437.2">The </span><strong class="bold"><span class="koboSpan" id="kobo.438.1">Migrate Plus</span></strong><span class="koboSpan" id="kobo.439.1"> contributed </span><a id="_idIndexMarker916"/><span class="koboSpan" id="kobo.440.1">module comes with a URL source plugin. </span><span class="koboSpan" id="kobo.440.2">By using the URL plugin as a migration source, the migration can fetch and parse data over HTTP in the </span><span class="No-Break"><span class="koboSpan" id="kobo.441.1">following formats:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.442.1">JSON</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.443.1">XML</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.444.1">SOAP</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.445.1">This means that you can migrate data from any API over the internet, making Migrate Plus an indispensable tool when you need to migrate data over </span><span class="No-Break"><span class="koboSpan" id="kobo.446.1">the wire.</span></span></p>
<p><span class="koboSpan" id="kobo.447.1">Let’s take a look at how this could be used to migrate data from an </span><span class="No-Break"><span class="koboSpan" id="kobo.448.1">HTTP API.</span></span></p>
<h2 id="_idParaDest-429"><a id="_idTextAnchor465"/><span class="koboSpan" id="kobo.449.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.450.1">At this point, we have given two examples of migration definitions in this chapter. </span><span class="koboSpan" id="kobo.450.2">Even though we are migrating from a different kind of source, the format of the migration definition itself is not going to change all that much. </span><span class="koboSpan" id="kobo.450.3">We still have our </span><strong class="source-inline"><span class="koboSpan" id="kobo.451.1">source</span></strong><span class="koboSpan" id="kobo.452.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.453.1">destination</span></strong><span class="koboSpan" id="kobo.454.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.455.1">process</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.456.1"> section.</span></span></p>
<p><span class="koboSpan" id="kobo.457.1">Imagine that we want to grab data from a public API that returns a JSON response and save it as nodes in Drupal. </span><span class="koboSpan" id="kobo.457.2">The JSON response in this example looks </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.459.1">
{
   "data":[
      {
         "id": 1,
         "title": "Item One",
         "body": "Lorem ipsum dolor sit amet",
         "archived": false
      },
      {
         "id": 2,
         "title": "Item Two",
         "body": "Lorem ipsum dolor sit amet",
         "archived": true
      },
      {
         "id": 3,
         "title": "Item Three",
         "body": "Lorem ipsum dolor sit amet",
         "archived": false
      }
   ]
}</span></pre>
<p><span class="koboSpan" id="kobo.460.1">We </span><a id="_idIndexMarker917"/><span class="koboSpan" id="kobo.461.1">need to consume that response and insert nodes for </span><a id="_idIndexMarker918"/><span class="koboSpan" id="kobo.462.1">every item under </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">data</span></strong><span class="koboSpan" id="kobo.464.1">. </span><span class="koboSpan" id="kobo.464.2">Our migration definition would look like </span><span class="No-Break"><span class="koboSpan" id="kobo.465.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.466.1">
id: chapter14httpjson
label: Migrates external API data.
</span><span class="koboSpan" id="kobo.466.2">migration_tags: {}
migration_dependencies: {}
source:
  plugin: url
  urls:
    - 'http://example.com/api/v1/content'
  data_fetcher_plugin: http
  data_parser_plugin: json
  item_selector: data
  fields:
    -
      name: id
      label: 'ID'
      selector: id
    -
      name:  title
      label: 'Title'
      selector: title
    -
      name: body
      label: 'Body content'
      selector: body
    -
      name: archived
      label: 'Archived status'
      selector: archived
  ids:
    id:
      type: integer
destination:
  plugin: entity:node
  default_bundle: article
process:
  title: title
  body/value: body
  body/format:
    plugin: default_value
    default_value: basic_html
  status: archived
  uid:
    plugin: default_value
    default_value: 1</span></pre>
<p><span class="koboSpan" id="kobo.467.1">The</span><a id="_idIndexMarker919"/><span class="koboSpan" id="kobo.468.1"> destination and process sections look the same as</span><a id="_idIndexMarker920"/><span class="koboSpan" id="kobo.469.1"> the other migrations at the beginning of the chapter. </span><span class="koboSpan" id="kobo.469.2">By now, you should see a pattern – migration definitions always look similar regardless of the source or destination. </span><span class="koboSpan" id="kobo.469.3">Each source plugin has different configuration values. </span><span class="koboSpan" id="kobo.469.4">Let’s break down what the </span><strong class="source-inline"><span class="koboSpan" id="kobo.470.1">Url</span></strong><span class="koboSpan" id="kobo.471.1"> plugin </span><span class="No-Break"><span class="koboSpan" id="kobo.472.1">is doing.</span></span></p>
<h2 id="_idParaDest-430"><a id="_idTextAnchor466"/><span class="koboSpan" id="kobo.473.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.474.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">Url</span></strong><span class="koboSpan" id="kobo.476.1"> plugin has a few configuration properties that can be set. </span><span class="koboSpan" id="kobo.476.2">The most important ones are </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">urls</span></strong><span class="koboSpan" id="kobo.478.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">data_fetcher_plugin</span></strong><span class="koboSpan" id="kobo.480.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">data_parser_plugin</span></strong><span class="koboSpan" id="kobo.482.1">. </span><span class="koboSpan" id="kobo.482.2">These must always be set when using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.483.1">Url</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.484.1"> plugin.</span></span></p>
<p><span class="koboSpan" id="kobo.485.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">urls</span></strong><span class="koboSpan" id="kobo.487.1"> property accepts one or more URLs for the migration. </span><span class="koboSpan" id="kobo.487.2">Each URL will have its contents migrated in one by one. </span><span class="koboSpan" id="kobo.487.3">This is useful if you have a scenario where you have multiple locations and need to migrate the data into the same place (assuming the response format is </span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">the same).</span></span></p>
<p><span class="koboSpan" id="kobo.489.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.490.1">data_fetcher_plugin</span></strong><span class="koboSpan" id="kobo.491.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.492.1">data_parser_plugin</span></strong><span class="koboSpan" id="kobo.493.1"> properties are unique to the Migrate Plus module. </span><span class="koboSpan" id="kobo.493.2">Migrate Plus introduces the </span><strong class="source-inline"><span class="koboSpan" id="kobo.494.1">DataFetcher</span></strong><span class="koboSpan" id="kobo.495.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.496.1">DataParser</span></strong><span class="koboSpan" id="kobo.497.1"> plugin types as well as plugin managers for them. </span><span class="koboSpan" id="kobo.497.2">It also includes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.498.1">File</span></strong><span class="koboSpan" id="kobo.499.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">Http</span></strong><span class="koboSpan" id="kobo.501.1"> data fetcher plugins, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.502.1">Json</span></strong><span class="koboSpan" id="kobo.503.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.504.1">Xml</span></strong><span class="koboSpan" id="kobo.505.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.506.1">Soap</span></strong><span class="koboSpan" id="kobo.507.1"> data </span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">parser plugins.</span></span></p>
<p><span class="koboSpan" id="kobo.509.1">When the </span><a id="_idIndexMarker921"/><span class="koboSpan" id="kobo.510.1">migration is executed, the configuration is read. </span><span class="koboSpan" id="kobo.510.2">This </span><a id="_idIndexMarker922"/><span class="koboSpan" id="kobo.511.1">loads the </span><strong class="source-inline"><span class="koboSpan" id="kobo.512.1">Url</span></strong><span class="koboSpan" id="kobo.513.1"> plugin, which contains </span><span class="No-Break"><span class="koboSpan" id="kobo.514.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.515.1">
  /**
   * Returns the initialized data parser plugin.
</span><span class="koboSpan" id="kobo.515.2">   *
   * @return \Drupal\migrate_plus\DataParserPluginInterface
   *   The data parser plugin.
</span><span class="koboSpan" id="kobo.515.3">   */
  public function getDataParserPlugin() {
    if (!isset($this-&gt;dataParserPlugin)) {
      $this-&gt;dataParserPlugin = \Drupal::service
        ('plugin.manager.migrate_plus.data_parser')-&gt;
          createInstance($this-&gt;configuration[
            'data_parser_plugin'], $this-&gt;configuration);
    }
    return $this-&gt;dataParserPlugin;
  }
  /**
   * Creates and returns a filtered Iterator over the
       documents.
</span><span class="koboSpan" id="kobo.515.4">   *
   * @return \Iterator
   *   An iterator over the documents providing source rows
           that match the
   *   configured item_selector.
</span><span class="koboSpan" id="kobo.515.5">   */
  protected function initializeIterator() {
    return $this-&gt;getDataParserPlugin();
  }</span></pre>
<p><span class="koboSpan" id="kobo.516.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.517.1">initializeIterator</span></strong><span class="koboSpan" id="kobo.518.1"> method is required to be provided by any migration source plugin. </span><span class="koboSpan" id="kobo.518.2">This tells the migration how to parse the data, which hands it off to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.519.1">Json</span></strong><span class="koboSpan" id="kobo.520.1"> plugin. </span><span class="koboSpan" id="kobo.520.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.521.1">Json</span></strong><span class="koboSpan" id="kobo.522.1"> plugin then gets the </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">data_fetcher_plugin</span></strong><span class="koboSpan" id="kobo.524.1"> value from the migration definition, which we have set as </span><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">http</span></strong><span class="koboSpan" id="kobo.526.1">. </span><span class="koboSpan" id="kobo.526.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">Xml</span></strong><span class="koboSpan" id="kobo.528.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">Soap</span></strong><span class="koboSpan" id="kobo.530.1"> data parsers have a similar implementation. </span><span class="koboSpan" id="kobo.530.2">When you combine those, this is how the migration knows to make a call over the internet to get data and how to parse that data to prepare it </span><span class="No-Break"><span class="koboSpan" id="kobo.531.1">for migration.</span></span></p>
<p><span class="koboSpan" id="kobo.532.1">Once the data</span><a id="_idIndexMarker923"/><span class="koboSpan" id="kobo.533.1"> has been retrieved and parsed, it needs to know </span><a id="_idIndexMarker924"/><span class="koboSpan" id="kobo.534.1">how to </span><em class="italic"><span class="koboSpan" id="kobo.535.1">access</span></em><span class="koboSpan" id="kobo.536.1"> items within the response. </span><span class="koboSpan" id="kobo.536.2">Sometimes, you get API responses where the results you want are </span><span class="No-Break"><span class="koboSpan" id="kobo.537.1">deeply nested.</span></span></p>
<p><span class="koboSpan" id="kobo.538.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">item_selector</span></strong><span class="koboSpan" id="kobo.540.1"> property in our source definition informs the parser how to read and extract items from the response. </span><span class="koboSpan" id="kobo.540.2">Since the example JSON structure is simple, all we have to do is give it </span><strong class="source-inline"><span class="koboSpan" id="kobo.541.1">data</span></strong><span class="koboSpan" id="kobo.542.1"> for the item selector. </span><span class="koboSpan" id="kobo.542.2">If the items we wanted were nested in some way, we would enter the path to the results as </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">foo/bar/data</span></strong><span class="koboSpan" id="kobo.544.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.545.1">for example.</span></span></p>
<p><span class="koboSpan" id="kobo.546.1">The fields portion under </span><strong class="source-inline"><span class="koboSpan" id="kobo.547.1">source</span></strong><span class="koboSpan" id="kobo.548.1"> describes to the migration the fields that we want to map, and how we want to refer to those fields in the process section. </span><span class="koboSpan" id="kobo.548.2">This was not necessary for the CSV migrations because the header records automatically become reference fields to use in the process pipeline mapping. </span><span class="koboSpan" id="kobo.548.3">In this case, we need to </span><span class="No-Break"><span class="koboSpan" id="kobo.549.1">map them:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.550.1">
      Name:  title
      label: 'Title'
      selector: title</span></pre>
<p><span class="koboSpan" id="kobo.551.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.552.1">name</span></strong><span class="koboSpan" id="kobo.553.1"> property is how we want to refer to this in the migration in the process section. </span><span class="koboSpan" id="kobo.553.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.554.1">label</span></strong><span class="koboSpan" id="kobo.555.1"> property is what it is called (visible in the migration source area within Drupal), and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.556.1">selector</span></strong><span class="koboSpan" id="kobo.557.1"> property is the actual name of it in our JSON result. </span><span class="koboSpan" id="kobo.557.2">You can make </span><strong class="source-inline"><span class="koboSpan" id="kobo.558.1">name</span></strong><span class="koboSpan" id="kobo.559.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.560.1">label</span></strong><span class="koboSpan" id="kobo.561.1"> whatever you want, but </span><strong class="source-inline"><span class="koboSpan" id="kobo.562.1">selector</span></strong><span class="koboSpan" id="kobo.563.1"> has to match what’s in the response fields returned from </span><span class="No-Break"><span class="koboSpan" id="kobo.564.1">the API.</span></span></p>
<p><span class="koboSpan" id="kobo.565.1">Again, we </span><a id="_idIndexMarker925"/><span class="koboSpan" id="kobo.566.1">can navigate to </span><strong class="bold"><span class="koboSpan" id="kobo.567.1">Structure</span></strong><span class="koboSpan" id="kobo.568.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.569.1">Migrations</span></strong><span class="koboSpan" id="kobo.570.1"> in the </span><a id="_idIndexMarker926"/><span class="koboSpan" id="kobo.571.1">Drupal admin to see this new migration and </span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">execute it.</span></span></p>
<h2 id="_idParaDest-431"><a id="_idTextAnchor467"/><span class="koboSpan" id="kobo.573.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.574.1">Here’s one final note on using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.575.1">Url</span></strong><span class="koboSpan" id="kobo.576.1"> plugin. </span><span class="koboSpan" id="kobo.576.2">Earlier, we mentioned that Migrate Plus comes with two data fetcher plugins. </span><span class="koboSpan" id="kobo.576.3">We covered </span><strong class="source-inline"><span class="koboSpan" id="kobo.577.1">Http</span></strong><span class="koboSpan" id="kobo.578.1">; the other is </span><strong class="source-inline"><span class="koboSpan" id="kobo.579.1">File</span></strong><span class="koboSpan" id="kobo.580.1">. </span><span class="koboSpan" id="kobo.580.2">If you want to migrate data in from JSON or XML files on disk, you can. </span><span class="koboSpan" id="kobo.580.3">If you change your </span><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">data_fetcher_plugin</span></strong><span class="koboSpan" id="kobo.582.1"> from </span><strong class="source-inline"><span class="koboSpan" id="kobo.583.1">http</span></strong><span class="koboSpan" id="kobo.584.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">file</span></strong><span class="koboSpan" id="kobo.586.1">, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">Url</span></strong><span class="koboSpan" id="kobo.588.1"> plugin will locate it and use it as a </span><span class="No-Break"><span class="koboSpan" id="kobo.589.1">migration source.</span></span></p>
<h1 id="_idParaDest-432"><a id="_idTextAnchor468"/><span class="koboSpan" id="kobo.590.1">Writing a custom migration source plugin</span></h1>
<p><span class="koboSpan" id="kobo.591.1">At this point, you have</span><a id="_idIndexMarker927"/><span class="koboSpan" id="kobo.592.1"> seen a few powerful ways that Drupal can migrate in data using available source plugins. </span><span class="koboSpan" id="kobo.592.2">What happens when one does not exist to meet your needs? </span><span class="koboSpan" id="kobo.592.3">You can write a migration source plugin, </span><span class="No-Break"><span class="koboSpan" id="kobo.593.1">of course!</span></span></p>
<p><span class="koboSpan" id="kobo.594.1">Consider this scenario. </span><span class="koboSpan" id="kobo.594.2">You need to migrate data in from a MySQL database as nodes into Drupal. </span><span class="koboSpan" id="kobo.594.3">While the migration system in Drupal can understand how to connect to databases, it does not understand how to query for the data you are trying to obtain. </span><span class="koboSpan" id="kobo.594.4">In these instances, you can write a </span><span class="No-Break"><span class="koboSpan" id="kobo.595.1">source plugin.</span></span></p>
<h2 id="_idParaDest-433"><a id="_idTextAnchor469"/><span class="koboSpan" id="kobo.596.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.597.1">Let’s assume that the</span><a id="_idIndexMarker928"/><span class="koboSpan" id="kobo.598.1"> database has a table named </span><strong class="source-inline"><span class="koboSpan" id="kobo.599.1">articles</span></strong><span class="koboSpan" id="kobo.600.1"> that we want to pull data from in the migration, and it has </span><strong class="source-inline"><span class="koboSpan" id="kobo.601.1">id</span></strong><span class="koboSpan" id="kobo.602.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.603.1">title</span></strong><span class="koboSpan" id="kobo.604.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.605.1">body</span></strong><span class="koboSpan" id="kobo.606.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.607.1">is_published</span></strong><span class="koboSpan" id="kobo.608.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">published_on</span></strong><span class="koboSpan" id="kobo.610.1"> as fields. </span><span class="koboSpan" id="kobo.610.2">Before we can write our source plugin, the first thing we need to do is establish a connection that will access </span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">this database.</span></span></p>
<p><span class="koboSpan" id="kobo.612.1">In your </span><strong class="source-inline"><span class="koboSpan" id="kobo.613.1">settings.php</span></strong><span class="koboSpan" id="kobo.614.1"> file, add the following MySQL </span><span class="No-Break"><span class="koboSpan" id="kobo.615.1">database connection:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.616.1">
$databases['migrate']['default'] = array (
  'database' =&gt; 'DATABASE_NAME',
  'username' =&gt; 'DATABASE_USERNAME',
  'password' =&gt; 'DATABASE_PASSWORD',
  'prefix' =&gt; '',
  'host' =&gt; 'DATABASE_HOSTNAME',
  'port' =&gt; '',
  'namespace' =&gt; 'Drupal\\Core\\Database\\Driver\\mysql',
  'driver' =&gt; 'mysql',
);</span></pre>
<p><span class="koboSpan" id="kobo.617.1">Note the </span><strong class="source-inline"><span class="koboSpan" id="kobo.618.1">migrate</span></strong><span class="koboSpan" id="kobo.619.1"> key name in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.620.1">$databases</span></strong><span class="koboSpan" id="kobo.621.1"> array. </span><span class="koboSpan" id="kobo.621.2">This entry will be used in our source plugin to make the connection. </span><span class="koboSpan" id="kobo.621.3">This key can be any name you want, other than </span><strong class="source-inline"><span class="koboSpan" id="kobo.622.1">default</span></strong><span class="koboSpan" id="kobo.623.1">, which is used by Drupal for its default database connection. </span><span class="koboSpan" id="kobo.623.2">If you choose to use a key name other than </span><strong class="source-inline"><span class="koboSpan" id="kobo.624.1">migrate</span></strong><span class="koboSpan" id="kobo.625.1">, be sure to remember it, as it will be referenced in your </span><span class="No-Break"><span class="koboSpan" id="kobo.626.1">migration definition.</span></span></p>
<p><span class="koboSpan" id="kobo.627.1">Back in your custom module, create a new directory at </span><strong class="source-inline"><span class="koboSpan" id="kobo.628.1">src/Plugin/migrate/source</span></strong><span class="koboSpan" id="kobo.629.1">. </span><span class="koboSpan" id="kobo.629.2">Next, create a file in this directory named </span><strong class="source-inline"><span class="koboSpan" id="kobo.630.1">ArticlesSource.php</span></strong><span class="koboSpan" id="kobo.631.1">. </span><span class="koboSpan" id="kobo.631.2">This will be the source plugin that powers the data retrieval for </span><span class="No-Break"><span class="koboSpan" id="kobo.632.1">the migration.</span></span></p>
<p><span class="koboSpan" id="kobo.633.1">There are three </span><a id="_idIndexMarker929"/><span class="koboSpan" id="kobo.634.1">methods that we need to fulfill for our source plugin – a </span><strong class="source-inline"><span class="koboSpan" id="kobo.635.1">query</span></strong><span class="koboSpan" id="kobo.636.1"> method, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.637.1">fields</span></strong><span class="koboSpan" id="kobo.638.1"> method, and an </span><strong class="source-inline"><span class="koboSpan" id="kobo.639.1">id</span></strong><span class="koboSpan" id="kobo.640.1"> method. </span><span class="koboSpan" id="kobo.640.2">For every SQL source plugin you create, these three methods </span><span class="No-Break"><span class="koboSpan" id="kobo.641.1">are required:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.642.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.643.1">query</span></strong><span class="koboSpan" id="kobo.644.1"> method will contain our actual SQL query to retrieve </span><span class="No-Break"><span class="koboSpan" id="kobo.645.1">the data</span></span></li>
<li><span class="koboSpan" id="kobo.646.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.647.1">fields</span></strong><span class="koboSpan" id="kobo.648.1"> method will return an array of available fields on the source, keyed by their machine names and </span><span class="No-Break"><span class="koboSpan" id="kobo.649.1">a description</span></span></li>
<li><span class="koboSpan" id="kobo.650.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.651.1">id</span></strong><span class="koboSpan" id="kobo.652.1"> method defines the source field(s) for uniquely identifying a </span><span class="No-Break"><span class="koboSpan" id="kobo.653.1">source row</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.654.1">In our new </span><strong class="source-inline"><span class="koboSpan" id="kobo.655.1">ArticlesSource.php</span></strong><span class="koboSpan" id="kobo.656.1"> file, we</span><a id="_idIndexMarker930"/><span class="koboSpan" id="kobo.657.1"> can start defining our </span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">source plugin:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.659.1">
&lt;?php
namespace Drupal\chapter14\Plugin\migrate\source;
use Drupal\migrate\Plugin\migrate\source\SqlBase;
/**
 * Get the article records from the legacy database.
 </span><span class="koboSpan" id="kobo.659.2">*
 * @MigrateSource(
 *   id = "legacy_articles",
 *   source_module = "chapter14",
 * )
 */
class ArticlesSource extends SqlBase {</span></pre>
<p><span class="koboSpan" id="kobo.660.1">Our plugin class extends </span><strong class="source-inline"><span class="koboSpan" id="kobo.661.1">SqlBase</span></strong><span class="koboSpan" id="kobo.662.1">, a core migrate plugin that deals with database source connections. </span><span class="koboSpan" id="kobo.662.2">It will do most of the heavy lifting after we provide the three </span><span class="No-Break"><span class="koboSpan" id="kobo.663.1">aforementioned methods.</span></span></p>
<p><span class="koboSpan" id="kobo.664.1">Our plugin </span><a id="_idIndexMarker931"/><span class="koboSpan" id="kobo.665.1">class also has the </span><strong class="source-inline"><span class="koboSpan" id="kobo.666.1">@MigrateSource</span></strong><span class="koboSpan" id="kobo.667.1"> annotation. </span><span class="koboSpan" id="kobo.667.2">This is </span><strong class="bold"><span class="koboSpan" id="kobo.668.1">required</span></strong><span class="koboSpan" id="kobo.669.1">. </span><span class="koboSpan" id="kobo.669.2">Without this annotation, Drupal will not discover this class as a usable source plugin, and the migration will fail to </span><span class="No-Break"><span class="koboSpan" id="kobo.670.1">do anything.</span></span></p>
<p><span class="koboSpan" id="kobo.671.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.672.1">id</span></strong><span class="koboSpan" id="kobo.673.1"> property of the annotation defines the plugin ID. </span><span class="koboSpan" id="kobo.673.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.674.1">source_module</span></strong><span class="koboSpan" id="kobo.675.1"> property identifies the system providing the data the source plugin will read from. </span><span class="koboSpan" id="kobo.675.2">For contributed sources, this is almost always the module they are </span><span class="No-Break"><span class="koboSpan" id="kobo.676.1">defined in.</span></span></p>
<p><span class="koboSpan" id="kobo.677.1">Next, we provide the </span><strong class="source-inline"><span class="koboSpan" id="kobo.678.1">query</span></strong><span class="koboSpan" id="kobo.679.1"> method. </span><span class="koboSpan" id="kobo.679.2">If you have ever used the database API in Drupal before, this will be familiar. </span><span class="koboSpan" id="kobo.679.3">It uses the same APIs. </span><span class="koboSpan" id="kobo.679.4">It looks like any other Drupal SQL query; the only difference is it will</span><a id="_idIndexMarker932"/><span class="koboSpan" id="kobo.680.1"> be executed in the other database – the one we defined in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.681.1">settings.php</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.682.1">file earlier.</span></span></p>
<p><span class="koboSpan" id="kobo.683.1">Filling that in </span><span class="No-Break"><span class="koboSpan" id="kobo.684.1">is straightforward:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.685.1">
  /**
   * {@inheritdoc}
   */
  public function query() {
    $query = $this-&gt;select('articles', 'art');
    $query-&gt;fields('art', [
        'id',
        'title',
        'body',
        'is_published',
        'published_on',
      ]);
    $query-&gt;orderBy('art.id');
    $query-&gt;orderBy('art.published_on');
    return $query;
  }</span></pre>
<h2 id="_idParaDest-434"><a id="_idTextAnchor470"/><span class="koboSpan" id="kobo.686.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.687.1">The database </span><a id="_idIndexMarker933"/><span class="koboSpan" id="kobo.688.1">API in Drupal is fairly easy to use. </span><span class="koboSpan" id="kobo.688.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">query</span></strong><span class="koboSpan" id="kobo.690.1"> method here selects all articles and their fields, ordering them by their ID and published dates. </span><span class="koboSpan" id="kobo.690.2">The results of this query are what will power our migration later in </span><span class="No-Break"><span class="koboSpan" id="kobo.691.1">this section.</span></span></p>
<p><span class="koboSpan" id="kobo.692.1">For the </span><strong class="source-inline"><span class="koboSpan" id="kobo.693.1">fields</span></strong><span class="koboSpan" id="kobo.694.1"> method, we need to list out the fields we are using within </span><span class="No-Break"><span class="koboSpan" id="kobo.695.1">the migration:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.696.1">
  /**
   * {@inheritdoc}
   */
  public function fields() {
    return [
      'id' =&gt; $this-&gt;-&gt;t('The article id.'),
      'title' =&gt; $this-&gt;-&gt;t('The article title.'),
      'body' =&gt; $this-&gt;-&gt;t('The article body content.'),
      'is_published' =&gt; $this-&gt;-&gt;t('The published state.'),
      'published_on' =&gt; $this-&gt;-&gt;t('The published date.'),
    ];
  }</span></pre>
<p><span class="koboSpan" id="kobo.697.1">Finally, for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.698.1">id</span></strong><span class="koboSpan" id="kobo.699.1"> method, we need to specify which field is the unique identifier for </span><span class="No-Break"><span class="koboSpan" id="kobo.700.1">the migration:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.701.1">
  /**
   * {@inheritdoc}
   */
  public function getIds() {
    return [
      'id' =&gt; [
        'type' =&gt; 'integer',
        'alias' =&gt; 'art',
      ],
    ];
  }</span></pre>
<p><span class="koboSpan" id="kobo.702.1">In this case, it </span><a id="_idIndexMarker934"/><span class="koboSpan" id="kobo.703.1">is simply </span><strong class="source-inline"><span class="koboSpan" id="kobo.704.1">id</span></strong><span class="koboSpan" id="kobo.705.1">, the unique field from the legacy database </span><span class="No-Break"><span class="koboSpan" id="kobo.706.1">articles table.</span></span></p>
<h3><span class="koboSpan" id="kobo.707.1">Using a custom source plugin in the migration</span></h3>
<p><span class="koboSpan" id="kobo.708.1">With our </span><a id="_idIndexMarker935"/><span class="koboSpan" id="kobo.709.1">source plugin in place, we can now focus </span><a id="_idIndexMarker936"/><span class="koboSpan" id="kobo.710.1">on the </span><span class="No-Break"><span class="koboSpan" id="kobo.711.1">migration itself.</span></span></p>
<p><span class="koboSpan" id="kobo.712.1">Like in our other examples, we need to define a migration definition </span><span class="No-Break"><span class="koboSpan" id="kobo.713.1">YAML file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.714.1">
id: articles
label: Migrates articles from the legacy database.
</span><span class="koboSpan" id="kobo.714.2">Migration_tags: {}
migration_dependencies: {}
source:
  plugin: legacy_articles
  key: migrate
destination:
  plugin: entity:node
  default_bundle: article
process:
  title: title
  body/value: body
  body/format:
    plugin: default_value
    default_value: basic_html
  status: is_published
  created: published_on
  uid:
    plugin: default_value
    default_value: 1</span></pre>
<p><span class="koboSpan" id="kobo.715.1">One of the best parts about migrations in Drupal is that the API is well defined, so regardless of how you may be obtaining data or processing data, the definitions always follow the </span><span class="No-Break"><span class="koboSpan" id="kobo.716.1">same patterns.</span></span></p>
<p><span class="koboSpan" id="kobo.717.1">In this migration, we have specified our new source plugin, </span><strong class="source-inline"><span class="koboSpan" id="kobo.718.1">legacy_articles</span></strong><span class="koboSpan" id="kobo.719.1">, which is the plugin ID we provided in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">ArticlesSource</span></strong><span class="koboSpan" id="kobo.721.1"> class. </span><span class="koboSpan" id="kobo.721.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.722.1">key</span></strong><span class="koboSpan" id="kobo.723.1"> property in the source section is the same name as the database key we added in </span><strong class="source-inline"><span class="koboSpan" id="kobo.724.1">settings.php</span></strong><span class="koboSpan" id="kobo.725.1">. </span><span class="koboSpan" id="kobo.725.2">Since we extended </span><strong class="source-inline"><span class="koboSpan" id="kobo.726.1">SqlBase</span></strong><span class="koboSpan" id="kobo.727.1">, the key property is used when establishing a database connection to execute the query against. </span><span class="koboSpan" id="kobo.727.2">If you’re curious, you can review the </span><strong class="source-inline"><span class="koboSpan" id="kobo.728.1">getDatabase</span></strong><span class="koboSpan" id="kobo.729.1"> method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.730.1">SqlBase</span></strong><span class="koboSpan" id="kobo.731.1"> to see how it uses the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.732.1">key</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.733.1"> property.</span></span></p>
<p><span class="koboSpan" id="kobo.734.1">Since we defined our fields in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.735.1">fields</span></strong><span class="koboSpan" id="kobo.736.1"> method of our source plugin, we can skip the fields section in the migration definition entirely and use them as provided. </span><span class="koboSpan" id="kobo.736.2">In this case, the migration will already know what the fields are. </span><span class="koboSpan" id="kobo.736.3">The same is true of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.737.1">ids</span></strong><span class="koboSpan" id="kobo.738.1"> property; the source plugin already defines it, so we do not need to list it here like the other migrations in </span><span class="No-Break"><span class="koboSpan" id="kobo.739.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.740.1">From here, the </span><a id="_idIndexMarker937"/><span class="koboSpan" id="kobo.741.1">rest of the migration looks the same as</span><a id="_idIndexMarker938"/><span class="koboSpan" id="kobo.742.1"> what you have seen in other examples in this chapter. </span><span class="koboSpan" id="kobo.742.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.743.1">destination</span></strong><span class="koboSpan" id="kobo.744.1"> section informs the migration to create </span><strong class="source-inline"><span class="koboSpan" id="kobo.745.1">article</span></strong><span class="koboSpan" id="kobo.746.1"> nodes, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.747.1">process</span></strong><span class="koboSpan" id="kobo.748.1"> section defines how to map our source fields to </span><span class="No-Break"><span class="koboSpan" id="kobo.749.1">node fields.</span></span></p>
<p><span class="koboSpan" id="kobo.750.1">Once again, you can view this migration at </span><strong class="bold"><span class="koboSpan" id="kobo.751.1">Structure</span></strong><span class="koboSpan" id="kobo.752.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.753.1">Migrations</span></strong><span class="koboSpan" id="kobo.754.1"> in the admin and run it. </span><span class="koboSpan" id="kobo.754.2">Feel free to create a database alongside your Drupal database to experiment with the source plugin – once you know how to do it, you will be able to pull anything into Drupal and be a true </span><span class="No-Break"><span class="koboSpan" id="kobo.755.1">migration wizard.</span></span></p>
<h1 id="_idParaDest-435"><a id="_idTextAnchor471"/><span class="koboSpan" id="kobo.756.1">Writing a custom process plugin for migrations</span></h1>
<p><span class="koboSpan" id="kobo.757.1">At this </span><a id="_idIndexMarker939"/><span class="koboSpan" id="kobo.758.1">point, we’ve covered migrating</span><a id="_idIndexMarker940"/><span class="koboSpan" id="kobo.759.1"> data from CSV, JSON,  and database sources, but what about cases where the data from these sources don’t quite align with the way they need to be stored </span><span class="No-Break"><span class="koboSpan" id="kobo.760.1">in Drupal?</span></span></p>
<p><span class="koboSpan" id="kobo.761.1">Migrations can be a tricky thing. </span><span class="koboSpan" id="kobo.761.2">While Drupal provides several avenues to source data to migrate in, there will be many cases where you need to manipulate that incoming data to get it to a satisfactory state, either for storage or cleanup purposes. </span><span class="koboSpan" id="kobo.761.3">Fortunately, creating process plugins is easy, and you will be manipulating data in a migration in </span><span class="No-Break"><span class="koboSpan" id="kobo.762.1">no time.</span></span></p>
<h2 id="_idParaDest-436"><a id="_idTextAnchor472"/><span class="koboSpan" id="kobo.763.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.764.1">Let’s take a look at an example of writing a process plugin. </span><span class="koboSpan" id="kobo.764.2">Using the previous example, a custom source plugin that fetches data from a database table, assume we now have to pull an additional field for the migration, </span><strong class="source-inline"><span class="koboSpan" id="kobo.765.1">no_index</span></strong><span class="koboSpan" id="kobo.766.1">. </span><span class="koboSpan" id="kobo.766.2">While querying the data is easy, the data itself is not suitable for storage in the metatag field (</span><a href="https://www.drupal.org/project/metatag"><span class="koboSpan" id="kobo.767.1">https://www.drupal.org/project/metatag</span></a><span class="koboSpan" id="kobo.768.1">), as its value is either a 0 or 1. </span><span class="koboSpan" id="kobo.768.2">When the value is 1 (</span><strong class="source-inline"><span class="koboSpan" id="kobo.769.1">true</span></strong><span class="koboSpan" id="kobo.770.1">), the author has indicated they do not want this page crawled by search engines. </span><span class="koboSpan" id="kobo.770.2">In the previous system, the presence of this value would add additional metatags to the head of </span><span class="No-Break"><span class="koboSpan" id="kobo.771.1">the page.</span></span></p>
<p><span class="koboSpan" id="kobo.772.1">The contributed Metatag module is able to replicate this functionality. </span><span class="koboSpan" id="kobo.772.2">However, the metatag field stores this data in a serialized fashion in the database. </span><span class="koboSpan" id="kobo.772.3">We cannot use the value as-is from the source, but we can add a process plugin to </span><em class="italic"><span class="koboSpan" id="kobo.773.1">convert</span></em><span class="koboSpan" id="kobo.774.1"> the data to the way we </span><span class="No-Break"><span class="koboSpan" id="kobo.775.1">need it.</span></span></p>
<p><span class="koboSpan" id="kobo.776.1">Assuming you added a Metatag field to the Article content type in Drupal, you can migrate the data by doing </span><span class="No-Break"><span class="koboSpan" id="kobo.777.1">the following.</span></span></p>
<p><span class="koboSpan" id="kobo.778.1">First, let’s update our source plugin to account for a </span><span class="No-Break"><span class="koboSpan" id="kobo.779.1">new field:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.780.1">
    $query-&gt;fields('art', [
        'id',
        'title',
        'body',
        'is_published',
        'published_on',
        'no_index',
      ]);</span></pre>
<p><span class="koboSpan" id="kobo.781.1">Then, we </span><a id="_idIndexMarker941"/><span class="koboSpan" id="kobo.782.1">add it to </span><a id="_idIndexMarker942"/><span class="koboSpan" id="kobo.783.1">our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.784.1">fields</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.785.1"> list:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.786.1">
  public function fields() {
    return [
      'id' =&gt; $this→t('The article id.'),
      'title' =&gt; $this→t('The article title.'),
      'body' =&gt; $this→t('The article body content.'),
      'is_published' =&gt; $this→t('The published state.'),
      'published_on' =&gt; $this→t('The published date.'),
      'no_index' =&gt; $this→t('Indicates this article should
          not be crawled.'),
    ];
  }</span></pre>
<p><span class="koboSpan" id="kobo.787.1">Now that it has been added to the source plugin, the migration is receiving the value for </span><span class="No-Break"><span class="koboSpan" id="kobo.788.1">each record.</span></span></p>
<p><span class="koboSpan" id="kobo.789.1">Back in our migration definition, let’s map the metatags field and get set up to write the custom </span><span class="No-Break"><span class="koboSpan" id="kobo.790.1">process plugin:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.791.1">
  field_metatags:
    - plugin: set_no_index
      _source: no_index</span></pre>
<p><span class="koboSpan" id="kobo.792.1">Here, we are piping the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.793.1">no_index</span></strong><span class="koboSpan" id="kobo.794.1"> field to a plugin whose ID is </span><strong class="source-inline"><span class="koboSpan" id="kobo.795.1">set_no_index</span></strong><span class="koboSpan" id="kobo.796.1">. </span><span class="koboSpan" id="kobo.796.2">Now, we can start to manipulate the data during the migration so that it can be </span><span class="No-Break"><span class="koboSpan" id="kobo.797.1">stored properly.</span></span></p>
<p><span class="koboSpan" id="kobo.798.1">In the custom module, we create a directory at </span><strong class="source-inline"><span class="koboSpan" id="kobo.799.1">src/Plugin/migrate/process</span></strong><span class="koboSpan" id="kobo.800.1">. </span><span class="koboSpan" id="kobo.800.2">Within this directory, we are going to create a file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.801.1">SetNoIndex.php</span></strong><span class="koboSpan" id="kobo.802.1">. </span><span class="koboSpan" id="kobo.802.2">This is our new custom </span><span class="No-Break"><span class="koboSpan" id="kobo.803.1">process plugin.</span></span></p>
<p><span class="koboSpan" id="kobo.804.1">Custom</span><a id="_idIndexMarker943"/><span class="koboSpan" id="kobo.805.1"> process plugins at a minimum need to </span><a id="_idIndexMarker944"/><span class="koboSpan" id="kobo.806.1">implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.807.1">transform</span></strong><span class="koboSpan" id="kobo.808.1"> method. </span><span class="koboSpan" id="kobo.808.2">This method is responsible for handling and returning data for this step in </span><span class="No-Break"><span class="koboSpan" id="kobo.809.1">the pipeline.</span></span></p>
<p><span class="koboSpan" id="kobo.810.1">The process plugin code would look like </span><span class="No-Break"><span class="koboSpan" id="kobo.811.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.812.1">
&lt;?php
namespace Drupal\chapter14\Plugin\migrate\process;
use Drupal\migrate\ProcessPluginBase;
use Drupal\migrate\MigrateExecutableInterface;
use Drupal\migrate\Row;
/**
 * @MigrateProcessPlugin(
 *   id = "set_no_index",
 * )
 */
class SetNoIndex extends ProcessPluginBase {
  /**
   * {@inheritdoc}
   */
  public function transform($value, MigrateExecutableInter
      face $migrate_executable, Row $row, $destination
          _property) {
    return (bool) $value ? </span><span class="koboSpan" id="kobo.812.2">['robots' =&gt; 'noindex, nofollow,
        noarchive, nosnippet'] : [];
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.813.1">Like the</span><a id="_idIndexMarker945"/><span class="koboSpan" id="kobo.814.1"> custom source plugin, note the annotation at the</span><a id="_idIndexMarker946"/><span class="koboSpan" id="kobo.815.1"> top of the class. </span><span class="koboSpan" id="kobo.815.2">This is required so that the plugin can be discovered by Drupal. </span><span class="koboSpan" id="kobo.815.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.816.1">id</span></strong><span class="koboSpan" id="kobo.817.1"> value is the same one we used in the </span><span class="No-Break"><span class="koboSpan" id="kobo.818.1">migration definition.</span></span></p>
<h2 id="_idParaDest-437"><a id="_idTextAnchor473"/><span class="koboSpan" id="kobo.819.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.820.1">When the migration runs, if the value passed in is 1, we get an array of values back. </span><span class="koboSpan" id="kobo.820.2">This is exactly what we need! </span><span class="koboSpan" id="kobo.820.3">However, we need to do one more thing before this will be successfully saved </span><span class="No-Break"><span class="koboSpan" id="kobo.821.1">into Drupal.</span></span></p>
<p><span class="koboSpan" id="kobo.822.1">Remember how we mentioned earlier that data is stored as a serialized array? </span><span class="koboSpan" id="kobo.822.2">Passing a plain PHP array along from our custom process plugin is not enough. </span><span class="koboSpan" id="kobo.822.3">In a migration, you can use several process plugins in a field mapping. </span><span class="koboSpan" id="kobo.822.4">They are run in the order they are listed, and this offers a composable way to transform the </span><span class="No-Break"><span class="koboSpan" id="kobo.823.1">source data.</span></span></p>
<p><span class="koboSpan" id="kobo.824.1">Fortunately, the core Migrate module provides a process plugin that will help us out, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.825.1">callback</span></strong><span class="koboSpan" id="kobo.826.1"> process plugin. </span><span class="koboSpan" id="kobo.826.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.827.1">callback</span></strong><span class="koboSpan" id="kobo.828.1"> process plugin calls a PHP function using the value from the previous process plugin (our result from </span><strong class="source-inline"><span class="koboSpan" id="kobo.829.1">set_no_index</span></strong><span class="koboSpan" id="kobo.830.1">) and returns the value from the </span><span class="No-Break"><span class="koboSpan" id="kobo.831.1">callback provided.</span></span></p>
<p><span class="koboSpan" id="kobo.832.1">Combining the two in the pipeline would look </span><span class="No-Break"><span class="koboSpan" id="kobo.833.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.834.1">
  field_metatags:
    - plugin: set_no_index
      _source: no_index
    - plugin: callback
      _callable: serialize</span></pre>
<p><span class="koboSpan" id="kobo.835.1">After updating the migration definition, we need to bring those changes into Drupal. </span><span class="koboSpan" id="kobo.835.2">This can be done </span><span class="No-Break"><span class="koboSpan" id="kobo.836.1">using Drush:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.837.1">
php vendor/bin/drush config-import --partial --source=/var/www/
html/web/modules/custom/chapter14/config/install -y</span></pre>
<p><span class="koboSpan" id="kobo.838.1">This command will re-import the configuration files in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.839.1">config/install</span></strong><span class="koboSpan" id="kobo.840.1"> directory of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.841.1">chapter14</span></strong><span class="koboSpan" id="kobo.842.1"> module. </span><span class="koboSpan" id="kobo.842.2">This command is a good way to continually bring in changes to a definition as you work on a migration definition bit </span><span class="No-Break"><span class="koboSpan" id="kobo.843.1">by bit.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.844.1">Migration definitions are configuration</span></p>
<p class="callout"><span class="koboSpan" id="kobo.845.1">Migration YAML files are configured just like any other Drupal configuration file. </span><span class="koboSpan" id="kobo.845.2">When you make updates to a migration YAML file and import the changes with the command above, be sure to</span><strong class="source-inline"><span class="koboSpan" id="kobo.846.1"> config-export</span></strong><span class="koboSpan" id="kobo.847.1"> when ready to deploy or commit the work to </span><span class="No-Break"><span class="koboSpan" id="kobo.848.1">a repository.</span></span></p>
<p><span class="koboSpan" id="kobo.849.1">When we run the migration, we have the new data in our metatags field. </span><span class="koboSpan" id="kobo.849.2">In this example, you could validate that it worked in </span><span class="No-Break"><span class="koboSpan" id="kobo.850.1">two ways:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.851.1">First, you </span><a id="_idIndexMarker947"/><span class="koboSpan" id="kobo.852.1">can look at the migrated content</span><a id="_idIndexMarker948"/><span class="koboSpan" id="kobo.853.1"> on your site in the admin, edit one of the migrated nodes, and see that the metatags field has the correct data on the </span><span class="No-Break"><span class="koboSpan" id="kobo.854.1">node form:</span></span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer125">
<span class="koboSpan" id="kobo.855.1"><img alt="Figure 14.7 – The metatags fields on the node form" src="image/Figure_14.7_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.856.1">Figure 14.7 – The metatags fields on the node form</span></p>
<ul>
<li><span class="koboSpan" id="kobo.857.1">Secondly, you can check the metatags field in the database and see the raw data </span><span class="No-Break"><span class="koboSpan" id="kobo.858.1">is there:</span></span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer126">
<span class="koboSpan" id="kobo.859.1"><img alt="Figure 14.8 – The metatags table in the database reflects the values we want to migrate" src="image/Figure_14.8_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.860.1">Figure 14.8 – The metatags table in the database reflects the values we want to migrate</span></p>
<p><span class="koboSpan" id="kobo.861.1">If you remember from the previous chapter, we discussed the importance of </span><em class="italic"><span class="koboSpan" id="kobo.862.1">knowing</span></em><span class="koboSpan" id="kobo.863.1"> that code we wrote actually works using unit tests. </span><span class="koboSpan" id="kobo.863.2">Process plugins are pretty easy to write tests for. </span><span class="koboSpan" id="kobo.863.3">We may be viewing data in Drupal from the migration, but let’s be 100% certain that our process plugin is doing the </span><span class="No-Break"><span class="koboSpan" id="kobo.864.1">right thing.</span></span></p>
<p><span class="koboSpan" id="kobo.865.1">Our unit test</span><a id="_idIndexMarker949"/><span class="koboSpan" id="kobo.866.1"> for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.867.1">set_no_index</span></strong><span class="koboSpan" id="kobo.868.1"> plugin would </span><a id="_idIndexMarker950"/><span class="koboSpan" id="kobo.869.1">look </span><span class="No-Break"><span class="koboSpan" id="kobo.870.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.871.1">
&lt;?php
namespace Drupal\Tests\chapter14\Unit\Plugin\migrate\
    process;
use Drupal\chapter14\Plugin\migrate\process\SetNoIndex;
use Drupal\Tests\migrate\Unit\process\
    MigrateProcessTestCase;
/**
 * Tests the set_no_index process plugin.
 </span><span class="koboSpan" id="kobo.871.2">*/
class SetNoIndexTest extends MigrateProcessTestCase {
  /**
   * {@inheritdoc}
   */
  protected function setUp(): void {
    $this-&gt;plugin = new SetNoIndex([], 'set_no_index', []);
    parent::setUp();
  }
  /**
   * Data provider for testPluginValue().
</span><span class="koboSpan" id="kobo.871.3">   *
   * @return array
   *   An array containing input values and expected output
         values.
</span><span class="koboSpan" id="kobo.871.4">   */
  public function valueProvider() {
    return [
      [1, ['robots' =&gt; 'noindex, nofollow, noarchive,
        nosnippet']],
      [0, []],
      [NULL, []],
    ];
  }
  /**
   * Test set_no_index plugin.
</span><span class="koboSpan" id="kobo.871.5">   *
   * @param $input
   *   The input values.
</span><span class="koboSpan" id="kobo.871.6">   *
   * @param $expected
   *   The expected output.
</span><span class="koboSpan" id="kobo.871.7">   *
   * @dataProvider valueProvider
   */
  public function testPluginValue($input, $expected) {
    $output = $this-&gt;plugin-&gt;transform($input, $this-&gt;
        migrateExecutable, $this-&gt;row,
            'destinationproperty');
    $this-&gt;assertSame($output, $expected);
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.872.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.873.1">valueProvider</span></strong><span class="koboSpan" id="kobo.874.1"> method feeds our test method values and the result we expect our </span><strong class="source-inline"><span class="koboSpan" id="kobo.875.1">set_no_index</span></strong><span class="koboSpan" id="kobo.876.1"> plugin to return when evaluated. </span><span class="koboSpan" id="kobo.876.2">Now we know for certain that our migration will </span><a id="_idIndexMarker951"/><span class="koboSpan" id="kobo.877.1">always provide the right data and that </span><a id="_idIndexMarker952"/><span class="koboSpan" id="kobo.878.1">no migrated articles will be incorrectly crawled by search engines. </span><span class="koboSpan" id="kobo.878.2">For more on unit testing in Drupal, be sure to refer to </span><a href="B18548_13.xhtml#_idTextAnchor412"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.879.1">Chapter 13</span></em></span></a><span class="koboSpan" id="kobo.880.1">, </span><em class="italic"><span class="koboSpan" id="kobo.881.1">Running and Writing Tests </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.882.1">with Drupal</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.883.1">.</span></span></p>
<h2 id="_idParaDest-438"><a id="_idTextAnchor474"/><span class="koboSpan" id="kobo.884.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.885.1">In this chapter, we have demonstrated the power and flexibility of the Migrate and Migrate Plus modules of Drupal. </span><span class="koboSpan" id="kobo.885.2">Wielding both of these will empower you to migrate data from just about any source and process it accordingly. </span><span class="koboSpan" id="kobo.885.3">We also demonstrated how you can write custom source and custom process plugins to achieve this goal </span><span class="No-Break"><span class="koboSpan" id="kobo.886.1">as well.</span></span></p>
<p><span class="koboSpan" id="kobo.887.1">Be sure to check the contributed module ecosystem of Migrate on </span><a href="http://Drupal.org"><span class="koboSpan" id="kobo.888.1">Drupal.org</span></a><span class="koboSpan" id="kobo.889.1">. </span><span class="koboSpan" id="kobo.889.2">There are several modules that provide countless source and process plugins, covering various data sources, such as CSV, JSON, XML, XLS, HTML, and </span><span class="No-Break"><span class="koboSpan" id="kobo.890.1">HTTP APIs.</span></span></p>
</div>
</body></html>