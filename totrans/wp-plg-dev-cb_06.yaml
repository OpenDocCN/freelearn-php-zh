- en: Accepting User Content Submissions
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 接受用户内容提交
- en: 'In this chapter, we will be focusing on giving visitors the ability to make
    submissions to a website. We will cover the following recipes:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将专注于向访客提供向网站提交内容的能力。我们将涵盖以下食谱：
- en: Creating a client-side content submission form
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 创建客户端内容提交表单
- en: Saving user-submitted content in custom post types
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在自定义帖子类型中保存用户提交的内容
- en: Sending email notifications upon new submissions
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在新提交后发送电子邮件通知
- en: Implementing a CAPTCHA on user forms using an online service
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用在线服务在用户表单上实现CAPTCHA
- en: Using a local library to implement a CAPTCHA on user forms
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用本地库在用户表单上实现CAPTCHA
- en: Introduction
  id: totrans-7
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 简介
- en: Giving users the ability to contribute content to a website is always a good
    way to engage the community and keep content fresh on a website. Going back to
    the book review system that was put in place in [Chapter 4](6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml),
    *The Power of Custom Post Types*, this chapter explains how to allow visitors
    to add their own book reviews to a website.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 给用户提供在网站上贡献内容的能力是吸引社区和保持网站内容新鲜的好方法。回到在[第4章](6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml)中实施的书籍评论系统，《自定义帖子类型的威力》，本章解释了如何允许访客向网站添加自己的书评。
- en: Creating a client-side content submission form
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建客户端内容提交表单
- en: The first step toward giving visitors the ability to contribute to a website
    is to present a form that they will be able to use to submit new content. This
    recipe shows how to create a shortcode that can easily be inserted on any WordPress
    page to render a simple form.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 向访客提供在网站上贡献内容的能力的第一步是展示一个他们可以使用来提交新内容的表单。本食谱展示了如何创建一个可以轻松插入任何WordPress页面以渲染简单表单的短代码。
- en: Getting ready
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: You should be running the final version of the Book Reviews plugin created in
    [Chapter 4](6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml), *The Power of Custom
    Post Types*, or using the final resulting code (`Chapter 4/ch4-book-reviews/ch4-book-reviews-v11.php`)
    from the downloaded code bundle.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该运行在[第4章](6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml)中创建的Book Reviews插件的最终版本，即《自定义帖子类型的威力》，或者使用下载的代码包中的最终结果代码（`Chapter
    4/ch4-book-reviews/ch4-book-reviews-v11.php`）。
- en: How to do it...
  id: totrans-13
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: Navigate to the WordPress plugin directory of your development installation.
  id: totrans-14
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 导航到你的开发安装的WordPress插件目录。
- en: Create a new directory called `ch6-book-review-user-submission` and open it.
  id: totrans-15
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个名为`ch6-book-review-user-submission`的新目录并打开它。
- en: Create a text file called `ch6-book-review-user-submission.php`.
  id: totrans-16
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个名为`ch6-book-review-user-submission.php`的文本文件。
- en: Open the new file in a code editor and add an appropriate header at the top
    of the plugin file, naming the plugin `Chapter 6 - Book Review User Submission`.
  id: totrans-17
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在代码编辑器中打开新文件，并在插件文件顶部添加一个适当的标题，将插件命名为“第6章 - 书评用户提交”。
- en: 'Add the following line of code to declare a new shortcode and its associated
    function:'
  id: totrans-18
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 添加以下代码行以声明一个新的短代码及其相关函数：
- en: '[PRE0]'
  id: totrans-19
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Add the following code segment to provide an implementation for the `ch6_brus_book_review_form`
    function:'
  id: totrans-20
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 向`ch6_brus_book_review_form`函数提供以下代码段：
- en: '[PRE1]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Save and close the plugin file.
  id: totrans-22
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存并关闭插件文件。
- en: Activate the `Chapter 6 - Book Review User Submission` plugin.
  id: totrans-23
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 激活“第6章 - 书评用户提交”插件。
- en: Create a new page and insert the newly created `[submit-book-review]` shortcode
    in the item's content.
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个新页面，并在项目内容中插入新创建的`[submit-book-review]`短代码。
- en: 'Publish and view the page to see the form. If you submit the form, nothing
    will happen at the moment, since we have not implemented a processing function
    to parse and save the submitted data:'
  id: totrans-25
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 发布并查看页面以查看表单。如果你提交表单，目前不会有任何动作，因为我们还没有实现一个处理函数来解析和保存提交的数据：
- en: '![](img/4983c168-84af-4664-a966-3e48e235547a.png)'
  id: totrans-26
  prefs: []
  type: TYPE_IMG
  zh: '![图片](img/4983c168-84af-4664-a966-3e48e235547a.png)'
- en: How it works...
  id: totrans-27
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: As seen in the previous chapters, shortcodes are special blocks of text that
    can be easily added in any post or page to be replaced by content when they are
    found in pages visited by users. This recipe uses the `add_shortcode` function
    to declare a new shortcode that gets replaced with a review submission form.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 如前几章所见，短代码是可以在任何帖子或页面中轻松添加的特殊文本块，当它们出现在用户访问的页面中时，会被内容替换。本食谱使用`add_shortcode`函数声明一个新的短代码，该短代码会被替换为评论提交表单。
- en: The form itself is created using standard HTML and displays a number of text
    fields. It also uses a bit of PHP code to dynamically build the list of ratings
    and book types defined in the system. The form also includes a PHP call to the
    `wp_nonce_field` function, which was previously seen when creating plugin configuration
    panels, to add hidden fields that will be used as a security measure in the associated
    data processing function. Finally, the code checks to see whether the user visiting
    the page is logged in to the website and displays a short message instead of the
    submission form when the check is negative.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 该表单本身使用标准HTML创建，并显示多个文本字段。它还使用一些PHP代码来动态构建系统中定义的评分和书籍类型列表。表单还包括对`wp_nonce_field`函数的PHP调用，该函数在创建插件配置面板时已见过，用于添加将作为关联数据处理函数中的安全措施使用的隐藏字段。最后，代码检查访问该页面的用户是否已登录到网站，并在检查结果为否定时显示一条简短的消息而不是提交表单。
- en: When submitted, the form action will send visitor content to the page where
    the book review form is displayed. This new content will be intercepted and processed
    in the code that will be added in the next recipe.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 提交时，表单操作将发送访客内容到显示书籍评论表单的页面。此新内容将被拦截并在下一个配方中添加的代码中进行处理。
- en: See also
  id: totrans-31
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 相关内容
- en: The *Creating a new simple shortcode* recipe in [Chapter 2](f7395811-9e4a-4913-8a02-cc68875d0071.xhtml),
    *Plugin Framework Basics*
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在[第2章](f7395811-9e4a-4913-8a02-cc68875d0071.xhtml)的*插件框架基础*中，创建一个新的简单短代码配方。
- en: Saving user-submitted content in custom post types
  id: totrans-33
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在自定义帖子类型中保存用户提交的内容
- en: When visitors click on the Submit button on the form created in the previous
    recipe, the target of the form is set to be the same page that is hosting the
    submission form. Since this page is not capable of handling form data, we must
    implement an action hook that intercepts this post data and sends it to a processing
    function that we will define. This recipe shows how to implement a function responsible
    for processing user input.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 当访客点击上一个配方中创建的表单上的提交按钮时，表单的目标被设置为托管提交表单的同一页面。由于该页面无法处理表单数据，我们必须实现一个动作钩子来拦截这些帖子数据并将其发送到我们将定义的处理函数。本配方展示了如何实现一个负责处理用户输入的函数。
- en: Getting ready
  id: totrans-35
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: You should be running the final version of the Book Reviews plugin created in
    [Chapter 4](6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml), *The Power of Custom
    Post Types*, and should have already followed the *Creating a client-side content
    submission form* recipe. Alternatively, you can get the files from the code bundle
    (`Chapter 4/ch4-book-reviews/ch4-book-reviews-v11.php` and `Chapter 6/ch6-book-review-user-submission/ch6-book-review-user-submission-v1.php`),
    and rename `ch6-book-review-user-submission-v1.php` to `ch6-book-review-user-submission.php`.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该运行[第4章](6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml)中创建的最终版本的书籍评论插件，并且应该已经遵循了*创建客户端内容提交表单*的配方。或者，您可以从代码包中获取文件（`Chapter
    4/ch4-book-reviews/ch4-book-reviews-v11.php`和`Chapter 6/ch6-book-review-user-submission/ch6-book-review-user-submission-v1.php`），并将`ch6-book-review-user-submission-v1.php`重命名为`ch6-book-review-user-submission.php`。
- en: How to do it...
  id: totrans-37
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: Navigate to the `ch6-book-review-user-submission` directory of the WordPress
    plugin folder of your development installation.
  id: totrans-38
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 导航到您开发安装中WordPress插件文件夹的`ch6-book-review-user-submission`目录。
- en: Open the file `ch6-book-review-user-submission.php` in a text editor.
  id: totrans-39
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在文本编辑器中打开文件`ch6-book-review-user-submission.php`。
- en: 'Add the following line of code to register a function that will intercept user-submitted
    book reviews:'
  id: totrans-40
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将以下代码行添加以注册一个将拦截用户提交的书籍评论的函数：
- en: '[PRE2]'
  id: totrans-41
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Add the following block of code to implement the `ch6_brus_match_new_book_reviews`
    function:'
  id: totrans-42
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将以下代码块添加以实现`ch6_brus_match_new_book_reviews`函数：
- en: '[PRE3]'
  id: totrans-43
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Insert the following code to provide an implementation for the `ch6_brus_process_user_book_reviews`:'
  id: totrans-44
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 插入以下代码以提供`ch6_brus_process_user_book_reviews`的实现：
- en: '[PRE4]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'In the original `ch6_brus_book_review_form` function, add the following code
    after the `wp_nonce_field` function call:'
  id: totrans-46
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在原始的`ch6_brus_book_review_form`函数中，在`wp_nonce_field`函数调用之后添加以下代码：
- en: '[PRE5]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Save and close the plugin file.
  id: totrans-48
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存并关闭插件文件。
- en: Go back to the book review submission form and submit a review to send all the
    fields to the newly created processing function. After processing the new content,
    the script will return to the form, which will display a confirmation message.
  id: totrans-49
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 返回书籍评论提交表单并提交一条评论以将所有字段发送到新创建的处理函数。处理新内容后，脚本将返回到表单，显示一条确认消息。
- en: How it works...
  id: totrans-50
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 工作原理...
- en: After submitting the book review form data to the page containing the book review
    submission form in the previous recipe, the first few steps of this recipe will
    be to assign a function to the `template_redirect` action hook to allow us to
    capture new book review content. This hook function is executed early in the WordPress
    processing sequence. If found, we will call the processing function that is defined
    in the rest of the recipe.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 在将书评表单数据提交到包含上一食谱中书评提交表单的页面后，这个食谱的前几个步骤将是将一个函数分配给`template_redirect`动作钩子，以便我们能够捕获新的书评内容。此钩子函数在WordPress处理序列的早期执行。如果找到，我们将调用在食谱其余部分定义的处理函数。
- en: The first thing that is done in our processing function is to check whether
    the proper hidden data field is found as part of the post data, using the `wp_verify_nonce`
    function. If it is not present, indicating that someone may be trying to post
    data to the website without having visited the frontend form, it will display
    an error message.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的处理函数中，首先要做的是检查是否找到了作为帖子数据一部分的正确隐藏数据字段，使用`wp_verify_nonce`函数。如果不存在，表明有人可能试图在没有访问前端表单的情况下向网站发布数据，它将显示一个错误消息。
- en: When we are sure that our data storage script is being called legitimately,
    we will continue processing the actual data by first checking to see whether all
    the fields are present and are not empty. If that is not the case, we will display
    an error message, asking the user to go back and complete the form using the `wp_die`
    function.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们确信我们的数据存储脚本是合法调用的，我们将继续通过首先检查所有字段是否存在且不为空来处理实际数据。如果不是这样，我们将显示一个错误消息，要求用户使用`wp_die`函数返回并完成表单。
- en: If all the fields have been received correctly, the recipe continues to process
    the incoming data by preparing an array of information that includes the newly
    submitted title and review text, along with a post status and the `book_reviews`
    post type name. The resulting array is sent to the `wp_insert_post` function to
    store the information. As we can see, `wp_insert_post` only requires a single
    parameter that is fulfilled using the array that we just created. While we only
    define four elements of that array, many more are available, which can be seen
    by consulting the WordPress Codex ([https://developer.wordpress.org/reference/functions/wp_insert_post/](https://developer.wordpress.org/reference/functions/wp_insert_post/)).
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 如果所有字段都已正确接收，食谱将继续通过准备一个包含新提交的标题和评论文本、帖子状态以及`book_reviews`帖子类型名称的信息数组来处理传入的数据。生成的数组被发送到`wp_insert_post`函数以存储信息。正如我们所见，`wp_insert_post`只需要一个参数，该参数使用我们刚刚创建的数组来满足。虽然我们只定义了该数组的四个元素，但还有更多可用，这可以通过查阅WordPress
    Codex（[https://developer.wordpress.org/reference/functions/wp_insert_post/](https://developer.wordpress.org/reference/functions/wp_insert_post/))来了解。
- en: Now, calling `wp_insert_post` only takes care of storing some key data elements
    that belong in the post data. We must follow up this code with calls to `update_post_meta`
    and `wp_set_post_terms` to store the remaining user information to the website
    database.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，调用`wp_insert_post`仅负责存储属于帖子数据的一些关键数据元素。我们必须随后调用`update_post_meta`和`wp_set_post_terms`来将剩余的用户信息存储到网站数据库中。
- en: Once all the information is stored, we use a combination of the `wp_redirect`
    and `add_query_arg` functions to send the user back to the page where he submitted
    a book review, while making sure that only one instance of the `add_review_message`
    variable is in the target address.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦所有信息都存储完毕，我们使用`wp_redirect`和`add_query_arg`函数的组合将用户送回到他提交书评的页面，同时确保目标地址中只有一个`add_review_message`变量的实例。
- en: Last but not least, this recipe makes a small modification to the code that
    rendered the book review form to add a confirmation message that is shown to visitors
    when information is accepted by the plugin.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 最后但同样重要的是，这个食谱对渲染书评表单的代码进行了微小修改，以添加一个确认消息，当插件接受信息时，该消息会显示给访客。
- en: There's more...
  id: totrans-58
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 还有更多...
- en: In a world of spam bots and real people, who are set on creating bogus content
    on any website, setting new book reviews to be immediately visible on the website
    might not be wise.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 在一个充斥着垃圾邮件机器人和决心在任何网站上创建虚假内容的真实人的世界中，将新书评论立即显示在网站上可能不是明智之举。
- en: Moderating user-submitted content
  id: totrans-60
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 审核用户提交的内容
- en: Instead of setting a status of publish for new post entries, we can use a value
    of draft to make the new entry visible only in the backend administration area.
    To give plugin users more flexibility, you could also give them a way to decide
    what method they prefer in a configuration panel.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 与将新帖子条目的状态设置为发布相比，我们可以使用草稿值使新条目仅在后台管理区域可见。为了给插件用户提供更多灵活性，您还可以在配置面板中给他们提供选择他们偏好的方法的方式。
- en: See also
  id: totrans-62
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 参见
- en: The *Creating a client-side content submission form* recipe
  id: totrans-63
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*创建客户端内容提交表单*配方'
- en: The *Processing and storing plugin configuration data* recipe in [Chapter 3](0346c3c6-27ee-45fb-bfd6-df398e04b2b4.xhtml),
    *User Settings and Administration Pages*
  id: totrans-64
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在[第3章](0346c3c6-27ee-45fb-bfd6-df398e04b2b4.xhtml)，“用户设置和管理页面”中的*处理和存储插件配置数据*配方
- en: The *Adding a new section to the custom post type editor* recipe in [Chapter
    4](6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml), *The Power of Custom Post Types*
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在[第4章](6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml)，“自定义文章类型的威力”中的*向自定义文章类型编辑器添加新部分*配方
- en: Sending email notifications upon new submissions
  id: totrans-66
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在新提交时发送电子邮件通知
- en: Just like WordPress sends out email notifications to the administrator when
    new comments are posted, sending out emails when visitors post new book reviews
    allows website managers to review new content as it comes in and decide if they
    approve it to be published online.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 就像WordPress在发布新评论时向管理员发送电子邮件通知一样，当访客发布新书评时发送电子邮件，允许网站管理员在内容到来时进行审查，并决定是否批准将其发布到网上。
- en: This recipe shows how to prepare email data and send it using the `wp_mail`
    function.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 这个配方展示了如何准备电子邮件数据并使用`wp_mail`函数发送它。
- en: Getting ready
  id: totrans-69
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: You should be running the final version of the Book Reviews plugin created in
    [Chapter 4](6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml), *The Power of Custom
    Post Types*, and should have already followed the *Saving user-submitted data
    in custom post types* recipe (including changing the post status to draft as indicated
    in the *There's more*... section). Alternatively, you can get the resulting files
    from the code bundle (`Chapter 4/ch4-book-reviews/ch4-book-reviews-v11.php` and
    `Chapter 6/ch6-book-review-user-submission/ch6-book-review-user-submission-v2.php`)
    and rename `ch6-book-review-user-submission-v2.php` to `ch6-book-review-user-submission.php`.
    Finally, you should have access to a WordPress installation on a hosted web server,
    as emails are usually not sent when running it on a local installation. Be sure
    to have access to the email account associated with the website administrator
    to see the resulting email.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该运行在[第4章](6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml)，“自定义文章类型的威力”中创建的Book
    Reviews插件的最终版本，并且应该已经遵循了*在自定义文章类型中保存用户提交的数据*的配方（包括根据*更多内容*部分中的指示更改文章状态为草稿）。或者，您可以从代码包中获取结果文件（`Chapter
    4/ch4-book-reviews/ch4-book-reviews-v11.php`和`Chapter 6/ch6-book-review-user-submission/ch6-book-review-user-submission-v2.php`），并将`ch6-book-review-user-submission-v2.php`重命名为`ch6-book-review-user-submission.php`。最后，您应该能够访问托管在Web服务器上的WordPress安装，因为当在本地安装上运行时，通常不会发送电子邮件。确保您有权访问与网站管理员关联的电子邮件账户，以查看生成的电子邮件。
- en: How to do it...
  id: totrans-71
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何做到这一点...
- en: Navigate to the `ch6-book-review-user-submission` directory of the WordPress
    plugin folder of your development installation.
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 导航到您的开发安装中WordPress插件文件夹的`ch6-book-review-user-submission`目录。
- en: Open the file `ch6-book-review-user-submission.php` in a text editor.
  id: totrans-73
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在文本编辑器中打开`ch6-book-review-user-submission.php`文件。
- en: 'Insert the following line of code to register a function to be called back
    when new posts are submitted:'
  id: totrans-74
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 插入以下代码行以注册一个在提交新帖子时被调用的函数：
- en: '[PRE6]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Insert the following block of code to implement the `ch6_brus_send_email` function:'
  id: totrans-76
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 插入以下代码块以实现`ch6_brus_send_email`函数：
- en: '[PRE7]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Save and close the plugin file.
  id: totrans-78
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存并关闭插件文件。
- en: 'Go back to the book review submission form and submit a book review. An email
    will be sent to the address associated with the website administrator, containing
    some information from the new review:'
  id: totrans-79
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 返回书评提交表单并提交书评。将向与网站管理员关联的地址发送一封电子邮件，其中包含新评论的一些信息：
- en: '![](img/5d17aacb-9af6-4397-8a7a-a81f617416f5.png)'
  id: totrans-80
  prefs: []
  type: TYPE_IMG
  zh: '![图片](img/5d17aacb-9af6-4397-8a7a-a81f617416f5.png)'
- en: How it works...
  id: totrans-81
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: 'The `wp_mail` function can be used by any plugin to send out email messages.
    It takes five arguments to define all the elements of the outgoing message:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: '`wp_mail`函数可以被任何插件用来发送电子邮件消息。它需要五个参数来定义出站消息的所有元素：'
- en: '[PRE8]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: The first three arguments are required and respectively define the email address
    of the intended recipient, the title of the message, and its content. As we have
    seen in this recipe, the content is mainly specified using standard HTML syntax,
    while the target email address is retrieved from the options table using the `get_option`
    function. As for the title, it is built from a number of textual elements, such
    as the blog title and book review title, to create the final result.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 前三个参数是必需的，分别定义了预期收件人的电子邮件地址、消息标题和内容。正如我们在本配方中看到的，内容主要使用标准HTML语法指定，而目标电子邮件地址是通过`get_option`函数从选项表中检索的。至于标题，它是由多个文本元素（如博客标题和书评标题）构建的，以创建最终结果。
- en: The next parameter is optional and provides header information for the email,
    with the most important piece of information in that section being the character
    set. The last parameter can optionally be used to specify the path of one or more
    files to be sent as email attachments.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个参数是可选的，为电子邮件提供标题信息，其中该部分最重要的信息是字符集。最后一个参数可以可选地用来指定一个或多个文件的路径，这些文件将被作为电子邮件附件发送。
- en: To make it easier for website administrators to manage new entries, part of
    the message body contains a link to the custom post management page of the WordPress
    website administration area to quickly display all the unapproved entries (set
    as draft items).
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使网站管理员更容易管理新条目，消息正文的一部分包含一个链接到WordPress网站管理区域的自定义帖子管理页面，以便快速显示所有未批准的条目（设置为草稿项目）。
- en: See also
  id: totrans-87
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 参考内容
- en: The *Creating a client-side content submission form* recipe
  id: totrans-88
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*创建客户端内容提交表单*配方'
- en: Implementing a CAPTCHA on user forms using an online service
  id: totrans-89
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在用户表单上使用在线服务实现CAPTCHA
- en: A common security measure on website forms is to use CAPTCHA codes, where distorted
    letters or some other form of test is displayed to check that the person submitting
    data is not a spam robot. The form that we have been building to accept visitor-submitted
    book reviews could benefit from this type of technology to avoid weeding through
    unwanted entries.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 网站表单上的一种常见安全措施是使用CAPTCHA代码，其中显示扭曲的字母或其他形式的测试，以检查提交数据的个人不是垃圾邮件机器人。我们一直在构建的接受访客提交的书评表单可以从这种技术中受益，以避免筛选不想要的条目。
- en: This recipe shows how to integrate Google's reCAPTCHA service in our book review
    submission form. If you prefer using a local CAPTCHA script to avoid being dependent
    on an online service or to be sure that your form can be used in all countries,
    jump to the next recipe, titled *Using a local library to implement a CAPTCHA
    on user forms*.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 这个配方展示了如何将Google的reCAPTCHA服务集成到我们的书评提交表单中。如果您更喜欢使用本地CAPTCHA脚本以避免依赖在线服务或确保您的表单可以在所有国家使用，请跳转到下一个配方，标题为*使用本地库在用户表单上实现CAPTCHA*。
- en: Getting ready
  id: totrans-92
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: You should be running the final version of the Book Reviews plugin created in
    [Chapter 4](6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml), *The Power of Custom
    Post Types*, and should have already followed the *Sending email notifications
    upon new submissions* recipe. Alternatively, you can get the resulting files from
    the code bundle (`Chapter 4/ch4-book-reviews/ch4-book-reviews-v11.php` and `Chapter
    6/ch6-book-review-user-submission/ch6-book-review-user-submission-v3.php`) and
    rename `ch6-book-review-user-submission-v3.php` to `ch6-book-review-user-submission.php`
    before starting the recipe.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该运行在第4章中创建的最终版本的“书评插件”，*自定义帖子类型的力量*，并且应该已经遵循了*在新的提交后发送电子邮件通知*的配方。或者，您可以从代码包中获取结果文件（`Chapter
    4/ch4-book-reviews/ch4-book-reviews-v11.php`和`Chapter 6/ch6-book-review-user-submission/ch6-book-review-user-submission-v3.php`），并在开始配方之前将`ch6-book-review-user-submission-v3.php`重命名为`ch6-book-review-user-submission.php`。
- en: This recipe requires having a Google account to be able to register for the
    reCAPTCHA service.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 这个配方需要有一个Google账户才能注册reCAPTCHA服务。
- en: How to do it...
  id: totrans-95
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: Visit the Google reCAPTCHA administrator website ([https://www.google.com/recaptcha/admin](https://www.google.com/recaptcha/admin))
    and log in if you are not already connected to Google services.
  id: totrans-96
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 访问Google reCAPTCHA管理员网站([https://www.google.com/recaptcha/admin](https://www.google.com/recaptcha/admin))，如果您尚未连接到Google服务，请登录。
- en: Register a new website by specifying a Label (for example, `Development website`)
    and setting the type of reCAPTCHA to reCAPTCHA V2 using the radio selector.
  id: totrans-97
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过指定标签（例如，`开发网站`）并使用单选选择器设置reCAPTCHA类型为reCAPTCHA V2来注册一个新的网站。
- en: Enter the domain name of the web server you will be using to test your code
    in the Domains field. If you are running a local development server, it is likely
    to be `localhost`.
  id: totrans-98
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在域名字段中输入您将用于测试代码的Web服务器的域名。如果您正在运行本地开发服务器，它可能是`localhost`。
- en: Check the box to accept the terms of service, then click on Register to complete
    the new website creation process.
  id: totrans-99
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开复选框以接受服务条款，然后点击注册以完成新网站创建过程。
- en: In the resulting page, take note of the website and secret keys that the service
    assigned to your test website.
  id: totrans-100
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在生成的页面中，注意服务分配给您的测试网站的网络和密钥。
- en: Navigate to the `ch6-book-review-user-submission` directory of your plugin folder
    and open the file named `ch6-book-review-user-submission.php` in a code editor.
  id: totrans-101
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 导航到您的插件文件夹中的`ch6-book-review-user-submission`目录，并在代码编辑器中打开名为`ch6-book-review-user-submission.php`的文件。
- en: 'Insert the following line of code at the end of the file to register a function
    that will be called when WordPress prepares the list of scripts to be loaded on
    the website:'
  id: totrans-102
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在文件末尾插入以下代码行以注册一个函数，该函数将在WordPress准备在网站上加载的脚本列表时被调用：
- en: '[PRE9]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Add the following block of code to provide an implementation for the `ch6_brus_recaptcha_script`
    function:'
  id: totrans-104
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 添加以下代码块以提供`ch6_brus_recaptcha_script`函数的实现：
- en: '[PRE10]'
  id: totrans-105
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Locate the `ch6_brus_book_review_form` function in your code and add an extra
    row to the form table to display the CAPTCHA, replacing `**[my-website-key]**`
    with the website key obtained earlier from the reCAPTCHA service:'
  id: totrans-106
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在您的代码中找到`ch6_brus_book_review_form`函数，并在表单表中添加一行额外的行以显示CAPTCHA，将`**[my-website-key]**`替换为从reCAPTCHA服务中较早获得的网站密钥：
- en: '[PRE11]'
  id: totrans-107
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Save your plugin and visit your book review submission page. You should now
    see the Google reCAPTCHA box appear in the form.
  id: totrans-108
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存您的插件并访问您的书评提交页面。现在你应该在表单中看到Google reCAPTCHA框出现了。
- en: '![](img/f80034a7-19c8-40b0-8541-bf33301c4d63.png)'
  id: totrans-109
  prefs: []
  type: TYPE_IMG
  zh: '![图片](img/f80034a7-19c8-40b0-8541-bf33301c4d63.png)'
- en: Visit the Google reCAPTCHA GitHub page ([https://github.com/google/recaptcha](https://github.com/google/recaptcha))
    and download the latest version of the repository to your computer.
  id: totrans-110
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 访问Google reCAPTCHA GitHub页面([https://github.com/google/recaptcha](https://github.com/google/recaptcha))并将存储库的最新版本下载到您的计算机上。
- en: Extract the repository contents and copy the resulting `src` folder to the `ch6-book-review-user-submission`
    directory.
  id: totrans-111
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 提取存储库内容并将生成的`src`文件夹复制到`ch6-book-review-user-submission`目录。
- en: Rename the `src` folder to `recaptcha`.
  id: totrans-112
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将`src`文件夹重命名为`recaptcha`。
- en: 'Locate the `ch6_brus_process_user_book_reviews` function in your code and add
    the following lines of code at the top of the function implementation, replacing
    `[my-secret-key]` with the secret key obtained earlier from the reCAPTCHA service:'
  id: totrans-113
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在您的代码中找到`ch6_brus_process_user_book_reviews`函数，并在函数实现的顶部添加以下代码行，将`[my-secret-key]`替换为从reCAPTCHA服务中较早获得的密钥：
- en: '[PRE12]'
  id: totrans-114
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Add an extra closing bracket (`}`) just before the end of the `ch6_brus_process_user_book_reviews`
    function to close out the `else` section of the code inserted in the previous
    step.
  id: totrans-115
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在`ch6_brus_process_user_book_reviews`函数的末尾之前添加一个额外的闭合括号（`}`），以关闭上一步插入的代码的`else`部分。
- en: Save and close the code file.
  id: totrans-116
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存并关闭代码文件。
- en: Submit a new book review without checking the reCAPTCHA checkbox to see that
    it will not be accepted by the processing function.
  id: totrans-117
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 提交一个新的书评而不检查reCAPTCHA复选框，以查看它将不会被处理函数接受。
- en: How it works...
  id: totrans-118
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: Google's reCAPTCHA service is a free service that can generate and display a
    CAPTCHA box in your form. It has evolved over time from asking users to decipher
    a scrambled message in an image to displaying addresses and other street signs
    and asking users to enter what they saw. In its latest incarnation, reCAPTCHA
    simply asks the user to check a box to indicate that they are not a robot and
    only asks more advanced questions if it suspects the visitor from being an automated
    system. When visitors check the box, a hidden field is populated with a validation
    code that gets sent to our data processing function along with the rest of the
    form data.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: Google的reCAPTCHA服务是一项免费服务，可以在您的表单中生成和显示CAPTCHA框。随着时间的推移，它已经从要求用户在图像中解读乱码信息发展到显示地址和其他街道标志，并要求用户输入他们所看到的。在其最新版本中，reCAPTCHA仅要求用户勾选一个框以表明他们不是机器人，并且只有在怀疑访客是自动化系统时才会提出更高级的问题。当访客勾选框时，一个隐藏字段会被填充一个验证码，该验证码会与表单数据的其余部分一起发送到我们的数据处理函数。
- en: Adding a reCAPTCHA to our form is actually quite easy, only requiring us to
    load a Javascript script and add a line of code to our form that gets transformed
    into the service's trademark checkbox. Once the form data is posted, validating
    it is a bit more complex than the nonces we have used before since our plugin
    needs to communicate with Google's servers to check the validation code. Thankfully,
    Google offers an easy-to-use library to hide away much of this operation's complexity.
    If the reCAPTCHA code received is valid, the previously created data processing
    and storage code is executed as before. Otherwise, an error message is displayed
    to users. In addition to being easy to integrate, a benefit of using a third-party
    service is that most code updates are done by the service provider. You would
    still need to check for occasional updates to the PHP validation library, but
    that is only a small part of this service's functionality.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 将 reCAPTCHA 添加到我们的表单实际上非常简单，只需要我们加载一个 JavaScript 脚本并在我们的表单中添加一行代码，该代码会被转换成服务的商标复选框。一旦表单数据提交，验证它比我们之前使用的非ces更复杂，因为我们的插件需要与
    Google 的服务器通信以检查验证码。幸运的是，Google 提供了一个易于使用的库来隐藏许多操作复杂性。如果收到的 reCAPTCHA 代码有效，之前创建的数据处理和存储代码将按之前的方式执行。否则，将向用户显示错误消息。除了易于集成之外，使用第三方服务的另一个好处是大多数代码更新都是由服务提供商完成的。你仍然需要检查
    PHP 验证库的偶尔更新，但这只是该服务功能的一小部分。
- en: If you are planning to distribute a plugin that makes use of the reCAPTCHA service
    for more than one person or customer, it would not make sense to leave your own
    website and secret keys in the final plugin code, as we have done here. Instead,
    you should create an administration panel, as you learned to do in [Chapter 3](0346c3c6-27ee-45fb-bfd6-df398e04b2b4.xhtml)*,
    User Settings and Administration Pages*, so that users can enter their own keys
    and have them be used on the website.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你计划分发一个用于多人或客户的 reCAPTCHA 服务的插件，那么在最终的插件代码中留下你自己的网站和密钥是没有意义的，就像我们在这里所做的那样。相反，你应该创建一个管理面板，就像你在[第
    3 章](0346c3c6-27ee-45fb-bfd6-df398e04b2b4.xhtml)*用户设置和管理页面*中学到的那样，以便用户可以输入他们自己的密钥，并在网站上使用它们。
- en: It should be noted that while Google reCAPTCHA is one of the most popular CAPTCHA-generation
    services, it does not work for Chinese visitors at the time of writing and has
    not worked there for some time. If you are developing a plugin for a wide audience,
    you might want to consider supporting more than one CAPTCHA service or library
    to make sure that users have options, no matter where they or their audience resides.
    Read the next recipe for an example of using a local library to generate a CAPTCHA.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 应该注意的是，虽然 Google reCAPTCHA 是最受欢迎的 CAPTCHA 生成服务之一，但在撰写本文时，它对中国访客不起作用，并且已经有一段时间没有工作了。如果你正在为广泛的受众开发插件，你可能需要考虑支持多个
    CAPTCHA 服务或库，以确保用户无论身在何处都有选择。阅读下一个配方，了解使用本地库生成 CAPTCHA 的示例。
- en: See also
  id: totrans-123
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 参见
- en: The *Sending email notifications upon new submissions* recipe
  id: totrans-124
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*在新提交时发送电子邮件通知* 的配方'
- en: The *Creating an administration page menu item in the Settings menu* recipe
  id: totrans-125
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*在设置菜单中创建管理页面菜单项* 的配方'
- en: The *Rendering the admin page contents using HTML* recipe
  id: totrans-126
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*使用 HTML 渲染管理页面内容* 的配方'
- en: The *Processing and storing plugin configuration data* recipe
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*处理和存储插件配置数据* 的配方'
- en: The *Displaying a confirmation message when options are saved* recipe
  id: totrans-128
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*在保存选项时显示确认消息* 的配方'
- en: Using a local library to implement a CAPTCHA on user forms
  id: totrans-129
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在用户表单上使用本地库实现 CAPTCHA
- en: As discussed in the previous recipe, *Implementing a CAPTCHA on user forms using
    an online service*, adding a CAPTCHA to visitor-facing forms helps reduce unwanted
    submissions to a website. After seeing how to integrate an online third-party
    service, this recipe shows how to download and integrate a local PHP script to
    generate and validate CAPTCHA images locally.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 如前一个配方中所述，*使用在线服务在用户表单上实现 CAPTCHA*，向面向访客的表单添加 CAPTCHA 有助于减少对网站的恶意提交。在了解了如何集成在线第三方服务后，这个配方展示了如何下载并集成一个本地
    PHP 脚本来本地生成和验证 CAPTCHA 图像。
- en: Getting ready
  id: totrans-131
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: You should be running the final version of the Book Reviews plugin created in
    [Chapter 4](6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml), *The Power of Custom
    Post Types*, and should have already followed the *Sending email notifications
    upon new submissions* recipe. Alternatively, you can get the resulting files from
    the code bundle (`Chapter 4/ch4-book-reviews/ch4-book-reviews-v11.php` and `Chapter
    6/ch6-book-review-user-submission/ch6-book-review-user-submission-v3.php`) and
    rename `ch6-book-review-user-submission-v3.php` to `ch6-book-review-user-submission.php`
    before starting the recipe.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该运行在[第4章](6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml)中创建的最终版本的“图书评论”插件，即《自定义文章类型的威力》，并且应该已经遵循了“在新提交时发送电子邮件通知”的步骤。或者，你也可以从代码包中获取结果文件（`Chapter
    4/ch4-book-reviews/ch4-book-reviews-v11.php` 和 `Chapter 6/ch6-book-review-user-submission/ch6-book-review-user-submission-v3.php`），在开始步骤之前将
    `ch6-book-review-user-submission-v3.php` 重命名为 `ch6-book-review-user-submission.php`。
- en: The GD and FreeType libraries need to be installed and activated in your development
    web server's PHP installation to be able to generate a CAPTCHA image. Most of
    the pre-packaged local web servers listed in the *Installing a web server on your
    computer* recipe from [Chapter 1](bd54bb42-2b11-4ac9-ac09-5e6e66f285b6.xhtml),
    *Preparing a Local Development Environment*, come with these libraries activated.
    They are also commonly enabled on most hosted web servers, but you should still
    mention that they are required when distributing a plugin containing the following
    code to a larger audience.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 为了能够生成 CAPTCHA 图像，需要在你的开发网络服务器的 PHP 安装中安装并激活 GD 和 FreeType 库。大多数在[第1章](bd54bb42-2b11-4ac9-ac09-5e6e66f285b6.xhtml)《准备本地开发环境》中提到的预包装本地网络服务器都带有这些库的激活。它们也通常在大多数托管网络服务器上启用，但在分发包含以下代码的插件给更广泛的受众时，还应提及这些库是必需的。
- en: How to do it...
  id: totrans-134
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: Visit the Securimage website ([https://www.phpcaptcha.org/download/](https://www.phpcaptcha.org/download/))
    to download the latest version of their CAPTCHA library.
  id: totrans-135
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 访问 Securimage 网站 ([https://www.phpcaptcha.org/download/](https://www.phpcaptcha.org/download/))
    下载他们 CAPTCHA 库的最新版本。
- en: Open the resulting archive and extract the entire `securimage` directory to
    the `ch6-book-review-user-submission` folder of your plugin directory.
  id: totrans-136
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开生成的存档，并将整个 `securimage` 目录提取到你的插件目录的 `ch6-book-review-user-submission` 文件夹中。
- en: In the plugin directory, open the file named `ch6-book-review-user-submission.php`
    in a code editor.
  id: totrans-137
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在插件目录中，使用代码编辑器打开名为 `ch6-book-review-user-submission.php` 的文件。
- en: 'Locate the `ch6_brus_book_review_form` function in your code and add an extra
    row to the form table to display the CAPTCHA:'
  id: totrans-138
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在你的代码中定位到 `ch6_brus_book_review_form` 函数，并在表单中添加一行以显示 CAPTCHA：
- en: '[PRE13]'
  id: totrans-139
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Save your plugin and visit your book review submission page. You should now
    see the CAPTCHA image appear in the form:'
  id: totrans-140
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存你的插件并访问你的图书评论提交页面。你现在应该会在表单中看到 CAPTCHA 图像：
- en: '![](img/c99e4d48-24ca-4c3c-bba8-a5a55ae6636d.png)'
  id: totrans-141
  prefs: []
  type: TYPE_IMG
  zh: '![](img/c99e4d48-24ca-4c3c-bba8-a5a55ae6636d.png)'
- en: 'Locate the `ch6_brus_process_user_book_reviews` function in your code and add
    the following lines of code at the top of the function implementation:'
  id: totrans-142
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在你的代码中定位到 `ch6_brus_process_user_book_reviews` 函数，并在函数实现的顶部添加以下代码行：
- en: '[PRE14]'
  id: totrans-143
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Add an extra closing bracket (`}`) just before the end of the `ch6_brus_process_user_book_reviews`
    function to close out the `else` section of the code inserted in the previous
    step.
  id: totrans-144
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 `ch6_brus_process_user_book_reviews` 函数的末尾之前添加一个额外的闭合括号（`}`），以关闭之前步骤中插入的代码的
    `else` 部分。
- en: Save and close the code file.
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存并关闭代码文件。
- en: Submit a new book review without entering the CAPTCHA code to see that it will
    not be accepted by the processing function.
  id: totrans-146
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 提交一个新的图书评论而不输入 CAPTCHA 代码，以查看它将不会被处理函数接受。
- en: How it works...
  id: totrans-147
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 工作原理...
- en: The `Securimage` script is a simple tool that can generate and display a CAPTCHA
    image, as well as store the string that it generated using session data.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: '`Securimage` 脚本是一个简单的工具，可以生成和显示 CAPTCHA 图像，以及使用会话数据存储它生成的字符串。'
- en: The recipe's code displays the CAPTCHA image by using a standard HTML `img`
    tag that uses one of the scripts in the `securimage` directory as the image path.
    On the data processing side, our code first starts by calling `session_start`
    to reconnect to the session that was initiated by the image generator to store
    the CAPTCHA code. It then proceeds to check whether the user CAPTCHA text matches
    the image that was displayed using the `check` method of the `securimage` class.
    Based on this result, we display an error message or continue verifying that the
    rest of the required data fields have been submitted correctly.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 该配方的代码通过使用标准 HTML `img` 标签来显示 CAPTCHA 图像，该标签使用 `securimage` 目录中的某个脚本作为图像路径。在数据处理方面，我们的代码首先通过调用
    `session_start` 来重新连接到由图像生成器启动的会话，以存储 CAPTCHA 代码。然后，它继续检查用户输入的 CAPTCHA 文本是否与显示的图像匹配，这是通过
    `securimage` 类的 `check` 方法实现的。根据这个结果，我们显示错误消息或继续验证其他所需数据字段是否已正确提交。
- en: While there are many PHP scripts available to generate CAPTCHA images, this
    particular one was selected for this recipe since it is an open source script
    that uses the BSD license, which is compatible with WordPress licensing. This
    means that you would be able to distribute this script with your plugin on the
    official WordPress plugin repository.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然有许多 PHP 脚本可用于生成 CAPTCHA 图像，但这个特定的配方选择了它，因为它是一个开源脚本，使用的是 BSD 许可证，这与 WordPress
    许可证兼容。这意味着你将能够将此脚本与你的插件一起在官方 WordPress 插件仓库中分发。
- en: When using a third-party library in your plugin, you should regularly check
    whether that library has been updated by its author and incorporate new versions
    in your work as soon as possible to make sure that you don't expose your plugin
    to security vulnerabilities.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 当你在插件中使用第三方库时，你应该定期检查该库是否已被其作者更新，并尽快将新版本纳入你的工作中，以确保你的插件不会暴露于安全漏洞。
- en: For more advanced content filtering methods, look up the Akismet API ([https://akismet.com/development/api/](https://akismet.com/development/api/)).
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 对于更高级的内容过滤方法，请查阅 Akismet API ([https://akismet.com/development/api/](https://akismet.com/development/api/))。
- en: See also
  id: totrans-153
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 参见
- en: The *Implementing a CAPTCHA on user forms using an online service* recipe
  id: totrans-154
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*使用在线服务在用户表单上实现 CAPTCHA 的配方*'
