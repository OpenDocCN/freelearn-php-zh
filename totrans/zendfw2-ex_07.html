<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Search Using Lucene"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Search Using Lucene</h1></div></div></div><p>
<span class="emphasis"><em>More often than not, we will come across web applications that need support for built-in search capabilities. Sometimes the search could involve searching a simple field in a MySQL table, or at times you may want to search a document or a plain text file; there <a id="id667" class="indexterm"/>are multiple ways to address the search requirements using various search libraries. Lucene is one such library that offers excellent search capabilities for implementing full text search.</em></span>
</p><p>In this chapter we will be using Zend Framework's Lucene search implementation. Zend Framework 1.0 had a built-in <code class="literal">Zend_Search_Lucene</code> library which supported indexing and searching with Lucene; in ZF 2.0, this library is available as <code class="literal">ZendSearch\Lucene</code>, which can be downloaded and installed on your web application. In this chapter, we will be learning the fundamentals of implementing a full-text search using the Lucene search library in the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Installing the <code class="literal">ZendSearch</code> library in your application</li><li class="listitem" style="list-style-type: disc">Creating data index for simple MySQL data</li><li class="listitem" style="list-style-type: disc">Querying the Lucene index</li><li class="listitem" style="list-style-type: disc">Adding new documents files to the index</li></ul></div><div class="section" title="Introduction to Lucene"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec65"/>Introduction to Lucene</h1></div></div></div><p>Lucene <a id="id668" class="indexterm"/>is a high-performance, scalable information retrieval (search) library developed by Apache Foundation, which can be used for implementing free-text search in web applications. Lucene provides a simple-to-use API, which will provide powerful indexing and searching capability to your web application. To read more about Lucene visit <a class="ulink" href="http://lucene.apache.org/">http://lucene.apache.org/</a>.</p><p>The most<a id="id669" class="indexterm"/> important components of the Lucene search library are explained as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Index</strong></span>: Lucene<a id="id670" class="indexterm"/> index is the data store that holds all the indexed <a id="id671" class="indexterm"/>documents; queries are executed against the index to fetch the documents.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Document</strong></span>: A document <a id="id672" class="indexterm"/>is the default building block for<a id="id673" class="indexterm"/> a Lucene index; documents can be compared to records in a table. Each document holds a number of fields upon which queries can be executed.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Field</strong></span>: Each<a id="id674" class="indexterm"/> Lucene document comprises of one or more fields;<a id="id675" class="indexterm"/> it is not necessary that all the fields are indexed, fields can also be stored without indexing.</li></ul></div><p>The Lucene<a id="id676" class="indexterm"/> search works based on the index, so it is necessary to have the index updated with the latest content to get the best search results. The following diagram explains the overview of the Lucene search:</p><div class="mediaobject"><img src="graphics/1929OS_07_01.jpg" alt="Introduction to Lucene"/></div></div></div>
<div class="section" title="Time for action &#x2013; installing ZendSearch\Lucene"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec66"/>Time for action – installing ZendSearch\Lucene</h1></div></div></div><p>Perform <a id="id677" class="indexterm"/>the<a id="id678" class="indexterm"/> following steps for installing <code class="literal">ZendSearch\Lucene</code>:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><code class="literal">ZendSearch\Lucene</code><a id="id679" class="indexterm"/> was not available as a composer package at the time of writing this book. So, we will check out the source from the GitHub repository. The repository is available at <a class="ulink" href="https://github.com/zendframework/ZendSearch">https://github.com/zendframework/ZendSearch</a>.</li><li class="listitem">Next we need to navigate to the <code class="literal">vendor</code> folder:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd /var/www/CommunicationApp/</strong></span>
<span class="strong"><strong>vendor/</strong></span>
</pre></div></li><li class="listitem">Clone the Zend search repository into the <code class="literal">vendor</code> folder:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ git clone https://github.com/zendframework/ZendSearch.git ZendSearch</strong></span>
</pre></div></li><li class="listitem">Next we should configure the ZendSearch library using composer:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd ZendSearch/</strong></span>
<span class="strong"><strong>$ curl -s https://getcomposer.org/installer | php</strong></span>
<span class="strong"><strong>$ php composer.phar install</strong></span>
</pre></div></li><li class="listitem">Once<a id="id680" class="indexterm"/> the library is configured,<a id="id681" class="indexterm"/> we will need to define a module-level configuration to store the index location. To do this, we need to modify <code class="literal">CommunicationApp/module/Users/config/module.config.php</code>, and add a new configuration for <code class="literal">search_index</code>:<div class="informalexample"><pre class="programlisting">   // MODULE CONFIGURATIONS
   'module_config' =&gt; array(
      'upload_location'        =&gt; __DIR__ . '/../data/uploads',
      'image_upload_location'  =&gt; __DIR__ . '/../data/images',
<span class="strong"><strong>      'search_index'         =&gt; __DIR__ . '/../data/search_index'</strong></span>
   ),</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec68"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We have now downloaded and configured the <code class="literal">ZendSearch</code> library for Zend Framework 2.0; the previous tutorial also provides us with a guideline for downloading and installing packages which cannot be downloaded directly from Composer.</p><p>Now that we have the <code class="literal">ZendSearch\Lucene</code> search library installed, our next task will be to create a Lucene index for some of the data that is already stored in our communication application.</p></div></div>
<div class="section" title="Indexing"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec67"/>Indexing</h1></div></div></div><p>Indexing<a id="id682" class="indexterm"/> is a fairly straightforward process using <code class="literal">ZendSearch\Lucene</code><a id="id683" class="indexterm"/>. All we need is to create<a id="id684" class="indexterm"/> documents with fields and values, and keep adding the document to the index. You can also remove documents, update documents, and clear an index. The following classes are used in index generation:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Field</code> – The <code class="literal">ZendSearch\Lucene\Document\Field</code> class allows users to define a<a id="id685" class="indexterm"/> new document field; this field can be classified <a id="id686" class="indexterm"/>into one the following types:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Field::keyword($name, $value, $encoding = 'UTF-8')</code>: the <code class="literal">keyword</code> field type is used to identify string fields that don't have to be tokenized, yet need to be indexed and stored. For example, date and URL.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Field::unIndexed($name, $value, $encoding = 'UTF-8')</code>: The <code class="literal">unIndexed</code> field type is used to store fields in the index without having to index/tokenize them. For example, ID fields.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Field::binary($name, $value)</code>: The <code class="literal">binary</code> field type is used for storing binary values in the index.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Field::text($name, $value, $encoding = 'UTF-8')</code>: The <code class="literal">text</code> field type is the most common field type used for describing short strings which are tokenized and stored in the index.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Field::unStored($name, $value, $encoding = 'UTF-8')</code>: The <code class="literal">unStored</code> field type is used to identify fields that will be tokenized and indexed, but not stored in the index.</li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">Document</code> – The <code class="literal">ZendSearch\Lucene\Document</code> class allows definition of a new index<a id="id687" class="indexterm"/> document. Some of the most commonly<a id="id688" class="indexterm"/>-used methods in this class are described as follows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">addField(Document\Field $field)</code>: Adds a new field to the document</li><li class="listitem" style="list-style-type: disc"><code class="literal">getFieldNames()</code>: Used to retrieve all field names from the document</li><li class="listitem" style="list-style-type: disc"><code class="literal">getField($fieldName)</code>: Used <a id="id689" class="indexterm"/>to retrieve a specific field from the<a id="id690" class="indexterm"/> document</li><li class="listitem" style="list-style-type: disc"><code class="literal">getFieldValue($fieldName)</code>: Used to retrieve a specific field value from the document</li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">Index</code> – <code class="literal">Index</code> can be retrieved using the <code class="literal">create()</code> and <code class="literal">open()</code> methods in the <code class="literal">ZendSearch\Lucene</code> class. Both the methods take the index path as the parameter<a id="id691" class="indexterm"/> and return an index of type <code class="literal">ZendSearch\Lucene\SearchIndexInterface</code>. The <code class="literal">SearchIndexInterface</code> <a id="id692" class="indexterm"/>provides the following methods for manipulating the documents inside the index:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">addDocument(Document $document)</code>: Adds<a id="id693" class="indexterm"/> a new document to the <a id="id694" class="indexterm"/>index</li><li class="listitem" style="list-style-type: disc"><code class="literal">delete($id)</code>: Deletes the indexed document based on the internal <a id="id695" class="indexterm"/>document<a id="id696" class="indexterm"/> ID</li><li class="listitem" style="list-style-type: disc"><code class="literal">optimize()</code>: Helps<a id="id697" class="indexterm"/> in optimizing <a id="id698" class="indexterm"/>the index, by merging all segments into a single segment, thereby increasing the performance</li><li class="listitem" style="list-style-type: disc"><code class="literal">commit()</code>: Used <a id="id699" class="indexterm"/>to commit<a id="id700" class="indexterm"/> transactions to the search index</li></ul></div></li></ul></div><p>Now that we have learned about the methods that are used for index generation, let's get started and generate the index for the <code class="literal">uploads</code> table that is available in our communication application.</p></div>
<div class="section" title="Time for action &#x2013; generating a Lucene index"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec68"/>Time for action – generating a Lucene index</h1></div></div></div><p>Perform<a id="id701" class="indexterm"/> the following steps for generating a Lucene<a id="id702" class="indexterm"/> index:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new search controller, <code class="literal">CommunicationApp/module/Users/src/Users/Controller/SearchController.php</code>, which will be used for searching and generating indexes.</li><li class="listitem">Add references to <code class="literal">ZendSearch\Lucene</code>:<div class="informalexample"><pre class="programlisting">use ZendSearch\Lucene;
use ZendSearch\Lucene\Document;
use ZendSearch\Lucene\Index;</pre></div></li><li class="listitem">Add a<a id="id703" class="indexterm"/> method to fetch the index location<a id="id704" class="indexterm"/> from the module configuration:<div class="informalexample"><pre class="programlisting">public function getIndexLocation()
{
  // Fetch Configuration from Module Config
  $config  = $this-&gt;getServiceLocator()-&gt;get('config');
  if ($config instanceof Traversable) {
    $config = ArrayUtils::iteratorToArray($config);
  }
  if (!empty($config['module_config']['search_index'])) {
    return $config['module_config']['search_index'];
  } else {
    return FALSE;
  }
}</pre></div></li><li class="listitem">The index document needs to be generated in the following format:<div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Index field</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">upload_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id705" class="indexterm"/> is non-indexed field which<a id="id706" class="indexterm"/> will be used for retrieving the uploaded file that gets returned in the search results</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">label</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id707" class="indexterm"/> field is used to index the <code class="literal">label</code> field <a id="id708" class="indexterm"/>of the <code class="literal">uploads</code> table</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">owner</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id709" class="indexterm"/> field is used to index the <code class="literal">name</code> field <a id="id710" class="indexterm"/>of the user who uploaded the document</p>
</td></tr></tbody></table></div></li><li class="listitem">Create a new action to generate the index:<div class="informalexample"><pre class="programlisting">public function generateIndexAction()
{
  $searchIndexLocation = $this-&gt;getIndexLocation();
  $index = Lucene\Lucene::create($searchIndexLocation);

  $userTable = $this-&gt;getServiceLocator()-&gt;get('UserTable');
  $uploadTable = $this-&gt;getServiceLocator()-&gt;get('UploadTable');
  $allUploads = $uploadTable-&gt;fetchAll();  
  foreach($allUploads as $fileUpload) {
    //
    $uploadOwner = $userTable-&gt;getUser($fileUpload-&gt;user_id);

    // create lucene fields
    $fileUploadId = Document\Field::unIndexed(
                          'upload_id', $fileUpload-&gt;id);
    $label = Document\Field::Text(
                          'label', $fileUpload-&gt;label);
    $owner = Document\Field::Text(
                          'owner', $uploadOwner-&gt;name);

    // create a new document and add all fields
    $indexDoc = new Lucene\Document();
    $indexDoc-&gt;addField($label);
    $indexDoc-&gt;addField($owner);
    $indexDoc-&gt;addField($fileUploadId);
    $index-&gt;addDocument($indexDoc);
  }
  $index-&gt;commit();
}</pre></div></li><li class="listitem">Now<a id="id711" class="indexterm"/> open the action URL (<code class="literal">http://comm-app.local/users/search/generateIndex</code>) in your web<a id="id712" class="indexterm"/> browser, and if everything works as expected, you will see that the index files that created in the <code class="literal">search_index</code> folder.<p>The following screenshot shows the browser response upon a successful index update:</p><div class="mediaobject"><img src="graphics/1929OS_07_09.jpg" alt="Time for action – generating a Lucene index"/></div></li></ol></div><p>You<a id="id713" class="indexterm"/> can see in the following screenshot that the index<a id="id714" class="indexterm"/> files are generated and stored in the <code class="literal">search_index</code> folder:</p><div class="mediaobject"><img src="graphics/1929OS_07_02.jpg" alt="Time for action – generating a Lucene index"/></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec69"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>Now we have created a method to index the data stored in the <code class="literal">MySQL</code> table to the Lucene data <a id="id715" class="indexterm"/>store; our next step will be to have some queries<a id="id716" class="indexterm"/> executed against the Lucene index and to fetch and show the results.</p></div></div>
<div class="section" title="Searching"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec69"/>Searching</h1></div></div></div><p>Searching<a id="id717" class="indexterm"/> the index is relatively simple<a id="id718" class="indexterm"/> using <code class="literal">ZendSearch\Lucene</code>. The index needs to be opened for querying and the query string needs to be passed to the <code class="literal">find()</code> method<a id="id719" class="indexterm"/> in <code class="literal">ZendSearch\Lucene\Index</code>. The <code class="literal">find</code> methods return an array matching the hits for the specific query, and this in turn can be used to render the search results.</p><p>There are two options for querying the index—you can pass the plain text query string to the find function or you can build your own <code class="literal">Query</code> object using <code class="literal">ZendSearch\Lucene\Search\Query</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip30"/>Tip</h3><p>To read more about various query options in ZendSearch\Lucene, check the following developer documentation:</p><p>
<a class="ulink" href="https://zf2.readthedocs.org/en/release-2.2.0/modules/zendsearch.lucene.queries.html ">https://zf2.readthedocs.org/en/release-2.2.0/modules/zendsearch.lucene.queries.html </a>
</p></div></div><p>In the following example, we will be using plain text queries, and you can manipulate the search results by using operators such as <code class="literal">:</code>,<code class="literal">+</code>,<code class="literal">-</code>, and field searches. For example, see the following list:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A search for all documents uploaded by Anne could be retrieved by the following query:<div class="informalexample"><pre class="programlisting">owner:Anne</pre></div></li><li class="listitem" style="list-style-type: disc">A search for all documents having the word <code class="literal">report</code> and uploaded by the user named <code class="literal">Anne</code> could be retrieved by the following query:<div class="informalexample"><pre class="programlisting">report AND owner:Anne</pre></div></li><li class="listitem" style="list-style-type: disc">A search<a id="id720" class="indexterm"/> for all documents<a id="id721" class="indexterm"/> having the word <code class="literal">report</code> and excluding the ones uploaded by <code class="literal">Anne</code> could be retrieved by the following query:<div class="informalexample"><pre class="programlisting">report -owner:Anne</pre></div></li></ul></div></div>
<div class="section" title="Time for action &#x2013; displaying search results"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec70"/>Time for action – displaying search results</h1></div></div></div><p>Perform the following steps for displaying search results:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">For displaying<a id="id722" class="indexterm"/> the search results, we will need to create a new form which will display the search textbox and render the search results right below the search form. The form will be placed in <code class="literal">SearchController</code> under <code class="literal">CommunicationApp/module/Users/src/Users/Controller/SearchController.php</code>.</li><li class="listitem">Create a new view which will be used for displaying the query window and also rendering search results. This will be placed under <code class="literal">CommunicationApp/module/Users/view/users/search/index.phtml</code>.<div class="informalexample"><pre class="programlisting">&lt;h3&gt;Document Search&lt;/h3&gt;
&lt;?php 
// Search Form
echo $this-&gt;form()-&gt;openTag($form);
foreach ($form as $element) {
    echo $this-&gt;formElement($element);       
    echo $this-&gt;formElementErrors($element);
}
echo $this-&gt;form()-&gt;closeTag();

// Search Results
if (count($searchResults)) {
?&gt;
&lt;h5&gt;Results&lt;/h5&gt;
&lt;table  style="width: 600px; border:1px solid #f5f5f5;"&gt;
  &lt;tr&gt;
    &lt;th width="30%" align="left"&gt; Label&lt;/th&gt;
    &lt;th width="30%" align="left"&gt; Owner&lt;/th&gt;
    &lt;th align="left"&gt; File&lt;/th&gt;
  &lt;/tr&gt;
  &lt;?php   foreach ($searchResults as $searchResult) {
  ?&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;?php echo $searchResult-&gt;label; ?&gt;&lt;/td&gt;
    &lt;td&gt;&lt;?php echo $searchResult-&gt;owner; ?&gt;&lt;/td&gt;
    &lt;td&gt;&lt;a href="&lt;?php echo $this-&gt;escapeHtml($this-&gt;url('users/upload-manager',
            array('action'=&gt;'fileDownload', 'id' =&gt; $searchResult-&gt;upload_id)));?&gt;"&gt;Download&lt;/a&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;?php 
  }
  ?&gt;
&lt;/table&gt;
&lt;?php }?&gt;</pre></div></li><li class="listitem">Now <a id="id723" class="indexterm"/>create a new action<a id="id724" class="indexterm"/> which will display<a id="id725" class="indexterm"/> the <code class="literal">Search</code> form and also query the Lucene index with the input provided in the <code class="literal">Search</code> form. This will be placed in <code class="literal">SearchController</code> under <code class="literal">CommunicationApp/module/Users/src/Users/Controller/SearchController.php</code>.<div class="informalexample"><pre class="programlisting">public function indexAction()
{
  $request = $this-&gt;getRequest();
  if ($request-&gt;isPost()) {
<span class="strong"><strong>    $queryText = $request-&gt;getPost()-&gt;get('query');</strong></span>
<span class="strong"><strong>    $searchIndexLocation = $this-&gt;getIndexLocation();</strong></span>
<span class="strong"><strong>    $index = Lucene\Lucene::open($searchIndexLocation);</strong></span>
<span class="strong"><strong>    $searchResults = $index-&gt;find($queryText);</strong></span>
  }

  // prepare search form
  $form  = new \Zend\Form\Form();
  $form-&gt;add(array(
    'name' =&gt; 'query',
    'attributes' =&gt; array(
      'type'  =&gt; 'text',
      'id' =&gt; 'queryText',
      'required' =&gt; 'required'
    ),
    'options' =&gt; array(
      'label' =&gt; 'Search String',
    ),
  ));
  $form-&gt;add(array(
          'name' =&gt; 'submit',
          'attributes' =&gt; array(
              'type'  =&gt; 'submit',
              'value' =&gt; 'Search'
          ),
  ));

  $viewModel  = new ViewModel(array(
      'form' =&gt; $form, 
<span class="strong"><strong>      'searchResults' =&gt; $searchResults</strong></span>
    )    
  );
  return $viewModel;
}</pre></div></li><li class="listitem">Test <a id="id726" class="indexterm"/>the page in your browser; <a id="id727" class="indexterm"/>you should be able to <a id="id728" class="indexterm"/>see search results for keywords that are<a id="id729" class="indexterm"/> available in the <code class="literal">label</code><a id="id730" class="indexterm"/> and <code class="literal">owner</code> fields:<div class="mediaobject"><img src="graphics/1929OS_07_03.jpg" alt="Time for action – displaying search results"/></div></li></ol></div><p>On searching using <code class="literal">Owner Name</code>, you will get the following search results:</p><div class="mediaobject"><img src="graphics/1929OS_07_04.jpg" alt="Time for action – displaying search results"/></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec70"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We<a id="id731" class="indexterm"/> have now implemented the search<a id="id732" class="indexterm"/> results page, which allows us to<a id="id733" class="indexterm"/> query for uploaded documents using their labels and owners. The retrieved search results are displayed in a customized view which allows us to download the document from the search result.</p><p>Our<a id="id734" class="indexterm"/> next step will be to expand the search <a id="id735" class="indexterm"/>to search the contents of the <a id="id736" class="indexterm"/>uploaded documents; for this we will need to make changes to the way we generate the index.</p></div></div>
<div class="section" title="Indexing Microsoft Office documents"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec71"/>Indexing Microsoft Office documents</h1></div></div></div><p>As we<a id="id737" class="indexterm"/> have seen in the previous example, it is usually insufficient to index the documents' meta information. Most of the time the query string is only present in the document's content. In order to achieve that, we need to parse the document and index the content; <code class="literal">ZendSearch\Lucene</code> provides support indexing the contents of the following document types:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For HTML documents the following are the index document creation methods:<div class="informalexample"><pre class="programlisting">ZendSearch\Lucene\Document\Html::loadHTMLFile($filename)
ZendSearch\Lucene\Document\Html::loadHTML($htmlString)</pre></div></li><li class="listitem" style="list-style-type: disc">For Word 2007 documents the following is the index document creation method:<div class="informalexample"><pre class="programlisting">ZendSearch\Lucene\Document\Docx::loadDocxFile($filename)</pre></div></li><li class="listitem" style="list-style-type: disc">For Powerpoint 2007 documents the following is the index document creation method:<div class="informalexample"><pre class="programlisting">ZendSearch\Lucene\Document\Pptx::loadPptxFile($filename)</pre></div></li><li class="listitem" style="list-style-type: disc">For Excel 2007 documents the following is the index document creation method:<div class="informalexample"><pre class="programlisting">ZendSearch\Lucene\Document\Xlsx::loadXlsxFile($filename)</pre></div></li></ul></div><p>All these methods return a document of type <code class="literal">ZendSearch\Lucene\Document</code>, which can be improvised further by adding more index fields to it.</p><p>So let's get started by indexing the documents that are available in the <code class="literal">uploads</code> section.</p></div>
<div class="section" title="Time for action &#x2013; indexing document files"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec72"/>Time for action – indexing document files</h1></div></div></div><p>Perform the<a id="id738" class="indexterm"/> following steps for<a id="id739" class="indexterm"/> indexing document files:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To index office documents, add a new <code class="literal">uploads</code> section for sample Word and Excel documents. In this case, we will upload a Word document and an Excel spreadsheet as follows:<div class="mediaobject"><img src="graphics/1929OS_07_05.jpg" alt="Time for action – indexing document files"/><div class="caption"><p>Sample Word 2007 document</p></div></div><div class="mediaobject"><img src="graphics/1929OS_07_06.jpg" alt="Time for action – indexing document files"/><div class="caption"><p>Sample Excel 2007 spreadsheet</p></div></div></li><li class="listitem">Add <a id="id740" class="indexterm"/>the following lines to the indexing function present in <code class="literal">SearchController</code>, which<a id="id741" class="indexterm"/> is present in <code class="literal">CommunicationApp/module/Users/src/Users/Controller/SearchController.php</code>, so that the method picks up and indexes Word documents and Excel <a id="id742" class="indexterm"/>spreadsheets separately:<div class="informalexample"><pre class="programlisting">if (substr_compare($fileUpload-&gt;filename, 
        ".xlsx", 
        strlen($fileUpload-&gt;filename) - strlen(".xlsx"), 
        strlen(".xlsx")) === 0) {
  // index excel sheet
  $uploadPath = $this-&gt;getFileUploadLocation();
<span class="strong"><strong>  $indexDoc = Lucene\Document\Xlsx::loadXlsxFile(</strong></span>
<span class="strong"><strong>                    $uploadPath ."/" . $fileUpload-&gt;filename);</strong></span>
} else if (substr_compare($fileUpload-&gt;filename, 
        ".docx", 
        strlen($fileUpload-&gt;filename) - strlen(".docx"), 
        strlen(".docx")) === 0) {
  // index word doc
  $uploadPath= $this-&gt;getFileUploadLocation();
<span class="strong"><strong>  $indexDoc = Lucene\Document\Docx::loadDocxFile(</strong></span>
<span class="strong"><strong>                    $uploadPath ."/" . $fileUpload-&gt;filename);</strong></span>
} else {
  $indexDoc = new Lucene\Document();
}

$indexDoc-&gt;addField($label);
$indexDoc-&gt;addField($owner);
$indexDoc-&gt;addField($fileUploadId);
$index-&gt;addDocument($indexDoc);</pre></div></li><li class="listitem">Now update the index (navigate to <code class="literal">http://comm-app.local/users/search/generateIndex</code>), come back to the <span class="strong"><strong>Document Search</strong></span> page, and try searching for keywords that are present in the document. You should be able to see the search results as shown in the following screenshot:<div class="mediaobject"><img src="graphics/1929OS_07_07.jpg" alt="Time for action – indexing document files"/></div></li></ol></div><p>Search<a id="id743" class="indexterm"/> results for the content inside Office documents<a id="id744" class="indexterm"/> will be as shown <a id="id745" class="indexterm"/>in the following screenshot:</p><div class="mediaobject"><img src="graphics/1929OS_07_08.jpg" alt="Time for action – indexing document files"/></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec71"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>In the last task we saw the implementation of indexing and searching the content of Microsoft <a id="id746" class="indexterm"/>Office documents. As you can see, it is relatively easy to implement these features using <code class="literal">ZendSearch\Lucene</code>.</p></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec72"/>Have a go hero</h2></div></div></div><p>Here<a id="id747" class="indexterm"/> is a simple task for you before you move on to the next chapter. Now that we have implemented indexing and<a id="id748" class="indexterm"/> searching, your task will be to modify the entities so that the index is updated each time changes are made to uploads. If a new upload is made, a document needs to be added to the index, and if an upload is deleted, it should be removed from the index, and so on.</p></div><div class="section" title="Pop quiz – search"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec73"/>Pop quiz – search</h2></div></div></div><p>Q1. Which of the following field types is not tokenized, yet is indexed and stored?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><code class="literal">keyword ()</code></li><li class="listitem"><code class="literal">unStored ()</code></li><li class="listitem"><code class="literal">text()</code></li><li class="listitem"><code class="literal">unIndexed()</code></li></ol></div><p>Q2. Which of the following file formats is not supported for <code class="literal">ZendSearch\Lucene</code> as a valid document format for content indexing?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><code class="literal">.docx</code></li><li class="listitem"><code class="literal">.pdf</code></li><li class="listitem"><code class="literal">.xslx</code></li><li class="listitem"><code class="literal">.html</code></li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec73"/>Summary</h1></div></div></div><p>In this chapter we have learned about implementing a simple search interface using <code class="literal">ZendSearch\Lucene</code>. This would be very useful when implementing search in any web application that you work with. In the next chapter we will be learning about implementing a simple e-commerce store using Zend Framework 2.0.</p></div></body></html>