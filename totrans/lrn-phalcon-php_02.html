<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Setting Up the MVC Structure and the Environment for Our Project"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Setting Up the MVC Structure and the Environment for Our Project</h1></div></div></div><p>In the previous chapter, we summarized the most common parts of Phalcon. Next, we will try to set up the "Hello world" page for our project. In this chapter, we will cover these topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">An introduction to MVC—what is MVC?</li><li class="listitem" style="list-style-type: disc">The MVC structure</li><li class="listitem" style="list-style-type: disc">Creating a configuration file and the Bootstrap</li><li class="listitem" style="list-style-type: disc"> Preparing the initial DI interface and the router</li><li class="listitem" style="list-style-type: disc"> Using the router component in a module</li><li class="listitem" style="list-style-type: disc"> Creating the base layout</li></ul></div><div class="section" title="What is MVC?"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec13"/>What is MVC?</h1></div></div></div><p>I am pretty sure that if<a id="id114" class="indexterm"/> you are reading this book, you are already familiar with the MVC pattern, but for beginners, we will try to explain this in a few words.</p><p>MVC is defined as an architectural pattern, and it stands for Model-View-Controller; it is used mostly in web development, but it is widely applied in software that needs a <a id="id115" class="indexterm"/>
<span class="strong"><strong>Graphical User Interface </strong></span>(<span class="strong"><strong>GUI</strong></span>). To make this introduction quick, let's explain these components:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Model</strong></span>: This is usually<a id="id116" class="indexterm"/> used as an abstraction layer, and validation for the tables of a database, but it can be used to handle any kind of logic within the application.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>View</strong></span>: A view, usually, represents<a id="id117" class="indexterm"/> a template (can be an HTML file) that the controller will render.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Controller</strong></span>: In a web <a id="id118" class="indexterm"/>application, the controller handles all the HTTP requests and sends an appropriate response. This response can mean rendering a template, outputting JSON data, and so on.</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note06"/>Note</h3><p>For the exact <a id="id119" class="indexterm"/>definition, I suggest you check out the Wikipedia page of the MVC pattern at <a class="ulink" href="http://code.tutsplus.com/tutorials/mvc-for-noobs--net-10488">http://code.tutsplus.com/tutorials/mvc-for-noobs--net-10488</a>).</p></div></div><p>Let's take a quick look at an example of <a id="id120" class="indexterm"/>MVC for a news/blog application by assuming that a user will make a request to <code class="literal">http://www.learning-phalcon.localhost/article/list</code>. To match this URL, we will need to implement the routing component, but we are going to cover this in the next chapters.</p><div class="section" title="Model"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec17"/>Model</h2></div></div></div><p>As mentioned earlier, a model<a id="id121" class="indexterm"/> is an abstraction layer for a database table and probably, in 99 percent of cases, you will use it for this purpose. In this example, we will extend the <code class="literal">Phalcon\Mvc\Model</code> component that has some built-in methods, such as the <code class="literal">find</code> method. By default, this method will return all the records found in a table named <code class="literal">article</code>.</p><p>Let's assume that we have the following MySQL table structure:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `article` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `article_short_title` varchar(255) COLLATE utf8_unicode_ci NOT NULL,
  `article_long_title` varchar(255) COLLATE utf8_unicode_ci NOT NULL,
  `article_slug` varchar(255) COLLATE utf8_unicode_ci NOT NULL,
  `article_description` text COLLATE utf8_unicode_ci NOT NULL,
  PRIMARY KEY (`id`),
  KEY `id` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci AUTO_INCREMENT=1;</pre></div><p>For this table, our model would look like this:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace \App\Core\Models\Article;

class Article extends \Phalcon\Mvc\Model
{
  protected $id;
  protected $article_short_title;
  protected $article_long_title;
  protected $article_slug;
  protected $article_description;

  public function getId()
  {
    return $this-&gt;id;
  }

  public function getArticleShortTitle()
  {
    return $this-&gt;article_short_title;
  }

  public function getArticleLongTitle()
  {
    return $this-&gt;article_long_title;
  }

  public function getArticleSlug()
  {
    return $this-&gt;article_slug;
  }

  public function getArticleDescription()
  {
    return $this-&gt;article_description;
  }

  public function setId($id)
  {
    $this-&gt;id = $id;
  }

  public function setArticleShortTitle($article_short_title)
  {
    $this-&gt;article_short_title = $article_short_title;
  }

  public function setArticleLongTitle($article_long_title)
  {
    $this-&gt;article_long_title = $article_long_title;
  }

  public function setArticleSlug($article_slug)
  {
    $this-&gt;article_slug = $article_slug;
  }

  public function setArticleDescription($article_description)
  {
    $this-&gt;article_description = $article_description;
  }
}</pre></div><p>If we need to <a id="id122" class="indexterm"/>overwrite the default find method, we can create one in our model. For example:</p><div class="informalexample"><pre class="programlisting">public static function find($parameters = null)
{
  return parent::find($parameters);
}</pre></div></div><div class="section" title="View"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec18"/>View</h2></div></div></div><p>Let's consider the following PHP/HTML <a id="id123" class="indexterm"/>template as our view:</p><div class="informalexample"><pre class="programlisting">&lt;div class="list"&gt;
  &lt;?php foreach ($articles as $article) {?&gt;
    &lt;article&gt;
      &lt;h1&gt;&lt;?php echo $article-&gt;getArticleShortTitle();?&gt;&lt;/h1&gt;
      &lt;p&gt;&lt;?php echo $article-&gt;getArticleLongTitle() ?&gt;&lt;/p&gt;
      &lt;a href="&lt;?php echo $article-&gt;getArticleSlug(); ?&gt;"&gt;Read more&lt;/a&gt;
    &lt;/article&gt;
  &lt;?php } ?&gt;
&lt;/div&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip08"/>Tip</h3><p><code class="literal">$article</code> is an instance of our model. This is why we can call our getters from it.</p></div></div></div><div class="section" title="Controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec19"/>Controller</h2></div></div></div><p>The controller <a id="id124" class="indexterm"/>will handle requests and will send the information to the appropriate method from a model. In this example, the controller will extend the <code class="literal">\Phalcon\Mvc\Controller</code> component:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Frontend\Controllers;
use \App\Core\Models\Article;

class ArticleController extends \Phalcon\Mvc\Controller
{
  public function listAction()
  {
    $articles = Article::find();
    $this-&gt;view-&gt;setVar('articles', $articles);
  }
}</pre></div><p>As you can see, we <a id="id125" class="indexterm"/>created a public method called <code class="literal">listAction</code> that calls the <code class="literal">find</code> method from the model, and it assigns the results to our <code class="literal">view</code> component. You probably noticed that the namespace of the controller contains the <code class="literal">Frontend</code> word. This is because we will use a multi-module application. (We will discuss this in the latter sections of this chapter.)</p><p>With this, we will close our short introduction to MVC or Phalcon MVC. Next, we will talk about the folder structure of an MVC application.</p></div></div></div>
<div class="section" title="The MVC structure"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec14"/>The MVC structure</h1></div></div></div><p>This subject (like many other subjects) is<a id="id126" class="indexterm"/> quite sensitive. It depends on how much experience you have and how you are used to structure your projects. In a web application, most of the time we have models, views (templates), controllers, and assets (images, JavaScript files, and style sheets). Based on this, I like the following structure, because it's easy to understand where a file resides and what its purpose is.</p><p>For a single module application, we can have the following structure:</p><div class="mediaobject"><img src="graphics/B03522_02_03.jpg" alt="The MVC structure"/></div><p>For a multi-module application, we<a id="id127" class="indexterm"/> can have the following structure:</p><div class="mediaobject"><img src="graphics/B03522_02_04.jpg" alt="The MVC structure"/></div><p>As you can see, it is quite easy to know exactly what a file is used for and where we can find it. In the end, you should choose the structure that fits your needs but keep in mind that if you are going to work in a<a id="id128" class="indexterm"/> team, it should be intuitive enough for any new member.</p></div>
<div class="section" title="Creating the structure for our project"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec15"/>Creating the structure for our project</h1></div></div></div><p>Now, we are going to create the<a id="id129" class="indexterm"/> structure for our project. In the first chapter, we <a id="id130" class="indexterm"/>created the <code class="literal">/var/www/learning-phalcon.localhost</code> folder. If you have another location, go there and create the following directory structure:</p><div class="mediaobject"><img src="graphics/B03522_02_05.jpg" alt="Creating the structure for our project"/></div><p>Next, let's create the <code class="literal">index.php</code> file that will handle our application. This file will be the default file in our web server:</p><div class="informalexample"><pre class="programlisting">&lt;?php

header('Content-Type: text/html; charset=utf-8');
mb_internal_encoding("UTF-8");

require_once __DIR__.'/../modules/Bootstrap.php';

$app = new Bootstrap('frontend');
$app-&gt;init();
?&gt;</pre></div><p>In the first two lines, we set the header and internal encoding to UTF-8. This is a good practice if you are going to use special characters / diacritics. In the fourth line, we include a file named <code class="literal">Bootstrap.php</code>. This file is the Bootstrap of our project, and we will create its content in a few moments. On the next lines, we create a new instance of Bootstrap with a default module (<code class="literal">frontend</code>), and we initialize it.</p><p>We will need to find a <a id="id131" class="indexterm"/>way to autoload any file in our application without <a id="id132" class="indexterm"/>manually including it. We will make use of the <code class="literal">\Phalcon\Loader</code> component that will register all our modules in the namespace. In the <code class="literal">config</code> folder, we will create a new file called <code class="literal">loader.php </code>with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$loader = new \Phalcon\Loader();

$loader-&gt;registerNamespaces(array(
    'App\Core'       =&gt; __DIR__ . '/../modules/Core/',
    'App\Frontend'   =&gt; __DIR__ . '/../modules/Frontend/',
    'App\Api'        =&gt; __DIR__ . '/../modules/Api/',
    'App\Backoffice' =&gt; __DIR__ . '/../modules/Backoffice/',
));

$loader-&gt;register();
?&gt;</pre></div><div class="section" title="PSR"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec20"/>PSR</h2></div></div></div><p>PSR is<a id="id133" class="indexterm"/> a collection of standards used in PHP development, which is supported by a group of people, the <a id="id134" class="indexterm"/>
<span class="strong"><strong>PHP Framework Interop Group</strong></span>. The standards include these:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The autoloading standard</li><li class="listitem" style="list-style-type: disc">The basic coding standard</li><li class="listitem" style="list-style-type: disc">The coding style guide</li><li class="listitem" style="list-style-type: disc">Logger interface</li></ul></div><p>The \<code class="literal">Phalcon\Loader</code> component<a id="id135" class="indexterm"/> is PSR-4 (<a class="ulink" href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-4-autoloader.md">https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-4-autoloader.md</a>) compliant, and it helps us to load only the file that we need, when we need them. In this way, we increase the speed of our application. Meanwhile, you can find more information about this<a id="id136" class="indexterm"/> component in the official documentation (at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/loader.html">http://docs.phalconphp.com/en/latest/reference/loader.html</a>).</p></div></div>
<div class="section" title="Creating the configuration file and the Bootstrap"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec16"/>Creating the configuration file and the Bootstrap</h1></div></div></div><p>Almost any application <a id="id137" class="indexterm"/>has some constants that will be reused (database credentials, SMTP credentials, and so on). For our application, we will create a global configuration file. This file will be an instance of the <code class="literal">\Phalcon\Config</code> component. Switch to the <code class="literal">config</code> directory and create it with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php

return new \Phalcon\Config(array(
    'application' =&gt; array(
        'name' =&gt; 'Learning Phalcon'
    ),
    'root_dir' =&gt; __DIR__.'/../',
    'redis' =&gt; array(
        'host' =&gt; '127.0.0.1',
        'port' =&gt; 6379,
    ),
    'session' =&gt; array(
        'unique_id' =&gt; 'learning_phalcon',
        'name' =&gt; 'learning_phalcon',
        'path' =&gt; 'tcp://127.0.0.1:6379?weight=1'
    ),
    'view' =&gt; array(
        'cache' =&gt; array(
            'dir' =&gt; __DIR__.'/../cache/volt/'
        )
    ),
));</pre></div><p>The<code class="literal"> Phalcon\Config</code> component simplifies the access to the configuration data within our application. By default, data is returned as an object (for example, we have access to the application name using <code class="literal">$config-&gt;application-&gt;name path</code>), but it also has a magic method to return data as an array—<code class="literal">$config-&gt;toArray()</code>. If you use <code class="literal">$config-&gt;toArray()</code>, then you will access the application name using the <code class="literal">$config['application']['name']</code> syntax. Another cool fact about this component is that we can merge another array into it using the <code class="literal">$config-&gt;merge($new_config)</code> syntax.</p><p>Now that we have an autoloader and a configuration, let's set up our Bootstrap file. To do this, create a file named <code class="literal">Bootstrap.php</code> in the <code class="literal">modules</code> folder with the following content:</p><p/><div class="informalexample"><pre class="programlisting">&lt;?php
   class Bootstrap extends \Phalcon\Mvc\Application
{
    private $modules;
    private $default_module = 'frontend';

    public function __construct($default_module)
    {
        $this-&gt;modules = array(
            'core' =&gt; array(
                'className' =&gt; 'App\Core\Module',
                'path' =&gt; __DIR__ . '/Core/Module.php'
            ),
            'api' =&gt; array(
                'className' =&gt; 'App\Api\Module',
                'path' =&gt; __DIR__ . '/Api/Module.php'
            ),
            'frontend' =&gt; array(
                'className' =&gt; 'App\Frontend\Module',
                'path' =&gt; __DIR__ . '/Frontend/Module.php'
            ),
            'backoffice' =&gt; array(
                'className' =&gt; 'App\Backoffice\Module',
                'path' =&gt; __DIR__ . '/Backoffice/Module.php'
            ),
        );

        $this-&gt;default_module = $default_module;
    }

    private function _registerServices()
    {
        $default_module = $this-&gt;default_module;
        $di             = new \Phalcon\DI\FactoryDefault();
        $config         = require __DIR__.'/../config/config.php';
        $modules        = $this-&gt;modules;

        include_once __DIR__.'/../config/loader.php';
        include_once __DIR__.'/../config/services.php';
        include_once __DIR__.'/../config/routing.php';

        $this-&gt;setDI($di);
    }

    public function init()
    {
        $debug = new \Phalcon\Debug();
        $debug-&gt;listen();

        $this-&gt;_registerServices();
        $this-&gt;registerModules($this-&gt;modules);

        echo $this-&gt;handle()-&gt;getContent();
    }
}</pre></div><p>Our Bootstrap file extends <code class="literal">\Phalcon\Mvc\Application</code> (<a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/applications.html">http://docs.phalconphp.com/en/latest/reference/applications.html</a>) that gives us access to<a id="id138" class="indexterm"/> the <code class="literal">registerModules()</code> method. The class constructor registers all our modules and sets the default module. The <code class="literal">_registerServices() </code>method initializes the DI and includes the required files for our application. Finally, the <code class="literal">init()</code> method initializes the application. Here, we make use of the <code class="literal">\Phalcon\Debug</code> component, because we need to be able to debug the application at any time. This should not be enabled in a production environment.</p><p>Until now, we created the folder structure, the configuration file, the autoloader, and the Bootstrap. We will go further by creating the services, routing, and the frontend modules files.</p></div>
<div class="section" title="Preparing the initial DI interface and the router"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Preparing the initial DI interface and the router</h1></div></div></div><p>In the Bootstrap, we<a id="id139" class="indexterm"/> don't have two files: <code class="literal">services.php </code>and<code class="literal"> routing.php</code>. The <code class="literal">services.php</code> file will hold the information about global services that<a id="id140" class="indexterm"/> our application will use, and the <code class="literal">routing.php</code> file will hold information about our routes. Let's start by creating the <code class="literal">services.php</code> file in our <code class="literal">config</code> folder with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
use \Phalcon\Logger\Adapter\File as Logger;

$di['session'] = function () use ($config) {

    $session = new \Phalcon\Session\Adapter\Redis(array(
        'uniqueId' =&gt; $config-&gt;session-&gt;unique_id,
        'path' =&gt; $config-&gt;session-&gt;path,
        'name' =&gt; $config-&gt;session-&gt;name
    ));

    $session-&gt;start();

    return $session;
};

$di['security'] = function () {
    $security = new \Phalcon\Security();
    $security-&gt;setWorkFactor(10);

    return $security;
};

$di['redis'] = function () use ($config) {
    $redis = new \Redis();
    $redis-&gt;connect(
        $config-&gt;redis-&gt;host,
        $config-&gt;redis-&gt;port
    );

    return $redis;
};

$di['url'] = function () use ($config, $di) {
    $url = new \Phalcon\Mvc\Url();

    return $url;
};

$di['voltService'] = function($view, $di) use ($config) {

    $volt = new \Phalcon\Mvc\View\Engine\Volt($view, $di);

    if (!is_dir($config-&gt;view-&gt;cache-&gt;dir)) {
        mkdir($config-&gt;view-&gt;cache-&gt;dir);
    }

    $volt-&gt;setOptions(array(
        "compiledPath" =&gt; $config-&gt;view-&gt;cache-&gt;dir,
        "compiledExtension" =&gt; ".compiled",
        "compileAlways" =&gt; true
    ));

    return $volt;
};

$di['logger'] = function () {
    $file = __DIR__."/../logs/".date("Y-m-d").".log";
    $logger = new Logger($file, array('mode' =&gt; 'w+'));

    return $logger;
};

$di['cache'] = function () use ($di, $config) {

    $frontend = new \Phalcon\Cache\Frontend\Igbinary(array(
        'lifetime' =&gt; 3600 * 24
    ));

    $cache = new \Phalcon\Cache\Backend\Redis($frontend, array(
        'redis' =&gt; $di['redis'],
        'prefix' =&gt; $config-&gt;application-&gt;name.':'
    ));

    return $cache;
};</pre></div><p>The <code class="literal">$di </code>variable<a id="id141" class="indexterm"/> is available because we initialized it in the <code class="literal">_registerServices()</code> method from<a id="id142" class="indexterm"/> the Bootstrap. <code class="literal">$di </code>is an instance of <code class="literal">\Phalcon\DI\FactoryDefault()</code>. Let's try to understand each component that we set:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$di['session']</code> is available by default, but we overwrite it because we want to use Redis to store our session.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$di['security']</code> is available by default, but we overwrite it because we want to set a higher work factor than the default one. We will use this component to encrypt our passwords.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$di['redis']</code> connects to the Redis server. We pass the parameters from our configuration file. The <code class="literal">\Redis</code> class is already available, because we installed it in the first chapter (<code class="literal">php5-redis</code>).</li><li class="listitem" style="list-style-type: disc"><code class="literal">$di['url']</code> is available by default. The reason why we overwrite this is for backwards compatibility with older versions of Phalcon. In the past, I wasn't able to access it without being defined. Since Phalcon 1.3, it works as expected.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$di['voltService']</code> is a custom DI component that we will use for the Volt template engine (you will learn about Volt soon).</li><li class="listitem" style="list-style-type: disc"><code class="literal">$di['logger']</code> is a custom DI component, and it uses <code class="literal">\Phalcon\Logger\Adapter\File</code>. We will use this to log different errors/warnings.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$di['cache']</code> is also a custom DI component that uses Igbinary as frontend cache and redis for backend. You will need to install Igbinary from PECL, if you don't have it, by issuing the following command: <code class="literal">sudo pecl install igbinary</code>. Note that you might need to reinstall <code class="literal">php5-redis</code> after installing Igbinary.</li></ul></div><p>Since we are going to use some components that are not available by default in Phalcon, we will need to install them from <code class="literal">phalcon/incubator</code> (<a class="ulink" href="https://github.com/phalcon/incubator">https://github.com/phalcon/incubator</a>).<span class="strong"><strong> Incubator</strong></span><a id="id143" class="indexterm"/> is a collection of components developed by the community, which may or may not be included in Phalcon's core. One of the components that we need right now is the <code class="literal">\Phalcon\Cache\Backend\Redis</code>.</p><p>We will use<a id="id144" class="indexterm"/> <span class="strong"><strong>Composer</strong></span> (<a class="ulink" href="https://getcomposer.org">https://getcomposer.org</a>/) to manage our package dependency. To<a id="id145" class="indexterm"/> install composer, execute the following <a id="id146" class="indexterm"/>command in the <code class="literal">learning-phalcon.localhost</code> folder:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ curl -s http://getcomposer.org/installer | php</strong></span>
</pre></div><p>Now, you should have a new file named <code class="literal">composer.phar</code> in your root folder. Next, let's install <code class="literal">phalcon/incubator</code> by executing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php composer.phar require phalcon/incubator dev-master</strong></span>
</pre></div><p>This will install other dependencies such as Swift Mailer, so it might take a few minutes to finish. If you check the folder structure, you will see that a new directory named <code class="literal">vendor</code> has been created. This is the default installation folder for composer, and all the packages will reside here.</p><p>However, this is not enough. In order to autoload the files from vendor, we need to make a small modification to our <code class="literal">public/index.php</code> file by adding the autoloader from composer. The new <code class="literal">index.php</code> file should look like this:</p><div class="informalexample"><pre class="programlisting">&lt;?php
header('Content-Type: text/html; charset=utf-8');
mb_internal_encoding("UTF-8");

require_once __DIR__.'/../vendor/autoload.php';
require_once __DIR__.'/../modules/Bootstrap.php';

$app = new Bootstrap('frontend');
$app-&gt;init();</pre></div></div>
<div class="section" title="Using the router component in a module"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Using the router component in a module</h1></div></div></div><p>We will continue this <a id="id147" class="indexterm"/>chapter by creating the routes for our application. To <a id="id148" class="indexterm"/>do this, switch to the <code class="literal">config</code> directory, and create a file named <code class="literal">routing.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$di['router'] = function() use ($default_module, $modules, $di, $config) {

    $router = new \Phalcon\Mvc\Router(false);
    $router-&gt;clear();

    $moduleRouting = __DIR__.'/../apps/'.ucfirst($default_module).'/Config/routing.php';

    if (file_exists($moduleRouting) &amp;&amp; is_file($moduleRouting)) {
        $router = include $moduleRouting;
    } else {
        $router-&gt;add('#^/(|/)$#', array(
            'module' =&gt; $default_module,
            'controller' =&gt; 'index',
            'action' =&gt; 'index',
        ));

        $router-&gt;add('#^/([a-zA-Z0-9\_]+)[/]{0,1}$#', array(
            'module' =&gt; $default_module,
            'controller' =&gt; 1,
        ));

        $router-&gt;add('#^/{0,1}([a-zA-Z0-9\_]+)/([a-zA-Z0-9\_]+)(/.*)*$#', array(
            'module' =&gt; $default_module,
            'controller' =&gt; 1,
            'action' =&gt; 2,
            'params' =&gt; 3,
        ));
    }

    return $router;
};</pre></div><p>In this file, we make use of the <code class="literal">\Phalcon\Mvc\Router</code> component. We check whether there is any <a id="id149" class="indexterm"/>routing <a id="id150" class="indexterm"/>information for the module and we load it; otherwise, we create the default routing rules. If you've been following us until now, you should have the following directory structure:</p><div class="mediaobject"><img src="graphics/B03522_02_06.jpg" alt="Using the router component in a module"/></div><p>In the first<a id="id151" class="indexterm"/> chapter, we already created and enabled the configuration <a id="id152" class="indexterm"/>files for the web server. In addition, we edited the host file, and www.learning-phalcon.localhost is pointing to our local host (<code class="literal">127.0.0.1</code>). Let's try to access <code class="literal">http://www.learning-phalcon.localhost</code> in our browser</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip09"/>Tip</h3><p>Please use <code class="literal">http://</code>. Otherwise, Chrome and probably other browsers will fail to access this URL, because <code class="literal">.dev</code> is not a registered Top Level Domain.</p></div></div><p>If you managed to access the application, you should see an error page similar to the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_02_01.jpg" alt="Using the router component in a module"/></div><p>Let's fix this<a id="id153" class="indexterm"/> error by creating the files needed for our <code class="literal">Frontend</code> module. Go to <a id="id154" class="indexterm"/>the <code class="literal">modules/Frontend</code> folder, and create a file named <code class="literal">Module.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Frontend;

use Phalcon\Mvc\ModuleDefinitionInterface;

class Module implements ModuleDefinitionInterface
{
    /**
     * Registers the module auto-loader
     */
    public function registerAutoloaders(<span class="strong"><strong>\Phalcon\DiInterface di = null</strong></span>) {}

    /**
     * Registers the module-only services
     *
     * @param Phalcon\DI $di
     */
    public function registerServices(<span class="strong"><strong>\Phalcon\DiInterface </strong></span>$di)
    {
        $config = include __DIR__ . "/Config/config.php";
        $di['config'] = $config;
        include __DIR__ . "/Config/services.php";
    }
}</pre></div><p>Now, copy this <a id="id155" class="indexterm"/>file into each module and change the namespace. For<a id="id156" class="indexterm"/> example, the <code class="literal">Module.php</code> file that resides in the <code class="literal">Api</code> module should have the <code class="literal">App\Api</code> namespace. Now, your modules directory structure should be like this:</p><div class="mediaobject"><img src="graphics/B03522_02_07.jpg" alt="Using the router component in a module"/></div><p>If you refresh the page, you will get another error that says <code class="literal">Phalcon\DI\Exception: Service 'view' was not found in the dependency injection container</code>. This happens because each module will have its own <code class="literal">config</code> folder, and we need to create the files there. Go to the <code class="literal">modules/Frontend/</code> directory and create a new folder named <code class="literal">Config</code> with C in uppercase.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note07"/>Note</h3><p>We use the uppercase because it's more easy to read and load within the namespace.</p></div></div><p>Now, in <code class="literal">modules/Frontend/Config/</code> create a file named <code class="literal">config.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
$config = require __DIR__.'/../../../config/config.php';
$module_config = array(
    'application' =&gt; array(
        'controllersDir' =&gt; __DIR__ . '/../Controllers/',
        'modelsDir' =&gt; __DIR__ . '/../Models/',
        'viewsDir' =&gt; __DIR__ . '/../Views/',
        'baseUri' =&gt; '/',
        'cryptSalt' =&gt; '5up3r5tr0n6p@55',
        'publicUrl' =&gt; 'http://www.learning-phalcon.localhost'
    ));

$config-&gt;merge($module_config);
return $config;</pre></div><p>In the first line, we<a id="id157" class="indexterm"/> assign the content of the global configuration file <a id="id158" class="indexterm"/>to the <code class="literal">$config</code> variable. Then, we set the module configuration, and we merge this information into our global <code class="literal">$config</code> variable. Next, let's create the routing and services files in the same folder (<code class="literal">modules/Frontend/Config/</code>):</p><p><code class="literal">services.php:</code></p><div class="informalexample"><pre class="programlisting">&lt;?php

$di['dispatcher'] = function () use ($di) {
    $eventsManager = $di-&gt;getShared('eventsManager');

    $dispatcher = new \Phalcon\Mvc\Dispatcher();
    $dispatcher-&gt;setEventsManager($eventsManager);
    $dispatcher-&gt;setDefaultNamespace('App\Frontend\Controllers');

    return $dispatcher;
};

$di['url']-&gt;setBaseUri(''.$config-&gt;application-&gt;baseUri.'');

$di['view'] = function () {

    $view = new \Phalcon\Mvc\View();
    $view-&gt;setViewsDir(__DIR__ . '/../Views/Default/');
    $view-&gt;registerEngines(array(
        ".volt" =&gt; 'voltService'
    ));

    return $view;
};</pre></div><p>In the <code class="literal">services.php</code> file, we overwrite the DI's URL and dispatcher components, and we create a custom view service that will use voltService that we declared in the global services file (<code class="literal">config/services.php</code>).</p><p><code class="literal">routing.php:</code></p><div class="informalexample"><pre class="programlisting">&lt;?php
$router = new \Phalcon\Mvc\Router(false);
$router-&gt;clear();

$router-&gt;add('/', array(
    'module' =&gt; 'frontend',
    'controller' =&gt; 'index',
    'action' =&gt; 'index'
));

return $router;</pre></div><p>We need<a id="id159" class="indexterm"/> the <code class="literal">routing.php</code> file here, because we are going to<a id="id160" class="indexterm"/> create custom routes for our Frontend module. The next thing that we need is a controller. It is a good practice in general to create a base file and all the other files to extend the base. This way you will avoid code duplication. Of course, you can use traits of other methods, but for this project, we will use a base file most of the time.</p><p>So, let's create the <code class="literal">Controllers</code> directory in <code class="literal">modules/Frontend/</code> and a blank base controller in <code class="literal">modules/Frontend/Controllers/</code> directory:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd modules/Frontend/</strong></span>
<span class="strong"><strong>$ mkdir Controllers</strong></span>
<span class="strong"><strong>$ touch Controllers/BaseController.php</strong></span>
</pre></div><p>Now, put the following content in <code class="literal">BaseController.php</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Frontend\Controllers;

class BaseController extends \Phalcon\Mvc\Controller
{

}</pre></div><p>Next, create another file here named <code class="literal">IndexController.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Frontend\Controllers;

class IndexController extends BaseController
{
    public function indexAction()
    {

    }
}</pre></div><p>If you check the <code class="literal">routing.php</code> file, you will notice that the default route goes to index controller → index action. In Phalcon, the standard is that any controller should have the <code class="literal">Controller</code> suffix, and any public action that matches a route should have the Action suffix.</p><p>Let's take a look <a id="id161" class="indexterm"/>at our directory structure from <code class="literal">modules/Frontend</code>. It <a id="id162" class="indexterm"/>should be exactly like this:</p><div class="mediaobject"><img src="graphics/B03522_02_08.jpg" alt="Using the router component in a module"/></div><p>If you try to refresh the page at <code class="literal">http://www.learning-phalcon.localhost</code>, you will see a blank page. This is perfectly normal. Next, let's copy the <code class="literal">Controllers</code> and <code class="literal">Config</code> folders from our <code class="literal">Frontend</code> module into each remaining module (<code class="literal">Api</code>, <code class="literal">Core</code>, and <code class="literal">Backoffice</code>). After we copy the files, we need to change the namespace and replace anything related to frontend with the new module name.</p><p>For example, after we copy the files into the <code class="literal">Api</code> module, we need to do the following:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Replace the <code class="literal">App\Frontend\Controllers</code> namespace with <code class="literal">App\Api\Controllers</code> in the <code class="literal">Controllers/</code> folder.</li><li class="listitem">Replace the word "<code class="literal">frontend</code>" with the word "<code class="literal">api</code>" in <code class="literal">Config/routing.php</code>.</li><li class="listitem">Replace <code class="literal">\App\Frontend\Controllers</code> with <code class="literal">App\Api\Controllers</code> in <code class="literal">services.php</code>.</li><li class="listitem">Append the module name in lowercase to the <code class="literal">baseUri</code> key from the <code class="literal">config.php</code> file. The result should be <code class="literal">'baseUri' =&gt; '/api/'</code>.</li></ol></div><p>After you<a id="id163" class="indexterm"/> finish, the new <a id="id164" class="indexterm"/>directory structure should be this:</p><div class="mediaobject"><img src="graphics/B03522_02_09.jpg" alt="Using the router component in a module"/></div></div>
<div class="section" title="Create the base layout"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec19"/>Create the base layout</h1></div></div></div><p>Now, it's time to focus a <a id="id165" class="indexterm"/>little bit on the layout (templates). We are going to use twitter-bootstrap for CSS and jQuery. Then, we are going to create first view in order to close this chapter.</p><p>Navigate to <code class="literal">public/folder</code> and create a folder named <code class="literal">assets</code>. Then, go to <code class="literal">assets</code> and create a folder named <code class="literal">default</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd public</strong></span>
<span class="strong"><strong>$ mkdir -p assets/default</strong></span>
</pre></div><p>I am using <a id="id166" class="indexterm"/>Bower (<a class="ulink" href="http://bower.io/">http://bower.io/</a>) as a package manager for my assets. It is what composer is for php packages.</p><p>If you don't have Bower installed and you don't want to use it, you will need to create a folder named <code class="literal">bower_components</code> in your <code class="literal">public/default/assets</code> folder and clone twitter-bootstrap repository from GitHub. You will also need to download jQuery and unzip it into the <code class="literal">bower_components</code> folder.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd public/default/assets/bower_components</strong></span>
<span class="strong"><strong>$ git clone https://github.com/twbs/bootstrap.git</strong></span>
</pre></div><p>If you have Bower, then just go to the <code class="literal">public/default/assets</code> folder and install twitter Bootstrap:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd public/default/assets</strong></span>
<span class="strong"><strong>$ bower install bootstrap</strong></span>
</pre></div><p>This will install jQuery automatically because Bootstrap requires jQuery, and Bower is smart enough to check for dependencies.</p><p>In the near future, we will also need some custom JavaScript, CSS files, and images. We need to create these directories in the public/assets/default folder, and we will also create two empty files named <code class="literal">lp.js</code> and <code class="literal">lp.css</code>. The folder structure of your public folder should be like this:</p><div class="mediaobject"><img src="graphics/B03522_02_10.jpg" alt="Create the base layout"/></div><p>Let's get back to <a id="id167" class="indexterm"/>our <code class="literal">frontend</code> module. Navigate to <code class="literal">modules/Frontend</code> and create a folder named Views. Then, in the <code class="literal">Views</code> folder, create another one named Default:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd modules/Frontend</strong></span>
<span class="strong"><strong>$ mkdir -p Views/Default</strong></span>
</pre></div><p>Remember that we are using <a id="id168" class="indexterm"/>Volt (<a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/volt.html">http://docs.phalconphp.com/en/latest/reference/volt.html</a>) as our template engine. We already discussed Volt's syntax in the first chapter, and as we move forward, we will dig more into this subject, but at the right moment. For now, we just want to finish our project structure and render a dummy layout for our fronted module.</p><p>This way we can ensure that we did everything as expected until now. In the dependency injection from <code class="literal">services.php</code>, we assigned the file extension .volt to our template engine. Therefore, all the views that we are going to create will have the extension .volt. Let's create the main layout. Navigate to <code class="literal">modules/Frontend/Views/Default</code> and create a new file named <code class="literal">layout.volt</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
&lt;meta charset="utf-8"&gt;
&lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
&lt;title&gt;{% block pageTitle %}Learning Phalcon{% endblock %}&lt;/title&gt;

{{ stylesheetLink('../assets/default/bower_components/bootstrap/dist/css/bootstrap.min.css') }}
{{ stylesheetLink('../assets/default/css/lp.css') }}

&lt;!--[if lt IE 9]&gt;
      &lt;script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"&gt;&lt;/script&gt;
      &lt;script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"&gt;&lt;/script&gt;
&lt;![endif]--&gt;
&lt;/head&gt;
&lt;body&gt;
    {% block body %}
    &lt;h1&gt;Main layout&lt;/h1&gt;
    {% endblock %}

    {{ javascriptInclude("../assets/default/bower_components/jquery/dist/jquery.min.js") }}
    {{ javascriptInclude("../assets/default/bower_components/bootstrap/dist/js/bootstrap.min.js") }}
    {{ javascriptInclude("../assets/default/js/lp.js") }}
    {% block javascripts %} {% endblock %}
&lt;/body&gt;
&lt;/html&gt;</pre></div><p>As we mentioned earlier, we are <a id="id169" class="indexterm"/>not going to talk about volt's syntax for now. There is one more step that needs to be performed in order to render the templates. We need to create a new folder named <code class="literal">index</code>; then, in the <code class="literal">index</code> folder, we also need to create a file named <code class="literal">index.volt</code>. This will match <code class="literal">IndexController</code> → <code class="literal">IndexAction</code>.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd modules/Frontend/Views/Default</strong></span>
<span class="strong"><strong>$ mkdir index</strong></span>
<span class="strong"><strong>$ cd index</strong></span>
<span class="strong"><strong>$ touch index.volt</strong></span>
</pre></div><p>The content of the <code class="literal">index.volt</code> file is this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>{% extends 'layout.volt' %}</strong></span>
<span class="strong"><strong>{% block body %}</strong></span>
<span class="strong"><strong>I did it !</strong></span>
<span class="strong"><strong>{% endblock %}</strong></span>
</pre></div><p>The final directory structure for our frontend module should be this:</p><div class="mediaobject"><img src="graphics/B03522_02_11.jpg" alt="Create the base layout"/></div><p>Now, let's try to <a id="id170" class="indexterm"/>refresh the page <code class="literal">http://www.learning-phalcon.localhost</code>. If you see a page like the one in the following screenshot, then you have made it!</p><div class="mediaobject"><img src="graphics/B03522_02_02.jpg" alt="Create the base layout"/></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec20"/>Summary</h1></div></div></div><p>In this chapter, we learned the basics of MVC, created the folder structure for our project, and learned a little bit about how to use the DI component, routing component, and the view component. We also created the views and rendered the first page from the Frontend module.</p><p>In the next chapters, we will learn about Phalcon's ORM and ODM, and we will continue to add features until we have a fully functional online newspaper website.</p></div></body></html>