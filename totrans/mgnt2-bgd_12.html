<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;11.&#xA0;Testing" id="2E6E41-818f5224668745eb9070ddf1d85e6bfa"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11" class="calibre1"/>Chapter 11. Testing</h1></div></div></div><p class="calibre7">Software testing can be defined as a critical step in the development life cycle. This step is often<a id="id508" class="calibre1"/> silently overlooked by a number of developers because a certain amount of time need to be invested into writing a decent test suite for a code base. Rather than being a single one-time activity, writing tests is a process that follows our code as it grows and changes. Test results should, at any given time, validate and verify that our software works as expected, thus meeting the business and technical requirements. Writing tests should follow writing the actual application code early on in the life cycle. This helps prevent defects from being introduced in the code.</p><p class="calibre7">On a high level, we can divide tests into the following categories:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre8">Static</strong></span>: Application<a id="id509" class="calibre1"/> code is not executed during testing. Possible errors are found by inspecting the application code files and not on their execution.</li><li class="listitem"><span class="strong"><strong class="calibre8">Dynamic</strong></span>: Application <a id="id510" class="calibre1"/>code is executed during testing. Possible errors are found while checking for functional behavior of an application.</li></ul></div><p class="calibre7">In this chapter, we will take a look at the testing options that Magento offers. Along the way, we will build a basic module with some testing features in it.</p></div>

<div class="book" title="Chapter&#xA0;11.&#xA0;Testing" id="2E6E41-818f5224668745eb9070ddf1d85e6bfa">
<div class="book" title="Types of tests"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch11lvl1sec75" class="calibre1"/>Types of tests</h1></div></div></div><p class="calibre7">Magento <a id="id511" class="calibre1"/>provides several types of tests out of the box. We can see a list of these tests on running the following command on the console in the Magento root folder:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php bin/magento dev:tests:run –help</strong></span>
</pre></div><p class="calibre7">The result of the command is an output that looks like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">Usage:</strong></span>
<span class="strong"><strong class="calibre8"> dev:tests:run [type]</strong></span>
<span class="strong"><strong class="calibre8">Arguments:</strong></span>
<span class="strong"><strong class="calibre8"> type Type of test to run. Available types: all, unit, integration, integration-all, static, static-all, integrity, legacy, default (default: "default")</strong></span>
</pre></div><p class="calibre7">This<a id="id512" class="calibre1"/> output originates from the <code class="email">Console/Command/DevTestsRunCommand.php</code> file in the core <code class="email">Magento_Developer</code> module. Looking at the output, we might say that there are actually nine types of tests, which are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">all</code></li><li class="listitem"><code class="email">unit</code></li><li class="listitem"><code class="email">integration</code></li><li class="listitem"><code class="email">integration-all</code></li><li class="listitem"><code class="email">static</code></li><li class="listitem"><code class="email">static-all</code></li><li class="listitem"><code class="email">integrity</code></li><li class="listitem"><code class="email">legacy</code></li><li class="listitem"><code class="email">default</code></li></ul></div><p class="calibre7">However, these are not unique types of tests; these are combinations, as we will soon see.</p><p class="calibre7">Let's take a closer look at the code in the <code class="email">DevTestsRunCommand</code> class and its <code class="email">setupTestInfo</code> method.</p><p class="calibre7">The <code class="email">setupTestInfo</code> method defines the internal <code class="email">commands</code> property, as follows:</p><div class="informalexample"><pre class="programlisting">$this-&gt;commands = [
    'unit'                   =&gt; ['../tests/unit', ''],
    'unit-performance'       =&gt; ['../tests/performance/ framework/tests/unit', ''],
    'unit-static'            =&gt; ['../tests/static/ framework/tests/unit', ''],
    'unit-integration'       =&gt; ['../tests/integration/ framework/tests/unit', ''],
    'integration'            =&gt; ['../tests/integration', ''],
    'integration-integrity'  =&gt; ['../tests/integration', ' testsuite/Magento/ Test/Integrity'],
    'static-default'         =&gt; ['../tests/static', ''],
    'static-legacy'          =&gt; ['../tests/static', ' testsuite/Magento/Test/Legacy'],
    'static-integration-js'  =&gt; ['../tests/static', ' testsuite/Magento/Test/ Js/Exemplar'],
];</pre></div><p class="calibre7">Furthermore, we can see the types property in the <code class="email">setupTestInfo</code> method defined in the following way:</p><div class="informalexample"><pre class="programlisting">$this-&gt;types = [
    'all'             =&gt; array_keys($this-&gt;commands),
    'unit'            =&gt; ['unit', 'unit-performance', 'unit- static', 'unit-integration'],
    'integration'     =&gt; ['integration'],
    'integration-all' =&gt; ['integration', 'integration-integrity'],
    'static'          =&gt; ['static-default'],
    'static-all'      =&gt; ['static-default', 'static-legacy', 'static-integration-js'],
    'integrity'       =&gt; ['static-default', 'static-legacy', 'integration-integrity'],
    'legacy'          =&gt; ['static-legacy'],
    'default'         =&gt; [
        'unit',
        'unit-performance',
        'unit-static',
        'unit-integration',
        'integration',
        'static-default',
    ],
];</pre></div><p class="calibre7">The <code class="email">types</code> property <a id="id513" class="calibre1"/>logically groups one or more tests into a single name that is found under the <code class="email">commands</code> property. We can see how like <code class="email">unit</code> single type encompasses the <code class="email">unit</code>, <code class="email">unit-performance</code>, <code class="email">unit-static</code>, and <code class="email">unit-integration</code> tests in it. The <code class="email">commands</code> property points to the disk location of the actual test library. Relative to the Magento root installation folder, tests can be found in the <code class="email">dev/tests/ directory</code>.</p></div></div>
<div class="book" title="Unit testing" id="2F4UM1-818f5224668745eb9070ddf1d85e6bfa"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec76" class="calibre1"/>Unit testing</h1></div></div></div><p class="calibre7"><span class="strong"><strong class="calibre8">Unit tests</strong></span> are <a id="id514" class="calibre1"/>designed to test individual class methods in isolation, asserting all possible combinations and taking care of the smallest testable part of an application. Magento uses the <span class="strong"><strong class="calibre8">PHPUnit</strong></span> testing framework for its unit tests. Being highly<a id="id515" class="calibre1"/> focused, unit tests make it easy to identify the root cause of issues if a certain test fails.</p><p class="calibre7">We can specifically trigger the unit tests from the root of the Magento installation by using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php bin/magento dev:tests:run unit</strong></span>
</pre></div><p class="calibre7">Once triggered, Magento will run the <code class="email">execute</code> command in the <code class="email">vendor/magento/module-developer/Console/Command/DevTestsRunCommand.php</code> file. Since the unit type is mapped to several commands, what will happen internally is that Magento will change the directories from one directory to another, as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">dev/tests/unit</code></li><li class="listitem"><code class="email">dev/tests/performance/framework/tests/unit</code></li><li class="listitem"><code class="email">dev/tests/static/framework/tests/unit</code></li><li class="listitem"><code class="email">dev/tests/integration/framework/tests/unit</code></li></ul></div><p class="calibre7">We can<a id="id516" class="calibre1"/> say that all of these directories are considered unit test directories.</p><p class="calibre7">Within each of those directories, Magento internally runs the <code class="email">passthru($command, $returnVal)</code> method, where the <code class="email">$command</code> parameter gets resolved to a string similar to the following one:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php /www/magento2/./vendor/phpunit/phpunit/phpunit</strong></span>
</pre></div><p class="calibre7">The PHPUnit will then look for the <code class="email">phpunit.xml</code> configuration file accordingly in each of these directories. If <code class="email">phpunit.xml</code> does not exist, we need to copy the contents of <code class="email">phpunit.xml.dist</code> into <code class="email">phpunit.xml</code>.</p><p class="calibre7">Let's take a closer look at the <code class="email">dev/tests/unit/phpunit.xml</code> file for <code class="email">testsuite</code>, <code class="email">filter</code>, <code class="email">whitelist</code>, and other configuration elements.</p><p class="calibre7">The following default <code class="email">testsuite</code> directory list is found in the <code class="email">dev/tests/unit/phpunit.xml file</code>, which lists the directories in which you need to look for <code class="email">tests</code> files prefixed with <code class="email">Test.php</code>:</p><div class="informalexample"><pre class="programlisting">../../../app/code/*/*/Test/Unit
../../../dev/tools/*/*/Test/Unit
../../../dev/tools/*/*/*/Test/Unit
../../../lib/internal/*/*/Test/Unit
../../../lib/internal/*/*/*/Test/Unit
../../../setup/src/*/*/Test/Unit
../../../update/app/code/*/*/Test/Unit
../../../vendor/*/module-*/Test/Unit
../../../vendor/*/framework/Test/Unit
../../../vendor/*/framework/*/Test/Unit</pre></div><p class="calibre7">The list is relative to the <code class="email">dev/tests/unit/</code> directory. For example, if we take a look at the first line in the preceding code and then look at the <code class="email">Magento_Catalog</code> module, it is clear that the <code class="email">Test</code> files are found under the <code class="email">app/code/&lt;vendorName&gt;/&lt;moduleName&gt;/Test/</code> directory and its subdirectories. Everything suffixed with <code class="email">Test.php</code> in these folders will get executed as a part of a unit test.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip17" class="calibre1"/>Tip</h3><p class="calibre7">If we were building our own module, we could easily make a copy of <code class="email">dev/tests/unit/phpunit.xml.dist</code>, properly edit <code class="email">testsuite</code> and <code class="email">filter &gt; whitelist</code> to quickly execute only our module's unit tests, thus saving <a id="id517" class="calibre1"/>some time on avoiding frequent execution of entire Magento unit tests.</p></div></div>
<div class="book" title="Integration testing" id="2G3F81-818f5224668745eb9070ddf1d85e6bfa"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec77" class="calibre1"/>Integration testing</h1></div></div></div><p class="calibre7"><span class="strong"><strong class="calibre8">Integration tests</strong></span> test the interaction between individual components, layers, and an environment. They<a id="id518" class="calibre1"/> can be found in the <code class="email">dev/tests/integration</code> directory. Like unit tests, Magento also uses PHPUnit for integration tests. Thus, the difference between a unit and an integration test is not that much of a technical nature; rather, it's of a logical nature.</p><p class="calibre7">To specifically trigger integration tests only, we can execute the following command on the console:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php bin/magento dev:tests:run integration</strong></span>
</pre></div><p class="calibre7">When executed, Magento internally changes the directory to <code class="email">dev/tests/integration</code> and executes a command that is similar to the following one:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php /Users/branko/www/magento2/./vendor/phpunit/phpunit/phpunit</strong></span>
</pre></div><p class="calibre7">The integration directory has its own <code class="email">phpunit.xml.dist</code> file. Looking at its <code class="email">testsuite</code> definition, we can see that it is pointing to all the <code class="email">Test.php</code> suffixed files that are found in the <code class="email">dev/tests/integration/testsuite</code> directory.</p></div>
<div class="book" title="Static testing" id="2H1VQ1-818f5224668745eb9070ddf1d85e6bfa"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec78" class="calibre1"/>Static testing</h1></div></div></div><p class="calibre7"><span class="strong"><strong class="calibre8">Static tests</strong></span> do <a id="id519" class="calibre1"/>not really run the code; they analyze it. They are used to verify that the code conforms to certain coding standards, such as PSR-1. We can find them under the <code class="email">dev/tests/static</code> directory.</p><p class="calibre7">To specifically trigger static tests only, we can execute the following command on the console:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php bin/magento dev:tests:run static</strong></span>
</pre></div><p class="calibre7">When executed, Magento internally changes the directory to <code class="email">dev/tests/static</code> and executes a command that is similar to the following one:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php /Users/branko/www/magento2/./vendor/phpunit/phpunit/phpunit</strong></span>
</pre></div><p class="calibre7">The static directory has its own <code class="email">phpunit.xml.dist</code> file. Looking at its <code class="email">testsuite</code> definition, you will see the following four test suites defined:</p><div class="book"><ul class="itemizedlist"><li class="listitem">JavaScript static code analysis</li><li class="listitem">PHP coding standard verification</li><li class="listitem">Code integrity tests</li><li class="listitem">XSS unsafe output test</li></ul></div><p class="calibre7"><code class="email">JSHint</code>, a JavaScript <a id="id520" class="calibre1"/>code quality tool, is used for JavaScript static code analysis. For PHP code standard verification, the elements of <code class="email">PHP_CodeSniffer</code> libraries are used. <code class="email">PHP_CodeSniffer</code> tokenizes PHP, JavaScript, and CSS files and detects violations of a defined set of coding standards.</p></div>
<div class="book" title="Integrity testing" id="2I0GC1-818f5224668745eb9070ddf1d85e6bfa"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec79" class="calibre1"/>Integrity testing</h1></div></div></div><p class="calibre7"><span class="strong"><strong class="calibre8">Integrity tests</strong></span> check how an application is linked. They check for things such as merged configuration <a id="id521" class="calibre1"/>validation. Basically, they tell us if your application should be able to run.</p><p class="calibre7">We can specifically trigger the integrity tests from the root of the Magento installation by using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php bin/magento dev:tests:run integrity</strong></span>
</pre></div><p class="calibre7">When this is executed, Magento first internally changes the directory to <code class="email">dev/tests/static</code> and then executes two commands that are similar to the following ones:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php /Users/branko/www/magento2/./vendor/phpunit/phpunit/phpunit</strong></span>
<span class="strong"><strong class="calibre8">php /Users/branko/www/magento2/./vendor/phpunit/phpunit/phpunit testsuite/Magento/Test/Legacy</strong></span>
</pre></div><p class="calibre7">Then, Magento internally changes the directory to <code class="email">dev/tests/integration</code> and executes a command that is similar to the following one:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php /Users/branko/www/magento2/./vendor/phpunit/phpunit/phpunit testsuite/Magento/Test/Integrity</strong></span>
</pre></div><p class="calibre7">Integration tests also utilize the PHPUnit to write the actual tests.</p></div>
<div class="book" title="Legacy testing" id="2IV0U1-818f5224668745eb9070ddf1d85e6bfa"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec80" class="calibre1"/>Legacy testing</h1></div></div></div><p class="calibre7"><span class="strong"><strong class="calibre8">Legacy tests</strong></span> comprise <a id="id522" class="calibre1"/>fragments of libraries that help developers port their modules to a new version of Magento.</p><p class="calibre7">We can trigger legacy tests specifically from the root of the Magento installation by using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php bin/magento dev:tests:run legacy</strong></span>
</pre></div><p class="calibre7">When this is executed, Magento first internally changes the directory to <code class="email">/dev/tests/static</code> and then executes a command, which is similar to the following one:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php /Users/branko/www/magento2/./vendor/phpunit/phpunit/phpunit testsuite/Magento/Test/Legacy</strong></span>
</pre></div><p class="calibre7">Once <a id="id523" class="calibre1"/>this is triggered, the code runs a check for obsolete access lists, connections, menus, responses, system configuration, and a few other things.</p></div>
<div class="book" title="Performance testing" id="2JTHG1-818f5224668745eb9070ddf1d85e6bfa"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec81" class="calibre1"/>Performance testing</h1></div></div></div><p class="calibre7">Performance <a id="id524" class="calibre1"/>tests can be found under the <code class="email">setup/performance-toolkit/</code> directory. These tests require Apache JMeter to be installed and are available on the console via the <code class="email">jmeter</code> command. Apache JMeter can be <a id="id525" class="calibre1"/>downloaded and installed by following the instructions at <a class="calibre1" href="http://jmeter.apache.org">http://jmeter.apache.org</a>.</p><p class="calibre7">The crux of the performance test is defined in the <code class="email">benchmark.jmx</code> file, which can be opened in the JMeter GUI tool, as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00088.jpeg" alt="Performance testing" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">As shown in the preceding screenshot, the default <code class="email">benchmark.jmx</code> tests are sectioned into three thread groups that are named <span class="strong"><strong class="calibre8">setUp Thread Group</strong></span>, <span class="strong"><strong class="calibre8">Customer Checkout</strong></span>, and <span class="strong"><strong class="calibre8">tearDown Thread Group</strong></span>. We might want to additionally click on each group and configure it with some extra parameters, thus possibly changing <span class="strong"><strong class="calibre8">Number of Threads (users)</strong></span>, as <a id="id526" class="calibre1"/>shown in the following screenshot. We can then simply save the changes as modifications to the <code class="email">benchmark.jmx</code> file or a file with new name:</p><div class="mediaobject"><img src="../images/00089.jpeg" alt="Performance testing" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">We can manually trigger a performance test from the console without using a GUI interface by running the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">jmeter -n \</strong></span>
<span class="strong"><strong class="calibre8">-t /Users/branko/www/magento2/setup/performance-toolkit/benchmark.jmx \</strong></span>
<span class="strong"><strong class="calibre8">-l /Users/branko/Desktop/jmeter-tmp/results.jtl \</strong></span>
<span class="strong"><strong class="calibre8">-Jhost="magento2.ce" \</strong></span>
<span class="strong"><strong class="calibre8">-Jbase_path="/" \</strong></span>
<span class="strong"><strong class="calibre8">-Jreport_save_path="/Users/branko/report" \</strong></span>
<span class="strong"><strong class="calibre8">-Jloops=2 \</strong></span>
<span class="strong"><strong class="calibre8">-Jurl_suffix=".html" \</strong></span>
<span class="strong"><strong class="calibre8">-Jcustomer_email="john.doe@email.loc" \</strong></span>
<span class="strong"><strong class="calibre8">-Jcustomer_password="abc123" \</strong></span>
<span class="strong"><strong class="calibre8">-Jadmin_path="/admin_nwb0bx" \</strong></span>
<span class="strong"><strong class="calibre8">-Jadmin-user="john" \</strong></span>
<span class="strong"><strong class="calibre8">-Jadmin-password="abc123" \</strong></span>
<span class="strong"><strong class="calibre8">-Jresponse_time_file_name="/Users/branko/report/AggregateGraph.csv" \</strong></span>
<span class="strong"><strong class="calibre8">-Jsimple_product_url_key="simple-product-1" \</strong></span>
<span class="strong"><strong class="calibre8">-Jsimple_product_name="Simple Product 1" \</strong></span>
<span class="strong"><strong class="calibre8">-Jconfigurable_product_url_key="configurable-product-1" \</strong></span>
<span class="strong"><strong class="calibre8">-Jconfigurable_product_name="Configurable Product 1" \</strong></span>
<span class="strong"><strong class="calibre8">-Jcategory_url_key="category-1" \</strong></span>
<span class="strong"><strong class="calibre8">-Jcategory_name="Category 1" \</strong></span>
<span class="strong"><strong class="calibre8">-Jsleep_between_steps=50</strong></span>
</pre></div><p class="calibre7">The <a id="id527" class="calibre1"/>console parameters that are listed here and which start with <code class="email">-J</code> also match the names of the <span class="strong"><strong class="calibre8">Used Defined Variables</strong></span> test toolkit, as shown in the preceding screenshot. We need to be careful and set them according to the Magento installation. The <code class="email">-n</code> parameter instructs <code class="email">jmeter</code> to run in the run <span class="strong"><em class="calibre9">nongui</em></span> mode. The <code class="email">-t</code> parameter is where we set the path of the test (<code class="email">.jmx</code>) file to run. The <code class="email">-l</code> parameter sets the file where we need to log samples to.</p></div>
<div class="book" title="Functional testing"><div class="book" id="2KS222-818f5224668745eb9070ddf1d85e6bfa"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec82" class="calibre1"/>Functional testing</h1></div></div></div><p class="calibre7"><span class="strong"><strong class="calibre8">Functional tests</strong></span> mimic<a id="id528" class="calibre1"/> the user interaction with our application. They literally mean testing in the form of browser interaction, which involves clicking on the page, adding products to the cart, and so on. For this purpose, Magento<a id="id529" class="calibre1"/> uses <span class="strong"><strong class="calibre8">Magento Testing Framework</strong></span> (<span class="strong"><strong class="calibre8">MTF</strong></span>). It's <a id="id530" class="calibre1"/>a PHP wrapper around <span class="strong"><strong class="calibre8">Selenium</strong></span>, which is a portable software testing framework for web applications. MTF is not available out of the box via the console. It <a id="id531" class="calibre1"/>can be downloaded at <a class="calibre1" href="https://github.com/magento/mtf">https://github.com/magento/mtf</a>.</p><p class="calibre7">The <a id="id532" class="calibre1"/>following requirements need to be met before installing MTF:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Git must be installed.</li><li class="listitem">The Firefox browser must be installed.</li><li class="listitem">The PHP openssl extension must be installed and enabled.</li><li class="listitem">Java version 1.6 or later is required and it's JAR executable must be in the system PATH.</li><li class="listitem">The <a id="id533" class="calibre1"/>Selenium standalone server, which is available at <a class="calibre1" href="http://www.seleniumhq.org/">http://www.seleniumhq.org/</a>, needs to be downloaded. The download should provide a JAR file that we will later need to refer to.</li><li class="listitem">Magento must be installed and configured to not use the secret URL key. We can set the secret URL key option by navigating to <span class="strong"><strong class="calibre8">Stores</strong></span> | <span class="strong"><strong class="calibre8">Configuration</strong></span> | <span class="strong"><strong class="calibre8">Advanced</strong></span> | <span class="strong"><strong class="calibre8">Admin</strong></span> | <span class="strong"><strong class="calibre8">Security</strong></span> | <span class="strong"><strong class="calibre8">Add Secret Key to URLs</strong></span> [Yes/No] and setting it to <span class="strong"><strong class="calibre8">No</strong></span>.</li></ul></div><p class="calibre7">Once the minimal requirements are met, we can install MTF, as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Run the <code class="email">composer install</code> command from the <code class="email">dev/tests/functional/</code> directory. This<a id="id534" class="calibre1"/> creates a new directory named <code class="email">vendor</code>; MTF is pulled from the Git repository at <a class="calibre1" href="https://github.com/magento/mtf">https://github.com/magento/mtf</a>. We should see a new directory named <code class="email">vendor</code> that is created with the checked off MTF. The <code class="email">vendor</code> directory <a id="id535" class="calibre1"/>contains the content that is shown in the following screenshot:<div class="mediaobject"><img src="../images/00090.jpeg" alt="Functional testing" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="2">Run the <code class="email">generate.php</code> file from the <code class="email">dev/tests/functional/utils/</code> directory. This should give us a console output that is similar to the following one:<div class="informalexample"><pre class="programlisting">|| Item               || Count || Time ||
|| Page Classes       || 152   || 0    ||
|| Fixture Classes    || 46    || 0    ||
|| Repository Classes || 67    || 0    ||
|| Block              || 475   || 0    ||
|| Fixture            || 100   || 0    ||
|| Handler            || 3     || 0    ||
|| Page               || 165   || 0    ||
|| Repository         || 67    || 0    ||</pre></div><div class="note" title="Note"><h3 class="title2"><a id="note20" class="calibre1"/>Note</h3><p class="calibre7">The generator tool creates factories for fixtures, handlers, repositories, page objects, and block objects. When MTF is initialized, the factories are pregenerated to facilitate the creation and running of tests.</p></div></li></ol><div class="calibre14"/></div><p class="calibre7">Before we<a id="id536" class="calibre1"/> can actually run the tests, there are a few more things that we need to configure, as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Edit the <code class="email">dev/tests/functional/phpunit.xml</code> file. Under the <code class="email">php</code> element, for <code class="email">name="app_frontend_url"</code>, set the value of the actual URL for the Magento storefront under test. For <code class="email">name="app_backend_url"</code>, set the value of the actual URL for the Magento admin URL under test. For <code class="email">name="credentials_file_path"</code>, set the value of <code class="email">./credentials.xml</code>.<div class="note" title="Note"><h3 class="title2"><a id="tip18" class="calibre1"/>Tip</h3><p class="calibre7">If <code class="email">phpunit.xml</code> does not exist, we need to create it and copy the contents of <code class="email">dev/tests/functional/phpunit.xml.dist</code> into it and then edit it afterwards.</p></div></li><li class="listitem" value="2">Edit the <code class="email">dev/tests/functional/etc/config.xml</code> file. Under the <code class="email">application</code> element, find and edit the information about <code class="email">backendLogin</code>, <code class="email">backendPassword</code>, and <code class="email">appBackendUrl</code> so that it matches that of our store.<div class="note" title="Note"><h3 class="title2"><a id="tip19" class="calibre1"/>Tip</h3><p class="calibre7">If <code class="email">config.xml</code> does not exist, we need to create it and copy the contents of <code class="email">dev/tests/functional/etc/config.xml.dist</code> into it and then edit it afterwards.</p></div></li><li class="listitem" value="3">Edit the <code class="email">dev/tests/functional/credentials.xml</code> file. Chances are that we will not need this on a blank Magento installation, as we can see by default the entries for the <code class="email">fedex</code>, <code class="email">ups</code>, <code class="email">dhl U</code>S, and <code class="email">dhl EU</code> carriers, which haven't been set on the freshly installed Magento.<div class="note" title="Note"><h3 class="title2"><a id="tip20" class="calibre1"/>Tip</h3><p class="calibre7">If <code class="email">credentials.xml</code> does not exist, we need to create it and copy the contents of <code class="email">dev/tests/functional/credentials.xml.dist</code> into it and then edit it afterwards.</p></div></li><li class="listitem" value="4">Run the <code class="email">java -jar {selenium_directory}/selenium-server.jar</code> command via the console. This is to ensure that the Selenium server is running.</li><li class="listitem" value="5">Open a new console or a console tab and execute the <code class="email">phpunit</code> command in the <code class="email">dev/tests/functional/</code> directory. This command should open the Firefox browser and start running test cases in it, simulating a user clicking on the browser window and filling in the form inputs.</li></ol><div class="calibre14"/></div><p class="calibre7">While a<a id="id537" class="calibre1"/> test is running, Magento will log all the failed tests under the <code class="email">dev/tests/functional/var/log</code> directory in a structure that is similar to the one shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00091.jpeg" alt="Functional testing" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">The <code class="email">log</code> path can be configured in the <code class="email">dev/tests/functional/phpunit.xml</code> file under the <code class="email">php</code> element with <code class="email">name="basedir"</code>.</p><p class="calibre7">If we want to target a specific test within the entire test suite, we can simply trigger a command like the following one in the <code class="email">dev/tests/functional/</code> directory:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">phpunit tests/app/Magento/Customer/Test/TestCase /RegisterCustomerFrontendEntityTest.php</strong></span>
</pre></div><p class="calibre7">The preceding command will run a single test called <code class="email">RegisterCustomerFrontendEntityTest.php</code>. We can also use a shorter form expression for the same thing, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">phpunit --filter RegisterCustomerFrontendEntityTest</strong></span>
</pre></div><p class="calibre7">Once <a id="id538" class="calibre1"/>this is executed, the browser should open and simulate the customer registration process on the storefront.</p></div>
<div class="book" title="Writing a simple unit test"><div class="book" id="2LQIK2-818f5224668745eb9070ddf1d85e6bfa"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec83" class="calibre1"/>Writing a simple unit test</h1></div></div></div><p class="calibre7">Now that we took a quick look at all the type of tests that Magento offers, let's take a step back and<a id="id539" class="calibre1"/> look at unit tests again. In practice, unit tests are probably <a id="id540" class="calibre1"/>the ones that we will be writing most of the time. With this in mind, let's grab the <code class="email">Foggyline_Unitly</code> module from <a class="calibre1" href="https://github.com/ajzele/B05032-Foggyline_Unitly">https://github.com/ajzele/B05032-Foggyline_Unitly</a> and start writing unit tests for it.</p><p class="calibre7">If you do not already have the <code class="email">Foggyline_Unitly</code> module in the code base that was a part of the previous chapters, then you need to place its content under <code class="email">app/code/Foggyline/Unitly</code> and execute the following commands on the console from the root of the Magento directory:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">php bin/magento module:enable Foggyline_Unitly</strong></span>
<span class="strong"><strong class="calibre8">php bin/magento setup:upgrade</strong></span>
</pre></div><p class="calibre7">The tests that we will write reside in the module's <code class="email">Test/Unit</code> directory. This makes the entire path of the test directory look like <code class="email">app/code/Foggyline/Unitly/Test/Unit/</code>. Magento knows that it needs to look inside this folder simply because of the test suite directory definitions found in the <code class="email">dev/tests/unit/phpunit.xml</code> file, as shown in the following piece of code:</p><div class="informalexample"><pre class="programlisting">&lt;directory suffix="Test.php"&gt;
    ../../../app/code/*/*/Test/Unit
&lt;/directory&gt;</pre></div><p class="calibre7">The structure of files and the folder within the individual module <code class="email">Test/Unit</code> directory also follows the structure of that module's files and folders. The following screenshot shows a structure of the <code class="email">Test/Unit</code> directory for the <code class="email">Magento_Catalog</code> module:</p><div class="mediaobject"><img src="../images/00092.jpeg" alt="Writing a simple unit test" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">This shows that almost any PHP class can be unit tested irrespective of the fact that it is a controller, block, helper, module, observer, or something else. To keep things simple, we will focus<a id="id541" class="calibre1"/> on the controller and block unit tests in relation to the <code class="email">Foggyline_Unitly</code> module, which is structured as follows:</p><div class="mediaobject"><img src="../images/00093.jpeg" alt="Writing a simple unit test" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Let's start by first writing a test for the <code class="email">Foggyline\Unitly\Controller\Hello\Shout</code> controller class. The <code class="email">Shout</code> class, ignoring the <code class="email">__construct</code>, has only one method called <code class="email">execute</code>.</p><p class="calibre7">We will write a test for it under the same directory structure, relative to the module's <code class="email">Test\Unit</code> directory, placing the test under the <code class="email">app/code/Foggyline/Unitly/Test/Unit/Controller/Hello/ShoutTest.php</code> file with (partial), as follows:</p><div class="informalexample"><pre class="programlisting">namespace Foggyline\Unitly\Test\Unit\Controller\Hello;

class ShoutTest extends \PHPUnit_Framework_TestCase
{
    protected $resultPageFactory;
    protected $controller;

    public function setUp()
    {
        /* setUp() code here */
    }

    public function testExecute()
    {
        /* testExecute() code here */
    }
}</pre></div><p class="calibre7">Every<a id="id542" class="calibre1"/> unit test in the Magento module directory extends from the <code class="email">\PHPUnit_Framework_TestCase</code> class. The <code class="email">setUp</code> method is called before the test is executed; we can think of it as PHP's <code class="email">__construct</code>. Here, we would usually set up the fixtures, open a network connection, or perform similar actions.</p><p class="calibre7">The <code class="email">testExecute</code> method name is actually formed from test <code class="email">+</code> the method name from the class that we are testing. Since the <code class="email">Shout</code> class has an execute method, the test method formed becomes test <code class="email">+</code> execute. By capitalizing the first letter of the class method name, the final name is <code class="email">testExecute</code>.</p><p class="calibre7">Now, let's go ahead and replace <code class="email">/* setUp()</code> code here <code class="email">*/</code> with content. as follows:</p><div class="informalexample"><pre class="programlisting">$request = $this-&gt;getMock(
    'Magento\Framework\App\Request\Http',
    [],
    [],
    '',
    false
);

$context = $this-&gt;getMock(
    '\Magento\Framework\App\Action\Context',
    ['getRequest'],
    [],
    '',
    false
);

$context-&gt;expects($this-&gt;once())
    -&gt;method('getRequest')
    -&gt;willReturn($request);

$this-&gt;resultPageFactory = $this-&gt; getMockBuilder ('Magento\Framework\View\Result\PageFactory')
    -&gt;disableOriginalConstructor()
    -&gt;setMethods(['create'])
    -&gt;getMock();

$this-&gt;controller = new \Foggyline\Unitly\Controller\Hello\Shout(
    $context,
    $this-&gt;resultPageFactory
);</pre></div><p class="calibre7">The whole<a id="id543" class="calibre1"/> concept of tests is based on mocking the objects that we need to work with. We use the <code class="email">getMock</code> method that returns a mock object for a specified class. Besides the class name, the <code class="email">getMock</code> method accepts quite a bit of other arguments. The second <code class="email">$methods</code> parameter marks the names of the methods that are replaced with a test double. Providing null for the <code class="email">$methods</code> parameter means that no methods will be replaced. The third parameter for the <code class="email">getMock</code> method stands for <code class="email">$arguments</code>, which are parameters that are passed to the original class constructor.</p><p class="calibre7">We can see from the preceding code that the <code class="email">$request</code> mock object does not provide any <code class="email">$methods</code> or <code class="email">$arguments</code> parameters to its <code class="email">getMock</code> method. On the other hand, the <code class="email">$context</code> object passes on the array with a single <code class="email">getRequest</code> element in it. Once the <code class="email">$context</code> object is initialized, it then calls the expects method, which registers a new expectation in the mock object and returns <code class="email">InvocationMocker</code> on which we call method and <code class="email">willReturn</code>. In this case, the instance on the previously initiated <code class="email">$request</code> object is passed to <code class="email">willReturn</code>. We used <code class="email">getMockBuilder</code> to create a <code class="email">Result\PageFactory</code> mock object and instantiated the <code class="email">Shout</code> controller action class, passing the context and result page mocks to it.</p><p class="calibre7">All the code in this <code class="email">setUp</code> method served a purpose in getting out the controller instance, which will be used in the <code class="email">testExecute</code> method.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip21" class="calibre1"/>Tip</h3><p class="calibre7">The <code class="email">final</code>, <code class="email">private</code>, and <code class="email">static</code> methods cannot be mocked. They are ignored by PHPUnit's test functionality because they retain their original behavior.</p></div><p class="calibre7">Let's go ahead and replace the <code class="email">/* testExecute()</code> code here <code class="email">*/</code> with content, as follows:</p><div class="informalexample"><pre class="programlisting">$title = $this-&gt; getMockBuilder('Magento\Framework\View\Page\Title')
    -&gt;disableOriginalConstructor()
    -&gt;getMock();
$title-&gt;expects($this-&gt;once())
    -&gt;method('set')
    -&gt;with('Unitly');

$config = $this-&gt; getMockBuilder('Magento\Framework\View\Page\Config')
    -&gt;disableOriginalConstructor()
    -&gt;getMock();
$config-&gt;expects($this-&gt;once())
    -&gt;method('getTitle')
    -&gt;willReturn($title);

$page = $this-&gt; getMockBuilder('Magento\Framework\View\Result\Page')
    -&gt;disableOriginalConstructor()
    -&gt;getMock();
$page-&gt;expects($this-&gt;once())
    -&gt;method('getConfig')
    -&gt;willReturn($config);

$this-&gt;resultPageFactory-&gt;expects($this-&gt;once())
    -&gt;method('create')
    -&gt;willReturn($page);

$result = $this-&gt;controller-&gt;execute();

$this-&gt;assertInstanceOf('Magento\Framework\View\Result\Page', $result);</pre></div><p class="calibre7">In the<a id="id544" class="calibre1"/> preceding code, we checked into the page title, page, and result page object. To get to the page title from within the controller code, we would normally use an expression such as <code class="email">$resultPage-&gt;getConfig()-&gt;getTitle()</code>. This expression involves three objects. The <code class="email">$resultPage</code> object calls the <code class="email">getConfig()</code> method, which returns the instance of the <code class="email">Page\Config</code> object. This object calls for the <code class="email">getTitle</code> method, which returns the instance of the <code class="email">Page\Title</code> object. Thus, we are mocking and testing all the three objects.</p><p class="calibre7">Now that we took a look at the controller test case, let's see how we can make one for the block class. Create an <code class="email">app/code/Foggyline/Unitly/Test/Unit/Block/Hello/ShoutTest.php</code> file with partial content, as follows:</p><div class="informalexample"><pre class="programlisting">namespace Foggyline\Unitly\Test\Unit\Block\Hello;

class ShoutTest extends \PHPUnit_Framework_TestCase
{
    /**
     * @var \Foggyline\Unitly\Block\Hello\Shout
     */
    protected $block;

    protected function setUp()
    {
        $objectManager = new \Magento\Framework\TestFramework\Unit \Helper\ObjectManager($this);
        $this-&gt;block = $objectManager-&gt; getObject('Foggyline\Unitly\Block\Hello\Shout');
    }

    public function testGreeting()
    {
        $name = 'Foggyline';

        $this-&gt;assertEquals(
            'Hello '.$this-&gt;block-&gt;escapeHtml($name),
            $this-&gt;block-&gt;greeting($name)
        );
    }
}</pre></div><p class="calibre7">Here, we<a id="id545" class="calibre1"/> have also defined the <code class="email">setUp</code> method and <code class="email">testGreeting</code>. The <code class="email">testGreeting</code> method is used as a test for the greeting method on the <code class="email">Shout</code> block class.</p><p class="calibre7">Conceptually, there is no difference between unit testing a controller, block, or model class. Therefore, we will omit the model unit test in this example. What's important for you to realize is that the test is what we make of it. Technically speaking, we can test a single method for various cases or just the most obvious one. However, to serve the purpose of the tests in a better way, we should test it for any possible number of result combinations.</p><p class="calibre7">Let's go ahead and create a <code class="email">dev/tests/unit/foggyline-unitly-phpunit.xml</code> file with content, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;phpunit  xsi:noNamespaceSchemaLocation="http://schema.phpunit.de /4.1/phpunit.xsd"
         colors="true"
         bootstrap="./framework/bootstrap.php"
        &gt;
    &lt;testsuite name="Foggyline_Unitly - Unit Tests"&gt;
        &lt;directory suffix="Test.php"&gt;
            ../../../app/code/Foggyline/Unitly/Test/Unit
        &lt;/directory&gt;
    &lt;/testsuite&gt;
    &lt;php&gt;
        &lt;ini name="date.timezone" value="Europe/Zagreb"/&gt;
        &lt;ini name="xdebug.max_nesting_level" value="200"/&gt;
    &lt;/php&gt;
    &lt;filter&gt;
        &lt;whitelist addUncoveredFilesFromWhiteList="true"&gt;
            &lt;directory suffix=".php"&gt;
                ../../../app/code/Foggyline/Unitly/*
            &lt;/directory&gt;
        &lt;/whitelist&gt;
    &lt;/filter&gt;
    &lt;logging&gt;
        &lt;log type="coverage-html" target="coverage_dir/Foggyline_Unitly/test- reports/coverage" charset="UTF-8" yui="true" highlight="true"/&gt;
    &lt;/logging&gt;
&lt;/phpunit&gt;</pre></div><p class="calibre7">Finally, we <a id="id546" class="calibre1"/>can execute only our own module unit tests by running a command such as <code class="email">phpunit -c foggyline-unitly-phpunit.xml</code>.</p><p class="calibre7">Once tests are executed, we should be able to see the entire code coverage report in the <code class="email">dev/tests/unit/coverage_dir/Foggyline_Unitly/test-reports/coverage/index.html</code> file, as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00094.jpeg" alt="Writing a simple unit test" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">The preceding screenshot demonstrates how detailed the code coverage is, which shows even the <a id="id547" class="calibre1"/>percentages and lines of code covered with test.</p></div>
<div class="book" title="Summary" id="2MP361-818f5224668745eb9070ddf1d85e6bfa"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec84" class="calibre1"/>Summary</h1></div></div></div><p class="calibre7">In this chapter, we took a look at the testing facility embedded in Magento through the libraries in the root <code class="email">dev/tests/ directory</code> and the <code class="email">Magento_Developer</code> module. We learned how to run all of its test types and studied a simple example of writing our own unit tests. The examples that are given here do not do justice to PHPUnit, given its robustness. More information on PHPUnit can be found at <a class="calibre1" href="https://phpunit.de/">https://phpunit.de/</a>.</p><p class="calibre7">We will now move on to the final chapter of this book, where we will reiterate the things that we learned so far and develop a functional miniature module that involves some basic testing.</p></div></body></html>