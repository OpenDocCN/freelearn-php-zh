<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Code Quality Analysis"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Code Quality Analysis</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Mess detector and PhpStorm</li><li class="listitem" style="list-style-type: disc">Code sniffer and PhpStorm</li><li class="listitem" style="list-style-type: disc">Locating code duplicates</li><li class="listitem" style="list-style-type: disc">Code formatting and arrangement</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec98"/>Introduction</h1></div></div></div><p>Engineering is beautiful. The beauty of engineering lies in the fact that it leaves no stone unturned and no path uncovered while carrying out even the simplest of tasks. Tasks that might appear too trivial for the lay person—even they are taken care of by engineering; software engineering, contextual.</p><p>You will agree that time matures you. Do you remember what your attitude used to be when you were a novice software engineer and when you were presented with a (programming) problem to solve? You started making plans using your infant knowledge about what the actual <span class="emphasis"><em>code</em></span> would be like. So childish, right? As time progressed and you started gaining experience, you started using a scratchpad-like thing to first plan using primitive sketching techniques to visualize the flow of the algorithm. This was where you started feeling the need for engineering diagrams. You started learning UML—the mother of all modeling languages and the very basis of software engineering.</p><p>Time kept on taking you through the tough lessons of life. In due course, you realized that without following engineering principles, it was easy to start moving forward, but the way was one-sided and one-directional. Once you are required to go back and fix mistakes that you, as a human, have committed, the action can take you into a state of limbo where no one obeys the law of gravity. So, you and software engineering became friends, and life became much easier.</p><p>So far, so good.</p><p>If it is said that you can know a lot more about your close friend—software engineering—it is not incorrect or inappropriate. Software engineering not only helps you in maintaining ethics while designing a system but also keeps a track of the code you write. The number of lines of code you write, for example, can be one metric to determine the cost of software (considering that a line of code costs a fixed amount of money). The variable names in your code need to follow a strict standard. Why? It has to be a human being only who will be required to go through the code once some modification becomes the need of the hour. Since change is inevitable, the odds in favor of this event happening are high.</p><p>To sum it up, software engineering<a id="id522" class="indexterm"/> provides you with systems to perform analysis on this aspect of your software application as well. This process is known as <a id="id523" class="indexterm"/>
<span class="strong"><strong>code quality assurance</strong></span> since you are able to create code that is readable and hence maintainable. The systems available for you to achieve this milestone are known as <span class="strong"><strong>PHP Mess Detector</strong></span> (<span class="strong"><strong>PHPMD</strong></span>) and <span class="strong"><strong>PHP Code Sniffer</strong></span> (<span class="strong"><strong>PHPCS</strong></span>). PHPMD<a id="id524" class="indexterm"/> literally identifies and inspects the mess that a team member has done in the code base and provides warnings, error messages, and indications to not only clean up the messy code but also attempts to keep the code base clean. Code Sniffer acts as a sniffer dog and barks whenever it detects potential bugs in the code base. It is not that the combination of your eye and brain would be unable to detect simple errors in the code, but there are plural incidents in the development phase where you, as a tired software engineer, might commit very simple mistakes. With the passage of time, such mistakes grow to become a mysterious bug probably extremely hard to crack. PHPCS<a id="id525" class="indexterm"/> proves helpful in curbing such mistakes.</p><p>A question that is very obvious to ask: where is PhpStorm in the scene? The answer to this is that PhpStorm is always at your disposal. How? The two systems mentioned are used in conjunction with PhpStorm to wreak havoc on the bugs that attempt to creep into the development phase and keep on bugging you for long and sometimes extended periods of time. A waste of your bandwidth and thus decrease in morale—your manager will not let you go that easily till you are able to debug your application.</p></div></div>
<div class="section" title="Mess detector and PhpStorm"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec99"/>Mess detector and PhpStorm</h1></div></div></div><p>PhpStorm<a id="id526" class="indexterm"/> is an obedient and diligent slave of yours. It ensures that none of your efforts get classified as scratchy or unengineered. How? It provides you with facilities to integrate systems, which in turn help you in letting your efforts achieve engineering maturity. You must be getting anxious as to which system is being talked about here. So, you can put your hands together for the mess detector known as<a id="id527" class="indexterm"/> PHPMD. A simple acronym, indeed. It is not that PhpStorm takes away all the due credit of removing the mess from your code, but yes, PhpStorm makes a provision for you to find out the appropriate version, download, integrate, and then start planning what to do. And then? Then what? Just sit back and let PhpStorm and mess detector collaborate and perform the tasks for you.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec230"/>Getting ready</h2></div></div></div><p>You need to have information about the latest (and stable) release of PHPMD. You can simply search it on the Internet via any popular search engine. The official<a id="id528" class="indexterm"/> website (<a class="ulink" href="http://phpmd.org/">http://phpmd.org/</a>) provides you with information about the downloading methods available. Since you have a good taste for PHP archives, you can get phar<a id="id529" class="indexterm"/> from the URL <a class="ulink" href="http://static.phpmd.org/php/1.4.1/phpmd.phar">http://static.phpmd.org/php/1.4.1/phpmd.phar</a> (this was the latest phar available at the time of writing). Just like other archives, you need not take any other action—only this download will suffice with the executable.</p><p>When you talk about <a id="id530" class="indexterm"/>executables, since <code class="literal">*nix</code> systems treat all files that have been <a id="id531" class="indexterm"/>downloaded from external sources as read-only, it is your duty to check the access permissions on phar. In most cases, a downloaded file reads permissions only for the sake of security. You need to be wise enough to downgrade the permissions to allow appropriate access to this archive. On <code class="literal">*nix</code> systems, there is this command available, <code class="literal">chmod</code>, using which you can play around with the access permissions on a specified file or a folder. Thus (using <code class="literal">chmod</code>), you can probably set <code class="literal">766</code> as the permission string for this archive.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec231"/>How to do it…</h2></div></div></div><p>Now comes the important part—you need to tell PhpStorm about PHPMD. This is one configuration that you really need to ensure is in place. The reason for this being the beginning of PhpStorm is for PhpStorm to know that it has got a new member and thus needs to take the appropriate action accordingly. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">You need to select <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Settings</strong></span> | <span class="strong"><strong>PHP</strong></span> | <span class="strong"><strong>Mess Detector</strong></span> and set the path of phar you just downloaded (or maybe borrowed from a friend), as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3878OT_09_01.jpg" alt="How to do it…"/></div></li><li class="listitem">Validate the work <a id="id532" class="indexterm"/>you did. Don't worry. PhpStorm will help <a id="id533" class="indexterm"/>you as there is a provision to check for the configuration to be proper via the <span class="strong"><strong>Validate</strong></span> button. If you have done everything correctly, you will get a green signal from PhpStorm, indicating the name of the software (<span class="strong"><strong>PHPMD</strong></span>), its author, and the version number, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3878OT_09_02.jpg" alt="How to do it…"/></div></li><li class="listitem">You need to<a id="id534" class="indexterm"/> configure the options available for PHPMD in <a id="id535" class="indexterm"/>PhpStorm. The settings are available at <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Settings</strong></span> | <span class="strong"><strong>Inspections</strong></span>.</li><li class="listitem">Turn on inspections.</li><li class="listitem">Configure inspections by opening the settings wizards at <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Settings</strong></span> | <span class="strong"><strong>Inspections</strong></span> and selecting the checkbox next to the <span class="strong"><strong>PHP Mess Detector</strong></span> validation.</li><li class="listitem">There is a certain predefined set of rules; you need to select some or all of them depending on your requirement. So, you can select one or all of the code-validation rules and proceed with writing the code. That is it. The following screenshot shows the <span class="strong"><strong>Inspections</strong></span> page:<div class="mediaobject"><img src="graphics/3878OT_09_03.jpg" alt="How to do it…"/></div><p>PHPMD will <a id="id536" class="indexterm"/>continue doing its work in the background<a id="id537" class="indexterm"/> and will keep on showing you errors and warnings as you keep on writing code. The notifications are classified according to the way you configured it.</p></li><li class="listitem">To configure the notifications, you need to select the individual rule and make changes in the color, font, and so on, as required. The following screenshot shows how the Edit Settings\Colors &amp; Fonts tab looks on the Severities Editor page:<div class="mediaobject"><img src="graphics/3878OT_09_04.jpg" alt="How to do it…"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec232"/>How it works…</h2></div></div></div><p>Getting PHPMD to work is no difficult task. All you need to do is make a few settings and resume doing your favorite work—writing code. However, since you are an engineer, you should be keen to know exactly what goes on under the hood that keeps you going.</p><p>By default, PHPMD follows some rules. These rules were made while keeping in mind the principles of software <a id="id538" class="indexterm"/>engineering. There are rules to keep a check on:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Code size rules</strong></span>: From time to time<a id="id539" class="indexterm"/> events occur which need you to keep a check on the size of the code. It is important to say that you write not only to write, but also to read it later and maintain it. One very important factor is the size of the code and the complexity associated with it.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Cyclomatic complexity</strong></span>: Theoretically, a<a id="id540" class="indexterm"/> flow graph needs to be drawn to denote the algorithm in question, then the edges, the nodes, and the exit points are counted, and then the resulting number is obtained by edge count—node count plus the exit point count in the flow graph.<p>PHPMD abstracts these details in its implementation. It takes into account the number of decision points, such as the loop constructs—if, for, while, case—and calculates the complexity as the number of decision points in the code plus 1 (one) for the entry point of the method.</p></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Npath complexity</strong></span>: Then, there is <a id="id541" class="indexterm"/>Npath complexity, which PHPMD takes care of. Npath is the number of possible outcomes in your code. It can be the cases under which the code produces output. So, PHPMD decides that a limit of 200 is OK for a code to be healthy. This means that your code (method) can have a maximum of 200 outcomes if your method is quality code.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Excessive method length rule</strong></span>: PHPMD <a id="id542" class="indexterm"/>puts a restriction on the length of the method by counting the number of lines of code in it. This one is known as the excessive method length rule. So, if a method's lines of code count exceeds 100, that method violates this restriction, and PHPMD indicates to you in the form of a warning or whatever you configured it to be:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If the number of <a id="id543" class="indexterm"/>lines of code in your class exceeds 1,000, you need to refactor the class you have written. Who said this? The PHPMD excessive class length restriction.</li><li class="listitem" style="list-style-type: disc">If the number of parameters declared exceed 10, PHPMD will notify you to reduce the number of arguments to less than 10. You can then try passing an object containing the like arguments in one single object. This rule is known as the excessive parameter list restriction.</li><li class="listitem" style="list-style-type: disc">If there are too many public members inside a class, PHPMD treats it as bad quality and reports it to you via PhpStorm. The too-many factor is set to a default value of 45, exceeding which PHPMD starts treating your code as bad code.</li><li class="listitem" style="list-style-type: disc">Having too many private or protected members is not treated as good, either. If there are more than 15 such members, or fields, to be more technical, PHPMD notifies you. You need to restructure your class to have fewer fields. Why not try using composition? The <span class="emphasis"><em>has-a</em></span> relationship... Remember?</li><li class="listitem" style="list-style-type: disc">If you have a little too many methods in a class that you wrote, beware. PHPMD will treat it as bad-quality code and will indicate that you need to refactor the class to have fewer methods in the class. The threshold is 10.</li></ul></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Controversial rules</strong></span>: PHPMD treats code as <a id="id544" class="indexterm"/>bad-quality code when:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You have access to a <span class="emphasis"><em>super global array</em></span> directly without encapsulating in some object.</li><li class="listitem" style="list-style-type: disc">You do not use the camel case to name classes, class members, and whatever variables you use in your code.</li></ul></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Design rules</strong></span>: Code written in<a id="id545" class="indexterm"/> PHP will be a candidate for bad code when:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You have exit points in your code within regular code, such as exit points without exception / error handling lines.</li><li class="listitem" style="list-style-type: disc">You love using <code class="literal">eval</code> in your code.</li><li class="listitem" style="list-style-type: disc">You find using <code class="literal">goto</code> in your code enjoyable.</li><li class="listitem" style="list-style-type: disc">You have created <a id="id546" class="indexterm"/>a few too many children of a class. Fifteen is the threshold for PHPMD.</li><li class="listitem" style="list-style-type: disc">You have created a class hierarchy in which a class inherits more than six parent classes.</li></ul></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Naming rules</strong></span>: PHPMD will also <a id="id547" class="indexterm"/>frown and thus indicate that the code is bad when:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A variable name is too long or too short. A name is too long when it is greater than 20 characters in length and too short when it is less than three characters in length. Really short!</li><li class="listitem" style="list-style-type: disc">A method name is too short to be understood. A name is too short when it is less than three characters in length.</li><li class="listitem" style="list-style-type: disc">The constructor uses the name of the enclosing class.</li><li class="listitem" style="list-style-type: disc">The constants in the class are written in lower case with words separated by an underscore (<code class="literal">_</code>).</li></ul></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Unused code rules</strong></span>: Leaving the<a id="id548" class="indexterm"/> code unused is not looked upon by PHPMD with high regard. According to PHPMD, code is bad when:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You have declared, and/or assigned a value to a local variable or a private field.</li><li class="listitem" style="list-style-type: disc">You have declared and/or defined a method but have not used it.</li><li class="listitem" style="list-style-type: disc">You have declared a formal parameter to a method but haven't used it.</li></ul></div><p>Here is PHPMD in action. You can see how PHPMD provides errors and warnings as you keep on writing the code:</p><div class="mediaobject"><img src="graphics/3878OT_09_05.jpg" alt="How it works…"/></div></li></ul></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec233"/>There's more...</h2></div></div></div><p>If you are convinced that the predefined rulesets are not sufficient to support your cause, you can have your own version of the ruleset file added to PhpStorm. All you need to do is create a new <a id="id549" class="indexterm"/>XML file, name it reasonably, and ask PhpStorm to incorporate the file, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/3878OT_09_06.jpg" alt="There's more..."/></div><p>Your ruleset file looks somewhat<a id="id550" class="indexterm"/> like the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;ruleset name="test-ruleset"


xsi:schemaLocation="http://pmd.sf.net/ruleset/1.0.0 http://pmd.sf.net/ruleset_xml_schema.xsd"
xsi:noNamespaceSchemaLocation="http://pmd.sf.net/ruleset_xml_schema.xsd"&gt;
&lt;description&gt;A custom ruleset – You can do wonders with this.
&lt;/description&gt;
&lt;rule ref="rulesets/codesize.xml/TooManyFields"/&gt;
&lt;/ruleset&gt;</pre></div><p>The actual detection is done when you write <code class="literal">&lt;rule ref="rulesets/codesize.xml/TooManyFields"/&gt;</code> because it is this line that selects which option should be turned on for PHPMD. The other lines written at the beginning—you need not boggle your mind—just comprise the basic skeleton part. The best part of the story is that <a id="id551" class="indexterm"/>you need not remember the lines: you can just copy the lines from here and paste it to any <code class="literal">ruleset.xml</code> that you wish. The only thing you need to remember is the exact name of the rule that you wish to apply.</p></div></div>
<div class="section" title="Code sniffer and PhpStorm"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec100"/>Code sniffer and PhpStorm</h1></div></div></div><p>Have you noticed why defense personnel keep sniffer dogs? No? The purpose of the sniffer dogs is to sniff items around and detect for any illegal items present in those items. You might wonder how a dog decides which one is illegal and which one is legal, and even if it does that, how can it inform the humans about the validity of the item. A dog just knows how to bark: it barks at both times, happy or sad. Everything said and done, the question still remains. How does a dog know about an illegal object?</p><p>The answer is straight, abrupt, and terse: a dog is <span class="emphasis"><em>configured</em></span> or trained to do that.</p><p>You have PhpStorm, right? You have been using it for all your programming needs, right? You can similarly use PhpStorm to sniff your code and inform you if the code contains some coding standard violation. The system that provides this functionality to PhpStorm is PHPCS or PHP Code Sniffer.</p><p>PHP Code Sniffer is a PHP5 script that tokenizes PHP, JavaScript, and CSS files to detect violations of a defined coding standard. It is an essential development tool that ensures that your code remains clean and consistent. It can also help prevent common semantic errors made by developers.</p><p>PHPCS <a id="id552" class="indexterm"/>is an application written in PHP that can be configured with a predefined or custom set of coding rules. It detects possible inconsistency and unclean code and thus does not allow common semantic errors to pass through in the production code.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec234"/>Getting ready</h2></div></div></div><p>Before you even plan to start<a id="id553" class="indexterm"/> code-sniffing, you need to download PHPCS as <code class="literal">.tgz</code> so that you<a id="id554" class="indexterm"/> have the installation file ready in your local system. The <a id="id555" class="indexterm"/>file can be downloaded from <a class="ulink" href="http://download.pear.php.net/package/PHP_CodeSniffer-2.0.0a2.tgz">http://download.pear.php.net/package/PHP_CodeSniffer-2.0.0a2.tgz</a>. After this, comes the installation. The PHPCS installation is quite simple in PhpStorm (just as easy as the other actions are). You need to perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Extract the contents of the tgz file you downloaded to a convenient location on your development machine—usually the computer where you play around with PhpStorm.</li><li class="listitem">Inside the extracted directory, locate the <code class="literal">phpcs</code> file, which is a script written in PHP. This would most probably be inside the scripts directory.</li><li class="listitem">Check whether the permissions set on the executable are sufficient to allow PhpStorm to use it. If you find something doubtful, set the permission to <code class="literal">755</code> on this PHPCS file.</li><li class="listitem">Carry out the most<a id="id556" class="indexterm"/> important step. You need to tell PhpStorm that there is <a id="id557" class="indexterm"/>PHPCS available. For that, you need to select <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Settings</strong></span> | <span class="strong"><strong>Code Sniffer</strong></span> and set the path to this PHPCS, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3878OT_09_07.jpg" alt="Getting ready"/></div></li><li class="listitem">Validate that the settings have been made properly and that everything is OK in there, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3878OT_09_08.jpg" alt="Getting ready"/></div></li></ol></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec235"/>How to do it…</h2></div></div></div><p>Having configured the code sniffer system with PhpStorm, you don't have to bother about how to make PHPCS work. It <a id="id558" class="indexterm"/>just works in the background with the default<a id="id559" class="indexterm"/> inspection system provided. However, you need to turn it on. The code sniffing process can be started by selecting the inspection option available for PHPCS:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the bottom-right corner, there is this inspection icon available. You need to click on it and click on the <span class="strong"><strong>Configure inspection</strong></span> option available, or the same option can be availed of by selecting <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Settings</strong></span> | <span class="strong"><strong>Inspections</strong></span>.</li><li class="listitem">You need to select the PHP inspection tree, and inside it, the <span class="strong"><strong>PHP Code Sniffer Validation</strong></span> option has to be selected.</li><li class="listitem">Next to the coding standard, there is a dropdown. You need to select one of the available values.</li><li class="listitem">If you add more values to PHPCS, you need to refresh the list of available standards. The refresh is confirmed by a message, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3878OT_09_09.jpg" alt="How to do it…"/></div></li><li class="listitem">Having done that, you can now focus on writing business logic for the organization you work for. PHPCS will continue in the background and will keep on showing errors as you proceed. One of the errors is shown in the following screenshot:<div class="mediaobject"><img src="graphics/3878OT_09_10.jpg" alt="How to do it…"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec236"/>How it works…</h2></div></div></div><p>The working of PHPCS<a id="id560" class="indexterm"/> is not very difficult to understand—especially for people such as you, who are (already) familiar with systems like PHPMD (it's another code quality assurance tool, just in case you were not familiar with it. Pun intended!). PHPCS also understands XML, and PHPCS also has inbuilt or precooked rules. This is clearly visible when you integrate PHPCS with PhpStorm. There are coding standards available to you via a dropdown containing these default values. This dropdown is available with the label <span class="strong"><strong>Coding Standard:</strong></span> The PHPCS system obeys the standards and checks your code as you open it.</p><p>So far, so good. The actual nuts and bolts are located in the <code class="literal">ruleset.xml</code> file. No, no, it is not a typographical error as a result of engineered copy-pasting! The <code class="literal">ruleset.xml</code> file follows certain standards during creation. The rules that drive PHPCS are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Due to its being an XML, the most important line to be added is the XML version:<div class="informalexample"><pre class="programlisting">&lt;? Xml version="1.0"?&gt;</pre></div></li><li class="listitem" style="list-style-type: disc">The parent node of all the nodes in the ruleset is the <code class="literal">ruleset</code> node. The name attribute makes the node known by a name to PhpStorm:<div class="informalexample"><pre class="programlisting">&lt;ruleset name="PHP Code Sniffer Standard"&gt;</pre></div></li><li class="listitem" style="list-style-type: disc">There can be a description node that contains the description of the standard under construction:<div class="informalexample"><pre class="programlisting">&lt;description&gt;A custom coding standard&lt;/description&gt;</pre></div></li><li class="listitem" style="list-style-type: disc">Then comes the actual rule. PHPCS can accept external references to a rule that someone else might have created:<div class="informalexample"><pre class="programlisting">&lt;rule ref="/path/to/some/persons/ruleset.xml"/&gt;</pre></div></li><li class="listitem" style="list-style-type: disc">There can be a directory that contains code standards in the form of the PHP class hierarchy:<div class="informalexample"><pre class="programlisting">&lt;rule ref="/full/path/to/standard-classes/"/&gt;</pre></div></li><li class="listitem" style="list-style-type: disc">Or, there might be a reference to a well-known coding standard, such as PEAR or Zend:<div class="informalexample"><pre class="programlisting">&lt;rule ref="PEAR"/&gt;</pre></div></li><li class="listitem" style="list-style-type: disc">Some of the default standards are included as shown in the following code:<div class="informalexample"><pre class="programlisting">&lt;rule ref="Generic.Files.LineLength.TooLong"&gt;
&lt;message&gt;Line longer than %s characters; contains %s characters&lt;/message&gt;

&lt;/rule&gt;</pre></div><p>Alternatively, it can have the following code too:</p><div class="informalexample"><pre class="programlisting">&lt;rule ref="Generic.File.LineEndings"&gt;
  &lt;properties&gt;
    &lt;property name="eolChar" value="\r\n"/&gt;
  &lt;/properties&gt;
&lt;/rule&gt;</pre></div></li></ul></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec237"/>There's more...</h2></div></div></div><p>Since the standards are <a id="id561" class="indexterm"/>defined in the form of the PHP class hierarchy, the inclusion also respects the hierarchical pattern in the <code class="literal">ref</code> attribute. So, the actual class that is referenced is the <code class="literal">Generic_Sniffs_Files_LineEndingsSniff</code> class defined inside the directory <code class="literal">/path/to/PHP_CodeSniffer/CodeSniffer/Standards/Generic/Sniffs/FilesLineEndingsSniff.php</code> under Version 2.0.0a2. The property being tried to be set in the class is the <code class="literal">eolChar</code>, which happens to be a public and string type member of the class.</p><p>You can find a sample ruleset file<a id="id562" class="indexterm"/> at <a class="ulink" href="http://pear.php.net/manual/en/package.php.php-codesniffer.annotated-ruleset.php">http://pear.php.net/manual/en/package.php.php-codesniffer.annotated-ruleset.php</a>.</p></div></div>
<div class="section" title="Locating code duplicates"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec101"/>Locating code duplicates</h1></div></div></div><p>Business needs money, money<a id="id563" class="indexterm"/> needs engineering, engineering needs a plan, and the plan needs time. Since business needs money, and time is money, business does not want to waste time. Spending time means spending money, and all (software) businesses assume that money spent is money lost. Since business spends money sparingly, engineering resorts to code reuse. But then, the customer needs quality—after all, the customer has paid a (huge) sum of money to get the work done. This is a vicious circle.</p><p>When the engineering team is short of time, the challenge ahead is always to ensure that the copy-paste tasks are under control without side effects. Under control means that the software is able to do the expected work. The side effects are duplicate sections in the software, which can potentially lead to increases in the lines of code.</p><p>The situation seems grim!</p><p>You must remember PhpStorm at all times in your coding lifespan—whether you are having leisure or trouble. PhpStorm always has something or other for you. This time, PhpStorm will take you out of this vicious circle. There is a feature available that allows you to scan through your code and locate the duplicate code.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec238"/>How to do it…</h2></div></div></div><p>To effectively locate <a id="id564" class="indexterm"/>duplicates in the code, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">You need to select <span class="strong"><strong>Code</strong></span> | <span class="strong"><strong>Locate Duplicates</strong></span> from the main menu. You will get a pop up that is the selection-making point for you, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3878OT_09_11.jpg" alt="How to do it…"/></div></li><li class="listitem">The default selection is <span class="strong"><strong>Whole project</strong></span>. You have the option to find code duplicates in the whole project.</li><li class="listitem">You can also set the criteria to work on the type or category of files according to the development cycle phase. You can choose <span class="strong"><strong>Uncommitted files</strong></span> to locate duplicates in the code that you have not committed yet. This can be a good idea to improve code quality.</li><li class="listitem">You can select the currently open file in the editor to work on locating the duplicate. PhpStorm also provides you with the option to set a custom scope of locating duplicates:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Project test files</strong></span>: This is <a id="id565" class="indexterm"/>used when you want to locate the duplicate code fragments in the test files that you created for the project. This can be handy when you have a large number of test cases (PHPUnit test cases, to be precise).</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Open files</strong></span>: When you need <a id="id566" class="indexterm"/>to select the open files in the editor, PhpStorm will set the scope of duplicate search as the open files only.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Module</strong></span>: When you want to<a id="id567" class="indexterm"/> analyze the non-project files, such as the libraries or the software development kits (SDKs), PhpStorm provides you with a facility by allowing this option.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Current file</strong></span>: When you are<a id="id568" class="indexterm"/> quite sure that you want only the file that is currently open and is being actively viewed, PhpStorm provides you with this feature.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Selected files</strong></span>: When you<a id="id569" class="indexterm"/> need to select a few files from the Project view, PhpStorm will set the scope of duplicate search as the selected files only.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Changed files</strong></span>: Being an<a id="id570" class="indexterm"/> experienced professional, you might need to review the code written by fellow developers. This option comes in handy for files that are changed and are yet to be committed to the code repository.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Default</strong></span>: This is used <a id="id571" class="indexterm"/>when you want to look for possible duplicates in the <a id="id572" class="indexterm"/>default change list for the changes to be put into the code repository.</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note35"/>Note</h3><p>You can separately include or exclude the test sources for the duplicate analysis.</p></div></div></li><li class="listitem">Code duplication analysis settings define the sensitivity of the search and set limitations that help avoid reporting about every similar code construct. The following screenshot shows the code duplicate analysis settings:<div class="mediaobject"><img src="graphics/3878OT_09_12.jpg" alt="How to do it…"/></div></li><li class="listitem">You can anonymize the functions, variables, and literals to save the memory heap.</li><li class="listitem">PhpStorm can be<a id="id573" class="indexterm"/> told to limit the duplication analysis settings to dig only that block of code that is bigger than a particular size. The default size is 10.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec239"/>How it works…</h2></div></div></div><p>The answer to this question is honestly! Code duplication works honestly and finds out the duplications in code. So, after you invoke the duplicate code finder, it finds the occurrences in the file that have duplicate code. The duplicate code block is found out on the basis of the filtering that you specified in the settings (see the <span class="emphasis"><em>How to do it…</em></span> section), as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/3878OT_09_13.jpg" alt="How it works…"/></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec240"/>There's more...</h2></div></div></div><p>The concept of duplication in code needs to be understood quite clearly to have an insight into the working of the duplication analysis. When is a block of code eligible to be termed as duplicate? The answer: when there are plural instances of the same lines of code rewritten for different purposes. Due to the pressure from the business end, you might get a feeling that your task will be completed in time if you copy and paste the same code for various tasks, but PhpStorm frowns on this attitude. Whenever code gets repeated, the <span class="emphasis"><em>DRY</em></span> principle gets violated. Whenever the DRY principle gets violated, software engineering demands you to ensure code reusability. The most common way is to write classes and methods <a id="id574" class="indexterm"/>appropriately. Since PhpStorm is a great soldier fighting to keep the principles of software engineering upright, to ensure this cause, the duplication analysis lists all such occurrences in a dedicated code duplication window.</p></div></div>
<div class="section" title="Code formatting and arrangement"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec102"/>Code formatting and arrangement</h1></div></div></div><p>A PhpStorm cookbook author says, "Merely writing code does not make you a software engineering warrior—an engineer becomes a Ninja when the code works and the person on the adjacent seat can make some sense out of it."</p><p>People might argue over this<a id="id575" class="indexterm"/> statement's validity. But since there is a general trend among<a id="id576" class="indexterm"/> engineers to develop dissatisfaction from their jobs, it becomes quite important for you, the senior software developer in the team, to have control over the way the code is written. Of course, it is your responsibility!</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec241"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">When you have got the determination to ensure that the written code has to be properly formatted, you need to select <span class="strong"><strong>Code</strong></span> | <span class="strong"><strong>Reformat Code</strong></span> from the main menu.</li><li class="listitem">Like always, there will be a pop-up window for you to make selections. Quite happily, you can do wonders with this pop-up window, which is shown in the following screenshot:<div class="mediaobject"><img src="graphics/3878OT_09_14.jpg" alt="How to do it…"/></div></li><li class="listitem">The default selection will <a id="id577" class="indexterm"/>format the currently selected file. Perform the<a id="id578" class="indexterm"/> following steps to obtain the required results:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">If you select text, PhpStorm will format the selected text only if the <span class="strong"><strong>Selected text</strong></span> option is provided.</li><li class="listitem">You can select all files in a particular folder when you select all files in the <span class="strong"><strong>...</strong></span> option. You can select the subdirectories inside the selected directory by selecting the checkbox adjacent to <span class="strong"><strong>Include subdirectories</strong></span>.</li><li class="listitem">You can <span class="strong"><strong>Optimize imports</strong></span> by removing the imports that are not required by the code.</li><li class="listitem">You can rearrange the import entries in the target code by selecting the <span class="strong"><strong>Rearrange entries</strong></span> option. <span class="strong"><strong>Rearrange entries</strong></span> will rearrange the order in which the elements in the code will appear.</li><li class="listitem">You can also reformat only the text that has been changed from Subversion by selecting <span class="strong"><strong>Only VCS changed text</strong></span>.</li><li class="listitem">On selecting the <span class="strong"><strong>Run</strong></span> button, the code formatting process does its work.</li></ol></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec242"/>How it works…</h2></div></div></div><p>The formatting system works by respecting the settings you have specified in <span class="strong"><strong>Code style</strong></span> | <span class="strong"><strong>PHP</strong></span>. You can control <span class="strong"><strong>Tabs and Indents</strong></span> by selecting the tab, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/3878OT_09_15.jpg" alt="How it works…"/></div><p>The spaces to be given in the <a id="id579" class="indexterm"/>code are controlled by the <span class="strong"><strong>Spaces</strong></span> tab in the <span class="strong"><strong>Settings</strong></span> panel, as shown<a id="id580" class="indexterm"/> in the following screenshot:</p><div class="mediaobject"><img src="graphics/3878OT_09_16.jpg" alt="How it works…"/></div><p>The wrappings and braces in the code are controlled by the <span class="strong"><strong>Wrapping and Braces</strong></span> tab, as shown in the following screenshot. This tab specifies where the text will be wrapped in the code and where the braces will be formatted in the target code.</p><div class="mediaobject"><img src="graphics/3878OT_09_17.jpg" alt="How it works…"/></div><p>The blank lines are inserted at <a id="id581" class="indexterm"/>appropriate places in the code when the specifications are made<a id="id582" class="indexterm"/> in the <span class="strong"><strong>Blank Lines</strong></span> tab, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/3878OT_09_18.jpg" alt="How it works…"/></div><p>The PHPDoc can be formatted as well.. Remember this setting?</p><div class="mediaobject"><img src="graphics/3878OT_09_19.jpg" alt="How it works…"/></div><p>Code formatting involves <a id="id583" class="indexterm"/>miscellaneous settings available under the <span class="strong"><strong>Other</strong></span> tab. This provides the <a id="id584" class="indexterm"/>general settings that are not categorized under other categories. The settings behind the code formatting found under the <span class="strong"><strong>Other</strong></span> tab are shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/3878OT_09_20.jpg" alt="How it works…"/></div><p>The arrangement <a id="id585" class="indexterm"/>of class members gets driven by the settings available under the <a id="id586" class="indexterm"/>
<span class="strong"><strong>Arrangement</strong></span> tab. The order in which the elements in the code are to be arranged is available under this tab. You can save the settings with the <span class="strong"><strong>Manage</strong></span> button and can use it in other projects as well. If you already are in that "other" project, you need to select the text in blue <span class="strong"><strong>Set from...</strong></span> to select the already-set formatting rule, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/3878OT_09_21.jpg" alt="How it works…"/></div><p>All done. Happy code formatting!</p><p>As a last word before leaving the kitchen, we, the authors, want to state that since knowledge is something that always keeps evolving, you, the (senior) software developer should not limit yourself to a limited set of knowledge resources. As an implementation of this rule, we plan to work on adding many more recipes that definitely were skipped due to deadline limitations. You can continue to follow the updates in the PhpStorm community; in the meantime, the authors will continue to work on PhpStorm to bring out more interesting and tasty dishes for you.</p><p>This is not the end, but the beginning of something more and something that is of the type <span class="emphasis"><em>NeverBefore</em></span>. PhpStorm rocks!</p></div></div></body></html>