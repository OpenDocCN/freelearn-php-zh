<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Performance Tuning"><div class="titlepage" id="2UD7M2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Performance Tuning</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Following best practices</li><li class="listitem">Speeding up session handling</li><li class="listitem">Using cache dependencies and chains</li><li class="listitem">Profiling an application with Yii</li><li class="listitem">Leveraging HTTP caching</li><li class="listitem">Combining and minimizing assets</li><li class="listitem">Running Yii2 on HHVM</li></ul></div><p>Yii is one of the fastest frameworks available. Nevertheless, when developing and deploying an <a class="indexterm" id="id653"/>application, it is good to have some extra performance for free, and to follow the best practices for the application itself. In this chapter, you will see how to configure Yii to gain extra performance. In addition, you will learn some best practices for developing an application that will run smoothly until you have very high loads.</p><div class="section" title="Following best practices"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec93"/>Following best practices</h1></div></div></div><p>In this recipe, you <a class="indexterm" id="id654"/>will see how to configure Yii2 for the best performance and some additional principles of building responsive applications. These principles are both general and Yii-related. Therefore, we will be able to apply some of these even without using Yii2.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec330"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guidestart-installation.html">http://www.yiiframework.com/doc-2.0/guidestart-installation.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec331"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Update your PHP to the latest stable version. Major releases of PHP may bring significant <a class="indexterm" id="id655"/>performance improvements. Turn off the debug mode and set the <code class="literal">prod</code> environment. This can be done by editing <code class="literal">web/index.php</code> as follows:<div class="informalexample"><pre class="programlisting">defined('YII_DEBUG') or define('YII_DEBUG', false);
defined('YII_ENV') or define('YII_ENV', 'prod');</pre></div><div class="note" title="Note"><h3 class="title"><a id="note16"/>Note</h3><p>
<span class="strong"><strong>Note</strong></span>: In the <code class="literal">yii2-app-advanced</code> application skeleton, you can use the shell command <code class="literal">php init</code> and opt production environment for loading optimized <code class="literal">index.php</code> and configuration files.</p></div></li><li class="listitem">Enable the <code class="literal">cache</code> component:<div class="informalexample"><pre class="programlisting">'components' =&gt; [
    'cache' =&gt; [
        'class' =&gt; 'yii\caching\FileCache',
    ],
],</pre></div><p>You can use any cache storage instead of <code class="literal">FileCache</code>. Also, you can register multiple cache application components and use <code class="literal">Yii::$app-&gt;cache</code> and <code class="literal">Yii::$app-&gt;cache2</code> for different data types:</p><div class="informalexample"><pre class="programlisting">'components' =&gt; [
    'cache' =&gt; [
        'class' =&gt; 'yii\caching\MemCache',
        'useMemcached' =&gt; true,
    ],
    'cache2' =&gt; [
        'class' =&gt; 'yii\caching\FileCache',
    ],
],</pre></div><p>The framework uses the <code class="literal">cache</code> component by default in its own classes.</p></li><li class="listitem">Enable table schema caching for the <code class="literal">db</code> component as follows:<div class="informalexample"><pre class="programlisting">return [
    // ...
    'components' =&gt; [
        // ...
        'cache' =&gt; [
            'class' =&gt; 'yii\caching\FileCache',
        ],
        'db' =&gt; [
            'class' =&gt; 'yii\db\Connection',
            'dsn' =&gt; 'mysql:host=localhost;dbname=mydatabase',
            'username' =&gt; 'root',
            'password' =&gt; '',
            'enableSchemaCache' =&gt; true,

            // Optional. Default value is 3600 seconds
            schemaCacheDuration' =&gt; 3600, 

            // Optional. Default value is 'cache'
            'schemaCache' =&gt; 'cache',
        ],
    ],
];</pre></div></li><li class="listitem">Use plain arrays instead <a class="indexterm" id="id656"/>of Active Record objects for listing sets of elements:<div class="informalexample"><pre class="programlisting">$categoriesArray = Categories::find()-&gt;asArray()-&gt;all();</pre></div></li><li class="listitem">Use <code class="literal">each()</code> instead of <code class="literal">all()</code> in <code class="literal">foreach</code> for a large count of results:<div class="informalexample"><pre class="programlisting">foreach (Post::find()-&gt;each() as $post) {
    // ...
}</pre></div></li><li class="listitem">Because Composer's autoloader is used to include most third-party class files, you should consider optimizing it by executing the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>composer dump-autoload</strong></span>
<span class="strong"><strong> -o</strong></span>
</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec332"/>How it works…</h2></div></div></div><p>When <code class="literal">YII_DEBUG </code>is set to <code class="literal">false</code>, Yii turns OFF all the trace level logging and uses less error handling code. Also, when you set <code class="literal">YII_ENV</code> to <code class="literal">prod</code> your application does not load Yii and Debug panel modules.</p><p>Setting <code class="literal">schemaCachingDuration</code> to a <a class="indexterm" id="id657"/>number of seconds allows caching the database schema used by Yii's Active Record. This is highly recommended for production servers and it significantly improves the Active Record performance. In order for it to work, you need to properly configure the <code class="literal">cache</code> component as follows:</p><div class="informalexample"><pre class="programlisting">'cache' =&gt; [
    'class' =&gt; 'yii\cache\FileCache',
],</pre></div><p>Enabling the cache also has a positive effect on other Yii components. For example, Yii router or urlManager starts to cache routes.</p><p>Of course, you can get into a situation where the preceding settings will not help to achieve a sufficient performance level. In most cases, it means that either the application itself is a bottleneck or you need more hardware.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>Server-side performance is just a part of the big picture</strong></span>: Server-side performance is only one of the things that affect the overall performance. By optimizing the client side such as serving CSS, images, and JavaScript files, proper caching and minimizing the amount of HTTP-requests can give a good visual performance gain even without optimizing the PHP code.</li><li class="listitem"><span class="strong"><strong>Things to be done without using Yii</strong></span>: Some things are best done without Yii. For example, image resizing on-the-fly is better in a separate PHP script in order to avoid the extra overhead.</li><li class="listitem"><span class="strong"><strong>Active Record versus Query Builder and SQL</strong></span>: Use Query Builder or SQL in performance-critical <a class="indexterm" id="id658"/>application parts. Generally, AR is most useful when adding and editing records, as it adds a convenient validation layer, and is less useful when selecting records.</li><li class="listitem"><span class="strong"><strong>Always check for slow queries first</strong></span>: Database can become a bottleneck in a second if a developer accidentally forgets to add an index to a table that is being read often or vice versa, or adds too many indexes to a table we are writing to very often. The same goes for selecting unnecessary data and unneeded JOINs.</li><li class="listitem"><span class="strong"><strong>Cache or save results of heavy processes</strong></span>: If you can avoid running a heavy process in every page load, it is better to do so. For example, it is a good practice to save or cache results of parsing the markdown text, purify it (this is a very resource-intensive process) once, and then to use the ready-to-display HTML.</li><li class="listitem"><span class="strong"><strong>Handling too much processing</strong></span>: Sometimes there is too much processing to be handled immediately. It can be building complex reports or simply sending e-mails (if your project is heavily loaded). In this case, it is better to put it into a queue and process it later using cron or other specialized tools.</li></ul></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec333"/>See also</h2></div></div></div><p>For more <a class="indexterm" id="id659"/>information about performance tuning and caching <a class="indexterm" id="id660"/>refer to the following URLs:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-tutorial-performance-tuning.html">http://www.yiiframework.com/doc-2.0/guide-tutorial-performance-tuning.html</a></li><li class="listitem"><a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-caching-overview.html">http://www.yiiframework.com/doc-2.0/guide-caching-overview.html</a></li></ul></div></div></div></div>
<div class="section" title="Speeding up session handling"><div class="titlepage" id="2VBO82-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch09lvl1sec94"/>Speeding up session handling</h1></div></div></div><p>Native session handling in PHP is fine in most cases. There are at least two possible reasons why you will <a class="indexterm" id="id661"/>want to change the way sessions are handled:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">When using multiple servers, you need to have common session storage for both servers.</li><li class="listitem">Default PHP sessions use files, so the maximum performance possible is limited by disk I/O.</li><li class="listitem">Default PHP sessions are blocking concurrent session storages. In this recipe, we will see how to use efficient storage for Yii sessions.</li></ul></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec334"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>, and install the Memcache server and the <code class="literal">memcache</code> PHP extension.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec335"/>How to do it…</h2></div></div></div><p>We will stress-test the website using the Apache <code class="literal">ab</code> tool. It is distributed with Apache binaries, so if you are using Apache, you will find it inside the <code class="literal">bin</code> directory.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Run the following command replacing your website with the actual hostname you are using:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ab -n 1000 -c 5 http://yii-book.app/index.php?r=site/contact</strong></span>
</pre></div><p>This will send 1,000 requests, five at a time, and will output stats as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>This is ApacheBench, Version 2.3 &lt;$Revision: 1528965 $&gt;</strong></span>
<span class="strong"><strong>Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</strong></span>
<span class="strong"><strong>Licensed to The Apache Software Foundation, http://www.apache.org/</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Server Software:        nginx</strong></span>
<span class="strong"><strong>Server Hostname:        yii-book.app</strong></span>
<span class="strong"><strong>Server Port:            80</strong></span>

<span class="strong"><strong>Document Path:          /index.php?r=site/contact</strong></span>
<span class="strong"><strong>Document Length:        14866 bytes</strong></span>
<span class="strong"><strong>Concurrency Level:      5</strong></span>
<span class="strong"><strong>Time taken for tests:   10.961 seconds</strong></span>
<span class="strong"><strong>Complete requests:      1000</strong></span>
<span class="strong"><strong>Failed requests:        0</strong></span>
<span class="strong"><strong>Total transferred:      15442000 bytes</strong></span>
<span class="strong"><strong>HTML transferred:       14866000 bytes</strong></span>
<span class="strong"><strong>Requests per second:    91.24 [#/sec] (mean)</strong></span>
<span class="strong"><strong>Time per request:       54.803 [ms] (mean)</strong></span>
<span class="strong"><strong>Time per request:       10.961 [ms] (mean, across all concurrent requests)</strong></span>
<span class="strong"><strong>Transfer rate:          1375.84 [Kbytes/sec] received</strong></span>

<span class="strong"><strong>Connection Times (ms)</strong></span>
<span class="strong"><strong>              min  mean[+/-sd] median   max</strong></span>
<span class="strong"><strong>Connect:        0    0   0.0      0       0</strong></span>
<span class="strong"><strong>Processing:    18   55 324.9     29    4702</strong></span>
<span class="strong"><strong>Waiting:       15   41 255.1     24    4695</strong></span>
<span class="strong"><strong>Total:         18   55 324.9     29    4702</strong></span>
</pre></div><p>We are interested in the requests-per-second metric. The number means that the website <a class="indexterm" id="id662"/>can process 91.24 requests per second if there are five requests at a time.</p><div class="note" title="Note"><h3 class="title"><a id="note17"/>Note</h3><p>Note that debuging is not turned off since we are interested in changes to the session handling speed.</p></div></li><li class="listitem">Now add the following to the <code class="literal">/config/web.php</code> components section:<div class="informalexample"><pre class="programlisting">'session' =&gt; array(
    'class' =&gt; 'yii\web\CacheSession',
    'cache' =&gt; 'sessionCache',
),
'sessionCache' =&gt; array(
    'class' =&gt; 'yii\caching\MemCache',
),</pre></div></li><li class="listitem">Run <code class="literal">ab</code> again with the same settings. This time, you should get better results. In my case, it was 139.07 requests per second. This means <code class="literal">Memcache</code>, as a session handler, performed 52% better than the default file-based session handler.<div class="note" title="Note"><h3 class="title"><a id="note18"/>Note</h3><p>Don't rely on the exact results provided here. It all depends on software versions, settings, and hardware used. Always try to run all tests yourself in an environment where you are going to deploy your application.</p></div></li><li class="listitem">You can get a significant performance gain by choosing the right session handling backend. Yii supports more caching backends out-of-the-box, including <a class="indexterm" id="id663"/>WinCache, XCache, and Zend data cache, which comes with the Zend Server. Moreover, you can implement your own cache backend to use fast noSQL storage, such as Redis.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec336"/>How it works…</h2></div></div></div><p>By default, Yii uses native PHP sessions; this means that the filesystem is used in most cases. A filesystem cannot deal with high concurrency efficiently.</p><p>Memcache or other platforms perform fine in the following situation:</p><div class="informalexample"><pre class="programlisting">'session' =&gt; array(
    'class' =&gt; 'yii\web\CacheSession',
    'cache' =&gt; 'sessionCache',
),
'sessionCache' =&gt; array(
    'class' =&gt; 'yii\caching\MemCache',
),</pre></div><p>In the preceding config section, we instruct Yii to use <code class="literal">CacheSession</code> as a session handler. With this component, we can delegate session handling to the cache component specified in <code class="literal">cache</code>. This time we are using <code class="literal">MemCache</code>.</p><p>When using a memcached backend, you should take into account the fact that when using these solutions the application user can possibly lose the session if the maximum cache capacity is reached.</p><div class="note" title="Note"><h3 class="title"><a id="note19"/>Note</h3><p>Note that, when using a cache backend for a session, you cannot rely on a session as a temporary data storage, since then there will be no memory to store more data in memcached. In such a case, this will just purge all data or delete some of it.</p></div><p>If you are using multiple servers, you cannot use file storage. There is no way to share the session data between servers. In the case of memcached, it is easy because it can be easily accessed from as many servers as you want.</p><p>Also, for sharing the session <a class="indexterm" id="id664"/>data you can use <code class="literal">DbSession</code>:</p><div class="informalexample"><pre class="programlisting">return [
    // ...
    'components' =&gt; [
        'session' =&gt; [
            'class' =&gt; 'yii\web\DbSession',
        ],
    ],
];</pre></div><p>Now, create a new table in your database:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE session (
    id CHAR(40) NOT NULL PRIMARY KEY,
    expire INTEGER,
    data BLOB
)</pre></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec337"/>There's more…</h2></div></div></div><p>It is a good idea to close the session as soon as possible. If you're not going to store anything in the session during the current request, you can even close it at the very beginning of your controller action. This way, even when using files as storage your application should be fine.</p><p>Use the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Yii:$app-&gt;session-&gt;close();</strong></span>
</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec338"/>See also</h2></div></div></div><p>For more information <a class="indexterm" id="id665"/>about performance and caching refer <a class="indexterm" id="id666"/>to the following URLs:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-tutorial-performance-tuning.html">http://www.yiiframework.com/doc-2.0/guide-tutorial-performance-tuning.html</a></li><li class="listitem"><a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-caching-overview.html">http://www.yiiframework.com/doc-2.0/guide-caching-overview.html</a></li></ul></div></div></div>
<div class="section" title="Using cache dependencies and chains"><div class="titlepage" id="30A8Q2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch09lvl1sec95"/>Using cache dependencies and chains</h1></div></div></div><p>Yii supports many cache backends, but what really <a class="indexterm" id="id667"/>makes the Yii cache flexible is the dependency and <a class="indexterm" id="id668"/>dependency chaining support. There are situations when you cannot simply cache data for an hour because the information cached can be changed at any time.</p><p>In this recipe, we will see how to cache a whole page and still always get fresh data when it is updated. The page will be of the dashboard-type and will show the five latest articles added and a total calculated for an account.</p><div class="note" title="Note"><h3 class="title"><a id="note20"/>Note</h3><p>Note that an operation cannot be edited as it is added, but an article can be.</p></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec339"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.
</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Activate the caching component in <code class="literal">config/web.php</code> as follows:<div class="informalexample"><pre class="programlisting">return [
    // ...
    'components' =&gt; [
        cache =&gt; ['class' =&gt; 'yii\caching\FileCache,
        ],
    ],
];</pre></div></li><li class="listitem">Set up a fresh <a class="indexterm" id="id669"/>database and configure it into <code class="literal">config/db.php</code>.</li><li class="listitem">Run the following <a class="indexterm" id="id670"/>migration:<div class="informalexample"><pre class="programlisting">&lt;?php

use yii\db\Schema;
use yii\db\Migration;

class m160308_093233_create_example_tables extends Migration
{
    public function up()
    {
        $tableOptions = null;
        if ($this-&gt;db-&gt;driverName === 'mysql') {
            $tableOptions = 'CHARACTER SET utf8 COLLATE utf8_general_ci ENGINE=InnoDB';
        }

        $this-&gt;createTable('{{%account}}', [
            'id' =&gt; Schema::TYPE_PK,
            'amount' =&gt; Schema::TYPE_DECIMAL . '(10,2) NOT NULL',
        ], $tableOptions);

        $this-&gt;createTable('{{%article}}', [
            'id' =&gt; Schema::TYPE_PK,
            'title' =&gt; Schema::TYPE_STRING . ' NOT NULL',
            'text' =&gt; Schema::TYPE_TEXT . ' NOT NULL',
        ], $tableOptions);
    }

    public function down()
    {
        $this-&gt;dropTable('{{%article}}');
        $this-&gt;dropTable('{{%account}}');
    }
}</pre></div></li><li class="listitem">Generate models <a class="indexterm" id="id671"/>for the account and article tables <a class="indexterm" id="id672"/>using Yii.</li><li class="listitem">Create <code class="literal">protected/controllers/DashboardController.php</code> as follows:<div class="informalexample"><pre class="programlisting">&lt;?php

namespace app\controllers;

use app\models\Account;
use app\models\Article;
use yii\web\Controller;

class DashboardController extends Controller
{
    public function actionIndex()
    {
        $total = Account::find()-&gt;sum('amount');
        $articles = Article::find()-&gt;orderBy('id DESC')-&gt;limit(5)-&gt;all();

        return $this-&gt;render('index', array(
            'total' =&gt; $total,
            'articles' =&gt; $articles,
        ));
    }

    public function actionRandomOperation()
    {
        $rec = new Account();
        $rec-&gt;amount = rand(-1000, 1000);
        $rec-&gt;save();

        echo 'OK';
    }

    public function actionRandomArticle()
    {
        $n = rand(0, 1000);

        $article = new Article();
        $article-&gt;title = "Title #".$n;
        $article-&gt;text = "Text #".$n;
        $article-&gt;save();

        echo 'OK';
    }
}</pre></div></li><li class="listitem">Create <code class="literal">views/dashboard/index.php</code> as <a class="indexterm" id="id673"/>follows:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;
/* @var $this yii\web\View */
/* @var $total int */
/* @var $articles app\models\Article[] */
?&gt;

&lt;h1&gt;Total: &lt;?= $total ?&gt;&lt;/h1&gt;
&lt;h2&gt;5 latest articles:&lt;/h2&gt;
&lt;?php foreach($articles as $article): ?&gt;
    &lt;h3&gt;&lt;?= Html::encode($article-&gt;title) ?&gt;&lt;/h3&gt;
    &lt;div&gt;&lt;?= Html::encode($article-&gt;text) ?&gt;&lt;/div&gt;
&lt;?php endforeach ?&gt;</pre></div></li><li class="listitem">Run <code class="literal">dashboard/random-operation</code> and <code class="literal">dashboard/random-article</code> several times. Then, <a class="indexterm" id="id674"/>run <code class="literal">dashboard/index</code> and you should see a screen similar to the one shown in the following screenshot:<div class="mediaobject"><img alt="Getting ready" src="../Images/image00499.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the number of <a class="indexterm" id="id675"/>database queries in the debug panel at the <a class="indexterm" id="id676"/>bottom of the page:<div class="mediaobject"><img alt="Getting ready" src="../Images/image00508.jpeg"/></div><p style="clear:both; height: 1em;"> </p><p>See a query list:</p><div class="mediaobject"><img alt="Getting ready" src="../Images/image00516.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec340"/>How to do it…</h2></div></div></div><p>Carry out the <a class="indexterm" id="id677"/>following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We need to <a class="indexterm" id="id678"/>modify the controller code as follows:<div class="informalexample"><pre class="programlisting">&lt;?php

namespace app\controllers;

use app\models\Account;
use app\models\Article;
use yii\caching\DbDependency;
use yii\caching\TagDependency;
use yii\web\Controller;

class DashboardController extends Controller
{
    public function behaviors()
    {
        return [
            'pageCache' =&gt; [
                'class' =&gt; 'yii\filters\PageCache',
                'only' =&gt; ['index'],
                'duration' =&gt; 24 * 3600 * 365, // 1 year
                'dependency' =&gt; [
                    'class' =&gt; 'yii\caching\ChainedDependency',
                    'dependencies' =&gt; [
                        new TagDependency(['tags' =&gt; 
                        ['articles']]),
                        new DbDependency(['sql' =&gt; 'SELECT MAX(id) FROM ' . Account::tableName()])
                    ]
                ],
            ],
        ];
    }

    public function actionIndex()
    {
        $total = Account::find()-&gt;sum('amount');
        $articles = Article::find()-&gt;orderBy('id DESC')-&gt;limit(5)-&gt;all();

        return $this-&gt;render('index', array(
            'total' =&gt; $total,
            'articles' =&gt; $articles,
        ));
    }

    public function actionRandomOperation()
    {
        $rec = new Account();
        $rec-&gt;amount = rand(-1000, 1000);
        $rec-&gt;save();

        echo 'OK';
    }

    public function actionRandomArticle()
    {
        $n = rand(0, 1000);

        $article = new Article();
        $article-&gt;title = "Title #".$n;
        $article-&gt;text = "Text #".$n;
        $article-&gt;save();

        TagDependency::invalidate(\Yii::$app-&gt;cache, 'articles');

        echo 'OK';
    }
}</pre></div></li><li class="listitem">That is it. Now, after loading <code class="literal">dashboard/index</code> several times, you will get only one <a class="indexterm" id="id679"/>simple query <a class="indexterm" id="id680"/>in the latest snapshot, as shown in the following screenshot:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00483.jpeg"/></div><p style="clear:both; height: 1em;"> </p><p>Also, try to run either <code class="literal">dashboard/random-operation</code> or <code class="literal">dashboard/random-article</code> and refresh <code class="literal">dashboard/index</code> after that. The data should change as follows:</p><div class="mediaobject"><img alt="How to do it…" src="../Images/image00533.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec341"/>How it works…</h2></div></div></div><p>In order to achieve <a class="indexterm" id="id681"/>maximum performance while doing minimal code <a class="indexterm" id="id682"/>modification, we use a full-page cache using a filter as follows:</p><div class="informalexample"><pre class="programlisting">public function behaviors()
{
    return [
        'pageCache' =&gt; [
            'class' =&gt; 'yii\filters\PageCache',
            'only' =&gt; ['index'],
            'duration' =&gt; 24 * 3600 * 365, // 1 year
            'dependency' =&gt; [
                'class' =&gt; 'yii\caching\ChainedDependency',
                'dependencies' =&gt; [
                    new TagDependency(['tags' =&gt; ['articles']]),
                    new DbDependency(['sql' =&gt; 'SELECT MAX(id) FROM account'])
                ]
            ],
        ],
    ];
}</pre></div><p>The preceding code means that we apply a full-page cache to the <code class="literal">index</code> action. The page will be cached for a year and the cache will refresh if one of the dependency data changes. Therefore, in general, the dependency works as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The first run gets the fresh data as described in the dependency, saves it for future reference, and updates the cache</li><li class="listitem">It gets the fresh data as described in dependency, gets the saved data, and then compares the two</li><li class="listitem">If they are equal, it uses the cached data</li><li class="listitem">If not, it updates the cache, uses the fresh data, and saves the fresh dependency data for future reference</li></ul></div><p>In our case, two dependency types are used—tag and DB. A tag dependency marks data with the custom string tag and checks it to decide if we need to invalidate the cache, while a DB dependency uses the SQL query result for the same purpose.</p><p>The question that you have now is probably, "Why have we used DB for one case and tags for another?" That is a good question!</p><p>The goal of using the DB dependency is to replace heavy calculations and select a light query that gets as little <a class="indexterm" id="id683"/>data as possible. The best thing about this type of dependency <a class="indexterm" id="id684"/>is that we don't need to embed any additional logic in the existing code. In our case, we can use this type of dependency for account operations, but cannot use it for articles as the article content can be changed. Therefore, for articles, we set a global tag named article which basically means that we can manually call the following when we want to invalidate total the article cache:</p><div class="informalexample"><pre class="programlisting">TagDependency::invalidate(\Yii::$app-&gt;cache, 'articles');</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec342"/>See also</h2></div></div></div><p>In order to learn more <a class="indexterm" id="id685"/>about caching and using cache dependencies, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-caching-overview.html">http://www.yiiframework.com/doc-2.0/guide-caching-overview.html</a>
</p></div></div>
<div class="section" title="Profiling an application with Yii"><div class="titlepage" id="318PC2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch09lvl1sec96"/>Profiling an application with Yii</h1></div></div></div><p>If all of the best practices for deploying a Yii application are applied and you still do not have the performance <a class="indexterm" id="id686"/>you want, then most probably there are some bottlenecks with the application itself. The main principle while dealing with these bottlenecks is that you should never assume anything and always test and profile the code before trying to optimize it.</p><p>In this recipe, we will try to find bottlenecks in the Yii2 mini application.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec343"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.
</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Set up your database connection and apply the following migration:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\db\Migration;

class m160308_093233_create_example_tables extends Migration
{
    public function up()
    {
        $tableOptions = null;
        if ($this-&gt;db-&gt;driverName === 'mysql') {
            $tableOptions = 'CHARACTER SET utf8 COLLATE utf8_general_ci ENGINE=InnoDB';
        }

        $this-&gt;createTable('{{%category}}', [
            'id' =&gt; $this-&gt;primaryKey(),
            'name' =&gt; $this-&gt;string()-&gt;notNull(),
        ], $tableOptions);

        $this-&gt;createTable('{{%article}}', [
            'id' =&gt; $this-&gt;primaryKey(),
            'category_id' =&gt; $this-&gt;integer()-&gt;notNull(),
            'title' =&gt; $this-&gt;string()-&gt;notNull(),
            'text' =&gt; $this-&gt;text()-&gt;notNull(),
        ], $tableOptions);

        $this-&gt;createIndex('idx-article-category_id', '{{%article}}', 'category_id');
        $this-&gt;addForeignKey('fk-article-category_id', '{{%article}}', 'category_id', '{{%category}}', 'id');
    }

    public function down()
    {
        $this-&gt;dropTable('{{%article}}');
        $this-&gt;dropTable('{{%category}}');
    }
}</pre></div></li><li class="listitem">Generate <a class="indexterm" id="id687"/>models for each table in Yii.</li><li class="listitem">Write the following console command:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\commands;

use app\models\Article;
use app\models\Category;
use Faker\Factory;
use yii\console\Controller;

class DataController extends Controller
{
    public function actionInit()
    {
        $db = \Yii::$app-&gt;db;
        $faker = Factory::create();

        $transaction = $db-&gt;beginTransaction();
        try {
            $categories = [];
            for ($id = 1; $id &lt;= 100; $id++) {
                $categories[] = [
                    'id' =&gt; $id,
                    'name' =&gt; $faker-&gt;name,
                ];
            }

            $db-&gt;createCommand()-&gt;batchInsert(Category::tableName(), ['id', 'name'], $categories)-&gt;execute();

            $articles = [];
            for ($id = 1; $id &lt;= 100; $id++) {
                $articles[] = [
                    'id' =&gt; $id,
                    'category_id' =&gt; $faker-&gt;numberBetween(1, 100),
                    'title' =&gt; $faker-&gt;text($maxNbChars = 100),
                    'text' =&gt; $faker-&gt;text($maxNbChars = 200),
                ];
            }

            $db-&gt;createCommand()
            -&gt;batchInsert(Article::tableName(), ['id', 'category_id', 'title', 'text'], $articles)-&gt;execute();

            $transaction-&gt;commit();
        } catch (\Exception $e) {
            $transaction-&gt;rollBack();
            throw $e;
        }
    }
}</pre></div><p>And execute it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>./yii data/init</strong></span>
</pre></div></li><li class="listitem">Add the <code class="literal">ArticleController</code> class as <a class="indexterm" id="id688"/>follows:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\controllers;

use Yii;
use app\models\Article;
use yii\data\ActiveDataProvider;
use yii\web\Controller;

class ArticleController extends Controller
{
    public function actionIndex()
    {
        $query = Article::find();
        $dataProvider = new ActiveDataProvider([
            'query' =&gt; $query,
        ]);

        return $this-&gt;render('index', [
            'dataProvider' =&gt; $dataProvider,
        ]);
    }
}</pre></div></li><li class="listitem">Add the <code class="literal">views/article/index.php</code> view <a class="indexterm" id="id689"/>as follows:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;
use yii\widgets\ListView;

/* @var $this yii\web\View */
/* @var $dataProvider yii\data\ActiveDataProvider */

$this-&gt;title = 'Articles';
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;
?&gt;
&lt;div class="article-index"&gt;
    &lt;h1&gt;&lt;?= Html::encode($this-&gt;title) ?&gt;&lt;/h1&gt;
    &lt;?= ListView::widget([
        'dataProvider' =&gt; $dataProvider,
        'itemOptions' =&gt; ['class' =&gt; 'item'],
        'itemView' =&gt; '_item',
    ]) ?&gt;
/div&gt;</pre></div><p>Then add <code class="literal">views/article/_item.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;

/* @var $this yii\web\View */
/* @var $model app\models\Article */
?&gt;

&lt;div class="panel panel-default"&gt;
    &lt;div class="panel-heading"&gt;&lt;?= Html::encode($model-&gt;title); ?&gt;&lt;/div&gt;
    &lt;div class="panel-body"&gt;
        Category: &lt;?= Html::encode($model-&gt;category-&gt;name) ?&gt;
    &lt;/div&gt;
&lt;/div&gt;</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec344"/>How to do it…</h2></div></div></div><p>Follow these <a class="indexterm" id="id690"/>steps to profile an application with Yii:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the articles page:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00428.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Open the <code class="literal">views/article/index.php</code> file and add profiler calls before and after the <code class="literal">ListView</code> widget:<div class="informalexample"><pre class="programlisting">&lt;div class="article-index"&gt;
    &lt;h1&gt;&lt;?= Html::encode($this-&gt;title) ?&gt;&lt;/h1&gt;

    &lt;?php Yii::beginProfile('articles') ?&gt;

    &lt;?= ListView::widget([
        'dataProvider' =&gt; $dataProvider,
        'itemOptions' =&gt; ['class' =&gt; 'item'],
        'itemView' =&gt; '_item',
    ]) ?&gt;

    &lt;?php Yii::endProfile('articles') ?&gt;

&lt;/div&gt;</pre></div><p>Now refresh the page.</p></li><li class="listitem">Expand the <a class="indexterm" id="id691"/>debug panel at the bottom of page and click on the timing badge (<span class="strong"><strong>73 ms</strong></span> in our case):<div class="mediaobject"><img alt="How to do it…" src="../Images/image00384.jpeg"/></div><p style="clear:both; height: 1em;"> </p><p>Now examine the<span class="strong"><strong> Profiling</strong></span> report:</p><div class="mediaobject"><img alt="How to do it…" src="../Images/image00391.jpeg"/></div><p style="clear:both; height: 1em;"> </p><p>We can see that our articles block has taken close to 40 milliseconds.</p></li><li class="listitem">Open our controller and add eager loading for article's <code class="literal">category</code> relation as follows:<div class="informalexample"><pre class="programlisting">class ArticleController extends Controller
{
    public function actionIndex()
    {
        $query = Article::find()-&gt;with('category');

        $dataProvider = new ActiveDataProvider([
            'query' =&gt; $query,
        ]);
        return $this-&gt;render('index', [
            'dataProvider' =&gt; $dataProvider,
        ]);
    }
}</pre></div></li><li class="listitem">Go back to the site, <a class="indexterm" id="id692"/>refresh the page, and open the <span class="strong"><strong>Profiling</strong></span> report again:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00492.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>Right now the articles listing has taken close to 25 milliseconds because the application makes fewer SQL queries with eager loading of related models.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec345"/>How it works…</h2></div></div></div><p>You can enclose any fragment of source code with <code class="literal">Yii::beginProfile</code> and <code class="literal">Yii::endProfile</code> calls:</p><div class="informalexample"><pre class="programlisting">Yii::beginProfile('articles');
// ...
Yii::endProfile('articles');</pre></div><p>After executing the page, <a class="indexterm" id="id693"/>you can see the report with all timings on the <span class="strong"><strong>Profiling</strong></span> page of the debug module.</p><p>Also, you can use nested profiling calls as follows:</p><div class="informalexample"><pre class="programlisting">Yii::beginProfile('outer');
    Yii::beginProfile('inner');
        // ...
    Yii::endProfile('inner');
Yii::endProfile('outer');</pre></div><div class="note" title="Note"><h3 class="title"><a id="note21"/>Note</h3><p>
<span class="strong"><strong>Note</strong></span>: Take care with correct opening and closing calls in this case and correct block naming. If you the miss <code class="literal">Yii::endProfile</code> call or switch the order of <code class="literal">Yii::endProfile('inner')</code> and <code class="literal">Yii::endProfile('outer')</code>, performance profiling will not work.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec346"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">For more <a class="indexterm" id="id694"/>information about logging refer to the following URL: <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-runtime-logging.html#performance-profiling">http://www.yiiframework.com/doc-2.0/guide-runtime-logging.html#performance-profiling</a></li><li class="listitem">About tuning of the <a class="indexterm" id="id695"/>application performance refer to the following URL: <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-tutorial-performance-tuning.html">http://www.yiiframework.com/doc-2.0/guide-tutorial-performance-tuning.html</a></li></ul></div></div></div>
<div class="section" title="Leveraging HTTP caching"><div class="titlepage" id="3279U2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch09lvl1sec97"/>Leveraging HTTP caching</h1></div></div></div><p>Instead of only server-side <a class="indexterm" id="id696"/>caching implementation you can use client-side caching via specific HTTP-headers.</p><p>In this recipe, we will cover full-page caching on the basis of the <code class="literal">Last-Modified</code> and <code class="literal">ETag</code> headers.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec347"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.
</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create and run migration as follows:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\db\Migration;

class m160308_093233_create_example_tables extends Migration
{
    public function up()
    {
        $this-&gt;createTable('{{%article}}', [
            'id' =&gt; $this-&gt;primaryKey(),
            'created_at' =&gt; $this-&gt;integer()-&gt;unsigned()-
            &gt;notNull(),
            'updated_at' =&gt; $this-&gt;integer()-&gt;unsigned()-&gt;notNull(),
            'title' =&gt; $this-&gt;string()-&gt;notNull(),
            'text' =&gt; $this-&gt;text()-&gt;notNull(),
        ]);
    }

    public function down()
    {
        $this-&gt;dropTable('{{%article}}');
    }
}</pre></div></li><li class="listitem">Create an <code class="literal">Article</code> model <a class="indexterm" id="id697"/>as follows:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\models;

use Yii;
use yii\behaviors\TimestampBehavior;
use yii\db\ActiveRecord;

class Article extends ActiveRecord
{
    public static function tableName()
    {
        return '{{%article}}';
    }

    public function behaviors()
    {
        return [
            TimestampBehavior::className(),
        ];
    }
}</pre></div></li><li class="listitem">Create a blog controller <a class="indexterm" id="id698"/>with the following actions:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\controllers;

use app\models\Article;
use yii\web\Controller;
use yii\web\NotFoundHttpException;
class BlogController extends Controller
{
    public function actionIndex()
    {
        $articles = Article::find()-&gt;orderBy(['id' =&gt; SORT_DESC])-&gt;all();
        return $this-&gt;render('index', array(
            'articles' =&gt; $articles,
        ));
    }

    public function actionView($id)
    {
        $article = $this-&gt;findModel($id);
        return $this-&gt;render('view', array(
            'article' =&gt; $article,
        ));
    }

    public function actionCreate()
    {
        $n = rand(0, 1000);
        $article = new Article();
        $article-&gt;title = 'Title #' . $n;
        $article-&gt;text = 'Text #' . $n;
        $article-&gt;save();
        echo 'OK';
    }

    public function actionUpdate($id)
    {
        $article = $this-&gt;findModel($id);
        $n = rand(0, 1000);
        $article-&gt;title = 'Title #' . $n;
        $article-&gt;text = 'Text #' . $n;
        $article-&gt;save();
        echo 'OK';
    }
    private function findModel($id)
    {
        if (($model = Article::findOne($id)) !== null) {
            return $model;
        } else {
            throw new NotFoundHttpException('The requested page does not exist.');
        }
    }
}</pre></div></li><li class="listitem">Add the <code class="literal">views/blog/index.php</code> view:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;

$this-&gt;title = 'Articles';;
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;
?&gt;

&lt;?php foreach($articles as $article): ?&gt;
    &lt;h3&gt;&lt;?= Html::a(Html::encode($article-&gt;title), ['view', 'id' =&gt; $article-&gt;id]) ?&gt;&lt;/h3&gt;
    &lt;div&gt;Created &lt;?= Yii::$app-&gt;formatter-&gt;asDatetime($article-&gt;created_at) ?&gt;&lt;/div&gt;
    &lt;div&gt;Updated &lt;?= Yii::$app-&gt;formatter-&gt;asDatetime($article-&gt;updated_at) ?&gt;&lt;/div&gt;
&lt;?php endforeach ?&gt;</pre></div></li><li class="listitem">Add the <code class="literal">views/blog/view.php</code> view <a class="indexterm" id="id699"/>file:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;

$this-&gt;title = $article-&gt;title;
$this-&gt;params['breadcrumbs'][] = ['label' =&gt; 'Articles', 'url' =&gt; ['index']];
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;
?&gt;

&lt;h1&gt;&lt;?= Html::encode($article-&gt;title) ?&gt;&lt;/h1&gt;
&lt;div&gt;Created &lt;?= Yii::$app-&gt;formatter-&gt;asDatetime($article-&gt;created_at) ?&gt;&lt;/div&gt;
&lt;div&gt;Updated &lt;?= Yii::$app-&gt;formatter-&gt;asDatetime($article-&gt;updated_at) ?&gt;&lt;/div&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;?= Yii::$app-&gt;formatter-&gt;asNtext($article-&gt;text) ?&gt;&lt;/p&gt;</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec348"/>How to do it…</h2></div></div></div><p>Follow these steps to leverage HTTP caching:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Access this URL <a class="ulink" href="http://yii-book.app/index.php?r=blog/create">http://yii-book.app/index.php?r=blog/create</a> three times <a class="indexterm" id="id700"/>to generate three articles.</li><li class="listitem">Open the following blog page:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00394.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Open the developer console in your browser and see the <code class="literal">200 OK</code> response status for each reloading of the blog page:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00456.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Open <code class="literal">BlogController</code> and attach <a class="indexterm" id="id701"/>the following behaviors:<div class="informalexample"><pre class="programlisting">class BlogController extends Controller
{
    public function behaviors()
    {
        return [
            [
                'class' =&gt; 'yii\filters\HttpCache',
                'only' =&gt; ['index'],
                'lastModified' =&gt; function ($action, $params) {
                    return Article::find()-&gt;max('updated_at');
                },
            ],
            [
                'class' =&gt; 'yii\filters\HttpCache',
                'only' =&gt; ['view'],
                'etagSeed' =&gt; function ($action, $params) {
                    $article = $this-&gt;findModel(\Yii::$app-&gt;request-&gt;get('id'));
                    return serialize([$article-&gt;title, $article-&gt;text]);
                },
            ],
        ];
    }

    // ...
}</pre></div></li><li class="listitem">Next, reload the page a few times <a class="indexterm" id="id702"/>and check that the server returns the <code class="literal">304 Not Modified</code> status instead of <code class="literal">200 OK</code>:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00530.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Open the relevant page using the following URL to update random articles: <code class="literal">http://yii-book.app/index.php?r=blog/update</code>.</li><li class="listitem">After updating the blog page, check that the server returns <code class="literal">200 OK</code> the first time and <code class="literal">304 Not Modified</code> thereafter, and verify that you see the new updated time on the page:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00427.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Open any page from<a class="indexterm" id="id703"/> our article, as follows:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00502.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>Verify that the server returns <code class="literal">200 OK</code> the first time and <code class="literal">304 Not </code>
<code class="literal">Modified</code> on subsequent requests.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec349"/>How it works…</h2></div></div></div><p>There are time-based and content-based approaches to check the availability of the cached response content for your browser with the help of HTTP-headers.</p><div class="section" title="Last-Modified"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec43"/>Last-Modified</h3></div></div></div><p>This approach suggests that the server must return the last modification date of every document. After <a class="indexterm" id="id704"/>storing <a class="indexterm" id="id705"/>the date, our browser can attach it in the <code class="literal">If-Modified-Since</code> header for every subsequent request.</p><p>We must attach the <code class="literal">action</code> filter to our controller and specify the <code class="literal">lastModified</code> callback as follows:</p><div class="informalexample"><pre class="programlisting">class BlogController extends Controller
{
    public function behaviors()
    {
        return [
            [
                'class' =&gt; 'yii\filters\HttpCache',
                'only' =&gt; ['index'],
                'lastModified' =&gt; function ($action, $params) {
                    return Article::find()-&gt;max('updated_at');
                },
            ],
           // ...
        ];
    }

    // ...
}</pre></div><p>The <code class="literal">\yii\filters\HttpCache</code> class calls the callback and compares the returned value with the <code class="literal">$_SERVER['HTTP_IF_MODIFIED_SINCE']</code> system variable. If the document has still not changed, <code class="literal">HttpCache</code> will send a lightweight <code class="literal">304</code> response header without running the action.</p><p>However, if the document has been updated, the cache will be ignored and the server will return a full response.</p><div class="informaltable"><table border="1"><colgroup><col/><col/></colgroup><thead><tr><th valign="bottom">
<p>Request</p>
</th><th valign="bottom">
<p>Response</p>
</th></tr></thead><tbody><tr><td colspan="2" style="text-align: center" valign="top">
<p>First request with full response</p>
</td></tr><tr><td valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">GET /index.php?r=blog HTTP 1.1</pre></div><p>
</p>
</td><td valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">HTTP/1.1 200 OK
Cache-Control: public, max-age=3600
Last-Modified: Thu, 21 Apr 2016 00:56:02 GMT

&lt;!DOCTYPE html&gt;
&lt;html lang="en-US"&gt;
...</pre></div><p>
</p>
</td></tr><tr><td colspan="2" style="text-align: center" valign="top">
<p>Second request with <code class="literal">If-Modified-Since</code> with blank response</p>
</td></tr><tr><td valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">GET /index.php?r=blog HTTP 1.1
If-Modified-Since: Thu, 21 Apr 2016 00:56:02 GMT</pre></div><p>
</p>
</td><td valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">HTTP/1.1 304 Not Modified
Cache-Control: public, max-age=3600</pre></div><p>
</p>
</td></tr><tr><td colspan="2" style="text-align: center" valign="top">
<p>Third request after <a cid="c9" class="indexterm" id="id706"/>updating <a cid="c10" class="indexterm" id="id707"/>the posts with a full response</p>
</td></tr><tr><td valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">GET /index.php?r=blog HTTP 1.1
If-Modified-Since: Thu, 21 Apr 2016 00:56:02 GMT</pre></div><p>
</p>
</td><td valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">HTTP/1.1 200 OK
Cache-Control: public, max-age=3600
Last-Modified: Thu, 21 Apr 2016 01:12:02 GMT

&lt;!DOCTYPE html&gt;
&lt;html lang="en-US"&gt;
...</pre></div><p>
</p>
</td></tr></tbody></table></div><p>As an alternative or an addition to the <code class="literal">Last-Modified</code> header variable, you can use <code class="literal">ETag</code>.</p></div><div class="section" title="Entity Tag"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec44"/>Entity Tag</h3></div></div></div><p>In cases when we do not store the last<a class="indexterm" id="id708"/> modified date in our documents or pages, we can use <a class="indexterm" id="id709"/>custom hashes, which can be generated at the base of the document content.</p><p>For example, we can use a content title for our document to hash a specific tag:</p><div class="informalexample"><pre class="programlisting">class BlogController extends Controller
{
    public function behaviors()
    {
        return [
            [
                'class' =&gt; 'yii\filters\HttpCache',
                'only' =&gt; ['view'],
                'etagSeed' =&gt; function ($action, $params) {
                    $article = $this-&gt;findModel(\Yii::$app-&gt;request-&gt;get('id'));
                    return serialize([$article-&gt;title, $article-&gt;text]);
                },
            ],
        ];
    }
    // ...
}</pre></div><p>The <code class="literal">HttpCache</code> filter will <a class="indexterm" id="id710"/>attach this tag to the server response as an <code class="literal">ETag</code> header <a class="indexterm" id="id711"/>variable.</p><p>After storing <code class="literal">ETag</code>, our browser can attach it in the <code class="literal">If-None-Match</code> header for every subsequent request.</p><p>If the document still has not changed, <code class="literal">HttpCache</code> will send a lightweight <code class="literal">304</code> response header without running the action.</p><div class="informaltable"><table border="1"><colgroup><col/><col/></colgroup><thead><tr><th valign="bottom">
<p>Request</p>
</th><th valign="bottom">
<p>Response</p>
</th></tr></thead><tbody><tr><td colspan="2" style="text-align: center" valign="top">
<p>First request with full response</p>
</td></tr><tr><td valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">GET index.php?r=blog/view&amp;id=3 HTTP 1.1</pre></div><p>
</p>
</td><td valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">HTTP/1.1 200 OK
Cache-Control: public, max-age=3600
Etag: "VYkwdOXBzV23KhnzTTJXU"

&lt;!DOCTYPE html&gt;
&lt;html lang="en-US"&gt;
...</pre></div><p>
</p>
</td></tr><tr><td colspan="2" style="text-align: center" valign="top">
<p>Second request with <code class="literal">If-None-Match</code> and blank response</p>
</td></tr><tr><td valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">GET index.php?r=blog/view&amp;id=3 HTTP 1.1
If-None-Match: "VYkwdOXBzV23KhnzTTJXU"</pre></div><p>
</p>
</td><td valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">HTTP/1.1 304 Not Modified
Cache-Control: public, max-age=3600
Etag: "VYkwdOXBzV23KhnzTTJXU"</pre></div><p>
</p>
</td></tr><tr><td colspan="2" style="text-align: center" valign="top">
<p>Third request after updating the post with a full response</p>
</td></tr><tr><td valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">GET index.php?r=blog/view&amp;id=3 HTTP 1.1
If-None-Match: "VYkwdOXBzV23KhnzTTJXU"</pre></div><p>
</p>
</td><td valign="top">
<p>
</p><div class="informalexample"><pre class="programlisting">HTTP/1.1 200 OK
Cache-Control: public, max-age=3600Etag: "Ur4Ghd6hdYthrn82Ph44dhF"

&lt;!DOCTYPE html&gt;
&lt;html lang="en-US"&gt;
...</pre></div><p>
</p>
</td></tr></tbody></table></div><p>When the cache is valid, <a class="indexterm" id="id712"/>our application will send the <code class="literal">304 Not Modified</code> response <a class="indexterm" id="id713"/>HTTP-headers instead of the page content and will not run controllers and actions repeatedly.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec350"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">For more <a class="indexterm" id="id714"/>information about HTTP caching refer to <a class="ulink" href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching">https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching</a></li><li class="listitem">For HTTP-caching <a class="indexterm" id="id715"/>in Yii2 refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-caching-http.html">http://www.yiiframework.com/doc-2.0/guide-caching-http.html</a></li></ul></div></div></div>
<div class="section" title="Combining and minimizing assets"><div class="titlepage" id="335QG2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch09lvl1sec98"/>Combining and minimizing assets</h1></div></div></div><p>If your web page <a class="indexterm" id="id716"/>includes many CSS and/or JavaScript files, the page will open very <a class="indexterm" id="id717"/>slowly because the browser sends a large number of HTTP requests to download each file in separated threads. To reduce the number of requests and connections, we can combine and compress multiple CSS/JavaScript files into one or very few files in production mode, and then include these compressed files on the page instead of the original ones.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec351"/>Getting ready</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Create a new <code class="literal">yii2-app-basic</code> application using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a></li><li class="listitem">Download the <code class="literal">compiler.jar</code> file <a class="indexterm" id="id718"/>from <a class="ulink" href="https://developers.google.com/closure/compiler/">https://developers.google.com/closure/compiler/</a></li><li class="listitem">Download the <code class="literal">yuicompressor.jar</code> file <a class="indexterm" id="id719"/>from <a class="ulink" href="https://github.com/yui/yuicompressor/releases">https://github.com/yui/yuicompressor/releases</a></li><li class="listitem">Download <a class="indexterm" id="id720"/>and <a class="indexterm" id="id721"/>install the <span class="strong"><strong>Java Runtime Environment</strong></span> (<span class="strong"><strong>JRE</strong></span>) from <a class="ulink" href="http://www.java.com">http://www.java.com</a></li></ul></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec352"/>How to do it…</h2></div></div></div><p>Follow these steps to combine and minimize assets:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the source HTML <a class="indexterm" id="id722"/>code of the <code class="literal">index</code> page of your application. Check <a class="indexterm" id="id723"/>whether it is similar to the following structure:<div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en-US"&gt;
&lt;head&gt;
    ...
    &lt;title&gt;My Yii Application&lt;/title&gt;
    &lt;link href="/assets/9b3b2888/css/bootstrap.css" rel="stylesheet"&gt;
    &lt;link href="/css/site.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    ...
    &lt;script src="/assets/25f82b8a/jquery.js"&gt;&lt;/script&gt;
    &lt;script src="/assets/f4307424/yii.js"&gt;&lt;/script&gt;
    &lt;script src="/assets/9b3b2888/js/bootstrap.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div><p>The page includes three JavaScript files.</p></li><li class="listitem">Open the <code class="literal">config/console.php</code> file and add the <code class="literal">@webroot</code> and <code class="literal">@web</code> alias definitions:<div class="informalexample"><pre class="programlisting">&lt;?php
Yii::setAlias('@webroot', __DIR__ . '/../web');
Yii::setAlias('@web', '/');</pre></div></li><li class="listitem">Open a console and run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>yii asset/template assets.php</strong></span>
</pre></div></li><li class="listitem">Open the generated <code class="literal">assets.php</code> file and configure it as follows:<div class="informalexample"><pre class="programlisting">&lt;?php
return [
    'jsCompressor' =&gt; 'java -jar compiler.jar --js {from} --js_output_file {to}',
    'cssCompressor' =&gt; 'java -jar yuicompressor.jar --type css {from} -o {to}',
    'bundles' =&gt; [
        'app\assets\AppAsset',
        'yii\bootstrap\BootstrapPluginAsset',
    ],
    'targets' =&gt; [
        'all' =&gt; [
            'class' =&gt; 'yii\web\AssetBundle',
            'basePath' =&gt; '@webroot/assets',
            'baseUrl' =&gt; '@web/assets',
            'js' =&gt; 'all-{hash}.js',
            'css' =&gt; 'all-{hash}.css',
        ],
    ],
    'assetManager' =&gt; [
        'basePath' =&gt; '@webroot/assets',
        'baseUrl' =&gt; '@web/assets',
    ],
];</pre></div></li><li class="listitem">Run the <a class="indexterm" id="id724"/>combining command <code class="literal">yii asset assets.php config/assets-prod.php</code>. If this is successful you must get the <code class="literal">config/assets-prod.php</code> file <a class="indexterm" id="id725"/>with the following configuration:<div class="informalexample"><pre class="programlisting">&lt;?php
return [
    'all' =&gt; [
        'class' =&gt; 'yii\\web\\AssetBundle',
        'basePath' =&gt; '@webroot/assets',
        'baseUrl' =&gt; '@web/assets',
        'js' =&gt; [
            'all-fe792d4766bead53e7a9d851adfc6ec2.js',
        ],
        'css' =&gt; [
            'all-37cfb42649f74eb0a4bfe0d0e715c420.css',
        ],
    ],
    'yii\\web\\JqueryAsset' =&gt; [
        'sourcePath' =&gt; null,
        'js' =&gt; [],
        'css' =&gt; [],
        'depends' =&gt; [
            'all',
        ],
    ],
    'yii\\web\\YiiAsset' =&gt; [
        'sourcePath' =&gt; null,
        'js' =&gt; [],
        'css' =&gt; [],
        'depends' =&gt; [
            'yii\\web\\JqueryAsset',
            'all',
        ],
    ],
    'yii\\bootstrap\\BootstrapAsset' =&gt; [
        'sourcePath' =&gt; null,
        'js' =&gt; [],
        'css' =&gt; [],
        'depends' =&gt; [
            'all',
        ],
    ],
    'app\\assets\\AppAsset' =&gt; [
        'sourcePath' =&gt; null,
        'js' =&gt; [],
        'css' =&gt; [],
        'depends' =&gt; [
            'yii\\web\\YiiAsset',
            'yii\\bootstrap\\BootstrapAsset',
            'all',
        ],
    ],
    'yii\\bootstrap\\BootstrapPluginAsset' =&gt; [
        'sourcePath' =&gt; null,
        'js' =&gt; [],
        'css' =&gt; [],
        'depends' =&gt; [
            'yii\\web\\JqueryAsset',
            'yii\\bootstrap\\BootstrapAsset',
            'all',
        ],
    ],
];</pre></div></li><li class="listitem">Add the configuration for the <code class="literal">assetManager</code> component into the <code class="literal">config/web.php</code> file:<div class="informalexample"><pre class="programlisting">'components' =&gt; [
    // ...
    'assetManager' =&gt; [
        'bundles' =&gt; YII_ENV_PROD ? require(__DIR__ . '/assets-prod.php') : [],
    ],
],</pre></div></li><li class="listitem">Turn on production mode in <code class="literal">web/index.php</code>:<div class="informalexample"><pre class="programlisting">defined('YII_ENV') or define('YII_ENV', 'prod');</pre></div></li><li class="listitem">Reload the page <a class="indexterm" id="id726"/>in your browser and see the HTML code again. Now <a class="indexterm" id="id727"/>it must contain single lines to include our compressed files:<div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en-US"&gt;
    &lt;head&gt;
        ...
        &lt;title&gt;My Yii Application&lt;/title&gt;
        &lt;link href="/assets/all-37cfb42649f74eb0a4bfe0d0e715c420.css" rel="stylesheet"&gt;
    &lt;/head&gt;
    &lt;body&gt;
        ...
        &lt;script src="/assets/all-fe792d4766bead53e7a9d851adfc6ec2.js"&gt;&lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec353"/>How it works…</h2></div></div></div><p>First of all, our page had a set of included files:</p><div class="informalexample"><pre class="programlisting">&lt;link href="/assets/9b3b2888/css/bootstrap.css" rel="stylesheet"&gt;
&lt;link href="/css/site.css" rel="stylesheet"&gt;
...
&lt;script src="/assets/25f82b8a/jquery.js"&gt;&lt;/script&gt;
&lt;script src="/assets/f4307424/yii.js"&gt;&lt;/script&gt;
&lt;script src="/assets/9b3b2888/js/bootstrap.js"&gt;&lt;/script&gt;</pre></div><p>Next, we generated the <code class="literal">assets.php</code> configuration file and specified bundles for compressing:</p><div class="informalexample"><pre class="programlisting">'bundles' =&gt; [
    'app\assets\AppAsset',
    'yii\bootstrap\BootstrapPluginAsset',
],</pre></div><div class="note" title="Note"><h3 class="title"><a id="note22"/>Note</h3><p>
<span class="strong"><strong>Note</strong></span>: We could specify all intermediate asset bundles such as <code class="literal">yii\web\JqueryAsset</code> and <code class="literal">yii\web\YiiAsset</code>, but these assets are already specified as dependencies of <code class="literal">AppAsset</code> and <code class="literal">BootstrapPluginAsset</code>, and the compressing command automatically resolves all these dependencies.</p></div><p>The AssetManager publishes all assets <a class="indexterm" id="id728"/>into the classic subdirectories in <code class="literal">web/assets</code> and after <a class="indexterm" id="id729"/>publishing it runs compressors to combine all CSS and JS files into <code class="literal">all-{hash}.js</code> and <code class="literal">all-{hash}.css</code>.</p><p>Check whether the CSS file includes other resources by relative paths such as the <code class="literal">bootstrap.css</code> file:</p><div class="informalexample"><pre class="programlisting">@font-face {
    font-family: 'Glyphicons Halflings';
    src: url('../fonts/glyphicons-halflings-regular.eot');
}</pre></div><p>If it is so, then in the combined file, our compressor changes all relative paths for storing all relationships as follows:</p><div class="informalexample"><pre class="programlisting">@font-face{
    font-family: 'Glyphicons Halflings';
    src: url('9b3b2888/fonts/glyphicons-halflings-regular.eot');
}</pre></div><p>After processing, we get the <code class="literal">assets-prod.php</code> file with the bundles configuration of the <code class="literal">assetManager</code> component. It defines the new virtual asset as a dependency of clean copies of the original bundles:</p><div class="informalexample"><pre class="programlisting">return [
    'all' =&gt; [
        'class' =&gt; 'yii\\web\\AssetBundle',
        'basePath' =&gt; '@webroot/assets',
        'baseUrl' =&gt; '@web/assets',
        'js' =&gt; [
            'all-fe792d4766bead53e7a9d851adfc6ec2.js',
        ],
        'css' =&gt; [
            'all-37cfb42649f74eb0a4bfe0d0e715c420.css',
        ],
    ],
    'yii\\web\\JqueryAsset' =&gt; [
        'sourcePath' =&gt; null,
        'js' =&gt; [],
        'css' =&gt; [],
        'depends' =&gt; [
            'all',
        ],
    ],
    // ...
]</pre></div><p>Now we can require this <a class="indexterm" id="id730"/>configuration into the <code class="literal">config/web.php</code> file:</p><div class="informalexample"><pre class="programlisting">'components' =&gt; [
    // ...
    'assetManager' =&gt; [
        'bundles' =&gt; require(__DIR__ . '/assets-prod.php'),
    ],
],</pre></div><p>Alternatively, we can require the <a class="indexterm" id="id731"/>file for the production environment only:</p><div class="informalexample"><pre class="programlisting">'components' =&gt; [
    // ...
    'assetManager' =&gt; [
        'bundles' =&gt; YII_ENV_PROD ? require(__DIR__ . '/assets-prod.php') : [],
    ],
],</pre></div><div class="note" title="Note"><h3 class="title"><a id="note23"/>Note</h3><p>
<span class="strong"><strong>Note</strong></span>: Do not forget to regenerate all compressed and combining files after any updates of the original resources.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec354"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">For more information about <a class="indexterm" id="id732"/>assets refer to the following URL: <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-structure-assets.html">http://www.yiiframework.com/doc-2.0/guide-structure-assets.html</a></li><li class="listitem">For Closure Compiler <a class="indexterm" id="id733"/>refer to the following URL: <a class="ulink" href="https://developers.google.com/closure/compiler/">https://developers.google.com/closure/compiler/</a></li><li class="listitem">For YUI Compressor <a class="indexterm" id="id734"/>refer to the following URL: <a class="ulink" href="https://github.com/yui/yuicompressor/">https://github.com/yui/yuicompressor/</a></li></ul></div></div></div>
<div class="section" title="Running Yii2 on HHVM"><div class="titlepage" id="344B22-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch09lvl1sec99"/>Running Yii2 on HHVM</h1></div></div></div><p>
<span class="strong"><strong>HipHop Virtual Machine</strong></span> (<span class="strong"><strong>HHVM</strong></span>) is a process <a class="indexterm" id="id735"/>virtual machine from Facebook based on just-in-time (JIT) compilation. HHVM transforms PHP code <a class="indexterm" id="id736"/>into intermediate <span class="strong"><strong>HipHop bytecode</strong></span> (<span class="strong"><strong>HHBC</strong></span>) and dynamically translates PHP code into machine code, which <a class="indexterm" id="id737"/>will be <a class="indexterm" id="id738"/>optimized and natively executed.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec355"/>Getting ready</h2></div></div></div><p>Create a new <code class="literal">yii2-app-basic</code> application using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guidestart-installation.html">http://www.yiiframework.com/doc-2.0/guidestart-installation.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec356"/>How to do it…</h2></div></div></div><p>Follow these steps to run Yii on HHVM:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the Apache2 or Nginx web server.</li><li class="listitem">Follow the guide for <a class="indexterm" id="id739"/>installing HHVM on Linux or Mac available at <a class="ulink" href="https://docs.hhvm.com/hhvm/installation/introduction">https://docs.hhvm.com/hhvm/installation/introduction</a>. For example, on Ubuntu you must run the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install software-properties-common</strong></span>
<span class="strong"><strong>sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0x5a16e7281be7a449</strong></span>
<span class="strong"><strong>sudo add-apt-repository "deb http://dl.hhvm.com/ubuntu $(lsb_release -sc) main"</strong></span>
<span class="strong"><strong>sudo apt-get update</strong></span>
<span class="strong"><strong>sudo apt-get install hhvm</strong></span>
<span class="strong"><strong>After installing, you will see the following tips in your terminal:</strong></span>
<span class="strong"><strong>********************************************************************</strong></span>
<span class="strong"><strong>* HHVM is installed.</strong></span>
<span class="strong"><strong>*</strong></span>
<span class="strong"><strong>* Running PHP web scripts with HHVM is done by having your</strong></span>
<span class="strong"><strong>* webserver talk to HHVM over FastCGI. Install nginx or Apache,</strong></span>
<span class="strong"><strong>* and then:</strong></span>
<span class="strong"><strong>* $ sudo /usr/share/hhvm/install_fastcgi.sh</strong></span>
<span class="strong"><strong>* $ sudo /etc/init.d/hhvm restart</strong></span>
<span class="strong"><strong>* (if using nginx)  $ sudo /etc/init.d/nginx restart</strong></span>
<span class="strong"><strong>* (if using apache) $ sudo /etc/init.d/apache restart</strong></span>
<span class="strong"><strong>*</strong></span>
<span class="strong"><strong>* Detailed FastCGI directions are online at:</strong></span>
<span class="strong"><strong>* https://github.com/facebook/hhvm/wiki/FastCGI</strong></span>
<span class="strong"><strong>*</strong></span>
<span class="strong"><strong>* If you're using HHVM to run web scripts, you probably want it</strong></span>
<span class="strong"><strong>* to start at boot:</strong></span>
<span class="strong"><strong>* $ sudo update-rc.d hhvm defaults</strong></span>
<span class="strong"><strong>*</strong></span>
<span class="strong"><strong>* Running command-line scripts with HHVM requires no special setup:</strong></span>
<span class="strong"><strong>* $ hhvm whatever.php</strong></span>
<span class="strong"><strong>*</strong></span>
<span class="strong"><strong>* You can use HHVM for /usr/bin/php even if you have php-cli</strong></span>
<span class="strong"><strong>* installed:</strong></span>
<span class="strong"><strong>* $ sudo /usr/bin/update-alternatives \</strong></span>
<span class="strong"><strong>*    --install /usr/bin/php php /usr/bin/hhvm 60</strong></span>
<span class="strong"><strong>********************************************************************</strong></span>
</pre></div></li><li class="listitem">Try to start the <a class="indexterm" id="id740"/>built-in <a class="indexterm" id="id741"/>server manually for your site:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd web</strong></span>
<span class="strong"><strong>hhvm -m server -p 8080</strong></span>
</pre></div><p>Open the <code class="literal">localhost:8080</code> host in your browser:</p><div class="mediaobject"><img alt="How to do it…" src="../Images/image00402.jpeg"/></div><p style="clear:both; height: 1em;"> </p><p>Right now you can use HHVM to develop your project.</p></li><li class="listitem">If you use the Nginx or Apache2 server, then HHVM automatically creates its own configuration <a class="indexterm" id="id742"/>files in the <code class="literal">/etc/nginx</code> and <code class="literal">/etc/apache2</code> directories. In the case of Nginx, it creates the <code class="literal">/etc/nginx/hhvm.conf</code> template <a class="indexterm" id="id743"/>to include configuration file to your projects. For example, let's create a new virtual host called <code class="literal">yii-book-hhvm.app</code>:<div class="informalexample"><pre class="programlisting">server {
    listen 127.0.0.1:80;
    server_name .yii-book-hhvm.app;
    root /var/www/yii-book-hhvm.app/web;
    charset utf-8; 
    index index.php index.html index.htm;    
    include /etc/nginx/hhvm.conf;
}</pre></div><p>Add the hostname into your <code class="literal">/etc/hosts</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>127.0.0.1	yii-book-hhvm.app</strong></span>
</pre></div><p>Now restart the Nginx server:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo service nginx restart</strong></span>
</pre></div><p>Finally, open the new host in your browser.</p><div class="mediaobject"><img alt="How to do it…" src="../Images/image00457.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>Your server is successfully set up.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec357"/>How it works…</h2></div></div></div><p>You can use HHVM as an <a class="indexterm" id="id744"/>alternative PHP process in the <code class="literal">fastcgi</code> mode. By default, it <a class="indexterm" id="id745"/>listens to the <code class="literal">9000</code> port. You can change the default port of the <code class="literal">fastcgi</code> process in the <code class="literal">/etc/hhvm/server.ini</code> file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>hhvm.server.port = 9000</strong></span>
</pre></div><p>Configure the specific PHP options in the <code class="literal">/etc/hhvm/php.ini</code> file.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec358"/>See also</h2></div></div></div><p>For more information <a class="indexterm" id="id746"/>about installing HHVM, refer to the following URLs:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><a class="ulink" href="https://docs.hhvm.com/hhvm/installation/linux">https://docs.hhvm.com/hhvm/installation/linux</a></li><li class="listitem"><a class="ulink" href="https://docs.hhvm.com/hhvm/installation/mac">https://docs.hhvm.com/hhvm/installation/mac</a></li></ul></div><p>In order to learn more <a class="indexterm" id="id747"/>information about HHVM usage refer to <a class="ulink" href="https://docs.hhvm.com/hhvm/">https://docs.hhvm.com/hhvm/</a>.
</p></div></div></body></html>