<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Everything under Control with Events and Observers"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Everything under Control with Events and Observers</h1></div></div></div><p>Have you ever heard anything about the single responsibility principle? I hope so. It is one of the SOLID principles in programming, and it basically says that a class has one and only one responsibility. In other words, every class has to do <span class="emphasis"><em>one</em></span> single thing and not anything else.</p><p>Usually, when you build the first version of software, everything goes fine. Then, it happens. Your boss calls: time to introduce a new feature, developer! Especially if <span class="emphasis"><em>update</em></span> means <span class="emphasis"><em>insert this little extra behavior here</em></span>, your code base easily becomes heavy and sloppy.</p><p>Terribly sloppy! Then, you fight against deadlines, tests, Q&amp;A, and so on, literally an odyssey. Not a very good practice, right?</p><p>Now, in the software development world, you can find many techniques and methods to add new features to your software in an elegant way. You have probably heard about <span class="emphasis"><em>events</em></span> in programming.</p><p>In a few words, let's say it consists of logic such as this: <span class="emphasis"><em>when X does this, then Y must do that</em></span>.</p><p>Imagine a similar situation in your application: you just finished your application and then you say, "Oh, I just forgot to send an e-mail to the newbie user!"</p><p>With Eloquent, you can handle this situation in two ways. The first way is using the very interesting concept of model events. The second way is based on a more advanced concept: model observers.</p><p>In this chapter, in the first place, you will learn everything about events in the context of Eloquent models. Then, I will cover model events: what they are and when you would use them.</p><p>Then, I will do the same for model observers. You will learn all the differences, and the pros and cons. Obviously, for both of the concepts, I will use a practical example to show how to use them in a real-world situation.</p><p>Are you ready, hero?</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">When should I use events in my models?</li><li class="listitem" style="list-style-type: disc">Model events</li><li class="listitem" style="list-style-type: disc">An example of model events</li><li class="listitem" style="list-style-type: disc">Model observers</li><li class="listitem" style="list-style-type: disc">An example of model observers</li></ul></div><div class="section" title="When should I use events in my models?"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec39"/>When should I use events in my models?</h1></div></div></div><p>What is an <a id="id194" class="indexterm"/>event? If you search the term on Google, you will get multiple results.</p><p>For example, it will be defined as <span class="emphasis"><em>something that happens or is regarded as happening; an occurrence, especially one of some importance</em></span>. It may also be defined as <span class="emphasis"><em>something that occurs in a certain place during a particular interval of time</em></span>.</p><p>I like these two<a id="id195" class="indexterm"/> definitions because they fit perfectly in this context. In fact, you can see the <span class="emphasis"><em>particular interval of time</em></span> as the model lifecycle, in a certain sense.</p><p>You can create a new instance, update an existing instance, or delete it.</p><p>Every operation you can do is related to two events.</p><p>Starting from the basics: I have just created that record, I deleted that record, or I am updating that record, sounds natural, right?</p><p>Good. Now, Eloquent triggers some events when something happens in the model lifecycle. To be more precise, they are as follows:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>creating</p>
</td><td style="text-align: left" valign="top">
<p>saved</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>created</p>
</td><td style="text-align: left" valign="top">
<p>deleting</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>updating</p>
</td><td style="text-align: left" valign="top">
<p>deleted</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>updated</p>
</td><td style="text-align: left" valign="top">
<p>restoring</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>saving</p>
</td><td style="text-align: left" valign="top">
<p>restored</p>
</td></tr></tbody></table></div><p>For every operation, you have two separate events. As you may imagine, they refer to separate moments. Let's pick the <span class="emphasis"><em>create</em></span> operation for our example.</p><p>You have the<a id="id196" class="indexterm"/> <span class="emphasis"><em>creating</em></span> event, that you can read as "the <a id="id197" class="indexterm"/>create operation is going to happen." Then, you <a id="id198" class="indexterm"/>have <span class="emphasis"><em>created</em></span> that means "the create <a id="id199" class="indexterm"/>operation just happened".</p><p>As a scientist would say:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Operation</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>creating</p>
</td><td style="text-align: left" valign="top">
<p>is about the <span class="emphasis"><em>t - 1</em></span> moment</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>created</p>
</td><td style="text-align: left" valign="top">
<p>is related to the <span class="emphasis"><em>t + 1</em></span> moment</p>
</td></tr></tbody></table></div><p>So, you have two events for the three basic operations: create, update, and delete.</p><p>Also, you can see two more operations: save and restore. However, don't worry, they are not complex, in fact:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Save</strong></span>: All you have <a id="id200" class="indexterm"/>to know is that the save operation is related both to <span class="emphasis"><em>create</em></span> and <span class="emphasis"><em>update</em></span>. Let's assume that you want to add a behavior, whether or not the application is creating a record or saving an existing record. Why bother declaring the same thing twice? Just use the "save" generic operation and you're done.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Restore</strong></span>: The restore operation is used when you have the soft deletes feature enabled for a certain model, and you undo a delete operation on it.</li></ul></div><p>Ok, I know what you are thinking: what about going deeper into the concepts?</p></div></div>
<div class="section" title="Model events"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec40"/>Model events</h1></div></div></div><p>The first technique <a id="id201" class="indexterm"/>we are going to look at for events is called <span class="strong"><strong>model events</strong></span>. The basic concept is really simple:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the <code class="literal">EventServiceProvider</code> class, you can add a special event listener and bind it to a certain closure</li><li class="listitem" style="list-style-type: disc">In this closure, you will be able to specify your new behavior without touching the model code</li><li class="listitem" style="list-style-type: disc">This binding must be placed in the <code class="literal">boot()</code> method of the class</li></ul></div><p>Here's a simple example of a binding between the <span class="emphasis"><em>created</em></span> user event and a closure, passed as a parameter of the called method.</p><p>The <code class="literal">$user</code> parameter of the closure contains the instance of the concerned user:</p><div class="informalexample"><pre class="programlisting">  public function boot(DispatcherContract $events)
  {
      parent::boot($events);

      User::created(function($user)
      {
          // doing something here, after User creation...
      });
  }</pre></div><p>As you can imagine, every model has these methods, named after the events we saw before. So, if you want to bind a certain operation to a <span class="emphasis"><em>saved</em></span> event, for instance, you must use the following:</p><div class="informalexample"><pre class="programlisting">  User::saved(function($user)
    {
        // doing something here, after User save operation (both create and update)...
    });</pre></div><p>Another<a id="id202" class="indexterm"/> interesting feature is the possibility to stop the current operation with the <span class="emphasis"><em>pre</em></span> methods. In fact, if you are using any of the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">creating</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">updating</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">saving</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">restoring</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">deleting</code></li></ul></div><p>You can decide to return the Boolean value <code class="literal">false</code> if you want to abort the operation.</p><p>Let's say you want to abort the create operation if the user e-mail ends with the <code class="literal">@deniedprovider.com</code> string. You could do something like this:</p><div class="informalexample"><pre class="programlisting">  User::creating(function($user)
    {
      if(ends_with($user-&gt;email, '@deniedprovider.com'))
      {
        return false;
      }
    });</pre></div><p>Obviously, you can't do the same on the created, updated, saved, restored, and deleted events; the event just happened and you can't go back in time!</p></div>
<div class="section" title="An example of model events"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec41"/>An example of model events</h1></div></div></div><p>We can now<a id="id203" class="indexterm"/> look at some examples of model events in action.</p><p>Let's start with the great classic. A new user joins us, and we want to greet them with a welcome e-mail. Nothing is easier! Let's open <code class="literal">EventServiceProvider</code> and add this code just after the <code class="literal">parent::boot()</code> call:</p><div class="informalexample"><pre class="programlisting">  User::created(function($user){

    Mail::send('emails.welcome', ['user' =&gt; $user], function($message) use ($user)
    {
        $message-&gt;to($user-&gt;email, $user-&gt;first_name . ' ' . $user-&gt;last_name)-&gt;subject('Welcome to My Awesome App, '.$user-&gt;first_name.'!');
    });

  });</pre></div><p>Done! Wasn't it easy?</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note37"/>Note</h3><p>I am assuming that you have a <code class="literal">welcome.blade.php</code> view in the <code class="literal">emails</code> folder under <code class="literal">resources/views</code>. I am also assuming that you know the basics of e-mail sending in Laravel. If you need some more info, go to <a class="ulink" href="http://laravel.com/docs/5.0/mail#basic-usage">http://laravel.com/docs/5.0/mail#basic-usage</a>.</p></div></div><p>Here is <a id="id204" class="indexterm"/>another example of model events in action:</p><p>Let's assume that we have a class (for the purpose of this example) that is delegated to send an e-mail to every user who wants to know when a new book by a certain author is added. The class is named <code class="literal">NewBookNotifier</code>, and the method is called <code class="literal">forAuthor($authorId)</code>, where the <code class="literal">$authorId</code> is the primary key of the desired author.</p><p>We could do something like this:</p><div class="informalexample"><pre class="programlisting">  Book::created(function($book){

    $newBookNotifier = new NewBookNotifier();
    $newBookNotifier-&gt;forAuthor($book-&gt;author-&gt;id);

  });</pre></div><p>Done! The main point is that this is very simple. As I mentioned earlier, the most important part is that every model remains untouched. You can even add a very complex behavior, but you will not touch anything in the model. This is a great advantage because if you test that model and you don't touch it, you can be sure that it will never break.</p><p>Now, I am going to talk about <span class="emphasis"><em>more complex things</em></span>.</p></div>
<div class="section" title="Events observers"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec42"/>Events observers</h1></div></div></div><p>Model <a id="id205" class="indexterm"/>events are cool, I agree. However, sometimes, you could need something more advanced.</p><p>When you use<a id="id206" class="indexterm"/> Laravel, you are working mostly with object-oriented programming and probably want to do the same with your model events. The answer to your questions is model observers, which is an advanced version of model events.</p><p>To use them, all you have to do is to declare a new class like the following (maybe in a dedicated folder called <code class="literal">observers</code>):</p><div class="informalexample"><pre class="programlisting">  class BookObserver {

    public function creating($book)
    {
      // I want to create the $book book, but first...
    }

      public function saving($book)
      {
          // I want to save the $book book, but first...
      }

      public function saved($book)
      {
          // I just saved the $book book, so....
      }

  } </pre></div><p>Then register it with:</p><div class="informalexample"><pre class="programlisting">  Book::observe(new BookObserver);</pre></div><p>In the <code class="literal">boot()</code> method of the <code class="literal">EventServiceProvider</code> class.</p><p>There is nothing more to it, the concept is exactly the same. With observers you can also use every single notion you learned before with model events. You can declare every method you want, and to bind a specific event, just use the event identifier for the method name. So, the <span class="emphasis"><em>creating</em></span> event will be related to the <code class="literal">creating()</code> method and so on.</p><p>Obviously, you can also abort an operation if you are using the <span class="emphasis"><em>pre</em></span> methods, such as <span class="emphasis"><em>creating</em></span> or <span class="emphasis"><em>updating</em></span>:</p><div class="informalexample"><pre class="programlisting">  class BookObserver {

    public function creating($book)
    {
      $somethingGoesWrong = true;

      if($somethingGoesWrong)
      {
        return false;
      }
    }

  }</pre></div><p>Alright, now<a id="id207" class="indexterm"/> let's look at <a id="id208" class="indexterm"/>a couple of examples using model observers!</p></div>
<div class="section" title="An example of model observers"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec43"/>An example of model observers</h1></div></div></div><p>First of all, here's <a id="id209" class="indexterm"/>how you can do the same thing you did in the first model events example, using observers.</p><p>Create a new file named <code class="literal">WelcomeUserObserver.php</code> under <code class="literal">app/Observers</code>. Now, type in the following:</p><div class="informalexample"><pre class="programlisting">  &lt;?php

  namespace App\Observers;

  class WelcomeUserObserver {

    public function created($user){

      Mail::send('emails.welcome', ['user' =&gt; $user], function($message) use ($user)
      {
          $message-&gt;to($user-&gt;email, $user-&gt;first_name . ' ' . $user-&gt;last_name)-&gt;subject('Welcome to My Awesome App, '.$user-&gt;first_name.'!');
      });

    }

  }</pre></div><p>Then, you can register the observer in the <code class="literal">boot()</code> method of <code class="literal">EventServiceProvider</code>:</p><div class="informalexample"><pre class="programlisting">  /**
   * Register any other events for your application.
   *
   * @param  \Illuminate\Contracts\Events\Dispatcher  $events
   * @return void
   */
  public function boot(DispatcherContract $events)
  {
      parent::boot($events);

      User::observe(new WelcomeUserObserver);
  }</pre></div><p>Ta-dah! <a id="id210" class="indexterm"/>You're done. Your observer is now attached to your model.</p><p>Let's imagine another situation now. After a meeting with developers, it comes out that the librarian needs some small introduced in to the code base:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A notification for every user when a new author is added to the system</li><li class="listitem" style="list-style-type: disc">An e-mail sent every time an author is added or deleted</li></ul></div><p>Finally, every time a book is deleted, the librarian must know how many authors are stored in the database without a related book.</p><p>Good. Let's start. We will build three separate classes: remember the <span class="emphasis"><em>Single Responsibility Principle</em></span>, my friend.</p><p>We will have:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">CustomerNewAuthorObserver</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">LibrarianAuthorObserver</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">AuthorsWithoutBooksObservers</code></li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note38"/>Note</h3><p>You can name your classes as you prefer. I used this convention just as an example to easily link the behavior to the chosen name.</p></div></div><p>Then, let's create the three separate classes:</p><div class="informalexample"><pre class="programlisting">  &lt;?php

  // file: app/Observers/CustomerNewAuthorObserver

  namespace App\Observers;

  class CustomerNewAuthorObserver {

    public function created($author)
    {

    }

  }

  &lt;?php

  // file: app/Observers/LibrarianAuthorObserver

  namespace App\Observers;

  class LibrarianAuthorObserver {

    public function created($author)
    {

    }

    public function deleted($author)
    {

    }

  }

  &lt;?php

  // file: app/Observers/AuthorsWithoutBooksObservers

  namespace App\Observers;

  class AuthorsWithoutBooksObservers {

    public function deleted($author)
    {

    }

  }</pre></div><p>Good. Now, it's time<a id="id211" class="indexterm"/> to add some logic.</p><p>First of all, let's add <code class="literal">CustomerNewAuthorObserver</code>:</p><div class="informalexample"><pre class="programlisting">  &lt;?php

  // file: app/Observers/CustomerNewAuthorObserver

  namespace App\Observers;

  class CustomerNewAuthorObserver {

    public function created($author)
    {
      // getting all users...
      $users = \App\User::all();

      foreach($users as $user)
      {
        Mail::send('emails.created_author_customer', ['author' =&gt; $author], function($message) use ($user)
        {
            $message-&gt;to($user-&gt;email, $user-&gt;first_name . ' ' . $user-&gt;last_name)-&gt;subject('New Author Added!');
        });
      }
    }

  }</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note39"/>Note</h3><p>A very rude approach, I know. As usual, it's just for teaching purposes. Don't try this at home!</p></div></div><p>Then, our <code class="literal">LibrarianAuthorObserver</code> class<a id="id212" class="indexterm"/> is as follows:</p><div class="informalexample"><pre class="programlisting">  &lt;?php

  // file: app/Observers/LibrarianAuthorObserver

  namespace App\Observers;

  class LibrarianAuthorObserver {

    public function created($author) {
      Mail::send('emails.created_author_librarian', ['author' =&gt; $author], function($message) use ($author)
      {
          $message-&gt;to('librarian@awesomelibrary.com', 'The Librarian')-&gt;subject('New Author: ' . $author-&gt;first_name . ' ' . $author-&gt;last_name);
      });
    }

    public function deleted($author) {
      Mail::send('emails.deleted_author_librarian', ['author' =&gt; $author], function($message) use ($author)
      {
          $message-&gt;to('librarian@awesomelibrary.com', 'The Librarian')-&gt;subject('New Author: ' . $author-&gt;first_name . ' ' . $author-&gt;last_name);
      });
    }

  }</pre></div><p>Finally, we have <a id="id213" class="indexterm"/>the following:</p><div class="informalexample"><pre class="programlisting">  &lt;?php

  // file: app/Observers/AuthorsWithoutBooksObservers

  namespace App\Observers;

  class AuthorsWithoutBooksObservers {

    public function deleted($author) {
      $authorsWithoutBooks = \App\Author::has('books', '=', 0)-&gt;get();

      if(count($authorsWithoutBooks) &gt; 0){
        Mail::send('emails.author_without_books_librarian', ['authorsWithoutBooks' =&gt; $authorsWithoutBooks], function($message)
        {
            $message-&gt;to('librarian@awesomelibrary.com', 'The Librarian')-&gt;subject('Authors without Books! A check is required!');
        });
      }
    }

  }</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note40"/>Note</h3><p>As mentioned earlier, I am assuming that you have all the needed views and know how to deal with e-mails. If not, take a look at the <a class="ulink" href="http://laravel.com/docs/5.0/mail#basic-usage">http://laravel.com/docs/5.0/mail#basic-usage</a> page.</p></div></div><p>It doesn't end here. You can use observers and events for a vast number of cases and scenarios. Just to take an example, imagine that you are writing a blog and you want to regenerate your sitemap<a id="id214" class="indexterm"/> every time you create or edit an article. Observers are the answer, or maybe you want to log something while you add new books—use event observers, again!</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec44"/>Summary</h1></div></div></div><p>Great! You are now able to deal with events in every form, starting from the very basic to the more advanced concepts of observers. You just added another little piece to your Eloquent knowledge: the further you go, the more you will learn about how to make sophisticated applications. Also, we're respecting some of the SOLID principles!</p><p>Not bad, huh? However, don't use observers and events for everything. Sometimes, they are not the best choice, and you have to use other tools. So, be careful and analyze the individual problem you want to solve. A good technique never applies well to everything.</p><p>Well, time to take another step forward. If you want, take some rest; the <span class="emphasis"><em>intermediate</em></span> part of our work is done. In the next two chapters, in fact, you will learn some advanced things.</p><p>Are you ready? Great!</p><p>Turn the page and learn how to use Eloquent without Laravel!</p></div></body></html>