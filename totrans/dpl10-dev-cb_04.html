<html><head></head><body>
<div id="_idContainer038">
<h1 class="chapter-number" id="_idParaDest-129"><a id="_idTextAnchor131"/><span class="koboSpan" id="kobo.1.1">4</span></h1>
<h1 id="_idParaDest-130"><a id="_idTextAnchor132"/><span class="koboSpan" id="kobo.2.1">Extending Drupal with  Custom Code</span></h1>
<p><span class="koboSpan" id="kobo.3.1">The greatest component of Drupal is its extensibility through modules. </span><span class="koboSpan" id="kobo.3.2">In this chapter, we will explore how to create a custom module that can be installed on your Drupal site. </span><span class="koboSpan" id="kobo.3.3">This chapter will explain how PSR-4 autoloading works with extensions and how to leverage class autoloading. </span><span class="koboSpan" id="kobo.3.4">You will be able to create a controller for a custom page and specify additional permissions to check whether the user has them. </span><span class="koboSpan" id="kobo.3.5">You will also understand what hooks and events in Drupal are, and how to interact with them. </span><span class="koboSpan" id="kobo.3.6">This chapter also lays the foundations for the </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">following chapters.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">The following recipes will be covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.7.1">Creating </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">a module</span></span></li>
<li><span class="koboSpan" id="kobo.9.1">Providing configuration settings for </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">your module</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">Defining permissions and checking whether a user </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">has access</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Hooking into Drupal to react to </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">entity changes</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Creating an event subscriber to react </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">to events</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">Creating a custom </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">Drush command</span></span></li>
</ul>
<h1 id="_idParaDest-131"><a id="_idTextAnchor133"/><span class="koboSpan" id="kobo.19.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.20.1">You can find the full code used in this chapter on </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">GitHub: </span></span><a href="https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp04"><span class="No-Break"><span class="koboSpan" id="kobo.22.1">https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp04</span></span></a></p>
<h1 id="_idParaDest-132"><a id="_idTextAnchor134"/><span class="koboSpan" id="kobo.23.1">Creating a module</span></h1>
<p><span class="koboSpan" id="kobo.24.1">The first step to</span><a id="_idIndexMarker222"/><span class="koboSpan" id="kobo.25.1"> extending Drupal is to create a custom module. </span><span class="koboSpan" id="kobo.25.2">Although the task sounds daunting, it can be accomplished in a few simple steps. </span><span class="koboSpan" id="kobo.25.3">Modules can provide functionalities and customizations for functionalities provided by other modules, or they can be used as a way to contain the configuration and a </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">site’s state.</span></span></p>
<p><span class="koboSpan" id="kobo.27.1">In this recipe, we will create a module by defining its </span><strong class="source-inline"><span class="koboSpan" id="kobo.28.1">modulename.info.yml</span></strong><span class="koboSpan" id="kobo.29.1"> file, a file containing information that Drupal uses to discover extensions and install </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">the module.</span></span></p>
<h2 id="_idParaDest-133"><a id="_idTextAnchor135"/><span class="koboSpan" id="kobo.31.1">How to do it…</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.32.1">In your </span><strong class="source-inline"><span class="koboSpan" id="kobo.33.1">web/modules</span></strong><span class="koboSpan" id="kobo.34.1"> directory, create a new directory called </span><strong class="source-inline"><span class="koboSpan" id="kobo.35.1">custom</span></strong><span class="koboSpan" id="kobo.36.1"> and then another directory named </span><strong class="source-inline"><span class="koboSpan" id="kobo.37.1">mymodule</span></strong><span class="koboSpan" id="kobo.38.1"> inside it. </span><span class="koboSpan" id="kobo.38.2">This will be your module’s directory. </span><span class="koboSpan" id="kobo.38.3">Using the command line, you may create the directory with the </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">following command:</span></span><pre class="console"><span class="koboSpan" id="kobo.40.1">
mkdir -p web/modules/custom/mymodule</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.41.1">This will create the </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">required directories.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.43.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.44.1">mymodule.info.yml</span></strong><span class="koboSpan" id="kobo.45.1"> file in your module’s directory. </span><span class="koboSpan" id="kobo.45.2">This will contain the metadata that identifies the module </span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">to Drupal.</span></span></li>
<li><span class="koboSpan" id="kobo.47.1">Add a line to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.48.1">mymodule.info.yml</span></strong><span class="koboSpan" id="kobo.49.1"> file to provide a name for the module with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.50.1">name</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.51.1"> key:</span></span><pre class="console"><span class="koboSpan" id="kobo.52.1">
name: My Module</span></pre></li>
<li><span class="koboSpan" id="kobo.53.1">We must define the type of extension with the key type. </span><span class="koboSpan" id="kobo.53.2">Drupal does not assume the </span><a id="_idIndexMarker223"/><span class="koboSpan" id="kobo.54.1">extension type just by directory </span><span class="No-Break"><span class="koboSpan" id="kobo.55.1">location alone:</span></span><pre class="console"><span class="koboSpan" id="kobo.56.1">
type: module</span></pre></li>
<li><span class="koboSpan" id="kobo.57.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.58.1">description</span></strong><span class="koboSpan" id="kobo.59.1"> key allows you to provide extra information about your module, which will be displayed on the module’s </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">list page:</span></span><pre class="console"><span class="koboSpan" id="kobo.61.1">
description: This is an example module from the Drupal</span></pre><pre class="console"><span class="koboSpan" id="kobo.62.1">
Development Cookbook!</span></pre></li>
<li><span class="koboSpan" id="kobo.63.1">Extensions are required to provide a </span><strong class="source-inline"><span class="koboSpan" id="kobo.64.1">core_version_requirement</span></strong><span class="koboSpan" id="kobo.65.1"> that identifies what versions of Drupal core the module is compatible with, using a semantic </span><span class="No-Break"><span class="koboSpan" id="kobo.66.1">versioning constraint</span><a id="_idTextAnchor136"/><span class="koboSpan" id="kobo.67.1">:</span></span><pre class="console"><span class="koboSpan" id="kobo.68.1">
core_version_requirement: '&gt;=10'</span></pre></li>
<li><span class="koboSpan" id="kobo.69.1">Save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.70.1">mymodule.info.yml</span></strong><span class="koboSpan" id="kobo.71.1"> file, which looks </span><span class="No-Break"><span class="koboSpan" id="kobo.72.1">as follows:</span></span><pre class="console"><span class="koboSpan" id="kobo.73.1">
name: My Module</span></pre><pre class="console"><span class="koboSpan" id="kobo.74.1">
type: module</span></pre><pre class="console"><span class="koboSpan" id="kobo.75.1">
description: This is an example module from the Drupal</span></pre><pre class="console"><span class="koboSpan" id="kobo.76.1">
  Development Cookbook</span><a id="_idTextAnchor137"/><span class="koboSpan" id="kobo.77.1">!</span></pre><pre class="console"><span class="koboSpan" id="kobo.78.1">
core_version_requirement: '&gt;=10'</span></pre></li>
<li><span class="koboSpan" id="kobo.79.1">Next, create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.80.1">mymodule.module</span></strong><span class="koboSpan" id="kobo.81.1"> in your </span><strong class="source-inline"><span class="koboSpan" id="kobo.82.1">module</span></strong><span class="koboSpan" id="kobo.83.1"> file. </span><span class="koboSpan" id="kobo.83.2">This is the extension file that will allow us to add hook definitions. </span><span class="koboSpan" id="kobo.83.3">It is a regular PHP file, but the file extension matches its extension type </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">of module.</span></span></li>
<li><span class="koboSpan" id="kobo.85.1">For this example, we will provide a hook that renders a message on </span><span class="No-Break"><span class="koboSpan" id="kobo.86.1">each payload:</span></span><pre class="console"><span class="koboSpan" id="kobo.87.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.88.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.89.1">
 * Implements hook_page_top().</span></pre><pre class="console"><span class="koboSpan" id="kobo.90.1">
 */</span></pre><pre class="console"><span class="koboSpan" id="kobo.91.1">
function mymodule_page_top() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.92.1">
  \Drupal::messenger()-&gt;addStatus('Hello world!')</span><a id="_idTextAnchor138"/><span class="koboSpan" id="kobo.93.1">;</span></pre><pre class="console"><span class="koboSpan" id="kobo.94.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.95.1">This </span><a id="_idIndexMarker224"/><span class="koboSpan" id="kobo.96.1">implements </span><strong class="source-inline"><span class="koboSpan" id="kobo.97.1">hook_page_top</span></strong><span class="koboSpan" id="kobo.98.1">, which is called whenever a page is rendered. </span><span class="koboSpan" id="kobo.98.2">It uses the messenger service to add a status message to </span><span class="No-Break"><span class="koboSpan" id="kobo.99.1">the page.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.100.1">Install your module </span><span class="No-Break"><span class="koboSpan" id="kobo.101.1">using Drush:</span></span><pre class="console"><span class="koboSpan" id="kobo.102.1">
php vendor/bin/drush en mymodule --yes</span></pre></li>
<li><span class="koboSpan" id="kobo.103.1">Visit your Drupal site. </span><span class="koboSpan" id="kobo.103.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.104.1">Hello world!</span></strong><span class="koboSpan" id="kobo.105.1"> message will be added to </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">each page:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer032">
<span class="koboSpan" id="kobo.107.1"><img alt="Figure 4.1 – Drupal page displaying Hello world!" src="image/Figure_4.01_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.108.1">Figure 4.1 – Drupal page displaying Hello world!</span></p>
<h2 id="_idParaDest-134"><a id="_idTextAnchor139"/><span class="koboSpan" id="kobo.109.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.110.1">Drupal utilizes </span><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">info.yml</span></strong><span class="koboSpan" id="kobo.112.1"> files to</span><a id="_idIndexMarker225"/><span class="koboSpan" id="kobo.113.1"> define extensions. </span><span class="koboSpan" id="kobo.113.2">Drupal has an extension discovery system that locates these files and parses them to discover modules. </span><span class="koboSpan" id="kobo.113.3">The extension discovery will scan your entire Drupal code base, giving the Drupal core </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">directory priority.</span></span></p>
<p><span class="koboSpan" id="kobo.115.1">In this recipe, we provided </span><strong class="source-inline"><span class="koboSpan" id="kobo.116.1">&gt;=10</span></strong><span class="koboSpan" id="kobo.117.1"> for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.118.1">core_version_requirement</span></strong><span class="koboSpan" id="kobo.119.1"> constraint. </span><span class="koboSpan" id="kobo.119.2">This constraint allows your module to work with a minimum of Drupal 10.0.0 but also be compatible with Drupal 11 or greater, simplifying maintenance when the next major version of Drupal core is released. </span><span class="koboSpan" id="kobo.119.3">If you know your code is not compatible with a previous minor version, it could be updated to </span><strong class="source-inline"><span class="koboSpan" id="kobo.120.1">&gt;=10.1.0</span></strong><span class="koboSpan" id="kobo.121.1"> or even a specific patch value </span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.123.1">&gt;=10.2.1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.125.1">One method to integrate with Drupal is through its hook system. </span><span class="koboSpan" id="kobo.125.2">During runtime, other modules may invoke a hook that other modules can implement to perform actions or modify data. </span><span class="koboSpan" id="kobo.125.3">Our recipe implemented the </span><strong class="source-inline"><span class="koboSpan" id="kobo.126.1">hook_page_top</span></strong><span class="koboSpan" id="kobo.127.1"> hook. </span><span class="koboSpan" id="kobo.127.2">This hook is part of the page rendering life cycle and allows you to add renderable content at the very top of </span><span class="No-Break"><span class="koboSpan" id="kobo.128.1">the page.</span></span></p>
<h3><span class="koboSpan" id="kobo.129.1">Module namespaces</span></h3>
<p><span class="koboSpan" id="kobo.130.1">Drupal uses the PSR-4 standard </span><a id="_idIndexMarker226"/><span class="koboSpan" id="kobo.131.1">developed by the </span><strong class="bold"><span class="koboSpan" id="kobo.132.1">PHP Framework Interoperability Group</span></strong><span class="koboSpan" id="kobo.133.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.134.1">PHP-FIG</span></strong><span class="koboSpan" id="kobo.135.1">). </span><span class="koboSpan" id="kobo.135.2">The PSR-4 standard is for package-based PHP namespace autoloading of classes and is used by most libraries and frameworks, including Laravel and Symfony. </span><span class="koboSpan" id="kobo.135.3">It defines a standard to understand how to automatically include classes based on a namespace and class name. </span><span class="koboSpan" id="kobo.135.4">Drupal modules have their own namespaces under the Drupal </span><span class="No-Break"><span class="koboSpan" id="kobo.136.1">root namespace.</span></span></p>
<p><span class="koboSpan" id="kobo.137.1">Using the module from the recipe, our PHP namespace will be </span><strong class="source-inline"><span class="koboSpan" id="kobo.138.1">Drupal\mymodule</span></strong><span class="koboSpan" id="kobo.139.1">, which represents the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.140.1">web/modules/mymodule/src</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.141.1"> folder.</span></span></p>
<p><span class="koboSpan" id="kobo.142.1">With PSR-4, files need to contain only one class, interface, or trait. </span><span class="koboSpan" id="kobo.142.2">These files need to have the same filename as the containing class, interface, or trait name. </span><span class="koboSpan" id="kobo.142.3">This allows a class loader to resolve a namespace as a directory path and know the class’s filename. </span><span class="koboSpan" id="kobo.142.4">The file can then be automatically loaded when it is used in </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">a file.</span></span></p>
<h3><span class="koboSpan" id="kobo.144.1">Creating a composer.json file</span></h3>
<p><span class="koboSpan" id="kobo.145.1">If you are writing a</span><a id="_idIndexMarker227"/><span class="koboSpan" id="kobo.146.1"> custom module that will only be used </span><a id="_idIndexMarker228"/><span class="koboSpan" id="kobo.147.1">on your site, this is not necessary. </span><span class="koboSpan" id="kobo.147.2">However, if you plan to contribute your code to Drupal.org and distribute it, you should provide a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.148.1">composer.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.149.1"> file.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.150.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.151.1">Projects on Drupal.org are not required to create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.152.1">composer.json</span></strong><span class="koboSpan" id="kobo.153.1"> file. </span><span class="koboSpan" id="kobo.153.2">If a project does not, one will be automatically generated for it based on the contents of its </span><strong class="source-inline"><span class="koboSpan" id="kobo.154.1">info.yml</span></strong><span class="koboSpan" id="kobo.155.1"> file. </span><span class="koboSpan" id="kobo.155.2">That is why it is recommended to create one: to </span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">be explicit.</span></span></p>
<p><span class="koboSpan" id="kobo.157.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.158.1">composer.json</span></strong><span class="koboSpan" id="kobo.159.1"> file in your module directory. </span><span class="koboSpan" id="kobo.159.2">It will look similar to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.160.1">mymodule.info.yml</span></strong><span class="koboSpan" id="kobo.161.1"> file but </span><span class="No-Break"><span class="koboSpan" id="kobo.162.1">as JSON:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.163.1">
{
    "name": "drupal/mymodule",
    "type": "drupal-module",
    "description": "This is an example module from the Dru
        pal Development Cookbook!",
    "require": {
        "drupal/core": "&gt;=10"
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.164.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.165.1">name</span></strong><span class="koboSpan" id="kobo.166.1"> key should be prefixed with </span><strong class="source-inline"><span class="koboSpan" id="kobo.167.1">drupal/</span></strong><span class="koboSpan" id="kobo.168.1"> to identify it is in the Drupal package namespace. </span><span class="koboSpan" id="kobo.168.2">The type is prefixed with </span><strong class="source-inline"><span class="koboSpan" id="kobo.169.1">drupal-</span></strong><span class="koboSpan" id="kobo.170.1"> for compatibility with the Composer Installers package, which we covered in </span><a href="B18548_01.xhtml#_idTextAnchor020"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.171.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.172.1">, </span><em class="italic"><span class="koboSpan" id="kobo.173.1">Up and Running </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.174.1">with Drupal</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.175.1">.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">core_version_requirement</span></strong><span class="koboSpan" id="kobo.177.1"> is converted </span><a id="_idIndexMarker229"/><span class="koboSpan" id="kobo.178.1">into Composer’s</span><a id="_idIndexMarker230"/><span class="koboSpan" id="kobo.179.1"> dependency definition and targets the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">drupal/core</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.181.1"> package.</span></span></p>
<h2 id="_idParaDest-135"><a id="_idTextAnchor140"/><span class="koboSpan" id="kobo.182.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.183.1">There are more details about Drupal modules and the module </span><strong class="source-inline"><span class="koboSpan" id="kobo.184.1">info.yml</span></strong><span class="koboSpan" id="kobo.185.1"> files that we </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">can explore.</span></span></p>
<h3><span class="koboSpan" id="kobo.187.1">Module dependencies</span></h3>
<p><span class="koboSpan" id="kobo.188.1">Modules can</span><a id="_idIndexMarker231"/><span class="koboSpan" id="kobo.189.1"> define dependencies to ensure that those modules are installed before your module can </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">be installed.</span></span></p>
<p><span class="koboSpan" id="kobo.191.1">Here is an example from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.192.1">info.yml</span></strong><span class="koboSpan" id="kobo.193.1"> file for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.194.1">Pathauto</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.195.1"> module:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.196.1">
name: 'Pathauto'
description: 'Provides a mechanism for modules to automati
    cally generate aliases for the content they manage.'
</span><span class="koboSpan" id="kobo.196.2">type: module
dependencies:
- ctools:ctools
- drupal:path
- token:token</span></pre>
<p><span class="koboSpan" id="kobo.197.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">dependencies</span></strong><span class="koboSpan" id="kobo.199.1"> key specifies that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.200.1">ctools</span></strong><span class="koboSpan" id="kobo.201.1"> path from Drupal core and </span><strong class="source-inline"><span class="koboSpan" id="kobo.202.1">token</span></strong><span class="koboSpan" id="kobo.203.1"> module must be installed first before the </span><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">Pathauto</span></strong><span class="koboSpan" id="kobo.205.1"> module can be installed. </span><span class="koboSpan" id="kobo.205.2">In the </span><em class="italic"><span class="koboSpan" id="kobo.206.1">Adding and managing modules and themes with Composer</span></em><span class="koboSpan" id="kobo.207.1"> recipe from </span><a href="B18548_01.xhtml#_idTextAnchor020"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.208.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.209.1">, </span><em class="italic"><span class="koboSpan" id="kobo.210.1">Up and Running with Drupal</span></em><span class="koboSpan" id="kobo.211.1">, they were automatically installed when we installed the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">Pathauto</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.213.1"> module.</span></span></p>
<p><span class="koboSpan" id="kobo.214.1">Drupal has always supported modules that contain additional submodules, an uncommon practice in other systems. </span><span class="koboSpan" id="kobo.214.2">As Drupal adopted</span><a id="_idTextAnchor141"/><span class="koboSpan" id="kobo.215.1"> Composer, it enforced namespaced dependencies in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">info.yml</span></strong><span class="koboSpan" id="kobo.217.1"> file. </span><span class="koboSpan" id="kobo.217.2">This identifies the root package and the specific module it contains to </span><span class="No-Break"><span class="koboSpan" id="kobo.218.1">be installed.</span></span></p>
<p><span class="koboSpan" id="kobo.219.1">If your module has dependencies and you plan to contribute it, remember to create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">composer.json</span></strong><span class="koboSpan" id="kobo.221.1"> file and </span><a id="_idIndexMarker232"/><span class="koboSpan" id="kobo.222.1">define your dependencies so that they will be downloaded </span><span class="No-Break"><span class="koboSpan" id="kobo.223.1">with Composer.</span></span></p>
<h2 id="_idParaDest-136"><a id="_idTextAnchor142"/><span class="koboSpan" id="kobo.224.1">See more…</span></h2>
<ul>
<li><span class="koboSpan" id="kobo.225.1">Refer to the </span><em class="italic"><span class="koboSpan" id="kobo.226.1">PSR-4: Autoloading </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.227.1">specification</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">: </span></span><a href="https://www.php-fig.org/psr/psr-4/"><span class="No-Break"><span class="koboSpan" id="kobo.229.1">https://www.php-fig.org/psr/psr-4/</span></span></a></li>
<li><span class="koboSpan" id="kobo.230.1">Changing a record by adding </span><strong class="source-inline"><span class="koboSpan" id="kobo.231.1">core_version_requirement</span></strong><span class="koboSpan" id="kobo.232.1"> and the reasonings behind its </span><span class="No-Break"><span class="koboSpan" id="kobo.233.1">addition: </span></span><a href="https://www.drupal.org/node/3070687"><span class="No-Break"><span class="koboSpan" id="kobo.234.1">https://www.drupal.org/node/3070687</span></span></a></li>
<li><a href="http://Drupal.org"><span class="koboSpan" id="kobo.235.1">Drupal.org</span></a><span class="koboSpan" id="kobo.236.1"> documentation for creating a </span><span class="No-Break"><span class="koboSpan" id="kobo.237.1">module: </span></span><a href="https://www.drupal.org/docs/creating-custom-modules"><span class="No-Break"><span class="koboSpan" id="kobo.238.1">https://www.drupal.org/docs/creating-custom-modules</span></span></a></li>
</ul>
<h1 id="_idParaDest-137"><a id="_idTextAnchor143"/><span class="koboSpan" id="kobo.239.1">Providing configuration settings for your module</span></h1>
<p><span class="koboSpan" id="kobo.240.1">Modules can</span><a id="_idIndexMarker233"/><span class="koboSpan" id="kobo.241.1"> leverage configuration settings to allow end users to modify how they operate. </span><span class="koboSpan" id="kobo.241.2">These pieces of configuration are YAML files. </span><span class="koboSpan" id="kobo.241.3">Modules can also provide default configuration for other modules when they are installed. </span><span class="koboSpan" id="kobo.241.4">Once the module has been installed, the default configuration it provides is imported into Drupal. </span><span class="koboSpan" id="kobo.241.5">Modules may also modify existing configurations programmatically through an installation hook or </span><span class="No-Break"><span class="koboSpan" id="kobo.242.1">update hooks.</span></span></p>
<p><span class="koboSpan" id="kobo.243.1">In this recipe, we will provide a configuration that creates a new contact form and then manipulates it through an </span><span class="No-Break"><span class="koboSpan" id="kobo.244.1">update hook.</span></span></p>
<h2 id="_idParaDest-138"><a id="_idTextAnchor144"/><span class="koboSpan" id="kobo.245.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.246.1">This recipe requires a custom module, like the one created in the first recipe. </span><span class="koboSpan" id="kobo.246.2">We will refer to the module as </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">mymodule</span></strong><span class="koboSpan" id="kobo.248.1"> throughout this recipe. </span><span class="koboSpan" id="kobo.248.2">Use your module’s appropriate name </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">where necessary.</span></span></p>
<h2 id="_idParaDest-139"><a id="_idTextAnchor145"/><span class="koboSpan" id="kobo.250.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.251.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.252.1">config</span></strong><span class="koboSpan" id="kobo.253.1"> folder in your module’s directory. </span><span class="koboSpan" id="kobo.253.2">Then, in that directory, create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.254.1">install</span></strong><span class="koboSpan" id="kobo.255.1"> directory. </span><span class="koboSpan" id="kobo.255.2">Drupal looks for YAML configuration in this </span><span class="No-Break"><span class="koboSpan" id="kobo.256.1">installation directory:</span></span><pre class="console"><span class="koboSpan" id="kobo.257.1">
mkdir -p config/install</span></pre></li>
<li><span class="koboSpan" id="kobo.258.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">install</span></strong><span class="koboSpan" id="kobo.260.1"> directory, create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">contact.form.contactus.yml</span></strong><span class="koboSpan" id="kobo.262.1"> file to store the YAML definition of the contact form, </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">Contact Us</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.264.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.265.1">Add the following</span><a id="_idIndexMarker234"/><span class="koboSpan" id="kobo.266.1"> YAML content to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">contact.form.contactus.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.268.1"> file:</span></span><pre class="console"><span class="koboSpan" id="kobo.269.1">
langcode: en</span></pre><pre class="console"><span class="koboSpan" id="kobo.270.1">
status: true</span></pre><pre class="console"><span class="koboSpan" id="kobo.271.1">
dependencies: { }</span></pre><pre class="console"><span class="koboSpan" id="kobo.272.1">
id: contactus</span></pre><pre class="console"><span class="koboSpan" id="kobo.273.1">
label: 'Contact Us'</span></pre><pre class="console"><span class="koboSpan" id="kobo.274.1">
recipients:</span></pre><pre class="console"><span class="koboSpan" id="kobo.275.1">
- webmaster@example.co</span><a id="_idTextAnchor146"/><span class="koboSpan" id="kobo.276.1">m</span></pre><pre class="console"><span class="koboSpan" id="kobo.277.1">
reply: ''</span></pre><pre class="console"><span class="koboSpan" id="kobo.278.1">
weight: 0</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.279.1">This YAML file represents the exported configuration object for a contact form. </span><strong class="source-inline"><span class="koboSpan" id="kobo.280.1">id</span></strong><span class="koboSpan" id="kobo.281.1"> is the contact form’s machine name and </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">label</span></strong><span class="koboSpan" id="kobo.283.1"> is the human display name for the user interface. </span><span class="koboSpan" id="kobo.283.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">recipients</span></strong><span class="koboSpan" id="kobo.285.1"> key is a YAML array of valid email addresses. </span><span class="koboSpan" id="kobo.285.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">reply</span></strong><span class="koboSpan" id="kobo.287.1"> key is a string of text for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">Auto-reply</span></strong><span class="koboSpan" id="kobo.289.1"> message. </span><span class="koboSpan" id="kobo.289.2">Finally, </span><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">weight</span></strong><span class="koboSpan" id="kobo.291.1"> defines the ordering of the form on the </span><span class="No-Break"><span class="koboSpan" id="kobo.292.1">administrative list.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.293.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.294.1">Normally, you do not manually write configuration YAML like this. </span><span class="koboSpan" id="kobo.294.2">You will generally export it individually from the Drupal site </span><span class="No-Break"><span class="koboSpan" id="kobo.295.1">if needed.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.296.1">Install the module </span><span class="No-Break"><span class="koboSpan" id="kobo.297.1">using Drush:</span></span><pre class="console"><span class="koboSpan" id="kobo.298.1">
php vendor/bin/drush en mymodule --yes</span></pre></li>
<li><span class="koboSpan" id="kobo.299.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.300.1">Contact Us</span></strong><span class="koboSpan" id="kobo.301.1"> form will now be located on the </span><strong class="bold"><span class="koboSpan" id="kobo.302.1">Contact forms</span></strong><span class="koboSpan" id="kobo.303.1"> overview page, located </span><span class="No-Break"><span class="koboSpan" id="kobo.304.1">under </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.305.1">Structure</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.306.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.307.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">mymodule.post_update.php</span></strong><span class="koboSpan" id="kobo.309.1"> file in the module’s directory. </span><span class="koboSpan" id="kobo.309.2">This file contains update hooks to be run after </span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">schema changes.</span></span></li>
<li><span class="koboSpan" id="kobo.311.1">We will create </span><a id="_idIndexMarker235"/><span class="koboSpan" id="kobo.312.1">a function called </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">mymodule_post_update_change_contactus_reply()</span></strong><span class="koboSpan" id="kobo.314.1"> that will be executed by the update system to modify the contact </span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">form’s configuration:</span></span><pre class="console"><span class="koboSpan" id="kobo.316.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.317.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.318.1">
 * Update "Contact Us" form to have a reply message.</span></pre><pre class="console"><span class="koboSpan" id="kobo.319.1">
 */</span></pre><pre class="console"><span class="koboSpan" id="kobo.320.1">
function mymodule_post_update_change_contactus_reply()</span></pre><pre class="console"><span class="koboSpan" id="kobo.321.1">
  {</span></pre><pre class="console"><span class="koboSpan" id="kobo.322.1">
  $contact_form = \Drupal\contact\Entity\Contact</span></pre><pre class="console"><span class="koboSpan" id="kobo.323.1">
    Form::load('contactus');</span></pre><pre class="console"><span class="koboSpan" id="kobo.324.1">
  $contact_form-&gt;setReply(t('Thank you for contacting</span></pre><pre class="console"><span class="koboSpan" id="kobo.325.1">
    us, we will reply shortly'));</span></pre><pre class="console"><span class="koboSpan" id="kobo.326.1">
  $contact_f</span><a id="_idTextAnchor147"/><span class="koboSpan" id="kobo.327.1">orm-&gt;save();</span></pre><pre class="console"><span class="koboSpan" id="kobo.328.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.329.1">This function uses the entity’s class to load the contact form entity object. </span><span class="koboSpan" id="kobo.329.2">It loads the </span><strong class="bold"><span class="koboSpan" id="kobo.330.1">Contact Us</span></strong><span class="koboSpan" id="kobo.331.1"> contact form, which our module has provided, and sets the reply property to its </span><span class="No-Break"><span class="koboSpan" id="kobo.332.1">new value.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.333.1">Run updates for the Drupal site </span><span class="No-Break"><span class="koboSpan" id="kobo.334.1">using Drush:</span></span><pre class="console"><span class="koboSpan" id="kobo.335.1">
php vendor/bin/drush updb</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.336.1">Drush will list the updates to be applied, including the one you just wrote. </span><span class="koboSpan" id="kobo.336.2">The function comment of an </span><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">update</span></strong><span class="koboSpan" id="kobo.338.1"> function will be output in the list of updates to be applied. </span><span class="koboSpan" id="kobo.338.2">After reviewing the changes, you can tell Drush to proceed by entering </span><strong class="source-inline"><span class="koboSpan" id="kobo.339.1">yes</span></strong><span class="koboSpan" id="kobo.340.1"> on the </span><span class="No-Break"><span class="koboSpan" id="kobo.341.1">command line.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.342.1">Review the </span><strong class="bold"><span class="koboSpan" id="kobo.343.1">Contact Us</span></strong><span class="koboSpan" id="kobo.344.1"> form settings and verify that the reply message has </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">been set.</span></span></li>
</ol>
<h2 id="_idParaDest-140"><a id="_idTextAnchor148"/><span class="koboSpan" id="kobo.346.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.347.1">Drupal’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">moduler_installer</span></strong><span class="koboSpan" id="kobo.349.1"> service, provided </span><a id="_idIndexMarker236"/><span class="koboSpan" id="kobo.350.1">through </span><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">\Drupal\Core\Extension\ModuleInstaller</span></strong><span class="koboSpan" id="kobo.352.1">, ensures that configuration items defined in the module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.353.1">config</span></strong><span class="koboSpan" id="kobo.354.1"> folder are processed on installation. </span><span class="koboSpan" id="kobo.354.2">When a module is installed, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">config.installer</span></strong><span class="koboSpan" id="kobo.356.1"> service, provided through </span><strong class="source-inline"><span class="koboSpan" id="kobo.357.1">\Drupal\Core\Config\ConfigInstaller</span></strong><span class="koboSpan" id="kobo.358.1">, is called to process the module’s </span><span class="No-Break"><span class="koboSpan" id="kobo.359.1">default configuration.</span></span></p>
<p><span class="koboSpan" id="kobo.360.1">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.361.1">config.installer</span></strong><span class="koboSpan" id="kobo.362.1"> service attempts to import configuration from a module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.363.1">config/install</span></strong><span class="koboSpan" id="kobo.364.1"> folder that already exists, an exception will be thrown. </span><span class="koboSpan" id="kobo.364.2">Modules cannot provide duplicated configuration or modify existing configuration objects via the </span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">YAML files.</span></span></p>
<p><span class="koboSpan" id="kobo.366.1">Since modules cannot adjust configuration objects through YAML files provided to Drupal, they can utilize the update system to modify the configuration. </span><span class="koboSpan" id="kobo.366.2">The update system has two update processes: schema updates and post updates. </span><span class="koboSpan" id="kobo.366.3">Since we did not make schema-level changes, we used the post-update process. </span><span class="koboSpan" id="kobo.366.4">This allows us to make modifications to existing </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">configuration objects.</span></span></p>
<p><span class="koboSpan" id="kobo.368.1">In </span><a href="B18548_07.xhtml#_idTextAnchor240"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.369.1">Chapter 7</span></em></span></a><span class="koboSpan" id="kobo.370.1">, </span><em class="italic"><span class="koboSpan" id="kobo.371.1">Creating Forms with the Form API</span></em><span class="koboSpan" id="kobo.372.1">, we will create a form for modifying </span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">configuration settings.</span></span></p>
<h2 id="_idParaDest-141"><a id="_idTextAnchor149"/><span class="koboSpan" id="kobo.374.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.375.1">We will now dive into some important notes when working with modules </span><span class="No-Break"><span class="koboSpan" id="kobo.376.1">and configurations.</span></span></p>
<h3><span class="koboSpan" id="kobo.377.1">Configuration subdirectories</span></h3>
<p><span class="koboSpan" id="kobo.378.1">There are three </span><a id="_idIndexMarker237"/><span class="koboSpan" id="kobo.379.1">directories that the configuration management system will inspect in a module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">config</span></strong><span class="koboSpan" id="kobo.381.1"> folder, which are </span><span class="No-Break"><span class="koboSpan" id="kobo.382.1">as follows:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">install</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.384.1">optional</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">schema</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.386.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">install</span></strong><span class="koboSpan" id="kobo.388.1"> folder specifies the configuration that will be imported. </span><span class="koboSpan" id="kobo.388.2">If the configuration object exists, the installation will fail. </span><span class="koboSpan" id="kobo.388.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">optional</span></strong><span class="koboSpan" id="kobo.390.1"> folder contains the configuration that will be installed if the following conditions </span><span class="No-Break"><span class="koboSpan" id="kobo.391.1">are met:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.392.1">The configuration does not </span><span class="No-Break"><span class="koboSpan" id="kobo.393.1">already exist</span></span></li>
<li><span class="koboSpan" id="kobo.394.1">It is a </span><span class="No-Break"><span class="koboSpan" id="kobo.395.1">configuration entity</span></span></li>
<li><span class="koboSpan" id="kobo.396.1">Its dependencies can </span><span class="No-Break"><span class="koboSpan" id="kobo.397.1">be met</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.398.1">If any one of the conditions fails, the configuration will not be installed, but it will not halt the module’s installation process. </span><span class="koboSpan" id="kobo.398.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.399.1">schema</span></strong><span class="koboSpan" id="kobo.400.1"> folder provides configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1">object definitions.</span></span></p>
<h3><span class="koboSpan" id="kobo.402.1">Modifying the existing configuration on installation</span></h3>
<p><span class="koboSpan" id="kobo.403.1">The configuration</span><a id="_idIndexMarker238"/><span class="koboSpan" id="kobo.404.1"> management system does not allow modules to provide configuration on an installation that already exists. </span><span class="koboSpan" id="kobo.404.2">For example, if a module tries to provide </span><strong class="source-inline"><span class="koboSpan" id="kobo.405.1">system.site</span></strong><span class="koboSpan" id="kobo.406.1"> and defines the site’s name, it would fail to install. </span><span class="koboSpan" id="kobo.406.2">This is because the </span><strong class="source-inline"><span class="koboSpan" id="kobo.407.1">system</span></strong><span class="koboSpan" id="kobo.408.1"> module provides this configuration object when you first </span><span class="No-Break"><span class="koboSpan" id="kobo.409.1">install Drupal.</span></span></p>
<p><span class="koboSpan" id="kobo.410.1">Modules may also have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.411.1">.install</span></strong><span class="koboSpan" id="kobo.412.1"> file, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.413.1">mymodule.install</span></strong><span class="koboSpan" id="kobo.414.1"> for our recipe’s module. </span><span class="koboSpan" id="kobo.414.2">This file is where modules may implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.415.1">hook_install</span></strong><span class="koboSpan" id="kobo.416.1"> hook provided by Drupal, along with schema </span><span class="No-Break"><span class="koboSpan" id="kobo.417.1">update hooks.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">hook_install()</span></strong><span class="koboSpan" id="kobo.419.1"> is executed during the module’s installation process. </span><span class="koboSpan" id="kobo.419.2">The following code will update the</span><a id="_idIndexMarker239"/><span class="koboSpan" id="kobo.420.1"> site’s title to </span><strong class="source-inline"><span class="koboSpan" id="kobo.421.1">Drupal Development Cookbook</span></strong><span class="koboSpan" id="kobo.422.1">! </span><span class="koboSpan" id="kobo.422.2">on the </span><span class="No-Break"><span class="koboSpan" id="kobo.423.1">module’s installation:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.424.1">
&lt;?php
/**
* Implements hook_install().
</span><span class="koboSpan" id="kobo.424.2">*/
function mymodule_install() {
  // Set the site name.
</span><span class="koboSpan" id="kobo.424.3">  \Drupal::configFactory()
    -&gt;getEditable('system.site')
    -&gt;set('name', 'Drupal Development Cookbook!')
    -&gt;save();
}</span></pre>
<p><span class="koboSpan" id="kobo.425.1">Configurable objects are immutable by default, meaning they cannot be changed or saved when loaded by the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">config</span></strong><span class="koboSpan" id="kobo.427.1"> service. </span><span class="koboSpan" id="kobo.427.2">To modify a configuration object, you will need to use the configuration factory to receive an editable instance of a configuration object. </span><span class="koboSpan" id="kobo.427.3">This</span><a id="_idIndexMarker240"/><span class="koboSpan" id="kobo.428.1"> object can have </span><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">set</span></strong><span class="koboSpan" id="kobo.430.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">save</span></strong><span class="koboSpan" id="kobo.432.1"> methods that are executed to update the configuration in a </span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">configuration object.</span></span></p>
<h3><span class="koboSpan" id="kobo.434.1">Schema update hooks</span></h3>
<p><span class="koboSpan" id="kobo.435.1">This recipe </span><a id="_idIndexMarker241"/><span class="koboSpan" id="kobo.436.1">mentioned schema update hooks. </span><span class="koboSpan" id="kobo.436.2">These are intended to be used to make changes to any database schema or entity field definitions. </span><span class="koboSpan" id="kobo.436.3">When the update system runs, the schema hooks are run first; then, post-updates </span><span class="No-Break"><span class="koboSpan" id="kobo.437.1">are executed.</span></span></p>
<p><span class="koboSpan" id="kobo.438.1">The schema update hooks are defined as </span><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">hook_update_N</span></strong><span class="koboSpan" id="kobo.440.1">, where </span><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">N</span></strong><span class="koboSpan" id="kobo.442.1"> is a numeric schema version value. </span><span class="koboSpan" id="kobo.442.2">When schema update hooks are executed, they are run in order of their schema version. </span><span class="koboSpan" id="kobo.442.3">Generally, the base schema version is based on the major version of Drupal core or the module’s versioning. </span><span class="koboSpan" id="kobo.442.4">In custom code, it can be anything </span><span class="No-Break"><span class="koboSpan" id="kobo.443.1">you wish.</span></span></p>
<p><span class="koboSpan" id="kobo.444.1">The naming conventions for schema updates have been under discussion since Drupal 8 regarding the support of semantic versioning in contributed projects. </span><span class="koboSpan" id="kobo.444.2">These naming conventions are</span><a id="_idIndexMarker242"/><span class="koboSpan" id="kobo.445.1"> discussed in the </span><span class="No-Break"><span class="koboSpan" id="kobo.446.1">following issues:</span></span></p>
<ul>
<li><a href="https://www.drupal.org/project/drupal/issues/3106712"><span class="No-Break"><span class="koboSpan" id="kobo.447.1">https://www.drupal.org/project/drupal/issues/3106712</span></span></a></li>
<li><a href="https://www.drupal.org/project/drupal/issues/3010334"><span class="No-Break"><span class="koboSpan" id="kobo.448.1">https://www.drupal.org/project/drupal/issues/3010334</span></span></a></li>
</ul>
<h2 id="_idParaDest-142"><a id="_idTextAnchor150"/><span class="koboSpan" id="kobo.449.1">See also</span></h2>
<ul>
<li><span class="koboSpan" id="kobo.450.1">Update API documentation on </span><span class="No-Break"><span class="koboSpan" id="kobo.451.1">Drupal.org: </span></span><a href="https://www.drupal.org/docs/drupal-apis/update-api"><span class="No-Break"><span class="koboSpan" id="kobo.452.1">https://www.drupal.org/docs/drupal-apis/update-api</span></span></a></li>
<li><a href="B18548_07.xhtml#_idTextAnchor240"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.453.1">Chapter 7</span></em></span></a><span class="koboSpan" id="kobo.454.1">, </span><em class="italic"><span class="koboSpan" id="kobo.455.1">Creating Forms with the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.456.1">Form API</span></em></span></li>
</ul>
<h1 id="_idParaDest-143"><a id="_idTextAnchor151"/><span class="koboSpan" id="kobo.457.1">Defining permissions and checking whether a user has access</span></h1>
<p><span class="koboSpan" id="kobo.458.1">In Drupal, roles and </span><a id="_idIndexMarker243"/><span class="koboSpan" id="kobo.459.1">permissions </span><a id="_idIndexMarker244"/><span class="koboSpan" id="kobo.460.1">are used to define robust access control lists for users. </span><span class="koboSpan" id="kobo.460.2">Modules use permissions to check whether the current user has access to perform an action, view specific items, or do other operations. </span><span class="koboSpan" id="kobo.460.3">Modules then define the permissions that are used so that Drupal is aware of them. </span><span class="koboSpan" id="kobo.460.4">Developers can then construct roles, which are made up of </span><span class="No-Break"><span class="koboSpan" id="kobo.461.1">enabled permissions.</span></span></p>
<p><span class="koboSpan" id="kobo.462.1">In this recipe, we will define new permission(s) in a module that is used to check if the user can mark content as promoted to the front page or sticky at the top of lists. </span><span class="koboSpan" id="kobo.462.2">This permission will be used in an entity field access hook to deny access to the fields if the user is missing </span><span class="No-Break"><span class="koboSpan" id="kobo.463.1">the permission.</span></span></p>
<h2 id="_idParaDest-144"><a id="_idTextAnchor152"/><span class="koboSpan" id="kobo.464.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.465.1">Create a new module, as we did in the first recipe. </span><span class="koboSpan" id="kobo.465.2">We will refer to the module as </span><strong class="source-inline"><span class="koboSpan" id="kobo.466.1">mymodule</span></strong><span class="koboSpan" id="kobo.467.1"> throughout this recipe. </span><span class="koboSpan" id="kobo.467.2">Use your module’s name in the following recipe </span><span class="No-Break"><span class="koboSpan" id="kobo.468.1">as appropriate.</span></span></p>
<p><span class="koboSpan" id="kobo.469.1">Create a new Drupal user with the Content editor role. </span><span class="koboSpan" id="kobo.469.2">Drupal bypasses access checks for the first user. </span><span class="koboSpan" id="kobo.469.3">The secondary user will be required to demonstrate </span><span class="No-Break"><span class="koboSpan" id="kobo.470.1">the permission.</span></span></p>
<h2 id="_idParaDest-145"><a id="_idTextAnchor153"/><span class="koboSpan" id="kobo.471.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.472.1">Permissions are stored in a </span><strong class="source-inline"><span class="koboSpan" id="kobo.473.1">permissions.yml</span></strong><span class="koboSpan" id="kobo.474.1"> file. </span><span class="koboSpan" id="kobo.474.2">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">mymodule.permissions.yml</span></strong><span class="koboSpan" id="kobo.476.1"> file to the base directory of </span><span class="No-Break"><span class="koboSpan" id="kobo.477.1">your module.</span></span></li>
<li><span class="koboSpan" id="kobo.478.1">First, we will need to define the internal string used to identify this permission, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">can </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.480.1">promote nodes</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.481.1">:</span></span><pre class="console"><span class="koboSpan" id="kobo.482.1">
can promote nodes:</span></pre></li>
<li><span class="koboSpan" id="kobo.483.1">Each </span><a id="_idIndexMarker245"/><span class="koboSpan" id="kobo.484.1">permission is a YAML array of data. </span><span class="koboSpan" id="kobo.484.2">We will need to provide </span><a id="_idIndexMarker246"/><span class="koboSpan" id="kobo.485.1">a </span><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">title</span></strong><span class="koboSpan" id="kobo.487.1"> key that will be displayed on the </span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">permissions page:</span></span><pre class="console"><span class="koboSpan" id="kobo.489.1">
can promote nodes:</span></pre><pre class="console"><span class="koboSpan" id="kobo.490.1">
  title: 'Can promote content'</span></pre></li>
<li><span class="koboSpan" id="kobo.491.1">Permissions have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.492.1">description</span></strong><span class="koboSpan" id="kobo.493.1"> key to provide details of the permission on the </span><span class="No-Break"><span class="koboSpan" id="kobo.494.1">permissions page:</span></span><pre class="console"><span class="koboSpan" id="kobo.495.1">
can promote nodes:</span></pre><pre class="console"><span class="koboSpan" id="kobo.496.1">
  title: 'Can promote content'</span></pre><pre class="console"><span class="koboSpan" id="kobo.497.1">
  description: 'Determines if the user can change pro</span></pre><pre class="console"><span class="koboSpan" id="kobo.498.1">
    motion fields on content.'</span></pre></li>
<li><span class="koboSpan" id="kobo.499.1">Save your </span><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">mymodule.permissions.yml</span></strong><span class="koboSpan" id="kobo.501.1"> file and edit the module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.502.1">mymodule.module</span></strong><span class="koboSpan" id="kobo.503.1"> file so that we may write our hook to use </span><span class="No-Break"><span class="koboSpan" id="kobo.504.1">the permission.</span></span></li>
<li><span class="koboSpan" id="kobo.505.1">In your </span><strong class="source-inline"><span class="koboSpan" id="kobo.506.1">mymodule.module</span></strong><span class="koboSpan" id="kobo.507.1"> file, add a function named </span><strong class="source-inline"><span class="koboSpan" id="kobo.508.1">mymodule_entity_field_access</span></strong><span class="koboSpan" id="kobo.509.1"> to implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.510.1">hook_entity_field_access</span></strong><span class="koboSpan" id="kobo.511.1">. </span><span class="koboSpan" id="kobo.511.2">This is invoked to control access at a granular level per field on </span><span class="No-Break"><span class="koboSpan" id="kobo.512.1">entity forms:</span></span><pre class="console"><span class="koboSpan" id="kobo.513.1">
function mymodule_entity_field_access(</span></pre><pre class="console"><span class="koboSpan" id="kobo.514.1">
  $operation,</span></pre><pre class="console"><span class="koboSpan" id="kobo.515.1">
  \Drupal\Core\Field\FieldDefinitionInterface</span></pre><pre class="console"><span class="koboSpan" id="kobo.516.1">
    $field_definition,</span></pre><pre class="console"><span class="koboSpan" id="kobo.517.1">
  \Drupal\Core\Session\AccountInterface $account</span></pre><pre class="console"><span class="koboSpan" id="kobo.518.1">
) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.519.1">
  return \Drupal\Core\Access\AccessResult::neutral();</span></pre><pre class="console"><span class="koboSpan" id="kobo.520.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.521.1">Drupal uses access result value objects to handle access results. </span><span class="koboSpan" id="kobo.521.2">Access results may be neutral, forbidden, or </span><a id="_idIndexMarker247"/><span class="koboSpan" id="kobo.522.1">allowed. </span><span class="koboSpan" id="kobo.522.2">Hooks implementing </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">hook_entity_field_access</span></strong><span class="koboSpan" id="kobo.524.1"> must </span><a id="_idIndexMarker248"/><span class="koboSpan" id="kobo.525.1">return an access result and cannot </span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">return </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">null</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.528.1">.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.529.1">In our hook, we will check the field name being checked. </span><span class="koboSpan" id="kobo.529.2">If the field name is </span><strong class="source-inline"><span class="koboSpan" id="kobo.530.1">promote</span></strong><span class="koboSpan" id="kobo.531.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.532.1">sticky</span></strong><span class="koboSpan" id="kobo.533.1">, we will check whether the user has the </span><strong class="source-inline"><span class="koboSpan" id="kobo.534.1">can promote nodes</span></strong><span class="koboSpan" id="kobo.535.1"> permission and return that </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">access result:</span></span><pre class="console"><span class="koboSpan" id="kobo.537.1">
function mymodule_entity_field_access(</span></pre><pre class="console"><span class="koboSpan" id="kobo.538.1">
  $operation,</span></pre><pre class="console"><span class="koboSpan" id="kobo.539.1">
  \Drupal\Core\Field\FieldDefinitionInterface</span></pre><pre class="console"><span class="koboSpan" id="kobo.540.1">
    $field_definition,</span></pre><pre class="console"><span class="koboSpan" id="kobo.541.1">
  \Drupal\Core\Session\AccountInterface $account</span></pre><pre class="console"><span class="koboSpan" id="kobo.542.1">
) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.543.1">
  $field_name = $field_definition-&gt;getName();</span></pre><pre class="console"><span class="koboSpan" id="kobo.544.1">
  if ($field_name === 'promote' || $field_name ===</span></pre><pre class="console"><span class="koboSpan" id="kobo.545.1">
    'sticky') {</span></pre><pre class="console"><span class="koboSpan" id="kobo.546.1">
    $can_promote_nodes = $account-&gt;hasPermission('can</span></pre><pre class="console"><span class="koboSpan" id="kobo.547.1">
        promote nodes');</span></pre><pre class="console"><span class="koboSpan" id="kobo.548.1">
    return Drupal\Core\Access\AccessResult::allowedIf</span></pre><pre class="console"><span class="koboSpan" id="kobo.549.1">
         ($can_promote_nodes);</span></pre><pre class="console"><span class="koboSpan" id="kobo.550.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.551.1">
  return \Drupal\Core\Access\AccessResult::neutral();</span></pre><pre class="console"><span class="koboSpan" id="kobo.552.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.553.1">The access result object has an </span><strong class="source-inline"><span class="koboSpan" id="kobo.554.1">allowedIf</span></strong><span class="koboSpan" id="kobo.555.1"> method that returns an appropriate result based </span><a id="_idIndexMarker249"/><span class="koboSpan" id="kobo.556.1">on</span><a id="_idIndexMarker250"/><span class="koboSpan" id="kobo.557.1"> the parameter provided. </span><span class="koboSpan" id="kobo.557.2">In this case, it will return </span><strong class="source-inline"><span class="koboSpan" id="kobo.558.1">AccessResult::allowed()</span></strong><span class="koboSpan" id="kobo.559.1"> if the user has the permission or </span><strong class="source-inline"><span class="koboSpan" id="kobo.560.1">AccessResult::neutral()</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.561.1">if not.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.562.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.563.1">Drupal’s access system requires explicit allowance. </span><span class="koboSpan" id="kobo.563.2">If an access result is neutral, the system will keep processing access results. </span><span class="koboSpan" id="kobo.563.3">If an access result is returned as forbidden or allowed, the access checks stop, and that result is used. </span><span class="koboSpan" id="kobo.563.4">If the ending result is neutral, access is not granted since it was not </span><span class="No-Break"><span class="koboSpan" id="kobo.564.1">explicitly allowed.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.565.1">New permissions are not granted to roles automatically. </span><span class="koboSpan" id="kobo.565.2">In another browser or guest tab, log in as a user with the Content editor role and create a piece of content. </span><span class="koboSpan" id="kobo.565.3">The </span><strong class="bold"><span class="koboSpan" id="kobo.566.1">Promotion options</span></strong><span class="koboSpan" id="kobo.567.1"> section of the sidebar will be missing since we do not have </span><span class="No-Break"><span class="koboSpan" id="kobo.568.1">field access:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer033">
<span class="koboSpan" id="kobo.569.1"><img alt="Figure 4.2 – Promotion options are hidden due to missing permissions" src="image/Figure_4.02_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.570.1">Figure 4.2 – Promotion options are hidden due to missing permissions</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.571.1">As your administrative user, go to </span><strong class="bold"><span class="koboSpan" id="kobo.572.1">People</span></strong><span class="koboSpan" id="kobo.573.1"> and then to </span><strong class="bold"><span class="koboSpan" id="kobo.574.1">Permissions</span></strong><span class="koboSpan" id="kobo.575.1"> to add your</span><a id="_idIndexMarker251"/><span class="koboSpan" id="kobo.576.1"> permission </span><a id="_idIndexMarker252"/><span class="koboSpan" id="kobo.577.1">for the Content editor role in the </span><strong class="bold"><span class="koboSpan" id="kobo.578.1">My </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.579.1">Module</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.580.1"> section:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer034">
<span class="koboSpan" id="kobo.581.1"><img alt="Figure 4.3 – Adding the permission to the Content editor role" src="image/Figure_4.03_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.582.1">Figure 4.3 – Adding the permission to the Content editor role</span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.583.1">Using your Content editor user, try and create a piece of content once more. </span><span class="koboSpan" id="kobo.583.2">The </span><strong class="bold"><span class="koboSpan" id="kobo.584.1">Promotion options</span></strong><span class="koboSpan" id="kobo.585.1"> section in the sidebar will </span><span class="No-Break"><span class="koboSpan" id="kobo.586.1">be present:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer035">
<span class="koboSpan" id="kobo.587.1"><img alt="Figure 4.4 – The Promotion options section appears once the permission has been granted" src="image/Figure_4.04_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.588.1">Figure 4.4 – The Promotion options section appears once the permission has been granted</span></p>
<h2 id="_idParaDest-146"><a id="_idTextAnchor154"/><span class="koboSpan" id="kobo.589.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.590.1">Permissions and roles are provided by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.591.1">User</span></strong><span class="koboSpan" id="kobo.592.1"> module. </span><span class="koboSpan" id="kobo.592.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.593.1">user.permissions</span></strong><span class="koboSpan" id="kobo.594.1"> service discovers the </span><strong class="source-inline"><span class="koboSpan" id="kobo.595.1">permissions.yml</span></strong><span class="koboSpan" id="kobo.596.1"> file provided by installed modules. </span><span class="koboSpan" id="kobo.596.2">By default, the service is defined through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.597.1">\</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.598.1">Drupal\user\PermissionHandler</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.599.1"> class.</span></span></p>
<p><span class="koboSpan" id="kobo.600.1">Drupal does not save a list of all available permissions. </span><span class="koboSpan" id="kobo.600.2">The permissions for a system are loaded when the permissions page is loaded. </span><span class="koboSpan" id="kobo.600.3">Roles contain an array </span><span class="No-Break"><span class="koboSpan" id="kobo.601.1">of permissions.</span></span></p>
<p><span class="koboSpan" id="kobo.602.1">When checking</span><a id="_idIndexMarker253"/><span class="koboSpan" id="kobo.603.1"> a </span><a id="_idIndexMarker254"/><span class="koboSpan" id="kobo.604.1">user’s access for permission, Drupal checks all the user’s roles to see whether they support </span><span class="No-Break"><span class="koboSpan" id="kobo.605.1">that permission.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.606.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.607.1">You can pass undefined permissions to a user access check and not receive an error. </span><span class="koboSpan" id="kobo.607.2">The access check will simply fail unless the user is UID 1, which bypasses access checks. </span><span class="koboSpan" id="kobo.607.3">In Drupal, user UID 1 is the root user and is not beholden to security checks or permissions. </span><span class="koboSpan" id="kobo.607.4">Be careful when granting access to that account or using user 1 </span><span class="No-Break"><span class="koboSpan" id="kobo.608.1">in testing.</span></span></p>
<h2 id="_idParaDest-147"><a id="_idTextAnchor155"/><span class="koboSpan" id="kobo.609.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.610.1">We will cover more ways to work with permissions in your modules in the </span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">upcoming sections.</span></span></p>
<h3><span class="koboSpan" id="kobo.612.1">Restricting access flag for permissions</span></h3>
<p><span class="koboSpan" id="kobo.613.1">Permissions can </span><a id="_idIndexMarker255"/><span class="koboSpan" id="kobo.614.1">be flagged as having a security risk if enabled; this can be done via the restrict access flag. </span><span class="koboSpan" id="kobo.614.2">When this flag is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.615.1">restrict access: TRUE</span></strong><span class="koboSpan" id="kobo.616.1">, it will add a warning to the </span><span class="No-Break"><span class="koboSpan" id="kobo.617.1">permission’s description.</span></span></p>
<p><span class="koboSpan" id="kobo.618.1">This allows module developers to provide more context regarding the amount of control a permission may give </span><span class="No-Break"><span class="koboSpan" id="kobo.619.1">a user:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer036">
<span class="koboSpan" id="kobo.620.1"><img alt="Figure 4.5 – Example of permissions with the restrict access flag" src="image/Figure_4.05_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.621.1">Figure 4.5 – Example of permissions with the restrict access flag</span></p>
<p><span class="koboSpan" id="kobo.622.1">The permission definition from our recipe would look </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">like this:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.624.1">
can promote nodes:
  title: 'Can promote content'
  description: 'Determines if the user can change promotion
    fields on content.'
</span><span class="koboSpan" id="kobo.624.2">  Restrict access: TRUE</span></pre>
<h3><span class="koboSpan" id="kobo.625.1">Defining permissions programmatically</span></h3>
<p><span class="koboSpan" id="kobo.626.1">Permissions </span><a id="_idIndexMarker256"/><span class="koboSpan" id="kobo.627.1">can be defined by a module programmatically or statically in a YAML file. </span><span class="koboSpan" id="kobo.627.2">A module needs to provide a </span><strong class="source-inline"><span class="koboSpan" id="kobo.628.1">permission_callbacks</span></strong><span class="koboSpan" id="kobo.629.1"> key in its </span><strong class="source-inline"><span class="koboSpan" id="kobo.630.1">permissions.yml</span></strong><span class="koboSpan" id="kobo.631.1"> file that contains either an array of callable methods or functions to define </span><span class="No-Break"><span class="koboSpan" id="kobo.632.1">permissions dynamically.</span></span></p>
<p><span class="koboSpan" id="kobo.633.1">For example, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.634.1">Filter</span></strong><span class="koboSpan" id="kobo.635.1"> module provides granular permissions based on the different text filters created </span><span class="No-Break"><span class="koboSpan" id="kobo.636.1">in Drupal:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.637.1">
permission_callbacks:
  -Drupal\filter\FilterPermissions::permissions</span></pre>
<p><span class="koboSpan" id="kobo.638.1">This tells the </span><strong class="source-inline"><span class="koboSpan" id="kobo.639.1">user_permissions</span></strong><span class="koboSpan" id="kobo.640.1"> service to execute the permissions method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.641.1">\Drupal\Filter\FilterPermissions</span></strong><span class="koboSpan" id="kobo.642.1"> class. </span><span class="koboSpan" id="kobo.642.2">The method is expected to return an array that matches the same structure as that of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.643.1">permissions.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.644.1"> file.</span></span></p>
<h2 id="_idParaDest-148"><a id="_idTextAnchor156"/><span class="koboSpan" id="kobo.645.1">See also…</span></h2>
<ul>
<li><a href="B18548_05.xhtml#_idTextAnchor172"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.646.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.647.1">, </span><em class="italic"><span class="koboSpan" id="kobo.648.1">Creating </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.649.1">Custom Pages</span></em></span></li>
</ul>
<h1 id="_idParaDest-149"><a id="_idTextAnchor157"/><span class="koboSpan" id="kobo.650.1">Hooking into Drupal to react to entity changes</span></h1>
<p><span class="koboSpan" id="kobo.651.1">One of the most </span><a id="_idIndexMarker257"/><span class="koboSpan" id="kobo.652.1">common integration points is hooking into Drupal to react to the create, read, update, and delete operations of an entity. </span><span class="koboSpan" id="kobo.652.2">The entity system also has hooks to provide default values when instantiating a new entity and modifying it before it </span><span class="No-Break"><span class="koboSpan" id="kobo.653.1">is saved.</span></span></p>
<p><span class="koboSpan" id="kobo.654.1">In this recipe, we will create a hook that runs whenever new content is published and send an email to the site’s email address as a notification of the </span><span class="No-Break"><span class="koboSpan" id="kobo.655.1">new content.</span></span></p>
<h2 id="_idParaDest-150"><a id="_idTextAnchor158"/><span class="koboSpan" id="kobo.656.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.657.1">First, create a file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.658.1">mymodule.module</span></strong><span class="koboSpan" id="kobo.659.1"> in your </span><strong class="source-inline"><span class="koboSpan" id="kobo.660.1">module</span></strong><span class="koboSpan" id="kobo.661.1"> file. </span><span class="koboSpan" id="kobo.661.2">This is the module extension file that stores </span><span class="No-Break"><span class="koboSpan" id="kobo.662.1">hook implementations.</span></span></li>
<li><span class="koboSpan" id="kobo.663.1">Next, we will implement a hook to listen for new node entities being inserted. </span><span class="koboSpan" id="kobo.663.2">Create a function named </span><strong class="source-inline"><span class="koboSpan" id="kobo.664.1">mymodule_node_insert</span></strong><span class="koboSpan" id="kobo.665.1">, which is an implementation of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.666.1">hook_ENTITY_TYPE_insert</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.667.1"> hook:</span></span><pre class="console"><span class="koboSpan" id="kobo.668.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.669.1">
function mymodule_node_insert(\Drupal\node\</span></pre><pre class="console"><span class="koboSpan" id="kobo.670.1">
    NodeInterface $node) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.671.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.672.1">In our </span><strong class="source-inline"><span class="koboSpan" id="kobo.673.1">insert</span></strong><span class="koboSpan" id="kobo.674.1"> hook, we</span><a id="_idIndexMarker258"/><span class="koboSpan" id="kobo.675.1"> will check if the node was saved as published. </span><span class="koboSpan" id="kobo.675.2">If it was, we will send an </span><span class="No-Break"><span class="koboSpan" id="kobo.676.1">email notification:</span></span><pre class="console"><span class="koboSpan" id="kobo.677.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.678.1">
function mymodule_node_insert(\Drupal\node\</span></pre><pre class="console"><span class="koboSpan" id="kobo.679.1">
    NodeInterface $node) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.680.1">
  if ($node-&gt;isPublished()) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.681.1">
    $site_mail = \Drupal::config('system.site')-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.682.1">
        get('mail');</span></pre><pre class="console"><span class="koboSpan" id="kobo.683.1">
    /** @var \Drupal\Core\Mail\MailManager</span></pre><pre class="console"><span class="koboSpan" id="kobo.684.1">
        $mail_service */</span></pre><pre class="console"><span class="koboSpan" id="kobo.685.1">
    $mail_service = \Drupal::service(</span></pre><pre class="console"><span class="koboSpan" id="kobo.686.1">
        'plugin.manager.mail');</span></pre><pre class="console"><span class="koboSpan" id="kobo.687.1">
    $mail_service-&gt;mail(</span></pre><pre class="console"><span class="koboSpan" id="kobo.688.1">
      module: 'mymodule',</span></pre><pre class="console"><span class="koboSpan" id="kobo.689.1">
      key: 'node_published',</span></pre><pre class="console"><span class="koboSpan" id="kobo.690.1">
      to: $site_mail,</span></pre><pre class="console"><span class="koboSpan" id="kobo.691.1">
      langcode: 'en',</span></pre><pre class="console"><span class="koboSpan" id="kobo.692.1">
      params: ['node' =&gt; $node],</span></pre><pre class="console"><span class="koboSpan" id="kobo.693.1">
    );</span></pre><pre class="console"><span class="koboSpan" id="kobo.694.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.695.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.696.1">First, we check if the node has been published. </span><span class="koboSpan" id="kobo.696.2">The node entity type implements </span><strong class="source-inline"><span class="koboSpan" id="kobo.697.1">EntityPublishedInterface</span></strong><span class="koboSpan" id="kobo.698.1">, which provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.699.1">isPublished</span></strong><span class="koboSpan" id="kobo.700.1"> method. </span><span class="koboSpan" id="kobo.700.2">If the node has been published, we fetch the site’s email address from the configuration. </span><span class="koboSpan" id="kobo.700.3">To send an email, we need to fetch the mail manager service. </span><span class="koboSpan" id="kobo.700.4">With the mail manager service, we invoke the </span><strong class="source-inline"><span class="koboSpan" id="kobo.701.1">mail</span></strong><span class="koboSpan" id="kobo.702.1"> method. </span><span class="koboSpan" id="kobo.702.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.703.1">module</span></strong><span class="koboSpan" id="kobo.704.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.705.1">key</span></strong><span class="koboSpan" id="kobo.706.1"> parameters are used to invoke another hook in the module to generate the email’s content. </span><span class="koboSpan" id="kobo.706.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.707.1">to</span></strong><span class="koboSpan" id="kobo.708.1"> parameter is where the email should be sent. </span><strong class="source-inline"><span class="koboSpan" id="kobo.709.1">langcode</span></strong><span class="koboSpan" id="kobo.710.1"> represents what language the email should be sent in. </span><span class="koboSpan" id="kobo.710.2">Finally, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.711.1">params</span></strong><span class="koboSpan" id="kobo.712.1"> parameter </span><a id="_idIndexMarker259"/><span class="koboSpan" id="kobo.713.1">provides context values to the hook, which generates the </span><span class="No-Break"><span class="koboSpan" id="kobo.714.1">email content.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.715.1">We want to add a hook that listens when nodes are updated, as they may have first been saved as unpublished. </span><span class="koboSpan" id="kobo.715.2">Create a function named </span><strong class="source-inline"><span class="koboSpan" id="kobo.716.1">mymodule_node_update</span></strong><span class="koboSpan" id="kobo.717.1"> so that we can implement the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.718.1">hook_ENTITY_TYPE_update</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.719.1"> hook:</span></span><pre class="console"><span class="koboSpan" id="kobo.720.1">
function mymodule_node_update(\Drupal\node\NodeInter</span></pre><pre class="console"><span class="koboSpan" id="kobo.721.1">
    face $node) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.722.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.723.1">In our </span><strong class="source-inline"><span class="koboSpan" id="kobo.724.1">update</span></strong><span class="koboSpan" id="kobo.725.1"> hook, we will check if the unchanged version of the node was published or not. </span><span class="koboSpan" id="kobo.725.2">We do not want to send duplicate emails. </span><span class="koboSpan" id="kobo.725.3">We only send an email if the node was previously unpublished and then </span><span class="No-Break"><span class="koboSpan" id="kobo.726.1">became published:</span></span><pre class="console"><span class="koboSpan" id="kobo.727.1">
function mymodule_node_update(\Drupal\node\NodeInter</span></pre><pre class="console"><span class="koboSpan" id="kobo.728.1">
    face $node) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.729.1">
  if ($node-&gt;isPublished()) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.730.1">
    /** @var \Drupal\node\NodeInterface $original */</span></pre><pre class="console"><span class="koboSpan" id="kobo.731.1">
    $original = $node-&gt;original;</span></pre><pre class="console"><span class="koboSpan" id="kobo.732.1">
    if (!$original-&gt;isPublished()) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.733.1">
      $site_mail = \Drupal::config('system.site')-&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.734.1">
        get('mail');</span></pre><pre class="console"><span class="koboSpan" id="kobo.735.1">
      /** @var \Drupal\Core\Mail\MailManager</span></pre><pre class="console"><span class="koboSpan" id="kobo.736.1">
        $mail_service */</span></pre><pre class="console"><span class="koboSpan" id="kobo.737.1">
      $mail_service = \Drupal::service('plugin</span></pre><pre class="console"><span class="koboSpan" id="kobo.738.1">
        .manager.mail');</span></pre><pre class="console"><span class="koboSpan" id="kobo.739.1">
      $mail_service-&gt;mail(</span></pre><pre class="console"><span class="koboSpan" id="kobo.740.1">
        module: 'mymodule',</span></pre><pre class="console"><span class="koboSpan" id="kobo.741.1">
        key: 'node_published_update',</span></pre><pre class="console"><span class="koboSpan" id="kobo.742.1">
        to: $site_mail,</span></pre><pre class="console"><span class="koboSpan" id="kobo.743.1">
        langcode: 'en',</span></pre><pre class="console"><span class="koboSpan" id="kobo.744.1">
        params: ['node' =&gt; $node],</span></pre><pre class="console"><span class="koboSpan" id="kobo.745.1">
      );</span></pre><pre class="console"><span class="koboSpan" id="kobo.746.1">
    }</span></pre><pre class="console"><span class="koboSpan" id="kobo.747.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.748.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.749.1">As you can see, this </span><a id="_idIndexMarker260"/><span class="koboSpan" id="kobo.750.1">hook is nearly the same as our </span><strong class="source-inline"><span class="koboSpan" id="kobo.751.1">insert</span></strong><span class="koboSpan" id="kobo.752.1"> hook, but we check the values of the original node object. </span><span class="koboSpan" id="kobo.752.2">The entity storage sets the original property on an entity that has unchanged values from the database. </span><span class="koboSpan" id="kobo.752.3">This allows us to compare the previous values to the newly modified ones. </span><span class="koboSpan" id="kobo.752.4">In our hook, we verify that the original node was not already published before sending </span><span class="No-Break"><span class="koboSpan" id="kobo.753.1">our email.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.754.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.755.1">This hook uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.756.1">node_published_update</span></strong><span class="koboSpan" id="kobo.757.1"> key so that we can use different </span><span class="No-Break"><span class="koboSpan" id="kobo.758.1">email text.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.759.1">Now, we need to create a function named </span><strong class="source-inline"><span class="koboSpan" id="kobo.760.1">mymodule_mail</span></strong><span class="koboSpan" id="kobo.761.1"> that implements </span><strong class="source-inline"><span class="koboSpan" id="kobo.762.1">hook_mail</span></strong><span class="koboSpan" id="kobo.763.1">. </span><span class="koboSpan" id="kobo.763.2">This will allow us to define the content for our </span><span class="No-Break"><span class="koboSpan" id="kobo.764.1">email notifications:</span></span><pre class="console"><span class="koboSpan" id="kobo.765.1">
function mymodule_mail($key, array &amp;$message, $params) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.766.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.767.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.768.1">key</span></strong><span class="koboSpan" id="kobo.769.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.770.1">params</span></strong><span class="koboSpan" id="kobo.771.1"> parameters are the values we passed to the mail manager’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.772.1">mail</span></strong><span class="koboSpan" id="kobo.773.1"> method and how we can identify what content to generate. </span><span class="koboSpan" id="kobo.773.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.774.1">message</span></strong><span class="koboSpan" id="kobo.775.1"> property is an array that represents the email to be sent, such as who the email is being sent to and </span><span class="No-Break"><span class="koboSpan" id="kobo.776.1">its content.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.777.1">In our </span><strong class="source-inline"><span class="koboSpan" id="kobo.778.1">mail</span></strong><span class="koboSpan" id="kobo.779.1"> hook, we </span><a id="_idIndexMarker261"/><span class="koboSpan" id="kobo.780.1">will provide a different subject based on whether the email is sent for a newly published node or an </span><strong class="source-inline"><span class="koboSpan" id="kobo.781.1">update</span></strong><span class="koboSpan" id="kobo.782.1"> node that became published, along with </span><span class="No-Break"><span class="koboSpan" id="kobo.783.1">a message:</span></span><pre class="console"><span class="koboSpan" id="kobo.784.1">
function mymodule_mail($key, array &amp;$message, $params)</span></pre><pre class="console"><span class="koboSpan" id="kobo.785.1">
{</span></pre><pre class="console"><span class="koboSpan" id="kobo.786.1">
  /** @var \Drupal\node\NodeInterface $node */</span></pre><pre class="console"><span class="koboSpan" id="kobo.787.1">
  $node = $params['node'];</span></pre><pre class="console"><span class="koboSpan" id="kobo.788.1">
  if ($key === 'node_published_insert') {</span></pre><pre class="console"><span class="koboSpan" id="kobo.789.1">
    $message['subject'] = 'Newly published node: ' .</span></pre><pre class="console"><span class="koboSpan" id="kobo.790.1">
        $node-&gt;label();</span></pre><pre class="console"><span class="koboSpan" id="kobo.791.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.792.1">
  elseif ($key === 'node_published_update') {</span></pre><pre class="console"><span class="koboSpan" id="kobo.793.1">
    $message['subject'] = 'Existing node published: '</span></pre><pre class="console"><span class="koboSpan" id="kobo.794.1">
        . </span><span class="koboSpan" id="kobo.794.2">$node-&gt;label();</span></pre><pre class="console"><span class="koboSpan" id="kobo.795.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.796.1">
  else {</span></pre><pre class="console"><span class="koboSpan" id="kobo.797.1">
    // Unknown key.</span></pre><pre class="console"><span class="koboSpan" id="kobo.798.1">
    Return;</span></pre><pre class="console"><span class="koboSpan" id="kobo.799.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.800.1">
  $message['body'][] = 'The following node has been</span></pre><pre class="console"><span class="koboSpan" id="kobo.801.1">
    published:';</span></pre><pre class="console"><span class="koboSpan" id="kobo.802.1">
  $message['body'][] = $node-&gt;label();</span></pre><pre class="console"><span class="koboSpan" id="kobo.803.1">
  $message['body'][] = $node-&gt;toUrl()-&gt;setAbsolute()</span></pre><pre class="console"><span class="koboSpan" id="kobo.804.1">
    -&gt;toString();</span></pre><pre class="console"><span class="koboSpan" id="kobo.805.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.806.1">We check the </span><strong class="source-inline"><span class="koboSpan" id="kobo.807.1">key</span></strong><span class="koboSpan" id="kobo.808.1"> value and set an appropriate email subject based on the keys we have defined. </span><span class="koboSpan" id="kobo.808.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.809.1">body</span></strong><span class="koboSpan" id="kobo.810.1"> key in the message expects an array of text, which Drupal will convert into </span><span class="No-Break"><span class="koboSpan" id="kobo.811.1">new lines.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.812.1">Now, whenever</span><a id="_idIndexMarker262"/><span class="koboSpan" id="kobo.813.1"> nodes are published, an email will be sent to the site’s email address, notifying the site administrator of the newly </span><span class="No-Break"><span class="koboSpan" id="kobo.814.1">published content.</span></span></li>
</ol>
<h2 id="_idParaDest-151"><a id="_idTextAnchor159"/><span class="koboSpan" id="kobo.815.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.816.1">The entity system in Drupal has various hooks that it triggers to interact with entities when they are loaded, created (instantiation for a new entity), saved, or deleted. </span><span class="koboSpan" id="kobo.816.2">In this recipe, we listened to two post-save hooks. </span><span class="koboSpan" id="kobo.816.3">Once an entity has been saved, the entity storage’s post-save process invokes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.817.1">insert</span></strong><span class="koboSpan" id="kobo.818.1"> hook for new entities or the </span><strong class="source-inline"><span class="koboSpan" id="kobo.819.1">update</span></strong><span class="koboSpan" id="kobo.820.1"> hook for </span><span class="No-Break"><span class="koboSpan" id="kobo.821.1">existing entities.</span></span></p>
<p><span class="koboSpan" id="kobo.822.1">In this recipe, we used hooks that targeted a specific entity type. </span><span class="koboSpan" id="kobo.822.2">This allowed us to be more concise in our code and also type-hint the appropriate entity interface in our hooks. </span><span class="koboSpan" id="kobo.822.3">Each entity operation hook can also be implemented generically. </span><span class="koboSpan" id="kobo.822.4">If we were to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.823.1">hook_entity_insert</span></strong><span class="koboSpan" id="kobo.824.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.825.1">hook_entity_update</span></strong><span class="koboSpan" id="kobo.826.1">, they would be fired for any entity type, such as taxonomy terms or blocks. </span><span class="koboSpan" id="kobo.826.2">When using the more generic hook implementation, you need to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.827.1">\Drupal\Entity\EntityInterface</span></strong><span class="koboSpan" id="kobo.828.1"> for your type hint and use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.829.1">getEntityTypeId</span></strong><span class="koboSpan" id="kobo.830.1"> method to check the </span><span class="No-Break"><span class="koboSpan" id="kobo.831.1">entity’s type.</span></span></p>
<p><span class="koboSpan" id="kobo.832.1">The available hooks for the create, read, update, and delete operations of entities are documented on Drupal.org, along with details about each hook and </span><span class="No-Break"><span class="koboSpan" id="kobo.833.1">examples: </span></span><a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Entity%21entity.api.php/group/entity_crud/10.0.x"><span class="No-Break"><span class="koboSpan" id="kobo.834.1">https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Entity%21entity.api.php/group/entity_crud/10.0.x</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.835.1">.</span></span></p>
<h2 id="_idParaDest-152"><a id="_idTextAnchor160"/><span class="koboSpan" id="kobo.836.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.837.1">This recipe</span><a id="_idIndexMarker263"/><span class="koboSpan" id="kobo.838.1"> covered hooking into the post-save hooks. </span><span class="koboSpan" id="kobo.838.2">In the following section, we will explore the other hooks that </span><span class="No-Break"><span class="koboSpan" id="kobo.839.1">are available.</span></span></p>
<h3><span class="koboSpan" id="kobo.840.1">Changing values before an entity is saved</span></h3>
<p><span class="koboSpan" id="kobo.841.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.842.1">insert</span></strong><span class="koboSpan" id="kobo.843.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.844.1">update</span></strong><span class="koboSpan" id="kobo.845.1"> hooks</span><a id="_idIndexMarker264"/><span class="koboSpan" id="kobo.846.1"> are triggered after an entity has been saved. </span><span class="koboSpan" id="kobo.846.2">There is also a pre-save hook that allows you to manipulate the entity before it </span><span class="No-Break"><span class="koboSpan" id="kobo.847.1">is saved.</span></span></p>
<p><span class="koboSpan" id="kobo.848.1">This hook is often used to populate empty values or ensure values match an expected state. </span><span class="koboSpan" id="kobo.848.2">For example, in the </span><em class="italic"><span class="koboSpan" id="kobo.849.1">Creating an editorial workflow with content moderation</span></em><span class="koboSpan" id="kobo.850.1"> recipe in </span><a href="B18548_02.xhtml#_idTextAnchor059"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.851.1">Chapter 2</span></em></span></a><span class="koboSpan" id="kobo.852.1">, </span><em class="italic"><span class="koboSpan" id="kobo.853.1">Content Building Experience</span></em><span class="koboSpan" id="kobo.854.1">, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.855.1">Content Moderation</span></strong><span class="koboSpan" id="kobo.856.1"> module. </span><span class="koboSpan" id="kobo.856.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.857.1">Content Moderation</span></strong><span class="koboSpan" id="kobo.858.1"> module uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.859.1">hook_entity_presave()</span></strong><span class="koboSpan" id="kobo.860.1"> hook to ensure the content is marked as published or unpublished based on the </span><span class="No-Break"><span class="koboSpan" id="kobo.861.1">workflow’s state.</span></span></p>
<h1 id="_idParaDest-153"><a id="_idTextAnchor161"/><span class="koboSpan" id="kobo.862.1">Creating an event subscriber to react to events</span></h1>
<p><span class="koboSpan" id="kobo.863.1">Drupal has</span><a id="_idIndexMarker265"/><span class="koboSpan" id="kobo.864.1"> two ways of integrating various parts of the system: using hooks or events. </span><span class="koboSpan" id="kobo.864.2">Hooks have been a part of Drupal for its entire lifespan and events were introduced in Drupal 8. </span><span class="koboSpan" id="kobo.864.3">Unlike the hook system, which has implicit registration, the event dispatch system uses explicit registration for </span><span class="No-Break"><span class="koboSpan" id="kobo.865.1">an event.</span></span></p>
<p><span class="koboSpan" id="kobo.866.1">The events dispatcher system comes from the Symfony framework and allows components to easily interact with one another. </span><span class="koboSpan" id="kobo.866.2">Within Drupal, and integrated Symfony components, events are dispatched, and event subscribers can listen to the events and react to changes or </span><span class="No-Break"><span class="koboSpan" id="kobo.867.1">other processes.</span></span></p>
<p><span class="koboSpan" id="kobo.868.1">In this recipe, we will subscribe to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.869.1">RequestEvent</span></strong><span class="koboSpan" id="kobo.870.1"> event, which fires when a request is first handled. </span><span class="koboSpan" id="kobo.870.2">If the user is not logged in, we will navigate them to the </span><span class="No-Break"><span class="koboSpan" id="kobo.871.1">login page.</span></span></p>
<h2 id="_idParaDest-154"><a id="_idTextAnchor162"/><span class="koboSpan" id="kobo.872.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.873.1">Create </span><strong class="source-inline"><span class="koboSpan" id="kobo.874.1">src/EventSubscriber/RequestSubscriber.php</span></strong><span class="koboSpan" id="kobo.875.1"> in </span><span class="No-Break"><span class="koboSpan" id="kobo.876.1">your module.</span></span></li>
<li><span class="koboSpan" id="kobo.877.1">Define </span><a id="_idIndexMarker266"/><span class="koboSpan" id="kobo.878.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.879.1">RequestSubscriber</span></strong><span class="koboSpan" id="kobo.880.1"> class, which implements the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.881.1">EventSubscriberInterface</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.882.1"> interface:</span></span><pre class="console"><span class="koboSpan" id="kobo.883.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.884.1">
namespace Drupal\mymodule\EventSubscriber;</span></pre><pre class="console"><span class="koboSpan" id="kobo.885.1">
use Symfony\Component\EventDispatcher\EventSubscriber</span></pre><pre class="console"><span class="koboSpan" id="kobo.886.1">
    Interface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.887.1">
class RequestSubscriber implements EventSubscriber</span></pre><pre class="console"><span class="koboSpan" id="kobo.888.1">
    Interface {</span></pre><pre class="console"><span class="koboSpan" id="kobo.889.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.890.1">To satisfy the interface requirements, we must add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.891.1">getSubscribedEvents</span></strong><span class="koboSpan" id="kobo.892.1"> method. </span><span class="koboSpan" id="kobo.892.2">This tells the system which events we are subscribing to and the method</span><a id="_idIndexMarker267"/><span class="koboSpan" id="kobo.893.1"> that needs to </span><span class="No-Break"><span class="koboSpan" id="kobo.894.1">be invoked:</span></span><pre class="console"><span class="koboSpan" id="kobo.895.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.896.1">
namespace Drupal\mymodule\EventSubscriber;</span></pre><pre class="console"><span class="koboSpan" id="kobo.897.1">
use Symfony\Component\EventDispatcher\EventSubscriber</span></pre><pre class="console"><span class="koboSpan" id="kobo.898.1">
    Interface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.899.1">
use Symfony\Component\HttpKernel\Event\RequestEvent;</span></pre><pre class="console"><span class="koboSpan" id="kobo.900.1">
class RequestSubscriber implements EventSubscriber</span></pre><pre class="console"><span class="koboSpan" id="kobo.901.1">
    Interface {</span></pre><pre class="console"><span class="koboSpan" id="kobo.902.1">
  /**</span></pre><pre class="console"><span class="koboSpan" id="kobo.903.1">
    * {@inheritdoc}</span></pre><pre class="console"><span class="koboSpan" id="kobo.904.1">
    */</span></pre><pre class="console"><span class="koboSpan" id="kobo.905.1">
  public static function getSubscribedEvents() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.906.1">
    return [</span></pre><pre class="console"><span class="koboSpan" id="kobo.907.1">
      RequestEvent::class =&gt; ['doAnonymousRedirect',</span></pre><pre class="console"><span class="koboSpan" id="kobo.908.1">
        28],</span></pre><pre class="console"><span class="koboSpan" id="kobo.909.1">
    ];</span></pre><pre class="console"><span class="koboSpan" id="kobo.910.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.911.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.912.1">Event names are derived from the PHP class name for the event object. </span><span class="koboSpan" id="kobo.912.2">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">getSubscribedEvent</span></strong><span class="koboSpan" id="kobo.914.1"> method, we construct an associative array to be returned. </span><span class="koboSpan" id="kobo.914.2">The event class name is the key and our class method to invoke when that event </span><span class="No-Break"><span class="koboSpan" id="kobo.915.1">is dispatched.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.916.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.917.1">Priorities will be discussed in the </span><em class="italic"><span class="koboSpan" id="kobo.918.1">How it works...</span></em><span class="koboSpan" id="kobo.919.1"> section. </span><span class="koboSpan" id="kobo.919.2">It is provided in the example to resolve possible conflicts when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.920.1">dynamic_page_cache</span></strong><span class="koboSpan" id="kobo.921.1"> module </span><span class="No-Break"><span class="koboSpan" id="kobo.922.1">is enabled.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.923.1">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.924.1">doAnonymousRedirect</span></strong><span class="koboSpan" id="kobo.925.1"> method we specified, which will receive the </span><strong class="source-inline"><span class="koboSpan" id="kobo.926.1">RequestEvent</span></strong><span class="koboSpan" id="kobo.927.1"> object</span><a id="_idIndexMarker268"/><span class="koboSpan" id="kobo.928.1"> for the </span><span class="No-Break"><span class="koboSpan" id="kobo.929.1">current request:</span></span><pre class="console"><span class="koboSpan" id="kobo.930.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.931.1">
namespace Drupal\mymodule\EventSubscriber;</span></pre><pre class="console"><span class="koboSpan" id="kobo.932.1">
use Drupal\Core\Url;</span></pre><pre class="console"><span class="koboSpan" id="kobo.933.1">
use Symfony\Component\EventDispatcher\EventSubscriber</span></pre><pre class="console"><span class="koboSpan" id="kobo.934.1">
    Interface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.935.1">
use Symfony\Component\HttpFoundation\RedirectResponse;</span></pre><pre class="console"><span class="koboSpan" id="kobo.936.1">
use Symfony\Component\HttpKernel\Event\RequestEvent;</span></pre><pre class="console"><span class="koboSpan" id="kobo.937.1">
class RequestSubscriber implements EventSubscriber</span></pre><pre class="console"><span class="koboSpan" id="kobo.938.1">
    Interface {</span></pre><pre class="console"><span class="koboSpan" id="kobo.939.1">
  /**</span></pre><pre class="console"><span class="koboSpan" id="kobo.940.1">
    * Redirects all anonymous users to the login page.</span></pre><pre class="console"><span class="koboSpan" id="kobo.941.1">
    *</span></pre><pre class="console"><span class="koboSpan" id="kobo.942.1">
    * @param \Symfony\Component\HttpKernel\Event\</span></pre><pre class="console"><span class="koboSpan" id="kobo.943.1">
        RequestEvent $event</span></pre><pre class="console"><span class="koboSpan" id="kobo.944.1">
    *    The event.</span></pre><pre class="console"><span class="koboSpan" id="kobo.945.1">
    */</span></pre><pre class="console"><span class="koboSpan" id="kobo.946.1">
  public function doAnonymousRedirect(RequestEvent</span></pre><pre class="console"><span class="koboSpan" id="kobo.947.1">
    $event) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.948.1">
    // Make sure we are not on the user login route.</span></pre><pre class="console"><span class="koboSpan" id="kobo.949.1">
    if (\Drupal::routeMatch()-&gt;getRouteName() ==</span></pre><pre class="console"><span class="koboSpan" id="kobo.950.1">
        'user.login') {</span></pre><pre class="console"><span class="koboSpan" id="kobo.951.1">
      return;</span></pre><pre class="console"><span class="koboSpan" id="kobo.952.1">
    }</span></pre><pre class="console"><span class="koboSpan" id="kobo.953.1">
    // Check if the current user is logged in.</span></pre><pre class="console"><span class="koboSpan" id="kobo.954.1">
    if (\Drupal::currentUser()-&gt;isAnonymous()) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.955.1">
      // If they are not logged in, create a redirect</span></pre><pre class="console"><span class="koboSpan" id="kobo.956.1">
        response.</span></pre><pre class="console"><span class="koboSpan" id="kobo.957.1">
      $url = Url::fromRoute('user.login')-&gt;toString();</span></pre><pre class="console"><span class="koboSpan" id="kobo.958.1">
      $redirect = new RedirectResponse($url);</span></pre><pre class="console"><span class="koboSpan" id="kobo.959.1">
      // Set the redirect response on the event,</span></pre><pre class="console"><span class="koboSpan" id="kobo.960.1">
        canceling default response.</span></pre><pre class="console"><span class="koboSpan" id="kobo.961.1">
      $event-&gt;setResponse($redirect);</span></pre><pre class="console"><span class="koboSpan" id="kobo.962.1">
    }</span></pre><pre class="console"><span class="koboSpan" id="kobo.963.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.964.1">
  /**</span></pre><pre class="console"><span class="koboSpan" id="kobo.965.1">
    * {@inheritdoc}</span></pre><pre class="console"><span class="koboSpan" id="kobo.966.1">
    */</span></pre><pre class="console"><span class="koboSpan" id="kobo.967.1">
  public static function getSubscribedEvents() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.968.1">
    return [</span></pre><pre class="console"><span class="koboSpan" id="kobo.969.1">
      RequestEvent::class =&gt; ['doAnonymousRedirect',</span></pre><pre class="console"><span class="koboSpan" id="kobo.970.1">
        28],</span></pre><pre class="console"><span class="koboSpan" id="kobo.971.1">
    ];</span></pre><pre class="console"><span class="koboSpan" id="kobo.972.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.973.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.974.1">To prevent a redirect loop, we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.975.1">RouteMatch</span></strong><span class="koboSpan" id="kobo.976.1"> service to get the current route object and verify that we are not already on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.977.1">user.login</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.978.1">route page.</span></span></p>
<p><span class="koboSpan" id="kobo.979.1">Then, we check whether the user is anonymous and, if they are, set the event’s response to a </span><span class="No-Break"><span class="koboSpan" id="kobo.980.1">redirect response.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.981.1">Now that we have created our class, create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.982.1">mymodule.services.yml</span></strong><span class="koboSpan" id="kobo.983.1"> file in your </span><span class="No-Break"><span class="koboSpan" id="kobo.984.1">module’s directory.</span></span></li>
<li><span class="koboSpan" id="kobo.985.1">We must register</span><a id="_idIndexMarker269"/><span class="koboSpan" id="kobo.986.1"> our class with the service container so that Drupal recognizes that it will act as an </span><span class="No-Break"><span class="koboSpan" id="kobo.987.1">event subscriber:</span></span><pre class="console"><span class="koboSpan" id="kobo.988.1">
services:</span></pre><pre class="console"><span class="koboSpan" id="kobo.989.1">
  mymodule.request_subscriber:</span></pre><pre class="console"><span class="koboSpan" id="kobo.990.1">
    class: Drupal\mymodule\EventSubscriber\</span></pre><pre class="console"><span class="koboSpan" id="kobo.991.1">
        RequestSubscriber</span></pre><pre class="console"><span class="koboSpan" id="kobo.992.1">
    tags:</span></pre><pre class="console"><span class="koboSpan" id="kobo.993.1">
      - { name: event_subscriber }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.994.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.995.1">event_subscriber</span></strong><span class="koboSpan" id="kobo.996.1"> tag tells the container to invoke the </span><strong class="source-inline"><span class="koboSpan" id="kobo.997.1">getSubscribedEvents</span></strong><span class="koboSpan" id="kobo.998.1"> method and register </span><span class="No-Break"><span class="koboSpan" id="kobo.999.1">its methods.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1000.1">Install the module or rebuild Drupal’s caches if it has been </span><span class="No-Break"><span class="koboSpan" id="kobo.1001.1">already installed.</span></span></li>
<li><span class="koboSpan" id="kobo.1002.1">Navigate to any page as an anonymous user – you will be redirected to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1003.1">login form.</span></span></li>
</ol>
<h2 id="_idParaDest-155"><a id="_idTextAnchor163"/><span class="koboSpan" id="kobo.1004.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.1005.1">Throughout Drupal and Symfony, component events can be passed to the event dispatcher. </span><span class="koboSpan" id="kobo.1005.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1006.1">event_dispatcher</span></strong><span class="koboSpan" id="kobo.1007.1"> service in Drupal is an optimized version of the one provided by Symfony but is completely interoperable and provides backward compatibility layers with Symfony. </span><span class="koboSpan" id="kobo.1007.2">When the container is built, all services tagged as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1008.1">event_subscriber</span></strong><span class="koboSpan" id="kobo.1009.1"> are gathered. </span><span class="koboSpan" id="kobo.1009.2">They are then registered into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1010.1">event_dispatcher</span></strong><span class="koboSpan" id="kobo.1011.1"> service, keyed by the events returned in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1012.1">getSubscribedEvents</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1013.1"> method.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1014.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1015.1">Symfony 4.3 changed how events are dispatched. </span><span class="koboSpan" id="kobo.1015.2">Previously, events were identified only by name, with the event object serving as a value object. </span><span class="koboSpan" id="kobo.1015.3">With Symfony 4.3, the event name was made optional. </span><span class="koboSpan" id="kobo.1015.4">This also aligns with the PSR-14 Event Dispatcher by </span><span class="No-Break"><span class="koboSpan" id="kobo.1016.1">the PHP-FIG.</span></span></p>
<p><span class="koboSpan" id="kobo.1017.1">When</span><a id="_idIndexMarker270"/><span class="koboSpan" id="kobo.1018.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1019.1">event_dispatcher</span></strong><span class="koboSpan" id="kobo.1020.1"> service is told to dispatch an event, it invokes the registered methods on all subscribed services. </span><span class="koboSpan" id="kobo.1020.2">Drupal still primarily uses named events over event objects, as many events leverage the same event </span><span class="No-Break"><span class="koboSpan" id="kobo.1021.1">object class.</span></span></p>
<p><span class="koboSpan" id="kobo.1022.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1023.1">\Symfony\Component\HttpKernel\KernelEvents</span></strong><span class="koboSpan" id="kobo.1024.1"> class documents the events available to interact with the request life cycle to become a response and even after the response is sent, as we did with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1025.1">RequestEvent</span></strong><span class="koboSpan" id="kobo.1026.1">. </span><span class="koboSpan" id="kobo.1026.2">Then, there are events, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1027.1">ConfigEvents::SAVE</span></strong><span class="koboSpan" id="kobo.1028.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1029.1">ConfigEvents::DELETE</span></strong><span class="koboSpan" id="kobo.1030.1">, that are dispatched and allow you to react to a configuration being saved or deleted but are not able to adjust the configuration entity directly through the </span><span class="No-Break"><span class="koboSpan" id="kobo.1031.1">event object.</span></span></p>
<h2 id="_idParaDest-156"><a id="_idTextAnchor164"/><span class="koboSpan" id="kobo.1032.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.1033.1">Event subscribers require knowledge of creating services, registering them, and even dependency injection. </span><span class="koboSpan" id="kobo.1033.2">We’ll discuss this some more in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1034.1">next section.</span></span></p>
<h3><span class="koboSpan" id="kobo.1035.1">Using dependency injection</span></h3>
<p><span class="koboSpan" id="kobo.1036.1">Drupal utilizes a </span><a id="_idIndexMarker271"/><span class="koboSpan" id="kobo.1037.1">service container that allows you </span><a id="_idIndexMarker272"/><span class="koboSpan" id="kobo.1038.1">to declare classes and services and define their dependencies. </span><span class="koboSpan" id="kobo.1038.2">For services, a dependency is an argument that must be passed to its constructor. </span><span class="koboSpan" id="kobo.1038.3">Dependency injection is a software design concept, and at its base level, it provides a means to use a class without having to directly reference it. </span><span class="koboSpan" id="kobo.1038.4">In our example, we retrieved services multiple times using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1039.1">\Drupal</span></strong><span class="koboSpan" id="kobo.1040.1"> global static class. </span><span class="koboSpan" id="kobo.1040.2">This is convenient but is a bad practice within services. </span><span class="koboSpan" id="kobo.1040.3">It can make testing </span><span class="No-Break"><span class="koboSpan" id="kobo.1041.1">more difficult.</span></span></p>
<p><span class="koboSpan" id="kobo.1042.1">To implement dependency injection, first, we will add a constructor to our class that accepts the services used (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1043.1">current_route_match</span></strong><span class="koboSpan" id="kobo.1044.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1045.1">current_user</span></strong><span class="koboSpan" id="kobo.1046.1">) and matches protected properties to </span><span class="No-Break"><span class="koboSpan" id="kobo.1047.1">store them:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1048.1">
  /**
    * The route match.
</span><span class="koboSpan" id="kobo.1048.2">    *
    * @var \Drupal\Core\Routing\RouteMatchInterface
    */
  protected $routeMatch;
  /**
    * Account proxy.
</span><span class="koboSpan" id="kobo.1048.3">    *
    * @var \Drupal\Core\Session\AccountProxyInterface
    */
  protected $accountProxy;
  /**
    * Creates a new RequestSubscriber object.
</span><span class="koboSpan" id="kobo.1048.4">    *
    * @param \Drupal\Core\Routing\RouteMatchInterface
        $route_match
    * The route match.
</span><span class="koboSpan" id="kobo.1048.5">    * @param \Drupal\Core\Session\AccountProxyInterface
        $account_proxy
    * The current user.
</span><span class="koboSpan" id="kobo.1048.6">    */
  public function __construct(RouteMatchInterface
    $route_match, AccountProxyInterface $account_proxy) {
    $this-&gt;routeMatch = $route_match;
    $this-&gt;accountProxy = $account_proxy;
  }</span></pre>
<p><span class="koboSpan" id="kobo.1049.1">We can </span><a id="_idIndexMarker273"/><span class="koboSpan" id="kobo.1050.1">then</span><a id="_idIndexMarker274"/><span class="koboSpan" id="kobo.1051.1"> replace any calls to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1052.1">\Drupal::</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1053.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1054.1">$this-&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1055.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1056.1">
  /**
    * Redirects all anonymous users to the login page.
</span><span class="koboSpan" id="kobo.1056.2">    *
    * @param \Symfony\Component\HttpKernel\Event\Request
        Event $event
    *    The event.
</span><span class="koboSpan" id="kobo.1056.3">    */
  public function doAnonymousRedirect(RequestEvent $event)
{
    // Make sure we are not on the user login route.
</span><span class="koboSpan" id="kobo.1056.4">    if ($this-&gt;routeMatch-&gt;getRouteName() == 'user.login') {
      return;
    }
    // Check if the current user is logged in.
</span><span class="koboSpan" id="kobo.1056.5">    if ($this-&gt;accountProxy-&gt;isAnonymous()) {
      // If they are not logged in, create a redirect
        response.
</span><span class="koboSpan" id="kobo.1056.6">      $url = Url::fromRoute('user.login')-&gt;toString();
      $redirect = new RedirectResponse($url);
      // Set the redirect response on the event, canceling
        default response.
</span><span class="koboSpan" id="kobo.1056.7">      $event-&gt;setResponse($redirect);
    }
  }</span></pre>
<p><span class="koboSpan" id="kobo.1057.1">Finally, we will update </span><strong class="source-inline"><span class="koboSpan" id="kobo.1058.1">mymodule.services.yml</span></strong><span class="koboSpan" id="kobo.1059.1"> to specify our constructor arguments so that they will be injected when the container runs our </span><span class="No-Break"><span class="koboSpan" id="kobo.1060.1">event subscriber:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1061.1">
services:
  mymodule.request_subscriber:
    class: Drupal\mymodule\EventSubscriber\
        RequestSubscriber
    arguments: ['@current_route_match', '@current_user']
    tags:
      - { name: event_subscriber }</span></pre>
<p><span class="koboSpan" id="kobo.1062.1">Dependency</span><a id="_idIndexMarker275"/><span class="koboSpan" id="kobo.1063.1"> injection </span><a id="_idIndexMarker276"/><span class="koboSpan" id="kobo.1064.1">feels and seems magical at first. </span><span class="koboSpan" id="kobo.1064.2">However, with use and practice, it will begin to make more sense and become second nature when developing </span><span class="No-Break"><span class="koboSpan" id="kobo.1065.1">with Drupal.</span></span></p>
<h2 id="_idParaDest-157"><a id="_idTextAnchor165"/><span class="koboSpan" id="kobo.1066.1">See also</span></h2>
<ul>
<li><span class="koboSpan" id="kobo.1067.1">PSR-14 Event Dispatcher by </span><span class="No-Break"><span class="koboSpan" id="kobo.1068.1">PHP-FIG: </span></span><a href="https://www.php-fig.org/psr/psr-14/"><span class="No-Break"><span class="koboSpan" id="kobo.1069.1">https://www.php-fig.org/psr/psr-14/</span></span></a></li>
</ul>
<h1 id="_idParaDest-158"><a id="_idTextAnchor166"/><span class="koboSpan" id="kobo.1070.1">Creating a custom Drush command</span></h1>
<p><span class="koboSpan" id="kobo.1071.1">Throughout this</span><a id="_idIndexMarker277"/><span class="koboSpan" id="kobo.1072.1"> book, we have used Drush to perform operations on a Drupal site from the command line. </span><span class="koboSpan" id="kobo.1072.2">Custom commands for Drush can be provided by modules. </span><span class="koboSpan" id="kobo.1072.3">This allows developers to create commands that help them manage their Drupal sites. </span><span class="koboSpan" id="kobo.1072.4">Drush requires modules to provide a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1073.1">composer.json</span></strong><span class="koboSpan" id="kobo.1074.1"> file that instructs them where to load a services file that will register </span><span class="No-Break"><span class="koboSpan" id="kobo.1075.1">Drush commands.</span></span></p>
<p><span class="koboSpan" id="kobo.1076.1">In this recipe, we will create a new Drush command for a custom module that prints the location of where Drupal </span><span class="No-Break"><span class="koboSpan" id="kobo.1077.1">is installed.</span></span></p>
<h2 id="_idParaDest-159"><a id="_idTextAnchor167"/><span class="koboSpan" id="kobo.1078.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.1079.1">Drush provides a command to generate the required files for creating a command file for custom commands. </span><span class="koboSpan" id="kobo.1079.2">To begin, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.1080.1">following command:</span></span><pre class="console"><span class="koboSpan" id="kobo.1081.1">
php vendor/bin/drush generate drush-command-file</span></pre></li>
<li><span class="koboSpan" id="kobo.1082.1">You will be prompted to provide a value for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1083.1">Module</span></strong><span class="koboSpan" id="kobo.1084.1"> machine name; type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1085.1">mymodule</span></strong><span class="koboSpan" id="kobo.1086.1"> for the name of </span><span class="No-Break"><span class="koboSpan" id="kobo.1087.1">our module.</span></span></li>
<li><span class="koboSpan" id="kobo.1088.1">Next, press </span><em class="italic"><span class="koboSpan" id="kobo.1089.1">Enter</span></em><span class="koboSpan" id="kobo.1090.1"> to skip converting a legacy Drush </span><span class="No-Break"><span class="koboSpan" id="kobo.1091.1">command file.</span></span></li>
<li><span class="koboSpan" id="kobo.1092.1">The command output will display the files that have been created </span><span class="No-Break"><span class="koboSpan" id="kobo.1093.1">or updated:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer037">
<span class="koboSpan" id="kobo.1094.1"><img alt="Figure 4.6 – Output from the command file generator" src="image/Figure_4.06_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1095.1">Figure 4.6 – Output from the command file generator</span></p>
<p><span class="koboSpan" id="kobo.1096.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1097.1">composer.json</span></strong><span class="koboSpan" id="kobo.1098.1"> file contains information about </span><strong class="source-inline"><span class="koboSpan" id="kobo.1099.1">drush.services.yml</span></strong><span class="koboSpan" id="kobo.1100.1">. </span><span class="koboSpan" id="kobo.1100.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1101.1">drush.services.yml</span></strong><span class="koboSpan" id="kobo.1102.1"> file is a service definition file that contains classes and their arguments. </span><span class="koboSpan" id="kobo.1102.2">It has an initial definition for the created </span><strong class="source-inline"><span class="koboSpan" id="kobo.1103.1">MymoduleCommands</span></strong><span class="koboSpan" id="kobo.1104.1"> class. </span><span class="koboSpan" id="kobo.1104.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1105.1">MymoduleCommands</span></strong><span class="koboSpan" id="kobo.1106.1"> class is generated with sample commands </span><span class="No-Break"><span class="koboSpan" id="kobo.1107.1">as well.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1108.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1109.1">drush.services.yml</span></strong><span class="koboSpan" id="kobo.1110.1"> file is important. </span><span class="koboSpan" id="kobo.1110.2">It is a services definition file that tags services as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1111.1">drush.command</span></strong><span class="koboSpan" id="kobo.1112.1"> so that classes are collected </span><span class="No-Break"><span class="koboSpan" id="kobo.1113.1">by Drush:</span></span><pre class="console"><span class="koboSpan" id="kobo.1114.1">
services:</span></pre><pre class="console"><span class="koboSpan" id="kobo.1115.1">
  mymodule.commands:</span></pre><pre class="console"><span class="koboSpan" id="kobo.1116.1">
    class: \Drupal\mymodule\Commands\MymoduleCommands</span></pre><pre class="console"><span class="koboSpan" id="kobo.1117.1">
    tags:</span></pre><pre class="console"><span class="koboSpan" id="kobo.1118.1">
      - { name: drush.command }</span></pre></li>
<li><span class="koboSpan" id="kobo.1119.1">Commands are defined as class methods in a command file. </span><span class="koboSpan" id="kobo.1119.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1120.1">src/Commands/MymoduleCommands.php</span></strong><span class="koboSpan" id="kobo.1121.1"> file to create a </span><span class="No-Break"><span class="koboSpan" id="kobo.1122.1">new command.</span></span></li>
<li><span class="koboSpan" id="kobo.1123.1">Create a new</span><a id="_idIndexMarker278"/><span class="koboSpan" id="kobo.1124.1"> method called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1125.1">helloWorld</span></strong><span class="koboSpan" id="kobo.1126.1">, which we will use to provide the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1127.1">hello-world</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1128.1"> command:</span></span><pre class="console"><span class="koboSpan" id="kobo.1129.1">
  public function helloWorld() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1130.1">
  }</span></pre></li>
<li><span class="koboSpan" id="kobo.1131.1">Next, add the following code to the command to output a message and display the directory of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1132.1">Drupal site:</span></span><pre class="console"><span class="koboSpan" id="kobo.1133.1">
  public function helloWorld() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1134.1">
    $this-&gt;io()-&gt;writeln('Hello world!');</span></pre><pre class="console"><span class="koboSpan" id="kobo.1135.1">
    $self_alias = \Drush\Drush::aliasManager()-&gt;get</span></pre><pre class="console"><span class="koboSpan" id="kobo.1136.1">
        S</span><a id="_idTextAnchor168"/><span class="koboSpan" id="kobo.1137.1">elf();</span></pre><pre class="console"><span class="koboSpan" id="kobo.1138.1">
    $drupal_root = $self_alias-&gt;root();</span></pre><pre class="console"><span class="koboSpan" id="kobo.1139.1">
    $this-&gt;io()-&gt;writeln("Drupal is located at: {$dru</span></pre><pre class="console"><span class="koboSpan" id="kobo.1140.1">
    pal_root}");</span></pre><pre class="console"><span class="koboSpan" id="kobo.1141.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1142.1">This method uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1143.1">io()</span></strong><span class="koboSpan" id="kobo.1144.1"> method to get the input/output helper to write content back to the terminal. </span><span class="koboSpan" id="kobo.1144.2">The code then gets the current site alias from the alias manager. </span><span class="koboSpan" id="kobo.1144.3">Drush supports using aliases to connect to remote Drupal sites, with the “self” alias being the current local Drupal site. </span><span class="koboSpan" id="kobo.1144.4">The code then calls the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1145.1">root</span></strong><span class="koboSpan" id="kobo.1146.1"> method to display the directory of the Drupal </span><span class="No-Break"><span class="koboSpan" id="kobo.1147.1">code base.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.1148.1">Finally, we need to provide annotations in the document block of the method</span><a id="_idTextAnchor169"/><span class="koboSpan" id="kobo.1149.1">. </span><span class="koboSpan" id="kobo.1149.2">This is how Drush </span><a id="_idIndexMarker279"/><span class="koboSpan" id="kobo.1150.1">interprets the </span><span class="No-Break"><span class="koboSpan" id="kobo.1151.1">command name:</span></span><pre class="console"><span class="koboSpan" id="kobo.1152.1">
  /**</span></pre><pre class="console"><span class="koboSpan" id="kobo.1153.1">
   * @command mymodule:hello-world</span></pre><pre class="console"><span class="koboSpan" id="kobo.1154.1">
   */</span></pre><pre class="console"><span class="koboSpan" id="kobo.1155.1">
  public function helloWorld() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1156.1">
    $this-&gt;io()-&gt;writeln('Hello world!');</span></pre><pre class="console"><span class="koboSpan" id="kobo.1157.1">
    $self_alias = \Drush\Drush::aliasManager()-&gt;get</span></pre><pre class="console"><span class="koboSpan" id="kobo.1158.1">
        Self();</span></pre><pre class="console"><span class="koboSpan" id="kobo.1159.1">
    $drupal_root = $self_alias-&gt;root();</span></pre><pre class="console"><span class="koboSpan" id="kobo.1160.1">
    $this-&gt;io()-&gt;writeln("Drupal is located at: {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1161.1">
        $drupal_root}");</span></pre><pre class="console"><span class="koboSpan" id="kobo.1162.1">
  }</span></pre></li>
<li><span class="koboSpan" id="kobo.1163.1">Now, we can execute the command. </span><span class="koboSpan" id="kobo.1163.2">First, we must clear the cache so that Drupal and Drush can register the new command. </span><span class="koboSpan" id="kobo.1163.3">Then, we can </span><span class="No-Break"><span class="koboSpan" id="kobo.1164.1">execute it:</span></span><pre class="console"><span class="koboSpan" id="kobo.1165.1">
php vendor/bin/drush cache-rebuild</span></pre><pre class="console"><span class="koboSpan" id="kobo.1166.1">
php vendor/bin/drush mymodule:hello-world</span></pre></li>
</ol>
<h2 id="_idParaDest-160"><a id="_idTextAnchor170"/><span class="koboSpan" id="kobo.1167.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.1168.1">The Drush command line bootstraps Drupal when it is launched. </span><span class="koboSpan" id="kobo.1168.2">During that launch, it takes the Drupal service container and adds and registers the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1169.1">\Drush\Drupal\FindCommandsCompilerPass</span></strong><span class="koboSpan" id="kobo.1170.1"> compiler pass. </span><span class="koboSpan" id="kobo.1170.2">This compiler pass scans the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1171.1">services.yml</span></strong><span class="koboSpan" id="kobo.1172.1"> files collected by Drupal and finds services tagged with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1173.1">drush.command</span></strong><span class="koboSpan" id="kobo.1174.1">. </span><span class="koboSpan" id="kobo.1174.2">This is why modules must have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1175.1">drush.services.yml</span></strong><span class="koboSpan" id="kobo.1176.1"> file. </span><span class="koboSpan" id="kobo.1176.2">This defines the services and tags them appropriately to be discovered </span><span class="No-Break"><span class="koboSpan" id="kobo.1177.1">by Drush.</span></span></p>
<p><span class="koboSpan" id="kobo.1178.1">Since Drush wraps around Drupal, command files may also have other services injected into them as dependencies. </span><span class="koboSpan" id="kobo.1178.2">Here is an example of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1179.1">drush.services.yml</span></strong><span class="koboSpan" id="kobo.1180.1"> file using dependency </span><a id="_idIndexMarker280"/><span class="koboSpan" id="kobo.1181.1">injection from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1182.1">Pathauto</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1183.1"> module:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1184.1">
services:
  pathauto.commands:
    class: \Drupal\pathauto\Commands\PathautoCommands
    arguments:
      - '@config.factory'
      - '@plugin.manager.alias_type'
      - '@pathauto.alias_storage_helper'
    tags:
      - { name: drush.command }</span></pre>
<h2 id="_idParaDest-161"><a id="_idTextAnchor171"/><span class="koboSpan" id="kobo.1185.1">See also</span></h2>
<ul>
<li><span class="koboSpan" id="kobo.1186.1">Drush command authoring </span><span class="No-Break"><span class="koboSpan" id="kobo.1187.1">documentation: </span></span><a href="https://www.drush.org/latest/commands/"><span class="No-Break"><span class="koboSpan" id="kobo.1188.1">https://www.drush.org/latest/commands/</span></span></a></li>
</ul>
</div>
</body></html>