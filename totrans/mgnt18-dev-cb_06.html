<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Databases and Modules"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Databases and Modules</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Registering the resource models</li><li class="listitem" style="list-style-type: disc">Registering connections</li><li class="listitem" style="list-style-type: disc">Installing and upgrading scripts</li><li class="listitem" style="list-style-type: disc">Creating a flat table with models</li><li class="listitem" style="list-style-type: disc">Working with Magento collections</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec45"/>Introduction</h1></div></div></div><p>In the previous chapter, we learned how the Magento database works, which connections are available, and how we can interact with the database.</p><p>In this chapter, we will perform some practical tasks with the things we learned in the previous chapter. We will extend the module that we created in <a class="link" href="ch04.html" title="Chapter 4. Creating a Module">Chapter 4</a>, <span class="emphasis"><em>Creating a Module</em></span>, with database interactions.</p><p>We will create Magento <a id="id259" class="indexterm"/>models that will interact with a database table, which will be installed by the module.</p></div></div>
<div class="section" title="Registering the resource models"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec46"/>Registering the resource models</h1></div></div></div><p>The first thing we have to do is to register the <a id="id260" class="indexterm"/>
<span class="strong"><strong>resource</strong></span> models. The normal models are used to write business logic. The resource models are used to interact with the database.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec113"/>Getting ready</h2></div></div></div><p>We have to add <a id="id261" class="indexterm"/>an extra configuration in the <code class="literal">config.xml</code> file of the module. Open the <code class="literal">app/code/local/Packt/Helloworld/etc/config.xml</code> file.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec114"/>How to do it...</h2></div></div></div><p>The following steps explain how to register resource models in the existing <code class="literal">Packt_Helloworld</code> module:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the tag where the models are registered. This is in the <code class="literal">config/global/models</code> tag.</li><li class="listitem">Add the following configuration in it to add the resource models. Your <code class="literal">&lt;global&gt;</code> tag will look as follows:<div class="informalexample"><pre class="programlisting">&lt;global&gt;
    &lt;blocks&gt;
       &lt;helloworld&gt;
           &lt;class&gt;Packt_Helloworld_Block&lt;/class&gt;
       &lt;/helloworld&gt;
    &lt;/blocks&gt;
    &lt;helpers&gt;
       &lt;helloworld&gt;
           &lt;class&gt;Packt_Helloworld_Helper&lt;/class&gt;
       &lt;/helloworld&gt;
    &lt;/helpers&gt;
    &lt;models&gt;
       &lt;helloworld&gt;
           &lt;class&gt;Packt_Helloworld_Model&lt;/class&gt;
       &lt;/helloworld&gt;
       &lt;helloworld_resource&gt;
           &lt;class&gt;Packt_Helloworld_Model_Resource&lt;/class&gt;
       &lt;/helloworld_resource&gt;
    &lt;/models&gt;
&lt;/global&gt;</pre></div></li><li class="listitem">Create the <code class="literal">app/code/local/Packt/Helloworld/Model/Resource</code> folder.</li><li class="listitem">Link the normal model with the resource model by adding the following XML code in the <code class="literal">&lt;models&gt;</code> tag. The <code class="literal">&lt;models&gt;</code> tag will look as follows:<div class="informalexample"><pre class="programlisting">&lt;models&gt;
   &lt;helloworld&gt;
       &lt;class&gt;Packt_Helloworld_Model&lt;/class&gt;
       &lt;resourceModel&gt;helloworld_resource&lt;/resourceModel&gt;
   &lt;/helloworld&gt;
   &lt;helloworld_resource&gt;
       &lt;class&gt;Packt_Helloworld_Model_Resource&lt;/class&gt;
   &lt;/helloworld_resource&gt;
&lt;/models&gt;</pre></div><p>The link between the <code class="literal">helloworld</code> and <code class="literal">helloworld_resource</code> models is done with the <code class="literal">&lt;resourceModel&gt;</code> tag.</p></li><li class="listitem">Test your<a id="id262" class="indexterm"/> configuration with the <code class="literal">wiz</code> command-line tool by running the following command:<div class="informalexample"><pre class="programlisting">wiz devel-models | grep helloworld</pre></div><p>You will now get the following output:</p><div class="mediaobject"><img src="graphics/3320OS_06_01.jpg" alt="How to do it..."/></div><p>The previous command will display all registered models and filter the output on rows matching the <code class="literal">helloworld</code> word.</p></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec115"/>How it works...</h2></div></div></div><p>The models in Magento <a id="id263" class="indexterm"/>are used for business logic. For example, an observer model usually contains functions that will be triggered by events or cron jobs.</p><p>A Magento object can also represent an entity such as a product, customer, and category. The models representing an entity usually inherit from the <code class="literal">Mage_Core_Model_Abstract</code> class<a id="id264" class="indexterm"/>. This class has logic to connect with a resource model. For example, the <code class="literal">save()</code> function is declared in this class.</p><p>When you look in the <code class="literal">save()</code> function of the <code class="literal">Mage_Core_Model_Abstract</code> class<a id="id265" class="indexterm"/>, you see that the <code class="literal">getResource()</code> function<a id="id266" class="indexterm"/> is called. This <code class="literal">getResource()</code> function will return an instance of the resource model.</p><p>Resource models are used to connect entities with the database. Magento-specific business logic is written in the model and the model is called while working with an entity.</p><p>If you want to get a resource model instance, you can use the <code class="literal">Mage::getResourceModel()</code>
<a id="id267" class="indexterm"/> or <code class="literal">Mage::getResourceSingleton()</code> method<a id="id268" class="indexterm"/>. To get an instance of a class, we have to pass the Magento classname as the first argument.</p></div></div>
<div class="section" title="Registering connections"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec47"/>Registering connections</h1></div></div></div><p>In this recipe, we will configure the <code class="literal">read</code> and <code class="literal">write</code> adapters to use it in this module. These adapters are used to connect the models with the database.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec116"/>Getting ready</h2></div></div></div><p>We will add the adapter <a id="id269" class="indexterm"/>configuration in the <code class="literal">config.xml</code> file of the <code class="literal">Packt_Helloworld</code> module. Open this file and get ready to add some configuration.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec117"/>How to do it...</h2></div></div></div><p>Follow the next steps to create the <code class="literal">read</code> and <code class="literal">write</code> connections of the <code class="literal">Packt_Helloworld</code> module:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <code class="literal">&lt;global&gt;</code> tag and add the following configuration to it. This will register the <code class="literal">read</code> adapter.<div class="informalexample"><pre class="programlisting">&lt;resources&gt;
    &lt;helloworld_read&gt;
        &lt;connection&gt;
            &lt;use&gt;core_read&lt;/use&gt;
        &lt;/connection&gt;
    &lt;/helloworld_read&gt;
&lt;/resources&gt;</pre></div></li><li class="listitem">Configure the <code class="literal">write</code> adapter to add the following in the <code class="literal">&lt;resources&gt;</code> tag of the XML code. Your resources tag will look as follows:<div class="informalexample"><pre class="programlisting">&lt;resources&gt;
    &lt;helloworld_write&gt;
        &lt;connection&gt;
            &lt;use&gt;core_write&lt;/use&gt;
        &lt;/connection&gt;
    &lt;/helloworld_write&gt;
    &lt;helloworld_read&gt;
        &lt;connection&gt;
            &lt;use&gt;core_read&lt;/use&gt;
        &lt;/connection&gt;
    &lt;/helloworld_read&gt;
&lt;/resources&gt;</pre></div></li><li class="listitem">Clear your cache and you're done.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec118"/>How it works...</h2></div></div></div><p>Every model in Magento is associated with a <code class="literal">read</code> and <code class="literal">write</code> adapter. The default <code class="literal">read</code> adapter is <code class="literal">core_read</code>. The default <code class="literal">write</code> adapter is <code class="literal">core_write</code>.</p><p>Normally, all models use the <code class="literal">core_read</code> and <code class="literal">core_write</code> adapters when the database tables are in the<a id="id270" class="indexterm"/> Magento database.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec119"/>There's more...</h2></div></div></div><p>You can register and configure a specific database model that uses another database connection. If you navigate to the following URL, you can find a good tutorial that explains this:</p><p>
<a class="ulink" href="http://www.solvingmagento.com/accessing-an-external-database-from-your-magento-module/">http://www.solvingmagento.com/accessing-an-external-database-from-your-magento-module/</a>
</p></div></div>
<div class="section" title="Installing and upgrading scripts"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec48"/>Installing and upgrading scripts</h1></div></div></div><p>When your module uses a custom database table, you need to make certain changes to the database to deploy your module on a staging or production server. Magento has a way to automatically trigger and install or update scripts when the code is in the right place.</p><p>In this recipe, we will extend the <code class="literal">Packt_Helloworld</code> module with the <code class="literal">install</code> script. This <code class="literal">install</code> script will add an attribute to all products.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec120"/>Getting ready</h2></div></div></div><p>For this recipe, we have to work in the module's folder and the database. Open your database client and go to your code in the <code class="literal">Packt_Helloworld</code> module.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec121"/>How to do it...</h2></div></div></div><p>The following steps describe the procedure to<a id="id271" class="indexterm"/> create and install scripts for your<a id="id272" class="indexterm"/> module:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Initialize the setup procedures for the module by adding the following code in the <code class="literal">&lt;resources&gt;</code> tag of the <code class="literal">config.xml</code> file:<div class="informalexample"><pre class="programlisting">&lt;helloworld_setup&gt;
    &lt;setup&gt;
        &lt;module&gt;Packt_Helloworld&lt;/module&gt;
        &lt;class&gt;Mage_Eav_Model_Entity_Setup&lt;/class&gt;
    &lt;/setup&gt;
    &lt;connection&gt;
        &lt;use&gt;core_setup&lt;/use&gt;
    &lt;/connection&gt;
&lt;/helloworld_setup&gt;</pre></div><p>The previous code will initialize a setup procedure with the name <code class="literal">helloworld_setup</code>. The <code class="literal">&lt;module&gt;</code> tag configures the relation with the <code class="literal">Packt_Helloworld</code> module.</p></li><li class="listitem">Create the <a id="id273" class="indexterm"/>folder for the installation scripts. The folder name in this case is <code class="literal">app/code/local/Packt/Helloworld/sql/helloworld_setup</code>.</li><li class="listitem">Create the<a id="id274" class="indexterm"/> installation script. The naming of an installation script follows the convention <code class="literal">install-&lt;version_number_config_xml&gt;.php</code>. In our case, the name of this script is <code class="literal">install-0.0.1.php</code>.</li><li class="listitem">Add the following content in the file to test the installation procedure:<div class="informalexample"><pre class="programlisting">die('test');</pre></div></li><li class="listitem">Clear the cache and reload any page from the frontend. You will see a white page with <span class="strong"><strong>Test</strong></span> on it.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip23"/>Tip</h3><p>An installation or upgrade script is made to run once during an installation. The version number of every registered setup is stored in the <code class="literal">core_resource</code> database table. When you want to run your script again for testing it, you can remove an entry or change the version number for a setup.</p></div></div></li><li class="listitem">Add the following content in the installation script. This installs a product attribute that is available for all products.<div class="informalexample"><pre class="programlisting">&lt;?php

$installer = $this;

$installer-&gt;startSetup();

$installer-&gt;addAttribute('catalog_product', 'helloworld_label', array(
        'group'             =&gt; 'Helloworld',
        'type'              =&gt; 'varchar',
        'label'             =&gt; 'Helloworld label',
        'input'             =&gt; 'text',
        'global'            =&gt; Mage_Catalog_Model_Resource_Eav_Attribute::SCOPE_STORE,
        'visible'           =&gt; true,
        'required'          =&gt; false,
        'searchable'        =&gt; false,
        'filterable'        =&gt; false,
        'comparable'        =&gt; false,
        'visible_on_front'  =&gt; true,
        'unique'            =&gt; false,
        'apply_to'          =&gt; 'simple,configurable,virtual,bundle,downloadable',
        'is_configurable'   =&gt; false
    ));

$installer-&gt;endSetup();</pre></div><p>The <a id="id275" class="indexterm"/>previous code will create the <code class="literal">helloworld_label</code> product attribute. The attribute will be applied to all products.</p><p>With the <code class="literal">group</code> option, the attribute will be displayed in the <span class="strong"><strong>Helloworld</strong></span> tab while viewing a product in the backend.</p></li><li class="listitem">Clear the <a id="id276" class="indexterm"/>cache and reload the page. While reloading a page after clearing cache, the installation script will run automatically.</li><li class="listitem">Go to the backend and open a product to check whether the product attribute is added. Normally, you will see a <span class="strong"><strong>Helloworld</strong></span> tab with the attribute in it similar to the following screenshot:<div class="mediaobject"><img src="graphics/3329OS_06_02.jpg" alt="How to do it..."/></div></li><li class="listitem">When your<a id="id277" class="indexterm"/> installation script is executed, you can see your setup in the <code class="literal">core_resource</code> table of Magento. In this table, all modules and version numbers are stored, so Magento knows which installation or <a id="id278" class="indexterm"/>upgradation scripts have to be executed.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec122"/>How it works...</h2></div></div></div><p>Working with<a id="id279" class="indexterm"/> installation scripts is useful when you want to change something in the structure of your database. <a id="id280" class="indexterm"/>Some of the purposes are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Easy deployment of your site from your development/test environment to your production environment</li><li class="listitem" style="list-style-type: disc">Ability to repair the database</li><li class="listitem" style="list-style-type: disc">Overview of the database changes</li></ul></div><p>The <code class="literal">$this</code> object in the installation scripts is the class we have declared in the setup registration in the <code class="literal">config.xml</code> file. In this case, it is the <code class="literal">Mage_Eav_Model_Entity_Setup</code> class<a id="id281" class="indexterm"/>. This class is mostly used when you want to add EAV attributes to the entities such as a product or category like we did in this recipe. Mostly all setup classes extend the default setup class, that is, <code class="literal">Mage_Core_Model_Resource_Setup</code>.</p><p>If you want to do a lot <a id="id282" class="indexterm"/>of things in you installation script, you can create your own setup class. This will extend from the normal setup classes.</p><p>The functions<a id="id283" class="indexterm"/> declared in this class can call the <code class="literal">$this</code> object in the installer file.</p></div></div>
<div class="section" title="Creating a flat table with models"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec49"/>Creating a flat table with models</h1></div></div></div><p>In this recipe, we will extend our module with a flat database table. We will create an upgradation script with the instruction to create a table. When the table is created, we will finish the setup by adding the needed Magento models, resource models, and collections. After finishing  the <a id="id284" class="indexterm"/>whole setup, we have created a custom Magento entity with all the features of the Magento ORM.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec123"/>Getting ready</h2></div></div></div><p>For this recipe, we have to <a id="id285" class="indexterm"/>work with the code and the database. Open your IDE in the <code class="literal">module</code> folder and get access to your database client.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec124"/>How to do it...</h2></div></div></div><p>The following steps are the instructions to create a database table with the appropriate Magento models that can interact with this table:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Configure the table name in the <code class="literal">app/code/local/Packt/Helloworld/etc/config.xml</code> file.</li><li class="listitem">Add the following code under the <code class="literal">helloworld_resource</code> tag so that the tag looks as follows:<div class="informalexample"><pre class="programlisting">&lt;helloworld_resource&gt;
     &lt;class&gt;Packt_Helloworld_Model_Resource&lt;/class&gt;
     &lt;entities&gt;
         &lt;subscription&gt;
             &lt;table&gt;helloworld_subscription&lt;/table&gt;
         &lt;/subscription&gt;
     &lt;/entities&gt;
&lt;/helloworld_resource&gt;</pre></div><p>The previous code will declare an entity which references the <code class="literal">helloworld_subscription</code> table.</p></li><li class="listitem">Create the upgradation script by creating the  <code class="literal">app/code/local/Packt/Helloworld/sql/helloworld_setup/upgrade-0.0.1-0.0.2.php</code> file.</li><li class="listitem">Add the<a id="id286" class="indexterm"/> following code in the upgradation file. This<a id="id287" class="indexterm"/> code is a command to create a table with some fields.<div class="informalexample"><pre class="programlisting">&lt;?php

$installer = $this;

$installer-&gt;startSetup();

$table = $installer-&gt;getConnection()
    -&gt;newTable($installer-&gt;getTable('helloworld/subscription'))
    -&gt;addColumn('subscription_id', Varien_Db_Ddl_Table::TYPE_INTEGER, null, array(
        'identity'  =&gt; true,
        'unsigned'  =&gt; true,
        'nullable'  =&gt; false,
        'primary'   =&gt; true,
        ), 'Subscription id')
    -&gt;addColumn('created_at', Varien_Db_Ddl_Table::TYPE_TIMESTAMP, null, array(
        'nullable'  =&gt; false,
        ), 'Created at')
    -&gt;addColumn('updated_at', Varien_Db_Ddl_Table::TYPE_TIMESTAMP, null, array(
        'nullable'  =&gt; false,
        ), 'Updated at')
    -&gt;addColumn('firstname', Varien_Db_Ddl_Table::TYPE_TEXT, 64, array(
        'nullable'  =&gt; false,
        ), 'First name')
    -&gt;addColumn('lastname', Varien_Db_Ddl_Table::TYPE_TEXT, 64, array(
        'nullable'  =&gt; false,
        ), 'Last name')
    -&gt;addColumn('email', Varien_Db_Ddl_Table::TYPE_TEXT, 64, array(
        'nullable'  =&gt; false,
        ), 'Email address')
    -&gt;addColumn('status', Varien_Db_Ddl_Table::TYPE_TEXT, 32, array(
        'nullable'  =&gt; false,
        'default'   =&gt; 'pending',
        ), 'Status')
    -&gt;addColumn('message', Varien_Db_Ddl_Table::TYPE_TEXT, '64k', array(
        'unsigned'  =&gt; true,
        'nullable'  =&gt; false,
        ), 'Subscription notes')
    -&gt;addIndex($installer-&gt;getIdxName('helloworld/subscription', array('email')),
        array('email'))
    -&gt;setComment('Helloworld subscriptions');
$installer-&gt;getConnection()-&gt;createTable($table);

$installer-&gt;endSetup();</pre></div></li><li class="listitem">Clear the <a id="id288" class="indexterm"/>cache and reload the frontend. When you refresh your tables in the database client, you will see the <code class="literal">helloworld_subscription</code> table in the list.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip24"/>Tip</h3><p>While creating a table<a id="id289" class="indexterm"/>, think about the naming convention. The first part is the name where the models are registered followed by an underscore. The second part refers to the entity model.</p><p>Make sure the name of the model is singular. For this example, it is <code class="literal">subscription</code> and not <code class="literal">subscriptions</code>.</p></div></div></li><li class="listitem">Check whether the table is installed in the database. Reload the tables in phpMyAdmin and open the new table. The structure will look as follows:<div class="mediaobject"><img src="graphics/3329OS_06_03.jpg" alt="How to do it..."/></div></li><li class="listitem">When the<a id="id290" class="indexterm"/> table is installed with the upgradation script (from 0.0.1 to 0.0.2), the last part is to create a Magento entity that communicates with the previously created table. For doing this, we have to<a id="id291" class="indexterm"/> create a model, a resource model, and a collection resource model. The first step is to create the following files:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">app/code/local/Packt/Helloworld/Model/Subscription.php</code> (the model)</li><li class="listitem" style="list-style-type: disc"><code class="literal">app/code/local/Packt/Helloworld/Model/Resource/Subscription.php</code> (the resource model)</li><li class="listitem" style="list-style-type: disc"><code class="literal">app/code/local/Packt/Helloworld/Model/Resource/Subscription/Collection.php</code> (the resource collection model)</li></ul></div></li><li class="listitem">Open the model file and add the following content to it. This content will link the model with the appropriate resource model.<div class="informalexample"><pre class="programlisting">&lt;?php
class Packt_Helloworld_Model_Subscription extends Mage_Core_Model_Abstract 
{
    protected function _construct() 
    {
        $this-&gt;_init('helloworld/subscription');
    }
    
}</pre></div></li><li class="listitem">Open the resource<a id="id292" class="indexterm"/> model file and add the following content to it. The next content will link the model with the database. In the <code class="literal">_init</code> function, we will link the model <a id="id293" class="indexterm"/>with the primary key of the database table.<div class="informalexample"><pre class="programlisting">&lt;?php
class Packt_Helloworld_Model_Resource_Subscription extends Mage_Core_Model_Resource_Db_Abstract 
{
    
    protected function _construct() {
        $this-&gt;_init('helloworld/subscription', 'subscription_id');
    }
    
}</pre></div></li><li class="listitem">Open the resource collection model file and add the following content to it. This file makes it possible to work with Magento collections on the model when you call the <code class="literal">getCollection()</code> method<a id="id294" class="indexterm"/> on an entity.<div class="informalexample"><pre class="programlisting">&lt;?php
class Packt_Helloworld_Model_Resource_Subscription_Collection extends Mage_Core_Model_Resource_Db_Collection_Abstract 
{
    
    protected function _construct() {
        $this-&gt;_init('helloworld/subscription');
    }
    
}</pre></div></li><li class="listitem">All the files are at the right place to start the tests if everything went well so far. To perform some tests, create a <code class="literal">subscriptionAction()</code> method<a id="id295" class="indexterm"/> in the <code class="literal">IndexController</code> of the module where we can perform some tests.</li><li class="listitem">Navigate to the new action in the controller by going to the <code class="literal">http://magento-dev.local/helloworld/index/subscription</code> URL. You will see a blank page.</li><li class="listitem">Add the <a id="id296" class="indexterm"/>following content in the action that will create a new subscription item in our table:<div class="informalexample"><pre class="programlisting">public function subscriptionAction()
{
    $subscription = Mage::getModel('helloworld/subscription');

    $subscription-&gt;setFirstname('John');
    $subscription-&gt;setLastname('Doe');
    $subscription-&gt;setEmail('john.doe@example.com');
    $subscription-&gt;setMessage('A short message to test');

    $subscription-&gt;save();

    echo 'success';
}</pre></div></li><li class="listitem">When you <a id="id297" class="indexterm"/>reload the page, you will see the word <span class="strong"><strong>success</strong></span>. This word being displayed is a sign that all the actions have successfully executed. Navigate to your database and make the following query:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>SELECT * FROM helloworld_subscription;</strong></span>
</pre></div><p>This query will give you the following output:</p></li></ol></div><div class="mediaobject"><img src="graphics/3329OS_06_04.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec125"/>How it works...</h2></div></div></div><p>When you <a id="id298" class="indexterm"/>work with the previous setup for entities in a database table, the Magento ORM makes the link between the entity and the database.</p><p>In our previously<a id="id299" class="indexterm"/> created Magento entity (<code class="literal">Mage::getModel('helloworld/subscription')</code>), we can use the following functions that will result in a query to the database:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">load($entityId)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">save()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">delete()</code></li></ul></div><p>All these functions are implemented in the <code class="literal">Mage_Core_Model_Abstract</code> class. All the Magento entities will extend this abstract class to use the ORM framework.</p></div></div>
<div class="section" title="Working with Magento collections"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec50"/>Working with Magento collections</h1></div></div></div><p>In this chapter, we will explore the possibilities of the Magento collections. A Magento collection is a set of <span class="strong"><strong>entities</strong></span><a id="id300" class="indexterm"/> where you can add filters to customize your result.</p><p>In this chapter, we will<a id="id301" class="indexterm"/> explore everything that is possible with Magento collections.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec126"/>Getting ready</h2></div></div></div><p>Go to the <code class="literal">indexController</code> of the <code class="literal">helloworld</code> module and create a <code class="literal">collectionAction</code> method in it. In this action, we will perform some tests to compare the results.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec127"/>How to do it...</h2></div></div></div><p>The next examples <a id="id302" class="indexterm"/>show what are the possibilities while working with Magento collections:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following code in the <code class="literal">collectionAction</code> method<a id="id303" class="indexterm"/> and navigate to the page. This code will return 10 products.<div class="informalexample"><pre class="programlisting">public function collectionAction () 
{

    $productCollection = Mage::getModel('catalog/product')
            -&gt;getCollection()
            -&gt;setPageSize(10,1);

    foreach ($productCollection as $product)
    {
        Zend_Debug::dump($product-&gt;debug());
    }

}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip25"/>Tip</h3><p>At the end of the code, there is a <code class="literal">foreach</code> loop. This calls the <code class="literal">debug()</code> function on the object. The <code class="literal">debug()</code> function<a id="id304" class="indexterm"/> is available on all objects that extend the <code class="literal">Varien_Object</code> function. A collection dump is a very large array and can cause an <span class="strong"><strong>out of memory</strong></span> exception in PHP or very large responses in the <a id="id305" class="indexterm"/>browser.</p></div></div></li><li class="listitem">When you look at the output, you will see the following array:<div class="informalexample"><pre class="programlisting">array(11) {
  ["entity_id"] =&gt; string(2) "16"
  ["entity_type_id"] =&gt; string(2) "10"
  ["attribute_set_id"] =&gt; string(2) "38"
  ["type_id"] =&gt; string(6) "simple"
  ["sku"] =&gt; string(5) "n2610"
  ["created_at"] =&gt; string(19) "2007-08-23 13:03:05"
  ["updated_at"] =&gt; string(19) "2008-08-08 14:50:04"
  ["has_options"] =&gt; string(1) "0"
  ["required_options"] =&gt; string(1) "0"
  ["is_salable"] =&gt; string(1) "1"
  ["stock_item (Varien_Object)"] =&gt; array(1) {
    ["is_in_stock"] =&gt; string(1) "1"
  }
}</pre></div></li><li class="listitem">The values in this object don't contain attribute values. To select them, we have to use the <code class="literal">addAttributeToSelect('&lt;attribute_code&gt;')</code> function<a id="id306" class="indexterm"/>. Add the following code to select the first 10 products with the name, price, and image attributes:<div class="informalexample"><pre class="programlisting">public function collectionAction () 
{

    $productCollection = Mage::getModel('catalog/product')
            -&gt;getCollection()
            -&gt;addAttributeToSelect('name')
            -&gt;addAttributeToSelect('price')
            -&gt;addAttributeToSelect('image')
            -&gt;setPageSize(10,1);

    foreach ($productCollection as $product)
    {
        Zend_Debug::dump($product-&gt;debug());
    }

}</pre></div><p>This code <a id="id307" class="indexterm"/>will output an array for each product as shown in the following code:</p><div class="informalexample"><pre class="programlisting">array(14) {
  ["entity_id"] =&gt; string(2) "16"
  ["entity_type_id"] =&gt; string(2) "10"
  ["attribute_set_id"] =&gt; string(2) "38"
  ["type_id"] =&gt; string(6) "simple"
  ["sku"] =&gt; string(5) "n2610"
  ["created_at"] =&gt; string(19) "2007-08-23 13:03:05"
  ["updated_at"] =&gt; string(19) "2008-08-08 14:50:04"
  ["has_options"] =&gt; string(1) "0"
  ["required_options"] =&gt; string(1) "0"
  ["name"] =&gt; string(16) "Nokia 2610 Phone"
  ["image"] =&gt; string(27) "/n/o/nokia-2610-phone-2.jpg"
  ["price"] =&gt; string(8) "149.9900"
  ["is_salable"] =&gt; string(1) "1"
  ["stock_item (Varien_Object)"] =&gt; array(1) {
    ["is_in_stock"] =&gt; string(1) "1"
  }
}</pre></div></li><li class="listitem">We will now create a filter on the product collection. The next code shows how you can filter the products with the name <span class="strong"><strong>Nokia 2610 Phone</strong></span>:<a id="id308" class="indexterm"/><div class="informalexample"><pre class="programlisting">public function collectionAction () 
{

    $productCollection = Mage::getModel('catalog/product')
            -&gt;getCollection()
            -&gt;addAttributeToSelect('price')
            -&gt;addAttributeToSelect('image')
            -&gt;addAttributeToFilter('name', 'Nokia 2610 Phone');

    foreach ($productCollection as $_product)
    {
        Zend_Debug::dump($_product-&gt;debug());
    }

}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>The code in this statement will create a <code class="literal">WHERE name = 'Nokia 2610 Phone'</code> statement to the query, so all the items with the name <span class="strong"><strong>Nokia 2610 Phone</strong></span> will be returned.</p></div></div></li><li class="listitem">With the<a id="id309" class="indexterm"/> <code class="literal">addAttributeToFilter</code> function, we can do more. The following code shows how you can create a <code class="literal">WHERE product_id IN (159, 160, 161)</code> statement:<div class="informalexample"><pre class="programlisting">public function collectionAction () 
{

    $productCollection = Mage::getModel('catalog/product')
            -&gt;getCollection()
            -&gt;addAttributeToSelect('price')
            -&gt;addAttributeToSelect('image')
            -&gt;addAttributeToFilter('entity_id', array(
                'in' =&gt; array(159, 160, 161)
            ));

    foreach ($productCollection as $_product)
    {
        Zend_Debug::dump($_product-&gt;debug());
    }

}</pre></div></li><li class="listitem">The next filter we will use is the <code class="literal">like</code> filter. Add the following code to make a query with the <code class="literal">WHERE name LIKE '%PC%'</code> statement:<div class="informalexample"><pre class="programlisting">public function collectionAction () 
{

    $productCollection = Mage::getModel('catalog/product')
            -&gt;getCollection()
            -&gt;addAttributeToSelect('price')
            -&gt;addAttributeToSelect('image')
            -&gt;addAttributeToFilter('name', array(
                'like' =&gt; '%PC%'
            ));

    foreach ($productCollection as $_product)
    {
        Zend_Debug::dump($_product-&gt;debug());
    }

}</pre></div></li><li class="listitem">When the<a id="id310" class="indexterm"/> queries get more complex, sometimes it is nice to know what SQL query will be generated to get the collection. To print the SQL query, which is used for a collection, we can use the following line of code:<div class="informalexample"><pre class="programlisting">$productCollection-&gt;getSelect()-&gt;__toString()</pre></div></li><li class="listitem">When you add the following code, you will see the query for this collection:<div class="informalexample"><pre class="programlisting">public function collectionAction () 
{

    $productCollection = Mage::getModel('catalog/product')
            -&gt;getCollection()
            -&gt;addAttributeToSelect('price')
            -&gt;addAttributeToSelect('image')
            -&gt;addAttributeToFilter('name', array(
                'like' =&gt; '%PC%'
            ));

    $productCollection-&gt;load();

    echo $productCollection-&gt;getSelect()-&gt;__toString();

}</pre></div><p>This code will output the following SQL query:</p><div class="informalexample"><pre class="programlisting">SELECT `e`.*,
       IF(at_name.value_id &gt; 0, at_name.value, at_name_default.value) AS `name`,
       `price_index`.`price`,
       `price_index`.`tax_class_id`,
       `price_index`.`final_price`,
       IF(price_index.tier_price IS NOT NULL, Least(price_index.min_price,
                                          price_index.tier_price),
       price_index.min_price)                                         AS
       `minimal_price`,
       `price_index`.`min_price`,
       `price_index`.`max_price`,
       `price_index`.`tier_price`
FROM   `catalog_product_entity` AS `e`
       INNER JOIN `catalog_product_entity_varchar` AS `at_name_default`
               ON ( `at_name_default`.`entity_id` = `e`.`entity_id` )
                  AND ( `at_name_default`.`attribute_id` = '96' )
                  AND `at_name_default`.`store_id` = 0
                  LEFT JOIN `catalog_product_entity_varchar` AS `at_name`
              ON ( `at_name`.`entity_id` = `e`.`entity_id` )
                 AND ( `at_name`.`attribute_id` = '96' )
                 AND ( `at_name`.`store_id` = 1 )
                 INNER JOIN `catalog_product_index_price` AS `price_index`
               ON price_index.entity_id = e.entity_id
                  AND price_index.website_id = '1'
                  AND price_index.customer_group_id = 0
WHERE  ( IF(at_name.value_id &gt; 0, at_name.value, at_name_default.value) LIKE
         '%PC%' )</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip26"/>Tip</h3><p>When using the <code class="literal">getSelect()-&gt;__toString()</code> function<a id="id311" class="indexterm"/>, make sure the collection is<a id="id312" class="indexterm"/> loaded. This is why we called the <code class="literal">$productCollection-&gt;load()</code> function<a id="id313" class="indexterm"/> before printing the SQL statement. When you add a collection in a <code class="literal">foreach()</code> loop, the collection will automatically be loaded.</p></div></div><p>Run this query in phpMyAdmin, and you will see that this flat response can be used to create a product collection.</p></li><li class="listitem">With the previous code examples, we can only read data from the database. By using the <code class="literal">setDataToAll()</code> function<a id="id314" class="indexterm"/>, you can update some attributes for all the entities<a id="id315" class="indexterm"/> in the collection. Use the next code to update all the prices in the collection:<div class="informalexample"><pre class="programlisting">public function collectionAction () 
{

    $productCollection = Mage::getModel('catalog/product')
            -&gt;getCollection()
            -&gt;addAttributeToSelect('price')
            -&gt;addAttributeToSelect('image')
            -&gt;addAttributeToFilter('name', array(
                'like' =&gt; '%PC%'
            ));

    $productCollection-&gt;setDataToAll('price', 20);

    foreach ($productCollection as $_product)
    {
        Zend_Debug::dump($_product-&gt;debug());
    }

}</pre></div></li><li class="listitem">When you use the <code class="literal">setDataToAll()</code> function<a id="id316" class="indexterm"/>, nothing will be changed in the database until you have called the <code class="literal">save()</code> function. Add the following code after the <code class="literal">setDataToAll()</code> function<a id="id317" class="indexterm"/> to save the collection:<div class="informalexample"><pre class="programlisting">$productCollection-&gt;save();</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec128"/>How it works...</h2></div></div></div><p>When you want to get a collection of entities, you can do this by calling the next two methods. The return value of these two is a collection object.</p><div class="informalexample"><pre class="programlisting">Mage::getModel('model/entity')-&gt;getCollection();
Mage::getResourceModel('model/entity_collection');</pre></div><p>A Magento collection object always extends from the <code class="literal">Varien_Data_Collection</code> class<a id="id318" class="indexterm"/>. This object works as an array, so you can iterate between items in a collection.</p><p>For every entity, a collection class is created in the resource model folder. In most cases, this class extends the parent classes and in some cases, methods are added specially for an entity.</p><p>The product entity is <a id="id319" class="indexterm"/>a good example of this. When you open the <code class="literal">Mage_Catalog_Model_Resource_Product_Collection</code> class,<a id="id320" class="indexterm"/> you will see that this class is not empty. Here, some functions are declared specially for the product entity.</p><p>When you debug the inheritance of collections, you will see that there is a difference for flat and EAV entities as you can see in the following diagram:</p><div class="mediaobject"><img src="graphics/3329OS_06_06.jpg" alt="How it works..."/></div><p>You can see that the classes of the flat entities (<code class="literal">Mage_Core_Model_Resource_Db_Collection_Abstract</code>) and EAV entities (<code class="literal">Mage_Eav_Model_Entity_Collection_Abstract</code>) extend the same parents. The EAV class adds extra methods and redefines some existing ones to work together with the EAV system.</p><p>This is the main reason why the collection queries are different for flat and EAV entities.</p><p>For adding a filter<a id="id321" class="indexterm"/> on a field, the function for EAV is <code class="literal">addAttributeToFilter()</code>. For a flat entity, the function is <code class="literal">addFieldToFilter()</code>. The <code class="literal">addAttributeToFilter()</code>function<a id="id322" class="indexterm"/> is declared in the <code class="literal">Mage_Eav_Model_Entity_Collection_Abstract</code> class<a id="id323" class="indexterm"/>, so it is not available in the <code class="literal">Varien_Data_Collection_Db</code> class<a id="id324" class="indexterm"/>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec129"/>See also</h2></div></div></div><p>If you want to know all the possibilities on offer for Magento collections, have a look at the following article on the Magento website, which has information on all the functions and options:</p><p>
<a class="ulink" href="http://www.magentocommerce.com/wiki/1_-_installation_and_configuration/using_collections_in_magento">http://www.magentocommerce.com/wiki/1_-_installation_and_configuration/using_collections_in_magento</a>
</p></div></div></body></html>