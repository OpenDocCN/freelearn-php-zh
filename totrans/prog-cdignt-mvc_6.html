<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Models"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Models</h1></div></div></div><p>This chapter covers the CI models, their role, and their usage with several code examples of web applications. The <a id="id195" class="indexterm"/>model is responsible for handling the database it stores and retrieves database objects used by the application from a database and contains the logic implemented by the application.</p><p>Much of the data that is part of the persistent state of the application (whether that persistent state is stored in files or databases) should reside in the model objects after the data is loaded into the application. Because the model objects represent knowledge and expertise related to a specific topic, they can be reused in the application.</p><p>The model represents the application data services and can serve the application logic (commonly referred to as business logic), as well. Usually, the <a id="id196" class="indexterm"/>model is responsible for the following operations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Adding, modifying, deleting, and searching the application database objects</strong></span>: Generally, this includes the database operations, but implementing the same operations and invoking external web services or APIs is not unusual at all.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Encapsulating the application logic</strong></span>: For example, the model can make data validations before storing a data object and can alert the calling application module about the problem.</li></ul></div><p>The most common misuse of the CI database class is using it directly from the controller, view, or helper. A good practice is to develop the model classes to handle all the application database services.</p><p>Hence, all the other application modules can benefit, and reuse those models.</p><p>The CI models are special classes designed to handle databases or external information resources, such as Facebook (we will see an example of this in this chapter).</p><p>The CI models are the PHP classes that are designed to work with information in the database.</p><p>This chapter will primarily focus on the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The CI model scope:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The model resource path</li><li class="listitem" style="list-style-type: disc">Loading a model</li><li class="listitem" style="list-style-type: disc">Using model methods</li><li class="listitem" style="list-style-type: disc">Connecting to a database</li><li class="listitem" style="list-style-type: disc">Business logic</li></ul></div></li><li class="listitem" style="list-style-type: disc">Object Relational Mapping (ORM)</li><li class="listitem" style="list-style-type: disc">Example 1: a CRUD example</li><li class="listitem" style="list-style-type: disc">Example 2: a business logic example</li><li class="listitem" style="list-style-type: disc">Example 3: retrieving data from Facebook</li></ul></div><p>We will begin by briefly reviewing the CI model scope and will proceed with several usage examples, covering different use cases that are combined in a real project.</p><div class="section" title="Scope of the CI model"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec38"/>Scope of the CI model</h1></div></div></div><p>The CI <a id="id197" class="indexterm"/>model provides services for all the application modules to access the application database(s) or external information resources in an OOP fashion. Typically, the model classes will contain functions that help us retrieve, insert, and update information in the database.</p><p>This section will focus on the CI model syntax and usage guidelines, as a preface to the following usage code examples.</p><div class="section" title="The model resource path"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec53"/>The model resource path</h2></div></div></div><p>The model <a id="id198" class="indexterm"/>files are located in the folder <code class="literal">application/models/</code>, in the pattern <code class="literal">application/models/&lt;MODEL_NAME&gt;.php</code>.</p></div><div class="section" title="Loading a model"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec54"/>Loading a model</h2></div></div></div><p>Loading a <a id="id199" class="indexterm"/>model <a id="id200" class="indexterm"/>can be done automatically or via the controller. More specifically, it can be done in a certain controller's constructor or any controller's method.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If the model is used in a few of the controller's methods, it's recommended that you load the model in those methods. The scope of the model in that case is only in those methods project and will refer to <code class="literal">application/models/mymodel.php</code>.</li><li class="listitem" style="list-style-type: disc">If the model is used in most of the controller's methods, it's recommended that you load the model in the controller's constructor. In that case the scope of the model is in all the controller's methods project and will refer to <code class="literal">application/models/mymodel.php</code>.<div class="informalexample"><pre class="programlisting">$this-&gt;load-&gt;model('mymodel');</pre></div><p>It automatically loads a model <code class="literal">mymodel</code> for all the CI projects.</p></li><li class="listitem" style="list-style-type: disc">If the model is used in most of CI's project controllers, it is recommended that you <a id="id201" class="indexterm"/>autoload it in <code class="literal">application/config/autoload.php</code>. In that case the scope of the model is in all the CI <a id="id202" class="indexterm"/>project and will refer to <code class="literal">application/models/mymodel.php</code>.<p><code class="literal">$autoload['model'] = array('users', 'mymodel');</code></p></li></ul></div></div><div class="section" title="Using model methods"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec55"/>Using model methods</h2></div></div></div><p>Once the CI model<a id="id203" class="indexterm"/> is loaded, we will access the model functions using an object with the model name as our class. The model's method is called for performing database operations, such as retrieving, inserting, and updating data from the database.</p><div class="informalexample"><pre class="programlisting">// Loading the model mymodel in the controller's method
$this-&gt;load-&gt;model('mymodel');
// Calling the model's method my_function 
$this-&gt;mymodel-&gt;my_function();</pre></div><p>For example, let's load the model <code class="literal">users</code> and access its function <code class="literal">get_users</code>.</p><div class="informalexample"><pre class="programlisting">// Loading the model class
$this-&gt;load-&gt;model('usermodel');
// Calling the model to retrieve the users from the database
$view_params['users'] = $this-&gt;usermodel-&gt;get_users();</pre></div></div><div class="section" title="Connecting to a database"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec56"/>Connecting to a database</h2></div></div></div><p>For more <a id="id204" class="indexterm"/>information, refer to <a class="link" href="ch02.html" title="Chapter 2. Configurations and Naming Conventions">Chapter 2</a>, <span class="emphasis"><em>Configurations and Naming Conventions</em></span>.</p><p>In this example, we will connect manually to a database. The following settings are done in <code class="literal">application/config/database.php</code>:</p><div class="informalexample"><pre class="programlisting">$config['hostname'] = '127.0.0.1';
$config['username'] = 'db_username';
$config['password'] = 'db_password';
$config['database'] = 'db_database';
$config['port'] = 'db_port';
$config['dbdriver'] = 'mysql';
$config['dbprefix'] = '';
$config['pconnect'] = TRUE;
$config['db_debug'] = TRUE;
$config['cache_on'] = FALSE;
$config['cachedir'] = '';
$config['char_set'] = 'utf8';
$config['dbcollat'] = 'utf8_general_ci';
$config['swap_pre'] = '';
$config['autoinit'] = TRUE;
$config['stricton'] = FALSE;
// Loading the database with the configuration manually
this-&gt;load-&gt;database($config);</pre></div></div><div class="section" title="Business logic"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec57"/>Business logic</h2></div></div></div><p>Business logic <a id="id205" class="indexterm"/>is a set of validation rules and decision <a id="id206" class="indexterm"/>criteria defined for a certain information object topic or database object.</p><p>The model can apply business logic to the database and information objects that it handles.</p><p>In the case of a social network, the model layer would take care of tasks, such as saving user data, saving friend associations, storing and retrieving user photos, finding new friends for suggestions, and so on.</p></div></div></div>
<div class="section" title="Object Relational Mapping (ORM)"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec39"/>Object Relational Mapping (ORM)</h1></div></div></div><p>While CI provides the model class for the developer to expand for object-oriented database <span class="strong"><strong>CRUD</strong></span> (<span class="strong"><strong>Create, Read, Update, and Delete</strong></span>)<a id="id207" class="indexterm"/> validation, and business logic for the defined project database, there's another option that enables automatic model services. In this section, we will discuss <span class="strong"><strong>Object Relational Mapping</strong></span> (<span class="strong"><strong>ORM</strong></span>). ORM<a id="id208" class="indexterm"/> is a new concept of converting the database scheme definition into an object-oriented database class API. It provides database CRUD services on a given database, so that the minimal code is required, instead of the full model development. More than that, the customized validation on the CRUD operation is enabled as well. Using an ORM plugin may reduce the need to self-develop our own CI models so that only special business logic activities are left to be implemented.</p><p>Today, ORM plugins provide predefined validation services, as well as user-defined services to enforce validations on CRUD requests from the application controllers, libraries, or helpers requesting the database CRUD services.</p><p>There are pros and cons of using ORM. On one hand, it simplifies a lot of the database model development for the database. On there other hand, it dictates various rules on the database scheme definition, such as defining user tables for an ORM object user, or defining the auto-increment primary key field name, such as ID, and so on.</p><p>There are several ORM plugins for CI; the most well-known and well-documented ones, with a large network of community developers, are the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Doctrine ORM</strong></span> (<a class="ulink" href="http://docs.doctrine-project.org">docs.doctrine-project.org</a>): This ORM<a id="id209" class="indexterm"/> plugin with the well-documented <a id="id210" class="indexterm"/>CI integration guidelines is available at <a class="ulink" href="http://docs.doctrine-project.org/en/2.0.x/cookbook/integrating-with-codeigniter.html">http://docs.doctrine-project.org/en/2.0.x/cookbook/integrating-with-codeigniter.html</a>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>DataMapper CodeIgniter ORM library</strong></span><a id="id211" class="indexterm"/> (<a class="ulink" href="http://datamapper.wanwizard.eu">datamapper.wanwizard.eu</a>): It provides the CI library, such as user guide web <a id="id212" class="indexterm"/>navigator.</li><li class="listitem" style="list-style-type: disc">Both ORM libraries provide more than just the table-based CRUD services, but can be configured to handle the cross-table relationships of the foreign key fields. They can support one-to-many, many-to-one, and many-to-many relationships, or even more complex relationships between multiple database tables.</li></ul></div><p>The ORM plugins also provide validation and manipulation services on the handled database fields, such as performing trimming on a string field before it is saved to the database.</p><p>Validation services include built-in validations such as valid e-mail fields, or a field that must have the same value as another field, such as fields with an account creation password retype requirement. The full scope and usage of ORM is beyond the scope of this CI book. However, it is highly recommended that you learn more about ORM and try using the referred ORM plugins and consider using them in your CI projects.</p><p>Of course, we do provide a simple usage example of adding a record to the database, and retrieving the database records using ORM in the following section:</p><div class="section" title="ORM simple operations example"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec58"/>ORM simple operations example</h2></div></div></div><p>For example, let's say we have a<a id="id213" class="indexterm"/> user database table with the ID as the primary key auto-increment. User name, e-mail, and password are the other fields, and if we want to add a new user record to the database, we could do so with the help of the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?PHP
// We shall define the database table named users// with ID as auto-increment, username, password, and e-mail as // the other fields.
// ORM will create an user objet based on the users // table scheme. We can set the variable to this object, and use // the operational services provided by ORM for actions, such // as save, delete, update, and add.
$u = new User();
$u-&gt;username = 'A new User';
$u-&gt;password = 'shhnew1';
$u-&gt;email = 'user@mail.com';
// To add a new user record
if ($u-&gt;save()) {
  // if saved we have a new echo 'New User Id Opened having'$u-&gt;id. 'User Id &lt;br/&gt;';
  }
else {// Show why we failed to save echo
  $u-&gt;error-&gt;string;
  }
// Getting the first three users from the database
$u = new User();
$u-&gt;limit(3)-&gt;get();
// Showing the fetched users
foreach ($u as $user_rec)
{
  echo 'User Id: '. $user_rec-&gt;id . '&lt;br/&gt;';
  echo 'User Name: '. $user_rec-&gt;username . '&lt;br /&gt;';
  echo 'User Email: '. $user_rec-&gt;email. '&lt;br/&gt;';
  }
// Get the user with Uid = 10 if any
$u = new user();
$seek_uid = 10;

$u-&gt;where('id', $seek_uid)-&gt;get();
// Check if found
if (exist ($u)){
  echo 'User Id:'.$u-&gt;id.' Name is'.$u-&gt;username. '&lt;br /&gt;';
  }
else echo 'No user found for user ID'. $seek_uid. '&lt;br /&gt;';</pre></div><p>This is only a very simple usage <a id="id214" class="indexterm"/>example, while ORM today provides a rich set of CRUD and validation services. Please refer to the provided links to the featured ORM plugins for more information.</p></div></div>
<div class="section" title="Example 1 &#x2013; a CRUD example"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec40"/>Example 1 – a CRUD example</h1></div></div></div><p>In this example, we will see <a id="id215" class="indexterm"/>how to use a CI model. For this example, we will use a model that performs these operations on the database: <code class="literal">SELECT</code>, <code class="literal">INSERT</code>, and <code class="literal">UPDATE</code>.</p><p>The example displays, all the products that are retrieved by the model <code class="literal">productmodel</code> at the main page in the database.</p><p>Let us assume the URI to the project root is <code class="literal">http://mydomain.com/myproject</code> and <code class="literal">http://mydomain.com/myproject/product</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note05"/>Note</h3><p>The source code is provided with this book via URLs.</p></div></div><p>The main page has links for adding and editing a product. These links generate a form for editing and adding a product.</p><p>Let us assume the URI to the project root is <code class="literal">http://mydomain.com/myproject</code> and <code class="literal">http://mydomain.com/myproject/product/add</code>.</p><p>Suppose we want to edit and update the product with <code class="literal">product_id 1</code>, the link will be <code class="literal">http://mydomain.com/myproject/product/edit/1</code>. This example will be constructed from the following controller, model, and views:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">application/controllers/product.php</code>: This controller loads the model product.<div class="informalexample"><pre class="programlisting">$this-&gt;load-&gt;model('productmodel');</pre></div><p>This controller renders the following views:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">productsview</code>: This view displays all the products with links to editing and adding a product</li><li class="listitem" style="list-style-type: disc"><code class="literal">productform</code>: This view contains the form for adding and editing a product</li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">application/models/productmodel.php</code>: This model contains functions that perform these operations on the database: <code class="literal">SELECT</code>, <code class="literal">INSERT</code>, and <code class="literal">UPDATE</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">application/views/productsview.php</code>: The view that displays the products.</li><li class="listitem" style="list-style-type: disc"><code class="literal">application/views/productform.php</code>: The view that contains the form.</li></ul></div><div class="section" title="The controller file"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec59"/>The controller file</h2></div></div></div><p>The <a id="id216" class="indexterm"/>controller PHP file is located at <code class="literal">application/controllers/product.php</code>. The controller handles the product's operations, such as adding, editing, updating, and displaying the product's table.</p><p>The controller creates a form for adding and editing a product.</p><p>For more information refer to <a class="link" href="ch07.html" title="Chapter 7. Views">Chapter 7</a>, <span class="emphasis"><em>Views</em></span>.</p><p>The following are the code and inline explanations:</p><div class="informalexample"><pre class="programlisting">&lt;?php
if (!defined('BASEPATH')) exit('No direct script access allowed');
class Product extends CI_Controller {
// Accessory method for generating forms called by the methods add // and edit.
private function load_form($form_action, $a_values = array())
{
  // Loading the form helper
  $this-&gt;load-&gt;helper('form');
  // Loading the form_validation library
  $this-&gt;load-&gt;library('form_validation');
  $view_params['form']['attributes'] = array('id' =&gt; 'productform');
  $view_params['form']['action'] = $form_action;
  $product_id = isset($a_values['product_id']) ?
  $a_values['product_id']: 0;
  $view_params['form']['hidden_fields'] = array('product_id' =&gt; $product_id);
  // product name details
  $view_params['form']['product_name']['label'] = array('text' =&gt; 'Product name:', 'for' =&gt; 'product_name');
  $view_params['form']['product_name']['field'] = array('name' =&gt; 'product_name', 'id' =&gt; 'product_name', 'value' =&gt; isset($a_values['product_name']) ? $a_values['product_name']: '', 'maxlength' =&gt; '100', size' =&gt; '30', 'class' =&gt; 'input');
  // product sku details
  $view_params['form']['product_sku']['label'] = array('text' =&gt; 'Product SKU:', 'for' =&gt; 'product_sku');
  $view_params['form']['product_sku']['field'] = array('name' =&gt; 'product_sku', 'id' =&gt; 'product_sku', 'value' =&gt; isset($a_values['product_sku']) ? $a_values['product_sku']: '', 'maxlength' =&gt; '100', 'size' =&gt; '30', 'class' =&gt; 'input');
  // product quantity details
  $view_params['form']['product_quantity']['label'] = array('text' =&gt; 'Product Quantity:', 'for' =&gt; 'product_quantity');
  $view_params['form']['product_quantity']['field'] = array('name' =&gt; 'product_quantity', 'id' =&gt; 'product_quantity', 'value' =&gt; isset($a_values['product_quantity']) ? $a_values['product_quantity']: '', 'maxlength' =&gt; '100', 'size' =&gt; '30', 'class' =&gt; 'input');
  // Form attributes validation rules
  $config_form_rules = array(array('field' =&gt; 'product_name', 'label' =&gt; 'Product Name','rules' =&gt; 'trim|required'), array('field' =&gt; 'product_sku', 'label' =&gt; 'Product SKU', 'rules' =&gt; 'trim|required'), array('field' =&gt; 'product_quantity', 'label' =&gt; 'Product Quantity', 'rules' =&gt; 'trim|required|integer'));
  $this-&gt;form_validation-&gt;set_rules($config_form_rules);
  return $view_params;
  }
// This controller method retrieves the products list calling the // model productmodel's method get_products() renders the results // in the view productsview.
public function index()
{
  // Loading the url helper
  $this-&gt;load-&gt;helper('url');
  
  // Manually loading the database
  $this-&gt;load-&gt;database();
  
  // Loading the model class
  $this-&gt;load-&gt;model('productmodel');
  
  // Calling the model productmodel's method get_products()to // retrieve the products from the database.
  $view_params['products'] = $this-&gt;productmodel-&gt;get_products();
  // Rendering the products list in the view productsview.
  $this-&gt;load-&gt;view('productsview', $view_params);
  }
// This method handles the operation of adding a product to the // database.
public function add()
{
  // Loading the url helper
  $this-&gt;load-&gt;helper('url');
  
  // Manually loading the database
  $this-&gt;load-&gt;database();
  
  // Loading the model class
  $this-&gt;load-&gt;model('productmodel');
  
  $a_post_values = $this-&gt;input-&gt;post();
  $view_params = $this-&gt;load_form('product/add', $a_post_values);
  
  // Validating the form
  if ($this-&gt;form_validation-&gt;run() == FALSE) {
    // Validation failed
    $this-&gt;load-&gt;view('productform', $view_params);
    } else {
    $data = $a_post_values;
    array_pop($data);
    $this-&gt;productmodel-&gt;addProduct($data);
    
    redirect('product');
    }
  }
// This method handles the operation of editing a product
public function edit($product_id)
{
  // Loading the url helper
  $this-&gt;load-&gt;helper('url');
  // Manually loading the database
  $this-&gt;load-&gt;database();
  
  // Loading the model class
  $this-&gt;load-&gt;model('productmodel');
  
  $a_post_values = $this-&gt;input-&gt;post();
  // Checking if a form was submitted
  if ($a_post_values) {
    $a_form_values = $a_post_values;
    } else {
    // Get the values of the database
    $a_db_values = $this-&gt;productmodel-&gt;get_product($product_id);
    $a_form_values = array('product_id' =&gt; $a_db_values[0]-&gt;product_id, 'product_name' =&gt; $a_db_values[0]-&gt;product_name, product_sku' =&gt; $a_db_values[0]-&gt;product_sku, 'product_quantity' =&gt; $a_db_values[0]-&gt;product_quantity);
    }
  
  $view_params = $this-&gt;load_form('product/edit/' . $product_id, $a_form_values);
  // Validating the form
  if ($this-&gt;form_validation-&gt;run() == FALSE) {
    // Validation failed
    $this-&gt;load-&gt;view('productform', $view_params);
    } else {
    $a_fields = array('product_name', 'product_sku', 'product_quantity');
    for ($index = 0; $index &lt; count($a_fields); $index++)
    {
      $s_field = $a_fields[$index];
      $data[$s_field] = $this-&gt;input-&gt;post($s_field)
      }
    $this-&gt;productmodel-&gt;updateProduct($product_id, $data);
    redirect('product');
    }
  }
}
/* End of file product.php */
/* Location: /application/controllers/product.php */</pre></div></div><div class="section" title="The model file"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec60"/>The model file</h2></div></div></div><p>The model PHP<a id="id217" class="indexterm"/> file is located at <code class="literal">application/models/productmodel.php</code>.</p><p>In this example, the methods of the CI object <code class="literal">db</code> are called for generating and executing the SQL queries.</p><p>Please refer to the CI database library at <a class="ulink" href="http://ellislab.com/codeigniter/user-guide/database/index.html">http://ellislab.com/codeigniter/user-guide/database/index.html</a>.</p><p>The following are the code and inline explanations:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class Productmodel extends CI_Model {
  // The model's constructor method
  public function __construct()
  {
    // Call the Model's parent constructor
    parent::__construct();
    }
  // This method retrieves the products list and returns an array of // objects each containing product details.
  public function get_products()
  {
    // Calling the CI's db object's method for generating SQL // queries.
    $query = $this-&gt;db-&gt;get('products');
    // returns an array of products objects
    return $query-&gt;result();
    }
  // This method retrieves a specific product's details identified by // $product_id as a parameter
  public function get_product($product_id)
  {
    // Calling the CI's db object's methods for generating SQL // queries.
    $this-&gt;db-&gt;select('*');
    $this-&gt;db-&gt;from('products');
    $this-&gt;db-&gt;where('product_id', $product_id);
    
    // Calling the CI's db object method for executing the query
    $query = $this-&gt;db-&gt;get();
    // Returning array of one object element containing product // details.
    return $query-&gt;result();
    }
  
  // This method adds a product to the products table Parameters // $data - The data to insert into the table
  public function addProduct($data)
  {
    // Calling the CI's db object method for inserting a product data // into the products table.
    $this-&gt;db-&gt;insert('products', $data);
    }
  // This method updates a product row in the products table // parameters $product_id - The product id, $data - The updated // data
  public function updateProduct($product_id, $data)
  {
  // Calling the CI's db object's methods for generating SQL queries
  $this-&gt;db-&gt;where('product_id', $product_id);
  // Calling the CI's db object method for updating the product data // in the products table
  $this-&gt;db-&gt;update('products', $data);
  }
}</pre></div></div><div class="section" title="The view file"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec61"/>The view file</h2></div></div></div><p>The view PHP file is<a id="id218" class="indexterm"/> located at <code class="literal">application/views/productsview.php</code>.</p><p>This view file displays a table with the products list. The following are the code and inline explanations:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
&lt;meta charset="utf-8"&gt;
&lt;title&gt;Products List&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;table&gt;
&lt;tr&gt;
  &lt;td&gt;ID&lt;/td&gt;
  &lt;td&gt;Name&lt;/td&gt;
  &lt;td&gt;SKU&lt;/td&gt;
  &lt;td&gt;Quantity&lt;/td&gt;
  &lt;td&gt;Actions&lt;/td&gt;
&lt;/tr&gt;

&lt;?php foreach ($products as $product): ?&gt;
&lt;tr&gt;
  &lt;td&gt;&lt;?php echo $product-&gt;product_id; ?&gt;&lt;/td&gt;
  &lt;td&gt;&lt;?php echo $product-&gt;product_name; ?&gt;&lt;/td&gt;
  &lt;td&gt;&lt;?php echo $product-&gt;product_sku ; ?&gt;&lt;/td&gt;
  &lt;td&gt;&lt;?php echo $product-&gt;product_quantity ; ?&gt;&lt;/td&gt;
  &lt;td&gt;&lt;a href="&lt;?php echo site_url("product/edit/" . $product-&gt;product_id); ?&gt;"&gt;Edit Product&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;?php endforeach; ?&gt;
&lt;/table&gt;

&lt;p&gt;
  &lt;a href="&lt;?php echo site_url('product/add'); ?&gt;"&gt;Add Product&lt;/a&gt;
&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></div></div>
<div class="section" title="Example 2 &#x2013; a business logic example"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec41"/>Example 2 – a business logic example</h1></div></div></div><p>In this example, we will <a id="id219" class="indexterm"/>demonstrate business logic. Ordering a product will trigger the model to update the product's quantity and check whether it's smaller than a certain amount.</p><p>This example will be constructed from the following controllers, model, and view:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">application/controllers/order.php</code>: This controller loads the model <code class="literal">productmodel</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$this-&gt;load-&gt;model(' productmodel')</code>: This controller renders the view <code class="literal">orderview</code>, which displays all the products, and where each product has links to ordering a product</li><li class="listitem" style="list-style-type: disc"><code class="literal">application/models/productmodel.php</code>: This model contains functions, which retrieve products, updates its quantity, and checks its quantity</li><li class="listitem" style="list-style-type: disc"><code class="literal">application/views/ orderview.php</code>: The view displays all the products in a table, where each row has a link for ordering the product</li></ul></div><p>Let us assume the URI to the project root is <code class="literal">http://mydomain.com/myproject</code> and <code class="literal">http://mydomain.com/myproject/order</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note06"/>Note</h3><p>The source code is provided with this book via URLs.</p></div></div><div class="section" title="The controller file"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec62"/>The controller file</h2></div></div></div><p>The <a id="id220" class="indexterm"/>controller PHP file is located at <code class="literal">application/controllers/order.php</code>.</p><p>This controller is responsible for displaying the products and updates each product. If the product's quantity reaches a limit, it generates an error message.</p><p>The code and inline explanations are as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?php
if (!defined('BASEPATH')) exit('No direct script access allowed');
class Order extends CI_Controller
{
  // This method retrieves the products list and returns an array // of objects each containing product details
  public function index()
  {
    // Loading the url helper
    $this-&gt;load-&gt;helper('url');
    
    // Manually loading the database
    $this-&gt;load-&gt;database();
    
    // Loading the model class
    $this-&gt;load-&gt;model('productmodel');
    
    $view_params['products'] = $this-&gt;productmodel-&gt;get_products();
    
    $this-&gt;load-&gt;view('orderview', $view_params);
    }
  // This method checks the product's quantity.
  // It updates the product row in the database or generates an // error message
  public function product($product_id)
  {
    // Loading the url helper
    $this-&gt;load-&gt;helper('url');
    
    // Manually loading the database
    $this-&gt;load-&gt;database();
    
    // Loading the model class
    $this-&gt;load-&gt;model('productmodel');
    
    if (!$this-&gt;productmodel-&gt;update_quantity($product_id)) {
      mail($user_mail, 'product' . $product_id . "reached it's limit", 'Order product' . $product_id);
      }
    redirect('product');
  }
}</pre></div></div><div class="section" title="The model file"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec63"/>The model file</h2></div></div></div><p>The model PHP file <a id="id221" class="indexterm"/>is located at <code class="literal">application/models/productmodel.php</code>.</p><p>In this example, the methods of the CI object <code class="literal">db</code> are called for generating and executing the SQL queries.</p><p>Please refer to the CI database's library available at <a class="ulink" href="http://ellislab.com/codeigniter/user-guide/database/index.html">http://ellislab.com/codeigniter/user-guide/database/index.html</a>.</p><p>The code and inline explanations are as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class Productmodel extends CI_Model
{
  // The model's constructor method
  public function __construct()
  {
    // Call the model constructor
    parent::__construct();
    }
  // This method retrieves the products list and returns an array of // objects each containing product details.
  public function get_products()
  {
    // Calling the CI's db object's method for generating the // SQL queries.
    $query = $this-&gt;db-&gt;get('products');
    // returns an array of products objects
    return $query-&gt;result();
    }
  // This method retrieves a specific product's details // identified by $product_id as a parameter.
  public function get_product($product_id)
  {
  // Calling the CI's db object's methods for generating the // SQL queries.
  $this-&gt;db-&gt;select('*');
  $this-&gt;db-&gt;from('products');
  $this-&gt;db-&gt;where('product_id', $product_id);
  // Calling the CI's db object method for executing the query
  $query = $this-&gt;db-&gt;get();
  // Returning array of one object element containing the product // details.
  return $query-&gt;result();
  }
// This method adds a product to the products table parameters.
// $data - The data to insert into the table
public function addProduct($data)
{
  // Calling the CI's db object method for inserting a product data // into the products table.
  $this-&gt;db-&gt;insert('products', $data);
  }
// This method updates a product row in the products table // parameters.
// $product_id - The product id
// $data - The updated data
public function updateProduct($product_id, $data)
{
  // Calling the CI's db object's methods for generating the // SQL queries.
  $this-&gt;db-&gt;where('product_id', $product_id);
  // Calling the CI's db object method for updating the product data // in the products table.
  $this-&gt;db-&gt;update('products', $data);
  }

// This method checks whether the quantity exceeds it's limit.
private function check_quantity($product_id) {
  // Calling the CI's db object's methods for generating the // SQL queries.
  $this-&gt;db-&gt;select('product_quantity');
  $this-&gt;db-&gt;from('products');
  $this-&gt;db-&gt;where('product_id', $product_id);
  // Calling the CI's db object method for executing the query.
  $query = $this-&gt;db-&gt;get();
  // Calling the result's method row, which returns the SQL query // result row.
  $row = $query-&gt;row();
  if ($row-&gt;product_quantity &lt; 7) {
    return false;
    } else {
    return true;
    }
  }

// This method updates a product quantity and return true or false, // if quantity reaches it's limit.
public function update_quantity($product_id)
{
  $sql = "UPDATE products SET product_quantity = product_quantity - 1 WHERE product_id=" $product_id;
  
  $this-&gt;db-&gt;query($sql);
  
  // Checking if the quantity reached it's limit.
  if ($this-&gt;check_quantity($product_id)) {
    return true;
    } else {
    return false;
    }
  }
}</pre></div></div><div class="section" title="The view file"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec64"/>The view file</h2></div></div></div><p>The <a id="id222" class="indexterm"/>PHP view file is located at <code class="literal">application/views/orderview.php</code>. This view file displays a table with the products list.</p><p>The following are the code and inline explanations:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
&lt;meta charset="utf-8"&gt;
&lt;title&gt;Products List&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;table&gt;
&lt;tr&gt;
  &lt;th&gt;ID&lt;/th&gt;
  &lt;th&gt;Name&lt;/th&gt;
  &lt;th&gt;SKU&lt;/th&gt;
  &lt;th&gt;Quantity&lt;/th&gt;
  &lt;th&gt;Actions&lt;/th&gt;
&lt;/tr&gt;
&lt;?php foreach ($products as $product): ?&gt;
&lt;tr&gt;
  &lt;td&gt;&lt;?php echo $product-&gt;product_id; ?&gt;&lt;/td&gt;
  &lt;td&gt;&lt;?php echo $product-&gt;product_name;  ?&gt;&lt;/td&gt;
  &lt;td&gt;&lt;?php echo $product-&gt;product_sku ; ?&gt;&lt;/td&gt;
  &lt;td&gt;&lt;?php echo $product-&gt;product_quantity ; ?&gt;&lt;/td&gt;
  &lt;td&gt;&lt;a href="&lt;?php echo site_url("order/product/" . $product-&gt;product_id); ?&gt;"&gt;Order Product&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;?php endforeach; ?&gt;
&lt;/table&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></div></div>
<div class="section" title="Example 3 &#x2013; retrieving data from Facebook"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec42"/>Example 3 – retrieving data from Facebook</h1></div></div></div><p>In this example, we will use the <a id="id223" class="indexterm"/>CI built-in model to retrieve<a id="id224" class="indexterm"/> data from Facebook.</p><p>The example displays a <a id="id225" class="indexterm"/>Facebook user name and picture and displays the user's Facebook friends.</p><p>This example uses Facebook PHP SDK as a CI library. It can be downloaded from <a class="ulink" href="https://github.com/facebook/php-sdk">https://github.com/facebook/php-sdk</a>. For more information, refer to <a class="link" href="ch04.html" title="Chapter 4. Libraries">Chapter 4</a>, <span class="emphasis"><em>Libraries</em></span>.</p><p>This example will be constructed from the following controllers, model, and view:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">application/controllers/fbpage.php</code>: This controller loads the model <code class="literal">fbmodel</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">$this-&gt;load-&gt;model('fbmodel')</code>: This controller renders the view <code class="literal">fbview</code>, which displays the user's Facebook picture and name, and table, which contains the user's friends' names and links to their profiles</li><li class="listitem" style="list-style-type: disc"><code class="literal">application/models/fbmodel.php</code>: This model contains functions that retrieve data from Facebook</li><li class="listitem" style="list-style-type: disc"><code class="literal">application/views/fbview.php</code>: This view displays Facebook data</li></ul></div><p>Let us assume the URI to the project root is <code class="literal">http://mydomain.com/myproject</code> and <code class="literal">http://mydomain.com/myproject/fbpage</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note07"/>Note</h3><p>The source code is provided with this book via URLs.</p></div></div><div class="section" title="The controller file"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec65"/>The controller file</h2></div></div></div><p>The controller PHP file is <a id="id226" class="indexterm"/>located at <code class="literal">application/controllers/fbpage.php</code>.</p><p>The controller is responsible for getting the access token from Facebook and redirecting the Facebook user to the Facebook login page to confirm the Facebook app's permission.</p><p>The controller is also responsible for getting the Facebook user's details and friends via the model and rendering the view page accordingly.</p><p>For more information about Facebook API usage and development, please refer to the Facebook developer page available at <a class="ulink" href="http://developers.facebook.com/">http://developers.facebook.com/</a>.</p><p>The following are the code and inline explanations:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class Fbpage extends CI_Controller {
  public function __construct() {
    parent::__construct();
    // Extremely important!!!
    // Due to the fact that the CI handles classes for // $_GET, $_POST, and $_COOKIE parse_str is called to // copy the variables sent by Facebook to the $_REQUEST var, // so that the Facebook SDK can do its checks.
    // This is done in order to avoid infinite redirect loop.
    parse_str($_SERVER['QUERY_STRING'], $_REQUEST);
    }
  // This method retrieves Facebook data of a Facebook user and // displays personal details and some of his  friends.
  // It checks if a Facebook token is valid, if it's valid, // then it displays his details, otherwise it produces // the token.
  public function index() {
    $a_config = array('appId' =&gt; $fb_API, 'secret'=&gt; $fb_secret, 'cookie' =&gt; true);
    $this-&gt;load-&gt;library('facebook', $a_config);
    // Checking if the user is logged in and confirms // the app's permissions.
    if ($user = $this-&gt;facebook-&gt;getUser()) {
      // Get the Facebook token
      $access_token = $this-&gt;facebook-&gt;getAccessToken();
      // Loading the fbmodel
      $this-&gt;load-&gt;model('fbmodel');
      // Updating the token
      $this-&gt;fbmodel-&gt;set_token($access_token);
      // Get a Facebook user's profile details
      $user_profile = $this-&gt;fbmodel-&gt;get_user_profile();
      // Getting the Facebook user ID
      $uid = $user_profile['id'];
      
      // Retrieving a Facebook user's details
      $me = $this-&gt;fbmodel-&gt;get_me_by_fql($uid);
      // Get a Facebook user's friends
      $friends = $this-&gt;fbmodel-&gt;get_friends();
      $view_params = array('me' =&gt; $me, 'friends' =&gt; $friends);
      // Loading the view
      $this-&gt;load-&gt;view("fbview", $view_params);
      } else {
      // The Facebook parameters for the Facebook login URL, // where scope consists the Facebook app's permissions.
      $a_params = array ('fbconnect' =&gt; 0, 'scope' =&gt; offline_access, publish_stream', 'cookie' =&gt; true);
      // The Facebook login URL page
      $login_url= $this-&gt;facebook-&gt;getLoginUrl($a_params);
      // Redirecting the Facebook user to the login URL.
      // After the Facebook user confirms the permissions // required by the app; he is redirected back to the // index page.
      header('Location:'. $login_url);
      }
    }
  }</pre></div></div><div class="section" title="The model file"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec66"/>The model file</h2></div></div></div><p>The<a id="id227" class="indexterm"/> model PHP file is located at <code class="literal">application/models/fbmodel.php</code>.</p><p>The model is responsible for<a id="id228" class="indexterm"/> interacting with the Facebook SDK and retrieving the Facebook user's details and friend lists. The model uses the Facebook FQL mechanism.</p><p>For more information about Facebook API usage and development, please refer to the Facebook developer page available at <a class="ulink" href="http://developers.facebook.com/">http://developers.facebook.com/</a>.</p><p>The code and inline explanations are as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class fbmodel extends CI_Model {
  // The Facebook app's token
  private $token;
  public function __construct() {
    // Call the model constructor
    parent::__construct();
    }
  
  // This method sets the model class's private token value
  public function set_token($token) {
    $this-&gt;token = $token;
    }
  
  // This method returns an array, which contains the Facebook user // profile.
  public function get_user_profile() {
    // Getting the CI main class to get access to the Facebook // library.
    $ci =&amp; get_instance();
    
    // Getting the Facebook user's profile
    $user_profile = $ci-&gt;facebook-&gt;api('/me');
    return $user_profile;
    }
  
  // This method returns an array, which contains a Facebook user's // details.
  public function get_me_by_fql($uid) {
    // Getting the CI main class to get access to the Facebook // library.
    $ci =&amp; get_instance();
    // The SQL query to send to Facebook $fql = SELECT uid, name, // pic_big FROM user WHERE uid=" $uid;
    $param = array('method' =&gt; 'fql.query', 'query' =&gt; $fql, 'callback' =&gt; '');
    
    // Getting the Facebook user's details
    $fqlResult = $ci-&gt;facebook-&gt;api($param);
    // Returning an array, which contains the required details
    return $fqlResult;
    }
  
  // This method returns an array of a Facebook user's friend.
  public function get_friends() {
    // Getting the CI main class to get access to the Facebook // library
    $ci =&amp; get_instance();
    // Getting the Facebook user's friends
    $friends = $ci-&gt;facebook-&gt;api('/me/friends');
    
    // Returning an array, which contains a Facebook user's friend
    return $friends;
    }
  }</pre></div></div><div class="section" title="The view file"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec67"/>The view file</h2></div></div></div><p>The view PHP <a id="id229" class="indexterm"/>file is located at <code class="literal">application/views/fbview.php</code>.</p><p>This view file displays a<a id="id230" class="indexterm"/> Facebook user's details and a table with their friend details.</p><p>The code and inline explanations are as follows:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;title&gt;My facebook details&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;div id="my_details"&gt;
  &lt;div id="picture"&gt;&lt;img src="&lt;?=$me[0]['pic_big'] ?&gt;"&gt;&lt;/div&gt;
  &lt;div id="my_name"&gt;&lt;?=$me[0]['name'] ?&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;table&gt;
&lt;tr&gt;
  &lt;th&gt;Name&lt;/th&gt;
  &lt;th&gt;Link to friend&lt;/th&gt;
&lt;/tr&gt;
&lt;?php foreach ($friends['data'] as $friend): ?&gt;
&lt;tr&gt;
  &lt;td&gt;&lt;?=$friend['name']?&gt;&lt;/td&gt;
  &lt;td&gt;&lt;a href='http://www.facebook.com/&lt;?=$friend["id"]?&gt;'&gt;To friend&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;?php endforeach; ?&gt;
&lt;/table&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec43"/>Summary</h1></div></div></div><p>In this chapter, we have reviewed the CI model scope, business logic, and ORM. We have made the following examples in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Example 1: a CRUD example</li><li class="listitem" style="list-style-type: disc">Example 2: a business logic example</li><li class="listitem" style="list-style-type: disc">Example 3: retrieving data from Facebook</li></ul></div></div></body></html>