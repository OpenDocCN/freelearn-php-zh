<html><head></head><body><div class="chapter" id="E9OE1-ae331331bc644dc9b658d3634f0748da" title="Chapter&#xA0;1.&#xA0;Fundamentals"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Fundamentals</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Installing the framework</li><li class="listitem">Application templates</li><li class="listitem">Dependency injection container</li><li class="listitem">Service locator</li><li class="listitem">Code generation</li><li class="listitem">Configuring components</li><li class="listitem">Working with events</li><li class="listitem">Using external code</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Introduction</h1></div></div></div><p>In this chapter we will cover how to install Yii Framework and about possible techniques of installation. We will introduce you to application templates: basic and advanced and their difference between them. Then you will learn about dependency injection container. This chapter contains info about model events, which trigger after some actions such as model saving, updating and others. We will learn how to use external code which will include ZendFramework, Laravel, or Symfony. We will also be learning about how to update your <code class="literal">yii-1.x.x</code> based application to <code class="literal">yii2</code> step-by-step.</p></div></div>
<div class="section" title="Installing the framework"><div class="titlepage" id="F8902-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Installing the framework</h1></div></div></div><p>Yii2 is <a class="indexterm" id="id0"/>a modern PHP framework provided as a Composer <a class="indexterm" id="id1"/>package. In this recipe, we will install the framework via the Composer package manager and configure the database connection for our application.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec12"/>Getting ready</h2></div></div></div><p>First of all, install the Composer package manager on your system.</p><div class="note" title="Note"><h3 class="title"><a id="note02"/>Note</h3><p>
<span class="strong"><strong>Note</strong></span>: If you use the OpenServer application on Windows, than the <code class="literal">composer</code> command already exists in the OpenServer terminal.</p></div><p>In Mac or Linux <a class="indexterm" id="id2"/>download the installer from <a class="ulink" href="https://getcomposer.org/download/">https://getcomposer.org/download/</a> and install it globally by using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer</strong></span>
</pre></div><p>In Windows <a class="indexterm" id="id3"/>without OpenServer download and run <code class="literal">Composer-Setup.exe</code> from the <a class="ulink" href="https://getcomposer.org/doc/00-intro.md">https://getcomposer.org/doc/00-intro.md</a> page.</p><p>If you do not have administrative privileges on the system then as an alternative you can just download the <a class="ulink" href="https://getcomposer.org/composer.phar">https://getcomposer.org/composer.phar</a> raw file and use the <code class="literal">php composer.phar</code> call instead of single the <code class="literal">composer</code> command.</p><p>After installation run in <a class="indexterm" id="id4"/>your terminal:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>composer</strong></span>
</pre></div><p>Or (if you just download archive) its alternative:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php composer.phar</strong></span>
</pre></div><p>When the installation succeeds you will see the following response:</p><div class="informalexample"><pre class="programlisting">   ______
  / ____/___  ____ ___  ____  ____  ________  _____
 / /   / __ \/ __ '__ \/ __ \/ __ \/ ___/ _ \/ ___/
/ /___/ /_/ / / / / / / /_/ / /_/ (__  )  __/ /
\____/\____/_/ /_/ /_/ .___/\____/____/\___/_/
                    /_/
Composer version 1.2.0 2016-07-18 11:27:19</pre></div><p>Right <a class="indexterm" id="id5"/>now you can install any package from the <a class="ulink" href="https://packagist.org">https://packagist.org</a> repository.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec13"/>How to do it…</h2></div></div></div><p>You can install basic or advanced application templates. In order to learn about the differences between the templates see the <span class="emphasis"><em>Application templates</em></span> recipe.</p><div class="note" title="Note"><h3 class="title"><a id="note03"/>Note</h3><p>Note that during installation the Composer package manager gets a lot of information from the GitHub site. GitHub may limit requests for anonymous users. In this case Composer asks you to input your access token. You should just register the <a class="ulink" href="https://github.com">https://github.com</a> site and generate a new token via the <a class="ulink" href="https://github.com/blog/1509-personal-api-tokens">https://github.com/blog/1509-personal-api-tokens</a> guide.</p></div><div class="section" title="Installing a basic project template"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec01"/>Installing a basic project template</h3></div></div></div><p>Carry out <a class="indexterm" id="id6"/>the following steps for installing <a class="indexterm" id="id7"/>basic project template:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">As the first <a class="indexterm" id="id8"/>step open your terminal and install <span class="strong"><strong>Bower-to-Composer</strong></span> adapter:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>composer global require "fxp/composer-asset-plugin:^1.2.0"</strong></span>
</pre></div><p>It provides a simple way to load related non-PHP packages (JavaScript and CSS) from the Bower repository.</p></li><li class="listitem">Create a new application in the new <code class="literal">basic</code> directory:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>composer create-project --prefer-dist yiisoft/yii2-app-basic basic</strong></span>
</pre></div></li><li class="listitem">Check that your PHP contains the required extensions:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd basic</strong></span>
<span class="strong"><strong>php requirements.php</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title"><a id="note04"/>Note</h3><p>
<span class="strong"><strong>Note</strong></span>: PHP in command-mode and in web-interface mode can use different <code class="literal">php.ini</code> files with different configurations and different extensions.</p></div></li><li class="listitem">Create a new database (if it is needle for your project) and configure it in the <code class="literal">config/db.php</code> file.</li><li class="listitem">Try to run application via the following console command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php yii serve</strong></span>
</pre></div></li><li class="listitem">Check in your browser that the application works by the <code class="literal">http://localhost:8080</code> address:<div class="mediaobject"><img alt="Installing a basic project template" src="../Images/image00451.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>For <a class="indexterm" id="id9"/>permanent working create a new host in your server (Apache, Nginx, and so on) and <a class="indexterm" id="id10"/>set the <code class="literal">web</code> directory as a document root of the host.</p></div><div class="section" title="Installing advanced project template"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec02"/>Installing advanced project template</h3></div></div></div><p>Carry <a class="indexterm" id="id11"/>out the following steps <a class="indexterm" id="id12"/>for installing advanced project template:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">As the first step open your terminal install Bower-to-Composer adapter:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>composer global require "fxp/composer-asset-plugin:^1.2.0"</strong></span>
</pre></div><p>It provides a simple way to load related non-PHP packages (JavaScript and CSS) from the Bower repository.</p></li><li class="listitem">Create a new application in the new <code class="literal">basic</code> directory:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>composer create-project --prefer-dist yiisoft/yii2-app-advanced advanced</strong></span>
</pre></div></li><li class="listitem">The new application does not contains local configuration files and <code class="literal">index.php</code> entry scripts yet. To generate the files just <code class="literal">init</code> a working environment:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd advanced</strong></span>
<span class="strong"><strong>php init</strong></span>
</pre></div><p>During initialization select the <span class="strong"><strong>Development</strong></span> environment.</p></li><li class="listitem">Check that your PHP contains the required extensions:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php requirements.php</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title"><a id="note05"/>Note</h3><p>
<span class="strong"><strong>Note</strong></span>: PHP <a class="indexterm" id="id13"/>in <span class="strong"><strong>command-line</strong></span> mode and in <span class="strong"><strong>web-interface</strong></span> mode <a class="indexterm" id="id14"/>can use different <code class="literal">php.ini</code> files with different configuration and different extensions.</p></div></li><li class="listitem">Create a new database and configure it in the generated <code class="literal">common/config/main-local.php</code> file.</li><li class="listitem">Apply <a class="indexterm" id="id15"/>the application <a class="indexterm" id="id16"/>migrations:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php yii migrate</strong></span>
</pre></div><p>This command will automatically create a <code class="literal">user</code> table in your database.</p></li><li class="listitem">Try to run a frontend application by the following console command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php yii serve --docroot=@frontend/web --port=8080</strong></span>
</pre></div><p>Then run the backend in an other terminal window:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php yii serve --docroot=@backend/web --port=8090</strong></span>
</pre></div></li><li class="listitem">Check in your browser that the application works via the <code class="literal">http://localhost:8080</code> and <code class="literal">http://localhost:8090</code> addresses:<div class="mediaobject"><img alt="Installing advanced project template" src="../Images/image00455.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>Create two new hosts for backend and frontend application in your server (Apache, Nginx, and so on) and set the <code class="literal">backend/web</code> and <code class="literal">frontend/web</code> directories as document roots of the hosts.</p></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec14"/>How it works…</h2></div></div></div><p>First of all, we installed the Composer package manager and the Bower asset plugin.</p><p>After we installed the application via the <code class="literal">composer create-project</code> command, the command creates a new <a class="indexterm" id="id17"/>empty directory, clones the source code of application template and loads all its inner dependencies (framework and other components) into the <code class="literal">vendor</code> subdirectory.</p><p>If needed, we will initialize application configuration and set up a new database.</p><p>We can check system requirements via running the <code class="literal">requirements.php</code> script in console or browser mode.</p><p>And after cloning of the code we can configure our own PHP server to work with the <code class="literal">web</code> directories as the server's document roots.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec15"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">For <a class="indexterm" id="id18"/>more information about installing <code class="literal">yii2-app-basic</code> refer to, <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</li><li class="listitem">Refer to, <a class="ulink" href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-installation.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-installation.md</a> for <code class="literal">yii2-app-advanced</code>.</li><li class="listitem">Refer to, <a class="ulink" href="https://getcomposer.org">https://getcomposer.org</a> for the Composer package manager.</li><li class="listitem">For creating a GitHub access token for Composer refer to <a class="ulink" href="https://github.com/blog/1509-personal-api-tokens">https://github.com/blog/1509-personal-api-tokens</a>.</li></ul></div></div></div>
<div class="section" id="G6PI1-ae331331bc644dc9b658d3634f0748da" title="Application templates"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Application templates</h1></div></div></div><p>Yii2 <a class="indexterm" id="id19"/>has two application templates for development: basic and advanced. What is the difference between basic and advanced templates?</p><p>The names are confusing. Some people in the end choose basic because advanced may sound repulsive. In this chapter we will look at the differences.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec16"/>How to do it…</h2></div></div></div><p>Please refer to the <span class="emphasis"><em>Installing the framework</em></span> recipe's <span class="emphasis"><em>How to do it…</em></span> section to understand and learn how to install different templates.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec17"/>How it works…</h2></div></div></div><p>The advanced template has a custom system of configurations. It is developed so that a team can work together on a project but each developer can customize their own configurations for development, testing, and other environments.</p><p>Configuration environments can be complicated and normally aren't used when you develop alone.</p><p>The advanced template has frontend and backend folders for the frontend and backend parts of the web application <a class="indexterm" id="id20"/>accordingly. So you can configure a separate host for each folder and thereby isolate the frontend and backend part.</p><p>This is a simple way to organize files into directories and configure the web server. You can easily do the same thing in the basic template.</p><p>Neither front/back-end separation nor user management is on its own a good reason to choose the advanced template. It's better to adapt these features to your app—you'll learn more and won't get the difficult config problem.</p><p>If you will be working on the project with a team and you might need configuration flexibility, use different environments to develop and in this case a better choice would be the advanced application template. If you will be working alone and your project is simple you should choose the basic application template.</p></div></div>
<div class="section" title="Dependency injection container"><div class="titlepage" id="H5A42-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch01lvl1sec12"/>Dependency injection container</h1></div></div></div><p>
<span class="strong"><strong>Dependency Inversion Principle</strong></span> (<span class="strong"><strong>DIP</strong></span>) suggests we create modular low-coupling code with <a class="indexterm" id="id21"/>the help of extracting clear abstraction subsystems.</p><p>For <a class="indexterm" id="id22"/>example, if you want to simplify a big class you can split it into many chunks of routine code and extract every chunk into a new simple separated class.</p><p>The principle says that your low-level chunks should implement an all-sufficient and clear abstraction, and high-level code should work only with this abstraction and not low-level implementation.</p><p>When we split a big multitask class into small specialized classes, we face the issue of creating dependent objects and injecting them into each other.</p><p>If we could create one instance before:</p><div class="informalexample"><pre class="programlisting">$service = new MyGiantSuperService();</pre></div><p>And after splitting we will create or get all dependent items and build our service:</p><div class="informalexample"><pre class="programlisting">$service = new MyService(
    new Repository(new PDO('dsn', 'username', 'password')),
    new Session(),
    new Mailer(new SmtpMailerTransport('username', 'password', host')),
    new Cache(new FileSystem('/tmp/cache')),
);</pre></div><p>Dependency injection container is a factory that allows us to not care about building our <a class="indexterm" id="id23"/>objects. In Yii2 we can configure a container only once and use it for retrieving our service like this:</p><div class="informalexample"><pre class="programlisting">$service = Yii::$container-&gt;get('app\services\MyService')</pre></div><p>We can also use this:</p><div class="informalexample"><pre class="programlisting">$service = Yii::createObject('app\services\MyService')</pre></div><p>Or we ask the container to inject it as a dependency in the constructor of an other service:</p><div class="informalexample"><pre class="programlisting">use app\services\MyService;
class OtherService
{
    public function __construct(MyService $myService) { … }
}</pre></div><p>When we will get the <code class="literal">OtherService</code> instance:</p><div class="informalexample"><pre class="programlisting">$otherService = Yii::createObject('app\services\OtherService')</pre></div><p>In all cases the container will resolve all dependencies and inject dependent objects in each other.</p><p>In the recipe we create shopping cart with storage subsystem and inject the cart automatically into controller.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec18"/>Getting ready</h2></div></div></div><p>Create a new application by using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-startinstallation.html">http://www.yiiframework.com/doc-2.0/guide-startinstallation.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec19"/>How to do it…</h2></div></div></div><p>Carry out the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a shopping cart class:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\cart;

use app\cart\storage\StorageInterface;

class ShoppingCart
{
    private $storage;

    private $_items = [];

    public function __construct(StorageInterface $storage)
    {
        $this-&gt;storage = $storage;
    }

    public function add($id, $amount)
    {
        $this-&gt;loadItems();
        if (array_key_exists($id, $this-&gt;_items)) {
            $this-&gt;_items[$id]['amount'] += $amount;
        } else {
            $this-&gt;_items[$id] = [
                'id' =&gt; $id,
                'amount' =&gt; $amount,
            ];
        }
        $this-&gt;saveItems();
    }

    public function remove($id)
    {
        $this-&gt;loadItems();
        $this-&gt;_items = array_diff_key($this-&gt;_items, [$id =&gt; []]);
        $this-&gt;saveItems();
    }

    public function clear()
    {
        $this-&gt;_items = [];
        $this-&gt;saveItems();
    }

    public function getItems()
    {
        $this-&gt;loadItems();
        return $this-&gt;_items;
    }

    private function loadItems()
    {
        $this-&gt;_items = $this-&gt;storage-&gt;load();
    }

    private function saveItems()
    {
        $this-&gt;storage-&gt;save($this-&gt;_items);
    }
}</pre></div></li><li class="listitem">It will work only with own items. Instead of built-in storing items to session it will delegate this responsibility to any external storage class, which will implement the <code class="literal">StorageInterface</code> interface.</li><li class="listitem">The cart <a class="indexterm" id="id24"/>class just gets the storage object in its own constructor, saves it instance into private <code class="literal">$storage</code> field and calls its <code class="literal">load()</code> and <code class="literal">save()</code> methods.</li><li class="listitem">Define a common cart storage interface with the required methods:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\cart\storage;

interface StorageInterface
{
    /**
    * @return array of cart items
    */
    public function load();

    /**
    * @param array $items from cart
    */
    public function save(array $items);
}</pre></div></li><li class="listitem">Create a simple storage implementation. It will store selected items in a server session:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\cart\storage;

use yii\web\Session;

class SessionStorage implements StorageInterface
{
    private $session;
    private $key;

    public function __construct(Session $session, $key)
    {
        $this-&gt;key = $key;
        $this-&gt;session = $session;
    }

    public function load()
    {
        return $this-&gt;session-&gt;get($this-&gt;key, []);
    }

    public function save(array $items)
    {
        $this-&gt;session-&gt;set($this-&gt;key, $items);
    }
}</pre></div></li><li class="listitem">The storage <a class="indexterm" id="id25"/>gets any framework session instance in the constructor and uses it later for retrieving and storing items.</li><li class="listitem">Configure the <code class="literal">ShoppingCart</code> class and its dependencies in the <code class="literal">config/web.php</code> file:<div class="informalexample"><pre class="programlisting">&lt;?php
use app\cart\storage\SessionStorage;

Yii::$container-&gt;setSingleton('app\cart\ShoppingCart');

Yii::$container-&gt;set('app\cart\storage\StorageInterface', function() {
    return new SessionStorage(Yii::$app-&gt;session, 'primary-cart');
});

$params = require(__DIR__ . '/params.php');

//…</pre></div></li><li class="listitem">Create the cart controller with an extended constructor:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\controllers;

use app\cart\ShoppingCart;
use app\models\CartAddForm;
use Yii;
use yii\data\ArrayDataProvider;
use yii\filters\VerbFilter;
use yii\web\Controller;

class CartController extends Controller
{
    private $cart;

    public function __construct($id, $module, ShoppingCart $cart, $config = [])
    {
        $this-&gt;cart = $cart;
        parent::__construct($id, $module, $config);
    }

    public function behaviors()
    {
        return [
            'verbs' =&gt; [
                'class' =&gt; VerbFilter::className(),
                'actions' =&gt; [
                    'delete' =&gt; ['post'],
                ],
            ],
        ];
    }

    public function actionIndex()
    {
        $dataProvider = new ArrayDataProvider([
            'allModels' =&gt; $this-&gt;cart-&gt;getItems(),
        ]);

        return $this-&gt;render('index', [
            'dataProvider' =&gt; $dataProvider,
        ]);
    }

    public function actionAdd()
    {
        $form = new CartAddForm();

        if ($form-&gt;load(Yii::$app-&gt;request-&gt;post()) &amp;&amp; $form-&gt;validate()) {
            $this-&gt;cart-&gt;add($form-&gt;productId, $form-&gt;amount);
            return $this-&gt;redirect(['index']);
        }

        return $this-&gt;render('add', [
            'model' =&gt; $form,
        ]);
    }

    public function actionDelete($id)
    {
        $this-&gt;cart-&gt;remove($id);

        return $this-&gt;redirect(['index']);
    }
}</pre></div></li><li class="listitem">Create <a class="indexterm" id="id26"/>a form:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\models;

use yii\base\Model;

class CartAddForm extends Model
{
    public $productId;
    public $amount;

    public function rules()
    {
        return [
            [['productId', 'amount'], 'required'],
            [['amount'], 'integer', 'min' =&gt; 1],
        ];
    }
}</pre></div></li><li class="listitem">Create the <code class="literal">views/cart/index.php</code> view:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\grid\ActionColumn;
use yii\grid\GridView;
use yii\grid\SerialColumn;
use yii\helpers\Html;

/* @var $this yii\web\View */
/* @var $dataProvider yii\data\ArrayDataProvider */

$this-&gt;title = 'Cart';
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;
?&gt;
&lt;div class="cart-index"&gt;
    &lt;h1&gt;&lt;?= Html::encode($this-&gt;title) ?&gt;&lt;/h1&gt;

    &lt;p&gt;&lt;?= Html::a('Add Item', ['add'], ['class' =&gt; 'btn btn-success']) ?&gt;&lt;/p&gt;

    &lt;?= GridView::widget([
        'dataProvider' =&gt; $dataProvider,
        'columns' =&gt; [
            ['class' =&gt; SerialColumn::className()],

            'id:text:Product ID',
            'amount:text:Amount',

            [
                'class' =&gt; ActionColumn::className(),
                'template' =&gt; '{delete}',
            ]
        ],
    ]) ?&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Create <a class="indexterm" id="id27"/>the <code class="literal">views/cart/add.php</code> view:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;
use yii\bootstrap\ActiveForm;

/* @var $this yii\web\View */
/* @var $form yii\bootstrap\ActiveForm */
/* @var $model app\models\CartAddForm */

$this-&gt;title = 'Add item';
$this-&gt;params['breadcrumbs'][] = ['label' =&gt; 'Cart', 'url' =&gt; ['index']];
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;
?&gt;
&lt;div class="cart-add"&gt;
    &lt;h1&gt;&lt;?= Html::encode($this-&gt;title) ?&gt;&lt;/h1&gt;

    &lt;?php $form = ActiveForm::begin(['id' =&gt; 'contact-form']); ?&gt;
        &lt;?= $form-&gt;field($model, 'productId') ?&gt;
        &lt;?= $form-&gt;field($model, 'amount') ?&gt;
        &lt;div class="form-group"&gt;
            &lt;?= Html::submitButton('Add', ['class' =&gt; 'btn btn-primary']) ?&gt;
        &lt;/div&gt;
    &lt;?php ActiveForm::end(); ?&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Add link items into the main menu:<div class="informalexample"><pre class="programlisting">['label' =&gt; 'Home', 'url' =&gt; ['/site/index']],
['label' =&gt; 'Cart', 'url' =&gt; ['/cart/index']],
['label' =&gt; 'About', 'url' =&gt; ['/site/about']],
// …</pre></div></li><li class="listitem">Open <a class="indexterm" id="id28"/>the cart page and try to add rows:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00448.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec20"/>How it works…</h2></div></div></div><p>In this case we have the main <code class="literal">ShoppingCart</code> class with a low-level dependency, defined by an abstraction interface:</p><div class="informalexample"><pre class="programlisting">class ShoppingCart
{
    public function __construct(StorageInterface $storage) { … }
}

interface StorageInterface
{
   public function load();
   public function save(array $items);
}</pre></div><p>And we have some an implementation of the abstraction:</p><div class="informalexample"><pre class="programlisting">class SessionStorage implements StorageInterface
{
    public function __construct(Session $session, $key) { … }
}</pre></div><p>Right <a class="indexterm" id="id29"/>now we can create an instance of the cart manually like this:</p><div class="informalexample"><pre class="programlisting">$storage = new SessionStorage(Yii::$app-&gt;session, 'primary-cart');
$cart = new ShoppingCart($storage)</pre></div><p>It allows us to create a lot of different implementations such as <code class="literal">SessionStorage</code>, <code class="literal">CookieStorage</code>, or <code class="literal">DbStorage</code>. And we can reuse the framework-independent <code class="literal">ShoppingCart</code> class with <code class="literal">StorageInterface</code> in different projects and different frameworks. We must only implement the storage class with the interface's methods for needed framework.</p><p>But instead of manually creating an instance with all dependencies, we can use a dependency injection container.</p><p>By default the container parses the constructors of all classes and recursively creates all the required instances. For example, if we have four classes:</p><div class="informalexample"><pre class="programlisting">class A {
     public function __construct(B $b, C $c) { … }
}

class B {
    ...
}

class C {
    public function __construct(D $d) { … }
}

class D {
    ...
}</pre></div><p>We can retrieve the instance of class <code class="literal">A</code> in two ways:</p><div class="informalexample"><pre class="programlisting">$a = Yii::$container-&gt;get('app\services\A')
// or
$a = Yii::createObject('app\services\A')</pre></div><p>And the container automatically creates instances of the <code class="literal">B</code>, <code class="literal">D</code>, <code class="literal">C</code>, and <code class="literal">A</code> classes and injects them into each other.</p><p>In our case we mark the cart instance as a singleton:</p><div class="informalexample"><pre class="programlisting">Yii::$container-&gt;setSingleton('app\cart\ShoppingCart');</pre></div><p>This means that the container will return a single instance for every repeated call instead of creating the cart again and again.</p><p>Besides, our <code class="literal">ShoppingCart</code> has the <code class="literal">StorageInterface</code> type in its own constructor and the container <a class="indexterm" id="id30"/>does know what class it must instantiate for this type. We must manually bind the class to the interface like this:</p><div class="informalexample"><pre class="programlisting">Yii::$container-&gt;set('app\cart\storage\StorageInterface', 'app\cart\storage\CustomStorage',);</pre></div><p>But our <code class="literal">SessionStorage</code> class has non-standard constructor:</p><div class="informalexample"><pre class="programlisting">class SessionStorage implements StorageInterface
{
    public function __construct(Session $session, $key) { … }
}</pre></div><p>Therefore we use an anonymous function to manually creatie the instance:</p><div class="informalexample"><pre class="programlisting">Yii::$container-&gt;set('app\cart\storage\StorageInterface', function() {
    return new SessionStorage(Yii::$app-&gt;session, 'primary-cart');
});</pre></div><p>And after all we can retrieve the cart object from the container manually in our own controllers, widgets, and other places:</p><div class="informalexample"><pre class="programlisting">$cart = Yii::createObject('app\cart\ShoppingCart')</pre></div><p>But every controller and other object will be created via the <code class="literal">createObject</code> method inside the framework. And we can use injection of cart via the controller constructor:</p><div class="informalexample"><pre class="programlisting">class CartController extends Controller
{
    private $cart;

    public function __construct($id, $module, ShoppingCart $cart, $config = [])
    {
        $this-&gt;cart = $cart;
        parent::__construct($id, $module, $config);
    }

    // ...
}</pre></div><p>Use this <a class="indexterm" id="id31"/>injected cart object:</p><div class="informalexample"><pre class="programlisting">public function actionDelete($id)
{
    $this-&gt;cart-&gt;remove($id);
    return $this-&gt;redirect(['index']);
}</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec21"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">For <a class="indexterm" id="id32"/>more information about DIP refer to <a class="ulink" href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">https://en.wikipedia.org/wiki/Dependency_inversion_principle</a></li><li class="listitem">In order to learn more about dependency injection container refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-concept-di-container.html">http://www.yiiframework.com/doc-2.0/guide-concept-di-container.html</a></li></ul></div></div></div>
<div class="section" title="Service locator"><div class="titlepage" id="I3QM2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch01lvl1sec13"/>Service locator</h1></div></div></div><p>Instead <a class="indexterm" id="id33"/>of manually creating instances of different shared services (application components) we can get them from a special global object, which contains configurations and instances of all components.</p><p>A service locator is a global object that contains a list of components or definitions, uniquely identified by an ID, and allow us to retrieve any needed instance by its ID. The locator creates a single instance of the component on-the-fly at the first call and returns a previous instance at the subsequent calls.</p><p>In this recipe, we will create a shopping cart component and will write a cart controller for working with it.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec22"/>Getting ready</h2></div></div></div><p>Create a new application by using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec23"/>How to do it…</h2></div></div></div><p>Carry out the <a class="indexterm" id="id34"/>following steps to create a shopping cart component:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a shopping cart component. It will store selected items in a user session:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\components;

use Yii;
use yii\base\Component;

class ShoppingCart extends Component
{
    public $sessionKey = 'cart';

    private $_items = [];

    public function add($id, $amount)
    {
        $this-&gt;loadItems();
        if (array_key_exists($id, $this-&gt;_items)) {
            $this-&gt;_items[$id]['amount'] += $amount;
        } else {
            $this-&gt;_items[$id] = [
                'id' =&gt; $id,
                'amount' =&gt; $amount,
            ];
        }
       $this-&gt;saveItems();
    }

    public function remove($id)
    {
        $this-&gt;loadItems();
        $this-&gt;_items = array_diff_key($this-&gt;_items, [$id =&gt; []]);
        $this-&gt;saveItems();
    }

    public function clear()
    {
        $this-&gt;_items = [];
        $this-&gt;saveItems();
    }

    public function getItems()
    {
        $this-&gt;loadItems();
        return $this-&gt;_items;
    }

    private function loadItems()
    {
        $this-&gt;_items = Yii::$app-&gt;session-&gt;get($this-&gt;sessionKey, []);
    }

    private function saveItems()
    {
        Yii::$app-&gt;session-&gt;set($this-&gt;sessionKey, $this-&gt;_items);
    }
}</pre></div></li><li class="listitem">Register the <code class="literal">ShoppingCart</code> in service locator as an application component in the <code class="literal">config/web.php</code> file:<div class="informalexample"><pre class="programlisting">'components' =&gt; [
    …
    'cart =&gt; [
        'class' =&gt; 'app\components\ShoppingCart',
        'sessionKey' =&gt; 'primary-cart',
    ],
]</pre></div></li><li class="listitem">Create <a class="indexterm" id="id35"/>a cart controller:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\controllers;

use app\models\CartAddForm;
use Yii;
use yii\data\ArrayDataProvider;
use yii\filters\VerbFilter;
use yii\web\Controller;

class CartController extends Controller
{
    public function behaviors()
    {
        return [
            'verbs' =&gt; [
                'class' =&gt; VerbFilter::className(),
                'actions' =&gt; [
                    'delete' =&gt; ['post'],
                ],
            ],
        ];
    }

    public function actionIndex()
    {
        $dataProvider = new ArrayDataProvider([
            'allModels' =&gt; Yii::$app-&gt;cart-&gt;getItems(),
        ]);

        return $this-&gt;render('index', [
            'dataProvider' =&gt; $dataProvider,
        ]);
    }

    public function actionAdd()
    {
        $form = new CartAddForm();

        if ($form-&gt;load(Yii::$app-&gt;request-&gt;post()) &amp;&amp; $form-&gt;validate()) {
            Yii::$app-&gt;cart-&gt;add($form-&gt;productId, $form-&gt;amount);
            return $this-&gt;redirect(['index']);
        }

        return $this-&gt;render('add', [
            'model' =&gt; $form,
        ]);
    }

    public function actionDelete($id)
    {
        Yii::$app-&gt;cart-&gt;remove($id);

        return $this-&gt;redirect(['index']);
    }
}</pre></div></li><li class="listitem">Create <a class="indexterm" id="id36"/>a form:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\models;

use yii\base\Model;

class CartAddForm extends Model
{
    public $productId;
    public $amount;

    public function rules()
    {
        return [
            [['productId', 'amount'], 'required'],
            [['amount'], 'integer', 'min' =&gt; 1],
        ];
    }
}</pre></div></li><li class="listitem">Create <a class="indexterm" id="id37"/>the <code class="literal">views</code>/<code class="literal">cart</code>/<code class="literal">index.php</code> view:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\grid\ActionColumn;
use yii\grid\GridView;
use yii\grid\SerialColumn;
use yii\helpers\Html;

/* @var $this yii\web\View */
/* @var $dataProvider yii\data\ArrayDataProvider */

$this-&gt;title = 'Cart';
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;
?&gt;
&lt;div class="site-contact"&gt;
    &lt;h1&gt;&lt;?= Html::encode($this-&gt;title) ?&gt;&lt;/h1&gt;

    &lt;p&gt;&lt;?= Html::a('Add Item', ['add'], ['class' =&gt; 'btn btn-success']) ?&gt;&lt;/p&gt;

    &lt;?= GridView::widget([
        'dataProvider' =&gt; $dataProvider,
        'columns' =&gt; [
            ['class' =&gt; SerialColumn::className()],

            'id:text:Product ID',
            'amount:text:Amount',

            [
               'class' =&gt; ActionColumn::className(),
               'template' =&gt; '{delete}',
            ]
        ],
    ]) ?&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Create the <code class="literal">views</code>/<code class="literal">cart</code>/<code class="literal">add.php</code> view:<div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Html;
use yii\bootstrap\ActiveForm;

/* @var $this yii\web\View */
/* @var $form yii\bootstrap\ActiveForm */
/* @var $model app\models\CartAddForm */

$this-&gt;title = 'Add item';
$this-&gt;params['breadcrumbs'][] = ['label' =&gt; 'Cart', 'url' =&gt; ['index']];
$this-&gt;params['breadcrumbs'][] = $this-&gt;title;
?&gt;
&lt;div class="site-contact"&gt;
    &lt;h1&gt;&lt;?= Html::encode($this-&gt;title) ?&gt;&lt;/h1&gt;

    &lt;?php $form = ActiveForm::begin(['id' =&gt; 'contact-form']); ?&gt;
        &lt;?= $form-&gt;field($model, 'productId') ?&gt;
        &lt;?= $form-&gt;field($model, 'amount') ?&gt;
        &lt;div class="form-group"&gt;
            &lt;?= Html::submitButton('Add', ['class' =&gt; 'btn btn-primary']) ?&gt;
        &lt;/div&gt;
    &lt;?php ActiveForm::end(); ?&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Add <a class="indexterm" id="id38"/>a link item into the main menu:<div class="informalexample"><pre class="programlisting">['label' =&gt; 'Home', 'url' =&gt; ['/site/index']],
['label' =&gt; 'Cart', 'url' =&gt; ['/cart/index']],
['label' =&gt; 'About', 'url' =&gt; ['/site/about']],
// …</pre></div></li><li class="listitem">Open the cart page and try to add rows:<div class="mediaobject"><img alt="How to do it…" src="../Images/image00458.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec24"/>How it works…</h2></div></div></div><p>First of all <a class="indexterm" id="id39"/>we created our own class with a public <code class="literal">sessionKey</code> option:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\components;
use yii\base\Component;

class ShoppingCart extends Component
{
    public $sessionKey = 'cart';

    // …
}</pre></div><p>Secondly, we added the component definition into the <code class="literal">components</code> section of the configuration file:</p><div class="informalexample"><pre class="programlisting">'components' =&gt; [
    …
    'cart =&gt; [
        'class' =&gt; 'app\components\ShoppingCart',
        'sessionKey' =&gt; 'primary-cart',
    ],
]</pre></div><p>Right now we can retrieve the component instance in two ways:</p><div class="informalexample"><pre class="programlisting">$cart = Yii::$app-&gt;cart;
$cart = Yii::$app-&gt;get('cart');</pre></div><p>And we can use this object in our own controllers, widgets, and other places.</p><p>When we <a class="indexterm" id="id40"/>call any component such as <code class="literal">cart</code>:</p><div class="informalexample"><pre class="programlisting">Yii::$app-&gt;cart</pre></div><p>We call the virtual property of the <code class="literal">Application</code> class instance in the <code class="literal">Yii::$app</code> static variable. But the <code class="literal">yii\base\Application</code> class extends the <code class="literal">yii\base\Module</code> class, which extends the <code class="literal">yii\di\ServiceLocator</code> class with the <code class="literal">__get</code> magic method. This magic method just calls the <code class="literal">get()</code> method of the <code class="literal">yii\di\ServiceLocator</code> class:</p><div class="informalexample"><pre class="programlisting">namespace yii\di;

class ServiceLocator extends Component
{
    private $_components = [];
    private $_definitions = [];

    public function __get($name)
    {
        if ($this-&gt;has($name)) {
            return $this-&gt;get($name);
        } else {
            return parent::__get($name);
        }
    }
    // …
}</pre></div><p>As a result it is an alternative to directly calling the service via the <code class="literal">get</code> method:</p><div class="informalexample"><pre class="programlisting">Yii::$app-&gt;get('cart);</pre></div><p>When we get a component from the <code class="literal">get</code> method of service locator, the locator finds needed definition in its <code class="literal">_definitions</code> list and if successful it creates a new object by the definition on the fly, registers it in its own list of complete instances <code class="literal">_components</code> and returns the object.</p><p>If we get some component, multiplying the locator will always return the previous saved instance again and again:</p><div class="informalexample"><pre class="programlisting">$cart1 = Yii::$app-&gt;cart;
$cart2 = Yii::$app-&gt;cart;
var_dump($cart1 === $cart2); // bool(true)</pre></div><p>It allows <a class="indexterm" id="id41"/>us to use the shared single cart instance <code class="literal">Yii::$app-&gt;cart</code> or single database connection <code class="literal">Yii::$app-&gt;db</code> instead of creating one large set from scratch again and again.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec25"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">For <a class="indexterm" id="id42"/>more information about the service locator and about core framework components refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-concept-service-locator.html">http://www.yiiframework.com/doc-2.0/guide-concept-service-locator.html</a></li><li class="listitem">The <span class="emphasis"><em>Configuring components</em></span> recipe</li><li class="listitem">The <span class="emphasis"><em>Creating components</em></span> recipe in <a class="link" href="part0086.xhtml#2I0GC1-ae331331bc644dc9b658d3634f0748da" title="Chapter 8. Extending Yii">Chapter 8</a>, <span class="emphasis"><em>Extending Yii</em></span></li></ul></div></div></div>
<div class="section" id="J2B81-ae331331bc644dc9b658d3634f0748da" title="Code generation"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec14"/>Code generation</h1></div></div></div><p>Yii2 <a class="indexterm" id="id43"/>provides the powerful module Gii to generate models, controllers, and views, which you can easily modify and customize. It's a really helpful tool for fast and quick development.</p><p>In this section we will explore how to use Gii and generate code. For example you have a database with one table named <code class="literal">film</code> and you would like to create an application with CRUD operations for this table. It's easy.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec26"/>Getting ready</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new application by using composer as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</li><li class="listitem">Download <a class="indexterm" id="id44"/>the Sakila database from <a class="ulink" href="http://dev.mysql.com/doc/index-other.html">http://dev.mysql.com/doc/index-other.html</a>.</li><li class="listitem">Execute the downloaded SQLs: first the schema then the data.</li><li class="listitem">Configure the database connection in <code class="literal">config/main.php</code> to use the Sakila database.</li><li class="listitem">Run your web-server by <code class="literal">./yii serve</code>.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec27"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <code class="literal">http://localhost:8080/index.php?r=gii</code> and select <span class="strong"><strong>Model Generator</strong></span>.</li><li class="listitem">Fill out <span class="strong"><strong>Table Name</strong></span> as <code class="literal">actor</code> and <span class="strong"><strong>Model Class</strong></span> as <code class="literal">Actor</code> and press button <span class="strong"><strong>Generate</strong></span> at the bottom of page.<div class="mediaobject"><img alt="How to do it…" src="../Images/image00463.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Return to<a class="indexterm" id="id45"/>the main Gii menu by clicking the <span class="strong"><strong>yii code generator</strong></span> logo on the header and choose <span class="strong"><strong>CRUD Generator</strong></span>.</li><li class="listitem">Fill out the <span class="strong"><strong>Model Class</strong></span> field as <code class="literal">app\models\Actor</code> and <span class="strong"><strong>Controller Class</strong></span> as <code class="literal">app\controllers\ActorController</code>.<div class="mediaobject"><img alt="How to do it…" src="../Images/image00466.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Press <a class="indexterm" id="id46"/>the <span class="strong"><strong>Preview</strong></span> button at the bottom of page and then press green button <span class="strong"><strong>Generate</strong></span>.</li><li class="listitem">Check the result via <code class="literal">http://localhost:8080/index.php?actor/create</code>.<div class="mediaobject"><img alt="How to do it…" src="../Images/image00480.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec28"/>How it works…</h2></div></div></div><p>If you <a class="indexterm" id="id47"/>check your project structure you will see autogenerated code:</p><div class="mediaobject"><img alt="How it works…" src="../Images/image00471.jpeg"/></div><p style="clear:both; height: 1em;"> </p><p>Firstly <a class="indexterm" id="id48"/>we've created an <code class="literal">Actor</code> model. Gii automatically creates all model rules which depends on <code class="literal">mysql</code> field types. For example, if in your MySQL <code class="literal">actor</code> table's fields <code class="literal">first_name</code> and <code class="literal">last_name</code> have <code class="literal">IS NOT NULL</code> flag then Yii automatically creates rule for it <code class="literal">required</code> and sets max length <code class="literal">45</code> symbols because in our database max length of this field is set up as <code class="literal">45</code>.</p><div class="informalexample"><pre class="programlisting">public function rules()
{
    return [
        [['first_name', 'last_name'], 'required'],
        [['last_update'], 'safe'],
        [['first_name', 'last_name'], 'string', 'max' =&gt; 45],
    ];
}</pre></div><p>Also Yii creates relationship between models automatically, based on foreign keys you added to your database. In our case two relations were created automatically.</p><div class="informalexample"><pre class="programlisting">public function getFilmActors()
{
    return $this-&gt;hasMany(FilmActor::className(), ['actor_id' =&gt; 'actor_id']);
}

public function getFilms()
{
    return $this-&gt;hasMany(Film::className(), ['film_id' =&gt; 'film_id'])-&gt;viaTable('film_actor', ['actor_id' =&gt; 'actor_id']);
}</pre></div><p>This relationship <a class="indexterm" id="id49"/>has been created because we have two foreign keys in our database. The <code class="literal">film_actor</code> table has foreign key <code class="literal">fk_film_actor_actor</code> which points to <code class="literal">actor</code> table fields <code class="literal">actor_id</code> and <code class="literal">fk_film_actor_film</code> which points to <code class="literal">film</code> table field <code class="literal">film_id</code>.</p><a class="indexterm" id="id50"/><p>Notice that you haven't generated <code class="literal">FilmActor</code> model yet. So if you would develop full-app versus demo you had to generate <code class="literal">Film</code>, <code class="literal">FilmActor</code> models also. For the rest of the pieces, refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-gii.html">http://www.yiiframework.com/doc-2.0/guide-start-gii.html</a>.</p></div></div>
<div class="section" id="K0RQ1-ae331331bc644dc9b658d3634f0748da" title="Configuring components"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec15"/>Configuring components</h1></div></div></div><p>Yii is a very <a class="indexterm" id="id51"/>customizable framework. Moreover, as in all customizable code, there should be a convenient way to set up different application parts. In Yii, this is provided through configuration files located at <code class="literal">config</code>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec29"/>Getting ready</h2></div></div></div><p>Create a new application by using the Composer package manager as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-startinstallation.html">http://www.yiiframework.com/doc-2.0/guide-startinstallation.html</a>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec30"/>How to do it…</h2></div></div></div><p>If you have worked with Yii before, then you have probably configured a database connection:</p><div class="informalexample"><pre class="programlisting">return [
    …
    'components' =&gt; [
        'db' =&gt; [
            'class' =&gt; 'system.db.CDbConnection',
            'dsn' =&gt; 'mysql:host=localhost;dbname=database_name',
            'username' =&gt; 'root',
            'password' =&gt; '',
            'charset' =&gt; 'utf8',
        ],
        …
    ],
    …
];</pre></div><p>This way of configuring components is used when you want to use a component across all application parts. With the preceding configuration, you can access a component by its name, such as <code class="literal">Yii::$app-&gt;db</code>.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec31"/>How it works…</h2></div></div></div><p>When <a class="indexterm" id="id52"/>you are using the <code class="literal">Yii::$app-&gt;db</code> component for the first time directly or through an Active Record model, Yii creates a component and initializes its public properties with the corresponding values provided in <code class="literal">db</code> array under the <code class="literal">components</code> section of the application configuration file. In the preceding code, <code class="literal">dsn</code> value will be assigned to <code class="literal">yii\db\Connection::dsn</code>, <code class="literal">username</code> will be assigned to <code class="literal">Connection::username</code>, and so on.</p><p>If you want to find out what <code class="literal">charset</code> stands for or want to know what else you can configure in the <code class="literal">db</code> component, then you need to know its class. In the case of the <code class="literal">db</code> component, the class is <code class="literal">yii\db\Connection</code>. You can just open the class and look for its public properties, which you can set from config.</p><p>In the preceding code, the <code class="literal">class</code> property is a bit special because it is used to specify the component class name. It does not exist in the <code class="literal">yii\db\Connection</code> class. Therefore, it can be used to override a class as follows:</p><div class="informalexample"><pre class="programlisting">return [
    …
    'components' =&gt; [
        'db' =&gt; [
            'class' =&gt; app\components\MyConnection',
            …
        ],
        …
    ],
     …
);</pre></div><p>This way, you can <a class="indexterm" id="id53"/>override each application component; this is very useful whenever a standard component does not fit your application.</p><div class="section" title="Built-in components"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec03"/>Built-in components</h3></div></div></div><p>Now, let's <a class="indexterm" id="id54"/>find out which standard Yii application <a class="indexterm" id="id55"/>components you can configure. There are two application types bundled with Yii:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Web application (<code class="literal">yii\webApplication</code>)</li><li class="listitem">Console application (<code class="literal">yii\console\Application</code>)</li></ul></div><p>Both are extended from <code class="literal">yii\base\Application</code>, so both console and web applications share its components.</p><p>You can get the component names from the source code of the <code class="literal">coreComponents()</code> application's method.</p><p>You can add your own application components (classes extended from <code class="literal">yii\base\Component</code>) by simply adding new configuration items and pointing their class properties to your custom classes.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec32"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Both <a class="indexterm" id="id56"/>console and web application <a class="indexterm" id="id57"/>components are listed in the list at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-structure-application-components.html">http://www.yiiframework.com/doc-2.0/guide-structure-application-components.html</a></li><li class="listitem">For more information on creating your own components see:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="emphasis"><em>Service locator</em></span> recipe</li><li class="listitem">The <span class="emphasis"><em>Creating components</em></span> recipe in <a class="link" href="part0086.xhtml#2I0GC1-ae331331bc644dc9b658d3634f0748da" title="Chapter 8. Extending Yii">Chapter 8</a>, <span class="emphasis"><em>Extending Yii</em></span></li></ul></div></li></ul></div></div></div>
<div class="section" title="Working with events"><div class="titlepage" id="KVCC2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch01lvl1sec16"/>Working with events</h1></div></div></div><p>Yii's events <a class="indexterm" id="id58"/>provide a simple implementation, which allows you to listen and subscribe to various events that occur in your web-application. For example, you may wish to send a notification about a new article to followers each time you publish new material.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec33"/>Getting ready</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new application by using the Composer package manager, as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</li><li class="listitem">Execute the following SQL code on your server to create the <code class="literal">article</code> table:<div class="informalexample"><pre class="programlisting">CREATE TABLE 'article' (
    'id' int(11) NOT NULL AUTO_INCREMENT,
    'name' varchar(255) DEFAULT NULL,
    'description' text,
    PRIMARY KEY ('id')
) ENGINE=InnoDB AUTO_INCREMENT=29 DEFAULT CHARSET=utf8;</pre></div></li><li class="listitem">Generate the <code class="literal">Article</code> model using Gii.</li><li class="listitem">Run your webserver by <code class="literal">./yii serve</code> command.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec34"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add an action <a class="indexterm" id="id59"/>test to <code class="literal">\controllers\SiteController</code>:<div class="informalexample"><pre class="programlisting">public function actionTest()
{
    $article = new Article();
    $article-&gt;name = 'Valentine\'s Day\'s coming? Aw crap! I forgot to get a girlfriend again!';
    $article-&gt;description = 'Bender is angry at Fry for dating a robot. Stay away from our women.
    You've got metal fever, boy. Metal fever';

    // $event is an object of yii\base\Event or a child class
    $article-&gt;on(ActiveRecord::EVENT_AFTER_INSERT, function($event) {
        $followers = ['john2@teleworm.us', 'shivawhite@cuvox.de', 'kate@dayrep.com' ];
        foreach($followers as $follower) {
            Yii::$app-&gt;mailer-&gt;compose()
                -&gt;setFrom('techblog@teleworm.us')
                -&gt;setTo($follower)
                -&gt;setSubject($event-&gt;sender-&gt;name)
                -&gt;setTextBody($event-&gt;sender-&gt;description)
                -&gt;send();
        }
        echo 'Emails has been sent';
    });

    if (!$article-&gt;save()) {
        echo VarDumper::dumpAsString($article-&gt;getErrors());
    };
}</pre></div></li><li class="listitem">Update the <code class="literal">config/web.php</code> component <code class="literal">mailer</code> using the following code.<div class="informalexample"><pre class="programlisting">'mailer' =&gt; [
    'class' =&gt; 'yii\swiftmailer\Mailer',
    'useFileTransport' =&gt; false,
],</pre></div></li><li class="listitem">Run this <a class="indexterm" id="id60"/>URL in your browser: <code class="literal">http://localhost:8080/index.php?r=site/test</code>.</li><li class="listitem">Also check <code class="literal">http://www.fakemailgenerator.com/inbox/teleworm.u</code><code class="literal">s/john2/</code>.<div class="mediaobject"><img alt="How to do it…" src="../Images/image00510.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec35"/>How it works…</h2></div></div></div><p>We've created an <code class="literal">Article</code> model and added a handler for the <code class="literal">ActiveRecord::EVENT_AFTER_INSERT</code> event to our <code class="literal">Article</code> model. It means that every time we save a new article an event is triggered and our attached handler will be called.</p><p>In the real-world, we would like to notify our blog followers each time we publish a new article. In a real application we would have a <code class="literal">follower</code> or <code class="literal">user</code> table and with different blog sections not only single blog. In this example, after saving our model we notify our followers <code class="literal">john2@teleworm.us</code>, <code class="literal">shivawhite@cuvox.de</code>, and <code class="literal">kate@dayrep.com</code>. In the last step we just prove that users have received our notifications, particularly <code class="literal">john2</code>. You can create your own <a class="indexterm" id="id61"/>event with any name. In this example we use a built-in event called <code class="literal">ActiveRecord::EVENT_AFTER_INSERT</code>, which is called after each insert to the database.</p><p>For example, we <a class="indexterm" id="id62"/>can create our own event. Just add a new <code class="literal">actionTestNew</code> with the following code:</p><div class="informalexample"><pre class="programlisting">public function actionTestNew()
{
    $article = new Article();
    $article-&gt;name = 'Valentine\'s Day\'s coming? Aw crap! I forgot to get a girlfriend again!';
    $article-&gt;description = 'Bender is angry at Fry for dating a robot. Stay away from our women.
    You've got metal fever, boy. Metal fever';

    // $event is an object of yii\base\Event or a child class
    $article-&gt;on(Article::EVENT_OUR_CUSTOM_EVENT, function($event) {
        $followers = ['john2@teleworm.us', 'shivawhite@cuvox.de', 'kate@dayrep.com' ];
        foreach($followers as $follower) {
            Yii::$app-&gt;mailer-&gt;compose()
                -&gt;setFrom('techblog@teleworm.us')
                -&gt;setTo($follower)
                -&gt;setSubject($event-&gt;sender-&gt;name)
                -&gt;setTextBody($event-&gt;sender-&gt;description)
                -&gt;send();
        }
        echo 'Emails have been sent';
    });

    if ($article-&gt;save()) {
        $article-&gt;trigger(Article::EVENT_OUR_CUSTOM_EVENT);
    }
}</pre></div><p>Also add the <code class="literal">EVENT_OUR_CUSTOM_EVENT</code> constant to <code class="literal">models/Article</code> as:</p><div class="informalexample"><pre class="programlisting">class Article extends \yii\db\ActiveRecord
{
    CONST EVENT_OUR_CUSTOM_EVENT = 'eventOurCustomEvent';
…
}</pre></div><p>Run <code class="literal">http://localhost:8080/index.php?r=site/test-new</code>.</p><p>You should see the same result and all notifications to followers will be sent again. The main difference is we used our custom event name.</p><p>After <a class="indexterm" id="id63"/>the save, we've triggered our event. Events may be triggered by calling the <code class="literal">yii\base\Component::trigger()</code> method. The method requires an event name, and optionally an event object that describes the parameters to be passed to the event handlers.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec36"/>See also</h2></div></div></div><p>For more <a class="indexterm" id="id64"/>information about events refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-concept-events.html">http://www.yiiframework.com/doc-2.0/guide-concept-events.html</a>
</p></div></div>
<div class="section" title="Using external code"><div class="titlepage" id="LTSU2-ae331331bc644dc9b658d3634f0748da"><div><div><h1 class="title"><a id="ch01lvl1sec17"/>Using external code</h1></div></div></div><p>Package <a class="indexterm" id="id65"/>repositories, PSR standards, and social coding provide us with lots of high-quality reusable libraries and other components with free licenses. We can just install any external component in project instead of reengineering them from scratch. It improves development performance and makes for higher-quality code.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec37"/>Getting ready</h2></div></div></div><p>Create a new application by using the Composer package manager as described in the official guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-start-installation.html">http://www.yiiframework.com/doc-2.0/guide-start-installation.html</a>.</p></div><div class="section" title="How to do it… "><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec38"/>How to do it… </h2></div></div></div><p>In this recipe we will try to attach some libraries manually and via Composer.</p><div class="section" title="Installing a library via Composer"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec04"/>Installing a library via Composer</h3></div></div></div><p>When <a class="indexterm" id="id66"/>you use NoSQL or other databases <a class="indexterm" id="id67"/>without autoincrement primary keys, you must <a class="indexterm" id="id68"/>generate unique identifiers manually. For example, you <a class="indexterm" id="id69"/>can use <span class="strong"><strong>Universally Unique Identifier</strong></span> (<span class="strong"><strong>UUID</strong></span>) instead of a numerical one. Let's do it:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install <a class="ulink" href="https://github.com/ramsey/uuid">https://github.com/ramsey/uuid</a> component via Composer:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>composer require ramsey/uuid</strong></span>
</pre></div></li><li class="listitem">Create <a class="indexterm" id="id70"/>a demonstration console controller:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\commands;

use Ramsey\Uuid\Uuid;
use yii\console\Controller;

class UuidController extends Controller
{
    public function actionGenerate()
    {
        $this-&gt;stdout(Uuid::uuid4()-&gt;toString() . PHP_EOL);
        $this-&gt;stdout(Uuid::uuid4()-&gt;toString() . PHP_EOL);
        $this-&gt;stdout(Uuid::uuid4()-&gt;toString() . PHP_EOL);
        $this-&gt;stdout(Uuid::uuid4()-&gt;toString() . PHP_EOL);
        $this-&gt;stdout(Uuid::uuid4()-&gt;toString() . PHP_EOL);
    }
}</pre></div></li><li class="listitem">And just run it:<div class="informalexample"><pre class="programlisting">./yii uuid/generate</pre></div></li><li class="listitem">If successful, you'll see the following output:<div class="informalexample"><pre class="programlisting">25841e6c-6060-4a81-8368-4d99aa3617dd
fcac910a-a9dc-4760-8528-491c17591a26
4d745da3-0a6c-47df-aee7-993a42ed915c
0f3e6da5-88f1-4385-9334-b47d1801ca0f
21a28940-c749-430d-908e-1893c52f1fe0</pre></div></li><li class="listitem">That's it! Now you can use the <code class="literal">Ramsey\Uuid\Uuid</code> class in your project.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="Installing libraries manually"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec05"/>Installing libraries manually</h3></div></div></div><p>We can install <a class="indexterm" id="id71"/>a library automatically when it is <a class="indexterm" id="id72"/>provided as a Composer package. In other cases we must install it manually.</p><p>For example, create some library examples:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">awesome/namespaced/Library.php</code> file with the following code:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace awesome\namespaced;

class Library
{
    public function method()
    {
        return 'I am an awesome library with namespace.';
    }
}</pre></div></li><li class="listitem">Create the <code class="literal">old/OldLibrary.php</code> file:<div class="informalexample"><pre class="programlisting">&lt;?php
class OldLibrary
{
    function method()
    {
        return 'I am an old library without namespace.';
    }
}</pre></div></li><li class="listitem">Create a set of functions as an <code class="literal">old/functions.php</code> file:<div class="informalexample"><pre class="programlisting">&lt;?php
function simpleFunction()
{
    return 'I am a simple function.';
}</pre></div><p>And now set up this file in our application:</p></li><li class="listitem">Define the new alias for the <code class="literal">awesome</code> library namespace root in the <code class="literal">config/web.php</code> file (in <code class="literal">aliases</code> section):<div class="informalexample"><pre class="programlisting">$config = [
    'id' =&gt; 'basic',
    'basePath' =&gt; dirname(__DIR__),
    'bootstrap' =&gt; ['log'],
    'aliases' =&gt; [
        '@awesome' =&gt; '@app/awesome',
    ],
    'components' =&gt; [
        // …
    ],
    'params' =&gt; // …
];</pre></div><p>or via the <code class="literal">setAlias</code> method:</p><div class="informalexample"><pre class="programlisting">Yii::setAlias('@awesome', '@app/awesome');</pre></div></li><li class="listitem">Define <a class="indexterm" id="id73"/>a simple class file path at the top of the <code class="literal">config/web.php</code> file:<div class="informalexample"><pre class="programlisting">Yii::$classMap['OldLibrary'] = '@old/OldLibrary.php';</pre></div></li><li class="listitem">Configure <a class="indexterm" id="id74"/>autoloading of the <code class="literal">functions.php</code> file in <code class="literal">composer.json</code>:<div class="informalexample"><pre class="programlisting">"require-dev": {
    ...
},
"autoload": {
    "files": ["old/functions.php"]
},
"config": {
    ...
},</pre></div><p>And apply the changes:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>composer update</strong></span>
</pre></div></li><li class="listitem">And now create an example controller:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace app\controllers;

use yii\base\Controller;

class LibraryController extends Controller
{
    public function actionIndex()
    {
        $awesome = new \awesome\namespaced\Library();
        echo '&lt;pre&gt;' . $awesome-&gt;method() . '&lt;/pre&gt;';

        $old = new \OldLibrary();
        echo '&lt;pre&gt;' . $old-&gt;method() . '&lt;/pre&gt;';

        echo '&lt;pre&gt;' . simpleFunction() . '&lt;/pre&gt;';
    }
}</pre></div><p>And <a class="indexterm" id="id75"/>open <a class="indexterm" id="id76"/>the page:</p><div class="mediaobject"><img alt="Installing libraries manually" src="../Images/image00524.jpeg"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="Using Yii2 code in other frameworks"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec06"/>Using Yii2 code in other frameworks</h3></div></div></div><p>If you <a class="indexterm" id="id77"/>want to use Yii2 framework code with other frameworks just add Yii2-specific parameters in <code class="literal">composer.json</code>:</p><div class="informalexample"><pre class="programlisting">{
    ...
    "extra": {
        "asset-installer-paths": {
            "npm-asset-library": "vendor/npm",
            "bower-asset-library": "vendor/bower"
        }
    }
}</pre></div><p>And <a class="indexterm" id="id78"/>install the framework:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>composer require yiisoft/yii2</strong></span>
</pre></div><p>Now open the entry script of your application (on ZendFramework, Laravel, Symfony, and many more), require the Yii2 autoloader, and create the Yii application instance:</p><div class="informalexample"><pre class="programlisting">require(__DIR__ . '/../vendor/autoload.php');
require(__DIR__ . '/../vendor/yiisoft/yii2/Yii.php');
$config = require(__DIR__ . '/../config/yii/web.php');
new yii\web\Application($config);</pre></div><p>That's it! Now you can use Yii::$app instances, models, widgets and other components from Yii2.</p></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec39"/>How it works…</h2></div></div></div><p>In the first case we just install a new Composer package in our project and use it, because its <code class="literal">composer.json</code> file defines all aspects of <code class="literal">autoloading</code> library files.</p><p>But in the second case we did not have Composer packages and registered the files in the autoloading mechanism manually. In Yii2 we can use aliases and <code class="literal">Yii::$classMap</code> for registering <a class="indexterm" id="id79"/> the roots of PSR-4 namespaces and for single files.</p><p>But as an <a class="indexterm" id="id80"/>alternative we can use Composer autoloader for all cases. Just define an extended <code class="literal">autoload</code> section in the <code class="literal">composer.json</code> file like this:</p><div class="informalexample"><pre class="programlisting">"autoload": {
    "psr-0": { "": "old/" },
    "psr-4": {"awesome\\": "awesome/"},
    "files": ["old/functions.php"]
}</pre></div><p>Apply the changes using this command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>composer update</strong></span>
</pre></div><p>Right now you can remove aliases and <code class="literal">$classMap</code> definitions from your configuration files and ensure the example page still works correctly:</p><div class="mediaobject"><img alt="How it works…" src="../Images/image00479.jpeg"/></div><p style="clear:both; height: 1em;"> </p><p>This example completely uses Composer's autoloader instead of the framework's autoloader.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec40"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">For <a class="indexterm" id="id81"/>more information about integrating external code in Yii2 and framework code into our projects see the guide at <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-tutorial-yii-integration.html">http://www.yiiframework.com/doc-2.0/guide-tutorial-yii-integration.html</a></li><li class="listitem">For <a class="indexterm" id="id82"/>more on aliases refer to <a class="ulink" href="http://www.yiiframework.com/doc-2.0/guide-concept-aliases.html">http://www.yiiframework.com/doc-2.0/guide-concept-aliases.html</a></li><li class="listitem">For more on the <code class="literal">autoload</code> section of <code class="literal">composer.json</code> refer to <a class="ulink" href="https://getcomposer.org/doc/01-basic-usage.md#autoloading">https://getcomposer.org/doc/01-basic-usage.md#autoloading</a></li><li class="listitem">And also you can browse or search any Composer packages on <a class="ulink" href="https://packagist.org">https://packagist.org</a></li></ul></div></div></div></body></html>