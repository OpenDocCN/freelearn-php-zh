<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Creating a Newsletter Signup"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Creating a Newsletter Signup</h1></div></div></div><p>A newsletter signup is quite a<a id="id344" class="indexterm"/> handy application; you can adapt it quite easily to fit most applications without much fuss. It enables you to have a database of subscribers and manage them, editing their settings and removing them from the database should they choose to unsubscribe.</p><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Design and wireframes</li><li class="listitem" style="list-style-type: disc">Creating a database</li><li class="listitem" style="list-style-type: disc">Creating models</li><li class="listitem" style="list-style-type: disc">Creating views</li><li class="listitem" style="list-style-type: disc">Creating controllers</li><li class="listitem" style="list-style-type: disc">Putting it all together</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec49"/>Introduction</h1></div></div></div><p>In this project, we will create an application that will allow users to sign up for a newsletter. A form will be displayed, inviting a <a id="id345" class="indexterm"/>user to enter their e-mail address, and then it will define a couple of settings to submit that form. It will also let subscribers alter their settings and even unsubscribe entirely.</p><p>To create this app, we will create one controller. This will handle all parts of the project: subscribing, editing settings, and unsubscribing.</p><p>We'll create a language file to store text, allowing you to have multiple language support should that be required.</p><p>We'll create all the necessary view files and a model to interface with the database.</p><p>However, this app, along with all the others in this book, relies on the basic setup we did in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>. Although you can take large sections of the code and drop it into pretty much any app you might already have, please keep in mind that the setup done in the first chapter acts as a foundation for this chapter.</p><p>So, without further ado, let's get on with it.</p></div></div>
<div class="section" title="Design and wireframes"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec50"/>Design and wireframes</h1></div></div></div><p>As always, before we start building, we should take a look at what we plan to build.</p><p>First, let's look at a brief <a id="id346" class="indexterm"/>description of our intent: we plan to build an app that will allow people to sign up for a database of contacts that will be used as a newsletter signup database. We will enable users to subscribe by registering their e-mail address and <a id="id347" class="indexterm"/>some options. These will be saved in a database.</p><p>We will also enable people to amend their settings and even unsubscribe should they wish to.</p><p>Anyway, to get a better idea of what's happening, let's take a look at the following site map:</p><div class="mediaobject"><img src="graphics/7093OS_05_01.jpg" alt="Design and wireframes"/></div><p>So, that's the site map; the first thing to notice is how simple the site is. There are only three main areas in this project. Let's go over each item and get a brief idea of what they do:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Home</strong></span>: This is the initial landing area. The <code class="literal">index()</code> function is responsible for displaying a form to the<a id="id348" class="indexterm"/> user, inviting them to subscribe.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Signup</strong></span>: This<a id="id349" class="indexterm"/> processes the validation of the form input and passes that data (if validated successfully) to the <code class="literal">add()</code> model function.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Settings/Unsubscribe</strong></span>: This accepts the users' e-mail address as the third and fourth <code class="literal">uri</code> parameters and displays a form to the subscriber. This form contains the settings<a id="id350" class="indexterm"/> assigned to the e-mail <a id="id351" class="indexterm"/>address supplied. The user is able to amend these settings and unsubscribe should they wish to.</li></ul></div><p>Now that we have a fairly good idea of the structure and form of the site, let's take a look at some wireframes of each page.</p><div class="section" title="The Home – index() and Signup – index() items"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec47"/>The Home – index() and Signup – index() items</h2></div></div></div><p>The following <a id="id352" class="indexterm"/> screenshot shows you a wireframe from point <span class="strong"><strong>1</strong></span> (the Home (<code class="literal">index()</code>) item) and point 2 (the Signup (<code class="literal">index()</code>) item) in the preceding diagram. The user is shown a textbox named <code class="literal">signup_email</code> in the HTML and two checkboxes named <code class="literal">signup_opt1</code> and <code class="literal">signup_opt2</code> in the HTML.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip07"/>Tip</h3><p>These options are<a id="id353" class="indexterm"/> just an example; they can be removed or amended should you wish. They are intended to act as a filter to the newsletters. For example, you could include frequency options giving weekly, monthly, or quarterly options. When you come to send your newsletters, you would only send the subscriber a newsletter based on those options—as I say, you can change them, add more, or have none if you wish. </p></div></div><p>The user can enter their e-mail address as shown in the following screenshot, apply any options they might wish to add, and submit the form. The form is submitted to the <code class="literal">signup</code> controller's <code class="literal">index()</code> function, which will then validate that data. On passing the validation, the <code class="literal">add()</code> function of <code class="literal">Signup_model</code> will create the record in the <code class="literal">signups</code> database table.</p><div class="mediaobject"><img src="graphics/7093OS_05_02.jpg" alt="The Home – index() and Signup – index() items"/></div></div><div class="section" title="Settings/Unsubscribe – settings()"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec48"/>Settings/Unsubscribe – settings()</h2></div></div></div><p>The following <a id="id354" class="indexterm"/>screenshot shows you a wireframe from point <span class="strong"><strong>3</strong></span> (the Settings/Unsubscribe (<code class="literal">settings()</code>) item) in the site map diagram. The user is presented with a form that is pre-populated with their settings.</p><div class="mediaobject"><img src="graphics/7093OS_05_03.jpg" alt="Settings/Unsubscribe – settings()"/></div><p>We were able to fetch the correct details because of the URL. The user's e-mail address is in the URL as the third and fourth segments.</p><p>The page is loaded<a id="id355" class="indexterm"/> when a user clicks on an unsubscribe link—perhaps in an e-mail. The URL for this link would take the <code class="literal">http://www.domain.com/signup/settings/name/domain.com</code> format.</p><p>You'll notice that we don't use the <code class="literal">http://www.domain.com/signup/settings/name@domain.com</code> format.</p><p>In the second URL, you can see the <code class="literal">@</code> character; in the first, you can see that character replaced with a forward slash. In effect, we have turned the first part of the e-mail address (everything before <code class="literal">@</code>) into the third <code class="literal">uri</code> parameter, and the fourth parameter of the <code class="literal">uri</code> comes from the second part of the e-mail address (everything after <code class="literal">@</code>).</p><p>For security reasons, we are unable to use the <code class="literal">@</code> character in the URL, so we cannot have <code class="literal">http://www.domain.com/signup/settings/name@domain.com</code> as the URL. This is default CodeIgniter behavior: certain characters are disallowed from URLs in an effort to reduce the chances of malicious scripts or commands being run.</p></div><div class="section" title="File overview"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec49"/>File overview</h2></div></div></div><p>This is a relatively<a id="id356" class="indexterm"/> small project, and all in all, we're only going to create six files. These are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/signup_model.php</code>: This provides read/write access to<a id="id357" class="indexterm"/> the database.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/signup/signup.php</code>: This displays a small form to the user, inviting them to enter their e-mail address and to check two <a id="id358" class="indexterm"/>checkboxes: <span class="strong"><strong>Option 1</strong></span> and <span class="strong"><strong>Option 2</strong></span>. You can amend these options, adding more or removing them completely. The options are there to help the person who is signing up define what information they want from the application.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/signup/settings.php</code>: This displays a small form to<a id="id359" class="indexterm"/> the user, showing their current settings with the application.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/nav/top_nav.php</code>: This provides a navigation bar at the<a id="id360" class="indexterm"/> top of the page.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/signup.php</code>: This contains all functions necessary<a id="id361" class="indexterm"/> to sign up new subscribers and amend their account details. This controller also handles any unsubscribe requests.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/language/english/en_admin_lang.php</code>: This provides language support for the application.</li></ul></div><p>The file structure of the preceding six files is as follows:</p><div class="informalexample"><pre class="programlisting">application/
├── controllers/
│   ├── signup.php
├── models/
│   ├── signup_model.php
├── views/signup/
│   ├── signup.php
│   ├── settings.php
├── views/nav/
│   ├── top_nav.php
├── language/english/
│   ├── en_admin_lang.php</pre></div></div></div>
<div class="section" title="Creating the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec51"/>Creating the database</h1></div></div></div><p>Okay, you should have<a id="id362" class="indexterm"/> already set up CodeIgniter and Bootstrap as described in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>. If not, then you should know that the code in this chapter is specifically<a id="id363" class="indexterm"/> built with the setup from <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>, in mind. However it's not the end of the world if you haven't; the code can easily be applied to other situations.</p><p>First, we'll build the database. Copy the following MySQL code to your database:</p><div class="informalexample"><pre class="programlisting">CREATE DATABASE `signupdb`;
USE DATABASE `signupdb`;

CREATE TABLE `signups` (
  `signup_id` int(11) NOT NULL AUTO_INCREMENT,
  `signup_email` varchar(255) NOT NULL,
  `signup_opt1` int(1) NOT NULL,
  `signup_opt2` int(1) NOT NULL,
  `signup_active` int(1) NOT NULL,
  `signup_created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`signup_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</pre></div><p>Right, let's take a look at each item in the table and see what it means:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th colspan="2" style="text-align: center" valign="bottom">
<p>Table: signups</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Element</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Description</strong></span>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">signup_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id364" class="indexterm"/> primary key.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">signup_email</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This shows<a id="id365" class="indexterm"/> you the users' e-mail addresses.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">signup_opt1</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This stores <a id="id366" class="indexterm"/>the users option for option 1 in the <code class="literal">views/signup/signup.php</code> file.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">signup_opt2</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This stores the<a id="id367" class="indexterm"/> users option for option 2 in the <code class="literal">views/signup/signup.php</code> file.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">signup_active</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is a sort of soft<a id="id368" class="indexterm"/> delete. It's not currently supported in the application in this chapter, but is there should you wish to use it.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">signup_created_at</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is a MySQL<a id="id369" class="indexterm"/> timestamp for the date on which the row was created in the table.</p>
</td></tr></tbody></table></div><p>We'll also need to make amends to the <code class="literal">config/database.php</code> file, namely, setting the database access details, username password, and so on:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">config/database.php</code> file and find the following lines:<div class="informalexample"><pre class="programlisting">$db['default']['hostname'] = 'localhost';
$db['default']['username'] = 'your username';
$db['default']['password'] = 'your password';
$db['default']['database'] = 'signupdb';</pre></div></li><li class="listitem">Edit the<a id="id370" class="indexterm"/> values in the preceding lines, ensuring you substitute these values with ones more specific to your setup and situation—so enter your username, password, and so on.</li></ol></div></div>
<div class="section" title="Adjusting the routes.php file"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec52"/>Adjusting the routes.php file</h1></div></div></div><p>We want to<a id="id371" class="indexterm"/> redirect the user to the <code class="literal">signup</code> controller rather than the default CodeIgniter <code class="literal">welcome</code> controller. To do this, we will need to amend<a id="id372" class="indexterm"/> the default controller setting in the <code class="literal">routes.php</code> file.</p><p>Open the <code class="literal">config/routes.php</code> file to edit and find the following lines (near the bottom of the file):</p><div class="informalexample"><pre class="programlisting">$route['default_controller'] = "welcome";
$route['404_override'] = '';</pre></div><p>First, we need to change the default controller. Initially, in a CodeIgniter application the default controller is set to <code class="literal">welcome</code>. However, we don't need this, instead we want the default controller to be <code class="literal">signup</code>. So, find the following line:</p><div class="informalexample"><pre class="programlisting">$route['default_controller'] = "welcome";</pre></div><p>Replace the preceding line with the following:</p><div class="informalexample"><pre class="programlisting">$route['default_controller'] = "signup";
$route['404_override'] = '';</pre></div></div>
<div class="section" title="Creating the model"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec53"/>Creating the model</h1></div></div></div><p>There is only one model in this project—<code class="literal">signup_model.php</code> that contains functions that are specific to adding a<a id="id373" class="indexterm"/> subscriber to the database, amending their settings and processing the removal of a subscriber should they unsubscribe.</p><p>This is our one and<a id="id374" class="indexterm"/> only model for this project. Let's briefly go over each function in it to give us a general idea of what it does, and then we will go into more details of the code.</p><p>There are four main functions in this model, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">add()</code>: This accepts one argument: the <code class="literal">$data</code> array sent by the <code class="literal">signup</code> controller's <code class="literal">index()</code> function<a id="id375" class="indexterm"/> when a user successfully submits the form in <code class="literal">views/signup/signup.php</code>. The <code class="literal">add()</code> function takes the array and using the <code class="literal">$this-&gt;db-&gt;insert()</code>CodeIgniter Active Record function, it inserts the user's signup data in the <code class="literal">signups</code> table.</li><li class="listitem" style="list-style-type: disc"><code class="literal">edit()</code>: This accepts one <a id="id376" class="indexterm"/>argument: the <code class="literal">$data</code> array sent by the <code class="literal">signup</code> controller's <code class="literal">settings()</code> function. This function is called only if the user is editing their settings rather than unsubscribing. The <code class="literal">edit()</code> function will update a user's profile.</li><li class="listitem" style="list-style-type: disc"><code class="literal">delete()</code>: This accepts <a id="id377" class="indexterm"/>one argument: the <code class="literal">$data</code> array sent by the <code class="literal">signup</code> controller's <code class="literal">settings()</code> function. This function is called only if the user is unsubscribing rather than editing their settings. The function will return <code class="literal">true</code> if the delete was successful and <code class="literal">false</code> if not.</li><li class="listitem" style="list-style-type: disc"><code class="literal">get_settings()</code>: This accepts<a id="id378" class="indexterm"/> one argument: the <code class="literal">$data</code> array sent by the <code class="literal">signup</code> controller's <code class="literal">settings()</code> function. The settings form needs to be populated with the correct data for the required e-mail address, and <code class="literal">get_settings()</code> supplies this information.</li></ul></div><p>That's a quick overview, so let's create<a id="id379" class="indexterm"/> the model and discuss how it functions.</p><p>Create the <code class="literal">/path/to/codeigniter/application/models/signup_model.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed'); 

class Signup_model extends CI_Model { 
  function __construct() { 
    parent::__construct(); 
  } </pre></div><p>The following code snippet adds a subscriber to the database using the <code class="literal">$this-&gt;db-&gt;insert()</code> CodeIgniter Active Record function. This function is called by the <code class="literal">signup</code> controller's <code class="literal">index()</code> function. It accepts an array called <code class="literal">$data</code>; this array is the validated form input submitted by the user in the <code class="literal">views/signup/signup.php</code> form. On successfully writing to the database, it will return <code class="literal">true</code>; it will return <code class="literal">false</code> if an error occurs:</p><div class="informalexample"><pre class="programlisting">  public function add($data) { 
    if ($this-&gt;db-&gt;insert('signups', $data)) {
      return true;
    } else {
      return false;
    }
  } </pre></div><p>The following code snippet performs an update procedure on the <code class="literal">signups</code> database table using the <code class="literal">$this-&gt;db-&gt;update()</code> CodeIgniter Active Record function. It accepts an array called <code class="literal">$data</code>. This array is the <a id="id380" class="indexterm"/>validated form input submitted by the user in the <code class="literal">views/signup/settings.php</code> form. On a successful update, it will return <code class="literal">true</code>; it will return <code class="literal">false</code> if an error occurs:</p><div class="informalexample"><pre class="programlisting">public function edit($data) {
  $this-&gt;db-&gt;where('signup_email', $data['signup_email']);
  if ($this-&gt;db-&gt;update('signups', $data)) {
    return true;
  } else {
    return false;
  }
}</pre></div><p>The following code snippet performs a delete procedure on the <code class="literal">signups</code> database table using the <code class="literal">$this-&gt;db-&gt;delete()</code> CodeIgniter Active Record function. It accepts an array called <code class="literal">$data</code>. This array is the validated form input submitted by the user in the <code class="literal">views/signup/settings.php</code> form and contains the subscribers' e-mail addresses only. On a successful deletion, it will return <code class="literal">true</code>; it will return <code class="literal">false</code> if an error occurs:</p><div class="informalexample"><pre class="programlisting">public function delete($data) {
  $this-&gt;db-&gt;where('signup_email', $data['signup_email']);
  if ($this-&gt;db-&gt;delete('signups')) {
    return true;
  } else {
    return false;
  }
}</pre></div><p>The following code snippet performs a select procedure on the <code class="literal">signups</code> database table using the <code class="literal">$this-&gt;db-&gt;get()</code> CodeIgniter Active Record function. It accepts a variable called <code class="literal">$email</code>. This is the formatted e-mail address of the subscriber. This function returns a subscriber's database record. It is required by the <code class="literal">signup</code> controller's <code class="literal">settings()</code> function in order to pre-populate form items. On a successful selection, it will return a database result object; it will return <code class="literal">false</code> if an error occurs:</p><div class="informalexample"><pre class="programlisting">  public function get_settings($email) {
    $this-&gt;db-&gt;where('signup_email', $email);
    $query = $this-&gt;db-&gt;get('signups');
    if ($query) {
      return $query;
    } else {
      return false;
    }
  }
}</pre></div><p>As you can see, the <a id="id381" class="indexterm"/>model is fairly straightforward and concise, so let's now take a look at the views.</p></div>
<div class="section" title="Creating the views"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec54"/>Creating the views</h1></div></div></div><p>There are three <a id="id382" class="indexterm"/>views in this project, and these are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/signup/signup.php</code>: This displays a form to the user, allowing<a id="id383" class="indexterm"/> them to sign up their e-mail address to the project.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/signup/settings.php</code>: This displays a form to the <a id="id384" class="indexterm"/>user, allowing them to amend their preferences and also unsubscribe should they wish.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/nav/top_nav.php</code>: This displays the top-level menu. In<a id="id385" class="indexterm"/> this project, this file is very simple, and as such it just contains a link to return to the <code class="literal">index()</code> function.</li></ul></div><p>This is a good overview of the views. Now let's go over each one, build the code, and discuss how they function:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">/path/to/codeigniter/application/views/signup/signup.php</code> file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;div class="row row-offcanvas row-offcanvas-right"&gt;
  &lt;div class="col-xs-12 col-sm-9"&gt;
    &lt;div class="row"&gt;
      &lt;?php echo validation_errors(); ?&gt; 
      &lt;?php echo form_open('/signup') ; ?&gt;
      &lt;?php echo form_input($signup_email); ?&gt;&lt;br /&gt; 
      &lt;?php echo form_checkbox($signup_opt1) . $this-&gt;lang-&gt;line('signup_opt1'); ?&gt;&lt;br /&gt; 
      &lt;?php echo form_checkbox($signup_opt2) . $this-&gt;lang-&gt;line('signup_opt2'); ?&gt;&lt;br /&gt;
      &lt;?php echo form_submit('', $this-&gt;lang-&gt;line('common_form_elements_go'), 'class="btn btn-success"') ; ?&gt;&lt;br /&gt; 
      &lt;?php echo form_close() ; ?&gt; 
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div><p>The preceding HTML contains the form to enable a user to sign up to the application. The form also displays any validation errors.</p></li><li class="listitem">Create the <code class="literal">/path/to/codeigniter/application/views/signup/settings.php</code> file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;div class="row row-offcanvas row-offcanvas-right"&gt;
  &lt;div class="col-xs-12 col-sm-9"&gt;
    &lt;div class="row"&gt;
      &lt;?php echo validation_errors(); ?&gt; 
      &lt;?php echo form_open('/signup/settings') ; ?&gt;
      &lt;?php echo form_input($signup_email); ?&gt;&lt;br /&gt; 
      &lt;?php echo form_checkbox($signup_opt1) . $this-&gt;lang-&gt;line('signup_opt1'); ?&gt;&lt;br /&gt; 
      &lt;?php echo form_checkbox($signup_opt2) . $this-&gt;lang-&gt;line('signup_opt2'); ?&gt;&lt;br /&gt;
      &lt;?php echo form_checkbox($signup_unsub) . $this-&gt;lang-&gt;line('signup_unsub'); ?&gt;&lt;br /&gt;
      &lt;?php echo form_submit('', $this-&gt;lang-&gt;line('common_form_elements_go'), 'class="btn btn-success"') ; ?&gt;&lt;br /&gt; 
      &lt;?php echo form_close() ; ?&gt; 
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div><p>The preceding <a id="id386" class="indexterm"/>HTML contains the form to enable the subscriber to edit their settings or unsubscribe completely. The data for the form is fetched by the <code class="literal">get_settings()</code> function of <code class="literal">signup_model</code>.</p></li><li class="listitem">Create the <code class="literal">/path/to/codeigniter/application/views/nav/top_nav.php</code> file and add the following code to it:<div class="informalexample"><pre class="programlisting">&lt;!-- Fixed navbar --&gt;
&lt;div class="navbar navbar-inverse navbar-fixed-top" role="navigation"&gt;
  &lt;div class="container"&gt;
    &lt;div class="navbar-header"&gt;
      &lt;button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"&gt;
        &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
      &lt;/button&gt;
      &lt;a class="navbar-brand" href="&lt;?php echo base_url() ; ?&gt;"&gt;&lt;?php echo $this-&gt;lang-&gt;line('system_system_name'); ?&gt;&lt;/a&gt;
    &lt;/div&gt;
    &lt;div class="navbar-collapse collapse"&gt;
      &lt;ul class="nav navbar-nav"&gt;
        &lt;li class="active"&gt;&lt;?php echo anchor('signup', $this-&gt;lang-&gt;line('nav_home')) ; ?&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/div&gt;&lt;!--/.nav-collapse --&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;div class="container theme-showcase" role="main"&gt;</pre></div></li></ol></div></div>
<div class="section" title="Creating the controllers"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec55"/>Creating the controllers</h1></div></div></div><p>We're going to create only one controller in<a id="id387" class="indexterm"/> this project, which is <code class="literal">/path/to/codeigniter/application/controllers/signup.php</code>.</p><p>Let's go over this <a id="id388" class="indexterm"/>controller now, look at the code, and discuss how it functions.</p><p>Create the <code class="literal">/path/to/codeigniter/application/controllers/signup.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed'); 

class Signup extends MY_Controller {
  function __construct() { 
    parent::__construct(); 
    $this-&gt;load-&gt;helper('form'); 
    $this-&gt;load-&gt;helper('url'); 
    $this-&gt;load-&gt;model('Signup_model');
    $this-&gt;load-&gt;library('form_validation');
    $this-&gt;form_validation-&gt;set_error_delimiters('&lt;div class="alert alert-danger"&gt;', '&lt;/div&gt;');
  } 

  public function index() {</pre></div><p>This function creates<a id="id389" class="indexterm"/> a subscriber in the database, so the first thing we need to do is set the form validation rules:</p><div class="informalexample"><pre class="programlisting">// Set validation rules 
$this-&gt;form_validation-&gt;set_rules('signup_email', $this-&gt;lang-&gt;line('signup_emailemail'), 'required|valid_email|min_length[1]|max_length[125]|is_unique[signups.signup_email]');
$this-&gt;form_validation-&gt;set_rules('signup_emailopt1', $this-&gt;lang-&gt;line('signup_emailopt1'), 'min_length[1]|max_length[1]'); 
$this-&gt;form_validation-&gt;set_rules('signup_emailopt2', $this-&gt;lang-&gt;line('signup_emailopt2'), 'min_length[1]|max_length[1]'); 

// Begin validation 
if ($this-&gt;form_validation-&gt;run() == FALSE) { </pre></div><p>If the form was submitted with errors, or if this is the first load instance of the function, then we will arrive at the following code. We define the following settings for the form elements in the <code class="literal">views/signup/signup.php</code> file:</p><div class="informalexample"><pre class="programlisting">  $data['signup_email'] = array('name' =&gt; 'signup_email', 'class' =&gt; 'form-control', 'id' =&gt; 'signup_email', 'value' =&gt; set_value('signup_email', ''), 'maxlength' =&gt; '100', 'size' =&gt; '35', 'placeholder' =&gt; $this-&gt;lang-&gt;line('signup_email'));
  $data['signup_opt1'] = array('name' =&gt; 'signup_opt1', 'id' =&gt; 'signup_opt1', 'value' =&gt; '1', 'checked' =&gt; FALSE, 'style' =&gt; 'margin:10px');
  $data['signup_opt2'] = array('name' =&gt; 'signup_opt2', 'id' =&gt; 'signup_opt2', 'value' =&gt; '1', 'checked' =&gt; FALSE, 'style' =&gt; 'margin:10px');

  $this-&gt;load-&gt;view('common/header');
  $this-&gt;load-&gt;view('nav/top_nav', $data);
  $this-&gt;load-&gt;view('signup/signup', $data); 
  $this-&gt;load-&gt;view('common/footer');
} else { </pre></div><p>However, if there were no errors with the validation, we will arrive at the following code. We package the data from the form elements into an array called <code class="literal">$data</code> and send it to the <code class="literal">add()</code> function of <code class="literal">signup_model</code>. This will perform the task of writing the subscriber to the database:</p><div class="informalexample"><pre class="programlisting">    $data = array('signup_email' =&gt; $this-&gt;input-&gt;post('signup_email'),
                  'signup_opt1' =&gt; $this-&gt;input-&gt;post('signup_opt1'),
                  'signup_opt2' =&gt; $this-&gt;input-&gt;post('signup_opt2'),
                  'signup_active' =&gt; 1);

    if ($this-&gt;Signup_model-&gt;add($data)) {
      echo $this-&gt;lang-&gt;line('signup_success');
    } else {
      echo $this-&gt;lang-&gt;line('signup_error');
    }
  }
}</pre></div><p>The following function is responsible for updating a subscriber's settings, or handling an unsubscribe request. Before it can do either of these things, it needs the users' e-mail address. The e-mail address is supplied when a subscriber clicks on a link (such as an unsubscribe link in an e-mail):</p><div class="informalexample"><pre class="programlisting">public function settings() { 
    // Set validation rules 
    $this-&gt;form_validation-&gt;set_rules('signup_email', $this-&gt;lang-&gt;line('signup_email'), 'required|valid_email|min_length[1]|max_length[125]'); 
    $this-&gt;form_validation-&gt;set_rules('signup_opt1', $this-&gt;lang-&gt;line('signup_opt1'), 'min_length[1]|max_length[1]'); 
    $this-&gt;form_validation-&gt;set_rules('signup_opt2', $this-&gt;lang-&gt;line('signup_opt2'), 'min_length[1]|max_length[1]');
    $this-&gt;form_validation-&gt;set_rules('signup_unsub', $this-&gt;lang-&gt;line('signup_unsub'), 'min_length[1]|max_length[1]'); 

    // Begin validation 
    if ($this-&gt;form_validation-&gt;run() == FALSE) { </pre></div><p>If validation was <a id="id390" class="indexterm"/>unsuccessful, or the form is being accessed for the first time, then we arrive at the following code. The first thing we try to do is get the details of the subscriber so that we can display the correct settings in the form. We pass the third and fourth parameters of the <code class="literal">uri</code> segment to the <code class="literal">get_settings()</code> function of <code class="literal">signup_model</code>. We join them by writing the <code class="literal">@</code> symbol between the two <code class="literal">uri</code> segments, remembering that we cannot accept <code class="literal">@</code> symbols in the URL for security reasons. This can be done as follows:</p><div class="informalexample"><pre class="programlisting">$query = $this-&gt;Signup_model-&gt;get_settings($this-&gt;uri-&gt;segment(3) . '@' . $this-&gt;uri-&gt;segment(4));
if ($query-&gt;num_rows() == 1) {
  foreach ($query-&gt;result() as $row) {
    $signup_opt1 = $row-&gt;signup_opt1;
    $signup_opt2 = $row-&gt;signup_opt2;
  }
} else {
  redirect('signup');
}</pre></div><p>The <code class="literal">get_settings()</code> function of <code class="literal">signup_model</code> will look in the <code class="literal">signups</code> table and return a result object.</p><p>First, we test to see<a id="id391" class="indexterm"/> whether the number of records found is exactly <code class="literal">1</code>. Anything else and there's a problem: either more than one record exists in the database belonging to the same e-mail address, or no e-mail address was found at all, in which case we redirect the users to the <code class="literal">index()</code> function.</p><p>Anyway, if exactly one record was found, we then loop over the result object with a <code class="literal">foreach</code> loop and put the values that we will use to populate the form options into local variables: <code class="literal">$signup_opt1</code> and <code class="literal">$signup_opt2</code>.</p><p>We then define the settings for our form elements, passing <code class="literal">$signup_email</code>, <code class="literal">$signup_opt1</code> and <code class="literal">$signup_opt2</code> as well as settings for the unsubscribe checkbox to them:</p><div class="informalexample"><pre class="programlisting">$data['signup_email'] = array('name' =&gt; 'signup_email', 'class' =&gt; 'form-control', 'id' =&gt; 'signup_email', 'value' =&gt; set_value('signup_email', $this-&gt;uri-&gt;segment(3) . '@' . $this-&gt;uri-&gt;segment(4)), 'maxlength' =&gt; '100', 'size' =&gt; '35', 'placeholder' =&gt; $this-&gt;lang-&gt;line('signup_email'));
$data['signup_opt1'] = array('name' =&gt; 'signup_opt1', 'id' =&gt; 'signup_opt1', 'value' =&gt; '1', 'checked' =&gt; ($signup_opt1 == 1) ? TRUE : FALSE, 'style' =&gt; 'margin:10px');
$data['signup_opt2'] = array('name' =&gt; 'signup_opt2', 'id' =&gt; 'signup_opt2', 'value' =&gt; '1', 'checked' =&gt; ($signup_opt2 == 1) ? TRUE : FALSE, 'style' =&gt; 'margin:10px');
$data['signup_unsub'] = array('name' =&gt; 'signup_unsub', 'id' =&gt; 'signup_unsub', 'value' =&gt; '1', 'checked' =&gt; FALSE, 'style' =&gt; 'margin:10px');</pre></div><p>These form element settings are then sent to the <code class="literal">views/signup/settings.php</code> file:</p><div class="informalexample"><pre class="programlisting">  $this-&gt;load-&gt;view('common/header');
  $this-&gt;load-&gt;view('nav/top_nav', $data);
  $this-&gt;load-&gt;view('signup/settings', $data); 
  $this-&gt;load-&gt;view('common/footer');
} else {</pre></div><p>If the form is submitted without errors, then we arrive at the following code. The first thing we do is work out whether the user has indicated that they wish to unsubscribe. This is done by looking for the value of the <code class="literal">signup_unsub</code> form checkbox. If this has been checked by the user, then there is no need to update their settings. Instead, we delete the user by calling the <code class="literal">delete()</code> function of <code class="literal">signup_model</code>:</p><div class="informalexample"><pre class="programlisting">if ($this-&gt;input-&gt;post('signup_unsub') == 1) {
  $data = array('signup_email' =&gt; $this-&gt;input-&gt;post('signup_email'));
  if ($this-&gt;Signup_model-&gt;delete($data)) {
    echo $this-&gt;lang-&gt;line('unsub_success');
  } else {
    echo $this-&gt;lang-&gt;line('unsub_error');
  }
} else {</pre></div><p>However, if they haven't indicated that they want to unsubscribe by checking the form checkbox named <code class="literal">signup_unsub</code>, then we would want to update their details. We package up the <a id="id392" class="indexterm"/>values of the form inputs into an array called <code class="literal">$data</code> and make it ready to write to the database using the <code class="literal">edit()</code> function of <code class="literal">signup_model</code>:</p><div class="informalexample"><pre class="programlisting">        $data = array('signup_email' =&gt; $this-&gt;input-&gt;post('signup_email'),
                      'signup_opt1' =&gt; $this-&gt;input-&gt;post('signup_opt1'),
                      'signup_opt2' =&gt; $this-&gt;input-&gt;post('signup_opt2')); 
        if ($this-&gt;Signup_model-&gt;edit($data)) {
          echo $this-&gt;lang-&gt;line('setting_success');
        } else {
          echo $this-&gt;lang-&gt;line('setting_error');
        }
      }
    }
  }
}</pre></div><p>So, that was the <code class="literal">signup</code> controller. As you saw, it's a small, concise script that I'm sure you will be able to amend and extend as you wish.</p></div>
<div class="section" title="Creating the language file"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec56"/>Creating the language file</h1></div></div></div><p>As with all the<a id="id393" class="indexterm"/> projects in this book, we're making use of the<a id="id394" class="indexterm"/> language file to serve text to users. This way, you can enable multiple region/multiple language support. Let's create the language file.</p><p>Create the <code class="literal">/path/to/codeigniter/application/language/english/en_admin_lang.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

s// General
$lang['system_system_name'] = "Signup";

// nav
$lang['nav_home'] = "Home";

// index()
$lang['singup_instruction'] = "";
$lang['signup_email'] = "Your Email";
$lang['signup_opt1'] = "Option 1";
$lang['signup_opt2'] = "Option 2";
$lang['signup_unsub'] = "Unsubscribe";
$lang['signup_success'] = "You have signed up";
$lang['signup_error'] = "There was an error in signing up";
$lang['setting_success'] = "Your settings have been amended";
$lang['setting_error'] = "There was an error in amending your settings";
$lang['unsub_success'] = "You have been unsubscribed";
$lang['unsub_error'] = "There was an error in unsubscribing you";</pre></div></div>
<div class="section" title="Putting it all together"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec57"/>Putting it all together</h1></div></div></div><p>Okay, here are a few<a id="id395" class="indexterm"/> examples that will help put everything together.</p><div class="section" title="User subscribes"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec50"/>User subscribes</h2></div></div></div><p>The sequence of events<a id="id396" class="indexterm"/> taking place when a user subscribes are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The user visits the application and CodeIgniter routes them to the <code class="literal">signup</code> controller.</li><li class="listitem">The <code class="literal">index()</code> function<a id="id397" class="indexterm"/> in the <code class="literal">signup</code> controller displays the <code class="literal">views/signup/signup.php</code> view file.</li><li class="listitem">The user views the form in the browser, enters their e-mail address, and submits the form with no validation errors.</li><li class="listitem">The <code class="literal">index()</code> function packages the users' input into an array called <code class="literal">$data</code> and passes it to the <code class="literal">add()</code> function of <code class="literal">Signup_model</code>.</li><li class="listitem">The <code class="literal">add()</code> function <a id="id398" class="indexterm"/>performs an Active Record insert to write the users' subscription to the <code class="literal">signups</code> database table.</li></ol></div></div><div class="section" title="User updates their settings"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec51"/>User updates their settings</h2></div></div></div><p>The following events take place when a user wants to update settings:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The user clicks <a id="id399" class="indexterm"/>on a link in an e-mail they have been sent.</li><li class="listitem">The URL routes them to the <code class="literal">signup</code> controller's <code class="literal">settings()</code> function.</li><li class="listitem">The <code class="literal">settings()</code> function<a id="id400" class="indexterm"/> takes the third and fourth parameters of the URL, joins the third and fourth segments with an <code class="literal">@</code> character, and passes this "rebuilt" e-mail address to the <code class="literal">signup</code> controller's <code class="literal">get_settings()</code> function.</li><li class="listitem">The <code class="literal">get_settings()</code> function<a id="id401" class="indexterm"/> looks in the database for a matching record, and if exactly one record is found, it returns it as a database result object to the <code class="literal">settings()</code> function.</li><li class="listitem">Now that the<a id="id402" class="indexterm"/> <code class="literal">settings()</code> function has a matching record, it takes various items from the result object and assigns them to local variables.</li><li class="listitem">These are then used to prepopulate the form items in the <code class="literal">views/signup/settings.php</code> file.</li><li class="listitem">The user sees the form displayed with whichever settings the records are filled in.</li><li class="listitem">The user wishes to check <span class="strong"><strong>Option 1</strong></span> but leave <span class="strong"><strong>Option 2</strong></span> unchecked. The user clicks on the checkbox of <span class="strong"><strong>Option 1</strong></span>.</li><li class="listitem">The user submits the form, the form is submitted to the <code class="literal">signup</code> controller's <code class="literal">settings()</code> function, and is validated successfully with no errors.</li><li class="listitem">As there are no errors, the second part of the validation test (the rest) is run.</li><li class="listitem">The value of the form element <code class="literal">signup_unsub</code> is checked. As the user is not unsubscribing, this will not equal <code class="literal">1</code>.</li><li class="listitem">As <code class="literal">signup_unsub</code> does not equal <code class="literal">1</code>, the <code class="literal">edit()</code> function<a id="id403" class="indexterm"/> of <code class="literal">signup_model</code> is passed an array called <code class="literal">$data</code>. This <code class="literal">$data</code> array contains the contents of the posted form data.</li><li class="listitem">The <code class="literal">edit()</code> function then performs a CodeIgniter Active Record update operation on the <code class="literal">$data</code> array.</li></ol></div></div><div class="section" title="User unsubscribes"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec52"/>User unsubscribes</h2></div></div></div><p>When a user wants to<a id="id404" class="indexterm"/> unsubscribe, the following events take place:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The user clicks on a link in an e-mail they have been sent.</li><li class="listitem">The URL routes them to the <code class="literal">signup</code> controller's <code class="literal">settings()</code> function.</li><li class="listitem">The <code class="literal">settings()</code> function takes the third and fourth parameters of the URL, joins the third and fourth segments with an <code class="literal">@</code> character, and passes this "rebuilt" e-mail address to the <code class="literal">signup</code> controller's <code class="literal">get_settings()</code> function.</li><li class="listitem">The <code class="literal">get_settings()</code> function<a id="id405" class="indexterm"/> looks in the database for a matching record, and if exactly one record is found, it returns it as a database result object to the <code class="literal">settings()</code> function.</li><li class="listitem">Now that the <code class="literal">settings()</code> function has a matching record, it takes various items from the result object and assigns them to local variables.</li><li class="listitem">These are then used to pre-populate the form items in the <code class="literal">views/signup/settings.php</code> file.</li><li class="listitem">The user sees the form displayed with whichever settings the records are filled in.</li><li class="listitem">The user wishes to unsubscribe from the service.</li><li class="listitem">The user checks Unsubscribe and submits the form. The form is submitted to the <code class="literal">signup</code> controller's <code class="literal">settings()</code> function and is validated successfully with no errors.</li><li class="listitem">As there are<a id="id406" class="indexterm"/> no errors, the second part of the validation test (the rest) is run.</li><li class="listitem">The value of the form element <code class="literal">signup_unsub</code> is checked. This equals <code class="literal">1</code> as the user is unsubscribing.</li><li class="listitem">As <code class="literal">signup_unsub</code> equals <code class="literal">1</code>, the <code class="literal">delete()</code> function of <code class="literal">signup_model</code> is passed an array called <code class="literal">$data</code>. This <code class="literal">$data</code> array contains the subscribers' e-mail address.</li><li class="listitem">The <code class="literal">delete()</code> function<a id="id407" class="indexterm"/> then performs a CodeIgniter Active Record delete operation on the <code class="literal">$data</code> array.</li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec58"/>Summary</h1></div></div></div><p>In this project, you'll have the foundations of a useful signup application. As always, there are a few things you can do to expand upon the functionality, which do are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Add more options that a user might apply to their subscription</li><li class="listitem" style="list-style-type: disc">Add HTML/plaintext settings (and only send them what they've asked for)</li><li class="listitem" style="list-style-type: disc">Add a signup sunset clause: allow someone to sign up for a certain time and once that time is arrived at, stop sending them newsletters.</li></ul></div></div></body></html>