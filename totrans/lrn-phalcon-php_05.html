<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;The API Module"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. The API Module</h1></div></div></div><p>An <span class="strong"><strong>Application Programming Interface</strong></span> (<span class="strong"><strong>API</strong></span>) is <a id="id301" class="indexterm"/>the most common way of exposing services to third parties, and lately, most of the software out there is driven by APIs. Why? Because, by having an API for your application, not only is it easy to implement a fully functional HTML + JS frontend, but you can also use it if you develop a mobile application, for example. In this chapter, we will implement most of the functionalities needed for our project, covering topics such as these:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using APIs—recommended practices</li><li class="listitem" style="list-style-type: disc">Enabling SSL on our local machine</li><li class="listitem" style="list-style-type: disc">Creating the module structure</li><li class="listitem" style="list-style-type: disc">Writing a fully functional REST module with Phalcon PHP</li><li class="listitem" style="list-style-type: disc">Securing an API</li><li class="listitem" style="list-style-type: disc">Documenting the API</li></ul></div><div class="section" title="Using APIs – recommended practices"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec34"/>Using APIs – recommended practices</h1></div></div></div><p>If you are completely new to <a id="id302" class="indexterm"/>APIs, I recommend that you read at least the basics<a id="id303" class="indexterm"/> about developing an API. In the simplest way, an API response can be created with plain PHP, like this:</p><div class="informalexample"><pre class="programlisting">$data = [
  'name' =&gt; 'John Doe',
  'age' =&gt; 50
];

echo json_encode($data);</pre></div><p>Next, we are going to talk about some general rules that you should follow when developing an API, which are discussed as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Use plural nouns instead of verbs, use concrete names, and make use of HTTP verbs (<code class="literal">GET</code>, <code class="literal">POST</code>, <code class="literal">PUT</code>, and <code class="literal">DELETE</code>) to operate on them:<p>This format is bad:</p><div class="informalexample"><pre class="programlisting">GET /getAllArticles
GET /getArticle
POST /newArticle</pre></div><p>This format is good:</p><div class="informalexample"><pre class="programlisting">GET /articles (Retrieve all articles)
GET /article/12 (Retrieve article with id 12)
POST /article (Create a new article)
PUT /article/12 (Update article with id 12)
DELETE /article/12 (Delete article with id 12)</pre></div></li><li class="listitem" style="list-style-type: disc">Use<a id="id304" class="indexterm"/> verbs when the response does not involve <a id="id305" class="indexterm"/>a resource:<div class="informalexample"><pre class="programlisting">GET /search?title=Learning+Phalcon</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note14"/>Note</h3><p>Always <a id="id306" class="indexterm"/>version your API. In this way, when you make changes to your application, you ensure backward compatibility. Some examples are given here:</p><div class="informalexample"><pre class="programlisting">
https://learning-phalcon.localhost/api/v1
https://api.learning-phalcon.localhost/v1/
</pre></div></div></div></li><li class="listitem" style="list-style-type: disc">Always use a secure connection (HTTPS), as you can see in the preceding information box.</li><li class="listitem" style="list-style-type: disc">Allow data filtering and sorting:<div class="informalexample"><pre class="programlisting">GET /articles?author=John
GET /articles?author=John&amp;sort=created_at</pre></div></li><li class="listitem" style="list-style-type: disc">Use <code class="literal">camelCase</code> instead of <code class="literal">snake_case</code>. I know that using snake case it would be easier to read, and I agree with you. But since (I assume that) you are going to represent your data in JSON format, you should use the JavaScript naming conventions. Anyway, this is a recommendation. After many years, I still cannot get used to camel case for these situations. In this book, I will use snake case.</li></ul></div><p>If a business decision does not force you to expose XML format, go with JSON. From my point of view, XML is kind of dead.</p><p>These are just a few general rules. You are going to learn about a few more, later in this chapter.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip19"/>Tip</h3><p>If you don't know much about<a id="id307" class="indexterm"/> APIs, please check out resources such as <a class="ulink" href="https://blog.apigee.com/taglist/restful">https://blog.apigee.com/taglist/restful</a>, <a class="ulink" href="http://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api">http://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api</a>, or <span class="emphasis"><em>Web API design</em></span>, an e-book by Brian Mulloy (38 pages).</p></div></div></div></div>
<div class="section" title="Enabling SSL on our local machine"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec35"/>Enabling SSL on our local machine</h1></div></div></div><p>We will take into<a id="id308" class="indexterm"/> account one of the API rules: always use a secure <a id="id309" class="indexterm"/>connection. Assuming that you are using Nginx, this can be done in four easy steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a directory, <code class="literal">/etc/nginx/ssl</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo mkdir /etc/nginx/ssl</strong></span>
</pre></div></li><li class="listitem">Generate a new certificate using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/nginx/ssl/nginx.key -out /etc/nginx/ssl/nginx.crt</strong></span>
</pre></div><p>At this point you will be asked to provide some information about the new certificate, as shown in the following diagram:</p><div class="mediaobject"><img src="graphics/B03522_05_01.jpg" alt="Enabling SSL on our local machine"/></div></li><li class="listitem">Open the <code class="literal">learning-phalcon.localhost</code> configuration file (<code class="literal">/etc/nginx/sites-available/learning-phalcon.localhost</code>) and enable SSL:<div class="informalexample"><pre class="programlisting">server {
  listen 80;
  <span class="strong"><strong>listen 443 ssl;</strong></span>

<span class="strong"><strong>  ssl_certificate /etc/nginx/ssl/nginx.crt;</strong></span>
<span class="strong"><strong>  ssl_certificate_key /etc/nginx/ssl/nginx.key;</strong></span>

  #....rest of the code
}</pre></div></li><li class="listitem">Then reload the Nginx configuration:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo service nginx reload</strong></span>
</pre></div></li></ol></div><p>Now you can <a id="id310" class="indexterm"/>try to access <code class="literal">https://learning-phalcon.localhost/</code>. In any browser that you are using, you will get a warning saying<a id="id311" class="indexterm"/> that the server certificate is not trusted. This is normal because it has not been signed by any authority. On Chrome, you should click on the <span class="strong"><strong>Advanced</strong></span> link (seen in the following screenshot) and then on the<span class="strong"><strong> Proceed to learning-phalcon.localhost (unsafe</strong></span>) link (shown in the next screenshot). Other browsers will have similar links:</p><div class="mediaobject"><img src="graphics/B03522_05_02.jpg" alt="Enabling SSL on our local machine"/></div><p>After you click on <span class="strong"><strong>Advanced</strong></span>, a new page will open and it should look like the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_05_03.jpg" alt="Enabling SSL on our local machine"/></div><p>Note that <a id="id312" class="indexterm"/>your connection is not actually secured. The<a id="id313" class="indexterm"/> purpose of this was for us to be able to access our project via HTTPS.</p></div>
<div class="section" title="Creating the module structure"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec36"/>Creating the module structure</h1></div></div></div><p>We have already created the basic<a id="id314" class="indexterm"/> structure in the previous chapters. The directory structure should look like this:</p><div class="mediaobject"><img src="graphics/B03522_05_04.jpg" alt="Creating the module structure"/></div><p>This is okay. What <a id="id315" class="indexterm"/>we need to do here is enable the routing and add some methods to <code class="literal">BaseController</code> so that we can move forward. Let's start this process by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">routing.php</code> file from the <code class="literal">api</code> module, delete its content, and put in this code:<div class="informalexample"><pre class="programlisting">&lt;?php
$versions = [
  'v1' =&gt; '/api/v1',
  'v2' =&gt; '/api/v2'
];
$router-&gt;removeExtraSlashes(true);

// Articles group
$articles = new \Phalcon\Mvc\Router\Group(array(
  'module' =&gt; 'api',
  'controller' =&gt; 'articles'
));

$articles-&gt;setPrefix($versions['v1'].'/articles');
$articles-&gt;addGet('', array(
  'module' =&gt; 'api',
  'controller' =&gt; 'articles',
  'action' =&gt; 'list'
));

$router-&gt;mount($articles);</pre></div></li><li class="listitem">Next, we add an array with the available versions of our API, and we tell the router to remove extra slashes. Therefore, a request to <code class="literal">/api/v1/articles</code> will be the same as a request to <code class="literal">/api/v1/articles/</code>.</li><li class="listitem">After that, we make use of the router's capability of grouping and create a new group for the articles.</li><li class="listitem">Finally, we mount the <code class="literal">articles</code> group onto the router.</li></ol></div><p>There are a few <a id="id316" class="indexterm"/>things that we need to fix regarding the routing system. They are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We'll be putting in new content in the global routing file (<code class="literal">config/routing.php</code>), like the following:<div class="informalexample"><pre class="programlisting">&lt;?php

$di['router'] = function () use ($default_module, $modules, $di, $config) {

  $router = new \Phalcon\Mvc\Router(false);
  $router-&gt;clear();

  $moduleRouting = __DIR__.'/../modules/'.ucfirst($default_module).'/Config/routing.php';

  if (file_exists($moduleRouting) &amp;&amp; is_file($moduleRouting)) {
    include $moduleRouting;
  } else {
    $router-&gt;add('#^/(|/)$#', array(
      'module' =&gt; $default_module,
      'controller' =&gt; 'index',
      'action' =&gt; 'index',
    ));

    $router-&gt;add('#^/([a-zA-Z0-9\_]+)[/]{0,1}$#', array(
      'module' =&gt; $default_module,
      'controller' =&gt; 1,
    ));

    $router-&gt;add('#^/{0,1}([a-zA-Z0-9\_]+)/([a-zA-Z0-9\_]+)(/.*)*$#', array(
      'module' =&gt; $default_module,
      'controller' =&gt; 1,
      'action' =&gt; 2,
      'params' =&gt; 3,
    ));
  }

  foreach ($modules as $moduleName =&gt; $module) {
    if ($default_module == $moduleName) {
      continue;
    }

    $moduleRouting = __DIR__.'/../modules/'.ucfirst($moduleName).'/Config/routing.php';

    if (file_exists($moduleRouting) &amp;&amp; is_file($moduleRouting)) {
      include $moduleRouting;
    }
  }

  return $router;
};</pre></div></li><li class="listitem">Delete<a id="id317" class="indexterm"/> the <code class="literal">modules/App/Core/Config/routing.php</code> file—we are not going to have any routes for the core module. This module is more like a library.</li><li class="listitem">Finally, replace the content of <code class="literal">modules/Frontend/Config/routing.php</code> with this content:<div class="informalexample"><pre class="programlisting">&lt;?php
$router-&gt;add('/', array(
  'module' =&gt; 'frontend',
  'controller' =&gt; 'index',
  'action' =&gt; 'index'
));

$router-&gt;add('#^/articles[/]{0,1}$#', array(
  'module' =&gt; 'frontend',
  'controller' =&gt; 'article',
  'action' =&gt; 'list'
));

$router-&gt;add('#^/articles/([a-zA-Z0-9\-]+)[/]{0,1}$#', array(
  'module' =&gt; 'frontend',
  'controller' =&gt; 'article',
  'action' =&gt; 'read',
  'slug' =&gt; 1
));</pre></div></li></ol></div><p>The new router group uses a controller named <code class="literal">Articles</code>, which does not exist. Now, let's continue with further processes:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's <a id="id318" class="indexterm"/>create <code class="literal">ArticlesController.php</code> with the following content:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Api\Controllers;

class ArticlesController extends BaseController {
  public function listAction() {
    $this-&gt;view-&gt;disable();
    echo __METHOD__;
  }
}</pre></div><p>The following screenshot shows the output after running the <code class="literal">ArticlesController.php</code> file:</p><div class="mediaobject"><img src="graphics/B03522_05_05.jpg" alt="Creating the module structure"/></div><p>Now, if you access <code class="literal">https://learning-phalcon.localhost/api/v1/articles</code>, you should see the same content as shown in the preceding screenshot.</p></li><li class="listitem">Next, let's modify our base controller. Open <code class="literal">BaseController.php</code> and append this content:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Api\Controllers;

use \Phalcon\Http\Response;

class BaseController extends \Phalcon\Mvc\Controller {
  protected $statusCode = 200;

  protected $headers    = [
    'Access-Control-Allow-Origin' =&gt; '*',
    'Access-Control-Allow-Headers' =&gt; 'X-Requested-With, content-type, access-control-allow-origin, accept, apikey',
    'Access-Control-Allow-Methods' =&gt; 'GET, PUT, POST, DELETE, OPTIONS','Access-Control-Allow-Credentials' =&gt; 'true'
  ];

  protected $payload = '';

  protected $format = 'json';

  protected function initResponse($status = 200) {
    $this-&gt;statusCode = $status;
    $this-&gt;headers    = array();
    $this-&gt;payload    = '';
  }

  protected function _getContent($payload) {
    return json_encode($payload);
  }

  protected function output() {
    $payload     = $this-&gt;getPayload();
    $status      = $this-&gt;getStatusCode();
    $description = $this-&gt;getHttpCodeDescription($status);
    $headers     = $this-&gt;getHeaders();

    $response = (new Response())
      -&gt;setStatusCode($status, $description)
      -&gt;setContentType('application/json', 'UTF-8')
      -&gt;setContent(json_encode($payload, JSON_PRETTY_PRINT))
    ;

    foreach ($headers as $key =&gt; $value) {
      $response-&gt;setHeader($key, $value);
    }

    $this-&gt;view-&gt;disable();

    return $response;
  }

  protected function render($st_output, $statusCode = 200){
    $this-&gt;initResponse();

    $this-&gt;setStatusCode($statusCode);
    $this-&gt;setPayload($st_output);

    return $this-&gt;output();
  }
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note15"/>Note</h3><p>Note that we have left out some methods. For a complete class, check out the source code for this chapter.</p></div></div></li><li class="listitem">Now, let's<a id="id319" class="indexterm"/> edit the <code class="literal">listAction()</code> function in <code class="literal">ArticlesController.php</code>. The new <code class="literal">listAction()</code>function will look like this:<div class="informalexample"><pre class="programlisting">public function listAction() {
  try {
    $st_output = [
      'method' =&gt; __METHOD__
    ];

    return $this-&gt;render($st_output);
  } catch (\Exception $e) {
    return $this-&gt;render($e-&gt;getMessage(), 500);
  }
}</pre></div></li></ol></div><p>We can now reopen <code class="literal">https://learning-phalcon.localhost/api/v1/articles</code> and check the result. You should see JSON-encoded text, as shown in this screenshot:</p><div class="mediaobject"><img src="graphics/B03522_05_06.jpg" alt="Creating the module structure"/></div><p>We have the basics. Let's move forward with our project and develop its API.</p></div>
<div class="section" title="Writing a fully functional REST module with Phalcon PHP"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec37"/>Writing a fully functional REST module with Phalcon PHP</h1></div></div></div><p>Before starting, I <a id="id320" class="indexterm"/>recommend that you <a id="id321" class="indexterm"/>use a RESTful client that will help you test things faster. Personally, I prefer DHC (it's a Chrome extension), which <a id="id322" class="indexterm"/>can be found at <a class="ulink" href="https://chrome.google.com/webstore/detail/dhc-resthttp-api-client/aejoelaoggembcahagimdiliamlcdmfm?hl=en">https://chrome.google.com/webstore/detail/dhc-resthttp-api-client/aejoelaoggembcahagimdiliamlcdmfm?hl=en</a>.</p><p>We are going to develop the CRUD operations for <code class="literal">Articles</code>, <code class="literal">Categories</code>, <code class="literal">Hashtags</code> and <code class="literal">Users</code>. Let's start with <code class="literal">Articles</code>.</p><div class="section" title="Articles"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec44"/>Articles</h2></div></div></div><p>We have already <a id="id323" class="indexterm"/>created the controller, so by executing a <code class="literal">GET</code> <a id="id324" class="indexterm"/>method on <code class="literal">https://learning-phalcon.localhost/api/v1/articles</code>, you should get a response. Let's implement the article manager for the articles listing so that we can retrieve real data.</p><p>First of all, we will make some changes to the <code class="literal">Article</code> model and overwrite the <code class="literal">toArray()</code> method. Open <code class="literal">modules/Core/Models/Article.php</code> and append the following code:</p><div class="informalexample"><pre class="programlisting">public function getTranslations($arguments = null) {
  return $this-&gt;getRelated('translations', $arguments);
}

public function getCategories($arguments = null) {
  return $this-&gt;getRelated('categories', $arguments);
}

public function getHashtags($arguments = null) {
  return $this-&gt;getRelated('hashtags', $arguments);
}

public function getUser($arguments = null) {
  return $this-&gt;getRelated('user', $arguments);
}

public function toArray($columns = null) {
  $output = parent::toArray($columns);

  $output['article_translations'] = $this-&gt;getTranslations([
    'columns' =&gt; [
      'article_translation_short_title',
      'article_translation_long_title',
      'article_translation_slug',
      'article_translation_description',
      'article_translation_lang'
    ]
  ])-&gt;toArray();

  $output['article_categories'] = $this-&gt;getCategories()-&gt;filter(function($category){
    return $category-&gt;toArray(['id','category_translations']);
  });

  $output['article_hashtags'] = $this-&gt;getHashtags([
    'columns' =&gt; [
      'id',
      'hashtag_name'
    ]
  ])-&gt;filter(function($hashtag){
    return $hashtag-&gt;toArray();
  });

  $output['article_author'] = $this-&gt;getUser([
    'columns' =&gt; [
      'user_first_name',
      'user_last_name',
      'user_email'
    ]
  ])-&gt;toArray();

  return $output;
}</pre></div><p>As you can see, we<a id="id325" class="indexterm"/> append everything<a id="id326" class="indexterm"/> related to the article: translations, information about the author, categories, and hashtags.</p><p>As the categories have translations, we will also overwrite the <code class="literal">toArray()</code> method from the category model. Open <code class="literal">modules/Core/Models/Category.php</code> and add the following code:</p><div class="informalexample"><pre class="programlisting">public function getTranslations($arguments = null) {
  return $this-&gt;getRelated('translations', $arguments);
}

public function toArray($columns = null) {
  $output = parent::toArray($columns);

  $output['category_translations'] = $this-&gt;getTranslations([
    'columns' =&gt; [
      'category_translation_name',
      'category_translation_slug',
      'category_translation_lang'
    ]
  ])-&gt;toArray();

  return $output;
}</pre></div><p>All we have to do now is implement a new <a id="id327" class="indexterm"/>method in the<a id="id328" class="indexterm"/> Article manager. We call that method from the Article controller, and we should have our first call ready.</p><p>Open <code class="literal">modules/Core/Managers/ArticleManager.php</code> and append the following code:</p><div class="informalexample"><pre class="programlisting">public function restGet(array $parameters = null, array $options = null, $page = 1, $limit = 10) {
  $articles = $this-&gt;find($parameters);

  $result = $articles-&gt;filter(function($article){
    return $article-&gt;toArray();
  });

  $paginator = new \Phalcon\Paginator\Adapter\NativeArray([
    'data'  =&gt; $result,
    'limit' =&gt; $limit,
    'page'  =&gt; $page
  ]);

  $data = $paginator-&gt;getPaginate();

  if ($data-&gt;total_items &gt; 0) {
    return $data;
  }

  if (isset($parameters['bind']['id'])) {
    throw new \Exception('Not Found', 404);
  } else {
    throw new \Exception('No Content', 204);
  }
}</pre></div><p>You will see that the method name is <code class="literal">restGet</code>. I like to append the <code class="literal">rest</code> prefix to my methods that are strictly used for APIs. It is a personal preference; you can use any naming conventions for your projects.</p><p>The <code class="literal">restGet()</code> method will throw exceptions. If<a id="id329" class="indexterm"/> we request <a id="id330" class="indexterm"/>a list of articles and the request is successful but we don't have the articles in the database, we use HTTP code 204. In simple words, it means, <span class="emphasis"><em>Your request was okay, but I have no content</em></span>. We use HTTP <code class="literal">404 (not found)</code> if we try to get an article by ID but that article does not exist in our database.</p><p>The final step is to call this method from our controller. Open <code class="literal">modules/Api/Controllers/ArticlesController.php</code> and update the <code class="literal">listAction()</code> method with the following code:</p><div class="informalexample"><pre class="programlisting">public function listAction() {
  try {
    $manager = $this-&gt;getDI()-&gt;get('core_article_manager');
    $page    = $this-&gt;request-&gt;getQuery('p', 'int', 0);

    $st_output = $manager-&gt;restGet([], [], $page);

    return $this-&gt;render($st_output);
  } catch (\Exception $e) {
    return $this-&gt;render([
      'code' =&gt; $e-&gt;getCode(),
      'message' =&gt; $e-&gt;getMessage()
    ], $e-&gt;getCode());
  }
}</pre></div><p>That's it! From your favorite API client, make a <code class="literal">GET</code> request to <code class="literal">http://learning-phalcon.localhost/api/v1/articles</code>, or do it from the command line with CURL:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ curl -i -X GET \</strong></span>
<span class="strong"><strong> 'http://learning-phalcon.localhost/api/v1/articles'</strong></span>
</pre></div><p>If you did everything well, you should be able to see a response similar to what is presented in the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_05_07.jpg" alt="Articles"/></div><p>We now have all of the information<a id="id331" class="indexterm"/> needed to render the most common <a id="id332" class="indexterm"/>data for an article. Consider, for example, if you are going to get this data with jQuery, it is easy:</p><div class="informalexample"><pre class="programlisting">$.get('http://learning-phalcon.localhost/api/v1/articles', function(data){
    // render a list with articles
});</pre></div><p>You can also append the page number in your request like this: <code class="literal">http://learning-phalcon.localhost/api/v1/articles?p=2</code>.</p><p>Let's continue with our CRUD <a id="id333" class="indexterm"/>operations as<a id="id334" class="indexterm"/> follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We will now create a service to retrieve a single article. Open the <code class="literal">routing.php</code> file from the <code class="literal">api</code> module, and append the following route to the <code class="literal">$articles</code> group:<div class="informalexample"><pre class="programlisting">$articles-&gt;addGet('/{id}', array(
  'module' =&gt; 'api',
  'controller' =&gt; 'articles',
  'action' =&gt; 'get'
));</pre></div></li><li class="listitem">Then, we add the <code class="literal">get()</code> method to <code class="literal">ArticlesController.php</code>:<div class="informalexample"><pre class="programlisting">public function getAction($id) {
  try {
    $manager = $this-&gt;getDI()-&gt;get('core_article_manager');

    $st_output = $manager-&gt;restGet([
      'id = :id:',
      'bind' =&gt; [
        'id' =&gt; $id
      ],
    ]);

    return $this-&gt;render($st_output);
  } catch (\Exception $e) {
    return $this-&gt;render([
      'code' =&gt; $e-&gt;getCode(),
      'message' =&gt; $e-&gt;getMessage()
    ], $e-&gt;getCode());
  }
}</pre></div></li></ol></div><p>That's it! You can now request an article that exists in your database, and you should get exactly the same structure. Also, the <code class="literal">items</code> key will contain only this article. In my case, it was the article with the ID equal to <code class="literal">6</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ curl -i -X GET  'http://learning-phalcon.localhost/api/v1/articles/6'</strong></span>
</pre></div><p>If you request a non-existing article, you should get a response similar to what is shown in this screenshot:</p><div class="mediaobject"><img src="graphics/B03522_05_08.jpg" alt="Articles"/></div><p>Next, we are going to implement the<a id="id335" class="indexterm"/> <code class="literal">update</code> method for an article<a id="id336" class="indexterm"/> as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we need to add the routing information. Open <code class="literal">modules/Api/Config/routing.php</code> and append the following code:<div class="informalexample"><pre class="programlisting">$articles-&gt;addPut('/{id}', array(
    'module' =&gt; 'api',
    'controller' =&gt; 'articles',
    'action' =&gt; 'update'
));</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip20"/>Tip</h3><p>Note that we use <code class="literal">PUT</code>, the recommended method for updating resources.</p></div></div></li><li class="listitem">Create a new method named <code class="literal">updateAction()</code> in <code class="literal">ArticlesController.php</code> with the following code:<div class="informalexample"><pre class="programlisting">public function updateAction($id) {
  try {
    $manager = $this-&gt;getDI()-&gt;get('core_article_manager');

    if ($this-&gt;request-&gt;getHeader('CONTENT_TYPE') == 'application/json') {
      $data = $this-&gt;request-&gt;getJsonRawBody(true);
    } else {
      $data = [$this-&gt;request-&gt;getPut()];
    }

    if (count($data[0]) == 0) {
      throw new \Exception('Please provide data', 400);
    }

    $result = $manager-&gt;restUpdate($id, $data);

    return $this-&gt;render($result);
  } catch (\Exception $e) {
    return $this-&gt;render([
      'code' =&gt; $e-&gt;getCode(),
      'message' =&gt; $e-&gt;getMessage()
    ], $e-&gt;getCode());
  }
}</pre></div><p>In <code class="literal">updateAction()</code>, we check whether the content-type header is of the <code class="literal">application/json</code> type. If it is, we call <code class="literal">getJsonRawBody()</code> from the request object. The <code class="literal">true</code> Boolean parameter means that we force decoding as an array. If the data is received via a form, we will make use of the <code class="literal">getPut()</code> method.</p></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Submitting data as a JSON <a id="id337" class="indexterm"/>body is the best approach <a id="id338" class="indexterm"/>from my point of view. Using jQuery, you can do this very simply, as follows:<div class="informalexample"><pre class="programlisting">var data = [{ "article_is_published" : 1 }];
$.ajax({
  type: "PUT",
  url: "/api/v1/articles/6",
  processData: false,
  contentType: 'application/json',
  data: JSON.stringify(data),
  success: function(response) {
    console.log(response);
  }
});</pre></div></li></ol></div><p>Now, let's see how our <code class="literal">restUpdate()</code> method looks. Open <code class="literal">ArticleManager.php</code> and add the following code:</p><div class="informalexample"><pre class="programlisting">public function restUpdate($id, $data) {
  $article = Article::findFirstById((int)$id);

  if (!$article) {
    throw new \Exception('Not found', 404);
  }

  $article-&gt;setArticleIsPublished($data[0]['article_is_published']);

  if (false === $article-&gt;update()) {
    foreach ($article-&gt;getMessages() as $message) {
      throw new \Exception($message-&gt;getMessage(), 500);
    }
  }
  return $article-&gt;toArray();
}</pre></div><p>As you can see, for now, we are going to <a id="id339" class="indexterm"/>update only one <a id="id340" class="indexterm"/>field: <code class="literal">article_is_published</code>. If the article has been successfully updated, you will get the new update article as a response (check out the following screenshot). Now let's test this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ curl -i -X PUT -H "Content-Type:application/json" -d '[{"article_is_pu blished": 0}]' 'http://learning-phalcon.localhost/api/v1/articles/6'</strong></span>
</pre></div><div class="mediaobject"><img src="graphics/B03522_05_09.jpg" alt="Articles"/></div><p>If we don't provide any data, we will get a <code class="literal">400 Bad Request</code> message, like this:</p><div class="mediaobject"><img src="graphics/B03522_05_10.jpg" alt="Articles"/></div><p>Well done! So far, we have exposed a service with three methods: <code class="literal">GET</code> for a list of articles, <code class="literal">GET</code> for a single article, and <code class="literal">PUT</code> for updating an article.</p><p>We will continue developing the <a id="id341" class="indexterm"/>remaining two <a id="id342" class="indexterm"/>methods: <code class="literal">DELETE</code> (for deleting) and <code class="literal">POST</code> (for creation). Let's start with the easier one, which is <code class="literal">DELETE</code>. To do so, let's perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the API routing file and append the following code:<div class="informalexample"><pre class="programlisting">$articles-&gt;addDelete('/{id}', array(
  'module' =&gt; 'api',
  'controller' =&gt; 'articles',
  'action' =&gt; 'delete'
));</pre></div></li><li class="listitem">Next, we create a method named <code class="literal">deleteAction()</code> in <code class="literal">ArticlesController.php</code>:<div class="informalexample"><pre class="programlisting">public function deleteAction($id) {
  try {
    $manager = $this-&gt;getDI()-&gt;get('core_article_manager');

    $st_output = $manager-&gt;restDelete($id);

    return $this-&gt;render($st_output);
  } catch (\Exception $e) {
    return $this-&gt;render([
      'code' =&gt; $e-&gt;getCode(),
      'message' =&gt; $e-&gt;getMessage()
    ], $e-&gt;getCode());
  }
}</pre></div></li><li class="listitem">Finally, create the <code class="literal">restDelete()</code> method in <code class="literal">ArticlesManager.php</code>:<div class="informalexample"><pre class="programlisting">public function restDelete($id) {
  $article = Article::findFirstById((int)$id);

  if (!$article) {
    throw new \Exception('Not found', 404);
  }

  if (false === $article-&gt;delete()) {
    foreach ($article-&gt;getMessages() as $message) {
      throw new \Exception($message-&gt;getMessage(), 500);
    }
  }

  return true;
}</pre></div></li></ol></div><p>Before testing, we must make a small <a id="id343" class="indexterm"/>change to the <code class="literal">Articles.php</code> model <a id="id344" class="indexterm"/>by adding <code class="literal">\Phalcon\Mvc\Model\Relation::ACTION_CASCADE</code> to the foreign key for translations, otherwise, we will get an error message saying <span class="strong"><strong>Record is referenced by model App\\Core\\Models\\ArticleTranslation</strong></span>. This change is needed because of the existing relation between articles and translations. When we delete an article, its translation will be automatically deleted.</p><p>Open <code class="literal">modules/Core/Models/Article.php</code> file and replace the relation for translations with the following code snippet:</p><div class="informalexample"><pre class="programlisting">$this-&gt;hasMany('id', 'App\Core\Models\ArticleTranslation', 'article_translation_article_id', array(
  'alias' =&gt; 'translations',
  'foreignKey' =&gt; array(
    'action' =&gt; \Phalcon\Mvc\Model\Relation::ACTION_CASCADE
  )
));</pre></div><p>We can now test our code, and the result should be similar to what is shown in the following screenshot. If the article was not found, you will receive a 404 error instead of 200:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ curl -i -X DELETE 'http://learning-phalcon.localhost/api/v1/articles/1'</strong></span>
</pre></div><div class="mediaobject"><img src="graphics/B03522_05_11.jpg" alt="Articles"/></div><p>That's it! You can delete articles by simply making a <code class="literal">DELETE</code> request to the right URL.</p><p>Now, let's continue with the <a id="id345" class="indexterm"/>implementation of <a id="id346" class="indexterm"/>
<code class="literal">POST</code> (to create an article). To do so, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">modules/Api/Config/routing.php</code> and add this code:<div class="informalexample"><pre class="programlisting">$articles-&gt;addPost('', array(
  'module' =&gt; 'api',
  'controller' =&gt; 'articles',
  'action' =&gt; 'create'
));</pre></div></li><li class="listitem">Implement a <code class="literal">createAction()</code> method in <code class="literal">ArticlesController.php</code>:<div class="informalexample"><pre class="programlisting">public function createAction() {
  try {
    $manager   = $this-&gt;getDI()-&gt;get('core_article_manager');

    if ($this-&gt;request-&gt;getHeader('CONTENT_TYPE') == 'application/json') {
      $data = $this-&gt;request-&gt;getJsonRawBody(true);
    } else {
      $data = $this-&gt;request-&gt;getPost();
    }

    if (count($data) == 0) {
      throw new \Exception('Please provide data', 400);
    }

    $st_output = $manager-&gt;restCreate($data);

    return $this-&gt;render($st_output);
  } catch (\Exception $e) {
    return $this-&gt;render([
      'code' =&gt; $e-&gt;getCode(),
      'message' =&gt; $e-&gt;getMessage()
    ], $e-&gt;getCode());
  }
}</pre></div></li><li class="listitem">The <a id="id347" class="indexterm"/>manager (<code class="literal">ArticleManager.php</code>) will <a id="id348" class="indexterm"/>contain a new method named <code class="literal">restCreate()</code>, but we will also update the <code class="literal">create()</code> method:<div class="informalexample"><pre class="programlisting">public function restCreate($data) {
  $result = $this-&gt;create($data);

  return $result-&gt;toArray();
}

public function create($input_data) {
  $default_data = array(
    'article_user_id' =&gt; 1,
    'article_is_published' =&gt; 0,
    'translations' =&gt; array(
      'en' =&gt; array(
        'article_translation_short_title' =&gt; 'Short title',
        'article_translation_long_title' =&gt; 'Long title',
        'article_translation_description' =&gt; 'Description',
        'article_translation_slug' =&gt; '',
        'article_translation_lang' =&gt; 'en',
      )
    ),
    'categories' =&gt; array(),
    'hashtags' =&gt; array(),
  );

  $data = array_merge($default_data, $input_data);

  $article = new Article();
  $article-&gt;setArticleIsPublished($data['article_is_published']);

  $articleTranslations = array();

  foreach ($data['translations'] as $lang =&gt; $translation){
    $tmp = new ArticleTranslation();
    $tmp-&gt;assign($translation);
    array_push($articleTranslations, $tmp);
  }

  if (count($data['categories']) &gt; 0) {
    $article-&gt;categories = Category::find([
      "id IN (".implode(',', $data['categories']).")"
    ])-&gt;filter(function($category){
      return $category;
    });
  }

  if (count($data['hashtags']) &gt; 0) {
    $article-&gt;hashtags = Hashtag::find([
      "id IN (".implode(',', $data['hashtags']).")"
    ])-&gt;filter(function($hashtag){
      return $hashtag;
    });
  }

  $user = User::findFirstById((int) $data['article_user_id']);

  if (!$user) {
    throw new \Exception('User not found', 404);
  }

  $article-&gt;setArticleUserId($data['article_user_id']);

  $article-&gt;translations = $articleTranslations;

  return $this-&gt;save($article, 'create');
}</pre></div></li></ol></div><p>Let's test the <a id="id349" class="indexterm"/>new code. Create a <a id="id350" class="indexterm"/>JSON body content and the <code class="literal">POST</code> method data to <code class="literal">/api/v1/articles</code> as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ curl -i -X POST -H "Content-Type:application/json" -d '{"article_user_id":12,"article_is_published":1,"translations":{"en":{"article_translation_short_title":"Test API create","article_translation_long_title":"Test API create","article_translation_description":"Test API create description","article_translation_slug":"test-api-create","article_translation_lang":"en"}},"categories":[9,16],"hashtags":[1]}' 'http://learning-phalcon.localhost/api/v1/articles'</strong></span>
</pre></div><p>Don't forget to replace the user ID, and the IDs of the categories and hashtags that you have in your database. The result should be a newly created article, similar to the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_05_12.jpg" alt="Articles"/></div><p>Following<a id="id351" class="indexterm"/> the same rule as <a id="id352" class="indexterm"/>followed in <code class="literal">Articles</code>, you should try to develop the rest of the endpoints (categories, hashtags, and users). If you don't feel comfortable with it, you can always check out the source code for this chapter.</p></div></div>
<div class="section" title="Securing an API"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec38"/>Securing an API</h1></div></div></div><p>In general, when you <a id="id353" class="indexterm"/>put something online, it is not secure anymore. Virtually anything can be hacked. What can you do in this case? Well, if you are not a billionaire who can afford huge investments in human resources and security software and hardware, all that you can do is try to make the attackers' life a bit rough and always monitor your stuff.</p><p>There are hundreds of books about security and securing an API. We will try to implement a few basic security methods that can help you avoid a disaster.</p><p>So what are these methods? Here is a list:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Always use SSL</li><li class="listitem" style="list-style-type: disc">Add an API key for extra protection</li><li class="listitem" style="list-style-type: disc">Limit the number of requests per second from the same IP</li><li class="listitem" style="list-style-type: disc">Limit access to resources, such as <code class="literal">DELETE</code>, <code class="literal">PUT</code>, <code class="literal">POST</code>, for authenticated users</li></ul></div><div class="section" title="Using SSL"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec45"/>Using SSL</h2></div></div></div><p>There is no need to<a id="id354" class="indexterm"/> elaborate on SSL. Using a secure connection is how you need to go about it. SSL certificates are quite cheap these days. For example, the guys from <a class="ulink" href="http://www.namecheap.com">http://www.namecheap.com</a> sell the multi-domain SSL certificate for 80 EUR per year.</p></div><div class="section" title="Adding an API key for extra protection"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec46"/>Adding an API key for extra protection</h2></div></div></div><p>We will create a <a id="id355" class="indexterm"/>white list of API keys in our global configuration. We will append an APIKEY header to all our requests and check it against the values from config. If the API key does not match, the server will respond with a <code class="literal">403 Forbidden</code> error. If you use this key in a JavaScript environment, everyone will be able to see it, but at least you can take control and change the API key in a second. Let's implement the protection:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">config/config.php</code> global configuration file and append this code to the <code class="literal">$config</code> array:<div class="informalexample"><pre class="programlisting">'apiKeys' =&gt; array(
  '6y825Oei113X3vbz78Ck7Fh7k3xF68Uc0lki41GKs2Z73032T4z8m1I81648JcrY'
)</pre></div></li><li class="listitem">Create a new directory named <code class="literal">Listeners</code> in <code class="literal">modules/Core/</code>, and create a new file named <code class="literal">ApiListener.php</code> with the following content:<div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Listeners;

class ApiListener extends \Phalcon\Mvc\User\Plugin{
  public function beforeExecuteRoute($event, $dispatcher) {
    $hasValidKey = $this-&gt;checkForValidApiKey();

    if (false === $hasValidKey) {
      return false;
    }
  }

  private function checkForValidApiKey() {
    $apiKey = $this-&gt;request-&gt;getHeader('APIKEY');

    if (!in_array($apiKey, $this-&gt;config-&gt;apiKeys-&gt;toArray())) {
      $this-&gt;response-&gt;setStatusCode(403, 'Forbidden');
      $this-&gt;response-&gt;sendHeaders();
      $this-&gt;response-&gt;send();
      $this-&gt;view-&gt;disable();

      return false;
    }

    return true;
  }
}</pre></div></li><li class="listitem">Finally, inject <a id="id356" class="indexterm"/>this service into <code class="literal">dispatcher</code>. Open <code class="literal">modules/Api/service.php</code> and replace the <code class="literal">$di['dispatcher']</code> array with this:<div class="informalexample"><pre class="programlisting">$di['dispatcher'] = function () use ($di) {
  $eventsManager = $di-&gt;getShared('eventsManager');

  $apiListener = new \App\Core\Listeners\ApiListener();
  $eventsManager-&gt;attach('dispatch', $apiListener);

  $dispatcher = new Phalcon\Mvc\Dispatcher();
  $dispatcher-&gt;setEventsManager($eventsManager);
  $dispatcher-&gt;setDefaultNamespace("App\Api\Controllers");

  return $dispatcher;
};</pre></div></li></ol></div><p>If you make a request using the following command line, you will notice that all you get is a <code class="literal">403 Forbidden</code> error:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ curl -i -X GET 'http://learning-phalcon.localhost/api/v1/articles/6'</strong></span>
</pre></div><p>The <code class="literal">403 Forbidden</code> error is as presented in the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_05_13.jpg" alt="Adding an API key for extra protection"/></div><p>This happened <a id="id357" class="indexterm"/>because you didn't provide the APIKEY header. All you need to do is provide the correct header with the correct key, and you will get the article:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ curl -i -X GET -H "APIKEY:6y825Oei113X3vbz78Ck7Fh7k3xF68Uc0lki41GKs2Z73032T4z8m1I81648JcrY" 'http://learning-phalcon.localhost/api/v1/articles/6'</strong></span>
</pre></div><p>This is it! Of course, this method can be improved, but that is beyond the scope of this book. Additionally, you can map API keys with clients and/or IP addresses, and so on.</p></div><div class="section" title="Limiting the number of requests per second from the same IP"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec47"/>Limiting the number of requests per second from the same IP</h2></div></div></div><p>We will use a <a id="id358" class="indexterm"/>simple solution from Redis for limiting the number of requests per second from the same IP. Let's assume that we want a limit of five requests per second from the same IP:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">ApiListener.php</code> and add the following method:<div class="informalexample"><pre class="programlisting">private function checkIpRateLimit() {
  $ip   = $this-&gt;request-&gt;getClientAddress();
  $time = time();
  $key  = $ip.':'.$time;

  $redis   = $this-&gt;getDI()-&gt;get('redis');
  $current = $redis-&gt;get($key);

  if ($current != null &amp;&amp; $current &gt; 5) {

    $this-&gt;response-&gt;setStatusCode(429, 'Too Many Requests');
    $this-&gt;response-&gt;sendHeaders();
    $this-&gt;response-&gt;send();
    $this-&gt;view-&gt;disable();

    return false;
  } else {
    $redis-&gt;multi();
    $redis-&gt;incr($key, 1);
    $redis-&gt;expire($key, 5);
    $redis-&gt;exec();
  }

  return true;
}</pre></div></li><li class="listitem">Then, update the <code class="literal">beforeExecuteRoute()</code> method with the following code:<div class="informalexample"><pre class="programlisting">public function beforeExecuteRoute($event, $dispatcher) {
  $hasValidKey = $this-&gt;checkForValidApiKey();
  $ipRateLimit = $this-&gt;checkIpRateLimit();

  if (false === $hasValidKey || false === $ipRateLimit) {
    return false;
  }
}</pre></div></li></ol></div><p>That's all! You<a id="id359" class="indexterm"/> can easily test it by replacing <code class="literal">5</code> with <code class="literal">2</code>, and make some requests. You will get a 429 response. You can use this method in conjunction with API keys and users to limit the requests for a certain user.</p></div><div class="section" title="Limiting access to resources such as DELETE, PUT, and POST for authenticated users"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec48"/>Limiting access to resources such as DELETE, PUT, and POST for authenticated users</h2></div></div></div><p>If you are going to expose<a id="id360" class="indexterm"/> your API, you need to be sure that only authenticated users can access certain resources. This means that you shouldn't access these resources from a public interface, for example, the frontend. A quick and convenient solution would be to use another header (let's call it <code class="literal">TOKEN</code>) that will be used in CRUD operations from the admin interface. Let's perform the following set of steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Here, we'll first add a new method, <code class="literal">resourceWithToken()</code>, in <code class="literal">ApiListener.php</code> as follows, and then update <code class="literal">beforeExecuteRoute()</code> method:<div class="informalexample"><pre class="programlisting">private function resourceWithToken() {
  if (in_array($this-&gt;dispatcher-&gt;getActionName(), ['update','delete','create'])) {
    if ($this-&gt;request-&gt;getHeader('TOKEN') != 'mySecretToken') {
      $this-&gt;response-&gt;setStatusCode(405, 'Method Not Allowed');
      $this-&gt;response-&gt;sendHeaders();
      $this-&gt;response-&gt;send();
      $this-&gt;view-&gt;disable();

      return false;     }

    return true;
  }
}</pre></div></li><li class="listitem">Append the following code to the <code class="literal">beforeExecuteRoute()</code> method:<div class="informalexample"><pre class="programlisting">if (false === $this-&gt;resourceWithToken()) {
  return false;
}</pre></div></li></ol></div><p>If you<a id="id361" class="indexterm"/> try <code class="literal">POST</code>, <code class="literal">PUT</code>, or <code class="literal">DELETE</code>, you will get a 405 error. From now on, you need to append the header named TOKEN with the <code class="literal">mySecretToken</code> value, as shown in this example:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ curl -i -X PUT    -H "Content-Type:application/json"    -H "APIKEY:6y825Oei113X3vbz8Ck7Fh7k3xF68Uc0lki41GKs2Z73032T4z8m1I81648JcrY"    -H "TOKEN:mySecretToken"    -d '{"article_user_id":12,"article_is_published":1,"translations":{"en":{"article_translation_short_title":"Test API create","article_translation_long_title":"Test API create","article_translation_description":"Test API create description","article_translation_slug":"test-api-create","article_translation_lang":"en"}},"categories":[9,16],"hashtags":[1]}'  'http://learning-phalcon.localhost/api/v1/articles/6'</strong></span>
</pre></div><p>Remember that this will not secure your API if you call it from a frontend using JavaScript, because the value of the token will be visible to everyone.</p><p>There are hundreds of other solutions, and you should carefully study what is needed. Also, securing your API is not enough. Securing the entire application, plus the server (for example, by using firewalls), is important too. But just for the purpose of this chapter, what we did should be enough to protect us from the most common attacks.</p><p>Read more, document yourself, and ask for experts' opinions. Most of the time, what seems to be a good solution for someone might not be a good solution for you.</p></div></div>
<div class="section" title="Documenting the API"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec39"/>Documenting the API</h1></div></div></div><p>Documentation is <a id="id362" class="indexterm"/>probably one of the most important things you should spend time on. When I discovered Phalcon, the first thing that I did was to develop a simple API. When I needed to create documentation for my API, I found myself in a strange situation; there were just a few solutions out there, and most of them had dependencies. This was back in the summer of 2013 or so.</p><p>So, I decided to create my own API documentation generator, without any dependencies—just pure PHP. I <a id="id363" class="indexterm"/>am going to use this tool (it is publicly available on GitHub at <a class="ulink" href="https://github.com/calinrada/php-apidoc">https://github.com/calinrada/php-apidoc</a>) to create and generate the API documentation for our project.</p><div class="section" title="Installation"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec49"/>Installation</h2></div></div></div><p>You should already have it, because<a id="id364" class="indexterm"/> I was using the extractor from it to generate comments for the CLI tasks. If you missed it, you can do it in two easy steps:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php composer.phar require crada/php-apidoc</strong></span>
<span class="strong"><strong>$ php composer.phar update</strong></span>
</pre></div></div><div class="section" title="Usage"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec50"/>Usage</h2></div></div></div><p>We'll perform a couple of <a id="id365" class="indexterm"/>steps to properly understand the usage:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's create a new CLI task named <code class="literal">ApidocTask.php</code> with the following content:<div class="informalexample"><pre class="programlisting">&lt;?php
use Crada\Apidoc\Builder;
use Crada\Apidoc\Exception;

class ApidocTask extends BaseTask {
  /**
  * @Description("Build API Documentation")
  * @Example("php apps/cli.php apidoc generate")
  */
  public function generateAction($params = null) {
    $classes = [
      'App\Api\Controllers\ArticlesController'
    ];

    try {
      $builder = new Builder($classes, __DIR__.'/../../docs/api', 'index.html');
      $builder-&gt;generate();
      exec("ln -s ".__DIR__."/../../docs/api ".__DIR__."/../../public/apidoc");
      $this-&gt;consoleLog('ok! : '.__DIR__.'/../../docs/api/index.html');

    } catch (Exception $e) {
      $this-&gt;consoleLog($e-&gt;getMessage(), 'red');
    }
  }
}</pre></div><p>We are going to<a id="id366" class="indexterm"/> use annotation to document each method.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note16"/>Note</h3><p>For additional information on this, check out <a class="ulink" href="https://github.com/calinrada/php-apidoc#usage">https://github.com/calinrada/php-apidoc#usage</a> and <a class="ulink" href="https://github.com/calinrada/php-apidoc#available-methods">https://github.com/calinrada/php-apidoc#available-methods</a>.</p></div></div></li><li class="listitem">Open <code class="literal">ArticlesController.php</code> and append the following content to the <code class="literal">listActi/on()</code> method:<div class="informalexample"><pre class="programlisting">/**
  * @ApiDescription(section="Articles", description="Retrieve a list of articles")
  * @ApiMethod(type="get")
  * @ApiRoute(name="/articles")
  * @ApiParams(name="p", type="integer", nullable=true, description="Page number")
  * @ApiReturnHeaders(sample="HTTP 200 OK")
  * @ApiReturn(type="object", sample="{
  *  'items': [{
  *    'id':'int',
  *    'article_user_id':'int',
  *    'article_is_published':'int',
  *    'article_created_at':'string',
  *    'article_updated_at':'string',
  *    'article_translations':[{
  *      'article_translation_short_title':'string',
  *      'article_translation_long_title':'string',
  *      'article_translation_slug':'string',
  *      'article_translation_description':'string',
  *      'article_translation_lang':'string'
  *    }],
  *    'article_categories':[{
  *      'id':'int',
  *      'category_translations':[{
  *        'category_translation_name':'string',
  *        'category_translation_slug':'string',
  *        'category_translation_lang':'string'
  *      }]
  *    }],
  *    'article_hashtags':[{
  *      'id':'int',
  *      'hashtag_name':'string'
  *    }],
  *    'article_author':{
  *      'user_first_name':'string',
  *      'user_last_name':'string',
  *      'user_email':'string'
  *    }
  *  }],
  *  'before':'int',
  *  'first':'int',
  *  'next':'int',
  *  'last':'int',
  *  'current':'int',
  *  'total_pages':'int',
  *  'total_items':'int',
  *}")
  */
public function listAction() {

}</pre></div></li></ol></div><p>Now switch to the<a id="id367" class="indexterm"/> command prompt and execute the following command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php modules/cli.php apidoc generate</strong></span>
</pre></div><p>The task creates a new symlink in your public folder. Now you can access the API documentation at <code class="literal">http://learning-phalcon.localhost/apidoc/</code>, and you should be able to see exactly the same output as presented in the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_05_14.jpg" alt="Usage"/></div><p>It's time to close<a id="id368" class="indexterm"/> this chapter. Please take your time to read as much as possible about developing APIs, especially secure APIs.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec40"/>Summary</h1></div></div></div><p>In this chapter, we discovered how easily and quickly we can develop an API. You learned about the recommended practices and a few common ways of securing an API. We covered new topics, such as route grouping and filtering results.</p><p>In the next chapters, we will switch layouts and JavaScript integration, but we will continue to adapt, or change, things in the API, database, and models.</p></div></body></html>