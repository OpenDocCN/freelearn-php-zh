- en: '16'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Avoiding Sleepless Nights – Moodle Backup and Restore
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Your Moodle application will contain important data such as coursework, assignments,
    grades, and all administrative data, for example, users, cohorts, and roles. Therefore,
    you must have a good backup strategy in place.
  prefs: []
  type: TYPE_NORMAL
- en: Preparing for the unexpected is always a good strategy when dealing with information
    systems, and having well-preserved backups allows for full application recovery
    upon unexpected hardware or software failures. Systems are not expected to fail,
    but there’s always a possibility for failure, and a good strategy for fast recovery
    ensures a low impact on users. This chapter presents strategies and options for
    managing backups and auto-backups of your data.
  prefs: []
  type: TYPE_NORMAL
- en: 'Moodle itself supports two types of backups:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Course-level backups**: Course backups are usually ad hoc and only archive
    the selected course. You will learn how to create course backups, restore courses,
    and copy course content using the related course import facility.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Site-level backups**: The site backup option saves all courses and related
    data to a specified location at regular intervals. You will learn how to set this
    up and recover data from it.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Both mechanisms will be covered in detail before we look at **system-level
    backups**, including Moodle backups (covering the Moodle software and the data
    stored in it) and snapshot creation (full system images). The three backup types
    are shown in the following diagram and are at the core of this chapter:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.1 – Moodle backups ](img/Figure_16.01_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.1 – Moodle backups
  prefs: []
  type: TYPE_NORMAL
- en: 'We will conclude this chapter by looking at two applications that use backup
    and restore facilities: planning year-end procedures and implementing course templates.'
  prefs: []
  type: TYPE_NORMAL
- en: 'We will cover the following main topics in this chapter:'
  prefs: []
  type: TYPE_NORMAL
- en: Managing course-level backups
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Managing site-level backups
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Managing system-level backups
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using backup and restore for alternative tasks
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Managing course-level backups
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Course-level backups allow teachers and administrators to create copies of courses
    for safekeeping or to pass on to colleagues. If configured appropriately, course
    backups can save an administrator a lot of hassle and time.
  prefs: []
  type: TYPE_NORMAL
- en: Important note
  prefs: []
  type: TYPE_NORMAL
- en: Course backups include some or all of the items of a course.
  prefs: []
  type: TYPE_NORMAL
- en: First, we will look at the backup procedure before going into the details of
    recovering data during the restore operation.
  prefs: []
  type: TYPE_NORMAL
- en: Creating course backups
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: To back up an individual course, it is best if you are inside that course, where
    you have to select the **Course reuse** option in the course menu and then select
    **Backup** from the dropdown.
  prefs: []
  type: TYPE_NORMAL
- en: 'The backup procedure comprises five steps, illustrated in the following workflow:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.2 – Course backup workflow ](img/Figure_16.02_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.2 – Course backup workflow
  prefs: []
  type: TYPE_NORMAL
- en: You can navigate back to any step via the process links at the top of the screen
    or the navigation buttons at the bottom. We will go through the steps one by one
    in the following subsections.
  prefs: []
  type: TYPE_NORMAL
- en: Initial settings
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Several settings determine how the backup will be performed and what type of
    information will be included:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.3 – Course backup – Initial settings ](img/Figure_16.03_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.3 – Course backup – Initial settings
  prefs: []
  type: TYPE_NORMAL
- en: 'Some settings are only available if other settings have been activated; for
    example, **Include user role assignments** can only be ticked if enrolled users
    are included. Most options are self-explanatory, but two options require some
    commentary:'
  prefs: []
  type: TYPE_NORMAL
- en: If `Jonny Walker` might become `anonfirstname69 anonlastname69`.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: In addition to the standard Moodle backup format, **IMS Common Cartridge 1.1**
    is a special format that’s supported. For more information on IMS CC, please consult
    the Moodle Docs at [docs.moodle.org/en/IMS_Common_Cartridge_import_and_export](http://docs.moodle.org/en/IMS_Common_Cartridge_import_and_export).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'By default, all options can be selected for all users who have the appropriate
    permissions in the course context. If you wish to change the default values and/or
    lock specific settings (such as **Include course logs**, as shown in the previous
    screenshot), go to **Site administration** | **Courses** | **Backups** | **General**
    **backup defaults**:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.4 – Course backup default settings ](img/Figure_16.04_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.4 – Course backup default settings
  prefs: []
  type: TYPE_NORMAL
- en: For every setting, there are two checkboxes. The first represents the parameter’s
    default, whereas the second value indicates whether it is locked or not. Locking
    allows you to force specific settings, for instance, the exclusion of users.
  prefs: []
  type: TYPE_NORMAL
- en: 'There are usually two types of course backups that you are likely to perform:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Content-only backups**'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: As the name suggests, this type of backup only contains content that can be
    passed on to another person without transferring any information about its users,
    roles, grades, and so on. To perform a content-only backup, you must deselect
    **Include enrolled users**, which is a prerequisite for all user-related backup
    options.
  prefs: []
  type: TYPE_NORMAL
- en: A content-only backup is the best option if you wish to pass a course on to
    other educators or make it available for download. Another use case is to create
    a new instance of a course for yourself, for example, taking a course backup from
    one semester to use in a different semester. When you publish courses on a community
    hub or MoodleNet (refer to [*Chapter 19*](B18779_19.xhtml#_idTextAnchor344), *Setting
    Up Moodle Networking*), you will also create a content-only backup.
  prefs: []
  type: TYPE_NORMAL
- en: Important note
  prefs: []
  type: TYPE_NORMAL
- en: By default, users with teaching rights can only perform content-only backups.
    This restriction can be changed via the `moodle/backup:userinfo` capability, but
    it should be done carefully.
  prefs: []
  type: TYPE_NORMAL
- en: '**Full-course backups**'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If you wish to back up a course for potential recovery purposes, you should
    create a full-course backup, which includes user data (for example, forum posts),
    course data, and user information. To do this, you can leave all the settings
    at their default values and use the **Jump to final** **step** button.
  prefs: []
  type: TYPE_NORMAL
- en: If you wish to back up the course logs, the **Include course logs** setting
    must be enabled. Remember that logs can be massive and often exceed multiple gigabytes
    when you’re backing up several courses.
  prefs: []
  type: TYPE_NORMAL
- en: 'Before we move on to the next screen, a note of caution: some third-party course-level
    plugins (activities, blocks, or filters) might not support backups. If you encounter
    any issues, you will have to exclude items created by these from the backup or,
    better, avoid the plugin altogether.'
  prefs: []
  type: TYPE_NORMAL
- en: Schema settings
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'All learning resources and activities are shown in the order in which they
    appear in the course. Resources are only available if the **Include activities**
    parameter has not been deactivated on the previous screen. By default, all the
    available elements are selected; if you wish to exclude any individual items,
    you have to deselect them. Additionally, you can exclude/include all the items
    of a section by selecting/deselecting the section name itself:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.5 – Course backup – Schema settings ](img/Figure_16.05_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.5 – Course backup – Schema settings
  prefs: []
  type: TYPE_NORMAL
- en: Moodle distinguishes between **course content** and **user data**. For example,
    the forum description and all its settings are classified as course content in
    a forum activity. In contrast, all topics, posts, and replies to a forum are classified
    as user data. If the **Include enrolled users** option has been left activated
    on the initial setup screen, user data can be included/excluded for each selected
    activity and resource.
  prefs: []
  type: TYPE_NORMAL
- en: Selecting the **Next** button will take you to the last course backup configuration
    screen.
  prefs: []
  type: TYPE_NORMAL
- en: Confirmation and review
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The third screen lets you choose the backup filename and review the items to
    be included in the archive. The format of the default **Filename** is as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: At the time of writing, `<type>` is always set to `<format>` is `–nu` parameter
    stands for no users, and `-an` is an indicator for anonymous users.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you have opted to create `.imscc` extension will be used instead of `.mbz`:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.6 – Course backup – Confirmation and review ](img/Figure_16.06_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.6 – Course backup – Confirmation and review
  prefs: []
  type: TYPE_NORMAL
- en: Moodle creates a bespoke file format for backups, known as the `.mbz` extension.
    A Moodle backup file is a compressed file (in `.tgz` format) that consists of
    an XML file (which describes the file’s content) and the actual content, users,
    log data, and so on.
  prefs: []
  type: TYPE_NORMAL
- en: The additional **Backup settings** section shows which item has been selected
    and deselected on the initial settings screen. The **Included items** section
    indicates, with a green tick, all resources and activities that will be included,
    as well as any user data that will be part of the course backup. A red cross means
    that the item has been deselected, whereas a red cross followed by a lock indicates
    that it wasn’t possible to select the item since a prerequisite has not been fulfilled.
  prefs: []
  type: TYPE_NORMAL
- en: Once you press the **Perform backup** button, the Moodle course archive will
    be created.
  prefs: []
  type: TYPE_NORMAL
- en: Finalizing the backup
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The created archive file is saved in the **Course backup** area. This process
    can take a few minutes, depending on the volume of data being backed up. If the
    **Anonymize user data** setting was chosen at the beginning, the backup file will
    be placed in the **User private** **backup** area.
  prefs: []
  type: TYPE_NORMAL
- en: Important note
  prefs: []
  type: TYPE_NORMAL
- en: Moodle backups include the course configuration, which contains course settings,
    activity arrangements, and block positions.
  prefs: []
  type: TYPE_NORMAL
- en: After completion, a brief status message is shown; you will have to take appropriate
    actions if this contains any errors or warnings.
  prefs: []
  type: TYPE_NORMAL
- en: 'Backups sometimes fail on large courses, and the cause is usually that the
    backup process runs out of time or memory. If this happens, you have two options
    that are not mutually exclusive:'
  prefs: []
  type: TYPE_NORMAL
- en: First, you can increase the **Extra PHP memory limit** setting by going to **Server**
    | **Performance**.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Second, you can choose **Enable synchronous backups** by going to **Site administration**
    | **Courses** | **Backups** | **Asynchronous backup/restore**, which triggers
    Moodle to execute backups (and restores) as a separate background process:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![Figure 16.7 – Asynchronous backup/restore ](img/Figure_16.07_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.7 – Asynchronous backup/restore
  prefs: []
  type: TYPE_NORMAL
- en: Asynchronous backups only allow a user to have one pending backup for a resource
    at a time. Multiple asynchronous backups of the same resource can’t be queued,
    as this would likely result in multiple backups that contain the same content.
  prefs: []
  type: TYPE_NORMAL
- en: If you wish to notify the user who initiated the course backup when the process
    is completed, choose **Enable message notifications** and customize the **Subject**
    and **Message** properties of the notification that will be sent out.
  prefs: []
  type: TYPE_NORMAL
- en: This concludes this section on creating course backups. The reverse operation
    – restoring course backups – is the topic of the following section.
  prefs: []
  type: TYPE_NORMAL
- en: Restoring course backups
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: To wholly or partly restore a previously backed up course, it is best if you
    are inside that course, where you have to select the **Course reuse** option in
    the course menu and then select **Restore** from the dropdown. Alternatively,
    you can navigate to **Site administration** | **Courses** | **Restore course**.
  prefs: []
  type: TYPE_NORMAL
- en: 'Once you have selected a `.mbz` file, the restore procedure comprises seven
    steps, illustrated in the following diagram:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.8 – Course restore workflow ](img/Figure_16.08_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.8 – Course restore workflow
  prefs: []
  type: TYPE_NORMAL
- en: As with the backup workflow, you can navigate back to any step via the process
    links at the top of the screen or using the navigation buttons at the bottom.
    We will go through the steps one by one in the following subsections.
  prefs: []
  type: TYPE_NORMAL
- en: File selection and confirmation
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Moodle stores its backup files in different `.mbz` file to be restored, as
    shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.9 – Course backup areas ](img/Figure_16.09_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.9 – Course backup areas
  prefs: []
  type: TYPE_NORMAL
- en: 'The four locations for Moodle archives are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Import backup file**: Archives that are usually stored outside of Moodle
    and selected via the file picker or drag’n’drop'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Course backup area**: Archives created using default settings are stored
    in this area'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**User private backup area**: Archives with anonymized users are stored here'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Automated backups**: Archives that are created automatically (see the *Site*
    *backups* section)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: In the preceding example, a single course is present in the course backup area,
    called `backup-moodle2-course-14-packt_backup-20220712-2001.mbz`. From its filename,
    we already know that the course ID is 14, its name is Packt Backup, and that it
    was backed up on July 12, 2022, at 20:01.
  prefs: []
  type: TYPE_NORMAL
- en: Select the `.mbz` file), **Backup settings** (identical to the initial settings
    in the backup), and **Course details**. Once you have confirmed this information-only
    screen, you have to specify where you wish to recover the backup.
  prefs: []
  type: TYPE_NORMAL
- en: Selecting the restore destination
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'There are various options for restoring a course backup:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Restore as a** **new course**'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Restore into this course** and merge the backup into this course'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Restore into this course**, delete the contents of this course, and then
    restore it'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Restore into an existing course** and merge the backup into the selected
    course'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Restore into an existing course**, delete its contents, and then restore:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![Figure 16.10 – Course restore – Destination](img/Figure_16.10_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.10 – Course restore – Destination
  prefs: []
  type: TYPE_NORMAL
- en: If you wish to **Restore as a new course**, you will have to select a category
    in which the new course will be created. You must use the provided search facility
    if the number of categories exceeds 20\. Alternatively, you can choose the current
    course as the destination (**Restore into this course**). You can either combine
    the current course content with the backup (**Merge the backup course into this
    existing course**) or replace it (**Delete the contents of this course and then
    restore**). If you choose the merging option and an activity or resource with
    the same name exists, both will be kept and not overridden. The third option is
    to restore the course to another existing course, which you have to select. The
    same options (merge and replace) exist to restore the backup in the current course.
    Make sure you click on the correct **Continue** button before you proceed.
  prefs: []
  type: TYPE_NORMAL
- en: Restore settings
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The **Restore settings** screen shows all the available options that were selected
    during the backup process (refer to the preceding *Initial settings* section).
    As shown earlier, the choices made here determine the types of data that will
    be recovered, and which type of content will be offered for further selection.
    Also, most options have prerequisites that are identical to their backup counterparts.
  prefs: []
  type: TYPE_NORMAL
- en: If you wish to change the default values and/or lock specific settings, go to
    **Site administration** | **Courses** | **Backups** | **General restore defaults**.
    For every parameter, there are two checkboxes. The first represents the setting’s
    default, whereas the second value indicates whether it is locked or not. Locking
    allows you to force specific settings, for instance, the exclusion of users.
  prefs: []
  type: TYPE_NORMAL
- en: The backup schema
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Depending on your choices on the previous two screens, the schema step lets
    you specify several course settings. If you restore the backup to an existing
    course, you have the option to overwrite its settings. These are **Course name**,
    **Course short name**, and **Course start date**. You can further choose to **Keep
    current roles and enrolments** (if these are part of the backup), **Keep current
    groups and groupings** (if stored in the backup), and use the course settings
    of the backup file instead of the current ones (**Overwrite** **course configuration**):'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.11 – Course restore – Schema](img/Figure_16.11_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.11 – Course restore – Schema
  prefs: []
  type: TYPE_NORMAL
- en: You must also choose which content and user data to include in the recovery
    procedure. The selection mechanism is very similar to the backup equivalent described
    earlier. By default, all the data that is present is selected. If you wish to
    narrow down the data to be restored, you must manually deselect items.
  prefs: []
  type: TYPE_NORMAL
- en: Finalizing restore
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: After the final familiar-looking **Review** screen, the restore process is initiated
    once the **Perform restore** button is pressed. Any selected data will be recovered
    to the chosen destination. After completion, a summary message is shown.
  prefs: []
  type: TYPE_NORMAL
- en: 'If the restored course contains any roles that do not exist on your Moodle
    system, a role mappings step will be shown, where you must map roles manually
    to ensure consistency:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.12 – Course restore – Restore role mappings ](img/Figure_16.12_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.12 – Course restore – Restore role mappings
  prefs: []
  type: TYPE_NORMAL
- en: 'This completes this section on restoring course backups. Before we move on
    to site backups, let’s cover a feature closely related to course restore: course
    import.'
  prefs: []
  type: TYPE_NORMAL
- en: Importing course data
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: It is sometimes necessary to copy data from one course to another. To achieve
    this, Moodle provides the **import course data** feature. However, unlike the
    backup function, it will not import user data, such as assignment submissions
    or forum posts – it will only import the structure of activities, blocks, and
    filters. For example, you might want to import a single quiz from one course to
    another.
  prefs: []
  type: TYPE_NORMAL
- en: Teachers can import content from courses for which they have editing rights;
    as an administrator, this restriction does not apply. This mechanism bypasses
    the requirement for a backup and restore procedure if you want to copy course
    content from one course to another and do not require user data.
  prefs: []
  type: TYPE_NORMAL
- en: To copy course data, you need to be inside the receiving course, where you have
    to select the **Course reuse** option in the course menu and then select **Import**
    from the dropdown.
  prefs: []
  type: TYPE_NORMAL
- en: 'The import procedure comprises six steps, as illustrated in the following workflow:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.13 – Course import workflow ](img/Figure_16.13_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.13 – Course import workflow
  prefs: []
  type: TYPE_NORMAL
- en: 'As with the backup and restore workflows, you can navigate back to any step
    via the process links at the top of the screen or the navigation buttons at the
    bottom. Since the course import feature is effectively a subset of the course
    backup and restore functionality, we will only briefly mention each step in the
    process:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Course selection**: You must select a course from which you wish to import
    content. Use the provided search facility if the list exceeds 10 courses (default
    value). You can also select the current course; this way, you can duplicate multiple
    activities.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Initial settings**: Choose which course items you wish to import. Note the
    absence of user-related options.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Schema settings**: A familiar screen for selecting topics and activities.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Confirmation and review**: Import settings and included items are shown.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Perform import**: Go, go, go!'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Complete**: A summary message is shown.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If you wish to change the default values and/or lock specific settings, go to
    **Site administration** | **Courses** | **Backups** | **General import defaults**.
    There are two checkboxes for every setting, and the same logic applies as for
    the backup and restore defaults. On this screen, you can also specify the **Maximum
    number of courses listed for** **import** option.
  prefs: []
  type: TYPE_NORMAL
- en: Importing concludes this section on course-level archives, where the focus has
    been on creating and restoring individual course backups. To automate this process
    across courses, site-level backups are needed, which we will cover in the following
    section.
  prefs: []
  type: TYPE_NORMAL
- en: Managing site-level backups
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: So far, we have dealt with backing up single courses. Site-level backups perform
    the same operation for every course in your system, including hidden courses and
    the home page.
  prefs: []
  type: TYPE_NORMAL
- en: Before we look at backup reports and notifications, we will configure automated
    backups. We will conclude this section with some backup strategies.
  prefs: []
  type: TYPE_NORMAL
- en: Configuring automated backups
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Go to **Site administration** | **Courses** | **Backups** | **Automated backup
    setup** to schedule site backups. Here, you will see the following settings:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.14 – Automated backup configuration ](img/Figure_16.14_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.14 – Automated backup configuration
  prefs: []
  type: TYPE_NORMAL
- en: The remainder of the configuration page covers **Automated backup settings**,
    which specify which elements will be included in the backup. These are identical
    to the initial backup settings, except for the anonymize option, which has been
    excluded.
  prefs: []
  type: TYPE_NORMAL
- en: 'For the backup to start automatically at the specified time, the `cron` process
    must be configured correctly, which we covered in [*Chapter 1*](B18779_01.xhtml#_idTextAnchor020),
    *Installing Moodle*. Alternatively, you can initiate the backup process via the
    CLI, which executes the same script that’s called by the `cron` process. The command
    execution from the shell or for the inclusion in scripts is as follows (assuming
    the Apache user is `www-data`):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: Recovering courses from an automated backup is identical to restoring data from
    course-level backup archives.
  prefs: []
  type: TYPE_NORMAL
- en: To ensure that the backups are running correctly, Moodle provides a backup report
    and notifications, which we will explain in the following subsection.
  prefs: []
  type: TYPE_NORMAL
- en: Backup reports and notifications
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'As a Moodle administrator, you must ensure that the backup execution has been
    successful. For this purpose, Moodle provides a backup report, which you can find
    by going to **Site administration** | **Reports** | **Backups**. It shows a log
    of the last execution:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.15 – Automated backup configuration ](img/Figure_16.15_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.15 – Automated backup configuration
  prefs: []
  type: TYPE_NORMAL
- en: The report provides details for each **Course** being backed up, namely **Time
    taken** (start and end time), **Status**, and the date and time of its **Next
    backup**.
  prefs: []
  type: TYPE_NORMAL
- en: Courses in which there hasn’t been any activity for 30 days – that is, no changes
    have been made to the course content, and no users have used the course – are
    excluded from the automated backup, and the status is shown as **Skipped**.
  prefs: []
  type: TYPE_NORMAL
- en: As a Moodle administrator, you will receive an email after the scheduled site-level
    backup has been completed. It provides details on the total number of courses
    backed up and a split of how many course backups were okay, contained errors,
    were unfinished, and were skipped. Ensure your email settings have been configured
    correctly (refer to [*Chapter 10*](B18779_10.xhtml#_idTextAnchor204), *Configuring
    Technical Features*). It is highly recommended that you check the content of this
    email every day.
  prefs: []
  type: TYPE_NORMAL
- en: To ensure the smooth and reliable execution of your automated backups, you must
    have an adequate backup strategy in place, which we will discuss next.
  prefs: []
  type: TYPE_NORMAL
- en: The backup strategy
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'There are several issues to consider when running automatic site-wide Moodle
    backups:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Backup content**: Ensure that everything included in the archives is needed,
    and anything that is not required is excluded. Do you have to back up the entire
    logs and gradebook history every night?'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Backup size**: The size of the backup files can be potentially huge (multiple
    gigabytes). Ensure that you only keep the number of backups that are required
    and your setup can cope with.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Backup timing**: The backup operation is a CPU and hard disk-intensive operation.
    Make sure you schedule its execution when the load on the site is relatively low.
    If you run multiple sites on the same server, it is recommended to time-stagger
    backups or create a script that uses the described CLI. An alternative approach
    is to set up a dedicated backup server.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Backup frequency**: Do you need seven daily backups, or are weekly backups
    sufficient? Are there periods (such as weekends) when you can switch off the backup
    facility altogether?'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Backup location**: By default, all backup files are saved to the respective
    courses, which means that the backups are held on the same server as Moodle. If
    you have to recover multiple courses, you must locate each archive separately,
    a potentially mind-numbing and time-consuming exercise.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: You might want to consider storing your backups on an external device (external
    disk, NAS drive, SAN, and so on). An alternative to this approach is to mount
    a backup device and include its content in the organization-wide backup.
  prefs: []
  type: TYPE_NORMAL
- en: Site-level backups are a great way to automate course backups and simplify educators’
    lives. However, they only back up courses, not the entire system. While this is
    sufficient if you have to recover a single course or some activities, it is insufficient
    in a disaster scenario when the entire system has to be recovered.
  prefs: []
  type: TYPE_NORMAL
- en: Important note
  prefs: []
  type: TYPE_NORMAL
- en: You should not use the course backup facility as your sole backup system.
  prefs: []
  type: TYPE_NORMAL
- en: Instead, system-level backups should be used as a supplement, which we will
    look at next.
  prefs: []
  type: TYPE_NORMAL
- en: Managing system-level backups
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: System-level backups cannot be configured or executed from within Moodle. Instead,
    they must be set up at the system level. If your system is hosted externally,
    there is a possibility that you will not have access to the system level, which
    will prevent you from performing this type of backup. Unless the host already
    runs system-level backups on your behalf, it is time to change to another provider!
  prefs: []
  type: TYPE_NORMAL
- en: 'There are two types of system backups that are not mutually exclusive:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Moodle backups**: These create an archive of Moodle itself, the application
    data, and any application configuration'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Snapshots**: These create an image of the system, which is used for disaster
    recovery if the system has to be rolled back in its totality'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: We will briefly cover both approaches in the following two subsections.
  prefs: []
  type: TYPE_NORMAL
- en: Moodle backups
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Moodle distinguishes between the application software and the data stored in
    it. The advantage of this separation becomes apparent when creating backups: a
    software backup is only required when an update has been installed or customization
    is taking place, whereas data should be backed up more frequently.'
  prefs: []
  type: TYPE_NORMAL
- en: Backing up the `moodle`). Most administrators would create a single archive
    of the directory for easier handling (in Unix, simply use `tar -cvf <backupfile>`).
    This step is usually only required before a system upgrade or when you need to
    archive your entire system.
  prefs: []
  type: TYPE_NORMAL
- en: 'Moodle stores its data in two separate locations:'
  prefs: []
  type: TYPE_NORMAL
- en: '`mysqldump` shell command for MySQL and MariaDB to create a single backup file:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: '`<username>` has to be replaced with the database username, `–p` will ask you
    for a password, and `–h <databasehost>` is only required if the database is located
    on a separate server. The `<database>` option is the name of the database, and
    `<backup-file>` is the name of the archive to be created. It is common practice
    to use the `.``sql` extension.'
  prefs: []
  type: TYPE_NORMAL
- en: 'To recover the database dump, use the following `mysql` shell command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: For other database types, refer to the respective administration guides.
  prefs: []
  type: TYPE_NORMAL
- en: '**Moodle data directory ($CFG->dataroot)**: This is where all contributed files
    reside – for instance, submitted assignments, language customizations, user profile
    pictures, videos, and so on. Like the Moodle system, all you have to do is create
    a copy of the directory and all its subdirectories. It is crucial to stop Apache
    while performing the backup to guarantee that the content does not go out of sync.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The advantage of this approach is that it is less resource-intensive, can be
    scripted, and recovering the entire Moodle system is far more straightforward.
    However, it is impossible to retrieve individual activities without setting up
    a temporary server, as is possible with course backups.
  prefs: []
  type: TYPE_NORMAL
- en: Snapshot creation
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Creating snapshots is only briefly mentioned here for completeness as it is
    not a Moodle administrator role but a system administrator task. However, you
    should ensure that such a mechanism is set up in case of hardware failures or
    other system issues.
  prefs: []
  type: TYPE_NORMAL
- en: A snapshot is an image of the entire partition(s) on the hard disk(s) that contain(s)
    the Moodle software itself, as well as all the data (database and data directory).
    The advantage of the snapshot is that the entire system can be rolled back to
    the point when the image was created. However, any data that has been added or
    modified since this point in time will be overridden. Snapshots cannot be used
    to recover a single course or parts thereof but to fully replace the system.
  prefs: []
  type: TYPE_NORMAL
- en: Important note
  prefs: []
  type: TYPE_NORMAL
- en: No matter what combination of backups you choose, frequently verify that the
    backup procedure is working. There is nothing worse than a false sense of security
    – that is, assuming that all your data is backed up when it isn’t!
  prefs: []
  type: TYPE_NORMAL
- en: 'This concludes this section on site-wide backups, which covered Moodle backups
    and snapshots. The following checklist provides a quick summary of the backup
    and restore configurations that should be taken care of:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 16.16 – Backup checklist ](img/Figure_16.16_B18779.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 16.16 – Backup checklist
  prefs: []
  type: TYPE_NORMAL
- en: We will finish this chapter by looking at two use cases that utilize Moodle’s
    backup and restore features.
  prefs: []
  type: TYPE_NORMAL
- en: Using backup and restore for alternative tasks
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'While the prime purpose of backups is the recovery of data in case of loss,
    some applications can be carried out using the techniques covered in this chapter.
    We will briefly describe two of them: year-end procedure and course templates.'
  prefs: []
  type: TYPE_NORMAL
- en: Planning the year-end procedure
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Most organizations have some sort of year-end procedure in place, which might
    be at the end of an academic year, a term, the financial year, or, in the case
    of roll-on-roll-off setups, every month. Given the nature and importance of the
    procedure, each step should be planned well in advance. The key considerations
    are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: When do you run the year-end procedure?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: What has to be done?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Who is involved?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Where will the archives go?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The following is a list of typical steps that might or might not apply to your
    setup. It gives you an idea of how such a procedure may look and demonstrates
    the importance of the backup facility:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Archive**: Create full backups of all courses and consider including a system
    backup. Ensure archives are stored on a separate medium.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Grade export**: Export grades course by course to store them on your student
    management information system.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Course reset**: Use the reset feature at the course level to remove any user
    data. (Resetting courses can also be done in batch mode. Refer to the *Managing
    courses in bulk* section in [*Chapter 4*](B18779_04.xhtml#_idTextAnchor074), *Managing
    Courses* *and Enrolments*.)'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Delete users**: Remove users who have left the organization or disable their
    accounts.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Next-year preparation**: Hide or delete obsolete courses and add new courses.
    Add new users and assign roles to courses.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: This is only a crude outline of tasks to be considered. Ensure you have a detailed
    plan for this type of exercise before you kick off the year-end procedure.
  prefs: []
  type: TYPE_NORMAL
- en: Implementing course templates
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'There is often a requirement to create course templates, which are used as
    a basis to create multiple courses. This process might be in an organization that
    emphasizes the homogeneity of course structure and layout or an education establishment
    that wants to simplify the work of its course creators. The steps to achieve this
    are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Create a course that will become your course template.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Add all the elements (activities, resources, filters, blocks, and so on) to
    the course, change its settings, and arrange the content as required.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Create a content-only backup of the course.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: You can now use the restore mechanism to create as many courses from this template
    as you wish. (This operation can also be done in batch mode. Refer to the *Managing
    courses in bulk* section in [*Chapter 4*](B18779_04.xhtml#_idTextAnchor074), *Managing
    Courses* *and Enrolments*.)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Alternatively, use the **Copy course** feature in the **Course reuse** menu
    at the course level instead of performing *Steps 3* and *4*. However, course copying
    cannot be done in batch mode.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Optionally, you can grant users appropriate rights to the course so that they
    can use the import facility.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The preceding list requires you to perform some manual steps to implement a
    course templating mechanism. You may find more user-friendly approaches in the
    Moodle plugin database at [moodle.org/plugins](http://moodle.org/plugins), such
    as **Kickstart** ([moodle.org/plugins/format_kickstart](http://moodle.org/plugins/format_kickstart)).
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we dealt with various Moodle backup alternatives. You learned
    how to create course-level, site-level, and system-level backups, as well as how
    to perform data recovery from each type. Your Moodle backup strategy must fit
    in with your organization’s overall disaster recovery plan. We also saw some applications
    that use the covered backup and restore facilities.
  prefs: []
  type: TYPE_NORMAL
- en: Moodle offers a good range of backup and restore options. Ensure that they are
    configured correctly and run test recoveries to be on the safe(r) side. There
    is nothing worse than a false sense of security – that is, assuming that all your
    data is backed up when it isn’t!
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will cover a collection of useful and not-so-useful
    Moodle admin tools.
  prefs: []
  type: TYPE_NORMAL
