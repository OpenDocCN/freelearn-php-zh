<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Creating a Microblogging Platform"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Creating a Microblogging Platform</h1></div></div></div><p>For our next project, we will be developing a scalable<a id="id391" class="indexterm"/> microblogging platform similar to Twitter. This platform will allow users to share content with others, mention other users in their share, and view a timeline of their shares. Additionally, users will be able to register, manage, and change certain account details such as their e-mail address and password. Finally, our platform will enable users to share content with other external social networks such as Twitter.</p><p>By the end of this chapter, we'll have a social network that will allow us to share content and manage our accounts, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7734OS_05_01.jpg" alt="Creating a Microblogging Platform"/></div><p>Our users will also have the ability to directly reply to and share individual posts that they make, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7734OS_05_02.jpg" alt="Creating a Microblogging Platform"/></div><div class="section" title="Prerequisites"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec41"/>Prerequisites</h1></div></div></div><p>Before we <a id="id392" class="indexterm"/>get started, there are a couple of things that we'll need to set up and have working:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Since we'll be sending and receiving e-mails from our application, we're going to need a registered and active domain name. If you do not already have a working domain name, you can purchase one from a domain registrar such as <a class="ulink" href="https://www.namecheap.com">https://www.namecheap.com</a>, <a class="ulink" href="http://www.name.com">www.name.com</a>, or <a class="ulink" href="http://www.gandi.net">www.gandi.net</a>.</li><li class="listitem" style="list-style-type: disc">Next, you'll need to have a web server with a public-facing IP address. This will allow e-mails to be sent to our application. Many cloud <span class="strong"><strong>Virtual Private Server</strong></span> (<span class="strong"><strong>VPS</strong></span>) providers are available for use for low monthly or hourly prices. Such services include <a class="ulink" href="https://www.digitalocean.com">https://www.digitalocean.com</a>, <a class="ulink" href="https://www.linode.com">https://www.linode.com</a>, and <a class="ulink" href="http://www.rackspace.com/cloud/servers">www.rackspace.com/cloud/servers</a>.</li><li class="listitem" style="list-style-type: disc">In order to send e-mails in our application, we'll once again be utilizing a free SendGrid Developer Account, which can be set up at <a class="ulink" href="https://www.sendgrid.com/developers">https://www.sendgrid.com/developers</a>.</li><li class="listitem" style="list-style-type: disc">In this chapter, we'll once again be using the latest version of MySQL (at the time of writing this, it is MySQL 5.6). Make sure that your MySQL server is set up and running on your server.</li><li class="listitem" style="list-style-type: disc">For this <a id="id393" class="indexterm"/>project, we'll once again be managing our dependencies through Composer, which you can download and install from <a class="ulink" href="https://getcomposer.org/">https://getcomposer.org/</a>.</li><li class="listitem" style="list-style-type: disc">Finally, you'll need a Twitter Developer account, which can be obtained from <a class="ulink" href="https://dev.twitter.com/">https://dev.twitter.com/</a>. This account will allow us to enable the sharing of our content to Twitter as the logged-in user via Twitter's OAuth API.</li></ul></div><p>Once you have acquired the listed items, create a subdomain on the domain name you are using and point it to your server. In this chapter, I'll be using <code class="literal">chapter5.example.com</code> to refer to this subdomain. After everything is set up and your server is responding to that domain name, we can get started.</p></div></div>
<div class="section" title="Describing the project"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec42"/>Describing the project</h1></div></div></div><p>Our <a id="id394" class="indexterm"/>microblogging platform can be broken down into two big components:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Users who will be following other users and creating, sharing, and liking content</li><li class="listitem" style="list-style-type: disc">Text-based shares that will be created by the users</li></ul></div><div class="section" title="Users"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec79"/>Users</h2></div></div></div><p>The<a id="id395" class="indexterm"/> first<a id="id396" class="indexterm"/> component of our application is the set of users who will be performing all the tasks in our application. For this application, we're going to be largely reusing the user database and authentication system that we expanded upon in <a class="link" href="ch04.html" title="Chapter 4. Developing an Issue-tracking Application">Chapter 4</a>, <span class="emphasis"><em>Developing an Issue-tracking Application</em></span>. In this chapter, we'll be expanding upon the <code class="literal">users</code> database table, and adding several new relations such as followers and likes.</p><div class="section" title="Followers"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec29"/>Followers</h3></div></div></div><p>In this application, users<a id="id397" class="indexterm"/> will be able to follow and be followed by other users. This relationship will allow users to stay up-to-date with other users by showing content that other users have recently created. Moreover, it will allow them to know how many people are following them and see how much of an<a id="id398" class="indexterm"/> influence they have over their network. For this application, our <code class="literal">followers</code> table will just contain the primary keys of users who are either following or being followed by another user. Our database table will look as follows:</p><div class="informalexample"><pre class="programlisting">ID INTEGER PRIMARY KEY
follower_id INTEGER
followee_id INTEGER
created INTEGER
updated INTEGER</pre></div></div><div class="section" title="Likes"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec30"/>Likes</h3></div></div></div><p>In<a id="id399" class="indexterm"/> this application, users will also be able to indicate that they like a particular share. Similar to our <code class="literal">followers</code> table, the <code class="literal">likes</code> table will only contain the primary keys of the <code class="literal">users</code> and the <code class="literal">shares</code> table. Our database table will look as follows:</p><div class="informalexample"><pre class="programlisting">ID INTEGER PRIMARY KEY
user_id INTEGER
share_id INTEGER
created INTEGER
updated INTEGER</pre></div></div></div><div class="section" title="Shares"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec80"/>Shares</h2></div></div></div><p>The <a id="id400" class="indexterm"/>second component of our application will be the shares<a id="id401" class="indexterm"/> that users create. For our purposes, we will define a share as a piece of text that can contain unique markers such as the <code class="literal">@</code> sign for mentioning other users, and the <code class="literal">#</code> character for tagging a share. Shares can also be in reply to another share, which will allow them to be viewed on the share's view page. Finally, shares can be reshared users who wish to share another user's share with their network. Our database table will look as follows:</p><div class="informalexample"><pre class="programlisting">ID INTEGER PRIMARY KEY
text STRING
author_id INTEGER
reshare_id INTEGER
reply_id INTEGER
created INTEGER
updated INTEGER</pre></div></div></div>
<div class="section" title="Initializing the project"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec43"/>Initializing the project</h1></div></div></div><p>By now, you <a id="id402" class="indexterm"/>should be comfortable with creating projects from scratch. To provide us with a common starting ground, a skeleton project has been included with the project resources for this chapter. Included with this skeleton project are the necessary migrations, data files, controllers, and views that we need to get started. The login system that we'll be using for authentication throughout this chapter is also included. Copy the skeleton project from the project resources folder to your web server and configure it so that it responds to <code class="literal">chapter5.example.com</code> as outlined at the beginning of the chapter, and then perform the following steps to make sure everything is set up:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Adjust the permissions on the <code class="literal">assets</code> and <code class="literal">protected/runtime</code> folders so that they are writable by your web server.</li><li class="listitem">Next, create the MySQL user and database table that our application will use. If you don't want to alter the provided main configuration file, the following MySQL commands will create the database and user for you:<div class="informalexample"><pre class="programlisting">CREATE USER 'ch5_socialii'@'localhost' IDENTIFIED BY ''ch5_socialii'';
CREATE DATABASE IF NOT EXISTS  `'ch5_socialii'` ;
GRANT ALL PRIVILEGES ON  `'ch5\_socialii'` . * TO  ''ch5_socialii''@'localhost';
FLUSH PRIVILEGES;</pre></div></li><li class="listitem">Next, we'll need to run the initial migrations and then import the sample data that is provided in the <code class="literal">protected/data</code> folder. This sample data will allow us to immediately log in to our application and start using it once the application is running. Navigate to the root of the project, and then run the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>php protected/yiic.php migrate up --interactive=0</strong></span>
<span class="strong"><strong>mysql –u ch5_socialii –pch5_socialii ch5_socialii &lt; protected/data/combined.sql</strong></span>
</pre></div></li><li class="listitem">Then, we will need to update <code class="literal">params.php</code> located at <code class="literal">protected/config/</code> with our SendGrid information. Your username and password will correspond to your SendGrid username and password. Keeping in line with our example domain, set the <code class="literal">from</code> address to <code class="literal">socialii@chapter5.example.com</code>.</li><li class="listitem">Finally, we will need to install the necessary Composer dependencies:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>composer install</strong></span>
</pre></div></li></ol></div><p>At this point, you should be able to open <code class="literal">http://chapter5.example.com</code> in your browser and see <a id="id403" class="indexterm"/>the following page:</p><div class="mediaobject"><img src="graphics/7734OS_05_03.jpg" alt="Initializing the project"/></div><div class="section" title="Making a better Yii bootstrap file"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec81"/>Making a better Yii bootstrap file</h2></div></div></div><p>One thing you may <a id="id404" class="indexterm"/>have noticed was that we didn't have to declare where the Yii framework was located for our site to work. That's because we included Yii framework as a dependency in our <code class="literal">composer.json</code> file, as follows:</p><div class="informalexample"><pre class="programlisting">"yiisoft/yii": "1.1.14"</pre></div><p>There are several benefits<a id="id405" class="indexterm"/> to including Yii as a dependency in our project rather than hardcoding it in our bootstrapper, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Including it in our bootstrapper as a Composer dependency means that we don't have to bother installing Yii framework on our server before we push our code to it</li><li class="listitem" style="list-style-type: disc">We can now automate our deployment process, and be certain that the dependencies in our development environment match those of our production environment</li><li class="listitem" style="list-style-type: disc">The code used for this project is now separate from other projects that might also use Yii framework</li><li class="listitem" style="list-style-type: disc">Finally, this separation allows us to upgrade Yii or use a different fork of Yii without having to worry about how we're going to deploy Yii framework to our server—Composer will simply take care of the installation for us</li></ul></div><p>We've also made a few improvements and changes to our Bootstrap file to make developing and debugging easier for us. Let's take a look at the changes in our <code class="literal">index.php</code> file:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we include our configuration file:<div class="informalexample"><pre class="programlisting">$config=require dirname(__FILE__).'/protected/config/main.php';
defined('DS') or define('DS', DIRECTORY_SEPARATOR);</pre></div></li><li class="listitem">Next, we're going to set <code class="literal">YII_DEBUG</code> and <code class="literal">YII_TRACE</code> to variables that are defined in our <code class="literal">main.php</code> file at <code class="literal">protected/config/</code>. This will allow us to toggle the debug mode and the trace level without having to alter the code in <code class="literal">index.php</code>:<div class="informalexample"><pre class="programlisting">defined('YII_DEBUG') or define('YII_DEBUG',isset($config['params']['debug']) ? $config['params']['debug'] : false);
defined('YII_TRACE_LEVEL') or define('YII_TRACE_LEVEL',isset($config['params']['trace']) ? $config['params']['trace'] : 0);</pre></div></li><li class="listitem">In <a id="id406" class="indexterm"/>our <code class="literal">main.php</code> file at <code class="literal">protected/config/</code>, we can toggle these variables by setting <code class="literal">params[debug]</code> and <code class="literal">params[trace]</code>:<div class="informalexample"><pre class="programlisting">'params' =&gt; array(
   'includes' =&gt; require __DIR__ . '/params.php',
   'debug' =&gt; true,
   'trace' =&gt; 3
)</pre></div></li><li class="listitem">Then, we're going to load our Composer dependencies. Depending on whether <code class="literal">YII_DEBUG</code> is set or not, load <code class="literal">yii.php</code> or <code class="literal">yiilite.php</code>. For most configurations, and when coupled with APC Cache or Zend OPcache, <code class="literal">yiilite.php</code> should improve the performance of your application:<div class="informalexample"><pre class="programlisting">require_once(__DIR__ . '/vendor/autoload.php');
require(__DIR__.DS.'vendor'.DS.'yiisoft'.DS.'yii'.DS.'framework'.DS.(YII_DEBUG ? 'yii.php' : 'yiilite.php'));</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note23"/>Note</h3><p>If you want to learn more <a id="id407" class="indexterm"/>about yiilite, take a look at the official Yii documentation at <a class="ulink" href="http://www.yiiframework.com/doc/guide/1.1/en/topics.performance#using-x-9x">http://www.yiiframework.com/doc/guide/1.1/en/topics.performance#using-x-9x</a>.</p></div></div></li><li class="listitem">Next, we're going to automatically enable logging, and turn error reporting to its maximum value when we're in the debug mode. This will allow us to easily view full stack traces when an error occurs and get detailed log messages about what's going on in our application. This option will help with development and won't be loaded when we are running in a production environment:<div class="informalexample"><pre class="programlisting">if (YII_DEBUG &amp;&amp; YII_TRACE_LEVEL == 3)
{
   error_reporting(-1);
   ini_set('display_errors', 'true');

   // Enable WebLogRouteLogging
   $config['preload'][] = 'log';
   $config['components']['log']['routes'][0]['enabled'] = true;
}</pre></div></li><li class="listitem">For the <a id="id408" class="indexterm"/>preceding step to work, we then need to define a logging method that we want to use. In our development environment, it makes sense to use <code class="literal">CWebLogRoute</code> so that we can see our log messages in our browser. To enable this route, we'll add the following to the components section of our <code class="literal">main.php</code> file located at <code class="literal">protected/config/</code>:<div class="informalexample"><pre class="programlisting">'log' =&gt; array(
   'class' =&gt; 'CLogRouter',
      'routes' =&gt; array(
      array(
         'class' =&gt; 'CWebLogRoute',
         'levels' =&gt; 'error, warning, trace, info',
         'enabled' =&gt; false
      )
   )
)</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note24"/>Note</h3><p>Yii provides several different logging methods that you can use in both production and development environments. To learn more about<a id="id409" class="indexterm"/> logging, take a look at the official <a id="id410" class="indexterm"/>Yii documentation at <a class="ulink" href="http://www.yiiframework.com/doc/guide/1.1/en/topics.logging">http://www.yiiframework.com/doc/guide/1.1/en/topics.logging</a>.</p></div></div></li><li class="listitem">Finally, we're going to bootstrap our application:<div class="informalexample"><pre class="programlisting">Yii::createWebApplication($config)-&gt;run();</pre></div></li></ol></div></div></div>
<div class="section" title="Enabling users to manage their information"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec44"/>Enabling users to manage their information</h1></div></div></div><p>In the previous chapters, our <a id="id411" class="indexterm"/>users haven't been able to do much besides interacting with content. In this chapter, we'll be expanding upon the base User model so that they can register with our application, securely activate their accounts, reset their passwords if they forget them, and change their e-mail address.</p><div class="section" title="Upgrading our UserIdentity class"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec82"/>Upgrading our UserIdentity class</h2></div></div></div><p>Before <a id="id412" class="indexterm"/>implementing the previously mentioned functionality, we need to make sure that we can address our users appropriately without having to ask our database for some basic information about the currently logged-in user. To do this, we're going to add some information to our <code class="literal">UserIdentity.php</code> file located at <code class="literal">protected/components/</code> as shown next in the highlighted sections of our <code class="literal">authenticate()</code> method. Additionally, we're going to enhance this class so that if <code class="literal">YII_DEBUG</code> is enabled, we can get more information about what is going on if authentication fails:</p><div class="informalexample"><pre class="programlisting">public function authenticate()
{
   $record = User::model()-&gt;findByAttributes(array('email'=&gt;$this-&gt;username));

   if ($record == NULL)
      <span class="strong"><strong>$this-&gt;errorCode = YII_DEBUG ? this-&gt;errorCode=self::ERROR_USERNAME_INVALID : self::ERROR_UNKNOWN_IDENTITY;</strong></span>
   else if (password_verify($this-&gt;password, $record-&gt;password))
   {
      $this-&gt;errorCode = self::ERROR_NONE;
      $this-&gt;_id        = $record-&gt;id;
      $this-&gt;setState('email', $record-&gt;email);
      $this-&gt;setState('role', $record-&gt;role_id);
      <span class="strong"><strong>$this-&gt;setState('username', $record-&gt;username);</strong></span>
      <span class="strong"><strong>$this-&gt;setState('name', $record-&gt;name);</strong></span>
   }
   else
      <span class="strong"><strong>$this-&gt;errorCode = YII_DEBUG ? self::ERROR_PASSWORD_INVALID : self::ERROR_UNKNOWN_IDENTITY;</strong></span>

   return !$this-&gt;errorCode;
}</pre></div></div><div class="section" title="Defining user relations"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec83"/>Defining user relations</h2></div></div></div><p>Next, we'll <a id="id413" class="indexterm"/>want to make sure that our relations are set up so that we can tell which data is associated with our users. This includes shares, followers, and followees. Within our <code class="literal">protected/models/User.php</code> file, make sure the following is set to our <code class="literal">relations()</code> method:</p><div class="informalexample"><pre class="programlisting">return array(
   'followees' =&gt; array(self::HAS_MANY, 'Follower', 'followee_id'),
   'followers' =&gt; array(self::HAS_MANY, 'Follower', 'follower_id'),
   'shares' =&gt; array(self::HAS_MANY, 'Share', 'author_id'),
   'role' =&gt; array(self::BELONGS_TO, 'Role', 'role_id'),
);</pre></div><p>We're also going to add a new relational type to our <code class="literal">relations()</code> method so that we can quickly retrieve the number of shares, followers, and followees a user has. This relation type is called <code class="literal">STAT</code>, and behaves the same as a <code class="literal">HAS_MANY</code> relation, except that it performs a count at the database level and returns a number rather than returning an array of objects:</p><div class="informalexample"><pre class="programlisting">'followeesCount' =&gt; array(self::STAT, 'Follower', 'followee_id'),
'followersCount' =&gt; array(self::STAT, 'Follower', 'follower_id'),
'sharesCount' =&gt; array(self::STAT, 'Share', 'author_id')</pre></div><p>By using the <code class="literal">STAT</code> relation, we can reduce the strain on our database when we want to know how many followers a user has. In a small database with a few users, a <code class="literal">HAS_MANY</code> relationship isn't very significant; however, when dealing with thousands of users, repeatedly running a <code class="literal">HAS_MANY</code> query will result in a large number of results to be returned, which can result in our application running out of memory and crashing.</p><div class="section" title="Determining whether a user is following another user"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec31"/>Determining whether a user is following another user</h3></div></div></div><p>The last change <a id="id414" class="indexterm"/>we need to make to our model for our relations is to add a quick method that will allow us to determine whether the currently logged-in user is following another user. We'll use this information later on to adjust what's displayed in our views. Add the following method to your <code class="literal">User.php</code> file located at <code class="literal">protected/models/</code>:</p><div class="informalexample"><pre class="programlisting">public static function isFollowing($id=NULL)
{
   if ($id == NULL || Yii::app()-&gt;user-&gt;isGuest)
      return false;

   $following = Follower::model()-&gt;findByAttributes(array('follower_id' =&gt; Yii::app()-&gt;user-&gt;id, 'followee_id' =&gt; $id));

   return $following != NULL;
}</pre></div></div></div><div class="section" title="Implementing a secure registration process"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec84"/>Implementing a secure registration process</h2></div></div></div><p>One of the<a id="id415" class="indexterm"/> more difficult parts of creating a secure web application is ensuring that the users who register on our site are really the users they claim to be. Often, this is accomplished by sending an e-mail to the user with a unique single-use token. If the user is able to visit our site with that secure token, we can assume that they are real users, and that they have access to the e-mail address. By employing this method of validation, we can ensure that the users who register on our site are who they claim to be, and that they choose to engage with our application.</p><p>While we could handle the majority of this functionality directly within our controller and bloat our User model with unnecessary methods, our tool of choice for this task will be <code class="literal">CFormModel</code>. In this book, we've only utilized <code class="literal">CFormModel</code> for our <code class="literal">LoginForm</code> model, which we've been using for logging users in. Before moving forward, let's take a deeper look into what <code class="literal">CFormModel</code> is and explore how we can use it.</p><p>
<code class="literal">CFormModel</code><a id="id416" class="indexterm"/> is very similar to <code class="literal">CActiveRecord</code>, in that it extends <code class="literal">CModel</code> and inherits many of the methods that <code class="literal">CActiveRecord</code> has, such as <code class="literal">attributeLabels</code>, <code class="literal">attributes</code>, and <code class="literal">rules</code>. The primary difference between <code class="literal">CFormModel</code> and <code class="literal">CActiveRecord</code> is that <code class="literal">CFormModel</code> is used to collect information from an HTML form, and the data submitted to <code class="literal">CFormModel</code> is acted upon rather than stored and manipulated in a database. By taking advantage of the methods inherited from <code class="literal">CModel</code>, we can cleanly and easily use <code class="literal">CFormModel</code> to validate input and reduce the amount of code clutter in our controllers and models.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note25"/>Note</h3><p>To learn more about <code class="literal">CFormModel</code>, check out the official Yii documentation at <a class="ulink" href="http://www.yiiframework.com/doc/api/1.1/CFormModel">http://www.yiiframework.com/doc/api/1.1/CFormModel</a>.</p></div></div><p>To get started, create a new file in <code class="literal">protected/models/RegistrationForm.php</code> and add the following to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php class RegistrationForm extends CFormModel {}</pre></div><p>The next steps are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first <a id="id417" class="indexterm"/>item we'll be placing in this class is our attributes. These model attributes are publicly exposed, and can be set from our controllers:<div class="informalexample"><pre class="programlisting">public $email;
public $name;
public $password;
public $username;</pre></div></li><li class="listitem">Next, we'll define our attribute labels for these attributes:<div class="informalexample"><pre class="programlisting">public function attributeLabels()
{
   return array(
      'email' =&gt; 'Your Email Address',
      'name' =&gt; 'Your Full Name',
      'password' =&gt; 'Your Password',
      'username' =&gt; 'Your Username'
   );
}</pre></div></li><li class="listitem">Then, we'll want to set up our validation rules. For new users, we want to verify that all attributes are set, the e-mail address is a valid one, the password is at least <code class="literal">8</code> characters long, and the username the user's trying to register with is not already taken:<div class="informalexample"><pre class="programlisting">public function rules()
{
   return array(
      array('email, username, name, password', 'required'),
      array('password', 'length', 'min'=&gt;8),
      array('email', 'email'),
      array('username', 'validateUsername') ,
      array('email', 'verifyEmailIsUnique')
   );
}</pre></div></li><li class="listitem">Since Yii doesn't provide a native validator for usernames, we will then need to define our own <code class="literal">validateUsername()</code> method, which will do a simple existence check against our database:<div class="informalexample"><pre class="programlisting">public function validateUsername($attributes, $params)
{
   $user = User::model()-&gt;findByAttributes(array('username' =&gt; $this-&gt;username));

   if ($user === NULL)
      return true;
   else
   {
      $this-&gt;addError('username', 'That username has already been registered');
      return false;
   }
}</pre></div></li><li class="listitem">We'll also <a id="id418" class="indexterm"/>want to define a validator to ensure that our e-mail address is not already taken:<div class="informalexample"><pre class="programlisting">public function verifyEmailIsUnique($attributes, $params)
{
   $user = User::model()-&gt;findByAttributes(array('email' =&gt; $this-&gt;email));

   if ($user === NULL)
      return true;
   else
   {
      $this-&gt;addError('email', 'That email address has already been registered');
      return false;
   }
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note26"/>Note</h3><p>Notice that when validation fails, we're not only returning false but also adding an error to our model. We're doing this for three reasons: to enhance the user experience and ensure that the user knows what went wrong, to ensure that the <code class="literal">validate()</code> method of <code class="literal">CModel</code> fails when an error is thrown (it will return true unless <code class="literal">$this-&gt;addError()</code> is called), and to ensure that we can run these validators independently of the form.</p></div></div></li><li class="listitem">Out of preference, the last method we'll be creating is a <code class="literal">save()</code> method, which will perform the validation, send a verification e-mail to the user, and insert the new record into our database. To achieve this, start by creating a new method called <code class="literal">save()</code>:<div class="informalexample"><pre class="programlisting">public function save()</pre></div><p>Then, within the method, first perform the validation:</p><div class="informalexample"><pre class="programlisting">if (!$this-&gt;validate())
return false;</pre></div><p>Then, create a new <code class="literal">User</code> object:</p><div class="informalexample"><pre class="programlisting">$user = new User;
$user-&gt;attributes = array(
   'email' =&gt; $this-&gt;email,
   'name' =&gt; $this-&gt;name,
   'password' =&gt; $this-&gt;password,
   'username' =&gt; str_replace(' ', '',$this-&gt;username),
   'activated' =&gt; 0
);</pre></div><p>Then, attempt <a id="id419" class="indexterm"/>to save the user and send that user an e-mail address with the activation details:</p><div class="informalexample"><pre class="programlisting">if ($user-&gt;save())
{
   // Send an email to the user
   $sendgrid = new SendGrid(Yii::app()-&gt;params['includes']['sendgrid']['username'], Yii::app()-&gt;params['includes']['sendgrid']['password']);
   $email    = new SendGrid\Email();

   $email-&gt;setFrom(Yii::app()-&gt;params['includes']['sendgrid']['from'])
      -&gt;addTo($user-&gt;email)
      -&gt;setSubject("Activate Your Socialii Account")
      -&gt;setText('Activate Your Socialii Account')
      -&gt;setHtml(Yii::app()-&gt;controller-&gt;renderPartial('//email/activate', array('user' =&gt; $user), true));

   // Send the email
   $sendgrid-&gt;send($email);

   // Return true if we get to this point
   return true;
}</pre></div></li><li class="listitem">Next, we'll want to update our User models so that the activation key is set when the user is <a id="id420" class="indexterm"/>first created. To generate the activation key, we'll be using a library that was included in our <code class="literal">composer.json</code> file that securely generates strings:<div class="informalexample"><pre class="programlisting">public function beforeSave()
{
   if ($this-&gt;isNewRecord)
   {
      $this-&gt;generateActivationKey();
      $this-&gt;role_id = 1;
   }

   return parent::beforeSave();
}

public function generateActivationKey()
{
   $factory = new CryptLib\Random\Factory;
   $this-&gt;activation_key = $factory-&gt;getHighStrengthGenerator()-&gt;generateString(16);
   return $this-&gt;activation_key;
}</pre></div></li><li class="listitem">Now, we can add a register action to our <code class="literal">UserController.php</code> file located at <code class="literal">protected/controllers/</code> that will allow the user to register with our site. Since majority of the work has already been done in our form, all we have to do is collect the data from the <code class="literal">$_POST</code> request, apply it to the model, and call the <code class="literal">save()</code> method on the model. To provide a better user experience, we can also attempt to automatically log the user in using their new credentials:<div class="informalexample"><pre class="programlisting">public function actionRegister()
{
   // Authenticated users shouldn't be able to register
   if (!Yii::app()-&gt;user-&gt;isGuest)
   $this-&gt;redirect($this-&gt;createUrl('timeline/index'));

   $form = new RegistrationForm;
   if (isset($_POST['RegistrationForm']))
   {
      $form-&gt;attributes = $_POST['RegistrationForm'];

      // Attempt to save the user's information
      if ($form-&gt;save())
      {
         // Try to automagically log the user in, if we fail though just redirect them to the login page
         $model = new LoginForm;
         $model-&gt;attributes = array(
            'username' =&gt; $form-&gt;email,
            'password' =&gt; $form-&gt;password
         );

         if ($model-&gt;login())
         {
            // Set a flash message associated to the new Yii::app()-&gt;user
            Yii::app()-&gt;user-&gt;setFlash('sucess', 'You successfully registred an account!');

            // Then redirect to their timeline
            $this-&gt;redirect($this-&gt;createUrl('timeline/index'));
         }
         else
            $this-&gt;redirect($this-&gt;createUrl('site/login'));
      }
   }

   $this-&gt;render('register', array('user' =&gt; $form));
}</pre></div></li><li class="listitem">Then, from<a id="id421" class="indexterm"/> the project resources folder, copy the following view files into your project: <code class="literal">protected/views/user/register.php</code>, <code class="literal">protected/views/email/activate.php</code>, and <code class="literal">protected/views/site/index.php</code>. Now, either from the <code class="literal">site/index</code> or <code class="literal">user/register</code> route, you can register a new account in your site.</li><li class="listitem">Finally, create a new method in your <code class="literal">UserController.php</code> file located at <code class="literal">protected/controllers/</code> called <code class="literal">actionActivate()</code> that will actually activate our user. To do so, we're simply going to verify that the ID parameter sent to us in the route matches with what we have on file for the user:<div class="informalexample"><pre class="programlisting">public function actionActivate($id=NULL)
{
   if ($id == NULL)
      throw new CHttpException(400, 'Activation ID is missing');

   $user = User::model()-&gt;findByAttributes(array('activation_key' =&gt; $id));

   if ($user == NULL)
      throw new CHttpException(400, 'The activation ID you supplied is invalid');

   // Don't allow activations of users who have a password reset request OR have a change email request in
   // Email Change Requests and Password Reset Requests require an activated account
   if ($user-&gt;activated == -1 || $user-&gt;activated == -2)
      throw new CHttpException(400, 'There was an error fulfilling your request');

   $user-&gt;activated = 1;
   $user-&gt;password = NULL;           // Don't reset the password
   $user-&gt;activation_key = NULL;     // Prevent reuse of their activation key

   if ($user-&gt;save())
   {
      $this-&gt;render('activate');
      Yii::app()-&gt;end();
   }

   throw new CHttpException(500, 'An error occurring activating your account. Please try again later');
}</pre></div></li></ol></div><p>We can also<a id="id422" class="indexterm"/> reuse the form we just created on our home page to allow users to log in or register a new account from there. Since we've already copied the view over, we simply need to adjust the <code class="literal">SiteController</code> <code class="literal">actionIndex()</code> method:</p><div class="informalexample"><pre class="programlisting">public function actionIndex()
{
   if (!Yii::app()-&gt;user-&gt;isGuest)
      $this-&gt;redirect($this-&gt;createUrl('timeline/index'));

   $this-&gt;layout = 'main';
   $this-&gt;render('index', array('loginform' =&gt; new LoginForm, 'user' =&gt; new RegistrationForm));
}</pre></div></div><div class="section" title="Handling forgotten passwords"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec85"/>Handling forgotten passwords</h2></div></div></div><p>As previously<a id="id423" class="indexterm"/> shown, using <code class="literal">CFormModel</code> to handle input from an HTML form makes it very easy to validate submitted information and act upon it while keeping our models and controllers very clear. We can once again use <code class="literal">CFormModel</code> to handle forgotten password requests from a user.</p><p>To handle forgotten passwords, we're going to request that the user provides us with the e-mail address they used to register their account. Next, we'll verify that we have an e-mail address on file, and then send the user an e-mail with a single use token that will allow them to securely reset their password. To start, create a new file called <code class="literal">ForgotForm.php</code> in <code class="literal">protected/models</code> and add the following to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php class ForgotForm extends CFormModel {}</pre></div><p>The next steps are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Begin by declaring the public attributes of our form:<div class="informalexample"><pre class="programlisting">public $email;
public function attributeLabels()
{
   return array(
      'email' =&gt; 'Your Email Address'
   );
}</pre></div></li><li class="listitem">We're also going to declare a private property for our User model that we'll be reusing throughout this model:<div class="informalexample"><pre class="programlisting">private $_user;</pre></div></li><li class="listitem">Next, we'll declare our validation rules and custom validator:<div class="informalexample"><pre class="programlisting">public function rules()
{
   return array(
      array('email', 'required'),
      array('email', 'email'),
      array('email', 'checkUser'),
   );
}

public function checkUser($attribute,$params)
{
   $this-&gt;_user = User::model()-&gt;findByAttributes(array('email' =&gt; $this-&gt;email));

   if ($this-&gt;_user == NULL)
   {
      $this-&gt;addError('email', 'There is no user in our system with that email address.');
      return false;
   }

   return true;
}</pre></div></li><li class="listitem">Then, we<a id="id424" class="indexterm"/> will declare our <code class="literal">save()</code> method that will send the user the e-mail and indicate that they have asked for their password to be reset:<div class="informalexample"><pre class="programlisting">public function save()
{
   if (!$this-&gt;validate())
      return false;

   // Set the activation details
   $this-&gt;_user-&gt;generateActivationKey();
   $this-&gt;_user-&gt;activated = -1;

   if ($this-&gt;_user-&gt;save())
   {
      $sendgrid = new SendGrid(Yii::app()-&gt;params['includes']['sendgrid']['username'], Yii::app()-&gt;params['includes']['sendgrid']['password']);
      $email    = new SendGrid\Email();

      $email-&gt;setFrom(Yii::app()-&gt;params['includes']['sendgrid']['from'])
         -&gt;addTo($this-&gt;_user-&gt;email)
         -&gt;setSubject('Reset Your Socialii Password')
         -&gt;setText('Reset Your Socialii Password')
         -&gt;setHtml(Yii::app()-&gt;controller-&gt;renderPartial('//email/forgot', array('user' =&gt; $this-&gt;_user), true));

      // Send the email
      $sendgrid-&gt;send($email);

      return true;
   }
   else
      $this-&gt;addError('email', 'Unable to send reset link. This is likely a temporary error. Please try again in a few minutes.');

   return false;
}</pre></div></li><li class="listitem">Then, create <a id="id425" class="indexterm"/>an action in <code class="literal">protected/controllers/UserController.php</code> to handle the form submission:<div class="informalexample"><pre class="programlisting">public function actionForgot()
{
   $form = new ForgotForm;

   if (isset($_POST['ForgotForm']))
   {
      $form-&gt;attributes = $_POST['ForgotForm'];

      if ($form-&gt;save())
      {
         $this-&gt;render('forgot_success');
         Yii::app()-&gt;end();
      }
   }

   $this-&gt;render('forgot', array('forgotform' =&gt; $form));
}</pre></div></li><li class="listitem">Finally, copy <code class="literal">protected/views/user/forgot.php</code>, <code class="literal">protected/views/user/forgot_success.php</code> and <code class="literal">protected/views/email/forgot.php</code> from <a id="id426" class="indexterm"/>the project resources folder into your application.</li></ol></div></div><div class="section" title="Resetting a forgotten password"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec86"/>Resetting a forgotten password</h2></div></div></div><p>Once the <a id="id427" class="indexterm"/>user has the single-use token we sent them, we can then allow the user to securely change their password to whatever they want. Start by creating a new file in <code class="literal">protected/models</code> called <code class="literal">PasswordResetform.php</code> with the following:</p><div class="informalexample"><pre class="programlisting">&lt;?php class PasswordResetForm extends CFormModel {}</pre></div><p>The next steps are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Begin by declaring the public attributes for this form:<div class="informalexample"><pre class="programlisting">public $password;
public $pasword_repeat;
public $user;</pre></div></li><li class="listitem">Then, add the validation rules. The user's new password should have the same requirements as when the user registered. Since we're requesting the password twice, we'll want to compare the two passwords using the compare validator. This validator validates the first attribute against the <code class="literal">attribute_repeat</code> attribute:<div class="informalexample"><pre class="programlisting">public function rules()
{
   return array(
      array('password', 'length', 'min' =&gt; 8),
      array('password, password_repeat, user', 'required'),
      array('password', 'compare', 'compareAttribute' =&gt; 'password_repeat'),
   );
}</pre></div></li><li class="listitem">Then, add the <code class="literal">save()</code> method to reset the user's password:<div class="informalexample"><pre class="programlisting">public function save()
{
   if (!$this-&gt;validate())
      return false;

   $this-&gt;user-&gt;password = $this-&gt;password;

   // Verify that this activation key can't be used again
   $this-&gt;user-&gt;activated = 1;
   $this-&gt;user-&gt;activation_key = NULL;

   if ($this-&gt;user-&gt;save())
      return true;

   return false;
}</pre></div></li><li class="listitem">Then, create <a id="id428" class="indexterm"/>our controller action:<div class="informalexample"><pre class="programlisting">public function actionResetPassword($id = NULL)
{
   if ($id == NULL)
      throw new CHttpException(400, 'Missing Password Reset ID');

   $user = User::model()-&gt;findByAttributes(array('activation_key' =&gt; $id));

   if ($user == NULL)
      throw new CHttpException(400, 'The password reset id you supplied is invalid');

   $form = new PasswordResetForm;

   if (isset($_POST['PasswordResetForm']))
   {
      $form-&gt;attributes = array(
         'user' =&gt; $user,
         'password' =&gt; $_POST['PasswordResetForm']['password'],
         'password_repeat' =&gt; $_POST['PasswordResetForm']['password_repeat']
      );

      if ($form-&gt;save())
      {
         $this-&gt;render('resetpasswordsuccess');
         Yii::app()-&gt;end();
      }
   }

   $this-&gt;render('resetpassword', array(
      'passwordresetform' =&gt; $form,
      'id' =&gt; $id
   ));
}</pre></div></li><li class="listitem">Finally, copy <code class="literal">protected/views/user/resetpassword.php</code> and <code class="literal">protected/views/user/resetpassword_success.php</code> from the project resources <a id="id429" class="indexterm"/>folder into your application.</li></ol></div></div><div class="section" title="Enabling users to manage their details"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec87"/>Enabling users to manage their details</h2></div></div></div><p>At this<a id="id430" class="indexterm"/> point, we can now log in, register an account, and reset our passwords if we forgot them. Now, let's work on allowing users to manage their own details. This includes allowing them to change their password, e-mail address, and the other pieces of information that we collect during the registration process. The steps are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We'll start by once again creating a new <code class="literal">CFormModel</code> in <code class="literal">protected/models</code> called <code class="literal">ProfileForm.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php class ProfileForm extends CFormModel {}</pre></div></li><li class="listitem">Then, we'll add our attributes and labels:<div class="informalexample"><pre class="programlisting">public $email;
public $password;
public $name;
public $newpassword = NULL;
public $newpassword_repeat = NULL;
private $_user;
public function attributeLabels()
 {
    return array(
       'email'               =&gt; 'Your New Email Address',
       'password'            =&gt; 'Your Current Password',
       'name'                =&gt; 'Your Name',
       'newpassword'         =&gt; 'Your NEW password',
       'newpassword_repeat'  =&gt; 'Your NEW password (again)'
    );
 }</pre></div></li><li class="listitem">We'll then add our basic validation rules:<div class="informalexample"><pre class="programlisting">public function rules()
{
   return array(
      array('email, name, password', 'required'),
      array('newpassword', 'length', 'min' =&gt; 8),
      array('email', 'email'),
      array('password', 'verifyPassword'),
      array('newpassword', 'compare', 'compareAttribute' =&gt; 'newpassword_repeat')
   );
}</pre></div></li><li class="listitem">Before <a id="id431" class="indexterm"/>allowing the user to change any of their information (including their password and e-mail address), we're going to require them to enter their current password. This will validate that they have control over the account:<div class="informalexample"><pre class="programlisting">public function verifyPassword($attribute,$params)
{
   // Only allow change requests from the currently logged inuser
   $this-&gt;_user = User::model()-&gt;findByPk(Yii::app()-&gt;user-&gt;id);

   // User doesn't exist. Something bad has happened
   if ($this-&gt;_user == NULL)
      return false;

   // NULL the new password if it isn't set
   if ($this-&gt;newpassword == '' || $this-&gt;newpassword == NULL)
      $this-&gt;newpassword == NULL;

   // Validate the password
   if (!password_verify($this-&gt;password, $this-&gt;_user-&gt;password))
   {
      $this-&gt;addError('password', 'The password you entered is invalid');
      return false;
   }
   return true;
}</pre></div></li><li class="listitem">We'll then<a id="id432" class="indexterm"/> add our <code class="literal">save()</code> method that will update the user's information:<div class="informalexample"><pre class="programlisting">public function save()
{
   if (!$this-&gt;validate())
      return false;

   // Set the user attributes
   $this-&gt;_user-&gt;attributes = array(
      // If the email submitted is different than the current email, change the new_email field
      'new_email' =&gt; $this-&gt;email == $this-&gt;_user-&gt;email ? NULL : $this-&gt;email,

      // Set the new password if validation passes
      'password' =&gt; $this-&gt;newpassword == NULL ? NULL : $this-&gt;newpassword,
      'name' =&gt; $this-&gt;name
   );

   // Save the user's information
   if ($this-&gt;_user-&gt;save())
   {
      // If the user's password has changed, send the user an email so that they can be aware of it
      if ($this-&gt;newpassword != NULL &amp;&amp; $this-&gt;password != $this-&gt;newpassword)
         $this-&gt;sendPasswordChangeNotification();

      // If the user entered a NEW email address, and we haven't already sent them a change email notification
      // Send them a change email notification
      if ($this-&gt;email != $this-&gt;_user-&gt;_oldAttributes['email'] &amp;&amp; $this-&gt;_user-&gt;activated != -2)
         $this-&gt;sendEmailChangeNotification();

      return true;
   }

   return false;
}</pre></div></li><li class="listitem">In the <code class="literal">save()</code> method, we <a id="id433" class="indexterm"/>declared two new methods: <code class="literal">sendPasswordChangeNotification()</code> and <code class="literal">sendEmailChangeNotification()</code>. These two methods will send e-mails to the user when the event occurs:<div class="informalexample"><pre class="programlisting">private function sendPasswordChangeNotification()
{
   $sendgrid = new SendGrid(Yii::app()-&gt;params['includes']['sendgrid']['username'], Yii::app()-&gt;params['includes']['sendgrid']['password']);
   $email    = new SendGrid\Email();

   $email-&gt;setFrom(Yii::app()-&gt;params['includes']['sendgrid']['from'])
      -&gt;addTo($this-&gt;_user-&gt;email)
      -&gt;setSubject("Your Socialii Password Has Been Changed")
      -&gt;setText('Your Socialii Password Has Been Changed')
      -&gt;setHtml(Yii::app()-&gt;controller-&gt;renderPartial('//email/passwordchange', array('user' =&gt; $this-&gt;_user), true));

   // Send the email
   return $sendgrid-&gt;send($email);
}</pre></div></li><li class="listitem">The second method, <code class="literal">sendEmailChangeNotification()</code> sends an e-mail to the user when the user's e-mail address changes. This allows us to verify their new e-mail address before we start using it in our application:<div class="informalexample"><pre class="programlisting">private function sendEmailChangeNotification()
{
   // Change the user's activation status for the verification link
   $this-&gt;_user-&gt;activated = -2;
   $this-&gt;_user-&gt;activation_key = $this-&gt;_user-&gt;generateActivationKey();

   // Save the user's information
   if ($this-&gt;_user-&gt;save())
   {
      $sendgrid = new SendGrid(Yii::app()-&gt;params['includes']['sendgrid']['username'], Yii::app()-&gt;params['includes']['sendgrid']['password']);
      $email    = new SendGrid\Email();

      $email-&gt;setFrom(Yii::app()-&gt;params['includes']['sendgrid']['from'])
         -&gt;addTo($this-&gt;_user-&gt;new_email)
         -&gt;setSubject("Verify Your New Email Address")
         -&gt;setText('Verify Your New Email Address')
         -&gt;setHtml(Yii::app()-&gt;controller-&gt;renderPartial('//email/verify', array('user' =&gt; $this-&gt;_user), true));

      // Send the email
      return $sendgrid-&gt;send($email);
   }

   return false;
}</pre></div></li><li class="listitem">Then, within <a id="id434" class="indexterm"/>our <code class="literal">UserController</code>, we'll define our <code class="literal">actionIndex()</code> method that will collect this information:<div class="informalexample"><pre class="programlisting">public function actionIndex()
{
   $user = User::model()-&gt;findByPk(Yii::app()-&gt;user-&gt;id);
   $form = new ProfileForm;
   if (isset($_POST['ProfileForm']))
   {
      $form-&gt;attributes = $_POST['ProfileForm'];
      $form-&gt;newpassword_repeat = $_POST['ProfileForm']['newpassword_repeat'];

      if ($form-&gt;save())
         Yii::app()-&gt;user-&gt;setFlash('success', 'Your information has been successfully changed');
      else
         Yii::app()-&gt;user-&gt;setFlash('danger', 'There was an error updating your information');
   }

   $this-&gt;render('index', array(
      'user' =&gt; $user,
      'profileform' =&gt; $form
   ));
}</pre></div></li><li class="listitem">Finally, we <a id="id435" class="indexterm"/>need to copy <code class="literal">protected/views/user/index.php</code>, <code class="literal">protected/view/email/passwordchange.php</code> and <code class="literal">protected/views/email/verify.php</code> from our project resources folder into our project.</li></ol></div></div><div class="section" title="Verifying a new e-mail address"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec88"/>Verifying a new e-mail address</h2></div></div></div><p>Now, our<a id="id436" class="indexterm"/> users can change their own information without having to go through us. Before we close <code class="literal">UserController</code>, there are a couple of more methods that we need to implement.</p><p>One secure way of changing a user's e-mail address is to store the new e-mail address in a temporary table or column in our database and then send to that e-mail address a verification e-mail (this is what we implemented in our <code class="literal">ProfileForm</code> class). This allows us to indicate that we're aware that the user wants to change their password, but we require them to prove that they have access to the new e-mail address. The e-mail that we sent them contains a secure activation token and a link to the <code class="literal">actionVerify()</code> method, which will verify that the token belongs to the user, and then move the new e-mail address to the main e-mail address field in our database. We can implement the <code class="literal">actionVerify()</code> method as follows:</p><div class="informalexample"><pre class="programlisting">public function actionVerify($id=NULL)
{
   if ($id == NULL)
      throw new CHttpException(400, 'Activation ID is missing');

   $user = User::model()-&gt;findByAttributes(array('activation_key' =&gt; $id));

   if ($user == NULL)
   throw new CHttpException(400, 'The verification ID you supplied is invalid');

   $user-&gt;attributes = array(
      'email' =&gt; $user-&gt;new_email,
      'new_email' =&gt; NULL,
      'activated' =&gt; 1,
      'activation_key' =&gt; NULL
   );

   // Save the information
   if ($user-&gt;save())
   {
      $this-&gt;render('verify');
      Yii::app()-&gt;end();
   }

   throw new CHttpException(500, 'There was an error processing your request. Please try again later');
}</pre></div><p>The last actions <a id="id437" class="indexterm"/>we'll implement for this controller will allow a user to follow and unfollow another user. We'll use these actions in our views later in the chapter. For now, implement the actions as follows:</p><div class="informalexample"><pre class="programlisting">public function actionFollow($id=NULL)
{
   if ($id == NULL)
      throw new CHttpException(400, 'You must specify the user you wish to follow');

   if ($id == Yii::app()-&gt;user-&gt;id)
      throw new CHttpException(400, 'You cannot follow yourself');

   $follower = new Follower;
   $follower-&gt;attributes = array(
      'follower_id' =&gt; Yii::app()-&gt;user-&gt;id,
      'followee_id' =&gt; $id
   );

   if ($follower-&gt;save())
      Yii::app()-&gt;user-&gt;setFlash('success', 'You are now  following ' . User::model()-&gt;findByPk($id)-&gt;name);

   // Redirect back to where they were before
   $this-&gt;redirect(Yii::app()-&gt;request-&gt;urlReferrer);
}

public function actionUnFollow($id=NULL)
{
   if ($id == NULL)
   throw new CHttpException(400, 'You must specify the user you wish to unfollow');

   if ($id == Yii::app()-&gt;user-&gt;id)
      throw new CHttpException(400, 'You cannot unfollow yourself');

   $follower = Follower::model()-&gt;findByAttributes(array('follower_id' =&gt; Yii::app()-&gt;user-&gt;id, 'followee_id' =&gt; $id));

   if ($follower != NULL)
   {
      if ($follower-&gt;delete())
         Yii::app()-&gt;user-&gt;setFlash('success', 'You are no longer following ' . User::model()-&gt;findByPk($id)-&gt;name);
   }

   // Redirect back to where they were before
   $this-&gt;redirect(Yii::app()-&gt;request-&gt;urlReferrer);
}</pre></div><p>Before closing <a id="id438" class="indexterm"/>this controller, verify that the <code class="literal">accessRules()</code> method is set up correctly:</p><div class="informalexample"><pre class="programlisting">public function accessRules()
{
   return array(
   array('allow',
      'actions' =&gt; array('register', 'forgot', 'verify', 'activate', 'resetpassword'),
      'users' =&gt; array('*')
      ),
      array('allow',
         'actions' =&gt; array('index', 'follow', 'unfollow'),
         'users'=&gt;array('@'),
      ),
      array('deny',  // deny all users
         'users'=&gt;array('*'),
      ),
   );
}</pre></div></div></div>
<div class="section" title="Viewing a timeline of shares"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec45"/>Viewing a timeline of shares</h1></div></div></div><p>The easiest <a id="id439" class="indexterm"/>way to display new content is <a id="id440" class="indexterm"/>to simply list it so that the newest items are shown first. On our timeline page, we want to provide the user with the ability to share something, view information about the user they are viewing (such as the number of shares, followers, and followees), and view things that the user has recently shared. To do this, we're going to take advantage of <code class="literal">CListView</code> loaded asynchronously from our main timeline view. This will allow us to reuse this view later on by simply making a <code class="literal">GET</code> request to an endpoint that we'll create later. In our <code class="literal">TimelineController.php</code> file located at <code class="literal">protected/controllers/</code>, implement<a id="id441" class="indexterm"/> the <code class="literal">actionIndex()</code> method:</p><div class="informalexample"><pre class="programlisting">public function actionIndex($id = NULL)
{
   // If the ID is not set, set this to the currently logged in user.
   if ($id == NULL)
   {
      if (Yii::app()-&gt;user-&gt;isGuest)
         $this-&gt;redirect($this-&gt;createUrl('site/login'));

      $id = Yii::app()-&gt;user-&gt;username;
   }

   // Get the user's information
   $user = User::model()-&gt;findByAttributes(array('username' =&gt; $id));
   if ($user == NULL)
      throw new CHttpException(400, 'Unable to find a user with that ID');

   $this-&gt;render('index', array(
      'user' =&gt; $user,
      'share' =&gt; new Share,
      'id' =&gt; $user-&gt;id
   ));
}</pre></div><p>All that we're doing in this action is retrieving the user ID (in this case, the username of the user) from <a id="id442" class="indexterm"/>the route and then passing some <a id="id443" class="indexterm"/>information down to our view. From the project resources folder, copy the <code class="literal">index.php</code> file located at <code class="literal">protected/views/timeline/</code> into your project. Let's take a look at some of the more interesting parts of this file.</p><p>The first thing to notice in this file is that we're simply using <code class="literal">CActiveForm</code> to display the new share container. Moreover, at the bottom of this file, we've implemented some JavaScript to do some rudimentary form validation checking, to clear the text field upon asynchronous submission, to adjust the number of shares we have, and finally, to prepend the new share to the top of our shares list.</p><p>The second thing to notice is that we've implemented conditional follow and unfollow button links to allow our users to simply click on a link to follow or unfollow a particular user:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (Yii::app()-&gt;user-&gt;isGuest): ?&gt;
   &lt;?php echo CHtml::link('Login to follow ' . $user-&gt;name, $this-&gt;createUrl('site/login'), array('class' =&gt; 'btn btn-primary')); ?&gt;
      &lt;br /&gt;&lt;br /&gt;
   &lt;?php else: ?&gt;
      &lt;?php if (!User::isFollowing($id)): ?&gt;
         &lt;?php echo CHtml::link('Follow This User', $this-&gt;createUrl('user/follow/', array('id' =&gt; $id)), array('class' =&gt; 'btn btn-success')); ?&gt;
      &lt;?php else: ?&gt;
         &lt;?php echo CHtml::link('Stop Following This User', $this-&gt;createUrl('user/unfollow/', array('id' =&gt; $id)), array('class' =&gt; 'btn btn-danger')); ?&gt;
   &lt;?php endif; ?&gt;
&lt;?php endif; ?&gt;</pre></div><p>The last thing to notice in this file is our use of the count relations we set up earlier in our User model:</p><div class="informalexample"><pre class="programlisting">&lt;a type="button" class="btn btn-primary" disabled&gt;Followers: &lt;?php echo $user-&gt;followeesCount; ?&gt;&lt;/a&gt;
&lt;a type="button" class="btn btn-primary" disabled&gt;Following: &lt;?php echo $user-&gt;followersCount; ?&gt;&lt;/a&gt;
&lt;a type="button" class="btn btn-primary" disabled&gt;Shares: &lt;span class="share-count"&gt;&lt;?php echo $user-&gt;sharesCount; ?&gt;&lt;/span&gt;&lt;/a&gt;</pre></div><p>Finally, we're <a id="id444" class="indexterm"/>loading our shares for this user by<a id="id445" class="indexterm"/> registering an asynchronous callback to fetch the appropriate shares, regardless of which user we are viewing the share for:</p><div class="informalexample"><pre class="programlisting">&lt;?php Yii::app()-&gt;clientScript-&gt;registerScript('loadshares', '$.get("' . $this-&gt;createUrl('share/getshares', array('id' =&gt; $id)) . '", function(data) { $(".shares").html(data); }); '); ?&gt;</pre></div><div class="section" title="Retrieving shares"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec89"/>Retrieving shares</h2></div></div></div><p>Now, let's <a id="id446" class="indexterm"/>implement our action that will display our shares. This action will have slightly different behaviors depending on whether we're viewing our timeline or a timeline of another user. Within our <code class="literal">ShareController.php</code> file located at <code class="literal">protected/controllers/</code>, implement <code class="literal">actionGetShares</code>, as follows:</p><div class="informalexample"><pre class="programlisting">public function actionGetShares($id=NULL) {}</pre></div><p>The next steps are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Since this is an asynchronous callback, we don't want to render anything from our layout:<div class="informalexample"><pre class="programlisting">   $this-&gt;layout = false;</pre></div></li><li class="listitem">Next, we're going to either throw an error if a user wasn't provided and we're not logged in, or set the user to ourselves if we are logged in and an ID was given to us:<div class="informalexample"><pre class="programlisting">   if ($id == NULL)
   {
      if (Yii::app()-&gt;user-&gt;isGuest)
         throw new CHttpException(400, 'Cannot retrieve shares for that user');

      $id = Yii::app()-&gt;user-&gt;id;
   }</pre></div></li><li class="listitem">Then we're going to implement <code class="literal">CListView</code>, which will retrieve data from our <code class="literal">GET</code> parameters:<div class="informalexample"><pre class="programlisting">   $myFollowers = array();

   // CListView for showing shares
   $shares = new Share('search');
   $shares-&gt;unsetAttributes();

   if(isset($_GET['Share']))
      $shares-&gt;attributes=$_GET['Share'];</pre></div></li><li class="listitem">When viewing <a id="id447" class="indexterm"/>another user's timeline, we only care about the shares that they have shared with the world. However, when we're viewing our timeline, we want to view both our shares and the shares of the user we are following. We can implement the controller portion of this as follows:<div class="informalexample"><pre class="programlisting">   // If this is NOT the current user, then only show stuff that belongs to this user
   if ($id != Yii::app()-&gt;user-&gt;id)
      $shares-&gt;author_id = $id;
   else
   {
      // Alter the criteria to do a search of everyone the current user is following
      $myFollowers[] = Yii::app()-&gt;user-&gt;id;

      $followers = Follower::model()-&gt;findAllByAttributes(array('follower_id' =&gt; Yii::app()-&gt;user-&gt;id));
      if ($followers != NULL)
      {
         foreach ($followers as $follower)
         $myFollowers[] = $follower-&gt;followee_id;
      }
   }

   $this-&gt;render('getshares', array('shares' =&gt; $shares, 'myFollowers' =&gt; $myFollowers));
}</pre></div></li><li class="listitem">Then, we'll need<a id="id448" class="indexterm"/> to implement our <code class="literal">getshares.php</code> view file at <code class="literal">protected/views/shares/</code> as <code class="literal">CListView</code>. Notice that we're passing down <code class="literal">$myFollowers</code> as a custom parameter to our Share model's <code class="literal">search()</code> method:<div class="informalexample"><pre class="programlisting">&lt;?php $this-&gt;widget('zii.widgets.CListView', array(
    'dataProvider'=&gt;$shares-&gt;search($myFollowers),
    'itemView'=&gt;'share',
    'emptyText' =&gt; '&lt;div class="center"&gt;This user hasn\'t shared anything yet!&lt;/div&gt;',
    'template' =&gt; '{items}{pager}',
    'afterAjaxUpdate' =&gt; 'js:function() { init(); }
    ',
    'pager' =&gt; array(
        'header' =&gt; ' ',
        'selectedPageCssClass' =&gt; 'active',
        'htmlOptions' =&gt; array('class' =&gt; 'pagination')
    )
));

Yii::app()-&gt;clientScript-&gt;registerScript('init', '
function init() {
    $(".fa-heart").click(function() {
        var id = $(this).parent().parent().parent().attr("data-attr-id");
        var self = this;
        $.post("' . $this-&gt;createUrl('share/like') . '/" + id, function(data) {
            $(self).toggleClass("liked");
        });
    });

    $(".fa-mail-forward").click(function() {
        var id = $(this).parent().parent().parent().attr("data-attr-id");
        var self = this;
        $.post("' . $this-&gt;createUrl('share/re-share') . '/" + id, function(data) {
            $(self).toggleClass("liked");
        });
    });
}

init();
');</pre></div></li><li class="listitem">Then, within our model, we're going to adjust our <code class="literal">search()</code> method so that it conditionally loads the appropriate data:<div class="informalexample"><pre class="programlisting">public function search($items = array())
{
   $criteria=new CDbCriteria;

   $criteria-&gt;compare('id',$this-&gt;id);
   $criteria-&gt;compare('text',$this-&gt;text,true);
   $criteria-&gt;compare('reply_id',$this-&gt;reply_id);
   $criteria-&gt;compare('created',$this-&gt;created);

   <span class="strong"><strong>if (empty($items))</strong></span>
<span class="strong"><strong>      $criteria-&gt;compare('author_id',$this-&gt;author_id);</strong></span>
<span class="strong"><strong>   else</strong></span>
<span class="strong"><strong>      $criteria-&gt;addInCondition('author_id', $items);</strong></span>
   
   $criteria-&gt;order = 'created DESC';
   return new CActiveDataProvider($this, array(
      'criteria' =&gt; $criteria,
   ));
}</pre></div></li><li class="listitem">Finally, we can implement our individual share view by copying <code class="literal">protected/views/share/share.php</code> from our project resources folder into our project.</li></ol></div><p>Within this file, we're <a id="id449" class="indexterm"/>going to implement some custom logic so that hashtags (#) and @ mentions are displayed as links. This will allow us to store unformatted text in our database, which in turns means we could adjust the way our views work without having to modify our data. We're also going to render our text in Markdown to allow our users to add links or other custom formatting, but prevent them from attempting XSS injection:</p><div class="informalexample"><pre class="programlisting">&lt;?php
   $data-&gt;text = preg_replace("/#([A-Za-z0-9\/\.]*)/", "&lt;a target=\"_new\" href=\"" . Yii::app()-&gt;controller-&gt;createAbsoluteUrl('timeline/search') ."?q=$1\"&gt;#$1&lt;/a&gt;", $data-&gt;text);
   $data-&gt;text = preg_replace("/@([A-Za-z0-9\/\.]*)/", "&lt;a href=\"" . Yii::app()-&gt;controller-&gt;createAbsoluteUrl('timeline/index'). "/$1\"&gt;@$1&lt;/a&gt;", $data-&gt;text);
   $md = new CMarkdownParser;
   echo $md-&gt;safeTransform($data-&gt;text);</pre></div></div></div>
<div class="section" title="Sharing new content"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec46"/>Sharing new content</h1></div></div></div><p>At this point, if <a id="id450" class="indexterm"/>we had shares in our database, we'd be able to see them. So let's work on sharing new content! From within our controller, the action to handle sharing is simply going to be loading a new Share model and populating it. Have a look at the following code:</p><div class="informalexample"><pre class="programlisting">public function actionCreate()
{
   $share = new Share;

   if (isset($_POST['Share']))
   {
      $share-&gt;attributes = array(
         'text' =&gt; $_POST['Share']['text'],
         'reply_id' =&gt; isset($_POST['Share']['reply_id']) ? $_POST['Share']['reply_id'] : NULL,
         'author_id' =&gt; Yii::app()-&gt;user-&gt;id
      );

      // Share the content
      if ($share-&gt;save())
      {
         $this-&gt;renderPartial('share', array('data' =&gt; $share));
         Yii::app()-&gt;end();
      }
   }

   throw new CHttpException(500, 'There was an error sharing your content');
}</pre></div><p>Though, the real power behind sharing content happens in the <code class="literal">beforeSave()</code> method of our Share model. From here, we handle all the mentioning that may occur within our model, and send <a id="id451" class="indexterm"/>an e-mail to everyone who was mentioning in the share. The code is as follows:</p><div class="informalexample"><pre class="programlisting">public function afterSave()
{
   preg_match_all('/@([A-Za-z0-9\/\.]*)/', $this-&gt;text, $matches);
   $mentions = implode(',', $matches[1]);

   if (!empty($matches[1]))
   {
      $criteria = new CDbCriteria;
      $criteria-&gt;addInCondition('username', $matches[1]);
      $users = User::model()-&gt;findAll($criteria);

      foreach ($users as $user)
      {
         $sendgrid = new SendGrid(Yii::app()-&gt;params['includes']['sendgrid']['username'], Yii::app()-&gt;params['includes']['sendgrid']['password']);
         $email    = new SendGrid\Email();

         $email-&gt;setFrom(Yii::app()-&gt;params['includes']['sendgrid']['from'])
            -&gt;addTo($user-&gt;email)
            -&gt;setSubject("You've Been @mentioned!")
            -&gt;setText("You've Been @mentioned!")
            -&gt;setHtml(Yii::app()-&gt;controller-&gt;renderPartial('//email/mention', array('share' =&gt; $this, 'user' =&gt; $user), true));

         // Send the email
         $sendgrid-&gt;send($email);
      }
   }

   return parent::afterSave();
}</pre></div><div class="section" title="Resharing"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec90"/>Resharing</h2></div></div></div><p>Since<a id="id452" class="indexterm"/> everything in our model is already implemented, we can easily implement resharing now as a new controller action within <code class="literal">protected/controllers/ShareController.php</code>. Resharing allows a user to share something another user shared, while still giving that user credit for the original share. In our controller, what we're going to do is load the share we want to reshare with our network, change the author to us, and then indicate that this is a reshare of another share.</p><p>First, let's create a <a id="id453" class="indexterm"/>
<code class="literal">loadModel()</code> utility method:</p><div class="informalexample"><pre class="programlisting">private function loadModel($id=NULL)
{
    if ($id == NULL)
        throw new CHttpException(400, 'Missing Share ID');

    return Share::model()-&gt;findByPk($id);
}</pre></div><p>Then, we'll <a id="id454" class="indexterm"/>implement the resharing ability as described in the <span class="emphasis"><em>Describing the project</em></span> section:</p><div class="informalexample"><pre class="programlisting">public function actionReshare($id=NULL)
{
   // Load the share model
   $share = $this-&gt;loadModel($id);

   // You can't reshare your own stuff
   if ($share-&gt;author_id == Yii::app()-&gt;user-&gt;id)
   return false;

   // You can't reshare stuff you've already reshared
   $reshare = Share::model()-&gt;findByAttributes(array(
      'author_id' =&gt; Yii::app()-&gt;user-&gt;id,
      'reshare_id' =&gt; $id
   ));

   if ($reshare !== NULL)
   return false;

   // Create a new Share as a reshare
   $model = new Share;

   // Assign the shared attributes
   $model-&gt;attributes = $share-&gt;attributes;

   // Set the reshare other to the current user
   $model-&gt;author_id = Yii::app()-&gt;user-&gt;id;

   // Propogate the reshare if this isn't original
   if ($model-&gt;reshare_id == 0 || $model-&gt;reshare_id == NULL)
   $model-&gt;reshare_id = $share-&gt;id;

   // Then save the reshare, return the response. Yii will set a 200 or 500 response code automagically if false
   return $model-&gt;save();
}</pre></div></div><div class="section" title="Liking and unliking shares"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec91"/>Liking and unliking shares</h2></div></div></div><p>Next, we'll <a id="id455" class="indexterm"/>implement the actions and methods necessary for a user to like and unlike a given share. The only restriction on likes should be that a user can't like a share more than once. </p><p>We can implement the action for liking in <code class="literal">ShareController</code> as follows:</p><div class="informalexample"><pre class="programlisting">public function actionLike($id=NULL)
{
   $share = $this-&gt;loadModel($id);
   if ($share-&gt;isLiked())
      return $share-&gt;unlike();

   return $share-&gt;like();
}</pre></div><p>Then, within our Share model, we'll implement the method necessary to check whether an action has already been liked by a user or not:</p><div class="informalexample"><pre class="programlisting">public function isLiked()
{
   $like = Like::model()-&gt;findByAttributes(array(
      'user_id' =&gt; Yii::app()-&gt;user-&gt;id,
      'share_id' =&gt; $this-&gt;id
   ));

   return $like != NULL;
}</pre></div><p>Then, we will implement <a id="id456" class="indexterm"/>the <code class="literal">like()</code> method:</p><div class="informalexample"><pre class="programlisting">public function like()
{
   $like = Like::model()-&gt;findByAttributes(array(
      'user_id' =&gt; Yii::app()-&gt;user-&gt;id,
      'share_id' =&gt; $this-&gt;id
   ));

   // Share is already liked, return true
   if ($like != NULL)
      return true;

   $like = new Like;
   $like-&gt;attributes = array(
      'share_id' =&gt; $this-&gt;id,
      'user_id' =&gt; Yii::app()-&gt;user-&gt;id
   );

   // Save the like
   return $like-&gt;save();
}</pre></div><p>Finally, we will <a id="id457" class="indexterm"/>implement <a id="id458" class="indexterm"/>the <code class="literal">unlike()</code> method:</p><div class="informalexample"><pre class="programlisting">public function unlike()
{
   $like = Like::model()-&gt;findByAttributes(array(
      'user_id' =&gt; Yii::app()-&gt;user-&gt;id,
      'share_id' =&gt; $this-&gt;id
   ));

   // Item is not already liked, return true
   if ($like == NULL)
      return true;

   // Delete the Like
   return $like-&gt;delete();
}</pre></div></div><div class="section" title="Viewing shares"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec92"/>Viewing shares</h2></div></div></div><p>At this point, we <a id="id459" class="indexterm"/>can do everything with a share except dive into one and view all the replies to a share. Let's implement the <code class="literal">actionView()</code> method<a id="id460" class="indexterm"/> so that our users can view a particular share. In <code class="literal">ShareController</code>, we'll implement this as follows:</p><div class="informalexample"><pre class="programlisting">public function actionView($id=NULL)
{
   $share = $this-&gt;loadModel($id);

   if ($share == NULL)
      throw new CHttpException(400, 'No share with that ID was found');

   $this-&gt;render('view', array(
      'share' =&gt; $share,
      'replies' =&gt; Share::model()-&gt;findAllByAttributes(array('reply_id' =&gt; $id), array('order' =&gt; 'created DESC')),
      'reply' =&gt; new Share
   ));
}</pre></div><p>Then, we will copy <code class="literal">protected/views/share/view.php</code> from our project resources folder into the project. Within our view, we can now share something and click on the eye icon on the share in order to view it in more detail.</p></div></div>
<div class="section" title="Searching for shares"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec47"/>Searching for shares</h1></div></div></div><p>One of the <a id="id461" class="indexterm"/>most important parts of any application is the ability to search for and discover new content. For this application, we'll be implementing a search method that will allow users to search for content and users. To do this, we'll check whether the query string in our search method contains the <code class="literal">@</code> character. If it does, we'll perform a second search for that user and display information about that user in our view. We'll implement that method as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We'll start by implementing <code class="literal">actionSearch()</code> as follows:<div class="informalexample"><pre class="programlisting">public function actionSearch() {}</pre></div></li><li class="listitem">We'll then retrieve the query string from our <code class="literal">$_GET</code> parameters and define the scope for our models:<div class="informalexample"><pre class="programlisting">$query = isset($_GET['q']) ? $_GET['q'] : NULL;
$users = $shares = NULL;</pre></div></li><li class="listitem">Then, as long as there is a query to run against, we'll create two <code class="literal">CDbCriteria</code> objects; one for users and the other for shares:<div class="informalexample"><pre class="programlisting">if ($query != NULL)
{
   $userCriteria = new CDbCriteria;
   $searchCriteria = new CDbCriteria;
}</pre></div></li><li class="listitem">Within this <code class="literal">if</code> bracket, we'll first check whether there were any mentions in our query string, by using <code class="literal">preg_match_all</code>:<div class="informalexample"><pre class="programlisting">   preg_match_all('/@([A-Za-z0-9\/\.]*)/', $query, $matches);
   $mentions = implode(',', $matches[1]);</pre></div></li><li class="listitem">If there <a id="id462" class="indexterm"/>are any results, we'll build a query to find all the users who were mentioned in the query, and then, we'll remove that criteria from our query string:<div class="informalexample"><pre class="programlisting">   if (!empty($matches[1]))
   {
      $userCriteria-&gt;addInCondition('username', $matches[1]);
      $users = User::model()-&gt;findAll($userCriteria);
      foreach ($matches[1] as $u)
         $query = str_replace('@'.$u,'',$query);
   }</pre></div></li><li class="listitem">Then, we'll perform a <code class="literal">LIKE</code> query search against the <code class="literal">text</code> field of our Share model:<div class="informalexample"><pre class="programlisting">$searchCriteria-&gt;addSearchCondition('text', $query);
$searchCriteria-&gt;limit = 30;
$shares = Share::model()-&gt;findAll($searchCriteria);</pre></div></li><li class="listitem">Then, we'll render our view:<div class="informalexample"><pre class="programlisting">$this-&gt;render('search', array(
   'users' =&gt; $users,
   'shares' =&gt; $shares
));</pre></div></li><li class="listitem">Finally, we'll need to copy our view file from <code class="literal">protected/views/timeline/search.php</code> into our project folder.</li></ol></div></div>
<div class="section" title="Sharing on Twitter with HybridAuth"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec48"/>Sharing on Twitter with HybridAuth</h1></div></div></div><p>Since our <a id="id463" class="indexterm"/>application doesn't have a large following yet, it's important to enable our users to share content that they generate on our site to other places. A great way to spread the word about a particular site or service is to take advantage of Twitter. One way to integrate with Twitter is by utilizing their OAuth API. This will allow us to authenticate as a given user and post content on their behalf, at just a click of a button.</p><p>To do this, we'll be taking advantage of <a id="id464" class="indexterm"/>
<span class="strong"><strong>HybridAuth</strong></span>. HybridAuth is an open source library that allows developers to integrate with multiple third-party social networks, and enables developers to make their application more social. For our purposes, we're going to utilize HybridAuth to <a id="id465" class="indexterm"/>impersonate a given user (with their permission, of course) and submit content on their behalf upon their request.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note27"/>Note</h3><p>If you want to learn <a id="id466" class="indexterm"/>more about HybridAuth, check out the official documentation at <a class="ulink" href="http://hybridauth.sourceforge.net/">http://hybridauth.sourceforge.net/</a>.</p></div></div><div class="section" title="Setting up a Twitter application"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec93"/>Setting up a Twitter application</h2></div></div></div><p>Before we <a id="id467" class="indexterm"/>start using HybridAuth though, we<a id="id468" class="indexterm"/> first need to set up a Twitter application and obtain our OAuth credentials. These credentials will allow our application to communicate securely with Twitter, and enable us to sign in and post as our users. The steps are as follows:</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note28"/>Note</h3><p>What is OAuth? OAuth is an open standard for authentication, and provides client applications such as the one we are building in this application, secure delegated access to server resources on behalf of that owner, in this case, Twitter. By using OAuth, we can communicate securely with a server without having to transmit our user's credentials to our application. In our application, we'll be using HybridAuth to take care of most of the leg work when dealing with Twitter's OAuth endpoint. Check out <a class="ulink" href="http://oauth.net/about/">http://oauth.net/about/</a> for more information about what OAuth is and how it works.</p></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To begin, open up your web browser, navigate to <a class="ulink" href="https://apps.twitter.com/">https://apps.twitter.com/</a>, and sign in using your Twitter credentials.</li><li class="listitem">Once authenticated, click on the <span class="strong"><strong>Create New App</strong></span> button in the top-right corner of the page body.</li><li class="listitem">On this <a id="id469" class="indexterm"/>page, fill out the fields as shown in the next screenshot. Adjust the website URL and <span class="strong"><strong>Callback URL</strong></span> to match what you are using in your application. Note that the endpoint you provide to Twitter must be publicly accessible.<div class="mediaobject"><img src="graphics/7734OS_05_04.jpg" alt="Setting up a Twitter application"/></div></li><li class="listitem">On the next page, click on the <span class="strong"><strong>Settings</strong></span> tab, check the <span class="strong"><strong>Allow this application to be used to sign into Twitter</strong></span> checkbox, and click on the <span class="strong"><strong>Update Settings</strong></span> button at the bottom of the page.</li><li class="listitem">Then, click on the <span class="strong"><strong>Permissions</strong></span> tab and change the access level to <span class="strong"><strong>Read and Write</strong></span> and <a id="id470" class="indexterm"/>save the form.</li></ol></div></div><div class="section" title="Configuring HybridAuth"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec94"/>Configuring HybridAuth</h2></div></div></div><p>With our <a id="id471" class="indexterm"/>Twitter application <a id="id472" class="indexterm"/>configured, we now need to install and configure HybridAuth. Fortunately, HybridAuth is available as a Composer dependency, so we can include its source code into our project by adding the following to the require section of our <code class="literal">composer.json</code> file:</p><div class="informalexample"><pre class="programlisting">"hybridauth/hybridauth": "2.2.0.*@dev"</pre></div><p>The next steps are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Run the <code class="literal">composer update</code> command from your command line:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>composer update</strong></span>
</pre></div></li><li class="listitem">You should see something similar to the following output:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Loading composer repositories with package information</strong></span>
<span class="strong"><strong>Updating dependencies (including require-dev)</strong></span>
<span class="strong"><strong>  - Installing hybridauth/hybridauth (2.2.0.x-dev 5774600)</strong></span>
<span class="strong"><strong>    Cloning 57746000e5b2f96469b229b366e56eb70ab7bf20</strong></span>

<span class="strong"><strong>Writing lock file</strong></span>
<span class="strong"><strong>Generating autoload files</strong></span>
</pre></div></li><li class="listitem">Next, we'll configure HybridAuth so that it knows what information to use. Open up <code class="literal">protected/config/params.php</code>, and add the following after our SendGrid information:<div class="informalexample"><pre class="programlisting">'hybridauth' =&gt; array(
   'baseUrl' =&gt; '',
   'base_url' =&gt; '',
   'providers' =&gt; array(
      'Twitter' =&gt; array(
         'enabled' =&gt; true,
         'keys' =&gt; array(
            'key' =&gt; '&lt;twiter_key&gt;',
            'secret' =&gt; '&lt;twitter_secret&gt;'
         )
      )
   )
)</pre></div></li><li class="listitem">Then, retrieve your Twitter API key and Twitter Secret key from the <span class="strong"><strong>API Keys</strong></span> tab of our <a id="id473" class="indexterm"/>Twitter application, as shown in the next screenshot, and <a id="id474" class="indexterm"/>replace <code class="literal">&lt;twitter_key&gt;</code> and <code class="literal">&lt;twitter_secret&gt;</code> with them in your configuration file:<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note29"/>Note</h3><p>Your Twitter OAuth Key and Secret are confidential pieces of information and should be kept out of your DCVS provider. If you ever suspect that your OAuth credentials have been compromised, you should immediately regenerate your API keys. This will prevent potential attacks from gaining the ability to sign on and tweet as your users.</p></div></div></li></ol></div><div class="mediaobject"><img src="graphics/7734OS_05_05.jpg" alt="Configuring HybridAuth"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note30"/>Note</h3><p>HybridAuth can be configured with several different options. Be sure to look at a few of the examples if you're interested in implementing social sharing for other providers at <a class="ulink" href="http://hybridauth.sourceforge.net/userguide/Configuration.html">http://hybridauth.sourceforge.net/userguide/Configuration.html</a>.</p></div></div></div><div class="section" title="Implementing HybridAuth social sign-on and sharing"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec95"/>Implementing HybridAuth social sign-on and sharing</h2></div></div></div><p>Now that our <a id="id475" class="indexterm"/>application <a id="id476" class="indexterm"/>has Twitter's OAuth credentials, we can implement the<a id="id477" class="indexterm"/> social sign-on <a id="id478" class="indexterm"/>and sharing features:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Begin by adjusting our <code class="literal">accessRules()</code> method to only allow authenticated users to share content on Twitter:<div class="informalexample"><pre class="programlisting">array('allow',
   'actions' =&gt; array('create', 'reshare', 'like', 'delete', '<span class="strong"><strong>hybrid</strong></span>'),
   'users' =&gt; array('@')
),</pre></div></li><li class="listitem">Then, implement the <code class="literal">actionHybrid()</code> method:<div class="informalexample"><pre class="programlisting">public function actionHybrid($id=NULL) {}</pre></div></li><li class="listitem">We'll start this action by looking for some specific HybridAuth <code class="literal">$_GET</code> parameters, and calling <code class="literal">Hybrid_Endpoint::process()</code> if either of the two are detected:<div class="informalexample"><pre class="programlisting">if (isset($_GET['hauth_start']) || isset($_GET['hauth_done']))
    Hybrid_Endpoint::process();</pre></div></li><li class="listitem">We'll then wrap the next section in a <code class="literal">try</code>/<code class="literal">catch</code> block to catch any errors that HybridAuth may throw if it encounters an error:<div class="informalexample"><pre class="programlisting">try {
} catch (Exception $e) {
    $this-&gt;redirect($this-&gt;createUrl('timeline/index'));
}</pre></div></li><li class="listitem">Within our <code class="literal">try</code>/<code class="literal">catch</code> block, we'll then load our configuration we set in our <code class="literal">params.php</code> file, and set the base URL for HybridAuth to use internally within our application. This base URL should correspond to the location from where HybridAuth will be called:<div class="informalexample"><pre class="programlisting">$config = Yii::app()-&gt;params['includes']['hybridauth'];
$config['baseUrl'] = $config['base_url'] = $this-&gt;createAbsoluteUrl('share/hybrid');</pre></div></li><li class="listitem">We'll initialize <a id="id479" class="indexterm"/>HybridAuth with our configuration:<div class="informalexample"><pre class="programlisting">$hybridauth = new Hybrid_Auth($config, array());</pre></div></li><li class="listitem">Then, we'll <a id="id480" class="indexterm"/>create a HybridAuth adapter for us to talk to Twitter:<div class="informalexample"><pre class="programlisting">$adapter = $hybridauth-&gt;authenticate('Twitter');</pre></div></li><li class="listitem">Next, we should check whether the <code class="literal">adapter</code> is connected to Twitter:<div class="informalexample"><pre class="programlisting">if ($adapter-&gt;isUserConnected()) {}</pre></div></li><li class="listitem">Within this <code class="literal">if</code> block, we should load the share we want to share on Twitter:<div class="informalexample"><pre class="programlisting">$share = $this-&gt;loadModel($id);</pre></div></li><li class="listitem">Then, share our content on Twitter:<div class="informalexample"><pre class="programlisting">$response = $adapter-&gt;setUserStatus($share-&gt;text . ' | #Socialii ' . $this-&gt;createAbsoluteUrl('share/view', array('id' =&gt; $id)));
Yii::app()-&gt;user-&gt;setFlash('success', 'Your status has been shared to Twitter');
$this-&gt;redirect(Yii::app()-&gt;user-&gt;returnUrl);</pre></div></li></ol></div><p>Now, if you share<a id="id481" class="indexterm"/> something <a id="id482" class="indexterm"/>on our site, then click on the Twitter icon for that share; you'll be redirected to Twitter to sign in, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7734OS_05_06.jpg" alt="Implementing HybridAuth social sign-on and sharing"/></div><p>After <a id="id483" class="indexterm"/>signing in, you'll need <a id="id484" class="indexterm"/>to authorize<a id="id485" class="indexterm"/> our <a id="id486" class="indexterm"/>application to update our Twitter profile, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7734OS_05_07.jpg" alt="Implementing HybridAuth social sign-on and sharing"/></div><p>Then, our <a id="id487" class="indexterm"/>content <a id="id488" class="indexterm"/>will be <a id="id489" class="indexterm"/>shared on Twitter on <a id="id490" class="indexterm"/>our behalf, as shown in the next screenshot. Moreover, if we click on the Twitter button again within our application, our content will be automatically shared on Twitter for us, without us having to reauthenticate against Twitter.</p><div class="mediaobject"><img src="graphics/7734OS_05_08.jpg" alt="Implementing HybridAuth social sign-on and sharing"/></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec49"/>Summary</h1></div></div></div><p>Wow, we covered quite a bit in this chapter! We expanded upon our user authentication and management to include secure activation and password resets if a user forgets their password, and enabled our users to securely and safely change both their own e-mail address and password with proper verification and notifications. Moreover, we implemented all of these actions using <code class="literal">CFormModel</code>, which enabled us to cleanly isolate the logic for handling these actions in forms rather than in our controllers. Finally, we implemented an asynchronous <code class="literal">CListViews</code> and utilized HybridAuth to share on Twitter using our OAuth credentials.</p><p>The user components that we developed in this chapter can easily be used and adapted for almost any application that will require user authentication and management. In the next chapter, we'll be utilizing these components to build a full-scale content management system that will allow us to upload content and photos and also allow us to share this content with others. The CMS that we'll be building will also be SEO-optimized and will include dynamic content slugs and a sitemap feature that can be submitted to the search engines. Before proceeding to the next chapter, be sure to review the Yii Class Reference at <a class="ulink" href="http://www.yiiframework.com/doc/api/">http://www.yiiframework.com/doc/api/</a> and review all the classes that we used in this chapter. Then, when you're ready, head over to the next chapter where you'll build a CMS!</p></div></body></html>