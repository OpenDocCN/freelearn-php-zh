<html><head></head><body>
<div id="_idContainer117">
<h1 class="chapter-number" id="_idParaDest-353"><a id="_idTextAnchor383"/><span class="koboSpan" id="kobo.1.1">12</span></h1>
<h1 id="_idParaDest-354"><a id="_idTextAnchor384"/><span class="koboSpan" id="kobo.2.1">Building APIs with Drupal</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Drupal 10 comes with several awesome features to help facilitate building out RESTful APIs using the core Serialization and JSON:API modules. </span><span class="koboSpan" id="kobo.3.2">These enable you to build headless and/or decoupled solutions that can still interact with and query for data </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">in Drupal.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">In this chapter, we will look at how to do </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.7.1">Fetching data from Drupal using </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">JSON:API (</span></span><a href="https://jsonapi.org/"><span class="No-Break"><span class="koboSpan" id="kobo.9.1">https://jsonapi.org/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.10.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">Using POST to create data </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">with JSON:API</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Using PATCH to update data </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">with JSON:API</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Using DELETE to remove data </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">with JSON:API</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">Using Views to provide custom </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">data sources</span></span></li>
<li><span class="koboSpan" id="kobo.19.1">Using </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">OAuth methods</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.21.1">The Serialization module provides a means of serializing data to or deserializing from formats such as JSON and XML. </span><span class="koboSpan" id="kobo.21.2">The RESTful Web Services module then exposes entities and other resource types through web APIs. </span><span class="koboSpan" id="kobo.21.3">Operations done over RESTful resource endpoints use the same create, edit, delete, and view permissions that would be used in a non-API context. </span><span class="koboSpan" id="kobo.21.4">The JSON:API module exposes your data entities (nodes, taxonomy, media, and users) in JSON representation on API routes. </span><span class="koboSpan" id="kobo.21.5">We will also cover how to handle custom authentication for </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">your API.</span></span></p>
<h1 id="_idParaDest-355"><a id="_idTextAnchor385"/><span class="koboSpan" id="kobo.23.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.24.1">All of the APIs in this chapter operate over HTTP. </span><span class="koboSpan" id="kobo.24.2">An HTTP response code is returned, regardless of whether the request was successful or not. </span><span class="koboSpan" id="kobo.24.3">If you are not familiar with HTTP response codes or just need to brush up on them, you can review them here: </span><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status"><span class="koboSpan" id="kobo.25.1">https://developer.mozilla.org/en-US/docs/Web/HTTP/Status</span></a><span class="koboSpan" id="kobo.26.1">. </span><span class="koboSpan" id="kobo.26.2">You will see plenty of HTTP response codes when working with the APIs in Drupal, so it is a good idea to review them. </span><span class="koboSpan" id="kobo.26.3">You can find the full code used in this chapter on </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">GitHub: </span></span><a href="https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp12"><span class="No-Break"><span class="koboSpan" id="kobo.28.1">https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp12</span></span></a></p>
<h1 id="_idParaDest-356"><a id="_idTextAnchor386"/><span class="koboSpan" id="kobo.29.1">Fetching data from Drupal using JSON:API</span></h1>
<p><span class="koboSpan" id="kobo.30.1">With just a</span><a id="_idIndexMarker718"/><span class="koboSpan" id="kobo.31.1"> few</span><a id="_idIndexMarker719"/><span class="koboSpan" id="kobo.32.1"> clicks, we</span><a id="_idIndexMarker720"/><span class="koboSpan" id="kobo.33.1"> can open </span><a id="_idIndexMarker721"/><span class="koboSpan" id="kobo.34.1">up and expose data from Drupal to consume from external services. </span><span class="koboSpan" id="kobo.34.2">This will enable us to ask Drupal for data and return it to us in JSON, making it easy </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">to consume.</span></span></p>
<h2 id="_idParaDest-357"><a id="_idTextAnchor387"/><span class="koboSpan" id="kobo.36.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.37.1">First, we need to enable some core modules. </span><span class="koboSpan" id="kobo.37.2">Head to </span><strong class="bold"><span class="koboSpan" id="kobo.38.1">Admin</span></strong><span class="koboSpan" id="kobo.39.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.40.1">Extend</span></strong><span class="koboSpan" id="kobo.41.1"> and enable </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">the following:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.43.1">HTTP </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.44.1">Basic Authentication</span></strong></span></li>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.45.1">JSON:API</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.46.1">RESTful </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.47.1">Web Services</span></strong></span></li>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.48.1">Serialization</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">:</span></span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer090">
<span class="koboSpan" id="kobo.50.1"><img alt="Figure 12.1 – Enabling the necessary modules in Drupal" src="image/Figure_12.1_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.51.1">Figure 12.1 – Enabling the necessary modules in Drupal</span></p>
<p><span class="koboSpan" id="kobo.52.1">The JSON:API module users the Serialization module to handle the normalization of a response and denormalization of data from requests. </span><span class="koboSpan" id="kobo.52.2">Endpoints support specific formats (JSON, XML, and so on), and authentication providers support passing authentication in the headers of requests. </span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.53.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.54.1">Note that at the time of writing, multilingual support is still being finalized under JSON:API. </span><span class="koboSpan" id="kobo.54.2">You can track the status of this issue </span><span class="No-Break"><span class="koboSpan" id="kobo.55.1">here: </span></span><a href="https://www.drupal.org/project/drupal/issues/2794431"><span class="No-Break"><span class="koboSpan" id="kobo.56.1">https://www.drupal.org/project/drupal/issues/2794431</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.57.1">.</span></span></p>
<h2 id="_idParaDest-358"><a id="_idTextAnchor388"/><span class="koboSpan" id="kobo.58.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.59.1">You will have a new area in the </span><strong class="bold"><span class="koboSpan" id="kobo.60.1">Configuration</span></strong><span class="koboSpan" id="kobo.61.1"> section of the Drupal admin area </span><span class="No-Break"><span class="koboSpan" id="kobo.62.1">called </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.63.1">JSON:API</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.64.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer091">
<span class="koboSpan" id="kobo.65.1"><img alt="Figure 12.2 – JSON:API adds a new configuration section of the Drupal admin area" src="image/Figure_12.2_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.66.1">Figure 12.2 – JSON:API adds a new configuration section of the Drupal admin area</span></p>
<p><span class="koboSpan" id="kobo.67.1">JSON:API does </span><a id="_idIndexMarker722"/><span class="koboSpan" id="kobo.68.1">not provide many settings</span><a id="_idIndexMarker723"/><span class="koboSpan" id="kobo.69.1"> out </span><a id="_idIndexMarker724"/><span class="koboSpan" id="kobo.70.1">of the box beyond two security settings. </span><span class="koboSpan" id="kobo.70.2">One allows only read endpoints, while the </span><a id="_idIndexMarker725"/><span class="koboSpan" id="kobo.71.1"> other allows </span><strong class="bold"><span class="koboSpan" id="kobo.72.1">create, read, update, delete</span></strong><span class="koboSpan" id="kobo.73.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.74.1">CRUD</span></strong><span class="koboSpan" id="kobo.75.1">) operations </span><span class="No-Break"><span class="koboSpan" id="kobo.76.1">on endpoints:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer092">
<span class="koboSpan" id="kobo.77.1"><img alt="Figure 12.3 – Configuration options for JSON:API" src="image/Figure_12.3_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.78.1">Figure 12.3 – Configuration options for JSON:API</span></p>
<p><span class="koboSpan" id="kobo.79.1">Leave the default as-is for now. </span><span class="koboSpan" id="kobo.79.2">Create a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.80.1">Basic Page</span></strong><span class="koboSpan" id="kobo.81.1"> node and </span><span class="No-Break"><span class="koboSpan" id="kobo.82.1">save it.</span></span></p>
<p><span class="koboSpan" id="kobo.83.1">Then, go to this URL (replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.84.1">localhost</span></strong><span class="koboSpan" id="kobo.85.1"> with your local </span><span class="No-Break"><span class="koboSpan" id="kobo.86.1">site domain):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.87.1">
https://localhost/jsonapi/node/page</span></pre>
<p><span class="koboSpan" id="kobo.88.1">Drupal will respond with </span><a id="_idIndexMarker726"/><span class="koboSpan" id="kobo.89.1">a </span><a id="_idIndexMarker727"/><span class="koboSpan" id="kobo.90.1">JSON:API</span><a id="_idIndexMarker728"/><span class="koboSpan" id="kobo.91.1"> representation of all </span><strong class="source-inline"><span class="koboSpan" id="kobo.92.1">Basic Page</span></strong><span class="koboSpan" id="kobo.93.1"> nodes in </span><span class="No-Break"><span class="koboSpan" id="kobo.94.1">your site:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer093">
<span class="koboSpan" id="kobo.95.1"><img alt="Figure 12.4 – A sample JSON:API response from Drupal" src="image/Figure_12.4_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.96.1">Figure 12.4 – A sample JSON:API response from Drupal</span></p>
<p><span class="koboSpan" id="kobo.97.1">If you wanted to fetch a specific node by ID, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.98.1">filter</span></strong><span class="koboSpan" id="kobo.99.1"> keyword in the request URL as a </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">query parameter.</span></span></p>
<p><span class="koboSpan" id="kobo.101.1">The format for </span><strong class="source-inline"><span class="koboSpan" id="kobo.102.1">filter</span></strong><span class="koboSpan" id="kobo.103.1"> is </span><strong class="source-inline"><span class="koboSpan" id="kobo.104.1">filter[attribute]</span></strong><span class="koboSpan" id="kobo.105.1">. </span><span class="koboSpan" id="kobo.105.2">Following that, we can fetch a node with an ID of 1 by requesting this URL in </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">the browser:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.107.1">
https://localhost/jsonapi/node/page?filter[
    drupal_internal__nid]=1</span></pre>
<p><span class="koboSpan" id="kobo.108.1">You will get the same response you got in the first example, but now, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.109.1">data</span></strong><span class="koboSpan" id="kobo.110.1"> array in the response will contain </span><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">only</span></strong><span class="koboSpan" id="kobo.112.1"> the node matching ID 1. </span><span class="koboSpan" id="kobo.112.2">This works for any attribute you want to filter by. </span><span class="koboSpan" id="kobo.112.3">If you know an entity’s UUID, you can also request it directly by using it as </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">a parameter:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.114.1">
https://localhost/jsonapi/node/page/{ENTITY UUID}</span></pre>
<p><span class="koboSpan" id="kobo.115.1">By passing the</span><a id="_idIndexMarker729"/><span class="koboSpan" id="kobo.116.1"> UUID</span><a id="_idIndexMarker730"/><span class="koboSpan" id="kobo.117.1"> as a URL </span><a id="_idIndexMarker731"/><span class="koboSpan" id="kobo.118.1">parameter, you would get that specific </span><strong class="source-inline"><span class="koboSpan" id="kobo.119.1">Basic Page</span></strong><span class="koboSpan" id="kobo.120.1"> node type’s node information. </span><span class="koboSpan" id="kobo.120.2">Create a few more </span><strong class="source-inline"><span class="koboSpan" id="kobo.121.1">Basic Page</span></strong><span class="koboSpan" id="kobo.122.1"> nodes using the word </span><strong class="source-inline"><span class="koboSpan" id="kobo.123.1">Test</span></strong><span class="koboSpan" id="kobo.124.1"> in the title. </span><span class="koboSpan" id="kobo.124.2">Suppose you wanted to filter by nodes containing the word </span><strong class="source-inline"><span class="koboSpan" id="kobo.125.1">Test</span></strong><span class="koboSpan" id="kobo.126.1"> in the title; you could request this </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">like so:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.128.1">
https://localhost/jsonapi/node/page?filter[title][operator]
  =CONTAINS&amp;filter[title][value]=Test&amp;fields[node--page]
    =title</span></pre>
<p><span class="koboSpan" id="kobo.129.1">Drupal will only return nodes with the word “Test” in the title. </span><span class="koboSpan" id="kobo.129.2">Here, we also added </span><strong class="source-inline"><span class="koboSpan" id="kobo.130.1">&amp;fields[node—page]=title</span></strong><span class="koboSpan" id="kobo.131.1"> to the request to make the response easier </span><span class="No-Break"><span class="koboSpan" id="kobo.132.1">to see:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer094">
<span class="koboSpan" id="kobo.133.1"><img alt="Figure 12.5 – A filtered JSON:API response from Drupal" src="image/Figure_12.5_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.134.1">Figure 12.5 – A filtered JSON:API response from Drupal</span></p>
<p><span class="koboSpan" id="kobo.135.1">If you prefer </span><a id="_idIndexMarker732"/><span class="koboSpan" id="kobo.136.1">to</span><a id="_idIndexMarker733"/><span class="koboSpan" id="kobo.137.1"> use </span><strong class="source-inline"><span class="koboSpan" id="kobo.138.1">cURL</span></strong><span class="koboSpan" id="kobo.139.1"> instead, you</span><a id="_idIndexMarker734"/><span class="koboSpan" id="kobo.140.1"> can do </span><span class="No-Break"><span class="koboSpan" id="kobo.141.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.142.1">
curl \
  --header 'Accept: application/vnd.api+json' \
  --url "https://localhost/jsonapi/node/page?filter
    [title][operator]=CONTAINS&amp;filter[title][value]=
      Test&amp;fields[node--page]=title" \
--globoff</span></pre>
<p><span class="koboSpan" id="kobo.143.1">You can request this from any HTTP API in any language or command-line tool such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">cURL</span></strong><span class="koboSpan" id="kobo.145.1">, so long as your parameters and options are correct. </span><span class="koboSpan" id="kobo.145.2">Consult the appropriate documentation on using </span><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">fetch</span></strong><span class="koboSpan" id="kobo.147.1"> (</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API"><span class="koboSpan" id="kobo.148.1">https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API</span></a><span class="koboSpan" id="kobo.149.1">) in JavaScript, for example, to integrate this with a decoupled </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">JavaScript application.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.151.1">curl: (60) SSL certificate problem</span></p>
<p class="callout"><span class="koboSpan" id="kobo.152.1">If you get an </span><a id="_idIndexMarker735"/><span class="koboSpan" id="kobo.153.1">error about an SSL certificate problem with cURL, it is likely your SSL certificate could not be verified. </span><span class="koboSpan" id="kobo.153.2">This is common with local self-signed certificates. </span><span class="koboSpan" id="kobo.153.3">To get around this error in development, you can pass the </span><strong class="source-inline"><span class="koboSpan" id="kobo.154.1">--insecure</span></strong><span class="koboSpan" id="kobo.155.1"> flag with the cURL request mentioned previously. </span><span class="koboSpan" id="kobo.155.2">In production, make sure you have a valid working SSL certificate – do not use this flag for </span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">real-world applications.</span></span></p>
<p><span class="koboSpan" id="kobo.157.1">JSON:API can </span><a id="_idIndexMarker736"/><span class="koboSpan" id="kobo.158.1">also </span><a id="_idIndexMarker737"/><span class="koboSpan" id="kobo.159.1">include </span><a id="_idIndexMarker738"/><span class="koboSpan" id="kobo.160.1">related data in the response by asking for it with </span><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">include</span></strong><span class="koboSpan" id="kobo.162.1">. </span><span class="koboSpan" id="kobo.162.2">If we add </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">include</span></strong><span class="koboSpan" id="kobo.164.1"> to the query parameter plus any relationship name under the relationships section of a JSON item, we receive them back with the </span><span class="No-Break"><span class="koboSpan" id="kobo.165.1">JSON:API response.</span></span></p>
<p><span class="koboSpan" id="kobo.166.1">If you want the node author information, for example, you can request it </span><span class="No-Break"><span class="koboSpan" id="kobo.167.1">like so:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.168.1">
https://localhost/jsonapi/node/page?filter[title][operator]=CONTAINS&amp;filter[title][value]=Test&amp;fields[node—page]=title&amp;include=uid</span></pre>
<p><span class="koboSpan" id="kobo.169.1">We will receive that information in </span><span class="No-Break"><span class="koboSpan" id="kobo.170.1">the response:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer095">
<span class="koboSpan" id="kobo.171.1"><img alt="Figure 12.6 – A sample JSON:API response with the author data attached" src="image/Figure_12.6_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.172.1">Figure 12.6 – A sample JSON:API response with the author data attached</span></p>
<p><span class="koboSpan" id="kobo.173.1">Note that to view</span><a id="_idIndexMarker739"/><span class="koboSpan" id="kobo.174.1"> user</span><a id="_idIndexMarker740"/><span class="koboSpan" id="kobo.175.1"> data, the </span><a id="_idIndexMarker741"/><span class="koboSpan" id="kobo.176.1">requesting user needs the </span><strong class="source-inline"><span class="koboSpan" id="kobo.177.1">View user information</span></strong><span class="koboSpan" id="kobo.178.1"> permission. </span><span class="koboSpan" id="kobo.178.2">You will get an </span><strong class="bold"><span class="koboSpan" id="kobo.179.1">access denied</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.180.1">error otherwise.</span></span></p>
<p><span class="koboSpan" id="kobo.181.1">Any item listed under </span><strong class="bold"><span class="koboSpan" id="kobo.182.1">relationships</span></strong><span class="koboSpan" id="kobo.183.1"> can be requested – for example, author data, taxonomy attached to returned entities, media attached to returned entities, or other types of </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">related data.</span></span></p>
<h3><span class="koboSpan" id="kobo.185.1">Paginating, filtering, and sorting requests</span></h3>
<p><span class="koboSpan" id="kobo.186.1">Pagination </span><a id="_idIndexMarker742"/><span class="koboSpan" id="kobo.187.1">is done </span><a id="_idIndexMarker743"/><span class="koboSpan" id="kobo.188.1">by </span><a id="_idIndexMarker744"/><span class="koboSpan" id="kobo.189.1">appending a page query parameter. </span><span class="koboSpan" id="kobo.189.2">To limit the request to 10 nodes, we must use </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">append ?page[limit]=10</span></strong><span class="koboSpan" id="kobo.191.1">. </span><span class="koboSpan" id="kobo.191.2">To access the next set of results, we must also </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">pass </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">page[offset]=10</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.195.1">The following is an example of returning the first and second pages </span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">of results:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.197.1">
https://localhost/jsonapi/node/article?page[limit]=10
https://localhost/jsonapi/node/article?page[offset]=10&amp;page
  [limit]=10</span></pre>
<p><span class="koboSpan" id="kobo.198.1">Each request contains a link property; this will also contain the next and previous links when using a </span><span class="No-Break"><span class="koboSpan" id="kobo.199.1">paginated result.</span></span></p>
<p><span class="koboSpan" id="kobo.200.1">Filtering is done by appending a filter query parameter. </span><span class="koboSpan" id="kobo.200.2">The following is an example of requesting all nodes that have been promoted to the </span><span class="No-Break"><span class="koboSpan" id="kobo.201.1">front page:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.202.1">
https://localhost/jsonapi/node/article?filter[promoted]
  [path]=promote&amp;filter[promoted][value]=1&amp;filter[promoted]
    [operator]==</span></pre>
<p><span class="koboSpan" id="kobo.203.1">Each filter is </span><a id="_idIndexMarker745"/><span class="koboSpan" id="kobo.204.1">defined</span><a id="_idIndexMarker746"/><span class="koboSpan" id="kobo.205.1"> by a name – in the </span><a id="_idIndexMarker747"/><span class="koboSpan" id="kobo.206.1">preceding example, it is promoted. </span><span class="koboSpan" id="kobo.206.2">The filter then takes </span><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">path</span></strong><span class="koboSpan" id="kobo.208.1">, which is the field to filter on. </span><span class="koboSpan" id="kobo.208.2">The value and operator decide how </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">to filter.</span></span></p>
<p><span class="koboSpan" id="kobo.210.1">Sorting is the simplest operation to perform. </span><span class="koboSpan" id="kobo.210.2">Here, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.211.1">sort</span></strong><span class="koboSpan" id="kobo.212.1"> query parameter is added. </span><span class="koboSpan" id="kobo.212.2">The field name value is the field to sort by; to sort in descending order, you must add a minus symbol in front of the field name. </span><span class="koboSpan" id="kobo.212.3">The following examples show how to sort by </span><strong class="source-inline"><span class="koboSpan" id="kobo.213.1">nid</span></strong><span class="koboSpan" id="kobo.214.1"> in ascending and descending </span><span class="No-Break"><span class="koboSpan" id="kobo.215.1">order, respectively:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.216.1">
https://localhost/jsonapi/node/article?sort=nid
https://localhost/jsonapi/node/article?sort=-nid</span></pre>
<h2 id="_idParaDest-359"><a id="_idTextAnchor389"/><span class="koboSpan" id="kobo.217.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.218.1">The Serialization module </span><a id="_idIndexMarker748"/><span class="koboSpan" id="kobo.219.1">in Drupal provides the necessary plumbing to normalize and denormalize data structures to and from formats such as JSON and XML. </span><span class="koboSpan" id="kobo.219.2">When requests are made to Drupal, the responsible route gets the resource and normalizes it to an array; then, a </span><a id="_idIndexMarker749"/><span class="koboSpan" id="kobo.220.1">registered </span><strong class="bold"><span class="koboSpan" id="kobo.221.1">encoder</span></strong><span class="koboSpan" id="kobo.222.1"> (in this case, </span><strong class="bold"><span class="koboSpan" id="kobo.223.1">JsonEncoder</span></strong><span class="koboSpan" id="kobo.224.1">) returns</span><a id="_idIndexMarker750"/><span class="koboSpan" id="kobo.225.1"> the data in the requested format (JSON, XML, and </span><span class="No-Break"><span class="koboSpan" id="kobo.226.1">so on):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer096">
<span class="koboSpan" id="kobo.227.1"><img alt="Figure 12.7 – A high-level look at how serialization works in Drupal" src="image/Figure_12.7_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.228.1">Figure 12.7 – A high-level look at how serialization works in Drupal</span></p>
<p><span class="koboSpan" id="kobo.229.1">This is the backbone of the normalization and serialization of data in Drupal. </span><span class="koboSpan" id="kobo.229.2">When you enabled the </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">JSON:API</span></strong><span class="koboSpan" id="kobo.231.1"> module, new routes were registered for resources under </span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">/jsonapi/</span></strong><span class="koboSpan" id="kobo.233.1">. </span><span class="koboSpan" id="kobo.233.2">These dynamically generated routes automatically encode data and return it as JSON. </span><span class="koboSpan" id="kobo.233.3">Any time an entity is requested, the serializer and encoders are responsible for</span><a id="_idIndexMarker751"/><span class="koboSpan" id="kobo.234.1"> building the data for </span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">the response.</span></span></p>
<h2 id="_idParaDest-360"><a id="_idTextAnchor390"/><span class="koboSpan" id="kobo.236.1">There’s more…</span></h2>
<h3><span class="koboSpan" id="kobo.237.1">Installing the JSON:API Extras module</span></h3>
<p><span class="koboSpan" id="kobo.238.1">The JSON:API Extras</span><a id="_idIndexMarker752"/><span class="koboSpan" id="kobo.239.1"> module provides a user interface for additional customization. </span><span class="koboSpan" id="kobo.239.2">The JSON:API Extras module should be added to your Drupal installation like all other modules – that is, </span><span class="No-Break"><span class="koboSpan" id="kobo.240.1">using Composer:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.241.1">
composer require drupal/jsonapi_extras:^3.0</span></pre>
<p><span class="koboSpan" id="kobo.242.1">Once the module has been installed in Drupal, you will be able to enable or disable endpoints, change resource names, alter resource paths, disable fields, provide alias field names, and enhance field outputs of </span><span class="No-Break"><span class="koboSpan" id="kobo.243.1">JSON:API routes.</span></span></p>
<h3><span class="koboSpan" id="kobo.244.1">Changing the JSON:API path prefix</span></h3>
<p><span class="koboSpan" id="kobo.245.1">The API path </span><a id="_idIndexMarker753"/><span class="koboSpan" id="kobo.246.1">prefix can be changed from </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">jsonapi</span></strong><span class="koboSpan" id="kobo.248.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">api</span></strong><span class="koboSpan" id="kobo.250.1"> or any other prefix using the </span><span class="No-Break"><span class="koboSpan" id="kobo.251.1">Extras module.</span></span></p>
<p><span class="koboSpan" id="kobo.252.1">From the administrative toolbar, navigate to </span><strong class="bold"><span class="koboSpan" id="kobo.253.1">Configuration</span></strong><span class="koboSpan" id="kobo.254.1">. </span><span class="koboSpan" id="kobo.254.2">Under the </span><strong class="bold"><span class="koboSpan" id="kobo.255.1">Web services</span></strong><span class="koboSpan" id="kobo.256.1"> section, click on </span><strong class="bold"><span class="koboSpan" id="kobo.257.1">JSON:API Overwrites</span></strong><span class="koboSpan" id="kobo.258.1"> to customize the JSON:API implementation. </span><span class="koboSpan" id="kobo.258.2">The </span><strong class="bold"><span class="koboSpan" id="kobo.259.1">Settings</span></strong><span class="koboSpan" id="kobo.260.1"> tab allows you to modificy the API </span><span class="No-Break"><span class="koboSpan" id="kobo.261.1">path prefix:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer097">
<span class="koboSpan" id="kobo.262.1"><img alt="Figure 12.8 – Using JSON:API Extras to change the JSON path prefix" src="image/Figure_12.9_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.263.1">Figure 12.8 – Using JSON:API Extras to change the JSON path prefix</span></p>
<p><span class="koboSpan" id="kobo.264.1">After changing </span><strong class="bold"><span class="koboSpan" id="kobo.265.1">Path prefix</span></strong><span class="koboSpan" id="kobo.266.1">, clear the cache in Drupal to see the result and the </span><span class="No-Break"><span class="koboSpan" id="kobo.267.1">new path.</span></span></p>
<h3><span class="koboSpan" id="kobo.268.1">Disabling and enhancing returned entity fields</span></h3>
<p><span class="koboSpan" id="kobo.269.1">The JSON:API Extras </span><a id="_idIndexMarker754"/><span class="koboSpan" id="kobo.270.1">module </span><a id="_idIndexMarker755"/><span class="koboSpan" id="kobo.271.1">allows you to overwrite endpoints automatically exposed by the JSON:API module. </span><span class="koboSpan" id="kobo.271.2">This allows you to disable fields from being returned. </span><span class="koboSpan" id="kobo.271.3">It also allows you to use enhancers to simplify the structure of a </span><span class="No-Break"><span class="koboSpan" id="kobo.272.1">field property.</span></span></p>
<p><span class="koboSpan" id="kobo.273.1">From the administrative toolbar, go to </span><strong class="bold"><span class="koboSpan" id="kobo.274.1">Configuration</span></strong><span class="koboSpan" id="kobo.275.1">. </span><span class="koboSpan" id="kobo.275.2">Under the </span><strong class="bold"><span class="koboSpan" id="kobo.276.1">Web services</span></strong><span class="koboSpan" id="kobo.277.1"> section, click on </span><strong class="bold"><span class="koboSpan" id="kobo.278.1">JSON:API Overwrites</span></strong><span class="koboSpan" id="kobo.279.1"> to customize the </span><span class="No-Break"><span class="koboSpan" id="kobo.280.1">JSON:API implementation.</span></span></p>
<p><span class="koboSpan" id="kobo.281.1">To disable an endpoint, click on </span><strong class="bold"><span class="koboSpan" id="kobo.282.1">Overwrite</span></strong><span class="koboSpan" id="kobo.283.1"> on any endpoint. </span><span class="koboSpan" id="kobo.283.2">Check the </span><strong class="bold"><span class="koboSpan" id="kobo.284.1">Disabled</span></strong><span class="koboSpan" id="kobo.285.1"> checkbox to turn off that </span><span class="No-Break"><span class="koboSpan" id="kobo.286.1">specific endpoint:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer098">
<span class="koboSpan" id="kobo.287.1"><img alt="Figure 12.9 – You can disable resources with JSON:API Extras so that endpoints are not accessible" src="image/Figure_12.10_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.288.1">Figure 12.9 – You can disable resources with JSON:API Extras so that endpoints are not accessible</span></p>
<p><span class="koboSpan" id="kobo.289.1">To disable, alias, or</span><a id="_idIndexMarker756"/><span class="koboSpan" id="kobo.290.1"> use an enhancer, click on </span><strong class="bold"><span class="koboSpan" id="kobo.291.1">Overwrite</span></strong><strong class="bold"><a id="_idIndexMarker757"/></strong><span class="koboSpan" id="kobo.292.1"> on any endpoint. </span><span class="koboSpan" id="kobo.292.2">This checkbox will allow you to prevent a field from being used in the API. </span><span class="koboSpan" id="kobo.292.3">The enhancers allow you to simplify fields when returned or used in </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">POST</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.294.1">/</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.295.1">PATCH</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.296.1"> requests:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer099">
<span class="koboSpan" id="kobo.297.1"><img alt="Figure 12.10 – You can change field aliases and disable fields in JSON:API endpoints" src="image/Figure_12.11_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.298.1">Figure 12.10 – You can change field aliases and disable fields in JSON:API endpoints</span></p>
<p><span class="koboSpan" id="kobo.299.1">Here, we </span><a id="_idIndexMarker758"/><span class="koboSpan" id="kobo.300.1">have </span><a id="_idIndexMarker759"/><span class="koboSpan" id="kobo.301.1">disabled the revision fields from appearing in the JSON:API output. </span><span class="koboSpan" id="kobo.301.2">We can apply enhancers to the created and </span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">changed fields:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer100">
<span class="koboSpan" id="kobo.303.1"><img alt="Figure 12.11 – Using enhancers to format data returned in JSON:API" src="image/Figure_12.12_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.304.1">Figure 12.11 – Using enhancers to format data returned in JSON:API</span></p>
<p><span class="koboSpan" id="kobo.305.1">In this example, the created and changed fields will no longer return Unix timestamps, but </span><em class="italic"><span class="koboSpan" id="kobo.306.1">RFC ISO </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.307.1">8601</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.308.1">-formatted timestamps.</span></span></p>
<p><span class="koboSpan" id="kobo.309.1">Going back and viewing our JSON:API route now, we can see that revision fields were removed and that the </span><a id="_idIndexMarker760"/><span class="koboSpan" id="kobo.310.1">created and changed fields </span><span class="No-Break"><span class="koboSpan" id="kobo.311.1">are </span></span><span class="No-Break"><a id="_idIndexMarker761"/></span><span class="No-Break"><span class="koboSpan" id="kobo.312.1">formatted:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer101">
<span class="koboSpan" id="kobo.313.1"><img alt="Figure 12.12 – A JSON:API response customized by the JSON:API Extras module" src="image/Figure_12.13_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.314.1">Figure 12.12 – A JSON:API response customized by the JSON:API Extras module</span></p>
<h2 id="_idParaDest-361"><a id="_idTextAnchor391"/><span class="koboSpan" id="kobo.315.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.316.1">JSON and XML are not the only formats Drupal can return data in as a response. </span><span class="koboSpan" id="kobo.316.2">There are contributed modules that provide other data formats as well, such as PDF, CSV, and XLS (Excel) serialization. </span><span class="koboSpan" id="kobo.316.3">Check </span><a id="_idIndexMarker762"/><span class="koboSpan" id="kobo.317.1">out the source code </span><a id="_idIndexMarker763"/><span class="koboSpan" id="kobo.318.1">of these modules if you are curious as to how </span><span class="No-Break"><span class="koboSpan" id="kobo.319.1">they work:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.320.1">PDF </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">serialization: </span></span><a href="https://www.drupal.org/project/pdf_serialization"><span class="No-Break"><span class="koboSpan" id="kobo.322.1">https://www.drupal.org/project/pdf_serialization</span></span></a></li>
<li><span class="koboSpan" id="kobo.323.1">CSV </span><span class="No-Break"><span class="koboSpan" id="kobo.324.1">serialization: </span></span><a href="https://www.drupal.org/project/csv_serialization"><span class="No-Break"><span class="koboSpan" id="kobo.325.1">https://www.drupal.org/project/csv_serialization</span></span></a></li>
<li><span class="koboSpan" id="kobo.326.1">Excel</span><a id="_idIndexMarker764"/><span class="koboSpan" id="kobo.327.1"> Serialization </span><span class="No-Break"><span class="koboSpan" id="kobo.328.1">serialization: </span></span><a href="https://www.drupal.org/project/xls_serialization"><span class="No-Break"><span class="koboSpan" id="kobo.329.1">https://www.drupal.org/project/xls_serialization</span></span></a></li>
</ul>
<h1 id="_idParaDest-362"><a id="_idTextAnchor392"/><span class="koboSpan" id="kobo.330.1">Using POST to create data with JSON:API</span></h1>
<p><span class="koboSpan" id="kobo.331.1">An API that </span><a id="_idIndexMarker765"/><span class="koboSpan" id="kobo.332.1">returns </span><a id="_idIndexMarker766"/><span class="koboSpan" id="kobo.333.1">data is great, but to make a more functional decoupled app or integrate external services, we need to be able to send data into Drupal as well. </span><span class="koboSpan" id="kobo.333.2">After reading the following section, you will be able to create entities in a Drupal 10 application from </span><span class="No-Break"><span class="koboSpan" id="kobo.334.1">remote sources.</span></span></p>
<h2 id="_idParaDest-363"><a id="_idTextAnchor393"/><span class="koboSpan" id="kobo.335.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.336.1">We are going to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">Article</span></strong><span class="koboSpan" id="kobo.338.1"> content type that comes installed in the Drupal 10 standard profile. </span><span class="koboSpan" id="kobo.338.2">If you do not have an </span><strong class="source-inline"><span class="koboSpan" id="kobo.339.1">Article</span></strong><span class="koboSpan" id="kobo.340.1"> content type, create one and add a basic field such </span><span class="No-Break"><span class="koboSpan" id="kobo.341.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.342.1">Body</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.343.1">.</span></span></p>
<h2 id="_idParaDest-364"><a id="_idTextAnchor394"/><span class="koboSpan" id="kobo.344.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.345.1">First, we need to tell Drupal to allow CRUD operations for JSON:API. </span><span class="koboSpan" id="kobo.345.2">Head back to the JSON:API settings page in the </span><strong class="bold"><span class="koboSpan" id="kobo.346.1">Configuration</span></strong><span class="koboSpan" id="kobo.347.1"> section of the Drupal admin and enable </span><strong class="bold"><span class="koboSpan" id="kobo.348.1">Accept all JSON:API create, read, update, and </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.349.1">delete operations.</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.350.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer102">
<span class="koboSpan" id="kobo.351.1"><img alt="Figure 12.13 – Enabling JSON:API to allow more actions" src="image/Figure_12.14_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.352.1">Figure 12.13 – Enabling JSON:API to allow more actions</span></p>
<p><span class="koboSpan" id="kobo.353.1">If you do not enable this, you cannot do anything other than read data from a </span><span class="No-Break"><span class="koboSpan" id="kobo.354.1">JSON:API endpoint.</span></span></p>
<p><span class="koboSpan" id="kobo.355.1">Next, create a user account that has only the necessary permissions to create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">Article</span></strong><span class="koboSpan" id="kobo.357.1"> node. </span><span class="koboSpan" id="kobo.357.2">This is the account we will use in our requests to create new nodes. </span><span class="koboSpan" id="kobo.357.3">You should </span><a id="_idIndexMarker767"/><span class="koboSpan" id="kobo.358.1">not </span><a id="_idIndexMarker768"/><span class="koboSpan" id="kobo.359.1">use an administrator account in your APIs for </span><span class="No-Break"><span class="koboSpan" id="kobo.360.1">security reasons.</span></span></p>
<p><span class="koboSpan" id="kobo.361.1">With each request to create an API in Drupal, we need to authenticate before our request will </span><span class="No-Break"><span class="koboSpan" id="kobo.362.1">be accepted.</span></span></p>
<p><span class="koboSpan" id="kobo.363.1">Open a terminal (command line). </span><span class="koboSpan" id="kobo.363.2">Unlike the previous section, we cannot perform these requests directly in the browser. </span><span class="koboSpan" id="kobo.363.3">For this, we are going to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.364.1">curl</span></strong><span class="koboSpan" id="kobo.365.1">, which comes pre-installed on many </span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">operating systems:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.367.1">
curl \
    --user chapter12:chapter12 \
    --header 'Accept: application/vnd.api+json' \
    --header 'Content-type: application/vnd.api+json' \
    --request POST https://localhost/jsonapi/node/article \
    --data-binary '{
  "data": {
    "type": "node--article",
    "attributes": {
      "title": "New article created by chapter12",
      "body": {
        "value": "This node was created using JSON:API!",
        "format": "plain_text"
      }
    }
  }
}'</span></pre>
<p><span class="koboSpan" id="kobo.368.1">Again, remember </span><a id="_idIndexMarker769"/><span class="koboSpan" id="kobo.369.1">to </span><a id="_idIndexMarker770"/><span class="koboSpan" id="kobo.370.1">replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.371.1">localhost</span></strong><span class="koboSpan" id="kobo.372.1"> with the correct hostname for your development site. </span><span class="koboSpan" id="kobo.372.2">We created a user named </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">chapter12</span></strong><span class="koboSpan" id="kobo.374.1"> with a password of </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">chapter12</span></strong><span class="koboSpan" id="kobo.376.1"> and set them as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">Content Editor</span></strong><span class="koboSpan" id="kobo.378.1"> role (included with the Standard install profile), which has basic permissions to create and edit nodes. </span><span class="koboSpan" id="kobo.378.2">This user is passed in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">user</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.381.1"> parameter.</span></span></p>
<p><span class="koboSpan" id="kobo.382.1">The response will return either a successful or unsuccessful authorization response. </span><span class="koboSpan" id="kobo.382.2">If it succeeded, you will see a large JSON response reflecting the new node that was created, and you will see the new node </span><span class="No-Break"><span class="koboSpan" id="kobo.383.1">in Drupal:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer103">
<span class="koboSpan" id="kobo.384.1"><img alt="Figure 12.14 – The node created by a POST request" src="image/Figure_12.15_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.385.1">Figure 12.14 – The node created by a POST request</span></p>
<p><span class="koboSpan" id="kobo.386.1">We can also see that it was correctly added to the body field, along with the text format we specified in </span><span class="No-Break"><span class="koboSpan" id="kobo.387.1">the request:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer104">
<span class="koboSpan" id="kobo.388.1"><img alt="Figure 12.15 – Verifying that the content we passed in a POST request was created correctly" src="image/Figure_12.16_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.389.1">Figure 12.15 – Verifying that the content we passed in a POST request was created correctly</span></p>
<p><span class="koboSpan" id="kobo.390.1">If we look back at </span><a id="_idIndexMarker771"/><span class="koboSpan" id="kobo.391.1">our </span><a id="_idIndexMarker772"/><span class="koboSpan" id="kobo.392.1">JSON:API route in the browser, we will see this new node there </span><span class="No-Break"><span class="koboSpan" id="kobo.393.1">as well:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer105">
<span class="koboSpan" id="kobo.394.1"><img alt="Figure 12.16 – Accessing the newly created node with an HTTP request" src="image/Figure_12.17_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.395.1">Figure 12.16 – Accessing the newly created node with an HTTP request</span></p>
<h2 id="_idParaDest-365"><a id="_idTextAnchor395"/><span class="koboSpan" id="kobo.396.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.397.1">In this instance, the JSON:API module</span><a id="_idIndexMarker773"/><span class="koboSpan" id="kobo.398.1"> in</span><a id="_idIndexMarker774"/><span class="koboSpan" id="kobo.399.1"> this instance is not doing anything extra concerning authentication or entity access. </span><span class="koboSpan" id="kobo.399.2">The request is processed by Drupal no differently than if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.400.1">chapter12</span></strong><span class="koboSpan" id="kobo.401.1"> user came to the site, logged in, and created the node in the admin interface. </span></p>
<p><span class="koboSpan" id="kobo.402.1">The type of request is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.403.1">POST</span></strong><span class="koboSpan" id="kobo.404.1"> request. </span><span class="koboSpan" id="kobo.404.2">This is different from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.405.1">GET</span></strong><span class="koboSpan" id="kobo.406.1"> request in the first section for reading data. </span><span class="koboSpan" id="kobo.406.2">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.407.1">POST</span></strong><span class="koboSpan" id="kobo.408.1"> is required to send data to the server. </span><span class="koboSpan" id="kobo.408.2">You can read more about </span><strong class="source-inline"><span class="koboSpan" id="kobo.409.1">POST</span></strong><span class="koboSpan" id="kobo.410.1"> request(s) on </span><span class="No-Break"><span class="koboSpan" id="kobo.411.1">MDN: </span></span><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/POST"><span class="No-Break"><span class="koboSpan" id="kobo.412.1">https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/POST</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.413.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.414.1">This is a powerful abstraction that can help you build out APIs and decoupled applications as it requires valid user authentication, but it cannot perform any actions outside of the scope of what that user/user role is permitted to do. </span><span class="koboSpan" id="kobo.414.2">This means that if we were to remove the permission to </span><strong class="source-inline"><span class="koboSpan" id="kobo.415.1">Create article nodes</span></strong><span class="koboSpan" id="kobo.416.1"> for the Content Editor role, this </span><strong class="source-inline"><span class="koboSpan" id="kobo.417.1">POST</span></strong><span class="koboSpan" id="kobo.418.1"> request would fail with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.419.1">403</span></strong><span class="koboSpan" id="kobo.420.1"> Forbidden response. </span><span class="koboSpan" id="kobo.420.2">Therefore, it is a good idea to create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.421.1">API User</span></strong><span class="koboSpan" id="kobo.422.1"> role with limited permissions in the real world that you can toggle on or off at a </span><span class="No-Break"><span class="koboSpan" id="kobo.423.1">moment’s notice.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.424.1">Never</span></strong><span class="koboSpan" id="kobo.425.1"> use the superuser (</span><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">user 1</span></strong><span class="koboSpan" id="kobo.427.1">) or user with the administrator role for API requests. </span><span class="koboSpan" id="kobo.427.2">If the credentials leak, a bad actor could perform any request they desire. </span><span class="koboSpan" id="kobo.427.3">After reading this chapter, it would be a good idea to review the security considerations when using APIs in Drupal on </span><span class="No-Break"><span class="koboSpan" id="kobo.428.1">Drupal.org: </span></span><a href="https://www.drupal.org/docs/core-modules-and-themes/core-modules/jsonapi-module/security-considerations"><span class="No-Break"><span class="koboSpan" id="kobo.429.1">https://www.drupal.org/docs/core-modules-and-themes/core-modules/jsonapi-module/security-considerations</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.430.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.431.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.432.1">curl</span></strong><span class="koboSpan" id="kobo.433.1"> request, when we pass the </span><strong class="source-inline"><span class="koboSpan" id="kobo.434.1">--user</span></strong><span class="koboSpan" id="kobo.435.1"> parameter, it automatically creates the </span><a id="_idIndexMarker775"/><span class="koboSpan" id="kobo.436.1">Authorization </span><a id="_idIndexMarker776"/><span class="koboSpan" id="kobo.437.1">header for the request. </span><span class="koboSpan" id="kobo.437.2">This header passes along a basic authentication, which the Basic Auth module in Drupal intercepts and uses to authenticate </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">the request.</span></span></p>
<p><span class="koboSpan" id="kobo.439.1">Alternatively, you can get the basic auth token manually with the command line; </span><span class="No-Break"><span class="koboSpan" id="kobo.440.1">for example:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.441.1">
echo -n "chapter12:chapter12" | base64</span></pre>
<p><span class="koboSpan" id="kobo.442.1">This returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">Y2hhcHRlcjEyOmNoYXB0ZXIxMg==</span></strong><span class="koboSpan" id="kobo.444.1">. </span><span class="koboSpan" id="kobo.444.2">Then, you can pass that in a header instead of using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.445.1">–user</span></strong><span class="koboSpan" id="kobo.446.1"> parameter: </span></p>
<pre class="console"><span class="koboSpan" id="kobo.447.1">
curl \
    --header 'Accept: application/vnd.api+json' \
    --header 'Content-type: application/vnd.api+json' \
    --header 'Authorization:Basic Y2hhcHRlcjEyOmNoYXB0ZX
      IxMg=='Y2hhcHRlcjEyOmNoYXB0ZXIxMg==' \
  … rest of request</span></pre>
<h2 id="_idParaDest-366"><a id="_idTextAnchor396"/><span class="koboSpan" id="kobo.448.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.449.1">While powerful, </span><strong class="bold"><span class="koboSpan" id="kobo.450.1">cURL</span></strong><span class="koboSpan" id="kobo.451.1"> is </span><a id="_idIndexMarker777"/><span class="koboSpan" id="kobo.452.1">a low-level tool that can be difficult to use from the command line for longer, larger requests. </span><span class="koboSpan" id="kobo.452.2">You can install Google’s Postman tool to make working with APIs easier. </span><span class="koboSpan" id="kobo.452.3">You can download it </span><span class="No-Break"><span class="koboSpan" id="kobo.453.1">from </span></span><a href="https://www.postman.com/"><span class="No-Break"><span class="koboSpan" id="kobo.454.1">https://www.postman.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.455.1">.</span></span></p>
<h1 id="_idParaDest-367"><a id="_idTextAnchor397"/><span class="koboSpan" id="kobo.456.1">Using PATCH to update data with JSON:API</span></h1>
<p><span class="koboSpan" id="kobo.457.1">Now that</span><a id="_idIndexMarker778"/><span class="koboSpan" id="kobo.458.1"> we know how to create some data </span><a id="_idIndexMarker779"/><span class="koboSpan" id="kobo.459.1">in Drupal, let’s learn how to update </span><span class="No-Break"><span class="koboSpan" id="kobo.460.1">existing data.</span></span></p>
<h2 id="_idParaDest-368"><a id="_idTextAnchor398"/><span class="koboSpan" id="kobo.461.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.462.1">Our request will look similar to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">POST</span></strong><span class="koboSpan" id="kobo.464.1"> request from the previous sections but with a </span><span class="No-Break"><span class="koboSpan" id="kobo.465.1">few changes.</span></span></p>
<p><span class="koboSpan" id="kobo.466.1">First, to update an entity in Drupal, you need to pass the entity UUID in the </span><a id="_idIndexMarker780"/><span class="koboSpan" id="kobo.467.1">request payload for it to work. </span><span class="koboSpan" id="kobo.467.2">This is different than the numeric entity ID. </span><span class="koboSpan" id="kobo.467.3">You can get the UUID from fetching data from JSON:API, as we saw in the </span><em class="italic"><span class="koboSpan" id="kobo.468.1">Fetching data from Drupal using JSON:API</span></em><span class="koboSpan" id="kobo.469.1"> section. </span><span class="koboSpan" id="kobo.469.2">For the node that we created in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.470.1">POST</span></strong><span class="koboSpan" id="kobo.471.1"> request, the UUID value </span><span class="No-Break"><span class="koboSpan" id="kobo.472.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.473.1">1ddf244d-e8e6-40f5-be48-23bc8fa0fa3e</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.474.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.475.1">Let’s go ahead and change the title and body of the article node we created previously. </span><span class="koboSpan" id="kobo.475.2">This time, we must pass the UUID in the URL as well as the </span><span class="No-Break"><span class="koboSpan" id="kobo.476.1">request body:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.477.1">
   curl \
    --user chapter12:chapter12 \
    --header 'Accept: application/vnd.api+json' \
    --header 'Content-type: application/vnd.api+json' \
    --request PATCH 'https://localhost/jsonapi/node/
      article/1ddf244d-e8e6-40f5-be48-23bc8fa0fa3e' \
    --data-binary '{
  "data": {
    "type": "node--article",
    "id": "1ddf244d-e8e6-40f5-be48-23bc8fa0fa3e",
    "attributes": {
      "title": "Article updated by chapter12",
      "body": {
        "value": "This node was updated using JSON:API!",
        "format": "plain_text"
      }
    }
  }
}'</span></pre>
<p><span class="koboSpan" id="kobo.478.1">Note that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">id</span></strong><span class="koboSpan" id="kobo.480.1"> property</span><a id="_idIndexMarker781"/><span class="koboSpan" id="kobo.481.1"> is outside of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.482.1">attributes</span></strong><strong class="source-inline"><a id="_idIndexMarker782"/></strong><span class="koboSpan" id="kobo.483.1"> data. </span><span class="koboSpan" id="kobo.483.2">If you try to pass it under </span><strong class="source-inline"><span class="koboSpan" id="kobo.484.1">attributes</span></strong><span class="koboSpan" id="kobo.485.1">, you will get an </span><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">HTTP 422 Unprocessable Content</span></strong><span class="koboSpan" id="kobo.487.1"> error. </span><span class="koboSpan" id="kobo.487.2">If you pass invalid attributes, you will receive a </span><strong class="source-inline"><span class="koboSpan" id="kobo.488.1">500</span></strong><span class="koboSpan" id="kobo.489.1"> error. </span><span class="koboSpan" id="kobo.489.2">What you are updating must match the data model to </span><span class="No-Break"><span class="koboSpan" id="kobo.490.1">be successful.</span></span></p>
<p><span class="koboSpan" id="kobo.491.1">After submitting this request, we get the updated node back in JSON format on the command line, and we will see in Drupal that our updates </span><span class="No-Break"><span class="koboSpan" id="kobo.492.1">were applied:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer106">
<span class="koboSpan" id="kobo.493.1"><img alt="Figure 12.17 – Reviewing a node that was updated using a PATCH request" src="image/Figure_12.18_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.494.1">Figure 12.17 – Reviewing a node that was updated using a PATCH request</span></p>
<p><span class="koboSpan" id="kobo.495.1">What if we wanted</span><a id="_idIndexMarker783"/><span class="koboSpan" id="kobo.496.1"> to </span><a id="_idIndexMarker784"/><span class="koboSpan" id="kobo.497.1">attribute the node to another user? </span><span class="koboSpan" id="kobo.497.2">It is a good idea to use an account solely to handle API actions, but we certainly don’t want all content attributed to </span><span class="No-Break"><span class="koboSpan" id="kobo.498.1">that user.</span></span></p>
<p><span class="koboSpan" id="kobo.499.1">For example, assume you have an external publishing platform where users are submitting content. </span><span class="koboSpan" id="kobo.499.2">When content is published, that system makes a </span><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">POST</span></strong><span class="koboSpan" id="kobo.501.1"> request to Drupal so that the content is created. </span><span class="koboSpan" id="kobo.501.2">Let’s attribute that content to a user in Drupal named </span><strong class="source-inline"><span class="koboSpan" id="kobo.502.1">Johnny Editor</span></strong><span class="koboSpan" id="kobo.503.1"> with a UUID of </span><strong class="source-inline"><span class="koboSpan" id="kobo.504.1">c1ce9fe6-4eea-4f69-92c2-883415019002</span></strong><span class="koboSpan" id="kobo.505.1">. </span><span class="koboSpan" id="kobo.505.2">Like nodes, you can view user entity data </span><span class="No-Break"><span class="koboSpan" id="kobo.506.1">at </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.507.1">/jsonapi/user/user</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.509.1">We can fix the existing content with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.510.1">PATCH</span></strong><span class="koboSpan" id="kobo.511.1"> request and change the author from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.512.1">chapter12</span></strong><span class="koboSpan" id="kobo.513.1"> user to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.514.1">Johnny Editor</span></strong><span class="koboSpan" id="kobo.515.1"> user by passing </span><strong class="source-inline"><span class="koboSpan" id="kobo.516.1">relationships</span></strong><span class="koboSpan" id="kobo.517.1"> data in the request body. </span><span class="koboSpan" id="kobo.517.2">Before we can do that, though, our API user role needs </span><strong class="bold"><span class="koboSpan" id="kobo.518.1">Administer Content</span></strong><span class="koboSpan" id="kobo.519.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.520.1">Edit any article content</span></strong><span class="koboSpan" id="kobo.521.1"> enabled; otherwise, they will not have access to </span><strong class="source-inline"><span class="koboSpan" id="kobo.522.1">PATCH</span></strong><span class="koboSpan" id="kobo.523.1"> the data. </span><span class="koboSpan" id="kobo.523.2">Go ahead and enable </span><span class="No-Break"><span class="koboSpan" id="kobo.524.1">that permission.</span></span></p>
<p><span class="koboSpan" id="kobo.525.1">This is because, in this example, we are requesting to change ownership of a node from one user to another, and this is explicitly checked by Drupal before the action </span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">is executed.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.527.1">Review your permissions</span></p>
<p class="callout"><span class="koboSpan" id="kobo.528.1">Again, once you’ve read this chapter, it is a good idea to review the security considerations when using APIs in Drupal on </span><span class="No-Break"><span class="koboSpan" id="kobo.529.1">Drupal.org: </span></span><a href="https://www.drupal.org/docs/core-modules-and-themes/core-modules/jsonapi-module/security-considerations"><span class="No-Break"><span class="koboSpan" id="kobo.530.1">https://www.drupal.org/docs/core-modules-and-themes/core-modules/jsonapi-module/security-considerations</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.531.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.532.1">Now, we can make </span><a id="_idIndexMarker785"/><span class="koboSpan" id="kobo.533.1">our</span><a id="_idIndexMarker786"/><span class="koboSpan" id="kobo.534.1"> new </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">PATCH</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.536.1"> request:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.537.1">
   curl \
    --user chapter12:chapter12 \
    --header 'Accept: application/vnd.api+json' \
    --header 'Content-type: application/vnd.api+json' \
    --request PATCH 'https://localhost/jsonapi/node/
      article/1ddf244d-e8e6-40f5-be48-23bc8fa0fa3e' \
    --data-binary '{
  "data": {
    "type": "node--article",
    "id": "1ddf244d-e8e6-40f5-be48-23bc8fa0fa3e",
    "attributes": {
      "title": "Using Drupal 10 PATCH &amp; JSON:API by Johnny 
        Editor",
      "body": {
        "value": "This is how you use Drupal 10 PATCH &amp; 
          JSON:API.",
        "format": "plain_text"
      }
    },
    "relationships": {
      "uid": {
        "data": {
          "type": "user--user",
          "id": "c1ce9fe6-4eea-4f69-92c2-883415019002"
        }
      }
    }
  }
}'</span></pre>
<p><span class="koboSpan" id="kobo.538.1">Here, we receive a </span><a id="_idIndexMarker787"/><span class="koboSpan" id="kobo.539.1">successful </span><a id="_idIndexMarker788"/><span class="koboSpan" id="kobo.540.1">response from Drupal, along with the JSON representation of the node. </span><span class="koboSpan" id="kobo.540.2">We can see that the content was updated and that the node owner was re-assigned to </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.541.1">Johnny Editor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.542.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer107">
<span class="koboSpan" id="kobo.543.1"><img alt="Figure 12.18 – Re-assigning node ownership using a PATCH request" src="image/Figure_12.19_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.544.1">Figure 12.18 – Re-assigning node ownership using a PATCH request</span></p>
<p><span class="koboSpan" id="kobo.545.1">You can use relationships to add any entity reference you want to add to entities. </span><span class="koboSpan" id="kobo.545.2">Using this same formula, we can add some taxonomy to this article. </span><span class="koboSpan" id="kobo.545.3">Let’s assume there are two terms in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.546.1">taxonomy</span></strong><span class="koboSpan" id="kobo.547.1"> tag called </span><strong class="source-inline"><span class="koboSpan" id="kobo.548.1">Technology</span></strong><span class="koboSpan" id="kobo.549.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.550.1">News</span></strong><span class="koboSpan" id="kobo.551.1">. </span><span class="koboSpan" id="kobo.551.2">We want to tag them in </span><span class="No-Break"><span class="koboSpan" id="kobo.552.1">this article.</span></span></p>
<p><span class="koboSpan" id="kobo.553.1">Like nodes and users, you can see taxonomy term data by navigating </span><span class="No-Break"><span class="koboSpan" id="kobo.554.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.555.1">/jsonapi/taxonomy_term/tags</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer108">
<span class="koboSpan" id="kobo.557.1"><img alt="Figure 12.19 – Reading taxonomy terms using its JSON:API endpoint" src="image/Figure_12.20_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.558.1">Figure 12.19 – Reading taxonomy terms using its JSON:API endpoint</span></p>
<p><span class="koboSpan" id="kobo.559.1">Using the UUIDs</span><a id="_idIndexMarker789"/><span class="koboSpan" id="kobo.560.1"> here, we </span><a id="_idIndexMarker790"/><span class="koboSpan" id="kobo.561.1">can pass both of them in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.562.1">relationships</span></strong><span class="koboSpan" id="kobo.563.1"> part of </span><span class="No-Break"><span class="koboSpan" id="kobo.564.1">the request:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.565.1">
   curl \
    --user chapter12:chapter12 \
    --header 'Accept: application/vnd.api+json' \
    --header 'Content-type: application/vnd.api+json' \
    --request PATCH 'https://localhost/jsonapi/node/
      article/1ddf244d-e8e6-40f5-be48-23bc8fa0fa3e' \
    --data-binary '{
  "data": {
    "type": "node--article",
    "id": "1ddf244d-e8e6-40f5-be48-23bc8fa0fa3e",
    "attributes": {
      "title": "Using Drupal 10 PATCH &amp; JSON:API by Johnny 
        Editor",
      "body": {
        "value": "This is how you use Drupal 10 PATCH &amp; 
          JSON:API.",
        "format": "plain_text"
      }
    },
    "relationships": {
      "field_tags": {
        "data": [
          {
            "type": "taxonomy_term--tags",
            "id": "4ef201ed-7cb6-49e5-b125-4c2709be1a42"
          },
          {
            "type": "taxonomy_term--tags",
            "id": "09504010-8eff-4be0-8205-607f9e74ffa1"
          }
       ]
      }
    }
  }
}'</span></pre>
<p><span class="koboSpan" id="kobo.566.1">When submitted, we will see that the article node was successfully updated with the two taxonomy </span><span class="No-Break"><span class="koboSpan" id="kobo.567.1">terms specified:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer109">
<span class="koboSpan" id="kobo.568.1"><img alt="Figure 12.20 – Taxonomy tags added to a node via a PATCH request" src="image/Figure_12.21_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.569.1">Figure 12.20 – Taxonomy tags added to a node via a PATCH request</span></p>
<p><span class="koboSpan" id="kobo.570.1">Now, if we were </span><a id="_idIndexMarker791"/><span class="koboSpan" id="kobo.571.1">to</span><a id="_idIndexMarker792"/><span class="koboSpan" id="kobo.572.1"> fetch the data from Drupal as we did in the first section, we will see the author and taxonomy relationships in the </span><span class="No-Break"><span class="koboSpan" id="kobo.573.1">node data:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer110">
<span class="koboSpan" id="kobo.574.1"><img alt="Figure 12.21 – Taxonomy relationships in the response for a node" src="image/Figure_12.22_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.575.1">Figure 12.21 – Taxonomy relationships in the response for a node</span></p>
<p><span class="koboSpan" id="kobo.576.1">When you</span><a id="_idIndexMarker793"/><span class="koboSpan" id="kobo.577.1"> combine</span><a id="_idIndexMarker794"/><span class="koboSpan" id="kobo.578.1"> that this with </span><strong class="source-inline"><span class="koboSpan" id="kobo.579.1">include</span></strong><span class="koboSpan" id="kobo.580.1"> in the URL query string, you will get the author data, as well as the taxonomy </span><span class="No-Break"><span class="koboSpan" id="kobo.581.1">data: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.582.1">include=uid,field_tags</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.583.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.584.1">If you want to remove referenced items, you can submit a </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">PATCH</span></strong><span class="koboSpan" id="kobo.586.1"> request without that item. </span><span class="koboSpan" id="kobo.586.2">If we wanted to remove one of the terms, we can just pass the term we want </span><span class="No-Break"><span class="koboSpan" id="kobo.587.1">to keep:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.588.1">
"relationships": {
      "field_tags": {
        "data": [
          {
            "type": "taxonomy_term--tags",
            "id": "4ef201ed-7cb6-49e5-b125-4c2709be1a42"
          },
       ]
      }
    }</span></pre>
<p><span class="koboSpan" id="kobo.589.1">To completely </span><a id="_idIndexMarker795"/><span class="koboSpan" id="kobo.590.1">empty </span><a id="_idIndexMarker796"/><span class="koboSpan" id="kobo.591.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.592.1">tags</span></strong><span class="koboSpan" id="kobo.593.1"> field, pass an </span><span class="No-Break"><span class="koboSpan" id="kobo.594.1">empty value:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.595.1">
"relationships": {
      "field_tags": {
        "data": {}
      }
    }</span></pre>
<p><span class="koboSpan" id="kobo.596.1">You will see that the terms have been removed from the </span><span class="No-Break"><span class="koboSpan" id="kobo.597.1">article node:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer111">
<span class="koboSpan" id="kobo.598.1"><img alt="Figure 12.22 – Passing an empty value in a PATCH request will remove relationships" src="image/Figure_12.23_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.599.1">Figure 12.22 – Passing an empty value in a PATCH request will remove relationships</span></p>
<h2 id="_idParaDest-369"><a id="_idTextAnchor399"/><span class="koboSpan" id="kobo.600.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.601.1">Just like </span><strong class="source-inline"><span class="koboSpan" id="kobo.602.1">POST</span></strong><span class="koboSpan" id="kobo.603.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.604.1">PATCH</span></strong><span class="koboSpan" id="kobo.605.1"> provides a powerful way to update entity data in Drupal from a decoupled application or remote system. </span><span class="koboSpan" id="kobo.605.2">When you understand your entity data and schema, you can create and manipulate it in any way that you want via </span><span class="No-Break"><span class="koboSpan" id="kobo.606.1">the API.</span></span></p>
<p><span class="koboSpan" id="kobo.607.1">Also like </span><strong class="source-inline"><span class="koboSpan" id="kobo.608.1">POST</span></strong><span class="koboSpan" id="kobo.609.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.610.1">PATCH</span></strong><span class="koboSpan" id="kobo.611.1"> requests must abide by the permission system in Drupal. </span><span class="koboSpan" id="kobo.611.2">The same rules are respected as if this were a real user logging in to Drupal to </span><span class="No-Break"><span class="koboSpan" id="kobo.612.1">update content.</span></span></p>
<p><span class="koboSpan" id="kobo.613.1">With these</span><a id="_idIndexMarker797"/><span class="koboSpan" id="kobo.614.1"> two </span><a id="_idIndexMarker798"/><span class="koboSpan" id="kobo.615.1">methods, you can create a decoupled site that can collect data from users and post it back to Drupal, such as a kiosk, survey, or commenting system. </span><span class="koboSpan" id="kobo.615.2">The possibilities </span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">are endless.</span></span></p>
<h1 id="_idParaDest-370"><a id="_idTextAnchor400"/><span class="koboSpan" id="kobo.617.1">Using DELETE to remove data with JSON:API</span></h1>
<p><span class="koboSpan" id="kobo.618.1">Finally, we</span><a id="_idIndexMarker799"/><span class="koboSpan" id="kobo.619.1">  have come to the final action </span><a id="_idIndexMarker800"/><span class="koboSpan" id="kobo.620.1">of the CRUD acronym: the </span><strong class="source-inline"><span class="koboSpan" id="kobo.621.1">delete</span></strong><span class="koboSpan" id="kobo.622.1"> method. </span><span class="koboSpan" id="kobo.622.2">This method removes requested data in Drupal, provided you have </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">the UUID.</span></span></p>
<h2 id="_idParaDest-371"><a id="_idTextAnchor401"/><span class="koboSpan" id="kobo.624.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.625.1">Like </span><strong class="source-inline"><span class="koboSpan" id="kobo.626.1">PATCH</span></strong><span class="koboSpan" id="kobo.627.1">, issuing </span><strong class="source-inline"><span class="koboSpan" id="kobo.628.1">DELETE</span></strong><span class="koboSpan" id="kobo.629.1"> requires the appropriate permission in Drupal. </span><span class="koboSpan" id="kobo.629.2">In this case, the role assigned to our API user needs to be allowed to delete article nodes. </span><span class="koboSpan" id="kobo.629.3">Head back to the permissions section of the Drupal admin area and grant </span><strong class="bold"><span class="koboSpan" id="kobo.630.1">Article: Delete any content</span></strong><span class="koboSpan" id="kobo.631.1"> to </span><span class="No-Break"><span class="koboSpan" id="kobo.632.1">the role.</span></span></p>
<p><span class="koboSpan" id="kobo.633.1">We need to assign </span><strong class="source-inline"><span class="koboSpan" id="kobo.634.1">delete any</span></strong><span class="koboSpan" id="kobo.635.1"> instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.636.1">delete own</span></strong><span class="koboSpan" id="kobo.637.1"> since we assigned the node ownership to </span><span class="No-Break"><span class="koboSpan" id="kobo.638.1">another user.</span></span></p>
<p><span class="koboSpan" id="kobo.639.1">All the </span><strong class="source-inline"><span class="koboSpan" id="kobo.640.1">DELETE</span></strong><span class="koboSpan" id="kobo.641.1"> request needs is the UUID of the entity we wish to remove. </span><span class="koboSpan" id="kobo.641.2">Using the node we created, the UUID of it is </span><strong class="source-inline"><span class="koboSpan" id="kobo.642.1">1ddf244d-e8e6-40f5-be48-23bc8fa0fa3e</span></strong><span class="koboSpan" id="kobo.643.1">. </span><span class="koboSpan" id="kobo.643.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.644.1">DELETE</span></strong><span class="koboSpan" id="kobo.645.1"> request looks </span><span class="No-Break"><span class="koboSpan" id="kobo.646.1">like this:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.647.1">
   curl \
    --user chapter12:chapter12 \
    --header 'Accept: application/vnd.api+json' \
    --header 'Content-type: application/vnd.api+json' \
    --request DELETE 'https://localhost/jsonapi/node/
      article/1ddf244d-e8e6-40f5-be48-23bc8fa0fa3e'</span></pre>
<p><span class="koboSpan" id="kobo.648.1">When you submit it this time, there will be no response output on the command line. </span><span class="koboSpan" id="kobo.648.2">When successful, the response will be an </span><strong class="source-inline"><span class="koboSpan" id="kobo.649.1">HTTP 204</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.650.1">empty response.</span></span></p>
<p><span class="koboSpan" id="kobo.651.1">The JSON:API route </span><a id="_idIndexMarker801"/><span class="koboSpan" id="kobo.652.1">now shows no nodes, </span><a id="_idIndexMarker802"/><span class="koboSpan" id="kobo.653.1">which means </span><strong class="source-inline"><span class="koboSpan" id="kobo.654.1">DELETE</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.655.1">was successful:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer112">
<span class="koboSpan" id="kobo.656.1"><img alt="Figure 12.23 – After using a DELETE request, the node was successfully deleted" src="image/Figure_12.24_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.657.1">Figure 12.23 – After using a DELETE request, the node was successfully deleted</span></p>
<h2 id="_idParaDest-372"><a id="_idTextAnchor402"/><span class="koboSpan" id="kobo.658.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.659.1">Just like </span><strong class="source-inline"><span class="koboSpan" id="kobo.660.1">POST</span></strong><span class="koboSpan" id="kobo.661.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.662.1">PATCH</span></strong><span class="koboSpan" id="kobo.663.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.664.1">DELETE</span></strong><span class="koboSpan" id="kobo.665.1"> performs actions on behalf of the specified user. </span><span class="koboSpan" id="kobo.665.2">Since this user has permission to </span><strong class="source-inline"><span class="koboSpan" id="kobo.666.1">delete any</span></strong><span class="koboSpan" id="kobo.667.1"> article content, the request is permitted and Drupal removes the article node from </span><span class="No-Break"><span class="koboSpan" id="kobo.668.1">the website.</span></span></p>
<p><span class="koboSpan" id="kobo.669.1">For some use cases, </span><strong class="source-inline"><span class="koboSpan" id="kobo.670.1">DELETE</span></strong><span class="koboSpan" id="kobo.671.1"> may be too destructive of an action to either have an API perform or permission to grant. </span><span class="koboSpan" id="kobo.671.2">In this case, you could use </span><strong class="source-inline"><span class="koboSpan" id="kobo.672.1">PATCH</span></strong><span class="koboSpan" id="kobo.673.1"> and change the entity</span><a id="_idIndexMarker803"/><span class="koboSpan" id="kobo.674.1"> status </span><a id="_idIndexMarker804"/><span class="koboSpan" id="kobo.675.1">to </span><strong class="source-inline"><span class="koboSpan" id="kobo.676.1">unpublished</span></strong><span class="koboSpan" id="kobo.677.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.678.1">archived</span></strong><span class="koboSpan" id="kobo.679.1"> (if using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.680.1">Content </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.681.1">Moderation</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.682.1"> module).</span></span></p>
<h1 id="_idParaDest-373"><a id="_idTextAnchor403"/><span class="koboSpan" id="kobo.683.1">Using Views to provide custom data sources</span></h1>
<p><span class="koboSpan" id="kobo.684.1">The RESTful Web </span><a id="_idIndexMarker805"/><span class="koboSpan" id="kobo.685.1">Services module provides</span><a id="_idIndexMarker806"/><span class="koboSpan" id="kobo.686.1"> Views plugins that allow you to expose data over Views for your RESTful API. </span><span class="koboSpan" id="kobo.686.2">This allows you to create a view that has a path and outputs data using a serializer plugin. </span><span class="koboSpan" id="kobo.686.3">You can use this to output entities in JSON or XML and it can be sent with </span><span class="No-Break"><span class="koboSpan" id="kobo.687.1">appropriate headers.</span></span></p>
<p><span class="koboSpan" id="kobo.688.1">In this recipe, we will create a view that outputs the users of the Drupal site, providing their username, email, and picture </span><span class="No-Break"><span class="koboSpan" id="kobo.689.1">if provided.</span></span></p>
<h2 id="_idParaDest-374"><a id="_idTextAnchor404"/><span class="koboSpan" id="kobo.690.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.691.1">Make sure you have the following core </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">modules enabled:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.693.1">Views</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.694.1">Views UI</span></span></li>
<li><span class="koboSpan" id="kobo.695.1">RESTful </span><span class="No-Break"><span class="koboSpan" id="kobo.696.1">Web Services</span></span></li>
</ul>
<h2 id="_idParaDest-375"><a id="_idTextAnchor405"/><span class="koboSpan" id="kobo.697.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.698.1">Navigate to </span><strong class="bold"><span class="koboSpan" id="kobo.699.1">Structure</span></strong><span class="koboSpan" id="kobo.700.1"> and then </span><strong class="bold"><span class="koboSpan" id="kobo.701.1">Views</span></strong><span class="koboSpan" id="kobo.702.1">. </span></li>
<li><span class="koboSpan" id="kobo.703.1">Click on </span><strong class="bold"><span class="koboSpan" id="kobo.704.1">Add new view</span></strong><span class="koboSpan" id="kobo.705.1">. </span></li>
<li><span class="koboSpan" id="kobo.706.1">Name the view </span><strong class="source-inline"><span class="koboSpan" id="kobo.707.1">API Users</span></strong><span class="koboSpan" id="kobo.708.1"> and have it show </span><strong class="bold"><span class="koboSpan" id="kobo.709.1">Users</span></strong><span class="koboSpan" id="kobo.710.1">. </span><span class="koboSpan" id="kobo.710.2">At the bottom of the View creation page, check off </span><strong class="bold"><span class="koboSpan" id="kobo.711.1">Provide a REST export</span></strong><span class="koboSpan" id="kobo.712.1">. </span><span class="koboSpan" id="kobo.712.2">Give it a path </span><span class="No-Break"><span class="koboSpan" id="kobo.713.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.714.1">/api/users</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.715.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer113">
<span class="koboSpan" id="kobo.716.1"><img alt="Figure 12.24 – Setting the path for Views for a custom REST endpoint" src="image/Figure_12.25_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.717.1">Figure 12.24 – Setting the path for Views for a custom REST endpoint</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.718.1">Save the view </span><span class="No-Break"><span class="koboSpan" id="kobo.719.1">and continue.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.720.1">With the </span><a id="_idIndexMarker807"/><span class="koboSpan" id="kobo.721.1">view</span><a id="_idIndexMarker808"/><span class="koboSpan" id="kobo.722.1"> created, make the </span><span class="No-Break"><span class="koboSpan" id="kobo.723.1">following changes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.724.1">Change the format of the row plugin from </span><strong class="bold"><span class="koboSpan" id="kobo.725.1">Entity</span></strong><span class="koboSpan" id="kobo.726.1"> to </span><strong class="bold"><span class="koboSpan" id="kobo.727.1">Fields</span></strong><span class="koboSpan" id="kobo.728.1"> so that we can control the </span><span class="No-Break"><span class="koboSpan" id="kobo.729.1">specific output.</span></span></li>
<li><span class="koboSpan" id="kobo.730.1">Under the </span><strong class="bold"><span class="koboSpan" id="kobo.731.1">Settings</span></strong><span class="koboSpan" id="kobo.732.1"> section of format, enable </span><strong class="bold"><span class="koboSpan" id="kobo.733.1">json</span></strong><span class="koboSpan" id="kobo.734.1"> under </span><strong class="bold"><span class="koboSpan" id="kobo.735.1">Accepted </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.736.1">request formats</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.737.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.738.1">Ensure that your view has </span><strong class="bold"><span class="koboSpan" id="kobo.739.1">Name</span></strong><span class="koboSpan" id="kobo.740.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.741.1">Email</span></strong><span class="koboSpan" id="kobo.742.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.743.1">Picture</span></strong><span class="koboSpan" id="kobo.744.1"> as user </span><span class="No-Break"><span class="koboSpan" id="kobo.745.1">entity fields</span></span></li>
<li><span class="koboSpan" id="kobo.746.1">Change the </span><strong class="bold"><span class="koboSpan" id="kobo.747.1">User: Name</span></strong><span class="koboSpan" id="kobo.748.1"> field to the </span><strong class="bold"><span class="koboSpan" id="kobo.749.1">Plain text</span></strong><span class="koboSpan" id="kobo.750.1"> formatter. </span><span class="koboSpan" id="kobo.750.2">Do not link it to the user to ensure the response does not contain </span><span class="No-Break"><span class="koboSpan" id="kobo.751.1">any HTML.</span></span></li>
<li><span class="koboSpan" id="kobo.752.1">Change the </span><strong class="bold"><span class="koboSpan" id="kobo.753.1">User: Picture</span></strong><span class="koboSpan" id="kobo.754.1"> field so that it uses the URL to image formatter so that only a URL is returned and </span><span class="No-Break"><span class="koboSpan" id="kobo.755.1">not HTML.</span></span></li>
<li><span class="koboSpan" id="kobo.756.1">Save the </span><span class="No-Break"><span class="koboSpan" id="kobo.757.1">updated View.</span></span></li>
<li><span class="koboSpan" id="kobo.758.1">Access your view by visiting </span><strong class="source-inline"><span class="koboSpan" id="kobo.759.1">/api/users</span></strong><span class="koboSpan" id="kobo.760.1">. </span><span class="koboSpan" id="kobo.760.2">You will receive a JSON response containing the </span><span class="No-Break"><span class="koboSpan" id="kobo.761.1">user information.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.762.1">In your browser, you will see the output of the users in your system formatted in the way we set it in </span><span class="No-Break"><span class="koboSpan" id="kobo.763.1">the View:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.764.1">
[
  {
    "name": "spuvest",
    "mail": "spuvest@example.com", 
    "user_picture": "\/sites\/default\/files\/pictures\/
      2017-07\/generateImage_xIQkfx.jpg"
  },
  {
    "name": "crepathuslus",
    "mail": "crepathuslus@example.com", 
    "user_picture": "\/sites\/default\/files\/pictures\/
      2017-07\/generateImage_eauTko.gif"
  },
  {
    "name": "veradabufrup",
    "mail": "veradabufrup@example.com", 
    "user_picture": "\/sites\/default\/files\/pictures\/
      2017-07\/generateImage_HsEjKW.png"
  }
]</span></pre>
<h2 id="_idParaDest-376"><a id="_idTextAnchor406"/><span class="koboSpan" id="kobo.765.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.766.1">The RESTful Web</span><a id="_idIndexMarker809"/><span class="koboSpan" id="kobo.767.1"> Services </span><a id="_idIndexMarker810"/><span class="koboSpan" id="kobo.768.1">module provides a display, row, and format plugin that allows you to export content entities in a serialized format. </span><span class="koboSpan" id="kobo.768.2">The REST Export display plugin is what allows you to specify a path to access the RESTful endpoint, and properly assigns the </span><strong class="source-inline"><span class="koboSpan" id="kobo.769.1">Content-Type</span></strong><span class="koboSpan" id="kobo.770.1"> header for the </span><span class="No-Break"><span class="koboSpan" id="kobo.771.1">requested format.</span></span></p>
<p><span class="koboSpan" id="kobo.772.1">The Serializer style is provided as the only supported style plugin for the REST Export display. </span><span class="koboSpan" id="kobo.772.2">This style plugin only supports row plugins that identify themselves as data display types. </span><span class="koboSpan" id="kobo.772.3">It expects data from the row plugin to be raw so that it can be passed to the </span><span class="No-Break"><span class="koboSpan" id="kobo.773.1">appropriate serializer.</span></span></p>
<p><span class="koboSpan" id="kobo.774.1">You then have the option of using the Data entity or Data field row plugins. </span><span class="koboSpan" id="kobo.774.2">Instead of returning a render array from their render method, they return raw data that will be serialized into the proper format. </span><span class="koboSpan" id="kobo.774.3">With the row plugins returning raw format data and the data then serialized by the style plugin, the display plugin will return the response, converted into the proper format via the Serialization module, which we saw earlier in </span><span class="No-Break"><span class="koboSpan" id="kobo.775.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.776.1">Using Views is an excellent way to provide API routes for reading. </span><span class="koboSpan" id="kobo.776.2">You get all the convenience of using the Views UI that you are used to in Drupal with the combined power of JSON </span><a id="_idIndexMarker811"/><span class="koboSpan" id="kobo.777.1">or</span><a id="_idIndexMarker812"/><span class="koboSpan" id="kobo.778.1"> XML serialization. </span><span class="koboSpan" id="kobo.778.2">You can create as many of these as you need to satisfy different </span><span class="No-Break"><span class="koboSpan" id="kobo.779.1">use cases.</span></span></p>
<h2 id="_idParaDest-377"><a id="_idTextAnchor407"/><span class="koboSpan" id="kobo.780.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.781.1">Views allow you to deliver specific RESTful endpoints. </span><span class="koboSpan" id="kobo.781.2">With Views, you can add displays with custom paths and add fields to them, creating a custom JSON response. </span><span class="koboSpan" id="kobo.781.3">This makes for a rapid way of developing custom read-only data APIs </span><span class="No-Break"><span class="koboSpan" id="kobo.782.1">in Drupal.</span></span></p>
<h3><span class="koboSpan" id="kobo.783.1">Controlling the key name in the JSON output</span></h3>
<p><span class="koboSpan" id="kobo.784.1">The Data fields</span><a id="_idIndexMarker813"/><span class="koboSpan" id="kobo.785.1"> row plugin allows you to configure field aliases. </span><span class="koboSpan" id="kobo.785.2">When the data is returned to the view, it will contain Drupal’s machine names. </span><span class="koboSpan" id="kobo.785.3">This means that custom fields will look something like </span><strong class="source-inline"><span class="koboSpan" id="kobo.786.1">field_my_field</span></strong><span class="koboSpan" id="kobo.787.1">, which may not make sense to the consumer. </span><span class="koboSpan" id="kobo.787.2">By clicking on </span><strong class="bold"><span class="koboSpan" id="kobo.788.1">Settings</span></strong><span class="koboSpan" id="kobo.789.1"> next to </span><strong class="bold"><span class="koboSpan" id="kobo.790.1">Fields</span></strong><span class="koboSpan" id="kobo.791.1">, you can set aliases in the </span><span class="No-Break"><span class="koboSpan" id="kobo.792.1">modal form:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer114">
<span class="koboSpan" id="kobo.793.1"><img alt="Figure 12.25 – You can alias field names in a Views REST display" src="image/Figure_12.26_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.794.1">Figure 12.25 – You can alias field names in a Views REST display</span></p>
<p><span class="koboSpan" id="kobo.795.1">When you provide an</span><a id="_idIndexMarker814"/><span class="koboSpan" id="kobo.796.1"> alias, the fields will match. </span><span class="koboSpan" id="kobo.796.2">For example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.797.1">user_picture</span></strong><span class="koboSpan" id="kobo.798.1"> can be changed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.799.1">avatar</span></strong><span class="koboSpan" id="kobo.800.1"> and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.801.1">mail</span></strong><span class="koboSpan" id="kobo.802.1"> key can be changed </span><span class="No-Break"><span class="koboSpan" id="kobo.803.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.804.1">email</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.805.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.806.1">
[
  {
    "name": "spuvest",
    "email": "spuvest@example.com", 
    "avatar": "\/sites\/default\/files\/pictures\/2017-07\/ 
      generateImage_xIQkfx.jpg"
  },
]</span></pre>
<h3><span class="koboSpan" id="kobo.807.1">Controlling access to RESTful Views</span></h3>
<p><span class="koboSpan" id="kobo.808.1">When you create </span><a id="_idIndexMarker815"/><span class="koboSpan" id="kobo.809.1">a RESTful endpoint with Views, you are not using the same permissions created by the RESTful Web Services module. </span><span class="koboSpan" id="kobo.809.2">You need to define the route permissions within the view, allowing you to specify specific roles or permissions for </span><span class="No-Break"><span class="koboSpan" id="kobo.810.1">the request.</span></span></p>
<p><span class="koboSpan" id="kobo.811.1">The default </span><strong class="source-inline"><span class="koboSpan" id="kobo.812.1">GET</span></strong><span class="koboSpan" id="kobo.813.1"> method provided by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.814.1">EntityResource</span></strong><span class="koboSpan" id="kobo.815.1"> plugin does not provide a way to list entities and allows any entity to be retrieved by an ID. </span><span class="koboSpan" id="kobo.815.2">Using Views, you can provide a list of entities, limiting them to specific bundles and </span><span class="No-Break"><span class="koboSpan" id="kobo.816.1">much more.</span></span></p>
<p><span class="koboSpan" id="kobo.817.1">With Views, you can even provide a new endpoint to retrieve a specific entity. </span><span class="koboSpan" id="kobo.817.2">Using Contextual filters, you can add route parameters and filters to limit and validate entity IDs. </span><span class="koboSpan" id="kobo.817.3">For example, you </span><a id="_idIndexMarker816"/><span class="koboSpan" id="kobo.818.1">may want to expose the article content over the API, but </span><span class="No-Break"><span class="koboSpan" id="kobo.819.1">not pages.</span></span></p>
<h1 id="_idParaDest-378"><a id="_idTextAnchor408"/><span class="koboSpan" id="kobo.820.1">Using OAuth methods</span></h1>
<p><span class="koboSpan" id="kobo.821.1">Using the RESTful Web Services </span><a id="_idIndexMarker817"/><span class="koboSpan" id="kobo.822.1">module, we can define specific supported </span><a id="_idIndexMarker818"/><span class="koboSpan" id="kobo.823.1">authentication providers for an endpoint. </span><span class="koboSpan" id="kobo.823.2">Drupal core provides a cookie provider, which authenticates through a valid cookie, such as your regular login experience. </span><span class="koboSpan" id="kobo.823.3">Then, there is the HTTP Basic Authentication module to support HTTP </span><span class="No-Break"><span class="koboSpan" id="kobo.824.1">authentication headers.</span></span></p>
<p><span class="koboSpan" id="kobo.825.1">Some alternatives provide more robust authentication methods. </span><span class="koboSpan" id="kobo.825.2">With cookie-based authentication, you need to use CSRF tokens to prevent unrequested page loads by an unauthorized party. </span><span class="koboSpan" id="kobo.825.3">When you use HTTP authentication, you are sending a password for each request in the </span><span class="No-Break"><span class="koboSpan" id="kobo.826.1">request header.</span></span></p>
<p><span class="koboSpan" id="kobo.827.1">A popular, and open, authorization framework is OAuth. </span><span class="koboSpan" id="kobo.827.2">OAuth is a proper authentication method that uses tokens and not passwords. </span><span class="koboSpan" id="kobo.827.3">In this recipe, we will implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.828.1">Simple OAuth</span></strong><span class="koboSpan" id="kobo.829.1"> module to provide OAuth 2.0 authentication for </span><strong class="source-inline"><span class="koboSpan" id="kobo.830.1">GET</span></strong><span class="koboSpan" id="kobo.831.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.832.1">POST</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.833.1"> requests.</span></span></p>
<h2 id="_idParaDest-379"><a id="_idTextAnchor409"/><span class="koboSpan" id="kobo.834.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.835.1">If you are not familiar with OAuth or OAuth 2.0, it is a standard for authorization. </span><span class="koboSpan" id="kobo.835.2">The implementation of OAuth revolves around the usage of tokens sent in HTTP headers. </span><span class="koboSpan" id="kobo.835.3">Refer to the OAuth home page for more </span><span class="No-Break"><span class="koboSpan" id="kobo.836.1">information: </span></span><a href="http://oauth.net/"><span class="No-Break"><span class="koboSpan" id="kobo.837.1">http://oauth.net/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.838.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.839.1">For the following sections, you will need the contributed</span><a id="_idIndexMarker819"/> <strong class="bold"><span class="koboSpan" id="kobo.840.1">Rest UI</span></strong><span class="koboSpan" id="kobo.841.1"> module. </span><span class="koboSpan" id="kobo.841.2">Rest UI will make it easier for you to see and control your REST-based routes </span><span class="No-Break"><span class="koboSpan" id="kobo.842.1">in Drupal.</span></span></p>
<h2 id="_idParaDest-380"><a id="_idTextAnchor410"/><span class="koboSpan" id="kobo.843.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.844.1">Go ahead and get the necessary module </span><span class="No-Break"><span class="koboSpan" id="kobo.845.1">with Composer:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.846.1">
composer require drupal/restui:^1.0</span></pre>
<p><span class="koboSpan" id="kobo.847.1">Enable the </span><strong class="bold"><span class="koboSpan" id="kobo.848.1">REST UI</span></strong><span class="koboSpan" id="kobo.849.1"> module in the admin area </span><span class="No-Break"><span class="koboSpan" id="kobo.850.1">under </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.851.1">Extend</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.852.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.853.1">Now, do </span><span class="No-Break"><span class="koboSpan" id="kobo.854.1">the following:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.855.1">First, we must add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.856.1">Simple OAuth</span></strong><span class="koboSpan" id="kobo.857.1"> module to our Drupal site: </span><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.858.1">composer require drupal/simple_oauth:^6.0@beta</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.859.1">Go to </span><strong class="bold"><span class="koboSpan" id="kobo.860.1">Configuration</span></strong><span class="koboSpan" id="kobo.861.1"> and click on </span><strong class="bold"><span class="koboSpan" id="kobo.862.1">REST</span></strong><span class="koboSpan" id="kobo.863.1"> under </span><strong class="bold"><span class="koboSpan" id="kobo.864.1">Web Services</span></strong><span class="koboSpan" id="kobo.865.1"> to configure the </span><span class="No-Break"><span class="koboSpan" id="kobo.866.1">available endpoints:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer115">
<span class="koboSpan" id="kobo.867.1"><img alt="Figure 12.26 – With the REST UI module, you can manage RESTful endpoints in the admin" src="image/Figure_12.27_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.868.1">Figure 12.26 – With the REST UI module, you can manage RESTful endpoints in the admin</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.869.1">Now that the </span><a id="_idIndexMarker820"/><span class="koboSpan" id="kobo.870.1">endpoint has been enabled, it</span><a id="_idIndexMarker821"/><span class="koboSpan" id="kobo.871.1"> must be configured. </span><span class="koboSpan" id="kobo.871.2">Check the </span><strong class="bold"><span class="koboSpan" id="kobo.872.1">GET</span></strong><span class="koboSpan" id="kobo.873.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.874.1">POST</span></strong><span class="koboSpan" id="kobo.875.1"> method checkboxes to allow </span><strong class="source-inline"><span class="koboSpan" id="kobo.876.1">GET</span></strong><span class="koboSpan" id="kobo.877.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.878.1">POST</span></strong><span class="koboSpan" id="kobo.879.1"> requests. </span><span class="koboSpan" id="kobo.879.2">Then, check the </span><strong class="bold"><span class="koboSpan" id="kobo.880.1">JSON</span></strong><span class="koboSpan" id="kobo.881.1"> checkbox so that data can be returned as JSON. </span><span class="koboSpan" id="kobo.881.2">Check the </span><strong class="bold"><span class="koboSpan" id="kobo.882.1">oauth2</span></strong><span class="koboSpan" id="kobo.883.1"> checkbox and then </span><span class="No-Break"><span class="koboSpan" id="kobo.884.1">save it.</span></span></li>
<li><span class="koboSpan" id="kobo.885.1">Before we can configure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.886.1">Simple OAuth</span></strong><span class="koboSpan" id="kobo.887.1"> module, we have to generate a pair of keys to encrypt the </span><strong class="source-inline"><span class="koboSpan" id="kobo.888.1">OAuth</span></strong><span class="koboSpan" id="kobo.889.1"> tokens. </span><span class="koboSpan" id="kobo.889.2">We can do this in one of </span><span class="No-Break"><span class="koboSpan" id="kobo.890.1">two ways:</span></span><ol><li><span class="koboSpan" id="kobo.891.1">Create a directory outside of the webroot, then click </span><strong class="bold"><span class="koboSpan" id="kobo.892.1">Generate keys</span></strong><span class="koboSpan" id="kobo.893.1">. </span><span class="koboSpan" id="kobo.893.2">In the dialog that appears, add the full path to this folder on the server and </span><span class="No-Break"><span class="koboSpan" id="kobo.894.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.895.1">Generate</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.896.1">.</span></span></li><li><span class="koboSpan" id="kobo.897.1">If the admin UI does not work, we can use the following two commands to generate keys. </span><span class="koboSpan" id="kobo.897.2">Place them on the server outside of </span><span class="No-Break"><span class="koboSpan" id="kobo.898.1">the webroot:</span></span></li></ol><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.899.1">openssl genrsa -out private.key 2048</span></strong></pre><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.900.1">openssl rsa -in private.key -pubout &gt; public.key</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.901.1">With the keys generated, go to the </span><strong class="bold"><span class="koboSpan" id="kobo.902.1">Configuration</span></strong><span class="koboSpan" id="kobo.903.1"> page and then to </span><strong class="bold"><span class="koboSpan" id="kobo.904.1">Simple OAuth</span></strong><span class="koboSpan" id="kobo.905.1">. </span><span class="koboSpan" id="kobo.905.2">Enter the paths to the private and public keys that were just generated and click on </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.906.1">Save configuration</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.907.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer116">
<span class="koboSpan" id="kobo.908.1"><img alt="Figure 12.27 – Managing keys in Simple OAuth in the admin area" src="image/Figure_12.28_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.909.1">Figure 12.27 – Managing keys in Simple OAuth in the admin area</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.910.1">From the </span><strong class="bold"><span class="koboSpan" id="kobo.911.1">Simple</span></strong><strong class="bold"><a id="_idIndexMarker822"/></strong><strong class="bold"><span class="koboSpan" id="kobo.912.1"> OAuth</span></strong><strong class="bold"><a id="_idIndexMarker823"/></strong><strong class="bold"><span class="koboSpan" id="kobo.913.1"> Settings</span></strong><span class="koboSpan" id="kobo.914.1"> configuration form, click on</span><strong class="bold"><span class="koboSpan" id="kobo.915.1"> +</span></strong> <strong class="bold"><span class="koboSpan" id="kobo.916.1">Add Client</span></strong><span class="koboSpan" id="kobo.917.1">. </span><span class="koboSpan" id="kobo.917.2">Provide a label for the client and select the </span><strong class="bold"><span class="koboSpan" id="kobo.918.1">Administrator</span></strong><span class="koboSpan" id="kobo.919.1"> scope. </span><span class="koboSpan" id="kobo.919.2">Then, click on </span><strong class="bold"><span class="koboSpan" id="kobo.920.1">Save</span></strong><span class="koboSpan" id="kobo.921.1"> to create </span><span class="No-Break"><span class="koboSpan" id="kobo.922.1">the client.</span></span></li>
<li><span class="koboSpan" id="kobo.923.1">Next, we will generate a token through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.924.1">/oauth/</span></strong><span class="koboSpan" id="kobo.925.1"> token endpoint. </span><span class="koboSpan" id="kobo.925.2">You will need the ID from the client you just created. </span><span class="koboSpan" id="kobo.925.3">We must pass </span><strong class="source-inline"><span class="koboSpan" id="kobo.926.1">grant_type</span></strong><span class="koboSpan" id="kobo.927.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.928.1">client_id</span></strong><span class="koboSpan" id="kobo.929.1">, and the username and password. </span><strong class="source-inline"><span class="koboSpan" id="kobo.930.1">grant_type</span></strong><span class="koboSpan" id="kobo.931.1"> is the password, whereas </span><strong class="source-inline"><span class="koboSpan" id="kobo.932.1">client_id</span></strong><span class="koboSpan" id="kobo.933.1"> is the ID from the created client. </span><span class="koboSpan" id="kobo.933.2">The username and password will be of the account you wish </span><span class="No-Break"><span class="koboSpan" id="kobo.934.1">to use:</span></span><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.935.1">curl -X POST https://localhost/oauth/token \</span></strong></pre><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.936.1">  -H 'content-type: application/x-www-form-</span></strong></pre><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.937.1">    urlencoded' \</span></strong></pre><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.938.1">  -d 'grant_type=client_credentials&amp;client_id=</span></strong></pre><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.939.1">    CLIENT_ID&amp;username=chapter12&amp;client_secret=</span></strong></pre><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.940.1">      chapter12'</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.941.1">The response will contain an </span><strong class="source-inline"><span class="koboSpan" id="kobo.942.1">access_token</span></strong><span class="koboSpan" id="kobo.943.1"> property. </span><span class="koboSpan" id="kobo.943.2">This is to be used as your token when making </span><span class="No-Break"><span class="koboSpan" id="kobo.944.1">API requests.</span></span></li>
<li><span class="koboSpan" id="kobo.945.1">Request a node over REST with the </span><strong class="bold"><span class="koboSpan" id="kobo.946.1">Authorization: Bearer [</span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.947.1">token]</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.948.1"> header:</span></span><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.949.1">curl -X GET 'https://localhost/node/8?_format=json' \</span></strong></pre><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.950.1"> -H 'accept: application/json' \</span></strong></pre><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.951.1"> -H 'authorization: Bearer ACCESS_TOKEN'</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.952.1">That’s it! </span><span class="koboSpan" id="kobo.952.2">You can now set authenticated routes using OAuth to various resources in Drupal and configure </span><a id="_idIndexMarker824"/><span class="koboSpan" id="kobo.953.1">all the </span><a id="_idIndexMarker825"/><span class="koboSpan" id="kobo.954.1">different REST endpoints with the methods and authentication types </span><span class="No-Break"><span class="koboSpan" id="kobo.955.1">they accept.</span></span></p>
<h2 id="_idParaDest-381"><a id="_idTextAnchor411"/><span class="koboSpan" id="kobo.956.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.957.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.958.1">Simple OAuth</span></strong><span class="koboSpan" id="kobo.959.1"> module is built using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.960.1">League\OAuth2</span></strong><span class="koboSpan" id="kobo.961.1"> PHP library, a community standard library for </span><span class="No-Break"><span class="koboSpan" id="kobo.962.1">OAuth2 implementation.</span></span></p>
<p><span class="koboSpan" id="kobo.963.1">In a typical authentication request, there is an authentication manager that uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.964.1">authentication_collector</span></strong><span class="koboSpan" id="kobo.965.1"> service to collect all the tagged authentication provider servers. </span><span class="koboSpan" id="kobo.965.2">Based on the provider’s set priority, each service is invoked to check whether it applies to the current request. </span><span class="koboSpan" id="kobo.965.3">Each applied authentication provider then gets invoked to see whether the authentication </span><span class="No-Break"><span class="koboSpan" id="kobo.966.1">is invalid.</span></span></p>
<p><span class="koboSpan" id="kobo.967.1">For the RESTful Web Services module, this process is more explicit. </span><span class="koboSpan" id="kobo.967.2">The providers identified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.968.1">supported_auth</span></strong><span class="koboSpan" id="kobo.969.1"> definition for the endpoint are the only services that run through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.970.1">applies</span></strong><span class="koboSpan" id="kobo.971.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.972.1">authenticates</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.973.1"> processes.</span></span></p>
</div>
</body></html>