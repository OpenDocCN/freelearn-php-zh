<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;System Events and Advanced Configuration"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. System Events and Advanced Configuration</h1></div></div></div><p>In this chapter we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Declaring advanced configuration variables</li><li class="listitem" style="list-style-type: disc">Enabling events in concrete5</li><li class="listitem" style="list-style-type: disc">Listening to system events</li><li class="listitem" style="list-style-type: disc">Passing parameters to event handlers</li><li class="listitem" style="list-style-type: disc">Defining a page type event</li><li class="listitem" style="list-style-type: disc">Sending an e-mail when a user creates an account</li><li class="listitem" style="list-style-type: disc">Sending an e-mail when a file has been uploaded</li><li class="listitem" style="list-style-type: disc">Creating a custom scheduled job</li><li class="listitem" style="list-style-type: disc">Making your add-on translation ready</li><li class="listitem" style="list-style-type: disc">Rebranding concrete5 as a white label CMS</li><li class="listitem" style="list-style-type: disc">Changing the dashboard background image</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec147"/>Introduction</h1></div></div></div><p>concrete5 contains a lot of miscellaneous advanced functionality for developers. Earlier in the book, we have touched on the concept of events in concrete5. In this chapter, we will explore recipes to listen for system events and act upon them, as well as create customized configuration settings and even change the concrete5 branding to white label the CMS as your own.</p><div class="section" title="About the code in this chapter"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec521"/>About the code in this chapter</h2></div></div></div><p>This chapter will sometimes place code in places, such as <code class="literal">/config/site_post.php</code>, which can sometimes interrupt the normal operation of the website. Make sure you perform these recipes on a development server!</p></div></div></div>
<div class="section" title="Declaring advanced configuration variables"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec148"/>Declaring advanced configuration variables</h1></div></div></div><p>concrete5 comes with a <a id="id542" class="indexterm"/>bunch of "secret" advanced configuration variables that developers can set to augment the behavior of concrete5. In this recipe, we will set a hypothetical configuration setting.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec522"/>How to do it...</h2></div></div></div><p>The steps for declaring advanced configuration variables are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the site configuration file, located at <code class="literal">/config/site.php</code> in your preferred code editor.</li><li class="listitem">Declare a new constant variable called <code class="literal">FOO</code> and set its value to <code class="literal">BAR</code>, as follows:<div class="informalexample"><pre class="programlisting">define('FOO', 'BAR');</pre></div></li><li class="listitem">Save the <code class="literal">site.php</code> file.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec523"/>How it works...</h2></div></div></div><p>concrete5 simply loads this file at the beginning of every page request. By defining configuration settings here, developers can override default concrete5 settings and also create their own constant variables. If a developer were to dump the contents of the constant <code class="literal">FOO</code>, they would see the string <code class="literal">BAR</code>.</p></div></div>
<div class="section" title="Enabling events in concrete5"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec149"/>Enabling events in concrete5</h1></div></div></div><p>concrete5 comes with a publish/subscribe event model that makes it easy for developers to have their code respond to <a id="id543" class="indexterm"/>system events. If developers wish to declare events in <code class="literal">/config/site_events.php</code> (which we do in this chapter), they must be enabled in <code class="literal">site.php</code>.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec524"/>How to do it...</h2></div></div></div><p>The steps to enable events are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Locate the file <code class="literal">/config/site.php</code> and open it in your preferred code editor.</li><li class="listitem">Add the following configuration setting to <code class="literal">config.php</code>:<div class="informalexample"><pre class="programlisting">define('ENABLE_APPLICATION_EVENTS', true);</pre></div></li><li class="listitem">Save the file.</li><li class="listitem">Clear the concrete5 cache by visiting <code class="literal">/dashboard/system/optimization/clear_cache/</code> and clicking on the <span class="strong"><strong>Clear Cache</strong></span> button.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec525"/>How it works...</h2></div></div></div><p>Before concrete5 allows developers to register event listeners in <code class="literal">/config/site_events.php</code>, it will <a id="id544" class="indexterm"/>check to see if this configuration setting is present and set to <code class="literal">true</code>.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec526"/>There's more...</h2></div></div></div><p>In later concrete5 versions (Versions 5.5 and above) this step can be ignored, though this author's personal preference is to put the configuration in place anyway, so that events can be enabled or disabled (by setting the value to <code class="literal">false</code>) with ease.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec527"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Declaring advanced configuration variables</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Listening to system events</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Listening to system events"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec150"/>Listening to system events</h1></div></div></div><p>Once events have been enabled in <a id="id545" class="indexterm"/>concrete5, developers can write their own code to respond to the different events. In this recipe, we will create a basic "Hello World!" event that runs immediately when a page is visited and outputs a message to the screen.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec528"/>Getting ready</h2></div></div></div><p>Before you can register an event in <code class="literal">site_events.php</code>, concrete5 must be configured to enable the events system. Refer to the previous recipe to see how to enable events.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec529"/>How to do it...</h2></div></div></div><p>The steps are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new file in <code class="literal">/config</code> called <code class="literal">site_events.php</code>.</li><li class="listitem">Open <code class="literal">site_events.php</code> in your preferred code editor.</li><li class="listitem">Add the following code to listen to the <code class="literal">on_start</code> event.<div class="informalexample"><pre class="programlisting">Events::extend('on_start', 'MyClass', 'onStartFired', 'libraries/my_class.php');</pre></div></li><li class="listitem">Create a new file in <code class="literal">/libraries</code> called <code class="literal">my_class.php</code>.</li><li class="listitem">Define a new class called <code class="literal">MyClass</code> in <code class="literal">my_class.php</code>.<div class="informalexample"><pre class="programlisting">class MyClass {
}</pre></div></li><li class="listitem">Add a method to <code class="literal">MyClass</code> called <code class="literal">onStartFired</code>.<div class="informalexample"><pre class="programlisting">public function onStartFired() { 
}</pre></div></li><li class="listitem">In <code class="literal">onStartFired</code>, use the <a id="id546" class="indexterm"/><code class="literal">die</code> function to output <span class="strong"><strong>hello world!</strong></span>.<div class="informalexample"><pre class="programlisting">die('hello world!');</pre></div></li><li class="listitem">Visit any page on your site. <a id="id547" class="indexterm"/>You will see a white screen with the words <span class="strong"><strong>hello world!</strong></span> as shown in the following screenshot:<div class="mediaobject"><img src="graphics/4548OS_09_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Feel free to comment out the <code class="literal">die</code> statement in the <code class="literal">onStartFired</code> function of <code class="literal">MyClass</code> to restore your site to proper working order.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec530"/>How it works...</h2></div></div></div><p>concrete5 will automatically check for the presence of the <code class="literal">/config/site_events.php</code> file and execute any code contained within it while the site is loading (much like how <code class="literal">/config/site_post.php</code> behaves). This is the perfect place to experiment with our event registrations. When we call <code class="literal">Event::extend()</code>, we pass in arguments that specify which event we want to listen to, the class name that our event handler resides in (<code class="literal">MyClass</code>, in this example), the method within that class that will be executed when the event is fired (<code class="literal">onStartFired</code>, in this case), and finally the path to the file containing our handler class.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec531"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Enabling events in concrete5</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Passing parameters to event handlers</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Passing parameters to event handlers"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec151"/>Passing parameters to event handlers</h1></div></div></div><p>Event handlers are the functions <a id="id548" class="indexterm"/>that concrete5 executes when events are fired. In the previous recipe, we used the custom class <code class="literal">MyClass</code> and its function <code class="literal">onStartFired</code> as the event handler. concrete5 allows developers to actually pass <a id="id549" class="indexterm"/>parameters to these handlers as well. In this recipe, we build upon the event handler from the previous recipe and pass a message to the <a id="id550" class="indexterm"/>
<code class="literal">onStartFired</code> handler, which will output that message.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec532"/>Getting ready</h2></div></div></div><p>We will be using the code that we created in the previous recipe as the base for this one. Also, make sure that you have enabled events as described in the first recipe in this chapter.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec533"/>How to do it...</h2></div></div></div><p>The steps for passing parameters to event handlers are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">site_events.php</code> file located in <code class="literal">/config</code> in your code editor.</li><li class="listitem">Add a new argument to the event registration code, so it looks like the following code:<div class="informalexample"><pre class="programlisting">Events::extend('on_start', 'MyClass', 'onStartFired', 'libraries/my_class.php', array('This is a custom message!'));</pre></div></li><li class="listitem">Open <code class="literal">/libraries/my_class.php</code> and change <code class="literal">onStartFired</code> so that it looks like the following code:<div class="informalexample"><pre class="programlisting">public function onStartFired($view, $message) {
  die($message);
}</pre></div></li><li class="listitem">You will now be able to see the new message when you refresh your website as shown in the following screenshot:<div class="mediaobject"><img src="graphics/4548OS_09_02.jpg" alt="How to do it..."/></div></li><li class="listitem">Feel free to comment out the <code class="literal">die</code> statement to allow your site to function as normal.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec534"/>How it works...</h2></div></div></div><p>By adding a fifth parameter to the <a id="id551" class="indexterm"/>
<code class="literal">Events::extend()</code> function call, we can send parameters to the event handler function. This new parameter needs to be an array, which contains the various parameters that we wish to send to the handler.</p><p>You may notice that our handler <a id="id552" class="indexterm"/>function, <code class="literal">onStartFired</code>, has two parameters (<code class="literal">$view</code> and <code class="literal">$message</code>), when we only specified the message parameter. This is because concrete5 provides the current <code class="literal">View</code> object to the handler as a bit of context, which can be <a id="id553" class="indexterm"/>useful. If you are ever unsure of which parameters have been applied to your function, dump the result of the <a id="id554" class="indexterm"/>
<code class="literal">func_get_args()</code> function of PHP to see an array of all of the parameters that have been sent, as they can vary between events.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec535"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Enabling events in concrete5</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Listening to system events</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Defining a page type event"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec152"/>Defining a page type event</h1></div></div></div><p>In addition to providing a variety of events that developers can hook into, concrete5 also provides an events system at the <a id="id555" class="indexterm"/>page type level. We discussed page types in detail in the first chapter of this book, but now we can add a custom event to our page types. In this recipe, we will create a page type called <code class="literal">blog_post</code> and hook into the <a id="id556" class="indexterm"/>
<code class="literal">on_page_add</code> event for that page type.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec536"/>Getting ready</h2></div></div></div><p>Page types and how to work with them are described in much more detail in <a class="link" href="ch01.html" title="Chapter 1. Pages and Page Types">Chapter 1</a>, <span class="emphasis"><em>Pages and Page Types</em></span>. Make sure events are enabled in concrete5 and that your <code class="literal">/config/site_events.php</code> file exists.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec537"/>How to do it...</h2></div></div></div><p>The steps for defining a page type event are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Register the event handler in <code class="literal">/config/site_events.php</code>:<div class="informalexample"><pre class="programlisting">Events::extendPageType('blog_post', 'on_page_add');</pre></div></li><li class="listitem">First, create a new page type file in <code class="literal">/page_types</code> called <code class="literal">blog_post.php</code>.</li><li class="listitem">Next, create the controller file for the page type in <code class="literal">/controllers/page_types/blog_post.php</code>.</li><li class="listitem">Create the controller class, extending the core <code class="literal">Controller</code> class:<div class="informalexample"><pre class="programlisting">class BlogPostPageTypeController extends Controller {
}</pre></div></li><li class="listitem">Add a method to the controller class called <code class="literal">on_page_add</code>:<div class="informalexample"><pre class="programlisting">public function on_page_add() {
}</pre></div></li><li class="listitem">In the <code class="literal">on_page_add</code> function, create a simple <code class="literal">die</code> statement so we know that this event is working:<div class="informalexample"><pre class="programlisting">die('blog post added');</pre></div></li><li class="listitem">Install the page type by <a id="id557" class="indexterm"/>visiting <code class="literal">/dashboard/pages/types</code>.</li><li class="listitem">Click on <span class="strong"><strong>Add a Page Type</strong></span>.</li><li class="listitem">Give the page type a name and make sure the handle is set to <code class="literal">blog_post</code>.<div class="mediaobject"><img src="graphics/4548OS_09_03.jpg" alt="How to do it..."/></div></li><li class="listitem">Now visit the sitemap, located at <code class="literal">/dashboard/sitemap/full/</code>.</li><li class="listitem">Add a new page to the site, choose blog post as the page type.<div class="mediaobject"><img src="graphics/4548OS_09_04.jpg" alt="How to do it..."/></div></li><li class="listitem">Add a blog post as <a id="id558" class="indexterm"/>shown in the following screenshot:<div class="mediaobject"><img src="graphics/4548OS_09_05.jpg" alt="How to do it..."/></div></li><li class="listitem">When the page is added, you will see the message that you created in the event handler, as shown in the <a id="id559" class="indexterm"/>following screenshot:<div class="mediaobject"><img src="graphics/4548OS_09_06.jpg" alt="How to do it..."/></div></li><li class="listitem">Don't forget to remove the <code class="literal">die</code> statement from your event handler so that your website returns to normal functionality.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec538"/>How it works...</h2></div></div></div><p>When adding events to page types, concrete5 removes the need for developers to manually specify the class name, function name, and file location of the event handler. Because page types follow a specific convention (the controller name is called <code class="literal">BlogPostPageTypeController</code>) and are <a id="id560" class="indexterm"/>usually located in the <code class="literal">/controllers/page_types</code> directory, concrete5 can automatically determine which file and class should be loaded to handle the event.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec539"/>There's more...</h2></div></div></div><p>Parameters can be passed to page type event handlers just like they are in regular event handlers. Simply add a third parameter to the event declaration, an array containing each of the parameters to be passed onto the handler function as follows:</p><div class="informalexample"><pre class="programlisting">Events::extendPageType('blog_post', 'on_page_add', array('This is a custom parameter'));</pre></div><p>The new parameter can then be accessed from the handler function:</p><div class="informalexample"><pre class="programlisting">public function on_page_add($view, $message) {
  die($message);
}</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec540"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Enabling events in concrete5</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Listening to system events</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Passing parameters to event handlers</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Sending an e-mail when a user creates an account"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec153"/>Sending an e-mail when a user creates an account</h1></div></div></div><p>We have covered a number of <a id="id561" class="indexterm"/>recipes pertaining to events in concrete5 so far in this chapter. Now we can try out a common real-world example of using system <a id="id562" class="indexterm"/>events to execute custom code. In this recipe, we will send an e-mail to a site administrator whenever a user registers on the website.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec541"/>Getting ready</h2></div></div></div><p>Sending e-mails can be tricky business in PHP, as a lot of it can depend on individual server configuration. We will be using concrete5's Mail helper (discussed in more detail in <a class="link" href="ch04.html" title="Chapter 4. Using the Core Helpers">Chapter 4</a>, Using the <span class="emphasis"><em>Core Helpers</em></span>), which helps a little bit, but misconfigured servers can still have problems. We will assume that your server (development or otherwise) is capable of sending e-mails.</p><p>Also, make sure that events are enabled in concrete5 as described in the <span class="emphasis"><em>Declaring advanced configuration variables</em></span> recipe of this chapter!</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec542"/>How to do it...</h2></div></div></div><p>The steps for sending an e-mail when a user creates an account, are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Declare the event listener in <code class="literal">/config/site_events.php</code>:<div class="informalexample"><pre class="programlisting">Events::extend('on_user_add', 'UserEmailer', 'newAccountCreated', 'libraries/user_emailer.php');</pre></div></li><li class="listitem">Create the <code class="literal">user_emailer.php</code> file mentioned in the event registration in /libraries:</li><li class="listitem">Define a new class in <code class="literal">user_emailer.php</code> called <code class="literal">UserEmailer</code>:<div class="informalexample"><pre class="programlisting">class UserEmailer {
}</pre></div></li><li class="listitem">Add a method to <code class="literal">UserEmailer</code> called <code class="literal">newAccountCreated</code>, which accepts one parameter, a <code class="literal">UserInfo</code> object called <code class="literal">$user</code>:<div class="informalexample"><pre class="programlisting">public function newAccountCreated($user) {
}</pre></div></li><li class="listitem">In the <code class="literal">newAccountCreated</code> function, load the Mail helper:<div class="informalexample"><pre class="programlisting">$mail = Loader::helper('mail');</pre></div></li><li class="listitem">Set the subject of the <a id="id563" class="indexterm"/>e-mail:<div class="informalexample"><pre class="programlisting">$mail-&gt;setSubject('New account created!');</pre></div></li><li class="listitem">Set the body of the e-mail:<div class="informalexample"><pre class="programlisting">$mail-&gt;setBody('Someone with the email address of '.$user-&gt;uEmail.' has created an account.');</pre></div></li><li class="listitem">Set the destination address of the e-mail (set this to an e-mail that you own, so you can make sure that it works):<div class="informalexample"><pre class="programlisting">$mail-&gt;to('somebody@example.com');</pre></div></li><li class="listitem">Set the <code class="literal">from</code> address to <a id="id564" class="indexterm"/>something appropriate for your own website:<div class="informalexample"><pre class="programlisting">$mail-&gt;from('noreply@example.com');</pre></div></li><li class="listitem">Send the e-mail:<div class="informalexample"><pre class="programlisting">$mail-&gt;sendMail();</pre></div></li><li class="listitem">Test that this event works by adding a new user to your website.</li><li class="listitem">Visit <code class="literal">/dashboard/users/add/</code> of your concrete5 website to add a new user.<div class="mediaobject"><img src="graphics/4548OS_09_07.jpg" alt="How to do it..."/></div></li><li class="listitem">Once the user has <a id="id565" class="indexterm"/>been <a id="id566" class="indexterm"/>added, you should receive an e-mail.<div class="mediaobject"><img src="graphics/4548OS_09_08.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec543"/>How it works...</h2></div></div></div><p>When the event listener gets defined in <code class="literal">site_events.php</code>, concrete5 will remember to execute the provided function when the <a id="id567" class="indexterm"/>relevant event is fired. In this case, concrete5 fires the <code class="literal">on_user_add</code> event once a new user is added to the database, thereby <a id="id568" class="indexterm"/>running our custom code that we created. Using the Mail helper, we are able to programmatically generate an e-mail and send it immediately.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec544"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Sending e-mails with the Mail helper</em></span> recipe in <a class="link" href="ch04.html" title="Chapter 4. Using the Core Helpers">Chapter 4</a>, <span class="emphasis"><em>Using the Core Helpers</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Listening to system events</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Sending an e-mail when a file has been uploaded"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec154"/>Sending an e-mail when a file has been uploaded</h1></div></div></div><p>We are going to play around with <a id="id569" class="indexterm"/>sending e-mails again; this time we will send someone an e-mail whenever a file gets added to the file manager. The e-mail will contain a <a id="id570" class="indexterm"/>link to download the file.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec545"/>How to do it...</h2></div></div></div><p>The steps for sending an e-mail when a file has been uploaded, are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Set up the event listener in <code class="literal">/config/site_events.php</code>:<div class="informalexample"><pre class="programlisting">Events::extend('on_file_add', 'FileEmailer', 'fileUploaded', 'libraries/file_emailer.php');</pre></div></li><li class="listitem">Create a new library in <code class="literal">/libraries/file_emailer.php</code>:</li><li class="listitem">Declare the new <code class="literal">FileEmailer</code> class:<div class="informalexample"><pre class="programlisting">class FileEmailer {
}</pre></div></li><li class="listitem">Add a method to the class called <code class="literal">fileUploaded</code>:<div class="informalexample"><pre class="programlisting">public function fileUploaded($file, $fv) {
}</pre></div></li><li class="listitem">Load the Mail helper:<div class="informalexample"><pre class="programlisting">$mail = Loader::helper('mail');</pre></div></li><li class="listitem">Set the subject of the message:<div class="informalexample"><pre class="programlisting">$mail-&gt;setSubject('A file has been added to the file manager');</pre></div></li><li class="listitem">Set the body of the message, including a link to download the file:<div class="informalexample"><pre class="programlisting">$mail-&gt;setBody('A new file has been uploaded. Download it here: '.
  $fv-&gt;getDownloadURL());</pre></div></li><li class="listitem">Add the recipient's e-mail address (change this to an e-mail address that you have access to):<div class="informalexample"><pre class="programlisting">$mail-&gt;to('somebody@example.com');</pre></div></li><li class="listitem">Set the return address:<div class="informalexample"><pre class="programlisting">$mail-&gt;from('noreply@example.com');</pre></div></li><li class="listitem">Send the e-mail:<div class="informalexample"><pre class="programlisting">$mail-&gt;sendMail();</pre></div></li><li class="listitem">Visit your website's file manager at <code class="literal">/dashboard/files/search</code>.<div class="mediaobject"><img src="graphics/4548OS_09_12.jpg" alt="How to do it..."/></div></li><li class="listitem">Upload a new file.</li><li class="listitem">You will receive an <a id="id571" class="indexterm"/>e-mail <a id="id572" class="indexterm"/>containing a link to download the new file as shown in the following screenshot:<div class="mediaobject"><img src="graphics/4548OS_09_13.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec546"/>How it works...</h2></div></div></div><p>When a file gets uploaded, concrete5 <a id="id573" class="indexterm"/>automatically fires off the <code class="literal">on_file_add</code> event, which we registered a listener for in <code class="literal">/config/site_events.php</code>. concrete5 passes <code class="literal">File</code> and <code class="literal">FileVersion</code> objects as the <a id="id574" class="indexterm"/>two parameters in the event callback. The <code class="literal">FileVersion</code> object contains the method to get the download URL.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec547"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Sending an e-mail when a user creates an account</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Creating a custom scheduled job"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec155"/>Creating a custom scheduled job</h1></div></div></div><p>concrete5 allows developers to <a id="id575" class="indexterm"/>create special jobs to run automatically via scheduled tasks on the server. These jobs can be any sort of action that you wish to perform automatically on a regular basis. In this recipe, we will write a job that will send a good morning e-mail to every user on the website.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec548"/>Getting ready</h2></div></div></div><p>It probably should go without saying, but please make sure to perform this recipe on a test server with test users and e-mail addresses. You don't want to annoy your entire user base with silly e-mails every morning.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec549"/>How to do it...</h2></div></div></div><p>The steps for creating a custom scheduled job are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new file at <code class="literal">/jobs/email_everyone.php</code>.</li><li class="listitem">Declare a new class called <code class="literal">EmailEveryone</code>:<div class="informalexample"><pre class="programlisting">class EmailEveryone extends Job {
}</pre></div></li><li class="listitem">Create a method in the class to return the job's name:<div class="informalexample"><pre class="programlisting">public function getJobName() {
  return 'Wakeup Email';
}</pre></div></li><li class="listitem">Create another method to return the job's description:<div class="informalexample"><pre class="programlisting">public function getJobDescription() {
  return 'Give all of your site members a morning wakeup email!';
}</pre></div></li><li class="listitem">Create a function called <code class="literal">run</code>:<div class="informalexample"><pre class="programlisting">public function run() {
}</pre></div></li><li class="listitem">Load the <code class="literal">UserList</code> model:<div class="informalexample"><pre class="programlisting">Loader::model('user_list');</pre></div></li><li class="listitem">Create a new instance of the <code class="literal">UserList</code> class:<div class="informalexample"><pre class="programlisting">$ul = new UserList();</pre></div></li><li class="listitem">Get an array of all of the users on the website:<div class="informalexample"><pre class="programlisting">$users = $ul-&gt;get();</pre></div></li><li class="listitem">Loop through the array:<div class="informalexample"><pre class="programlisting">foreach ($users as $user) {
}</pre></div></li><li class="listitem">In the loop, load the Mail helper:<div class="informalexample"><pre class="programlisting">$mail = Loader::helper('mail');</pre></div></li><li class="listitem">Set the subject of the e-mail:<div class="informalexample"><pre class="programlisting">$mail-&gt;setSubject('Good morning!');</pre></div></li><li class="listitem">Set the reply address:<div class="informalexample"><pre class="programlisting">$mail-&gt;from('noreply@example.com');</pre></div></li><li class="listitem">Set the destination address to the current user in the loop:<div class="informalexample"><pre class="programlisting">$mail-&gt;to($user-&gt;getUserEmail());</pre></div></li><li class="listitem">Set the body of the e-mail, including the user's username:<div class="informalexample"><pre class="programlisting">$mail-&gt;setBody('Good morning, '.$user-&gt;getUserName());</pre></div></li><li class="listitem">Send the <a id="id576" class="indexterm"/>e-mail:<div class="informalexample"><pre class="programlisting">$mail-&gt;sendMail();</pre></div></li><li class="listitem">Return a message to display on the dashboard:<div class="informalexample"><pre class="programlisting">return 'Emailed '.count($users).' users.';</pre></div></li><li class="listitem">Visit the <span class="strong"><strong>Automated Jobs</strong></span> page of the dashboard, located at <code class="literal">/dashboard/system/optimization/jobs/</code>.</li><li class="listitem">You will see your new job at the bottom of the list as shown in the following screenshot.<div class="mediaobject"><img src="graphics/4548OS_09_14.jpg" alt="How to do it..."/></div></li><li class="listitem">Click on the <span class="strong"><strong>Install</strong></span> button <a id="id577" class="indexterm"/>as shown in the preceding screenshot.<div class="mediaobject"><img src="graphics/4548OS_09_15.jpg" alt="How to do it..."/></div></li><li class="listitem">Click on the triangle play <a id="id578" class="indexterm"/>icon to run your job. You will see a message showing how many users were mailed.<div class="mediaobject"><img src="graphics/4548OS_09_17.jpg" alt="How to do it..."/></div></li><li class="listitem">You will receive an e-mail in your inbox (if your e-mail address is assigned to one of the site members) as shown in the following screenshot:<div class="mediaobject"><img src="graphics/4548OS_09_16.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec550"/>How it works...</h2></div></div></div><p>concrete5 will asynchronously run the new task once the "play" button is clicked. The task simply loads a list of all of the users on the site, and e-mails each of them. In production use, this is inefficient for a <a id="id579" class="indexterm"/>large amount of members and can even get your server blacklisted for spam.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec551"/> There's more...</h2></div></div></div><p>You may be wondering how to automatically run something like this. The answer lies within server automated tasks. On most Linux web servers, site administrators will use the <code class="literal">cron</code> scheduler to manage automatic tasks, and possibly the <code class="literal">curl</code> command to send an HTTP request to the task runner. To run this task automatically, create a scheduled task to ping the URL listed at the bottom of the jobs page. This URL contains a token that will allow your system to access concrete5 without logging in. Make sure to keep this URL and its token private, otherwise unauthorized users could trigger your site's automated tasks.</p><p>For more information on creating scheduled tasks on your Linux-based web server, see <a class="ulink" href="https://en.wikipedia.org/wiki/Cron">https://en.wikipedia.org/wiki/Cron</a>.</p></div></div>
<div class="section" title="Making your add-on translation ready"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec156"/>Making your add-on translation ready</h1></div></div></div><p>concrete5 allows developers to take advanced steps to make sure that their code is compatible with concrete5 translations. In this recipe, we will show how to prepare a string for translation.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec552"/>How to do it...</h2></div></div></div><p>The steps for making add-on <a id="id580" class="indexterm"/>translation ready are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/config/site_post.php</code> in your code editor.</li><li class="listitem">Declare a string for testing:<div class="informalexample"><pre class="programlisting">$str = 'Hello world!';</pre></div></li><li class="listitem">Use the translation function to output your string:<div class="informalexample"><pre class="programlisting">echo t($str);
exit;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec553"/>How it works...</h2></div></div></div><p>concrete5 makes use of the Zend translation library. concrete5 defines the global <code class="literal">t()</code> function as a shortcut to make strings available to various translations. Translators then will prepare translation files using a tool such as Poedit to assist with translating these strings. To learn more about Poedit and creating translation files, see <a class="ulink" href="http://www.poedit.net">http://www.poedit.net</a>.</p></div></div>
<div class="section" title="Rebranding concrete5 as a white label CMS"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec157"/>Rebranding concrete5 as a white label CMS</h1></div></div></div><p>concrete5 allows developers to <a id="id581" class="indexterm"/>change the logo, title, and general branding information of the CMS to whatever they would prefer. Often larger organizations <a id="id582" class="indexterm"/>like to white label their products like this, and concrete5 makes it easy. In this recipe, we will white label concrete5 by changing the logo in the edit bar.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec554"/>Getting ready</h2></div></div></div><p>You will need an image of your logo that is 49 x 49 pixels. We are using a sample logo in this recipe, which is included with the code download from this book's website.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec555"/>How to do it...</h2></div></div></div><p>The steps are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Upload your new logo to your site. In this example, our logo is located at <code class="literal">/images/new-logo.png</code> (you may need to create the images directory)</li><li class="listitem">Open <code class="literal">/config/site.php</code> in your code editor.</li><li class="listitem">Add the following configuration to the file:<div class="informalexample"><pre class="programlisting">define('WHITE_LABEL_LOGO_SRC', '/images/new-logo.png');</pre></div></li><li class="listitem">Save the file. You will now <a id="id583" class="indexterm"/>see the new logo <a id="id584" class="indexterm"/>in the edit bar as shown in the following screenshot:<div class="mediaobject"><img src="graphics/4548OS_09_09.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec556"/>How it works...</h2></div></div></div><p>concrete5 checks for the presence of this configuration variable and changes the logo source if that is present. concrete5 will also add a <span class="strong"><strong>Powered by concrete5</strong></span> message to the edit bar if the logo has been changed.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec557"/>There's more...</h2></div></div></div><p>There are a few more white labeling <a id="id585" class="indexterm"/>aspects that are available for developers. <a id="id586" class="indexterm"/>There is a great list available at <a class="ulink" href="http://www.concrete5.org/documentation/how-tos/developers/white-labelling/">http://www.concrete5.org/documentation/how-tos/developers/white-labelling/</a>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec558"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Declaring advanced configuration variables</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Changing the dashboard background image"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec158"/>Changing the dashboard background image</h1></div></div></div><p>By default, concrete5 displays <a id="id587" class="indexterm"/>big and bright photographs in the background of every dashboard page. These images are powered by a feed running on concrete5's official servers, and the image changes every day.</p><div class="mediaobject"><img src="graphics/4548OS_09_10.jpg" alt="Changing the dashboard background image"/></div><p>It's a fun effect and brings a lot of color into the dashboard, but some clients and agencies might not like showing random photos on their site, especially if it is used for business. Fortunately, concrete5 makes it <a id="id588" class="indexterm"/>easy to change the background image.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec559"/>Getting ready</h2></div></div></div><p>You will need a new image to use for the background, with a size of at least 1024 x 768 pixels. In this example, we will be using a subtle dark gradient that can be quickly created in Adobe Photoshop, but you can use any image you like. The background image is available with the code download of this book.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec560"/>How to do it...</h2></div></div></div><p>The steps for changing the background image of dashboard are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">/config/site.php</code> file in your code editor.</li><li class="listitem">Add the following configuration to the file.<div class="informalexample"><pre class="programlisting">define('WHITE_LABEL_DASHBOARD_BACKGROUND_SRC', '/images/new-background.png');</pre></div></li><li class="listitem">Save the file. The background <a id="id589" class="indexterm"/>of the dashboard will now be changed.<div class="mediaobject"><img src="graphics/4548OS_09_11.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec561"/>How it works...</h2></div></div></div><p>concrete5 simply checks for the <code class="literal">WHITE_LABEL_DASHBOARD_BACKGROUND_SRC</code> configuration setting and replaces the daily image with the new background that you have provided.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec562"/>There's more...</h2></div></div></div><p>Developers can get rid of the <a id="id590" class="indexterm"/>background picture entirely by setting the background source to "none".</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec563"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Declaring advanced configuration variables</em></span> recipe.</li></ul></div></div></div></body></html>