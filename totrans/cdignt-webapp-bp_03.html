<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Discussion Forum"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Discussion Forum</h1></div></div></div><p>A discussion forum<a id="id99" class="indexterm"/> can be quite a useful resource to have on internal company projects or to allow clients to interact on projects, for example.</p><p>Discussion forums are a great way to create a community around a particular subject or topic, acting as a type of wiki. They are a store of knowledge of something or a record of a discussion, containing a history of changes of ideas and concepts and recording the evolution of thinking around a topic or subject. They can also be used to talk about cats.</p><p>To create this app, we'll create three controllers: one to handle discussions, one to handle comments, and one to handle any admin functionality that we might need, such as moderating comments and discussions.</p><p>We'll create a language file to store text, allowing you to have multiple language support, should that be required.</p><p>We will make amendments to the <code class="literal">config.php</code> file to allow for encryption support, which is necessary for sessions and password support.</p><p>We'll create all the necessary view files and even a <code class="literal">.css</code> file to help Bootstrap with some of the views.</p><p>This app, along with all the others in this book, relies on the basic setup we did in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>, although you can take large sections of the code and drop it into pretty much any app you might already have; please keep in mind that the setup done in the first chapter acts as the foundation for this chapter.</p><p>It is worth mentioning the limits of the application. This application contains the most basic discussion forum functionality. We create users on our way; however, there is no user management—to include that would be a large extension of the application code and slightly out of scope of a discussion forum.</p><p>Users are created when someone creates a comment or discussion using an e-mail address that is not currently stored in the <code class="literal">users</code> table. A password is generated for them and a hash is created based on that password.</p><p>As this application creates a password for them automatically, you might wish to tell them what that password is—perhaps by sending them an e-mail. However, you might not wish them to be able to log in at all. It's up to you—the functionality is there should you wish to expand upon it.</p><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Design and wireframes</li><li class="listitem" style="list-style-type: disc">Creating the database</li><li class="listitem" style="list-style-type: disc">Creating the models</li><li class="listitem" style="list-style-type: disc">Creating the views</li><li class="listitem" style="list-style-type: disc">Creating the controllers</li><li class="listitem" style="list-style-type: disc">Putting it all together</li></ul></div><p>So, without further ado, let's get on with it.</p><div class="section" title="Design and wireframes"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec28"/>Design and wireframes</h1></div></div></div><p>As always, before we start building, we should take a look at what we plan to build.</p><p>Firstly, we need<a id="id100" class="indexterm"/> to give a brief description of our intent; we plan to <a id="id101" class="indexterm"/>build an app that will let a user view any pre-existing discussion pages and then allow that user to comment on a page if they wish. The user can also create new discussions and other users can comment on them.</p><p>Let's take a look at a site map:</p><div class="mediaobject"><img src="graphics/7093OS_03_01.jpg" alt="Design and wireframes"/></div><p>Now, let's go <a id="id102" class="indexterm"/>over each item and get a brief idea of what it <a id="id103" class="indexterm"/>does:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Home</strong></span>: Imagine <a id="id104" class="indexterm"/>this as the index—the routing start point. The user will visit the Home page and will be redirected to point <span class="strong"><strong>2</strong></span> (the View All Discussions page).</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>View All Discussions</strong></span>: This will display all discussions in a list format. We'll have <a id="id105" class="indexterm"/>some filtering going on as well (the most recent first, most popular next, and so on). The user will be able to click on a discussion title and be redirected to the View Discussion page.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>View Discussion/Add Comment</strong></span>: This page displays the initial comment (written by the person who created the discussion) and all subsequent comments<a id="id106" class="indexterm"/> and contributions added by other users. A user is able to join in a discussion by filling in a form at the bottom of the View Discussion page.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>New Discussion</strong></span>: A user can create a new discussion. This discussion will then <a id="id107" class="indexterm"/>appear on the View All Discussions page as a new discussion.</li></ul></div><p>We now begin to look at the admin-only functions (largely, discussion and comment moderation), which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Admin Login</strong></span>: This is <a id="id108" class="indexterm"/>just a simple login script. It is separate from the one used in <a class="link" href="ch06.html" title="Chapter 6. Creating an Authentication System">Chapter 6</a>, <span class="emphasis"><em>Creating an Authentication System</em></span>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Moderator Dashboard</strong></span>: This displays all discussions and comments awaiting <a id="id109" class="indexterm"/>moderation and options in a list format, in order to allow or reject them.</li></ul></div><p>Now that<a id="id110" class="indexterm"/> we have a fairly good idea of the structure and form of<a id="id111" class="indexterm"/> the site, let's take a look at some wireframes of each page.</p><div class="section" title="The View All Discussions page"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec20"/>The View All Discussions page</h2></div></div></div><p>The following screenshot<a id="id112" class="indexterm"/> shows a wireframe of point <span class="strong"><strong>2</strong></span> (the View All Discussions page) in the preceding diagram. The user is able to see all current<a id="id113" class="indexterm"/> discussions, the initial text written by the discussion creator (this acts as a brief introduction to the discussion subject), the total number of comments so far, the methods to sort the discussions into newest/oldest, and so on.</p><div class="mediaobject"><img src="graphics/7093OS_03_02.jpg" alt="The View All Discussions page"/></div></div><div class="section" title="The View Discussion/Add Comment page"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec21"/>The View Discussion/Add Comment page</h2></div></div></div><p>The following <a id="id114" class="indexterm"/>screenshot shows a wireframe<a id="id115" class="indexterm"/> from point <span class="strong"><strong>3</strong></span> (the View Discussion/Add Comment page). You can see that this page displays the initial discussion text and all the replies. At the bottom of the list of replies, there is a form that allows the user to join the discussion. There is also a New Discussion link at the top; this will take the user to point <span class="strong"><strong>4</strong></span> (the New Discussion page).</p><p>Notice the flag link next to each comment title. If a user clicks this, then the comment is immediately flagged for review by the admin. For example, let's say someone wrote something about a famous Hollywood actor or, something loony such as spaceships that might be considered potentially libelous; this comment can be flagged for review. If it is considered safe, it can be set as such; however, if it is not considered safe, it can<a id="id116" class="indexterm"/> be removed to prevent the <a id="id117" class="indexterm"/>writer of the comment from being followed everywhere by people in vans, turning up at their work, talking to their neighbors, and so on—a purely hypothetical, non-real-world, and completely made up example of something that has never happened ever, not even once.</p><div class="mediaobject"><img src="graphics/7093OS_03_03.jpg" alt="The View Discussion/Add Comment page"/></div></div><div class="section" title="The New Discussion page"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec22"/>The New Discussion page</h2></div></div></div><p>The following screenshot<a id="id118" class="indexterm"/> shows a wireframe from point <span class="strong"><strong>4</strong></span> (the New Discussion page). You can see the form where the user can create a new discussion. The <a id="id119" class="indexterm"/>user is invited to enter the discussion title, their name, and the initial discussion text. Once the user has entered all relevant information into the form, they press the <span class="strong"><strong>Go</strong></span> button, and the form is validated by the <code class="literal">create()</code> discussion controller function.</p><div class="mediaobject"><img src="graphics/7093OS_03_04.jpg" alt="The New Discussion page"/></div></div><div class="section" title="The admin Dashboard page"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec23"/>The admin Dashboard page</h2></div></div></div><p>The following screenshot<a id="id120" class="indexterm"/> shows you the admin dashboard from <a id="id121" class="indexterm"/>point <span class="strong"><strong>6</strong></span> (the Moderator Dashboard page). From this area, the admin can view any discussions and comments that have been<a id="id122" class="indexterm"/> flagged and moderate them, approving them <a id="id123" class="indexterm"/>or agreeing with the flag and deleting them.</p><div class="mediaobject"><img src="graphics/7093OS_03_05.jpg" alt="The admin Dashboard page"/></div></div><div class="section" title="File overview"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec24"/>File overview</h2></div></div></div><p>We're <a id="id124" class="indexterm"/>going to create 15 files for this application; these files <a id="id125" class="indexterm"/>are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/discussions_model.php</code>: This file provides read/write access to the database table <code class="literal">discussions</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/comments_model.php</code>: This file provides read/write access to the database table <code class="literal">comments</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/admin_model.php</code>: This file provides read/write access to the database, enabling an admin to moderate discussions and comments.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/discussions/new.php</code>: This file provides an interface to display a form, allowing the user to create a new discussion; it also displays any error or success messages to the user.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/discussions/view.php</code>: This file provides us with an interface, allowing the user to view all active discussions. It also provides filtering interface options (for example, sorting).</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/comments/view.php</code>: This file provides us with an interface to display an individual discussion with all the comments other users have written to the user. There is also a form at the bottom of this view file that allows the user to join the discussion by creating a comment. Any validation or success messages related to adding a comment will be displayed in this view file as well.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/admin/dashboard.php</code>: This file displays a list of comments and/or discussions that require moderating.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/admin/login.php</code>: This file provides a login form for admins.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/nav/top_nav.php</code>: This file provides a navigation bar at the top of the page.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/discussions.php</code>: The <code class="literal">discussions</code> controller manages the creation of new discussions and displays a list of discussions to normal users.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/comments.php</code>: The <code class="literal">comments</code> controller manages the creation of new comments and links them to discussions. It also displays a list of comments to normal users.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/admin.php</code>: The <code class="literal">admin</code> controller handles the logging in of admins, the display of discussions and comments awaiting moderation, and the moderation of those discussions and comments.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/language/english/en_admin_lang.php</code>: This file provides language support for the application.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/common/login_header.php</code>: This file contains specific HTML markup to display the login form correctly.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/bootstrap/css/signin.css</code>: This is a css script containing specific css code to display the login form correctly.</li></ul></div><p>The file structure of the preceding 15 files is as follows:</p><div class="informalexample"><pre class="programlisting">application/
├── controllers/
│   ├── discussions.php
│   ├── comments.php
│   ├── admin.php
├── models/
│   ├── comments_model.php
│   ├── discussions_model.php
│   ├── admin_model.php
├── views/discussions/
│   ├── view.php
│   ├── new.php
├── views/comments/
│   ├── view.php
├── views/admin/
│   ├── login.php
│   ├── dashboard.php
├── views/nav/
│   ├── top_nav.php
├── views/common/
│   ├── login_header.php
├── language/english/
│   ├── en_admin_lang.php
bootstrap/
├── css/
    ├── signin.css</pre></div><p>Note the<a id="id126" class="indexterm"/> last item in the list: <code class="literal">signin.css</code>. This sits in<a id="id127" class="indexterm"/> the <code class="literal">bootstrap/css/</code> folder, which is at the same level as CodeIgniter's <code class="literal">application</code> folder. We installed Twitter Bootstrap in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>. In this chapter, we will go through placing the <code class="literal">bootstrap</code> folder at this folder level and location.</p></div></div></div>
<div class="section" title="Creating the database"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec29"/>Creating the database</h1></div></div></div><p>Okay, you should have already set up <a id="id128" class="indexterm"/>CodeIgniter and Bootstrap<a id="id129" class="indexterm"/> as described in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>. If not, then you should know that the code in this chapter is specifically built with the setup from the first chapter in mind. However, it's not the end of the world if you haven't—the code can easily be applied to other situations.</p><p>Firstly, we'll build the database. Copy the following MySQL code to your database:</p><div class="informalexample"><pre class="programlisting">CREATE DATABASE 'discuss_forum';
USE 'discuss_forum';

DROP TABLE IF EXISTS 'ci_sessions';
CREATE TABLE 'ci_sessions' (
  'session_id' varchar(40) COLLATE utf8_bin NOT NULL DEFAULT '0',
  'ip_address' varchar(16) COLLATE utf8_bin NOT NULL DEFAULT '0',
  'user_agent' varchar(120) COLLATE utf8_bin DEFAULT NULL,
  'last_activity' int(10) unsigned NOT NULL DEFAULT '0',
  'user_data' text COLLATE utf8_bin NOT NULL,
  PRIMARY KEY ('session_id'),
  KEY 'last_activity_idx' ('last_activity')
) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS 'comments';
CREATE TABLE 'comments' (
  'cm_id' int(11) NOT NULL AUTO_INCREMENT,
  'ds_id' int(11) NOT NULL,
  'cm_body' text NOT NULL,
  'cm_created_at' timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  'usr_id' int(11) NOT NULL,
  'cm_is_active' int(1) NOT NULL,
  PRIMARY KEY ('cm_id')
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS 'discussions';
CREATE TABLE 'discussions' (
  'ds_id' int(11) NOT NULL AUTO_INCREMENT,
  'usr_id' int(11) NOT NULL,
  'ds_title' varchar(255) NOT NULL,
  'ds_body' text NOT NULL,
  'ds_created_at' timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  'ds_is_active' int(1) NOT NULL,
  PRIMARY KEY ('ds_id')
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS 'users';
CREATE TABLE 'users' (
  'usr_id' int(11) NOT NULL AUTO_INCREMENT,
  'usr_name' varchar(25) NOT NULL,
  'usr_hash' varchar(255) NOT NULL,
  'usr_email' varchar(125) NOT NULL,
  'usr_created_at' timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  'usr_is_active' int(1) NOT NULL,
  'usr_level' int(1) NOT NULL,
  PRIMARY KEY ('usr_id')
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip04"/>Tip</h3><p>You don't have to call the database <code class="literal">discuss_forum</code> if you don't want to. Feel free to rename it to something else if you wish; just be sure to update <code class="literal">config/database.php</code> accordingly.</p></div></div><p>You'll see that the first table<a id="id130" class="indexterm"/> that we create is <code class="literal">ci_sessions</code>; we need <a id="id131" class="indexterm"/>this in order to allow CodeIgniter to manage sessions, specifically, logged-in users. However, this is just the standard session table that is available from <span class="emphasis"><em>CodeIgniter User Guide</em></span>, so I'll not include a description of the table as it's not technically specific to this application. However if you're interested, there's a description at <a class="ulink" href="http://ellislab.com/codeigniter/user-guide/libraries/sessions.html">http://ellislab.com/codeigniter/user-guide/libraries/sessions.html</a>.</p><p>Right, let's take a look at each item in each table and see what it means. The following table describes the <code class="literal">comments</code> table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th colspan="2" style="text-align: center" valign="bottom">
<p>Table: comments</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Element</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Description</strong></span>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cm_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id132" class="indexterm"/>primary key.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">ds_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id133" class="indexterm"/>foreign key from the <code class="literal">discussions</code> table; it links the <code class="literal">comments</code> table to the <code class="literal">discussions</code> table. The link is <code class="literal">discussions.ds_id = comments.cm_id</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cm_body</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id134" class="indexterm"/> body text of a comment.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cm_created_at</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id135" class="indexterm"/>MySQL timestamp that is created when the record is created.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">usr_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id136" class="indexterm"/> foreign Key from the <code class="literal">users</code> table. A user is created when someone enters an e-mail address (when creating a discussion or comment) that doesn't already exist in the <code class="literal">users</code> table.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">cm_is_active</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This indicates<a id="id137" class="indexterm"/> whether the comment is active (<code class="literal">1</code>) or inactive (<code class="literal">0</code>); inactive means that a comment is not displayed in a forum but is displayed to an admin in the admin dashboard for moderation.</p>
</td></tr></tbody></table></div><p>The following table describes the <code class="literal">discussions</code> table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th colspan="2" style="text-align: center" valign="bottom">
<p>Table: discussions</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Element</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Description</strong></span>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">ds_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id138" class="indexterm"/> primary key.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">usr_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id139" class="indexterm"/>foreign key from the <code class="literal">users</code> table. A user is created when someone enters an e-mail address (when creating a discussion or comment) that doesn't already exist in the users table.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">ds_title</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the title of a<a id="id140" class="indexterm"/> discussion forum.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">ds_body</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id141" class="indexterm"/>body element of a discussion forum; it is the initial text—usually a question—that the creator of a discussion writes to entice people to comment.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">ds_created_at</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id142" class="indexterm"/>MySQL timestamp that is created when the record is created.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">ds_is_active</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This indicates<a id="id143" class="indexterm"/> whether the discussion forum is active (<code class="literal">1</code>) or inactive (<code class="literal">0</code>); inactive means that a discussion is not displayed on the page but is displayed to an admin in the admin dashboard for moderation.</p>
</td></tr></tbody></table></div><p>The following table describes the <code class="literal">users</code> table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th colspan="2" style="text-align: center" valign="bottom">
<p>Table: users</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Element</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Description</strong></span>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">usr_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id144" class="indexterm"/>primary key.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">usr_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id145" class="indexterm"/>username of an individual once they're in the database.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">usr_hash</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id146" class="indexterm"/>hashed value of their password. The password is generated in the <code class="literal">new_comment()</code> function of <code class="literal">comments_model</code> and the <code class="literal">create()</code> function of <code class="literal">discussions_model</code> and is passed to the <code class="literal">$this-&gt;encrypt-&gt;sha1()</code>CodeIgniter function to create a hash. The hash is stored in the database in <code class="literal">users.usr_hash</code>; however, the password is not stored (as you would expect).</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">usr_email</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the e-mail of the <a id="id147" class="indexterm"/>person writing a comment or creating a discussion forum. The application will look in the <code class="literal">users</code> table to see whether the e-mail already exists. If it does, the primary key (<code class="literal">usr_id</code>) for that record is assigned to a comment or discussion forum. If the e-mail does not already exist, then a row is created in the <code class="literal">users</code> table and the primary key is then assigned to the comment or discussion.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">usr_created_at</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id148" class="indexterm"/>MySQL timestamp that is created when the recordis created.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">usr_is_active</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id149" class="indexterm"/> indicates whether the user is active (<code class="literal">1</code>) or inactive (<code class="literal">0</code>). Currently, there is no functionality to handle active or inactive users; this is something you can implement yourself should you wish.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">usr_level</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id150" class="indexterm"/> indicates the permission level of the user. Standard users are given the integer value 1, and admins (that is, those who can log in) are given the integer value 2. There is no functionality to use this <code class="literal">usr_level</code> element; however, it is there should you wish to expand upon it.</p>
</td></tr></tbody></table></div><p>At this early stage, it's <a id="id151" class="indexterm"/>important to discuss the concept of users in this application. We're not really going to employ any detailed user management, and users will <a id="id152" class="indexterm"/>only be created when someone enters their e-mail address when they add a comment or create a discussion. We're creating users here because it'll be easy for you to extend this functionality in your own time to manage users, should you wish.</p><p>We'll also need to make amendments to the <code class="literal">config/database.php</code> file—namely setting the database access details, username password, and so on. The steps are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">config/database.php</code> file and find the following lines:<div class="informalexample"><pre class="programlisting">$db['default']['hostname'] = 'localhost';
$db['default']['username'] = 'your username';
$db['default']['password'] = 'your password';
$db['default']['database'] = 'urls';</pre></div></li><li class="listitem">Edit the values in the preceding lines, ensuring you replace these values with values that are more specific to your setup and situation. Enter your username, password, and so on.</li></ol></div></div>
<div class="section" title="Adjusting the config.php file"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec30"/>Adjusting the config.php file</h1></div></div></div><p>There are a few<a id="id153" class="indexterm"/> things in this file that we'll need to configure to support sessions and encryption. So, open the <code class="literal">config/config.php</code> file and make the changes described in this section.</p><p>We will need to set an encryption key. Both sessions as well as CodeIgniter's encryption functionality require an encryption key to be set in the <code class="literal">$config</code> array, so perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Find the following line:<div class="informalexample"><pre class="programlisting">$config['encryption_key'] = '';</pre></div><p>Change it to the following:</p><div class="informalexample"><pre class="programlisting">$config['encryption_key'] = 'a-random-string-of-alphanum-characters';</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip05"/>Tip</h3><p>Now, don't actually change this value to literally a-random-string-of-alphanum-characters<a id="id154" class="indexterm"/> obviously, but change it to, er, a random string of alphanum characters—if that makes sense. Yeah, you know what I mean.</p></div></div></li><li class="listitem">Find the following lines:<div class="informalexample"><pre class="programlisting">$config['sess_cookie_name'] = 'ci_session';
$config['sess_expiration'] = 7200;
$config['sess_expire_on_close'] = FALSE;
$config['sess_encrypt_cookie'] = FALSE;
$config['sess_use_database'] = FALSE;
$config['sess_table_name'] = 'ci_sessions';
$config['sess_match_ip'] = FALSE;
$config['sess_match_useragent'] = TRUE;
$config['sess_time_to_update'] = 300;</pre></div><p>Change them to the following:</p><div class="informalexample"><pre class="programlisting">$config['sess_cookie_name'] = 'ci_session';
$config['sess_expiration'] = 7200;
$config['sess_expire_on_close'] = TRUE;
$config['sess_encrypt_cookie'] = TRUE;
$config['sess_use_database'] = TRUE;
$config['sess_table_name'] = 'ci_sessions';
$config['sess_match_ip'] = TRUE;
$config['sess_match_useragent'] = TRUE;
$config['sess_time_to_update'] = 300;</pre></div></li></ol></div></div>
<div class="section" title="Adjusting the routes.php file"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec31"/>Adjusting the routes.php file</h1></div></div></div><p>We want to redirect the <a id="id155" class="indexterm"/>user to the <code class="literal">discussions</code> controller rather than the default CodeIgniter <code class="literal">welcome</code> controller. To do this, we will need to amend the default controller setting in the <code class="literal">routes.php</code> file to reflect this, which can be done as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">config/routes.php</code> file for editing and find the following lines (near the bottom of the file):<div class="informalexample"><pre class="programlisting">$route['default_controller'] = "welcome";
$route['404_override'] = '';</pre></div></li><li class="listitem">Firstly, we need to change the default controller. Initially in a CodeIgniter application, the default controller is set to <code class="literal">welcome</code>; however, we don't need this. We want the default controller to be <code class="literal">discussions</code> instead. So, find the following line:<div class="informalexample"><pre class="programlisting">$route['default_controller'] = "welcome";</pre></div><p>Change it to the following:</p><div class="informalexample"><pre class="programlisting">$route['default_controller'] = "discussions";</pre></div></li></ol></div></div>
<div class="section" title="Creating the models"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec32"/>Creating the models</h1></div></div></div><p>We're<a id="id156" class="indexterm"/> going to create three models for this application; these <a id="id157" class="indexterm"/>are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">discussions_model.php</code>: This helps in managing interactions with the <code class="literal">discussions</code> table</li><li class="listitem" style="list-style-type: disc"><code class="literal">comments_model.php</code>: This helps in managing interactions with the <code class="literal">comments</code> table</li><li class="listitem" style="list-style-type: disc"><code class="literal">admin_model.php</code>: This helps in managing interactions with the <code class="literal">users</code> table</li></ul></div><div class="section" title="Creating the model file – models/discussions_model.php"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec25"/>Creating the model file – models/discussions_model.php</h2></div></div></div><p>The <code class="literal">discussions_model.php</code> model file has three functions; these are <code class="literal">fetch_discussions()</code>, <code class="literal">fetch_discussion()</code>, and <code class="literal">flag()</code>. The <code class="literal">fetch_discussions()</code> function fetches many discussions, the <code class="literal">fetch_discussion()</code> function <a id="id158" class="indexterm"/>fetches a single discussion, and<a id="id159" class="indexterm"/> the <code class="literal">flag()</code> function sets a<a id="id160" class="indexterm"/> discussion as one that<a id="id161" class="indexterm"/> requires <a id="id162" class="indexterm"/>moderation by an admin.</p><p>The <a id="id163" class="indexterm"/>steps to create this model file are as follows:</p><p>Create the <code class="literal">/path/to/codeigniter/application.models/discussion_model.php</code> file and<a id="id164" class="indexterm"/> add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Discussions_model extends CI_Model {
  function __construct() {
    parent::__construct();
  }</pre></div><p>Let's first<a id="id165" class="indexterm"/> look at the <code class="literal">fetch_discussions()</code> function. The <code class="literal">fetch_discussions()</code> function will return the result of a database query to the <code class="literal">discussions</code> controller's <code class="literal">index()</code> function. It takes two arguments that are set to <code class="literal">null</code> by default. These are <code class="literal">$filter</code> and <code class="literal">$direction</code>, and they are used to add filtering and sorting to the query string.</p><p>The following query will only return active discussions—that is, any discussions whose <code class="literal">ds_is_active</code> value is not set to <code class="literal">0</code>. The <code class="literal">flag()</code> function of <code class="literal">discussions_model</code> (discussed later) sets a discussion to inactive:</p><div class="informalexample"><pre class="programlisting">function fetch_discussions($filter = null, $direction = null) {
  $query = "SELECT * FROM 'discussions', 'users' 
            WHERE 'discussions'.'usr_id' = 'users'.'usr_id'
            AND 'discussions'.'ds_is_active' != '0' ";</pre></div><p>If the <code class="literal">filter</code> variable is initially null, then we will need to order the results to ascending. In<a id="id166" class="indexterm"/> the following code, we test <a id="id167" class="indexterm"/>whether <code class="literal">$filter</code> equals <code class="literal">null</code>; if not, <code class="literal">$dir =  'ASC'</code> sets the direction to ascending. If, however, <code class="literal">$filter</code> is not <code class="literal">null</code>, then we go into the PHP <code class="literal">if</code> statement and look at the value of <code class="literal">$direction</code>. We perform a PHP <code class="literal">switch case</code> procedure to quickly ascertain whether the value of <code class="literal">$direction</code> is <code class="literal">ASC</code> or <code class="literal">DESC</code>, writing the value of <code class="literal">$dir</code> to <code class="literal">ASC</code> or <code class="literal">DESC</code> accordingly:</p><div class="informalexample"><pre class="programlisting">if ($filter != null) {
  if ($filter == 'age') {
    $filter = 'ds_created_at';
    switch ($direction) {
      case 'ASC':
        $dir = 'ASC';
        break;
      case 'DESC':
        $dir = 'DESC';
        break;
      default:
        $dir = 'ASC';
    }
  }
} else {
  $dir = 'ASC';
}</pre></div><p>Next, the query is executed and its return value is analyzed. If the query was successful, then <code class="literal">$result</code> is returned to the <code class="literal">index()</code> function of the <code class="literal">discussions</code> controller. The <code class="literal">index()</code> function of the <code class="literal">discussions</code> controller then stores this query result in the <code class="literal">$page_data['query']</code> array item and passes it to the <code class="literal">discussions/view.php</code> view file. This is shown here:</p><div class="informalexample"><pre class="programlisting">$query .= "ORDER BY 'ds_created_at' " . $dir;
$result = $this-&gt;db-&gt;query($query, array($dir));

if ($result) {
  return $result;
} else {
  return false;
}
}

function fetch_discussion($ds_id) {
  $query = "SELECT * FROM 'discussions', 'users' WHERE 'ds_id' = ?
            AND 'discussions'.'usr_id' = 'users'.'usr_id'";
  return $result = $this-&gt;db-&gt;query($query, array($ds_id));
}</pre></div><p>Now, let's<a id="id168" class="indexterm"/> look at the <code class="literal">create($data)</code> function. The function takes an array (named <code class="literal">$data</code>) as its only argument. The <code class="literal">$data</code> array contains the following items:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">usr_email</code>: This is <a id="id169" class="indexterm"/>populated from the form in <code class="literal">views/discussions/new.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">usr_id</code>: This<a id="id170" class="indexterm"/> is populated by the model itself by looking in the database</li><li class="listitem" style="list-style-type: disc"><code class="literal">usr_name</code>: This <a id="id171" class="indexterm"/>is populated from the form in <code class="literal">views/discussions/new.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ds_title</code>: This<a id="id172" class="indexterm"/> is populated from the form in <code class="literal">views/discussions/new.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ds_body</code>: This<a id="id173" class="indexterm"/> is populated from the form in <code class="literal">views/discussions/new.php</code></li></ul></div><p>We <a id="id174" class="indexterm"/>want to associate this discussion forum with a user. Although we don't really manage users in this application, we still want to do this as it might be useful for us in the future. To associate a discussion with a user, we'll need to find an existing user ID (<code class="literal">users.usr_id</code>) or create a new user and assign that ID instead.</p><p>This function begins by looking at the <code class="literal">users</code> table to see whether the e-mail address in <code class="literal">$data['usr_email']</code> already exists in the database. If it does, then <code class="literal">usr_id</code> is pulled out of the <code class="literal">users</code> table and written to <code class="literal">$data['usr_id']</code>; this will be stored until we update to the <code class="literal">discussions</code> table:</p><div class="informalexample"><pre class="programlisting">function create($data) {
  // Look and see if the email address already exists in the users 
  // table, if it does return the primary key, if not create them 
  // a user account and return the primary key.
  $usr_email = $data['usr_email'];
  $query = "SELECT * FROM 'users' WHERE 'usr_email' = ? ";
  $result = $this-&gt;db-&gt;query($query,array($usr_email));

  if ($result-&gt;num_rows() &gt; 0) {
    foreach ($result-&gt;result() as $rows) {
      $data['usr_id'] = $rows-&gt;usr_id;
    }
  } else {</pre></div><p>If the<a id="id175" class="indexterm"/> e-mail address doesn't exist in<a id="id176" class="indexterm"/> the <code class="literal">users</code> table, then a record is created. A password is generated using the <code class="literal">random_string()</code> CodeIgniter function. The password is stored in the <code class="literal">$password</code> variable and is passed to the <code class="literal">sha1</code> CodeIgniter function to generate a hash string:</p><div class="informalexample"><pre class="programlisting">$password = random_string('alnum', 16);
$hash = $this-&gt;encrypt-&gt;sha1($password);</pre></div><p>The <code class="literal">$hash</code> value along with <code class="literal">usr_email</code> and <code class="literal">usr_name</code>, submitted by the user, is added to the <code class="literal">$user_data</code> array. Also added to the <code class="literal">$user_data</code> array are some admin flags such as <code class="literal">usr_is_active</code> and <code class="literal">usr_level</code>.</p><p>The <code class="literal">usr_is_active</code> flag is set to <code class="literal">1</code> by default; this can be set to any other value you wish should you want to add user management functions. The <code class="literal">usr_level</code> flag is set to <code class="literal">1</code> by default; this can be set to any other value you wish should you want to add user management functions:</p><div class="informalexample"><pre class="programlisting">$user_data = array('usr_email' =&gt; $data['usr_email'],
                   'usr_name' =&gt; $data['usr_name'],
                   'usr_is_active' =&gt; '1',
                   'usr_level' =&gt; '1',
                   'usr_hash' =&gt; $hash);</pre></div><p>The <code class="literal">$user_data</code> array is inserted to the database. Should you wish, you could send the user an e-mail containing their password; this will only be because you want to add user management functionality. The newly created user ID is returned by <code class="literal">$this-&gt;db-&gt;insert_id()</code> and stored in <code class="literal">$data['usr_id']</code>. This is shown here:</p><div class="informalexample"><pre class="programlisting">  if ($this-&gt;db-&gt;insert('users',$user_data)) {
    $data['usr_id'] = $this-&gt;db-&gt;insert_id();
    // Send email with password???
  }
}</pre></div><p>Once the user ID is stored in the <code class="literal">$data</code> array, we create a new array, <code class="literal">$discussion_data</code>. The <code class="literal">$discussion_data</code> array contains all the data required for the creation of a discussion, as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">ds_title</code>: This<a id="id177" class="indexterm"/> is populated from the form in <code class="literal">views/discussions/new.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ds_body</code>: This<a id="id178" class="indexterm"/> is populated from the form in <code class="literal">views/discussions/new.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">usr_id</code>: This <a id="id179" class="indexterm"/>is populated by a database lookup</li><li class="listitem" style="list-style-type: disc"><code class="literal">ds_is_active</code>: This<a id="id180" class="indexterm"/> is set when we create the <code class="literal">$discussion_data</code> array</li></ul></div><p>Once the <code class="literal">$discussion_data</code> array is created, we write the record to the discussion table:</p><div class="informalexample"><pre class="programlisting">$discussion_data = array('ds_title' =&gt; $data['ds_title'],
                         'ds_body' =&gt; $data['ds_body'],
                         'usr_id' =&gt; $data['usr_id'],
                         'ds_is_active' =&gt; '1');</pre></div><p>If the<a id="id181" class="indexterm"/> insertion was successful, we return <code class="literal">TRUE</code>; if it wasn't successful, we return <code class="literal">FALSE</code>.</p><p>This<a id="id182" class="indexterm"/> model also contains the <code class="literal">flag()</code> function. The <code class="literal">flag()</code> function uses an <code class="literal">UPDATE</code> command to set the <code class="literal">ds_is_active</code> column to <code class="literal">0</code>. This means that the discussion will not be displayed to users, as the <code class="literal">fetch_discussions()</code> function of <code class="literal">discussions_model</code> will only return discussions that have <code class="literal">ds_is_active</code> set to <code class="literal">1</code>. This is shown here:</p><div class="informalexample"><pre class="programlisting">  if ($this-&gt;db-&gt;insert('discussions',$discussion_data) ) {
    return $this-&gt;db-&gt;insert_id();
  } else {
    return false;
  }
}</pre></div><p>The <code class="literal">flag()</code> function accepts one argument—that is, the primary key of the discussion passed by the <code class="literal">discussions</code> controller. When the user clicks on the <span class="strong"><strong>flag</strong></span> link next to a discussion title in the <code class="literal">views/discussions/view.php</code> file, the <code class="literal">flag()</code> function of the <code class="literal">discussions</code> controller is called. The third <code class="literal">uri</code> segment in the <span class="strong"><strong>flag</strong></span> link is the primary key of the discussion.</p><p>We use CodeIgniter's Active Record functionality to update the discussions record in the database, setting <code class="literal">ds_is_active</code> to <code class="literal">0</code>. Setting <code class="literal">ds_is_active</code> to <code class="literal">0</code> will immediately prevent the discussion from being viewed in <code class="literal">views/discussions/view.php</code> and make it appear in the admin section for moderation:</p><div class="informalexample"><pre class="programlisting">  function flag($ds_id) {
    $this-&gt;db-&gt;where('ds_id', $ds_id);
    if ($this-&gt;db-&gt;update('discussions', array('ds_is_active' =&gt; '0'))) {
      return true;
    } else {
      return false;
    }
  }
}</pre></div></div><div class="section" title="Creating the model file – comments_model.php"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec26"/>Creating the model file – comments_model.php</h2></div></div></div><p>The <code class="literal">comments_model.php</code> model file contains three functions; these are <code class="literal">fetch_comments()</code>, <code class="literal">new_comment()</code>, and <code class="literal">flag()</code>. The <code class="literal">fetch_comments()</code> function fetches all comments that belong to a discussion forum and are active. The <code class="literal">new_comment()</code> function adds a comment to the database associated with a discussion forum by <a id="id183" class="indexterm"/>means of a foreign key. Finally, the <code class="literal">flag()</code> function will set a comment as one that requires moderation.</p><p>Create <a id="id184" class="indexterm"/>the <code class="literal">/path/to/codeigniter/application/models/comments_model.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Comments_model extends CI_Model {
    function __construct() {
        parent::__construct();
    }</pre></div><p>There are three functions in this model. These are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">fetch_comments()</code>: This fetches all active comments that are associated with the <a id="id185" class="indexterm"/>current <a id="id186" class="indexterm"/>discussion from the <code class="literal">comments</code> table .</li><li class="listitem" style="list-style-type: disc"><code class="literal">new_comments()</code>: This<a id="id187" class="indexterm"/> creates a <a id="id188" class="indexterm"/>new record in the <code class="literal">comments</code> table. The comment is associated with <code class="literal">users.usr_id</code> and <code class="literal">discussions.ds_id</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">flag()</code>: This <a id="id189" class="indexterm"/>sets a comment <a id="id190" class="indexterm"/>as being flagged for moderation by setting <code class="literal">comments.cm_is_active</code> to <code class="literal">0</code>.</li></ul></div><p>The <code class="literal">fetch_comments()</code> function accepts one argument—<code class="literal">$ds_id</code>—that is the primary key of the discussion in the database. We take this primary key and look in the database for comments belonging to that discussion, and users belonging to the comments, as shown here:</p><div class="informalexample"><pre class="programlisting">function fetch_comments($ds_id) {
    $query = "SELECT * FROM 'comments', 'discussions', 'users' 
              WHERE 'discussions'.'ds_id' = ?
               AND 'comments'.'ds_id' = 'discussions'.'ds_id' 
               AND 'comments'.'usr_id' = 'users'.'usr_id' 
               AND 'comments'.'cm_is_active' = '1' 
               ORDER BY 'comments'.'cm_created_at' DESC " ;

        $result = $this-&gt;db-&gt;query($query, array($ds_id));</pre></div><p>These comments are then returned as an Active Record database result object. Or, the Boolean value <code class="literal">false</code> is returned if an error occurred, as shown here:</p><div class="informalexample"><pre class="programlisting">    if ($result) {
        return $result;
    } else {
        return false;
    }
}</pre></div><p>The <code class="literal">new_comment()</code> function takes one argument, the <code class="literal">$data</code> array. This is populated <a id="id191" class="indexterm"/>in the <code class="literal">comments</code> controller, as <a id="id192" class="indexterm"/>shown here:</p><div class="informalexample"><pre class="programlisting">function new_comment($data) {
    // Look and see if the email address already exists in the users 
    // table, if it does return the primary key, if not create them 
    // a user account and return the primary key.</pre></div><p>First off, we check whether the e-mail address used by the person who is commenting already exists in the database; we do this as we might want to add functionality to ban particular users later, delete posts from specific users, or even develop functionality to allow users to log in and view their previous posts:</p><div class="informalexample"><pre class="programlisting">        $usr_email = $data['usr_email'];
        $query = "SELECT * FROM 'users' WHERE 'usr_email' = ? ";
        $result = $this-&gt;db-&gt;query($query,array($usr_email));

        if ($result-&gt;num_rows() &gt; 0) {</pre></div><p>If we arrive here in the code, then the e-mail address is obviously already in the database, so we grab the users' primary key and store it in <code class="literal">$data['usr_id']</code>; later, we will save it to the comment:</p><div class="informalexample"><pre class="programlisting">    foreach ($result-&gt;result() as $rows) {
        $data['usr_id'] = $rows-&gt;usr_id;
    }
} else {</pre></div><p>If we get here, then the user doesn't exist, so we create them in the <code class="literal">users</code> table, returning the primary key using the <code class="literal">$this-&gt;d-&gt;insert_id()</code>CodeIgniter function:</p><div class="informalexample"><pre class="programlisting">    $password = random_string('alnum', 16);
    $hash = $this-&gt;encrypt-&gt;sha1($password); 

    $user_data = array('usr_email' =&gt; $data['usr_email'],
                       'usr_name' =&gt; $data['usr_name'],
                       'usr_is_active' =&gt; '1',
                       'usr_level' =&gt; '1',
                       'usr_hash' =&gt; $hash);

    if ($this-&gt;db-&gt;insert('users',$user_data)) {
        $data['usr_id'] = $this-&gt;db-&gt;insert_id();
    }
}

$comment_data = array('cm_body' =&gt; $data['cm_body'],
                      'ds_id' =&gt; $data['ds_id'],
                      'cm_is_active' =&gt; '1',
                      'usr_id' =&gt; $data['usr_id']);</pre></div><p>Now we<a id="id193" class="indexterm"/> save the comment to the <code class="literal">comments</code> table<a id="id194" class="indexterm"/> using the CodeIgniter Active Record function <code class="literal">$this-&gt;db-&gt;insert()</code>. This is shown here:</p><div class="informalexample"><pre class="programlisting">        if ($this-&gt;db-&gt;insert('comments',$comment_data) ) {
            return $this-&gt;db-&gt;insert_id();
        } else {
            return false;
        }
    }

  function flag($cm_id) {
    $this-&gt;db-&gt;where('cm_id', $cm_id);
    if ($this-&gt;db-&gt;update('comments', array('cm_is_active' =&gt; '0'))) {
      return true;
    } else {
      return false;
    }
  } 
}</pre></div></div><div class="section" title="Creating the model file – admin_model.php"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec27"/>Creating the model file – admin_model.php</h2></div></div></div><p>There are <a id="id195" class="indexterm"/>four functions in the <code class="literal">admin_model.php</code> model, and<a id="id196" class="indexterm"/> these are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">dashboard_fetch_comments()</code>: This fetches comments from the databases that<a id="id197" class="indexterm"/> have<a id="id198" class="indexterm"/> been flagged for moderation.</li><li class="listitem" style="list-style-type: disc"><code class="literal">dashboard_fetch_discussions()</code>: This fetches discussions from the databases<a id="id199" class="indexterm"/> that <a id="id200" class="indexterm"/>have been flagged for moderation.</li><li class="listitem" style="list-style-type: disc"><code class="literal">update_comments()</code>: This updates a comment based on the decision of the moderator, changing the value of <code class="literal">cm_is_active</code> to <code class="literal">1</code> if the comment is approved <a id="id201" class="indexterm"/>or deleting it<a id="id202" class="indexterm"/> if is unapproved.</li><li class="listitem" style="list-style-type: disc"><code class="literal">update_discussions()</code>: This updates a discussion based on the decision of the<a id="id203" class="indexterm"/> moderator, changing <a id="id204" class="indexterm"/>the value of <code class="literal">cm_is_active</code> to <code class="literal">1</code> if approved or deleting it if is unapproved. If a discussion is deleted, then all comments associated with that discussion will also be deleted.</li></ul></div><p>Create the <code class="literal">/path/to/codeigniter/application/models/admin_model.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Admin_model extends CI_Model {
    function __construct() {
        parent::__construct();
    }</pre></div><p>The following function will fetch all comments for moderation from the database. Comments are for moderation if <code class="literal">comments.cm_is_active</code> is set to <code class="literal">0</code>. The database is queried and all comments for moderation are returned to the <code class="literal">admin</code> controller. This result will eventually be looped over in the <code class="literal">views/admin/dashboard.php</code> file:</p><div class="informalexample"><pre class="programlisting">function dashboard_fetch_comments() {
    $query = "SELECT * FROM 'comments', 'users' 
              WHERE 'comments'.'usr_id' = 'users'.'usr_id'
              AND 'cm_is_active' = '0' ";

    $result = $this-&gt;db-&gt;query($query);

    if ($result) {
        return $result;
    } else {
        return false;
    }
}</pre></div><p>The following function will fetch all discussions for moderation from the database. Discussions are for moderation if <code class="literal">discussions.ds_is_active</code> is set to <code class="literal">0</code>. The database is queried and all discussions for moderation are returned to the <code class="literal">admin</code> controller. This result will eventually be looped over in the <code class="literal">views/admin/dashboard.php</code> file:</p><div class="informalexample"><pre class="programlisting">function dashboard_fetch_discussions() {
    $query = "SELECT * FROM 'discussions', 'users' 
             WHERE 'discussions'.'usr_id' = 'users'.'usr_id'
             AND 'ds_is_active' = '0' ";

    $result = $this-&gt;db-&gt;query($query);

    if ($result) {
        return $result;
    } else {
        return false;
    }
}

function does_user_exist($email) {
    $this-&gt;db-&gt;where('usr_email', $email);
    $query = $this-&gt;db-&gt;get('users');
    return $query;
} </pre></div><p>The <a id="id205" class="indexterm"/>following function is called by the <code class="literal">admin</code> controller function when an admin is moderating comments. If a comment is deemed<a id="id206" class="indexterm"/> to be fine, then <code class="literal">comments.cm_is_active</code> is updated and set to <code class="literal">1</code>. However, if it is not fine, then the comment is deleted from the <code class="literal">comments</code> table:</p><div class="informalexample"><pre class="programlisting">function update_comments($is_active, $id) {
    if ($is_active == 1) {
        $query = "UPDATE 'comments' SET 'cm_is_active' = ? WHERE 'cm_id' = ? " ;
        if ($this-&gt;db-&gt;query($query,array($is_active,$id))) {
            return true;
        } else {
            return false;
        }
    } else {
        $query = "DELETE FROM 'comments' WHERE 'cm_id' = ?  " ;
        if ($this-&gt;db-&gt;query($query,array($id))) {
            return true;
        } else {
            return false;
        } 
    } 
}</pre></div><p>The <a id="id207" class="indexterm"/>following function is called by the <code class="literal">admin</code> controller function when an admin is moderating discussions. If a discussion is deemed to<a id="id208" class="indexterm"/> be fine, then <code class="literal">discussions.ds_is_active</code> is updated and set to <code class="literal">1</code>. However, if it is not fine, then the discussion is deleted from the <code class="literal">discussions</code> table. Any comments belonging to that discussion are also deleted from the <code class="literal">comments</code> table:</p><div class="informalexample"><pre class="programlisting">    function update_discussions($is_active, $id) {
        if ($is_active == 1) {
            $query = "UPDATE 'discussions' SET 'ds_is_active' = ? WHERE 'ds_id' = ? " ;
            if ($this-&gt;db-&gt;query($query, array($is_active,$id))) {
                return true;
            } else {
                return false;
            } 
        } else {
            $query = "DELETE FROM 'discussions' WHERE 'ds_id' = ?  " ;
            if ($this-&gt;db-&gt;query($query,array($id))) {
                $query = "DELETE FROM 'comments' WHERE 'ds_id' = ?  " ;
                if ($this-&gt;db-&gt;query($query,array($id))) {
                    return true;
                }
            } else {
                return false;
            } 
        } 
    }
}</pre></div></div></div>
<div class="section" title="Creating views"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec33"/>Creating views</h1></div></div></div><p>There <a id="id209" class="indexterm"/>are six view files in this application, and these are as<a id="id210" class="indexterm"/> follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">discussions/view.php</code>: This <a id="id211" class="indexterm"/>displays all active discussions</li><li class="listitem" style="list-style-type: disc"><code class="literal">discussions/new.php</code>: This <a id="id212" class="indexterm"/>displays a form to the user, allowing them to create a discussion</li><li class="listitem" style="list-style-type: disc"><code class="literal">comments/view.php</code>: This <a id="id213" class="indexterm"/>displays all active comments within a discussion</li><li class="listitem" style="list-style-type: disc"><code class="literal">nav/top_nav.php</code>: This <a id="id214" class="indexterm"/>contains the top navigation links</li><li class="listitem" style="list-style-type: disc"><code class="literal">admin/login.php</code>: This <a id="id215" class="indexterm"/>displays a login form for the user; don't forget to add the <code class="literal">signin.css</code> script, which you can find later in this chapter</li><li class="listitem" style="list-style-type: disc"><code class="literal">common/login_header.php</code>: The <code class="literal">views/admin/login.php</code> view requires different resources from the rest of<a id="id216" class="indexterm"/> the application, which is supported by this header</li></ul></div><div class="section" title="Discussions"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec28"/>Discussions</h2></div></div></div><p>The <code class="literal">discussions/view.php</code> view file displays a list of all active discussions as well as sorting <a id="id217" class="indexterm"/>options.</p><p>Create<a id="id218" class="indexterm"/> the <code class="literal">/path/to/codeigniter/views/discussions/view.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">SORT: &lt;?php echo anchor('discussions/index/sort/age/' . (($dir == 'ASC') ? 'DESC' : 'ASC'),'Newest ' 
            . (($dir == 'ASC') ? 'DESC' : 'ASC'));?&gt;

&lt;table class="table table-hover"&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;&lt;?php echo $this-&gt;lang-&gt;line('discussions_title') ; ?&gt;&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;

    &lt;?php foreach ($query-&gt;result() as $result) : ?&gt;
      &lt;tr&gt;
        &lt;td&gt;
          &lt;?php echo anchor('comments/index/'.$result-&gt;ds_id,$result-&gt;ds_title) . ' '
                . $this-&gt;lang-&gt;line('comments_created_by') . $result-&gt;usr_name; ?&gt;

          &lt;?php echo anchor('discussions/flag/'.$result-&gt;ds_id,
          $this-&gt;lang-&gt;line('discussion_flag')) ; ?&gt;
          &lt;br /&gt;
          &lt;?php echo $result-&gt;ds_body ; ?&gt;
        &lt;/td&gt;
      &lt;/tr&gt;
    &lt;?php endforeach ; ?&gt;

  &lt;/tbody&gt;
&lt;/table&gt;</pre></div><p>Take a<a id="id219" class="indexterm"/> look at the first few lines. We open with a CodeIgniter <code class="literal">anchor()</code> statement. Let's <a id="id220" class="indexterm"/>take a closer look at the code for the link:</p><div class="informalexample"><pre class="programlisting">SORT: &lt;?php echo anchor('discussions/index/sort/age/' . (($dir == 'ASC') ? 'DESC' : 'ASC'),'Newest ' . (($dir == 'ASC') ? 'DESC' : 'ASC'));?&gt;</pre></div><p>Let's break this down into smaller sections:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">anchor('discussions/index/age/sort/' .</code>: This sets the link for the <code class="literal">discussions</code> controller, <code class="literal">index()</code> function, and sorting by age (the created date—<code class="literal">discussions.ds_created_at</code>), but what is the direction? Well…</li><li class="listitem" style="list-style-type: disc"><code class="literal">(($dir == 'ASC') ? 'DESC' : 'ASC'),</code>: The value of <code class="literal">$dir</code> comes from the <code class="literal">index()</code> function of the <code class="literal">discussions</code> controller. It is the current direction of the sort. We then use a PHP ternary operator to switch between the directions. It's a bit like an if/else statement but is more compact. It works like this: <span class="emphasis"><em>if a variable is equal (or not equal) to a variable, then execute A, otherwise execute B</em></span>. For example, as an if/else statement, the code would be as follows:<div class="informalexample"><pre class="programlisting">if ($dir == 'ASC') {
  return 'DESC';
} else {
  return 'ASC';
}</pre></div><p>So, the second part of the link will flip-flop between <code class="literal">ASC</code> and <code class="literal">DESC</code> depending on the value held in <code class="literal">$dir</code>.  Now, let's look at the rest.</p></li><li class="listitem" style="list-style-type: disc"><code class="literal">'Newest ' . (($dir == 'ASC') ? 'DESC' : 'ASC'));?&gt;</code>: This is the text that users will see as their link. You can see that we again make use of the ternary operator to display the text, flipping between <code class="literal">Newest ASC</code> and <code class="literal">Newest DESC</code>.</li></ul></div><p>The rest <a id="id221" class="indexterm"/>of the view is fairly undramatic; all we do is loop over the <a id="id222" class="indexterm"/>database result from the discussions' <code class="literal">index()</code> function, displaying all active discussions as we go.</p></div><div class="section" title="Comments"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec29"/>Comments</h2></div></div></div><p>The <a id="id223" class="indexterm"/>comments view displays a list of all valid comments to the user for a<a id="id224" class="indexterm"/> selected discussion.</p><p>Create the <code class="literal">/path/to/codeigniter/application/views/comments/view.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;!-- Discussion - initial comment --&gt;
&lt;?php foreach ($discussion_query-&gt;result() as $discussion_result) : ?&gt;
  &lt;h2&gt;
      &lt;?php echo $discussion_result-&gt;ds_title; ?&gt;&lt;br /&gt;
      &lt;small&gt;&lt;?php echo $this-&gt;lang-&gt;line('comments_created_by') . $discussion_result-&gt;usr_name . $this-&gt;lang-&gt;line('comments_created_at') . $discussion_result-&gt;ds_created_at; ?&gt;&lt;/small&gt;
  &lt;/h2&gt;
  &lt;p class="lead"&gt;&lt;?php echo $discussion_result-&gt;ds_body; ?&gt;&lt;/p&gt;
&lt;?php endforeach ; ?&gt;

&lt;!-- Comment - list of comments --&gt;
&lt;?php foreach ($comment_query-&gt;result() as $comment_result) : ?&gt;
  &lt;li class="media"&gt;
    &lt;a class="pull-left" href="#"&gt;
      &lt;img class="media-object" src="&lt;?php echo base_url() ; ?&gt;img/profile.svg" /&gt;
    &lt;/a&gt;
    &lt;div class="media-body"&gt;
      &lt;h4 class="media-heading"&gt;&lt;?php echo $comment_result-&gt;usr_name . anchor('comments/flag/'.$comment_result-&gt;ds_id . '/' . $comment_result-&gt;cm_id,$this-&gt;lang-&gt;line('comments_flag')) ; ?&gt;&lt;/h4&gt;
      &lt;?php echo $comment_result-&gt;cm_body ; ?&gt;
    &lt;/div&gt;
  &lt;/li&gt;
&lt;?php endforeach ; ?&gt;

&lt;!-- Form - begin form section --&gt;
&lt;br /&gt;&lt;br /&gt;
&lt;p class="lead"&gt;&lt;?php echo $this-&gt;lang-&gt;line('comments_form_instruction');?&gt;&lt;/p&gt;

&lt;?php echo validation_errors(); ?&gt;
&lt;?php echo form_open('comments/index','role="form"') ; ?&gt;
    &lt;div class="form-group col-md-5"&gt;
      &lt;label for="comment_name"&gt;&lt;?php echo $this-&gt;lang-&gt;line('comments_comment_name');?&gt;&lt;/label&gt;
      &lt;input type="text" name="comment_name" class="form-control" id="comment_name" value="&lt;?php echo set_value('comment_name'); ?&gt;"&gt;
    &lt;/div&gt;
    &lt;div class="form-group col-md-5"&gt;
      &lt;label for="comment_email"&gt;&lt;?php echo $this-&gt;lang-&gt;line('comments_comment_email');?&gt;&lt;/label&gt;
      &lt;input type="email" name="comment_email" class="form-control" id="comment_email" value="&lt;?php echo set_value('comment_email'); ?&gt;"&gt;
    &lt;/div&gt;
    &lt;div class="form-group  col-md-10"&gt;
      &lt;label for="comment_body"&gt;&lt;?php echo $this-&gt;lang-&gt;line('comments_comment_body');?&gt;&lt;/label&gt;
      &lt;textarea class="form-control" rows="3" name="comment_body" id="comment_body"&gt;&lt;?php echo set_value('comment_body'); ?&gt;&lt;/textarea&gt;
    &lt;/div&gt;
    &lt;div class="form-group  col-md-11"&gt;
      &lt;button type="submit" class="btn btn-success"&gt;&lt;?php echo $this-&gt;lang-&gt;line('common_form_elements_go');?&gt;&lt;/button&gt;
    &lt;/div&gt;
  &lt;?php echo form_hidden('ds_id',$ds_id) ; ?&gt;
&lt;?php echo form_close() ; ?&gt; </pre></div><p>Note<a id="id225" class="indexterm"/> the<a id="id226" class="indexterm"/> following line in the form:</p><div class="informalexample"><pre class="programlisting">&lt;button type="submit" class="btn btn-success"&gt;&lt;?php echo $this-&gt;lang-&gt;line('common_form_elements_go');?&gt;&lt;/button&gt;</pre></div><p>You will see that we use a line from the <code class="literal">lang</code> file that is not in the code example; this is because the <code class="literal">common_form_elements_go</code> line is to be found in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>.</p></div><div class="section" title="New discussion"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec30"/>New discussion</h2></div></div></div><p>The <a id="id227" class="indexterm"/>New Discussion view displays a form to the user and any <a id="id228" class="indexterm"/>validation error messages that might need to be conveyed.</p><p>Create the <code class="literal">/path/to/codeigniter/application/views/discussions/new.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;!-- Form - begin form section --&gt;
&lt;br /&gt;&lt;br /&gt;
&lt;p class="lead"&gt;&lt;?php echo $this-&gt;lang-&gt;line('discussion_form_instruction');?&gt;&lt;/p&gt;

&lt;?php echo validation_errors(); ?&gt;
&lt;?php echo form_open('discussions/create','role="form"') ; ?&gt;
    &lt;div class="form-group col-md-5"&gt;
      &lt;label for="usr_name"&gt;&lt;?php echo $this-&gt;lang-&gt;line('discussion_usr_name');?&gt;&lt;/label&gt;
      &lt;input type="text" name="usr_name" class="form-control" id="usr_name" value="&lt;?php echo set_value('usr_name'); ?&gt;"&gt;
    &lt;/div&gt;
    &lt;div class="form-group col-md-5"&gt;
      &lt;label for="usr_email"&gt;&lt;?php echo $this-&gt;lang-&gt;line('discussion_usr_email');?&gt;&lt;/label&gt;
      &lt;input type="email" name="usr_email" class="form-control" id="usr_email" value="&lt;?php echo set_value('usr_email'); ?&gt;"&gt;
    &lt;/div&gt;
    &lt;div class="form-group col-md-10"&gt;
      &lt;label for="ds_title"&gt;&lt;?php echo $this-&gt;lang-&gt;line('discussion_ds_title');?&gt;&lt;/label&gt;
      &lt;input type="text" name="ds_title" class="form-control" id="ds_title" value="&lt;?php echo set_value('ds_title'); ?&gt;"&gt;
    &lt;/div&gt;
    &lt;div class="form-group  col-md-10"&gt;
      &lt;label for="ds_body"&gt;&lt;?php echo $this-&gt;lang-&gt;line('discussion_ds_body');?&gt;&lt;/label&gt;
      &lt;textarea class="form-control" rows="3" name="ds_body" id="ds_body"&gt;&lt;?php echo set_value('ds_body'); ?&gt;&lt;/textarea&gt;
    &lt;/div&gt;
    &lt;div class="form-group  col-md-11"&gt;
      &lt;button type="submit" class="btn btn-success"&gt;&lt;?php echo $this-&gt;lang-&gt;line('common_form_elements_go');?&gt;&lt;/button&gt;
    &lt;/div&gt;
&lt;?php echo form_close() ; ?&gt;</pre></div><p>Note the following line in the form:</p><div class="informalexample"><pre class="programlisting">&lt;button type="submit" class="btn btn-success"&gt;&lt;?php echo $this-&gt;lang-&gt;line('common_form_elements_go');?&gt;&lt;/button&gt;</pre></div><p>You will see that we use a line from the <code class="literal">lang</code> file that is not in the code example; this is because the <code class="literal">common_form_elements_go</code> line is to be found in <a class="link" href="ch01.html" title="Chapter 1. Introduction and Shared Project Resources">Chapter 1</a>, <span class="emphasis"><em>Introduction and Shared Project Resources</em></span>.</p><p>We<a id="id229" class="indexterm"/> provide options to the user to create a new discussion. We <a id="id230" class="indexterm"/>display form elements for them to enter their username, e-mail, discussion title, and the text of their discussion.</p><p>The form is submitted to the <code class="literal">create()</code> function of the <code class="literal">discussion</code> controller, where is it validated with any validation errors being displayed.</p></div><div class="section" title="The top_nav file"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec31"/>The top_nav file</h2></div></div></div><p>Every <a id="id231" class="indexterm"/>project in this book has its own navigation file, and this is no <a id="id232" class="indexterm"/>exception. The <code class="literal">top_nav</code> file is standard Bootstrap navigation code; however, there are a few Codeigniter <code class="literal">anchor()</code> functions that provide the URL links and text.</p><p>Create the <code class="literal">/path/to/codeigniter/application/views/common/top_nav.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;!-- Fixed navbar --&gt;
&lt;div class="navbar navbar-inverse navbar-fixed-top" role="navigation"&gt;
  &lt;div class="container"&gt;
    &lt;div class="navbar-header"&gt;
      &lt;button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"&gt;
        &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
        &lt;span class="icon-bar"&gt;&lt;/span&gt;
      &lt;/button&gt;
      &lt;a class="navbar-brand" href="#"&gt;&lt;?php echo $this-&gt;lang-&gt;line('system_system_name'); ?&gt;&lt;/a&gt;
    &lt;/div&gt;
    &lt;div class="navbar-collapse collapse"&gt;
      &lt;ul class="nav navbar-nav"&gt;
        &lt;li &lt;?php if ($this-&gt;uri-&gt;segment(1) == '') {echo 'class="active"';} ; ?&gt;&gt;&lt;?php echo anchor('/', $this-&gt;lang-&gt;line('top_nav_view_discussions')) ; ?&gt;&lt;/li&gt;
        &lt;li &lt;?php if ($this-&gt;uri-&gt;segment(1) == 'discussions') {echo 'class="active"';} ; ?&gt;&gt;&lt;?php echo anchor('discussions/create', $this-&gt;lang-&gt;line('top_nav_new_discussion')) ; ?&gt;&lt;/li&gt;
      &lt;/ul&gt;

      &lt;ul class="nav navbar-nav navbar-right"&gt;
        &lt;li&gt;&lt;?php echo anchor('admin/login', $this-&gt;lang-&gt;line('top_nav_login')) ; ?&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/div&gt;&lt;!--/.nav-collapse --&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;div class="container theme-showcase" role="main"&gt;</pre></div></div><div class="section" title="The login view"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec32"/>The login view</h2></div></div></div><p>The<a id="id233" class="indexterm"/> login view displays the form and any errors to the admin user when<a id="id234" class="indexterm"/> he/she wants to log in.</p><p>Create the <code class="literal">/path/to/codeigniter/application/views/admin/login.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (isset($login_fail)) : ?&gt;
  &lt;div class="alert alert-danger"&gt;&lt;?php echo $this-&gt;lang-&gt;line('admin_login_error') ; ?&gt;&lt;/div&gt;
&lt;?php endif ; ?&gt;
&lt;?php echo validation_errors(); ?&gt;

&lt;div class="container"&gt;
  &lt;?php echo form_open('admin/login', 'class="form-signin" role="form"') ; ?&gt;
    &lt;h2 class="form-signin-heading"&gt;&lt;?php echo $this-&gt;lang-&gt;line('admin_login_header') ; ?&gt;&lt;/h2&gt;
    &lt;input type="email" name="usr_email" class="form-control" placeholder="&lt;?php echo $this-&gt;lang-&gt;line('admin_login_email') ; ?&gt;" required autofocus&gt;
    &lt;input type="password" name="usr_password" class="form-control" placeholder="&lt;?php echo $this-&gt;lang-&gt;line('admin_login_password') ; ?&gt;" required&gt;
    &lt;button class="btn btn-lg btn-primary btn-block" type="submit"&gt;&lt;?php echo $this-&gt;lang-&gt;line('admin_login_signin') ; ?&gt;&lt;/button&gt;
  &lt;?php echo form_close() ; ?&gt;
&lt;/div&gt;</pre></div><p>There's not too much to get into here—everything is as you would expect. We display a form to the user, giving them text fields to enter their e-mail address and password, and errors are displayed above the form.</p><p>The form is submitted to the <code class="literal">login()</code> function of the <code class="literal">admin</code> controller, which will handle <a id="id235" class="indexterm"/>the technical process of logging the user in. If the login is <a id="id236" class="indexterm"/>successful, the user is directed to the <code class="literal">dashboard()</code> function of the <code class="literal">admin</code> controller.</p></div><div class="section" title="The login_header file"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec33"/>The login_header file</h2></div></div></div><p>The <code class="literal">admin/login.php</code> file requires different<a id="id237" class="indexterm"/> files and resources <a id="id238" class="indexterm"/>from the rest of the discussion forum application. For<a id="id239" class="indexterm"/> this reason, we're going to create a header file that's specific to the login page.</p><p>Create the <code class="literal">/path/to/codeigniter/application/common/login_header.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
    &lt;meta name="description" content=""&gt;
    &lt;meta name="author" content=""&gt;
    &lt;link rel="shortcut icon" href="&lt;?php echo base_url('bootstrap/ico/favicon.ico'); ?&gt;"&gt;

    &lt;title&gt;&lt;?php echo $this-&gt;lang-&gt;line('system_system_name'); ?&gt;&lt;/title&gt;

    &lt;!-- Bootstrap core CSS --&gt;
    &lt;link href="&lt;?php echo base_url('bootstrap/css/bootstrap.min.css'); ?&gt;" rel="stylesheet"&gt;
    &lt;!-- Bootstrap theme --&gt;
    &lt;link href="&lt;?php echo base_url('bootstrap/css/bootstrap-theme.min.css'); ?&gt;" rel="stylesheet"&gt;

    &lt;!-- Custom styles for this template --&gt;
    &lt;link href="&lt;?php echo base_url('bootstrap/css/signin.css');?&gt;" rel="stylesheet"&gt;


    &lt;!-- Just for debugging purposes. Don't actually copy this line! --&gt;
    &lt;!--[if lt IE 9]&gt;&lt;script src="../../assets/js/ie8-responsive-file-warning.js"&gt;&lt;/script&gt;&lt;![endif]--&gt;

    &lt;!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries --&gt;
    &lt;!--[if lt IE 9]&gt;
      &lt;script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"&gt;&lt;/script&gt;
      &lt;script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"&gt;&lt;/script&gt;
    &lt;![endif]--&gt;
  &lt;/head&gt;

  &lt;body&gt;</pre></div></div><div class="section" title="Dashboard"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec34"/>Dashboard</h2></div></div></div><p>The dashboard view is able to display to the admin user (in this case, a moderator) all discussion<a id="id240" class="indexterm"/> forums and comments that are awaiting moderation. These are <a id="id241" class="indexterm"/>displayed in a table in a list format, each item having two options for the moderator: Allow and Disallow.</p><p>Clicking on Allow will set the active status of the discussion (<code class="literal">discussions.ds_is_active</code>) or comment (<code class="literal">comments.cm_is_active</code>) to <code class="literal">1</code>, making them appear once more for general users to see. However, Disallow will delete them from the database. If it is a discussion forum being disallowed, then all comments associated with that discussion will also be deleted.</p><p>Create the <code class="literal">/path/to/codeigniter/application/views/admin/dashboard.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">  &lt;h1 id="tables" class="page-header"&gt;Dashboard&lt;/h1&gt;

&lt;table class="table"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
          &lt;th&gt;#&lt;/th&gt;
          &lt;th&gt;Name&lt;/th&gt;
          &lt;th&gt;Email&lt;/th&gt;
          &lt;td&gt;Actions&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        &lt;?php if ($discussion_query-&gt;num_rows() &gt; 0) : ?&gt;
            &lt;?php foreach ($discussion_query-&gt;result() as $row) : ?&gt;
                &lt;tr&gt;
                  &lt;td&gt;&lt;?php echo $row-&gt;ds_id ; ?&gt;&lt;/td&gt;
                  &lt;td&gt;&lt;?php echo $row-&gt;usr_name ; ?&gt;&lt;/td&gt;
                  &lt;td&gt;&lt;?php echo $row-&gt;usr_email ; ?&gt;&lt;/td&gt;
                  &lt;td&gt;&lt;?php echo anchor('admin/update_item/ds/allow/'.
                    $row-&gt;ds_id,$this-&gt;lang-&gt;line('admin_dash_allow')) .
                    ' ' . anchor('admin/update_item/ds/disallow/'.
                    $row-&gt;ds_id,$this-&gt;lang-&gt;line('admin_dash_disallow')) ; ?&gt;
                  &lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                  &lt;td colspan="3"&gt;&lt;?php echo $row-&gt;ds_title; ?&gt;&lt;/td&gt;
                  &lt;td&gt;&lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                   &lt;td colspan="3"&gt;&lt;?php echo $row-&gt;ds_body; ?&gt;&lt;/td&gt;
                  &lt;td&gt;&lt;/td&gt;
                &lt;/tr&gt;
            &lt;?php endforeach ; ?&gt;
        &lt;?php else : ?&gt;
            &lt;tr&gt;
              &lt;td colspan="4"&gt;No naughty forums here, horay!&lt;/td&gt;
            &lt;/tr&gt;
        &lt;?php endif; ?&gt;
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;table class="table"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
          &lt;th&gt;#&lt;/th&gt;
          &lt;th&gt;Name&lt;/th&gt;
          &lt;th&gt;Email&lt;/th&gt;
         &lt;td&gt;Actions&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        &lt;?php if ($comment_query-&gt;num_rows() &gt; 0) : ?&gt;
            &lt;?php foreach ($comment_query-&gt;result() as $row) : ?&gt;
                &lt;tr&gt;
                  &lt;td&gt;&lt;?php echo $row-&gt;cm_id ; ?&gt;&lt;/td&gt;
                  &lt;td&gt;&lt;?php echo $row-&gt;usr_name ; ?&gt;&lt;/td&gt;
                  &lt;td&gt;&lt;?php echo $row-&gt;usr_email ; ?&gt;&lt;/td&gt;
                  &lt;td&gt;&lt;?php echo anchor('admin/update_item/cm/allow/'.
                    $row-&gt;cm_id,$this-&gt;lang-&gt;line('admin_dash_allow')) . 
                    ' ' . anchor('admin/update_item/cm/disallow/'.
                    $row-&gt;cm_id,$this-&gt;lang-&gt;line('admin_dash_disallow')) ; ?&gt;
                  &lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                  &lt;td colspan="3"&gt;&lt;?php echo $row-&gt;cm_body; ?&gt;&lt;/td&gt;
                  &lt;td&gt;&lt;/td&gt;
                &lt;/tr&gt;
            &lt;?php endforeach ; ?&gt;
        &lt;?php else : ?&gt;
                &lt;tr&gt;
                  &lt;td colspan="4"&gt;No naughty comments here, horay!&lt;/td&gt;
                &lt;/tr&gt;
        &lt;?php endif; ?&gt;
    &lt;/tbody&gt;
&lt;/table&gt;</pre></div></div><div class="section" title="The signin.css file"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec35"/>The signin.css file</h2></div></div></div><p>The <code class="literal">signin.css</code> file is required to <a id="id242" class="indexterm"/>display the login form correctly; this<a id="id243" class="indexterm"/> is the same <code class="literal">signin.css</code> file as the one that is available from<a id="id244" class="indexterm"/> the Twitter Bootstrap resource.</p><p>Create the <code class="literal">/path/to/codeigniter/bootstrap/css/signin.css</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">body {
  padding-top: 40px;
  padding-bottom: 40px;
  background-color: #eee;
}

.form-signin {
  max-width: 330px;
  padding: 15px;
  margin: 0 auto;
}
.form-signin .form-signin-heading,
.form-signin .checkbox {
  margin-bottom: 10px;
}
.form-signin .checkbox {
  font-weight: normal;
}
.form-signin .form-control {
  position: relative;
  height: auto;
  -webkit-box-sizing: border-box;
     -moz-box-sizing: border-box;
          box-sizing: border-box;
  padding: 10px;
  font-size: 16px;
}
.form-signin .form-control:focus {
  z-index: 2;
}
.form-signin input[type="email"] {
  margin-bottom: -1px;
  border-bottom-right-radius: 0;
  border-bottom-left-radius: 0;
}
.form-signin input[type="password"] {
  margin-bottom: 10px;
  border-top-left-radius: 0;
  border-top-right-radius: 0;
}</pre></div></div></div>
<div class="section" title="Creating the controllers"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec34"/>Creating the controllers</h1></div></div></div><p>We're<a id="id245" class="indexterm"/> going to create three controllers for this <a id="id246" class="indexterm"/>application. These are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">discussions.php</code>: This fetches discussions from the <code class="literal">discussions</code> table in the database and allows the user to create a new discussion</li><li class="listitem" style="list-style-type: disc"><code class="literal">comments.php</code>: This fetches comments from the <code class="literal">comments</code> table in the database and allows the user to join a discussion by adding a comment to a discussion forum</li><li class="listitem" style="list-style-type: disc"><code class="literal">admin.php</code>: This contains basic admin functions, login functionalities, and moderation options</li></ul></div><div class="section" title="The discussions controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec36"/>The discussions controller</h2></div></div></div><p>The <code class="literal">discussions.php</code> controller<a id="id247" class="indexterm"/> is responsible for the display <a id="id248" class="indexterm"/>of all valid discussions, processing the creation of new discussions and flagging any discussion for moderation. The <code class="literal">discussions</code> controller contains three functions, and these are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">index()</code>: This<a id="id249" class="indexterm"/> displays all valid discussions</li><li class="listitem" style="list-style-type: disc"><code class="literal">create()</code>: This <a id="id250" class="indexterm"/>creates a new discussion, handling any form validation</li><li class="listitem" style="list-style-type: disc"><code class="literal">flag()</code>: This<a id="id251" class="indexterm"/> processes a discussion for moderation by calling the <code class="literal">flag()</code> function of <code class="literal">discussions_model.php</code>, setting <code class="literal">discussions.ds_is_active</code> to <code class="literal">0</code></li></ul></div><p>Create the <code class="literal">/path/to/codeigniter/application/controllers/discussions.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Discussions extends MY_Controller {
    function __construct() {
        parent::__construct();
        $this-&gt;load-&gt;helper('string');
        $this-&gt;load-&gt;library('encrypt');
        $this-&gt;load-&gt;model('Discussions_model');
        $this-&gt;load-&gt;library('form_validation');
        $this-&gt;form_validation-&gt;set_error_delimiters('&lt;div class="alert alert-danger"&gt;', '&lt;/div&gt;');
    }

    public function index() {
        if ($this-&gt;uri-&gt;segment(3)) {
            $filter = $this-&gt;uri-&gt;segment(4);
            $direction = $this-&gt;uri-&gt;segment(5);
            $page_data['dir'] = $this-&gt;uri-&gt;segment(5);
        } else {
            $filter = null;
            $direction = null;
            $page_data['dir'] = 'ASC';
        }

        $page_data['query'] = $this-&gt;Discussions_model-&gt;fetch_discussions($filter,$direction);

        $this-&gt;load-&gt;view('common/header');
        $this-&gt;load-&gt;view('nav/top_nav');
        $this-&gt;load-&gt;view('discussions/view', $page_data);
        $this-&gt;load-&gt;view('common/footer');
    }

    public function create() {
    public function create() {
        $this-&gt;form_validation-&gt;set_rules('usr_name', $this-&gt;lang-&gt;line('discussion_usr_name'), 'required|min_length[1]|max_length[255]');
        $this-&gt;form_validation-&gt;set_rules('usr_email', $this-&gt;lang-&gt;line('discussion_usr_email'), 'required|min_length[1]|max_length[255]');
        $this-&gt;form_validation-&gt;set_rules('ds_title', $this-&gt;lang-&gt;line('discussion_ds_title'), 'required|min_length[1]|max_length[255]');
        $this-&gt;form_validation-&gt;set_rules('ds_body', $this-&gt;lang-&gt;line('discussion_ds_body'), 'required|min_length[1]|max_length[5000]');

        if ($this-&gt;form_validation-&gt;run() == FALSE) { 
            $this-&gt;load-&gt;view('common/header');
            $this-&gt;load-&gt;view('nav/top_nav');
            $this-&gt;load-&gt;view('discussions/new');
            $this-&gt;load-&gt;view('common/footer');
        } else {
            $data = array('usr_name' =&gt; $this-&gt;input-&gt;post('usr_name'),
                          'usr_email' =&gt; $this-&gt;input-&gt;post('usr_email'),
                          'ds_title' =&gt; $this-&gt;input-&gt;post('ds_title'),
                          'ds_body' =&gt;  $this-&gt;input-&gt;post('ds_body')
                          );

            if ($ds_id = $this-&gt;Discussions_model-&gt;create($data)) {
                redirect('comments/index/'.$ds_id);
            } else {
                // error
                // load view and flash sess error
            }
        }
    }
    public function flag() {
        $ds_id = $this-&gt;uri-&gt;segment(3);
        if ($this-&gt;Discussions_model-&gt;flag($ds_id)) {
            redirect('discussions/');
        } else {
            // error
            // load view and flash sess error
        }
    }
}</pre></div><p>Taking <a id="id252" class="indexterm"/>each function one by one, we'll begin with <code class="literal">index()</code>. The <code class="literal">index()</code> function is responsible for displaying all active discussions<a id="id253" class="indexterm"/> to the user.</p><p>The code begins by checking to see whether there is a value in the third <code class="literal">uri</code> segment or not.</p><p>If there is a value present, then this indicates that the user has pressed the sort's ascending or descending link; we'll discusses this in a moment but, for now, we'll assume that there is no value in the third segment.</p><p>As there is no value present, we set <code class="literal">$filter</code> and <code class="literal">$direction</code> to <code class="literal">NULL</code>, but we set <code class="literal">$page_data['dir']</code> to <code class="literal">ASC</code> (short for ascending). This is set because, initially, the discussion forums are displayed in descending order of their created date; however, the sorting link needs to be written in the opposite direction from what is currently being displayed. Setting <code class="literal">$page_data['dir']</code> to <code class="literal">ASC</code> (ascending) will enable the URL in the sort link to be ready for us should we need to click it.</p><p>We then ask the <code class="literal">fetch_discussions()</code> function of <code class="literal">discussions_model.php</code> to get all active discussions, passing to it two variables as arguments: <code class="literal">$filter</code> and <code class="literal">$direction</code>. These are set to <code class="literal">null</code> by default. The <code class="literal">fetch_discussions()</code> function will know not to apply these filters.</p><p>The direction of the sort link will flip-flop between ascending and descending—always being the opposite of what is currently displayed. This flip-flopping is done in the view file (this might not be the best place for it if you're being strict, but I thought that this was a location that you would find obvious, so there you go).</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip06"/>Tip</h3><p>Check out the code and explanation for the <code class="literal">discussions/view.php</code> view file earlier in this chapter for a full explanation of how the flip-flopping functions.</p></div></div><p>Let's now look at the <code class="literal">create()</code> function; we initially set the validation rules and check to see whether the form has been submitted (or has been submitted with errors). Assuming that it has been submitted without errors, we save the post data in the <code class="literal">$data</code> array:</p><div class="informalexample"><pre class="programlisting">$data = array('usr_name' =&gt; $this-&gt;input-&gt;post('usr_name'),
              'usr_email' =&gt; $this-&gt;input-&gt;post('usr_email'),
              'ds_title' =&gt; $this-&gt;input-&gt;post('ds_title'),
              'ds_body' =&gt;  $this-&gt;input-&gt;post('ds_body'));</pre></div><p>Once all the form elements are packaged into the <code class="literal">$data</code> array, we send it off to the<code class="literal"> create()</code> function of <code class="literal">discussions_model</code> to write to the database.</p><p>If the<a id="id254" class="indexterm"/> insert operation was successful, the model<a id="id255" class="indexterm"/> will return the primary key of the new discussion but will return <code class="literal">false</code> if there was an error.</p><p>We test the return value of the insert operation. If the insert was successful, we redirect the user to the <code class="literal">index()</code> function of the <code class="literal">comments</code> controller, passing to it the <code class="literal">$ds_id</code> value that was returned by the model. The user can then see their discussion, which is ready to be commented on:</p><div class="informalexample"><pre class="programlisting">if ($ds_id = $this-&gt;Discussions_model-&gt;create($data)) {
    redirect('comments/index/'.$ds_id);
} else {
   ...</pre></div><p>If there was an error, then we have no new primary key, so we can't redirect the user. This has been left blank in this project; you can implement your own policy for this behavior; perhaps you can send them an e-mail informing them about this or write an error to the screen.</p></div><div class="section" title="The comments controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec37"/>The comments controller</h2></div></div></div><p>The <code class="literal">comments</code> controller <a id="id256" class="indexterm"/>manages all matters related to the <a id="id257" class="indexterm"/>flagging (for moderation) and creation of comments on discussions from users. The <code class="literal">comments</code> controller has two functions, and these are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">index()</code>: This<a id="id258" class="indexterm"/> displays all comments for a specific discussion forum and handles the submission—that is, the validation of a user's comment.</li><li class="listitem" style="list-style-type: disc"><code class="literal">flag()</code>: This <a id="id259" class="indexterm"/>allows a user to flag a comment for moderation by the admin. The <code class="literal">comments.cm_is_active</code> value in the database is set to <code class="literal">0</code> for the specific comment.</li></ul></div><p>Create the <code class="literal">/path/to/codeigniter/application/controllers/comments.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Comments extends MY_Controller {
    function __construct() {
        parent::__construct();
        $this-&gt;load-&gt;helper('string');
        $this-&gt;load-&gt;library('form_validation');
        $this-&gt;load-&gt;model('Discussions_model');
        $this-&gt;load-&gt;model('Comments_model');
        $this-&gt;form_validation-&gt;set_error_delimiters('&lt;div class="alert alert-danger"&gt;', '&lt;/div&gt;');
    }

    public function index() {
        if ($this-&gt;input-&gt;post()) {
            $ds_id = $this-&gt;input-&gt;post('ds_id');
        } else {
            $ds_id = $this-&gt;uri-&gt;segment(3);
        }

        $page_data['discussion_query'] = $this-&gt;Discussions_model-&gt;fetch_discussion($ds_id);
        $page_data['comment_query'] = $this-&gt;Comments_model-&gt;fetch_comments($ds_id);
        $page_data['ds_id'] = $ds_id;

        $this-&gt;form_validation-&gt;set_rules('ds_id', $this-&gt;lang-&gt;line('comments_comment_hidden_id'), 'required|min_length[1]|max_length[11]');
        $this-&gt;form_validation-&gt;set_rules('comment_name', $this-&gt;lang-&gt;line('comments_comment_name'), 'required|min_length[1]|max_length[25]');
        $this-&gt;form_validation-&gt;set_rules('comment_email', $this-&gt;lang-&gt;line('comments_comment_email'), 'required|min_length[1]|max_length[255]');
        $this-&gt;form_validation-&gt;set_rules('comment_body', $this-&gt;lang-&gt;line('comments_comment_body'), 'required|min_length[1]|max_length[5000]');

        if ($this-&gt;form_validation-&gt;run() == FALSE) { 
            $this-&gt;load-&gt;view('common/header');
            $this-&gt;load-&gt;view('nav/top_nav');
            $this-&gt;load-&gt;view('comments/view', $page_data);
            $this-&gt;load-&gt;view('common/footer');
        } else {
            $data = array('cm_body' =&gt; $this-&gt;input-&gt;post('comment_body'),
                          'usr_email' =&gt; $this-&gt;input-&gt;post('comment_email'),
                          'usr_name' =&gt; $this-&gt;input-&gt;post('comment_name'),
                          'ds_id' =&gt;  $this-&gt;input-&gt;post('ds_id')
                          );

            if ($this-&gt;Comments_model-&gt;new_comment($data)) {
                redirect('comments/index/'.$ds_id);
            } else {
                // error
                // load view and flash sess error
            }
        }
    }

    public function flag() {
        $cm_id = $this-&gt;uri-&gt;segment(4);
        if ($this-&gt;Comments_model-&gt;flag($cm_id)) {
            redirect('comments/index/'.$this-&gt;uri-&gt;segment(3));
        } else {
            // error
            // load view and flash sess error
        }
    }
}</pre></div><p>Let's start with the <code class="literal">index()</code> function. The <code class="literal">index()</code> function will begin by displaying all comments for a specific discussion. To do this, it needs to know what discussion to look at. So, let's go a step back. The <code class="literal">discussions</code> controller will display a list of active discussions.</p><p>The<a id="id260" class="indexterm"/> following is a section of code from <code class="literal">discussions/view.php</code> that we looked at in greater detail earlier. This code will loop<a id="id261" class="indexterm"/> through a set of database results, displaying each active discussion in table rows.</p><p>Check out the line highlighted in bold:</p><div class="informalexample"><pre class="programlisting">&lt;!-- Comment - list of comments --&gt;
&lt;?php foreach ($comment_query-&gt;result() as $comment_result) : ?&gt;
  &lt;li class="media"&gt;
    &lt;a class="pull-left" href="#"&gt;
      &lt;img class="media-object" src="&lt;?php echo base_url() ; ?&gt;img/profile.svg" /&gt;
    &lt;/a&gt;
    &lt;div class="media-body"&gt;
      &lt;h4 class="media-heading"&gt;&lt;?php echo $comment_result-&gt;usr_name . <span class="strong"><strong>anchor('comments/flag/'.$comment_result-&gt;ds_id .</strong></span> <span class="strong"><strong>'/' . $comment_result-&gt;cm_id,$this-&gt;lang-</strong></span>
<span class="strong"><strong>&gt;line('comments_flag'))</strong></span> ; ?&gt;&lt;/h4&gt;
      &lt;?php echo $comment_result-&gt;cm_body ; ?&gt;
    &lt;/div&gt;
  &lt;/li&gt;
&lt;?php endforeach ; ?&gt;</pre></div><p>This line displays the URL that enables the user to view the discussion and any comments associated with it by clicking on a discussion title link, which looks like the following:</p><div class="informalexample"><pre class="programlisting">comments/index/id-of-discussion</pre></div><p>We can<a id="id262" class="indexterm"/> pass <code class="literal">id-of-discussion</code> as the third <a id="id263" class="indexterm"/>parameter of the link to the <code class="literal">index()</code> function of the <code class="literal">comments</code> controller. This is where we pick up the story. The <code class="literal">index()</code> function of the <code class="literal">comments</code> controller checks whether there is a third <code class="literal">uri</code> segment (if not, then it is possible that the form to create a comment has been submitted and would not exist in the <code class="literal">uri</code> segment).</p><p>It will grab the ID of the discussion and store it as the <code class="literal">$ds_id</code> variable:</p><div class="informalexample"><pre class="programlisting">if ($this-&gt;input-&gt;post()) {
    $ds_id = $this-&gt;input-&gt;post('ds_id');
} else {
    $ds_id = $this-&gt;uri-&gt;segment(3);
}</pre></div><p>We then define some validation rules for CodeIgniter to apply to the Add A Comment form at the bottom of the <code class="literal">comments/view.php</code> file.</p><p>The <code class="literal">comments/view.php</code> file contains not only a <code class="literal">foreach()</code> loop to display the current comments on the selected discussion, but also a form with a name and e-mail text field and a body text area. This is where the user can enter their name, e-mail, and comment text and then submit the comment.</p><p>There is also a hidden field, named <code class="literal">ds_id</code>, that contains the primary key of the selected discussion. We need it in the form as a hidden element as, when the form is submitted, the third <code class="literal">uri</code> segment will disappear. Having the discussion ID as a hidden form element will allow <code class="literal">index()</code> to maintain a relationship between the comment and the discussion when the new comment form is submitted.</p><p>Assuming that there were no errors with the form and it is submitted without the need to report anything requiring the user's attention, the <code class="literal">index()</code> function attempts to write the comment to the <code class="literal">comments</code> table in the database.</p><p>Before we do that, however, we need to package all our data into an array that will be passed to <code class="literal">Comments_model</code>. Take a look at the following code:</p><div class="informalexample"><pre class="programlisting">$data = array('cm_body' =&gt; $this-&gt;input-&gt;post('comment_body'),
              'usr_email' =&gt; $this-&gt;input-&gt;post('comment_email'),
              'usr_name' =&gt; $this-&gt;input-&gt;post('comment_name'),
              <span class="strong"><strong>'ds_id' =&gt;  $this-&gt;input-&gt;post('ds_id')</strong></span>
    );</pre></div><p>Here, you can see that we've got all the post elements including <code class="literal">ds_id</code> (highlighted in bold). This is now ready to be sent to the <code class="literal">new_comment()</code>model function for insertion into the database:</p><div class="informalexample"><pre class="programlisting">if ($this-&gt;Comments_model-&gt;new_comment($data)) {
     redirect('comments/index/'.$ds_id);
} else {
     // error
     // load view and flash sess error
}</pre></div><p>The <code class="literal">new_comment()</code>model function will return <code class="literal">true</code> on a successful insertion and <code class="literal">false</code> otherwise. If it was successful, then we redirect the user to the <code class="literal">comments</code> controller's <code class="literal">index()</code> function and pass <code class="literal">$ds_id</code> as the third parameter where the <code class="literal">index()</code> function <a id="id264" class="indexterm"/>will begin, displaying all active <a id="id265" class="indexterm"/>comments associated with the selected discussion.</p><p>Now, let's move on to the <code class="literal">flag()</code> function. The <code class="literal">flag()</code> function will enable the user to indicate that a comment requires moderation by an admin.</p><p>Stepping back to the <code class="literal">discussions</code> controller, the <code class="literal">discussions</code> controller will display a list of active discussions.</p><p>The following is a section of code from <code class="literal">comments/view.php</code> that we looked at in greater detail earlier. This code will loop through a set of database results, displaying each active comment in a table of rows:</p><div class="informalexample"><pre class="programlisting">&lt;!-- Comment - list of comments --&gt;
&lt;?php foreach ($comment_query-&gt;result() as $comment_result) : ?&gt;
  &lt;li class="media"&gt;
    &lt;a class="pull-left" href="#"&gt;
      &lt;img class="media-object" src="&lt;?php echo base_url() ; ?&gt;img/profile.svg" /&gt;
    &lt;/a&gt;
    &lt;div class="media-body"&gt;
      &lt;h4 class="media-heading"&gt;&lt;?php echo $comment_result-&gt;usr_name . <span class="strong"><strong>anchor('comments/flag/'.$comment_result-&gt;ds_id</strong></span> <span class="strong"><strong>. '/' . $comment_result-&gt;cm_id,$this-&gt;lang-</strong></span>
<span class="strong"><strong>&gt;line('comments_flag'))</strong></span> ; ?&gt;&lt;/h4&gt;
      &lt;?php echo $comment_result-&gt;cm_body ; ?&gt;
    &lt;/div&gt;
  &lt;/li&gt;
&lt;?php endforeach ; ?&gt;</pre></div><p>Take a look at the line highlighted in bold:</p><div class="informalexample"><pre class="programlisting">anchor('comments/flag/'.$comment_result-&gt;ds_id . '/' . $comment_result-&gt;cm_id,$this-&gt;lang-&gt;line('comments_flag'))</pre></div><p>This line contains a CodeIgniter <code class="literal">anchor()</code> statement with the <code class="literal">comments/flag/id-of-comment</code> URL. It is this line of code that creates the <span class="strong"><strong>flag</strong></span> link next to each comment.</p><p>Look at the <a id="id266" class="indexterm"/>third and fourth parameters. The third parameter is the discussion ID (<code class="literal">discussions.ds_id</code>) and the fourth is the <a id="id267" class="indexterm"/>comment ID (<code class="literal">comments.cm_id</code>); both are used in the <code class="literal">flag()</code> function of <code class="literal">comments_model</code>. The code for this looks as follows:</p><div class="informalexample"><pre class="programlisting">public function flag() {
    $cm_id = $this-&gt;uri-&gt;segment(4);
    if ($this-&gt;Comments_model-&gt;flag($cm_id)) {
        redirect('comments/index/'.$this-&gt;uri-&gt;segment(3));
    } else {
        // error
        // load view and flash sess error
    }
}</pre></div><p>If the insert operation returns <code class="literal">true</code>, then we redirect the user to the <code class="literal">comments</code> controller's <code class="literal">index()</code> function along with the discussion forum ID.</p></div><div class="section" title="The admin controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec38"/>The admin controller</h2></div></div></div><p>The <code class="literal">admin</code> controller <a id="id268" class="indexterm"/>contains all the functions required to run the<a id="id269" class="indexterm"/> moderation of comments and discussions and to log users in. It contains the following functions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">index()</code>: Every <a id="id270" class="indexterm"/>controller needs an index function and this is it. The <code class="literal">index()</code> function will check whether a user is logged in and redirect them elsewhere if not.</li><li class="listitem" style="list-style-type: disc"><code class="literal">login()</code>: The <code class="literal">login()</code> function handles the process of logging a user into the <a id="id271" class="indexterm"/>system.</li><li class="listitem" style="list-style-type: disc"><code class="literal">dashboard()</code>: This is responsible for displaying all comments and discussions<a id="id272" class="indexterm"/> that require moderation.</li><li class="listitem" style="list-style-type: disc"><code class="literal">update_item()</code>: This is responsible for applying the decision of the moderator, whether <a id="id273" class="indexterm"/>to approve or delete a comment or discussion.</li></ul></div><p>Create the <code class="literal">/path/to/codeigniter/application/controllers/admin.php</code> file and add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Admin extends MY_Controller {
    function __construct() {
        parent::__construct();
        $this-&gt;load-&gt;helper('string');
        $this-&gt;load-&gt;library('form_validation');
        $this-&gt;load-&gt;model('Admin_model');
        $this-&gt;form_validation-&gt;set_error_delimiters('&lt;div class="alert alert-danger"&gt;', '&lt;/div&gt;'); 
    }

    public function index() {
        if ($this-&gt;session-&gt;userdata('logged_in') == FALSE) {
            redirect('admin/login');
        } 

        redirect('admin/dashboard');
    }

    public function login() {
        $this-&gt;form_validation-&gt;set_rules('usr_email', $this-&gt;lang-&gt;line('admin_login_email'), 'required|min_length[1]|max_length[255]');
        $this-&gt;form_validation-&gt;set_rules('usr_password', $this-&gt;lang-&gt;line('admin_login_password'), 'required|min_length[1]|max_length[25]');

        if ($this-&gt;form_validation-&gt;run() == FALSE) {
            $this-&gt;load-&gt;view('common/login_header');
            $this-&gt;load-&gt;view('nav/top_nav');
            $this-&gt;load-&gt;view('admin/login');
            $this-&gt;load-&gt;view('common/footer');
        } else {
            $usr_email = $this-&gt;input-&gt;post('usr_email');
            $usr_password = $this-&gt;input-&gt;post('usr_password');

            $query = $this-&gt;Admin_model-&gt;does_user_exist($usr_email);

            if ($query-&gt;num_rows() == 1) { // One matching row found
                foreach ($query-&gt;result() as $row) {
                    // Call Encrypt library
                    $this-&gt;load-&gt;library('encrypt');

                    // Generate hash from a their password
                    $hash = $this-&gt;encrypt-&gt;sha1($usr_password);

                    // Compare the generated hash with that in the database
                    if ($hash != $row-&gt;usr_hash) {
                        // Didn't match so send back to login
                        $page_data['login_fail'] = true;
                        $this-&gt;load-&gt;view('common/login_header');
                        $this-&gt;load-&gt;view('nav/top_nav');
                        $this-&gt;load-&gt;view('admin/login',$page_data);
                        $this-&gt;load-&gt;view('common/footer'); 
                    } else {
                        $data = array(
                            'usr_id' =&gt; $row-&gt;usr_id,
                            'usr_email' =&gt; $row-&gt;usr_email,
                            'logged_in' =&gt; TRUE
                        );

                        // Save data to session
                        $this-&gt;session-&gt;set_userdata($data);
                        redirect('admin/dashboard');
                    }
                }
            }
        }
    }

    public function dashboard() {
        if ($this-&gt;session-&gt;userdata('logged_in') == FALSE) {
            redirect('admin/login');
        } 

        $page_data['comment_query'] = $this-&gt;Admin_model-&gt;dashboard_fetch_comments();
        $page_data['discussion_query'] = $this-&gt;Admin_model-&gt;dashboard_fetch_discussions();

        $this-&gt;load-&gt;view('common/header');
        $this-&gt;load-&gt;view('nav/top_nav');
        $this-&gt;load-&gt;view('admin/dashboard',$page_data);
        $this-&gt;load-&gt;view('common/footer');
    }

    public function update_item() {
        if ($this-&gt;session-&gt;userdata('logged_in') == FALSE) {
            redirect('admin/login');
        } 

        if ($this-&gt;uri-&gt;segment(4) == 'allow') {
            $is_active = 1;
        } else {
            $is_active = 0;
        }

        if ($this-&gt;uri-&gt;segment(3) == 'ds') {
            $result = $this-&gt;Admin_model-&gt;update_discussions($is_active, $this-&gt;uri-&gt;segment(5));
        } else {
            $result = $this-&gt;Admin_model-&gt;update_comments($is_active, $this-&gt;uri-&gt;segment(5));
        }

        redirect('admin');
    }
}</pre></div><p>Let's tackle<a id="id274" class="indexterm"/> this by first looking at the <code class="literal">index()</code> function. As<a id="id275" class="indexterm"/> the <code class="literal">admin</code> controller is only to be used by those logged in, the <code class="literal">index()</code> function will check to see whether an item called <code class="literal">logged_in</code> exists in the session. If <code class="literal">logged_in</code> is equal to <code class="literal">FALSE</code>, then it means that the user is not logged in, so they are redirected to the <code class="literal">login()</code> function.</p><p>This is very simple and we won't spend more time on it; however, a more complicated function is <code class="literal">login()</code>. The <code class="literal">login()</code> function is responsible for—as the name suggests—managing the login process for the admin moderator.</p><p>The first thing <code class="literal">login()</code> does is define form validation rules for the <code class="literal">usr_email</code> and <code class="literal">usr_pwd</code> form elements. These will govern how the data submitted by the user in the <code class="literal">admin/login.php</code> view file is validated.</p><p>We immediately test to see whether the form has been submitted:</p><div class="informalexample"><pre class="programlisting">if ($this-&gt;form_validation-&gt;run() == FALSE) {
  ...</pre></div><p>If the form hasn't been submitted, we'll load the view files to display the login form and wait for a response from the user.</p><p>However, if it has been submitted, then the form is validated against the validation criteria; if it passes validation, we try to work out whether the user exists in the database currently:</p><div class="informalexample"><pre class="programlisting">$query = $this-&gt;Admin_model-&gt;does_user_exist($usr_email);
  if ($query-&gt;num_rows() == 1) {
    ...</pre></div><p>If exactly one matching e-mail address has been found, then we will try to work out whether the users' password is correct. We load the CodeIgniter library using <code class="literal">$this-&gt;load-&gt;library('encrypt')</code> and generate a hash from the password that the user supplied in the login form:</p><div class="informalexample"><pre class="programlisting">$hash = $this-&gt;encrypt-&gt;sha1($usr_password);</pre></div><p>We then<a id="id276" class="indexterm"/> compare that hash with the hash stored in<a id="id277" class="indexterm"/> the database belonging to the user:</p><div class="informalexample"><pre class="programlisting">if ($hash != $row-&gt;usr_hash) {
   ...</pre></div><p>If it does not match, then we load the login form and display an error message. However, if it does match, then the user must have typed the correct password; so we log them in by creating a CodeIgniter session for them:</p><div class="informalexample"><pre class="programlisting">$data = array(
     'usr_id' =&gt; $row-&gt;usr_id,
     'usr_email' =&gt; $row-&gt;usr_email,
     'logged_in' =&gt; TRUE
);

// Save data to session
$this-&gt;session-&gt;set_userdata($data);
redirect('admin/dashboard');</pre></div><p>The user is then redirected to the dashboard. The dashboard will display any comments and discussions that are required for moderation.</p></div></div>
<div class="section" title="Creating the language file"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec35"/>Creating the language file</h1></div></div></div><p>As with all the projects in<a id="id278" class="indexterm"/> this book, we're making use of the language<a id="id279" class="indexterm"/> file to serve text to users. This way, you can enable multiple region/multiple language support.</p><p>Create<a id="id280" class="indexterm"/> the <code class="literal">/path/to/codeigniter/application/language/english/en_admin_lang.php</code> file and <a id="id281" class="indexterm"/>add the following code to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

// General
$lang['system_system_name'] = "Forum";

// Top Nav
$lang['top_nav_view_discussions'] = "Home";
$lang['top_nav_new_discussion'] = "New Discussion";
$lang['top_nav_login'] = "Login";

// Discussions
$lang['discussions_title'] = "Discussions";
$lang['discussions_num_comments'] = 'Comments';

// Comments
$lang['comments_form_instruction'] = "Join in, add your comment below.";
$lang['comments_flag'] = ' [Flag]';
$lang['comments_created_by'] = 'Created by ';
$lang['comments_created_at'] = ' at ';
$lang['comments_comment_name'] = 'Your name';
$lang['comments_comment_email'] = 'Your email';
$lang['comments_comment_body'] = 'Comment';

// Discussions
$lang['discussion_form_instruction'] = "Create your own discussion, fill in the form below";
$lang['discussion_flag'] = ' [Flag]';
$lang['discussion_usr_name'] = 'Your name';
$lang['discussion_usr_email'] = 'Your email';
$lang['discussion_ds_title'] = 'Discussion title';
$lang['discussion_ds_body'] = 'Your question, point etc';

// Admin - login
$lang['admin_login_header'] = "Please sign in";
$lang['admin_login_email'] = "Email";
$lang['admin_login_password'] = "Password";
$lang['admin_login_signin'] = "Signin...";
$lang['admin_login_error'] = "Whoops!  Something went wrong - have another go!";
$lang['admin_dash_allow'] = "Allow";
$lang['admin_dash_disallow'] = "Disallow";</pre></div></div>
<div class="section" title="Putting it all together"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec36"/>Putting it all together</h1></div></div></div><p>Now that <a id="id282" class="indexterm"/>we've created each file and resource necessary for the app, let's run through a few scenarios so that we can get a good idea of how it all works together.</p><div class="section" title="A user creates a discussion forum"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec39"/>A user creates a discussion forum</h2></div></div></div><p>Let's consider <a id="id283" class="indexterm"/>an example where David visits the discussion forum in his browser. The following is the sequence of steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">David clicks on the <span class="strong"><strong>New Discussion</strong></span> link in the top navigation bar.</li><li class="listitem">CodeIgniter loads the <code class="literal">create()</code> function in the <code class="literal">discussions</code> controller.</li><li class="listitem">The <code class="literal">create()</code> function displays the <code class="literal">discussions/new.php</code> view file, which displays a form to users, enabling them to enter their name, e-mail, discussion title, and discussion body text.</li><li class="listitem">David presses the <span class="strong"><strong>Go</strong></span> button to submit the form. The form is submitted to the <code class="literal">discussion</code> controller's <code class="literal">create()</code> function.</li><li class="listitem">The <code class="literal">discussion</code> controller's <code class="literal">create()</code> function validates the form. Assuming there were no errors, the <code class="literal">create()</code> function packages the post data into an array and sends it to the <code class="literal">create()</code> function of <code class="literal">discussions_model</code>.</li><li class="listitem">The <code class="literal">create()</code> model function looks in the <code class="literal">users</code> database table to see whether the e-mail address already exists. If it does, the primary key of the user is returned and added to the Active Record insertion for the discussion. However, if the e-mail address doesn't exist, then the model function creates it. Instead, the primary key of this insertion is returned.</li><li class="listitem">A password is created and a hash is generated from it. However, the password is not stored and David is not told what it is; this is perhaps a functionality you might not wish for, but you can easily add code to send David his password in an e-mail, should you wish.</li></ol></div></div><div class="section" title="A user comments on a discussion forum"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec40"/>A user comments on a discussion forum</h2></div></div></div><p>Let's consider <a id="id284" class="indexterm"/>an example where Ed visits the discussion forum in his browser. The following is the sequence of events:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">CodeIgniter loads the default controller—in this case, the <code class="literal">discussion</code> controller.</li><li class="listitem">The <code class="literal">discussion</code> controller uses the <code class="literal">fetch_discussions()</code> function of <code class="literal">discussions_model</code> to get the latest discussions from the <code class="literal">discussions</code> database table and passes them to the <code class="literal">discussions/view.php</code> view file where they are displayed.</li><li class="listitem">Ed likes the sound of one of the discussion forums and clicks on the name of the forum.</li><li class="listitem">CodeIgniter loads the <code class="literal">comments</code> controller's <code class="literal">index()</code> function. The <code class="literal">index()</code> function takes the third <code class="literal">uri</code> segment (the discussion forum ID—<code class="literal">discussions.ds_id</code>) and passes it to the <code class="literal">fetch_comments()</code> function of <code class="literal">comments_model</code>.</li><li class="listitem">The<a id="id285" class="indexterm"/> comments are displayed in the <code class="literal">comments/view.php</code> view file.</li><li class="listitem">Ed reads the comment history and decides that the world would benefit from his opinion.</li><li class="listitem">Ed scrolls to the bottom of the page where the form to add a comment is present. Ed enters his name, e-mail, and comment and clicks on <span class="strong"><strong>Go</strong></span>.</li><li class="listitem">The form is submitted to the <code class="literal">create()</code> function of <code class="literal">comments</code>. The <code class="literal">create()</code> function will validate the form. Assuming there were no errors, the <code class="literal">create()</code> function packages the post data into an array and sends it to the <code class="literal">create()</code> function of <code class="literal">comments_model</code>.</li><li class="listitem">The <code class="literal">create()</code> model function looks in the <code class="literal">users</code> database table to see whether the e-mail address already exists. If it does, the primary key of the user is returned and added to the Active Record insertion for the comment. However, if the e-mail address doesn't exist, then the model function creates it. Instead, the primary key of this insertion is returned.</li><li class="listitem">A password is created and a hash is generated from it. However, the password is not stored and Ed is not told what it is; this is perhaps a functionality you might not wish for, but you can easily add code to send Ed his password in an e-mail, should you wish.</li><li class="listitem">Ed is redirected to the discussion forum where he can see his comment.</li></ol></div></div><div class="section" title="A user dislikes a comment and flags it for moderation"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec41"/>A user dislikes a comment and flags it for moderation</h2></div></div></div><p>Let's<a id="id286" class="indexterm"/> consider an example where Nigel is<a id="id287" class="indexterm"/> looking through a discussion and sees a comment that he feels is necessary for moderation. The sequence of steps is as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Outraged, he presses the <span class="strong"><strong>flag</strong></span> link next to the comment.</li><li class="listitem">CodeIgniter loads the <code class="literal">flag()</code> function of <code class="literal">comments</code>. The URL that is used to access this is <code class="literal">comments/flag/id-of-discussion/id-of-comment</code>.</li><li class="listitem">CodeIgniter passes <code class="literal">id-of-comment</code> to the <code class="literal">flag()</code> function of <code class="literal">comments_model</code>, which will set <code class="literal">comments.cm_is_active</code> to <code class="literal">0</code>. This removes the comment from the discussion and places it in the moderation dashboard.</li><li class="listitem">If the<a id="id288" class="indexterm"/> update of the comment <a id="id289" class="indexterm"/>was successful, CodeIgniter will redirect Nigel to the discussion he was looking at.</li></ol></div></div><div class="section" title="A moderator reviews comments awaiting moderation"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec42"/>A moderator reviews comments awaiting moderation</h2></div></div></div><p>Let's<a id="id290" class="indexterm"/> consider an example where Nick logs in to his admin account. The sequence of steps is as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">admin</code> controller loads the <code class="literal">dashboard()</code> function.</li><li class="listitem">The <code class="literal">dashboard()</code> function loads a list of comments and discussions waiting for moderation.</li><li class="listitem">Nick sees the full text of comments and discussions along with two options: <span class="strong"><strong>Allow</strong></span> and <span class="strong"><strong>Disallow</strong></span>.</li><li class="listitem">Nick sees that there are two comments that require moderation.</li><li class="listitem">Nick reads the first comment and decides that it is fine; he clicks on the <span class="strong"><strong>Allow</strong></span> link. The structure of the link is <code class="literal">admin/update_item/cm/allow/id-or-comment</code>.</li><li class="listitem">CodeIgniter loads the <code class="literal">update_item()</code> function of <code class="literal">admin</code>.</li><li class="listitem">The <code class="literal">update_item()</code> function gets the type of thing that needs to be updated (comment: <code class="literal">cm</code> and discussion: <code class="literal">ds</code>); in this case, Nick is updating a comment to the first segment in <code class="literal">uri</code>, which is <code class="literal">cm</code>. The second <code class="literal">uri</code> segment is <code class="literal">allow</code> and the third <code class="literal">uri</code> segment is the ID of the comment (<code class="literal">comments.cm_id</code>).</li><li class="listitem">The <code class="literal">update_comments()</code> function of <code class="literal">admin_model</code> is called, setting <code class="literal">comments.cm_is_active</code> to <code class="literal">1</code>. This allows the comment to be displayed once more.</li><li class="listitem">Nick also notices the one remaining comment waiting for moderation. He reads the comment and decides that it's probably not the best comment and he wishes to remove it.</li><li class="listitem">He clicks on the <span class="strong"><strong>Disallow</strong></span> link. The structure of the link is <code class="literal">admin/update_item/cm/disallow/id-or-comment</code>.</li><li class="listitem">CodeIgniter loads the <code class="literal">update_item()</code> function of <code class="literal">admin</code>.</li><li class="listitem">The <code class="literal">update_item()</code> function gets the type of thing that needs to be updated (comment: <code class="literal">cm</code> and discussion: <code class="literal">ds</code>); in this case, Nick is updating a comment to the first segment in <code class="literal">uri</code>, which is <code class="literal">cm</code>. The second <code class="literal">uri</code> segment is <code class="literal">disallow</code> and the third <code class="literal">uri</code> segment is the ID of the comment (<code class="literal">comments.cm_id</code>).</li><li class="listitem">The <code class="literal">update_comments()</code> function of <code class="literal">admin_model</code> is called. As <code class="literal">$is_active</code> is set to <code class="literal">0</code>, we will not allow the comment to be displayed but will <a id="id291" class="indexterm"/>delete it. A PHP if/else statement works out the value of <code class="literal">$is_active</code>, the else section is executed, and a MySQL <code class="literal">DELETE</code> command is called, deleting the comment from the database permanently.</li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec37"/>Summary</h1></div></div></div><p>We have done a lot in this chapter; we've created many files and there's a lot to take in. However, this project gives you the base system for a discussion forum. You might wish to add user management (particularly when it comes to sending the user their password), assuming you want people to log in? What would they do once they are logged in? These are for you to define, but you now have the base system; this allows you to build more.</p></div></body></html>