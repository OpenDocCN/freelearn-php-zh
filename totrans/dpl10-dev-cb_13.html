<html><head></head><body>
<div id="_idContainer118">
<h1 class="chapter-number" id="_idParaDest-382"><a id="_idTextAnchor412"/><span class="koboSpan" id="kobo.1.1">13</span></h1>
<h1 id="_idParaDest-383"><a id="_idTextAnchor413"/><span class="koboSpan" id="kobo.2.1">Writing Automated Tests in Drupal</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In previous chapters, we reviewed how to add custom functionality to Drupal with controllers, routes, responses, custom modules, custom entity types, hooks, and more. </span><span class="koboSpan" id="kobo.3.2">With even just a little bit of code, you can add a lot of functionality to your </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">Drupal application.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">But how do you know that </span><em class="italic"><span class="koboSpan" id="kobo.6.1">it works</span></em><span class="koboSpan" id="kobo.7.1">? </span><span class="koboSpan" id="kobo.7.2">Sure, you can click around and try things out – but it is not a 100% guarantee that things are working under the hood as intended. </span><span class="koboSpan" id="kobo.7.3">The more code and features you add, the harder it will be to verify that existing functionality is still intact without </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">providing tests.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">By implementing automated tests, you can ensure that the code and features you have added actually work the way you expect. </span><span class="koboSpan" id="kobo.9.2">Most importantly, automated tests help significantly reduce bugs and regressions making it to your production website, which in turn will help build your confidence as </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">a developer.</span></span></p>
<p><span class="koboSpan" id="kobo.11.1">Drupal provides several classes of tools to help provide tests for your application. </span><span class="koboSpan" id="kobo.11.2">This chapter covers </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.13.1">Installing the PHPUnit </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">test suite</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.15.1">Running PHPUnit</span></span></li>
<li><span class="koboSpan" id="kobo.16.1">Writing a </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">unit test</span></span></li>
<li><span class="koboSpan" id="kobo.18.1">Writing a </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">kernel test</span></span></li>
<li><span class="koboSpan" id="kobo.20.1">Writing a </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">functional test</span></span></li>
<li><span class="koboSpan" id="kobo.22.1">Writing a functional </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">JavaScript test</span></span></li>
<li><span class="koboSpan" id="kobo.24.1">Writing a </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">NightwatchJS test</span></span></li>
</ul>
<h1 id="_idParaDest-384"><a id="_idTextAnchor414"/><span class="koboSpan" id="kobo.26.1">Types of tests</span></h1>
<p><span class="koboSpan" id="kobo.27.1">There are five types of </span><a id="_idIndexMarker826"/><span class="koboSpan" id="kobo.28.1">tests you can run and write in Drupal – </span><strong class="bold"><span class="koboSpan" id="kobo.29.1">unit tests</span></strong><span class="koboSpan" id="kobo.30.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.31.1">kernel tests</span></strong><span class="koboSpan" id="kobo.32.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.33.1">functional tests</span></strong><span class="koboSpan" id="kobo.34.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.35.1">functional JavaScript tests</span></strong><span class="koboSpan" id="kobo.36.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.37.1">NightwatchJS tests</span></strong><span class="koboSpan" id="kobo.38.1">. </span><span class="koboSpan" id="kobo.38.2">Which ones you write will depend on the kind of feature(s) you are creating and the level of test coverage you are willing to accept to prove your code is working. </span><span class="koboSpan" id="kobo.38.3">Let’s take a look at each of these types of tests. </span><span class="koboSpan" id="kobo.38.4">You can find the full code used in this chapter on </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">GitHub: </span></span><a href="https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp13"><span class="No-Break"><span class="koboSpan" id="kobo.40.1">https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp13</span></span></a></p>
<h2 id="_idParaDest-385"><a id="_idTextAnchor415"/><span class="koboSpan" id="kobo.41.1">Unit tests</span></h2>
<p><span class="koboSpan" id="kobo.42.1">Unit tests </span><a id="_idIndexMarker827"/><span class="koboSpan" id="kobo.43.1">are tests that do not need a Drupal installation to evaluate </span><a id="_idIndexMarker828"/><span class="koboSpan" id="kobo.44.1">because they test code that executes code only. </span><span class="koboSpan" id="kobo.44.2">They are the lowest-level test you can write. </span><span class="koboSpan" id="kobo.44.3">Unit tests are useful for testing plugins, services, or other code that do not require interaction with the database. </span><span class="koboSpan" id="kobo.44.4">If you need to write tests that require a database or Drupal environment in some way, you would write a </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">kernel test.</span></span></p>
<h2 id="_idParaDest-386"><a id="_idTextAnchor416"/><span class="koboSpan" id="kobo.46.1">Kernel tests</span></h2>
<p><span class="koboSpan" id="kobo.47.1">Kernel tests are</span><a id="_idIndexMarker829"/><span class="koboSpan" id="kobo.48.1"> the </span><a id="_idIndexMarker830"/><span class="koboSpan" id="kobo.49.1">next step up from unit tests. </span><span class="koboSpan" id="kobo.49.2">A kernel test is a test that can execute and test functionality that requires some level of database interaction. </span><span class="koboSpan" id="kobo.49.3">If you want to test the functionality of features that act when saving entities, test field formatters, check user role access to routes, or test controllers and their responses, a kernel test is what you would write. </span><span class="koboSpan" id="kobo.49.4">When executing kernel tests, an instance of Drupal is installed where the tests are performed. </span><span class="koboSpan" id="kobo.49.5">This level of isolation is what permits you to test interactive functionality without interfering with your current working database. </span><span class="koboSpan" id="kobo.49.6">You are able to specify modules to install and configurations to include in a kernel test, making it an excellent way of testing your modules. </span><span class="koboSpan" id="kobo.49.7">These are the most common tests you will see </span><span class="No-Break"><span class="koboSpan" id="kobo.50.1">in Drupal.</span></span></p>
<h2 id="_idParaDest-387"><a id="_idTextAnchor417"/><span class="koboSpan" id="kobo.51.1">Functional tests</span></h2>
<p><span class="koboSpan" id="kobo.52.1">Functional </span><a id="_idIndexMarker831"/><span class="koboSpan" id="kobo.53.1">tests </span><a id="_idIndexMarker832"/><span class="koboSpan" id="kobo.54.1">are the highest-level test you can write. </span><span class="koboSpan" id="kobo.54.2">Like kernel tests, a functional test will install a working copy of Drupal to run the tests in. </span><span class="koboSpan" id="kobo.54.3">These tests are evaluated with a headless browser and are useful for testing functionality from the user perspective. </span><span class="koboSpan" id="kobo.54.4">These types of tests are good for testing user workflows, user permissions, and evaluating page content for what you expect to see. </span><span class="koboSpan" id="kobo.54.5">For example, if you have a feature where a user navigates to a site, logs in, navigates to the Drupal admin, and sees sections that other roles should not, you can evaluate</span><a id="_idIndexMarker833"/><span class="koboSpan" id="kobo.55.1"> this with a</span><a id="_idIndexMarker834"/> <span class="No-Break"><span class="koboSpan" id="kobo.56.1">functional test.</span></span></p>
<h2 id="_idParaDest-388"><a id="_idTextAnchor418"/><span class="koboSpan" id="kobo.57.1">Functional JavaScript tests</span></h2>
<p><span class="koboSpan" id="kobo.58.1">Functional JavaScript tests </span><a id="_idIndexMarker835"/><span class="koboSpan" id="kobo.59.1">are executed using a real</span><a id="_idIndexMarker836"/><span class="koboSpan" id="kobo.60.1"> browser, such as Chrome or Firefox. </span><span class="koboSpan" id="kobo.60.2">Regular functional tests run in a headless PHP browser emulator called Mink under the hood. </span><span class="koboSpan" id="kobo.60.3">Since it is not a full-fledged browser, it cannot test any JavaScript-related features that real browsers such as Chrome have. </span><span class="koboSpan" id="kobo.60.4">If you want to test features related to AJAX, cookies, or DOM-related JavaScript events in the browser, you would write a functional JavaScript test. </span><span class="koboSpan" id="kobo.60.5">Functional JavaScript tests will require the presence of a browser such as Chrome and tools such as Selenium to orchestrate Chrome </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">under test.</span></span></p>
<h2 id="_idParaDest-389"><a id="_idTextAnchor419"/><span class="koboSpan" id="kobo.62.1">NightwatchJS tests</span></h2>
<p><span class="koboSpan" id="kobo.63.1">Similar to a</span><a id="_idIndexMarker837"/><span class="koboSpan" id="kobo.64.1"> functional</span><a id="_idIndexMarker838"/><span class="koboSpan" id="kobo.65.1"> JavaScript test, </span><strong class="bold"><span class="koboSpan" id="kobo.66.1">NightwatchJS</span></strong><span class="koboSpan" id="kobo.67.1"> uses Google Chrome and ChromeDriver (</span><a href="https://chromedriver.chromium.org/"><span class="koboSpan" id="kobo.68.1">https://chromedriver.chromium.org/</span></a><span class="koboSpan" id="kobo.69.1">) to evaluate tests. </span><span class="koboSpan" id="kobo.69.2">However, instead of PHP files, the test files are written entirely in JavaScript and </span><a id="_idIndexMarker839"/><span class="koboSpan" id="kobo.70.1">require </span><strong class="bold"><span class="koboSpan" id="kobo.71.1">NodeJS</span></strong><span class="koboSpan" id="kobo.72.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.73.1">yarn</span></strong><span class="koboSpan" id="kobo.74.1"> to run and interact with. </span><span class="koboSpan" id="kobo.74.2">If you are a developer who tends to write far more JavaScript than you do PHP, you may be interested in using NightwatchJS instead of </span><strong class="bold"><span class="koboSpan" id="kobo.75.1">PHPUnit</span></strong><span class="koboSpan" id="kobo.76.1">. </span><span class="koboSpan" id="kobo.76.2">Another </span><a id="_idIndexMarker840"/><span class="koboSpan" id="kobo.77.1">added benefit is that you can write unit tests for the custom JavaScript you write, which is something you cannot test </span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">with PHPUnit.</span></span></p>
<p><span class="koboSpan" id="kobo.79.1">Functional JavaScript and NightwatchJS tests require the most effort to set up and implement, but they can be very valuable because they are running under the same setup, conditions, user role(s), and browser that your visitors are using. </span><span class="koboSpan" id="kobo.79.2">They also take the longest to execute but still run in a fraction of the time any human could perform the </span><span class="No-Break"><span class="koboSpan" id="kobo.80.1">same tasks.</span></span></p>
<h1 id="_idParaDest-390"><a id="_idTextAnchor420"/><span class="koboSpan" id="kobo.81.1">Installing the PHPUnit test suite</span></h1>
<p><span class="koboSpan" id="kobo.82.1">All of the </span><a id="_idIndexMarker841"/><span class="koboSpan" id="kobo.83.1">preceding types of tests (with the exception of NightwatchJS tests) are executed from one test harness, PHPUnit. </span><span class="koboSpan" id="kobo.83.2">We can add any number of tests to our custom modules or custom themes and run them using PHPUnit – all we have to do is install it and configure it to point at our </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">test files.</span></span></p>
<h2 id="_idParaDest-391"><a id="_idTextAnchor421"/><span class="koboSpan" id="kobo.85.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.86.1">The first thing to do before proceeding is to install all the test dependencies so that you can actually run tests in Drupal. </span><span class="koboSpan" id="kobo.86.2">Drupal has a specific Composer package that brings in PHPUnit and the required dependencies </span><span class="No-Break"><span class="koboSpan" id="kobo.87.1">for it.</span></span></p>
<p><span class="koboSpan" id="kobo.88.1">To install, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.89.1">these steps:</span></span></p>
<p><span class="koboSpan" id="kobo.90.1">Open up a Terminal (command line) at the root of </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">your project.</span></span></p>
<p><span class="koboSpan" id="kobo.92.1">Run the following </span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">Composer command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.94.1">composer require --dev drupal/core-dev:^10</span></strong></pre>
<p><span class="koboSpan" id="kobo.95.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.96.1">drupal/core-dev</span></strong><span class="koboSpan" id="kobo.97.1"> package will bring in PHPUnit and various dependencies to your project that are</span><a id="_idIndexMarker842"/><span class="koboSpan" id="kobo.98.1"> needed for writing and running tests </span><span class="No-Break"><span class="koboSpan" id="kobo.99.1">in Drupal.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.100.1">The --dev flag</span></p>
<p class="callout"><span class="koboSpan" id="kobo.101.1">Note that when installing, we are using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.102.1">--dev</span></strong><span class="koboSpan" id="kobo.103.1"> flag. </span><span class="koboSpan" id="kobo.103.2">This tells Composer to list these packages under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.104.1">require-dev</span></strong><span class="koboSpan" id="kobo.105.1"> section in </span><strong class="source-inline"><span class="koboSpan" id="kobo.106.1">composer.json</span></strong><span class="koboSpan" id="kobo.107.1">. </span><span class="koboSpan" id="kobo.107.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.108.1">drupal/core-dev</span></strong><span class="koboSpan" id="kobo.109.1"> package is not something you want to have in your production environment; it is for </span><span class="No-Break"><span class="koboSpan" id="kobo.110.1">testing only.</span></span></p>
<h2 id="_idParaDest-392"><a id="_idTextAnchor422"/><span class="koboSpan" id="kobo.111.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.112.1">Next, we need to configure PHPUnit so that it knows where our tests reside. </span><span class="koboSpan" id="kobo.112.2">Drupal core ships with an example </span><strong class="source-inline"><span class="koboSpan" id="kobo.113.1">phpunit.xml.dist</span></strong><span class="koboSpan" id="kobo.114.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.115.1">core</span></strong><span class="koboSpan" id="kobo.116.1"> directory. </span><span class="koboSpan" id="kobo.116.2">This is the file that PHPUnit reads when it executes. </span><span class="koboSpan" id="kobo.116.3">You don’t have to understand it line for line, but there are a few areas we need to adjust so that it will execute within your custom </span><span class="No-Break"><span class="koboSpan" id="kobo.117.1">module directory.</span></span></p>
<p><span class="koboSpan" id="kobo.118.1">Copy the </span><strong class="source-inline"><span class="koboSpan" id="kobo.119.1">phpunit.xml.dist</span></strong><span class="koboSpan" id="kobo.120.1"> file out of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.121.1">core</span></strong><span class="koboSpan" id="kobo.122.1"> directory and place this file in the root of your project. </span><span class="koboSpan" id="kobo.122.2">Rename the file </span><strong class="source-inline"><span class="koboSpan" id="kobo.123.1">phpunit.xml</span></strong><span class="koboSpan" id="kobo.124.1"> and make the </span><span class="No-Break"><span class="koboSpan" id="kobo.125.1">following edits:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.126.1">Edit the bootstrap attribute on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">&lt;phpunit&gt;</span></strong><span class="koboSpan" id="kobo.128.1"> tag at the top of the document to point to the core tests’ </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.129.1">bootstrap</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.130.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.131.1">
bootstrap="./web/core/tests/bootstrap.php"</span></pre></li>
<li><span class="koboSpan" id="kobo.132.1">In order to run kernel or functional tests, edit the following environment settings in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">&lt;</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.134.1">php&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.135.1"> section:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.136.1">
&lt;env name="SIMPLETEST_BASE_URL"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.137.1">
    value="http://localhost"/&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.138.1">
&lt;env name="SIMPLETEST_DB" value="</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.139.1">
    mysql://database:database@database/database"/&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.140.1">
&lt;env name="BROWSERTEST_OUTPUT_DIRECTORY" value=""/&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.141.1">
&lt;env name="SYMFONY_DEPRECATIONS_HELPER" value="weak"/&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.142.1">
&lt;env name="MINK_DRIVER_ARGS_WEBDRIVER" value="</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.143.1">
     ["chrome", {"browserName":"chrome",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.144.1">
     "chromeOptions":{"args":["--disable-gpu","--</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.145.1">
     headless"]}}, "http://chrome:9515"] "/&gt;</span></pre></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.146.1">DDEV, Lando, Docksal, or Docker?</span></p>
<p class="callout"><span class="koboSpan" id="kobo.147.1">If you use DDEV, Lando, Docksal, or other readymade tools to run Drupal locally, check their documentation and what the service names are. </span><span class="koboSpan" id="kobo.147.2">Depending on which one you use, the preceding values can differ for </span><strong class="source-inline"><span class="koboSpan" id="kobo.148.1">SIMPLETEST_BASE_URL</span></strong><span class="koboSpan" id="kobo.149.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.150.1">SIMPLETEST_DB</span></strong><span class="koboSpan" id="kobo.151.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.152.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">MINK_DRIVER_ARGS_WEBDRIVER</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.154.1">.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.155.1">Next, edit</span><a id="_idIndexMarker843"/><span class="koboSpan" id="kobo.156.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">testsuites</span></strong><span class="koboSpan" id="kobo.158.1"> section to point to your custom modules directory. </span><span class="koboSpan" id="kobo.158.2">You need to specify a </span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">testsuite</span></strong><span class="koboSpan" id="kobo.160.1"> entry per </span><span class="No-Break"><span class="koboSpan" id="kobo.161.1">test type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.162.1">
  &lt;testsuites&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.163.1">
    &lt;testsuite name="unit"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.164.1">
      &lt;directory&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.165.1">
        web/modules/custom/*/tests/src/Unit</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.166.1">
      &lt;/directory&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.167.1">
    &lt;/testsuite&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.168.1">
    &lt;testsuite name="kernel"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.169.1">
      &lt;directory&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.170.1">
        web/modules/custom/*/tests/src/Kernel</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.171.1">
      &lt;/directory&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.172.1">
    &lt;/testsuite&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.173.1">
    &lt;testsuite name="functional"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.174.1">
      &lt;directory&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.175.1">
        web/modules/custom/*/tests/src/Functional</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.176.1">
      &lt;/directory&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.177.1">
    &lt;/testsuite&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.178.1">
    &lt;testsuite name="functional-javascript"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.179.1">
      &lt;directory&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.180.1">
   web/modules/custom/*/tests/src/FunctionalJavascript</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.181.1">
      &lt;/directory&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.182.1">
    &lt;/testsuite&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.183.1">
&lt;/testsuites&gt;</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.184.1">These changes will tell</span><a id="_idIndexMarker844"/><span class="koboSpan" id="kobo.185.1"> PHPUnit where to locate the tests that we write for our custom modules, located in </span><strong class="source-inline"><span class="koboSpan" id="kobo.186.1">web/modules/custom</span></strong><span class="koboSpan" id="kobo.187.1">. </span><span class="koboSpan" id="kobo.187.2">Tests live in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">tests/src</span></strong><span class="koboSpan" id="kobo.189.1"> directory of </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">a module.</span></span></p>
<p><span class="koboSpan" id="kobo.191.1">Each type of test lives in its own directory </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">within that:</span></span></p>
<p><span class="koboSpan" id="kobo.193.1">Unit tests go </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">into </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">tests/src/Unit</span></strong></span></p>
<p><span class="koboSpan" id="kobo.196.1">Kernel tests go </span><span class="No-Break"><span class="koboSpan" id="kobo.197.1">into </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">tests/src/Kernel</span></strong></span></p>
<p><span class="koboSpan" id="kobo.199.1">Functional tests go </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">into </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.201.1">tests/src/Functional</span></strong></span></p>
<p><span class="koboSpan" id="kobo.202.1">Function JavaScript tests go </span><span class="No-Break"><span class="koboSpan" id="kobo.203.1">into </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">tests/src/FunctionalJavascript</span></strong></span></p>
<p><span class="koboSpan" id="kobo.205.1">By defining each type of test as its own test suite in </span><strong class="source-inline"><span class="koboSpan" id="kobo.206.1">phpunit.xml</span></strong><span class="koboSpan" id="kobo.207.1">, we can choose which kind of test type to execute using PHPUnit, which we will look at in the next section. </span><span class="koboSpan" id="kobo.207.2">You can also set several </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">testsuite</span></strong><span class="koboSpan" id="kobo.209.1"> entries, or several directories within a </span><strong class="source-inline"><span class="koboSpan" id="kobo.210.1">testsuite</span></strong><span class="koboSpan" id="kobo.211.1"> entry. </span><span class="koboSpan" id="kobo.211.2">For example, if you wanted to include all unit tests from contributed modules when you run PHPUnit, you can add another </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">directory</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.213.1"> entry:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.214.1">
&lt;testsuite name="unit"&gt;
   &lt;directory&gt;
      web/modules/contrib/*/tests/src/Unit
   &lt;/directory&gt;
   &lt;directory&gt;
      web/modules/custom/*/tests/src/Unit
   &lt;/directory&gt;
&lt;/testsuite&gt;</span></pre>
<p><span class="koboSpan" id="kobo.215.1">The reason we have created a </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">phpunit.xml</span></strong><span class="koboSpan" id="kobo.217.1"> file and placed it at the root of the project is that the file prevents the project from being overwritten or removed the next time you update Drupal. </span><span class="koboSpan" id="kobo.217.2">This way, you can commit the configuration to your repository and share it with a team, as well as be able to run tests in continuous integration services provided by GitHub, GitLab, </span><span class="No-Break"><span class="koboSpan" id="kobo.218.1">or CircleCI.</span></span></p>
<p><span class="koboSpan" id="kobo.219.1">It is important to know that this is just one possible way to set your PHPUnit configuration. </span><span class="koboSpan" id="kobo.219.2">There are more settings that you can configure here once you are more comfortable </span><span class="No-Break"><span class="koboSpan" id="kobo.220.1">with PHPUnit.</span></span></p>
<p><span class="koboSpan" id="kobo.221.1">There are other</span><a id="_idIndexMarker845"/><span class="koboSpan" id="kobo.222.1"> settings that can output test coverage results, where to save screenshots of test failures, additional test listeners, logging output, and so on. </span><span class="koboSpan" id="kobo.222.2">Be sure to check the online documentation (</span><a href="https://phpunit.readthedocs.io/en/9.5/configuration.html"><span class="koboSpan" id="kobo.223.1">https://phpunit.readthedocs.io/en/9.5/configuration.html</span></a><span class="koboSpan" id="kobo.224.1">) for configuring PHPUnit for </span><span class="No-Break"><span class="koboSpan" id="kobo.225.1">more information.</span></span></p>
<h2 id="_idParaDest-393"><a id="_idTextAnchor423"/><span class="koboSpan" id="kobo.226.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.227.1">When you execute PHPUnit, it uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.228.1">phpunit.xml</span></strong><span class="koboSpan" id="kobo.229.1"> file to inform how it executes. </span><span class="koboSpan" id="kobo.229.2">It will scan all listed directories for test files and execute them accordingly, providing test feedback in the command-line window (or IDE). </span><span class="koboSpan" id="kobo.229.3">Every project you write tests for will require a </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">phpunit.xml</span></strong><span class="koboSpan" id="kobo.231.1"> file like this in order to run </span><span class="No-Break"><span class="koboSpan" id="kobo.232.1">any tests.</span></span></p>
<h2 id="_idParaDest-394"><a id="_idTextAnchor424"/><span class="koboSpan" id="kobo.233.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.234.1">If you plan on writing functional JavaScript tests, you will also need Chrome, Chrome WebDriver, and Selenium. </span><span class="koboSpan" id="kobo.234.2">Installing and configuring this can vary, depending on whether you are using Lando, DDEV, Docksal, Docker Compose, or other tools to run Drupal. </span><span class="koboSpan" id="kobo.234.3">Please consult the documentation for the best information on how to install these tools to properly execute functional JavaScript tests. </span><span class="koboSpan" id="kobo.234.4">Assuming you are using </span><strong class="bold"><span class="koboSpan" id="kobo.235.1">Lando</span></strong><span class="koboSpan" id="kobo.236.1">, you would add this in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.237.1">services</span></strong><span class="koboSpan" id="kobo.238.1"> section of your </span><strong class="source-inline"><span class="koboSpan" id="kobo.239.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.240.1">lando.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.241.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.242.1">
  chrome:
     type: compose
     services:
       image: drupalci/webdriver-chromedriver:production
       command: chromedriver --log-path=/tmp/
           chromedriver.log --verbose</span></pre>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">chrome</span></strong><span class="koboSpan" id="kobo.244.1"> becomes a new wired service in the </span><strong class="bold"><span class="koboSpan" id="kobo.245.1">Lando</span></strong><span class="koboSpan" id="kobo.246.1"> stack (referenced in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">MINK_DRIVER_ARGS_WEBDRIVER</span></strong><span class="koboSpan" id="kobo.248.1"> setting in </span><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">phpunit.xml</span></strong><span class="koboSpan" id="kobo.250.1">, which makes this all work for functional JavaScript tests). </span><span class="koboSpan" id="kobo.250.2">If you want to install and use Firefox as an alternative browser to test with, you can do that as well, but Chrome is the most common browser used </span><span class="No-Break"><span class="koboSpan" id="kobo.251.1">for testing.</span></span></p>
<p><span class="koboSpan" id="kobo.252.1">The way these tools are added can vary, depending on what you use. </span><span class="koboSpan" id="kobo.252.2">Please consult the documentation on the best approach to add Chrome and Chrome WebDriver. </span><span class="koboSpan" id="kobo.252.3">There are simply too many stack-specific configurations to cover in </span><span class="No-Break"><span class="koboSpan" id="kobo.253.1">this book.</span></span></p>
<h1 id="_idParaDest-395"><a id="_idTextAnchor425"/><span class="koboSpan" id="kobo.254.1">Running PHPUnit</span></h1>
<p><span class="koboSpan" id="kobo.255.1">First, we can </span><a id="_idIndexMarker846"/><span class="koboSpan" id="kobo.256.1">verify that we have set up correctly by executing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">phpunit</span></strong><span class="koboSpan" id="kobo.258.1"> command. </span><span class="koboSpan" id="kobo.258.2">There are no tests yet, but that’s okay. </span><span class="koboSpan" id="kobo.258.3">This step just verifies that the tool is installed and our configuration file is </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">properly read.</span></span></p>
<h2 id="_idParaDest-396"><a id="_idTextAnchor426"/><span class="koboSpan" id="kobo.260.1">How to do it…</span></h2>
<p class="callout-heading"><span class="koboSpan" id="kobo.261.1">Consult the documentation</span></p>
<p class="callout"><span class="koboSpan" id="kobo.262.1">From here, we are going to provide bare-bones, verbose commands to use PHPUnit to execute tests. </span><span class="koboSpan" id="kobo.262.2">If you use Lando, DDEV, Docksal, or otherwise, please consult their documentation on how to best run PHPUnit. </span><span class="koboSpan" id="kobo.262.3">They usually have command wrappers that are small </span><span class="No-Break"><span class="koboSpan" id="kobo.263.1">and convenient.</span></span></p>
<p><span class="koboSpan" id="kobo.264.1">In your command line, execute </span><span class="No-Break"><span class="koboSpan" id="kobo.265.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.266.1">
phpunit</span></pre>
<p><span class="koboSpan" id="kobo.267.1">This is the main command you will run. </span><span class="koboSpan" id="kobo.267.2">PHPUnit will automatically detect our </span><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">phpunit.xml</span></strong><span class="koboSpan" id="kobo.269.1"> configuration in the </span><span class="No-Break"><span class="koboSpan" id="kobo.270.1">project directory.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.271.1">Can’t find phpunit?</span></p>
<p class="callout"><span class="koboSpan" id="kobo.272.1">If you get an error about the </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">phpunit</span></strong><span class="koboSpan" id="kobo.274.1"> command not being found, you may need to instead use the full path to it from the project root with </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">vendor/bin/phpunit</span></strong><span class="koboSpan" id="kobo.276.1">. </span><span class="koboSpan" id="kobo.276.2">Composer should automatically alias commands for you, but depending on how a project is set up, this may </span><span class="No-Break"><span class="koboSpan" id="kobo.277.1">be required.</span></span></p>
<p><span class="koboSpan" id="kobo.278.1">You should see </span><a id="_idIndexMarker847"/><span class="koboSpan" id="kobo.279.1">output similar to </span><span class="No-Break"><span class="koboSpan" id="kobo.280.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.281.1">
PHPUnit 9.5.26 by Sebastian Bergmann and contributors.
</span><span class="koboSpan" id="kobo.281.2">No tests executed!</span></pre>
<p><span class="koboSpan" id="kobo.282.1">You can also run specific </span><strong class="source-inline"><span class="koboSpan" id="kobo.283.1">testsuites</span></strong><span class="koboSpan" id="kobo.284.1"> or individual tests by adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">--testsuite</span></strong><span class="koboSpan" id="kobo.286.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.287.1">--filter</span></strong><span class="koboSpan" id="kobo.288.1"> arguments </span><span class="No-Break"><span class="koboSpan" id="kobo.289.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">phpunit</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.291.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.292.1">
phpunit --testsuite unit</span></pre>
<p><span class="koboSpan" id="kobo.293.1">The preceding command will run all unit tests found in the directories listed in your </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">unit</span></strong><span class="koboSpan" id="kobo.295.1"> testsuite </span><span class="No-Break"><span class="koboSpan" id="kobo.296.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.297.1">phpunit.xml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.299.1">
phpunit --testsuite unit --filter FooBarTest</span></pre>
<p><span class="koboSpan" id="kobo.300.1">The preceding command will run only the </span><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">FooBarTest</span></strong><span class="koboSpan" id="kobo.302.1"> unit test. </span><span class="koboSpan" id="kobo.302.2">These two approaches are useful for testing certain </span><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">testsuites</span></strong><span class="koboSpan" id="kobo.304.1"> only or specific tests themselves for faster feedback, when testing, debugging, and iterating </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">your code.</span></span></p>
<h2 id="_idParaDest-397"><a id="_idTextAnchor427"/><span class="koboSpan" id="kobo.306.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.307.1">When you execute PHPUnit, it scans all listed directories in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">phpunit.xml</span></strong><span class="koboSpan" id="kobo.309.1"> file and provides test feedback in the </span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">command-line window.</span></span></p>
<p><span class="koboSpan" id="kobo.311.1">In this</span><a id="_idIndexMarker848"/><span class="koboSpan" id="kobo.312.1"> instance, PHPUnit said that no tests were found or executed, which is correct because we do not have any yet. </span><span class="koboSpan" id="kobo.312.2">We are now ready to write our first </span><span class="No-Break"><span class="koboSpan" id="kobo.313.1">unit test.</span></span></p>
<h1 id="_idParaDest-398"><a id="_idTextAnchor428"/><span class="koboSpan" id="kobo.314.1">Writing a unit test</span></h1>
<p><span class="koboSpan" id="kobo.315.1">Let’s write our</span><a id="_idIndexMarker849"/><span class="koboSpan" id="kobo.316.1"> first test. </span><span class="koboSpan" id="kobo.316.2">As previously mentioned, a unit test is the lowest-level type of test you can write. </span><span class="koboSpan" id="kobo.316.3">It only executes and tests raw PHP code that has no dependencies on services such as a connected database or other integrated APIs. </span><span class="koboSpan" id="kobo.316.4">This means the test can execute using </span><span class="No-Break"><span class="koboSpan" id="kobo.317.1">PHP only.</span></span></p>
<h2 id="_idParaDest-399"><a id="_idTextAnchor429"/><span class="koboSpan" id="kobo.318.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.319.1">Let’s create a scenario that will help you think about when and how to apply unit testing. </span><span class="koboSpan" id="kobo.319.2">Imagine you have to provide data to a frontend component. </span><span class="koboSpan" id="kobo.319.3">The frontend developer has requested that you provide all JSON keys in </span><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">camelCase</span></strong><span class="koboSpan" id="kobo.321.1"> format in the API response. </span><strong class="source-inline"><span class="koboSpan" id="kobo.322.1">camelCase</span></strong><span class="koboSpan" id="kobo.323.1"> would turn strings such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.324.1">field_event_date</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.325.1">into </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.326.1">fieldEventDate</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.327.1">.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">snake_case</span></strong><span class="koboSpan" id="kobo.329.1"> is used in many places in Drupal; the most common place you will see this is with machine names (such as on the preceding event date field). </span><span class="koboSpan" id="kobo.329.2">All machine names in Drupal are </span><span class="No-Break"><span class="koboSpan" id="kobo.330.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">snake_case</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.332.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.333.1">This is a very simple example but perfect to illustrate how we can wield a unit test to test </span><span class="No-Break"><span class="koboSpan" id="kobo.334.1">our class.</span></span></p>
<h2 id="_idParaDest-400"><a id="_idTextAnchor430"/><span class="koboSpan" id="kobo.335.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.336.1">Go ahead and create a custom module called </span><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">chapter13</span></strong><span class="koboSpan" id="kobo.338.1">. </span><span class="koboSpan" id="kobo.338.2">This is where we will be writing example code and its tests for the rest of this chapter. </span><span class="koboSpan" id="kobo.338.3">Refer to </span><a href="B18548_04.xhtml#_idTextAnchor131"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.339.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.340.1">, </span><em class="italic"><span class="koboSpan" id="kobo.341.1">Extending Drupal with Custom Code</span></em><span class="koboSpan" id="kobo.342.1">, if you need a refresher on how to create a custom module </span><span class="No-Break"><span class="koboSpan" id="kobo.343.1">in Drupal.</span></span></p>
<p><span class="koboSpan" id="kobo.344.1">With the custom module created, let’s add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">CamelCase</span></strong><span class="koboSpan" id="kobo.346.1"> class in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.347.1">chapter13</span></strong><span class="koboSpan" id="kobo.348.1"> module under the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.349.1">src</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.350.1"> directory:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.351.1">
&lt;?php
declare(strict_types=1);
namespace Drupal\chapter13;
/**
 * Class CamelCase
 * @package Drupal\chapter13
 */
class CamelCase {
  /**
   * Convert snake_case to camelCase.
</span><span class="koboSpan" id="kobo.351.2">   *
   * @param string $input
   * @return string
   */
  public static function convert(string $input): string {
    $input = strtolower($input);
    return str_replace('_', '', lcfirst(ucwords
      </span><a id="_idTextAnchor431"/><span class="koboSpan" id="kobo.352.1">  ($input, '_')));
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.353.1">Looks like it works, right? </span><span class="koboSpan" id="kobo.353.2">Let’s prove it with </span><span class="No-Break"><span class="koboSpan" id="kobo.354.1">a test.</span></span></p>
<p><span class="koboSpan" id="kobo.355.1">In your custom module, create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">tests</span></strong><span class="koboSpan" id="kobo.357.1"> directory. </span><span class="koboSpan" id="kobo.357.2">Under this directory, create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">src</span></strong><span class="koboSpan" id="kobo.359.1"> directory, and within the </span><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">src</span></strong><span class="koboSpan" id="kobo.361.1"> directory, create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.362.1">Unit</span></strong><span class="koboSpan" id="kobo.363.1"> directory. </span><span class="koboSpan" id="kobo.363.2">You should have a path now that looks like </span><strong class="source-inline"><span class="koboSpan" id="kobo.364.1">chapter13/tests/src/Unit</span></strong><span class="koboSpan" id="kobo.365.1">. </span><span class="koboSpan" id="kobo.365.2">Note that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.366.1">src</span></strong><span class="koboSpan" id="kobo.367.1"> directory in your </span><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">tests</span></strong><span class="koboSpan" id="kobo.369.1"> directory is different than the </span><strong class="source-inline"><span class="koboSpan" id="kobo.370.1">src</span></strong><span class="koboSpan" id="kobo.371.1"> directory at the root of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">chapter13</span></strong><span class="koboSpan" id="kobo.373.1"> module, where the </span><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">CamelCase</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.375.1">class resides.</span></span></p>
<p><span class="koboSpan" id="kobo.376.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">chapter13/tests/src/Unit</span></strong><span class="koboSpan" id="kobo.378.1"> directory, create a new file and name it </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">CamelCaseTest.php</span></strong><span class="koboSpan" id="kobo.380.1">. </span><span class="koboSpan" id="kobo.380.2">All test files must have </span><strong class="source-inline"><span class="koboSpan" id="kobo.381.1">Test</span></strong><span class="koboSpan" id="kobo.382.1"> at the end of their filenames to be discovered </span><span class="No-Break"><span class="koboSpan" id="kobo.383.1">by PHPUnit.</span></span></p>
<p><span class="koboSpan" id="kobo.384.1">Our test file needs to do </span><span class="No-Break"><span class="koboSpan" id="kobo.385.1">two things:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.386.1">Provide test data to convert with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">CamelCase</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.388.1"> class</span></span></li>
<li><span class="koboSpan" id="kobo.389.1">Assert that the convert method returns what </span><span class="No-Break"><span class="koboSpan" id="kobo.390.1">we expect</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.391.1">Any method that </span><a id="_idIndexMarker850"/><span class="koboSpan" id="kobo.392.1">begins with </span><strong class="source-inline"><span class="koboSpan" id="kobo.393.1">test</span></strong><span class="koboSpan" id="kobo.394.1"> in your test class will be evaluated by PHPUnit. </span><span class="koboSpan" id="kobo.394.2">With that in mind, let’s go ahead and fill in our unit test </span><span class="No-Break"><span class="koboSpan" id="kobo.395.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">CamelCaseTest.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.397.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.398.1">
&lt;?php
namespace Drupal\Tests\chapter13\Unit;
use Drupal\Tests\UnitTestCase;
use Drupal\chapter13\CamelCase;
/**
 * Class CamelCaseTest
 * @package Drupal\Tests\chapter13\Unit
 */
class CamelCaseTest extends UnitTestCase {
  /**
   * Data provider for testToCamel().
</span><span class="koboSpan" id="kobo.398.2">   *
   * @return array
   *   An array containing input values and expected output
            values.
</span><span class="koboSpan" id="kobo.398.3">   */
  public function exampleStrings() {
    return [
      ['button_color', 'buttonColor'],
      ['snake_case_example', 'snakeCaseExample'],
      ['ALL_CAPS_LOCK', 'allCapsLock'],
    ];
  }
  /**
   * Tests the ::convert method.
</span><span class="koboSpan" id="kobo.398.4">   *
   * @param $input
   *   The input values.
</span><span class="koboSpan" id="kobo.398.5">   *
   * @param bool $expected
   *   The expected output.
</span><span class="koboSpan" id="kobo.398.6">   *
   * @param bool $separator
   *   The string separator.
</span><span class="koboSpan" id="kobo.398.7">   *
   * @dataProvider exampleStrings()
   */
  public function testCamelCaseConversion($input,
    $expected) {
    $output = CamelCase::convert($input);
    $this-&gt;assertEquals($expected, $output);
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.399.1">Go ahead and </span><span class="No-Break"><span class="koboSpan" id="kobo.400.1">run </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">phpunit</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.403.1">
phpunit --testsuite unit --filter CamelCaseTest</span></pre>
<p><span class="koboSpan" id="kobo.404.1">It will result in </span><span class="No-Break"><span class="koboSpan" id="kobo.405.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.406.1">
Testing
...  3 / 3 (100%)
Time: 00:00.044, Memory: 10.00 MB
OK (3 tests, 3 assertions)</span></pre>
<p><span class="koboSpan" id="kobo.407.1">This output indicates</span><a id="_idIndexMarker851"/><span class="koboSpan" id="kobo.408.1"> that the test was called three times (one for each set of data in </span><strong class="source-inline"><span class="koboSpan" id="kobo.409.1">@dataProvider</span></strong><span class="koboSpan" id="kobo.410.1">) and each one passed. </span><span class="koboSpan" id="kobo.410.2">In other words, </span><strong class="source-inline"><span class="koboSpan" id="kobo.411.1">$input</span></strong><span class="koboSpan" id="kobo.412.1"> equaled </span><strong class="source-inline"><span class="koboSpan" id="kobo.413.1">$expected</span></strong><span class="koboSpan" id="kobo.414.1">, which is what </span><strong class="source-inline"><span class="koboSpan" id="kobo.415.1">assertEquals</span></strong><span class="koboSpan" id="kobo.416.1"> evaluates. </span><span class="koboSpan" id="kobo.416.2">If a test were to fail, this output would indicate what test failed and on </span><span class="No-Break"><span class="koboSpan" id="kobo.417.1">what line.</span></span></p>
<h2 id="_idParaDest-401"><a id="_idTextAnchor432"/><span class="koboSpan" id="kobo.418.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.419.1">PHPUnit reports that all three tests pass. </span><span class="koboSpan" id="kobo.419.2">But, wait – didn’t we only write the </span><strong class="source-inline"><span class="koboSpan" id="kobo.420.1">testCamelCaseConversion</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.421.1">test method?</span></span></p>
<p><span class="koboSpan" id="kobo.422.1">When the test is executed, PHPUnit detects a special annotation in our test method called </span><strong class="source-inline"><span class="koboSpan" id="kobo.423.1">@dataProvider</span></strong><span class="koboSpan" id="kobo.424.1">, which tags the </span><strong class="source-inline"><span class="koboSpan" id="kobo.425.1">exampleStrings</span></strong><span class="koboSpan" id="kobo.426.1"> method. </span><span class="koboSpan" id="kobo.426.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">exampleStrings</span></strong><span class="koboSpan" id="kobo.428.1"> method provides an array of data. </span><span class="koboSpan" id="kobo.428.2">Each array contains a value to send in and the value we expect to get back. </span><span class="koboSpan" id="kobo.428.3">PHPUnit will loop the data provider values, so our test method is called three times (one for each set of values) and evaluates the test. </span><span class="koboSpan" id="kobo.428.4">This means PHPUnit sees the test method called like this </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">when executed:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.430.1">
testCamelCaseConversion("button_color", "buttonColor")</span></pre>
<p><span class="koboSpan" id="kobo.431.1">The three values test that the method works for two or more words and returns the </span><span class="No-Break"><span class="koboSpan" id="kobo.432.1">proper case.</span></span></p>
<p><span class="koboSpan" id="kobo.433.1">Within the test, we pass the input along to </span><strong class="source-inline"><span class="koboSpan" id="kobo.434.1">CamelCase::convert</span></strong><span class="koboSpan" id="kobo.435.1">. </span><span class="koboSpan" id="kobo.435.2">From that method, we pass the value it returned to </span><strong class="source-inline"><span class="koboSpan" id="kobo.436.1">assertEquals</span></strong><span class="koboSpan" id="kobo.437.1">, one of the many value assertion methods </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">of PHPUnit.</span></span></p>
<p><span class="koboSpan" id="kobo.439.1">Every item you add to a data provider will be asserted by the test method(s) that use them. </span><strong class="source-inline"><span class="koboSpan" id="kobo.440.1">dataProviders</span></strong><span class="koboSpan" id="kobo.441.1"> is an excellent way to test our code under a variety of scenarios. </span><span class="koboSpan" id="kobo.441.2">Therefore, we know that any string passed to convert will be transformed from </span><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">foo_bar</span></strong><span class="koboSpan" id="kobo.443.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">fooBar</span></strong><span class="koboSpan" id="kobo.445.1"> and returned. </span><span class="koboSpan" id="kobo.445.2">The test </span><span class="No-Break"><span class="koboSpan" id="kobo.446.1">proves that.</span></span></p>
<p><span class="koboSpan" id="kobo.447.1">So, how does automated testing help here? </span><span class="koboSpan" id="kobo.447.2">With our setup, any developer on a team is able to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">testsuites</span></strong><span class="koboSpan" id="kobo.449.1"> and see their output. </span><span class="koboSpan" id="kobo.449.2">If they fail, they can see what code is failing and where. </span><span class="koboSpan" id="kobo.449.3">This provides an opportunity to fix the code before it is deployed </span><span class="No-Break"><span class="koboSpan" id="kobo.450.1">to production.</span></span></p>
<p><span class="koboSpan" id="kobo.451.1">Under continuous integration setups, you can prevent code from being merged into your main branch until all tests pass. </span><span class="koboSpan" id="kobo.451.2">As we mentioned, this is an excellent way to reduce bugs and </span><a id="_idIndexMarker852"/><span class="koboSpan" id="kobo.452.1">errors from surfacing on production to </span><span class="No-Break"><span class="koboSpan" id="kobo.453.1">your users.</span></span></p>
<h2 id="_idParaDest-402"><a id="_idTextAnchor433"/><span class="koboSpan" id="kobo.454.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.455.1">Over time, requirements can and often do change. </span><span class="koboSpan" id="kobo.455.2">Assume that after you have deployed this code, your frontend developer returns and asks that any string such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">foo-bar</span></strong><span class="koboSpan" id="kobo.457.1"> is also converted to </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">camel case.</span></span></p>
<p><span class="koboSpan" id="kobo.459.1">With our test in place, we can add this new case to our </span><span class="No-Break"><span class="koboSpan" id="kobo.460.1">data provider:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.461.1">
  public function exampleStrings() {
    return [
      ['button_color', 'buttonColor'],
      ['snake_case_example', 'snakeCaseExample'],
      ['ALL_CAPS_LOCK', 'allCapsLock'],
      ['foo-bar', 'fooBar'],
    ];
  }</span></pre>
<p><span class="koboSpan" id="kobo.462.1">When we run the test now, we get </span><span class="No-Break"><span class="koboSpan" id="kobo.463.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.464.1">
Testing
...F     4 / 4 (100%)
Time: 00:00.046, Memory: 10.00 MB
There was 1 failure:
1) Drupal\Tests\chapter13\Unit\CamelCaseTest::
    testCamelCaseConversion with data set #3 ('foo-bar',
        'fooBar')
Failed asserting that two strings are equal.
</span><span class="koboSpan" id="kobo.464.2">--- Expected
+++ Actual
@@ @@
-'fooBar'
+'foo-bar'
FAILURES!
</span><span class="koboSpan" id="kobo.464.3">Tests: 4, Assertions: 4, Failures: 1.</span></pre>
<p><span class="koboSpan" id="kobo.465.1">This is fine – we have not</span><a id="_idIndexMarker853"/><span class="koboSpan" id="kobo.466.1"> updated our implementation yet. </span><span class="koboSpan" id="kobo.466.2">Adding new cases to the test first lets us iterate and improve the implementation code until the test passes. </span><span class="koboSpan" id="kobo.466.3">This provides a fast feedback loop because we can modify the implementation in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.467.1">CamelCase</span></strong><span class="koboSpan" id="kobo.468.1"> class all we want. </span><span class="koboSpan" id="kobo.468.2">If the tests all pass, we know we have met the requirements and that our functionality works, and we can move on to other features in </span><span class="No-Break"><span class="koboSpan" id="kobo.469.1">our module.</span></span></p>
<h2 id="_idParaDest-403"><a id="_idTextAnchor434"/><span class="koboSpan" id="kobo.470.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.471.1">Writing tests first before having any implementation code is referred to as </span><strong class="bold"><span class="koboSpan" id="kobo.472.1">test-driven development</span></strong><span class="koboSpan" id="kobo.473.1">. </span><span class="koboSpan" id="kobo.473.2">This</span><a id="_idIndexMarker854"/><span class="koboSpan" id="kobo.474.1"> means the tests drive the specification or requirements, and the implementation code makes them pass. </span><span class="koboSpan" id="kobo.474.2">There are many schools of thought on whether you should write all tests first </span><span class="No-Break"><span class="koboSpan" id="kobo.475.1">or not.</span></span></p>
<p><span class="koboSpan" id="kobo.476.1">If you are new to testing, it is fine to write some initial code for a proof of concept if you need to hash out an idea in your Drupal module. </span><span class="koboSpan" id="kobo.476.2">You can always add tests to it at any point during development. </span><span class="koboSpan" id="kobo.476.3">The important point is to add tests for your code; don’t worry so much </span><span class="No-Break"><span class="koboSpan" id="kobo.477.1">about when.</span></span></p>
<p><span class="koboSpan" id="kobo.478.1">The more you practice and write tests, the better you will get, and you will eventually shift to writing the </span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">tests first.</span></span></p>
<p><span class="koboSpan" id="kobo.480.1">Continue experimenting with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">CamelCase</span></strong><span class="koboSpan" id="kobo.482.1"> class and its </span><strong class="source-inline"><span class="koboSpan" id="kobo.483.1">CamelCaseTest</span></strong><span class="koboSpan" id="kobo.484.1"> class. </span><span class="koboSpan" id="kobo.484.2">See whether you can invent some new requirements, change the code, run the tests, and get them </span><span class="No-Break"><span class="koboSpan" id="kobo.485.1">to pass.</span></span></p>
<p><span class="koboSpan" id="kobo.486.1">Drupal core has hundreds of great examples of unit tests. </span><span class="koboSpan" id="kobo.486.2">The most-popular contributed modules are useful as well. </span><span class="koboSpan" id="kobo.486.3">Be sure to check them out if you are stuck or </span><span class="No-Break"><span class="koboSpan" id="kobo.487.1">need guidance.</span></span></p>
<p><span class="koboSpan" id="kobo.488.1">Now that you know the basics of unit testing in Drupal, let’s look at </span><span class="No-Break"><span class="koboSpan" id="kobo.489.1">kernel tests.</span></span></p>
<h1 id="_idParaDest-404"><a id="_idTextAnchor435"/><span class="koboSpan" id="kobo.490.1">Writing a kernel test</span></h1>
<p><span class="koboSpan" id="kobo.491.1">Let’s build upon </span><a id="_idIndexMarker855"/><span class="koboSpan" id="kobo.492.1">the previous example. </span><span class="koboSpan" id="kobo.492.2">Assume now that stakeholders have asked you to output a field value on the screen in the camel case format. </span><span class="koboSpan" id="kobo.492.3">The good news is we have a working implementation and unit test, so we can make short work of this task </span><span class="No-Break"><span class="koboSpan" id="kobo.493.1">in Drupal.</span></span></p>
<p><span class="koboSpan" id="kobo.494.1">In this case, we need to make a field formatter class for string fields. </span><span class="koboSpan" id="kobo.494.2">When the formatter is used on a field to display output, we want to run the user input through our existing </span><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">CamelCase</span></strong><span class="koboSpan" id="kobo.496.1"> class. </span><span class="koboSpan" id="kobo.496.2">If you need a refresher on field formatters and managing entity displays, refer to </span><a href="B18548_02.xhtml#_idTextAnchor059"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.497.1">Chapter 2</span></em></span></a><span class="koboSpan" id="kobo.498.1">, </span><em class="italic"><span class="koboSpan" id="kobo.499.1">Content </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.500.1">Building Experience</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.501.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.502.1">This provides an excellent example to step into a kernel test. </span><span class="koboSpan" id="kobo.502.2">Earlier, we mentioned that kernel tests create a minimal installation of Drupal with the setup that you specify in your test, in order to run and evaluate their test methods. </span><span class="koboSpan" id="kobo.502.3">There is no danger in running kernel tests, as they do not touch or interfere with your current site database in any way. </span><span class="koboSpan" id="kobo.502.4">When the test is done, it is </span><em class="italic"><span class="koboSpan" id="kobo.503.1">torn down</span></em><span class="koboSpan" id="kobo.504.1">, or removed, from the database with </span><span class="No-Break"><span class="koboSpan" id="kobo.505.1">no trace.</span></span></p>
<h2 id="_idParaDest-405"><a id="_idTextAnchor436"/><span class="koboSpan" id="kobo.506.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.507.1">Create a new directory in your </span><strong class="source-inline"><span class="koboSpan" id="kobo.508.1">tests/src</span></strong><span class="koboSpan" id="kobo.509.1"> directory called </span><strong class="source-inline"><span class="koboSpan" id="kobo.510.1">Kernel</span></strong><span class="koboSpan" id="kobo.511.1">. </span><span class="koboSpan" id="kobo.511.2">This is where your kernel tests for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.512.1">chapter13</span></strong><span class="koboSpan" id="kobo.513.1"> module will live. </span><span class="koboSpan" id="kobo.513.2">This time around, we are going to write the </span><span class="No-Break"><span class="koboSpan" id="kobo.514.1">test first.</span></span></p>
<p><span class="koboSpan" id="kobo.515.1">Under </span><strong class="source-inline"><span class="koboSpan" id="kobo.516.1">chapter13/tests/src/Kernel</span></strong><span class="koboSpan" id="kobo.517.1">, create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.518.1">CamelCaseFormatterTest.php</span></strong><span class="koboSpan" id="kobo.519.1"> file. </span><span class="koboSpan" id="kobo.519.2">Next, we are going to fill it in with the following code. </span><span class="koboSpan" id="kobo.519.3">There is</span><a id="_idIndexMarker856"/><span class="koboSpan" id="kobo.520.1"> a fair amount of boilerplate in the setup, but we will review what’s </span><span class="No-Break"><span class="koboSpan" id="kobo.521.1">going on:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.522.1">
&lt;?php
namespace Drupal\Tests\chapter13\Kernel;
use Drupal\Core\Entity\Entity\EntityViewDisplay;
use Drupal\field\Entity\FieldConfig;
use Drupal\field\Entity\FieldStorageConfig;
use Drupal\KernelTests\KernelTestBase;
use Drupal\Tests\node\Traits\ContentTypeCreationTrait;
use Drupal\Tests\node\Traits\NodeCreationTrait;
/**
 * Tests the formatting of string fields using the Camel
        Case field formatter.
 </span><span class="koboSpan" id="kobo.522.2">*
 * @package Drupal\Tests\chapter13\Kernel
 */
class CamelCaseFormatterTest extends KernelTestBase {
  use NodeCreationTrait,
    ContentTypeCreationTrait;
  protected $strictConfigSchema = FALSE;
  /**
   * Modules to enable.
</span><span class="koboSpan" id="kobo.522.3">   *
   * @var array
   */
  protected static $modules = [
    'field',
    'text',
    'node',
    'system',
    'filter',
    'user',
    'chapter13',
  ];
  /**
   * {@inheritdoc}
   */
  protected function setUp(): void {
    parent::setUp();
    // Install required module schema and configs.
</span><span class="koboSpan" id="kobo.522.4">    $this-&gt;installEntitySchema('node');
    $this-&gt;installEntitySchema('user');
    $this-&gt;installConfig(['field', 'node', 'filter',
        'system']);
    $this-&gt;installSchema('node', ['node_access']);
    // Create a vanilla content type for testing.
</span><span class="koboSpan" id="kobo.522.5">    $this-&gt;createContentType(
      [
        'type' =&gt; 'page'
      ]
    );
    // Create and store the field_chapter13_test field.
</span><span class="koboSpan" id="kobo.522.6">    FieldStorageConfig::create([
      'field_name' =&gt; 'field_chapter13_test',
      'entity_type' =&gt; 'node',
      'type' =&gt; 'string',
      'cardinality' =&gt; 1,
      'locked' =&gt; FALSE,
      'indexes' =&gt; [],
      'settings' =&gt; [
        'max_length' =&gt; 255,
        'case_sensitive' =&gt; FALSE,
        'is_ascii' =&gt; FALSE,
      ],
    ])-&gt;save();
    FieldConfig::create([
      'field_name' =&gt; 'field_chapter13_test',
      'field_type' =&gt; 'string',
      'entity_type' =&gt; 'node',
      'label' =&gt; 'Chapter13 Camel Case Field',
      'bundle' =&gt; 'page',
      'description' =&gt; '',
      'required' =&gt; FALSE,
      'settings' =&gt; [
        'link_to_entity' =&gt; FALSE
      ],
    ])-&gt;save();
    // Set the entity display for testing to use our
        camel_case formatter.
</span><span class="koboSpan" id="kobo.522.7">    $entity_display = EntityViewDisplay::load
         ('node.page.default');
    $entity_display-&gt;setComponent('field_chapter13_test',
    [
      'type' =&gt; 'camel_case',
      'region' =&gt; 'content',
      'settings' =&gt; [],
      'label' =&gt; 'hidden',
      'third_party_settings' =&gt; []
    ]);
    $entity_display-&gt;save();
  }
  /**
   * Tests that the field formatter camel_case formats the
        value
   * as expected.
</span><span class="koboSpan" id="kobo.522.8">   */
  public function testFieldIsFormatted() {
    $node = $this-&gt;createNode(
      [
        'type' =&gt; 'page',
        'field_chapter13_test' =&gt; 'A user entered string'
      ]
    );
    $build = $node-&gt;field_chapter13_test-&gt;view('default');
    $this-&gt;assertSame('aUserEnteredString',
        $build[0]['#context']['value']);
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.523.1">Don’t be discouraged by </span><a id="_idIndexMarker857"/><span class="koboSpan" id="kobo.524.1">the amount of code in this test. </span><span class="koboSpan" id="kobo.524.2">A majority of the code is setting up the conditions we need to run the </span><span class="No-Break"><span class="koboSpan" id="kobo.525.1">test itself:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.526.1">Installing the required modules needed to provide the field and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">Node</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.528.1"> entity</span></span></li>
<li><span class="koboSpan" id="kobo.529.1">Installing the module configuration and </span><span class="No-Break"><span class="koboSpan" id="kobo.530.1">entity schema</span></span></li>
<li><span class="koboSpan" id="kobo.531.1">Creating a </span><strong class="source-inline"><span class="koboSpan" id="kobo.532.1">page</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.533.1">content type</span></span></li>
<li><span class="koboSpan" id="kobo.534.1">Creating </span><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">field_chapter13_test</span></strong><span class="koboSpan" id="kobo.536.1"> and assigning it to the page </span><span class="No-Break"><span class="koboSpan" id="kobo.537.1">Node type</span></span></li>
<li><span class="koboSpan" id="kobo.538.1">Modifying the Node default view mode and setting </span><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">field_chapter13_test</span></strong><span class="koboSpan" id="kobo.540.1"> to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.541.1">camel_case</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.542.1">field formatter</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.543.1">An alternative way to do this would be to create all of these items in Drupal (the content type, the field, set the formatter) and export that configuration into a module that is used only for this test. </span><span class="koboSpan" id="kobo.543.2">The result is more or less equivalent in the end, but you may find that creating the conditions entirely out of code is more maintainable in the long run than a few dozen </span><span class="No-Break"><span class="koboSpan" id="kobo.544.1">YAML files.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.545.1">Names in tests</span></p>
<p class="callout"><span class="koboSpan" id="kobo.546.1">When naming content types, entities, or fields in a kernel test, you can make them whatever you want. </span><span class="koboSpan" id="kobo.546.2">They don’t have to match your system exactly, especially if all you need is a random content type that can hold a field. </span><span class="koboSpan" id="kobo.546.3">What we are testing is the output returned, not </span><span class="No-Break"><span class="koboSpan" id="kobo.547.1">the names.</span></span></p>
<p><span class="koboSpan" id="kobo.548.1">If we run the test </span><a id="_idIndexMarker858"/><span class="koboSpan" id="kobo.549.1">now, it will fail; now, we can make the implementation so that the tests </span><span class="No-Break"><span class="koboSpan" id="kobo.550.1">will pass.</span></span></p>
<p><span class="koboSpan" id="kobo.551.1">To solve the ask, we need to create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.552.1">FieldFormatter</span></strong><span class="koboSpan" id="kobo.553.1"> plugin that uses our existing </span><strong class="source-inline"><span class="koboSpan" id="kobo.554.1">CamelCase</span></strong><span class="koboSpan" id="kobo.555.1"> class. </span><span class="koboSpan" id="kobo.555.2">This exercise is easy, since the bulk of the work already exists for changing inputs to camel </span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">case format.</span></span></p>
<p><span class="koboSpan" id="kobo.557.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.558.1">Plugin/Field/FieldFormatter</span></strong><span class="koboSpan" id="kobo.559.1"> directory under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.560.1">src</span></strong><span class="koboSpan" id="kobo.561.1"> directory of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.562.1">chapter13</span></strong><span class="koboSpan" id="kobo.563.1"> module. </span><span class="koboSpan" id="kobo.563.2">Within that directory, add a file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.564.1">CamelCaseFormatter.php</span></strong><span class="koboSpan" id="kobo.565.1">. </span><span class="koboSpan" id="kobo.565.2">Our implementation will be </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.567.1">
&lt;?php
declare(strict_types = 1);
namespace Drupal\chapter13\Plugin\Field\FieldFormatter;
use Drupal\chapter13\CamelCase;
use Drupal\Core\Field\FieldItemInterface;
use Drupal\Core\Field\FieldItemListInterface;
use Drupal\Core\Field\Plugin\Field\FieldFormatter\
    StringFormatter;
/**
 * Plugin implementation of the 'camel_case' field
      formatter.
 </span><span class="koboSpan" id="kobo.567.2">*
 * @FieldFormatter(
 *   id = "camel_case",
 *   label = @Translation("Camel case"),
 *   field_types = {
 *     "string"
 *   }
 * )
 */
class CamelCaseFormatter extends StringFormatter {
  /**
   * {@inheritdoc}
   */
  public function viewElements(FieldItemListInterface
    $items, $langcode) : array {
    $elements = [];
    foreach ($items as $delta =&gt; $item) {
      $view_value = $this-&gt;viewValue($item);
      $elements[$delta] = $view_value;
    }
    return $elements;
  }
  /**
   * {@inheritdoc}
   */
  protected function viewValue(FieldItemInterface $item) {
    return [
      '#type' =&gt; 'inline_template',
      '#template' =&gt; '{{ value|nl2br }}',
      '#context' =&gt; ['value' =&gt; CamelCase::convert($item
          -&gt;value)],
    ];
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.568.1">By extending</span><a id="_idIndexMarker859"/><span class="koboSpan" id="kobo.569.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.570.1">StringFormatter</span></strong><span class="koboSpan" id="kobo.571.1"> class from core Drupal, we can make modifications that leverage our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.572.1">CamelCase</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.573.1"> class.</span></span></p>
<p><span class="koboSpan" id="kobo.574.1">Now, let’s run our </span><span class="No-Break"><span class="koboSpan" id="kobo.575.1">kernel test:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.576.1">
phpunit --testsuite kernel --filter CamelCaseFormatterTest</span></pre>
<p><span class="koboSpan" id="kobo.577.1">This results in </span><span class="No-Break"><span class="koboSpan" id="kobo.578.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.579.1">
Testing
F     1 / 1 (100%)
Time: 00:01.500, Memory: 10.00 MB
There was 1 failure:
1) Drupal\Tests\chapter13\Kernel\CamelCaseFormatterTest::
    testFieldIsFormatted
Failed asserting that two strings are identical.
</span><span class="koboSpan" id="kobo.579.2">--- Expected
+++ Actual
@@ @@
-'aUserEnteredString'
+'a user entered string'
FAILURES!
</span><span class="koboSpan" id="kobo.579.3">Tests: 1, Assertions: 9, Failures: 1.</span></pre>
<p><span class="koboSpan" id="kobo.580.1">It failed! </span><span class="koboSpan" id="kobo.580.2">What</span><a id="_idIndexMarker860"/><span class="koboSpan" id="kobo.581.1"> happened? </span><span class="koboSpan" id="kobo.581.2">Remember when we mentioned before that requirements can change? </span><span class="koboSpan" id="kobo.581.3">Our test case passes </span><strong class="source-inline"><span class="koboSpan" id="kobo.582.1">A user entered string</span></strong><span class="koboSpan" id="kobo.583.1"> as test data. </span><span class="koboSpan" id="kobo.583.2">Our </span><strong class="source-inline"><span class="koboSpan" id="kobo.584.1">CamelCase</span></strong><span class="koboSpan" id="kobo.585.1"> class does not currently handle strings with spaces, dashes, or commas. </span><span class="koboSpan" id="kobo.585.2">Since this is a field in Drupal, users can enter just about anything. </span><span class="koboSpan" id="kobo.585.3">We need to account </span><span class="No-Break"><span class="koboSpan" id="kobo.586.1">for that.</span></span></p>
<p><span class="koboSpan" id="kobo.587.1">Modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.588.1">CamelCase</span></strong><span class="koboSpan" id="kobo.589.1"> class to account for this </span><span class="No-Break"><span class="koboSpan" id="kobo.590.1">new requirement:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.591.1">
  public static function convert(string $input): string {
    $input = strtolower($input);
    $input = preg_replace('/[, -]/', '_', $input);
    return str_replace('_', '', lcfirst(ucwords
        ($input, '_')));
  }</span></pre>
<p><span class="koboSpan" id="kobo.592.1">The addition of replacing the comma, space, and dash character should now satisfy new use cases. </span><span class="koboSpan" id="kobo.592.2">Let’s run the kernel </span><span class="No-Break"><span class="koboSpan" id="kobo.593.1">test again:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.594.1">
Testing
.       1 / 1 (100%)
Time: 00:01.491, Memory: 10.00 MB
OK (1 test, 9 assertions)</span></pre>
<p><span class="koboSpan" id="kobo.595.1">However, let’s not forget about our unit test that broke earlier – let’s add our two new example strings to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">exampleStrings</span></strong><span class="koboSpan" id="kobo.597.1"> data </span><span class="No-Break"><span class="koboSpan" id="kobo.598.1">provider method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.599.1">
  public function exampleStrings() {
    return [
      ['button_color', 'buttonColor'],
      ['snake_case_example', 'snakeCaseExample'],
      ['ALL_CAPS_LOCK', 'allCapsLock'],
      ['foo-bar', 'fooBar'],
      ['This is a basic string', 'thisIsABasicString'],
    ];
  }</span></pre>
<p><span class="koboSpan" id="kobo.600.1">Now, when you run</span><a id="_idIndexMarker861"/><span class="koboSpan" id="kobo.601.1"> PHPUnit, both the unit and the kernel test </span><span class="No-Break"><span class="koboSpan" id="kobo.602.1">should pass:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.603.1">
Testing
......   6 / 6 (100%)
Time: 00:01.419, Memory: 10.00 MB
OK (6 tests, 14 assertions)</span></pre>
<p><span class="koboSpan" id="kobo.604.1">We now have another new and tested feature added to the site that we can deploy with confidence. </span><span class="koboSpan" id="kobo.604.2">Of course, we are free to reuse this functionality for our Drupal application when we </span><span class="No-Break"><span class="koboSpan" id="kobo.605.1">need to.</span></span></p>
<h2 id="_idParaDest-406"><a id="_idTextAnchor437"/><span class="koboSpan" id="kobo.606.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.607.1">When running a kernel test, Drupal will install an additional copy of itself to run tests in. </span><span class="koboSpan" id="kobo.607.2">The kernel test will use the install profile and modules you require in the test. </span><span class="koboSpan" id="kobo.607.3">This way, you can ensure that you are testing your code in the cleanest possible setup, with no interference from unnecessary contributed modules or other code. </span><span class="koboSpan" id="kobo.607.4">When the tests finish running, Drupal will automatically clean up and remove this second installation, including any data that was created within the </span><span class="No-Break"><span class="koboSpan" id="kobo.608.1">test itself.</span></span></p>
<p><span class="koboSpan" id="kobo.609.1">So far, we have</span><a id="_idIndexMarker862"/><span class="koboSpan" id="kobo.610.1"> written code and tests that prove they do what we need – but they can’t test that a user on the site sees the right thing. </span><span class="koboSpan" id="kobo.610.2">Let’s dive in and add a functional test to do </span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">just that!</span></span></p>
<h1 id="_idParaDest-407"><a id="_idTextAnchor438"/><span class="koboSpan" id="kobo.612.1">Writing a functional test</span></h1>
<p><span class="koboSpan" id="kobo.613.1">Now that we know</span><a id="_idIndexMarker863"/><span class="koboSpan" id="kobo.614.1"> our code is working, let’s prove that a user can see the formatted string when they visit a node. </span><span class="koboSpan" id="kobo.614.2">Functional tests use an emulated browser that allows us to simulate users navigating the site. </span><span class="koboSpan" id="kobo.614.3">Functional tests install Drupal and test in an isolated fashion, so there is no risk of corrupting your current </span><span class="No-Break"><span class="koboSpan" id="kobo.615.1">Drupal installation.</span></span></p>
<h2 id="_idParaDest-408"><a id="_idTextAnchor439"/><span class="koboSpan" id="kobo.616.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.617.1">With a functional test, we can navigate the browser as if we were a real user, navigating and performing all kinds of assertions that unit and kernel tests cannot do. </span><span class="koboSpan" id="kobo.617.2">Like before, we do need to set some configurations in place in order to test. </span><span class="koboSpan" id="kobo.617.3">Within your </span><strong class="source-inline"><span class="koboSpan" id="kobo.618.1">tests/src</span></strong><span class="koboSpan" id="kobo.619.1"> directory, create a new directory called </span><strong class="source-inline"><span class="koboSpan" id="kobo.620.1">Functional</span></strong><span class="koboSpan" id="kobo.621.1">, and then create a file inside of it </span><span class="No-Break"><span class="koboSpan" id="kobo.622.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.623.1">CamelCaseFormatterDisplayTest.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.624.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.625.1">In this new test file, we are going to borrow some of the setups from the previous </span><span class="No-Break"><span class="koboSpan" id="kobo.626.1">kernel test:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.627.1">
&lt;?php
namespace Drupal\Tests\chapter13\Functional;
use Drupal\Core\Entity\Entity\EntityViewDisplay;
use Drupal\field\Entity\FieldConfig;
use Drupal\field\Entity\FieldStorageConfig;
use Drupal\Tests\BrowserTestBase;
/**
 * Class CamelCaseFormatterDisplayTest
 *
 * @package Drupal\Tests\chapter13\Functional
 */
class CamelCaseFormatterDisplayTest extends
    BrowserTestBase {
  /**
   * @var bool Disable schema checking.
</span><span class="koboSpan" id="kobo.627.2">   */
  protected $strictConfigSchema = FALSE;
  /**
   * @var string The theme to use during test.
</span><span class="koboSpan" id="kobo.627.3">   */
  protected $defaultTheme = 'stark';
  /**
   * Modules to enable.
</span><span class="koboSpan" id="kobo.627.4">   *
   * @var array
   */
  protected static $modules = [
    'field',
    'text',
    'node',
    'system',
    'filter',
    'user',
    'chapter13',
  ];
  /**
   * {@inheritdoc}
   */
  protected function setUp(): void {
    parent::setUp();
    // Create a vanilla content type for testing.
</span><span class="koboSpan" id="kobo.627.5">    $this-&gt;createContentType(
      [
        'type' =&gt; 'page'
      ]
    );
    // Create and store the field_chapter13_test field.
</span><span class="koboSpan" id="kobo.627.6">    FieldStorageConfig::create([
      'field_name' =&gt; 'field_chapter13_test',
      'entity_type' =&gt; 'node',
      'type' =&gt; 'string',
      'cardinality' =&gt; 1,
      'locked' =&gt; FALSE,
      'indexes' =&gt; [],
      'settings' =&gt; [
        'max_length' =&gt; 255,
        'case_sensitive' =&gt; FALSE,
        'is_ascii' =&gt; FALSE,
      ],
    ])-&gt;save();
    FieldConfig::create([
      'field_name' =&gt; 'field_chapter13_test',
      'field_type' =&gt; 'string',
      'entity_type' =&gt; 'node',
      'label' =&gt; 'Chapter13 Camel Case Field',
      'bundle' =&gt; 'page',
      'description' =&gt; '',
      'required' =&gt; FALSE,
      'settings' =&gt; [
        'link_to_entity' =&gt; FALSE
      ],
    ])-&gt;save();
    // Set the entity display for testing to use our
        camel_case formatter.
</span><span class="koboSpan" id="kobo.627.7">    $entity_display = EntityViewDisplay::load
        ('node.page.default');
    $entity_display-&gt;setComponent('field_chapter13_test',
      [
        'type' =&gt; 'camel_case',
        'region' =&gt; 'content',
        'settings' =&gt; [],
        'label' =&gt; 'hidden',
        'third_party_settings' =&gt; []
      ]);
    $en</span><a id="_idTextAnchor440"/><span class="koboSpan" id="kobo.628.1">tity_display-&gt;save();
  }
  /**
   * Test that a site visitor can see a string formatted
         with our custom
   * field CamelCaseFieldFormatter.
</span><span class="koboSpan" id="kobo.628.2">   *
   * @return void
   */
  public function testUserCanSeeFormattedString() {
    $this-&gt;drupalCreateNode(
      [
        'type' =&gt; 'page',
        'field_chapter13_test' =&gt; 'A user entered string'
      ]
    );
    $this-&gt;drupalGet('/node/1');
    $this-&gt;getSession()-&gt;getPage()-&gt;hasContent
        ('aUserEnteredString');
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.629.1">There are some differences here for the </span><span class="No-Break"><span class="koboSpan" id="kobo.630.1">functional test.</span></span></p>
<p><span class="koboSpan" id="kobo.631.1">In a functional test, you can specify two properties, </span><strong class="source-inline"><span class="koboSpan" id="kobo.632.1">$profile</span></strong><span class="koboSpan" id="kobo.633.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.634.1">$defaultTheme</span></strong><span class="koboSpan" id="kobo.635.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.636.1">$profile</span></strong><span class="koboSpan" id="kobo.637.1"> specifies which installation profile to use for this test, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.638.1">$defaultTheme</span></strong><span class="koboSpan" id="kobo.639.1"> specifies which theme to activate for this test. </span><span class="koboSpan" id="kobo.639.2">By default, the </span><em class="italic"><span class="koboSpan" id="kobo.640.1">testing</span></em><span class="koboSpan" id="kobo.641.1"> profile is used, the absolute minimum needed to install Drupal. </span><span class="koboSpan" id="kobo.641.2">You can also specify </span><em class="italic"><span class="koboSpan" id="kobo.642.1">minimal</span></em><span class="koboSpan" id="kobo.643.1"> or </span><em class="italic"><span class="koboSpan" id="kobo.644.1">standard</span></em><span class="koboSpan" id="kobo.645.1">, which</span><a id="_idIndexMarker864"/><span class="koboSpan" id="kobo.646.1"> installs either one of those profiles to use </span><span class="No-Break"><span class="koboSpan" id="kobo.647.1">in testing.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.648.1">Install profiles and testing</span></p>
<p class="callout"><span class="koboSpan" id="kobo.649.1">If you use install profiles that come with configurations or extras that create content types and roles, for example, be sure to not try to create them again in your test, with methods such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">createContentType</span></strong><span class="koboSpan" id="kobo.651.1">. </span><span class="koboSpan" id="kobo.651.2">In those cases, we will receive an error, since the install profile will have already </span><span class="No-Break"><span class="koboSpan" id="kobo.652.1">created them.</span></span></p>
<p><span class="koboSpan" id="kobo.653.1">Finally, you can also create your own install profile for testing that contains Drupal configuration files that you need – this is useful if you don’t want to write code in the state in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.654.1">setUp</span></strong><span class="koboSpan" id="kobo.655.1"> method of </span><span class="No-Break"><span class="koboSpan" id="kobo.656.1">the test.</span></span></p>
<p><span class="koboSpan" id="kobo.657.1">All we need for this test to run are the defaults, so </span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">run PHPUnit:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.659.1">
phpunit --testsuite functional --filter
  CamelCaseFormatterDisplayTest</span></pre>
<p><span class="koboSpan" id="kobo.660.1">This results in </span><span class="No-Break"><span class="koboSpan" id="kobo.661.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.662.1">
Testing
.           1 / 1 (100%)
Time: 00:07.390, Memory: 10.00 MB
OK (1 test, 3 assertions)</span></pre>
<p><span class="koboSpan" id="kobo.663.1">It passes, but do note that the total time to perform functional tests is far higher than unit or kernel tests. </span><span class="koboSpan" id="kobo.663.2">This is due to having to install a full version of Drupal to run the functional tests in. </span><span class="koboSpan" id="kobo.663.3">On this machine, it took 7 seconds with the core </span><em class="italic"><span class="koboSpan" id="kobo.664.1">testing</span></em><span class="koboSpan" id="kobo.665.1"> profile. </span><span class="koboSpan" id="kobo.665.2">If we switch to the core </span><em class="italic"><span class="koboSpan" id="kobo.666.1">standard</span></em><span class="koboSpan" id="kobo.667.1"> profile, which installs a lot more, we can see the </span><span class="No-Break"><span class="koboSpan" id="kobo.668.1">time increase:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.669.1">
protected $profile = 'standard';
Testing
.          1 / 1 (100%)
Time: 00:18.441, Memory: 10.00 MB
OK (1 test, 2 assertions)</span></pre>
<p><span class="koboSpan" id="kobo.670.1">The time elapsed is double over the smaller install profile. </span><span class="koboSpan" id="kobo.670.2">This is not necessarily a problem, but do </span><a id="_idIndexMarker865"/><span class="koboSpan" id="kobo.671.1">keep that in mind when writing tests. </span><span class="koboSpan" id="kobo.671.2">In the end, valuable tests and concrete feedback are worth a little extra time to make sure we get things right with </span><span class="No-Break"><span class="koboSpan" id="kobo.672.1">custom code.</span></span></p>
<h2 id="_idParaDest-409"><a id="_idTextAnchor441"/><span class="koboSpan" id="kobo.673.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.674.1">Functional tests are more robust than kernel tests. </span><span class="koboSpan" id="kobo.674.2">Like a kernel test, Drupal will install another copy of itself to run tests in, but the installation is more </span><em class="italic"><span class="koboSpan" id="kobo.675.1">full</span></em><span class="koboSpan" id="kobo.676.1"> or complete than a kernel test. </span><span class="koboSpan" id="kobo.676.2">These tests are run with a browser emulator called Mink, and that is how it is able to navigate URLs, check for HTML elements, and perform actions as if a real user were navigating </span><span class="No-Break"><span class="koboSpan" id="kobo.677.1">the site.</span></span></p>
<h2 id="_idParaDest-410"><a id="_idTextAnchor442"/><span class="koboSpan" id="kobo.678.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.679.1">There are many things you can do with functional tests (see the end of this chapter for ideas on how to </span><a id="_idIndexMarker866"/><span class="koboSpan" id="kobo.680.1">expand what we covered previously). </span><span class="koboSpan" id="kobo.680.2">However, Mink is not an actual browser and has no capability to run or react to JavaScript interactions. </span><span class="koboSpan" id="kobo.680.3">For example, if we had to hide the field text on the page after 5 seconds, or display the field value with AJAX, we would need to use a functional JavaScript test to </span><span class="No-Break"><span class="koboSpan" id="kobo.681.1">do that.</span></span></p>
<h1 id="_idParaDest-411"><a id="_idTextAnchor443"/><span class="koboSpan" id="kobo.682.1">Writing a functional JavaScript test</span></h1>
<p><span class="koboSpan" id="kobo.683.1">Assume that </span><a id="_idIndexMarker867"/><span class="koboSpan" id="kobo.684.1">you now have one last request. </span><span class="koboSpan" id="kobo.684.2">You have been asked to use AJAX to display the value from the Camel Case formatter 3 seconds after a user has visited </span><span class="No-Break"><span class="koboSpan" id="kobo.685.1">a page.</span></span></p>
<p><span class="koboSpan" id="kobo.686.1">Testing this requires using an actual browser such as Google Chrome. </span><span class="koboSpan" id="kobo.686.2">Checking anything that involves AJAX, cookies, user interactions, or the DOM cannot be done with a regular </span><span class="No-Break"><span class="koboSpan" id="kobo.687.1">functional test.</span></span></p>
<p><span class="koboSpan" id="kobo.688.1">Fortunately, writing a functional JavaScript test is not all that different; we just extend from a different base class for the test – </span><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">WebDriverTestBase</span></strong><span class="koboSpan" id="kobo.690.1"> instead </span><span class="No-Break"><span class="koboSpan" id="kobo.691.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.692.1">BrowserTestBase</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.693.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.694.1">Chrome and Selenium required</span></p>
<p class="callout"><span class="koboSpan" id="kobo.695.1">If you use DDEV, Lando, Docksal, or other ready made tools to run Drupal locally, check their documentation on how to best integrate Chrome and Selenium for functional JavaScript tests. </span><span class="koboSpan" id="kobo.695.2">They all have variations in approach to </span><span class="No-Break"><span class="koboSpan" id="kobo.696.1">installing them.</span></span></p>
<h2 id="_idParaDest-412"><a id="_idTextAnchor444"/><span class="koboSpan" id="kobo.697.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.698.1">In your </span><strong class="source-inline"><span class="koboSpan" id="kobo.699.1">tests/src</span></strong><span class="koboSpan" id="kobo.700.1"> directory, create a new directory named </span><strong class="source-inline"><span class="koboSpan" id="kobo.701.1">FunctionalJavascript</span></strong><span class="koboSpan" id="kobo.702.1">. </span><span class="koboSpan" id="kobo.702.2">Within that new directory, create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.703.1">CamelCaseFormatterDisplayAjaxTest.php</span></strong><span class="koboSpan" id="kobo.704.1">. </span><span class="koboSpan" id="kobo.704.2">You can copy the previous functional test code into this file, with </span><span class="No-Break"><span class="koboSpan" id="kobo.705.1">these changes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.706.1">Update </span><strong class="source-inline"><span class="koboSpan" id="kobo.707.1">namespace</span></strong><span class="koboSpan" id="kobo.708.1"> from </span><strong class="source-inline"><span class="koboSpan" id="kobo.709.1">Functional</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.710.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.711.1">FunctionalJavascript</span></strong></span></li>
<li><span class="koboSpan" id="kobo.712.1">Extend </span><strong class="source-inline"><span class="koboSpan" id="kobo.713.1">WebDriverTestBase</span></strong><span class="koboSpan" id="kobo.714.1"> instead </span><span class="No-Break"><span class="koboSpan" id="kobo.715.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.716.1">BrowserTestBase</span></strong></span></li>
<li><span class="koboSpan" id="kobo.717.1">The class name should be changed </span><span class="No-Break"><span class="koboSpan" id="kobo.718.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.719.1">CamelCaseFormatterDisplayAjaxTest</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.720.1">Since we now have a requirement to add JavaScript around the display of this text on the page, you can remove the old functional test, since it will fail. </span><span class="koboSpan" id="kobo.720.2">Text won’t be present on the page at first and the old test can’t listen or wait for AJAX, so we no longer need </span><span class="No-Break"><span class="koboSpan" id="kobo.721.1">that test.</span></span></p>
<p><span class="koboSpan" id="kobo.722.1">Now, we can update the test method to account for the new requirement. </span><span class="koboSpan" id="kobo.722.2">Assume that JavaScript has been written already and that the field value is fetched and output by AJAX. </span><span class="koboSpan" id="kobo.722.3">The implementation details are not important here, but we can change our test method to </span><em class="italic"><span class="koboSpan" id="kobo.723.1">wait</span></em><span class="koboSpan" id="kobo.724.1"> until AJAX has </span><a id="_idIndexMarker868"/><span class="koboSpan" id="kobo.725.1">completed before checking for text on </span><span class="No-Break"><span class="koboSpan" id="kobo.726.1">the page:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.727.1">
  public function testUserCanSeeFormattedString() {
    $this-&gt;drupalCreateNode(
      </span><a id="_idTextAnchor445"/><span class="koboSpan" id="kobo.728.1">[
        'type' =&gt; 'page',
        'field_chapter13_test' =&gt; 'A user entered string'
      ]
    );
    $this-&gt;drupalGet('/node/1');
    $this-&gt;assertSession()-&gt;assertWaitOnAjaxRequest();
    $this-&gt;a</span><a id="_idTextAnchor446"/><span class="koboSpan" id="kobo.729.1">ssertSession()-&gt;
        pageTextContains('aUserEnteredString');
  }</span></pre>
<p><span class="koboSpan" id="kobo.730.1">And after running our new test with PHPUnit, this is </span><span class="No-Break"><span class="koboSpan" id="kobo.731.1">the result:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.732.1">
Testing
.          1 / 1 (100%)
Time: 00:19.721, Memory: 10.00 MB
OK (1 test, 2 assertions)</span></pre>
<h2 id="_idParaDest-413"><a id="_idTextAnchor447"/><span class="koboSpan" id="kobo.733.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.734.1">Functional JavaScript tests are functional tests, with the added functionality of being run in a real browser such as Google Chrome. </span><span class="koboSpan" id="kobo.734.2">This is what makes it possible to assert even more tests for </span><a id="_idIndexMarker869"/><span class="koboSpan" id="kobo.735.1">HTML elements, interactivity, AJAX, cookies, and other features that require using a real browser to </span><span class="No-Break"><span class="koboSpan" id="kobo.736.1">perform actions.</span></span></p>
<h1 id="_idParaDest-414"><a id="_idTextAnchor448"/><span class="koboSpan" id="kobo.737.1">Writing a NightwatchJS test</span></h1>
<p><span class="koboSpan" id="kobo.738.1">Similar to a </span><a id="_idIndexMarker870"/><span class="koboSpan" id="kobo.739.1">functional JavaScript test, NightwatchJS uses Google Chrome to evaluate tests. </span><span class="koboSpan" id="kobo.739.2">However, instead of PHP files, the test files are written entirely in JavaScript and require NodeJS and </span><strong class="source-inline"><span class="koboSpan" id="kobo.740.1">yarn</span></strong><span class="koboSpan" id="kobo.741.1"> to run and </span><span class="No-Break"><span class="koboSpan" id="kobo.742.1">interact with.</span></span></p>
<h2 id="_idParaDest-415"><a id="_idTextAnchor449"/><span class="koboSpan" id="kobo.743.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.744.1">NightwatchJS is not included as part of PHPUnit, so you will need to install it </span><span class="No-Break"><span class="koboSpan" id="kobo.745.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.746.1">yarn</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.747.1">:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.748.1">Inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.749.1">/core</span></strong><span class="koboSpan" id="kobo.750.1"> folder, run </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.751.1">yarn install</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.752.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.753.1">Configure </span><strong class="bold"><span class="koboSpan" id="kobo.754.1">NightwatchJS</span></strong><span class="koboSpan" id="kobo.755.1"> settings by copying </span><strong class="source-inline"><span class="koboSpan" id="kobo.756.1">.env.example</span></strong><span class="koboSpan" id="kobo.757.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.758.1">.env</span></strong><span class="koboSpan" id="kobo.759.1"> and editing as necessary. </span><span class="koboSpan" id="kobo.759.2">These settings will mostly be the same as your local environment settings. </span><strong class="source-inline"><span class="koboSpan" id="kobo.760.1">DRUPAL_TEST_BASE_URL</span></strong><span class="koboSpan" id="kobo.761.1"> will be the value of your local site URL, </span><span class="No-Break"><span class="koboSpan" id="kobo.762.1">for example.</span></span></li>
</ol>
<h2 id="_idParaDest-416"><a id="_idTextAnchor450"/><span class="koboSpan" id="kobo.763.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.764.1">NightwatchJS looks for tests in the </span><span class="No-Break"><span class="koboSpan" id="kobo.765.1">following directories:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.766.1">mymodule/tests/src/Nightwatch/Tests</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.767.1">mymodule/tests/src/Nightwatch/Commands</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.768.1">mymodule/tests/src/Nightwatch/Assertions</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.769.1">mymodule/tests/src/Nightwatch/Pages</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.770.1">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.771.1">mymodule</span></strong><span class="koboSpan" id="kobo.772.1"> is your custom module name, like </span><strong class="source-inline"><span class="koboSpan" id="kobo.773.1">chapter13</span></strong><span class="koboSpan" id="kobo.774.1">, which we have been using for all the code in </span><span class="No-Break"><span class="koboSpan" id="kobo.775.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.776.1">You can run NightwatchJS tests </span><span class="No-Break"><span class="koboSpan" id="kobo.777.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.778.1">yarn</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.779.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.780.1">
yarn test:nightwatch (args)</span></pre>
<p><span class="koboSpan" id="kobo.781.1">Alternatively, you can run a single test – for example, a test in your </span><span class="No-Break"><span class="koboSpan" id="kobo.782.1">custom module:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.783.1">
yarn test:nightwatch mymodule/tests/src/Nightwatch/Tests/
  exampleTest.js</span></pre>
<p><span class="koboSpan" id="kobo.784.1">Let’s convert the </span><strong class="source-inline"><span class="koboSpan" id="kobo.785.1">CamelCase</span></strong><span class="koboSpan" id="kobo.786.1"> PHP class to a JavaScript function and test it </span><span class="No-Break"><span class="koboSpan" id="kobo.787.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.788.1">nightwatch</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.789.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.790.1">Create a directory called </span><strong class="source-inline"><span class="koboSpan" id="kobo.791.1">js</span></strong><span class="koboSpan" id="kobo.792.1"> at </span><strong class="source-inline"><span class="koboSpan" id="kobo.793.1">chapter13/js</span></strong><span class="koboSpan" id="kobo.794.1">. </span><span class="koboSpan" id="kobo.794.2">Inside, create a file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.795.1">camelCase.js</span></strong><span class="koboSpan" id="kobo.796.1">. </span><span class="koboSpan" id="kobo.796.2">The file </span><a id="_idIndexMarker871"/><span class="koboSpan" id="kobo.797.1">will contain the </span><span class="No-Break"><span class="koboSpan" id="kobo.798.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.799.1">
module.exports = (inputText) =&gt; {
  let text = inputText.toLowerCase();
  text = text.replace(/[, -]/g, '_');
  let extractedText = text.split('_').map(function(word,
    index) {
    if (index !== 0) {
      return word.charAt(0).toUpperCase() +
         word.slice(1).toLowerCase();
    } else {
      text = word;
    }
  }).join('');
  text = text.toLowerCase() + extractedText;
  return text.replace('_', '');
}</span></pre>
<p><span class="koboSpan" id="kobo.800.1">We can unit-test this JavaScript function just like we did with the PHP class at the start of the chapter. </span><span class="koboSpan" id="kobo.800.2">To do that, create a new directory under </span><strong class="source-inline"><span class="koboSpan" id="kobo.801.1">chapter13/tests/src/Nightwatch</span></strong><span class="koboSpan" id="kobo.802.1">, and within that directory, create another directory </span><span class="No-Break"><span class="koboSpan" id="kobo.803.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.804.1">Tests</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.805.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.806.1">Create a file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.807.1">Tests</span></strong><span class="koboSpan" id="kobo.808.1"> directory called </span><strong class="source-inline"><span class="koboSpan" id="kobo.809.1">CamelCaseTest.js</span></strong><span class="koboSpan" id="kobo.810.1">. </span><span class="koboSpan" id="kobo.810.2">It will look like this, getting the same result that we got from the previous functional </span><span class="No-Break"><span class="koboSpan" id="kobo.811.1">JavaScript test:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.812.1">
const assert = require('assert');
const camelCase = require('../../../js/camelCase');
const dataProvider = [
  {input: 'button_color', expected: 'buttonColor'},
  {input: 'snake_case_example', expected:
    'snakeCaseExample'},
  {input: 'ALL_CAPS_LOCK', expected: 'allCapsLock'},
  {input: 'foo-bar', expected: 'fooBar'},
];
module.exports = {
  '@tags': ['chapter13'],
  '@unitTest' : true,
  'Strings are converted to camelCase' : function (done) {
    dataProvider.forEach(function (values) {
      assert.strictEqual(camelCase(values.input),
          values.expected);
    });
    setTimeout(function() {
      done();
    }, 10);
  }
};</span></pre>
<p><span class="koboSpan" id="kobo.813.1">Now execute the </span><span class="No-Break"><span class="koboSpan" id="kobo.814.1">test with:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.815.1">
yarn test:nightwatch chapter13/tests/src/Nightwatch/Tests/
  CamelCaseTest.js</span></pre>
<p><span class="koboSpan" id="kobo.816.1">Nightwatch will execute the JavaScript function, loop over the </span><strong class="source-inline"><span class="koboSpan" id="kobo.817.1">dataProvider</span></strong><span class="koboSpan" id="kobo.818.1"> values, and assert that the function returns what we expect </span><span class="No-Break"><span class="koboSpan" id="kobo.819.1">it to:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.820.1">
yarn test:nightwatch ../modules/custom/chapter13/tests/src/
  Nightwatch/CamelCaseTest.js
yarn run v1.22.19
[Nightwatch/CamelCaseTest]
✔ Strings are converted to camelCase
Done in 3.77s.</span></pre>
<p><span class="koboSpan" id="kobo.821.1">This is useful for</span><a id="_idIndexMarker872"/><span class="koboSpan" id="kobo.822.1"> testing JavaScript functions you have written for your custom modules or themes. </span><span class="koboSpan" id="kobo.822.2">Testing JavaScript functions or behaviors can be a time-intensive task to do manually. </span><span class="koboSpan" id="kobo.822.3">NightwatchJS is handy for automating </span><span class="No-Break"><span class="koboSpan" id="kobo.823.1">that task.</span></span></p>
<h2 id="_idParaDest-417"><a id="_idTextAnchor451"/><span class="koboSpan" id="kobo.824.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.825.1">NightwatchJS is also capable of doing browser-based test assertions such as the functional JavaScript tests we discussed earlier in the chapter. </span><span class="koboSpan" id="kobo.825.2">There are caveats though, as the scope of JavaScript is more limited than a language such as PHP – depending on what you are trying to test, the test setup may take way longer than it would in PHP. </span><span class="koboSpan" id="kobo.825.3">You can certainly script your way there by using JavaScript in the test to log in as an admin and navigate Drupal to create fields, nodes, and elements, but this would take a </span><em class="italic"><span class="koboSpan" id="kobo.826.1">lot</span></em><span class="koboSpan" id="kobo.827.1"> of JavaScript to do, and it is more suitable to make your own install profile in </span><span class="No-Break"><span class="koboSpan" id="kobo.828.1">this case.</span></span></p>
<p><span class="koboSpan" id="kobo.829.1">Having said that, there are various tests in Drupal core that use NightwatchJS, so be sure to refer to them </span><a id="_idIndexMarker873"/><span class="koboSpan" id="kobo.830.1">for pointers, examples, </span><span class="No-Break"><span class="koboSpan" id="kobo.831.1">and ideas.</span></span></p>
<h3><span class="koboSpan" id="kobo.832.1">See also</span></h3>
<p><span class="koboSpan" id="kobo.833.1">You are not strictly limited to writing tests using PHPUnit or NightwatchJS for Drupal. </span><span class="koboSpan" id="kobo.833.2">There are many third-party test harnesses you can use to write and run tests for different use cases in Drupal. </span><span class="koboSpan" id="kobo.833.3">Be sure to check out </span><span class="No-Break"><span class="koboSpan" id="kobo.834.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.835.1">Behat </span><span class="No-Break"><span class="koboSpan" id="kobo.836.1">Drupal Extension</span></span></li>
<li><span class="koboSpan" id="kobo.837.1">Drupal </span><span class="No-Break"><span class="koboSpan" id="kobo.838.1">Test Traits</span></span></li>
<li><a href="https://Cypress.io"><span class="No-Break"><span class="koboSpan" id="kobo.839.1">Cypress.io</span></span></a></li>
</ul>
</div>
</body></html>