<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Database Architecture, Models, and CLI Applications"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Database Architecture, Models, and CLI Applications</h1></div></div></div><p>Now that we know the basics of Phalcon's ORM and ODM, we can create the database architecture and most of the models needed for our project. We will also create some CLI tasks in order to help us work faster. Because there is a large amount of code, when referring to some of the parts in <a class="link" href="ch01.html" title="Chapter 1. Getting Started with Phalcon">Chapter 1</a>, <span class="emphasis"><em>Getting Started with Phalcon</em></span>, I will use the abbreviation <a id="id239" class="indexterm"/>
<span class="strong"><strong>CSC</strong></span> (<span class="strong"><strong>check source code</strong></span>).</p><p>We will cover the following topics in the chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The database architecture</li><li class="listitem" style="list-style-type: disc">Models</li><li class="listitem" style="list-style-type: disc">CLI applications</li></ul></div><div class="section" title="The database architecture"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec31"/>The database architecture</h1></div></div></div><p>The main goal of this book is to<a id="id240" class="indexterm"/> learn by example and we are achieving this by developing an online news/magazine website. We will assume the following tables as mandatory:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">User</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">UserGroup</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">UserProfile</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Article</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ArticleCategory</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ArticleTranslation</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ArticleCategoryArticle</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Hashtag</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ArticleHashtagArticle</code></li></ul></div><p>These are basic tables, and we will add a few more in the later chapters. I like to use singular terms as part of the naming convention, but it's a matter of choice. To work faster, I recommend tools such as PhpMyAdmin or MySQL Workbench. Let's start with the first table.</p><div class="section" title="The User table"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec31"/>The User table</h2></div></div></div><p>The <code class="literal">User</code> table<a id="id241" class="indexterm"/> will <a id="id242" class="indexterm"/>hold basic information about a user:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CREATE TABLE IF NOT EXISTS `user` (</strong></span>
<span class="strong"><strong>  `id` int(11) NOT NULL AUTO_INCREMENT,</strong></span>
<span class="strong"><strong>  `user_first_name` varchar(16) COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>  `user_last_name` varchar(16) COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>  `user_email` varchar(32) COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>  `user_password` varchar(128) COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>  `user_group_id` int(11) DEFAULT NULL,</strong></span>
<span class="strong"><strong>  `user_is_active` tinyint(1) NOT NULL DEFAULT '0',</strong></span>
<span class="strong"><strong>  `user_created_at` datetime NOT NULL,</strong></span>
<span class="strong"><strong>  `user_updated_at` datetime DEFAULT NULL,</strong></span>
<span class="strong"><strong>  PRIMARY KEY (`id`),</strong></span>
<span class="strong"><strong>  UNIQUE KEY `idx_email` (`user_email`),</strong></span>
<span class="strong"><strong>  KEY `idx_user_group_id` (`user_group_id`),</strong></span>
<span class="strong"><strong>  KEY `idx_is_active` (`user_is_active`)</strong></span>
<span class="strong"><strong>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci AUTO_INCREMENT=1 ;</strong></span>
</pre></div><p>The <code class="literal">group_id</code> and <code class="literal">profile_id</code> fields will have a relation to the <code class="literal">UserGroup</code> and <code class="literal">UserProfile</code> tables. After we have created these tables, we will also create the relations.</p></div><div class="section" title="The UserGroup table"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec32"/>The UserGroup table</h2></div></div></div><p>The <code class="literal">UserGroup</code> table <a id="id243" class="indexterm"/>will hold <a id="id244" class="indexterm"/>information about user groups, and each user will be part of one of the available groups. We are not going to use one-to-many relationship between users and groups, but if you need them, feel free to implement them:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CREATE TABLE IF NOT EXISTS `user_group` (</strong></span>
<span class="strong"><strong>  `id` int(11) NOT NULL AUTO_INCREMENT,</strong></span>
<span class="strong"><strong>  `user_group_name` varchar(16) COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>  `user_group_created_at` datetime NOT NULL,</strong></span>
<span class="strong"><strong>  `user_group_updated_at` datetime DEFAULT NULL,</strong></span>
<span class="strong"><strong>  PRIMARY KEY (`id`)</strong></span>
<span class="strong"><strong>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci AUTO_INCREMENT=1 ;</strong></span>
</pre></div></div><div class="section" title="The UserProfile table"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec33"/>The UserProfile table</h2></div></div></div><p><code class="literal">UserProfile</code> is useful if you <a id="id245" class="indexterm"/>want a profile for the user. We are <a id="id246" class="indexterm"/>going to hold information about the user's location and date of birth:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CREATE TABLE IF NOT EXISTS `user_profile` (</strong></span>
<span class="strong"><strong>  `id` int(11) NOT NULL AUTO_INCREMENT,</strong></span>
<span class="strong"><strong>  `user_profile_user_id` int(11) NOT NULL,</strong></span>
<span class="strong"><strong>  `user_profile_location` varchar(64) COLLATE utf8_unicode_ci NOT NULL,</strong></span>
<span class="strong"><strong>  `user_profile_birthday` date NOT NULL,</strong></span>
<span class="strong"><strong>  `user_profile_created_at` datetime NOT NULL,</strong></span>
<span class="strong"><strong>  `user_profile_updated_at` datetime DEFAULT NULL,</strong></span>
<span class="strong"><strong>  PRIMARY KEY (`id`),</strong></span>
<span class="strong"><strong>  UNIQUE KEY `idx_user_profile_user_id` (`user_profile_user_id`)</strong></span>
<span class="strong"><strong>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci AUTO_INCREMENT=1 ;</strong></span>
</pre></div><p>For simplicity, the user location field will be free text, not a location based on coordinates. Now that we have all the user tables, let's create the relations/constraints between them:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ALTER TABLE `user_profile`</strong></span>
<span class="strong"><strong>  ADD CONSTRAINT `user_profile_ibfk_1` FOREIGN KEY (`user_profile_user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION;</strong></span>

<span class="strong"><strong>ALTER TABLE `user`</strong></span>
<span class="strong"><strong>  ADD CONSTRAINT `user_ibfk_2` FOREIGN KEY (`user_profile_id`) REFERENCES `user_profile` (`id`) ON UPDATE NO ACTION,</strong></span>
<span class="strong"><strong>  ADD CONSTRAINT `user_ibfk_1` FOREIGN KEY (`user_group_id`) REFERENCES `user_group` (`id`) ON UPDATE NO ACTION;</strong></span>
</pre></div><p>Finally, your database structure should look like what is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_04_01.jpg" alt="The UserProfile table"/></div></div></div></div>
<div class="section" title="Models"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec32"/>Models</h1></div></div></div><p>Now that we have the user architecture, before <a id="id247" class="indexterm"/>we continue with the rest of the database, let's create the models and a simple CLI task to register a new user.</p><p>If you have already installed the Phalcon Developer Tools, you can use them to generate models, or you can manually create them. You can also find them in the source code for this chapter.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip14"/>Tip</h3><p>Using the model generator will not create relations between tables. You have to manually create them.</p></div></div><p>All our models will extend the <code class="literal">Base</code> models created in the previous chapter. Next, I will show you a few lines of code containing the important parts of the models, excluding the getters, setters, and protected variables.</p><div class="section" title="The User model"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec34"/>The User model</h2></div></div></div><p>The <code class="literal">User</code> model will be<a id="id248" class="indexterm"/> located <a id="id249" class="indexterm"/>under the <code class="literal">App\Core\Models</code> namespace in the <code class="literal">apps/Core/Models/</code> directory:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models;

class User extends Base {
  public static function find($parameters = array()) {
    return parent::find($parameters);
  }

  public static function findFirst($parameters = array()) {
    return parent::findFirst($parameters);
  }

  public function initialize() {
    $this-&gt;hasOne('id', 'App\Core\Models\UserProfile', 'user_profile_user_id', array(
        'alias' =&gt; 'profile',
        'reusable' =&gt; true
    ));

    $this-&gt;hasOne('user_group_id', 'App\Core\Models\UserGroups', 'id', array(
      'alias' =&gt; 'group',
      'reusable' =&gt; true
    ));
  }
}</pre></div><p>The <code class="literal">initialize()</code> method acts like a constructor, so here we will put most of the code that we need to execute when the model is loaded.</p><p>In the preceding example, we created relations between the models in the <code class="literal">initialize()</code> method. We have already talked about <a id="id250" class="indexterm"/>relations, but you can always read more on the official website at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/models.html#relationships-between-models">http://docs.phalconphp.com/en/latest/reference/models.html#relationships-between-models</a>.</p><p>The model contains two other methods for quick access (<code class="literal">find</code> and <code class="literal">findFirst</code>). Remember that Phalcon's ORM supports calls using magic methods, for example, if you want to find a user by ID, you can use <code class="literal">findFirstById()</code>; if you want to find the first user by e-mail, you can use <code class="literal">findFirstByEmail()</code>; and so on.</p><p>The <code class="literal">find()</code> and <code class="literal">findFirst()</code> methods are automatically created if you generate the model using the Phalcon Developer Tools.</p></div><div class="section" title="The UserGroup model"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec35"/>The UserGroup model</h2></div></div></div><p><code class="literal">UserGroup</code> will be<a id="id251" class="indexterm"/> located under the <code class="literal">App\Core\Models</code> namespace in <a id="id252" class="indexterm"/>the <code class="literal">apps/Core/Models/</code> directory:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models;

class UserGroup extends Base{
  public static function find($parameters = array()){
    return parent::find($parameters);
  }
  public static function findFirst($parameters = array()){
    return parent::findFirst($parameters);
  }
  public function initialize(){
    $this-&gt;hasMany('id', 'App\Core\Models\User', 'group_id',array(
        'alias' =&gt; 'users'
    ));
  }
}</pre></div><p>This model has a 1-n relationship with users, which means that when you invoke <code class="literal">$group-&gt;users</code>, the command will return the names of all the users assigned to the <code class="literal">users</code> group.</p></div><div class="section" title="The UserProfile model"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec36"/>The UserProfile model</h2></div></div></div><p>The <code class="literal">UserProfile</code> model <a id="id253" class="indexterm"/>will be<a id="id254" class="indexterm"/> located under the <code class="literal">App\Core\Models</code> namespace in the <code class="literal">apps/Core/Models/</code> directory:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models;

class UserProfile extends Base
{
    public static function find($parameters = array())
    {
        return parent::find($parameters);
    }

    public static function findFirst($parameters = array())
    {
        return parent::findFirst($parameters);
    }

    public function initialize()
    {
        $this-&gt;hasOne('user_profile_user_id', 'App\Core\Models\User', 'id', array(
            'alias' =&gt; 'user',
            'reusable' =&gt; true
        ));
    }
}</pre></div><p>The <code class="literal">UserProfile</code> model has a 1-1 relationship with the user, which means that a profile is tightly coupled to a single user.</p><p>We're all set. Let's <a id="id255" class="indexterm"/>take a look at our <code class="literal">modules\Core\Models</code> directory <a id="id256" class="indexterm"/>structure. It should look like this:</p><div class="mediaobject"><img src="graphics/B03522_04_02.jpg" alt="The UserProfile model"/></div><p><code class="literal">Article.php</code> is in the list because we created it in the previous chapter. We can now go forward and create a CLI task to register a new user.</p><p>In general, you develop CLI applications to be used within cron jobs, to create utilities, and so on. We are going to develop a few tasks in this book for different situations. One of them is for registering a new user via command line.</p></div><div class="section" title="Registering a new user"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec37"/>Registering a new user</h2></div></div></div><p>Create a new <a id="id257" class="indexterm"/>directory named <code class="literal">Task</code> in the <code class="literal">modules\</code> folder:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd modules</strong></span>
<span class="strong"><strong>$ mkdir Task</strong></span>
</pre></div><p>Go to the <code class="literal">Task</code> directory, create a new file named <code class="literal">BaseTask.php</code>, and append the following content to it:</p><div class="informalexample"><pre class="programlisting">&lt;?php

class BaseTask extends \Phalcon\CLI\Task
{
    public function consoleLog($s_message, $color = 'green', $endline = true)
    {
        $start      = "\033[";
        $end        = "\033[0m\n";
        $bash_color = '0;32';
        $colors = array(
            'green'  =&gt; '0;32',
            'red'    =&gt; '0;31',
            'yellow' =&gt; '0;33',
            'blue'   =&gt; '0;34',
            'grey'   =&gt; '0;30',
        );
        if (isset($colors[$color])) {
            $bash_color = $colors[$color];
        }
        echo $start, $bash_color, 'm', $s_message;
        if ($endline) echo $end;
    }

    public function countdown($time)
    {
        for ($i=1;$i&lt;=$time;$i++) {
            sleep(1);
            $this-&gt;consoleLog(($time-$i).' seconds left ...', 'red');
        }
    }

    public function quit($s_message)
    {
        $this-&gt;consoleLog($s_message, 'red');
        exit;
    }

    public function log($s_message, $log_file='/tmp/app.log')
    {
        error_log(PHP_EOL.$s_message.PHP_EOL, 3, $log_file);
    }

    protected function confirm($message='Are you sure you want to process it')
    {
        echo "\033[0;31m".$message.' [y/N]: '."\033[0m";

        $confirmation = trim( fgets( STDIN ) );
        if ($confirmation !== 'y') {
            exit (0);
        }
    }
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note11"/>Note</h3><p>I wrote the content of this file a few years ago to "prettify" my command-line scripts a bit. If you are not happy with it, please feel free to remove it or change it.</p></div></div><p>Next, we are going to <a id="id258" class="indexterm"/>need a bootstrap for our CLI application, but before we do that, we need to install some dependencies. Assuming that you have installed <a id="id259" class="indexterm"/>Composer (<a class="ulink" href="http://getcomposer.org">http://getcomposer.org</a>), edit <code class="literal">composer.json</code> and add this content:</p><div class="informalexample"><pre class="programlisting">{
    "require": {
        "phalcon/incubator": "dev-master",
        "crada/php-apidoc": "@dev"
    }
}</pre></div><p>Update Composer by using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php composer.phar update</strong></span>
</pre></div><p>Go back to the <code class="literal">modules\</code> folder and create a new file named <code class="literal">cli.php</code>.</p><p>We will try to split and explain the contents of the following code:</p><div class="informalexample"><pre class="programlisting">#!/usr/bin/env php
&lt;?php
umask(0022);
set_time_limit(1200);
require_once __DIR__.'/../vendor/autoload.php';

use Phalcon\DI\FactoryDefault\CLI as CliDI;
use Phalcon\CLI\Console as ConsoleApp;
use Crada\Apidoc\Extractor;</pre></div><p>In these first lines, we <a id="id260" class="indexterm"/>include the autoloader generated by Composer and make use of Phalcon's DI and CLI and the <code class="literal">Extractor</code> helper, which will be needed to parse annotation comments for the methods:</p><div class="informalexample"><pre class="programlisting">class Cli
{
    private $arguments;
    private $params;
    private $console;

    public function __construct($argv)
    {
        $di = new CliDI();

        include __DIR__ .'/../config/loader.php';
        $config  = include __DIR__ . '/../config/config.php';

        $di-&gt;set('config', $config);

        include __DIR__ . '/../config/services.php';

        $console = new ConsoleApp();
        $console-&gt;setDI($di);

        foreach ($argv as $k =&gt; $arg) {
            if ($k == 1) {
                $this-&gt;arguments['task'] = $arg;
            } elseif ($k == 2) {
                $this-&gt;arguments['action'] = $arg;
            } elseif ($k &gt;= 3) {
                $this-&gt;params[] = $arg;
            }
        }

        if (count($this-&gt;params) &gt; 0) {
            $this-&gt;arguments['params'] = $this-&gt;params;
        }

        $this-&gt;console = $console;
    }</pre></div><p>The preceding class<a id="id261" class="indexterm"/> constructor will set up the DI for us and load the configuration files needed to run the tasks. It will also read any argument assigned to a task:</p><div class="informalexample"><pre class="programlisting">public function readTasks() {
  if ($handle = opendir(__DIR__.'/Task/')) {

    require_once __DIR__.'/Task/BaseTask.php';
    $util = new BaseTask();
    $util-&gt;consoleLog('Learning Phalcon CLI','grey');
    $util-&gt;consoleLog(str_repeat('-', 80),'grey');

    while (false !== ($entry = readdir($handle))) {
      if ($entry != '.' &amp;&amp; $entry != '..' &amp;&amp; $entry != 'BaseTask.php' &amp;&amp; preg_match("/\.php$/",$entry)) {
      $entries[] = $entry;
                }
            }

            asort($entries);

            $charCountActionName = 0;

            foreach ($entries as $entry) {
                $task = str_replace('Task.php', '', $entry);

                require_once __DIR__.'/Task/'.$entry;
                $tmp_className = str_replace('.php','',$entry);
                $tmp = new $tmp_className();

                $taskName = PHP_EOL.strtolower(preg_replace('/\B([A-Z])/', '_$1', $task));
                $taskDescription = '';

$util-&gt;consoleLog(str_pad($taskName, 
  25).$taskDescription, 'yellow');
$st_classMethods = get_class_methods($tmp);
asort($st_classMethods);
foreach ($st_classMethods as $value) {
  if (preg_match('/Action/', $value)) {
    $theActionName = str_pad(str_replace('Action', 
      '', $value), 6);
    if (strlen($theActionName) &gt; 
      $charCountActionName) {

        $charCountActionName = strlen(
          $theActionName);
      }
    }
  }
  foreach ($st_classMethods as $value) {
    if (preg_match('/Action/', $value)) {
      $theActionName = str_replace('Action', '', 
        $value);
      $theActionDescription = '';
      $annotations = Extractor::getMethodAnnotations(
        $tmp_className, $value);
      if (count($annotations) &gt; 0) {
        foreach ($annotations as $key =&gt; 
          $st_values) {

          if ($key == 'Description') {
            $theActionDescription .= implode(', ', $st_values);
          }
        }
      }
      $util-&gt;consoleLog(str_pad($theActionName, 
      $charCountActionName + 5)."\033[
        0;28m".$theActionDescription, 'green');
         }
        }
      }
    closedir($handle);
  }
}</pre></div><p>We use the <code class="literal">readTask</code> method to<a id="id262" class="indexterm"/> read the annotation from each task and to list the tasks available in our application. By executing <code class="literal">$</code> <code class="literal">php</code> <code class="literal">modules/cli.php</code> in your terminal, you will understand the purpose of this method better:</p><div class="informalexample"><pre class="programlisting">    public function getArguments()
    {
        return $this-&gt;arguments;
    }

    public function getConsole()
    {
        return $this-&gt;console;
    }
}</pre></div><p>Finally, we need to<a id="id263" class="indexterm"/> initialize our newly created class. We do this with the help of the next few lines:</p><div class="informalexample"><pre class="programlisting">try {
    $cli       = new Cli($argv);
    $arguments = $cli-&gt;getArguments();

    if (0 === count($arguments)) {
        $cli-&gt;readTasks();
    } else {
        $console = $cli-&gt;getConsole();
        $console-&gt;handle($arguments);
    }
} catch (\Phalcon\Exception $e) {
    echo $e-&gt;getMessage();
}</pre></div><p>…</p><p>We need to register the new task folder. Open the <code class="literal">config/loader.php</code> file and add this content:</p><div class="informalexample"><pre class="programlisting">$loader-&gt;registerDirs(array(
    __DIR__ . '/../modules/Task/'
));</pre></div><p>We're now ready to create our first task. Let's create a test task just to be sure that our code is working. Go to the <code class="literal">modules/Task/</code> folder and create a new file named <code class="literal">UserTask.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class UserTask extends BaseTask
{
    /**
     * @Description("Test action")
     */
    public function testAction()
    {
        $this-&gt;consoleLog('OK');
    }
}</pre></div><p>Execute the task <a id="id264" class="indexterm"/>from your project root folder:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php modules/cli.php user test</strong></span>
</pre></div><p>You should see something similar to the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_04_03.jpg" alt="Registering a new user"/></div><p>So far, we have the database structure and the models for the <code class="literal">user*</code> tables. We also have a working CLI application and a dummy test task. We can move forward with the user task.</p><p>Next, we are going to develop a user registration process that can be accessed from a CLI. The first thing we need to do is implement a registration method in our manager. This manager does not exist yet, but we will create it in <code class="literal">modules/Core/Managers/</code>, where <code class="literal">ArticleManager.php</code> resides (from the previous chapter).</p><p>Go to <code class="literal">modules/Core/Managers/</code> and create a new file named <code class="literal">UserManager.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Managers;

use \App\Core\Models\User;
use \App\Core\Models\UserGroup;
use \App\Core\Models\UserProfile;

class UserManager extends BaseManager
{
    public function find($parameters = null)
    {
        return User::find($parameters);
    }

    /**
     * Create a new user
     *
     * @param  array                           $data
     * @return string|\App\Core\Models\User
     */
    public function create($data)
    {
        $security = $this-&gt;getDI()-&gt;get('security');

        $user = new User();
        $user-&gt;setUserFirstName($data['user_first_name']);
        $user-&gt;setUserLastName($data['user_last_name']);
        $user-&gt;setUserEmail($data['user_email']);
        $user-&gt;setUserPassword($security-&gt;hash($data[
       'user_password']));
        $user-&gt;setUserIsActive($data['user_is_active']);

        if (false === $user-&gt;create()) {
            foreach ($user-&gt;getMessages() as $message) {
                $error[] = (string) $message;
            }

            throw new \Exception(json_encode($error));

        }

        return $user;
    }
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip15"/>Tip</h3><p>Note that we are using the security service to hash the user's password. The <code class="literal">hash</code> method uses the bcrypt algorithm.</p></div></div><p>After this, we <a id="id265" class="indexterm"/>need to register the newly created manager. To do this, open the service file located at <code class="literal">config/service.php</code> and add the following content:</p><div class="informalexample"><pre class="programlisting">$di['core_user_manager'] = function () {
    return new \App\Core\Managers\UserManager();
};</pre></div><p>Now we can<a id="id266" class="indexterm"/> implement the user creation task. Open <code class="literal">modules/Task/UserTask.php</code> and append the following content:</p><div class="informalexample"><pre class="programlisting">/**
 * @Description("Create a new user")
 * @Example("php modules/cli.php user create F_NAME L_NAME EMAIL@DOMAIN.TLD PASSWORD IS_ACTIVE")
*/
public function createAction($params = null) {
  if (!is_array($params) || count($params) &lt; 5) {
    $this-&gt;quit('Usage: php modules/cli.php user create F_NAME L_NAME EMAIL@DOMAIN.TLD PASSWORD IS_ACTIVE');
  }

  $this-&gt;confirm('You will create a user with the following data: '.implode(' | ', $params));

  $manager = $this-&gt;getDI()-&gt;get('core_user_manager');

  try {
    $user = $manager-&gt;create(array(
      'user_first_name' =&gt; $params[0],
      'user_last_name' =&gt; $params[1],
      'user_email' =&gt; $params[2],
      'user_password' =&gt; $params[3],
      'user_is_active' =&gt; $params[4],
    ));

    $this-&gt;consoleLog(sprintf(
      "User %s %s has been created. ID: %d",
      $user-&gt;getUserFirstName(),
      $user-&gt;getUserLastName(),
      $user-&gt;getId()
    ));

    } catch (\Exception $e) {
      $this-&gt;consoleLog("There were some errors creating the user: ","red");
      $errors = json_decode($e-&gt;getMessage(), true);
      foreach ($errors as $error) {
        $this-&gt;consoleLog("  - $error", "red");
    }
  }
}</pre></div><p>In the first two lines of the <code class="literal">createAction()</code> method, we just make a simple validation of parameters and ask the developer for a confirmation of the input. You can now execute the task:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php modules/cli.php user create john doe john.doe@john.tld P@ss0rd!1</strong></span>
</pre></div><p>But you will get<a id="id267" class="indexterm"/> an error similar to the one shown in this screenshot:</p><div class="mediaobject"><img src="graphics/B03522_04_04.jpg" alt="Registering a new user"/></div><p>The <code class="literal">user_created_at</code> <code class="literal">is</code> <code class="literal">required</code> exception is thrown, because in our <code class="literal">create()</code> method from the user manager, we didn't add this field—and we are not going to add it. Instead, we are going to use Phalcon's "timestampable" behavior.</p><p>Open the <code class="literal">User</code> model (<code class="literal">modules/Core/Models/User.php</code>) and add the following code to the <code class="literal">initialize()</code> method:</p><div class="informalexample"><pre class="programlisting">$this-&gt;addBehavior(new Timestampable(array(
  'beforeValidationOnCreate' =&gt; array(
    'field' =&gt; 'user_created_at',
    'format' =&gt; 'Y-m-d H:i:s'
  ),
  'beforeValidationOnUpdate' =&gt; array(
    'field' =&gt; 'user_updated_at',
    'format' =&gt; 'Y-m-d H:i:s'
  ),
)));</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note12"/>Note</h3><p>Add this behavior to all the models where we are using <code class="literal">*_created_at</code> and <code class="literal">*_updated_at</code>. Also, don't forget to make use of <code class="literal">use</code> <code class="literal">\Phalcon\Mvc\Model\Behavior\Timestampable;</code>.</p></div></div><p>Now, you can execute the user creation task again. If everything goes OK, you should see something similar to the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_04_05.jpg" alt="Registering a new user"/></div><p>We now have a<a id="id268" class="indexterm"/> functional CLI application for a user and a user manager, but the user has no profile and no group. We will modify the <code class="literal">create()</code> method from the user manager to be able to assign groups and create a profile. Because the <code class="literal">user_group</code> table is empty, we need to insert some data:</p><div class="informalexample"><pre class="programlisting">INSERT INTO `user_group` (`id`, `user_group_name`, `user_group_created_at`, `user_group_updated_at`) VALUES
(1, 'User', '2015-01-13 00:00:00', NULL);</pre></div><p>Here, we created a new group named <code class="literal">User</code>. This will be the default group. Next, we will modify the <code class="literal">create()</code> method from the user manager to be able to assign an existing group to a user. The new <code class="literal">create()</code> method will look like this:</p><div class="informalexample"><pre class="programlisting">public function create($data, $user_group_name = 'User') {
  $security = $this-&gt;getDI()-&gt;get('security');

  $user = new User();
  $user-&gt;setUserFirstName($data['user_first_name']);
  $user-&gt;setUserLastName($data['user_last_name']);
  $user-&gt;setUserEmail($data['user_email']);
  $user-&gt;setUserPassword($security-&gt;hash($data['user_password']));
  $user-&gt;setUserIsActive($data['user_is_active']);

<span class="strong"><strong>  $user_group_id = $this-&gt;findFirstGroupByName($user_group_name)-&gt;getId();</strong></span>
<span class="strong"><strong>  $user-&gt;setUserGroupId($user_group_id);</strong></span>

  if (false === $user-&gt;create()) {
    foreach ($user-&gt;getMessages() as $message) {
      $error[] = (string) $message;
    }

    throw new \Exception(json_encode($error));

  }
  return $user;
}</pre></div><p>We also need to create the <code class="literal">findFirstGroupByName()</code> method. Append the following content to the <code class="literal">UserManager.php</code> file:</p><div class="informalexample"><pre class="programlisting">public function findFirstGroupByName($user_group_name) {
  return UserGroup::findFirstByUserGroupName($user_group_name);
}</pre></div><p>Before we run the <code class="literal">user create</code> task again, we need to ensure data integrity, avoiding duplicate e-mails. Because of the database structure, we are not allowed to insert duplicate records (the <code class="literal">email</code> column is unique), and the <code class="literal">create()</code> method will throw a SQL exception similar to <code class="literal">SQLSTATE[23000]:</code> <code class="literal">Integrity</code> <code class="literal">constraint</code> <code class="literal">violation:</code> <code class="literal">1062</code> <code class="literal">Duplicate</code> <code class="literal">entry</code> <code class="literal">'john.doe@john.tld'</code> <code class="literal">for</code> <code class="literal">key</code> <code class="literal">'idx_email'</code>.</p><p>To avoid this, we <a id="id269" class="indexterm"/>will make use of the built-in validators. In this case, we will implement two of them: a uniqueness validator and an e-mail validator, both for the <code class="literal">user_email</code> column. We achieve this by adding the following code to the user model in the <code class="literal">modules/Core/Models/User.php</code> file:</p><div class="informalexample"><pre class="programlisting">public function validation() {
  $this-&gt;validate(new \Phalcon\Mvc\Model\Validator\Email(array(
    "field" =&gt; "user_email",
    "message" =&gt; "Invalid email address"
  )));

  $this-&gt;validate(new \Phalcon\Mvc\Model\Validator\Uniqueness(array(
    "field" =&gt; "user_email",
    "message" =&gt; "The email is already registered"
  )));

  return $this-&gt;validationHasFailed() != true;
}</pre></div><p>Now that we have a validator, we can be sure that an e-mail has the correct format and it does exist in our database. Let's execute the same task to see what happens:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php modules/cli.php user create john doe john.doe@john.tld P@ss0rd!1</strong></span>
</pre></div><p>If you did everything well, you should see a response similar to the one presented in the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_04_12.jpg" alt="Registering a new user"/></div><p>Now, execute the task again by changing the e-mail address and checking whether the group ID has been assigned to the new user. Let's call it <code class="literal">me@me.com</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php modules/cli.php user create john doe me@me.com P@ss0rd! 1</strong></span>
</pre></div><p>If you get a response similar to the one shown in the following screenshot, it means that you have done a great job!:</p><div class="mediaobject"><img src="graphics/B03522_04_06.jpg" alt="Registering a new user"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip16"/>Tip</h3><p>You can read more<a id="id270" class="indexterm"/> about validating data integrity at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/models.html#validating-data-integrity">http://docs.phalconphp.com/en/latest/reference/models.html#validating-data-integrity</a>.</p></div></div></div><div class="section" title="Creating a user profile"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec38"/>Creating a user profile</h2></div></div></div><p>What we need to do next is <a id="id271" class="indexterm"/>repeat almost the same process to create a user profile. The final <code class="literal">create()</code> method in <code class="literal">UserManager.php</code> should look like this:</p><div class="informalexample"><pre class="programlisting">public function create($data, $user_group_name = 'User') {
  $security = $this-&gt;getDI()-&gt;get('security');

  $user = new User();
  $user-&gt;setUserFirstName($data['user_first_name']);
  $user-&gt;setUserLastName($data['user_last_name']);
  $user-&gt;setUserEmail($data['user_email']);
  $user-&gt;setUserPassword($security-&gt;hash($data['user_password']));
  $user-&gt;setUserIsActive($data['user_is_active']);

  $user_group_id = $this-&gt;findFirstGroupByName($user_group_name)-&gt;getId();
  $user-&gt;setUserGroupId($user_group_id);

<span class="strong"><strong>  $profile = new UserProfile();</strong></span>
<span class="strong"><strong>  $profile-&gt;setUserProfileLocation($data['user_profile_location']);</strong></span>
<span class="strong"><strong>  $profile-&gt;setUserProfileBirthday($data['user_profile_birthday']);</strong></span>

<span class="strong"><strong>  $user-&gt;profile = $profile;</strong></span>

  return $this-&gt;save($user);
}</pre></div><p>To avoid code repetition, we will create a <code class="literal">save()</code> method in the <code class="literal">BaseManager</code> file. Open <code class="literal">modules/Core/Managers/BaseManager.php</code> and append the following code:</p><div class="informalexample"><pre class="programlisting">public function save($object, $type = 'save') {
  switch($type) {
    case 'save':
      $result = $object-&gt;save();
      break;
    case 'create':
      $result = $object-&gt;create();
      break;
    case 'update':
      $result = $object-&gt;update();
      break;
  }

  if (false === $result) {
    foreach ($object-&gt;getMessages() as $message) {
      $error[] = (string) $message;
    }

    throw new \Exception(json_encode($error));
  }

  return $object;
}</pre></div><p>One last change <a id="id272" class="indexterm"/>we need to make is in the <code class="literal">UserTask.php</code> file. Open it and update the <code class="literal">createAction()</code> method by replacing the <code class="literal">$user</code> <code class="literal">=</code> <code class="literal">$manager-&gt;create</code> <code class="literal">…</code> block of code with the following code:</p><div class="informalexample"><pre class="programlisting">$user = $manager-&gt;create(array(
  'user_first_name' =&gt; $params[0],
  'user_last_name' =&gt; $params[1],
  'user_email' =&gt; $params[2],
  'user_password' =&gt; $params[3],
  'user_is_active' =&gt; $params[4],
  'user_profile_location' =&gt; $params[5],
  'user_profile_birthday' =&gt; $params[6],
));</pre></div><p>We can try to execute the task again and test whether the new user has been created and a profile has also been created:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php modules/cli.php user create john doe other@email.com P@ss0rd! 1 Barcelona 1985-03-25</strong></span>
</pre></div><p>You should see something like this:</p><div class="mediaobject"><img src="graphics/B03522_04_07.jpg" alt="Creating a user profile"/></div><p>If you check out the records in the database, you should get a profile linked to the user, as follows:</p><div class="mediaobject"><img src="graphics/B03522_04_08.jpg" alt="Creating a user profile"/></div><p>Remember that when you <a id="id273" class="indexterm"/>create or update a record using the ORM, it is not mandatory to use the setters. Phalcon has a method named <code class="literal">assign()</code> that accepts the <code class="literal">key</code> <code class="literal">=&gt;</code> <code class="literal">value</code> array, where the key is the column name as defined in the table structure, for example, our <code class="literal">create()</code> method can also look like this:</p><div class="informalexample"><pre class="programlisting">public function create($data, $user_group_name = 'User') {
  $security = $this-&gt;getDI()-&gt;get('security');

  $user = new User();
  $user-&gt;assign(array(
    'user_first_name' =&gt; $data['user_first_name'],
    'user_last_name'  =&gt; $data['user_last_name'],
    'user_email'      =&gt; $data['user_email'],
    'user_password'   =&gt; $security-&gt;hash($data['user_password']),
    'user_is_active'  =&gt; $data['user_is_active']
  ));

  $user_group_id = $this-&gt;findFirstGroupByName($user_group_name)-&gt;getId();
  $user-&gt;setUserGroupId($user_group_id);

  $profile = new UserProfile();
  $profile-&gt;assign(array(
    'user_profile_location' =&gt; $data['user_profile_location'],
    'user_profile_birthday' =&gt; $data['user_profile_birthday'],
  ));

  $user-&gt;profile = $profile;

  return $this-&gt;save($user);
}</pre></div><p>We are ready to go further <a id="id274" class="indexterm"/>with this project by creating the rest of our database structure. Let's start with the <code class="literal">Article</code> table. First, drop the existing table from your database, and then create a new one:</p><div class="informalexample"><pre class="programlisting">DROP TABLE IF EXISTS `article`;
CREATE TABLE IF NOT EXISTS `article` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `article_user_id` int(11) NOT NULL,
  `article_is_published` tinyint(1) NOT NULL DEFAULT '0',
  `article_created_at` datetime NOT NULL,
  `article_updated_at` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `id` (`id`),
  KEY `article_user_id` (`article_user_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci AUTO_INCREMENT=1 ;

ALTER TABLE `article`
  ADD CONSTRAINT `fk_user_id` FOREIGN KEY (`article_user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION;</pre></div><p>For simplicity, an article will be assigned to a user through the <code class="literal">article_user_id</code> column.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note13"/>Note</h3><p>If you want to implement more complex things, such as "blameable" behavior, you can read an <a id="id275" class="indexterm"/>interesting article here <a class="ulink" href="http://blog.phalconphp.com/post/47652831003/tutorial-creating-a-blameable-behavior-with">http://blog.phalconphp.com/post/47652831003/tutorial-creating-a-blameable-behavior-with</a>.</p></div></div><p>As you can see, we eliminated all the text fields from the <code class="literal">article</code> table. This is because we are going to create another table named <code class="literal">article_translation</code>. In this way, we will be able to create multilingual articles/website content. The <code class="literal">article_translation</code> table is as follows:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `article_translation` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `article_translation_article_id` int(11) NOT NULL,
  `article_translation_short_title` varchar(255) COLLATE utf8_unicode_ci NOT NULL,
  `article_translation_long_title` varchar(255) COLLATE utf8_unicode_ci NOT NULL,
  `article_translation_slug` varchar(255) COLLATE utf8_unicode_ci NOT NULL,
  `article_translation_description` text COLLATE utf8_unicode_ci NOT NULL,
  `article_translation_lang` char(2) COLLATE utf8_unicode_ci DEFAULT 'en',
  PRIMARY KEY (`id`),
  KEY `id` (`id`),
  KEY `article_translation_article_id` (`article_translation_article_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci AUTO_INCREMENT=1 ;

ALTER TABLE `article_translation`
  ADD CONSTRAINT `fk_article_id` FOREIGN KEY (`article_translation_article_id`) REFERENCES `article` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION;</pre></div><p>The <code class="literal">article_lang</code> column <a id="id276" class="indexterm"/>will accept the two-letter ISO code for languages (ISO 639-1). Any news item, blog, or magazine has two major factors: <span class="strong"><strong>categories</strong></span><a id="id277" class="indexterm"/> and <a id="id278" class="indexterm"/>
<span class="strong"><strong>hashtags/keywords</strong></span>. We are going to create many-to-many relationship between articles and categories and between articles and hashtags. First, let's create the tables:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `category` (
  `id` smallint(5) NOT NULL AUTO_INCREMENT,
  `category_is_active` tinyint(1) NOT NULL DEFAULT '1',
  `category_created_at` datetime NOT NULL,
  `category_updated_at` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `category_is_active` (`category_is_active`),
  KEY `category_created_at` (`category_created_at`),
  KEY `category_updated_at` (`category_updated_at`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci AUTO_INCREMENT=1 ;

CREATE TABLE IF NOT EXISTS `category_translation` (
  `category_translation_category_id` smallint(5) NOT NULL,
  `category_translation_name` varchar(64) COLLATE utf8_unicode_ci NOT NULL,
  `category_translation_slug` varchar(128) COLLATE utf8_unicode_ci NOT NULL,
  `category_translation_lang` char(2) COLLATE utf8_unicode_ci NOT NULL,
  PRIMARY KEY (`category_translation_category_id`),
  UNIQUE KEY `category_translation_slug` (`category_translation_slug`),
  KEY `category_translation_lang` (`category_translation_lang`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;</pre></div><div class="informalexample"><pre class="programlisting">ALTER TABLE `category_translation`
  ADD CONSTRAINT `category_translation_ibfk_1` FOREIGN KEY (`category_translation_category_id`) REFERENCES `category` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip17"/>Tip</h3><p>If you check out the code from incubator (<a class="ulink" href="https://github.com/phalcon/incubator/tree/master/Library/Phalcon/Mvc/Model/Behavior">https://github.com/phalcon/incubator/tree/master/Library/Phalcon/Mvc/Model/Behavior</a>), you will see that there is a nice solution for a nested set, if you ever need to implement it.</p></div></div><p>Because we will use a <a id="id279" class="indexterm"/>many-to-many relationship, we need to create an intermediate table between articles and categories:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `article_category_article` (
  `article_id` int(11) NOT NULL,
  `category_id` smallint(5) NOT NULL,
  KEY `idx_article_id` (`article_id`),
  KEY `idx_category_id` (`category_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

ALTER TABLE `article_category_article`
  ADD CONSTRAINT `article_category_article_ibfk_2` FOREIGN KEY (`category_id`) REFERENCES `category` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION,
  ADD CONSTRAINT `article_category_article_ibfk_1` FOREIGN KEY (`article_id`) REFERENCES `article` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION;</pre></div><p>Having made these tables, let's create the models and the managers. The Article model already exists; remove it and create a new one with the new getters and setters. The next code samples will not contain the getters and setters, so you have to create them manually or check out the source code for this chapter.</p></div><div class="section" title="The Category model"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec39"/>The Category model</h2></div></div></div><p>The <code class="literal">Category</code> model<a id="id280" class="indexterm"/> can be<a id="id281" class="indexterm"/> seen with the <code class="literal">modules/Core/Models/Category.php</code> file. The following code contains an important method—<code class="literal">initialize()</code>. Here, we create a relation between models and add certain kinds of behavior for the date and time fields:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models;

class Category extends Base
{
    public function initialize()
    {
        /*
         * @param string $fields
         * @param string $intermediateModel
         * @param string $intermediateFields
         * @param string $intermediateReferencedFields
         * @param string $referencedModel
         * @param string $referencedFields
         * @param   array $options
         * @return  \Phalcon\Mvc\Model\Relation
         */
        $this-&gt;hasManyToMany(
            "id",
            "App\Core\Models\ArticleCategoryArticle",
            "category_id",
            "article_id",
            "App\Core\Models\Article",
            "id",
            array('alias' =&gt; 'articles')
        );

    $this-&gt;hasMany('id', 'App\Core\Models\CategoryTranslation','category_translation_category_id', array(

            'alias' =&gt; 'translations',
            'foreignKey' =&gt; true
        ));

        $this-&gt;addBehavior(new Timestampable(array(
            'beforeValidationOnCreate' =&gt; array(
                'field' =&gt; 'category_created_at',
                'format' =&gt; 'Y-m-d H:i:s'
            ),
            'beforeValidationOnUpdate' =&gt; array(
                'field' =&gt; 'category_updated_at',
                'format' =&gt; 'Y-m-d H:i:s'
            ),
        )));
    }
}</pre></div></div><div class="section" title="The Category translation model"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec40"/>The Category translation model</h2></div></div></div><p>The <a id="id282" class="indexterm"/>Category translation model <a id="id283" class="indexterm"/>makes use of <code class="literal">\Phalcon\Utils\Slug</code> to generate slugs. It uses the <code class="literal">Uniqueness</code> validator to ensure the uniqueness of the newly generated slug. This verification is made by interrogating the database:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models;

use \Phalcon\Mvc\Model\Validator\Uniqueness;
use \Phalcon\Utils\Slug;

class CategoryTranslation extends Base{
  public function initialize() {
    $this-&gt;belongsTo('category_translation_category_id', 'App\Core\Models\Category', 'id', array(
      'foreignKey' =&gt; true,
      'reusable' =&gt; true,
      'alias' =&gt; 'category'
        ));
    }

    public function validation()
    {
        $this-&gt;validate(new Uniqueness(array(
            "field" =&gt; "category_translation_slug",
            "message" =&gt; "Category slug should be unique"
        )));

        return $this-&gt;validationHasFailed() != true;
    }

    public function beforeValidation()
    {
        if ($this-&gt;category_translation_slug == '') {
            $this-&gt;category_translation_slug = Slug::generate($this-&gt;category_translation_name).'-'.$this-&gt;category_translation_category_id;
    }
  }
}</pre></div><p>We make use of <code class="literal">\Phalcon\Utils\Slug</code> to generate slugs for <code class="literal">category</code>. The same applies to the Article translation model.</p></div><div class="section" title="The Article translation model"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec41"/>The Article translation model</h2></div></div></div><p>This model, like the <a id="id284" class="indexterm"/>Category translation model, is validating <a id="id285" class="indexterm"/>the slug field to be unique and makes use of <code class="literal">\Phalcon\Utils\Slug</code> to generate a slug. This model is defined as follows. We'll be referencing the model from the <code class="literal">modules/Core/Models/ArticleTranslation.php</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models;

use \Phalcon\Mvc\Model\Validator\Uniqueness;
use \Phalcon\Utils\Slug;

class ArticleTranslation extends Base
{
    public function initialize()
    {
        $this-&gt;belongsTo('article_translation_article_id', 'App\Core\Models\Article', 'id', array(
            'foreignKey' =&gt; true,
            'reusable' =&gt; true,
            'alias' =&gt; 'article'
        ));
    }

    public function validation()
    {
        $this-&gt;validate(new Uniqueness(array(
            "field" =&gt; "article_translation_slug",
            "message" =&gt; "Article slug should be unique"
        )));

        return $this-&gt;validationHasFailed() != true;
    }

    public function beforeValidation()
    {
        if ($this-&gt;article_translation_slug == '') {
            $this-&gt;article_translation_slug = Slug::generate($this-&gt;article_translation_short_title).'-'.$this-&gt;article_translation_article_id;
        }
    }
}</pre></div></div><div class="section" title="The Article model"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec42"/>The Article model</h2></div></div></div><p>The<a id="id286" class="indexterm"/> Article model<a id="id287" class="indexterm"/> is similar to the Category model, with the difference being in the relations and the names of the fields. We'll be referencing the model from the <code class="literal">modules/Core/Models/Article.php</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models;

use \Phalcon\Mvc\Model\Behavior\Timestampable;

class Article extends Base
{
  public function initialize() {
    $this-&gt;hasMany('id', 'App\Core\Models\ArticleTranslation', 'article_translation_article_id', array(
        'alias' =&gt; 'translations',
        'foreignKey' =&gt; true
    ));

    $this-&gt;hasOne('article_user_id', 'App\Core\Models\User', 'id', array(
        'alias' =&gt; 'user',
        'reusable' =&gt; true
    ));

    $this-&gt;hasManyToMany(
      "id",
      "App\Core\Models\ArticleCategoryArticle",
      "article_id",
      "category_id",
      "App\Core\Models\Category",
      "id",
      array(
        'alias' =&gt; 'categories'
    ));

    $this-&gt;addBehavior(new Timestampable(array(
      'beforeValidationOnCreate' =&gt; array(
        'field' =&gt; 'article_created_at',
        'format' =&gt; 'Y-m-d H:i:s'
      ),
      'beforeValidationOnUpdate' =&gt; array(
        'field' =&gt; 'article_updated_at',
        'format' =&gt; 'Y-m-d H:i:s'
      ),
    )));
  }
}</pre></div></div><div class="section" title="The Article-Category-Article model"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec43"/>The Article-Category-Article model</h2></div></div></div><p>The<a id="id288" class="indexterm"/> Article-Category-Article model<a id="id289" class="indexterm"/> is an intermediate table and model used in a many-to-many relationship between articles and categories. We'll be referencing this model from the <code class="literal">modules/Core/Models/Article.php</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Models;

class ArticleCategoryArticle extends Base
{
    public function initialize()
    {
        $this-&gt;belongsTo('category_id', 'App\Core\Models\Category', 
  'id', array('alias' =&gt; 'category')
        );

        $this-&gt;belongsTo('article_id', 'App\Core\Models\Article', 
  'id', array('alias' =&gt; 'article')
        );
    }
}</pre></div><p>The final relations between articles and categories are presented here:</p><div class="mediaobject"><img src="graphics/B03522_04_09.jpg" alt="The Article-Category-Article model"/></div><p>We have the <a id="id290" class="indexterm"/>models. Now, let's continue by creating the <a id="id291" class="indexterm"/>managers and a simple task to create an article. The article manager already exists, but we are going to change the <code class="literal">create()</code> method. Before this, we will need to write the category manager with a <code class="literal">create()</code> method and enable it.</p><p>Create a file named <code class="literal">CategoryManager.php</code> in <code class="literal">modules/Core/Managers/</code> and add this content:</p><div class="informalexample"><pre class="programlisting">&lt;?php
namespace App\Core\Managers;

use \App\Core\Models\Category;
use \App\Core\Models\CategoryTranslation;

class CategoryManager extends BaseManager
{
    /**
     * Create method
     * @param array $input_data
     * @throws \Exception
     * @return \App\Core\Models\Category
     */
    public function create(array $input_data)
    {
        $default_data = array(
            'translations' =&gt; array(
                'en' =&gt; array(
                    'category_translation_name' =&gt; 'Category name',
                    'category_translation_slug' =&gt; '',
                    'category_translation_lang' =&gt; 'en',
                )
            ),
            'category_is_active' =&gt; 0
        );

        $data = array_merge($default_data, $input_data);

        $category = new Category();
        $category-&gt;setCategoryIsActive($data['category_is_active']);

        $categoryTranslations = array();

        foreach ($data['translations'] as $lang =&gt; $translation) {
            $tmp = new CategoryTranslation();
            $tmp-&gt;assign($translation);
            array_push($categoryTranslations, $tmp);
        }

        $category-&gt;translations = $categoryTranslations;

        return $this-&gt;save($category, 'create');
    }
}</pre></div><p>We will also <a id="id292" class="indexterm"/>need to register the new manager. Open <a id="id293" class="indexterm"/>
<code class="literal">config/service.php</code> and add the following code:</p><div class="informalexample"><pre class="programlisting">$di['core_category_manager'] = function () {
    return new \App\Core\Managers\CategoryManager();
};</pre></div><p>The <code class="literal">$default_data</code> array is meant to always remember the structure of the input that we need to use. We can test everything now by creating a task. Let's name it the <code class="literal">Article</code> task. Create the new file in <code class="literal">modules/Tasks/ArticleTask.php</code> and add this code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
class ArticleTask extends BaseTask
{
    /**
     * @Description("Create a new category with the default data as it is defined in the manager-&gt;create() method")
     * @Example("php modules/cli.php article createCategory")
     */
    public function createCategoryAction()
    {
        $manager = $this-&gt;getDI()-&gt;get('core_category_manager');

        try {
            $category = $manager-&gt;create(array());
            $this-&gt;consoleLog(sprintf(
                "The category has been created. ID: %d",
                $category-&gt;getId()
            ));

        } catch (\Exception $e) {
            $this-&gt;consoleLog("There were some errors creating the category: ","red");
            $errors = json_decode($e-&gt;getMessage(), true);

            if (is_array($errors)) {
                foreach ($errors as $error) {
                    $this-&gt;consoleLog("  - $error", "red");
                }
            } else {
                $this-&gt;consoleLog("  - $errors", "red");
            }
        }
    }
}</pre></div><p>This task will create a new category and generate a slug for it. Execute this task:</p><div class="informalexample"><pre class="programlisting">$ php modules/cli.php article createCategory</pre></div><p>You should see something similar to the following screenshot:</p><div class="mediaobject"><img src="graphics/B03522_04_10.jpg" alt="The Article-Category-Article model"/></div><p>We have <a id="id294" class="indexterm"/>pretty much everything we need to create a new <a id="id295" class="indexterm"/>article. Let's go back to our <code class="literal">ArticleManager.php</code> file and replace the existing <code class="literal">create()</code> method with this one:</p><div class="informalexample"><pre class="programlisting">    public function create($input_data)
{
  $default_data = array(
    'article_user_id' =&gt; 1,
    'article_is_published' =&gt; 0,
    'translations' =&gt; array(
      'en' =&gt; array(
        'article_translation_short_title' =&gt; 'Short title',
        'article_translation_long_title' =&gt; 'Long title',
        'article_translation_description' =&gt; 'Description',
        'article_translation_slug' =&gt; '',
        'article_translation_lang' =&gt; 'en',
      )
    ),
    'categories' =&gt; array()
  );
  $data = array_merge($default_data, $input_data);
  $article = new Article();
  $article-&gt;setArticleUserId($data['article_user_id']);
  $article-&gt;setArticleIsPublished(
    $data['article_is_published']);
  $articleTranslations = array();
  foreach ($data['translations'] as $lang =&gt; $translation) {
    $tmp = new ArticleTranslation();
    $tmp-&gt;assign($translation);
    array_push($articleTranslations, $tmp);
  }
  $article-&gt;translations = $articleTranslations;
  return $this-&gt;save($article, 'create');
}
</pre></div><p>The <code class="literal">createAction()</code> method <a id="id296" class="indexterm"/>from <code class="literal">ArticleTask.php</code>, which will<a id="id297" class="indexterm"/> enable us to create the new article, is given as follows:</p><div class="informalexample"><pre class="programlisting">    public function createAction()
    {
        $manager = $this-&gt;getDI()-&gt;get('core_article_manager');

        try {
            $article = $manager-&gt;create(array(
                'article_user_id' =&gt; 12
            ));
            $this-&gt;consoleLog(sprintf(
                "The article has been created. ID: %d",
                $article-&gt;getId()
            ));

        } catch (\Exception $e) {
            $this-&gt;consoleLog("There were some errors creating the article: ","red");
            $this-&gt;consoleLog($e-&gt;getMessage(),"yellow");
            $errors = json_decode($e-&gt;getMessage(), true);

            if (is_array($errors)) {
                foreach ($errors as $error) {
                    $this-&gt;consoleLog("  - $error", "red");
                }
            } else {
                $this-&gt;consoleLog("  - $errors", "red");
            }
        }
    }</pre></div><p>Pay attention to this code:</p><div class="informalexample"><pre class="programlisting">$article = $manager-&gt;create(array(
    'article_user_id' =&gt; 12
));</pre></div><p>In this case, I have assigned a user ID that I already have in the database. Check your database and add the specific user ID. Normally, this will be the ID of the authenticated user.</p><p>You can now run the task and you should see something similar to the next screenshot:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ php modules/cli.php article create</strong></span>
</pre></div><div class="mediaobject"><img src="graphics/B03522_04_11.jpg" alt="The Article-Category-Article model"/></div><p>The newly <a id="id298" class="indexterm"/>created article does not have any category<a id="id299" class="indexterm"/> assigned to it.</p><p>We will close this chapter with a small summary, and you will learn more about models when we develop the API module. In the meantime, I recommend that you try and develop the <code class="literal">hashtag</code> and <code class="literal">article_hashtag_article</code> tables, tasks, and models. There is no point in writing about this here, because it's the same thing as we did for categories (only the names have been changed). Also, you have it in the source code of this chapter.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip18"/>Tip</h3><p>As always, please spare<a id="id300" class="indexterm"/> some time to read the official documentation at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/models.html">http://docs.phalconphp.com/en/latest/reference/models.html</a>, where you can learn more about working with models.</p></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec33"/>Summary</h1></div></div></div><p>In this chapter, we created the database structure for our project, and you learned how to create a CLI application. We created models and managers and saw how relations between tables work. You also learned about model behavior ("timestampable"), model validations, and the storage of related records.</p><p>The next chapter will be about developing an API module, and we will have the chance to discover more techniques of working with models, searching for data, authenticating users, and much more.</p></div></body></html>