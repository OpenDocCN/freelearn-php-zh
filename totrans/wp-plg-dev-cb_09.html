<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Leveraging JavaScript, jQuery, and AJAX Scripts</h1>
                </header>
            
            <article>
                
<p>This chapter focuses on incorporating JavaScript in plugins by exploring the following topics:</p>
<ul>
<li>Safely loading jQuery onto WordPress web pages</li>
<li>Displaying a pop-up dialog using the built-in ThickBox plugin</li>
<li>Controlling pop-up dialog display using shortcodes</li>
<li>Displaying a calendar day selector using the Datepicker plugin</li>
<li>Adding tooltips to admin page form fields using the TipTip plugin</li>
<li>Using AJAX to dynamically update partial page contents</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article>
                
<p>JavaScript libraries, especially the very popular jQuery library and its numerous plugins, can do wonders in bringing a website to life with slick animations, dynamic data queries, and advanced visual features. Unfortunately, for all of their benefits, these scripts can also be difficult to work with. For example, loading more than one copy of jQuery can destroy all the setup that was done by the other instances and errors in one script usually prevent other scripts from running correctly.</p>
<p>WordPress' answer to this convoluted architecture is twofold. As a first step, it comes pre-packaged with a copy of jQuery and many other popular JavaScript libraries that plugin developers can use without having to load their own versions. Then, to prevent multiple copies from being loaded on a page, it offers easy-to-use functions that queue up scripts and styles to identify duplicates before rendering pages.</p>
<p>This chapter shows how to safely load JavaScript and jQuery files that are provided with WordPress or that come from external sources to add powerful new functionalities to front-facing pages and plugin configuration panels. It also explains how to securely run AJAX queries to refresh partial page sections.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Safely loading jQuery onto WordPress web pages</h1>
                </header>
            
            <article>
                
<p>While it might be tempting to provide your own copy of jQuery as part of a new plugin that uses the popular JavaScript library or to access a copy from the Google API website, WordPress actually provides a copy of jQuery in its installation and makes it very easy to load it.</p>
<p>By using the appropriate utility function to load jQuery, developers make a request to WordPress to load this library instead of doing it themselves. Once all the requests have been received, they are analyzed for duplicates and a single instance of each script is loaded to reduce the chance of conflicts between multiple copies of the same library.</p>
<p>This recipe shows how to load the jQuery script for use on front-facing website pages.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have access to a WordPress development environment.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the WordPress plugin directory of your development installation.</li>
<li>Create a new directory called <kbd>ch9-load-jquery</kbd>.</li>
<li>Navigate to the directory and create a text file called <kbd>ch9-load-jquery.php</kbd>.</li>
</ol>
<p> </p>
<ol start="4">
<li>Open the new file in a code editor and add an appropriate header at the top of the plugin file, naming the plugin <kbd>Chapter 9 - Load jQuery</kbd>.</li>
<li>Add the following line of code to register a function to be called when script loading requests are processed:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'wp_enqueue_scripts', 'ch9lj_front_facing_pages' ); </pre>
<ol start="6">
<li>Add the following code segment to provide an implementation for the <kbd>ch9lj_front_facing_pages</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch9lj_front_facing_pages() { <br/>    wp_enqueue_script( 'jquery' ); <br/>} </pre>
<ol start="7">
<li>Save and close the plugin file.</li>
<li>Go to the <span class="packt_screen">Themes</span> menu section located under <span class="packt_screen">Appearance</span> in the WordPress administration interface.</li>
<li>Click on <span class="packt_screen">Add New</span> and search for a theme called <kbd>Twenty Eleven</kbd>.</li>
<li><span class="packt_screen">Install</span> the theme on your website and <span class="packt_screen">Activate</span> it.</li>
<li>Visit your website and view the page source, searching for instances of the <kbd>jquery.js</kbd> library. Your search should come up empty unless you have activated other plugins that are asking for jQuery to be loaded.</li>
<li>Navigate to the <span class="packt_screen">Plugins</span> management page and <span class="packt_screen">Activate</span> the <kbd>Chapter 9 - Load jQuery</kbd> plugin.</li>
<li>Go back to any page on your website and view the page source.</li>
<li>Search for the keyword <kbd>jquery</kbd> to see that a copy of the script is now loaded from the WordPress <kbd>wp-includes</kbd> folder, along with the <kbd>jquery-migrate</kbd> script for backward compatibility:</li>
</ol>
<pre style="padding-left: 60px">&lt;script type='text/javascript' src='http://localhost/<br/>    wp-includes/js/jquery/jquery.js?ver=1.12.4'&gt;&lt;/script&gt;<br/>&lt;script type='text/javascript' src='http://localhost/<br/>    wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'&gt;&lt;/script&gt;</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>The key component of this recipe is the <kbd>wp_enqueue_script</kbd> function, which allows developers to load their own JavaScript files or to ask WordPress to load one of the scripts that it comes packaged with. While the function requires many arguments when loading your own scripts, which we'll cover in a later recipe, it only needs a single argument to load built-in scripts. In this example, that argument is <kbd>jquery</kbd>. To get a full list of default scripts available with WordPress, check out the code reference page for the function (<a href="https://developer.wordpress.org/reference/functions/wp_enqueue_script/">https://developer.wordpress.org/reference/functions/wp_enqueue_script/</a>).</p>
<p>Once you know which script to load, the call to <kbd>wp_enqueue_script</kbd> should be made from one of three action hooks, depending on the target page(s) where the script should be loaded. These are <kbd>wp_enqueue_scripts</kbd> for front-facing pages, <kbd>admin_enqueue_scripts</kbd> for administration pages, and <kbd>login_enqueue_scripts</kbd> for the login page, with the first one fulfilling our requirement for this recipe.</p>
<div class="packt_infobox">We had to go back and install an older theme to be able to see a change after activating our plugin. Many modern themes already make a request for jQuery to be loaded since it is used to animate menus or provide many other common functionalities. That being said, we cannot assume that this will be the case if we plan to distribute our work to a larger audience.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>Veteran jQuery developers should be aware that the copy delivered with WordPress has a small caveat.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">jQuery noconflict mode</h1>
                </header>
            
            <article>
                
<p>To avoid internal conflicts with other JavaScript and jQuery libraries, the version of jQuery that comes bundled with WordPress is configured in the <kbd>noconflict</kbd> mode. This means that the <kbd>$</kbd> shortcut that can normally be used to access jQuery will not be available. As such, all the examples found in this chapter spell out the jQuery keyword.</p>
<p>To regain access to this shortcut, you can use the following syntax in your code:</p>
<pre>jQuery( document ).ready( function($) { <br/>    // $ shortcut is now available for this function <br/>} ); </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Displaying a pop-up dialog using the built-in ThickBox plugin</h1>
                </header>
            
            <article>
                
<p>As annoying as they can be to visitors, pop-up dialogs are a feature that many website administrators are using to help them advertise special offers or get readers to subscribe to their content. Since it uses pop-up dialogs in its own administrative pages, WordPress comes bundled with a jQuery script called ThickBox that can be used to display these types of dialogs.</p>
<p>This recipe shows how to load the ThickBox script and use it to render a pop-up dialog.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have access to a WordPress development environment.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the WordPress plugin directory of your development installation.</li>
<li>Create a new directory called <kbd>ch9-pop-up-dialog</kbd>.</li>
<li>Navigate to the directory and create a text file called <kbd>ch9-pop-up-dialog.php</kbd>.</li>
<li>Open the new file in a code editor and add an appropriate header at the top of the plugin file, naming the plugin <kbd>Chapter 9 - Pop-Up Dialog</kbd>.</li>
<li>Add the following line of code to register a function to be called when script loading requests are made:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'wp_enqueue_scripts', 'ch9pud_load_scripts' ); </pre>
<ol start="6">
<li>Add the following code segment to provide an implementation for the <kbd>ch9pud_load_scripts</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch9pud_load_scripts() { <br/>    wp_enqueue_script( 'jquery' ); <br/>    add_thickbox(); <br/>} </pre>
<ol start="7">
<li>Insert the following line of code to register a function to display content in the page footer:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'wp_footer', 'ch9pud_footer_code' ); </pre>
<ol start="8">
<li>Append the following block of code to provide an implementation for the <kbd>ch9pud_footer_code</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch9pud_footer_code() { ?&gt; <br/>    &lt;script type="text/javascript"&gt; <br/>    jQuery( document ).ready(function() { <br/>        setTimeout( function() { <br/>            tb_show( 'Pop-Up Message', '&lt;?php echo plugins_url( <br/>                      'content.html?width=420&amp;height=220', <br/>                      __FILE__ ); ?&gt;', null ); <br/>        }, 2000 ); <br/>    } ); <br/> <br/>&lt;/script&gt; <br/>&lt;?php <br/>} </pre>
<ol start="9">
<li>Save and close the plugin file.</li>
<li>Create a new HTML file named <kbd>content.html</kbd> and open it in a code editor.</li>
<li>Insert the following HTML code as the file's content:</li>
</ol>
<pre style="padding-left: 60px">&lt;!DOCTYPE html&gt; <br/>&lt;html&gt; <br/>    &lt;body&gt; <br/>        &lt;div&gt;This is the pop-up content.&lt;/div&gt; <br/>    &lt;/body&gt; <br/>&lt;/html&gt; </pre>
<ol start="12">
<li>Save and close the HTML file.</li>
</ol>
<p> </p>
<ol start="13">
<li>Navigate to the <span class="packt_screen">Plugins</span> management page and <span class="packt_screen">Activate</span> the <kbd>Chapter 9 - Pop-Up Dialog</kbd> plugin.</li>
<li>Visit any page of the website to see the new pop-up dialog appear two seconds after the whole page is displayed:</li>
</ol>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="185" width="330" class="image-border" src="assets/2cc0b3fe-9ab2-4cd6-88b5-c1b148c8b6c6.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>Similarly to the previous recipe, we start by assigning a function to the <kbd>wp_enqueue_scripts</kbd> action hook. When executed, the callback makes a call to <kbd>wp_enqueue_script</kbd> to request for jQuery to be loaded from the local copy of WordPress. The next line calls the <kbd>add_thickbox</kbd> function, which is a utility function that makes multiple calls to <kbd>wp_enqueue_script</kbd> and <kbd>wp_enqueue_style</kbd> to load the appropriate JavaScript and stylesheet in the page header.</p>
<p>Once all the required elements are loaded, the next section of the recipe outputs a block of JavaScript code to the page footer which uses jQuery to register a function that will be called when the entire page is loaded. When this happens, the <kbd>setTimeout</kbd> JavaScript function is used to register a function that will be called 2000 milliseconds later and will take care of calling <kbd>tb_show</kbd> to display the pop-up dialog. <kbd>tb_show</kbd> has three arguments, with the first one indicating the dialog title, the second containing the address of the content to render within the box, and the third expecting a path to a group of images to be displayed. In our case, the last argument is left null. Notice that the width and height (in pixels) of the dialog are indicated as part of the address of the content page to be displayed.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>While the recipe displays a valid dialog, developers might want a bit more control over how it can be closed and when it gets displayed.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Removing the dialog close button</h1>
                </header>
            
            <article>
                
<p>By default, the ThickBox script offers a close button in the top-right corner of the pop-up dialog that can be used to close it at any time. This may not be desirable if you expect visitors to provide feedback or perform a specific action before dismissing the dialog. By adding the <kbd>modal</kbd> keyword to the content URL--set to the value of <kbd>true</kbd>--ThickBox will remove the dialog title bar, including the close button:</p>
<pre>tb_show( 'Pop-Up Message', '&lt;?php echo plugins_url( <br/>     'content.html?width=420&amp;height=220&amp;modal=true', __FILE__ ); ?&gt;', <br/>     null );</pre>
<p>Once the close button is gone, we can call the <kbd>tb_remove</kbd> JavaScript function to close the dialog. The following is an example of a simple link that could be added in <kbd>content.html</kbd> that will close the dialog:</p>
<pre>&lt;div&gt;&lt;a href="#" onclick="tb_remove();"&gt;Close Dialog&lt;/a&gt;&lt;/div&gt; </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Displaying pop-up dialogs on select pages</h1>
                </header>
            
            <article>
                
<p>While the recipe's original code displays a pop-up dialog on every single page of a website, it may be better to show it only on specific pages, such as the front page, to avoid over-exposition. To accomplish this, we can move the two <kbd>add_action</kbd> calls inside of an action hook callback and check whether the visitor is making a request to see the front page before loading our scripts:</p>
<pre>add_action( 'template_redirect', 'ch9pud_template_redirect' );<br/><br/>function ch9pud_template_redirect() {<br/>    if ( is_front_page() ) { <br/>        add_action( 'wp_enqueue_scripts', 'ch9pud_load_scripts' ); <br/>        add_action( 'wp_footer', 'ch9pud_footer_code' ); <br/>    }<br/>}</pre>
<p>A similar technique can be used by substituting the <kbd>is_front_page</kbd> function with the <kbd>is_page( 'id_title_or_slug' )</kbd> function, which checks whether the current page numeric ID, title, or post slug matches the value that it receives as an argument. In that situation, a plugin configuration page could allow users to easily select one or more pages on which the dialog should appear.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Controlling pop-up dialog display using shortcodes</h1>
                </header>
            
            <article>
                
<p>As you may be aware, loading scripts and styles on a page where they won't be used unnecessarily slows down that page's rendering time, since the browser will still need to download and validate the content of these external files. While the previous recipe's <em>There's More...</em> section offered one way to select specific pages where scripts and styles should be loaded, a different approach is to analyze the page contents for the presence of a special code to make that decision.</p>
<p>This recipe shows how to add a filter to the previous recipe to search for a shortcode in posts and pages to decide when to display a pop-up dialog.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Displaying a pop-up dialog using the built-in ThickBox plugin</em> recipe to have a starting point for this recipe. Alternatively, you can get the resulting code (<kbd>Chapter 9/ch9-pop-up-dialog/ch9-pop-up-dialog-v1.php</kbd>) from the code bundle and rename the file as <kbd>ch9-pop-up-dialog.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the WordPress plugin directory of your development installation.</li>
<li>Navigate to the <kbd>ch9-pop-up-dialog</kbd> directory and then edit <kbd>ch9-pop-up-dialog.php</kbd>.</li>
</ol>
<p> </p>
<ol start="3">
<li>Find the <kbd>ch9pud_load_scripts</kbd> function and add the following highlighted lines of code:</li>
</ol>
<pre style="padding-left: 60px">function ch9pud_load_scripts() { <br/>    <strong>// Only load scripts if variable is set to true</strong><br/><strong>    global $load_scripts;</strong><br/><br/><strong>    if ( $load_scripts ) {</strong><br/>        wp_enqueue_script( 'jquery' );<br/>        add_thickbox()<br/>    <strong>}</strong><br/>} </pre>
<ol start="4">
<li>Locate the <kbd>ch9pud_footer_code</kbd> function and modify the code, adding the following highlighted lines of code to the function body:</li>
</ol>
<pre style="padding-left: 60px">function ch9pud_footer_code() {<br/>    <strong>// Only load scripts if keyword is found on page</strong><br/><strong>    global $load_scripts;</strong><br/><strong>    if ( $load_scripts ) {</strong> ?&gt;<br/> <br/>    &lt;script type="text/javascript"&gt; <br/>        jQuery( document ).ready( function() { <br/>            setTimeout( <br/>                function(){ <br/>                    tb_show( 'Pop-Up Message', <br/>                        '&lt;?php echo plugins_url( <br/>                        'content.html?width=420&amp;height=220', <br/>                        __FILE__ ); ?&gt;', null ); <br/>                }, 2000 ); <br/>        }); <br/>    &lt;/script&gt; <br/>     <br/>&lt;?php <strong>}</strong>  <br/>} </pre>
<ol start="5">
<li>Add the following line of code to register a function that will filter post and page contents before any other parsing and formatting is performed:</li>
</ol>
<pre style="padding-left: 60px">add_filter( 'the_posts',<br/>            'ch9pud_conditionally_add_scripts_and_styles' ); </pre>
<ol start="6">
<li>Append the following block of code to provide an implementation for the<br/>
<kbd>ch9pud_conditionally_add_scripts_and_styles</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch9pud_conditionally_add_scripts_and_styles( $posts ) { <br/>    // Exit function immediately if no posts are present <br/>    if ( empty( $posts ) ) {<br/>        return $posts;<br/>    }<br/> <br/>    // Global variable to indicate if scripts should be loaded <br/>    global $load_scripts; <br/>    $load_scripts = false; <br/> <br/>    // Cycle through posts and set flag true if <br/>    // keyword is found <br/>    foreach ( $posts as $post ) {         <br/>        $shortcode_pos = stripos( $post-&gt;post_content, <br/>                                  '[popup]', 0 ); <br/>        if ( $shortcode_pos !== false ) { <br/>            $load_scripts = true; <br/>            return $posts; <br/>        } <br/>    } <br/> <br/>    // Return posts array unchanged <br/>    return $posts;     <br/>} </pre>
<ol start="7">
<li>Insert the following function call to declare a new shortcode along with a function responsible for replacing it with content:</li>
</ol>
<pre style="padding-left: 60px">add_shortcode( 'popup', 'ch9pud_popup_shortcode' ); </pre>
<ol start="8">
<li>Add the following code block to provide a simple implementation for the <kbd>ch9pud_popup_shortcode</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch9pud_popup_shortcode() { <br/>    return;     <br/>} </pre>
<ol start="9">
<li>Save and close the plugin file.</li>
<li>Visit the website's front page and you will notice that the pop-up dialog is no longer displayed.</li>
<li>Create a new page and insert the <kbd>[popup]</kbd> shortcode in the page contents.</li>
<li>View the new page to see that the new pop-up dialog appears, while the <kbd>[popup]</kbd> shortcode is not shown.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>While the existing action hooks were first modified to create and query a global variable to determine whether or not they should load scripts and output code to the page footer, the bulk of the work is actually done by the filter function that gets associated to <kbd>the_posts</kbd> hook. This function receives an array of all the posts and pages that are destined to be displayed and must determine if a special keyword is present to set the <kbd>load_scripts</kbd> variable appropriately.</p>
<p>As you can see from the recipe's code, the text that we chose to look for, <kbd>[popup]</kbd>, is a shortcode. While we could have selected any text as the trigger to display a pop-up dialog, we chose a shortcode, since it would be easy to make it disappear by providing a simple rendering function for it that returns no content.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Displaying a pop-up dialog using the built-in ThickBox plugin</em> recipe</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Displaying a calendar day selector using the Datepicker plugin</h1>
                </header>
            
            <article>
                
<p>For all of its great administrative control panels and user interface elements, WordPress still has a simplistic approach to date selection, making users interact with a drop-down box and text fields to indicate the month, day, year, and time when a post or page is to be published. A much more interesting way to enter this type of information is to use a pop-up calendar that allows users to navigate through visual representations of each month and pick the desired date.</p>
<p>This recipe shows how to use the jQuery Datepicker script that is provided by default with WordPress to display a pop-up calendar to provide an easy way to select dates.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have access to a WordPress development environment.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the WordPress plugin directory of your development installation.</li>
<li>Create a new directory called <kbd>ch9-calendar-picker</kbd> along with a subdirectory called <kbd>css</kbd>.</li>
<li>Visit <a href="https://www.jqueryui.com/download">https://</a><span class="URLPACKT"><a href="http://www.jqueryui.com/download">www.jqueryui.com/download</a>, toggle all the components to be unchecked, and select only <span class="packt_screen">Datepicker.</span></span> Then, select <span class="packt_screen">UI lightness</span> as the theme to be included and download the latest version of the jQuery UI package.</li>
<li>Open the resulting file with an archive management tool and extract the file <kbd>jquery-ui.min.css</kbd> to the <kbd>css</kbd> folder of the newly created plugin directory.</li>
<li>Extract the entire <kbd>images</kbd> directory from the archive to the <kbd>css</kbd> folder.</li>
<li>Create a text file called <kbd>ch9-calendar-picker.php</kbd> in the plugin directory.</li>
<li>Open the new file in a code editor and add an appropriate header at the top of the plugin file, naming the plugin <kbd>Chapter 9 - Calendar Picker</kbd>.</li>
<li>Add the following line of code to register a function to be called when script loading requests are made:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'admin_enqueue_scripts', 'ch9cp_admin_scripts' ); </pre>
<ol start="9">
<li>Add the following code segment to provide an implementation for the <kbd>ch9cp_admin_scripts</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch9cp_admin_scripts() {<br/>    $screen = get_current_screen();<br/>    if ( 'post' == $screen-&gt;base &amp;&amp; <br/>         'post' == $screen-&gt;post_type ) {<br/>        wp_enqueue_script( 'jquery' ); <br/>        wp_enqueue_script( 'jquery-ui-core' ); <br/>        wp_enqueue_script( 'jquery-ui-datepicker' ); <br/>        wp_enqueue_style( 'datepickercss',  <br/>            plugins_url( 'css/jquery-ui.min.css', <br/>                   __FILE__ ), array(), '1.12.1' );<br/>    }<br/>} </pre>
<ol start="10">
<li>Insert the following line of code to register a function to be called when meta boxes are created:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'add_meta_boxes', 'ch9cp_register_meta_box' ); </pre>
<ol start="11">
<li>Append the following block of code to provide an implementation for the <kbd>ch9cp_register_meta_box</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch9cp_register_meta_box() {     <br/>    add_meta_box( 'ch9cp_datepicker_box', 'Assign Date', <br/>                  'ch9cp_date_meta_box', 'post', 'normal'); <br/>} </pre>
<ol start="12">
<li>Insert the following code block to implement the <kbd>ch9cp_date_meta_box</kbd> function that was declared in the call to <kbd>add_meta_box</kbd>:</li>
</ol>
<pre style="padding-left: 60px">function ch9cp_date_meta_box( $post ) { ?&gt; <br/>    &lt;input type="text" id="ch9cp_date" name="ch9cp_date" /&gt; <br/>     <br/>    &lt;!-- JavaScript function to display calendar button --&gt; <br/>    &lt;!-- and associate date selection with field --&gt; <br/>    &lt;script type='text/javascript'&gt; <br/>        jQuery( document ).ready( function() { <br/>        jQuery( '#ch9cp_date' ).datepicker( { minDate: '+0', <br/>            dateFormat: 'yy-mm-dd', showOn: 'both', <br/>            constrainInput: true} );  <br/>        } ); <br/>    &lt;/script&gt; <br/>&lt;?php } </pre>
<ol start="13">
<li>Save and close the plugin file.</li>
<li>Navigate to the <span class="packt_screen">Plugins</span> management page and <span class="packt_screen">Activate</span> the <kbd>Chapter 9 - Calendar Picker plugin</kbd>.</li>
<li>Select any item in the <span class="packt_screen">Posts</span> management section and edit it to see the new date assignment meta box.</li>
<li>Click on the <span class="packt_screen">...</span> button or click on the <span class="packt_screen">Assign</span> <span class="packt_screen">Date</span> textbox to display the pop-up calendar and select a date:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="185" width="170" class="image-border" src="assets/235cae37-5891-43b1-ae74-d3d39dd7aafe.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>Just like we saw with jQuery and ThickBox in the previous recipes, WordPress comes bundled with many jQuery libraries. Two of these libraries, jQuery UI and jQuery UI Datepicker, can be used to display a pop-up calendar and associate it with a text field on a form. That being said, the distribution of these scripts is missing the associated stylesheet and images that are required to display a fully rendered calendar.</p>
<p>This recipe starts by visiting the jQuery UI website and downloading a copy of the complete library, which includes all the required layout files. Once the download is complete, we are only interested in getting a copy of the style data, since all the other necessary scripts are provided by WordPress. After registering a function with <kbd>admin_enqueue_scripts</kbd>, we make three function calls to load the required JavaScript files in the admin page header. We also make a call to load the stylesheet that we just downloaded. When copying files from the downloaded archive, we selected the minified versions of the CSS files to have the smallest versions available.</p>
<p>The <kbd>wp_enqueue_style</kbd> function has many parameters. In this example, we are providing values for the first four of them to indicate the name of the style, the path to the style file, an empty list of dependencies, and a version number. This function also has a fifth parameter, which we are not using here, to indicate if the script should be loaded in the header or footer, where the default is the header.</p>
<p>Once all of the required scripts are in place, the remainder of the code creates a meta box in the post editor, displays a text field in that box, and outputs JavaScript code that will be called when the page is completely rendered to associate the pop-up calendar with the text field. As part of the calendar's options, we specify that the user will only be able to select future dates with the <kbd>minDate</kbd> parameter along with the desired date format.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding tooltips to admin page form fields using the TipTip plugin</h1>
                </header>
            
            <article>
                
<p>Documentation is a very important step of plugin development, as it allows users to understand how to configure the plugins you create. That being said, users will not typically go very far to find the information they need, resulting in many unnecessary questions in discussion forums or in emails.</p>
<p>As discussed in <a href="0346c3c6-27ee-45fb-bfd6-df398e04b2b4.xhtml"><span class="ChapterrefPACKT">Chapter 3</span></a>, <em>User Settings and Administration Pages</em>, one way to provide documentation is to create a help tab that appears in the top-right corner of the plugin's configuration panel. While that approach is much easier for users than to find a Readme file or go back to the official WordPress plugin repository, it still requires them to actively seek and click a link to open that section.</p>
<p>That's where tooltips come into play. Using a jQuery plugin to render clean, good looking tooltips, we can add documentation to a plugin that will be displayed contextually based on the configuration fields that the user is currently interacting with.</p>
<p>This recipe shows how to download and integrate the TipTip jQuery library to display tooltips when configuration fields are used.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Displaying a calendar day selector using the Datepicker plugin</em> recipe to have a starting point for this recipe. Alternatively, you can get the resulting code (<kbd>Chapter 9/ch9-calendar-picker/ch9-calendar-picker-v1.php</kbd>) from the code bundle and rename the file as <kbd>ch9-calendar-picker.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the WordPress plugin directory of your development installation.</li>
<li>Navigate to the <kbd>ch9-calendar-picker</kbd> directory.</li>
<li>Create a new subdirectory called <kbd>tiptip</kbd>.</li>
<li>Visit the TipTip jQuery home page, available at <a href="https://drew.tenderapp.com/kb/tiptip-jquery-plugin/tiptip-downloads"><span class="URLPACKT">https://drew.tenderapp.com/kb/tiptip-jquery-plugin/tiptip-downloads</span></a>.</li>
<li>Download Version 1.3 of the plugin source code to your local computer.</li>
<li>Open the resulting file with an archive management tool and extract the <kbd>jquery.tipTip.minified.js</kbd> and <kbd>tipTip.css</kbd> files to the <kbd>tiptip</kbd> directory.</li>
<li>Open the main plugin file <kbd>ch9-calendar-picker.php</kbd> in a code editor.</li>
</ol>
<p> </p>
<ol start="8">
<li>Find the <kbd>ch9cp_admin_scripts</kbd> function and add the following lines of code at the end of the <kbd>if</kbd> condition, so that the new scripts are only loaded on the page and post editors, like the others:</li>
</ol>
<pre style="padding-left: 60px">wp_enqueue_script( 'tiptipjs',<br/>                   plugins_url( 'tiptip/jquery.tipTip.minified.js', <br/>                                __FILE__ ), <br/>                   array(), '1.3' ); <br/>wp_enqueue_style( 'tiptip',<br/>                  plugins_url( 'tiptip/tipTip.css', __FILE__ ),<br/>                               array(), '1.3' );</pre>
<ol start="9">
<li>Locate the <kbd>ch9cp_date_meta_box</kbd> function and modify the line that renders the textbox, as shown in the following highlighted code:</li>
</ol>
<pre style="padding-left: 60px">&lt;input type="text" <strong>class="ch9cp_tooltip" </strong><br/><strong>       </strong> id="ch9cp_date" <br/>       name="ch9cp_date" /&gt; </pre>
<ol start="10">
<li>Again, in the <kbd>ch9cp_date_meta_box</kbd> function, add the following highlighted block of code to the existing block of JavaScript code:</li>
</ol>
<pre style="padding-left: 60px">&lt;script type='text/javascript'&gt; <br/>    jQuery( document ).ready( function() { <br/>        jQuery( '#ch9cp_date' ).datepicker( { minDate: '+0', <br/>                dateFormat: 'yy-mm-dd', showOn: 'both', <br/>                constrainInput: true } ); <br/>             <br/>        <strong>jQuery( '.ch9cp_tooltip' ).each( function() { </strong><br/><strong>                jQuery( this ).tipTip(); </strong><br/><strong>            } </strong><br/><strong>        );</strong> <br/>    }); <br/>&lt;/script&gt; </pre>
<ol start="11">
<li>Save and close the plugin file.</li>
<li>Select any item in the <span class="packt_screen">Posts</span> management section and edit it.</li>
<li>Move the mouse over the date field to see the new tooltip appear:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="104" width="223" class="image-border" src="assets/f664d963-4f0f-4461-910d-34a5e8af215a.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>The TipTip library turns regular HTML <kbd>title</kbd> tags into nice looking tooltips that appear when users position their mouse cursor over an item or select it.</p>
<p>This recipe starts by downloading the TipTip script from the plugin author's website. Once downloaded, we only extract two of the three files that the archive contains. The third file is not needed, as it is a non-compact version of the script.</p>
<p>Once we have the desired files in place, we load them in the admin page header by adding calls to the <kbd>wp_enqueue_script</kbd> and <kbd>wp_enqueue_style</kbd> functions in the callback that was already associated with the <kbd>admin_enqueue_script</kbd> action hook. Similar to <kbd>wp_enqueue_style</kbd>, the <kbd>wp_enqueue_script</kbd> function has five parameters, which indicate the name of the script, the location of the script file, a list of any dependencies for the script, a version number, and an option to indicate if the script should be loaded in the site header or footer.</p>
<p>Once the library is loaded, activating the tooltips is quite simple. First, we select a class name for our items and add it to all the items that are destined to have help text associated with them. Then, we add the help text in a <kbd>title</kbd> tag on each item. Note that the item in question could be anything from a div to a form input component or a table row. Finally, we make a call to a jQuery function to find all the items that have the right class and execute the TipTip function on them. After execution, all the selected items will have their title text appear as tooltips.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Displaying a calendar day selector using the Datepicker plugin</em> recipe</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using AJAX to dynamically update partial page contents</h1>
                </header>
            
            <article>
                
<p>When users create complex websites with lots of dynamic content, such as Twitter widgets or other components that fetch external data, refreshing the entire page every time a user interacts with the website can quickly become a gruelling experience for visitors.</p>
<p>In such situations, using <strong>Asynchronous JavaScript and XML</strong> (<strong>AJAX</strong>) can greatly accelerate user navigation by only displaying subsets of data on visitor-facing pages and dynamically retrieving updates to isolated sections. More specifically, AJAX allows the browser to send requests to a web server, including data parameters, and to insert the data that it receives back in the web page, replacing or augmenting the original content.</p>
<p>This recipe shows how to add AJAX support to the bug tracking system created in <a href="9b139a97-7147-49cf-bd06-d370c6777c86.xhtml"><span class="ChapterrefPACKT">Chapter 8</span></a>, <em>Creating Custom MySQL Database Tables</em>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should have already followed the <em>Importing data from a user file into custom tables</em> recipe in <a href="9b139a97-7147-49cf-bd06-d370c6777c86.xhtml"><span class="ChapterrefPACKT">Chapter 8</span></a>, <em>Creating Custom MySQL Database Tables</em>, to have a starting point for this recipe. Alternatively, you can get the resulting code (<kbd>Chapter 8/ch8-bug-tracker/ch8-bug-tracker-v8.php</kbd>) from the code bundle and rename the file as <kbd>ch8-bug-tracker.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the WordPress plugin directory of your development installation.</li>
<li>Navigate to the <kbd>ch8-bug-tracker</kbd> directory and edit <kbd>ch8-bug-tracker.php</kbd>.</li>
<li>Locate the <kbd>ch8bt_shortcode_list</kbd> function and find the section where the SQL query is being prepared.</li>
<li>Add an extra line to the query (the highlighted line of code in the following code block) to show only open bugs (bugs with a <kbd>bug_status</kbd> field set to <kbd>0</kbd>):</li>
</ol>
<pre style="padding-left: 60px">$bug_query = 'select * from ' . $wpdb-&gt;get_blog_prefix(); <br/>$bug_query .= 'ch8_bug_data '; <br/><strong>$bug_query .= 'where bug_status = 0 '; </strong></pre>
<ol start="5">
<li>Make the change highlighted in the following code to the code building the search query:</li>
</ol>
<pre style="padding-left: 60px">if ( $search_mode ) { <br/>    $search_term = '%' . $search_string . '%'; <br/>    $bug_query .= "<strong>and (</strong> bug_title like '%s' "; <br/>    $bug_query .= "or bug_description like '%s'<strong> )</strong> "; <br/>} </pre>
<ol start="6">
<li>Find the code responsible for drawing the search form, and add the following highlighted block of code after it to display a link to be clicked to show closed bugs:</li>
</ol>
<pre style="padding-left: 60px">$output .= '&lt;/form&gt;&lt;/div&gt;';<br/> <br/><strong>$output .= '&lt;div class="show_closed_bugs"&gt;'; </strong><br/><strong>$output .= 'Show closed bugs'; </strong><br/><strong>$output .= '&lt;/div&gt;';</strong>  <br/><br/>$output .= '&lt;div class="bug-tracker-list"&gt;&lt;table&gt;'; </pre>
<ol start="7">
<li>Insert this code segment after the bug display table to add the JavaScript responsible for providing the AJAX-based data replacement functionality:</li>
</ol>
<pre style="padding-left: 60px">$output .= "&lt;script type='text/javascript'&gt;"; <br/>$nonce = wp_create_nonce( 'ch8bt_ajax' );  <br/>$output .= "function replacecontent( bug_status )" . <br/>           "{ jQuery.ajax( {" . <br/>           "    type: 'POST', url: ajax_url," . <br/>           "    data: { action: 'ch8bt_buglist_ajax'," . <br/>           "            _ajax_nonce: '" . $nonce . "'," . <br/>           "            bug_status: bug_status }," . <br/>           "    success: function( data ) {" . <br/>           "            jQuery('.bug-tracker-list').html( data );" . <br/>           "            }" . <br/>           "    });" . <br/>           "};"; <br/> <br/>$output .= "jQuery( document ).ready( function() {"; <br/>$output .= "jQuery('.show_closed_bugs').click( function() <br/>                                    { replacecontent( 1 ); } "; <br/>$output .= ")});"; <br/>$output .= "&lt;/script&gt;"; </pre>
<ol start="8">
<li>Add the following line of code at the end of the plugin file to register a function to add content to the page header:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'wp_head', 'ch8bt_declare_ajaxurl' ); </pre>
<ol start="9">
<li>Append the following block of code to provide an implementation for the <kbd>ch8bt_declare_ajaxurl</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch8bt_declare_ajaxurl() { ?&gt; <br/>    &lt;script type="text/javascript"&gt; <br/>        var ajax_url = <br/>            '&lt;?php echo admin_url( 'admin-ajax.php' ); ?&gt;'; <br/>    &lt;/script&gt; <br/>&lt;?php } </pre>
<ol start="10">
<li>Insert the following lines of code to register functions that will be called when AJAX requests are received from public or logged in users with an action variable set to <kbd>ch8bt_buglist_ajax</kbd>:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'wp_ajax_ch8bt_buglist_ajax', 'ch8bt_buglist_ajax' ); <br/>add_action( 'wp_ajax_nopriv_ch8bt_buglist_ajax', <br/>            'ch8bt_buglist_ajax' ); </pre>
<ol start="11">
<li>Add the following block of code to provide an implementation for the <kbd>ch8bt_buglist_ajax</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch8bt_buglist_ajax() { <br/>    check_ajax_referer( 'ch8bt_ajax' ); <br/> <br/>    if ( isset( $_POST['bug_status'] ) &amp;&amp;<br/>         is_numeric( $_POST['bug_status'] ) ) { <br/>        global $wpdb; <br/> <br/>        // Prepare query to retrieve bugs from database <br/>        $bug_query = 'select * from ' . $wpdb-&gt;get_blog_prefix(); <br/>        $bug_query .= 'ch8_bug_data where bug_status = '; <br/>        $bug_query .= intval( $_POST['bug_status'] ); <br/>        $bug_query .= ' ORDER by bug_id DESC'; <br/> <br/>        $bug_items = $wpdb-&gt;get_results(  <br/>            $wpdb-&gt;prepare( $bug_query ), ARRAY_A ); <br/> <br/>        // Prepare output to be returned to AJAX requestor <br/>        $output = '&lt;div class="bug-tracker-list"&gt;&lt;table&gt;'; <br/> <br/>        // Check if any bugs were found <br/>        if ( $bug_items ) {         <br/>            $output .= '&lt;tr&gt;&lt;th style="width: 80px"&gt;ID&lt;/th&gt;'; <br/>            $output .= '&lt;th style="width: 300px"&gt;'; <br/>            $output .= 'Title / Desc&lt;/th&gt;&lt;th&gt;Version&lt;/th&gt;&lt;/tr&gt;'; <br/> <br/>            // Create row in table for each bug <br/>            foreach ( $bug_items as $bug_item ) { <br/>                $output .= '&lt;tr style="background: #FFF"&gt;'; <br/>                $output .= '&lt;td&gt;' . $bug_item['bug_id'] . '&lt;/td&gt;'; <br/>                $output .= '&lt;td&gt;' . $bug_item['bug_title']; <br/>                $output .= '&lt;/td&gt;&lt;td&gt;' . $bug_item['bug_version']; <br/>                $output .= '&lt;/td&gt;&lt;/tr&gt;'; <br/>                $output .= '&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td colspan="2"&gt;'; <br/>                $output .= $bug_item['bug_description']; <br/>                $output .= '&lt;/td&gt;&lt;/tr&gt;'; <br/>            } <br/>        } else { <br/>            // Message displayed if no bugs are found <br/>            $output .= '&lt;tr style="background: #FFF"&gt;'; <br/>            $output .= '&lt;td colspan="3"&gt;No Bugs to Display&lt;/td&gt;'; <br/>        } <br/>        $output .= '&lt;/table&gt;&lt;/div&gt;&lt;br /&gt;';         <br/>        echo $output; <br/>    }     <br/>    die(); <br/>} </pre>
<ol start="12">
<li>Add the following line of code to register a function to be called when scripts are being queued up:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'wp_enqueue_scripts', 'ch8bt_load_jquery' ); </pre>
<ol start="13">
<li>Insert the following code block to provide an implementation for the <kbd>ch8bt_load_query</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch8bt_load_jquery() { <br/>    wp_enqueue_script( 'jquery' );<br/>    wp_enqueue_style( 'bug_tracker_css',<br/>                      plugins_url( 'stylesheet.css', __FILE__ ),<br/>                      array(), '1.0' );<br/>} </pre>
<ol start="14">
<li>Save and close the plugin file.</li>
</ol>
<p> </p>
<ol start="15">
<li>Create a new text file named <kbd>stylesheet.css</kbd> in the plugin directory and insert the following content in the file:</li>
</ol>
<pre style="padding-left: 60px">.show_closed_bugs {<br/>    cursor: pointer;<br/>    color: #00c;<br/>}</pre>
<ol start="16">
<li>Visit the bug listing page that was previously created to see that only opened bugs are displayed.</li>
<li>Click on the link to display closed bugs to see how the list gets quickly replaced with closed issues:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="140" width="284" class="image-border" src="assets/7233c716-dd0b-4bbd-a5b2-acfa93834a6c.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>AJAX page interactions are powered by JavaScript code and allow users to create pages with content that gets dynamically updated. To add this functionality to our bug tracking system, we start this recipe by modifying the existing shortcode bug query to only retrieve entries that have an open status (value of <kbd>0</kbd>).</p>
<p>Once this is done, we move on to add two new elements to the initial shortcode output, a link to display closed bugs and a block of JavaScript code. The link itself is quite simple, containing a class name and a text label that visitors will be able to click. The JavaScript code is a bit more complex. Essentially, the script makes a request for the <kbd>replacecontent</kbd> function to be called when the <kbd>show_closed_bugs</kbd> link is clicked by visitors. In turn, the <kbd>replacecontent</kbd> function contains a single call to the jQuery <kbd>ajax</kbd> function. This function takes a number of arguments, starting with the type of operation, which is set to <kbd>POST</kbd>. This indicates that all the variables sent in the request URL will be stored in a standard <kbd>$_POST</kbd> variable array.</p>
<p>The second parameter is the URL to which the request should be sent. The variable used here is defined in the header code that is generated by the <kbd>ch8bt_declare_ajaxurl</kbd> function and points to the WordPress <kbd>admin-ajax.php</kbd> script URL. While the name of this script starts with the word <kbd>admin</kbd>, it can also be used to process AJAX requests from visitor-facing pages.</p>
<p>After these first two arguments is a <kbd>data</kbd> array that contains a number of data elements, such as the name of the action, a nonce field to secure the request, and the status of the bugs that should be retrieved. Finally, the <kbd>success</kbd> parameter indicates that the data received back from the AJAX request should be used to replace the HTML content of the <kbd>bug-tracker-list</kbd> div section of the existing page.</p>
<p>To process this request, our plugin goes on to register the function <kbd>ch8bt_buglist_ajax</kbd> to be called when one of two variable name actions are matched: <kbd>wp_ajax_&lt;actionname&gt;</kbd> or <kbd>wp_ajax_nopriv_&lt;actionname&gt;</kbd>. In both cases, <kbd>&lt;actionname&gt;</kbd> is the string that was sent as part of the data parameters in the AJAX request. Upon receiving the request, the callback generates an updated bug table, echoes the resulting HTML code, and makes a call to the standard PHP <kbd>die()</kbd> function. While this last step might seem strange, it is needed to avoid having a trailing <kbd>1</kbd> at the end of the new HTML, indicating that AJAX processing was successfully performed by WordPress.</p>
<p>While the <kbd>ch8bt_buglist_ajax</kbd> function shares a lot of code with the existing <kbd>ch8bt_shortcode_list</kbd> function, it is easier to create a separate code block that only contains the necessary elements for this example. That being said, combining the two functions would make future updates to the table layout easier to maintain.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Importing data from a user file into custom tables</em> recipe in <a href="9b139a97-7147-49cf-bd06-d370c6777c86.xhtml"><span class="ChapterrefPACKT">Chapter 8</span></a>, <em>Creating Custom MySQL Database Tables</em></li>
</ul>


            </article>

            
        </section>
    </body></html>