<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Eloquent&#x2026; without Laravel!"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Eloquent… without Laravel!</h1></div></div></div><p>Our journey is close to the end, hero. You learned everything about Eloquent, starting from the very basics and going through models, relationships, and other topics. You probably started to like it and think about implementing it in your next project.</p><p>In fact, creating an application without a single SQL query is tempting. Maybe you also showed it to your boss and convinced him/her to use it in your next production project.</p><p>I am so proud of you, hero!</p><p>However, there is a little problem. Yeah, the next project isn't so new. It already exists, and, despite everything, it doesn't use Laravel! You start to shiver. This is so sad because you passed the last week studying this new ORM, a really cool one, and then moving forward.</p><p>Ok, stop complaining! There is always a solution! You are a developer! Also, the solution is not so hard to find. If you want, you can use Eloquent without Laravel. Yes, seriously!</p><p>Actually, Laravel is not a <span class="emphasis"><em>monolithic</em></span> framework. It is made up of several, separate parts, which are combined together to build something greater. However, nothing prevents you from using only selected packages in another application.</p><p>A really cool idea!</p><p>So, what are we going to see in this chapter?</p><p>First of all, we will explore the structure of the database package and see what is inside it. Then, you will learn how to install the <code class="literal">illuminate/database</code> package separately for your project and how to configure it for the first use.</p><p>Then, you will encounter some examples. First of all, we will look at the <a id="id215" class="indexterm"/>
<span class="strong"><strong>Eloquent ORM</strong></span>. You will learn how to define models and use them.</p><p>Having done this, as a little extra, I will show you how to use the <code class="literal">Query Builder</code> (remember that the <code class="literal">"illuminate/database"</code> package isn't just Eloquent). Maybe you would also enjoy the <code class="literal">Schema Builder</code> class. I will cover it, don't worry!</p><p>À la charge!</p><p>We will cover the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Exploring the directory structure</li><li class="listitem" style="list-style-type: disc">Installing and configuring the database package</li><li class="listitem" style="list-style-type: disc">Using the ORM</li><li class="listitem" style="list-style-type: disc">Using the Query and Schema Builders</li><li class="listitem" style="list-style-type: disc">Summary</li></ul></div><div class="section" title="Exploring the directory structure"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec45"/>Exploring the directory structure</h1></div></div></div><p>As I <a id="id216" class="indexterm"/>mentioned before, the key step in order to use Eloquent in your application without Laravel is to use the <code class="literal">"illuminate/database"</code> package. </p><p>So, before we install it, let's examine it a little. </p><p>You can see the package contents here: <a class="ulink" href="https://github.com/illuminate/database">https://github.com/illuminate/database</a>.</p><p>So, this is what you will probably see:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Folder</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Capsule</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <span class="strong"><strong>capsule manager</strong></span>
<a id="id217" class="indexterm"/> is a fundamental component. It instantiates the service container and loads some dependencies.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Connectors</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The database package can communicate with various DB systems. For instance, SQLite, MySQL, or PostgreSQL. Every type of database has its own connector. This is the folder in which you will find them.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Console</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The database package isn't just Eloquent with a bunch of connectors. In this specific folder, you will find everything related to console commands, such as <code class="literal">artisan db:seed</code> or <code class="literal">artisan migrate</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Eloquent</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Every single Eloquent class is placed here.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Migrations</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Don't confuse this with the <code class="literal">Console</code> folder. Every class related to migrations is stored here. When you type <code class="literal">artisan migrate</code> in your terminal, you are calling a class that is placed here.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Query</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The Query Builder is placed here.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Schema</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Everything related to the Schema Builder is placed here.</p>
</td></tr></tbody></table></div><p>In the <a id="id218" class="indexterm"/>main folder, you will also find some other files. However, don't worry as you don't need to know what they are.</p><p>If you open the <code class="literal">composer.json</code> file, take a look at the following <code class="literal">"require"</code> section:</p><div class="informalexample"><pre class="programlisting">"require": {
  "php": "&gt;=5.4.0",
  "illuminate/container": "5.1.*",
  "illuminate/contracts": "5.1.*",
  "illuminate/support": "5.1.*",
  "nesbot/carbon": "~1.0"
},</pre></div><p>As you can see, the database package has some prerequisites that you can't avoid. However, the container is quite small, and it is the same for <code class="literal">contracts</code> (just some interfaces) and <code class="literal">"illuminate/support"</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note41"/>Note</h3><p>Eloquent uses <code class="literal">Carbon</code> (<a class="ulink" href="https://github.com/briannesbitt/Carbon">https://github.com/briannesbitt/Carbon</a>) to deal with dates in a smarter way. So, if you are seeing this for the first time and you are confused, don't worry! Everything is all right.</p></div></div><p>Now that you know what you can find in this package, let's see how to install it and configure it for the first time.</p></div></div>
<div class="section" title="Installing and configuring the database package"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec46"/>Installing and configuring the database package</h1></div></div></div><p>Let's start with the setup. First of all, we will install the package using composer as usual. After that, we will configure the capsule manager in order to get started.</p><div class="section" title="Installing the package"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec55"/>Installing the package</h2></div></div></div><p>Installing <a id="id219" class="indexterm"/>the <code class="literal">"illuminate/database"</code> package is really easy.</p><p>All you have to do is to<a id="id220" class="indexterm"/> add <code class="literal">"illuminate/database"</code> to the <code class="literal">"require"</code> section of your <code class="literal">composer.json</code> file, like this:</p><div class="informalexample"><pre class="programlisting">"require": {


  "illuminate/database": "5.0.*",

},</pre></div><p>Then type <code class="literal">composer update</code> in to your terminal, and wait for a few seconds.</p><p>Another way<a id="id221" class="indexterm"/> is to include it with the shortcut in your project folder, obviously from the terminal:</p><div class="informalexample"><pre class="programlisting">composer require illuminate/database</pre></div><p>No matter<a id="id222" class="indexterm"/> which method you chose, you just installed the package.</p></div><div class="section" title="Configuring the package"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec56"/>Configuring the package</h2></div></div></div><p>Time to<a id="id223" class="indexterm"/> use <a id="id224" class="indexterm"/>the capsule manager! In your project, you will use something like this to get started:</p><div class="informalexample"><pre class="programlisting">use Illuminate\Database\Capsule\Manager as Capsule;

$capsule = new Capsule;

$capsule-&gt;addConnection([
  'driver'    =&gt; 'mysql',
  'host'      =&gt; 'localhost',
  'database'  =&gt; 'database',
  'username'  =&gt; 'root',
  'password'  =&gt; 'password',
  'charset'   =&gt; 'utf8',
  'collation' =&gt; 'utf8_unicode_ci',
  'prefix'    =&gt; '',
]);


// Set the event dispatcher used by Eloquent models... (optional)
use Illuminate\Events\Dispatcher;
use Illuminate\Container\Container;
$capsule-&gt;setEventDispatcher(new Dispatcher(new Container));</pre></div><p>The config syntax I used is exactly the same you can find in the <code class="literal">config/database.php</code> configuration file. The only difference is that this time you are explicitly using an instance of the capsule manager in order to do everything.</p><p>In the second part of the code, I am setting up the event dispatcher. You must do this if events are required from your project.</p><p>However, events are not included by default in this package, so you will have to manually add the <code class="literal">"illuminate/events"</code> dependency to your <code class="literal">composer.json</code> file.</p><p>Now, the final step!</p><p>Add this<a id="id225" class="indexterm"/> code to your setup file:</p><div class="informalexample"><pre class="programlisting">// Make this Capsule instance available globally via static methods... (optional)
$capsule-&gt;setAsGlobal();

// Setup the Eloquent ORM... (optional; unless you've used setEventDispatcher())
$capsule-&gt;bootEloquent();</pre></div><p>With <a id="id226" class="indexterm"/>
<code class="literal">setAsGlobal()</code> called on the capsule manager, you can set it as a global component in order to use it with static methods. You may like it or not; the choice is yours. The final line starts up Eloquent, so you will need it.</p><p>However, this is also an optional instruction. In some situations you may need the Query Builder only.</p><p>Then there is nothing else to do! Your application is now configured with the database package (and Eloquent)!</p></div></div>
<div class="section" title="Using the ORM"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec47"/>Using the ORM</h1></div></div></div><p>Using <a id="id227" class="indexterm"/>the Eloquent ORM in a non-Laravel application is not a big change. All you have to do is to declare your model as you are used to doing. Then, you need to call it and use it as you are used to.</p><p>Here is a perfect example of what I am talking about:</p><div class="informalexample"><pre class="programlisting">use Illuminate\Database\Eloquent\Model;

class Book extends Model {

  ...

  // some attributes here…
  protected $table = 'my_books_table';

  // some scopes here...
  public function scopeNewest()
  {
    // query here...
  }

  ...

}</pre></div><p>Exactly as you did with Laravel, the package you are using is the same. So, no worries! If you want to use the model you just created, then use the following:</p><div class="informalexample"><pre class="programlisting">$books = Book::newest()-&gt;take(5)-&gt;get();</pre></div><p>This also<a id="id228" class="indexterm"/> applies for relationships, observers, and so on. Everything is the same.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note42"/>Note</h3><p>In order to use the database package and ORM exactly, you would do the same thing you did in Laravel; remember to set up the project structure in a way that follows the PSR-4 autoloading convention.</p></div></div></div>
<div class="section" title="Using the Query and Schema Builder"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec48"/>Using the Query and Schema Builder</h1></div></div></div><p>It's not just about the ORM; with the database package, you can also use the Query and the Schema Builders. Let's discover how!</p><div class="section" title="The Query Builder"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec57"/>The Query Builder</h2></div></div></div><p>The <a id="id229" class="indexterm"/>Query Builder is also very easy to use. The only difference, this time, is that you are passing through the capsule manager object, like this:</p><div class="informalexample"><pre class="programlisting">$books = Capsule::table('books')
             -&gt;where('title', '=', "Michael Strogoff")
             -&gt;first();</pre></div><p>However, the result is still the same.</p><p>Also, if you like the DB facade in Laravel, you can use the capsule manager class in the same way:</p><div class="informalexample"><pre class="programlisting">$book = Capsule::select('select title, pages_count from books where id = ?', array(12));</pre></div></div><div class="section" title="The Schema Builder"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec58"/>The Schema Builder</h2></div></div></div><p>At the<a id="id230" class="indexterm"/> beginning of this book, I showed you the Schema Builder. You learned how to use it with migrations, but now, without Laravel, you don't have migrations.</p><p>However, you can still use the Schema Builder. Like this:</p><div class="informalexample"><pre class="programlisting">Capsule::schema()-&gt;create('books', function($table)
{ 
    $table-&gt;increments(''id'); 
    $table-&gt;string(''title'', 30); 
    $table-&gt;integer(''pages_count''); 
    $table-&gt;decimal(''price'', 5, 2);.
    $table-&gt;text(''description''); 
    $table-&gt;timestamps(); 
});</pre></div><p>Previously, you used to call the <code class="literal">create()</code> method of the <code class="literal">Schema facade</code>. This time is a little different: you will use the <code class="literal">create()</code> method, chained to the <code class="literal">schema()</code> method of the <code class="literal">Capsule</code> class.</p><p>Obviously, you <a id="id231" class="indexterm"/>can use any Schema class method in this way. For instance, you could call something like following:</p><div class="informalexample"><pre class="programlisting">Capsule::schema()-&gt;table('books', function($table)
{
    $table-&gt;string('title', 50)-&gt;change();
    $table-&gt;decimal('special_price', 5, 2);
});</pre></div><p>And you are good to go!</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note43"/>Note</h3><p>Remember that if you want to unlock some Schema Builder-specific features you will need to install other dependencies.</p><p>For example, do you want to rename a column? You will need the <code class="literal">doctrine/dbal</code> dependency package.</p></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec49"/>Summary</h1></div></div></div><p>Yeah, this time, it was quite quick.</p><p>I decided to add this chapter because many people ask me how to use Eloquent without Laravel. Mostly because they like the framework, but they can't migrate an already started project in its entirety.</p><p>Also, I think that it's cool to know, in a certain sense, what you can find under the hood.</p><p>It is always just about curiosity. Curiosity opens new paths, and you have a choice to solve a problem in a new and more elegant way.</p><p>In these few pages, I just scratched the surface. I want to give you some advice: explore the code. The best way to write good code is to read good code.</p><p>And now, to the final chapter!</p></div></body></html>