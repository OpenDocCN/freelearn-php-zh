<html><head></head><body><div class="chapter" title="Chapter&#xA0;1.&#xA0;Getting Started with Phalcon"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Getting Started with Phalcon</h1></div></div></div><p>What is Phalcon? Let's start by quoting from the documentation of the<a id="id0" class="indexterm"/> official website (<a class="ulink" href="http://phalconphp.com/">http://phalconphp.com/</a>):</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"Phalcon is an open source, full stack framework for PHP written as a C-extension, optimized for high performance."</em></span></p></blockquote></div><p>Version 2.0 of Phalcon <a id="id1" class="indexterm"/>was released in April, and it was developed with a new language called <a id="id2" class="indexterm"/>Zephir (<a class="ulink" href="http://zephir-lang.com/">http://zephir-lang.com/</a>). Zephir<a id="id3" class="indexterm"/> was designed especially for developing PHP extensions, and it is quite user friendly for both (PHP and C) developers.</p><p>There are many frameworks out there. The main reasons why we choose Phalcon were for its steep learning curve, speed, and because it is decoupled. (We can use any of its components independently.) If you have some knowledge of the <span class="strong"><strong>Model-View-Controller</strong></span> (<span class="strong"><strong>MVC</strong></span>) <a id="id4" class="indexterm"/>and some experience with any<a id="id5" class="indexterm"/> <span class="strong"><strong>Object-Relational Mapping</strong></span> (<span class="strong"><strong>ORM</strong></span>), you will find working with it pretty straightforward.</p><p>We will start our journey with this first chapter where we will:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Configure our web server</li><li class="listitem" style="list-style-type: disc">Install Phalcon</li><li class="listitem" style="list-style-type: disc">Discuss a bit about how Phalcon works</li></ul></div><p>Before starting, we assume that you are using a *nix environment. Personally, I feel comfortable with Debian distributions, especially Ubuntu, which I am using on a daily basis; so, the installations steps that we will talk about are for Ubuntu. The OS is a matter of personal choice, but I highly recommend any *nix distribution for development. (Even Microsoft decided to open source their ASP.NET for Linux early this year)</p><p>For other types of OS, you will have to search their official documentation, in terms of "how to". This book is intended to be about Phalcon and tutorials on installing different software on different kinds of OS are out of the scope of this book.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>Here is the list of URLs that<a id="id6" class="indexterm"/> contain installation instructions for different operating systems:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/install.html#windows">http://docs.phalconphp.com/en/latest/reference/install.html#windows</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/install.html#mac-os-x">http://docs.phalconphp.com/en/latest/reference/install.html#mac-os-x</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/install.html#freebsd">http://docs.phalconphp.com/en/latest/reference/install.html#freebsd</a></li></ul></div></div></div><p>Senior developers might not agree with me on certain subjects or certain techniques and/or recommendations. In general, as a developer, I think you should analyze what is suitable for you and develop a platform according to your (or client) requirements. In addition, most importantly, there is no such thing as "The Perfect Solution". There is always room for improvement.</p><div class="section" title="Installing the required software"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Installing the required software</h1></div></div></div><p>We need to install the following <a id="id7" class="indexterm"/>software that we are going to use in this book:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">PHP</li><li class="listitem" style="list-style-type: disc">Nginx and Apache</li><li class="listitem" style="list-style-type: disc">MongoDB</li><li class="listitem" style="list-style-type: disc">MySQL</li><li class="listitem" style="list-style-type: disc">GIT</li><li class="listitem" style="list-style-type: disc">Redis</li><li class="listitem" style="list-style-type: disc">Phalcon</li></ul></div><div class="section" title="Installing PHP"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec07"/>Installing PHP</h2></div></div></div><p>You have <a id="id8" class="indexterm"/>probably<a id="id9" class="indexterm"/> already installed PHP on your system since you are reading this book. However, just in case you haven't, here are the simple steps to quickly install the latest PHP version (Phalcon is running on PHP version &gt;= 5.3). I recommend you to use the <a id="id10" class="indexterm"/>
<span class="strong"><strong>Personal Package Archive</strong></span> (<span class="strong"><strong>PPA</strong></span>) from Ondřej Surý (<a class="ulink" href="https://launchpad.net/~ondrej/+archive/ubuntu/php5">https://launchpad.net/~ondrej/+archive/ubuntu/php5</a>) because it has the latest PHP version available on it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo add-apt-repository ppa:ondrej/php5</strong></span>
<span class="strong"><strong>$ sudo apt-get update</strong></span>
</pre></div><p>If you don't want to use this step, you can simply install PHP from the official repositories:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install php</strong></span>
</pre></div><p>Apache will be installed by default with PHP. However, if you want Nginx instead of Apache, you must install PHP in a certain order.</p><p>The following <a id="id11" class="indexterm"/>command will <span class="strong"><strong>automatically install PHP and Apache. </strong></span>If you don't <a id="id12" class="indexterm"/>need/want to use Apache, please skip using this command<span class="strong"><strong>:</strong></span></p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install php5 php5-fpm</strong></span>
</pre></div><p>To avoid Apache installation, execute the following commands in the exact same order:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install php5-common</strong></span>
<span class="strong"><strong>$ sudo apt-get install php5-cgi</strong></span>
<span class="strong"><strong>$ sudo apt-get install php5 php5-fpm</strong></span>
</pre></div><p>The <code class="literal">php5-cgi</code> package<a id="id13" class="indexterm"/> fulfills the dependencies that would otherwise be fulfilled by Apache.</p></div><div class="section" title="Installing Nginx"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Installing Nginx</h2></div></div></div><p>To install the <a id="id14" class="indexterm"/>Nginx web server, we need to execute the following <a id="id15" class="indexterm"/>commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo add-apt-repository ppa:nginx/stable</strong></span>
<span class="strong"><strong>$ sudo apt-get update</strong></span>
<span class="strong"><strong>$ sudo apt-get install nginx</strong></span>
</pre></div></div><div class="section" title="Installing MySQL"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec09"/>Installing MySQL</h2></div></div></div><p>MySQL<a id="id16" class="indexterm"/> is probably the most widely spread RDBMS system with a market share<a id="id17" class="indexterm"/> that is greater than 50 percent. Since we are going to use it to develop our project, we need to install it by executing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install mysql-server</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note002"/>Note</h3><p><span class="strong"><strong>Downloading the example code</strong></span></p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div></div><div class="section" title="Installing Redis"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec10"/>Installing Redis</h2></div></div></div><p><span class="strong"><strong>Redis</strong></span> is an<a id="id18" class="indexterm"/> advanced key-value storage/cache system. We are going to use this mostly<a id="id19" class="indexterm"/> for our session and to cache objects to improve the speed of our application. Let's install it by executing the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo add-apt-repository ppa:chris-lea/redis-server</strong></span>
<span class="strong"><strong>$ sudo apt-get update</strong></span>
<span class="strong"><strong>$ sudo apt-get install redis-server</strong></span>
<span class="strong"><strong>$ sudo apt-get install php5-redis</strong></span>
</pre></div></div><div class="section" title="Installing MongoDB"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec11"/>Installing MongoDB</h2></div></div></div><p>MongoDB<a id="id20" class="indexterm"/> is a <a id="id21" class="indexterm"/>document database (NoSQL database) system. We will use this to store data that is accessed frequently. Let's install it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 7F0CEB10</strong></span>
<span class="strong"><strong>$ echo 'deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen' | sudo tee /etc/apt/sources.list.d/mongodb.list</strong></span>
<span class="strong"><strong>$ sudo apt-get update</strong></span>
<span class="strong"><strong>$ sudo apt-get install -y mongodb-org</strong></span>
<span class="strong"><strong>$ sudo service mongodb start</strong></span>
<span class="strong"><strong>$ sudo apt-get install php5-mongo</strong></span>
</pre></div></div><div class="section" title="Installing Git"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec12"/>Installing Git</h2></div></div></div><p>Git is a <a id="id22" class="indexterm"/>distributed version control system that we will use to track changes to our <a id="id23" class="indexterm"/>application and much more. We will install Git by executing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install git</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip02"/>Tip</h3><p>I strongly recommend that you use the latest versions of all software as much as possible.</p></div></div></div></div></div>
<div class="section" title="Installing Phalcon"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Installing Phalcon</h1></div></div></div><p>Now that we have<a id="id24" class="indexterm"/> installed all the required software, we will proceed with the<a id="id25" class="indexterm"/> installation of Phalcon. Before we continue, we must install some dependencies:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install php5-dev libpcre3-dev gcc make php5-mysql</strong></span>
</pre></div><p>For Windows systems and more details about how to compile the extension on different systems, please check the latest documentation<a id="id26" class="indexterm"/> at <a class="ulink" href="http://phalconphp.com/en/download">http://phalconphp.com/en/download</a>.</p><p>Now, we can clone the repository and compile our extension:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ git clone --depth=1 git://github.com/phalcon/cphalcon.git</strong></span>
<span class="strong"><strong>$ cd cphalcon/build</strong></span>
<span class="strong"><strong>$ sudo ./install</strong></span>
<span class="strong"><strong>$ echo 'extension=phalcon.so' | sudo tee /etc/php5/mods-available/phalcon.ini</strong></span>

<span class="strong"><strong>$ sudo php5enmod phalcon</strong></span>
<span class="strong"><strong>$ sudo service php5-fpm restart</strong></span>
</pre></div><p>If everything goes well, you<a id="id27" class="indexterm"/> should be <a id="id28" class="indexterm"/>able to see Phalcon in the list of PHP installed modules:</p><div class="informalexample"><pre class="programlisting">$ php -m | grep phalcon</pre></div></div>
<div class="section" title="The Apache and Nginx configuration files"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec10"/>The Apache and Nginx configuration files</h1></div></div></div><p>We will use <code class="literal">/var/www/learning-phalcon.localhost</code> as the default directory for our project, and we will refer to it as the<a id="id29" class="indexterm"/> <span class="strong"><strong>root folder</strong></span>. Please create this folder:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo mkdir -p /var/www/learning-phalcon.localhost/public</strong></span>
</pre></div><p>Of course, if you want, you can use another folder. Let's create a test file in our <code class="literal">public</code> folder under the root directory with some PHP content:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd /var/www/learning-phalcon.localhost/public</strong></span>
<span class="strong"><strong>$ echo "&lt;?php date();" &gt; index.php</strong></span>
</pre></div><div class="section" title="Apache"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec13"/>Apache</h2></div></div></div><p>Let's switch<a id="id30" class="indexterm"/> to the default directory where Apache holds the<a id="id31" class="indexterm"/> configuration files for the available websites, using the command line: <code class="literal">$ cd /etc/apache2/sites-available/</code>. After that, perform the following set of steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Using your favorite editor, create a file named <code class="literal">learning-phalcon.localhost</code> for apache version &lt; 2.4 or <code class="literal">learning-phalcon.localhost.conf</code> for apache version &gt;= 2.4:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vim learning-phalcon.localhost.conf</strong></span>
</pre></div></li><li class="listitem">Now, paste the following content to this file:<div class="informalexample"><pre class="programlisting">&lt;VirtualHost *:80&gt;
    DocumentRoot "/var/www/learning-phalcon.localhost"
    DirectoryIndex index.php
    ServerName learning-phalcon.localhost
    ServerAlias www.learning-phalcon.localhost

    &lt;Directory "/var/www/learning-phalcon.localhost/public"&gt;
        Options All
        AllowOverride All
        Allow from all
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;</pre></div></li><li class="listitem">Then, switch to the public folder and add a file named <code class="literal">.htaccess</code> to it:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd /var/www/learning-phalcon.localhost/public</strong></span>
<span class="strong"><strong>$ vim .htaccess</strong></span>
</pre></div></li><li class="listitem">Then, add the <a id="id32" class="indexterm"/>following content to the <code class="literal">.htaccess</code> file:<div class="informalexample"><pre class="programlisting">&lt;IfModule mod_rewrite.c&gt;
    RewriteEngine On
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^(.*)$ index.php?_url=/$1 [QSA,L]
&lt;/IfModule&gt;</pre></div></li><li class="listitem">This will not<a id="id33" class="indexterm"/> work unless you have enabled <code class="literal">mod_rewrite</code>. To do so, execute this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo a2enmod rewrite</strong></span>
</pre></div></li><li class="listitem">Now that we have configured our virtual host, let's enable it:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo a2ensite learning-phalcon.localhost</strong></span>
<span class="strong"><strong>$ sudo service apache2 reload</strong></span>
</pre></div></li></ol></div></div><div class="section" title="The host file"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec14"/>The host file</h2></div></div></div><p>If you open a <a id="id34" class="indexterm"/>browser and type <code class="literal">http://www.learning-phalcon.localhost/</code>, you'll receive a host not found or connection error. This is because there is no name resolver for this<a id="id35" class="indexterm"/> <span class="strong"><strong>TLD</strong></span> (short for <span class="strong"><strong>Top Level Domain</strong></span>). To fix this, we edit our host file and add this name:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ echo "127.0.0.1 learning-phalcon.localhost www.learning-phalcon.localhost" | sudo tee /etc/hosts</strong></span>
</pre></div><p>Restart your browser and type the address <code class="literal">http://www.learning-phalcon.localhost/</code> again. If everything goes well, you should see the current date/time.</p></div><div class="section" title="Nginx"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec15"/>Nginx</h2></div></div></div><p>If you choose to use <a id="id36" class="indexterm"/>Nginx (which I recommend, especially because it<a id="id37" class="indexterm"/> can serve more concurrent clients with higher throughput, and it serves static content more efficiently) instead of Apache, here is what you need to do:</p><p>Locate the <code class="literal">config</code> folder of Nginx (in Ubuntu, it is installed under <code class="literal">/etc/nginx/</code>). Create a file <a id="id38" class="indexterm"/>named <code class="literal">learning-phalcon.localhost</code> in your <code class="literal">sites-available</code> <a id="id39" class="indexterm"/>folder (by navigating to <code class="literal">/etc/nginx/sites-available</code>):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd /etc/nginx/sites-available</strong></span>
<span class="strong"><strong>$ vim learning-phalcon.localhost</strong></span>
</pre></div><p>Now, add the following content to it:</p><div class="informalexample"><pre class="programlisting">server {
    listen 80;
    server_name learning-phalcon.localhost;

    index index.php;
    set $root_path "/var/www/learning-phalcon.localhost/public";
    root $root_path;

    client_max_body_size 10M;

    try_files $uri $uri/ @rewrite;

    location @rewrite {
        rewrite ^/(.*)$ /index.php?_url=/$1;
    }

    location ~ \.php {
        fastcgi_index /index.php;
        fastcgi_pass unix:/var/run/php5-fpm.sock;
        fastcgi_intercept_errors on;
        include fastcgi_params;

        fastcgi_split_path_info ^(.+\.php)(/.*)$;

        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        fastcgi_param SCRIPT_FILENAME $realpath_root/index.php;
    }

    location ~* ^/(css|img|js|flv|swf|download)/(.+)$ {
        root $root_path;
    }

    location ~ /\.ht {
        deny all;
    }
}
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note03"/>Note</h3><p>In some environments, you might need to edit your <code class="literal">php.ini</code> file and set <code class="literal">cgi.fix_pathinfo = 0</code>.</p></div></div><p>Then, save the file and restart Nginx:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo service nginx restart</strong></span>
</pre></div><p>Please edit and<a id="id40" class="indexterm"/> save your host file (check <span class="emphasis"><em>The host file</em></span> section), then <a id="id41" class="indexterm"/>open your browser and type <code class="literal">http://www.learning-phalcon.localhost/</code>. At this point, you should see a page that shows the current date/time.</p><p>There are many possible methods to install and configure PHP and Apache/Nginx. Feel free to do a simple Google search and choose one that fits you better, if my method is not the optimal one for your needs.</p><p>Assuming that everything went well until now, we will go further by learning a little bit about Phalcon's internals.</p></div></div>
<div class="section" title="Understanding the framework's internals"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Understanding the framework's internals</h1></div></div></div><p>In this section, I will try <a id="id42" class="indexterm"/>to make a short introduction to the common parts of the framework. Most of the text presented here is part of the official documentation that you should always read. The idea of this section is to make you familiar with the most common methods and components that will help you to understand quickly how the framework works.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip03"/>Tip</h3><p>Please note that images in this book might contain the text <a class="ulink" href="http://learning-phalcon.dev">http://learning-phalcon.dev</a>. You need to ignore that and use <code class="literal">http://learning-phalcon.localhost</code> as suggested in the chapter.</p></div></div><div class="section" title="The dependency injection"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec16"/>The dependency injection</h2></div></div></div><p>Probably one of the most <a id="id43" class="indexterm"/>powerful characteristics of Phalcon is the <a id="id44" class="indexterm"/>
<span class="strong"><strong>dependency injection</strong></span> (<span class="strong"><strong>DI</strong></span>). If you have no idea about dependency injection, you should read at <a id="id45" class="indexterm"/>least the wiki page for this design pattern at <a class="ulink" href="http://en.wikipedia.org/wiki/Dependency_injection">http://en.wikipedia.org/wiki/Dependency_injection</a>:</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"Dependency injection is a software design pattern that implements inversion of control for resolving dependencies. An injection is the passing of a dependency (a service or software module) to a dependent object (a client). The service is made part of the client's state. Passing the service to the client, rather than allowing a client to build or find the service, is the fundamental requirement of the pattern.</em></span></p><p><span class="emphasis"><em>Dependency injection allows a program design to follow the dependency inversion principle."</em></span></p></blockquote></div><p>The term "Dependency injection" was coined by Martin Fowler.</p><p>A real-life <a id="id46" class="indexterm"/>example of dependency injection might<a id="id47" class="indexterm"/> be the following situation: Suppose you go shopping. At the mall, you will need a bag to put your groceries, but you forgot to take one when you left your home. In this case, you will need to buy a bag. In development, buying this bag can be quite expensive. So, what if your door has a scanner that scans your body for a bag, and will not open unless you have one? This can be called dependency injection.</p><p>Phalcon uses the <code class="literal">\Phalcon\DI</code> component, which is a component that implements the Inversion of Control pattern. This reduces the overall code complexity.</p><p>The framework itself or the developer can register services. Phalcon has many built-in components that are available in the DI container, such as the following ones:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Request and response</li><li class="listitem" style="list-style-type: disc">Logger</li><li class="listitem" style="list-style-type: disc">Crypt</li><li class="listitem" style="list-style-type: disc">Flash</li><li class="listitem" style="list-style-type: disc">Router and configuration</li><li class="listitem" style="list-style-type: disc">View</li><li class="listitem" style="list-style-type: disc">Cache</li><li class="listitem" style="list-style-type: disc">Session</li></ul></div><p>Setting up a new component in the DI is as easy as the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$di = new Phalcon\DI();
// Lazy load
$di['mail'] = function() {
  return new \MyApp\Mail();
};</pre></div><p>When you need to access the "mail" component, in a controller for example, you can simply call it:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$mail = $this-&gt;getID()-&gt;get('mail');
// or
$mail = $this-&gt;getDI()-&gt;getMail();</pre></div><p>If you need to create your own DI, Phalcon or the <code class="literal">DiInterface</code> interface must be implemented to replace the one provided by Phalcon, or you must extend the current one.</p><p>These are just a few <a id="id48" class="indexterm"/>dummy examples so that you can have <a id="id49" class="indexterm"/>an idea about Phalcon's DI by the time we start our project. In the meanwhile, please take your time and read the official <a id="id50" class="indexterm"/>documentation that can be found at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/di.html">http://docs.phalconphp.com/en/latest/reference/di.html</a>.</p><div class="section" title="The request component"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec01"/>The request component</h3></div></div></div><p>The request component<a id="id51" class="indexterm"/> is probably one of the most used<a id="id52" class="indexterm"/> components in any framework. It handles any HTTP request (such as GET, POST, or DELETE, among others) and also provides a few shortcuts for the <code class="literal">$_SERVER</code> variable. Most of the time, we will use the request component in the controllers. The Phalcon<a id="id53" class="indexterm"/> documentation (<a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/mvc.html">http://docs.phalconphp.com/en/latest/reference/mvc.html</a>) states the following:</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"The controllers provide the "flow" between models and views. Controllers are responsible for processing the incoming requests from the web browser, interrogating the models for data, and passing that data on to the views for presentation."</em></span></p></blockquote></div><p>In Phalcon, all controllers should extend the <code class="literal">\Phalcon\Mvc\Controller</code> component, and the name of the public methods that we want to access via HTTP GET should have the suffix <code class="literal">Action</code>. For example:</p><div class="informalexample"><pre class="programlisting">&lt;?php

class ArticleController extends \Phalcon\Mvc\Controller
{
  // Method for rendering the form to create an article
  public function createAction()
  {
  }

  // Method for searching articles
  public function searchAction()
  {
  }

  // This method will not be accessible via http GET
  public function search()
  {
  }
}</pre></div><p>Okay. So, how do we use<a id="id54" class="indexterm"/> the request component? Easy! Do you<a id="id55" class="indexterm"/> remember that we talked about built-in components in the DI section? The request component is one of them. All we need to do is get the DI. Here is an example of how to get and use the request component:</p><div class="informalexample"><pre class="programlisting">&lt;?php

class ArticleController extends \Phalcon\Mvc\Controller
{
  public function searchAction()
  {
    $request = $this-&gt;getDI()-&gt;get('request');
    // You can also use $request = $this-&gt;request; but I don't
    // recommend it because $this-&gt;request can be easily overwritten
    // by mistake and you will spend time to debug ... nothing.

    $request-&gt;getMethod(); // Check the request method
    $request-&gt;isAjax(); // Checks if the request is an ajax request
    $request-&gt;get(); // Gets everything, from the request (GET, POST, DELETE, PUT)
    $request-&gt;getPost(); // Gets all the data submitted via POST method
    $request-&gt;getClientAddress(); // Return the client IP
  }
}</pre></div><p>These are just a few common methods that are built into the request component. Let's continue with the next important component—Response.</p></div><div class="section" title="The response component"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec02"/>The response component</h3></div></div></div><p>So, what can this<a id="id56" class="indexterm"/> component do? Well, pretty much everything <a id="id57" class="indexterm"/>that is response or output related. Using it, we can set headers, do redirects, send cookies, set content, and much more. Here is a list of common methods from this component:</p><div class="informalexample"><pre class="programlisting">&lt;?php

public function testRedirectAction()
{
  $response = $this-&gt;getDI()-&gt;get('response');
   // or you can use $this-&gt;response directly
  
  // Redirect the user to another url
  $this-&gt;view-&gt;disable();
  return $response-&gt;redirect('http://www.google.com/', true);
}</pre></div><p>The <code class="literal">redirect</code> method accepts three parameters: a location (string), if it is an external redirect (this is a Boolean type which is by default <code class="literal">false</code>), and a status code (http status code range). The following <a id="id58" class="indexterm"/>lines of code is the redirect<a id="id59" class="indexterm"/> method:</p><div class="informalexample"><pre class="programlisting">  &lt;?php</pre></div><div class="informalexample"><pre class="programlisting">  /**
  * Redirect by HTTP to another action or URL
  *
  * @param string $location
  * @param boolean $externalRedirect
  * @param int $statusCode
  * @return \Phalcon\Http\ResponseInterface
  */
  public function redirect($location, $externalRedirect, $statusCode);</pre></div><p>Another useful method is the <code class="literal">setHeader</code> method:</p><div class="informalexample"><pre class="programlisting">&lt;?php

public function testSetHeaderAction()
{
  $this-&gt;response-&gt;setHeader('APIKEY', 'AWQ23XX258561');
}</pre></div><p>The preceding example sets a header named <code class="literal">APIKEY</code> with the value as <code class="literal">AWQ23XX258561</code>. Sending headers is a common approach when you develop APIs. You can send any type of headers and overwrite current headers using this method.</p><p>Content related methods: <code class="literal">setContent()</code> and <code class="literal">setJsonContent()</code>. Let's take for example the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php

public function testContentAction()
{
  // First, we disable the view if there is any
  $this-&gt;view-&gt;disable();
  
  // Set a plain/text or html content
  $this-&gt;response-&gt;setContent('I love PhalconPHP');

  // OR

  // Set a json content (this will return a json object)
  $this-&gt;response-&gt;setJsonContent(array(
    'framework' =&gt; 'PhalconPHP'
    'versions' =&gt; array(
      '1.3.2',
      '1.3.3',
      '2.0.0'
    )
  ));

  // We send the output to the client
  return $this-&gt;response-&gt;send();
}</pre></div><p>When you need to send any <a id="id60" class="indexterm"/>JSON content, you should set the<a id="id61" class="indexterm"/> header as <code class="literal">application/json</code> using the built-in method in the response object:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$this-&gt;response-&gt;setContentType('application/json', 'UTF-8');</pre></div><p>Now that we know the basics about response/request components, we might find ourselves in a situation where we may need to log different things, such as errors. For this, we need to check the logger component.</p></div><div class="section" title="The logger component"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec03"/>The logger component</h3></div></div></div><p>In a production <a id="id62" class="indexterm"/>environment, we<a id="id63" class="indexterm"/> cannot afford to throw errors or blank pages at the client. We will avoid this and log the errors in a log file. You will read more about this in the next chapters. To sum it up, we will implement a custom logger to our DI, catch exceptions, and then log them. For example, perform the following set of steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Set the custom logger in DI using the following code:<div class="informalexample"><pre class="programlisting">&lt;?php

$di['logger'] = function() {
  $error_file = __DIR__.'/../logs/'.date("Ymd_error").'log';
  return new \Phalcon\Logger\Adapter\File($error_file, array('mode' =&gt; 'a+'));
};</pre></div></li><li class="listitem">Create a method that will throw an exception, catch it, and log it, as follows:<div class="informalexample"><pre class="programlisting">&lt;?php

public function testLoggerAction()
{
  try {
    $nonExistingComponent = $this-&gt;getDI()-&gt;get('nonExistingComponent');
    $nonExistingComponent-&gt;executeNonExistingMethod();
  } catch (\Exception $e) {
    $this-&gt;logger-&gt;error($e-&gt;getMessage());
    return $this-&gt;response-&gt;redirect('error/500.html');
  }
}</pre></div></li></ol></div><p>In the preceding <a id="id64" class="indexterm"/>example, we try to execute a nonexistent method, and <a id="id65" class="indexterm"/>our code will throw an exception that we catch. It will log it and then redirect the user to a friendly error page, <code class="literal">error/500.html</code>. You will notice that our logger component calls a method named <code class="literal">error</code>. There are other methods that are implemented, such as, <code class="literal">debug</code>, <code class="literal">info</code>, <code class="literal">notice</code>, <code class="literal">warning</code>, and so on.</p><p>The <code class="literal">logger</code> component can be transactional. (Phalcon stores the logs temporarily in memory, and later on, it writes the data to the relevant adapter.) For example, consider the following code snippet:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$this-&gt;logger-&gt;begin();

$this-&gt;logger-&gt;error('Ooops ! Error !');
$this-&gt;logger-&gt;warning('A warning message');

$this-&gt;logger-&gt;commit();</pre></div></div><div class="section" title="The crypt component"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec04"/>The crypt component</h3></div></div></div><p>Crypt is<a id="id66" class="indexterm"/> a very useful<a id="id67" class="indexterm"/> component if someone needs to encrypt data and decrypt it on your side. One situation where you might want to use the crypt component is to send data over the HTTP <code class="literal">get</code> method or save sensitive information in your database.</p><p>This component has many built-in methods such as <code class="literal">encrypt</code>, <code class="literal">decrypt</code>, <code class="literal">getAvailableChipers</code>, <code class="literal">setKey</code>, <code class="literal">getKey</code>, and so on. Here is an example of using the crypt component in the HTTP <code class="literal">get</code> method.</p><p>First, we overwrite the DI, and then we pass a key to it in order to avoid setting it every time:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$di['crypt'] = function () {
  $crypt = new \Phalcon\Crypt();
  $crypt-&gt;setKey('0urSup3rS3cr3tK3y!?');

  return $crypt;  
};

public function sendActivationAction()
{
  $activation_code = $this-&gt;crypt-&gt;encryptBase64('1234');
  $this-&gt;view-&gt;setVar('activation_code', $activation_code);
}

public function getActivationAction($code)
{
  if ('1234' == $this-&gt;crypt-&gt;decryptBase64($code)) {
    $this-&gt;flash-&gt;success('The code is valid ');
  } else {
    $this-&gt;flash-&gt;error('The code is invalid');
  }
}</pre></div><p>Of course, you <a id="id68" class="indexterm"/>are probably never going to use it this way. The preceding example just <a id="id69" class="indexterm"/>demonstrates the power of this component. You might have noticed that there is a new DI method called flash. We are going to talk about it next.</p></div><div class="section" title="The flash component"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec05"/>The flash component</h3></div></div></div><p>This component<a id="id70" class="indexterm"/> is used to<a id="id71" class="indexterm"/> send notifications to the client and inform him or her about the status of the component's actions. For example, we can send a successful message after a user has completed the registration on our website or submitted a contact form.</p><p>There are two kinds of flash messages—direct and session—and both are available in DI. The direct method outputs the message directly and cannot be loaded on a future request. On the contrary, the session method, stores the messages in a session, and they are automatically cleared after they are printed.</p><p>Here is a common usage of flash direct and flash session, assuming that you have a page called register, and you post the data on the same page:</p><div class="informalexample"><pre class="programlisting">public function registerAction()
{
  // … code
  if ($errors) {  
    $this-&gt;flash-&gt;warning('Please fix the following errors: ');
    foreach($errors as $error) {
      $this-&gt;flash-&gt;error($error);
    }
  } else {
    $this-&gt;flash-&gt;success('You have successfully registered on our website');
  }
}  </pre></div><p>In our view, we will <a id="id72" class="indexterm"/>render the messages using the <code class="literal">getContent()</code> method <a id="id73" class="indexterm"/>or <code class="literal">content()</code> in the template engine<a id="id74" class="indexterm"/> <span class="strong"><strong>Volt</strong></span> (we'll cover this later in the chapter).</p><p>If we need to redirect our user to another page (let's call it <code class="literal">registerSuccess</code>), then we need to use the flash session method; otherwise, the message will not appear.</p><div class="informalexample"><pre class="programlisting">&lt;?php

public function registerAction()
{
  // render our template
}</pre></div><p>The <code class="literal">register</code> template will contain a form with method <code class="literal">post</code> and <code class="literal">action</code> pointing to the <code class="literal">create</code> method. The <code class="literal">create</code> method will look something like this:</p><div class="informalexample"><pre class="programlisting">&lt;?php

public function createAction()
{
  if ($errors) {  
    $this-&gt;flashSession-&gt;warning('Please fix the following errors: ');
    foreach($errors as $error) {
      $this-&gt;flashSession-&gt;error($error);
    }
  } else {
    $this-&gt;flashSession-&gt;success('You have successfully registered on our website');
  }

  return $this-&gt;response-&gt;redirect('/register');
}</pre></div><p>In the preceding <a id="id75" class="indexterm"/>example, we set the messages in the session using <a id="id76" class="indexterm"/>the <code class="literal">flashSession</code> method, and we redirect the user back to the register page. In order to render the messages in our view, we need to call the method <code class="literal">flashSession()-&gt;output();</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip04"/>Tip</h3><p>The recommended way is to forward the request with the help of dispatcher, not using redirects. If you use redirects, the user will lose all the data that he or she filled in the form.</p></div></div></div><div class="section" title="The router component"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec06"/>The router component</h3></div></div></div><p>The router component<a id="id77" class="indexterm"/> helps us to map friendly URLs to our<a id="id78" class="indexterm"/> controllers and actions.</p><p>By default, if the rewrite module is enabled in your web server, you will be able to access a controller named <code class="literal">Post</code> and the <code class="literal">read</code> action<a id="id79" class="indexterm"/> like this: <code class="literal">http://www.learning-phalcon.localhost/post/read</code>. Our code can look like this:</p><div class="informalexample"><pre class="programlisting">&lt;?php

class PostController extends \Phalcon\Mvc\Controller
{
  public function readAction()
  {
    // get the post
  }
}</pre></div><p>However, sometimes, this code is not apt if you need to translate the URLs into multiple languages, or if you need to name the URLs in a different way to how they are defined in the code. Here is a usage example for the router component:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$router = new \Phalcon\Mvc\Router();
// Clear the default routes
$router-&gt;clear();

$st_categories = array(
  'entertainment',
  'travel',
  'video'
);

$s_categories = implode('|', $st_categories);

$router-&gt;add('#^/('.$s_categories.')[/]{0,1}$#', array(
    'module' =&gt; 'frontend',
    'controller' =&gt; 'post',
    'action' =&gt; 'findByCategorySlug',
    'slug' =&gt; 0
));</pre></div><p>In the preceding example, we <a id="id80" class="indexterm"/>map all the categories to the <a id="id81" class="indexterm"/>controller <code class="literal">post</code> and action <code class="literal">findByCategorySlug</code>. The router component allows us to use regular expressions for our URLs. With <code class="literal">preg_match</code>, this can be represented as follows</p><div class="informalexample"><pre class="programlisting">$url = 'http://www.learning-phalcon.localhost/video';
preg_match('#^/(entertainment|travel|video)[/]{0,1}$#', $url);</pre></div><p>By accessing <code class="literal">http://www.learning-phalcon.localhost/video</code>, the request will be forwarded to the <code class="literal">findByCategorySlug</code> action from the post controller:</p><div class="informalexample"><pre class="programlisting">&lt;?php

class PostController extends \Phalcon\Mvc\Controller
{
  public function findByCategorySlug()
  {
    $slug = $this-&gt;dispatcher-&gt;getParam('slug', array('string', 'striptags'), null);

    // We access our model (entity) to get all the posts from this category
    $posts = Posts::findByCategorySlug($slug);

    if ($posts-&gt;count() &gt; 0) {
      $this-&gt;view-&gt;setVar('posts', $posts);
    } else {
      throw new \Exception('There are no posts', 404);
    }
  }
}</pre></div><p>The <code class="literal">getParam()</code> method has three parameters. The first one is the name that we are searching for, the second parameter is an array of filters that can be applied automatically, and the third parameter is the default value in case the requested name does not exist or is not set.</p><p>We will discuss models in the next chapter. This was just a simple example of how you can use the router.</p><p>The router also supports <a id="id82" class="indexterm"/>a precheck of the <code class="literal">request</code> method. You may be <a id="id83" class="indexterm"/>used to check whether the method is POST, DELETE, PUT, or GET, like this:</p><div class="informalexample"><pre class="programlisting">&lt;?php

if ($_SERVER['REQUEST_METHOD'] == 'post') {
  // process the information
}</pre></div><p>While this is perfectly correct, it is not very friendly for our code. Phalcon's router has this capability by which you can add the right type of request that you are expecting, without the need to check this in your code:</p><div class="informalexample"><pre class="programlisting">&lt;?php

// Add a get route for register method within the user controller
$router-&gt;addGet('register', 'User::register');

// Add a post route for create method, from the user controller
$router-&gt;addPost('create', 'User::create');</pre></div><p>This is the basic usage of the router. As always, please read the documentation in order to learn everything about this component.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip05"/>Tip</h3><p>You can find out more about<a id="id84" class="indexterm"/> routing on the official documentation at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/routing.html">http://docs.phalconphp.com/en/latest/reference/routing.html</a>.</p></div></div></div><div class="section" title="The config component"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec07"/>The config component</h3></div></div></div><p>This component can handle <a id="id85" class="indexterm"/>configuration files of various formats by<a id="id86" class="indexterm"/> using adapters. Phalcon has two built-in adapters for it, which are INI and Array. Using INI files is probably never a good idea. Therefore, I recommend you to make use of native arrays.</p><p>What kind of data can or needs to be stored in these files? Well, pretty much everything that will be needed globally in our application, such as database connection parameters. In the old days, we used <code class="literal">$_GLOBALS</code> (a big security issue), or we used the <code class="literal">define()</code> method, and then gradually we started using it globally.</p><p>Here is an example of a <code class="literal">config</code> file, and how we can use it:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$st_settings = array(
  'database' =&gt; array(
    'adapter'  =&gt; 'Mysql',
    'host'     =&gt; 'localhost',
    'username' =&gt; 'john',
    'password' =&gt; 'johndoe',
    'dbname'     =&gt; 'test_database',
  ),
  'app' =&gt; array(
    'name' =&gt; 'Learning Phalcon'
  )
);

$config = new \Phalcon\Config($st_settings);

// Get our application name:
echo $config-&gt;app-&gt;name; // Will output Learning Phalcon</pre></div><p>The <code class="literal">config</code> object can be <a id="id87" class="indexterm"/>converted back to an array by <a id="id88" class="indexterm"/>using <code class="literal">toArray()</code> method:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$st_config = $config-&gt;toArray();
echo $config['app']['name']; // Will output Learning Phalcon</pre></div><p>Another useful method for this object is the <code class="literal">merge</code> method. If we have multiple configuration files, we can easily merge them into one object:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$config = array(
  'database' =&gt; array(
    'adapter'  =&gt; 'Mysql',
    'host'     =&gt; 'localhost',
    'dbname'     =&gt; 'test_database',
  ),
  'app' =&gt; array(
    'name' =&gt; 'Learning Phalcon'
  )
);

$config2 = array(
  'database' =&gt; array(
    'username' =&gt; 'john',
    'password' =&gt; 'johndoe',
  )</pre></div><p>Now, the <code class="literal">$config</code> object <a id="id89" class="indexterm"/>will have the same content as it did <a id="id90" class="indexterm"/>before.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip06"/>Tip</h3><p>There are two other adapters that are not implemented yet (YAML and JSON), but you can use them if you clone Phalcon's incubator repository<a id="id91" class="indexterm"/> (<a class="ulink" href="https://github.com/phalcon/incubator">https://github.com/phalcon/incubator</a>). This repository contains a collection of adapters/helpers that might be integrated in Phalcon in the near future.</p></div></div></div><div class="section" title="The view component"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec08"/>The view component</h3></div></div></div><p>This <a id="id92" class="indexterm"/>component is used to<a id="id93" class="indexterm"/> render our templates. By default, the templates have the <code class="literal">.phtml</code> extension, and they contain HTML and PHP code. Here are some examples on how to use the view:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we set up the view in the DI using the following code snippet:<div class="informalexample"><pre class="programlisting">&lt;?php

$di['view'] = function () use ($config) {
  $view = \Phacon\Mvc\View();
  // Assuming that we hold our views directory in the configuration file
  $view-&gt;setViewsDir($config-&gt;view-&gt;dir);

  return $view;
};  </pre></div></li><li class="listitem">Now, we can use this service as follows:<div class="informalexample"><pre class="programlisting">&lt;?php

class PostControler extends \Phalcon\Mvc\Controller
{
  public function listAction()
  {
    // Retrieve posts from DB
    $posts = Post:find();
    $this-&gt;view-&gt;setVar('pageTitle', 'Posts');
    $this-&gt;view-&gt;setVar('posts', $posts);
  }
}</pre></div></li><li class="listitem">Next, we need to create a view template that must look like this:<div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset="UTF-8"&gt;
&lt;title&gt;&lt;?php echo $pageTitle; ?&gt;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;?php foreach($posts as $post) { ?&gt;
  &lt;p&gt;&lt;?php echo $post-&gt;getPostTitle(); ?&gt;&lt;/p&gt;
  &lt;p&gt;&lt;?php echo $post-&gt;getPostContent(); ?&gt;&lt;/p&gt;
&lt;?php } ?&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></li></ol></div><p>Simple, isn't it? This<a id="id94" class="indexterm"/> component also supports hierarchical<a id="id95" class="indexterm"/> rendering. You can have a base layout, a general template for posts, and a template for a single post. Let's take, for example, the following directory structure:</p><div class="informalexample"><pre class="programlisting">app/views/
- index.phtml
- post/detail.phtml</pre></div><p>Phalcon will first render <code class="literal">app/views/index.phtml</code>. Then, when we request for <code class="literal">detailAction()</code> from the post controller, it will render <code class="literal">app/views/post/details.phtml</code>. The main layout can contain something similar to this code:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset="UTF-8"&gt;
&lt;title&gt;Learning Phalcon&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;?php echo $this-&gt;getContent(); ?&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div><p>And, the <code class="literal">details.phtml</code> template will have the following content:</p><div class="informalexample"><pre class="programlisting">&lt;?php foreach($posts as $post) { ?&gt;
  &lt;p&gt;&lt;?php echo $post-&gt;getPostTitle(); ?&gt;&lt;/p&gt;
  &lt;p&gt;&lt;?php echo $post-&gt;getPostContent(); ?&gt;&lt;/p&gt;
&lt;?php } ?&gt;</pre></div><p>This component also allows you to pick different templates to set a render level, disable or enable the view, and much more.</p><p>Phalcon has<a id="id96" class="indexterm"/> a built-in template engine named Volt. If <a id="id97" class="indexterm"/>you are familiar with PHP template engines such as <span class="strong"><strong>Smarty</strong></span><a id="id98" class="indexterm"/> or <a id="id99" class="indexterm"/>
<span class="strong"><strong>Twig</strong></span>, you will want to use them for sure. Volt is almost identical to Twig, and you will find it very useful—it is inspired by <a id="id100" class="indexterm"/>
<span class="strong"><strong>Jinja</strong></span> (<a class="ulink" href="http://jinja.pocoo.org/">http://jinja.pocoo.org/</a>). You can even use your own template engine, or any other template engine that you can find there.</p><p>In order to enable the Volt template engine, we need to make a small modification to our view service, and we need to create a Volt service; here is how to do this:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$di['voltService'] = function($view, $di) use ($config) {

    $volt = new \Phalcon\Mvc\View\Engine\Volt($view, $di);

    if (!is_dir($config-&gt;view-&gt;cache-&gt;dir)) {
        mkdir($config-&gt;view-&gt;cache-&gt;dir);
    }

    $volt-&gt;setOptions(array(
        "compiledPath" =&gt; $config-&gt;view-&gt;cache-&gt;dir,
        "compiledExtension" =&gt; ".compiled",
        "compileAlways" =&gt; false
    ));

    $compiler = $volt-&gt;getCompiler();

    return $volt;
};

// First, we setup the view in the DI
$di['view'] = function () use ($config) {
  $view = \Phacon\Mvc\View();
  $view-&gt;setViewsDir($config-&gt;view-&gt;dir);
  $view-&gt;registerEngines(array(
    '.volt' =&gt; 'voltService'
  ));

  return $view;
};</pre></div><p>By adding this modification and <code class="literal">voltService</code>, we can now use this template engine. From the inheritance point of view, Volt acts a little bit differently. We first need to define a main layout with named blocks. Then, the rest of the templates should extend the main layout, and we need to put our content in the same blocks as the main layout. Before we look at some <a id="id101" class="indexterm"/>examples, I will tell you a little bit about Volt's<a id="id102" class="indexterm"/> syntax, the details are as follows.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The syntax for outputting data or for echoing content:<div class="informalexample"><pre class="programlisting">{{ my_content }}</pre></div></li><li class="listitem" style="list-style-type: disc">The syntax for defining blocks:<div class="informalexample"><pre class="programlisting">{% block body %} Content here {% endblock %}</pre></div></li><li class="listitem" style="list-style-type: disc">The syntax to extend a template (this should be the first line in your template):<div class="informalexample"><pre class="programlisting">{% extends 'layouts/main.volt' %}</pre></div></li><li class="listitem" style="list-style-type: disc">The syntax to include a file:<div class="informalexample"><pre class="programlisting">{% include 'common/sidebar.volt' %}</pre></div></li><li class="listitem" style="list-style-type: disc">The syntax to include a file and pass variables:<div class="informalexample"><pre class="programlisting">{% include 'common/sidebar' with{'section':'homepage'} %}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip07"/>Tip</h3><p>Please note the missing extension. If you pass variables, you <span class="emphasis"><em>MUST</em></span> omit the extension.</p></div></div></li><li class="listitem" style="list-style-type: disc">The syntax for control structures (<code class="literal">for</code>, <code class="literal">if</code>, <code class="literal">else</code>):<div class="informalexample"><pre class="programlisting">{% for post in posts %}
  {% if post.getCategorySlug() == 'entertainment' %}
    &lt;h3 class="pink"&gt;{{ post.getPostTitle() }}&lt;/h3&gt;
  {% else %}
    &lt;h3 class="normal"&gt;{{ post.getPostTitle() }}&lt;/h3&gt;
  {% endif %}
{% endfor %}</pre></div></li><li class="listitem" style="list-style-type: disc">The syntax for the loop context:<div class="informalexample"><pre class="programlisting">{% for post in posts %}
  {% if loop.first %}
    &lt;h1&gt;{{ post.getPostTitle() }}&lt;/h1&gt;
  {% endif %}
{% endif %}</pre></div></li><li class="listitem" style="list-style-type: disc">The syntax for assignments:<div class="informalexample"><pre class="programlisting">{% set title = 'Learning Phalcon' %}
{% set cars = ['BMW', 'Mercedes', 'Audi'] %}</pre></div></li></ul></div><p>The list is long. Additionally, you <a id="id103" class="indexterm"/>can use expressions, comparison operators, logic <a id="id104" class="indexterm"/>operators, filters, and so on. Let's write a simple template to see how it works:</p><div class="informalexample"><pre class="programlisting">&lt;!-- app/views/index.volt --&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset="UTF-8"&gt;
&lt;title&gt;{% block pageTitle %}Learning Phalcon{% endblock%}&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class='header'&gt;{% block header %}Main layout header{% endblock%}&lt;/div&gt;
  &lt;div class='content'&gt;{% block content %}This is the main layout content{% endblock %}&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
 
&lt;!-- app/views/post/detail.volt 
{% extends 'index.volt' %}

{% block pageTitle  %}
  {{ post.getPostTitle() }}
{% endblock %}

{% block header %}
  Post layout
{% endblock %}

{% block content %}
  &lt;p&gt;{{ post.getPostContent() }}&lt;/p&gt;
{% endblock%}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>You can read the full <a id="id105" class="indexterm"/>documentation for the view component at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/views.html">http://docs.phalconphp.com/en/latest/reference/views.html</a> and for <a id="id106" class="indexterm"/>Volt at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/volt.html">http://docs.phalconphp.com/en/latest/reference/volt.html</a>.</p></div></div></div><div class="section" title="The session component"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec09"/>The session component</h3></div></div></div><p>This <a id="id107" class="indexterm"/>component provides <a id="id108" class="indexterm"/>object-oriented wrappers to access session data. To start the session, we need to add the service into the DI container:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$di['session'] = function () {
  $session = new Phalcon\Session\Adapter\Files();
  $session-&gt;start();
  return $session;  
};</pre></div><p>The following is a code example for working with session:</p><div class="informalexample"><pre class="programlisting">&lt;?php

public function testSessionAction()
{
  // Set a session variable
  $this-&gt;session-&gt;set('username', 'john');

  // Check if a session variable is defined
  if ($this-&gt;session-&gt;has('username')) {
    $this-&gt;view-&gt;setVar('username', $this-&gt;session-&gt;get('username'));
  }

  // Remove a session variable
  $this-&gt;session-&gt;remove('username');
  
  // Destroy the session
  $this-&gt;session-&gt;destroy();
}</pre></div><p>If you check Phalcon's incubator, there are many available adapters, such as Redis, Database, Memcache, and Mongo. You can also implement your own adapter.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note05"/>Note</h3><p>You can read the official documentation at <a class="ulink" href="http://docs.phalconphp.com/en/latest/reference/session.html">http://docs.phalconphp.com/en/latest/reference/session.html</a>.</p></div></div></div><div class="section" title="The cache component"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec10"/>The cache component</h3></div></div></div><p>To improve the performance<a id="id109" class="indexterm"/> of some applications, you will <a id="id110" class="indexterm"/>need to cache data. For example, we can cache the query results for a post. Why? Imagine 1 million views or posts. Normally, you will query the database for it, but this will mean 1 million queries (you can multiply this by at least 3, if you are using it, and for ORM—this means 3 million queries at least). Why? When you query, the ORM will act like this:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">It'll check if the table exists, in the information schema:<div class="informalexample"><pre class="programlisting">SELECT IF(COUNT(*)&gt;0, 1 , 0) FROM `INFORMATION_SCHEMA`.`TABLES` WHERE `TABLE_NAME`='user'</pre></div></li><li class="listitem">Then, it'll check whether it's executing a "Describe" of the table:<div class="informalexample"><pre class="programlisting">DESCRIBE `user`</pre></div></li><li class="listitem">Then, whether it's executing the actual query:<div class="informalexample"><pre class="programlisting">SELECT * FROM user.</pre></div></li><li class="listitem">If the <code class="literal">user</code> table has relations, the ORM will repeat each of the preceding steps for each relation.</li></ol></div><p>To solve this problem, we will save the post object into our caching system.</p><p>Personally, I use Redis and Igbinary. Redis is probably the most powerful tool, since it stores the data in memory and, saves the data on disk for redundancy. This means that every time you request the data from cache, you will get it from memory. Igbinary<a id="id111" class="indexterm"/> (<a class="ulink" href="https://pecl.php.net/package/igbinary">https://pecl.php.net/package/igbinary</a>) is a replacement for the standard php serializer. Here is an example cache service:</p><div class="informalexample"><pre class="programlisting">&lt;?php

$di['redis'] = function () {
    $redis = new \Redis();
    $redis-&gt;connect(
        '127.0.0.1',
        6379
    );

    return $redis;
};

$di['cache'] = function () use ($di, $config) {
    $frontend = new \Phalcon\Cache\Frontend\Igbinary(array(
        'lifetime' =&gt; 86400
    ));
    $cache = new \Phalcon\Cache\Backend\Redis($frontend, array(
        'redis' =&gt; $di['redis'],
        'prefix' =&gt; 'learning_phalcon'
    ));

    return $cache;
};</pre></div><p>The cache component<a id="id112" class="indexterm"/> has the following methods that are<a id="id113" class="indexterm"/> commonly used:</p><div class="informalexample"><pre class="programlisting">&lt;?php

// Save data in cache
$this-cache-&gt;save('post', array(
  'title' =&gt; 'Learning Phalcon',
  'slug' =&gt; 'learning-phalcon',
  'content' =&gt; 'Article content'
));

// Get data from cache
$post = $this-&gt;cache-&gt;get('post');

// Delete data from cache
$this-&gt;cache-&gt;delete('post');</pre></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec12"/>Summary</h1></div></div></div><p>In this chapter, we installed the required software, created the configuration files for the web servers, and you learned a little bit about Phalcon's internals. In the next chapters, we will learn by example, and everything will be much clearer.</p><p>Take your time, and before going further, read a little bit more about anything in which you don't have experience.</p><p>In the following chapter, we will look at how to set up the MVC structure and the environment for our project.</p></div></body></html>