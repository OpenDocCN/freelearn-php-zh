<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Accepting User Content Submissions</h1>
                </header>
            
            <article>
                
<p>In this chapter, we will be focusing on giving visitors the ability to make submissions to a website. We will cover the following recipes:</p>
<ul>
<li>Creating a client-side content submission form</li>
<li>Saving user-submitted content in custom post types</li>
<li>Sending email notifications upon new submissions</li>
<li>Implementing a CAPTCHA on user forms using an online service</li>
<li>Using a local library to implement a CAPTCHA on user forms</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article>
                
<p>Giving users the ability to contribute content to a website is always a good way to engage the community and keep content fresh on a website. Going back to the book review system that was put in place in <a href="6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml"><span class="ChapterrefPACKT">Chapter 4</span></a>, <em>The Power of Custom Post Types</em>, this chapter explains how to allow visitors to add their own book reviews to a website.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a client-side content submission form</h1>
                </header>
            
            <article>
                
<p>The first step toward giving visitors the ability to contribute to a website is to present a form that they will be able to use to submit new content. This recipe shows how to create a shortcode that can easily be inserted on any WordPress page to render a simple form.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should be running the final version of the Book Reviews plugin created in <a href="6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml"><span class="ChapterrefPACKT">Chapter 4</span></a>, <em>The Power of Custom Post Types</em>, or using the final resulting code (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v11.php</kbd>) from the downloaded code bundle.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the WordPress plugin directory of your development installation.</li>
<li>Create a new directory called <kbd>ch6-book-review-user-submission</kbd> and open it.</li>
<li>Create a text file called <kbd>ch6-book-review-user-submission.php</kbd>.</li>
<li>Open the new file in a code editor and add an appropriate header at the top of the plugin file, naming the plugin <kbd>Chapter 6 - Book Review User Submission</kbd>.</li>
<li>Add the following line of code to declare a new shortcode and its associated function:</li>
</ol>
<pre style="padding-left: 60px">add_shortcode( 'submit-book-review', 'ch6_brus_book_review_form' ); </pre>
<ol start="6">
<li>Add the following code segment to provide an implementation for the <kbd>ch6_brus_book_review_form</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch6_brus_book_review_form() { <br/>    // make sure user is logged in <br/>    if ( !is_user_logged_in() ) { <br/>        echo '&lt;p&gt;You need to be a website member to be able to '; <br/>        echo 'submit book reviews. Sign up to gain access!&lt;/p&gt;'; <br/>        return; <br/>    } <br/>    ?&gt; <br/> <br/>    &lt;form method="post" id="add_book_review" action=""&gt; <br/> <br/>    &lt;!-- Nonce fields to verify visitor provenance --&gt; <br/>    &lt;?php wp_nonce_field( 'add_review_form', 'br_user_form' ); ?&gt;<br/><br/>    &lt;table&gt; <br/>        &lt;tr&gt; <br/>            &lt;td&gt;Book Title&lt;/td&gt; <br/>            &lt;td&gt;&lt;input type="text" name="book_title" /&gt;&lt;/td&gt; <br/>        &lt;/tr&gt; <br/>        &lt;tr&gt; <br/>            &lt;td&gt;Book Author&lt;/td&gt; <br/>            &lt;td&gt;&lt;input type="text" name="book_author" /&gt;&lt;/td&gt; <br/>        &lt;/tr&gt; <br/>        &lt;tr&gt; <br/>            &lt;td&gt;Review&lt;/td&gt; <br/>            &lt;td&gt;&lt;textarea name="book_review_text"&gt;&lt;/textarea&gt;&lt;/td&gt; <br/>        &lt;/tr&gt; <br/>        &lt;tr&gt; <br/>          &lt;td&gt;Rating&lt;/td&gt; <br/>            &lt;td&gt;&lt;select name="book_review_rating"&gt; <br/>            &lt;?php <br/>            // Generate all rating items in drop-down list <br/>            for ( $rating = 5; $rating &gt;= 1; $rating-- ) { ?&gt; <br/>                &lt;option value="&lt;?php echo $rating; ?&gt;"&gt; <br/>                               &lt;?php echo $rating; ?&gt; stars <br/>            &lt;?php } ?&gt; <br/>            &lt;/select&gt; <br/>            &lt;/td&gt; <br/>        &lt;/tr&gt; <br/>        &lt;tr&gt; <br/>            &lt;td&gt;Book Type&lt;/td&gt; <br/>            &lt;td&gt; <br/>            &lt;?php  <br/>            // Retrieve array of all book types in system <br/>            $book_types = get_terms( 'book_reviews_book_type', <br/>                                 array( 'orderby' =&gt; 'name', <br/>                                        'hide_empty' =&gt; 0 ) ); <br/> <br/>            // Check if book types were found <br/>            if ( !is_wp_error( $book_types ) &amp;&amp; <br/>                 !empty( $book_types ) ) { <br/> <br/>                echo '&lt;select name="book_review_book_type"&gt;'; <br/> <br/>                // Display all book types <br/>                foreach ( $book_types as $book_type ) { <br/>                     echo '&lt;option value="' . $book_type-&gt;term_id; <br/>                     echo '"&gt;' . $book_type-&gt;name . '&lt;/option&gt;'; <br/>               }     <br/> <br/>               echo '&lt;/select&gt;'; <br/>            } ?&gt; <br/>            &lt;/td&gt; <br/>        &lt;/tr&gt; <br/>    &lt;/table&gt; <br/> <br/>    &lt;input type="submit" name="submit" value="Submit Review" /&gt; <br/>    &lt;/form&gt; <br/>&lt;?php } </pre>
<ol start="7">
<li>Save and close the plugin file.</li>
<li><span class="packt_screen">Activate</span> the <kbd>Chapter 6 - Book Review User Submission</kbd> plugin.</li>
<li>Create a new page and insert the newly created <kbd>[submit-book-review]</kbd> shortcode in the item's content.</li>
<li>Publish and view the page to see the form. If you submit the form, nothing will happen at the moment, since we have not implemented a processing function to parse and save the submitted data:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="257" width="574" class="image-border" src="assets/4983c168-84af-4664-a966-3e48e235547a.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>As seen in the previous chapters, shortcodes are special blocks of text that can be easily added in any post or page to be replaced by content when they are found in pages visited by users. This recipe uses the <kbd>add_shortcode</kbd> function to declare a new shortcode that gets replaced with a review submission form.</p>
<p>The form itself is created using standard HTML and displays a number of text fields. It also uses a bit of PHP code to dynamically build the list of ratings and book types defined in the system. The form also includes a PHP call to the <kbd>wp_nonce_field</kbd> function, which was previously seen when creating plugin configuration panels, to add hidden fields that will be used as a security measure in the associated data processing function. Finally, the code checks to see whether the user visiting the page is logged in to the website and displays a short message instead of the submission form when the check is negative.</p>
<p>When submitted, the form action will send visitor content to the page where the book review form is displayed. This new content will be intercepted and processed in the code that will be added in the next recipe.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Creating a new simple shortcode</em> recipe in <a href="f7395811-9e4a-4913-8a02-cc68875d0071.xhtml"><span class="ChapterrefPACKT">Chapter 2</span></a>, <em>Plugin Framework Basics</em></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Saving user-submitted content in custom post types</h1>
                </header>
            
            <article>
                
<p>When visitors click on the <span class="packt_screen">Submit</span> button on the form created in the previous recipe, the target of the form is set to be the same page that is hosting the submission form. Since this page is not capable of handling form data, we must implement an action hook that intercepts this post data and sends it to a processing function that we will define. This recipe shows how to implement a function responsible for processing user input.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should be running the final version of the Book Reviews plugin created in <a href="6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml"><span class="ChapterrefPACKT">Chapter 4</span></a>, <em>The Power of Custom Post Types</em>, and should have already followed the <em>Creating a client-side content submission form</em> recipe. Alternatively, you can get the files from the code bundle (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v11.php</kbd> and <kbd>Chapter 6/ch6-book-review-user-submission/ch6-book-review-user-submission-v1.php</kbd>), and rename <kbd>ch6-book-review-user-submission-v1.php</kbd> to <kbd>ch6-book-review-user-submission.php</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the <kbd>ch6-book-review-user-submission</kbd> directory of the WordPress plugin folder of your development installation.</li>
<li>Open the file <kbd>ch6-book-review-user-submission.php</kbd> in a text editor.</li>
<li>Add the following line of code to register a function that will intercept user-submitted book reviews:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'template_redirect', <br/>            'ch6_brus_match_new_book_reviews' ); </pre>
<ol start="4">
<li>Add the following block of code to implement the <kbd>ch6_brus_match_new_book_reviews</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch6_brus_match_new_book_reviews( $template ) { <br/>    if ( !empty( $_POST['ch6_brus_user_book_review'] ) ) { <br/>        ch6_brus_process_user_book_reviews(); <br/>    } else { <br/>        return $template; <br/>    } <br/>} </pre>
<ol start="5">
<li>Insert the following code to provide an implementation for the <kbd>ch6_brus_process_user_book_reviews</kbd>:</li>
</ol>
<pre style="padding-left: 60px">function ch6_brus_process_user_book_reviews() { <br/>    // Check that all required fields are present and non-empty <br/>    if ( wp_verify_nonce( $_POST['br_user_form'], <br/>                          'add_review_form' ) &amp;&amp; <br/>         !empty( $_POST['book_title'] ) &amp;&amp; <br/>         !empty( $_POST['book_author'] ) &amp;&amp; <br/>         !empty( $_POST['book_review_text'] ) &amp;&amp;  <br/>         !empty( $_POST['book_review_book_type'] ) &amp;&amp; <br/>         !empty( $_POST['book_review_rating'] ) ) { <br/>        // Create array with received data <br/>        $new_book_review_data = array( <br/>            'post_status' =&gt; 'publish',  <br/>            'post_title' =&gt; $_POST['book_title'], <br/>            'post_type' =&gt; 'book_reviews', <br/>            'post_content' =&gt; $_POST['book_review_text'] ); <br/> <br/>        // Insert new post in website database <br/>        // Store new post ID from return value in variable <br/>        $new_book_review_id =  <br/>                         wp_insert_post( $new_book_review_data ); <br/> <br/>        // Store book author and rating <br/>        add_post_meta( $new_book_review_id, 'book_author', <br/>                     wp_kses( $_POST['book_author'], array() ) ); <br/>        add_post_meta( $new_book_review_id, 'book_rating', <br/>                       (int) $_POST['book_review_rating'] ); <br/> <br/>        // Set book type on post <br/>        if ( term_exists( $_POST['book_review_book_type'], <br/>                          'book_reviews_book_type' ) ) { <br/>            wp_set_post_terms( $new_book_review_id, <br/>                               $_POST['book_review_book_type'], <br/>                               'book_reviews_book_type' );  <br/>        } <br/>        // Redirect browser to book review submission page <br/>        $redirect_address = <br/>             ( empty( $_POST['_wp_http_referer'] ) ? site_url() : <br/>                                    $_POST['_wp_http_referer'] ); <br/>        wp_redirect( add_query_arg( 'add_review_message', '1', <br/>                     $redirect_address ) ); <br/>        exit; <br/>    } else { <br/>        // Display message if any required fields are missing <br/>        $abort_message = 'Some fields were left empty. Please '; <br/>        $abort_message .= 'go back and complete the form.'; <br/>        wp_die( $abort_message ); <br/>        exit; <br/>    } <br/>} </pre>
<ol start="6">
<li>In the original <kbd>ch6_brus_book_review_form</kbd> function, add the following code after the <kbd>wp_nonce_field</kbd> function call:</li>
</ol>
<pre style="padding-left: 60px">&lt;?php if ( isset( $_GET['add_review_message'] ) <br/>            &amp;&amp; $_GET['add_review_message'] == 1 ) { ?&gt; <br/> <br/>    &lt;div style="margin: 8px;border: 1px solid #ddd; <br/>        background-color: #ff0;"&gt; <br/>    Thank for your submission! <br/>    &lt;/div&gt; <br/> <br/>&lt;?php } ?&gt; <br/> <br/>&lt;!-- Post variable to indicate user-submitted items --&gt; <br/>&lt;input type="hidden" name="ch6_brus_user_book_review" value="1" /&gt; </pre>
<ol start="7">
<li>Save and close the plugin file.</li>
<li>Go back to the book review submission form and submit a review to send all the fields to the newly created processing function. After processing the new content, the script will return to the form, which will display a confirmation message.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>After submitting the book review form data to the page containing the book review submission form in the previous recipe, the first few steps of this recipe will be to assign a function to the <kbd>template_redirect</kbd> action hook to allow us to capture new book review content. This hook function is executed early in the WordPress processing sequence. If found, we will call the processing function that is defined in the rest of the recipe.</p>
<p>The first thing that is done in our processing function is to check whether the proper hidden data field is found as part of the post data, using the <kbd>wp_verify_nonce</kbd> function. If it is not present, indicating that someone may be trying to post data to the website without having visited the frontend form, it will display an error message.</p>
<p>When we are sure that our data storage script is being called legitimately, we will continue processing the actual data by first checking to see whether all the fields are present and are not empty. If that is not the case, we will display an error message, asking the user to go back and complete the form using the <kbd>wp_die</kbd> function.</p>
<p>If all the fields have been received correctly, the recipe continues to process the incoming data by preparing an array of information that includes the newly submitted title and review text, along with a post status and the <kbd>book_reviews</kbd> post type name. The resulting array is sent to the <kbd>wp_insert_post</kbd> function to store the information. As we can see, <kbd>wp_insert_post</kbd> only requires a single parameter that is fulfilled using the array that we just created. While we only define four elements of that array, many more are available, which can be seen by consulting the WordPress Codex (<a href="https://developer.wordpress.org/reference/functions/wp_insert_post/">https://developer.wordpress.org/reference/functions/wp_insert_post/</a>).</p>
<p>Now, calling <kbd>wp_insert_post</kbd> only takes care of storing some key data elements that belong in the post data. We must follow up this code with calls to <kbd>update_post_meta</kbd> and <kbd>wp_set_post_terms</kbd> to store the remaining user information to the website database.</p>
<p>Once all the information is stored, we use a combination of the <kbd>wp_redirect</kbd> and <kbd>add_query_arg</kbd> functions to send the user back to the page where he submitted a book review, while making sure that only one instance of the <kbd>add_review_message</kbd> variable is in the target address.</p>
<p>Last but not least, this recipe makes a small modification to the code that rendered the book review form to add a confirmation message that is shown to visitors when information is accepted by the plugin.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>In a world of spam bots and real people, who are set on creating bogus content on any website, setting new book reviews to be immediately visible on the website might not be wise.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Moderating user-submitted content</h1>
                </header>
            
            <article>
                
<p>Instead of setting a status of publish for new post entries, we can use a value of draft to make the new entry visible only in the backend administration area. To give plugin users more flexibility, you could also give them a way to decide what method they prefer in a configuration panel.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Creating a client-side content submission form</em> recipe</li>
<li>The <em>Processing and storing plugin configuration data</em> recipe in <a href="0346c3c6-27ee-45fb-bfd6-df398e04b2b4.xhtml"><span class="ChapterrefPACKT">Chapter 3</span></a>, <em>User Settings and Administration Pages</em></li>
<li>The <em>Adding a new section to the custom post type editor</em> recipe in <a href="6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml"><span class="ChapterrefPACKT">Chapter 4</span></a>, <em>The Power of Custom Post Types</em></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Sending email notifications upon new submissions</h1>
                </header>
            
            <article>
                
<p>Just like WordPress sends out email notifications to the administrator when new comments are posted, sending out emails when visitors post new book reviews allows website managers to review new content as it comes in and decide if they approve it to be published online.</p>
<p>This recipe shows how to prepare email data and send it using the <kbd>wp_mail</kbd> function.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should be running the final version of the Book Reviews plugin created in <a href="6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml"><span class="ChapterrefPACKT">Chapter 4</span></a>, <em>The Power of Custom Post Types</em>, and should have already followed the <em>Saving user-submitted data in custom post types</em> recipe (including changing the post status to draft as indicated in the <em>There's more</em>... section). Alternatively, you can get the resulting files from the code bundle (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v11.php</kbd> and <kbd>Chapter 6/ch6-book-review-user-submission/ch6-book-review-user-submission-v2.php</kbd>) and rename <kbd>ch6-book-review-user-submission-v2.php</kbd> to <kbd>ch6-book-review-user-submission.php</kbd>. Finally, you should have access to a WordPress installation on a hosted web server, as emails are usually not sent when running it on a local installation. Be sure to have access to the email account associated with the website administrator to see the resulting email.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the <kbd>ch6-book-review-user-submission</kbd> directory of the WordPress plugin folder of your development installation.</li>
<li>Open the file <kbd>ch6-book-review-user-submission.php</kbd> in a text editor.</li>
<li>Insert the following line of code to register a function to be called back when new posts are submitted:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'wp_insert_post', 'ch6_brus_send_email', 10, 2 ); </pre>
<ol start="4">
<li>Insert the following block of code to implement the <kbd>ch6_brus_send_email</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch6_brus_send_email( $post_id, $post ) { <br/> <br/>    // Only send emails for user-submitted book reviews <br/>    if ( isset( $_POST['ch6_brus_user_book_review'] ) &amp;&amp; <br/>         'book_reviews' == $post-&gt;post_type ) { <br/> <br/>        $admin_mail = get_option( 'admin_email' ); <br/>        $headers = 'Content-type: text/html'; <br/>        $message = 'A user submitted a new book review to your '; <br/>        $message .= 'WordPress website database.&lt;br /&gt;&lt;br /&gt;'; <br/>        $message .= 'Book Title: ' . $post-&gt;post_title ; <br/>        $message .= '&lt;br /&gt;&lt;a href="'; <br/>        $message .= add_query_arg( array( <br/>                                   'post_status' =&gt; 'draft', <br/>                                  'post_type' =&gt; 'book_reviews' ), <br/>                                   admin_url( 'edit.php' ) ); <br/>        $message .= '"&gt;Moderate new book reviews&lt;/a&gt;'; <br/>        $email_title = htmlspecialchars_decode( get_bloginfo(), <br/>             ENT_QUOTES ) . " - New Book Review Added: " . <br/>             htmlspecialchars( $_POST['book_title'] ); <br/>        // Send email <br/>        wp_mail( $admin_mail, $email_title, $message, $headers ); <br/>    } <br/>} </pre>
<ol start="5">
<li>Save and close the plugin file.</li>
</ol>
<p> </p>
<ol start="6">
<li>Go back to the book review submission form and submit a book review. An email will be sent to the address associated with the website administrator, containing some information from the new review:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="222" width="386" class="image-border" src="assets/5d17aacb-9af6-4397-8a7a-a81f617416f5.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>The <kbd>wp_mail</kbd> function can be used by any plugin to send out email messages. It takes five arguments to define all the elements of the outgoing message:</p>
<pre style="padding-left: 60px">wp_mail( $destination, $subject, $message, [$headers], <br/>         [$attachments] ); </pre>
<p>The first three arguments are required and respectively define the email address of the intended recipient, the title of the message, and its content. As we have seen in this recipe, the content is mainly specified using standard HTML syntax, while the target email address is retrieved from the options table using the <kbd>get_option</kbd> function. As for the title, it is built from a number of textual elements, such as the blog title and book review title, to create the final result.</p>
<p>The next parameter is optional and provides header information for the email, with the most important piece of information in that section being the character set. The last parameter can optionally be used to specify the path of one or more files to be sent as email attachments.</p>
<p>To make it easier for website administrators to manage new entries, part of the message body contains a link to the custom post management page of the WordPress website administration area to quickly display all the unapproved entries (set as draft items).</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Creating a client-side content submission form</em> recipe</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Implementing a CAPTCHA on user forms using an online service</h1>
                </header>
            
            <article>
                
<p>A common security measure on website forms is to use CAPTCHA codes, where distorted letters or some other form of test is displayed to check that the person submitting data is not a spam robot. The form that we have been building to accept visitor-submitted book reviews could benefit from this type of technology to avoid weeding through unwanted entries.</p>
<p>This recipe shows how to integrate Google's reCAPTCHA service in our book review submission form. If you prefer using a local CAPTCHA script to avoid being dependent on an online service or to be sure that your form can be used in all countries, jump to the next recipe, titled <em>Using a local library to implement a CAPTCHA on user forms</em>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should be running the final version of the Book Reviews plugin created in <a href="6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml"><span class="ChapterrefPACKT">Chapter 4</span></a>, <em>The Power of Custom Post Types</em>, and should have already followed the <em>Sending email notifications upon new submissions</em> recipe. Alternatively, you can get the resulting files from the code bundle (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v11.php</kbd> and <kbd>Chapter 6/ch6-book-review-user-submission/ch6-book-review-user-submission-v3.php</kbd>) and rename <kbd>ch6-book-review-user-submission-v3.php</kbd> to <kbd>ch6-book-review-user-submission.php</kbd> before starting the recipe.</p>
<div class="packt_infobox">This recipe requires having a Google account to be able to register for the reCAPTCHA service.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Visit the Google reCAPTCHA administrator website (<a href="https://www.google.com/recaptcha/admin">https://www.google.com/recaptcha/admin</a>) and log in if you are not already connected to Google services.</li>
<li><span class="packt_screen">Register a new website</span> by specifying a <span class="packt_screen">Label</span> (for example, <kbd>Development website</kbd>) and setting the type of reCAPTCHA to <span class="packt_screen">reCAPTCHA V2</span> using the radio selector.</li>
<li>Enter the domain name of the web server you will be using to test your code in the <span class="packt_screen">Domains</span> field. If you are running a local development server, it is likely to be <kbd>localhost</kbd>.</li>
<li>Check the box to accept the terms of service, then click on <span class="packt_screen">Register</span> to complete the new website creation process.</li>
<li>In the resulting page, take note of the website and secret keys that the service assigned to your test website.</li>
<li>Navigate to the <kbd>ch6-book-review-user-submission</kbd> directory of your plugin folder and open the file named <kbd>ch6-book-review-user-submission.php</kbd> in a code editor.</li>
<li>Insert the following line of code at the end of the file to register a function that will be called when WordPress prepares the list of scripts to be loaded on the website:</li>
</ol>
<pre style="padding-left: 60px">add_action( 'wp_enqueue_scripts', 'ch6_brus_recaptcha_script' );</pre>
<ol start="8">
<li>Add the following block of code to provide an implementation for the <kbd>ch6_brus_recaptcha_script</kbd> function:</li>
</ol>
<pre style="padding-left: 60px">function ch6_brus_recaptcha_script() {<br/>    wp_enqueue_script( 'google_recaptcha', <br/>                       'https://www.google.com/recaptcha/api.js',<br/>                       array(), false, true );<br/>}</pre>
<ol start="9">
<li>Locate the <kbd>ch6_brus_book_review_form</kbd> function in your code and add an extra row to the form table to display the CAPTCHA, replacing <kbd><strong>[my-website-key]</strong></kbd> with the website key obtained earlier from the reCAPTCHA service:</li>
</ol>
<pre style="padding-left: 60px">&lt;tr&gt;<br/>    &lt;td colspan="2"&gt;<br/>        &lt;div class="g-recaptcha" <br/>             data-sitekey="<strong>[my-website-key]</strong>"&gt;&lt;/div&gt;<br/>    &lt;/td&gt;<br/>&lt;/tr&gt;</pre>
<ol start="10">
<li>Save your plugin and visit your book review submission page. You should now see the Google reCAPTCHA box appear in the form.</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="159" width="386" class="image-border" src="assets/f80034a7-19c8-40b0-8541-bf33301c4d63.png"/></div>
<ol start="11">
<li>Visit the Google reCAPTCHA GitHub page (<a href="https://github.com/google/recaptcha">https://github.com/google/recaptcha</a>) and download the latest version of the repository to your computer.</li>
<li>Extract the repository contents and copy the resulting <kbd>src</kbd> folder to the <kbd>ch6-book-review-user-submission</kbd> directory.</li>
<li>Rename the <kbd>src</kbd> folder to <kbd>recaptcha</kbd>.</li>
<li>Locate the <kbd>ch6_brus_process_user_book_reviews</kbd> function in your code and add the following lines of code at the top of the function implementation, replacing <kbd>[my-secret-key]</kbd> with the secret key obtained earlier from the reCAPTCHA service:</li>
</ol>
<pre style="padding-left: 60px">require_once plugin_dir_path( __FILE__ ) .<br/>             '/recaptcha/autoload.php';<br/><br/>$recaptcha = new \ReCaptcha\ReCaptcha( '<strong>[my-secret-key]</strong>' ); <br/>$resp = $recaptcha-&gt;verify( $_POST['g-recaptcha-response'],<br/>                            $_SERVER['REMOTE_ADDR'] );<br/> <br/>if ( ! $resp-&gt;isSuccess() ) {<br/>    // Display message if any required fields are missing <br/>    $abort_message = 'Missing or incorrect captcha.&lt;br /&gt;'; <br/>    $abort_message .= 'Please go back and try again.'; <br/>    wp_die( $abort_message ); <br/>    exit; <br/>} else {</pre>
<ol start="15">
<li>Add an extra closing bracket (<kbd>}</kbd>) just before the end of the <kbd>ch6_brus_process_user_book_reviews</kbd> function to close out the <kbd>else</kbd> section of the code inserted in the previous step.</li>
<li>Save and close the code file.</li>
<li>Submit a new book review without checking the reCAPTCHA checkbox to see that it will not be accepted by the processing function.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>Google's reCAPTCHA service is a free service that can generate and display a CAPTCHA box in your form. It has evolved over time from asking users to decipher a scrambled message in an image to displaying addresses and other street signs and asking users to enter what they saw. In its latest incarnation, reCAPTCHA simply asks the user to check a box to indicate that they are not a robot and only asks more advanced questions if it suspects the visitor from being an automated system. When visitors check the box, a hidden field is populated with a validation code that gets sent to our data processing function along with the rest of the form data.</p>
<p>Adding a reCAPTCHA to our form is actually quite easy, only requiring us to load a Javascript script and add a line of code to our form that gets transformed into the service's trademark checkbox. Once the form data is posted, validating it is a bit more complex than the nonces we have used before since our plugin needs to communicate with Google's servers to check the validation code. Thankfully, Google offers an easy-to-use library to hide away much of this operation's complexity. If the reCAPTCHA code received is valid, the previously created data processing and storage code is executed as before. Otherwise, an error message is displayed to users. In addition to being easy to integrate, a benefit of using a third-party service is that most code updates are done by the service provider. You would still need to check for occasional updates to the PHP validation library, but that is only a small part of this service's functionality.</p>
<p>If you are planning to distribute a plugin that makes use of the reCAPTCHA service for more than one person or customer, it would not make sense to leave your own website and secret keys in the final plugin code, as we have done here. Instead, you should create an administration panel, as you learned to do in <a href="0346c3c6-27ee-45fb-bfd6-df398e04b2b4.xhtml">Chapter 3</a><em>, User Settings and Administration Pages</em>, so that users can enter their own keys and have them be used on the website.</p>
<div class="packt_infobox">It should be noted that while Google reCAPTCHA is one of the most popular CAPTCHA-generation services, it does not work for Chinese visitors at the time of writing and has not worked there for some time. If you are developing a plugin for a wide audience, you might want to consider supporting more than one CAPTCHA service or library to make sure that users have options, no matter where they or their audience resides. Read the next recipe for an example of using a local library to generate a CAPTCHA.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Sending email notifications upon new submissions</em> recipe</li>
<li>The <em>Creating an administration page menu item in the Settings menu</em> recipe</li>
<li>The <em>Rendering the admin page contents using HTML</em> recipe</li>
<li>The <em>Processing and storing plugin configuration data</em> recipe</li>
<li>The <em>Displaying a confirmation message when options are saved</em> recipe</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using a local library to implement a CAPTCHA on user forms</h1>
                </header>
            
            <article>
                
<p>As discussed in the previous recipe, <em>Implementing a CAPTCHA on user forms using an online service</em>, adding a CAPTCHA to visitor-facing forms helps reduce unwanted submissions to a website. After seeing how to integrate an online third-party service, this recipe shows how to download and integrate a local PHP script to generate and validate CAPTCHA images locally.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>You should be running the final version of the Book Reviews plugin created in <a href="6298bc2b-19d5-4e3a-833c-3c4b667b22e5.xhtml"><span class="ChapterrefPACKT">Chapter 4</span></a>, <em>The Power of Custom Post Types</em>, and should have already followed the <em>Sending email notifications upon new submissions</em> recipe. Alternatively, you can get the resulting files from the code bundle (<kbd>Chapter 4/ch4-book-reviews/ch4-book-reviews-v11.php</kbd> and <kbd>Chapter 6/ch6-book-review-user-submission/ch6-book-review-user-submission-v3.php</kbd>) and rename <kbd>ch6-book-review-user-submission-v3.php</kbd> to <kbd>ch6-book-review-user-submission.php</kbd> before starting the recipe.</p>
<p>The GD and FreeType libraries need to be installed and activated in your development web server's PHP installation to be able to generate a CAPTCHA image. Most of the pre-packaged local web servers listed in the <em>Installing a web server on your computer</em> recipe from <a href="bd54bb42-2b11-4ac9-ac09-5e6e66f285b6.xhtml">Chapter 1</a>, <em>Preparing a Local Development Environment</em>, come with these libraries activated. They are also commonly enabled on most hosted web servers, but you should still mention that they are required when distributing a plugin containing the following code to a larger audience.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<ol>
<li>Visit the Securimage website (<a href="https://www.phpcaptcha.org/download/">https://www.phpcaptcha.org/download/</a>) to download the latest version of their CAPTCHA library.</li>
<li>Open the resulting archive and extract the entire <kbd>securimage</kbd> directory to the <kbd>ch6-book-review-user-submission</kbd> folder of your plugin directory.</li>
<li><span>In the plugin directory, open the file named</span> <kbd>ch6-book-review-user-submission.php</kbd> <span>in a code editor.</span></li>
<li>Locate the <kbd>ch6_brus_book_review_form</kbd> function in your code and add an extra row to the form table to display the CAPTCHA:</li>
</ol>
<pre style="padding-left: 60px">&lt;tr&gt;<br/>    &lt;td&gt;Enter text from image&lt;/td&gt;<br/>    &lt;td&gt;<br/>        &lt;img id="captcha" <br/>             src="&lt;?php echo plugins_url( <br/>                            'securimage/securimage_show.php', <br/>                            __FILE__ ); ?&gt;"<br/>             alt="CAPTCHA Image" /&gt;<br/>        &lt;input type="text" name="captcha_code"<br/>               size="10" maxlength="6" /&gt;<br/>        &lt;a href="#" <br/>           onclick="document.getElementById( 'captcha' ).src = <br/>           '&lt;?php echo plugins_url(<br/>                       '/securimage/securimage_show.php', <br/>                       __FILE__ ); ?&gt;?'<br/>           + Math.random(); return false"&gt;[ Different Image ]&lt;/a&gt;<br/>    &lt;/td&gt;<br/>&lt;/tr&gt; </pre>
<ol start="5">
<li>Save your plugin and visit your book review submission page. You should now see the CAPTCHA image appear in the form:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="122" width="396" class="image-border" src="assets/c99e4d48-24ca-4c3c-bba8-a5a55ae6636d.png"/></div>
<ol start="6">
<li>Locate the <kbd>ch6_brus_process_user_book_reviews</kbd> function in your code and add the following lines of code at the top of the function implementation:</li>
</ol>
<pre style="padding-left: 60px">if ( PHP_SESSION_NONE == session_status() ) {<br/>    session_start();<br/>}<br/> <br/>include_once plugin_dir_path( __FILE__ ) .<br/>             '/securimage/securimage.php';<br/>$securimage = new Securimage();<br/> <br/>if ( false == $securimage-&gt;check( $_POST['captcha_code'] ) ) {<br/>    // Display message if any required fields are missing <br/>    $abort_message = 'Missing or incorrect captcha.&lt;br /&gt;'; <br/>    $abort_message .= 'Please go back and try again.'; <br/>    wp_die( $abort_message ); <br/>    exit; <br/>} else {</pre>
<ol start="7">
<li>Add an extra closing bracket (<kbd>}</kbd>) just before the end of the <kbd>ch6_brus_process_user_book_reviews</kbd> function to close out the <kbd>else</kbd> section of the code inserted in the previous step.</li>
<li>Save and close the code file.</li>
<li>Submit a new book review without entering the CAPTCHA code to see that it will not be accepted by the processing function.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>The <kbd>Securimage</kbd> script is a simple tool that can generate and display a CAPTCHA image, as well as store the string that it generated using session data.</p>
<p>The recipe's code displays the CAPTCHA image by using a standard HTML <kbd>img</kbd> tag that uses one of the scripts in the <kbd>securimage</kbd> directory as the image path. On the data processing side, our code first starts by calling <kbd>session_start</kbd> to reconnect to the session that was initiated by the image generator to store the CAPTCHA code. It then proceeds to check whether the user CAPTCHA text matches the image that was displayed using the <kbd>check</kbd> method of the <kbd>securimage</kbd> class. Based on this result, we display an error message or continue verifying that the rest of the required data fields have been submitted correctly.</p>
<p>While there are many PHP scripts available to generate CAPTCHA images, this particular one was selected for this recipe since it is an open source script that uses the BSD license, which is compatible with WordPress licensing. This means that you would be able to distribute this script with your plugin on the official WordPress plugin repository.</p>
<div class="packt_infobox">When using a third-party library in your plugin, you should regularly check whether that library has been updated by its author and incorporate new versions in your work as soon as possible to make sure that you don't expose your plugin to security vulnerabilities.</div>
<p>For more advanced content filtering methods, look up the Akismet API (<a href="https://akismet.com/development/api/">https://akismet.com/development/api/</a>).</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <em>Implementing a CAPTCHA on user forms using an online service</em> recipe</li>
</ul>


            </article>

            
        </section>
    </body></html>