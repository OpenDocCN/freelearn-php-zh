<html><head></head><body>
<div id="_idContainer054">
<h1 class="chapter-number" id="_idParaDest-235"><a id="_idTextAnchor264"/><span class="koboSpan" id="kobo.1.1">8</span></h1>
<h1 id="_idParaDest-236"><a id="_idTextAnchor265"/><span class="koboSpan" id="kobo.2.1">Plug and Play with Plugins</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Plugins power many items in </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">Drupal</span></strong><span class="koboSpan" id="kobo.5.1">, such as blocks, field types, and field formatters. </span><span class="koboSpan" id="kobo.5.2">Plugins and plugin types are provided by modules. </span><span class="koboSpan" id="kobo.5.3">They provide a swappable and </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">specific functionality.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">In this chapter, we will </span><a id="_idIndexMarker430"/><span class="koboSpan" id="kobo.8.1">implement a </span><strong class="bold"><span class="koboSpan" id="kobo.9.1">block plugin</span></strong><span class="koboSpan" id="kobo.10.1">. </span><span class="koboSpan" id="kobo.10.2">We will use the Plugin API to provide a custom field type along with a widget and formatter for the field. </span><span class="koboSpan" id="kobo.10.3">The last recipe will show you how to create and use a custom </span><span class="No-Break"><span class="koboSpan" id="kobo.11.1">plugin type.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.12.1">Upcoming changes to the plugin system in Drupal minor versions</span></p>
<p class="callout"><strong class="bold"><span class="koboSpan" id="kobo.13.1">PHP 8</span></strong><span class="koboSpan" id="kobo.14.1"> provides a feature </span><a id="_idIndexMarker431"/><span class="koboSpan" id="kobo.15.1">called </span><strong class="bold"><span class="koboSpan" id="kobo.16.1">PHP attributes</span></strong><span class="koboSpan" id="kobo.17.1"> (</span><a href="https://www.php.net/manual/en/language.attributes.overview.php"><span class="koboSpan" id="kobo.18.1">https://www.php.net/manual/en/language.attributes.overview.php</span></a><span class="koboSpan" id="kobo.19.1">). </span><span class="koboSpan" id="kobo.19.2">With </span><strong class="bold"><span class="koboSpan" id="kobo.20.1">Drupal 10</span></strong><span class="koboSpan" id="kobo.21.1">’s adoption of </span><strong class="bold"><span class="koboSpan" id="kobo.22.1">PHP 8.1</span></strong><span class="koboSpan" id="kobo.23.1">, there is consideration to adopt PHP attributes over code document annotations, which are used in </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">this chapter.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.25.1">Support for PHP attributes instead of annotations may be available in </span><strong class="bold"><span class="koboSpan" id="kobo.26.1">Drupal 10.1</span></strong><span class="koboSpan" id="kobo.27.1">, the first minor release of Drupal 10. </span><span class="koboSpan" id="kobo.27.2">Annotations will be supported throughout Drupal 10 but may become deprecated. </span><span class="koboSpan" id="kobo.27.3">Deprecating annotations in favor of PHP attributes is discussed in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">issue: </span></span><a href="https://www.drupal.org/project/drupal/issues/3252386"><span class="No-Break"><span class="koboSpan" id="kobo.29.1">https://www.drupal.org/project/drupal/issues/3252386</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.30.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.31.1">In this chapter, we will dive into the Plugin API provided in Drupal with the </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.33.1">Creating blocks </span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">using plugins</span></span></li>
<li><span class="koboSpan" id="kobo.35.1">Creating a custom </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">field type</span></span></li>
<li><span class="koboSpan" id="kobo.37.1">Creating a custom </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">field widget</span></span></li>
<li><span class="koboSpan" id="kobo.39.1">Creating a custom </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">field formatter</span></span></li>
<li><span class="koboSpan" id="kobo.41.1">Creating a custom </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">plugin type</span></span></li>
</ul>
<h1 id="_idParaDest-237"><a id="_idTextAnchor266"/><span class="koboSpan" id="kobo.43.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.44.1">This chapter will require a custom module to be installed. </span><span class="koboSpan" id="kobo.44.2">In the following recipes, the module name is </span><strong class="source-inline"><span class="koboSpan" id="kobo.45.1">mymodule</span></strong><span class="koboSpan" id="kobo.46.1">. </span><span class="koboSpan" id="kobo.46.2">Replace as appropriate. </span><span class="koboSpan" id="kobo.46.3">You can find the full code used in this chapter on </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">GitHub: </span></span><a href="https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp08"><span class="No-Break"><span class="koboSpan" id="kobo.48.1">https://github.com/PacktPublishing/Drupal-10-Development-Cookbook/tree/main/chp08</span></span></a></p>
<h1 id="_idParaDest-238"><a id="_idTextAnchor267"/><span class="koboSpan" id="kobo.49.1">Creating blocks using plugins</span></h1>
<p><span class="koboSpan" id="kobo.50.1">In Drupal, a </span><strong class="bold"><span class="koboSpan" id="kobo.51.1">block</span></strong><span class="koboSpan" id="kobo.52.1"> is a piece of content that can be placed in a region provided by a theme. </span><span class="koboSpan" id="kobo.52.2">Blocks are used to present specific kinds of content, such as a user login form, a snippet of text, and </span><span class="No-Break"><span class="koboSpan" id="kobo.53.1">many more.</span></span></p>
<p><span class="koboSpan" id="kobo.54.1">Blocks are </span><a id="_idIndexMarker432"/><span class="koboSpan" id="kobo.55.1">annotated plugins. </span><span class="koboSpan" id="kobo.55.2">Annotated plugins use documentation blocks to provide details of the plugin. </span><span class="koboSpan" id="kobo.55.3">They are discovered in the module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.56.1">Plugin</span></strong><span class="koboSpan" id="kobo.57.1"> class namespace. </span><span class="koboSpan" id="kobo.57.2">Each class in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.58.1">Plugin/Block</span></strong><span class="koboSpan" id="kobo.59.1"> namespace will be discovered by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.60.1">Block</span></strong><span class="koboSpan" id="kobo.61.1"> module’s </span><span class="No-Break"><span class="koboSpan" id="kobo.62.1">plugin manager.</span></span></p>
<p><span class="koboSpan" id="kobo.63.1">In this recipe, we will define a block that will display a copyright snippet and the current year and place it in the </span><span class="No-Break"><span class="koboSpan" id="kobo.64.1">footer region.</span></span></p>
<h2 id="_idParaDest-239"><a id="_idTextAnchor268"/><span class="koboSpan" id="kobo.65.1">How to do it…</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.66.1">First, we need to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.67.1">src/Plugin/Block</span></strong><span class="koboSpan" id="kobo.68.1"> directory in the module’s directory. </span><span class="koboSpan" id="kobo.68.2">This will translate the </span><strong class="source-inline"><span class="koboSpan" id="kobo.69.1">\Drupal\mymodule\Plugin\Block</span></strong><span class="koboSpan" id="kobo.70.1"> namespace and allow block </span><span class="No-Break"><span class="koboSpan" id="kobo.71.1">plugin discovery:</span></span><pre class="console"><span class="koboSpan" id="kobo.72.1">
mkdir -p src/Plugin/Block</span></pre></li>
<li><span class="koboSpan" id="kobo.73.1">Create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.74.1">Copyright.php</span></strong><span class="koboSpan" id="kobo.75.1"> in the newly created directory so that we can define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.76.1">Copyright</span></strong><span class="koboSpan" id="kobo.77.1"> class for </span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">our block.</span></span></li>
<li><span class="koboSpan" id="kobo.79.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.80.1">Copyright</span></strong><span class="koboSpan" id="kobo.81.1"> class will extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.82.1">\</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.83.1">Drupal\Core\Block\BlockBase</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.84.1"> class:</span></span><pre class="console"><span class="koboSpan" id="kobo.85.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.86.1">
namespace Drupal\mymodule\Plugin\Block;</span></pre><pre class="console"><span class="koboSpan" id="kobo.87.1">
use Drupal\Core\Block\BlockBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.88.1">
class Copyright extends BlockBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.89.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.90.1">We will extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.91.1">BlockBase</span></strong><span class="koboSpan" id="kobo.92.1"> class, which implements </span><strong class="source-inline"><span class="koboSpan" id="kobo.93.1">\Drupal\Core\Block\BlockPluginInterface</span></strong><span class="koboSpan" id="kobo.94.1"> and provides us with an implementation of nearly all of the </span><span class="No-Break"><span class="koboSpan" id="kobo.95.1">interface’s methods.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.96.1">Next, we will </span><a id="_idIndexMarker433"/><span class="koboSpan" id="kobo.97.1">write the plugin annotation in a class document block. </span><span class="koboSpan" id="kobo.97.2">We will provide the block’s identifier, administrative label, and category as </span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">annotation tags:</span></span><pre class="console"><span class="koboSpan" id="kobo.99.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.100.1">
namespace Drupal\mymodule\Plugin\Block;</span></pre><pre class="console"><span class="koboSpan" id="kobo.101.1">
use Drupal\Core\Block\BlockBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.102.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.103.1">
 * @Block(</span></pre><pre class="console"><span class="koboSpan" id="kobo.104.1">
 *   id = "copyright_block",</span></pre><pre class="console"><span class="koboSpan" id="kobo.105.1">
 *   admin_label = @Translation("Copyright"),</span></pre><pre class="console"><span class="koboSpan" id="kobo.106.1">
 *   category = @Translation("Custom"),</span></pre><pre class="console"><span class="koboSpan" id="kobo.107.1">
 * )</span></pre><pre class="console"><span class="koboSpan" id="kobo.108.1">
*/</span></pre><pre class="console"><span class="koboSpan" id="kobo.109.1">
class Copyright extends BlockBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.110.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.111.1">Annotations are provided in code comments and are prefixed with </span><strong class="source-inline"><span class="koboSpan" id="kobo.112.1">@</span></strong><span class="koboSpan" id="kobo.113.1">. </span><span class="koboSpan" id="kobo.113.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.114.1">@</span></strong><span class="koboSpan" id="kobo.115.1"> symbol in </span><strong class="source-inline"><span class="koboSpan" id="kobo.116.1">@Block</span></strong><span class="koboSpan" id="kobo.117.1"> specifies that this is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.118.1">Block</span></strong><span class="koboSpan" id="kobo.119.1"> annotation. </span><span class="koboSpan" id="kobo.119.2">Drupal will parse this and create a plugin definition based on the provided properties. </span><strong class="source-inline"><span class="koboSpan" id="kobo.120.1">id</span></strong><span class="koboSpan" id="kobo.121.1"> is the internal machine name, </span><strong class="source-inline"><span class="koboSpan" id="kobo.122.1">admin_label</span></strong><span class="koboSpan" id="kobo.123.1"> is displayed on the block listing page, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.124.1">category</span></strong><span class="koboSpan" id="kobo.125.1"> shows up in the block </span><span class="No-Break"><span class="koboSpan" id="kobo.126.1">select list.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.127.1">We will </span><a id="_idIndexMarker434"/><span class="koboSpan" id="kobo.128.1">need to implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.129.1">build</span></strong><span class="koboSpan" id="kobo.130.1"> method to satisfy the </span><strong class="source-inline"><span class="koboSpan" id="kobo.131.1">\Drupal\Core\Block\BlockPluginInterface</span></strong><span class="koboSpan" id="kobo.132.1"> interface. </span><span class="koboSpan" id="kobo.132.2">This returns the output to </span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">be displayed:</span></span><pre class="console"><span class="koboSpan" id="kobo.134.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.135.1">
namespace Drupal\mymodule\Plugin\Block;</span></pre><pre class="console"><span class="koboSpan" id="kobo.136.1">
use Drupal\Core\Block\BlockBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.137.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.138.1">
 * @Block(</span></pre><pre class="console"><span class="koboSpan" id="kobo.139.1">
 * id = "copyright_block",</span></pre><pre class="console"><span class="koboSpan" id="kobo.140.1">
 * admin_label = @Translation("Copyright"),</span></pre><pre class="console"><span class="koboSpan" id="kobo.141.1">
 * category = @Translation("Custom")</span></pre><pre class="console"><span class="koboSpan" id="kobo.142.1">
 * )</span></pre><pre class="console"><span class="koboSpan" id="kobo.143.1">
 */</span></pre><pre class="console"><span class="koboSpan" id="kobo.144.1">
class Copyright extends BlockBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.145.1">
  /**</span></pre><pre class="console"><span class="koboSpan" id="kobo.146.1">
   * {@inheritdoc}</span></pre><pre class="console"><span class="koboSpan" id="kobo.147.1">
   */</span></pre><pre class="console"><span class="koboSpan" id="kobo.148.1">
  public function build() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.149.1">
    $date = new \DateTime();</span></pre><pre class="console"><span class="koboSpan" id="kobo.150.1">
    return [</span></pre><pre class="console"><span class="koboSpan" id="kobo.151.1">
      '#markup' =&gt; t('Copyright @year&amp;copy; My</span></pre><pre class="console"><span class="koboSpan" id="kobo.152.1">
        Company', [</span></pre><pre class="console"><span class="koboSpan" id="kobo.153.1">
        '@year' =&gt; $date-&gt;format('Y'),</span></pre><pre class="console"><span class="koboSpan" id="kobo.154.1">
      ]),</span></pre><pre class="console"><span class="koboSpan" id="kobo.155.1">
    ];</span></pre><pre class="console"><span class="koboSpan" id="kobo.156.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.157.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.158.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">build</span></strong><span class="koboSpan" id="kobo.160.1"> method returns a render array that uses Drupal’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">t</span></strong><span class="koboSpan" id="kobo.162.1"> function to substitute </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">@year</span></strong><span class="koboSpan" id="kobo.164.1"> for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.165.1">\DateTime</span></strong><span class="koboSpan" id="kobo.166.1"> object’s output that is formatted as a </span><span class="No-Break"><span class="koboSpan" id="kobo.167.1">full year.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.168.1">Rebuild your </span><a id="_idIndexMarker435"/><span class="koboSpan" id="kobo.169.1">Drupal site’s cache to rebuild the block plugin definitions cache, causing a rediscovery of </span><span class="No-Break"><span class="koboSpan" id="kobo.170.1">plugin definitions:</span></span><pre class="console"><span class="koboSpan" id="kobo.171.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.172.1">Go to the </span><strong class="bold"><span class="koboSpan" id="kobo.173.1">Block layout</span></strong><span class="koboSpan" id="kobo.174.1"> page from </span><strong class="bold"><span class="koboSpan" id="kobo.175.1">Structure</span></strong><span class="koboSpan" id="kobo.176.1"> in the administrative menu. </span><span class="koboSpan" id="kobo.176.2">In the Footer fourth region, click on </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.177.1">Place block</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.178.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.179.1">Review the block list and add the custom block to your regions, for instance, the footer region. </span><span class="koboSpan" id="kobo.179.2">Find the </span><strong class="bold"><span class="koboSpan" id="kobo.180.1">Copyright</span></strong><span class="koboSpan" id="kobo.181.1"> block and click on </span><strong class="bold"><span class="koboSpan" id="kobo.182.1">Place block</span></strong><span class="koboSpan" id="kobo.183.1"> in the </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">dialog form:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer049">
<span class="koboSpan" id="kobo.185.1"><img alt="Figure 8.1 – Place block dialog for the Copyright block" src="image/Figure_8.01_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.186.1">Figure 8.1 – Place block dialog for the Copyright block</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.187.1">Uncheck </span><a id="_idIndexMarker436"/><span class="koboSpan" id="kobo.188.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.189.1">Display title</span></strong><span class="koboSpan" id="kobo.190.1"> checkbox so that only our block’s content will be rendered. </span><span class="koboSpan" id="kobo.190.2">Click on </span><strong class="bold"><span class="koboSpan" id="kobo.191.1">Save blocks</span></strong><span class="koboSpan" id="kobo.192.1"> and accept all </span><span class="No-Break"><span class="koboSpan" id="kobo.193.1">other defaults.</span></span></li>
<li><span class="koboSpan" id="kobo.194.1">Visit your Drupal site and verify that the copyright statement displays the </span><span class="No-Break"><span class="koboSpan" id="kobo.195.1">current year:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer050">
<span class="koboSpan" id="kobo.196.1"><img alt="Figure 8.2 – Copyright block in the footer of a Drupal site" src="image/Figure_8.02_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.197.1">Figure 8.2 – Copyright block in the footer of a Drupal site</span></p>
<h2 id="_idParaDest-240"><a id="_idTextAnchor269"/><span class="koboSpan" id="kobo.198.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.199.1">The plugin system is comprised of multiple instantiable classes that share a similar interface. </span><span class="koboSpan" id="kobo.199.2">Using annotations and plugin managers, Drupal makes these classes discoverable. </span><span class="koboSpan" id="kobo.199.3">This allows </span><a id="_idIndexMarker437"/><span class="koboSpan" id="kobo.200.1">for interacting with plugins and executing </span><span class="No-Break"><span class="koboSpan" id="kobo.201.1">their functionality.</span></span></p>
<p><span class="koboSpan" id="kobo.202.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.203.1">\Drupal\Core\Block\BlockManager</span></strong><span class="koboSpan" id="kobo.204.1"> class specifies that the block plugins must be located in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.205.1">Plugin\Block</span></strong><span class="koboSpan" id="kobo.206.1"> namespace. </span><span class="koboSpan" id="kobo.206.2">It also defines the base interface that needs to be implemented, along with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">Annotation</span></strong><span class="koboSpan" id="kobo.208.1"> class, which is to be used when parsing the class’s </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">document block.</span></span></p>
<p><span class="koboSpan" id="kobo.210.1">When retrieving plugin definitions, the plugin manager first checks whether definitions have been previously discovered and cached. </span><span class="koboSpan" id="kobo.210.2">If there are no cached plugin definitions, the available namespaces registered in Drupal are scanned for plugins in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.211.1">\Drupal\{extension}\Plugin\Block</span></strong><span class="koboSpan" id="kobo.212.1"> namespace. </span><span class="koboSpan" id="kobo.212.2">The discovered classes are then processed with the class documentation, which contains annotation data, and are then cached as the available </span><span class="No-Break"><span class="koboSpan" id="kobo.213.1">plugin definitions.</span></span></p>
<p><span class="koboSpan" id="kobo.214.1">When viewing the </span><strong class="bold"><span class="koboSpan" id="kobo.215.1">Block layout</span></strong><span class="koboSpan" id="kobo.216.1"> page to manage blocks, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.217.1">label</span></strong><span class="koboSpan" id="kobo.218.1"> method on </span><strong class="source-inline"><span class="koboSpan" id="kobo.219.1">\Drupal\Core\Block\BlockBase</span></strong><span class="koboSpan" id="kobo.220.1"> is invoked to display the human-readable name defined in the plugin’s annotation. </span><span class="koboSpan" id="kobo.220.2">When a block is displayed on a rendered page, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">build</span></strong><span class="koboSpan" id="kobo.222.1"> method is invoked and passed to the theming layer to </span><span class="No-Break"><span class="koboSpan" id="kobo.223.1">be output.</span></span></p>
<h2 id="_idParaDest-241"><a id="_idTextAnchor270"/><span class="koboSpan" id="kobo.224.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.225.1">There are more in-depth items that can be used when creating a block plugin. </span><span class="koboSpan" id="kobo.225.2">We will cover those in the </span><span class="No-Break"><span class="koboSpan" id="kobo.226.1">following sections.</span></span></p>
<h3><span class="koboSpan" id="kobo.227.1">Altering blocks</span></h3>
<p><span class="koboSpan" id="kobo.228.1">Blocks can </span><a id="_idIndexMarker438"/><span class="koboSpan" id="kobo.229.1">be altered in three different ways: the </span><strong class="bold"><span class="koboSpan" id="kobo.230.1">plugin definition</span></strong><span class="koboSpan" id="kobo.231.1">, the </span><strong class="bold"><span class="koboSpan" id="kobo.232.1">build array</span></strong><span class="koboSpan" id="kobo.233.1">, or the </span><strong class="bold"><span class="koboSpan" id="kobo.234.1">view array output</span></strong><span class="koboSpan" id="kobo.235.1"> can </span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">be altered.</span></span></p>
<p><span class="koboSpan" id="kobo.237.1">A module can implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">hook_block_alter</span></strong><span class="koboSpan" id="kobo.239.1"> in its </span><strong class="source-inline"><span class="koboSpan" id="kobo.240.1">.module</span></strong><span class="koboSpan" id="kobo.241.1"> file and modify the annotation definitions of all the discovered blocks. </span><span class="koboSpan" id="kobo.241.2">This will allow a module to change the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.242.1">user_login_block</span></strong><span class="koboSpan" id="kobo.243.1"> from </span><strong class="bold"><span class="koboSpan" id="kobo.244.1">User Login</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.245.1">to </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.246.1">Login</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.247.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.248.1">
/**
 * Implements hook_block_alter().
 </span><span class="koboSpan" id="kobo.248.2">*/
function mymodule_block_alter(&amp;$definitions) {
  $definitions['user_login_block']['admin_label'] =
    t('Login');
}</span></pre>
<p><span class="koboSpan" id="kobo.249.1">A module can implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.250.1">hook_block_build_alter</span></strong><span class="koboSpan" id="kobo.251.1"> and modify the build information of a block. </span><span class="koboSpan" id="kobo.251.2">The hook is passed through the build array and the instance for the current block. </span><span class="koboSpan" id="kobo.251.3">Module developers can use this to add cache contexts or alter the cacheability of the </span><span class="No-Break"><span class="koboSpan" id="kobo.252.1">cache metadata:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.253.1">
/**
 * Implements hook_block_build_alter().
 </span><span class="koboSpan" id="kobo.253.2">*/
function mymodule_block_build_alter(
  array &amp;$build,
  \Drupal\Core\Block\BlockPluginInterface $block
) {
  // Add the 'url' cache the block per URL.
</span><span class="koboSpan" id="kobo.253.3">  if ($block-&gt;id() == 'myblock') {
    $build['#cache']['contexts'][] = 'url';
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.254.1">You can test the modification of the cache metadata by altering the block created in this recipe to output a timestamp instead of a year format. </span><span class="koboSpan" id="kobo.254.2">With caching enabled, you will see that the value persists on the same URL, but it will be different across </span><span class="No-Break"><span class="koboSpan" id="kobo.255.1">each page.</span></span></p>
<p><span class="koboSpan" id="kobo.256.1">Finally, a module can implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">hook_block_view_alter</span></strong><span class="koboSpan" id="kobo.258.1"> in order to modify the output of </span><a id="_idIndexMarker439"/><span class="koboSpan" id="kobo.259.1">the block to be rendered. </span><span class="koboSpan" id="kobo.259.2">A module can add content to be rendered or removed. </span><span class="koboSpan" id="kobo.259.3">This can be used to remove the </span><strong class="source-inline"><span class="koboSpan" id="kobo.260.1">contextual_links</span></strong><span class="koboSpan" id="kobo.261.1"> item, which allows inline editing on the front page of </span><span class="No-Break"><span class="koboSpan" id="kobo.262.1">a site:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.263.1">
/**
 * Implements hook_block_view_alter().
 </span><span class="koboSpan" id="kobo.263.2">*/
function mymodule_block_view_alter(
  array &amp;$build,
  \Drupal\Core\Block\BlockPluginInterface $block
) {
  // Remove the contextual links on all blocks that provide
    them.
</span><span class="koboSpan" id="kobo.263.3">  if (isset($build['#contextual_links'])) {
    unset($build['#contextual_links']);
  }
}</span></pre>
<h3><span class="koboSpan" id="kobo.264.1">Block settings form</span></h3>
<p><span class="koboSpan" id="kobo.265.1">Blocks can provide a settings form. </span><span class="koboSpan" id="kobo.265.2">This recipe provides the text </span><em class="italic"><span class="koboSpan" id="kobo.266.1">My Company</span></em><span class="koboSpan" id="kobo.267.1"> for the copyright text. </span><span class="koboSpan" id="kobo.267.2">Instead of being set in code, this can be defined through a text field in the block’s </span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">setting form.</span></span></p>
<p><span class="koboSpan" id="kobo.269.1">Let’s </span><a id="_idIndexMarker440"/><span class="koboSpan" id="kobo.270.1">readdress the </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">Copyright.php</span></strong><span class="koboSpan" id="kobo.272.1"> file that holds our block’s class. </span><span class="koboSpan" id="kobo.272.2">We will override methods provided by our base class. </span><span class="koboSpan" id="kobo.272.3">The following methods will be added to the class written in </span><span class="No-Break"><span class="koboSpan" id="kobo.273.1">this recipe.</span></span></p>
<p><span class="koboSpan" id="kobo.274.1">A block can override the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">defaultConfiguration</span></strong><span class="koboSpan" id="kobo.276.1"> method, which returns an array of setting keys and their default values. </span><span class="koboSpan" id="kobo.276.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">blockForm</span></strong><span class="koboSpan" id="kobo.278.1"> method can then be overridden to return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.279.1">Form</span></strong><span class="koboSpan" id="kobo.280.1"> API array to represent the </span><span class="No-Break"><span class="koboSpan" id="kobo.281.1">settings form:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.282.1">
  /**
   * {@inheritdoc}
   */
  public function defaultConfiguration() {
    return [
      'company_name' =&gt; '',
    ];
  }
  /**
   * {@inheritdoc}
   */
  public function blockForm($form,
    \Drupal\Core\Form\FormStateInterface $form_state) {
    $form['company_name'] = [
      '#type' =&gt; 'textfield',
      '#title' =&gt; t('Company name'),
      '#default_value' =&gt; $this-&gt;configuration
         ['company_name'],
    ];
    return $form;
  }</span></pre>
<p><span class="koboSpan" id="kobo.283.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">blockSubmit</span></strong><span class="koboSpan" id="kobo.285.1"> method must then be implemented, which updates the block’s configuration. </span><span class="koboSpan" id="kobo.285.2">The following code retrieves the </span><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">company_name</span></strong><span class="koboSpan" id="kobo.287.1"> value from the form’s state, which </span><a id="_idIndexMarker441"/><span class="koboSpan" id="kobo.288.1">contains submitted values, and sets it to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.289.1">configuration</span></strong><span class="koboSpan" id="kobo.290.1"> property in its </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.291.1">company_name</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.292.1"> key:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.293.1">
  /**
   * {@inheritdoc}
   */
  public function blockSubmit($form, \Drupal
    \Core\Form\FormStateInterface $form_state) {
    $this-&gt;configuration['company_name'] =
    $form_state-&gt;getValue('company_name');
  }</span></pre>
<p><span class="koboSpan" id="kobo.294.1">Finally, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.295.1">build</span></strong><span class="koboSpan" id="kobo.296.1"> method can be updated to use the new </span><span class="No-Break"><span class="koboSpan" id="kobo.297.1">configuration item:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.298.1">
  /**
   * {@inheritdoc}
   */
  public function build()
  {
    $date = new \DateTime();
    return [
      '#markup' =&gt; t('Copyright @year&amp;copy; @company', [
        '@year' =&gt; $date-&gt;format('Y'),
        '@company' =&gt; $this-&gt;configuration['company_name'],
      ]),
    ];
  }</span></pre>
<p><span class="koboSpan" id="kobo.299.1">You can </span><a id="_idIndexMarker442"/><span class="koboSpan" id="kobo.300.1">now return to the </span><strong class="bold"><span class="koboSpan" id="kobo.301.1">Block layout</span></strong><span class="koboSpan" id="kobo.302.1"> form and click on </span><strong class="bold"><span class="koboSpan" id="kobo.303.1">Configure</span></strong><span class="koboSpan" id="kobo.304.1"> for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.305.1">Copyright</span></strong><span class="koboSpan" id="kobo.306.1"> block. </span><span class="koboSpan" id="kobo.306.2">The new setting will be available in the block instance’s </span><span class="No-Break"><span class="koboSpan" id="kobo.307.1">configuration form.</span></span></p>
<h3><span class="koboSpan" id="kobo.308.1">Defining access to a block</span></h3>
<p><span class="koboSpan" id="kobo.309.1">Blocks, by default, are rendered for all users. </span><span class="koboSpan" id="kobo.309.2">The default access method can be overridden. </span><span class="koboSpan" id="kobo.309.3">This </span><a id="_idIndexMarker443"/><span class="koboSpan" id="kobo.310.1">allows a block to only be displayed to authenticated users or based on </span><span class="No-Break"><span class="koboSpan" id="kobo.311.1">specific permissions:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.312.1">
/**
 * {@inheritdoc}
 */
protected function blockAccess(AccountInterface $account) {
  $route_name = $this-&gt;routeMatch-&gt;getRouteName();
  if ($account-&gt;isAnonymous() &amp;&amp; !in_array($route_name,
     ['user.login', 'user.logout'])) {
    return AccessResult::allowed()
      -&gt;addCacheContexts(['route.name',
        'user.roles:anonymous']);
  }
  return AccessResult::forbidden();
}</span></pre>
<p><span class="koboSpan" id="kobo.313.1">The preceding code is taken from </span><strong class="source-inline"><span class="koboSpan" id="kobo.314.1">user_login_block</span></strong><span class="koboSpan" id="kobo.315.1">. </span><span class="koboSpan" id="kobo.315.2">It allows access to the block if the user is logged out and is not on the login or logout page. </span><span class="koboSpan" id="kobo.315.3">The access is cached based on the current route name and the user’s current role being anonymous. </span><span class="koboSpan" id="kobo.315.4">If these are not passed, the access returned is forbidden and the block is </span><span class="No-Break"><span class="koboSpan" id="kobo.316.1">not built.</span></span></p>
<p><span class="koboSpan" id="kobo.317.1">Other modules </span><a id="_idIndexMarker444"/><span class="koboSpan" id="kobo.318.1">can implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.319.1">hook_block_access</span></strong><span class="koboSpan" id="kobo.320.1"> to override the access of </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">a block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.322.1">
/**
 * Implements hook_block_access().
 </span><span class="koboSpan" id="kobo.322.2">*/
function mymodule_block_access(
  \Drupal\block\Entity\Block $block,
  $operation,
  \Drupal\Core\Session\AccountInterface $account
) {
  // Example code that would prevent displaying the
    Copyright' block in
  // a region different from the footer.
</span><span class="koboSpan" id="kobo.322.3">  if ($operation == 'view' &amp;&amp; $block-&gt;getPluginId() ==
    'copyright') {
    return
      \Drupal\Core\Access\AccessResult::forbiddenIf($block-
        &gt;getRegion() != 'footer');
  }
  // No opinion.
</span><span class="koboSpan" id="kobo.322.4">  return \Drupal\Core\Access\AccessResult::neutral();
}</span></pre>
<p><span class="koboSpan" id="kobo.323.1">A module implementing the preceding hook will deny access to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.324.1">Copyright</span></strong><span class="koboSpan" id="kobo.325.1"> block if it is not placed in the footer region. </span><span class="koboSpan" id="kobo.325.2">If the block operation is not </span><strong class="source-inline"><span class="koboSpan" id="kobo.326.1">view</span></strong><span class="koboSpan" id="kobo.327.1"> and the block is not our </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">Copyright</span></strong><span class="koboSpan" id="kobo.329.1"> block, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.330.1">neutral</span></strong><span class="koboSpan" id="kobo.331.1"> access result is passed. </span><span class="koboSpan" id="kobo.331.2">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.332.1">neutral</span></strong><span class="koboSpan" id="kobo.333.1"> result allows the </span><a id="_idIndexMarker445"/><span class="koboSpan" id="kobo.334.1">system to process other access results. </span><span class="koboSpan" id="kobo.334.2">Otherwise, </span><strong class="source-inline"><span class="koboSpan" id="kobo.335.1">AccessResult::forbiddenIf</span></strong><span class="koboSpan" id="kobo.336.1"> will return </span><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">neutral</span></strong><span class="koboSpan" id="kobo.338.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.339.1">forbidden</span></strong><span class="koboSpan" id="kobo.340.1"> based on the Boolean value passed </span><span class="No-Break"><span class="koboSpan" id="kobo.341.1">to it.</span></span></p>
<h2 id="_idParaDest-242"><a id="_idTextAnchor271"/><span class="koboSpan" id="kobo.342.1">See also</span></h2>
<ul>
<li><span class="koboSpan" id="kobo.343.1">Refer to the </span><em class="italic"><span class="koboSpan" id="kobo.344.1">Creating a custom plugin type</span></em><span class="koboSpan" id="kobo.345.1"> recipe of </span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">this chapter</span></span></li>
<li><span class="koboSpan" id="kobo.347.1">Annotation-based </span><a id="_idIndexMarker446"/><span class="koboSpan" id="kobo.348.1">plugin </span><span class="No-Break"><span class="koboSpan" id="kobo.349.1">documentation: </span></span><a href="https://www.drupal.org/docs/drupal-apis/plugin-api/annotations-based-plugins "><span class="No-Break"><span class="koboSpan" id="kobo.350.1">https://www.drupal.org/docs/drupal-apis/plugin-api/annotations-based-plugins</span></span></a></li>
<li><span class="koboSpan" id="kobo.351.1">Information </span><a id="_idIndexMarker447"/><span class="koboSpan" id="kobo.352.1">about hooks provided by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.353.1">Block</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.354.1">module: </span></span><a href="https://api.drupal.org/api/drupal/core%21modules%21block%21block.api.php/10"><span class="No-Break"><span class="koboSpan" id="kobo.355.1">https://api.drupal.org/api/drupal/core%21modules%21block%21block.api.php/10</span></span></a></li>
</ul>
<h1 id="_idParaDest-243"><a id="_idTextAnchor272"/><span class="koboSpan" id="kobo.356.1">Creating a custom field type</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.357.1">Field types</span></strong><span class="koboSpan" id="kobo.358.1"> are defined </span><a id="_idIndexMarker448"/><span class="koboSpan" id="kobo.359.1">using the plugin system. </span><span class="koboSpan" id="kobo.359.2">Each field type has its own class and definition. </span><span class="koboSpan" id="kobo.359.3">A new field type can be defined through a custom class that will provide schema and </span><span class="No-Break"><span class="koboSpan" id="kobo.360.1">property information.</span></span></p>
<p><span class="koboSpan" id="kobo.361.1">Field types </span><a id="_idIndexMarker449"/><span class="koboSpan" id="kobo.362.1">define ways in which data can be stored and handled through the </span><strong class="bold"><span class="koboSpan" id="kobo.363.1">Field</span></strong><span class="koboSpan" id="kobo.364.1"> API on entities. </span><span class="koboSpan" id="kobo.364.2">Field widgets provide means for editing a field type in the user interface. </span><span class="koboSpan" id="kobo.364.3">Field formatters provide means for displaying the field data to users. </span><span class="koboSpan" id="kobo.364.4">Both are plugins and will be covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">later recipes.</span></span></p>
<p><span class="koboSpan" id="kobo.366.1">In this example, we will create a simple field type called </span><strong class="source-inline"><span class="koboSpan" id="kobo.367.1">realname</span></strong><span class="koboSpan" id="kobo.368.1"> to store the first and last names and add it to a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.369.1">comment</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.370.1"> type.</span></span></p>
<h2 id="_idParaDest-244"><a id="_idTextAnchor273"/><span class="koboSpan" id="kobo.371.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.372.1">This recipe adds a field to a </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">comment</span></strong><span class="koboSpan" id="kobo.374.1"> type, which requires the </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">Comment</span></strong><span class="koboSpan" id="kobo.376.1"> module to be installed. </span><span class="koboSpan" id="kobo.376.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">Comment</span></strong><span class="koboSpan" id="kobo.378.1"> module is installed by default with a standard </span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">Drupal installation.</span></span></p>
<h2 id="_idParaDest-245"><a id="_idTextAnchor274"/><span class="koboSpan" id="kobo.380.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.381.1">First, we need </span><a id="_idIndexMarker450"/><span class="koboSpan" id="kobo.382.1">to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">src/Plugin/Field/FieldType</span></strong><span class="koboSpan" id="kobo.384.1"> directory in the module’s directory. </span><span class="koboSpan" id="kobo.384.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">Field</span></strong><span class="koboSpan" id="kobo.386.1"> module discovers field types in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">Plugin\Field\FieldType</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.388.1"> namespace:</span></span><pre class="console"><span class="koboSpan" id="kobo.389.1">
mkdir -p src/Plugin/Field/FieldType</span></pre></li>
<li><span class="koboSpan" id="kobo.390.1">Create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.391.1">RealName.php</span></strong><span class="koboSpan" id="kobo.392.1"> in the newly created directory so that we can define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.393.1">RealName</span></strong><span class="koboSpan" id="kobo.394.1"> class. </span><span class="koboSpan" id="kobo.394.2">This will provide our </span><strong class="source-inline"><span class="koboSpan" id="kobo.395.1">realname</span></strong><span class="koboSpan" id="kobo.396.1"> field type for the first and </span><span class="No-Break"><span class="koboSpan" id="kobo.397.1">last names.</span></span></li>
<li><span class="koboSpan" id="kobo.398.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.399.1">RealName</span></strong><span class="koboSpan" id="kobo.400.1"> class will extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">\</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.402.1">Drupal\Core\Field\FieldItemBase</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.403.1"> class:</span></span><pre class="console"><span class="koboSpan" id="kobo.404.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.405.1">
namespace Drupal\mymodule\Plugin\Field\FieldType;</span></pre><pre class="console"><span class="koboSpan" id="kobo.406.1">
use Drupal\Core\Field\FieldItemBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.407.1">
use Drupal\Core\Field\FieldStorageDefinitionInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.408.1">
use Drupal\Core\TypedData\DataDefinition;</span></pre><pre class="console"><span class="koboSpan" id="kobo.409.1">
class RealName extends FieldItemBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.410.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.411.1">We will extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.412.1">FieldItemBase</span></strong><span class="koboSpan" id="kobo.413.1"> class, which satisfies methods defined by inherited interfaces for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.414.1">FieldType</span></strong><span class="koboSpan" id="kobo.415.1"> plugin type, except for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">schema</span></strong><span class="koboSpan" id="kobo.417.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">propertyDefinitions</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.419.1"> methods.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.420.1">Next, we will write the plugin annotation in a class document block. </span><span class="koboSpan" id="kobo.420.2">We will provide the </span><a id="_idIndexMarker451"/><span class="koboSpan" id="kobo.421.1">field type’s identifier, label, description, category, default widget, </span><span class="No-Break"><span class="koboSpan" id="kobo.422.1">and formatter:</span></span><pre class="console"><span class="koboSpan" id="kobo.423.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.424.1">
namespace Drupal\mymodule\Plugin\Field\FieldType;</span></pre><pre class="console"><span class="koboSpan" id="kobo.425.1">
use Drupal\Core\Field\FieldItemBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.426.1">
use Drupal\Core\Field\FieldStorageDefinitionInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.427.1">
use Drupal\Core\TypedData\DataDefinition;</span></pre><pre class="console"><span class="koboSpan" id="kobo.428.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.429.1">
 * Plugin implementation of the 'realname' field type.</span></pre><pre class="console"><span class="koboSpan" id="kobo.430.1">
 *</span></pre><pre class="console"><span class="koboSpan" id="kobo.431.1">
 * @FieldType(</span></pre><pre class="console"><span class="koboSpan" id="kobo.432.1">
 *   id = "realname",</span></pre><pre class="console"><span class="koboSpan" id="kobo.433.1">
 *   label = @Translation("Real name"),</span></pre><pre class="console"><span class="koboSpan" id="kobo.434.1">
 *   description = @Translation("This field stores a</span></pre><pre class="console"><span class="koboSpan" id="kobo.435.1">
        first and last name."),</span></pre><pre class="console"><span class="koboSpan" id="kobo.436.1">
 *   category = @Translation("General"),</span></pre><pre class="console"><span class="koboSpan" id="kobo.437.1">
 *   default_widget = "string_textfield",</span></pre><pre class="console"><span class="koboSpan" id="kobo.438.1">
 *   default_formatter = "string"</span></pre><pre class="console"><span class="koboSpan" id="kobo.439.1">
 * )</span></pre><pre class="console"><span class="koboSpan" id="kobo.440.1">
 */</span></pre><pre class="console"><span class="koboSpan" id="kobo.441.1">
class RealName extends FieldItemBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.442.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.443.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">@FieldType</span></strong><span class="koboSpan" id="kobo.445.1"> annotation </span><a id="_idIndexMarker452"/><span class="koboSpan" id="kobo.446.1">tells Drupal that this is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.447.1">FieldType</span></strong><span class="koboSpan" id="kobo.448.1"> plugin. </span><span class="koboSpan" id="kobo.448.2">The following properties </span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">are defined:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.450.1">id</span></strong><span class="koboSpan" id="kobo.451.1">: This is the plugin’s </span><span class="No-Break"><span class="koboSpan" id="kobo.452.1">machine name</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.453.1">label</span></strong><span class="koboSpan" id="kobo.454.1">: This is the human-readable name for </span><span class="No-Break"><span class="koboSpan" id="kobo.455.1">the field</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">description</span></strong><span class="koboSpan" id="kobo.457.1">: This is the human-readable description of </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">the field</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.459.1">category</span></strong><span class="koboSpan" id="kobo.460.1">: This is the category where the field shows up in the </span><span class="No-Break"><span class="koboSpan" id="kobo.461.1">user interface</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.462.1">default_widget</span></strong><span class="koboSpan" id="kobo.463.1">: This is the default form widget to be used </span><span class="No-Break"><span class="koboSpan" id="kobo.464.1">for editing</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.465.1">default_formatter</span></strong><span class="koboSpan" id="kobo.466.1">: This is the default formatter with which you can display </span><span class="No-Break"><span class="koboSpan" id="kobo.467.1">the field</span></span></li>
</ul>
<ol>
<li value="5"><span class="koboSpan" id="kobo.468.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.469.1">RealName</span></strong><span class="koboSpan" id="kobo.470.1"> class needs to implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.471.1">schema</span></strong><span class="koboSpan" id="kobo.472.1"> method defined in </span><strong class="source-inline"><span class="koboSpan" id="kobo.473.1">\Drupal\Core\Field\FieldItemInterface</span></strong><span class="koboSpan" id="kobo.474.1">. </span><span class="koboSpan" id="kobo.474.2">This returns an array of the database API schema information. </span><span class="koboSpan" id="kobo.474.3">Add the following method to </span><span class="No-Break"><span class="koboSpan" id="kobo.475.1">your class:</span></span><pre class="console"><span class="koboSpan" id="kobo.476.1">
  /**</span></pre><pre class="console"><span class="koboSpan" id="kobo.477.1">
   * {@inheritdoc}</span></pre><pre class="console"><span class="koboSpan" id="kobo.478.1">
   */</span></pre><pre class="console"><span class="koboSpan" id="kobo.479.1">
  public static function schema(FieldStorage</span></pre><pre class="console"><span class="koboSpan" id="kobo.480.1">
    DefinitionInterface $field_definition)  {</span></pre><pre class="console"><span class="koboSpan" id="kobo.481.1">
    return [</span></pre><pre class="console"><span class="koboSpan" id="kobo.482.1">
      'columns' =&gt; [</span></pre><pre class="console"><span class="koboSpan" id="kobo.483.1">
        'first_name' =&gt; [</span></pre><pre class="console"><span class="koboSpan" id="kobo.484.1">
          'description' =&gt; 'First name.',</span></pre><pre class="console"><span class="koboSpan" id="kobo.485.1">
          'type' =&gt; 'varchar',</span></pre><pre class="console"><span class="koboSpan" id="kobo.486.1">
          'length' =&gt; '255',</span></pre><pre class="console"><span class="koboSpan" id="kobo.487.1">
          'not null' =&gt; TRUE,</span></pre><pre class="console"><span class="koboSpan" id="kobo.488.1">
          'default' =&gt; '',</span></pre><pre class="console"><span class="koboSpan" id="kobo.489.1">
        ],</span></pre><pre class="console"><span class="koboSpan" id="kobo.490.1">
        'last_name' =&gt; [</span></pre><pre class="console"><span class="koboSpan" id="kobo.491.1">
          'description' =&gt; 'Last name.',</span></pre><pre class="console"><span class="koboSpan" id="kobo.492.1">
          'type' =&gt; 'varchar',</span></pre><pre class="console"><span class="koboSpan" id="kobo.493.1">
          'length' =&gt; '255',</span></pre><pre class="console"><span class="koboSpan" id="kobo.494.1">
          'not null' =&gt; TRUE,</span></pre><pre class="console"><span class="koboSpan" id="kobo.495.1">
          'default' =&gt; '',</span></pre><pre class="console"><span class="koboSpan" id="kobo.496.1">
        ],</span></pre><pre class="console"><span class="koboSpan" id="kobo.497.1">
      ],</span></pre><pre class="console"><span class="koboSpan" id="kobo.498.1">
      'indexes' =&gt; [</span></pre><pre class="console"><span class="koboSpan" id="kobo.499.1">
        'first_name' =&gt; ['first_name'],</span></pre><pre class="console"><span class="koboSpan" id="kobo.500.1">
        'last_name' =&gt; ['last_name'],</span></pre><pre class="console"><span class="koboSpan" id="kobo.501.1">
      ],</span></pre><pre class="console"><span class="koboSpan" id="kobo.502.1">
    ];</span></pre><pre class="console"><span class="koboSpan" id="kobo.503.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.504.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.505.1">schema</span></strong><span class="koboSpan" id="kobo.506.1"> method defines the database columns in the field’s data table. </span><span class="koboSpan" id="kobo.506.2">We define a column to hold the </span><strong class="source-inline"><span class="koboSpan" id="kobo.507.1">first_name</span></strong><span class="koboSpan" id="kobo.508.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.509.1">last_name</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.510.1"> values.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.511.1">We will </span><a id="_idIndexMarker453"/><span class="koboSpan" id="kobo.512.1">also need to implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.513.1">propertyDefinitions</span></strong><span class="koboSpan" id="kobo.514.1"> method. </span><span class="koboSpan" id="kobo.514.2">This returns a data definition of the values defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.515.1">schema</span></strong><span class="koboSpan" id="kobo.516.1"> method. </span><span class="koboSpan" id="kobo.516.2">Add the following method to </span><span class="No-Break"><span class="koboSpan" id="kobo.517.1">your class:</span></span><pre class="console"><span class="koboSpan" id="kobo.518.1">
  /**</span></pre><pre class="console"><span class="koboSpan" id="kobo.519.1">
   * {@inheritdoc}</span></pre><pre class="console"><span class="koboSpan" id="kobo.520.1">
   */</span></pre><pre class="console"><span class="koboSpan" id="kobo.521.1">
  public static function propertyDefinitions</span></pre><pre class="console"><span class="koboSpan" id="kobo.522.1">
     (FieldStorageDefinitionInterface</span></pre><pre class="console"><span class="koboSpan" id="kobo.523.1">
        $field_definition) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.524.1">
    $properties['first_name'] =</span></pre><pre class="console"><span class="koboSpan" id="kobo.525.1">
        DataDefinition::create('string')</span></pre><pre class="console"><span class="koboSpan" id="kobo.526.1">
      -&gt;setLabel(t('First name'));</span></pre><pre class="console"><span class="koboSpan" id="kobo.527.1">
    $properties['last_name'] =</span></pre><pre class="console"><span class="koboSpan" id="kobo.528.1">
        DataDefinition::create('string')</span></pre><pre class="console"><span class="koboSpan" id="kobo.529.1">
      -&gt;setLabel(t('Last name'));</span></pre><pre class="console"><span class="koboSpan" id="kobo.530.1">
    return $properties;</span></pre><pre class="console"><span class="koboSpan" id="kobo.531.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.532.1">This method returns an array that is keyed with the same column names provided in the schema. </span><span class="koboSpan" id="kobo.532.2">It returns data definitions to represent the properties in the </span><span class="No-Break"><span class="koboSpan" id="kobo.533.1">field type.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.534.1">We will </span><a id="_idIndexMarker454"/><span class="koboSpan" id="kobo.535.1">override one more method, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.536.1">mainPropertyName</span></strong><span class="koboSpan" id="kobo.537.1"> method, to specify that </span><strong class="source-inline"><span class="koboSpan" id="kobo.538.1">first_name</span></strong><span class="koboSpan" id="kobo.539.1"> is the </span><span class="No-Break"><span class="koboSpan" id="kobo.540.1">main property:</span></span><pre class="console"><span class="koboSpan" id="kobo.541.1">
  /**</span></pre><pre class="console"><span class="koboSpan" id="kobo.542.1">
   * {@inheritdoc}</span></pre><pre class="console"><span class="koboSpan" id="kobo.543.1">
   */</span></pre><pre class="console"><span class="koboSpan" id="kobo.544.1">
  public static function mainPropertyName() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.545.1">
    return 'first_name';</span></pre><pre class="console"><span class="koboSpan" id="kobo.546.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.547.1">This method allows specifying the main property to be used for retrieving the field value automatically when there are </span><span class="No-Break"><span class="koboSpan" id="kobo.548.1">multiple values.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.549.1">Rebuild your Drupal site’s cache to build the field type plugin definitions cache, causing a rediscovery of </span><span class="No-Break"><span class="koboSpan" id="kobo.550.1">plugin definitions:</span></span><pre class="console"><span class="koboSpan" id="kobo.551.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.552.1">The field </span><a id="_idIndexMarker455"/><span class="koboSpan" id="kobo.553.1">will now appear on the field type management screen. </span><span class="koboSpan" id="kobo.553.2">To use it, go to </span><strong class="bold"><span class="koboSpan" id="kobo.554.1">Structure</span></strong><span class="koboSpan" id="kobo.555.1"> and then to </span><strong class="bold"><span class="koboSpan" id="kobo.556.1">Comment types</span></strong><span class="koboSpan" id="kobo.557.1">. </span><span class="koboSpan" id="kobo.557.2">You can now go to </span><strong class="bold"><span class="koboSpan" id="kobo.558.1">Manage fields</span></strong><span class="koboSpan" id="kobo.559.1"> and click on </span><strong class="bold"><span class="koboSpan" id="kobo.560.1">Add field</span></strong><span class="koboSpan" id="kobo.561.1"> to add a real name entry for </span><span class="No-Break"><span class="koboSpan" id="kobo.562.1">your comments:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer051">
<span class="koboSpan" id="kobo.563.1"><img alt="Figure 8.3 – The field appearing in the Add a new field list" src="image/Figure_8.03_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.564.1">Figure 8.3 – The field appearing in the Add a new field list</span></p>
<h2 id="_idParaDest-246"><a id="_idTextAnchor275"/><span class="koboSpan" id="kobo.565.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.566.1">The plugin manager for field types is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">plugin.manager.field.field_type</span></strong><span class="koboSpan" id="kobo.568.1"> service. </span><span class="koboSpan" id="kobo.568.2">This plugin manager defines that field type plugins must be in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">Plugin\Field\FieldType</span></strong><span class="koboSpan" id="kobo.570.1"> namespace and </span><span class="No-Break"><span class="koboSpan" id="kobo.571.1">implement </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.572.1">\Drupal\Core\Field\FieldItemInterface</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.573.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.574.1">When adding a new field to an entity type, the definitions are retrieved from the field type manager </span><a id="_idIndexMarker456"/><span class="koboSpan" id="kobo.575.1">to populate the list of field types. </span><span class="koboSpan" id="kobo.575.2">When a field is added to an entity type, that entity type’s database storage is updated based on the properties provided by the field in </span><strong class="source-inline"><span class="koboSpan" id="kobo.576.1">propertyDefinitions</span></strong><span class="koboSpan" id="kobo.577.1"> with the schema from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.578.1">schema</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.579.1"> method.</span></span></p>
<h2 id="_idParaDest-247"><a id="_idTextAnchor276"/><span class="koboSpan" id="kobo.580.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.581.1">Field types can implement a method to define whether the value is empty or not. </span><span class="koboSpan" id="kobo.581.2">We will cover this in the </span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">next section.</span></span></p>
<h3><span class="koboSpan" id="kobo.583.1">Defining whether a field is empty</span></h3>
<p><span class="koboSpan" id="kobo.584.1">Field type </span><a id="_idIndexMarker457"/><span class="koboSpan" id="kobo.585.1">classes have an </span><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">isEmpty</span></strong><span class="koboSpan" id="kobo.587.1"> method that is used to determine whether the field has </span><span class="No-Break"><span class="koboSpan" id="kobo.588.1">no values.</span></span></p>
<p><span class="koboSpan" id="kobo.589.1">Field types extend </span><strong class="source-inline"><span class="koboSpan" id="kobo.590.1">Drupal\Core\TypedData\Plugin\DataType\Map</span></strong><span class="koboSpan" id="kobo.591.1">, which is a class representation of an associative array in Drupal’s </span><strong class="bold"><span class="koboSpan" id="kobo.592.1">Typed Data</span></strong><span class="koboSpan" id="kobo.593.1"> API. </span><span class="koboSpan" id="kobo.593.2">This in turn implements the </span><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">\Drupal\Core\TypedDate\ComplexDataInterface</span></strong><span class="koboSpan" id="kobo.595.1"> interface, which provides the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">isEmpty</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.597.1"> method.</span></span></p>
<p><span class="koboSpan" id="kobo.598.1">The default functionality is that a field is not considered empty as long as one property has values. </span><span class="koboSpan" id="kobo.598.2">For instance, our real name field would not be considered empty if the first name or last name </span><span class="No-Break"><span class="koboSpan" id="kobo.599.1">had values.</span></span></p>
<p><span class="koboSpan" id="kobo.600.1">Field types can provide their own implementations to provide a more </span><span class="No-Break"><span class="koboSpan" id="kobo.601.1">robust verification.</span></span></p>
<h1 id="_idParaDest-248"><a id="_idTextAnchor277"/><span class="koboSpan" id="kobo.602.1">Creating a custom field widget</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.603.1">Field widgets</span></strong><span class="koboSpan" id="kobo.604.1"> provide the </span><a id="_idIndexMarker458"/><span class="koboSpan" id="kobo.605.1">form component to a field in an entity form. </span><span class="koboSpan" id="kobo.605.2">These integrate with the Form API to define how a field can be edited and the way in which the data can be formatted before it is saved. </span><span class="koboSpan" id="kobo.605.3">Field widgets are chosen and customized through the form </span><span class="No-Break"><span class="koboSpan" id="kobo.606.1">display interface.</span></span></p>
<p><span class="koboSpan" id="kobo.607.1">In this recipe, we will create a widget for the field created in the </span><em class="italic"><span class="koboSpan" id="kobo.608.1">Creating a custom field type</span></em><span class="koboSpan" id="kobo.609.1"> recipe in this chapter. </span><span class="koboSpan" id="kobo.609.2">The field widget will provide two text fields for entering the first and last </span><span class="No-Break"><span class="koboSpan" id="kobo.610.1">name items.</span></span></p>
<h2 id="_idParaDest-249"><a id="_idTextAnchor278"/><span class="koboSpan" id="kobo.611.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.612.1">This recipe provides a field widget for the field type created in the previous recipe, </span><em class="italic"><span class="koboSpan" id="kobo.613.1">Creating a custom </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.614.1">field type</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.615.1">.</span></span></p>
<h2 id="_idParaDest-250"><a id="_idTextAnchor279"/><span class="koboSpan" id="kobo.616.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.617.1">First, we need </span><a id="_idIndexMarker459"/><span class="koboSpan" id="kobo.618.1">to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.619.1">src/Plugin/Field/FieldWidget</span></strong><span class="koboSpan" id="kobo.620.1"> directory in the module’s directory. </span><span class="koboSpan" id="kobo.620.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.621.1">Field</span></strong><span class="koboSpan" id="kobo.622.1"> module discovers field widgets in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.623.1">Plugin\Field\FieldWidget</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.624.1"> namespace:</span></span><pre class="console"><span class="koboSpan" id="kobo.625.1">
mkdir -p src/Plugin/Field/FieldWidget</span></pre></li>
<li><span class="koboSpan" id="kobo.626.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.627.1">RealNameDefaultWidget.php</span></strong><span class="koboSpan" id="kobo.628.1"> file in the newly created directory so that we can define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.629.1">RealNameDefaultWidget</span></strong><span class="koboSpan" id="kobo.630.1"> class. </span><span class="koboSpan" id="kobo.630.2">This will provide a custom form element to edit the first and last name values of </span><span class="No-Break"><span class="koboSpan" id="kobo.631.1">our field.</span></span></li>
<li><span class="koboSpan" id="kobo.632.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.633.1">RealNameDefaultWidget</span></strong><span class="koboSpan" id="kobo.634.1"> class will extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.635.1">\</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.636.1">Drupal\Core\Field\WidgetBase</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.637.1"> class:</span></span><pre class="console"><span class="koboSpan" id="kobo.638.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.639.1">
namespace Drupal\mymodule\Plugin\Field\FieldWidget;</span></pre><pre class="console"><span class="koboSpan" id="kobo.640.1">
use Drupal\Core\Field\FieldItemListInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.641.1">
use Drupal\Core\Field\WidgetBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.642.1">
use Drupal\Core\Form\FormStateInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.643.1">
class RealNameDefaultWidget extends WidgetBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.644.1">
}</span></pre></li>
<li><span class="koboSpan" id="kobo.645.1">We will extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.646.1">WidgetBase</span></strong><span class="koboSpan" id="kobo.647.1"> class, which satisfies methods defined by inherited interfaces for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.648.1">FieldWidget</span></strong><span class="koboSpan" id="kobo.649.1"> plugin type, except the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">formElement</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.651.1"> method.</span></span></li>
<li><span class="koboSpan" id="kobo.652.1">We will </span><a id="_idIndexMarker460"/><span class="koboSpan" id="kobo.653.1">provide the field widget’s identifier, label, and supported field types in the </span><span class="No-Break"><span class="koboSpan" id="kobo.654.1">plugin’s annotation:</span></span><pre class="console"><span class="koboSpan" id="kobo.655.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.656.1">
namespace Drupal\mymodule\Plugin\Field\FieldWidget;</span></pre><pre class="console"><span class="koboSpan" id="kobo.657.1">
use Drupal\Core\Field\FieldItemListInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.658.1">
use Drupal\Core\Field\WidgetBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.659.1">
use Drupal\Core\Form\FormStateInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.660.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.661.1">
 * Plugin implementation of the 'realname_default'</span></pre><pre class="console"><span class="koboSpan" id="kobo.662.1">
    widget.</span></pre><pre class="console"><span class="koboSpan" id="kobo.663.1">
 *</span></pre><pre class="console"><span class="koboSpan" id="kobo.664.1">
 * @FieldWidget(</span></pre><pre class="console"><span class="koboSpan" id="kobo.665.1">
 *   id = "realname_default",</span></pre><pre class="console"><span class="koboSpan" id="kobo.666.1">
 *   label = @Translation("Real name"),</span></pre><pre class="console"><span class="koboSpan" id="kobo.667.1">
 *   field_types = {</span></pre><pre class="console"><span class="koboSpan" id="kobo.668.1">
 *     "realname"</span></pre><pre class="console"><span class="koboSpan" id="kobo.669.1">
 *   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.670.1">
 * )</span></pre><pre class="console"><span class="koboSpan" id="kobo.671.1">
 */</span></pre><pre class="console"><span class="koboSpan" id="kobo.672.1">
class RealNameDefaultWidget extends WidgetBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.673.1">
}</span></pre></li>
</ol>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.674.1">@FieldWidget</span></strong><span class="koboSpan" id="kobo.675.1"> tells Drupal that this is a field widget plugin. </span><span class="koboSpan" id="kobo.675.2">It defines </span><strong class="source-inline"><span class="koboSpan" id="kobo.676.1">id</span></strong><span class="koboSpan" id="kobo.677.1"> to represent the machine name, the human-readable name as </span><strong class="source-inline"><span class="koboSpan" id="kobo.678.1">label</span></strong><span class="koboSpan" id="kobo.679.1">, and the field types that the widget interacts with as the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.680.1">field_types</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.681.1"> property.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.682.1">We need </span><a id="_idIndexMarker461"/><span class="koboSpan" id="kobo.683.1">to implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.684.1">formElement</span></strong><span class="koboSpan" id="kobo.685.1"> method to satisfy the remaining interface methods after extending </span><strong class="source-inline"><span class="koboSpan" id="kobo.686.1">\Drupal\Core\Field\WidgetBase</span></strong><span class="koboSpan" id="kobo.687.1">. </span><span class="koboSpan" id="kobo.687.2">Add the following method to </span><span class="No-Break"><span class="koboSpan" id="kobo.688.1">your class:</span></span><pre class="console"><span class="koboSpan" id="kobo.689.1">
  /**</span></pre><pre class="console"><span class="koboSpan" id="kobo.690.1">
   * {@inheritdoc}</span></pre><pre class="console"><span class="koboSpan" id="kobo.691.1">
   */</span></pre><pre class="console"><span class="koboSpan" id="kobo.692.1">
  public function formElement(</span></pre><pre class="console"><span class="koboSpan" id="kobo.693.1">
    FieldItemListInterface $items,</span></pre><pre class="console"><span class="koboSpan" id="kobo.694.1">
    $delta,</span></pre><pre class="console"><span class="koboSpan" id="kobo.695.1">
    array $element,</span></pre><pre class="console"><span class="koboSpan" id="kobo.696.1">
    array &amp;$form,</span></pre><pre class="console"><span class="koboSpan" id="kobo.697.1">
    FormStateInterface $form_state</span></pre><pre class="console"><span class="koboSpan" id="kobo.698.1">
  ) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.699.1">
    $element['first_name'] = [</span></pre><pre class="console"><span class="koboSpan" id="kobo.700.1">
      '#type' =&gt; 'textfield',</span></pre><pre class="console"><span class="koboSpan" id="kobo.701.1">
      '#title' =&gt; t('First name'),</span></pre><pre class="console"><span class="koboSpan" id="kobo.702.1">
      '#default_value' =&gt; '',</span></pre><pre class="console"><span class="koboSpan" id="kobo.703.1">
      '#size' =&gt; 25,</span></pre><pre class="console"><span class="koboSpan" id="kobo.704.1">
      '#required' =&gt; $element['#required'],</span></pre><pre class="console"><span class="koboSpan" id="kobo.705.1">
    ];</span></pre><pre class="console"><span class="koboSpan" id="kobo.706.1">
    $element['last_name'] = [</span></pre><pre class="console"><span class="koboSpan" id="kobo.707.1">
      '#type' =&gt; 'textfield',</span></pre><pre class="console"><span class="koboSpan" id="kobo.708.1">
      '#title' =&gt; t('Last name'),</span></pre><pre class="console"><span class="koboSpan" id="kobo.709.1">
      '#default_value' =&gt; '',</span></pre><pre class="console"><span class="koboSpan" id="kobo.710.1">
      '#size' =&gt; 25,</span></pre><pre class="console"><span class="koboSpan" id="kobo.711.1">
      '#required' =&gt; $element['#required'],</span></pre><pre class="console"><span class="koboSpan" id="kobo.712.1">
    ];</span></pre><pre class="console"><span class="koboSpan" id="kobo.713.1">
    return $element;</span></pre><pre class="console"><span class="koboSpan" id="kobo.714.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.715.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.716.1">formElement</span></strong><span class="koboSpan" id="kobo.717.1"> method </span><a id="_idIndexMarker462"/><span class="koboSpan" id="kobo.718.1">returns the Form API array structure, which should be added to an entity form for each field item. </span><span class="koboSpan" id="kobo.718.2">The names of </span><a id="_idIndexMarker463"/><span class="koboSpan" id="kobo.719.1">the element items – </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">first_name</span></strong><span class="koboSpan" id="kobo.721.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.722.1">last_name</span></strong><span class="koboSpan" id="kobo.723.1"> – map to the field property names so that they are </span><span class="No-Break"><span class="koboSpan" id="kobo.724.1">saved correctly.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.725.1">Next, we will need to modify our original </span><strong class="source-inline"><span class="koboSpan" id="kobo.726.1">RealName</span></strong><span class="koboSpan" id="kobo.727.1"> field type plugin class to use the default widget that we created. </span><span class="koboSpan" id="kobo.727.2">Modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.728.1">src/Plugin/FieldType/RealName.php</span></strong><span class="koboSpan" id="kobo.729.1"> file, and update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.730.1">default_widget</span></strong><span class="koboSpan" id="kobo.731.1"> annotation property </span><span class="No-Break"><span class="koboSpan" id="kobo.732.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.733.1">realname_default</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.734.1">:</span></span><pre class="console"><span class="koboSpan" id="kobo.735.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.736.1">
 * Plugin implementation of the 'realname' field type.</span></pre><pre class="console"><span class="koboSpan" id="kobo.737.1">
 *</span></pre><pre class="console"><span class="koboSpan" id="kobo.738.1">
 * @FieldType(</span></pre><pre class="console"><span class="koboSpan" id="kobo.739.1">
 *   id = "realname",</span></pre><pre class="console"><span class="koboSpan" id="kobo.740.1">
 *   label = @Translation("Real name"),</span></pre><pre class="console"><span class="koboSpan" id="kobo.741.1">
 *   description = @Translation("This field stores a</span></pre><pre class="console"><span class="koboSpan" id="kobo.742.1">
        first and last name."),</span></pre><pre class="console"><span class="koboSpan" id="kobo.743.1">
 *   category = @Translation("General"),</span></pre><pre class="console"><span class="koboSpan" id="kobo.744.1">
 *   default_widget = "realname_default",</span></pre><pre class="console"><span class="koboSpan" id="kobo.745.1">
 *   default_formatter = "string"</span></pre><pre class="console"><span class="koboSpan" id="kobo.746.1">
 * )</span></pre><pre class="console"><span class="koboSpan" id="kobo.747.1">
 */</span></pre><pre class="console"><span class="koboSpan" id="kobo.748.1">
class RealName extends FieldItemBase {</span></pre></li>
<li><span class="koboSpan" id="kobo.749.1">Rebuild your </span><a id="_idIndexMarker464"/><span class="koboSpan" id="kobo.750.1">Drupal site’s cache to update the field type definition and discovery of the new field </span><span class="No-Break"><span class="koboSpan" id="kobo.751.1">widget plugin:</span></span><pre class="console"><span class="koboSpan" id="kobo.752.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.753.1">The field added to </span><strong class="bold"><span class="koboSpan" id="kobo.754.1">Comment type</span></strong><span class="koboSpan" id="kobo.755.1"> will now use the </span><span class="No-Break"><span class="koboSpan" id="kobo.756.1">field widget:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer052">
<span class="koboSpan" id="kobo.757.1"><img alt="Figure 8.4 – Real name widget on a comment form" src="image/Figure_8.04_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.758.1">Figure 8.4 – Real name widget on a comment form</span></p>
<h2 id="_idParaDest-251"><a id="_idTextAnchor280"/><span class="koboSpan" id="kobo.759.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.760.1">The plugin manager for field types is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.761.1">plugin.manager.field.widget</span></strong><span class="koboSpan" id="kobo.762.1"> service. </span><span class="koboSpan" id="kobo.762.2">This plugin manager defines that field type plugins must be in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.763.1">Plugin\Field\FieldWidget</span></strong><span class="koboSpan" id="kobo.764.1"> namespace and </span><span class="No-Break"><span class="koboSpan" id="kobo.765.1">implement </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.766.1">\Drupal\Core\Field\WidgetInterface</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.767.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.768.1">The entity </span><a id="_idIndexMarker465"/><span class="koboSpan" id="kobo.769.1">form display system uses the plugin manager to load field definitions as options on the form display configuration form. </span><span class="koboSpan" id="kobo.769.2">When the entity form is built using the form display configuration, the form-building process adds the element returned from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.770.1">formElement</span></strong><span class="koboSpan" id="kobo.771.1"> method to the </span><span class="No-Break"><span class="koboSpan" id="kobo.772.1">entity form.</span></span></p>
<h2 id="_idParaDest-252"><a id="_idTextAnchor281"/><span class="koboSpan" id="kobo.773.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.774.1">Field widgets have additional methods to provide more information; they are covered in the </span><span class="No-Break"><span class="koboSpan" id="kobo.775.1">next section.</span></span></p>
<h3><span class="koboSpan" id="kobo.776.1">Field widget settings and summary</span></h3>
<p><span class="koboSpan" id="kobo.777.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.778.1">\Drupal\Core\Field\WidgetInterface</span></strong><span class="koboSpan" id="kobo.779.1"> interface defines three methods that can </span><a id="_idIndexMarker466"/><span class="koboSpan" id="kobo.780.1">be overridden to provide a settings form and a summary </span><a id="_idIndexMarker467"/><span class="koboSpan" id="kobo.781.1">of the </span><span class="No-Break"><span class="koboSpan" id="kobo.782.1">current settings:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.783.1">defaultSettings</span></strong><span class="koboSpan" id="kobo.784.1">: This returns an array of the setting keys and </span><span class="No-Break"><span class="koboSpan" id="kobo.785.1">default values</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.786.1">settingsForm</span></strong><span class="koboSpan" id="kobo.787.1">: This returns a Form API array that is used for the </span><span class="No-Break"><span class="koboSpan" id="kobo.788.1">settings form</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.789.1">settingsSummary</span></strong><span class="koboSpan" id="kobo.790.1">: This allows an array of strings to be returned and displayed on the manage display form for </span><span class="No-Break"><span class="koboSpan" id="kobo.791.1">the field</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.792.1">Widget settings can be used to alter the form presented to the user. </span><span class="koboSpan" id="kobo.792.2">A setting can be created that allows the field element to be limited to only entering the first or last name with one </span><span class="No-Break"><span class="koboSpan" id="kobo.793.1">text field.</span></span></p>
<h1 id="_idParaDest-253"><a id="_idTextAnchor282"/><span class="koboSpan" id="kobo.794.1">Creating a custom field formatter</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.795.1">Field formatters</span></strong><span class="koboSpan" id="kobo.796.1"> define the way in which a field type will be presented. </span><span class="koboSpan" id="kobo.796.2">These formatters </span><a id="_idIndexMarker468"/><span class="koboSpan" id="kobo.797.1">return the render array information to be processed by the theming layer. </span><span class="koboSpan" id="kobo.797.2">Field formatters are configured on the display </span><span class="No-Break"><span class="koboSpan" id="kobo.798.1">mode interfaces.</span></span></p>
<p><span class="koboSpan" id="kobo.799.1">In this recipe, we will create a formatter for the field created in the </span><em class="italic"><span class="koboSpan" id="kobo.800.1">Creating a custom field type</span></em><span class="koboSpan" id="kobo.801.1"> recipe in this chapter. </span><span class="koboSpan" id="kobo.801.2">The field formatter will display the first and last name values inline, as a </span><span class="No-Break"><span class="koboSpan" id="kobo.802.1">full name.</span></span></p>
<h2 id="_idParaDest-254"><a id="_idTextAnchor283"/><span class="koboSpan" id="kobo.803.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.804.1">This recipe provides a field formatter for the field type created in the previous recipe, </span><em class="italic"><span class="koboSpan" id="kobo.805.1">Creating a custom </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.806.1">field type</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.807.1">.</span></span></p>
<h2 id="_idParaDest-255"><a id="_idTextAnchor284"/><span class="koboSpan" id="kobo.808.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.809.1">First, we need to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.810.1">src/Plugin/Field/FieldFormatter</span></strong><span class="koboSpan" id="kobo.811.1"> directory in the module’s directory. </span><span class="koboSpan" id="kobo.811.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.812.1">Field</span></strong><span class="koboSpan" id="kobo.813.1"> module discovers field formatters in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.814.1">Plugin\Field\FieldFormatter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.815.1"> namespace</span></span><span class="No-Break"><span class="koboSpan" id="kobo.816.1">:</span></span><pre class="console"><span class="koboSpan" id="kobo.817.1">
mkdir -p src/Plugin/Field/FieldFormatter</span></pre></li>
<li><span class="koboSpan" id="kobo.818.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.819.1">RealNameFormatter.php</span></strong><span class="koboSpan" id="kobo.820.1"> file in the newly created directory so that we can define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.821.1">RealNameFormatter</span></strong><span class="koboSpan" id="kobo.822.1"> class. </span><span class="koboSpan" id="kobo.822.2">This will provide a custom formatter to display the </span><span class="No-Break"><span class="koboSpan" id="kobo.823.1">field’s values.</span></span></li>
<li><span class="koboSpan" id="kobo.824.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.825.1">RealNameFormatter</span></strong><span class="koboSpan" id="kobo.826.1"> class will extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.827.1">\</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.828.1">Drupal\Core\Field\FormatterBase</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.829.1"> class:</span></span><pre class="console"><span class="koboSpan" id="kobo.830.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.831.1">
namespace Drupal\mymodule\Plugin\Field\FieldFormatter;</span></pre><pre class="console"><span class="koboSpan" id="kobo.832.1">
use Drupal\Core\Field\FormatterBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.833.1">
use Drupal\Core\Field\FieldItemListInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.834.1">
class RealNameFormatter extends FormatterBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.835.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.836.1">We extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.837.1">FormatterBase</span></strong><span class="koboSpan" id="kobo.838.1"> class, which satisfies methods defined by inherited interfaces for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.839.1">FieldFormatter</span></strong><span class="koboSpan" id="kobo.840.1"> plugin type, except the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.841.1">viewElements</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.842.1"> method.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.843.1">We will </span><a id="_idIndexMarker469"/><span class="koboSpan" id="kobo.844.1">provide the field widget’s identifier, label, and supported field types in the </span><span class="No-Break"><span class="koboSpan" id="kobo.845.1">plugin’s annotation:</span></span><pre class="console"><span class="koboSpan" id="kobo.846.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.847.1">
namespace Drupal\mymodule\Plugin\Field\FieldFormatter;</span></pre><pre class="console"><span class="koboSpan" id="kobo.848.1">
use Drupal\Core\Field\FormatterBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.849.1">
use Drupal\Core\Field\FieldItemListInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.850.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.851.1">
 * Plugin implementation of the 'realname_one_line'</span></pre><pre class="console"><span class="koboSpan" id="kobo.852.1">
    formatter.</span></pre><pre class="console"><span class="koboSpan" id="kobo.853.1">
 *</span></pre><pre class="console"><span class="koboSpan" id="kobo.854.1">
 * @FieldFormatter(</span></pre><pre class="console"><span class="koboSpan" id="kobo.855.1">
 *   id = "realname_one_line",</span></pre><pre class="console"><span class="koboSpan" id="kobo.856.1">
 *   label = @Translation("Real name (one line)"),</span></pre><pre class="console"><span class="koboSpan" id="kobo.857.1">
 *   field_types = {</span></pre><pre class="console"><span class="koboSpan" id="kobo.858.1">
 *     "realname"</span></pre><pre class="console"><span class="koboSpan" id="kobo.859.1">
 *   }</span></pre><pre class="console"><span class="koboSpan" id="kobo.860.1">
 * )</span></pre><pre class="console"><span class="koboSpan" id="kobo.861.1">
 */</span></pre><pre class="console"><span class="koboSpan" id="kobo.862.1">
class RealNameFormatter extends FormatterBase {</span></pre><pre class="console"><span class="koboSpan" id="kobo.863.1">
}</span></pre></li>
</ol>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.864.1">@FieldFormatter</span></strong><span class="koboSpan" id="kobo.865.1"> tells Drupal that this is a field formatter plugin. </span><span class="koboSpan" id="kobo.865.2">It defines </span><strong class="source-inline"><span class="koboSpan" id="kobo.866.1">id</span></strong><span class="koboSpan" id="kobo.867.1"> to represent the machine name, the human-readable name as </span><strong class="source-inline"><span class="koboSpan" id="kobo.868.1">label</span></strong><span class="koboSpan" id="kobo.869.1">, and the field types that the formatter interacts with as the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.870.1">field_types</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.871.1"> property.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.872.1">We will </span><a id="_idIndexMarker470"/><span class="koboSpan" id="kobo.873.1">need to implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.874.1">viewElements</span></strong><span class="koboSpan" id="kobo.875.1"> method to satisfy the </span><strong class="source-inline"><span class="koboSpan" id="kobo.876.1">\Drupal\Core\Field\FormatterInferface</span></strong><span class="koboSpan" id="kobo.877.1"> interface. </span><span class="koboSpan" id="kobo.877.2">This is used to render the field data. </span><span class="koboSpan" id="kobo.877.3">Add the following method to </span><span class="No-Break"><span class="koboSpan" id="kobo.878.1">your class:</span></span><pre class="console"><span class="koboSpan" id="kobo.879.1">
  /**</span></pre><pre class="console"><span class="koboSpan" id="kobo.880.1">
   * {@inheritdoc}</span></pre><pre class="console"><span class="koboSpan" id="kobo.881.1">
   */</span></pre><pre class="console"><span class="koboSpan" id="kobo.882.1">
  public function viewElements(</span></pre><pre class="console"><span class="koboSpan" id="kobo.883.1">
    FieldItemListInterface $items,</span></pre><pre class="console"><span class="koboSpan" id="kobo.884.1">
    $langcode</span></pre><pre class="console"><span class="koboSpan" id="kobo.885.1">
  ) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.886.1">
    $element = [];</span></pre><pre class="console"><span class="koboSpan" id="kobo.887.1">
    foreach ($items as $delta =&gt; $item) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.888.1">
      $element[$delta] = [</span></pre><pre class="console"><span class="koboSpan" id="kobo.889.1">
        '#markup' =&gt; $this-&gt;t('@first @last', [</span></pre><pre class="console"><span class="koboSpan" id="kobo.890.1">
          '@first' =&gt; $item-&gt;first_name,</span></pre><pre class="console"><span class="koboSpan" id="kobo.891.1">
          '@last' =&gt; $item-&gt;last_name,</span></pre><pre class="console"><span class="koboSpan" id="kobo.892.1">
        ]),</span></pre><pre class="console"><span class="koboSpan" id="kobo.893.1">
      ];</span></pre><pre class="console"><span class="koboSpan" id="kobo.894.1">
    }</span></pre><pre class="console"><span class="koboSpan" id="kobo.895.1">
    return $element;</span></pre><pre class="console"><span class="koboSpan" id="kobo.896.1">
  }</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.897.1">The field values are provided to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.898.1">viewElements</span></strong><span class="koboSpan" id="kobo.899.1"> method as a </span><strong class="source-inline"><span class="koboSpan" id="kobo.900.1">FieldItemListInterface</span></strong><span class="koboSpan" id="kobo.901.1"> iterable that contains each field item. </span><span class="koboSpan" id="kobo.901.2">Fields in Drupal can contain a single value, or an unlimited number of values. </span><span class="koboSpan" id="kobo.901.3">We iterate over each value and create a templated string that displays the first name and last name values in one line as a </span><span class="No-Break"><span class="koboSpan" id="kobo.902.1">full name.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.903.1">Next, we will </span><a id="_idIndexMarker471"/><span class="koboSpan" id="kobo.904.1">need to modify our original </span><strong class="source-inline"><span class="koboSpan" id="kobo.905.1">RealName</span></strong><span class="koboSpan" id="kobo.906.1"> field type’s plugin class to use the default formatter that we created. </span><span class="koboSpan" id="kobo.906.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.907.1">src/Plugin/FieldType/RealName.php</span></strong><span class="koboSpan" id="kobo.908.1"> file, and update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.909.1">default_formatter</span></strong><span class="koboSpan" id="kobo.910.1"> annotation property </span><span class="No-Break"><span class="koboSpan" id="kobo.911.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.912.1">realname_one_line</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.913.1">:</span></span><pre class="console"><span class="koboSpan" id="kobo.914.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.915.1">
 * Plugin implementation of the 'realname' field type.</span></pre><pre class="console"><span class="koboSpan" id="kobo.916.1">
 *</span></pre><pre class="console"><span class="koboSpan" id="kobo.917.1">
 * @FieldType(</span></pre><pre class="console"><span class="koboSpan" id="kobo.918.1">
 *   id = "realname",</span></pre><pre class="console"><span class="koboSpan" id="kobo.919.1">
 *   label = @Translation("Real name"),</span></pre><pre class="console"><span class="koboSpan" id="kobo.920.1">
 *   description = @Translation("This field stores a</span></pre><pre class="console"><span class="koboSpan" id="kobo.921.1">
        first and last name."),</span></pre><pre class="console"><span class="koboSpan" id="kobo.922.1">
 *   category = @Translation("General"),</span></pre><pre class="console"><span class="koboSpan" id="kobo.923.1">
 *   default_widget = "realname_default",</span></pre><pre class="console"><span class="koboSpan" id="kobo.924.1">
 *   default_formatter = "realname_one_line"</span></pre><pre class="console"><span class="koboSpan" id="kobo.925.1">
 * )</span></pre><pre class="console"><span class="koboSpan" id="kobo.926.1">
 */</span></pre><pre class="console"><span class="koboSpan" id="kobo.927.1">
class RealName extends FieldItemBase {</span></pre></li>
<li><span class="koboSpan" id="kobo.928.1">Rebuild your Drupal site’s cache to update the field type definition and discovery of the new field </span><span class="No-Break"><span class="koboSpan" id="kobo.929.1">formatter plugin:</span></span><pre class="console"><span class="koboSpan" id="kobo.930.1">
php vendor/bin/drush cr</span></pre></li>
<li><span class="koboSpan" id="kobo.931.1">The field </span><a id="_idIndexMarker472"/><span class="koboSpan" id="kobo.932.1">added to </span><strong class="bold"><span class="koboSpan" id="kobo.933.1">Comment type</span></strong><span class="koboSpan" id="kobo.934.1"> will now use the </span><span class="No-Break"><span class="koboSpan" id="kobo.935.1">field formatter:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer053">
<span class="koboSpan" id="kobo.936.1"><img alt="Figure 8.5 – Output of the real name formatter" src="image/Figure_8.05_B18548.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.937.1">Figure 8.5 – Output of the real name formatter</span></p>
<h2 id="_idParaDest-256"><a id="_idTextAnchor285"/><span class="koboSpan" id="kobo.938.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.939.1">The plugin manager for field types is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.940.1">plugin.manager.field.formatter</span></strong><span class="koboSpan" id="kobo.941.1"> service. </span><span class="koboSpan" id="kobo.941.2">This plugin manager defines that field type plugins must be in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.942.1">Plugin\Field\FieldFormatter</span></strong><span class="koboSpan" id="kobo.943.1"> namespace and </span><span class="No-Break"><span class="koboSpan" id="kobo.944.1">implement </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.945.1">\Drupal\Core\Field\FormatterInterface</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.946.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.947.1">The entity view display system uses the plugin manager to load field definitions as options on the view display configuration form. </span><span class="koboSpan" id="kobo.947.2">When the entity is built using the view display configuration, the process iterates through each field on the entity and invokes the configured formatter’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.948.1">viewElements</span></strong><span class="koboSpan" id="kobo.949.1"> method. </span><span class="koboSpan" id="kobo.949.2">The final result is used to render the display of </span><span class="No-Break"><span class="koboSpan" id="kobo.950.1">the entity.</span></span></p>
<h2 id="_idParaDest-257"><a id="_idTextAnchor286"/><span class="koboSpan" id="kobo.951.1">There’s more...</span></h2>
<p><span class="koboSpan" id="kobo.952.1">Field formatters </span><a id="_idIndexMarker473"/><span class="koboSpan" id="kobo.953.1">have additional methods to provide more information; they are covered in the </span><span class="No-Break"><span class="koboSpan" id="kobo.954.1">next section.</span></span></p>
<h3><span class="koboSpan" id="kobo.955.1">Formatter settings and summary</span></h3>
<p><span class="koboSpan" id="kobo.956.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.957.1">\Drupal\Core\Field\FormatterInterface</span></strong><span class="koboSpan" id="kobo.958.1"> interface defines three methods </span><a id="_idIndexMarker474"/><span class="koboSpan" id="kobo.959.1">that can be overridden to provide a settings form </span><a id="_idIndexMarker475"/><span class="koboSpan" id="kobo.960.1">and a summary of the </span><span class="No-Break"><span class="koboSpan" id="kobo.961.1">current settings:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.962.1">defaultSettings</span></strong><span class="koboSpan" id="kobo.963.1">: This returns an array of the setting keys and </span><span class="No-Break"><span class="koboSpan" id="kobo.964.1">default values</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.965.1">settingsForm</span></strong><span class="koboSpan" id="kobo.966.1">: This returns a Form API array that is used for the </span><span class="No-Break"><span class="koboSpan" id="kobo.967.1">settings form</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.968.1">settingsSummary</span></strong><span class="koboSpan" id="kobo.969.1">: This allows an array of strings to be returned and displayed on the manage display form for </span><span class="No-Break"><span class="koboSpan" id="kobo.970.1">the field</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.971.1">Settings can be used to alter how the formatter displays information. </span><span class="koboSpan" id="kobo.971.2">For example, these methods can be implemented to provide settings to hide or display the first or </span><span class="No-Break"><span class="koboSpan" id="kobo.972.1">last name.</span></span></p>
<h1 id="_idParaDest-258"><a id="_idTextAnchor287"/><span class="koboSpan" id="kobo.973.1">Creating a custom plugin type</span></h1>
<p><span class="koboSpan" id="kobo.974.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.975.1">plugin system</span></strong><span class="koboSpan" id="kobo.976.1"> provides </span><a id="_idIndexMarker476"/><span class="koboSpan" id="kobo.977.1">a means to create specialized objects in Drupal that do not require the data storage features of the entity system. </span><span class="koboSpan" id="kobo.977.2">As we have seen with the block and </span><a id="_idIndexMarker477"/><span class="koboSpan" id="kobo.978.1">field plugins, each plugin type serves a specific purpose and allows </span><span class="No-Break"><span class="koboSpan" id="kobo.979.1">for extensibility.</span></span></p>
<p><span class="koboSpan" id="kobo.980.1">In this recipe, we will create a </span><a id="_idIndexMarker478"/><span class="koboSpan" id="kobo.981.1">new plugin type called </span><strong class="source-inline"><span class="koboSpan" id="kobo.982.1">GeoLocator</span></strong><span class="koboSpan" id="kobo.983.1">, which will return the country code for a given IP address. </span><span class="koboSpan" id="kobo.983.2">We will create a plugin manager, a </span><a id="_idIndexMarker479"/><span class="koboSpan" id="kobo.984.1">default plugin interface, a plugin annotation definition, and plugin implementations. </span><span class="koboSpan" id="kobo.984.2">A </span><strong class="bold"><span class="koboSpan" id="kobo.985.1">Content Delivery Network</span></strong><span class="koboSpan" id="kobo.986.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.987.1">CDN</span></strong><span class="koboSpan" id="kobo.988.1">) commonly provides HTTP headers with the visitor’s country code. </span><span class="koboSpan" id="kobo.988.2">We will provide plugins for </span><strong class="bold"><span class="koboSpan" id="kobo.989.1">Cloudflare</span></strong><span class="koboSpan" id="kobo.990.1"> and </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.991.1">AWS CloudFront</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.992.1">.</span></span></p>
<h2 id="_idParaDest-259"><a id="_idTextAnchor288"/><span class="koboSpan" id="kobo.993.1">How to do it…</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.994.1">All plugins </span><a id="_idIndexMarker480"/><span class="koboSpan" id="kobo.995.1">need to have a service that acts as a plugin manager. </span><span class="koboSpan" id="kobo.995.2">Create a file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.996.1">src</span></strong><span class="koboSpan" id="kobo.997.1"> directory of your module called </span><strong class="source-inline"><span class="koboSpan" id="kobo.998.1">GeoLocatorManager.php</span></strong><span class="koboSpan" id="kobo.999.1">. </span><span class="koboSpan" id="kobo.999.2">This will hold the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1000.1">GeoLocatorManager</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1001.1"> class.</span></span></li>
<li><span class="koboSpan" id="kobo.1002.1">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1003.1">GeoLocatorManager</span></strong><span class="koboSpan" id="kobo.1004.1"> class by extending the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1005.1">\Drupal\Core\Plugin\DefaultPluginManager</span></strong><span class="koboSpan" id="kobo.1006.1"> class provided by </span><span class="No-Break"><span class="koboSpan" id="kobo.1007.1">Drupal core:</span></span><pre class="console"><span class="koboSpan" id="kobo.1008.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.1009.1">
namespace Drupal\mymodule;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1010.1">
use Drupal\Core\Plugin\DefaultPluginManager;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1011.1">
use Drupal\Core\Cache\CacheBackendInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1012.1">
use Drupal\Core\Extension\ModuleHandlerInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1013.1">
class GeoLocatorManager extends DefaultPluginManager {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1014.1">
}</span></pre></li>
</ol>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1015.1">DefaultPluginManager</span></strong><span class="koboSpan" id="kobo.1016.1"> provides the essential functionality for a plugin manager, requiring implementors to only override </span><span class="No-Break"><span class="koboSpan" id="kobo.1017.1">its constructor.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1018.1">Next, we will need to override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1019.1">__construct</span></strong><span class="koboSpan" id="kobo.1020.1"> method from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1021.1">DefaultPluginManager</span></strong><span class="koboSpan" id="kobo.1022.1"> class to define information about our plugin type. </span><span class="koboSpan" id="kobo.1022.2">Note, it will reference code created in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1023.1">following steps:</span></span><pre class="console"><span class="koboSpan" id="kobo.1024.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.1025.1">
namespace Drupal\mymodule;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1026.1">
use Drupal\Core\Plugin\DefaultPluginManager;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1027.1">
use Drupal\Core\Cache\CacheBackendInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1028.1">
use Drupal\Core\Extension\ModuleHandlerInterface;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1029.1">
class GeoLocatorManager extends DefaultPluginManager {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1030.1">
  public function __construct(</span></pre><pre class="console"><span class="koboSpan" id="kobo.1031.1">
    \Traversable $namespaces,</span></pre><pre class="console"><span class="koboSpan" id="kobo.1032.1">
    CacheBackendInterface $cache_backend,</span></pre><pre class="console"><span class="koboSpan" id="kobo.1033.1">
    ModuleHandlerInterface</span></pre><pre class="console"><span class="koboSpan" id="kobo.1034.1">
    $module_handler</span></pre><pre class="console"><span class="koboSpan" id="kobo.1035.1">
  ) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1036.1">
    parent::__construct(</span></pre><pre class="console"><span class="koboSpan" id="kobo.1037.1">
      'Plugin/GeoLocator',</span></pre><pre class="console"><span class="koboSpan" id="kobo.1038.1">
      $namespaces,</span></pre><pre class="console"><span class="koboSpan" id="kobo.1039.1">
      $module_handler,</span></pre><pre class="console"><span class="koboSpan" id="kobo.1040.1">
      'Drupal\mymodule\Plugin\GeoLocator</span></pre><pre class="console"><span class="koboSpan" id="kobo.1041.1">
        \GeoLocatorInterface',</span></pre><pre class="console"><span class="koboSpan" id="kobo.1042.1">
      'Drupal\mymodule\Annotation\GeoLocator'</span></pre><pre class="console"><span class="koboSpan" id="kobo.1043.1">
    );</span></pre><pre class="console"><span class="koboSpan" id="kobo.1044.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.1045.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1046.1">The first argument to the parent construct call of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1047.1">Plugin/GeoLocator</span></strong><span class="koboSpan" id="kobo.1048.1"> specifies that the namespace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1049.1">GeoLocator</span></strong><span class="koboSpan" id="kobo.1050.1"> plugins must reside in a module. </span><span class="koboSpan" id="kobo.1050.2">The fourth argument, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1051.1">Drupal\mymodule\Plugin\GeoLocator\GeoLocatorInterface</span></strong><span class="koboSpan" id="kobo.1052.1">, identifies the interface that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1053.1">GeoLocator</span></strong><span class="koboSpan" id="kobo.1054.1"> plugins must implement. </span><span class="koboSpan" id="kobo.1054.2">The fifth argument, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1055.1">Drupal\mymodule\Annotation\GeoLocator</span></strong><span class="koboSpan" id="kobo.1056.1">, specifies the annotation class, so that plugins may register themselves with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1057.1">@</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1058.1">GeoLocator</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1059.1"> annotations.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1060.1">Before we </span><a id="_idIndexMarker481"/><span class="koboSpan" id="kobo.1061.1">create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1062.1">GeoLocator</span></strong><span class="koboSpan" id="kobo.1063.1"> plugin interface and annotation, we will create the service definition to register our plugin manager. </span><span class="koboSpan" id="kobo.1063.2">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1064.1">mymodule.services.yml</span></strong><span class="koboSpan" id="kobo.1065.1"> file and add </span><span class="No-Break"><span class="koboSpan" id="kobo.1066.1">the following:</span></span><pre class="console"><span class="koboSpan" id="kobo.1067.1">
services:</span></pre><pre class="console"><span class="koboSpan" id="kobo.1068.1">
  plugin.manager.geolocator:</span></pre><pre class="console"><span class="koboSpan" id="kobo.1069.1">
    class: Drupal\mymodule\GeoLocatorManager</span></pre><pre class="console"><span class="koboSpan" id="kobo.1070.1">
    parent: default_plugin_manager</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1071.1">While not required, it is a pattern to name plugin manager services with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1072.1">plugin.manager.</span></strong><span class="koboSpan" id="kobo.1073.1"> and then the plugin type name. </span><span class="koboSpan" id="kobo.1073.2">We can use the parent definition to tell the service container to use the same arguments as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1074.1">default_plugin_manager</span></strong><span class="koboSpan" id="kobo.1075.1"> definition when constructing </span><span class="No-Break"><span class="koboSpan" id="kobo.1076.1">our class.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1077.1">All annotation-based plugins must provide an annotation class. </span><span class="koboSpan" id="kobo.1077.2">Create </span><strong class="source-inline"><span class="koboSpan" id="kobo.1078.1">GeoLocator.php</span></strong><span class="koboSpan" id="kobo.1079.1"> in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1080.1">src/Annotation</span></strong><span class="koboSpan" id="kobo.1081.1"> to provide the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1082.1">GeoLocator</span></strong><span class="koboSpan" id="kobo.1083.1"> annotation class, as we specified in our </span><span class="No-Break"><span class="koboSpan" id="kobo.1084.1">plugin manager:</span></span><pre class="console"><span class="koboSpan" id="kobo.1085.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.1086.1">
namespace Drupal\mymodule\Annotation;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1087.1">
use Drupal\Component\Annotation\Plugin;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1088.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.1089.1">
 * @Annotation</span></pre><pre class="console"><span class="koboSpan" id="kobo.1090.1">
 */</span></pre><pre class="console"><span class="koboSpan" id="kobo.1091.1">
class GeoLocator extends Plugin</span></pre><pre class="console"><span class="koboSpan" id="kobo.1092.1">
{</span></pre><pre class="console"><span class="koboSpan" id="kobo.1093.1">
  /**</span></pre><pre class="console"><span class="koboSpan" id="kobo.1094.1">
   * The human-readable name.</span></pre><pre class="console"><span class="koboSpan" id="kobo.1095.1">
   *</span></pre><pre class="console"><span class="koboSpan" id="kobo.1096.1">
   * @var \Drupal\Core\Annotation\Translation</span></pre><pre class="console"><span class="koboSpan" id="kobo.1097.1">
   *</span></pre><pre class="console"><span class="koboSpan" id="kobo.1098.1">
   * @ingroup plugin_translatable</span></pre><pre class="console"><span class="koboSpan" id="kobo.1099.1">
   */</span></pre><pre class="console"><span class="koboSpan" id="kobo.1100.1">
  public $label;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1101.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1102.1">Each property is an item that can be defined in the plugin’s annotation. </span><span class="koboSpan" id="kobo.1102.2">The annotated definition will be </span><strong class="source-inline"><span class="koboSpan" id="kobo.1103.1">@GeoLocator</span></strong><span class="koboSpan" id="kobo.1104.1"> for our plugins, as the annotation’s class name </span><span class="No-Break"><span class="koboSpan" id="kobo.1105.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1106.1">GeoLocator</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1107.1">.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1108.1">Next, we will </span><a id="_idIndexMarker482"/><span class="koboSpan" id="kobo.1109.1">define the plugin interface that we defined in the plugin manager. </span><span class="koboSpan" id="kobo.1109.2">The discovery process for plugins validates that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1110.1">GeoLocator</span></strong><span class="koboSpan" id="kobo.1111.1"> plugins implement this interface. </span><span class="koboSpan" id="kobo.1111.2">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1112.1">GeoLocatorInterface.php</span></strong><span class="koboSpan" id="kobo.1113.1"> file in our module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1114.1">src/Plugin/GeoLocator</span></strong><span class="koboSpan" id="kobo.1115.1"> directory to hold </span><span class="No-Break"><span class="koboSpan" id="kobo.1116.1">the interface:</span></span><pre class="console"><span class="koboSpan" id="kobo.1117.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.1118.1">
namespace Drupal\mymodule\Plugin\GeoLocator;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1119.1">
use Symfony\Component\HttpFoundation\Request;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1120.1">
interface GeoLocatorInterface {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1121.1">
  /**</span></pre><pre class="console"><span class="koboSpan" id="kobo.1122.1">
   * Get the plugin's label.</span></pre><pre class="console"><span class="koboSpan" id="kobo.1123.1">
   *</span></pre><pre class="console"><span class="koboSpan" id="kobo.1124.1">
   * @return string</span></pre><pre class="console"><span class="koboSpan" id="kobo.1125.1">
   *   The geolocator label</span></pre><pre class="console"><span class="koboSpan" id="kobo.1126.1">
   */</span></pre><pre class="console"><span class="koboSpan" id="kobo.1127.1">
  public function label();</span></pre><pre class="console"><span class="koboSpan" id="kobo.1128.1">
  /**</span></pre><pre class="console"><span class="koboSpan" id="kobo.1129.1">
   * Performs geolocation on an address.</span></pre><pre class="console"><span class="koboSpan" id="kobo.1130.1">
   *</span></pre><pre class="console"><span class="koboSpan" id="kobo.1131.1">
   * @param Request $request</span></pre><pre class="console"><span class="koboSpan" id="kobo.1132.1">
   *   The request.</span></pre><pre class="console"><span class="koboSpan" id="kobo.1133.1">
   *</span></pre><pre class="console"><span class="koboSpan" id="kobo.1134.1">
   * @return string|NULL</span></pre><pre class="console"><span class="koboSpan" id="kobo.1135.1">
   *   The geolocated country code, or NULL if not</span></pre><pre class="console"><span class="koboSpan" id="kobo.1136.1">
        found.</span></pre><pre class="console"><span class="koboSpan" id="kobo.1137.1">
   */</span></pre><pre class="console"><span class="koboSpan" id="kobo.1138.1">
  public function geolocate(Request $request):</span></pre><pre class="console"><span class="koboSpan" id="kobo.1139.1">
    ?string;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1140.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1141.1">We provide an interface so that we can guarantee that we have these expected methods when working with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1142.1">GeoLocator</span></strong><span class="koboSpan" id="kobo.1143.1"> plugin. </span><span class="koboSpan" id="kobo.1143.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1144.1">geolocate</span></strong><span class="koboSpan" id="kobo.1145.1"> method receives a request object and returns a country code, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1146.1">null</span></strong><span class="koboSpan" id="kobo.1147.1"> if one could not </span><span class="No-Break"><span class="koboSpan" id="kobo.1148.1">be found.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1149.1">Now that </span><a id="_idIndexMarker483"/><span class="koboSpan" id="kobo.1150.1">we have our plugin type set up, we will create our first plugin to support the Cloudflare country code header. </span><span class="koboSpan" id="kobo.1150.2">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1151.1">src/Plugin/GeoLocator/Cloudflare.php</span></strong><span class="koboSpan" id="kobo.1152.1"> file for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1153.1">Cloudflare</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1154.1">plugin class:</span></span><pre class="console"><span class="koboSpan" id="kobo.1155.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.1156.1">
namespace Drupal\mymodule\Plugin\GeoLocator;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1157.1">
use Drupal\Core\Plugin\PluginBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1158.1">
use Symfony\Component\HttpFoundation\Request;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1159.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.1160.1">
 * @GeoLocator(</span></pre><pre class="console"><span class="koboSpan" id="kobo.1161.1">
 *   id = "cloudflare",</span></pre><pre class="console"><span class="koboSpan" id="kobo.1162.1">
 *   label = "Cloudflare"</span></pre><pre class="console"><span class="koboSpan" id="kobo.1163.1">
 * )</span></pre><pre class="console"><span class="koboSpan" id="kobo.1164.1">
 */</span></pre><pre class="console"><span class="koboSpan" id="kobo.1165.1">
class Cloudflare extends PluginBase implements</span></pre><pre class="console"><span class="koboSpan" id="kobo.1166.1">
    GeoLocatorInterface {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1167.1">
  public function label() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1168.1">
    return $this-&gt;pluginDefinition['label'];</span></pre><pre class="console"><span class="koboSpan" id="kobo.1169.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.1170.1">
  public function geolocate(Request $request): ?string {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1171.1">
    return $request-&gt;headers-&gt;get('CF-IPCountry');</span></pre><pre class="console"><span class="koboSpan" id="kobo.1172.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.1173.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1174.1">Cloudflare </span><a id="_idIndexMarker484"/><span class="koboSpan" id="kobo.1175.1">provides the visitor’s country code in an HTTP header named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1176.1">CF-IPCountry</span></strong><span class="koboSpan" id="kobo.1177.1">. </span><span class="koboSpan" id="kobo.1177.2">This plugin returns the value from that header, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1178.1">null</span></strong><span class="koboSpan" id="kobo.1179.1"> if it </span><span class="No-Break"><span class="koboSpan" id="kobo.1180.1">is missing.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.1181.1">Next, we create a plugin for AWS CloudFront’s country code header. </span><span class="koboSpan" id="kobo.1181.2">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1182.1">src/Plugin/GeoLocator/CloudFront.php</span></strong><span class="koboSpan" id="kobo.1183.1"> file for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1184.1">CloudFront</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1185.1">plugin class:</span></span><pre class="console"><span class="koboSpan" id="kobo.1186.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.1187.1">
namespace Drupal\mymodule\Plugin\GeoLocator;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1188.1">
use Drupal\Core\Plugin\PluginBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1189.1">
use Symfony\Component\HttpFoundation\Request;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1190.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.1191.1">
 * @GeoLocator(</span></pre><pre class="console"><span class="koboSpan" id="kobo.1192.1">
 *   id = "cloudfront",</span></pre><pre class="console"><span class="koboSpan" id="kobo.1193.1">
 *   label = "CloudFront"</span></pre><pre class="console"><span class="koboSpan" id="kobo.1194.1">
 * )</span></pre><pre class="console"><span class="koboSpan" id="kobo.1195.1">
 */</span></pre><pre class="console"><span class="koboSpan" id="kobo.1196.1">
class CloudFront extends PluginBase implements</span></pre><pre class="console"><span class="koboSpan" id="kobo.1197.1">
    GeoLocatorInterface {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1198.1">
  public function label() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1199.1">
    return $this-&gt;pluginDefinition['label'];</span></pre><pre class="console"><span class="koboSpan" id="kobo.1200.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.1201.1">
  public function geolocate(Request $request): ?string {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1202.1">
    return $request-&gt;headers-&gt;get('CloudFront-Viewer-</span></pre><pre class="console"><span class="koboSpan" id="kobo.1203.1">
        Country');</span></pre><pre class="console"><span class="koboSpan" id="kobo.1204.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.1205.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1206.1">AWS CloudFront </span><a id="_idIndexMarker485"/><span class="koboSpan" id="kobo.1207.1">provides the visitor’s country code in an HTTP header named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1208.1">CloudFront-Viewer-Country</span></strong><span class="koboSpan" id="kobo.1209.1">. </span><span class="koboSpan" id="kobo.1209.2">This plugin returns the value from that header, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1210.1">null</span></strong><span class="koboSpan" id="kobo.1211.1"> if it </span><span class="No-Break"><span class="koboSpan" id="kobo.1212.1">is missing.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.1213.1">Finally, we will create a demonstration plugin that reads the country code from a query parameter. </span><span class="koboSpan" id="kobo.1213.2">Create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1214.1">src/Plugin/GeoLocator/RequestQuery.php</span></strong><span class="koboSpan" id="kobo.1215.1"> file for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1216.1">RequestQuery</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1217.1">plugin class:</span></span><pre class="console"><span class="koboSpan" id="kobo.1218.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.1219.1">
namespace Drupal\mymodule\Plugin\GeoLocator;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1220.1">
use Drupal\Core\Plugin\PluginBase;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1221.1">
use Symfony\Component\HttpFoundation\Request;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1222.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.1223.1">
 * @GeoLocator(</span></pre><pre class="console"><span class="koboSpan" id="kobo.1224.1">
 *   id = "request_query",</span></pre><pre class="console"><span class="koboSpan" id="kobo.1225.1">
 *   label = "Request query"</span></pre><pre class="console"><span class="koboSpan" id="kobo.1226.1">
 * )</span></pre><pre class="console"><span class="koboSpan" id="kobo.1227.1">
 */</span></pre><pre class="console"><span class="koboSpan" id="kobo.1228.1">
class RequestQuery extends PluginBase implements</span></pre><pre class="console"><span class="koboSpan" id="kobo.1229.1">
    GeoLocatorInterface {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1230.1">
  public function label() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1231.1">
    return $this-&gt;pluginDefinition['label'];</span></pre><pre class="console"><span class="koboSpan" id="kobo.1232.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.1233.1">
  public function geolocate(Request $request): ?string {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1234.1">
    return $request-&gt;query-&gt;get('countryCode');</span></pre><pre class="console"><span class="koboSpan" id="kobo.1235.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.1236.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1237.1">Unlike the </span><a id="_idIndexMarker486"/><span class="koboSpan" id="kobo.1238.1">other plugins, this plugin returns the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1239.1">countryCode</span></strong><span class="koboSpan" id="kobo.1240.1"> query parameter in </span><span class="No-Break"><span class="koboSpan" id="kobo.1241.1">a URL.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1242.1">The following is an example that will set a message of the country code, if one can be </span><a id="_idIndexMarker487"/><span class="koboSpan" id="kobo.1243.1">detected by a plugin, on </span><span class="No-Break"><span class="koboSpan" id="kobo.1244.1">each page:</span></span><pre class="console"><span class="koboSpan" id="kobo.1245.1">
&lt;?php</span></pre><pre class="console"><span class="koboSpan" id="kobo.1246.1">
/**</span></pre><pre class="console"><span class="koboSpan" id="kobo.1247.1">
 * Implements hook_page_top().</span></pre><pre class="console"><span class="koboSpan" id="kobo.1248.1">
 */</span></pre><pre class="console"><span class="koboSpan" id="kobo.1249.1">
function mymodule_page_top() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1250.1">
  $request = \Drupal::request();</span></pre><pre class="console"><span class="koboSpan" id="kobo.1251.1">
  /** @var \Drupal\mymodule\GeoLocatorManager $manager</span></pre><pre class="console"><span class="koboSpan" id="kobo.1252.1">
    */</span></pre><pre class="console"><span class="koboSpan" id="kobo.1253.1">
  $manager = \Drupal::service</span></pre><pre class="console"><span class="koboSpan" id="kobo.1254.1">
    ('plugin.manager.geolocator');</span></pre><pre class="console"><span class="koboSpan" id="kobo.1255.1">
  foreach ($manager-&gt;getDefinitions() as $plugin_id =&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1256.1">
    $definition) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1257.1">
    /** @var \Drupal\mymodule\Plugin\GeoLocator</span></pre><pre class="console"><span class="koboSpan" id="kobo.1258.1">
        \GeoLocatorInterface */</span></pre><pre class="console"><span class="koboSpan" id="kobo.1259.1">
    $instance = $manager-&gt;createInstance($plugin_id);</span></pre><pre class="console"><span class="koboSpan" id="kobo.1260.1">
    $country_code = $instance-&gt;geolocate($request);</span></pre><pre class="console"><span class="koboSpan" id="kobo.1261.1">
    if ($country_code) {</span></pre><pre class="console"><span class="koboSpan" id="kobo.1262.1">
      \Drupal::messenger()-&gt;addStatus("Country:</span></pre><pre class="console"><span class="koboSpan" id="kobo.1263.1">
        $country_code");</span></pre><pre class="console"><span class="koboSpan" id="kobo.1264.1">
      break;</span></pre><pre class="console"><span class="koboSpan" id="kobo.1265.1">
    }</span></pre><pre class="console"><span class="koboSpan" id="kobo.1266.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.1267.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1268.1">We fetch the definitions from the plugin manager and create an instance of each plugin. </span><span class="koboSpan" id="kobo.1268.2">We then check whether the plugin returns a result. </span><span class="koboSpan" id="kobo.1268.3">If the plugin returns a country code, the country code is added as a message and then the loop </span><span class="No-Break"><span class="koboSpan" id="kobo.1269.1">is stopped.</span></span></p>
<h2 id="_idParaDest-260"><a id="_idTextAnchor289"/><span class="koboSpan" id="kobo.1270.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.1271.1">Plugins and plugin </span><a id="_idIndexMarker488"/><span class="koboSpan" id="kobo.1272.1">types are a way of grouping classes that operate with specific functionality. </span><span class="koboSpan" id="kobo.1272.2">The plugin manager provides a way of discovering these classes and instantiating them. </span><span class="koboSpan" id="kobo.1272.3">In the last step of this recipe, we used the plugin manager to find each definition, create an instance of the plugin, and then call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1273.1">geolocate</span></strong><span class="koboSpan" id="kobo.1274.1"> method to find a country code from the </span><span class="No-Break"><span class="koboSpan" id="kobo.1275.1">request object.</span></span></p>
<p><span class="koboSpan" id="kobo.1276.1">Plugin managers utilize discovery methods to find plugin classes. </span><span class="koboSpan" id="kobo.1276.2">By default, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1277.1">\Drupal\Core\Plugin\Discovery\AnnotatedClassDiscovery</span></strong><span class="koboSpan" id="kobo.1278.1"> discovery method is used. </span><span class="koboSpan" id="kobo.1278.2">The subdirectory is used to look for plugins, which we specified as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1279.1">Plugin/GeoLocator</span></strong><span class="koboSpan" id="kobo.1280.1"> in our plugin manager’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1281.1">__construct</span></strong><span class="koboSpan" id="kobo.1282.1"> method. </span><span class="koboSpan" id="kobo.1282.2">The annotated class discovery then iterates through the mapping of namespaces to their directories. </span><span class="koboSpan" id="kobo.1282.3">It discovers PHP files in the desired directory. </span><span class="koboSpan" id="kobo.1282.4">These classes are then inspected for the proper </span><strong class="source-inline"><span class="koboSpan" id="kobo.1283.1">@GeoLocator</span></strong><span class="koboSpan" id="kobo.1284.1"> annotation and to make sure that they implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1285.1">GeoLocatorInterface</span></strong><span class="koboSpan" id="kobo.1286.1"> interface. </span><span class="koboSpan" id="kobo.1286.2">Discovered classes are then registered as </span><span class="No-Break"><span class="koboSpan" id="kobo.1287.1">plugin definitions.</span></span></p>
<h2 id="_idParaDest-261"><a id="_idTextAnchor290"/><span class="koboSpan" id="kobo.1288.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.1289.1">There are many additional items for creating a custom plugin type; we will discuss some of them in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1290.1">following sections.</span></span></p>
<h3><span class="koboSpan" id="kobo.1291.1">Specifying an alter hook</span></h3>
<p><span class="koboSpan" id="kobo.1292.1">Plugin managers </span><a id="_idIndexMarker489"/><span class="koboSpan" id="kobo.1293.1">have the ability to define an alter hook. </span><span class="koboSpan" id="kobo.1293.2">The following line of code will be added to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1294.1">GeoLocatorManager</span></strong><span class="koboSpan" id="kobo.1295.1"> class’s constructor to provide the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1296.1">hook_geolocator_plugins_alter</span></strong><span class="koboSpan" id="kobo.1297.1"> alter hook. </span><span class="koboSpan" id="kobo.1297.2">This is passed to the module handler service </span><span class="No-Break"><span class="koboSpan" id="kobo.1298.1">for invocations:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1299.1">
  public function __construct(
    \Traversable $namespaces,
    CacheBackendInterface $cache_backend,
    ModuleHandlerInterface
    $module_handler
  ) {
    parent::__construct(
      'Plugin/GeoLocator',
      $namespaces,
      $module_handler,
      'Drupal\mymodule\Plugin\GeoLocator
        \GeoLocatorInterface',
      'Drupal\mymodule\Annotation\GeoLocator'
    );
</span><strong class="bold"><span class="koboSpan" id="kobo.1300.1">    // Specify the alter hook.</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1301.1">    $this-&gt;alterInfo('geolocator_info');</span></strong><span class="koboSpan" id="kobo.1302.1">
  }</span></pre>
<p><span class="koboSpan" id="kobo.1303.1">Modules implementing </span><strong class="source-inline"><span class="koboSpan" id="kobo.1304.1">hook_geolocator_plugins_alter</span></strong><span class="koboSpan" id="kobo.1305.1"> in their </span><strong class="source-inline"><span class="koboSpan" id="kobo.1306.1">.module</span></strong><span class="koboSpan" id="kobo.1307.1"> file have </span><a id="_idIndexMarker490"/><span class="koboSpan" id="kobo.1308.1">the ability to modify all the discovered plugin definitions. </span><span class="koboSpan" id="kobo.1308.2">They also have the ability to remove defined plugin entries or alter any information provided for the </span><span class="No-Break"><span class="koboSpan" id="kobo.1309.1">annotation definition.</span></span></p>
<h3><span class="koboSpan" id="kobo.1310.1">Using a cache backend</span></h3>
<p><span class="koboSpan" id="kobo.1311.1">Plugins can </span><a id="_idIndexMarker491"/><span class="koboSpan" id="kobo.1312.1">use a cache backend to improve performance. </span><span class="koboSpan" id="kobo.1312.2">This can be done by specifying a cache backend with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1313.1">setCacheBackend</span></strong><span class="koboSpan" id="kobo.1314.1"> method in the plugin manager’s constructor. </span><span class="koboSpan" id="kobo.1314.2">The following line of code will allow the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1315.1">GeoLocator</span></strong><span class="koboSpan" id="kobo.1316.1"> plugin definitions to be cached and only discovered on a </span><span class="No-Break"><span class="koboSpan" id="kobo.1317.1">cache rebuild:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1318.1">
$this-&gt;setCacheBackend($cache_backend,
    'geolocator_plugins');</span></pre>
<p><span class="koboSpan" id="kobo.1319.1">Without specifying a cache backend, Drupal will scan the filesystem for any annotated </span><strong class="source-inline"><span class="koboSpan" id="kobo.1320.1">GeoLocator</span></strong><span class="koboSpan" id="kobo.1321.1"> plugins provided by modules. </span><span class="koboSpan" id="kobo.1321.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1322.1">$cache_backend</span></strong><span class="koboSpan" id="kobo.1323.1"> variable is passed to the constructor. </span><span class="koboSpan" id="kobo.1323.2">The second parameter provides the cache key. </span><span class="koboSpan" id="kobo.1323.3">The cache key will have the current language code added as </span><span class="No-Break"><span class="koboSpan" id="kobo.1324.1">a suffix.</span></span></p>
<p><span class="koboSpan" id="kobo.1325.1">There is </span><a id="_idIndexMarker492"/><span class="koboSpan" id="kobo.1326.1">an optional third parameter that takes an array of strings to represent cache tags that will cause the plugin definitions to be cleared. </span><span class="koboSpan" id="kobo.1326.2">This is an advanced feature, and plugin definitions should normally be cleared through the manager’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1327.1">clearCachedDefinitions</span></strong><span class="koboSpan" id="kobo.1328.1"> method. </span><span class="koboSpan" id="kobo.1328.2">The cache tags allow the plugin definitions to be cleared when a relevant cache is cleared </span><span class="No-Break"><span class="koboSpan" id="kobo.1329.1">as well.</span></span></p>
<h3><span class="koboSpan" id="kobo.1330.1">Accessing plugins through the manager</span></h3>
<p><span class="koboSpan" id="kobo.1331.1">Plugins are </span><a id="_idIndexMarker493"/><span class="koboSpan" id="kobo.1332.1">loaded through the manager service. </span><span class="koboSpan" id="kobo.1332.2">Plugin managers </span><a id="_idIndexMarker494"/><span class="koboSpan" id="kobo.1333.1">have various methods for retrieving plugin definitions, which are </span><span class="No-Break"><span class="koboSpan" id="kobo.1334.1">as follows:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1335.1">getDefinitions</span></strong><span class="koboSpan" id="kobo.1336.1">: This method will return an array of plugin definitions. </span><span class="koboSpan" id="kobo.1336.2">It first makes an attempt to retrieve cached definitions, if any, and sets the cache of discovered definitions before </span><span class="No-Break"><span class="koboSpan" id="kobo.1337.1">returning them.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1338.1">getDefinition</span></strong><span class="koboSpan" id="kobo.1339.1">: This takes an expected plugin ID and returns </span><span class="No-Break"><span class="koboSpan" id="kobo.1340.1">its definition.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1341.1">createInstance</span></strong><span class="koboSpan" id="kobo.1342.1">: This takes an expected plugin ID and returns an initiated class for </span><span class="No-Break"><span class="koboSpan" id="kobo.1343.1">the plugin.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1344.1">getInstance</span></strong><span class="koboSpan" id="kobo.1345.1">: This takes an array that acts as a plugin definition and returns an initiated class from </span><span class="No-Break"><span class="koboSpan" id="kobo.1346.1">the definition.</span></span></li>
</ul>
</div>
</body></html>