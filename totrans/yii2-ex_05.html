<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Developing a Reservation System"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Developing a Reservation System</h1></div></div></div><p>In this chapter, you will learn how to configure and manage databases, using SQL or ActiveRecord directly, then you will see how to solve common tasks, such as saving single and multiple models from a form, and how to create data aggregation and filtered views.</p><p>We will cover the following topics in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Configuring a DB connection:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For example, creating rooms, customers, and reservations tables</li></ul></div></li><li class="listitem" style="list-style-type: disc">For example, testing a connection and executing a SQL query</li><li class="listitem" style="list-style-type: disc">Using Gii to create room, customer, and reservation models</li><li class="listitem" style="list-style-type: disc">Using ActiveRecord to manipulate data:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For example, querying rooms list with ActiveRecord</li></ul></div></li><li class="listitem" style="list-style-type: disc">Working with relationships:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For example, using relationships to connect rooms, reservations, and customers</li></ul></div></li><li class="listitem" style="list-style-type: disc">How to save a model from a form:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For example, creating and updating a room from a form</li></ul></div></li><li class="listitem" style="list-style-type: disc">Setting up the GMT time zone</li><li class="listitem" style="list-style-type: disc">Using multiple database connections:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For example, configuring a second DB connection to export data to a local SQLite DB</li></ul></div></li></ul></div><div class="section" title="Configuring a DB connection"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec35"/>Configuring a DB connection</h1></div></div></div><p>Yii2 offers a <a id="id174" class="indexterm"/>high-level layer to access databases, built on top of <a id="id175" class="indexterm"/><span class="strong"><strong>PHP Data Objects</strong></span> (<span class="strong"><strong>PDO</strong></span>).</p><p>This framework allows us to manipulate a database table's content through the use of ActiveRecord objects. This encapsulates methods to access single or multiple records, as well as filtering, joining, and ordering data in an intuitive way.</p><p>Again, we can work with databases using plain SQL, but this means that we must handle dissimilarities in SQL languages passing through different databases (MySQL, SQL Server, Postgres, Oracle, and so on), which means losing Yii2 facilities.</p><p>A database object connection is an instance of <code class="literal">yii\db\Connection</code>:</p><div class="informalexample"><pre class="programlisting">$db = new yii\db\Connection([
    'dsn' =&gt; 'mysql:host=localhost;dbname=my_database',
    'username' =&gt; 'my_username',
    'password' =&gt; 'my_password',
    'charset' =&gt; 'utf8',
]);</pre></div><p>In this example, we have a connection to a MySQL Server with a <code class="literal">mysql</code> connection string to the database <code class="literal">my_databases</code>, setting <code class="literal">my_username</code> as <code class="literal">username</code> and <code class="literal">my_password</code> as <code class="literal">password</code>. Moreover, we set <code class="literal">charset</code> to <code class="literal">utf8</code> in order to guarantee standard charset use. This is a standard database connection entry.</p><p>Other common available connection strings are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">MySQL and MariaDB: <code class="literal">mysql:host=localhost;dbname=mydatabase</code></li><li class="listitem" style="list-style-type: disc">SQLite: <code class="literal">sqlite:/path/to/database/file</code></li><li class="listitem" style="list-style-type: disc">PostgreSQL: <code class="literal">pgsql:host=localhost;port=5432;dbname=mydatabase</code></li><li class="listitem" style="list-style-type: disc">MS SQL Server (via <code class="literal">mssql</code> driver): <code class="literal">mssql:host=localhost;dbname=mydatabase</code></li><li class="listitem" style="list-style-type: disc">Oracle: <code class="literal">oci:dbname=//localhost:1521/mydatabase</code></li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note21"/>Note</h3><p>If we do not provide a direct driver to database and we have to use ODBC, we will have a sample of the ODBC connection object as follows:</p><div class="informalexample"><pre class="programlisting">$db = new yii\db\Connection([
     'driverName' =&gt; 'mysql',
    'dsn' =&gt; 'odbc:Driver={MySQL};Server=localhost;Database=my_database',
    'username' =&gt; 'my_username',
    'password' =&gt; 'my_password',
    'charset' =&gt; 'utf8',
]);</pre></div></div></div><p>For convenience, we <a id="id176" class="indexterm"/>will set the database connection as an application component because it will be adopted in many points of the application. In <code class="literal">basic/config/web.php</code>:</p><div class="informalexample"><pre class="programlisting">return [
    // ...
    'components' =&gt; [
        // ...
        'db' =&gt; [
            'class' =&gt; 'yii\db\Connection',
            'dsn' =&gt; 'mysql:host=localhost;dbname=my_database',
            'username' =&gt; 'my_username',
            'password' =&gt; 'my_password',
            'charset' =&gt; 'utf8',
        ],
    ],
    // ...
];</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note22"/>Note</h3><p>In the basic template, database configuration is in a separate file, generally <code class="literal">basic/config/db.php</code>.</p><p>If we open <code class="literal">basic/config/web.php</code>, we can see that the <code class="literal">db.php</code> file fills the <code class="literal">db</code> property of the main configuration.</p></div></div><div class="section" title="Example – creating rooms, customers, and reservations tables"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec24"/>Example – creating rooms, customers, and reservations tables</h2></div></div></div><p>Now, we need a <a id="id177" class="indexterm"/>MySQL database instance to work <a id="id178" class="indexterm"/>with. Open the DB administration <a id="id179" class="indexterm"/>panel as phpMyAdmin (if provided) or access the DB directly using a console and create a new database named <code class="literal">my_database</code>, associated with the username <code class="literal">my_username</code> and the password <code class="literal">my_password</code>.</p><p>In this example, we will create three database tables to manage rooms, customers, and reservations data.</p><p>A room will have the following fields:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">id</code> as an integer</li><li class="listitem" style="list-style-type: disc"><code class="literal">floor</code> as an integer</li><li class="listitem" style="list-style-type: disc"><code class="literal">room_number</code> as an integer</li><li class="listitem" style="list-style-type: disc"><code class="literal">has_conditioner</code> as an integer</li><li class="listitem" style="list-style-type: disc"><code class="literal">has_tv</code> as an integer</li><li class="listitem" style="list-style-type: disc"><code class="literal">has_phone</code> as an integer</li><li class="listitem" style="list-style-type: disc"><code class="literal">available_from</code> as the date</li><li class="listitem" style="list-style-type: disc"><code class="literal">price_per_day</code> as a decimal</li><li class="listitem" style="list-style-type: disc"><code class="literal">description</code> as text</li></ul></div><p>The script of<a id="id180" class="indexterm"/> the <code class="literal">room</code> table will be:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `room` (
  `id` int(11) NOT NULL PRIMARY KEY AUTO_INCREMENT,
  `floor` int(11) NOT NULL,
  `room_number` int(11) NOT NULL,
  `has_conditioner` int(1) NOT NULL,
  `has_tv` int(1) NOT NULL,
  `has_phone` int(1) NOT NULL,
  `available_from` date NOT NULL,
  `price_per_day` decimal(20,2) DEFAULT NULL,
  `description` text);</pre></div><p>A customer will <a id="id181" class="indexterm"/>have the following fields:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">id</code> as an integer</li><li class="listitem" style="list-style-type: disc"><code class="literal">name</code> as a string</li><li class="listitem" style="list-style-type: disc"><code class="literal">surname</code> as a string</li><li class="listitem" style="list-style-type: disc"><code class="literal">phone_number</code> as a string</li></ul></div><p>The script <a id="id182" class="indexterm"/>of the <code class="literal">customer</code> table will be</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `customer` (
 `id` int(11) NOT NULL PRIMARY KEY AUTO_INCREMENT,
 `name` varchar(50) NOT NULL,
 `surname` varchar(50) NOT NULL,
 `phone_number` varchar(50) DEFAULT NULL
);</pre></div><p>A reservation will have the following fields:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">id</code> as an integer</li><li class="listitem" style="list-style-type: disc"><code class="literal">room_id</code> as an integer that is a reference to a room table</li><li class="listitem" style="list-style-type: disc"><code class="literal">customer_id</code> as an integer that is a reference to a customer table</li><li class="listitem" style="list-style-type: disc"><code class="literal">price_per_day</code> as a decimal</li><li class="listitem" style="list-style-type: disc"><code class="literal">date_from</code> as the date to specify check in</li><li class="listitem" style="list-style-type: disc"><code class="literal">date_to</code> as the date to specify check out</li><li class="listitem" style="list-style-type: disc"><code class="literal">reservation_date</code> as a timestamp of creation</li><li class="listitem" style="list-style-type: disc"><code class="literal">days_stay</code> as an integer</li></ul></div><p>The script <a id="id183" class="indexterm"/>of <a id="id184" class="indexterm"/>the <code class="literal">reservation</code> table<a id="id185" class="indexterm"/> will be:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE `reservation` (
 `id` int(11) NOT NULL AUTO_INCREMENT,
 `room_id` int(11) NOT NULL,
 `customer_id` int(11) NOT NULL,
 `price_per_day` decimal(20,2) NOT NULL,
 `date_from` date NOT NULL,
 `date_to` date NOT NULL,
 `reservation_date` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
);</pre></div><p>Finally, place <code class="literal">basic/config/web.php</code> in the <code class="literal">components</code> property:</p><div class="informalexample"><pre class="programlisting">$db = new yii\db\Connection([
    'dsn' =&gt; 'mysql:host=localhost;dbname=my_database',
    'username' =&gt; 'my_username',
    'password' =&gt; 'my_password',
    'charset' =&gt; 'utf8',
]);</pre></div><p>Then we are ready to test the connection to the DB.</p></div><div class="section" title="Example – test connection and executing the SQL query"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec25"/>Example – test connection and executing the SQL query</h2></div></div></div><p>Now let's see how to test the <a id="id186" class="indexterm"/>DB connection.</p><p>Put some rooms <a id="id187" class="indexterm"/>data in the database table:</p><div class="informalexample"><pre class="programlisting">INSERT INTO `my_database`.`room` (`id`, `floor`, `room_number`, `has_conditioner`, `has_tv`, `has_phone`, `available_from`, `price_per_day`, `description`)
VALUES
(NULL, '1', '101', '1', '0', '1', '2015-05-20', '120', NULL), (NULL, '2', '202', '0', '1', '1', '2015-05-30', '118', NULL);</pre></div><p>Database queries are made using the <code class="literal">yii\db\Command</code> object, which is created statically by the <code class="literal">yii\db\Connection::createCommand()</code> method.</p><p>The most important methods to retrieve data from a command are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">queryAll()</code>: This <a id="id188" class="indexterm"/>method returns all the rows of a query, where each array element is an array that represents a row of data; if the query returns no data, the response is an empty array</li><li class="listitem" style="list-style-type: disc"><code class="literal">queryOne()</code>: This <a id="id189" class="indexterm"/>method returns the first row of the query, that is, an array, which represents a row of data; if the query returns no data, the response is a false Boolean value</li><li class="listitem" style="list-style-type: disc"><code class="literal">queryScalar()</code>: This <a id="id190" class="indexterm"/>method returns the value of the first column in the first row of the query result; otherwise false will be returned if there is no value</li><li class="listitem" style="list-style-type: disc"><code class="literal">query()</code>: This is the <a id="id191" class="indexterm"/>most common response that returns the <code class="literal">yii\db\DataReader</code> object</li></ul></div><p>Now we will <a id="id192" class="indexterm"/>display the <code class="literal">room</code> table's content in different ways.</p><p>We will<a id="id193" class="indexterm"/> update <code class="literal">RoomsController</code> in <code class="literal">basic/controllers/RoomsController.php</code>. In this file, we will append an index action to fetch data and pass it to view:</p><div class="informalexample"><pre class="programlisting">&lt;?php

namespace app\controllers;

use Yii;
use yii\web\Controller;

class RoomsController extends Controller
{
    public function actionIndex()
    {
        $sql = 'SELECT * FROM room ORDER BY id ASC';
        
        $db = Yii::$app-&gt;db;
        
        $rooms = $db-&gt;createCommand($sql)-&gt;queryAll();
        
    // same of
     // $rooms = Yii::$app-&gt;db-&gt;createCommand($sql)-&gt;queryAll();

        return $this-&gt;render('index', [ 'rooms' =&gt; $rooms ]);
    }
}</pre></div><p>The content of <code class="literal">actionIndex()</code> is very simple. Define the <code class="literal">$sql</code> variable with the SQL statement to be executed, then fill the <code class="literal">$rooms</code> array with the query result, and finally render the <code class="literal">index</code> view, passing the rooms variable.</p><p>In the view content, in <code class="literal">basic/views/rooms/index.php</code>, we will display the <code class="literal">$rooms</code> array in a table to exploit Bootstrap CSS's advantages, and apply the <code class="literal">table</code> class to the table HTML tag.</p><p>This is the<a id="id194" class="indexterm"/> content of<code class="literal"> basic/views/rooms/index.php</code>, where we can<a id="id195" class="indexterm"/> also see the data formatter used:</p><div class="informalexample"><pre class="programlisting">&lt;table class="table"&gt;
    &lt;tr&gt;
        &lt;th&gt;Floor&lt;/th&gt;
        &lt;th&gt;Room number&lt;/th&gt;
        &lt;th&gt;Has conditioner&lt;/th&gt;
        &lt;th&gt;Has tv&lt;/th&gt;
        &lt;th&gt;Has phone&lt;/th&gt;
        &lt;th&gt;Available from&lt;/th&gt;
        &lt;th&gt;Available from (db format)&lt;/th&gt;
        &lt;th&gt;Price per day&lt;/th&gt;
        &lt;th&gt;Description&lt;/th&gt;
    &lt;/tr&gt;
    &lt;?php foreach($rooms as $item) { ?&gt;
    &lt;tr&gt;
        &lt;td&gt;&lt;?php echo $item['floor'] ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo $item['room_number'] ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asBoolean($item['has_conditioner']) ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asBoolean($item['has_tv']) ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo ($item['has_phone'] == 1)?'Yes':'No' ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($item['available_from']) ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($item['available_from'], 'php:Y-m-d') ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asCurrency($item['price_per_day'], 'EUR') ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo $item['description'] ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;?php } ?&gt;
&lt;/table&gt;</pre></div><p>The <code class="literal">floor</code> and <code class="literal">room_number</code> fields are directly displayed.</p><p>The next two fields <code class="literal">has_conditioner</code> and <code class="literal">has_tv</code> are shown by employing a Boolean formatter supplied by Yii2; the Boolean formatter will use the locale defined during the configuration of Yii2.</p><p>The next field <code class="literal">has_phone</code> renders its value as the previous two fields; the reason for this is to indicate how to produce the same output of a Boolean formatter in a standard PHP style.</p><p>Then, the<a id="id196" class="indexterm"/> <code class="literal">available_from</code> field is rendered using the date formatter in <a id="id197" class="indexterm"/>two different ways, directly and passing the format to be used. Or, if no parameter is passed, it adopts the default format.</p><p>Again, the <code class="literal">price_per_day</code> field is rendered through the currency formatter, passing the currency as a parameter. If no parameter is passed, the default value will be used. The last field <code class="literal">description</code> is displayed directly. Point your browser to <code class="literal">http://hostname/basic/web/rooms/index</code> to see the content as follows:</p><div class="mediaobject"><img src="graphics/B04656_05_01.jpg" alt="Example – test connection and executing the SQL query"/><div class="caption"><p>A list of rooms</p></div></div></div></div></div>
<div class="section" title="Using Gii to create room, customer, and reservation models"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec36"/>Using Gii to create room, customer, and reservation models</h1></div></div></div><p>Yii2 provides a powerful<a id="id198" class="indexterm"/> tool to generate models, controllers, and <a id="id199" class="indexterm"/>CRUD (create, read, update, and delete) <a id="id200" class="indexterm"/>actions, forms, modules, and extensions: Gii.</p><p>At the bottom of the <code class="literal">basic/config/web.php</code> file, placed in the basic standard configuration, there is a block of code that enables Gii:</p><div class="informalexample"><pre class="programlisting">if (YII_ENV_DEV) {
    // configuration adjustments for 'dev' environment
    $config['bootstrap'][] = 'debug';
    $config['modules']['debug'] = 'yii\debug\Module';

    $config['bootstrap'][] = 'gii';
    $config['modules']['gii'] = 'yii\gii\Module';
}</pre></div><p>Verify that these <a id="id201" class="indexterm"/>lines are present, otherwise append them at the bottom of the <code class="literal">web.php</code> file before the <code class="literal">return $config</code> statement. The last check is in <code class="literal">basic/web/index.php</code>. Verify that <code class="literal">YII_ENV</code> is <code class="literal">dev</code>, with this line:</p><div class="informalexample"><pre class="programlisting">defined('YII_ENV') or define('YII_ENV', 'dev');</pre></div><p>Now, we can point our<a id="id202" class="indexterm"/> browser to <code class="literal">http://hostname/basic/web/gii</code>, and we should <a id="id203" class="indexterm"/>see this error page:</p><div class="mediaobject"><img src="graphics/B04656_05_02.jpg" alt="Using Gii to create room, customer, and reservation models"/><div class="caption"><p>Forbidden access to Gii</p></div></div><p>This page will be displayed since access to Gii is locked by a password.</p><p>We need to add extra configuration to the <code class="literal">gii</code> module, passing other allowed IPs. Gii's configuration has an attribute named <code class="literal">allowedIPs</code>, which consents to specify which IP addresses can access the Gii page:</p><div class="informalexample"><pre class="programlisting"> 'allowedIPs' =&gt; ['127.0.0.1', '::1', '192.168.178.20']</pre></div><p>In this extract, Gii will accept access from a localhost (in the IPv4 form with 127.0.0.1 and IPv6 form with <code class="literal">::1</code>) and from <code class="literal">192.168.178.20</code>, which should be our IP address in private network.</p><p>If the Yii2 application is running on an external hosting, we will set our IP public address in this list of allowed IPs. For example, if our IP is <code class="literal">66.249.64.76</code>, this entry will be appended to existent (if we want maintain other permitted access points):</p><div class="informalexample"><pre class="programlisting"> 'allowedIPs' =&gt; ['127.0.0.1', '::1', '192.168.178.20', '66.249.64.76']</pre></div><p>To allow access from everywhere (useful in the development stage), we can add <code class="literal">*</code> in this list, which means that the Gii page can be accessed from every IP address:</p><div class="informalexample"><pre class="programlisting">'allowedIPs' =&gt; ['127.0.0.1', '::1', '192.168.178.20', '*']</pre></div><p>Consequently, the content of <code class="literal">gii]['gii'] = 'yii\gii\Module'</code> is:</p><div class="informalexample"><pre class="programlisting">    $config['modules']['gii'] = [
        'class' =&gt; 'yii\gii\Module',
        'allowedIPs' =&gt; ['127.0.0.1', '::1', '192.168.178.20', '*'] ]; configuration in basic/config/web.php will be:
if (YII_ENV_DEV) {
    // configuration adjustments for 'dev' environment
    $config['bootstrap'][] = 'debug';
    $config['modules']['debug'] = 'yii\debug\Module';

    $config['bootstrap'][] = 'gii';
    //$config['modules'
}</pre></div><p>Now, we are <a id="id204" class="indexterm"/>able to access to Gii from any IP.</p><p>Refresh the browser by <a id="id205" class="indexterm"/>clicking on the page <code class="literal">http://hostname/basic/web/gii</code> and<a id="id206" class="indexterm"/> we can finally see its content:</p><div class="mediaobject"><img src="graphics/B04656_05_03.jpg" alt="Using Gii to create room, customer, and reservation models"/><div class="caption"><p>Successful access to Gii</p></div></div><p>Now, click on the <span class="strong"><strong>Start</strong></span> button of <span class="strong"><strong>Model Generator</strong></span>; we will have a form of <span class="strong"><strong>Model Generator</strong></span> where <span class="strong"><strong>Table Name</strong></span> is the unique field to fill in. When we start to type the table name, auto-suggestion will display the possible choices. After doing this, when we move to the <span class="strong"><strong>Model Class</strong></span> field, this will be automatically filled in by a framework. The other fields can be left with the default settings.</p><p>Type <code class="literal">room</code> in <a id="id207" class="indexterm"/><span class="strong"><strong>Table Name</strong></span> and then click on the <span class="strong"><strong>Model Class</strong></span> field. This<a id="id208" class="indexterm"/> field will be filled with <span class="strong"><strong>Room</strong></span>, which is <a id="id209" class="indexterm"/>the filename in the <code class="literal">models</code> folder.</p><p>Clicking on the <span class="strong"><strong>Preview</strong></span> button will display the path where the file will be created and the action will be applied (it should be the overwrite value because we created it in the previous chapter).</p><p>Finally, click on the <span class="strong"><strong>Generate</strong></span> button to complete this action. A response message will give us information about the execution of this operation.</p><p>This is the form with a successful result:</p><div class="mediaobject"><img src="graphics/B04656_05_04.jpg" alt="Using Gii to create room, customer, and reservation models"/><div class="caption"><p>Model Generator of Gii</p></div></div><p>Repeat this <a id="id210" class="indexterm"/>operation for the other two tables: reservations and <a id="id211" class="indexterm"/>customers.</p><p>Now, we have three <a id="id212" class="indexterm"/>models in the <code class="literal">basic/models</code> folder: <code class="literal">Room.php</code>, <code class="literal">Reservation.php</code>, and <code class="literal">Customer.php</code>.</p><p>Let's explain what Gii has done. Open the <code class="literal">basic/models/Room.php</code> file, and we have three methods:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">tableName()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">rules()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">attributeLabels()</code></li></ul></div><p>The first method, <code class="literal">tableName()</code>, simply returns the name of table to which this model is linked:</p><div class="informalexample"><pre class="programlisting">    public static function tableName()
    {
        return 'room';
    }</pre></div><p>The second method, <code class="literal">rules()</code>, is important because it contains rules validation to be checked when the <code class="literal">validate()</code> method is launched (it is launched automatically in the <code class="literal">save()</code> method) or a massive attributes assignment as:</p><div class="informalexample"><pre class="programlisting">$model-&gt;attributes = arrayWithData;</pre></div><p>This is the content of the <code class="literal">rules()</code> method:</p><div class="informalexample"><pre class="programlisting">    public function rules()
    {
        return [
            [['floor', 'room_number', 'has_conditioner', 'has_tv', 'has_phone', 'available_from'], 'required'],
            [['floor', 'room_number', 'has_conditioner', 'has_tv', 'has_phone'], 'integer'],
            [['available_from'], 'safe'],
            [['price_per_day'], 'number'],
            [['description'], 'string']
        ];
    }</pre></div><p>The first rule <a id="id213" class="indexterm"/>specifies that the fields <code class="literal">floor</code>, <code class="literal">room_number</code>, <code class="literal">has_condition</code>, <code class="literal">has_tv</code>, and <code class="literal">avaiable_from</code> are mandatory because they are passed to the <a id="id214" class="indexterm"/>required validator. Moreover, they must <a id="id215" class="indexterm"/>be an integer, as required by the second rule.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note23"/>Note</h3><p>Fields that are not in rules, will be skipped in a massive assignment because they are considered unsafe (since they are not present in rules). So it is necessary that when a field that has not got a validator rule, it must have an entry in the 'safe' validator.</p></div></div><p>The fourth rule specifies that the <code class="literal">price_per_day</code> field is a number, while the last rule states that <code class="literal">description</code> is a string.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note24"/>Note</h3><p>These rules are read automatically from the database field type and constraint.</p></div></div><p>The last method <code class="literal">attributeLabels()</code> specifies the representation of fields in the display view as a form, grid, and so on.</p><p>This is the content of <code class="literal">attributeLabels()</code>:</p><div class="informalexample"><pre class="programlisting">    public function attributeLabels()
    {
        return [
            'id' =&gt; 'ID',
            'floor' =&gt; 'Floor',
            'room_number' =&gt; 'Room Number',
            'has_conditioner' =&gt; 'Has Conditioner',
            'has_tv' =&gt; 'Has Tv',
            'has_phone' =&gt; 'Has Phone',
            'available_from' =&gt; 'Available From',
            'price_per_day' =&gt; 'Price Per Day',
            'description' =&gt; 'Description',
        ];
    }</pre></div><p>Yii2 reports—in the model—any relationship between the tables present in a database. We have the <code class="literal">Reservation</code> model that has links to <code class="literal">Room</code> and <code class="literal">Customer</code>.</p><p>Follow these <a id="id216" class="indexterm"/>instructions to make the framework able to<a id="id217" class="indexterm"/> create a relationship in the model:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Check that the database<a id="id218" class="indexterm"/> tables use the InnoDB engine (which supports relationships and foreign keys).</li><li class="listitem">In the <code class="literal">Reservation</code> table, add two indexes, respectively for the <code class="literal">room_id</code> and <code class="literal">customer_id</code> fields:<div class="informalexample"><pre class="programlisting">ALTER TABLE `reservation` ADD INDEX ( `room_id` ) ;
ALTER TABLE `reservation` ADD INDEX ( `customer_id` ) ;</pre></div></li><li class="listitem">In the <code class="literal">Reservation</code> table, add two constraints to the <code class="literal">room</code> and <code class="literal">customer</code> tables:<div class="informalexample"><pre class="programlisting">ALTER TABLE `reservation` ADD FOREIGN KEY ( `room_id` ) REFERENCES `room` (`id`) ON DELETE RESTRICT ON UPDATE RESTRICT ;
ALTER TABLE `reservation` ADD FOREIGN KEY ( `customer_id` ) REFERENCES `customer` (`id`) ON DELETE RESTRICT ON UPDATE RESTRICT ;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note25"/>Note</h3><p>In these constraints, we used <code class="literal">RESTRICT</code> for <code class="literal">DELETE</code> and <code class="literal">UPDATE</code> operations. <code class="literal">RESTRICT</code> avoids the deletion of reservations that refer to customers or rooms that we are trying to delete. Therefore, to delete a customer or room that figures in reservations, we will be required to first delete the reservations.</p><p>This behavior ensures that important data such as reservations is never deleted automatically (in a cascade) when deleting a room or a customer. An error message will be displayed when you try to do this to a reservation linked to the customer or room.</p><p>In other contexts, a commonly used keyword is <code class="literal">CASCADE</code>, which removes all data that refers to linked tables.</p></div></div></li></ol></div><p>Open Gii again<a id="id219" class="indexterm"/> and navigate to <code class="literal">http://hostname/basic/web/gii</code>, then click on the <span class="strong"><strong>Start</strong></span> button in <span class="strong"><strong>Model Generator</strong></span> and type <code class="literal">room</code> in <span class="strong"><strong>Table Name</strong></span>. Click on the <span class="strong"><strong>Preview</strong></span> button at the bottom of the page and this<a id="id220" class="indexterm"/> time you will see that <code class="literal">models/Room.php</code> exists and the action is overwrite, unflagged.</p><p>Click on the check near 'overwrite' and then on the <span class="strong"><strong>Generate</strong></span> button. In this way, we have forced to overwrite <a id="id221" class="indexterm"/>the <code class="literal">Room</code> model with the relational data from the <code class="literal">Room</code> table.</p><p>Now, <code class="literal">basic/models/Room.php</code> contains a new method named <code class="literal">getReservations</code> at the bottom, with this content:</p><div class="informalexample"><pre class="programlisting">    /**
     * @return \yii\db\ActiveQuery
     */
    public function getReservations()
    {
       return $this-&gt;hasMany(Reservation::className(), ['room_id' =&gt; 'id']);
    }</pre></div><p>This method returns an ActiveQuery instance, which is used to build a query to be dispatched to the database.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note26"/>Note</h3><p>When called as a property, this method will return the list of reservations linked to the model.</p><p>You might encounter the case where <code class="literal">$model</code> is an instance of the <code class="literal">Room</code> class for example: <code class="literal">$reservationsList = $model-&gt;reservations;</code>
</p><p>In this case, fill the <code class="literal">$reservationsList</code> variables with a list of reservations related to this <code class="literal">Room</code> model.</p><p>This is not surprising, although the <code class="literal">hasMany</code> method returns an <code class="literal">ActiveQuery</code> object.</p><p>If we explore the <code class="literal">__get()</code> method of <code class="literal">BaseActiveRecord</code> (which is the base class of ActiveRecord) that<a id="id222" class="indexterm"/> handles the property<a id="id223" class="indexterm"/> requirements, we can see these lines of code:</p><div class="informalexample"><pre class="programlisting">            $value = parent::__get($name);
            if ($value instanceof ActiveQueryInterface) {
                return $this-&gt;_related[$name] = $value-&gt;findFor($name, $this);
            } else {
                return $value;
            }</pre></div><p>This returns <a id="id224" class="indexterm"/>linked results when the <code class="literal">$value</code> content is an instance of <code class="literal">ActiveQueryInterface</code> (which is an interface implemented by the <code class="literal">ActiveQuery</code> class).</p></div></div></div>
<div class="section" title="Using ActiveRecord to manipulate data"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec37"/>Using ActiveRecord to manipulate data</h1></div></div></div><p>ActiveRecord <a id="id225" class="indexterm"/>offers a convenient way to access and <a id="id226" class="indexterm"/>manipulate data stored in a database. This class is linked to a database table and represents a row of the linked table. Its attributes are the fields of the table and its methods allow us to perform common actions on database, such as selecting, inserting, or updating SQL statements.</p><p>Many common databases are supported by ActiveRecord, such as:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">MySQL</li><li class="listitem" style="list-style-type: disc">PostgreSQL</li><li class="listitem" style="list-style-type: disc">SQLite</li><li class="listitem" style="list-style-type: disc">Oracle</li><li class="listitem" style="list-style-type: disc">Microsoft SQL Server</li></ul></div><p>Also, some NoSQL databases are supported, such as:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Redis</li><li class="listitem" style="list-style-type: disc">MongoDB</li></ul></div><p>ActiveRecord reads the table structure every time it is instanced and makes available table columns as its properties. Every change to the table structure is immediately available in the ActiveRecord object.</p><p>Therefore, if a table contains the fields <code class="literal">id</code>, <code class="literal">floor</code>, and <code class="literal">room_number</code>, and if <code class="literal">$model</code> is an instance of <code class="literal">yii\db\ActiveRecord</code>, in order to access these fields, it will be enough to type:</p><div class="informalexample"><pre class="programlisting">$id = $model-&gt;id;
$floor = $model-&gt;floor;
$room_number = $model-&gt;room_numer;</pre></div><p>ActiveRecord<a id="id227" class="indexterm"/> handles properties request with the<code class="literal"> __get</code> magic <a id="id228" class="indexterm"/>method and catches the respective content of a table column. In the previous paragraph, you saw how to create a model class from database tables to extend <code class="literal">yii\db\ActiveRecord</code> with Gii. The syntax used by ActiveRecord is simple and redundant, so it is easy to remember. Now let's look at how to query data from a database with ActiveRecord.</p><p>Data is fetched from a database through an <code class="literal">\yii\db\ActiveQuery</code> object to build the query, and finally calls on <code class="literal">one()</code> or <code class="literal">all()</code> methods to get an ActiveRecord object or a list of ActiveRecord objects.</p><p>An ActiveQuery object is returned from an ActiveRecord object by calling its static method <code class="literal">::find()</code>.</p><p>If <code class="literal">Room</code> is a model (and subclasses ActiveRecord), an ActiveQuery will be returned from:</p><div class="informalexample"><pre class="programlisting">// $query is an ActiveQuery object
$query = Room::find();</pre></div><p>ActiveQuery objects provide methods to build the query with names such as in SQL expression.</p><p>The most common ones are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">where()</code> to add conditions</li><li class="listitem" style="list-style-type: disc"><code class="literal">orderBy()</code> to apply an order</li><li class="listitem" style="list-style-type: disc"><code class="literal">groupBy()</code> to make aggregations</li></ul></div><p>Almost all of these methods support a parameter that can be a string or an array. If it is a string, it will be passed exactly as it is to the SQL query; if it is an array, a key will be used as the column name, and a value as the corresponding value. For example, we want to build query to find a room on the first floor:</p><div class="informalexample"><pre class="programlisting">$query = Room::find()-&gt;where('floor = 1');
// equivalent to
$query = Room::find()-&gt;where(['floor' =&gt; 1]);</pre></div><p>For complex conditions, <code class="literal">where()</code> supports the operator format where the condition is an array with:</p><div class="informalexample"><pre class="programlisting">[operator, operand1, operand2, …]</pre></div><p>For example, we want to build a query to find a room on the first floor:</p><div class="informalexample"><pre class="programlisting">$query = Room::find()-&gt;where(['&gt;=', 'floor', 1]);
// equivalent to
$query = Room::find()-&gt;where('floor &gt;= 1';</pre></div><p>Other conditions can be added using <code class="literal">andWhere()</code> or <code class="literal">orWhere()</code>, by just using the <code class="literal">and</code> or <code class="literal">or</code> logical link.</p><p>An array parameter of the <code class="literal">where()</code> method is preferable to a string, because we can easily split the field name from its content and set the second parameter of the <code class="literal">where()</code> method with an array with pair keys <code class="literal">=&gt;</code> values of parameters.</p><p>After creating a query object, to get data from an ActiveQuery, we will have:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">one()</code>: This method returns an ActiveRecord object or null if not found</li><li class="listitem" style="list-style-type: disc"><code class="literal">all()</code>: This method returns a list of ActiveRecord objects or an empty array if not found</li></ul></div><p>So, to get rooms<a id="id229" class="indexterm"/> on the first floor, we must write:</p><div class="informalexample"><pre class="programlisting">$query = Room::find()-&gt;where(['floor' =&gt; 1]);
$items = $query-&gt;all();
// equivalent to
$items = Room::find()-&gt;where(['floor' =&gt; 1])-&gt;all();</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note28"/>Note</h3><p>There is a more concise syntax to fetch data from an ActiveRecord: the <code class="literal">findOne()</code> and <code class="literal">findAll()</code> methods, which return a single ActiveRecord or a list of ActiveRecords. The only difference from the previous methods is that they accept a single parameter, which can be:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A number to filter by primary key</li><li class="listitem" style="list-style-type: disc">An array of scalar values to filter by a list of primary key values (only for <code class="literal">findAll()</code> because <code class="literal">findOne()</code> returns a single ActiveRecord)</li><li class="listitem" style="list-style-type: disc">An array of name-value pair to filter by a set of attribute values</li></ul></div></div></div><p>Other common<a id="id230" class="indexterm"/> methods of ActiveRecord<a id="id231" class="indexterm"/> are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">validate()</code>: This <a id="id232" class="indexterm"/>method is used to apply rules validation to attributes of a model</li><li class="listitem" style="list-style-type: disc"><code class="literal">save()</code>: This <a id="id233" class="indexterm"/>method is used to save a new model or to update one that already exists (if the <code class="literal">save()</code> method is applied to a fetched ActiveRecord object)</li><li class="listitem" style="list-style-type: disc"><code class="literal">delete()</code>: This<a id="id234" class="indexterm"/> method is used to delete a model</li></ul></div><div class="section" title="Example – query rooms list with ActiveRecord"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec26"/>Example – query rooms list with ActiveRecord</h2></div></div></div><p>In this example, we will <a id="id235" class="indexterm"/>query the rooms list using ActiveRecord and filter<a id="id236" class="indexterm"/> through the following fields: <code class="literal">floor</code>, <code class="literal">room_number</code>, and <code class="literal">price_per_day</code> with operators (<code class="literal"> &gt;=</code>, <code class="literal">&lt;=</code>, and <code class="literal">=</code>).</p><p>A data filter will take place using the <code class="literal">SearchFilter</code> container to encapsulate all of the filter data inside a single array.</p><p>Starting from a view, create a new file with the path <code class="literal">basic/views/rooms/indexFiltered.php</code>.</p><p>In this view, we will put the search filter on the top and then a table to display the results.</p><p>We have three fields to filter: <code class="literal">floor</code>, <code class="literal">room_number</code>, and <code class="literal">price_per_day</code>, all with an operator. The data filter will be passed to the controller and the filter selected will be kept after executing <code class="literal">actionIndexFiltered</code> in the controller.</p><p>This is the content of the view concerning the filtered form:</p><div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Url;

$operators = [ '=', '&lt;=', '&gt;=' ];

$sf = $searchFilter;

?&gt;

&lt;form method="post" action="&lt;?php echo Url::to(['rooms/index-filtered']) ?&gt;"&gt;
    &lt;input type="hidden" name="&lt;?= Yii::$app-&gt;request-&gt;csrfParam; ?&gt;" value="&lt;?= Yii::$app-&gt;request-&gt;csrfToken; ?&gt;" /&gt;
    
    &lt;div class="row"&gt;
        &lt;?php $operator = $sf['floor']['operator']; ?&gt;
        &lt;?php $value = $sf['floor']['value']; ?&gt;
        &lt;div class="col-md-3"&gt;
            &lt;label&gt;Floor&lt;/label&gt;
            &lt;br /&gt;    
            &lt;select name="SearchFilter[floor][operator]"&gt;
                &lt;?php foreach($operators as $op) { ?&gt;
                    &lt;?php $selected = ($operator == $op)?'selected':''; ?&gt;
                    &lt;option value="&lt;?=$op?&gt;" &lt;?=$selected?&gt;&gt;&lt;?=$op?&gt;&lt;/option&gt;
                &lt;?php } ?&gt;=
            &lt;/select&gt;
            &lt;input type="text" name="SearchFilter[floor][value]" value="&lt;?=$value?&gt;" /&gt;
        &lt;/div&gt;
        
        &lt;?php $operator = $sf['room_number']['operator']; ?&gt;
        &lt;?php $value = $sf['room_number']['value']; ?&gt;
        &lt;div class="col-md-3"&gt;
            &lt;label&gt;Room Number&lt;/label&gt;
            &lt;br /&gt;    
            &lt;select name="SearchFilter[room_number][operator]"&gt;
                &lt;?php foreach($operators as $op) { ?&gt;
                    &lt;?php $selected = ($operator == $op)?'selected':''; ?&gt;
                    &lt;option value="&lt;?=$op?&gt;" &lt;?=$selected?&gt;&gt;&lt;?=$op?&gt;&lt;/option&gt;
                &lt;?php } ?&gt;
            &lt;/select&gt;
            &lt;input type="text" name="SearchFilter[room_number][value]" value="&lt;?=$value?&gt;" /&gt;
        &lt;/div&gt;
        
        &lt;?php $operator = $sf['price_per_day']['operator']; ?&gt;
        &lt;?php $value = $sf['price_per_day']['value']; ?&gt;
        &lt;div class="col-md-3"&gt;
            &lt;label&gt;Price per day&lt;/label&gt;
            &lt;br /&gt;    
            &lt;select name="SearchFilter[price_per_day][operator]"&gt;
                &lt;?php foreach($operators as $op) { ?&gt;
                    &lt;?php $selected = ($operator == $op)?'selected':''; ?&gt;
                    &lt;option value="&lt;?=$op?&gt;" &lt;?=$selected?&gt;&gt;&lt;?=$op?&gt;&lt;/option&gt;
                &lt;?php } ?&gt;
            &lt;/select&gt;
            &lt;input type="text" name="SearchFilter[price_per_day][value]" value="&lt;?=$value?&gt;" /&gt;
        &lt;/div&gt;    
    &lt;/div&gt;
    &lt;br /&gt;
    &lt;div class="row"&gt;
        &lt;div class="col-md-3"&gt;
            &lt;input type="submit" value="filter" class="btn btn-primary" /&gt;
            &lt;input type="reset" value="reset" class="btn btn-primary" /&gt;

        &lt;/div&gt;
    &lt;/div&gt;
&lt;/form&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note29"/>Note</h3><p>
<span class="strong"><strong>Pay attention:</strong></span>
</p><p>At the beginning of the view, there is a keyword <code class="literal">use</code>, which explains the complete path of the <code class="literal">Url</code> class. If we remove it, the framework will search the <code class="literal">Url</code> class requested in the <code class="literal">&lt;form&gt;</code> tag in the current namespace, that is <code class="literal">app/controllers</code>.</p><p>After declaring the <code class="literal">&lt;form&gt;</code> tag, we inserted:</p><div class="informalexample"><pre class="programlisting">&lt;input type="hidden" name="&lt;?= Yii::$app-&gt;request-&gt;csrfParam; ?&gt;" value="&lt;?= Yii::$app-&gt;request-&gt;csrfToken; ?&gt;" /&gt;</pre></div><p>This is mandatory to allow the framework to verify the sender of the post data.</p><p>The <code class="literal">$searchFilter</code> variable is used as <code class="literal">$sf</code> to provide a more concise form.</p></div></div><p>Now <a id="id237" class="indexterm"/>update <code class="literal">RoomsController</code> in <code class="literal">basic/controllers/RoomsController.php</code> and add a new action named <code class="literal">actionIndexFiltered</code>. Create an ActiveQuery object from <code class="literal">Room</code> and check whether there is content in the <code class="literal">SearchFilter</code> keyword of the <code class="literal">$_POST</code> array.</p><p>For every present<a id="id238" class="indexterm"/> filter, a condition will be added to <code class="literal">$query</code> using the <code class="literal">andWhere</code> method, passing an operator, field name, and value. For a more concise form of the actioned content, we put a filtered field in the loop, because they have the same redundant structure (operator and value):</p><div class="informalexample"><pre class="programlisting">    public function actionIndexFiltered()
    {
        $query = Room::find();
        
        $searchFilter = [
            'floor' =&gt; ['operator' =&gt; '', 'value' =&gt; ''],
            'room_number' =&gt; ['operator' =&gt; '', 'value' =&gt; ''],
            'price_per_day' =&gt; ['operator' =&gt; '', 'value' =&gt; ''],
        ];
        
        if(isset($_POST['SearchFilter']))
        {
            $fieldsList = ['floor', 'room_number', 'price_per_day'];
            
            foreach($fieldsList as $field)
            {
                $fieldOperator = $_POST['SearchFilter'][$field]['operator'];
                $fieldValue = $_POST['SearchFilter'][$field]['value'];
                
                $searchFilter[$field] = ['operator' =&gt; $fieldOperator, 'value' =&gt; $fieldValue];
                
                if( $fieldValue != '' )
                {
                    $query-&gt;andWhere([$fieldOperator, $field, $fieldValue]);
                }
            }
        }
        
        $rooms = $query-&gt;all();
        
        return $this-&gt;render('indexFiltered', [ 'rooms' =&gt; $rooms, 'searchFilter' =&gt; $searchFilter ]);
        
    }</pre></div><p>Finally, we need to <a id="id239" class="indexterm"/>display the results in a table format. So at the bottom<a id="id240" class="indexterm"/> of the view, add a table to display the content of the filtered rooms (copied from <code class="literal">basic/views/rooms/index.php</code>):</p><div class="informalexample"><pre class="programlisting">&lt;table class="table"&gt;
    &lt;tr&gt;
        &lt;th&gt;Floor&lt;/th&gt;
        &lt;th&gt;Room number&lt;/th&gt;
        &lt;th&gt;Has conditioner&lt;/th&gt;
        &lt;th&gt;Has tv&lt;/th&gt;
        &lt;th&gt;Has phone&lt;/th&gt;
        &lt;th&gt;Available from&lt;/th&gt;
        &lt;th&gt;Available from (db format)&lt;/th&gt;
        &lt;th&gt;Price per day&lt;/th&gt;
        &lt;th&gt;Description&lt;/th&gt;
    &lt;/tr&gt;
    &lt;?php foreach($rooms as $item) { ?&gt;
    &lt;tr&gt;
        &lt;td&gt;&lt;?php echo $item['floor'] ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo $item['room_number'] ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asBoolean($item['has_conditioner']) ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asBoolean($item['has_tv']) ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo ($item['has_phone'] == 1)?'Yes':'No' ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($item['available_from']) ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($item['available_from'], 'php:Y-m-d') ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asCurrency($item['price_per_day'], 'EUR') ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo $item['description'] ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;?php } ?&gt;
&lt;/table&gt;</pre></div><p>Now point the <a id="id241" class="indexterm"/>browser to <code class="literal">http://hostname/basic/web/rooms/index-filtered</code> and this should be <a id="id242" class="indexterm"/>displayed:</p><div class="mediaobject"><img src="graphics/B04656_05_05.jpg" alt="Example – query rooms list with ActiveRecord"/><div class="caption"><p>A list of rooms with filters</p></div></div><p>We can create tests by changing the filter values and operators as much as we want.</p></div></div>
<div class="section" title="Working with relationships"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec38"/>Working with relationships</h1></div></div></div><p>ActiveRecord <a id="id243" class="indexterm"/>provides us with skills to work with relationships between database tables. Yii2 employs two methods to establish the relationship between the current and other ActiveRecord classes: <code class="literal">hasOne</code> and <code class="literal">hasMany</code>, which return an ActiveQuery based on the multiplicity of the relationship.</p><p>The first method <code class="literal">hasOne()</code> returns at most one related record that matches the criteria set by this relationship, and <code class="literal">hasMany()</code> returns multiple related records that match the criteria set by this relationship.</p><p>Both methods require that the first parameter is the class name of the related ActiveRecord and that the second parameter is the pair of primary keys that are involved in the relationship: the first key is relative to a foreign ActiveRecord and the second key is related to the current ActiveRecord.</p><p>Usually, <code class="literal">hasOne()</code> and <code class="literal">hasMany()</code> are accessed from properties that identify which object (or objects) will be returned.</p><p>The <a id="id244" class="indexterm"/>method in this example is:</p><div class="informalexample"><pre class="programlisting">class Room extends ActiveRecord
{
    public function getReservations()
    {
return $this-&gt;hasMany(Reservation::className(), ['room_id' =&gt; 'id']);
    }
}</pre></div><p>By calling <code class="literal">$room-&gt;reservations</code>, framework will execute this query:</p><div class="informalexample"><pre class="programlisting">SELECT * FROM `reservation` WHERE `room_id` = id_of_room_model</pre></div><p>The use of the <code class="literal">hasOne()</code> method is similar, and as an example will look like this:</p><div class="informalexample"><pre class="programlisting">class Reservation extends ActiveRecord
{
    public function getRoom()
    {
return $this-&gt;hasOne(Room::className(), ['id' =&gt; 'room_id']);
    }
}</pre></div><p>Calling <code class="literal">$reservation-&gt;room</code>, framework will execute this query:</p><div class="informalexample"><pre class="programlisting">SELECT * FROM `room` WHERE `id` = reservation_id</pre></div><p>Remember that when we call a property that contains the <code class="literal">hasOne()</code> or <code class="literal">hasMany()</code> methods, a SQL query will be executed and its response will be cached. So, the next time that we call the property, a SQL query will not be executed and the last cached response will be released.</p><p>This approach to get related data is called <a id="id245" class="indexterm"/><span class="strong"><strong>lazy loading</strong></span>, which means that data is loaded only when it is effectively requested.</p><p>Now let's write an example to display the last reservation details about a room. Create a reservations model class using Gii if you have not done so before.</p><p>First of all, we need some data to work with. Insert this record in the <code class="literal">customer</code> table:</p><div class="informalexample"><pre class="programlisting">INSERT INTO `customer` (`id` ,`name` ,`surname` ,`phone_number`) VALUES ( NULL , 'James', 'Foo', '+39-12345678');</pre></div><p>In the <code class="literal">reservation</code> table, insert these records:</p><div class="informalexample"><pre class="programlisting">INSERT INTO `reservation` (`id`, `room_id`, `customer_id`, `price_per_day`, `date_from`, `date_to`, `reservation_date`) VALUES (NULL, '2', '1', '90', '2015-04-01', '2015-05-06', NULL), (NULL, '2', '1', '48', '2019-08-27', '2019-08-31', CURRENT_TIMESTAMP);</pre></div><p>Open the room <a id="id246" class="indexterm"/>model in <code class="literal">basic/models/Room.php</code> and append this property declaration at the bottom of the file:</p><div class="informalexample"><pre class="programlisting">    public function getLastReservation()
    {
        return $this-&gt;hasOne(
          Reservation::className(),
          ['room_id' =&gt; 'id']
          )
          -&gt;orderBy('id');
    }</pre></div><p>As said before, <code class="literal">hasOne()</code> and <code class="literal">hasMany()</code> return an ActiveQuery instance. We can append any methods to complete the relationship as we have done before by appending the <code class="literal">orderBy()</code> method to get the first record.</p><p>Create a new action named <code class="literal">actionLastReservationByRoomId($room_id)</code> in the <code class="literal">Rooms</code> controller, with the following content:</p><div class="informalexample"><pre class="programlisting">    public function actionLastReservationByRoomId($room_id)
    {
        $room = Room::findOne($room_id);
        
        // equivalent to
        // SELECT * FROM reservation WHERE room_id = $room_id
        $lastReservation = $room-&gt;lastReservation;
        
        // next times that we will call $room-&gt;reservation, no sql query will be executed.
        
        return $this-&gt;render('lastReservationByRoomId', ['room' =&gt; $room, 'lastReservation' =&gt; $lastReservation]);
    }
    Finally, create the view in basic/views/rooms/lastReservationByRoomId.php with this content:&lt;table class="table"&gt;
    &lt;tr&gt;
        &lt;th&gt;Room Id&lt;/th&gt;
        &lt;td&gt;&lt;?php echo $lastReservation['room_id'] ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
        &lt;th&gt;Customer Id&lt;/th&gt;
        &lt;td&gt;&lt;?php echo $lastReservation['customer_id'] ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
        &lt;th&gt;Price per day&lt;/th&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asCurrency($lastReservation['price_per_day'], 'EUR') ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
        &lt;th&gt;Date from&lt;/th&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($lastReservation['date_from'], 'php:Y-m-d') ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
        &lt;th&gt;Date to&lt;/th&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($lastReservation['date_to'], 'php:Y-m-d') ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
        &lt;th&gt;Reservation date&lt;/th&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($lastReservation['reservation_date'], 'php:Y-m-d H:i:s') ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;</pre></div><p>Point your <a id="id247" class="indexterm"/>browser to <code class="literal">http://hostname/basic/web/rooms/last-reservation-by-room-id?room_id=2</code> to visualize this frame:</p><div class="mediaobject"><img src="graphics/B04656_05_06.jpg" alt="Working with relationships"/><div class="caption"><p>A visualization of the last reservation of a room with id = 2</p></div></div><p>Only the last reservation inserted in the database will be displayed.</p><p>What about displaying all the last reservations for each room in a single table?</p><p>Here, the lazy <a id="id248" class="indexterm"/>loading approach will have performance issues because for every room, it will execute a single SQL query to get data for the last reservation. This is a code snippet in the view:</p><div class="informalexample"><pre class="programlisting">for($roomsList as $room)
{
    // SELECT * FROM reservation WHERE room_id = $room-&gt;id
      $lastReservation = $room-&gt;lastReservation;
}</pre></div><p>In order to complete the script's execution, it will execute as many related SQL queries as the number of rooms, and when the number of rooms grows, this solution will not be efficient anymore.</p><p>The Yii2 framework provides another type of loading data, named eager loading, to solve this kind of problem.</p><p>Eager loading is applied using the <code class="literal">with()</code> method of ActiveQuery. This method's parameters can be either one or multiple strings, or a single array of relation names and the optional callbacks to customize the relationships.</p><p>When we get a rooms list, if we apply the <code class="literal">with()</code> method to the query, a second SQL query will automatically be executed and this will return the list of the last reservations for each room.</p><p>With this example, we will get a rooms list and a list of the <code class="literal">lastReservation</code> relation for each room entry. In this way, when we refer to <code class="literal">$room-&gt;lastReservation</code>, no other SQL query will be executed:</p><div class="informalexample"><pre class="programlisting">// SELECT * FROM `room`
// SELECT * FROM `reservation` WHERE `room_id` IN ( room_id list from previous select ) ORDER BY `id` DESC
$rooms = Room::find()
-&gt;with('lastReservation')
-&gt;all();

// no query will be executed
$lastReservation = $rooms[0]-&gt;lastReservation;</pre></div><p>Let's write a complete example to get a full list of the last reservations for each room. In <code class="literal">basic/controllers/RoomsController.php</code>, append a new action named <code class="literal">actionLastReservationForEveryRoom()</code>:</p><div class="informalexample"><pre class="programlisting">    public function actionLastReservationForEveryRoom()
    {
            $rooms = Room::find()
            -&gt;with('lastReservation')
            -&gt;all();
        
            return $this-&gt;render('lastReservationForEveryRoom', ['rooms' =&gt; $rooms]);
    }</pre></div><p>This action <a id="id249" class="indexterm"/>will pass a list of rooms named <code class="literal">lastReservationForEveryRoom</code> to the view, together with the <code class="literal">lastReservation</code> relation loaded using the eager loading.</p><p>Create a view named <code class="literal">lastReservationForEveryRoom.php</code> in <code class="literal">basic/views/rooms/lastReservationForEveryRoom.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;table class="table"&gt;
    &lt;tr&gt;
        &lt;th&gt;Room Id&lt;/th&gt;
        &lt;th&gt;Customer Id&lt;/th&gt;
        &lt;th&gt;Price per day&lt;/th&gt;
        &lt;th&gt;Date from&lt;/th&gt;
        &lt;th&gt;Date to&lt;/th&gt;
        &lt;th&gt;Reservation date&lt;/th&gt;
    &lt;/tr&gt;
    &lt;?php foreach($rooms as $room) { ?&gt;
    &lt;?php $lastReservation = $room-&gt;lastReservation; ?&gt;
    &lt;tr&gt;
        &lt;td&gt;&lt;?php echo $lastReservation['room_id'] ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo $lastReservation['customer_id'] ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asCurrency($lastReservation['price_per_day'], 'EUR') ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($lastReservation['date_from'], 'php:Y-m-d') ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($lastReservation['date_to'], 'php:Y-m-d') ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($lastReservation['reservation_date'], 'php:Y-m-d H:i:s') ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;?php } ?&gt;
&lt;/table&gt;</pre></div><p>In this view, the<a id="id250" class="indexterm"/> last reservation data will be displayed for each room. Since the first room has no reservations, an empty row will be displayed. This is the result:</p><div class="mediaobject"><img src="graphics/B04656_05_07.jpg" alt="Working with relationships"/><div class="caption"><p>Last reservation for every room</p></div></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note31"/>Note</h3><p>There are two variants to the <code class="literal">with()</code> method: <code class="literal">joinWith()</code> and <code class="literal">innerJoinWith()</code>, which apply a left join or an inner join to a primary query.</p><p>For example, this is the use of <code class="literal">joinWith()</code> with:</p><div class="informalexample"><pre class="programlisting">            $rooms = Room::find()
            -&gt;leftJoinWith('lastReservation')
            -&gt;all();</pre></div><p>The preceding code snippet is equivalent to:</p><div class="informalexample"><pre class="programlisting">SELECT `room`.* FROM `room` LEFT JOIN `reservation` ON `room`.`id` = `reservation`.`room_id` ORDER BY `id` DESC

SELECT * FROM `reservation` WHERE `room_id` IN ( room_id list from previous sql respone ) ORDER BY `id` DESC</pre></div><p>Remember that the inner join selects all rows from both tables as long as there is a match between the columns in both tables; instead, the left join returns all rows from the left table (room), with the matching rows in the right table (reservation). The result is NULL in the right side when there is no match.</p></div></div><p>Sometimes it happens that we need more than one level of relationship between tables. For example, we could find a customer related to a room. In this case, starting from the room, we pass through the reservation and go from the reservation to the customer.</p><p>The relationship here will be:</p><div class="informalexample"><pre class="programlisting">room -&gt; reservation -&gt; customer</pre></div><p>If we want to find out the customer object from the room object, just type:</p><div class="informalexample"><pre class="programlisting">$customer = $room-&gt;customer;</pre></div><p>Generally, we have more levels of relationship, but in this case only two (reservation and customer).</p><p>Yii2 allows us to <a id="id251" class="indexterm"/>specify a junction table using the <code class="literal">via()</code> or <code class="literal">viaTable()</code> method. The first one, <code class="literal">via()</code>, is based on an existing relationship in the model, and it supports two parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Relation name</li><li class="listitem" style="list-style-type: disc">A PHP callback parameter to customize the associated relation</li></ul></div><p>The second method, <code class="literal">viaTable()</code>, is based on direct access to a physical table in the database and supports three parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The first parameter is a relation or table name</li><li class="listitem" style="list-style-type: disc">The second parameter is the link associated with the primary model</li><li class="listitem" style="list-style-type: disc">The third parameter is a PHP callback to customize the associated relation</li></ul></div><div class="section" title="Example – using a relationship to connect rooms, reservations, and customers"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec27"/>Example – using a relationship to connect rooms, reservations, and customers</h2></div></div></div><p>In this example, we will look at how<a id="id252" class="indexterm"/> to build a single view that displays the rooms, reservations, and customers lists at the same time; when a user clicks on the <span class="strong"><strong>Detail</strong></span> button of rooms record, the  reservations list will be filtered with data linked to that room. In the same way, when a user clicks on the <span class="strong"><strong>Detail</strong></span> button of a reservations record, the customers list will be filtered with data linked to that reservation.</p><p>If no parameter is passed (a condition that occurs when a page is called for the first time), either the rooms, reservations, or customers list contains a full record of data from the respective tables.</p><p>Start writing <code class="literal">actionIndexWithRelationships</code> in <code class="literal">basic/controllers/RoomsController.php</code>. This is the task list for this action:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Check which parameter of detail has been passed (<code class="literal">room_id</code> identifies that the reservations list has to be filled in with the data filtered using <code class="literal">room_id</code>, while <code class="literal">reservation_id</code> identifies that the customers list has to be filled with the data filtered using <code class="literal">reservation_id</code>)</li><li class="listitem" style="list-style-type: disc">Fill in three models: <code class="literal">roomSelected</code>, <code class="literal">reservationSelected</code>, and <code class="literal">customerSelected</code> to display the details and fill in three arrays of models: <code class="literal">rooms</code>, <code class="literal">reservations</code>, and <code class="literal">customers</code></li></ul></div><p>This is the <a id="id253" class="indexterm"/>complete content of<code class="literal"> actionIndexWithRelationships</code>:</p><div class="informalexample"><pre class="programlisting">     public function actionIndexWithRelationships()
    {
        // 1. Check what parameter of detail has been passed
        $room_id = Yii::$app-&gt;request-&gt;get('room_id', null);
        $reservation_id = Yii::$app-&gt;request-&gt;get('reservation_id', null);
        $customer_id = Yii::$app-&gt;request-&gt;get('customer_id', null);
        
        // 2. Fill three models: roomSelected, reservationSelected and customerSelected and
        //    Fill three arrays of models: rooms, reservations and customers;
        $roomSelected = null;
        $reservationSelected = null;
        $customerSelected = null;
        
        if($room_id != null)
        {
            $roomSelected = Room::findOne($room_id);
            
            $rooms = array($roomSelected);
            $reservations = $roomSelected-&gt;reservations;
            $customers = $roomSelected-&gt;customers;
        }
        else if($reservation_id != null)
        {
            $reservationSelected = Reservation::findOne($reservation_id);
            
            $rooms = array($reservationSelected-&gt;room);
            $reservations = array($reservationSelected);
            $customers = array($reservationSelected-&gt;customer);
        }
        else if($customer_id != null)
        {
            $customerSelected = Customer::findOne($customer_id);
            
            $rooms = $customerSelected-&gt;rooms;
            $reservations = $customerSelected-&gt;reservations;
            $customers = array($customerSelected);
        }
        else
        {
            $rooms = Room::find()-&gt;all();
            $reservations = Reservation::find()-&gt;all();
            $customers = Customer::find()-&gt;all();
        }
        
        return $this-&gt;render('indexWithRelationships', ['roomSelected' =&gt; $roomSelected, 'reservationSelected' =&gt; $reservationSelected, 'customerSelected' =&gt; $customerSelected, 'rooms' =&gt; $rooms, 'reservations' =&gt; $reservations, 'customers' =&gt; $customers]);
    }</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note34"/>Note</h3><p>Remember to add the <code class="literal">use</code> keyword for <code class="literal">Customer</code> and <code class="literal">Reservation</code> classes at the top of the <code class="literal">RoomsController</code> file:</p><div class="informalexample"><pre class="programlisting">use app\models\Reservation;
use app\models\Customer;</pre></div></div></div><p>The second part of <a id="id254" class="indexterm"/>the action body requires more attention, because there are filled in selected models and list models in this specific position.</p><p>Only one parameter at a time can be selected between <code class="literal">$room_id</code>, <code class="literal">$reservation_id</code>, and <code class="literal">$customer_id</code>. When one of these three parameters is selected, three arrays of the <code class="literal">Room</code>, <code class="literal">Reservation</code>, and <code class="literal">Customer</code> model will be filled in, using the relationships in the model. For this purpose, models must have all the relationships employed in the previous code.</p><p>Let's make sure that all the relationships exist in the models.</p><p>The <code class="literal">Room</code> model in <code class="literal">basic/models/Room.php</code> must have both <code class="literal">getReservations()</code> and <code class="literal">getCustomers()</code> defined, which both use the <code class="literal">via()</code> method to handle the second level of relationship:</p><div class="informalexample"><pre class="programlisting">    public function getReservations()
    {
            return $this-&gt;hasMany(Reservation::className(), ['room_id' =&gt; 'id']);
    }
public function getCustomers()
    {
            return $this-&gt;hasMany(Customer::className(), ['id' =&gt; 'customer_id'])-&gt;via('reservations');
    }</pre></div><p>The <code class="literal">Reservation</code> model in <code class="literal">basic/models/Reservation.php</code> must have <code class="literal">getCustomer()</code> and <code class="literal">getRoom()</code>, both returning a single related model:</p><div class="informalexample"><pre class="programlisting">    public function getRoom()
    {
            return $this-&gt;hasOne(Room::className(), ['id' =&gt; 'room_id']);
    }

    public function getCustomer()
    {
            return $this-&gt;hasOne(Customer::className(), ['id' =&gt; 'customer_id']);
    }</pre></div><p>Finally, the <code class="literal">Customer</code> model<a id="id255" class="indexterm"/> in <code class="literal">basic/models/Customer.php</code> must have <code class="literal">getReservations()</code> and <code class="literal">getRooms()</code>, which use the <code class="literal">via()</code> method to handle the second level of relationship:</p><div class="informalexample"><pre class="programlisting">    public function getReservations()
    {
            return $this-&gt;hasMany(Reservation::className(), ['customer_id' =&gt; 'id']);
    }
    
    public function getRooms()
    {
            return $this-&gt;hasMany(Room::className(), ['id' =&gt; 'room_id'])-&gt;via('reservations');
    }</pre></div><p>Now write a view file in <code class="literal">basic/view/rooms/indexWithRelationships.php</code>. We will split the HTML page into three parts (three tables), using the CSS provided by Bootstrap (which we will examine widely in the next few chapters).</p><p>The first table will be for the rooms list, the second table for the reservations list, and the last one for the customers list:</p><div class="informalexample"><pre class="programlisting">&lt;?php
use yii\helpers\Url;
?&gt;

&lt;a class="btn btn-danger" href="&lt;?php echo Url::to(['index-with-relationships']) ?&gt;"&gt;Reset&lt;/a&gt;

&lt;br /&gt;&lt;br /&gt;
&lt;div class="row"&gt;
    &lt;div class="col-md-4"&gt;
        &lt;legend&gt;Rooms&lt;/legend&gt;
        &lt;table class="table"&gt;
            &lt;tr&gt;
                &lt;th&gt;#&lt;/th&gt;
                &lt;th&gt;Floor&lt;/th&gt;
                &lt;th&gt;Room number&lt;/th&gt;
                &lt;th&gt;Price per day&lt;/th&gt;
            &lt;/tr&gt;
            &lt;?php foreach($rooms as $room) { ?&gt;
            &lt;tr&gt;
                &lt;td&gt;&lt;a class="btn btn-primary btn-xs" href="&lt;?php echo Url::to(['index-with-relationships', 'room_id' =&gt; $room-&gt;id]) ?&gt;"&gt;detail&lt;/a&gt;&lt;/td&gt;
                &lt;td&gt;&lt;?php echo $room['floor'] ?&gt;&lt;/td&gt;
                &lt;td&gt;&lt;?php echo $room['room_number'] ?&gt;&lt;/td&gt;
                &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asCurrency($room['price_per_day'], 'EUR') ?&gt;&lt;/td&gt;
            &lt;/tr&gt;
            &lt;?php } ?&gt;
        &lt;/table&gt;
        
        &lt;?php if($roomSelected != null) { ?&gt;
            &lt;div class="alert alert-info"&gt;
                &lt;b&gt;You have selected Room #&lt;?php echo $roomSelected-&gt;id ?&gt;&lt;/b&gt;
            &lt;/div&gt;
        &lt;?php } else { ?&gt;
            &lt;i&gt;No room selected&lt;/i&gt;
        &lt;?php } ?&gt;
    &lt;/div&gt;
    
    &lt;div class="col-md-4"&gt;
        &lt;legend&gt;Reservations&lt;/legend&gt;
        &lt;table class="table"&gt;
            &lt;tr&gt;
                &lt;th&gt;#&lt;/th&gt;
                &lt;th&gt;Price per day&lt;/th&gt;
                &lt;th&gt;Date from&lt;/th&gt;
                &lt;th&gt;Date to&lt;/th&gt;
            &lt;/tr&gt;
            &lt;?php foreach($reservations as $reservation) { ?&gt;
            &lt;tr&gt;
                &lt;td&gt;&lt;a class="btn btn-primary btn-xs" href="&lt;?php echo Url::to(['index-with-relationships', 'reservation_id' =&gt; $reservation-&gt;id]) ?&gt;"&gt;detail&lt;/a&gt;&lt;/td&gt;
                &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asCurrency($reservation['price_per_day'], 'EUR') ?&gt;&lt;/td&gt;
                &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($reservation['date_from'], 'php:Y-m-d') ?&gt;&lt;/td&gt;
                &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($reservation['date_to'], 'php:Y-m-d') ?&gt;&lt;/td&gt;
            &lt;/tr&gt;
            &lt;?php } ?&gt;
        &lt;/table&gt;
        
        &lt;?php if($reservationSelected != null) { ?&gt;
            &lt;div class="alert alert-info"&gt;
                &lt;b&gt;You have selected Reservation #&lt;?php echo $reservationSelected-&gt;id ?&gt;&lt;/b&gt;
            &lt;/div&gt;
        &lt;?php } else { ?&gt;
            &lt;i&gt;No reservation selected&lt;/i&gt;
        &lt;?php } ?&gt;
         
    &lt;/div&gt;
    &lt;div class="col-md-4"&gt;
        &lt;legend&gt;Customers&lt;/legend&gt;
        &lt;table class="table"&gt;
            &lt;tr&gt;
                &lt;th&gt;#&lt;/th&gt;
                &lt;th&gt;Name&lt;/th&gt;
                &lt;th&gt;Surname&lt;/th&gt;
                &lt;th&gt;Phone&lt;/th&gt;
            &lt;/tr&gt;
            &lt;?php foreach($customers as $customer) { ?&gt;
            &lt;tr&gt;
                &lt;td&gt;&lt;a class="btn btn-primary btn-xs" href="&lt;?php echo Url::to(['index-with-relationships', 'customer_id' =&gt; $customer-&gt;id]) ?&gt;"&gt;detail&lt;/a&gt;&lt;/td&gt;
                &lt;td&gt;&lt;?php echo $customer['name'] ?&gt;&lt;/td&gt;
                &lt;td&gt;&lt;?php echo $customer['surname'] ?&gt;&lt;/td&gt;
                &lt;td&gt;&lt;?php echo $customer['phone_number'] ?&gt;&lt;/td&gt;
            &lt;/tr&gt;
            &lt;?php } ?&gt;
        &lt;/table&gt;
        
        &lt;?php if($customerSelected != null) { ?&gt;
            &lt;div class="alert alert-info"&gt;
                &lt;b&gt;You have selected Customer #&lt;?php echo $customerSelected-&gt;id ?&gt;&lt;/b&gt;
            &lt;/div&gt;
        &lt;?php } else { ?&gt;
            &lt;i&gt;No customer selected&lt;/i&gt;
        &lt;?php } ?&gt;        
    &lt;/div&gt;   
&lt;/div&gt;</pre></div><p>Test the code by pointing<a id="id256" class="indexterm"/> your browser to <code class="literal">http://hostname/basic/rooms/index-with-relationships</code>. This should be the result of trying to filter a room on the second floor:</p><div class="mediaobject"><img src="graphics/B04656_05_08.jpg" alt="Example – using a relationship to connect rooms, reservations, and customers"/><div class="caption"><p>Rooms with relationships between reservations and customers</p></div></div></div></div>
<div class="section" title="How to save a model from a form"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec39"/>How to save a model from a form</h1></div></div></div><p>Let's now look at how to save a model from a form, which could be a new or an updated model.</p><p>The steps you need to follow are:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">action</code> method, create a new model or get an existing model.</li><li class="listitem">In the <code class="literal">action</code> method, check whether there is data in the <code class="literal">$_POST</code> array.</li><li class="listitem">If there is data in <code class="literal">$_POST</code>, fill in the <code class="literal">attributes</code> property of the model with data from <code class="literal">$_POST</code> and call the <code class="literal">save()</code> method of the model; if <code class="literal">save()</code> returns true, redirect the user to another page (the details page, for example).</li></ol></div><p>From now on, we will continue to use widgets and helper classes provided by the framework. In this case, the HTML form will be rendered using the <code class="literal">yii\widget\ActiveForm</code> class.</p><p>The most simple form we can write is the following:</p><div class="informalexample"><pre class="programlisting">&lt;?php
use yii\widgets\ActiveForm;

$form = ActiveForm::begin([
    'id' =&gt; 'login-form',
]) ?&gt;
    …
    …
    …
&lt;?php ActiveForm::end() ?&gt;</pre></div><p>This code <a id="id257" class="indexterm"/>generates a form HTML tag with <code class="literal">login-form</code> as the <code class="literal">id</code> attribute and empty content; the <code class="literal">method</code> and <code class="literal">action</code> attributes are respectively, by default, the post and same action URL that generated the form. Other properties about AJAX validation and client validation can be set, as you will see further on.</p><p>The widget <code class="literal">$form</code> is created by employing a static method <code class="literal">ActiveForm::begin</code>, passing as an array that contains attributes of a form HTML tag (<code class="literal">id</code>, <code class="literal">action</code>, <code class="literal">method</code>, and so on) a configuration parameter and a key named <code class="literal">options</code> to specify all the extra options that we want to pass to form the HTML tag. Finally, the form will be completed when we call the static method <code class="literal">ActiveForm::end()</code>. Between the <code class="literal">begin()</code> and <code class="literal">end()</code> methods of the form, we can insert all the content needed.</p><p>In particular, the input fields of the form can be managed using the ActiveField widget. The ActiveField widget related to an attribute of model is created by calling the <code class="literal">field()</code> method of the <code class="literal">$form</code> object:</p><div class="informalexample"><pre class="programlisting">$field = $form-&gt;field($model, 'attribute');</pre></div><p>The object returned from the <code class="literal">field()</code> method is a generic field that we can specialize by simply applying other methods to generate all the common kinds of input fields: hidden, text, password, file, and so on. This returns the same ActiveField <code class="literal">$field</code> object, and consequently other methods can be applied in a cascade.</p><p>A text field input is created with:</p><div class="informalexample"><pre class="programlisting">$textInputField = $field-&gt;textInput();</pre></div><p>Or can be created simply like this:</p><div class="informalexample"><pre class="programlisting">$textInputField = $form-&gt;field($model, 'attribute')-&gt;textInput();</pre></div><p>This variable <code class="literal">$textInputField</code> is again an ActiveField (the same object of <code class="literal">$field</code>), so we can apply all the other methods required to complete our input field; for example, if we need to place a hint in input field, we can use:</p><div class="informalexample"><pre class="programlisting">$textInputField-&gt;hint('Enter value');</pre></div><p>Or we can simply use:</p><div class="informalexample"><pre class="programlisting">$textInputField = $form-&gt;field($model, 'attribute')-&gt;textInput()-&gt;hint('Enter value');</pre></div><p>Additional framework in addition automatically takes into account the attribute's validation rules, which are defined in the <code class="literal">rules()</code> method of the model class. For example, if an attribute is required and we click on it and pass it to another field without typing anything, an error alert will be displayed reminding us that the field is required.</p><p>When an<a id="id258" class="indexterm"/> input field is created using the ActiveField widget, the <code class="literal">id</code> and <code class="literal">name</code> properties of this input will have this format: <code class="literal">model-class-name_attribute-name</code> for <code class="literal">id</code> and <code class="literal">model-class-name[attribute-name]</code> for <code class="literal">name</code>. This means that all the attributes of the model will be passed to the controller action when we submit the form grouped in a container array named the same as the model class.</p><p>For example, if the <code class="literal">$model</code> class is <code class="literal">Room</code> and the attribute is <code class="literal">floor</code> whose content is <code class="literal">12</code>, create a text field from the <code class="literal">$form</code> object:</p><div class="informalexample"><pre class="programlisting">&lt;?php echo $floorInputField = $form-&gt;field($model, 'floor')
-&gt;textInput()-&gt;hint('Enter value for floor');</pre></div><p>This outputs the following HTML:</p><div class="informalexample"><pre class="programlisting">&lt;input id="Room_floor" name="Room[floor]" value="12" placeholder="Enter value for floor" /&gt;</pre></div><div class="section" title="Example – creating and updating a room from a form"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec28"/>Example – creating and updating a room from a form</h2></div></div></div><p>Just from following <a id="id259" class="indexterm"/>the instructions in the previous paragraph, we will try to<a id="id260" class="indexterm"/> create and update a room from the HTML form.</p><p>We now update the previously created <code class="literal">actionCreate()</code> method in <code class="literal">RoomsController</code> with some code to instantiate a new model object, check the content of the <code class="literal">$_POST</code> array, and if it is set, we call <code class="literal">save()</code> on the model:</p><div class="informalexample"><pre class="programlisting">    public function actionCreate()
    {
        // 1. Create a new Room instance;
        $model = new Room();
        
        // 2. Check if $_POST['Room'] contains data;
        if(isset($_POST['Room']))
        {
            $model-&gt;attributes = $_POST['Room'];
            
            // Save model
            if($model-&gt;save())
            {
             // If save() success, redirect user to action view.
             return $this-&gt;redirect(['view', 'id' =&gt; $model-&gt;id]);
            }
        }

        return $this-&gt;render('create', ['model' =&gt; $model]);
    }</pre></div><p>To update the<a id="id261" class="indexterm"/> view<a id="id262" class="indexterm"/> in <code class="literal">basic/views/rooms/create.php</code>, pass:</p><div class="informalexample"><pre class="programlisting">&lt;?php
use yii\widgets\ActiveForm;
use yii\helpers\Html;
?&gt;
 
&lt;div class="row"&gt;

    &lt;div class="col-lg-6"&gt;
        
        &lt;h2&gt;Create a new room&lt;/h2&gt;
            
        &lt;?php $form = ActiveForm::begin(['id' =&gt; 'room-form']) ?&gt;

        &lt;?php echo $form-&gt;field($model, 'floor')-&gt;textInput(); ?&gt;
        &lt;?php echo $form-&gt;field($model, 'room_number')-&gt;textInput(); ?&gt;
        &lt;?php echo $form-&gt;field($model, 'has_conditioner')-&gt;checkbox(); ?&gt;
        &lt;?php echo $form-&gt;field($model, 'has_tv')-&gt;checkbox(); ?&gt;
        &lt;?php echo $form-&gt;field($model, 'has_phone')-&gt;checkbox(); ?&gt;
        &lt;?php echo $form-&gt;field($model, 'available_from')-&gt;textInput(); ?&gt;
        &lt;?php echo $form-&gt;field($model, 'price_per_day')-&gt;textInput(); ?&gt;
        &lt;?php echo $form-&gt;field($model, 'description')-&gt;textArea(); ?&gt;
        &lt;?php echo Html::submitButton('Save', ['class' =&gt; 'btn btn-primary']); ?&gt;
        &lt;?php ActiveForm::end() ?&gt;
    &lt;/div&gt;
&lt;/div&gt;</pre></div><p>By default, <code class="literal">ActiveForm::begin()</code> creates a form that has client validation enabled; therefore, the form will be submitted only when all the validation rules are satisfied as the <code class="literal">submit</code> button is rendered using <code class="literal">yii\helpers\Html</code>.</p><p>Pay attention<a id="id263" class="indexterm"/> to the top of view that contains the <code class="literal">use</code> keyword to define<a id="id264" class="indexterm"/> the complete path of the classes <code class="literal">Html</code> and <code class="literal">ActiveForm</code>:</p><div class="informalexample"><pre class="programlisting">use yii\widgets\ActiveForm;
use yii\helpers\Html;</pre></div><p>Point your browser to <code class="literal">http://hostname/basic/rooms/create</code> to display the form to create a new room. The following screenshot shows what you should display, reporting in it some particular conditions:</p><div class="mediaobject"><img src="graphics/B04656_05_09.jpg" alt="Example – creating and updating a room from a form"/><div class="caption"><p>The form to create a new room</p></div></div><p>This screenshot presents different states of fields: the floor input has a red border because it has the wrong type of content (it must be an integer!), the room number has a green border to indicate that is correct, and the <span class="strong"><strong>Available From</strong></span> field has a red border because it is required but the user left it blank. The framework provides a more concise form to fill in attributes if <code class="literal">$_POST</code> data is available:</p><div class="informalexample"><pre class="programlisting">$model-&gt;load(Yii::$app-&gt;request-&gt;post());</pre></div><p>This fills in the attributes of the model if the <code class="literal">$_POST[model-class]</code> content is available, and with this suggestion we can change the <code class="literal">actionCreate</code> content as follows:</p><div class="informalexample"><pre class="programlisting">    public function actionCreate()
    {
        // 1. Create a new Room instance;
        $model = new Room();
        
        // 2. Check if $_POST['Room'] contains data and save model;
        if( $model-&gt;load(Yii::$app-&gt;request-&gt;post()) &amp;&amp; ($model-&gt;save()) )
        {
            return $this-&gt;redirect(['detail', 'id' =&gt; $model-&gt;id]);
        }
        
        return $this-&gt;render('create', ['model' =&gt; $model]);
    }</pre></div><p>This is<a id="id265" class="indexterm"/> extraordinarily concise! Similarly, we can handle the <a id="id266" class="indexterm"/>update action to save changes to an existing model.</p><p>We can make a reusable form by putting its content in an external. Create a new file in <code class="literal">basic/views/rooms/_form.php</code> (the first underscore indicates that this is a view that is includable in other views) and cut and paste the code about form generation from the <code class="literal">create</code> view to this new <code class="literal">_form</code> view:</p><div class="informalexample"><pre class="programlisting">&lt;?php
use yii\widgets\ActiveForm;
use yii\helpers\Html;
?&gt;
&lt;?php $form = ActiveForm::begin(['id' =&gt; 'room-form']) ?&gt;

&lt;?php echo $form-&gt;field($model, 'floor')-&gt;textInput(); ?&gt;
&lt;?php echo $form-&gt;field($model, 'room_number')-&gt;textInput(); ?&gt;
&lt;?php echo $form-&gt;field($model, 'has_conditioner')-&gt;checkbox(); ?&gt;
&lt;?php echo $form-&gt;field($model, 'has_tv')-&gt;checkbox(); ?&gt;
&lt;?php echo $form-&gt;field($model, 'has_phone')-&gt;checkbox(); ?&gt;
&lt;?php echo $form-&gt;field($model, 'available_from')-&gt;textInput(); ?&gt;
&lt;?php echo $form-&gt;field($model, 'price_per_day')-&gt;textInput(); ?&gt;
&lt;?php echo $form-&gt;field($model, 'description')-&gt;textArea(); ?&gt;

&lt;?php echo Html::submitButton('Create', ['class' =&gt; 'btn btn-primary']); ?&gt;

&lt;?php ActiveForm::end() ?&gt;</pre></div><p>In the <code class="literal">basic/views/rooms/create.php</code> file, instead of the form code, just put the code to render the <code class="literal">_form</code> view in it:</p><div class="informalexample"><pre class="programlisting">&lt;?php echo $this-&gt;render('_form', ['model' =&gt; $model]); ?&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note35"/>Note</h3><p>When we modify the <code class="literal">create</code> view, remember to pass <code class="literal">$model</code> as the second parameter to render the <code class="literal">_form</code> view.</p></div></div><p>We are ready to<a id="id267" class="indexterm"/> build the update flow in order to update the room <a id="id268" class="indexterm"/>content from a form. Firstly, create an action in <code class="literal">basic/controllers/RoomsController.php</code> named <code class="literal">actionUpdate</code>, passing <code class="literal">$id</code> as a parameter that identifies the primary key to find the model.</p><p>In this action, we will put some code to get the model based on the <code class="literal">id</code> primary key, check whether the <code class="literal">$_POST</code> array contains data, and then save the model:</p><div class="informalexample"><pre class="programlisting">    public function actionUpdate($id)
    {
        // 1. Create a new Room instance;
        $model = Room::findOne($id);
        
        // 2. Check if $_POST['Room'] contains data and save model;
        if( ($model!=null) &amp;&amp; $model-&gt;load(Yii::$app-&gt;request-&gt;post()) &amp;&amp; ($model-&gt;save()) )
        {
            return $this-&gt;redirect(['detail', 'id' =&gt; $model-&gt;id]);
        }
        
        return $this-&gt;render('update', ['model' =&gt; $model]);
    }</pre></div><p>This is basically equivalent to the code for the <code class="literal">create</code> action. Now, create the <code class="literal">update</code> view in <code class="literal">basic/views/rooms/update.php</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;div class="row"&gt;

    &lt;div class="col-lg-6"&gt;
        
        &lt;h2&gt;Update a room&lt;/h2&gt;
        &lt;?php echo $this-&gt;render('_form', ['model' =&gt; $model]); ?&gt;
    &lt;/div&gt;

&lt;/div&gt;</pre></div><p>From the database, check for one existing room and type the <code class="literal">id</code> value of this URL in your browser: <code class="literal">http://hostname/basic/rooms/update?id=id-found</code>.</p><p>For example, if <code class="literal">id</code> of an existing room is <code class="literal">1</code>, type this URL in your browser:</p><p>
<code class="literal">http://hostname/basic/rooms/update?id=1</code>
</p><p>This will show <a id="id269" class="indexterm"/>a form with the filled in field based on the model attributes' content.</p><p>This example is <a id="id270" class="indexterm"/>complete, having built the <code class="literal">detail</code> view, which shows the content of model attributes. Create an action named <code class="literal">actionDetail</code>, passing <code class="literal">$id</code> as a parameter, which identifies the primary key to find the model:</p><div class="informalexample"><pre class="programlisting">    public function actionDetail($id)
    {
        // 1. Create a new Room instance;
        $model = Room::findOne($id);
        
        return $this-&gt;render('detail', ['model' =&gt; $model]);
    }</pre></div><p>Then, create the <code class="literal">detail</code> view to display some of the model attributes' values in <code class="literal">basic/views/rooms/detail.php</code>:</p><div class="informalexample"><pre class="programlisting">&lt;table class="table"&gt;
    &lt;tr&gt;
        &lt;th&gt;ID&lt;/th&gt;
        &lt;td&gt;&lt;?php echo $model['id'] ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
        &lt;th&gt;Floor&lt;/th&gt;
        &lt;td&gt;&lt;?php echo $model['floor'] ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
        &lt;th&gt;Room number&lt;/th&gt;
        &lt;td&gt;&lt;?php echo $model['room_number'] ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;</pre></div><p>Now after successfully creating or updating model, the detail view will be displayed with the content of some attributes of the model.</p></div></div>
<div class="section" title="Setting up the GMT time zone"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec40"/>Setting up the GMT time zone</h1></div></div></div><p>It is important to set the <a id="id271" class="indexterm"/>default time zone for date/time management.</p><p>Usually, when we refer to date/time, do not pay attention to which time zone value is being referred to.</p><p>For example, if we live in Rome and want to spend our next holiday in New York, when we receive the check-in date/time from the hotel, we must consider which time zone time is being referred to (whether local or remote).</p><p>When we display a date/time value that could be misunderstood, it is always recommended to add a time zone reference to it. The time zone is expressed through positive or negative hours compared to a reference that is usually<a id="id272" class="indexterm"/> <span class="strong"><strong>GMT</strong></span> (<span class="strong"><strong>Greenwich Mean Time</strong></span>).</p><p>For example, if it is 9 p.m. in Rome (GMT +1), in GMT time it will be 8 p.m. (GMT +0), 3 p.m. in New York (GMT -5), and finally 12 p.m. in Los Angeles (GMT -8).</p><p>Therefore, it is necessary to establish a common shared time value. For this purpose, it is advisable to use GMT as the time reference for all values and operations on values.</p><p>We need to configure the time zone in two environments:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In an application, set the <code class="literal">timeZone</code> attribute of a configuration; this will set the default time zone for all functions about the date and time</li><li class="listitem" style="list-style-type: disc">Some databases, such as MySQL, do not have internal management of time zones, so every value uses the default time zone of the database or the time zone configured during connection from the application to the database; we will set the default time zone during the connection to the database</li></ul></div><p>Complete the first step. Open <code class="literal">basic/config/web.php</code> and add the <code class="literal">timeZone</code> property with the <code class="literal">GMT</code> value in the <code class="literal">config</code> array, for example, after the <code class="literal">basePath</code> property:</p><div class="informalexample"><pre class="programlisting">    'timeZone' =&gt; 'GMT',</pre></div><p>The second step is setting the time zone for the database connections, if the database, such as MySQL, does not provide it. This is done globally by adding this code in the <code class="literal">on afterOpen</code> event. Open <code class="literal">basic/config/db.php</code> and append it as the last attribute in an array (usually the last attribute is <code class="literal">charset</code>):</p><div class="informalexample"><pre class="programlisting">'on afterOpen' =&gt; function($event) {
$event-&gt;sender-&gt;createCommand("SET time_zone = '+00:00'")-&gt;execute();
}</pre></div><p>This code means that once the connection with the database is opened, the SQL query <code class="literal">SET time_zone = +00:00</code> will be executed for every connection that we are going to establish with the database, and every date/time field value and function related to the GMT (+00:00) time zone will be considered.</p><p>Let's make a test. Create a <a id="id273" class="indexterm"/>new controller that simply displays the current date/time and time zone, in <code class="literal">basic/controllers/TestTimezoneController.php</code> with an action named <code class="literal">actionCheck()</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php

namespace app\controllers;

use Yii;
use yii\web\Controller;

class TestTimezoneController extends Controller
{
    public function actionCheck()
    {
        $dt = new \DateTime();
        echo 'Current date/time: '.$dt-&gt;format('Y-m-d H:i:s');
        echo '&lt;br /&gt;';
        echo 'Current timezone: '.$dt-&gt;getTimezone()-&gt;getName();
        echo '&lt;br /&gt;';
    }
}</pre></div><p>Point your browser to <code class="literal">http://hostname/basic/web/test-timezone/check</code>. This is what my browser displayed:</p><div class="informalexample"><pre class="programlisting">Current date/time: 2015-05-27 19:53:35
Current timezone: GMT</pre></div><p>And, the local time (in Rome) was 21:53:35, because Rome was then at +02:00 GMT due to daylight savings time.</p><p>If we comment the <code class="literal">timeZone</code> property in the app configuration in <code class="literal">basic/config/web.php</code>, we will see the default server time zone that is in my browser:</p><div class="informalexample"><pre class="programlisting">Current date/time: 2015-05-27 21:53:35
Current timezone: Europe/Rome</pre></div><p>This confirms that we have changed the default <code class="literal">timezone</code> property for all date/time functions. The last check to perform is on the database. Create a new action named <code class="literal">actionCheckDatabase</code> to verify that the database's default time zone for the current (and every) connection is GMT:</p><div class="informalexample"><pre class="programlisting">public function actionCheckDatabase()
{
        $result = \Yii::$app-&gt;db-&gt;createCommand('SELECT NOW()')-&gt;queryColumn();

        echo 'Database current date/time: '.$result[0];
}</pre></div><p>Point your browser to <code class="literal">http://hostname/basic/web/test-timezone/check-database</code>. This is what my browser displayed:</p><div class="informalexample"><pre class="programlisting">Database current date/time: 2015-05-27 20:12:08</pre></div><p>And the local time (in Rome) was 22:12:08, because Rome was then at +02:00 GMT.</p><p>Remember that, from <a id="id274" class="indexterm"/>now on, all date/time information displayed in a database refers to the GMT time zone, although this specification was missing (as we can see in the previous database's current date/time).</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip03"/>Tip</h3><p>Another strategy to handle the GMT time zone in a database's date/time column is to store the value as a timestamp, which is by definition an integer that indicates the number of seconds from 01/01/1970 at 00:00:00 in the GMT (UTC) time zone; so it is immediately understandable that field is a date/time with the GMT time zone, but remember that any database function applied to it will be executed using the database's default time zone.</p></div></div></div>
<div class="section" title="Using multiple database connections"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec41"/>Using multiple database connections</h1></div></div></div><p>Applications can require <a id="id275" class="indexterm"/>multiple database connections so that they can send and get data from different sources.</p><p>Using other database sources is incredibly simple. The only thing to do is to add a new database entry in the main configuration and use ActiveRecord support. All the operations on records will be transparent for the developer.</p><p>Here are some examples of connection strings (dsn) to configure access to other databases:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">MySQL and MariaDB: <code class="literal">mysql:host=localhost;dbname=mydatabase</code></li><li class="listitem" style="list-style-type: disc">SQLite: <code class="literal">sqlite:/path/to/database/file</code></li><li class="listitem" style="list-style-type: disc">PostgreSQL: <code class="literal">pgsql:host=localhost;port=5432;dbname=mydatabase</code></li><li class="listitem" style="list-style-type: disc">CUBRID: <code class="literal">cubrid:dbname=demodb;host=localhost;port=33000</code></li><li class="listitem" style="list-style-type: disc">MS SQL Server (via the <code class="literal">sqlsrv</code> driver): <code class="literal">sqlsrv:Server=localhost;Database=mydatabase</code></li><li class="listitem" style="list-style-type: disc">MS SQL Server (via the <code class="literal">dblib</code> driver): <code class="literal">dblib:host=localhost;dbname=mydatabase</code></li><li class="listitem" style="list-style-type: disc">MS SQL Server (via the <code class="literal">mssql</code> driver): <code class="literal">mssql:host=localhost;dbname=mydatabase</code></li><li class="listitem" style="list-style-type: disc">Oracle: <code class="literal">oci:dbname=//localhost:1521/mydatabase</code></li></ul></div><div class="section" title="Example – configuring a second DB connection to export data to a local SQLite DB"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec29"/>Example – configuring a second DB connection to export data to a local SQLite DB</h2></div></div></div><p>We now want to add a <a id="id276" class="indexterm"/>new database connection to a SQLite DB. When we use a database, we have to make sure that the PDO driver is installed in the system, otherwise PHP cannot handle it.</p><p>Open <code class="literal">basic/config/web.php</code> and the inner <code class="literal">components</code> attribute, and append a new attribute named <code class="literal">dbSqlite</code> with the following attributes:</p><div class="informalexample"><pre class="programlisting">        'dbSqlite' =&gt; [
            'class' =&gt; 'yii\db\Connection',
            'dsn' =&gt; 'sqlite:'.dirname(__DIR__).'/../db.sqlite',
        ],</pre></div><p>This entry will use a DB SQLite named <code class="literal">db.sqlite</code>, which we can find in the <code class="literal">dirname(__DIR__).'/../web/db.sqlite'</code> path, under the <code class="literal">/basic/web</code> folder. If this file does not exist, it will be created (if a write permission is present in the <code class="literal">/basic/web</code> folder).</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note36"/>Note</h3><p>Be sure that the <code class="literal">/basic/web</code> folder is writable, otherwise it will be impossible for the framework to create a <code class="literal">db.sqlite</code> file.</p></div></div><p>Create a new controller to handle actions in this new database. This will be put in <code class="literal">/basic/controllers/TestSqliteController.php</code>.</p><p>Insert the first action named <code class="literal">actionCreateRoomTable</code> in this new controller, which will create the same structure of the <code class="literal">Room</code> table from MySQL in <code class="literal">dbSqlite</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php

namespace app\controllers;

use Yii;
use yii\web\Controller;


class TestSqliteController extends Controller
{
    public function actionCreateRoomTable()
    {
        // Create room table
        $sql = 'CREATE TABLE IF NOT EXISTS room (id int not null, floor int not null, room_number int not null, has_conditioner int not null, has_tv int not null, has_phone int not null, available_from date not null, price_per_day float, description text)';
        \Yii::$app-&gt;dbSqlite-&gt;createCommand($sql)-&gt;execute();
        echo 'Room table created in dbSqlite';
    }
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note37"/>Note</h3><p>Pay attention so that in <code class="literal">actionCreateRoomTable</code>, the database instance is taken from: <code class="literal">\Yii::$app-&gt;dbSqlite</code>.</p></div></div><p>Point your <a id="id277" class="indexterm"/>browser to <code class="literal">http://hostname/basic/web/test-sqlite/create-room-table</code> and create a <code class="literal">db.sqlite</code> file in <code class="literal">basic/web</code> and a <code class="literal">room</code> table in it.</p><p>As we have mentioned before, if the PDO driver is correctly installed, a blank page with the <span class="strong"><strong>Room table created in dbSqlite</strong></span> text will be displayed.</p><p>Now we want to clone the room table from MySQL to SQLite to make a backup of this table. We need to save the records from MySQL to SQLite and verify the data stored to display it in a table.</p><p>Create a new action named <code class="literal">actionBackupRoomTable()</code> that executes these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a <code class="literal">room</code> table (if it does not exist).</li><li class="listitem">Delete all the records from the room in <code class="literal">dbSqlite</code> (alias truncate).</li><li class="listitem">Load all the records from the room table in MySQL (using ActiveRecord).</li><li class="listitem">Insert every single record from MySQL into SQLite.</li><li class="listitem">Render the view to display data from SQLite with the table (to verify that the copy succeeded).</li></ol></div><p>The content of the <code class="literal">actionBackupRoomTable()</code> action is:</p><div class="informalexample"><pre class="programlisting">    use app\models\Room;

    public function actionBackupRoomTable()
    {
        // Create room table
        $sql = 'CREATE TABLE IF NOT EXISTS room (id int not null, floor int not null, room_number int not null, has_conditioner int not null, has_tv int not null, has_phone int not null, available_from date not null, price_per_day float, description text)';
        \Yii::$app-&gt;dbSqlite-&gt;createCommand($sql)-&gt;execute();
        
        // Truncate room table in dbSqlite
        $sql = 'DELETE FROM room';
        \Yii::$app-&gt;dbSqlite-&gt;createCommand($sql)-&gt;execute();
        
        // Load all records from MySQL and insert every single record in dbqlite
        $models = Room::find()-&gt;all();
        
        foreach($models as $m)
        {
            \Yii::$app-&gt;dbSqlite-&gt;createCommand()-&gt;insert('room', $m-&gt;attributes)-&gt;execute();            
        }
        
        // Load all records from dbSqlite
        $sql = 'SELECT * FROM room';
        $sqliteModels = \Yii::$app-&gt;dbSqlite-&gt;createCommand($sql)-&gt;queryAll();
 
        return $this-&gt;render('backupRoomTable', ['sqliteModels' =&gt; $sqliteModels]);
   }</pre></div><p>Finally, create <a id="id278" class="indexterm"/>a view <code class="literal">backupRoomTable</code> in <code class="literal">basic/views/test-sqlite/backupRoomTable.php</code> with the following content to display data from <code class="literal">dbSqlite</code>:</p><div class="informalexample"><pre class="programlisting">&lt;h2&gt;Rooms from dbSqlite&lt;/h2&gt;

&lt;table class="table"&gt;
    &lt;tr&gt;
        &lt;th&gt;Floor&lt;/th&gt;
        &lt;th&gt;Room number&lt;/th&gt;
        &lt;th&gt;Has conditioner&lt;/th&gt;
        &lt;th&gt;Has tv&lt;/th&gt;
        &lt;th&gt;Has phone&lt;/th&gt;
        &lt;th&gt;Available from&lt;/th&gt;
        &lt;th&gt;Available from (db format)&lt;/th&gt;
        &lt;th&gt;Price per day&lt;/th&gt;
        &lt;th&gt;Description&lt;/th&gt;
    &lt;/tr&gt;
    &lt;?php foreach($sqliteModels as $item) { ?&gt;
    &lt;tr&gt;
        &lt;td&gt;&lt;?php echo $item['floor'] ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo $item['room_number'] ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asBoolean($item['has_conditioner']) ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asBoolean($item['has_tv']) ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo ($item['has_phone'] == 1)?'Yes':'No' ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($item['available_from']) ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asDate($item['available_from'], 'php:Y-m-d') ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo Yii::$app-&gt;formatter-&gt;asCurrency($item['price_per_day'], 'EUR') ?&gt;&lt;/td&gt;
        &lt;td&gt;&lt;?php echo $item['description'] ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;?php } ?&gt;
&lt;/table&gt;</pre></div><p>Navigate your <a id="id279" class="indexterm"/>browser to <code class="literal">http://hostname/basic/web/test-sqlite/backup-room-table</code>, which should display a similar output to this:</p><div class="mediaobject"><img src="graphics/B04656_05_10.jpg" alt="Example – configuring a second DB connection to export data to a local SQLite DB"/><div class="caption"><p>The list of rooms from the SQLite database</p></div></div><p>We can now download the <code class="literal">db.sqlite</code> file from <code class="literal">http://hostname/basic/web/db.sqlite</code> to preserve a backup copy of the room table!</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec42"/>Summary</h1></div></div></div><p>In this chapter, you mastered how to configure a database connection and execute SQL queries from scratch with DAO support of the framework. Next, you found out how to use Gii and got to know about the advantages it has in creating models from the database table structure. Gii creates models that extend the ActiveRecord class and through its use, you finally learned to manipulate data. All the examples are accompanied with a visualization grid that shows data, which is graphically enhanced by Bootstrap's presence in Yii2.</p><p>We carefully analyzed the common topic of tables' relationships, which must be managed in models and then displayed in views.</p><p>At the end of the chapter, after you learned to manipulate data with ActiveRecord, you wrote a complete flow to save data from a HTML form to a database. Finally, you learned the importance of setting the GMT time zone in date/time fields and using other database sources in the same application in order to make a backup of the primary database.</p><p>In the next chapter, you will learn to use and customize the grid widget to improve data visualization.</p></div></body></html>