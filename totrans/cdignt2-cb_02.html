<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;User Management"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. User Management</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Viewing users</li><li class="listitem" style="list-style-type: disc">Creating users</li><li class="listitem" style="list-style-type: disc">Editing users</li><li class="listitem" style="list-style-type: disc">Deleting users</li><li class="listitem" style="list-style-type: disc">Generating passwords with CodeIgniter</li><li class="listitem" style="list-style-type: disc">Generating passwords with CodeIgniter – the bare bones</li><li class="listitem" style="list-style-type: disc">Forgot password? – resetting passwords with CodeIgniter</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec16"/>Introduction</h1></div></div></div><p>Chances are that a lot of the sites and apps you'll build with CodeIgniter will need users, and there will be a need to manage them and their details directly, that is create, update, edit, and delete them.</p><p>In this chapter, we'll look at basic user management and, build a simple CRUD interface to manage and maintain those users in a database. Later, in <a class="link" href="ch07.html" title="Chapter 7. Creating a Secure User Environment">Chapter 7</a>, <span class="emphasis"><em>Creating a Secure User Environment</em></span>, we will be looking at securing your user information with login and session functionality, but for now, we will concentrate on building a user management interface.</p><p>Before we begin, we'll need to alter some settings in a couple of config files in the <code class="literal">application/config</code> folder. We'll be editing the following files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/config/config.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/config/database.php</code></li></ul></div><p>Find the following config values in the <code class="literal">path/to/codeigniter/application/config/config.php</code> file and amend them to reflect the following:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Config item</p>
</th><th style="text-align: left" valign="bottom">
<p>Change to</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_cookie_name']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">ci_session</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id34" class="indexterm"/>should be the name of the cookie written to the users computer.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_expiration']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">7200</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id35" class="indexterm"/>number of seconds a session should remain active after a period of no activity before becoming void.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_expire_on_close']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TRUE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This specifies <a id="id36" class="indexterm"/>that if the user closes their browser, the session becomes void.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_encrypt_cookie']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TRUE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This specifies <a id="id37" class="indexterm"/>that if the cookie should be encrypted on the user's computer; for security purposes, this should be set to <code class="literal">TRUE</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_use_database']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TRUE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id38" class="indexterm"/>specifies whether or not to store sessions in the database. For security purposes, this should be set to <code class="literal">TRUE</code>. You will also need to create the session table, which can be found in the <span class="emphasis"><em>Database schema</em></span> section.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_table_name']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">sessions</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id39" class="indexterm"/>specifies the name of the database table used to store session data.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_match_ip']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TRUE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id40" class="indexterm"/>specifies CodeIgniter should monitor the IP address of requests and against that of the <code class="literal">session_id</code>. If the IP of an incoming request doesn't match the previous values, the session is disallowed.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$config['sess_match_useragent']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TRUE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id41" class="indexterm"/>specifies CodeIgniter should monitor the user agent address of requests and against that of the <code class="literal">session_id</code>. If the user agent of an incoming request doesn't match the previous values, the session is disallowed.</p>
</td></tr></tbody></table></div><p>Find the following config values in the <code class="literal">path/to/codeigniter/application/config/database.php</code> file and amend them to reflect the following:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Config item</p>
</th><th style="text-align: left" valign="bottom">
<p>Change to value</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$db['default']['hostname']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">localhost</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The hostname of <a id="id42" class="indexterm"/>your database; this is usually either <code class="literal">localhost</code> or an IP address</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$db['default']['username']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>?</p>
</td><td style="text-align: left" valign="top">
<p>The username you <a id="id43" class="indexterm"/>wish to use to connect to your database</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$db['default']['password']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>?</p>
</td><td style="text-align: left" valign="top">
<p>The password <a id="id44" class="indexterm"/>used to connect to your database</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$db['default']['database']</code>
</p>
</td><td style="text-align: left" valign="top">
<p>?</p>
</td><td style="text-align: left" valign="top">
<p>The name of the <a id="id45" class="indexterm"/>database, which you wish to connect to, for example, <code class="literal">users</code>
</p>
</td></tr></tbody></table></div><div class="section" title="Database schema"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec20"/>Database schema</h2></div></div></div><p>Using the method of your <a id="id46" class="indexterm"/>choice (command line, phpmyadmin, and so on) enter the following code into your database:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `sessions` (
  `session_id` varchar(40) COLLATE utf8_bin NOT NULL DEFAULT '0',
  `ip_address` varchar(16) COLLATE utf8_bin NOT NULL DEFAULT '0',
  `user_agent` varchar(120) COLLATE utf8_bin DEFAULT NULL,
  `last_activity` int(10) unsigned NOT NULL DEFAULT '0',
  `user_data` text COLLATE utf8_bin NOT NULL,
  PRIMARY KEY (`session_id`),
  KEY `last_activity_idx` (`last_activity`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

CREATE TABLE `users` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `first_name` varchar(125) NOT NULL,
  `last_name` varchar(125) NOT NULL,
  `email` varchar(255) NOT NULL,
  `created_date` int(11) NOT NULL COMMENT 'unix timestamp',
  `is_active` varchar(3) NOT NULL COMMENT 'yes or no',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1;

INSERT INTO `users` (`id`, `first_name`, `last_name`, `email`, `created_date`, `is_active`) VALUES
(5, 'First Name', 'Last name', 'first@last.com', 0, '0');</pre></div><p>What are the columns for and what type of <a id="id47" class="indexterm"/>data will we store in them? The following table is a guide to the preceding database schema:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Item name</p>
</th><th style="text-align: left" valign="bottom">
<p>Attributes</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">user_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">INTEGER(11)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The table primary key.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">user_first_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">VARCHAR(125)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The user's first name.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">user_last_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">VARCHAR(125)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The user's last name.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">user_email</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">VARCHAR(255)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The user's e-mail address, for example, <code class="email">&lt;<a class="email" href="mailto:name@example.org">name@example.org</a>&gt;</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">user_created_date</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">INTEGER(11)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The unix timestamp for the date the user was created within the database.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">user_is_active</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">INTEGER(1)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The Boolean value represented as <code class="literal">0</code> or <code class="literal">1</code>, if the user is active. This variable specifies whether the user is active within the system. An active user can login, while inactive users cannot.</p>
</td></tr></tbody></table></div><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip03"/>Tip</h3><p>If you have already created a sessions table, then you can omit that table.</p></div></div></div></div></div>
<div class="section" title="Viewing users"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Viewing users</h1></div></div></div><p>A good place for us to begin is to <a id="id48" class="indexterm"/>display a list of our users. We're going to create a model, view, and controller to provide the  functionality to do this.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec21"/>How to do it...</h2></div></div></div><p>We're going to create the following three files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/models/users_model.php</code>: This file gives us CRUD support with the database</li><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/views/users/view_all_users.php</code>: This file contains a <code class="literal">foreach</code> loop, which runs through the results array, writing all users to a table</li><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/controllers/users.php</code>: This file contains the code necessary to handle the CRUD functionality</li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Copy the following code into the, <code class="literal">path/to/codeigniter/application/controllers/users.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed');

class Users extends CI_Controller {
    function __construct() {
        parent::__construct();
        $this-&gt;load-&gt;helper('form');
        $this-&gt;load-&gt;helper('url');
        $this-&gt;load-&gt;helper('security');
        $this-&gt;load-&gt;model('Users_model');
        $this-&gt;load-&gt;database();
    }
    
    public function index() {
        redirect('users/view_users');
    }
    
    public function view_users() {
        $data['query'] = $this-&gt;Users_model-&gt;get_all_users();
        $this-&gt;load-&gt;view('users/view_all_users', $data);
    }
}</pre></div></li><li class="listitem">Copy the following code <a id="id49" class="indexterm"/>into the, <code class="literal">path/to/codeigniter/application/models/users_model.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Users_model extends CI_Model {
    function __construct() {
        parent::__construct();
    }

    public function get_all_users() {
        return $this-&gt;db-&gt;get('users');
    }
}</pre></div></li><li class="listitem">Copy the following code into the, <code class="literal">path/to/codeigniter/application/views/users/view_all_users.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php if ($query-&gt;num_rows() &gt; 0 ) : ?&gt;
&lt;table border="0"&gt;
  &lt;tr&gt;
      &lt;td&gt;ID&lt;/td&gt;
      &lt;td&gt;First Name&lt;/td&gt;
      &lt;td&gt;Last Name&lt;/td&gt;
      &lt;td&gt;Created Date&lt;/td&gt;
      &lt;td&gt;Is Active&lt;/td&gt;
      &lt;td colspan="2"&gt;Actions&lt;/td&gt;
  &lt;/tr&gt;
  &lt;?php foreach ($query-&gt;result() as $row) : ?&gt;
  &lt;tr&gt;
      &lt;td&gt;&lt;?php echo $row-&gt;id; ?&gt;&lt;/td&gt;
      &lt;td&gt;&lt;?php echo $row-&gt;first_name; ?&gt;&lt;/td&gt;
      &lt;td&gt;&lt;?php echo $row-&gt;last_name; ?&gt;&lt;/td&gt;
      &lt;td&gt;&lt;?php echo date("d-m-Y", $row-&gt;created_date); ?&gt;&lt;/td&gt;
      &lt;td&gt;&lt;?php echo ($row-&gt;is_active ? 'Yes' : 'No'); ?&gt;&lt;/td&gt;
      &lt;td&gt;&lt;?php echo anchor('users/edit_user/'.$row-&gt;id, 'Edit') ; ?&gt;&lt;/td&gt;
      &lt;td&gt;&lt;?php echo anchor('users/delete_user/'.$row-&gt;id, 'Delete') ; ?&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;?php endforeach ; ?&gt;
&lt;/table&gt;
&lt;?php endif ; ?&gt;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec22"/>How it works...</h2></div></div></div><p>This is  fairly standard stuff and there's nothing complicated going on. We have a controller running the show, which loads some useful helpers to provide support with functions such as <code class="literal">redirect()</code>, <a id="id50" class="indexterm"/>other <a id="id51" class="indexterm"/>security functions, and the <code class="literal">Users_model</code> in its constructor. <code class="literal">public function index()</code> redirects to <code class="literal">public function view_users()</code>, which in turn connects to the, <code class="literal">get_all_users()</code>function in the, <code class="literal">Users_model model</code>, using the, <code class="literal">$this-&gt;Users_model-&gt;get_all_users()</code>syntax to return an Active Record result set. This result set is then passed to the, <code class="literal">users/view_all_users view</code>, where it is displayed in a <code class="literal">foreach</code> loop in a table. See...I told you it was simple!</p></div></div>
<div class="section" title="Creating users"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Creating users</h1></div></div></div><p>You will always need a method to <a id="id52" class="indexterm"/>create users yourself from within an application, and will need to; manually enter their data rather than the user entering the data themselves. We're going to build functionality to allow you to create users one by one.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec23"/>How to do it...</h2></div></div></div><p>We'll need to create one file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/views/users/new_user.php</code></li></ul></div><p>And amend the following two files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/controllers/users.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/models/users_model.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Copy the following code into the, <code class="literal">path/to/codeigniter/application/views/users/new_user.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php echo form_open('users/new_user') ; ?&gt;
  &lt;?php if (validation_errors()) : ?&gt;
    &lt;h3&gt;Whoops! There was an error:&lt;/h3&gt;
    &lt;p&gt;&lt;?php echo validation_errors(); ?&gt;&lt;/p&gt;
  &lt;?php endif; ?&gt;
  &lt;table border="0"&gt;
  &lt;tr&gt;
    &lt;td&gt;User First Name&lt;/td&gt;
    &lt;td&gt;&lt;?php echo form_input($first_name); ?&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;User Last Name&lt;/td&gt;
    &lt;td&gt;&lt;?php echo form_input($last_name); ?&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;User Email&lt;/td&gt;
    &lt;td&gt;&lt;?php echo form_input($email); ?&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;User Is Active?&lt;/td&gt;
    &lt;td&gt;&lt;?php echo form_checkbox($is_active); ?&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
    &lt;?php echo form_submit('submit', 'Create'); ?&gt;
    or &lt;?php echo anchor('users/index', 'cancel'); ?&gt;
&lt;?php echo form_close(); ?&gt;</pre></div></li><li class="listitem">Amend the, <code class="literal">path/to/codeigniter/application/controllers/users.php </code>file, with the following code:<div class="informalexample"><pre class="programlisting">    public function new_user() {
        // Load support assets
        $this-&gt;load-&gt;library('form_validation');
        $this-&gt;form_validation-&gt;set_error_delimiters('', '&lt;br /&gt;');

        // Set validation rules
        $this-&gt;form_validation-&gt;set_rules('first_name', 'First Name', 'required|min_length[1]|max_length[125]');
        $this-&gt;form_validation-&gt;set_rules('last_name', 'Last Name', 'required|min_length[1]|max_length[125]');
        $this-&gt;form_validation-&gt;set_rules('email', 'Email', 'required|min_length[1]|max_length[255]|valid_email');
        $this-&gt;form_validation-&gt;set_rules('is_active', 'Is Active', 'min_length[1]|max_length[1]|integer|is_natural');

        // Begin validation
        if ($this-&gt;form_validation-&gt;run() == FALSE) {
            // First load, or problem with form
            $data['first_name'] = array('name' =&gt; 'first_name', 'id' =&gt; 'first_name', 'value' =&gt; set_value('first_name', ''), 'maxlength'   =&gt; '100', 'size' =&gt; '35');
            $data['last_name'] = array('name' =&gt; 'last_name', 'id' =&gt; 'last_name', 'value' =&gt; set_value('last_name', ''), 'maxlength'   =&gt; '100', 'size' =&gt; '35');
            $data['email'] = array('name' =&gt; 'email', 'id' =&gt; 'email', 'value' =&gt; set_value('email', ''), 'maxlength'   =&gt; '100', 'size' =&gt; '35');
            $data['is_active'] = array('name' =&gt; 'is_active', 'id' =&gt; 'is_active', 'value' =&gt; set_value('is_active', ''));

            $this-&gt;load-&gt;view('users/new_user',$data);
        } else { // Validation passed, now escape the data
            $data = array(
                'first_name' =&gt; $this-&gt;input-&gt;post('first_name'),
                'last_name' =&gt; $this-&gt;input-&gt;post('last_name'),
                'email' =&gt; $this-&gt;input-&gt;post('email'),
                'is_active' =&gt; $this-&gt;input-&gt;post('is_active'),
            );

            if ($this-&gt;Users_model-&gt;process_create_user($data)) {
               redirect('users');
           }
        }
    }</pre></div></li><li class="listitem">Amend the, <code class="literal">path/to/codeigniter/application/models/users_model.php </code>file, with the following code:<div class="informalexample"><pre class="programlisting">    public function process_create_user($data) {
        if ($this-&gt;db-&gt;insert('users', $data)) {
          return true;
        } else {
          return false;
        }
    }</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec24"/>How it works...</h2></div></div></div><p>There's a little more going on here than with the preceding <code class="literal">view_users</code> code, but it's still simple and straightforward. <code class="literal">public function new_user()</code> performs several functions, such as loading the view file, to validating any data inputted after submission, and displaying a view.</p><p>If <code class="literal">public function new_user()</code> is <a id="id53" class="indexterm"/>being <a id="id54" class="indexterm"/>called for the first time (that is, it is not being called by a form submission), then the validation check (<code class="literal">$this-&gt;form_validation-&gt;run()</code>) will equal <code class="literal">FALSE</code> and the code within the parentheses will be executed. In this case, the code will load the, <code class="literal">cust/new_user </code>view.</p><p>However, if the function is loaded as the result of a form submission, then CodeIgniter will begin checking the user input. The first line of the function loads the necessary library to enable checking the user's input: <code class="literal">$this-&gt;library('form_validation')</code>, and our error delimiters are set with the function, <code class="literal">set_error_deimiters()</code>. Each item in the form is then checked against the criteria we specify. A full list of validation criteria options are available at: <a class="ulink" href="http://ellislab.com/codeigniter/user-guide/libraries/form_validation.html">http://ellislab.com/codeigniter/user-guide/libraries/form_validation.html</a>
</p><p>We will also discuss form validation in greater detail in <a class="link" href="ch05.html" title="Chapter 5. Managing Data In and Out">Chapter 5</a>, <span class="emphasis"><em>Managing Data In and Out</em></span>.</p><p>If validation isn't passed (the input from the user didn't meet the requirements we set), then <code class="literal">$this-&gt;form_validation-&gt;run()</code> will return <code class="literal">FALSE</code> and the form will be displayed again. The form elements in the view are able to display the user's input (so they don't have to re-enter everything from scratch).</p><p>Once validation is passed (<code class="literal">$this-&gt;form_validation-&gt;run()</code> returns <code class="literal">TRUE</code>), then we'll package up the input into an array: <code class="literal">$data</code>. As we're using Active Record to interact with the database, the keys of the <code class="literal">$data</code> array must match the column names of our database table.The <code class="literal">$data</code> array is then sent to the <code class="literal">Users_model</code> <a id="id55" class="indexterm"/>for writing to the database using the syntax: <code class="literal">$this-&gt;Users_model-&gt;get_all_users()</code>.</p></div></div>
<div class="section" title="Editing users"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec19"/>Editing users</h1></div></div></div><p>You will always need some method to <a id="id56" class="indexterm"/>edit users yourself from within an application. In this section, we will look at creating functionality to do just that: to update and edit user details.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec25"/>How to do it...</h2></div></div></div><p>We'll need to create one file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/views/users/edit_user.php</code></li></ul></div><p>And amend the following two files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/controllers/users.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/models/users_model.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Copy the following code to the, <code class="literal">path/to/codeigniter/application/views/users/edit_user.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php echo form_open('users/edit_user') ; ?&gt;
    &lt;?php if (validation_errors()) : ?&gt;
        &lt;h3&gt;Whoops! There was an error:&lt;/h3&gt;
        &lt;p&gt;&lt;?php echo validation_errors(); ?&gt;&lt;/p&gt;
    &lt;?php endif; ?&gt;
    &lt;table border="0" &gt;
      &lt;tr&gt;
         &lt;td&gt;User First Name&lt;/td&gt;
         &lt;td&gt;&lt;?php echo form_input($first_name); ?&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
         &lt;td&gt;User Last Name&lt;/td&gt;
         &lt;td&gt;&lt;?php echo form_input($last_name); ?&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
         &lt;td&gt;User Email&lt;/td&gt;
         &lt;td&gt;&lt;?php echo form_input($email); ?&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;User Is Active?&lt;/td&gt;
          &lt;td&gt;&lt;?php echo form_checkbox($is_active); ?&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;?php echo form_hidden($id); ?&gt;
    &lt;/table&gt;
    &lt;?php echo form_submit('submit', 'Update'); ?&gt;
    or &lt;?php echo anchor('users/index', 'cancel'); ?&gt;
&lt;?php echo form_close(); ?&gt;</pre></div></li><li class="listitem">Amend the, <code class="literal">path/to/codeigniter/application/controllers/users.php </code>file, with the following code:<div class="informalexample"><pre class="programlisting">    public function edit_user() {
        // Load support assets
        $this-&gt;load-&gt;library('form_validation');
        $this-&gt;form_validation-&gt;set_error_delimiters('', '&lt;br /&gt;');

        // Set validation rules
        $this-&gt;form_validation-&gt;set_rules('first_name', 'First Name', 'required|min_length[1]|max_length[125]');
        $this-&gt;form_validation-&gt;set_rules('last_name', 'Last Name', 'required|min_length[1]|max_length[125]');
        $this-&gt;form_validation-&gt;set_rules('email', 'Email', 'required|min_length[1]|max_length[255]|valid_email');
        $this-&gt;form_validation-&gt;set_rules('is_active', 'Is Active', 'min_length[1]|max_length[1]|integer|is_natural');

        if ($this-&gt;input-&gt;post()) {
            $id = $this-&gt;input-&gt;post('id');
        } else {
            $id = $this-&gt;uri-&gt;segment(3); 
        }
        
        // Begin validation
        if ($this-&gt;form_validation-&gt;run() == FALSE) {
          // First load, or problem with form
                $query = $this-&gt;Users_model-&gt;get_user_details($id);
                foreach ($query-&gt;result() as $row) {
                    $first_name = $row-&gt;first_name;
                    $last_name = $row-&gt;last_name;
                    $email = $row-&gt;email;
                    $is_active= $row-&gt;is_active;
                }

                $data['first_name'] = array('name' =&gt; 'first_name', 'id' =&gt; 'first_name', 'value' =&gt; set_value('first_name', $first_name), 'maxlength' =&gt; '100', 'size' =&gt; '35');
                $data['last_name'] = array('name' =&gt; 'last_name', 'id' =&gt; 'last_name', 'value' =&gt; set_value('last_name', $last_name), 'maxlength'   =&gt; '100', 'size' =&gt; '35');
                $data['email'] = array('name' =&gt; 'email', 'id' =&gt; 'email', 'value' =&gt; set_value('email', $email), 'maxlength' =&gt; '100', 'size' =&gt; '35');
                $data['is_active'] = array('name' =&gt; 'is_active', 'id' =&gt; 'is_active', 'value' =&gt; set_value('is_active', $is_active), 'maxlength'   =&gt; '100', 'size' =&gt; '35');
                $data['id'] = array('id' =&gt; set_value('id', $id));

                $this-&gt;load-&gt;view('users/edit_user', $data);
            
        } else { // Validation passed, now escape the data
            $data = array(
                'first_name' =&gt; $this-&gt;input-&gt;post('first_name'),
                'last_name' =&gt; $this-&gt;input-&gt;post('last_name'),
                'email' =&gt; $this-&gt;input-&gt;post('email'),
                'is_active' =&gt; $this-&gt;input-&gt;post('is_active'),
            );

            if ($this-&gt;Users_model-&gt;process_update_user($id, $data)) {
                redirect('users/view_users');
            }
        }
    }</pre></div></li><li class="listitem">Amend the, <code class="literal">path/to/codeigniter/application/models/users_model.php </code>file, with the following code:<div class="informalexample"><pre class="programlisting">    public function process_update_user($id, $data) {
        $this-&gt;db-&gt;where('id', $id);
        if ($this-&gt;db-&gt;update('users', $data)) {
          return true;
        } else {
          return false;
        }
    }

    public function get_user_details($id) {
        $this-&gt;db-&gt;where('id', $id);
        return $this-&gt;db-&gt;get('users');
    }</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec26"/>How it works...</h2></div></div></div><p>This is similar functionality to creating a new user (mentioned earlier), but instead of writing a row to the users table, we're removing a row based on the user's primary key.</p><p>First we'll need to grab the user's ID. At this point, the user's ID is probably coming from an URL, but may also be coming from a post array (for example, if returned <code class="literal">FALSE</code>). The following code works out how the <code class="literal">$id</code> variable is coming in (either post or URL), and stores it in the <code class="literal">$id</code> variable ready for later processing:.</p><div class="informalexample"><pre class="programlisting">if ($this-&gt;input-&gt;post()) {
    $id = $this-&gt;input-&gt;post('id');
} else {
    $id = $this-&gt;uri-&gt;segment(3); 
}</pre></div><p>We then validate the users edited data—if the data passes validation we package up the incoming form data into an associative array (called <code class="literal">$data</code>). We use the array keys as a mapper to the column names in our database—that is to say that the keys in the array match the database column—stake a look at the following code:</p><div class="informalexample"><pre class="programlisting">    $data = array(
        'first_name' =&gt; $this-&gt;input-&gt;post('first_name'),
        'last_name' =&gt; $this-&gt;input-&gt;post('last_name'),
        'email' =&gt; $this-&gt;input-&gt;post('email'),
        'is_active' =&gt; $this-&gt;input-&gt;post('is_active'),
    );</pre></div><p>You can see that the keys of the associative array match the column names in the database table; so the key <code class="literal">first_name</code> in the array will map to <code class="literal">first_name</code> column in the table. The key <code class="literal">last_name</code> in the array will map to the <code class="literal">last_name</code> column in the table.</p><p>Next we write the users edited information to the database.  We do this by sending the <code class="literal">$data</code> array we just created (along with the <code class="literal">$id</code> variable) to our <code class="literal">Users_model</code> function <code class="literal">process_update_user()</code>, which will perform the task of updating.</p><div class="informalexample"><pre class="programlisting">    if ($this-&gt;Users_model-&gt;process_update_user($id, $data)) {
        redirect('users/view_users');
    }</pre></div></div></div>
<div class="section" title="Deleting users"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec20"/>Deleting users</h1></div></div></div><p>It's always a good idea to be able to <a id="id57" class="indexterm"/>delete users from an interface rather than removing them from the database directly or not deleting them at all. We're going to create a CRUD interface to allow us to remove users from the database. Here's how to do it.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec27"/>How to do it…</h2></div></div></div><p>We'll need to create one file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/views/users/delete_user.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following code into the, <code class="literal">views/users/delete_user.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php echo form_open('users/delete_user'); ?&gt;
    &lt;?php if (validation_errors()) : ?&gt;
        &lt;h3&gt;Whoops! There was an error:&lt;/h3&gt;
        &lt;p&gt;&lt;?php echo validation_errors(); ?&gt;&lt;/p&gt;
    &lt;?php endif; ?&gt;
    &lt;?php foreach ($query-&gt;result() as $row) : ?&gt;
        &lt;?php echo $row-&gt;first_name . ' ' . $row-&gt;last_name; ?&gt;
        &lt;?php echo form_submit('submit', 'Delete'); ?&gt;
        or &lt;?php echo anchor('users/index', 'cancel'); ?&gt;
        &lt;?php echo form_hidden('id', $row-&gt;id); ?&gt;
    &lt;?php endforeach; ?&gt;
&lt;/form&gt;</pre></div></li><li class="listitem">Amend the following <a id="id58" class="indexterm"/>two files:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/controllers/users.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">path/to/codeigniter/application/models/users_model.php</code></li></ul></div></li><li class="listitem">Amend the, <code class="literal">controllers/users.php </code>file, with the following code:<div class="informalexample"><pre class="programlisting">   public function delete_user() {
        // Load support assets
        $this-&gt;load-&gt;library('form_validation');
        $this-&gt;form_validation-&gt;set_error_delimiters('', '&lt;br /&gt;');

        // Set validation rules
        $this-&gt;form_validation-&gt;set_rules('id', 'User ID', 'required|min_length[1]|max_length[11]|integer|is_natural');

        if ($this-&gt;input-&gt;post()) {
            $id = $this-&gt;input-&gt;post('id');
        } else {
            $id = $this-&gt;uri-&gt;segment(3);
        }
        
        if ($this-&gt;form_validation-&gt;run() == FALSE) {
          // First load, or problem with form

            $data['query'] = $this-&gt;Users_model-&gt;get_user_details($id);

            $this-&gt;load-&gt;view('users/delete_user', $data);
        } else {
            if ($this-&gt;Users_model-&gt;delete_user($id)) {
                redirect('users/view_users');
            }
        }
    }</pre></div></li><li class="listitem">Amend the, <code class="literal">controllers/users_model.php </code>file, with the following code:<div class="informalexample"><pre class="programlisting">    public function delete_user($id) {
        $this-&gt;db-&gt;where('id', $id);
        if ($this-&gt;db-&gt;delete('users')) {
            return true;
        } else {
            return false;
        }
    }</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec28"/>How it works...</h2></div></div></div><p>This is similar functionality to creating a new user (explained earlier), but instead of writing a row to the users table, we're removing a row based on the user's primary key.</p><p>First, we'll need to grab the user's ID. At this point the user's ID is probably coming from an URL, but may also be coming from the post array.</p><p>The following code works out how the <code class="literal">$id</code> variable is coming in (either from post or by URL) and stores it in the <code class="literal">$id</code> variable ready for processing later:</p><div class="informalexample"><pre class="programlisting">if ($this-&gt;input-&gt;post()) {
  $id = $this-&gt;input-&gt;post('id');
} else {
  $id = $this-&gt;uri-&gt;segment(3);  
}</pre></div><p>If <code class="literal">public function delete_user()</code> is being called for the first time (that is, it is not being called by a form submission), then the user's primary key is passed to <code class="literal">public function delete_user()</code> from within the URL. It is picked up by <code class="literal">$this-&gt;uri-&gt;segment(3)</code>and is sent to the, <code class="literal">users/delete_user.php </code>view by assigning it in <code class="literal">$this-&gt;load-&gt;view('user/delete_user', $data['id])</code>. Within the view, the <code class="literal">$id</code> value is written as a hidden HTML form the element.</p><p>It is necessary to assign the user's ID as a hidden element in the form because when the form is submitted, <code class="literal">public function delete_user()</code> will require the ID of the user. A the form is being submitted rather than a first load, the ID will not be available from <code class="literal">$this-&gt;uri-&gt;segment(3)</code>.</p><p>
<code class="literal">public function delete_user()</code> <a id="id59" class="indexterm"/>performs several functions similar to <code class="literal">public function new_user()</code>. These are loading the view file, validating any data inputted after submission, and displaying a view.</p><p>If <code class="literal">public function delete_user()</code> is being called as the result of a form submission, CodeIgniter will begin checking and validating the user input; in this case, submitted input consists only of the users ID, which is written as a hidden form element in the view. The first line of the function loads the necessary library to enable checking the user's input: <code class="literal">$this-&gt;library('form_validation')</code>, and our error delimiters are set with the function, <code class="literal">set_error_deimiters()</code>. The user ID is then checked against the criteria we specify. A full list of validation criteria options are available at:</p><p>
<a class="ulink" href="http://ellislab.com/codeigniter/user-guide/libraries/form_validation.html">http://ellislab.com/codeigniter/user-guide/libraries/form_validation.html</a>. We will also discuss form validation in greater detail in <a class="link" href="ch05.html" title="Chapter 5. Managing Data In and Out">Chapter 5</a>, <span class="emphasis"><em>Managing Data In and Out</em></span>.</p><p>If validation isn't passed (the input from <a id="id60" class="indexterm"/>the user didn't meet the requirements we set), then <code class="literal">$this-&gt;form_validation-&gt;run()</code> will return <code class="literal">FALSE</code>, and the form will be displayed again.</p><p>Once validation is passed (<code class="literal">$this-&gt;form_validation-&gt;run()</code> returns <code class="literal">TRUE</code>), then we'll package up the input into an array: <code class="literal">$data</code>. As we're using Active Record to interact with the database, the keys of the <code class="literal">$data</code> array must match the column names of our database table.</p><p>The <code class="literal">$data</code> array is then sent to the <code class="literal">Users_model</code> for deletion from the database using the syntax: <code class="literal">$this-&gt;Users_model-&gt;delete_user($id)</code>.</p></div></div>
<div class="section" title="Generating passwords with CodeIgniter"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec21"/>Generating passwords with CodeIgniter</h1></div></div></div><p>There are two ways to explain this. <a id="id61" class="indexterm"/>As this is a recipe book, I'm going to give <a id="id62" class="indexterm"/>you the structure for a user to register (part of this process is creating a hash from the password the user will provide) and also the signin form (part of this process is to validate a password against a hash). But I'm aware that you won't  necessarily need all the following files, the lines which focus on password hashing in the following examples. This way, you can quickly see how the process works and apply it to your situation.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec29"/>Getting ready</h2></div></div></div><p>First, let's make the database schema to support the recipe. If you have your own table ready and are just looking for the hashing code, you can probably skip this part. Otherwise, copy the following code into your database:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE IF NOT EXISTS `register` ( 
  `user_id` int(11) NOT NULL AUTO_INCREMENT, 
  `user_first_name` varchar(125) NOT NULL, 
  `user_last_name` varchar(125) NOT NULL, 
  `user_email` varchar(255) NOT NULL, 
  `user_hash` text NOT NULL, 
  PRIMARY KEY (`user_id`) 
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;</pre></div><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip04"/>Tip</h3><p>
<span class="strong"><strong>Downloading the example code</strong></span>
</p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit h</p></div></div><p>The register table description is as follows:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Item name</p>
</th><th style="text-align: left" valign="bottom">
<p>Attributes</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">user_id</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">INTEGER(11)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Table primary key</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">user_first_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">VARCHAR(125)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The user's first name</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">user_last_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">VARCHAR(125)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The user's last name</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">user_email</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">VARCHAR(255)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The user's e-mail address, for example, <code class="email">&lt;<a class="email" href="mailto:name@example.org">name@example.org</a>&gt;</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">user_hash</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">TEXT</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The hash of their password generated by <code class="literal">$this-&gt;encrypt-&gt;sha1($string_to_hash [, $key])</code>
</p>
</td></tr></tbody></table></div><p>You'll also have to create a sessions table and ensure that the config file is set up to handle database stored sessions. For instructions on how to do that, see </p><p>That's the database done! We're <a id="id63" class="indexterm"/>going to use the CodeIgniter <span class="strong"><strong>encrypt</strong></span> library to do the heavy lifting of hashing the password for us, specifically, <code class="literal">$this-&gt;encrypt-&gt;sha1($string_to_hash [, $key])</code>, where <code class="literal">$key</code> is optional. There are a few things we need to set up first.You'll need to decide on the encryption key you want to use: this can either be the encryption key that you've set in <code class="literal">$config['encryption_key']</code> in <code class="literal">config.php</code>, or you can pass a new key as a second parameter to CodeIgniter. The presence of this second parameter overrides the value set in <code class="literal">$config['encryption_key']</code>.</p><p>In the following recipe, we are using the <a id="id64" class="indexterm"/>value in <code class="literal">$config['encryption_key']</code> to serve as our encryption key; as such, we won't be passing a second parameter.</p><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip05"/>Tip</h3><p>When creating a key, try not to use just a single word as this may be cracked using a rainbow table; instead use a fairly long string with random alphanumeric characters.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec30"/>How to do it...</h2></div></div></div><p>In this recipe, we're going to create <a id="id65" class="indexterm"/>the following seven files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/register.php</code>: This file contains a form allowing the user to sign up, and a record is then added to the database table (SQL in the <span class="emphasis"><em>Getting ready</em></span> section)</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/register_model.php</code>: This file interacts with the database for the controller</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/register/register.php</code>: This file is for the registration form</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/signin.php</code>: This file handles the login process, including comparing the password against the hash</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/signin_model.php</code>: This file interacts with the database for the controller</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/signin/signin.php</code>: This file is for the signin form</li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/signin/loggedin.php</code>: This file presents a page indicating a successful sign-in</li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Copy the following code into the, <code class="literal">/path/to/codeigniter/application/controllers/register.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Register extends CI_Controller {
    function __construct() {
        parent::__construct();
        $this-&gt;load-&gt;helper('form');
        $this-&gt;load-&gt;helper('url');
        $this-&gt;load-&gt;helper('security');
        $this-&gt;load-&gt;model('Register_model');
        $this-&gt;load-&gt;library('encrypt');
        $this-&gt;load-&gt;database();
    }

    public function index() {
        redirect('register/register_user');
    }

    public function register_user() {
        // Load support assets
        $this-&gt;load-&gt;library('form_validation');
        $this-&gt;form_validation-&gt;set_error_delimiters('', '&lt;br /&gt;');

        // Set validation rules
        $this-&gt;form_validation-&gt;set_rules('first_name', 'First Name', 'required|min_length[1]|max_length[125]');
        $this-&gt;form_validation-&gt;set_rules('last_name', 'Last Name', 
            'required|min_length[1]|max_length[125]');
        $this-&gt;form_validation-&gt;set_rules('email', 'Email', 
          'required|min_length[1]|max_length[255]|valid_email');
        $this-&gt;form_validation-&gt;set_rules('password1', 
          'Password', 'required|min_length[5]|max_length[15]');
        $this-&gt;form_validation-&gt;set_rules('password2', 'Confirmation Password', 'required|min_length[5]|max_length[15]|matches[password1]');

        // Begin validation
        if ($this-&gt;form_validation-&gt;run() == FALSE) {
            // First load, or problem with form
            $data['page_title'] = "Register";
            $this-&gt;load-&gt;view('register/register',$data);
        } else {
            // Create hash from user password
            $hash = $this-&gt;encrypt-&gt;sha1($this-&gt;input-&gt;post('password1'));
             
            $data = array(
                'user_first_name' =&gt; $this-&gt;input-&gt;post('first_name'),
                'user_last_name' =&gt; $this-&gt;input-&gt;post('last_name'),
                'user_email' =&gt; $this-&gt;input-&gt;post('email'),
                'user_hash' =&gt; $hash
            );

            if ($this-&gt;Register_model-&gt;register_user($data)) {
                redirect('signin');
            } else {
                redirect('register');
            }
        }
    }
}</pre></div></li><li class="listitem">Copy the <a id="id66" class="indexterm"/>following <a id="id67" class="indexterm"/>code into the, <code class="literal">/path/to/codeigniter/application/models/register_model.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php if (! defined('BASEPATH')) exit('No direct script access allowed');

class Register_model extends CI_Model {
    function __construct() {
        parent::__construct();
    }
    
    public function register_user($data) {
        if ($this-&gt;db-&gt;insert('register', $data)) {
            return true;
        } else {
            return false;
        }
    }

    public function update_user($data, $email) {
        $this-&gt;db-&gt;where('user_email', $email);
        $this-&gt;db-&gt;update('register', $data);
    }
}</pre></div></li><li class="listitem">Copy the following code into the, <code class="literal">/path/to/codeigniter/application/views/register/register.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php echo form_open('register/register_user') ; ?&gt;
    &lt;?php if (validation_errors()) : ?&gt;
        &lt;h3&gt;Whoops! There was an error:&lt;/h3&gt;
        &lt;p&gt;&lt;?php echo validation_errors(); ?&gt;&lt;/p&gt;
    &lt;?php endif; ?&gt;
    &lt;table border="0" &gt;
        &lt;tr&gt;
            &lt;td&gt;First Name&lt;/td&gt;
            &lt;td&gt;&lt;?php echo form_input(array('name' =&gt; 'first_name', 'id' =&gt; 'first_name','value' =&gt; set_value('first_name', ''), 'maxlength' =&gt; '100', 'size' =&gt; '50', 'style' =&gt; 'width:100%')); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;Last Name&lt;/td&gt;
            &lt;td&gt;&lt;?php echo form_input(array('name' =&gt; 'last_name', 'id' =&gt; 'last_name', 
                'value' =&gt; set_value('last_name', ''), 'maxlength' =&gt; '100', 'size' =&gt; '50', 'style' =&gt; 'width:100%')); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;User Email&lt;/td&gt;
            &lt;td&gt;&lt;?php echo form_input(array('name' =&gt; 'email', 'id' =&gt; 'email', 'value' =&gt; set_value('email', ''), 'maxlength' =&gt; '100', 'size' =&gt; '50', 'style' =&gt; 'width:100%')); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;Password&lt;/td&gt;
            &lt;td&gt;&lt;?php echo form_password(array('name' =&gt; 'password1', 'id' =&gt; 'password1', 
                'value' =&gt; set_value('password1', ''), 'maxlength' =&gt; '100', 'size' =&gt; '50', 
                    'style' =&gt; 'width:100%')); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;Confirm Password&lt;/td&gt;
            &lt;td&gt;&lt;?php echo form_password(array('name' =&gt; 'password2', 'id' =&gt; 'password2', 'value' =&gt; set_value('password2', ''), 'maxlength' =&gt; '100', 'size' =&gt; '50', 'style' =&gt; 'width:100%')); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/table&gt;
    &lt;?php echo form_submit('submit', 'Submit'); ?&gt;
    or &lt;?php echo anchor('form', 'cancel'); ?&gt;
&lt;?php echo form_close(); ?&gt;</pre></div></li><li class="listitem">Copy the following <a id="id68" class="indexterm"/>code in to the, <code class="literal">/path/to/codeigniter/application/controllers/signin.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Signin extends CI_Controller {

  function __construct() {
    parent::__construct();
    $this-&gt;load-&gt;helper('form');
    $this-&gt;load-&gt;helper('url');
    $this-&gt;load-&gt;helper('security');
  }

  public function index() {
    redirect('signin/login');
  }

    public function login() {
    if ($this-&gt;session-&gt;userdata('logged_in') == TRUE) {
      redirect('signin/loggedin');
    } else {
      $this-&gt;load-&gt;library('form_validation');

      // Set validation rules for view filters
      $this-&gt;form_validation-&gt;set_rules('email', 'Email', 'required|valid_email|min_length[5]|max_length[125]');
      $this-&gt;form_validation-&gt;set_rules('password', 'Password ', 'required|min_length[5]|max_length[30]');

      if ($this-&gt;form_validation-&gt;run() == FALSE) {
        $this-&gt;load-&gt;view('signin/signin');
      } else {
        $email = $this-&gt;input-&gt;post('email');
        $password = $this-&gt;input-&gt;post('password');

        $this-&gt;load-&gt;model('Signin_model');
        $query = $this-&gt;Signin_model-&gt;does_user_exist($email);

        if ($query-&gt;num_rows() == 1) {
          // One matching row found
          foreach ($query-&gt;result() as $row) {
            // Call Encrypt library
<span class="strong"><strong>            $this-&gt;load-&gt;library('encrypt');</strong></span>

            // Generate hash from a their password
            $hash = $this-&gt;encrypt-&gt;sha1($password);

            // Compare the generated hash with that in the // database
<span class="strong"><strong>            if ($hash != $row-&gt;user_hash) {</strong></span>
<span class="strong"><strong>              // Didn't match so send back to login</strong></span>
<span class="strong"><strong>              $data['login_fail'] = true;</strong></span>
<span class="strong"><strong>              $this-&gt;load-&gt;view('signin/signin', $data);</strong></span>
<span class="strong"><strong>            } else {</strong></span>
<span class="strong"><strong>              $data = array(</strong></span>
<span class="strong"><strong>                  'user_id' =&gt; $row-&gt;user_id,</strong></span>
<span class="strong"><strong>                  'user_email' =&gt; $row-&gt;user_email,</strong></span>
<span class="strong"><strong>                  'logged_in' =&gt; TRUE</strong></span>
<span class="strong"><strong>              );</strong></span>

<span class="strong"><strong>              // Save data to session</strong></span>
<span class="strong"><strong>              $this-&gt;session-&gt;set_userdata($data);</strong></span>
<span class="strong"><strong>              redirect('signin/loggedin');</strong></span>
<span class="strong"><strong>            }</strong></span>
          }
        } 
      }
    }
  }

  function loggedin() {
    if ($this-&gt;session-&gt;userdata('logged_in') == TRUE) {
      $this-&gt;load-&gt;view('signin/loggedin');
    } else {
      redirect('signin');
    }       
  }
}</pre></div></li><li class="listitem">Copy the <a id="id69" class="indexterm"/>following <a id="id70" class="indexterm"/>code in to the, <code class="literal">/path/to/codeigniter/application/models/signin_model.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Signin_model extends CI_Model {
    function __construct() {
        parent::__construct();
    }

    public function does_user_exist($email) {
        $this-&gt;db-&gt;where('user_email', $email);
        $query = $this-&gt;db-&gt;get('register');
        return $query;
    }
}</pre></div></li><li class="listitem">Then copy the following <a id="id71" class="indexterm"/>code in to the, <code class="literal">/path/to/codeigniter/application/views/signin/signin.php </code>file:<div class="informalexample"><pre class="programlisting">&lt;?php echo form_open('signin/login') ; ?&gt;
    &lt;?php if (validation_errors()) : ?&gt;
        &lt;h3&gt;Whoops! There was an error:&lt;/h3&gt;
        &lt;p&gt;&lt;?php echo validation_errors(); ?&gt;&lt;/p&gt;
    &lt;?php endif; ?&gt;

    &lt;?php if (isset($login_fail)) : ?&gt;
        &lt;h3&gt;Login Error:&lt;/h3&gt;
        &lt;p&gt;Username or Password is incorrect, please try again.&lt;/p&gt;
    &lt;?php endif; ?&gt;

    &lt;table border="0" &gt;
        &lt;tr&gt;
            &lt;td&gt;User Email&lt;/td&gt;
            &lt;td&gt;&lt;?php echo form_input(array('name' =&gt; 'email', 'id' =&gt; 'email', 'value' =&gt; set_value('email', ''), 'maxlength' =&gt; '100', 'size' =&gt; '50', 'style' =&gt; 'width:100%')); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;Password&lt;/td&gt;
            &lt;td&gt;&lt;?php echo form_password(array('name' =&gt; 'password', 'id' =&gt; 'password', 
                'value' =&gt; set_value('password', ''), 'maxlength' =&gt; '100', 'size' =&gt; '50', 
                    'style' =&gt; 'width:100%')); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/table&gt;
    &lt;?php echo form_submit('submit', 'Submit'); ?&gt;
    or &lt;?php echo anchor('signin', 'cancel'); ?&gt;
&lt;?php echo form_close(); ?&gt;</pre></div></li><li class="listitem">Then copy the following code in to the, <code class="literal">/path/to/codeigniter/application/views/signin/loggedin.php </code>file:<div class="informalexample"><pre class="programlisting">Success!  Logged in as &lt;?php echo $this-&gt;session-&gt;userdata('user_email'); ?&gt;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec31"/>How it works...</h2></div></div></div><p>Okay, there's a lot going on in this example but it's actually fairly simple. Take a look at the preceding code again—specifically the <a id="id72" class="indexterm"/>lines which are highlighted as these are the lines that are password specific. The files created in the preceding section show the creation of a user and the logging in of that user. Of course, your code will be different; but let's concentrate on those highlighted lines.</p><p>They show the code that performs the hashing and comparison of passwords (a concise version can be found in the following recipe).</p><p>Firstly, let's look at the register user process. The register controller accepts user-submitted information from the <code class="literal">/path/to/codeigniter/application/views/register/register.php</code> view. Upon successfully passing the following validation line:</p><div class="informalexample"><pre class="programlisting">$hash = $this-&gt;encrypt-&gt;sha1($password);</pre></div><p>will generate a hashed value using the <a id="id73" class="indexterm"/>password the user supplied, this hashed value is stored in the, <code class="literal">$hash</code> variable (obvious huh?).</p><p>
<code class="literal">$hash</code> is then <a id="id74" class="indexterm"/>added to the <a id="id75" class="indexterm"/>
<code class="literal">$data</code> array for <a id="id76" class="indexterm"/>insertion into the database as follows:</p><div class="informalexample"><pre class="programlisting">// Create hash from user password
$hash = $this-&gt;encrypt-&gt;sha1($this-&gt;input-&gt;post('password1'));

$data = array(
     'user_first_name' =&gt; $this-&gt;input-&gt;post('first_name'),
     'user_last_name' =&gt; $this-&gt;input-&gt;post('last_name'),
     'user_email' =&gt; $this-&gt;input-&gt;post('email'),
     'user_hash' =&gt; $hash
);</pre></div><p>Now let's take a look at the sign-in process. <code class="literal">public function login()</code> accepts the e-mail address and password from the user (from the, <code class="literal">/path/to/codeigniter/application/views/signin/signin.php </code>view), and upon successfully passing validation, we look up the user-supplied e-mail address in the register table as follows:</p><div class="informalexample"><pre class="programlisting">        $this-&gt;load-&gt;model('Signin_model');
        $query = $this-&gt;Signin_model-&gt;does_user_exist($email);

        if ($query-&gt;num_rows() == 1) {
          // One matching row found
          foreach ($query-&gt;result() as $row) {
          ..
        }</pre></div><p>If the e-mail exists, we generate a <a id="id77" class="indexterm"/>hash from the user-supplied password. This process is the same as the functionality found in the registration process as follows:</p><div class="informalexample"><pre class="programlisting">            // Call Encrypt library
            $this-&gt;load-&gt;library('encrypt');

            // Generate hash from a their password
            $hash = $this-&gt;encrypt-&gt;sha1($password);

            // Compare the generated hash with that in the // database
<span class="strong"><strong>            if ($hash != $row-&gt;user_hash) {</strong></span>
              // Didn't match so send back to login
              $data['login_fail'] = true;
              $this-&gt;load-&gt;view('signin/signin', $data);
            } else {
              $data = array(
                  'user_id' =&gt; $row-&gt;user_id,
                  'user_email' =&gt; $row-&gt;user_email,
                  'logged_in' =&gt; TRUE
              );

              // Save data to session
              $this-&gt;session-&gt;set_userdata($data);
              redirect('signin/loggedin');
            }</pre></div><p>Now, take a look at the highlighted line in the preceding code. We're comparing the hash we generated from the user-supplied password against <code class="literal">user_hash</code> in the record we pulled from the register table. If the two hashes do not match, then the user must not have supplied the correct password, so we send them back to the signin form and wait for another attempt. However, if the two hashes do match, then the user must have supplied the correct password, so we'll start a session <a id="id78" class="indexterm"/>for them and redirect them to <code class="literal">public function loggedin()</code>.In this case, it is a brief message, indicating that they are successfully logged in. However, in <a id="id79" class="indexterm"/>your application, this would be some sort of password protected member area, perhaps a dashboard.</p></div></div>
<div class="section" title="Generating passwords with CodeIgniter &#x2013; the bare bones"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec22"/>Generating passwords with CodeIgniter – the bare bones</h1></div></div></div><p>Okay, this is just the bare bones process. If you want a full example, then the preceding recipe is for you. This recipe is for people who already have a create-user process, but wish to integrate some password protection into an existing process.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec32"/>How to do it...</h2></div></div></div><p>If you don't need the preceding recipe and only require the bare bones of hashing/comparing; please refer to the following steps:</p><div class="section" title="Generating a hash"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec03"/>Generating a hash</h3></div></div></div><p>To generate a hash, perform the following <a id="id80" class="indexterm"/>steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Generate a hash with a key in <code class="literal">$config['encryption_key']</code> as follows: <div class="informalexample"><pre class="programlisting">// Call Encrypt library
$this-&gt;load-&gt;library('encrypt');

$hash = $this-&gt;encrypt-&gt;sha1($text_to_be_hashed);</pre></div></li><li class="listitem">Generate a hash with a key other than that in <code class="literal">$config['encryption_key']</code> as follows:<div class="informalexample"><pre class="programlisting">// Call Encrypt library
$this-&gt;load-&gt;library('encrypt');

$key = "This-is-the-key";
$hash = $this-&gt;encrypt-&gt;sha1($text_to_be_hashed, $key);</pre></div><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip06"/>Tip</h3><p>In a production environment, replace the <code class="literal">$key</code> value (<code class="literal">This-is-the-key</code>) with a realistic value. Make it a long string of alphanumeric characters; the more random the better!</p></div></div></li></ol></div></div><div class="section" title="Comparing hashed values"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec04"/>Comparing hashed values</h3></div></div></div><p>The hash values are compared as follows:</p><div class="informalexample"><pre class="programlisting">// Call Encrypt library
$this-&gt;load-&gt;library('encrypt');

// Generate hash from a their password
$hash = $this-&gt;encrypt-&gt;sha1($password);

// Compare the generated hash with that in the database
if ($hash != $row-&gt;user_hash) {
    // Didn't match so send back to login
    redirect('signin/login');
} else { 
    // Did match so log them in if you wish
}</pre></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec33"/>How it works...</h2></div></div></div><p>
<span class="strong"><strong>Generating a hash with the $config['encryption_key'] value</strong></span>: First, we load the encrypt library with <code class="literal">$this-&gt;load-&gt;library('encrypt')</code>, then we call the <code class="literal">sha1</code> function <a id="id81" class="indexterm"/>in the encrypt library and pass to it the, <code class="literal">$text_to_be_hashed </code>variable. The key used to encrypt the <code class="literal">$text_to_be_hashed string</code>, comes from the <a id="id82" class="indexterm"/>value set in the config array item, <code class="literal">$config['encryption_key']</code>, in the <code class="literal">config.php</code> file. <code class="literal">$this-&gt;encrypt-&gt;sha1($text_to_be_hashed)</code> will return a string that we'll store in the, <code class="literal">$hash </code>variable.</p><p>
<span class="strong"><strong>Generating a hash without the $config['encryption_key'] value (that is adding a second parameter)</strong></span>: First, we <a id="id83" class="indexterm"/>load the encrypt library with <code class="literal">$this-&gt;load-&gt;library('encrypt')</code>, then we call the <code class="literal">sha1</code> function in the encrypt library and pass to it the, <code class="literal">$text_to_be_hashed</code>, and also an encryption key as a second parameter:</p><div class="informalexample"><pre class="programlisting">$this-&gt;encrypt-&gt;sha1($text_to_be_hashed, $key)</pre></div><p>Adding this key as a second parameter (<code class="literal">$key</code>) will cause CodeIgniter to use that key rather than any value set in <code class="literal">$config['encryption_key']</code>. <code class="literal">$this-&gt;encrypt-&gt;sha1($text_to_be_hashed, $key)</code> will return a string that we'll store in the variable, <code class="literal">$hash</code>.</p><p>After loading the encryption support library with <code class="literal">$this-&gt;load-&gt;library('encrypt')</code>, a string of text (in this case, in the, <code class="literal">$password </code>variable) is passed to the <code class="literal">sha1</code> function in the encrypt library, storing its product in the, <code class="literal">$hash </code>variable. We can now use this variable to compare a stored value, such as from a database select result. In this example, we compare <code class="literal">$hash</code> with the value in <code class="literal">$row-&gt;user_hash</code>. If they do not match, we send <code class="literal">redirect()</code> to the login screen, but you could easily code any action, such as logging the event or displaying a message rather than a redirect. If the <code class="literal">$hash</code> and <code class="literal">$row-&gt;user_hash</code> values do match, then you could perform an action based on this confirmation; an example would be logging the user in.</p></div></div>
<div class="section" title="Forgot password? &#x2013; resetting passwords with CodeIgniter"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec23"/>Forgot password? – resetting passwords with CodeIgniter</h1></div></div></div><p>Everyone forgets their password <a id="id84" class="indexterm"/>from time to time and it's likely that a <a id="id85" class="indexterm"/>user may wish to be reminded of their password. However, we cannot send them their password as we don't have it; we are only storing a hash of it—the password isn't actually stored in the database. The user will have to reset their password; generating a new hash as they do so.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec34"/>Getting ready</h2></div></div></div><p>We want to be sure that a user has genuinely requested a new password, therefore, we're going to add a column in the register table to support this. The new column called <code class="literal">forgot_password</code> will contain a code which we will generate when a new password is requested; and we will check that code when the user is redirected back to the site from a url in an e-mail, which we will also send to them. Copy the following code into your database:</p><div class="informalexample"><pre class="programlisting">ALTER TABLE register ADD forgot_password INT(11) AFTER user_hash;</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec35"/>How to do it...</h2></div></div></div><p>We're going to create the following <a id="id86" class="indexterm"/>two files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/signin/forgot_password.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/signin/new_password.php</code></li></ul></div><p>And amend the following three files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/controllers/signin.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/models/signin_model.php</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/path/to/codeigniter/application/views/signin/signin.php</code></li></ul></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Copy the following code into <code class="literal">/path/to/codeigniter/application/views/signin/forgot_password.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php echo form_open('signin/forgot_password') ; ?&gt;
    &lt;?php if (validation_errors()) : ?&gt;
        &lt;h3&gt;Whoops! There was an error:&lt;/h3&gt;
        &lt;p&gt;&lt;?php echo validation_errors(); ?&gt;&lt;/p&gt;
    &lt;?php endif; ?&gt;
    &lt;?php if (isset($submit_success)) : ?&gt;
        &lt;h3&gt;Email Sent:&lt;/h3&gt;
        &lt;p&gt;An email has been sent to the address provided.&lt;/p&gt;
    &lt;?php endif; ?&gt;
    &lt;table border="0" &gt;
        &lt;tr&gt;
            &lt;td&gt;User Email&lt;/td&gt;
            &lt;td&gt;&lt;?php echo form_input(array('name' =&gt; 'email', 'id' =&gt; 'email', 'value' =&gt; set_value('email', ''), 'maxlength' =&gt; '100', 'size' =&gt; '50', 'style' =&gt; 'width:100%')); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/table&gt;
    &lt;?php echo form_submit('submit', 'Submit'); ?&gt;
    or &lt;?php echo anchor('form', 'cancel'); ?&gt;
&lt;?php echo form_close(); ?&gt;</pre></div></li><li class="listitem">Copy the following <a id="id87" class="indexterm"/>code into <code class="literal">/path/to/codeigniter/application/views/signin/new_password.php</code>:<div class="informalexample"><pre class="programlisting">&lt;?php echo form_open('signin/new_password') ; ?&gt;
    &lt;?php if (validation_errors()) : ?&gt;
        &lt;h3&gt;Whoops! There was an error:&lt;/h3&gt;
        &lt;p&gt;&lt;?php echo validation_errors(); ?&gt;&lt;/p&gt;
    &lt;?php endif; ?&gt;
    &lt;h2&gt;Reset your password&lt;/h2&gt;

    &lt;table border="0"&gt;
        &lt;tr&gt;
            &lt;td&gt;User Email&lt;/td&gt;
            &lt;td&gt;&lt;?php echo form_input(array('name' =&gt; 'email', 'id' =&gt; 'email', 'value' =&gt; set_value('email', ''), 'maxlength' =&gt; '100', 'size' =&gt; '50', 'style' =&gt; 'width:100%')); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;Password&lt;/td&gt;
            &lt;td&gt;&lt;?php echo form_password(array('name' =&gt; 'password1', 'id' =&gt; 'password1', 'value' =&gt; set_value('password1', ''), 'maxlength' =&gt; '100', 'size' =&gt; '50', 'style' =&gt; 'width:100%')); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;Confirm Password&lt;/td&gt;
            &lt;td&gt;&lt;?php echo form_password(array('name' =&gt; 'password2', 'id' =&gt; 'password2', 'value' =&gt; set_value('password2', ''), 'maxlength' =&gt; '100', 'size' =&gt; '50', 'style' =&gt; 'width:100%')); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;?php echo form_hidden('code', $code) ; ?&gt;
    &lt;/table&gt;
    &lt;?php echo form_submit('submit', 'Submit'); ?&gt;
    or &lt;?php echo anchor('form', 'cancel'); ?&gt;
&lt;?php echo form_close(); ?&gt;</pre></div></li><li class="listitem">Amend <code class="literal">/path/to/codeigniter/application/controllers/signin.php</code>, adding the following <a id="id88" class="indexterm"/>code:<div class="informalexample"><pre class="programlisting">public function forgot_password() {
    $this-&gt;load-&gt;library('form_validation');
    $this-&gt;form_validation-&gt;set_rules('email', 'Email', 'required|valid_email|min_length[5]|max_length[125]');

    if ($this-&gt;form_validation-&gt;run() == FALSE) {
      $this-&gt;load-&gt;view('signin/forgot_password');
    } else {
      $email = $this-&gt;input-&gt;post('email');

      $this-&gt;db-&gt;where('user_email', $email);
      $this-&gt;db-&gt;from('register');
      $num_res = $this-&gt;db-&gt;count_all_results();
      
      if ($num_res == 1) {
        // Make a small string (code) to assign to the user // to indicate they've requested a change of // password
        $code = mt_rand('5000', '200000');
        $data = array(
          'forgot_password' =&gt; $code,
        );

        $this-&gt;db-&gt;where('user_email', $email);
        if ($this-&gt;db-&gt;update('register', $data)) {
          // Update okay, send email
          $url = "http://www.domain.com/signin/new_password/".$code;
          $body = "\nPlease click the following link to reset your password:\n\n".$url."\n\n";
          if (mail($email, 'Password reset', $body, 'From: no-reply@domain.com')) {
            $data['submit_success'] = true;
            $this-&gt;load-&gt;view('signin/signin', $data);
          }
        } else {
          // Some sort of error happened, redirect user // back to form
          redirect('singin/forgot_password');
        }
      } else {
        // Some sort of error happened, redirect user back // to form
        redirect('singin/forgot_password');
      }
    }
  }
  
  public function new_password() {
    $this-&gt;load-&gt;library('form_validation');
    $this-&gt;form_validation-&gt;set_rules('code', 'Code', 'required|min_length[4]|max_length[7]');
    $this-&gt;form_validation-&gt;set_rules('email', 'Email', 'required|valid_email|min_length[5]|max_length[125]');
    $this-&gt;form_validation-&gt;set_rules('password1', 'Password', 'required|min_length[5]|max_length[15]');
    $this-&gt;form_validation-&gt;set_rules('password2', 'Confirmation Password', 'required|min_length[5]|max_length[15]|matches[password1]');
    
    // Get Code from URL or POST and clean up
    if ($this-&gt;input-&gt;post()) {
      $data['code'] = xss_clean($this-&gt;input-&gt;post('code'));
    } else {
      $data['code'] = xss_clean($this-&gt;uri-&gt;segment(3));
    }

    if ($this-&gt;form_validation-&gt;run() == FALSE) {
      $this-&gt;load-&gt;view('signin/new_password', $data);
    } else {
      // Does code from input match the code against the // email
      $this-&gt;load-&gt;model('Signin_model');
      $email = xss_clean($this-&gt;input-&gt;post('email'));
      if (!$this-&gt;Signin_model-&gt;does_code_match($data['code'], $email)) {
        // Code doesn't match
        redirect ('signin/forgot_password');
      } else {// Code does match
        $this-&gt;load-&gt;model('Register_model');
        $hash = $this-&gt;encrypt-&gt;sha1($this-&gt;input-&gt;post('password1'));

        $data = array(
          'user_hash' =&gt; $hash
        );

        if ($this-&gt;Register_model-&gt;update_user($data, $email)) {
          redirect ('signin');
        }
      }
    }
  }</pre></div></li><li class="listitem"><a id="id89" class="indexterm"/>Then, amend <code class="literal">/path/to/codeigniter/application/models/signin_model.php</code>, adding the <a id="id90" class="indexterm"/>following code:<div class="informalexample"><pre class="programlisting">    public function update_user($data, $email) {
        $this-&gt;db-&gt;where('user_email', $email);
        $this-&gt;db-&gt;update('register', $data);
    }

    public function does_email_exist($email) {
      $this-&gt;db-&gt;where('user_email', $email);
      $this-&gt;db-&gt;from('register');
      $num_res = $this-&gt;db-&gt;count_all_results();
        if ($num_res == 1) {
          return TRUE;
      } else {
          return FALSE;
      }
    }

    public function does_code_match($code, $email) {
      $this-&gt;db-&gt;where('user_email', $email);
      $this-&gt;db-&gt;where('forgot_password', $code);
      $this-&gt;db-&gt;from('register');
        $num_res = $this-&gt;db-&gt;count_all_results();

        if ($num_res == 1) {
          return TRUE;
      } else {
          return FALSE;
      }
    }</pre></div></li><li class="listitem">Then, amend <code class="literal">/path/to/codeigniter/application/views/signin.php</code>, adding the <a id="id91" class="indexterm"/>following code:<div class="informalexample"><pre class="programlisting">&lt;?php echo form_open('signin/login') ; ?&gt;
    &lt;?php if (validation_errors()) : ?&gt;
        &lt;h3&gt;Whoops! There was an error:&lt;/h3&gt;
        &lt;p&gt;&lt;?php echo validation_errors(); ?&gt;&lt;/p&gt;
    &lt;?php endif; ?&gt;

    &lt;?php if (isset($login_fail)) : ?&gt;
        &lt;h3&gt;Login Error:&lt;/h3&gt;
        &lt;p&gt;Username or Password is incorrect, please try again.&lt;/p&gt;
    &lt;?php endif; ?&gt;

    &lt;table border="0" &gt;
        &lt;tr&gt;
            &lt;td&gt;User Email&lt;/td&gt;
            &lt;td&gt;&lt;?php echo form_input(array('name' =&gt; 'email', 'id' =&gt; 'email', 'value' =&gt; set_value('email', ''), 'maxlength' =&gt; '100', 'size' =&gt; '50', 'style' =&gt; 'width:100%')); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;Password&lt;/td&gt;
            &lt;td&gt;&lt;?php echo form_password(array('name' =&gt; 'password', 'id' =&gt; 'password', 'value' =&gt; set_value('password', ''), 'maxlength' =&gt; '100', 'size' =&gt; '50', 'style' =&gt; 'width:100%')); ?&gt;&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/table&gt;
    &lt;?php echo form_submit('submit', 'Submit'); ?&gt;
    or &lt;?php echo anchor('signin', 'cancel'); ?&gt;
<span class="strong"><strong>    &lt;?php echo anchor('signin/forgot_password', 'Forgot Password'); ?&gt;</strong></span>
&lt;?php echo form_close(); ?&gt;</pre></div><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip07"/>Tip</h3><p>We're only changing one line from this file: the highlighted line is an <code class="literal">anchor()</code> statement, which displays a link to the forgot password form.</p></div></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec36"/>How it works...</h2></div></div></div><p>Firstly, take a <a id="id92" class="indexterm"/>look at the <a id="id93" class="indexterm"/>following flowchart:</p><div class="mediaobject"><img src="graphics/2308OS_02_01.jpg" alt="How it works..."/></div><p>Now, let's imagine that a user has forgotten their password and wishes to be reminded of it. The user will click on the forgot password link in the amended signin form (<code class="literal">/path/to/codeigniter/application/views/signin/signin.php</code>), which redirects them to <code class="literal">public function forgot_password()</code> in the signin controller. The <code class="literal">forgot_password()</code> function immediately displays the, <code class="literal">/path/to/codeigniter/application/views/signin/forgot_password.php view</code>. The user enters an e-mail address and submits the form using the <span class="strong"><strong>Submit</strong></span> button.</p><p>Next the <code class="literal">forgot_password()</code> function will validate the input supplied by the user and if that input passes the validation rules the <code class="literal">forgot_password()</code> function will look in the database to see if a row exists in the register table whose e-mail matches the supplied e-mail in the form submission.  If a match is found a tracking code (this is used for the hidden form element in the form view file) is generated and assigned to the <code class="literal">$data</code> array.  This code is then written to the row in the database we just looked for, and an e-mail is sent to the e-mail address associated with the account (or row).  In this case we're using the PHPs <code class="literal">mail()</code> function rather than CodeIgniter's mail functionality; you can of course use CodeIgniter to send the e-mail rather than PHP <code class="literal">mail()</code>—we discuss sending e-mails in CodeIgniter in <a class="link" href="ch04.html" title="Chapter 4. Email, HTML Table, and Text Libraries">Chapter 4</a>, <span class="emphasis"><em>Email, HTML Table, and Text Libraries</em></span>, anyway—back to the story.</p><p>Next, it's over to our user. They should look in their e-mail inbox for the e-mail we've just sent them, if they do they'll see a link in that e-mail directing them back to our system and to <code class="literal">public function new_password()</code>. Clicking on that link will open the, <code class="literal">/path/to/codeigniter/application/views/signin/new_password.php view</code>, which will display the reset password form.</p><p>Remember that the <code class="literal">$code</code> we parameter generated? <code class="literal">$code</code> was the third URL parameter and is now set as a hidden form element. The user enters <a id="id94" class="indexterm"/>their e-mail and password (twice to confirm) and clicks on <span class="strong"><strong>Submit</strong></span>. The form then posts to <code class="literal">public function new_password()</code>, which validates for form.</p><p>Upon passing validation, the e-mail address and code are looked up in the register table. If found (and they match), a new <code class="literal">$hash</code> array <a id="id95" class="indexterm"/>is made and saved to their record in the database. Finally, they're redirected to the signin form, where they can log()in using their new password.</p></div></div></body></html>