<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Database in an OOP Way"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Database in an OOP Way</h1></div></div></div><p>Besides regular improvements in the OOP, PHP5 also introduces many new libraries to seamlessly work with database in an OOP way. These libraries provide you with improved performance, sometimes improved security features, and of course a whole lot of methods to interact with new features provided by the database server. </p><p>In this chapter we will discuss MySQL improved API, which is known as MySQLi. Take a look at basic PDO (well, not detailed because PDO is so huge that it is possible to write a whole book just on it), ADOdb, and PEAR::MDB2. In the mean time we will also take a look at Active Record pattern in PHP using ADOdb's active. One thing to note here is that we are not focusing on how to do general database manipulations. We will only focus on some specific topics which are interesting for PHP developers who are doing database programming in an OO way. </p><div class="section" title="Introduction to MySQLi"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec75"/>Introduction to MySQLi</h1></div></div></div><a id="id313" class="indexterm"/><a id="id314" class="indexterm"/><p>MySQLi is an improved extension introduced in PHP5 to work with advanced MySQL features like prepared statements and stored procedures. From a performance point of view, MySQLi is much better than a MySQL extension. Also this extension offers completely object oriented interfaces to work with a MySQL database which was not available before PHP5. But keep in mind that if your MySQL version is at least 4.1.3 or above, you will get it working. </p><p>So what are the major improvements? Let's have a look first: </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Improved performance over MySQL extensions</li><li class="listitem" style="list-style-type: disc">Flexible OO and Non OO interface</li><li class="listitem" style="list-style-type: disc">Advantage over new MySQL objects </li><li class="listitem" style="list-style-type: disc">Ability to create compressed connections </li><li class="listitem" style="list-style-type: disc">Ability to connect over SSL</li><li class="listitem" style="list-style-type: disc">Support for Prepared Statements</li><li class="listitem" style="list-style-type: disc">Support for Stored Procedure (SP)</li><li class="listitem" style="list-style-type: disc">Support for better replication and transaction</li></ul></div><p>We will look into some of these features in the following examples. But of course we are not going for anything introductory to MySQL, because that is out of scope for this book. We will just show you how to use OO interface using MySQLi and how to use some of these advanced features. </p><div class="section" title="Connecting to MySQL in an OO Way"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec25"/>Connecting to MySQL in an OO Way</h2></div></div></div><p>Remember those old days when you had to use procedural function <code class="literal">call</code> to connect to MySQL, even from your objects. Those days are over. Now you can take advantage of complete OO interface of MySQLi to talk to MySQL (well, there are a few procedural methods, but overall it's completely OO). Take a look at the following example: </p><div class="informalexample"><pre class="programlisting">&lt;?
$mysqli = new mysqli("localhost", "user", "password", "dbname");
if (mysqli_connect_errno()) {
   echo("Failed to connect, the error message is : ". 
                                          mysqli_connect_error());
   exit();
}
?&gt;</pre></div><p>If the connection fails, you may get an error message like this:</p><div class="informalexample"><pre class="programlisting">Failed to connect, the error message is : Access denied for user 
                      'my_user'@'localhost' (using password: YES)</pre></div></div><div class="section" title="Selecting Data in an OO Way"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec26"/>Selecting Data in an OO Way</h2></div></div></div><a id="id315" class="indexterm"/><p>Let's see how to select data from a table in an OO way using MySQLi API. </p><div class="informalexample"><pre class="programlisting">&lt;?php
$mysqli = new mysqli("localhost", "un" "pwd", "db");
if (mysqli_connect_errno()) {
   echo("Failed to connect, the error message is : ". 
                                     mysqli_connect_error());
   exit();
}
/* close connection */
$result = $mysqli -&gt;query("select * from users");
while ($data = $result-&gt;fetch_object())
{
  echo $data-&gt;name." : '".$data-&gt;pass."' \n";
}
?&gt;</pre></div><p>The output is as following:</p><div class="informalexample"><pre class="programlisting">robin : 'no password' 
tipu : 'bolajabena'<a id="id316" class="indexterm"/>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>Please note that it is not good practice to store users' passwords in plain text in your database without encrypting them in some way. The best way is to store just the hash of their passwords using some hash routines like <code class="literal">md5()</code>
</p></div></div></div><div class="section" title="Updating Data in an OO Way"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec27"/>Updating Data in an OO Way</h2></div></div></div><a id="id317" class="indexterm"/><p>There is no special deal with it. You can update your data as you previously did with MySQL extension. But for the sake of OO style, we are showing an example of how you can do that with <code class="literal">mysqli_query()</code> function as shown in the above example. Instantiate an instance of MySQLi object and then run the query. </p></div><div class="section" title="Prepared Statements"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec28"/>Prepared Statements</h2></div></div></div><a id="id318" class="indexterm"/><a id="id319" class="indexterm"/><p>Here we are in a really interesting section which has been introduced for the first time in PHP OO using MySQLi extension. The prepared statements are introduced in MySQL 5.0 versions (dynamic SQL) for better security and flexibility. It has a great performance boost over the regular one. </p><p>So what is actually a prepared statement? A prepared statement is nothing but a regular query that is pre-compiled by the MySQL sever that could be invoked later. Prepared statements reduce the chances of SQL injection and offers greater performance over the general non-prepared queries, as it need not perform different compilation steps at the run time.(It is already compiled, remember?)</p><a id="id320" class="indexterm"/><p>The following are advantages of using prepared statements:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Better Performance</li><li class="listitem" style="list-style-type: disc">Prevention of SQL injection</li><li class="listitem" style="list-style-type: disc">Saving memory while handling blobs</li></ul></div><a id="id321" class="indexterm"/><p>But there are drawbacks too!</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">There is no performance boost if you use prepared statements for a single call.</li><li class="listitem" style="list-style-type: disc">There is no query cache for using prepared statements.</li><li class="listitem" style="list-style-type: disc">Chance of memory leak if statements are not closed explicitly.</li><li class="listitem" style="list-style-type: disc">Not all statements can be used as a prepared statement. <a id="id322" class="indexterm"/></li></ul></div><p>Prepared statements can accept parameters at run time in the same order you specify them whilst preparing the query. In this section we will learn about creating prepared statements, passing values to them, and fetching results.</p><div class="section" title="Basic Prepared Statements"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec02"/>Basic Prepared Statements</h3></div></div></div><a id="id323" class="indexterm"/><p>Let's prepare a statement using PHP's native MySQLi extension. In the following example we will make a prepared statement, execute it, and fetch the result from it:</p><div class="informalexample"><pre class="programlisting">&lt;?
$mysqli  = new mysqli("localhost", "un" "pwd", "db");
if (mysqli_connect_errno()) {
   echo("Failed to connect, the error message is : ". 
                                 mysqli_connect_error());
   exit();
}
$stmt = $mysqli -&gt;prepare("select name, pass from users 
                                          order by name");

$stmt-&gt;execute();
//$name=null;
$stmt-&gt;bind_result($name, $pass);

while ($stmt-&gt;fetch())
{
  echo $name."&lt;br/&gt;";
}
?&gt;</pre></div><p>So what did we actually do in the above example? </p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We prepared the statement using the following code:<div class="informalexample"><pre class="programlisting">   $stmt = $mysqli-&gt;prepare("select name, pass from users order
                                                    by name");</pre></div></li><li class="listitem">Then we executed it:<div class="informalexample"><pre class="programlisting">	$stmt-&gt;execute();</pre></div></li><li class="listitem">Then we bound two variables with it, as there are two variables in our query:<div class="informalexample"><pre class="programlisting">	$stmt-&gt;bind_result($name, $pass);</pre></div></li><li class="listitem">Finally we fetched the result using: </li></ol></div><div class="informalexample"><pre class="programlisting">	$stmt-&gt;fetch()</pre></div><p>Whenever we called <code class="literal">fetch()</code>, the bound variables are populated with values. So we can now use them. <a id="id324" class="indexterm"/>
</p></div><div class="section" title="Prepared Statements with Variables"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec03"/>Prepared Statements with Variables</h3></div></div></div><a id="id325" class="indexterm"/><p>The advantage of prepared statements is that you can use variables with queries. First you can prepare the query by placing a <code class="literal">?</code> sign at the appropriate place, and then you can pass the value after preparing it. Let's have a look at the following example:</p><div class="informalexample"><pre class="programlisting">&lt;?
$mysqli = new mysqli("localhost", "un" "pwd", "db");
if (mysqli_connect_errno()) {
   echo("Failed to connect, the error message is : ". 
                                   mysqli_connect_error());
   exit();
}
$stmt = $mysqli-&gt;prepare("select name, pass from users 
                                            where name=?");
$stmt-&gt;bind_param("s",$name); //binding name as string
$name = "tipu";
$stmt-&gt;execute();
$name=null;
$stmt-&gt;bind_result($name, $pass);

while ($r = $stmt-&gt;fetch())
{
  echo $pass."&lt;br/&gt;";
}
?&gt;</pre></div><p>Here we prepare the query <code class="literal">"select name, pass from users where name=?</code>" where the name is definitely a string type value. As we bind parameters in the previous example for the result using <code class="literal">bind_results()</code>, here we have to bind parameters using <code class="literal">bind_params()</code> function. Besides that, we need to supply the data type of the parameters bound. </p><p>MySQL prepared statements support four types of parameters: </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">i</code>, means the corresponding variable has type integer </li><li class="listitem" style="list-style-type: disc"><code class="literal">d</code>, means the corresponding variable has type double </li><li class="listitem" style="list-style-type: disc"><code class="literal">s</code>, means the corresponding variable has type string </li><li class="listitem" style="list-style-type: disc"><code class="literal">b</code>, means the corresponding variable is a blob and will be sent in packets</li></ul></div><p>As our parameter is a string, we used the following line to bind the parameter:</p><div class="informalexample"><pre class="programlisting">$stmt-&gt;bind_param("<span class="strong"><strong>s</strong></span>",$name);</pre></div><p>After binding the variable, now we set the value to <code class="literal">$name</code> and call the <code class="literal">execute() </code>function. After that we fetch the values as before. <a id="id326" class="indexterm"/>
</p></div></div><div class="section" title="Using BLOB with Prepared Statements"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec29"/>Using BLOB with Prepared Statements</h2></div></div></div><a id="id327" class="indexterm"/><a id="id328" class="indexterm"/><a id="id329" class="indexterm"/><p>Prepared statements support handling <span class="strong"><strong>BLOB</strong></span> or <span class="strong"><strong>Binary Large Objects</strong></span> efficiently. If you manage BLOB with prepared statements, it will save you from greater memory consumption by sending the data as packets. Let's see how we can store BLOB (in this case, an image file). </p><p>Prepared statements support sending data in chunks using the <code class="literal">send_long_data()</code> function. In the following example we will store the image using this function, though you can send them as usual, unless your data exceeds the limit defined by the <code class="literal">max_allowed_packet</code> MySQL configuration variable. </p><div class="informalexample"><pre class="programlisting">&lt;?
$mysqli = new mysqli("localhost", "un" "pwd", "db");
if (mysqli_connect_errno()) {
   echo("Failed to connect, the error message is : ". 
                               mysqli_connect_error());
   exit();
}
$stmt = $mysqli-&gt;prepare("insert into images value(NULL,?)");
$stmt-&gt;bind_param("b",$image);
$image = file_get_contents("signature.jpg");//fetching content of 
//a file
$stmt-&gt;send_long_data(0,$image);
$stmt-&gt;execute();
?&gt;</pre></div><p>Our table schema is as shown below:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE 'images' (
  'id' int(11) NOT NULL auto_increment,
  'image' mediumblob,
  PRIMARY KEY  ('id')
) ENGINE=MyISAM;</pre></div><p>We choose medium BLOB as our data type because blob can store only 65KB of data, where as medium BLOB can store more than 16MB, and long blob can store more than 4GB data in it. </p><p>Now we will restore this BLOB data using the image again in prepared statement:</p><div class="informalexample"><pre class="programlisting">&lt;?
$mysqli = new mysqli("localhost", "username", "password", "test");
if (mysqli_connect_errno()) {
   echo("Failed to connect, the error message is : ". 
                                           mysqli_connect_error());
   exit();
}
$stmt = $mysqli-&gt;prepare("select image from images where id=?");
$stmt-&gt;bind_param("i",$id);
$id = $_GET['id'];
$stmt-&gt;execute();
$image=NULL;
$stmt-&gt;bind_result($image);
$stmt-&gt;fetch();
header("Content-type: image/jpeg");
echo $image;
?&gt;<a id="id330" class="indexterm"/>
</pre></div></div><div class="section" title="Executing Stored Procedure with MySQLi and PHP"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec30"/>Executing Stored Procedure with MySQLi and PHP</h2></div></div></div><a id="id331" class="indexterm"/><p>Stored procedure is another new addition to MySQL 5 which reduces the need for client‑side queries to a great extent. Using MySQLi extension, you can execute stored procedures in MySQL. We are not going to discuss stored procedures as that is out of scope for this book. There are several articles available in the Internet that will help you in writing stored procedures in MySQL. You can read this awesome one for getting a basic idea about advanced MySQL features: <a class="ulink" href="http://dev.mysql.com/tech-resources/articles/mysql-storedprocedures.pdf">http://dev.mysql.com/tech-resources/articles/mysql-storedprocedures.pdf</a>
</p><p>Let's create a small stored procedure and run it using PHP. This stored procedure can take an input and insert that record in a table: <a id="id332" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">DELIMITER $$;

DROP PROCEDURE IF EXISTS 'test'.'sp_create_user'$$

CREATE PROCEDURE 'sp_create_user'(IN uname VARCHAR(50))
BEGIN
INSERT INTO users(id,name) VALUES (null, uname); 
END$$

DELIMITER ;$$</pre></div><p>If you run this stored procedure in your database (using MySQL query builder or anything) the <code class="literal">sp_create_user</code> procedure will be created. </p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>You can manually execute any stored, procedure from MySQL client using "Execute" command. For example to execute the above stored procedure you have to use <code class="literal">call sp_create_user('
</code><span class="emphasis"><em><code class="literal">username</code></em></span><code class="literal">')</code>.</p></div></div><p>Now we will run this stored procedure using PHP code. Let's see.</p><div class="informalexample"><pre class="programlisting">&lt;?
$mysqli = new mysqli("localhost", "username", "password", "test");
if (mysqli_connect_errno()) {
   echo("Failed to connect, the error message is : ". 
                                mysqli_connect_error());
   exit();
}

$mysqli-&gt;query("call sp_create_user('hasin')");
?&gt;</pre></div><p>That's it!<a id="id333" class="indexterm"/>
</p></div></div></div>
<div class="section" title="PDO"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec76"/>PDO</h1></div></div></div><a id="id334" class="indexterm"/><a id="id335" class="indexterm"/><a id="id336" class="indexterm"/><p>Another new extension added in PHP 5.1 for managing databases is PDO (although PDO was available with PHP 5.0 as a PECL Extension). This comes with a set of drivers for working with different database engines. <span class="strong"><strong>PDO</strong></span> stands for <span class="strong"><strong>PHP Data Objects</strong></span>. It is developed to provide a lightweight interface for different database engines. And one of the very good features of PDO is that it works like a Data Access Layer so that you can use the same function names for all database engines. </p><p>You can connect to different databases using DSN (Data Source Name) strings. In the following example we will connect to a MySQL databases and retrieve some data. </p><div class="informalexample"><pre class="programlisting">&lt;?php
$dsn = 'mysql:dbname=test;host=localhost;';
$user = 'user';
$password = 'password';

try {
   $pdo = new PDO($dsn, $user, $password);
} 
catch (PDOException $e) 
{
   echo 'Connection failed: ' . $e-&gt;getMessage();
}

$result = $pdo-&gt;query("select * from users");
foreach ($result as $row)
echo $row['name'];

?&gt;</pre></div><p>That's fairly hassle free, right? It just connects to MySQL server with the DSN (here it connects to <code class="literal">test</code> database) and then executes the query. And Finally we display the result. </p><p>So what would this be like if we connected to a SQLite database? </p><div class="informalexample"><pre class="programlisting">&lt;?php
$dsn = 'sqlite:abcd.db';

try 
{
<span class="strong"><strong>    $pdo = new PDO($dsn);</strong></span>
<span class="strong"><strong>    $pdo-&gt;exec("CREATE TABLE users (id int, name VARCHAR)");</strong></span>
<span class="strong"><strong>    $pdo-&gt;exec("DELETE FROM users");</strong></span>
<span class="strong"><strong>    $pdo-&gt;exec("INSERT INTO users (name) VALUES('afif')");</strong></span>
<span class="strong"><strong>    $pdo-&gt;exec("INSERT INTO users (name) VALUES('tipu')");</strong></span>
<span class="strong"><strong>    $pdo-&gt;exec("INSERT INTO users (name) VALUES('robin')");</strong></span>
} 
catch (PDOException $e) {
   echo 'Connection failed: ' . $e-&gt;getMessage();
}

$result = $pdo-&gt;query("select * from users");
foreach ($result as $row)
echo $row['name'];

?&gt;</pre></div><p>See there is no change in the code except the DSN. </p><p>You can also create a SQLite database in memory and perform the operation there. Let's see the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?php
$dsn = 'sqlite::memory:';

try {
    $pdo = new PDO($dsn);
    $pdo-&gt;exec("CREATE TABLE users (id int, name VARCHAR)");
    $pdo-&gt;exec("DELETE FROM users");
    $pdo-&gt;exec("INSERT INTO users (name) VALUES('afif')");
    $pdo-&gt;exec("INSERT INTO users (name) VALUES('tipu')");
    $pdo-&gt;exec("INSERT INTO users (name) VALUES('robin')");
} 
catch (PDOException $e) 
{
   echo 'Connection failed: ' . $e-&gt;getMessage();
}

$result = $pdo-&gt;query("select * from users");
foreach ($result as $row)
echo $row['name'];

?&gt;</pre></div><p>We just changed the DSN here. </p><div class="section" title="DSN Settings for Different Databases Engines"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec31"/>DSN Settings for Different Databases Engines</h2></div></div></div><a id="id337" class="indexterm"/><p>Let us take a look at the DSN settings for different database engines to connect with PDO. Supported database drivers are as shown below:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">PDO_DBLIB for FreeTDS/Microsoft SQL Server/Sybase </li><li class="listitem" style="list-style-type: disc">PDO_FIREBIRD for Firebird/Interbase 6 </li><li class="listitem" style="list-style-type: disc">PDO_INFORMIX for IBM Informix Dynamic Server </li><li class="listitem" style="list-style-type: disc">PDO_MYSQL for MySQL 3.x/4.x/5.x </li><li class="listitem" style="list-style-type: disc">PDO_OCI for Oracle Call Interface </li><li class="listitem" style="list-style-type: disc">PDO_ODBC for ODBC v3 (IBM DB2, unixODBC and win32 ODBC) </li><li class="listitem" style="list-style-type: disc">PDO_PGSQL for PostgreSQL </li><li class="listitem" style="list-style-type: disc">PDO_SQLITE for SQLite 3 and SQLite 2</li></ul></div><p>Let's have a look at these sample driver-specific DSN settings: </p><div class="informalexample"><pre class="programlisting">mssql:host=localhost;dbname=testdb
sybase:host=localhost;dbname=testdb
dblib:host=localhost;dbname=testdb
firebird:User=john;Password=mypass;Database=DATABASE.GDE;
                         DataSource=localhost;Port=3050
informix:host=host.domain.com; service=9800;database=common_db; 
   server=ids_server; protocol=onsoctcp;EnableScrollableCursors=1

mysql:host=localhost;port=3307;dbname=testdb
mysql:unix_socket=/tmp/mysql.sock;dbname=testdb

oci:mydb
oci:dbname=//localhost:1521/mydb

odbc:testdb
odbc:DRIVER={IBM DB2 ODBC 
 DRIVER};HOSTNAME=localhost;PORT=50000;DATABASE=SAMPLE;PROTOCOL=TCPIP;
                                            UID=db2inst1;PWD=ibmdb2;
odbc:Driver={Microsoft Access Driver 
                            (*.mdb)};Dbq=C:\\db.mdb;Uid=Admin

pgsql:dbname=example;user=nobody;password=change_me;host=localhost;
                                            port=5432

sqlite:/opt/databases/mydb.sq3
sqlite::memory:
sqlite2:/opt/databases/mydb.sq2
sqlite2::memory:</pre></div></div><div class="section" title="Using Prepared Statements with PDO"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec32"/>Using Prepared Statements with PDO</h2></div></div></div><a id="id338" class="indexterm"/><p>Using PDO you can run prepared statements against your database. The benefits are the same as before. It increases the performance for multiple calls by parsing and caching the server-side query and it also eliminates the chance of SQL injection. </p><p>PDO prepared statements can take named variables, unlike what we've seen in the examples of MySQLi. </p><p>Let's take a look at the following example to understand this: </p><div class="informalexample"><pre class="programlisting">&lt;?php
$dsn = 'mysql:dbname=test;host=localhost;';
$user = 'username';
$password = 'password';

try {
    $pdo = new PDO($dsn, $user, $password);
} catch (PDOException $e) 
{
   echo 'Connection failed: ' . $e-&gt;getMessage();
}

$stmt = $pdo-&gt;prepare("select id from users where name=:name");
$name = "tipu";
$stmt-&gt;bindParam(<span class="strong"><strong>":name"</strong></span>,$name, PDO::PARAM_STR);
$stmt-&gt;execute();
$stmt-&gt;bindColumn("id",$id);
$stmt-&gt;fetch();
echo $id;
?&gt;</pre></div><p>But you can also run the example like this:</p><div class="informalexample"><pre class="programlisting">&lt;?php
$dsn = 'mysql:dbname=test;host=localhost;';
$user = 'username';
$password = 'password';

try {
    $pdo = new PDO($dsn, $user, $password);
} 
catch (PDOException $e) 
{
   echo 'Connection failed: ' . $e-&gt;getMessage();
}

$stmt = $pdo-&gt;prepare("select id from users where name=?");
$name = "tipu";
$stmt-&gt;bindParam(<span class="strong"><strong>1</strong></span>,$name, PDO::PARAM_STR);
$stmt-&gt;execute();

$stmt-&gt;bindColumn("id",$id);
$stmt-&gt;fetch();
echo $id;
?&gt;</pre></div><a id="id339" class="indexterm"/><p>Instead of calling <code class="literal">bindParam()</code>, you can use <code class="literal">bindValues()</code> like the following one:</p><div class="informalexample"><pre class="programlisting">$stmt-&gt;bindValue(1,"tipu", PDO::PARAM_STR);</pre></div></div><div class="section" title="Calling Stored Procedures"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec33"/>Calling Stored Procedures</h2></div></div></div><a id="id340" class="indexterm"/><p>PDO provides an easy way to call stored procedures. All you have to do is run "CALL SPNAME(PARAMS)" via <code class="literal">exec()</code> method: </p><div class="informalexample"><pre class="programlisting">$pdo-&gt;exec("CALL sp_create_user('david')");</pre></div></div><div class="section" title="Other Interesting Functions"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec34"/>Other Interesting Functions</h2></div></div></div><a id="id341" class="indexterm"/><p>There are several other interesting functions available in PDO. For example, take a look at the list below: </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">fetchAll()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">fetchColumn()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">rowCount()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">setFetchMode()</code></li></ul></div><p>The <code class="literal">fetchAll()</code> function can fetch all records from a result set. Let's have a look at the following example:</p><div class="informalexample"><pre class="programlisting">$stmt = $pdo-&gt;prepare("select * from users");
$stmt-&gt;execute();
echo "&lt;pre&gt;";
print_r($stmt-&gt;fetchAll());
echo "&lt;/pre&gt;";</pre></div><p>The <code class="literal">fetchColumn()</code> function helps to select data from any specific column after executing the statement. Let's take a look:</p><div class="informalexample"><pre class="programlisting">$stmt = $pdo-&gt;prepare("select * from users");
$stmt-&gt;execute();
while ($name = $stmt-&gt;fetchColumn(1))
{
  echo $name."&lt;br/&gt;";
}</pre></div><p>
<code class="literal">rowCount()</code> returns the number of affected rows after performing any <code class="literal">UPDATE</code> or <code class="literal">DELETE</code> query. But you must remember that it returns the number of affected rows by the latest executed query. </p><div class="informalexample"><pre class="programlisting">$stmt = $pdo-&gt;prepare("DELETE from users WHERE name='Anonymous'");
$stmt-&gt;execute();
echo $stmt-&gt;rowCount();</pre></div><p>
<code class="literal">setFetchMode()</code> helps you to set the fetch mode of PDO prepared statements. The available values are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">PDO::FETCH_NUM</code>: Fetch results as a numerically indexed array</li><li class="listitem" style="list-style-type: disc"><code class="literal">PDO::FETCH_ASSOC</code>: Fetch rows as index by column names as keys</li><li class="listitem" style="list-style-type: disc"><code class="literal">PDO::FETCH_BOTH</code>: Fetch as both of the above</li><li class="listitem" style="list-style-type: disc"><code class="literal">PDO::FETCH_OBJ</code>: Fetch the rows as objects where column names are set as properties. <a id="id342" class="indexterm"/></li></ul></div></div></div>
<div class="section" title="Introduction to Data Abstraction Layers"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec77"/>Introduction to Data Abstraction Layers</h1></div></div></div><a id="id343" class="indexterm"/><p>
<span class="strong"><strong>Data Abstraction Layers </strong></span>(<span class="strong"><strong>DALs</strong></span>) are developed to provide unified interfaces to work with every database engine. It provides similar API to work with every database engine independently. As the function names are similar for all platforms, they are easier to work with, easier to remember, and of course make your code portable. To make you understand the necessity of DAL, let me explain a common scenario. </p><p>Suppose Team Y gets a big project. Their client says that they will use MySQL. So team Y develops the application and when the time comes to deliver, the client requests the team to give support for PostgreSQL. They will pay for this change but they require the change early. </p><p>Team Y had designed the application using all native MySQL functions. So what will Team Y do? Will they rewrite everything to give support for PostgreSQL? Well, that is the only way they have to. But what will happen if they need to give support for MSSQL in the near future? Another rewrite? Can you imagine the cost of refactoring each and every time?</p><p>To save from these disasters, here comes the need for DAL where the code will remain the same and it could be changed to support any DB at any time without any major change. </p><p>There are many popular libraries to implement DAL for PHP. To name some of those, ADOdb and PEAR::MDB2 are very popular. PEAR::DB was very popular but its development has been discontinued (<a class="ulink" href="http://blog.agoraproduction.com/index.php?/archives/42-PEARDB-is-DEPRECATED,-GOT-IT.html#extended">http://blog.agoraproduction.com/index.php?/archives/42-PEARDB-is-DEPRECATED,-GOT-IT.html#extended</a>). </p><p>In this section we will discuss PEAR::MDB2 and ADOdb. We will see the basic database operations using it and learn how to install these libraries for working around. </p><div class="section" title="ADOdb"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec35"/>ADOdb</h2></div></div></div><a id="id344" class="indexterm"/><p>ADOdb is a nice and popular data abstraction layer developed by John Lim and released under LGPL. This is one of the very best data abstraction layers for PHP. You can get the latest version of ADOdb from <a class="ulink" href="http://adodb.sourceforge.net">http://adodb.sourceforge.net</a>.</p><div class="section" title="Installing ADOdb"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec04"/>Installing ADOdb</h3></div></div></div><a id="id345" class="indexterm"/><p>There is no install of ADodb as such. It is a set of classes and regular scripts. So all you have to do is just extract the archive in a location from where you can include the script. Let's take a look at the following image to understand the directory structure after extracting:</p><div class="mediaobject"><img src="graphics/2561_07_01.jpg" alt="Installing ADOdb"/></div></div><div class="section" title="Connecting to Different Databases"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec05"/>Connecting to Different Databases</h3></div></div></div><p>L<a id="id346" class="indexterm"/>ike PDO, you can connect to different database drivers using ADOdb. DSN is different from PDO. Let's take a look at the supported database list and their DSN strings. </p><p>ADOdb supports a common DSN format, like this:</p><div class="informalexample"><pre class="programlisting">$driver://$username:$password@hostname/$database?options[=value]</pre></div><p>So what are the available drivers supported by ADOdb? Let's take a look below. This is a list taken from the ADOdb manual for your understanding: </p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Name</p>
</th><th style="text-align: left" valign="bottom">
<p>Tested</p>
</th><th style="text-align: left" valign="bottom">
<p>Database<a id="id348" class="indexterm"/>
</p>
</th><th style="text-align: left" valign="bottom">
<p>Prerequisites</p>
</th><th style="text-align: left" valign="bottom">
<p>Operating Systems</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>access</p>
</td><td style="text-align: left" valign="top">
<p>B</p>
</td><td style="text-align: left" valign="top">
<p>Microsoft Access/Jet. You need to create an ODBC DSN.</p>
</td><td style="text-align: left" valign="top">
<p>ODBC </p>
</td><td style="text-align: left" valign="top">
<p>Windows only</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>ado</p>
</td><td style="text-align: left" valign="top">
<p>B</p>
</td><td style="text-align: left" valign="top">
<p>Generic ADO, not tuned for specific databases. Allows DSN-less connections. For best performance, use an OLEDB provider. This is the base class for all ado drivers.</p>
<p>You can set <code class="literal">$db-&gt;codePage</code> before connecting.</p>
</td><td style="text-align: left" valign="top">
<p>ADO or OLEDB provider</p>
</td><td style="text-align: left" valign="top">
<p>Windows only</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>ado_access</p>
</td><td style="text-align: left" valign="top">
<p>B</p>
</td><td style="text-align: left" valign="top">
<p>Microsoft Access/Jet using ADO. Allows DSN‑less connections. For best performance, use an OLEDB provider.</p>
</td><td style="text-align: left" valign="top">
<p>ADO or OLEDB provider</p>
</td><td style="text-align: left" valign="top">
<p>Windows only</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>ado_mssql</p>
</td><td style="text-align: left" valign="top">
<p>B</p>
</td><td style="text-align: left" valign="top">
<p>Microsoft SQL Server using ADO. Allows DSN-less connections. For best performance, use an OLEDB provider.</p>
</td><td style="text-align: left" valign="top">
<p>ADO or OLEDB provider</p>
</td><td style="text-align: left" valign="top">
<p>Windows only</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>db2</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>Uses PHP's db2-specific extension for better performance.</p>
</td><td style="text-align: left" valign="top">
<p>DB2 CLI/ODBC interface</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows. Requires IBM DB2 Universal Database client</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>odbc_db2</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>Connects to DB2 using generic ODBC extension.</p>
</td><td style="text-align: left" valign="top">
<p>DB2 CLI/ODBC interface</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows. Unix install hints. I have had reports that the <code class="literal">$host</code> and <code class="literal">$database</code> params have to be reversed in <code class="literal">Connect()</code> when using the CLI interface</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>vfp</p>
</td><td style="text-align: left" valign="top">
<p>A</p>
</td><td style="text-align: left" valign="top">
<p>Microsoft Visual FoxPro. You need to create an ODBC DSN.</p>
</td><td style="text-align: left" valign="top">
<p>ODBC</p>
</td><td style="text-align: left" valign="top">
<p>Windows only</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>fbsql</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>FrontBase. </p>
</td><td style="text-align: left" valign="top">
<p>?</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>ibase</p>
</td><td style="text-align: left" valign="top">
<p>B</p>
</td><td style="text-align: left" valign="top">
<p>Interbase 6 or earlier. Some users report you might need to use this<code class="literal">$db-&gt;PConnect('localhost:c:/ibase/employee.gdb', "sysdba", "masterkey")</code> to connect. Lacks <code class="literal">Affected_Rows</code> currently.You can set <code class="literal">$db-&gt;role</code>, <code class="literal">$db-&gt;dialect</code>, <code class="literal">$db-&gt;buffers</code> and <code class="literal">$db-&gt;charSet</code> before connecting.</p>
</td><td style="text-align: left" valign="top">
<p>Interbase client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>firebird</p>
</td><td style="text-align: left" valign="top">
<p>B</p>
</td><td style="text-align: left" valign="top">
<p>Firebird version of interbase.</p>
</td><td style="text-align: left" valign="top">
<p>Interbase client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>borland_ibase</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>Borland version of Interbase 6.5 or later. Very sad that the forks differ.</p>
</td><td style="text-align: left" valign="top">
<p>Interbase client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>informix</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>Generic informix driver. Use this if you are using Informix 7.3 or later.</p>
</td><td style="text-align: left" valign="top">
<p>Informix client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>informix72</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>Informix databases before Informix 7.3 that do no support <code class="literal">SELECT FIRST</code>.</p>
</td><td style="text-align: left" valign="top">
<p>Informix client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>ldap</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>LDAP driver. See this example for usage information.</p>
</td><td style="text-align: left" valign="top">
<p>LDAP extension</p>
</td><td style="text-align: left" valign="top">
<p>?</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>mssql</p>
</td><td style="text-align: left" valign="top">
<p>A</p>
</td><td style="text-align: left" valign="top">
<p>Microsoft SQL Server 7 and later. Works with Microsoft SQL Server 2000 also. Note that date formating is problematic with this driver. For example, the PHP MSSQL extension does not return the seconds for datetime!<a id="id351" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Mssql client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows. Unix install howto and another one. </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>mssqlpo</p>
</td><td style="text-align: left" valign="top">
<p>A</p>
</td><td style="text-align: left" valign="top">
<p>Portable mssql driver. Identical to above mssql driver, except that '||', the concatenation operator, is converted to '+'. Useful for porting scripts from most other sql variants that use ||.</p>
</td><td style="text-align: left" valign="top">
<p>Mssql client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows. Unix install howto.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>mysql</p>
</td><td style="text-align: left" valign="top">
<p>A</p>
</td><td style="text-align: left" valign="top">
<p>MySQL without transaction support. You can also set <code class="literal">$db-&gt;clientFlags</code> before connecting.</p>
</td><td style="text-align: left" valign="top">
<p>MySQL client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>mysqli</p>
</td><td style="text-align: left" valign="top">
<p>B</p>
</td><td style="text-align: left" valign="top">
<p>Supports the newer PHP5 MySQL API.</p>
</td><td style="text-align: left" valign="top">
<p>MySQL 4.1+ client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>mysqlt or maxsql</p>
</td><td style="text-align: left" valign="top">
<p>A</p>
</td><td style="text-align: left" valign="top">
<p>MySQL with transaction support. We recommend using || as the concat operator for best portability. This can be done by running MySQL using: <code class="literal">mysqld --ansi or mysqld --sql-mode=PIPES_AS_CONCAT</code>
</p>
</td><td style="text-align: left" valign="top">
<p>MySQL client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>oci8</p>
</td><td style="text-align: left" valign="top">
<p>A</p>
</td><td style="text-align: left" valign="top">
<p>Oracle 8/9. Has more functionality than oracle driver (eg. <code class="literal">Affected_Rows</code>). You might have to <code class="literal">putenv('ORACLE_HOME=...')</code> before Connect/PConnect. </p>
<p>There are 2 ways of connecting: with server IP and service name: <code class="literal">PConnect('serverip:1521','scott','tiger','service')</code>or using an entry in TNSNAMES.ORA or ONAMES or HOSTNAMES: <code class="literal">PConnect(false, 'scott', 'tiger', $oraname)</code>. </p>
<p>Since 2.31, we support Oracle REF cursor variables directly (see <code class="literal">ExecuteCursor</code>). <a id="id352" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Oracle client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>oci805</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>Supports reduced Oracle functionality for Oracle 8.0.5. <code class="literal">SelectLimit</code> is not as efficient as in the oci8 or oci8po drivers.</p>
</td><td style="text-align: left" valign="top">
<p>Oracle client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>oci8po</p>
</td><td style="text-align: left" valign="top">
<p>A</p>
</td><td style="text-align: left" valign="top">
<p>Oracle 8/9 portable driver. This is nearly identical with the oci8 driver except (a) bind variables in <code class="literal">Prepare()</code> use the <code class="literal">?</code> convention, instead of <code class="literal">:bindvar</code>, (b) field names use the more common PHP convention of lowercase names. </p>
<p>Use this driver if porting from other databases is important. Otherwise the oci8 driver offers better performance. </p>
</td><td style="text-align: left" valign="top">
<p>Oracle client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>odbc</p>
</td><td style="text-align: left" valign="top">
<p>A</p>
</td><td style="text-align: left" valign="top">
<p>Generic ODBC, not tuned for specific databases. To connect, use <code class="literal">PConnect('DSN','user','pwd')</code>. This is the base class for all ODBC derived drivers.</p>
</td><td style="text-align: left" valign="top">
<p>ODBC</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows. Unix hints</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>odbc_mssql</p>
</td><td style="text-align: left" valign="top">
<p>A</p>
</td><td style="text-align: left" valign="top">
<p>Uses ODBC to connect to MSSQL</p>
</td><td style="text-align: left" valign="top">
<p>ODBC</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>odbc_oracle</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>Uses ODBC to connect to Oracle</p>
</td><td style="text-align: left" valign="top">
<p>ODBC</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>odbtp</p>
</td><td style="text-align: left" valign="top">
<p>B</p>
</td><td style="text-align: left" valign="top">
<p>Generic odbtp driver. Odbtp is a software for accessing Windows ODBC data sources from other operating systems.</p>
</td><td style="text-align: left" valign="top">
<p>odbtp</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>odbtp_unicode</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>Odtbp with unicode support</p>
</td><td style="text-align: left" valign="top">
<p>odbtp</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>oracle</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>Implements old Oracle 7 client API. Use oci8 driver if possible for better performance.</p>
</td><td style="text-align: left" valign="top">
<p>Oracle client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>netezza</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>Netezza driver. Netezza is based on PostGREs code-base.</p>
</td><td style="text-align: left" valign="top">
<p>?</p>
</td><td style="text-align: left" valign="top">
<p>?</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>pdo</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>Generic PDO driver for PHP5. </p>
</td><td style="text-align: left" valign="top">
<p>PDO extension and database specific drivers</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>postgres</p>
</td><td style="text-align: left" valign="top">
<p>A</p>
</td><td style="text-align: left" valign="top">
<p>Generic PostgreSQL driver. Currently identical to postgres7 driver. </p>
</td><td style="text-align: left" valign="top">
<p>PostgreSQL client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>postgres64</p>
</td><td style="text-align: left" valign="top">
<p>A</p>
</td><td style="text-align: left" valign="top">
<p>For PostgreSQL 6.4 and earlier which does not support LIMIT internally.</p>
</td><td style="text-align: left" valign="top">
<p>PostgreSQL client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>postgres7</p>
</td><td style="text-align: left" valign="top">
<p>A</p>
</td><td style="text-align: left" valign="top">
<p>PostgreSQL which supports LIMIT and other version 7 functionality.</p>
</td><td style="text-align: left" valign="top">
<p>PostgreSQL client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>postgres8</p>
</td><td style="text-align: left" valign="top">
<p>A</p>
</td><td style="text-align: left" valign="top">
<p>Currently identical to postgres7<a id="id355" class="indexterm"/>.</p>
</td><td style="text-align: left" valign="top">
<p>PostgreSQL client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>sapdb</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>SAP DB. Should work reliably as based on ODBC driver.</p>
</td><td style="text-align: left" valign="top">
<p>SAP ODBC client</p>
</td><td style="text-align: left" valign="top">
<p>?</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>sqlanywhere</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>Sybase SQL Anywhere. Should work reliably as based on ODBC driver.</p>
</td><td style="text-align: left" valign="top">
<p>SQL Anywhere ODBC client</p>
</td><td style="text-align: left" valign="top">
<p>?</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>sqlite</p>
</td><td style="text-align: left" valign="top">
<p>B</p>
</td><td style="text-align: left" valign="top">
<p>SQLite.</p>
</td><td style="text-align: left" valign="top">
<p>-</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>sqlitepo</p>
</td><td style="text-align: left" valign="top">
<p>B</p>
</td><td style="text-align: left" valign="top">
<p>Portable SQLite driver. This is because assoc mode does not work like other drivers in SQLite. Namely, when selecting (joining) multiple tables, the table names are included in the assoc keys in the "sqlite" driver. </p>
<p>In "sqlitepo" driver, the table names are stripped from the returned column names. When this results in a conflict, the first field get preference. </p>
</td><td style="text-align: left" valign="top">
<p>-</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>sybase</p>
</td><td style="text-align: left" valign="top">
<p>C</p>
</td><td style="text-align: left" valign="top">
<p>Sybase. 
</p>
</td><td style="text-align: left" valign="top">
<p>Sybase client</p>
</td><td style="text-align: left" valign="top">
<p>Unix and Windows</p>
</td></tr></tbody></table></div></div><div class="section" title="Basic Database Operations using ADOdb"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec06"/>Basic Database Operations using ADOdb</h3></div></div></div><p>Remember the directory structure that saw minutes ago? Now we are going to make use of those scripts. In this section we will learn basic database operation using ADOdb. Let's connect to MySQL and perform a basic operation: </p><div class="informalexample"><pre class="programlisting">&lt;?
include("adodb/adodb.inc.php");
$dsn = 'mysql://username:password@localhost/test?persist';
$conn = ADONewConnection($dsn); 
$conn-&gt;setFetchMode(ADODB_FETCH_ASSOC);
$recordSet = $conn-&gt;Execute('select * from users');

if (!$recordSet)
print $conn-&gt;ErrorMsg(); //if any error is there
else
while (!$recordSet-&gt;EOF) {
  echo $recordSet-&gt;fields['name'].'&lt;BR&gt;';
  $recordSet-&gt;MoveNext();
} 
?&gt;</pre></div><p>Let's see an alternate connection example:</p><div class="informalexample"><pre class="programlisting">&lt;?
include("adodb/adodb.inc.php");
$conn =ADONewConnection('mysql');//just the RDBMS type 
$conn-&gt;connect("localhost","username","password","test");
//here comes the credentials
?&gt;</pre></div></div><div class="section" title="Inserting, Deleting, and Updating Records"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec07"/>Inserting, Deleting, and Updating Records</h3></div></div></div><p>You can execute any SQL statement using <code class="literal">execute()</code> method of <code class="literal">ADONewConnection</code> or <code class="literal">ADOConnection</code> object. So nothing is new here. But let's see how can we insert/delete/update some records and track the success or failure. </p><div class="informalexample"><pre class="programlisting">&lt;?
include("adodb/adodb.inc.php");
$conn =ADONewConnection('mysql');
$conn-&gt;connect("localhost","user","password","test");
$conn-&gt;setFetchMode(ADODB_FETCH_ASSOC);
$res = $conn-&gt;execute("insert into users(name) values('test')");
echo $conn-&gt;Affected_Rows();
?&gt;</pre></div><p>So, <code class="literal">Affected_Rows</code> gives you the result for these scenarios. 

</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip03"/>Tip</h3><p>
<span class="strong"><strong>Insert Id</strong></span>
</p><p>If you are looking to find the latest inserted ID, you can use the <code class="literal">Insert_Id()</code> function. </p></div></div></div><div class="section" title="Executing Prepared Statements"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec08"/>Executing Prepared Statements</h3></div></div></div><a id="id354" class="indexterm"/><p>ADOdb provides easy API to create and execute prepared statements. Let's take a look at the following example to understand how that works: </p><div class="informalexample"><pre class="programlisting">&lt;?
include("adodb/adodb.inc.php");
$conn =ADONewConnection('mysql');
$conn-&gt;connect("localhost","user","password","test") ;
$conn-&gt;setFetchMode(ADODB_FETCH_ASSOC);
$stmt = $conn-&gt;Prepare('insert into users(name) values (?)');

$conn-&gt;Execute($stmt,array((string) "afif"));

echo $conn-&gt;Affected_Rows();
?&gt;</pre></div><p>You can retrieve records in the same way. </p></div></div><div class="section" title="MDB2"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec36"/>MDB2</h2></div></div></div><p>MDB2 is another popular data abstraction library developed under PEAR by combining the best features of PEAR::DB and Metabase. It provides very consistent API, improved performance, and solid development platform over DB and MDB. MDB2 comes with an excellent set of documentation. In this chapter we surely cannot cover all the features supported by MDB2 but we will go through the basic features to make you understand how it works. </p><div class="section" title="Installing MDB2"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec09"/>Installing MDB2</h3></div></div></div><a id="id356" class="indexterm"/><p>Installing MDB2 requires a working version of PEAR. So to work with MDB2 you must have PEAR installed and functioning in your machine. If you don't have PEAR installed, the following tip will be helpful for you. </p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip04"/>Tip</h3><p>
<span class="strong"><strong>Installing PEAR</strong></span>
</p><p>Go to <a class="ulink" href="http://pear.php.net/go-pear">http://pear.php.net/go-pear</a> and save the page as <code class="literal">go-pear.php</code> in your hard drive. Now apply the command <code class="literal">php /path/to/go-pear.php</code> in your shell or command prompt and follow the instructions there. If it asks whether you want to install MDB2, say 'Yes'. Also say Yes, if it wants to modify your <code class="literal">php.ini</code> file. Don't worry, it will just add entries to make PEAR available in your current include path, and all other settings will remain the same as before. So you are done. </p></div></div><p>If you have PEAR I installed but not MDB2, then you can install it in a second. Open your shell or command prompt and apply the following commands: </p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>pear install MDB2
pear install MDB2_Driver_$driver</strong></span></pre></div><p>Where <code class="literal">$driver</code> could be anything like SQLite, PgSQL, MySQL, MYSQLi, oci8, MSSQL, and ibase. So for example, to install MySQL driver you have to apply the command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>pear install MDB2_Driver_mysql</strong></span></pre></div><p>That's it. You are done. </p></div><div class="section" title="Connecting to Database"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec10"/>Connecting to Database</h3></div></div></div><a id="id357" class="indexterm"/><p>Using MDB2 you can connect to different database engines. MDB2 also has a formatted DSN string to connect. The format of that DSN is as shown: </p><div class="informalexample"><pre class="programlisting">phptype(dbsyntax)://username:password@protocol+hostspec/database?
                                                      option=value</pre></div><p>But there are some variations in this DSN. These are listed here:</p><div class="informalexample"><pre class="programlisting">phptype://username:password@protocol+hostspec:110//usr/db_file.db
phptype://username:password@hostspec/database
phptype://username:password@hostspec
phptype://username@hostspec
phptype://hostspec/database
phptype://hostspec
phptype:///database
phptype:///database?option=value&amp;anotheroption=anothervalue</pre></div><p>The supported drivers (PHPtype) are shown here: </p><div class="informalexample"><pre class="programlisting">fbsql  -&gt; FrontBase
ibase  -&gt; InterBase / Firebird (requires PHP 5)
mssql  -&gt; Microsoft SQL Server (NOT for Sybase. Compile PHP --with-mssql)
mysql  -&gt; MySQL
mysqli -&gt; MySQL (supports new authentication protocol) (requires PHP 5)
oci8   -&gt; Oracle 7/8/9/10
pgsql  -&gt; PostgreSQL
querysim -&gt; QuerySim
sqlite -&gt; SQLite 2</pre></div><p>Now let's connect to MySQL:</p><div class="informalexample"><pre class="programlisting">&lt;?php
set_include_path(get_include_path().";".
                   "C:/Program Files/PHP/pear;");
require_once 'MDB2.php';

$dsn = 'mysql://user:password@localhost/test';
$options = array('persistent' =&gt; true
);

$mdb2 = MDB2::factory($dsn, $options);
if (PEAR::isError($mdb2)) {
    die($mdb2-&gt;getMessage());
}

// ...

$result = $mdb2-&gt;query("select * from users");

while ($row = $result-&gt;fetchRow(MDB2_FETCHMODE_ASSOC))
{
	echo $row['name']."\n";
}

$mdb2-&gt;disconnect();
?&gt;<a id="id358" class="indexterm"/>
</pre></div></div><div class="section" title="Executing Prepared Statements"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec11"/>Executing Prepared Statements</h3></div></div></div><a id="id359" class="indexterm"/><p>You can execute prepared statements using MDB2 easily. MDB2 provides flexible API for creating and executing prepared statements. In the following example we will execute two types of prepared statements. One which will just execute some insert/update/delete queries, and another which will return some data as output.  </p><div class="informalexample"><pre class="programlisting">&lt;?php
set_include_path(get_include_path().";".
                         "C:/Program Files/PHP/pear;");
require_once 'MDB2.php';

$dsn = 'mysql://user:password@localhost/test';
$options = array('persistent' =&gt; true
);

$mdb2 = MDB2::factory($dsn, $options);
if (PEAR::isError($mdb2)) {
    die($mdb2-&gt;getMessage());
}

$stmt = $mdb2-&gt;Prepare("insert into users(name) 
                    values(?)",array("text"),MDB2_PREPARE_MANIP);
//for DML statements, we should use MDB2_PREPARE_MANIP and For 
//Reading we should use MDB2_PREPARE_RESULT
echo $stmt-&gt;execute("Mohiuddin");


$stmt = $mdb2-&gt;Prepare("select name from users where 
                       id=?",array("integer"),array("text"));
$result = $stmt-&gt;execute(11);
if (PEAR::isError($result))
echo $result-&gt;getMessage();

while ($row = $result-&gt;fetchRow())
{
  echo $row[0];
}
?&gt;<a id="id360" class="indexterm"/>
</pre></div><p>Now what if we want to insert in multiple fields? Well for example, if we have another field like "age" in our table, we need to pass data like this:</p><div class="informalexample"><pre class="programlisting">$stmt = $mdb2-&gt;Prepare("insert into users(name,age) 
   values(?)",array("text","integer"),MDB2_PREPARE_MANIP);
echo $stmt-&gt;execute("Mohiuddin",2);</pre></div><p>Or:</p><div class="informalexample"><pre class="programlisting">$stmt = $mdb2-&gt;Prepare("insert into users(name,age) 
   values(?)",array("text","integer"),MDB2_PREPARE_MANIP);
echo $stmt-&gt;execute(<span class="strong"><strong>array</strong></span>("Mohiuddin",2));</pre></div><p>So we can also insert multiple rows at once using <code class="literal">executeMultiple()</code> method:</p><div class="informalexample"><pre class="programlisting">$stmt = $mdb2-&gt;Prepare("insert into users(name,age) values(?)",array("text","integer"),MDB2_PREPARE_MANIP);
echo $stmt-&gt;<span class="strong"><strong>executeMultiple</strong></span>(array(array("Mohiuddin",2),
                                         array("another",3));</pre></div><p>That's it. <a id="id361" class="indexterm"/>
</p></div></div></div>
<div class="section" title="Introduction to ActiveRecord"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec78"/>Introduction to ActiveRecord</h1></div></div></div><a id="id362" class="indexterm"/><p>ActiveRecord is a design pattern created to solve the data accessing problem in a fairly readable manner. Using ActiveRecord design pattern you can manipulate data like a charm. In this section we will go through the basic features of an ActiveRecord implementation in PHP. </p><p>Let's see how ActiveRecord actually works. For this, we will use ADOdb's active record implementation. Adodb provides a class named <code class="literal">Adodb_Active_Record</code> devoted to it. </p><p>Let's create a table in our database with the following structure: </p><div class="informalexample"><pre class="programlisting">CREATE TABLE 'users' (
  'id' int(11) NOT NULL auto_increment,
  'name' varchar(250),
  'pass' varchar(32),
  PRIMARY KEY  ('id')
) ENGINE=MyISAM;</pre></div><div class="section" title="Creating a New Record via ActiveRecord"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec37"/>Creating a New Record via ActiveRecord</h2></div></div></div><a id="id363" class="indexterm"/><p>Now we will create a new user in this table. Have a look at the following code: </p><div class="informalexample"><pre class="programlisting">&lt;?
include("adodb/adodb.inc.php");
include('adodb/adodb-active-record.inc.php');
$conn =ADONewConnection('mysql');
$conn-&gt;connect("localhost","user","password","test") ;

ADODB_Active_Record::setDatabaseAdapter($conn);
class User extends ADODB_Active_Record {}
$user = new User();//a dynamic model to access the user table
$user-&gt;name = "Packt";
$user-&gt;pass = "Hello";
$user-&gt;save();//calling save() will internally save this 
      //record in table
?&gt;</pre></div><p>ActiveRecord exposes a separate object for every table in your database by which you can perform different operations. Let's take a look at how we can select some data. <a id="id364" class="indexterm"/>
</p></div><div class="section" title="Selecting and Updating Data"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec38"/>Selecting and Updating Data</h2></div></div></div><a id="id365" class="indexterm"/><a id="id366" class="indexterm"/><p>We can load and change any record using ActiveRecord easily. Let's have a look at the following example: </p><div class="informalexample"><pre class="programlisting">&lt;?
include("adodb/adodb.inc.php");
include('adodb/adodb-active-record.inc.php');
$conn =ADONewConnection('mysql');
$conn-&gt;connect("localhost","user","password","test") ;

ADODB_Active_Record::setDatabaseAdapter($conn);
class User extends ADODB_Active_Record {}
$user = new User();
$user-&gt;load("id=10");//load the record where the id is 10
echo $user-&gt;name;
$user-&gt;name= "Afif Mohiuddin";//now update
$user-&gt;save();//and save the previously loaded record
?&gt;</pre></div><p>So that's fairly easy. When you call the <code class="literal">load()</code> method with any expression, the record will be loaded into the object itself. Then you can make any change and finally save it. ActiveRecord is extremely charming to work with. </p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec79"/>Summary</h1></div></div></div><p>You finished reading a chapter devoted for total DB access using the OOP way. There are lot other interesting projects like Propel (<a class="ulink" href="http://propel.phpdb.org/trac/">http://propel.phpdb.org/trac/</a>) as Object Relational Mapping library for PHP developers, Creole (<a class="ulink" href="http://creole.phpdb.org/trac/">http://creole.phpdb.org/trac/</a>) as a DAL, ActiveRecord library from CodeIgniter framework (<a class="ulink" href="http://www.codeigniter.com">http://www.codeigniter.com</a>), and many more. You have got a large number of resources available to manipulate database using PHP5 and OO style. </p><p>In the next chapter we will learn about using XML in PHP. You will be surprised to find that you can use plain XML files as a lightweight alternative of regular heavyweight database engines. Until then, happy coding.</p></div></body></html>