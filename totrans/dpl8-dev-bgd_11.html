<html><head></head><body><div class="chapter" title="Chapter&#xA0;11.&#xA0;Searching Your Site with the Search API Module"><div class="titlepage"><div><div><h1 class="title"><a id="ch11"/>Chapter 11. Searching Your Site with the Search API Module</h1></div></div></div><p><span class="emphasis"><em>In this chapter, we are going to look at a more powerful and flexible replacement for the search module that comes packaged with Drupal core. We'll walk through the installation of the Apache Solr search server and look at ways of enhancing the user's search experience.</em></span></p><p>In this chapter, we will learn:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How to choose a suitable search configuration for your needs</li><li class="listitem" style="list-style-type: disc">Installing and configuring the Search API module to replace the Drupal core search</li><li class="listitem" style="list-style-type: disc">Installing and configuring the Apache Solr search server using two different methods</li><li class="listitem" style="list-style-type: disc">Setting up a search server and a search index using the Search API module</li><li class="listitem" style="list-style-type: disc">Creating custom faceted search blocks to enhance the user's search experience</li></ul></div><div class="section" title="The Drupal core search"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec137"/>The Drupal core search</h1></div></div></div><p>Like Drupal 7, Drupal 8 <a class="indexterm" id="id565"/>core comes packaged with its own built-in search module. This provides usable search functionality by querying the Drupal database directly. The Drupal core search allows you to search for user profiles and for node content. It periodically queries the database to maintain an index of content without requiring any prior configuration.</p><p>The Drupal search may be fine for your needs if you only require basic search functionality and you don't have a large amount of site traffic. However, it has several functional limitations which include the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">It uses the Drupal database to carry out its queries, placing extra load on the database which may already be a performance bottleneck on your site</li><li class="listitem" style="list-style-type: disc">It's not possible to control which nodes are indexed for the search</li><li class="listitem" style="list-style-type: disc">The content is always indexed based on the default display mode of each node</li><li class="listitem" style="list-style-type: disc">The search only matches whole keywords for nodes</li></ul></div><p>If you mind about any of these limitations, you should switch to using the Search API module.</p><p>As well as allowing additional control over how your content is searched and indexed, the Search API module gives you the option of taking a load off the Drupal database by integrating with a third-party search engine.</p><p>If the complexity of your site or the amount of traffic it gets has increased to a point to which the performance of the database is becoming a bottleneck, you'll need to use the Search API module in conjunction with a third party search engine so that the Drupal database is left to concentrate on other things. Apache Solr is an example of a third party search engine which we'll use in this chapter.</p></div></div>
<div class="section" title="The Search API module"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec138"/>The Search API module</h1></div></div></div><p>The<a class="indexterm" id="id566"/> Search API module (<a class="ulink" href="http://www.drupal.org/project/search_api">http://www.drupal.org/project/search_api</a>) replaces the Drupal core search with a framework<a class="indexterm" id="id567"/> that can be used with different kinds of underlying search engines. The search engines exist as third parties independent of the Drupal site and its database.</p><p>Thomas Seidl (also known as "drunken monkey") is one of the main contributors to the Search API module. This is how he explained its origins:</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"Search API was created in 2010. I was involved in discussions about how to improve Drupal's core search module and turn it into more of a framework for Drupal 8. The problem was that there was no search framework in Drupal and all search-related modules had to include the same boilerplate code over and over. I took the best parts of that discussion and turned them into a contributed module and search framework for Drupal 7."</em></span></p></blockquote></div><p>The Search API module <a class="indexterm" id="id568"/>can be extended with other contributed modules to provide very powerful search functionality. Search API also integrates with the Views module, which allows you to create Views listing pages based on search terms entered by the user.</p><p>The Apache Solr search engine we'll use later is open source, fast, and has many features. However, in place of a search engine, we also have the option of continuing to query the Drupal database with the Search API module. This has the advantage that we can set up any complex configuration we require based on the Search API without installing a search engine in our development environment. Then, when we deploy our site to a production environment we can swap to using a search engine with minimal re-configuration.</p><p>We'll start by setting up the Search API module to search using the Drupal database. This will allow us to explore some of the features and concepts that the Search API module provides. Later on, we'll swap to using the Apache Solr search engine with Search API and explore some more powerful search functionality.</p></div>
<div class="section" title="Time for action &#x2013; basic installation and configuration of the Search API module"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec139"/>Time for action – basic installation and configuration of the Search API module</h1></div></div></div><p>In the following steps, we'll download, install, and configure the Search API module:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, download<a class="indexterm" id="id569"/> the <code class="literal">search_api</code> module using the method that you're used to. If you have Drush installed, as explained in the <span class="emphasis"><em>Mobile First, Responsive Design</em></span> section of <a class="link" href="ch05.html" title="Chapter 5. Theming in Drupal 8">Chapter 5</a>, <span class="emphasis"><em>Theming in Drupal 8</em></span>, you'll be able to type the following at the command line:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ drush dl search_api</strong></span>
<span class="strong"><strong>$ drush en search_api</strong></span>
</pre></div></li><li class="listitem">Before we go further, we should follow Drupal's suggestion to uninstall the core search module which the Search API module replaces.<div class="mediaobject"><img alt="Time for action – basic installation and configuration of the Search API module" src="graphics/4659_11_01.jpg"/></div><p>You'll be notified of this via a command line message if you install the module via Drush, or the message will appear on the <span class="strong"><strong>Status Report</strong></span> page at <span class="strong"><strong>Reports</strong></span> | <span class="strong"><strong>Status report</strong></span>. Disabling the core search module will remove the search block as well as the search pages for content and users. Don't panic, we'll replace them. To install the core search module with drush, type:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ drush pm-uninstall search</strong></span>
</pre></div></li><li class="listitem">Search API <a class="indexterm" id="id570"/>does not do anything on its own - we need to give it a search engine to interact with. To do this, we'll use a submodule that you will have downloaded as part of <code class="literal">search_api</code> called <code class="literal">search_api_db</code>. Enable it now using the method that you're used to.<p>The <code class="literal">search_api_db</code> module allows the Search API to interact directly with the Drupal database. This has the advantage of being simple to set up, and on small sites where the database does not already have significant load on it, you can use this method of search on the production server.</p></li><li class="listitem">The <code class="literal">search_api_db</code> module contains a very handy submodule which sets up some sensible default configuration. You can then use this configuration as the basis of your search setup. To take advantage of this, enable <code class="literal">search_api_db_defaults</code> and then disable it again. All the configuration happens when the module is initially enabled and will remain when you disable the module.</li><li class="listitem">If you now navigate to <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Search and metadata</strong></span> | <span class="strong"><strong>Search API</strong></span>, you should see a screen similar to the following:<div class="mediaobject"><img alt="Time for action – basic installation and configuration of the Search API module" src="graphics/4659_11_02.jpg"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec89"/><span class="emphasis"><em>What just happened?</em></span></h2></div></div></div><p>You downloaded <a class="indexterm" id="id571"/>and installed the Search API module and used one of its submodules to install some default configuration. We can now see that this configuration includes a search server and a search index, and we'll examine what this means.</p><p>In the next few sections, we'll review some aspects of the default settings that have been set up by the <code class="literal">search_api_db_defaults</code> module. Note that some of these settings and screen layouts may change in subsequent versions of the modules that we're using. We won't cover all the settings, but hopefully enough to give you a good start in customizing the settings to your own needs.</p></div><div class="section" title="An explanation of search servers and search indexes"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec90"/>An explanation of search servers and search indexes</h2></div></div></div><p>In <a class="indexterm" id="id572"/>Drupal terminology, a search server defines how searchable data is indexed. This includes the way in which it is queried on your Drupal site and how the search index is stored. These things are dictated by the <span class="emphasis"><em>backend</em></span> that you choose to give your search  server. In this chapter, we'll be looking at search servers that use the Drupal database as a backend and the Apache Solr search engine as a backend. However, there are other backends that you can use which will define other ways in which your data is queried and indexed.</p><p>The <a class="indexterm" id="id573"/>search index defines the indexing process. The search index is associated with a search server that you previously configured to power it. The search index settings dictate things such as the types of content that gets indexed on your site, the fields that are indexed, and various ways the data is processed before, during, and after the search.</p><p>By splitting the configuration up into a search server and a search index, it is possible to swap out the search engine that performs the work whilst maintaining the way the data is queried and indexed. This is a little akin to being able to swap the petrol engine in your car for a diesel one whilst maintaining everything else about the way it looks and feels to drive.</p><p>It's also possible to have more than one search server and choose which one is most appropriate to use, depending on the point you're at in site development or which of your environments you're working in.</p><p>To extend the search configuration even further, it is also possible to have multiple search indexes. Imagine a future in which your recipe site is so popular that you start selling cookery books of your recipes on your site. You may want to have a separate search index that contains only details of the books, so that when users type <code class="literal">India</code> in a separate search box, they only see cookery books related to Indian cooking in the search result. Both your search indexes could still be based on the search server with the Apache Solr backend.</p></div><div class="section" title="Search server"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec91"/>Search server</h2></div></div></div><p>Having<a class="indexterm" id="id574"/> configured the Search API module in the previous steps, the first item you'll see listed on the Search API configuration table is a search server named Database Server. As the name suggests, this is a search server based on the Drupal database as the backend.</p><p>Click on <span class="strong"><strong>Edit</strong></span> in the operations column and you will be taken to the Database Server configuration:</p><div class="mediaobject"><img alt="Search server" src="graphics/4659_11_03.jpg"/></div><p>The <a class="indexterm" id="id575"/>server configuration is fairly self-explanatory. A server has a name and it should be enabled via the checkbox. It also has a backend, which in this case is Database and is provided by our <code class="literal">search_api_db</code> module. You can also set the minimum number of letters in words that will be used in a search.</p><p>Next up, we'll look at the configuration for default content index.</p></div><div class="section" title="Search index"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec92"/>Search index</h2></div></div></div><p>We now <a class="indexterm" id="id576"/>require our search index settings. Configuration for the search index is also on the Search API page at <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Search and metadata</strong></span> | <span class="strong"><strong>Search API</strong></span>. Click on <span class="strong"><strong>Edit</strong></span> next to the <span class="strong"><strong>Default content index</strong></span> to see the configuration page:</p><div class="mediaobject"><img alt="Search index" src="graphics/4659_11_04.jpg"/></div><p>You'll see that there are a number of data sources available for indexing. We're not just limited to users and node content as we were with the Drupal core search. For now we'll only index content, as it's already selected in the default configuration we installed.</p><p>You'll note <a class="indexterm" id="id577"/>also that the search index is linked to a search server by way of a radio button selection. The <span class="strong"><strong>Server</strong></span> field is set to <span class="strong"><strong>Database Server</strong></span> in this case, as that's the only one we have set up so far.</p></div><div class="section" title="Fields"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec93"/>Fields</h2></div></div></div><p>Next, move <a class="indexterm" id="id578"/>on to the <span class="strong"><strong>Fields</strong></span> tab at the top of the page. This is where we set which fields on each of the data sources actually get indexed:</p><div class="mediaobject"><img alt="Fields" src="graphics/4659_11_05.jpg"/></div><p>Inside the <span class="strong"><strong>general</strong></span> table, you'll see <span class="strong"><strong>Item language</strong></span> and <span class="strong"><strong>Rendered item</strong></span> listed. These are properties that are common to all types of searchable data sources. The <span class="strong"><strong>Rendered item</strong></span> field allows you to go to a full text search based on what an entity looks like when rendered in Drupal.</p><p>In the <span class="strong"><strong>CONTENT</strong></span> table<a class="indexterm" id="id579"/> further down the page, you'll see fields that are common to nodes. For each field on the field configuration page, you can set the boost value, which controls the relative significance that a search match in that field is given when it comes to ordering the search results.</p></div><div class="section" title="Processors"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec94"/>Processors</h2></div></div></div><p>Processors <a class="indexterm" id="id580"/>act on data or the query at different points during the search and indexing process, and make alterations. Processes have their own tab on the search index where they can be configured.</p><div class="mediaobject"><img alt="Processors" src="graphics/4659_11_06.jpg"/></div><p>Half way <a class="indexterm" id="id581"/>down this page, you see the processor order table which allows you to control the order in which the processors run:</p><div class="mediaobject"><img alt="Processors" src="graphics/4659_11_07.jpg"/></div><p>For example, the <span class="strong"><strong>Rendered item</strong></span> processor, that assembles the whole entity to be searched, has to be run before the data gets indexed. Processors such as the highlight that gets put on the results of the search to show the term you searched for happens after the query is executed, so you will note that this is in the <span class="strong"><strong>POSTPROCESS QUERY</strong></span> section.</p><p>If you're making changes to processors, pay special attention to the <span class="strong"><strong>Processor settings</strong></span> in the vertical tabs at the bottom of the page. This is where the exact behavior of each processor is <a class="indexterm" id="id582"/>configured. If enabled processors aren't behaving exactly as you expect them to, it's these settings which should be your first port of call.</p><div class="mediaobject"><img alt="Processors" src="graphics/4659_11_08.jpg"/></div></div><div class="section" title="Populating your search index"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec95"/>Populating your search index</h2></div></div></div><p>Now<a class="indexterm" id="id583"/> that we've set up our search backend and search index, we need to use them to index the content on our site.</p><p>Bulk indexing of your content can be performed by clicking on the <span class="strong"><strong>Index now</strong></span> button at the foot of the <span class="strong"><strong>Default content index view</strong></span> tab. You'll see a blue progress bar to show progress as your content is indexed and then you'll be returned to the content index view tab.</p><p>Content can also be indexed during a <code class="literal">cron</code> run. One way to trigger a <code class="literal">cron</code> run is with the <code class="literal">drush</code> command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ drush cron</strong></span>
</pre></div><p>The number of content nodes that are indexed each time <code class="literal">cron</code> runs is 50 by default. If you have 50 items of content or less, the blue progress bar should show 100 percent after one <code class="literal">cron</code> run. If you have more content, you might have to run <code class="literal">cron</code> a few times before it is all indexed. You can adjust the number of nodes that are indexed on each <code class="literal">cron</code> run (that is, the <code class="literal">cron</code> batch size) on the <span class="strong"><strong>Edit</strong></span> tab of your search settings. Scroll to the bottom of the page and expand the <span class="strong"><strong>Index Options</strong></span> where you'll be able to adjust this value:</p><div class="mediaobject"><img alt="Populating your search index" src="graphics/4659_11_09.jpg"/></div><p>Whether you ran <code class="literal">cron</code> or clicked on the <span class="strong"><strong>Index now</strong></span> button, your content should now be indexed.</p><p>You'll note <a class="indexterm" id="id584"/>that there are some links at the bottom of the content index view tab that provide some extra control over the indexation of your content:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Queue all items for reindexing</strong></span> marks all the currently indexed items of content as ready to be indexed again the next time <code class="literal">cron</code> runs or you click on <span class="strong"><strong>Index now</strong></span>. Until content re-indexing is triggered, the current search index will continue to be used. This helps deliver uninterrupted searching for your users, even when content must be re-indexed.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Clear all indexed data</strong></span> makes the current search index immediately unavailable and searches will stop yielding results until content is re-indexed.</li></ul></div></div></div>
<div class="section" title="Exposing the search to users"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec140"/>Exposing the search to users</h1></div></div></div><p>So <a class="indexterm" id="id585"/>now we have a search index with content in it, but how do we actually allow the end users to perform a search on our Drupal site?</p><p>One of the features of Search API is that it integrates well with the Views module. This means that you can search content using the search server you set up and display it in a view. The <code class="literal">search_api_db_defaults</code> module that you used earlier provides some views configuration which implements the search index and search server that was configured.</p><p>To see this View, go to <code class="literal">/search/content</code> on your site. Try searching the content for a certain word and check that you get sensible results. You should find that if you have two items of content, one of which has your search keyword in the title and one in the body text, that the search results are ordered according to the boost values that you set in the <span class="strong"><strong>Fields</strong></span> tab of your search index settings section earlier. By default, the title field has a boost value of eight while the rendered item has a boost value of one. Therefore, content that has your keyword in its title should appear before content that has your keyword in its body or elsewhere.</p><p>In order to better replicate the Drupal core search functionality that we disabled earlier in favor of the Search API, it would be nice to have a search field that we can display site-wide so that users don't need to navigate to <code class="literal">/search/content</code> to perform a search.</p><p>To achieve this, we'll expose the search form in a block. Navigate to <span class="strong"><strong>Structure</strong></span> | <span class="strong"><strong>Views</strong></span> and click on the <span class="strong"><strong>Edit</strong></span> button next to the <span class="strong"><strong>Search content</strong></span> view. Expand the <span class="strong"><strong>Advanced</strong></span> section and toggle <span class="strong"><strong>Exposed form in block</strong></span> from <span class="strong"><strong>No</strong></span> to <span class="strong"><strong>Yes</strong></span>. Click on the <span class="strong"><strong>Save</strong></span> button:</p><div class="mediaobject"><img alt="Exposing the search to users" src="graphics/4659_11_10.jpg"/></div><p>The exposed <a class="indexterm" id="id586"/>search field that appears at the top of our new search results page is now available in a block that we can configure to appear on pages on our site. Go to <span class="strong"><strong>Structure</strong></span> | <span class="strong"><strong>Block layout</strong></span> and click on <span class="strong"><strong>Place block</strong></span> next to the region you want to place it in. Somewhere in the list that appears, you will see the block <span class="strong"><strong>Exposed form: search_content-page_1</strong></span>. Configure the block settings in the usual way:</p><div class="mediaobject"><img alt="Exposing the search to users" src="graphics/4659_11_11.jpg"/></div><p>You should <a class="indexterm" id="id587"/>now have a sitewide search block that replaces the core search block that we removed.</p><div class="section" title="Altering the search display"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec96"/>Altering the search display</h2></div></div></div><p>One <a class="indexterm" id="id588"/>advantage of Search API is that the way each item in your search results is displayed can be controlled with your content type display settings. You will note that the search content view uses a node display mode of <span class="strong"><strong>Search result highlighting input</strong></span>.</p><div class="mediaobject"><img alt="Altering the search display" src="graphics/4659_11_12.jpg"/></div><p>This is a <a class="indexterm" id="id589"/>node display mode which is supplied by <span class="strong"><strong>search_api_db_defaults</strong></span>. You can change the settings of this display mode from the settings of each content type.</p><p>Go to <span class="strong"><strong>Structure</strong></span> | <span class="strong"><strong>Content types</strong></span>, choosing the content type whose display settings you'd like to change, and then go to tab <span class="strong"><strong>Manage display</strong></span> | <span class="strong"><strong>Search result highlighting input</strong></span>:</p><div class="mediaobject"><img alt="Altering the search display" src="graphics/4659_11_13.jpg"/></div><p>Try changing the fields from your content type that are displayed in the search results. For example, try hiding the image and setting the <span class="strong"><strong>Body format</strong></span> to <span class="strong"><strong>Trimmed</strong></span> with a trimmed limit of 400 characters.</p><p>You should now get search results as something similar to the following screenshot:</p><div class="mediaobject"><img alt="Altering the search display" src="graphics/4659_11_14.jpg"/></div></div><div class="section" title="Excluding entities from being indexed"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec97"/>Excluding entities from being indexed</h2></div></div></div><p>With the <a class="indexterm" id="id590"/>configuration we've set up so far, all the nodes on your site will be indexed and will be searchable. What if we'd like to choose whether individual recipes we create on our site should appear in the search results or not. Perhaps we'd like to create promotional links to special recipes that are not available through a site search, for example.</p><p>Well, there's a contributed module <a class="indexterm" id="id591"/>for that called Search API Exclude Entity (<a class="ulink" href="https://www.drupal.org/project/search_api_exclude_entity">https://www.drupal.org/project/search_api_exclude_entity</a>). When you download and install it, you'll find that there is an additional field type available that can be added to your nodes and other entities. If you add this field to your recipe content type, then when you next create or edit a recipe, you'll note that there are some extra metadata options that appear on the recipe edit screen:</p><div class="mediaobject"><img alt="Excluding entities from being indexed" src="graphics/4659_11_36.jpg"/></div><p>Next, go to<a class="indexterm" id="id592"/> the <span class="strong"><strong>Processors</strong></span> configuration on your search index: <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Search and metadata</strong></span> | <span class="strong"><strong>Search API</strong></span>. Click on <span class="strong"><strong>Edit</strong></span> next to the <span class="strong"><strong>Default content index</strong></span> to see the configuration page, then choose the <span class="strong"><strong>Processors</strong></span> tab. You'll see that you have a new Search API Exclude Entity that can be enabled. Once you've enabled this processor, scroll down to the <span class="strong"><strong>Processor settings</strong></span> section at the bottom of the screen and check the checkbox next to the field name that you just added to your content type.</p><p>Try creating a new recipe and excluding it from the search. Check that all your content has been indexed and then do a search for your new recipe. You should find that it doesn't appear in the search results.</p></div></div>
<div class="section" title="Installing Apache Solr as the search backend"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec141"/>Installing Apache Solr as the search backend</h1></div></div></div><p>The <a class="indexterm" id="id593"/>main reason for using Search API over the core search module is that we can plug in different search engines and use them to index your content. This really becomes an advantage when we start working with a large site that contains a lot of content.</p><p>Apache Solr<a class="indexterm" id="id594"/> is an open source search engine used by many high profile enterprise level sites. It is not part of Drupal or a Drupal module and is very often used independently of Drupal. However, it integrates well with the Drupal Search API module, as we'll see.</p><p>Solr has the following advantages<a class="indexterm" id="id595"/> over using the Search API with the database:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">It's faster</li><li class="listitem" style="list-style-type: disc">It does not rely on your Drupal database, freeing up database resources for Drupal to do the rest of its work with</li><li class="listitem" style="list-style-type: disc">It can be hosted on a server separate from your database and your code base which is useful when you need to scale your infrastructure</li><li class="listitem" style="list-style-type: disc">You can search for phrases and use wildcards</li></ul></div><p>We'll examine these same defaults later in this chapter. Meanwhile, if you'd like more information on the<a class="indexterm" id="id596"/> Apache Solr project, see its website at <a class="ulink" href="http://lucene.apache.org/solr/">http://lucene.apache.org/solr/</a>.</p><p>There are a few different ways to install Solr. Here, we'll explain two methods, one using a virtual <a class="indexterm" id="id597"/>machine and a puppet script, and one more manual method using an Ubuntu 14.04 server.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note20"/>Note</h3><p>If you follow either of these methods, Apache Solr does not block unauthorized users from accessing your Solr server by default. If you are setting up a Solr server outside your local machine, or that can be connected to over the Internet, it is extremely important that you employ some method of securing Apache Solr. Otherwise, unauthorized users will be able to make search queries and possibly even compromise your website in other ways. See the section <span class="emphasis"><em>Securing Apache Solr with Uncomplicated Firewall</em></span> in this chapter to learn how to secure Solr.</p></div></div><div class="section" title="Installing Solr 4.x on a virtual machine with Vagrant and Puppet"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec98"/>Installing Solr 4.x on a virtual machine with Vagrant and Puppet</h2></div></div></div><p>This<a class="indexterm" id="id598"/> is a quick and easy method of setting up a disposable virtual machine that you can use locally for development purposes. It will behave exactly the same as a Solr instance on a real server that you can go on to set up later if you want.</p><p>A useful online service for generating Puppet deployment configuration was introduced in <a class="link" href="ch01.html" title="Chapter 1. Setting Up a Drupal Development Environment">Chapter 1</a>, <span class="emphasis"><em>Setting Up a Drupal Development Environment</em></span>. This tool is called PuPHPet—Puppet with a capital PHP in the middle to denote that it is primarily intended for PHP web development. At the time of writing, the latest version of Apache Solr to be available on<a class="indexterm" id="id599"/> PuPHPet (<a class="ulink" href="https://puphpet.com/">https://puphpet.com/</a>) was 4.10.*. Therefore, these instructions will assume that you're using the 4.x version of Solr.</p><p>If you really need the latest and greatest version of Solr, you can skip to the next section where we'll explain how to install Solr manually on an Ubuntu 14.04 server.</p></div></div>
<div class="section" title="Time for action &#x2013; creating and configuring your virtual machine"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec142"/>Time for action – creating and configuring your virtual machine</h1></div></div></div><p>The following steps will use an online service to create a Puppet script that you can use with Vagrant to launch a virtual machine locally. Puppet, Vagrant, and the PuPHPet site were introduced in <a class="link" href="ch01.html" title="Chapter 1. Setting Up a Drupal Development Environment">Chapter 1</a>, <span class="emphasis"><em>Setting Up a Drupal Development Environment</em></span> of this book. If you haven't already got Puppet and Vagrant set up locally, follow the instructions there to get them working.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create <a class="indexterm" id="id600"/>your VM at PuPHPet. Point your browser at <a class="ulink" href="https://puphpet.com/">https://puphpet.com/</a> and click the big green <span class="strong"><strong>Get started right away</strong></span> button:<div class="mediaobject"><img alt="Time for action – creating and configuring your virtual machine" src="graphics/4659_11_15.jpg"/></div><p>During <a class="indexterm" id="id601"/>the wizard that you'll be guided through, you can generally accept the default options. Just make sure that when you get to the <span class="strong"><strong>Search Servers</strong></span> section you choose to install the latest 4.* version of Apache Solr. We'll also glance at a couple of other options here for creating a nice, clean virtual machine that you can use time and time again.</p><p>On the first <a class="indexterm" id="id602"/>page of the wizard after you've clicked on the <span class="strong"><strong>Get started</strong></span> button, make sure you have <span class="strong"><strong>Deploy to Local Host</strong></span> checked, along with VirtualBox as the provider. We'll also select Ubuntu Trusty 14.04 LTS x64 as the Distro:</p><div class="mediaobject"><img alt="Time for action – creating and configuring your virtual machine" src="graphics/4659_11_16.jpg"/></div><p>If you scroll <a class="indexterm" id="id603"/>further down this page, you'll<a class="indexterm" id="id604"/> find options for setting an <span class="strong"><strong>Internal Identifier</strong></span>, <span class="strong"><strong>Hostname</strong></span>, and <span class="strong"><strong>IP Address</strong></span>. You may want to change these if you have other virtual machines already running and need to distinguish this one from the others.</p><div class="mediaobject"><img alt="Time for action – creating and configuring your virtual machine" src="graphics/4659_11_17.jpg"/></div><p>It's also<a class="indexterm" id="id605"/> important that you have a <a class="indexterm" id="id606"/>folder that will be shared between your physical host machine and the virtual machine you are creating. By default, this is configured for you.</p><p>Follow the wizard using the big green buttons at the bottom of the screen and accept the defaults for the rest of the <span class="strong"><strong>System</strong></span> section.</p><p>When you get to the <span class="strong"><strong>Web Servers</strong></span> section, you can deselect both Apache and Nginx (Apache Solr doesn't require either of them). All the options can also be deselected in the <span class="strong"><strong>Languages and Databases</strong></span> sections—Solr does not require any of these.</p><p>Keep moving<a class="indexterm" id="id607"/> through the wizard, continuing to accept the further defaults until you get to <span class="strong"><strong>Search Servers</strong></span>. Choose <span class="strong"><strong>Apache Solr</strong></span> and select the latest version from the drop-down box:</p><div class="mediaobject"><img alt="Time for action – creating and configuring your virtual machine" src="graphics/4659_11_18.jpg"/></div></li><li class="listitem">Download and <a class="indexterm" id="id608"/>set up your virtual machine. Now you can hit the <span class="strong"><strong>Create Archive</strong></span> button to download a ZIP file containing the Puppet configuration you've just set up.<p>As previously explained in <a class="link" href="ch01.html" title="Chapter 1. Setting Up a Drupal Development Environment">Chapter 1</a>, <span class="emphasis"><em>Setting Up a Drupal Development Environment</em></span>, you can now run your virtual machine by extracting the ZIP archive, navigating to the extracted folder at your command line (which will contain a file called <code class="literal">Vagrantfile</code>), and typing:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant up</strong></span>
</pre></div><p>It will take a little while the first time you start the virtual machine because it has to download a large disk image containing the operating system. During this process you should get some verbose output at your command line, informing you of what is happening.</p><p>If everything<a class="indexterm" id="id609"/> ran correctly, you should now be able to open a browser and navigate to <code class="literal">http://localhost:8983/solr</code>. If this doesn't work, check that the port number is correct by scrolling back through the output at your command line and checking which<a class="indexterm" id="id610"/> local port has been forwarded to <code class="literal">8983</code>, the Apache Solr port.</p><p>Here's what you should now see in your browser:</p><div class="mediaobject"><img alt="Time for action – creating and configuring your virtual machine" src="graphics/4659_11_19.jpg"/></div></li><li class="listitem">Install the Drupal schema. Apache Solr is now installed on your virtual machine and <a class="indexterm" id="id611"/>you can connect to it through your browser. Congratulations!<p>It's not going<a class="indexterm" id="id612"/> to be of much use though unless we give it some content to index and search. We need to connect it to our Drupal site. The first step to doing this is to install the correct configuration files that tell Solr how to index Drupal content.</p><p>Download and extract the <code class="literal">search_api_solr</code> module for Drupal 8. Put it in the <code class="literal">/modules</code> folder of your site, but don't enable it just yet. The configuration files required for the Vagrant Solr instance can be found in the Drupal <code class="literal">search_api_solr</code> module at <code class="literal">search_api_solr/solr-conf/4.x</code>.</p><p>To copy these files to your virtual machine, copy the <code class="literal">4.x</code> folder into the <code class="literal">puphpet</code> folder, which sits in the same folder as the Vagrantfile that you extracted earlier.</p><p>Next, SSH into your virtual machine by navigating to the folder that contains Vagrantfile and typing:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant ssh</strong></span>
</pre></div><p>You will be logged in to your virtual machine over SSH, just as though it was a remote server.</p><p>The <code class="literal">puphpet</code> folder you copied the configuration into is shared between the physical host machine and the virtual machine. You can find the <code class="literal">4.x</code> folder at <code class="literal">/var/www/puphpet/4.x</code> on the virtual machine. First, back up the original Solr configuration and then move the new configuration into your Solr instance at <code class="literal">/opt/solr/solr-4.10.2/example/solr/collection1/conf</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo cp -r /opt/solr/solr-4.10.2/example/solr/collection1/conf /opt/solr/solr-4.10.2/example/solr/collection1/conf-orig</strong></span>
<span class="strong"><strong>$ mv /var/www/puphpet/4.x/* /opt/solr/solr-4.10.2/example/solr/collection1/conf/</strong></span>
</pre></div><p>Now we'll <a class="indexterm" id="id613"/>restart Solr. An easy way to do this<a class="indexterm" id="id614"/> is just to restart our entire virtual machine.</p><p>Next, exit the SSH terminal:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ exit</strong></span>
</pre></div><p>Then stop the virtual machine:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant halt</strong></span>
</pre></div><p>Then start it up again:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant up</strong></span>
</pre></div><p>Check that everything worked correctly by visiting the Solr admin page again in your browser.</p><div class="mediaobject"><img alt="Time for action – creating and configuring your virtual machine" src="graphics/4659_11_20.jpg"/></div><p>Select <span class="strong"><strong>collection1</strong></span> from the dropdown in the sidebar and then click on <span class="strong"><strong>Schema Browser</strong></span> at the bottom of the sidebar. In the dropdown that then appears in the main content area of the page, you should see a bunch of Drupal related <span class="strong"><strong>fields</strong></span>, <span class="strong"><strong>bundle_name</strong></span>, <span class="strong"><strong>entity_id</strong></span>, <span class="strong"><strong>entity_type</strong></span>, and so on.</p><p>Next, you'll <a class="indexterm" id="id615"/>need to enable and configure the <code class="literal">seach_api_solr</code> module in Drupal. To do this now, skip to the section. The Search API Solr module.</p></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec99"/><span class="emphasis"><em>What just happened?</em></span></h2></div></div></div><p>You used Vagrant and Puppet to set up a virtual machine running Apache Solr. You then configured your Solr server to work with Drupal by installing the configuration file that comes with the Drupal Search API Solr module. This virtual machine configuration can be reused again and again whilst you're experimenting and developing with Apache Solr.</p></div><div class="section" title="Installing Solr 5.x manually on Ubuntu 14.04"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec100"/>Installing Solr 5.x manually on Ubuntu 14.04</h2></div></div></div><p>This is the <a class="indexterm" id="id616"/>method to use if any of the following apply:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You want a later version of Apache Solr than is available on PuPHPet</li><li class="listitem" style="list-style-type: disc">You need Solr to run on a server outside your local machine</li><li class="listitem" style="list-style-type: disc">You want more control over the installation process</li></ul></div><p>These instructions will assume that you are installing Solr 5.x on an Ubuntu 4.x box. This could be the same server that your site is running on, or one dedicated to Solr.</p><p>The version of Solr that is available in the Ubuntu package repository is one major version before the current one. Rather than simply using Ubuntu's apt package manager tool to install the earlier version, we will follow a method that allows us to install the latest 5.x version of Solr.</p></div></div>
<div class="section" title="Time for action &#x2013; installing and configuring Solr on Ubuntu"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec143"/>Time for action – installing and configuring Solr on Ubuntu</h1></div></div></div><p>First, we'll install some required packages and then we'll manually install the latest version of Solr from the Apache Solr site:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install<a class="indexterm" id="id617"/> required packages. First, use <code class="literal">apt-get</code> to ensure you have the <code class="literal">python-software-properties</code> package available. This will allow you to add a new package repository:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install python-software-properties</strong></span>
</pre></div><p>Now, add<a class="indexterm" id="id618"/> the unofficial Java installer repository:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo add-apt-repository ppa:webupd8team/java</strong></span>
</pre></div><p>Confirm that you want to add this repository when prompted and then update the list of source packages:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get update</strong></span>
</pre></div><p>We can now install the Oracle Java JDK Version 8:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install oracle-java8-installer</strong></span>
</pre></div><p>This is an Oracle package and you will have to agree to the license terms in order to proceed. Just press <span class="emphasis"><em>Enter</em></span> when prompted.</p></li><li class="listitem">Run the Apache Solr installer. Now that we have the Java JDK installed, we can install the latest version of Apache Solr. Go to the list of mirrors available to download <a class="indexterm" id="id619"/>Solr from <a class="ulink" href="http://www.apache.org/dyn/closer.lua/lucene/solr/">http://www.apache.org/dyn/closer.lua/lucene/solr/</a>.<p>Choose a mirror and then choose the latest directory with a version number that starts with <code class="literal">5.*</code>.</p><p>Next, right-click the latest <code class="literal">.tgz </code>file whose name does not contain <code class="literal">src</code> and copy the link to it. At the time of writing, this was <code class="literal">solr-5.5.0.tgz</code>, where the version number appears in the commands below, replace with the version you have downloaded.</p><p>Back at the command line of the server you are installing Solr on, download the file to your home folder and untar it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd ~</strong></span>
<span class="strong"><strong>$ wget http://&lt;download_path&gt;/solr-5.5.0.tgz</strong></span>
<span class="strong"><strong>$ tar -xvzf solr-5.5.0.tgz</strong></span>
</pre></div><p>Solr 5.x comes with its own installer script which makes it easier to set up than the previous versions. We'll run the script as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo bash solr-5.5.0/bin/install_solr_service.sh solr-5.5.0.tgz</strong></span>
</pre></div><p>When it starts up, Solr will output the port number that it is running on, usually <code class="literal">8983</code>. Open a browser window and navigate to the IP address of your server followed by the port number. For example: <code class="literal">http://&lt;Server IP address&gt;:8983</code>.</p><p>You <a class="indexterm" id="id620"/>should see <a class="indexterm" id="id621"/>the Solr admin screen as follows:</p><div class="mediaobject"><img alt="Time for action – installing and configuring Solr on Ubuntu" src="graphics/4659_11_21.jpg"/></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note21"/>Note</h3><p>Ensure you pay special attention to the following section in this chapter <span class="emphasis"><em>Securing Apache Solr with Uncomplicated Firewall</em></span> to ensure there is no unauthorized access to your Solr interface.</p></div></div></li><li class="listitem">Install the <a class="indexterm" id="id622"/>Drupal schema. Apache Solr is now installed on your virtual machine and you can connect to it through your browser. Congratulations!<p>It's not going<a class="indexterm" id="id623"/> to be of much use though unless we give it some content to index and search. We need to connect it to our Drupal site. The first step to doing this is to install the correct configuration files that tell Solr how to index Drupal content.</p><p>The configuration files required to make Solr work with Drupal can be found in the <code class="literal">search_api_solr</code> module. Navigate to the module page on Drupal to get the link to the latest packaged <code class="literal">tar.gz</code> file. Download it to your Apache Solr server and extract the files:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd ~</strong></span>
<span class="strong"><strong>$ wget https://ftp.drupal.org/files/projects/search_api_solr-8.x-1.0-alpha2.tar.gz</strong></span>
<span class="strong"><strong>$ tar -xvf search_api_solr-8.x-1.0-alpha2.tar.gz</strong></span>
</pre></div><p>You will have to replace the filenames in the preceding commands with the filename of the latest version of the module.</p><p>Next, create the directory that you will copy the Solr configuration files into:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo mkdir -p /var/solr/data/drupal/conf</strong></span>
</pre></div><p>Copy the files from the Drupal module into the Solr configuration directory:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo cp search_api_solr/solr-conf/5.x/* /var/solr/data/drupal/conf/</strong></span>
</pre></div><p>Set the correct ownership on the files:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo chown -R solr:solr /var/solr /opt/solr</strong></span>
</pre></div><p>Create a new Solr core:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo /opt/solr/bin/solr create -c drupal</strong></span>
</pre></div><p>Restart the Solr service:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo service solr restart</strong></span>
</pre></div><p>Navigate again to the Solr admin screen in your browser. In the <span class="strong"><strong>Core Selector</strong></span> drop down in the sidebar, you should now have a core called <span class="strong"><strong>drupal</strong></span>:</p><div class="mediaobject"><img alt="Time for action – installing and configuring Solr on Ubuntu" src="graphics/4659_11_22.jpg"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec101"/><span class="emphasis"><em>What just happened?</em></span></h2></div></div></div><p>You installed the latest version of Apache Solr on Ubuntu using the package manager. This is the process you'll use when setting Solr up from scratch on a production server. Just make sure you secure it too!</p></div></div>
<div class="section" title="Securing Apache Solr with Uncomplicated Firewall"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec144"/>Securing Apache Solr with Uncomplicated Firewall</h1></div></div></div><p>It's very<a class="indexterm" id="id624"/> important that you secure <a class="indexterm" id="id625"/>Apache Solr to prevent outside access to it. If your Solr server is accessible over the Internet or even over your local network, you should employ a method of controlling unauthorized access to it. </p></div>
<div class="section" title="Time for action &#x2013; configuring Uncomplicated Firewall"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec145"/>Time for action – configuring Uncomplicated Firewall</h1></div></div></div><p>On Ubuntu, you can<a class="indexterm" id="id626"/> use the built in Uncomplicated Firewall tool to set access to the server at a firewall level:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Start by denying all access:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo ufw default deny</strong></span>
</pre></div><p>However, we don't want to break the SSH connection that we're currently using, so make sure that we allow access for SSH connections:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo ufw allow ssh</strong></span>
</pre></div><p>Also, we want to allow all connections from our local IP address:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo ufw allow from &lt;ip address&gt;</strong></span>
</pre></div><p>Here, <code class="literal">&lt;ip address&gt;</code> is the IP address of the machine you are connecting from. You will also want to add the IP address of your Drupal server here if it's different from your Solr server. Just run the preceding command again, changing the IP address to that of your Drupal server. For further details, see the Ubuntu UFW documentation at <a class="ulink" href="https://help.ubuntu.com/community/UFW">https://help.ubuntu.com/community/UFW</a>.</p></li><li class="listitem">Now <a class="indexterm" id="id627"/>enable the firewall with the following settings:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo ufw enable</strong></span>
</pre></div><p>You may receive a warning to say that the existing SSH commands may be disrupted. As long as you've allowed access for SSH connections with the command we ran earlier, you can proceed.</p></li><li class="listitem">Now check the status of your firewall:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo ufw status</strong></span>
</pre></div></li><li class="listitem">You should receive an output that looks as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Status: active</strong></span>

<span class="strong"><strong>To               Action      From</strong></span>
<span class="strong"><strong>--               ------      ----</strong></span>
<span class="strong"><strong>22               ALLOW       Anywhere</strong></span>
<span class="strong"><strong>Anywhere         ALLOW       &lt;ip address&gt;</strong></span>
<span class="strong"><strong>22 (v6)          ALLOW       Anywhere (v6)</strong></span>
</pre></div></li></ol></div><p>You should now be able to access the Solr admin interface from your local machine or network but not from anywhere else. Try navigating to the following URL: <code class="literal">http://&lt;Server IP address&gt;:8983</code>.</p><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec102"/><span class="emphasis"><em>What just happened?</em></span></h2></div></div></div><p>You configured Ubuntu's Uncomplicated Firewall to allow access to your Solr installation only from a specific IP address.</p></div></div>
<div class="section" title="The Search API Solr module"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec146"/>The Search API Solr module</h1></div></div></div><p>Prior to<a class="indexterm" id="id628"/> Drupal 8, Drupal used a module that was independent of Search API to integrate with Apache Solr. This module was called Apache Solr Search. However, it was decided that the Search API would become the module on which to base all search integrations for Drupal 8. A main contributor to both the Search API project and the earlier Apache Solr Search module for Drupal 7 is Nick Veenhof (also known as "Nick_vh" on Drupal.org). He explained the rationale behind making the Search API module a requirement of the new Search API Solr module:</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"Drupal 8 has also helped in forcing us to rethink certain concepts and also live up to our promise to avoid the divide we had in Drupal 7 between the Apache Solr Module and Search API. Search API will be the sole provider of Apache Solr integration in Drupal 8. Search API in Drupal 8 ships with sane defaults (which you can enable or disable) that pre-configures the module so it can be used instantly."</em></span></p></blockquote></div></div>
<div class="section" title="Time for action &#x2013; configuring Drupal to use Apache Solr"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec147"/>Time for action – configuring Drupal to use Apache Solr</h1></div></div></div><p>However <a class="indexterm" id="id629"/>you set up Apache Solr, you'll now want to configure Drupal to use your new Solr server as your search server in Drupal:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Installing the Search API Solr module. First we need to install the <code class="literal">search_api_solr</code> module on our Drupal site. Download the module and extract it into the <code class="literal">/modules</code> folder of your Drupal site as usual. The module has some dependencies that are managed by composer, so navigate into the directory of your module and run:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ composer install</strong></span>
</pre></div><p>At the<a class="indexterm" id="id630"/> time of writing, the development version of <code class="literal">search_api_solr</code> was required in order to fix some errors on the official alpha release displayed for download on the module page. To fetch this, it is best to use Git:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ git clone --branch 8.x-1.x https://git.drupal.org/project/search_api_solr.git</strong></span>
</pre></div></li><li class="listitem">Configuring the Search API Solr module. When we installed the <code class="literal">search_api_db_defaults</code> module earlier on in this chapter, it created a search server based on the database for us.<p>Now that we have the Search API Solr module installed, we can set up a second search server based on the Solr server.</p><p>Navigate to <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Search and metadata</strong></span> | <span class="strong"><strong>Search API</strong></span> and click on the <span class="strong"><strong>Add Server</strong></span> button.</p><p>Fill in the form as shown next. The Solr path should be <code class="literal">/solr/</code> followed by the name of your core. This will be <code class="literal">drupal</code> if you followed the previous instructions to install Solr 5.x or <code class="literal">collection1</code> if you followed the instructions for installing Solr 4.x:</p><div class="mediaobject"><img alt="Time for action – configuring Drupal to use Apache Solr" src="graphics/4659_11_23.jpg"/></div><p>If you've secured the Solr admin interface using the firewall rules as explained <a class="indexterm" id="id631"/>in the previous section, you will not need to add login details for HTTP authentication. Leave this blank and click on <span class="strong"><strong>Save</strong></span>:</p><div class="mediaobject"><img alt="Time for action – configuring Drupal to use Apache Solr" src="graphics/4659_11_24.jpg"/></div><p>Now that you've created a second search server in the Drupal configuration, one of the advantages of the Search API module is that you can swap between them easily. You may want to dedicate your Solr server to the production site for example, but you still want to be able to perform searches for development purposes on your staging and development sites.</p><p>In development and staging environments, you can set your search index to use the <a class="indexterm" id="id632"/>database, and on the production environment, you can swap it to use Solr.</p><p>Edit the default content index that you set up earlier in this chapter and change the <span class="strong"><strong>Server</strong></span> radio button to <span class="strong"><strong>Solr</strong></span>:</p><div class="mediaobject"><img alt="Time for action – configuring Drupal to use Apache Solr" src="graphics/4659_11_25.jpg"/></div><p>Click on <span class="strong"><strong>Save</strong></span> and<a class="indexterm" id="id633"/> then re-index your content. That's it! Go back to your search page and test out the new search, this time powered by Solr.</p></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec103"/><span class="emphasis"><em>What just happened?</em></span></h2></div></div></div><p>You installed Drupal's Search API Solr module and configured it to connect to your Apache Solr installation via a new search server. You then connected your search index to the new search server and indexed your content using Solr.</p></div><div class="section" title="Using the read-only mode"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec104"/>Using the read-only mode</h2></div></div></div><p>In some <a class="indexterm" id="id634"/>situations, you may want to make your search index read-only. This can help if you implement a Drupal development workflow across several servers. For example, when you copy the Drupal database down from production to your staging and development environments in order to keep them updated with the latest content from your production site. Rather than create a new Apache Solr server for each of your environments, you'll want to use the same Apache Solr server but ensure that only content added to your production server gets indexed.</p><p>On your staging and production environments, you can check the <span class="strong"><strong>Read only</strong></span> checkbox in the <span class="strong"><strong>Index Options</strong></span>. This will prevent any test content you create here making it into the Apache Solr index:</p><div class="mediaobject"><img alt="Using the read-only mode" src="graphics/4659_11_35.jpg"/></div><p>You should note that if you add a new content type to the system, you will need to ensure that the search index is not set to read only in order for the content type to be indexed. When the index is set to read-write (that is, the read only checkbox is unchecked), any new content <a class="indexterm" id="id635"/>created using your new content type will be automatically indexed as usual.</p></div></div>
<div class="section" title="Search facets"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec148"/>Search facets</h1></div></div></div><p>To<a class="indexterm" id="id636"/> further showcase the power of the Search API, we're going to create a facet block to accompany the search listing. You may be familiar with facet blocks from other websites that have a lot of categorized content to search and sort.</p><p>For example, here are some faceted search blocks from a popular recipe website:</p><p> </p><div class="mediaobject"><img alt="Search facets" src="graphics/4659_11_26.jpg"/><div class="caption"><p><a class="ulink" href="http://www.bbcgoodfood.com/search/recipes?query=family">http://www.bbcgoodfood.com/search/recipes?query=family</a></p></div></div></div>
<div class="section" title="Time for action &#x2013; building faceted search blocks"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec149"/>Time for action – building faceted search blocks</h1></div></div></div><p>Let's look <a class="indexterm" id="id637"/>at how you can build one of these faceted search blocks using the Search API and the Drupal 8 facets module:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download <a class="indexterm" id="id638"/>and enable the facets module from (<a class="ulink" href="https://www.drupal.org/project/facets">https://www.drupal.org/project/facets</a>) in the way you're used to.</li><li class="listitem">Navigate to <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Search API</strong></span> | <span class="strong"><strong>Facets</strong></span> and click on the blue Add Facet button. As an example, we'll create a facet block that uses words from the titles of our recipes. However, if you have categorized your recipes using taxonomy terms, you could also base your facet block on that field.<p>Give the facet a human readable name and a machine name:</p><div class="mediaobject"><img alt="Time for action – building faceted search blocks" src="graphics/4659_11_27.jpg"/></div></li><li class="listitem">The facet block needs a source to get its data from. In the <span class="strong"><strong>Facet field</strong></span> dropdown, you'll have one option which will be the search view that we created earlier. Set the <span class="strong"><strong>Facet field</strong></span> to <span class="strong"><strong>Title</strong></span> and the weight of the facet to <code class="literal">0</code>, then save the settings.</li><li class="listitem">You can also configure the display settings of your facet by clicking the <span class="strong"><strong>Display</strong></span> tab at the top of the page. Here, you can choose options such as whether to display your facet list as a dropdown, checkboxes, or list of links. You can <a class="indexterm" id="id639"/>also choose the way the facet list behaves, such as hiding items that will not narrow the currently displayed search results down any further. We're going to aim to make our facet list similar to the example at the start of this section. Therefore, we'll choose <span class="strong"><strong>List of links</strong></span> as the <span class="strong"><strong>Widget</strong></span> and we'll check <span class="strong"><strong>Hide non narrowing results</strong></span>:<div class="mediaobject"><img alt="Time for action – building faceted search blocks" src="graphics/4659_11_28.jpg"/></div></li><li class="listitem">You have <a class="indexterm" id="id640"/>now created a facet which is related to a facet source. The facets table you now see at <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Search API</strong></span> | <span class="strong"><strong>Facets</strong></span> should look as follows:<div class="mediaobject"><img alt="Time for action – building faceted search blocks" src="graphics/4659_11_29.jpg"/></div></li><li class="listitem">The facet <a class="indexterm" id="id641"/>you have created will manifest itself as a block. We'll make this block visible by placing it in a region in the usual way using the Block layout configuration at <span class="strong"><strong>Structure</strong></span> | <span class="strong"><strong>Block layout</strong></span>. Next to Sidebar first, click on the <span class="strong"><strong>Place block</strong></span> button and search for your block in the list that pops up:<div class="mediaobject"><img alt="Time for action – building faceted search blocks" src="graphics/4659_11_30.jpg"/></div><p>The block will have the name that you gave the facet earlier in the configuration.</p></li><li class="listitem">Click <a class="indexterm" id="id642"/>on <span class="strong"><strong>Place block</strong></span>.</li><li class="listitem">In the block configuration screen, in the <span class="strong"><strong>Other facet</strong></span> blocks field, select the radio button of the Facet you created:<div class="mediaobject"><img alt="Time for action – building faceted search blocks" src="graphics/4659_11_31.jpg"/></div></li><li class="listitem">Click <a class="indexterm" id="id643"/>on <span class="strong"><strong>Save block</strong></span> and navigate to your search page at <code class="literal">/search/content</code>.</li><li class="listitem">You will have to ensure you have a few pieces of content on your site that have the same word in their title to show the power of facets. For example, I have three recipes with the word <code class="literal">awesome</code> in the title. To start with, the facet block lists all <a class="indexterm" id="id644"/>the discrete words in the titles of my recipes:<div class="mediaobject"><img alt="Time for action – building faceted search blocks" src="graphics/4659_11_32.jpg"/></div></li><li class="listitem">When I search for <code class="literal">awesome</code>, the search results and facet list are narrowed down:<div class="mediaobject"><img alt="Time for action – building faceted search blocks" src="graphics/4659_11_33.jpg"/></div></li><li class="listitem">I can now click in the facet block on any of the other words that occur in titles that <a class="indexterm" id="id645"/>also have the word awesome in them. This makes it very easy to filter down to the search result that you are looking for:<div class="mediaobject"><img alt="Time for action – building faceted search blocks" src="graphics/4659_11_34.jpg"/></div></li></ol></div><p>When you've built up a large amount of content on your site, your users will be able to search, filter, and explore using a powerful mix of keyword searches and filtering with facets.</p><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec105"/><span class="emphasis"><em>What just happened?</em></span></h2></div></div></div><p>You configured Drupal's Facet module to show a block containing search terms to filter by next to your search results. This allows your users to further refine their search by choosing from the list of search keywords in your content titles.</p></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec106"/>Have a go hero</h2></div></div></div><p>Try creating a taxonomy vocabulary for tagging your recipes with different categorizations. For example, cuisine, origin country, different dietary requirements, ease to make, or level of spice. Then create new facet blocks that allow your users to filter their search by each of these categories. For example, they may wish to start by searching for <code class="literal">rice</code>, then use facets to filter further by <code class="literal">Italian</code>, and finally <code class="literal">Vegetarian</code> to end up with a recipe for a tasty Asparagas risotto!</p></div><div class="section" title="Pop quiz"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec107"/>Pop quiz</h2></div></div></div><p>Q1. Choose for which of the following you can use Uncomplicated Firewall for:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To prevent remote access to a server from a certain IP address.</li><li class="listitem">To stop users logging into your server with root access.</li><li class="listitem">To prevent a certain port being accessed on your server.</li><li class="listitem">To display a welcome message to your users when they log into your server.</li></ol></div><p>Q2. Choose which of the following are valid reasons to use Apache Solr instead of a database-based search:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">You want to be able to search the titles of the nodes on your site as well as the body content.</li><li class="listitem">Your site has a lot of visitors and the load on your Drupal database is often high.</li><li class="listitem">You want anonymous users and logged in users to be able to search on your site.</li><li class="listitem">You want to automatically suggest search terms to your users as they type in the search box.</li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec150"/>Summary</h1></div></div></div><p>In this chapter, we learned about Drupal search concepts and how to configure a powerful and flexible search solution for visitors to find what they're looking for on your site. We introduced the Search API module and understood how it can be configured to work with the Drupal database. We then introduced the Apache Solr search engine and looked at the advantages of using this as a search engine instead of relying on the Drupal database. Finally, we learnt how to create a faceted search interface like that used by online shops or other sites with a large amount of content to search through.</p><p>In the next chapter, we will explore one of the major new developer features in Drupal 8: built-in support for REST. We'll develop an Angular JS app that will consume a REST API on our website.</p></div></body></html>