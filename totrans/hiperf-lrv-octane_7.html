<html><head></head><body>
<div id="_idContainer065">
<h1 class="chapter-number" id="_idParaDest-114"><a id="_idTextAnchor121"/><span class="koboSpan" id="kobo.1.1">7</span></h1>
<h1 id="_idParaDest-115"><a id="_idTextAnchor122"/><span class="koboSpan" id="kobo.2.1">Configuring the Laravel Octane Application for the Production Environment</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In previous chapters and this book in general, we have seen how to use Laravel Octane and implement several optimizations to improve the performance and responsiveness of our application. </span><span class="koboSpan" id="kobo.3.2">We operated mainly in the local development environment. </span><span class="koboSpan" id="kobo.3.3">In addition, we have worked at the </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">application level.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">This chapter will address system configurations, setup, and fine-tuning in a production environment. </span><span class="koboSpan" id="kobo.5.2">Understanding the specific configurations for the production environment is very useful, especially because the configuration of a local environment is typically different from the configuration of the production environment due to the different settings and </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">services available.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">In practice, we will cover </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.9.1">A typical </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">production architecture</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">How the reference architecture can </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">be optimized</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Which specific Laravel operations can bring benefits from a </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">performance perspective</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">The deployment strategy </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">via </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.17.1">Makefile</span></strong></span></li>
</ul>
<h1 id="_idParaDest-116"><a id="_idTextAnchor123"/><span class="koboSpan" id="kobo.18.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.19.1">We start with the assumption that the reader has a production environment available. </span><span class="koboSpan" id="kobo.19.2">Typically, this kind of environment can be on a virtual machine, such as one (or more) Amazon EC2 instances, or an environment provided by cloud PaaS solutions, such as </span><em class="italic"><span class="koboSpan" id="kobo.20.1">Platfrom.sh</span></em><span class="koboSpan" id="kobo.21.1">, or by cloud servers/service providers, such as </span><em class="italic"><span class="koboSpan" id="kobo.22.1">Digital Ocean</span></em> <span class="No-Break"><span class="koboSpan" id="kobo.23.1">or </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.24.1">Vultr</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.26.1">We will not address the specific installation of these environments; however, we will give indications of a typical architecture that combines the use of a web server such as nginx on one (or more) GNU/Linux-type </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">virtual machines.</span></span></p>
<p><span class="koboSpan" id="kobo.28.1">The source code and the configuration files of the examples described in the current chapter are available </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">here: </span></span><a href="https://github.com/PacktPublishing/High-Performance-with-Laravel-Octane/tree/main/octane-ch07"><span class="No-Break"><span class="koboSpan" id="kobo.30.1">https://github.com/PacktPublishing/High-Performance-with-Laravel-Octane/tree/main/octane-ch07</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.31.1">.</span></span></p>
<h1 id="_idParaDest-117"><a id="_idTextAnchor124"/><span class="koboSpan" id="kobo.32.1">Introducing the production architecture</span></h1>
<p><span class="koboSpan" id="kobo.33.1">In the local environment</span><a id="_idIndexMarker368"/><span class="koboSpan" id="kobo.34.1"> development scenario (as in the previous chapters), it is fine to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.35.1">php artisan octane:start</span></strong><span class="koboSpan" id="kobo.36.1"> command to start Laravel Octane. </span><span class="koboSpan" id="kobo.36.2">However, it may be helpful to configure a different architecture in a production environment where the requirements are different from a </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">local environment.</span></span></p>
<p><span class="koboSpan" id="kobo.38.1">Typically, in a local development environment, you need automation and configurations that are useful for developing new features, such as automatic service reload. </span><span class="koboSpan" id="kobo.38.2">In contrast, in a production environment, the configuration must allow for optimum levels of performance and reliability. </span><span class="koboSpan" id="kobo.38.3">Therefore, choosing a different, production-specific architecture in this production scenario </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">is common.</span></span></p>
<p><span class="koboSpan" id="kobo.40.1">The design of the production environment architecture we are going to address involves the use of a web server to initially sort HTTP requests. </span><span class="koboSpan" id="kobo.40.2">The web server’s task will be to differentiate requests for static assets (where no PHP engine involvement is required) from requests that require server-side processing. </span><span class="koboSpan" id="kobo.40.3">Usually, a request for a page, which requires server-side processing, might be followed by other requests for static assets such as CSS files, JavaScript files, and image files. </span><span class="koboSpan" id="kobo.40.4">PHP involvement is not needed for these types of files, so the web server’s task will be to serve these types of assets immediately, in the fastest way possible. </span><span class="koboSpan" id="kobo.40.5">On the other hand, for requests requiring PHP execution, the web server will forward the request to the service provided by </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">Laravel Octane.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer060">
<span class="koboSpan" id="kobo.42.1"><img alt="Figure 7.1: A typical production architecture" src="image/Figure_7.01_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.43.1">Figure 7.1: A typical production architecture</span></p>
<p><span class="koboSpan" id="kobo.44.1">To configure the production</span><a id="_idIndexMarker369"/><span class="koboSpan" id="kobo.45.1"> environment, several steps must </span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">be performed:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.47.1">Place the static assets in a specific directory (we can organize the asset types into </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">multiple subfolders).</span></span></li>
<li><span class="koboSpan" id="kobo.49.1">Configure the nginx (</span><strong class="source-inline"><span class="koboSpan" id="kobo.50.1">nginx.conf</span></strong><span class="koboSpan" id="kobo.51.1"> file) for acting as </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">a proxy.</span></span></li>
<li><span class="koboSpan" id="kobo.53.1">Configure nginx to forward the page requests to </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">Laravel Octane.</span></span></li>
<li><span class="koboSpan" id="kobo.55.1">Set nginx to listen to the </span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">HTTPS protocol.</span></span></li>
<li><span class="koboSpan" id="kobo.57.1">Set the communication between nginx and Laravel Octane as </span><span class="No-Break"><span class="koboSpan" id="kobo.58.1">standard HTTP.</span></span></li>
<li><span class="koboSpan" id="kobo.59.1">All the URL generated by Laravel has to be set up as served as HTTPS (for absolute </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">URL generation).</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.61.1">Let’s start with managing </span><span class="No-Break"><span class="koboSpan" id="kobo.62.1">public assets.</span></span></p>
<h2 id="_idParaDest-118"><a id="_idTextAnchor125"/><span class="koboSpan" id="kobo.63.1">Managing public static assets</span></h2>
<p><span class="koboSpan" id="kobo.64.1">If you look at the directory</span><a id="_idIndexMarker370"/><span class="koboSpan" id="kobo.65.1"> structure of a Laravel application, you will notice that there is a public directory, the purpose of which is to contain </span><span class="No-Break"><span class="koboSpan" id="kobo.66.1">static files.</span></span></p>
<p><span class="koboSpan" id="kobo.67.1">The public directory also contains the built CSS and JS files (by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.68.1">npm run build</span></strong><span class="koboSpan" id="kobo.69.1"> command). </span><span class="koboSpan" id="kobo.69.2">If your application needs a CSS style, you will probably set it in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.70.1">resources/css/app.css</span></strong><span class="koboSpan" id="kobo.71.1"> file (or in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.72.1">resources/js</span></strong><span class="koboSpan" id="kobo.73.1"> directory for the JavaScript files). </span><span class="koboSpan" id="kobo.73.2">Once you run </span><strong class="source-inline"><span class="koboSpan" id="kobo.74.1">npm run build</span></strong><span class="koboSpan" id="kobo.75.1">, the CSS and JS files are built, and the output files are stored in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.76.1">public/build</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.77.1"> directory.</span></span></p>
<p><span class="koboSpan" id="kobo.78.1">To provide static files in HTTP responses, it is not necessary to involve the PHP engine. </span><span class="koboSpan" id="kobo.78.2">Avoiding involving the PHP engine to provide static files minimizes the use of resources such as CPU and memory and, consequently, also reduces </span><span class="No-Break"><span class="koboSpan" id="kobo.79.1">response times.</span></span></p>
<p><span class="koboSpan" id="kobo.80.1">Static files typically are files with a specific extension such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.81.1">jpg</span></strong><span class="koboSpan" id="kobo.82.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.83.1">jpeg</span></strong><span class="koboSpan" id="kobo.84.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.85.1">gif</span></strong><span class="koboSpan" id="kobo.86.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.87.1">css</span></strong><span class="koboSpan" id="kobo.88.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.89.1">png</span></strong><span class="koboSpan" id="kobo.90.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.91.1">js</span></strong><span class="koboSpan" id="kobo.92.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.93.1">ico</span></strong><span class="koboSpan" id="kobo.94.1">, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.95.1">html</span></strong><span class="koboSpan" id="kobo.96.1">. </span><span class="koboSpan" id="kobo.96.2">For static files, we could need a particular configuration – for example, for turning off the log, defining an expiration date, or adding a header. </span><span class="koboSpan" id="kobo.96.3">If you need to set a specific setting for the assets, the suggestion is to set a particular configuration for nginx in the server section in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.97.1">nginx.conf</span></strong><span class="koboSpan" id="kobo.98.1"> file (or the file for </span><span class="No-Break"><span class="koboSpan" id="kobo.99.1">your domain):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.100.1">
location ~* \.(jpg|jpeg|gif|css|png|js|ico|html)$ {
  access_log off;
  expires max;
  log_not_found off;
  add_header X-Debug-Config STATICASSET;
}</span></pre>
<p><span class="koboSpan" id="kobo.101.1">For files with assets extensions, I added a header (header in the HTTP response) named </span><strong class="source-inline"><span class="koboSpan" id="kobo.102.1">X-Debug-Config</span></strong><span class="koboSpan" id="kobo.103.1">, for debugging purposes. </span><span class="koboSpan" id="kobo.103.2">The configuration was set to check whether </span><strong class="source-inline"><span class="koboSpan" id="kobo.104.1">STATICASSET</span></strong><span class="koboSpan" id="kobo.105.1"> value was present in the HTTP </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">response headers.</span></span></p>
<h2 id="_idParaDest-119"><a id="_idTextAnchor126"/><span class="koboSpan" id="kobo.107.1">Setting nginx as a proxy</span></h2>
<p><span class="koboSpan" id="kobo.108.1">In the production environment, we are going</span><a id="_idIndexMarker371"/><span class="koboSpan" id="kobo.109.1"> to use nginx to reply to HTTP</span><a id="_idIndexMarker372"/><span class="koboSpan" id="kobo.110.1"> requests. </span><span class="koboSpan" id="kobo.110.2">We are going to configure nginx as a proxy because, for the PHP files, nginx will forward the requests to the Laravel </span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">Octane service.</span></span></p>
<p><span class="koboSpan" id="kobo.112.1">The nginx configuration for PHP files looks </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.114.1">
location ~ \.php$ {
  include snippets/fastcgi-php.conf;
  add_header X-Debug-Config2 FASTCGI;
  fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}</span></pre>
<p><span class="koboSpan" id="kobo.115.1">This typical configuration with nginx for using the PHP uses the FPM module via FastCGI. </span><span class="koboSpan" id="kobo.115.2">As mentioned in </span><a href="B17728_01.xhtml#_idTextAnchor015"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.116.1">Chapter 1</span></em></span></a><em class="italic"><span class="koboSpan" id="kobo.117.1">, Understanding the Laravel Web Application Architecture</span></em><span class="koboSpan" id="kobo.118.1">, nginx is not able to run PHP scripts. </span><span class="koboSpan" id="kobo.118.2">To do that, nginx can be configured to forward the requests to the FPM module. </span><span class="koboSpan" id="kobo.118.3">The FPM module will run the PHP scripts and will send back the response to nginx. </span><span class="koboSpan" id="kobo.118.4">All the requests to PHP files are forwarded to the FPM socket communication </span><span class="No-Break"><span class="koboSpan" id="kobo.119.1">channel (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.120.1">fastcgi_pass</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.121.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.122.1">In case you use Laravel Octane, you don’t need to use the FastCGI option to execute PHP scripts because the PHP scripts will be executed by the Laravel Octane service via the application servers (Swoole </span><span class="No-Break"><span class="koboSpan" id="kobo.123.1">or RoadRunner).</span></span></p>
<p><span class="koboSpan" id="kobo.124.1">If you have Laravel Octane, you can start the Octane service via the </span><strong class="source-inline"><span class="koboSpan" id="kobo.125.1">php artisan octane:start</span></strong><span class="koboSpan" id="kobo.126.1"> command and then instruct nginx to act as a proxy, forwarding all the PHP requests to the Laravel </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">Octane service.</span></span></p>
<p><span class="koboSpan" id="kobo.128.1">To set nginx as a proxy, you can set this configuration in your nginx </span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">configuration file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.130.1">
location /index.php {
    try_files /not_exists @octane;
}
location / {
    try_files $uri $uri/ @octane;
}
location @octane {
        add_header X-Debug-Config2 POWEREDBYOCTANE;
        set $suffix "";
        if ($uri = /index.php) {
            set $suffix ?$query_string;
        }
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header Scheme $scheme;
        proxy_set_header SERVER_PORT $server_port;
        proxy_set_header REMOTE_ADDR $remote_addr;
        proxy_set_header X-Forwarded-For
                         $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade $http_upgrade;
        proxy_pass http://127.0.0.1:8000$suffix;
}</span></pre>
<p><span class="koboSpan" id="kobo.131.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.132.1">try_files</span></strong><span class="koboSpan" id="kobo.133.1"> line is very important for splitting</span><a id="_idIndexMarker373"/><span class="koboSpan" id="kobo.134.1"> the behavior of nginx regarding</span><a id="_idIndexMarker374"/><span class="koboSpan" id="kobo.135.1"> how to manage static resources (existing files) and dynamic resources (not </span><span class="No-Break"><span class="koboSpan" id="kobo.136.1">existing files).</span></span></p>
<p><span class="koboSpan" id="kobo.137.1">If the request is for </span><strong class="source-inline"><span class="koboSpan" id="kobo.138.1">/test.png</span></strong><span class="koboSpan" id="kobo.139.1"> and the file exists in a public directory (because of the root directive), the file is loaded and served </span><span class="No-Break"><span class="koboSpan" id="kobo.140.1">by nginx.</span></span></p>
<p><span class="koboSpan" id="kobo.141.1">If the request is for </span><strong class="source-inline"><span class="koboSpan" id="kobo.142.1">/test</span></strong><span class="koboSpan" id="kobo.143.1">, it falls in the latest scenario of </span><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">try_files</span></strong><span class="koboSpan" id="kobo.145.1"> labeled </span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.147.1">@octane</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.148.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.149.1">Then, there is a specific section to manage all requests labeled as </span><strong class="source-inline"><span class="koboSpan" id="kobo.150.1">@octane</span></strong><span class="koboSpan" id="kobo.151.1">. </span><span class="koboSpan" id="kobo.151.2">All these requests are sent to Laravel Octane via the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.152.1">proxy_pass</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.153.1"> directive.</span></span></p>
<p><span class="koboSpan" id="kobo.154.1">As you can see, all the FastCGI directives</span><a id="_idIndexMarker375"/><span class="koboSpan" id="kobo.155.1"> are commented out, or they are removed. </span><span class="koboSpan" id="kobo.155.2">Now, we</span><a id="_idIndexMarker376"/><span class="koboSpan" id="kobo.156.1"> are using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">proxy_pass</span></strong><span class="koboSpan" id="kobo.158.1"> directive. </span><span class="koboSpan" id="kobo.158.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">proxy_pass</span></strong><span class="koboSpan" id="kobo.160.1"> directive refers to the IP address</span><a id="_idIndexMarker377"/><span class="koboSpan" id="kobo.161.1"> and the port where the Laravel Octane service </span><span class="No-Break"><span class="koboSpan" id="kobo.162.1">is running.</span></span></p>
<p><span class="koboSpan" id="kobo.163.1">To make the proxy configuration work, you have to set some additional parameters such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.164.1">proxy_http_version 1.1;</span></strong><span class="koboSpan" id="kobo.165.1"> for setting the protocol version and other options for controlling </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">the headers.</span></span></p>
<p><span class="koboSpan" id="kobo.167.1">Once you edit your nginx configuration file, you must restart the nginx process to apply your changes. </span><span class="koboSpan" id="kobo.167.2">Before restarting nginx, I suggest checking the syntax of the changed </span><span class="No-Break"><span class="koboSpan" id="kobo.168.1">configuration files.</span></span></p>
<p><span class="koboSpan" id="kobo.169.1">Using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.170.1">nginx -t</span></strong><span class="koboSpan" id="kobo.171.1"> command shows you whether there are any issues with your </span><span class="No-Break"><span class="koboSpan" id="kobo.172.1">new configuration:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.173.1">
# nginx -t
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful</span></pre>
<p><span class="koboSpan" id="kobo.174.1">Once you have a successful message, you can safely restart nginx. </span><span class="koboSpan" id="kobo.174.2">How to restart the service depends on your distribution. </span><span class="koboSpan" id="kobo.174.3">In the case of Ubuntu, you can use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">service</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.176.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.177.1">
service nginx restart</span></pre>
<p><span class="koboSpan" id="kobo.178.1">In general, if your Linux distribution doesn’t provide a </span><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">service</span></strong><span class="koboSpan" id="kobo.180.1"> command, you can use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.181.1">systemctl</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.182.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.183.1">
sudo systemctl restart nginx</span></pre>
<p><span class="koboSpan" id="kobo.184.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.185.1">sudo</span></strong><span class="koboSpan" id="kobo.186.1"> command is used because you need to have </span><span class="No-Break"><span class="koboSpan" id="kobo.187.1">root permission.</span></span></p>
<p><span class="koboSpan" id="kobo.188.1">Once you reload nginx, you have to launch the </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1">artisan</span></strong><span class="koboSpan" id="kobo.190.1"> command for launching </span><span class="No-Break"><span class="koboSpan" id="kobo.191.1">Laravel Octane.</span></span></p>
<h2 id="_idParaDest-120"><a id="_idTextAnchor127"/><span class="koboSpan" id="kobo.192.1">Launching Octane</span></h2>
<p><span class="koboSpan" id="kobo.193.1">You can manually</span><a id="_idIndexMarker378"/><span class="koboSpan" id="kobo.194.1"> execute the </span><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">octane:start</span></strong><span class="koboSpan" id="kobo.196.1"> command for a quick configuration</span><a id="_idIndexMarker379"/><span class="koboSpan" id="kobo.197.1"> test. </span><span class="koboSpan" id="kobo.197.2">Then, we will see how to launch Octane automatically when the </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">system starts.</span></span></p>
<p><span class="koboSpan" id="kobo.199.1">For starting Octane, you should use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.200.1">octane:start</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.201.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.202.1">
php artisan octane:start --server=swoole</span></pre>
<p><span class="koboSpan" id="kobo.203.1">This command starts Octane and accepts connections </span><span class="No-Break"><span class="koboSpan" id="kobo.204.1">on localhost.</span></span></p>
<p><span class="koboSpan" id="kobo.205.1">Suppose you need to execute Octane on a different machine (one machine used for running nginx, and another machine used for running Laravel Octane): you should allow Octane to accept all incoming requests via the </span><strong class="source-inline"><span class="koboSpan" id="kobo.206.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">host</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.208.1"> parameter:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.209.1">
php artisan octane:start –host=0.0.0.0 –server=swoole</span></pre>
<p><span class="koboSpan" id="kobo.210.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.211.1">0.0.0.0</span></strong><span class="koboSpan" id="kobo.212.1"> address means Octane will accept all incoming requests from all IP addresses (not just the </span><span class="No-Break"><span class="koboSpan" id="kobo.213.1">local ones).</span></span></p>
<h2 id="_idParaDest-121"><a id="_idTextAnchor128"/><span class="koboSpan" id="kobo.214.1">Launching Octane via Supervisor</span></h2>
<p><span class="koboSpan" id="kobo.215.1">If you need to launch</span><a id="_idIndexMarker380"/><span class="koboSpan" id="kobo.216.1"> and monitor a process</span><a id="_idIndexMarker381"/><span class="koboSpan" id="kobo.217.1"> during the boot </span><a id="_idIndexMarker382"/><span class="koboSpan" id="kobo.218.1">of the system, I suggest doing it with </span><span class="No-Break"><span class="koboSpan" id="kobo.219.1">Supervisor software.</span></span></p>
<p><span class="koboSpan" id="kobo.220.1">There is excellent open source software named Supervisor that you can install via your GNU/Linux package manager through a command such as </span><span class="No-Break"><span class="koboSpan" id="kobo.221.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.222.1">
apt-get install supervisor</span></pre>
<p><span class="koboSpan" id="kobo.223.1">Once Supervisor is installed, you can set the startup script file for </span><span class="No-Break"><span class="koboSpan" id="kobo.224.1">Laravel Octane.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.225.1">Supervisor</span></p>
<p class="callout"><span class="koboSpan" id="kobo.226.1">If you are interested in Supervisor</span><a id="_idIndexMarker383"/><span class="koboSpan" id="kobo.227.1"> for other projects/commands (not just for Laravel Octane), you can retrieve more information on the official </span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">website: </span></span><a href="http://supervisord.org/"><span class="No-Break"><span class="koboSpan" id="kobo.229.1">http://supervisord.org/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.230.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.231.1">The startup scripts managed by the supervisor are stored in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">conf.d</span></strong><span class="koboSpan" id="kobo.233.1"> directory, which is inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.234.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.235.1">etc/supervisor/</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.236.1"> directory.</span></span></p>
<p><span class="koboSpan" id="kobo.237.1">Create a new file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">/etc/supervisor/conf.d/laravel-octane.conf</span></strong><span class="koboSpan" id="kobo.239.1">, with </span><span class="No-Break"><span class="koboSpan" id="kobo.240.1">this</span></span><span class="No-Break"><a id="_idIndexMarker384"/></span><span class="No-Break"><span class="koboSpan" id="kobo.241.1"> configuration:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.242.1">
[program:laravel-octane]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/mydomain/htdocs/artisan octane:sta– --server=swoo– --max-requests=10– --workers– --task-workers=– --port=8000
autostart=true
autorestart=true
user=deploy
redirect_stderr=true
stdout_logfile=/var/www/mydomain/htdocs/storage/logs/laravel-octane-worker.log</span></pre>
<p><span class="koboSpan" id="kobo.243.1">Here, you</span><a id="_idIndexMarker385"/><span class="koboSpan" id="kobo.244.1"> have to set </span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">some</span></span><span class="No-Break"><a id="_idIndexMarker386"/></span><span class="No-Break"><span class="koboSpan" id="kobo.246.1"> directives:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">process_name</span></strong><span class="koboSpan" id="kobo.248.1">: This is the name used for tagging </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">the process</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.250.1">command</span></strong><span class="koboSpan" id="kobo.251.1">: This is the command line for launching the Octane service </span><span class="No-Break"><span class="koboSpan" id="kobo.252.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.253.1">octane:start</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.254.1">autostart</span></strong><span class="koboSpan" id="kobo.255.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.256.1">autorestart</span></strong><span class="koboSpan" id="kobo.257.1">: This is to set how and when to start the </span><span class="No-Break"><span class="koboSpan" id="kobo.258.1">process (automatically)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.259.1">The user used for launching the process (I’m using a specific one such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.260.1">deploy</span></strong><span class="koboSpan" id="kobo.261.1">) is usually </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">www-data</span></strong><span class="koboSpan" id="kobo.263.1">, which, by convention, is the user used for running the web server process (nginx </span><span class="No-Break"><span class="koboSpan" id="kobo.264.1">or Apache).</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">redirect_stderr</span></strong><span class="koboSpan" id="kobo.266.1">: If the error messages have to be redirected to the log this </span><span class="No-Break"><span class="koboSpan" id="kobo.267.1">is used.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">stdout_logfile</span></strong><span class="koboSpan" id="kobo.269.1">: This is the file name used for the log. </span><span class="koboSpan" id="kobo.269.2">Make sure that one row for each request managed by Octane is created </span><span class="No-Break"><span class="koboSpan" id="kobo.270.1">by default.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.271.1">Supervisor supports many parameters if you are interested in a more complex configuration. </span><span class="koboSpan" id="kobo.271.2">All the parameters</span><a id="_idIndexMarker387"/><span class="koboSpan" id="kobo.272.1"> are documented </span><span class="No-Break"><span class="koboSpan" id="kobo.273.1">here: </span></span><a href="http://supervisord.org/configuration.html"><span class="No-Break"><span class="koboSpan" id="kobo.274.1">http://supervisord.org/configuration.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.275.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.276.1">Once you have set the configuration</span><a id="_idIndexMarker388"/><span class="koboSpan" id="kobo.277.1"> file, you can update</span><a id="_idIndexMarker389"/><span class="koboSpan" id="kobo.278.1"> the Supervisor configuration, adding</span><a id="_idIndexMarker390"/><span class="koboSpan" id="kobo.279.1"> the Laravel </span><span class="No-Break"><span class="koboSpan" id="kobo.280.1">Octane configuration:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.281.1">
supervisorctl update</span></pre>
<p><span class="koboSpan" id="kobo.282.1">Then, you </span><span class="No-Break"><span class="koboSpan" id="kobo.283.1">restart Supervisor:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.284.1">
supervisorctl restart all</span></pre>
<p><span class="koboSpan" id="kobo.285.1">Or you can specifically restart just the </span><span class="No-Break"><span class="koboSpan" id="kobo.286.1">Octane service:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.287.1">
supervisorctl restart laravel-octane:laravel-octane_00</span></pre>
<p><span class="koboSpan" id="kobo.288.1">This way, the Laravel Octane is launched according to the parameter defined on the command line (the command directive in the Supervisor configuration), and Laravel Octane is relaunched in case of reboot </span><span class="No-Break"><span class="koboSpan" id="kobo.289.1">or crash.</span></span></p>
<p><span class="koboSpan" id="kobo.290.1">Now, Laravel Octane has launched automatically. </span><span class="koboSpan" id="kobo.290.2">If you change your application’s source code or deploy a new version of your Laravel application, you have to reload the worker so that all the changes are applied to all </span><span class="No-Break"><span class="koboSpan" id="kobo.291.1">the workers.</span></span></p>
<p><span class="koboSpan" id="kobo.292.1">Reloading </span><span class="No-Break"><span class="koboSpan" id="kobo.293.1">the workers</span></span></p>
<p><span class="koboSpan" id="kobo.294.1">Every time you make some changes</span><a id="_idIndexMarker391"/><span class="koboSpan" id="kobo.295.1"> to your application logic, you have to restart the application with the </span><span class="No-Break"><span class="koboSpan" id="kobo.296.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.297.1">
php artisan octane:reload</span></pre>
<p><span class="koboSpan" id="kobo.298.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">octane:reload</span></strong><span class="koboSpan" id="kobo.300.1"> command restarts the workers instanced by Octane, and in this way, the code </span><span class="No-Break"><span class="koboSpan" id="kobo.301.1">is reloaded.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer061">
<span class="koboSpan" id="kobo.302.1"><img alt="Figure 7.2: Reloading the workers with php artisan octane:reload" src="image/Figure_7.02_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.303.1">Figure 7.2: Reloading the workers with php artisan octane:reload</span></p>
<p><span class="koboSpan" id="kobo.304.1">If you want to know about the status (running or not) of the Laravel Octane service, you can use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.305.1">octane:status</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.306.1"> command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.307.1">
php artisan octane:status</span></pre>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">octane:status</span></strong><span class="koboSpan" id="kobo.309.1"> shows the </span><strong class="bold"><span class="koboSpan" id="kobo.310.1">Octane server is running.</span></strong><span class="koboSpan" id="kobo.311.1"> message if everything</span><a id="_idIndexMarker392"/><span class="koboSpan" id="kobo.312.1"> is fine. </span><span class="koboSpan" id="kobo.312.2">Otherwise, it shows </span><strong class="bold"><span class="koboSpan" id="kobo.313.1">Octane server is </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.314.1">not running.</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer062">
<span class="koboSpan" id="kobo.316.1"><img alt="Figure 7.3: Checking the status of Laravel Octane" src="image/Figure_7.03_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.317.1">Figure 7.3: Checking the status of Laravel Octane</span></p>
<h2 id="_idParaDest-122"><a id="_idTextAnchor129"/><span class="koboSpan" id="kobo.318.1">Listening events</span></h2>
<p><span class="koboSpan" id="kobo.319.1">Laravel Octane internally</span><a id="_idIndexMarker393"/><span class="koboSpan" id="kobo.320.1"> defines some events for notifying and managing</span><a id="_idIndexMarker394"/><span class="koboSpan" id="kobo.321.1"> when something happens, such as the worker starting, a request being received, and so on. </span><span class="koboSpan" id="kobo.321.2">In a framework, if you can produce some events, as a developer, you need a mechanism to listen for when an event occurs. </span><span class="koboSpan" id="kobo.321.3">The Laravel framework provides the developer with a mechanism to define and create events and a mechanism to listen (a listener). </span><span class="koboSpan" id="kobo.321.4">The listener in Laravel can execute a function defined by </span><span class="No-Break"><span class="koboSpan" id="kobo.322.1">the developer.</span></span></p>
<p><span class="koboSpan" id="kobo.323.1">So, in this case, using the event listener mechanism provided by Laravel, you can listen to some specific Laravel </span><span class="No-Break"><span class="koboSpan" id="kobo.324.1">Octane events.</span></span></p>
<p><span class="koboSpan" id="kobo.325.1">Looking into the Laravel Octane config file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.326.1">config/octane.php</span></strong><span class="koboSpan" id="kobo.327.1">) in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">listener</span></strong><span class="koboSpan" id="kobo.329.1"> section, you will see that the defined events are as follows: </span><strong class="source-inline"><span class="koboSpan" id="kobo.330.1">WorkerStarting</span></strong><span class="koboSpan" id="kobo.331.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.332.1">RequestReceived</span></strong><span class="koboSpan" id="kobo.333.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">RequestHandled</span></strong><span class="koboSpan" id="kobo.335.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">RequestTerminated</span></strong><span class="koboSpan" id="kobo.337.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">TaskReceived</span></strong><span class="koboSpan" id="kobo.339.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.340.1">TaskTerminated</span></strong><span class="koboSpan" id="kobo.341.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.342.1">TickReceived</span></strong><span class="koboSpan" id="kobo.343.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.344.1">TickTerminated</span></strong><span class="koboSpan" id="kobo.345.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.346.1">OperationTerminated</span></strong><span class="koboSpan" id="kobo.347.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">WorkerErrorOccurred</span></strong><span class="koboSpan" id="kobo.349.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.350.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">WorkerStopping</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.352.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.353.1">For example, if you want to implement a listener for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">RequestReceived</span></strong><span class="koboSpan" id="kobo.355.1"> event, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">make:listener</span></strong><span class="koboSpan" id="kobo.357.1"> command to create the </span><span class="No-Break"><span class="koboSpan" id="kobo.358.1">listener class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.359.1">
php artisan make:listener RequestReceivedNotification --event=RequestReceived</span></pre>
<p><span class="koboSpan" id="kobo.360.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.361.1">make:listener</span></strong><span class="koboSpan" id="kobo.362.1"> command creates the </span><strong class="source-inline"><span class="koboSpan" id="kobo.363.1">RequestReceivedNotification</span></strong><span class="koboSpan" id="kobo.364.1"> class file based on the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.365.1">RequestReceived</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.366.1"> event.</span></span></p>
<p><span class="koboSpan" id="kobo.367.1">The file is created in </span><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">app/Listeners/RequestReceivedNotification.php</span></strong><span class="koboSpan" id="kobo.369.1"> with the constructor</span><a id="_idIndexMarker395"/><span class="koboSpan" id="kobo.370.1"> and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.371.1">handle()</span></strong><span class="koboSpan" id="kobo.372.1"> method, so you</span><a id="_idIndexMarker396"/><span class="koboSpan" id="kobo.373.1"> can add your logic to track some of the activity in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">handle()</span></strong><span class="koboSpan" id="kobo.375.1"> method; for example, I’m going to log the IP address where the request </span><span class="No-Break"><span class="koboSpan" id="kobo.376.1">comes from:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.377.1">
&lt;?php
namespace App\Listeners;
use Illuminate\Support\Facades\Log;
use Laravel\Octane\Events\RequestReceived;
class RequestReceivedNotification
{
    /**
     * Create the event listener.
</span><span class="koboSpan" id="kobo.377.2">     *
     * @return void
     */
    public function __construct()
    {
        //
    }
    /**
     * Handle the event.
</span><span class="koboSpan" id="kobo.377.3">     *
     * @param  \Laravel\Octane\Events\RequestReceived;
        $event
     * @return void
     */
    public function handle(RequestReceived $event)
    {
        Log::info('Request Received by
                  '.$event-&gt;request-&gt;ip());
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.378.1">To enable the listener, you</span><a id="_idIndexMarker397"/><span class="koboSpan" id="kobo.379.1"> have to add</span><a id="_idIndexMarker398"/><span class="koboSpan" id="kobo.380.1"> the class to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.381.1">config/octane.php</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.382.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.383.1">
        RequestReceived::class =&gt; [
            ...Octane::prepareApplicationForNextOperation(),
            ...Octane::prepareApplicationForNextRequest(),
// Add the RequestReceivedNotification class
            RequestReceivedNotification::class
            //
        ],</span></pre>
<p><span class="koboSpan" id="kobo.384.1">In the same way, you</span><a id="_idIndexMarker399"/><span class="koboSpan" id="kobo.385.1"> can also add other events</span><a id="_idIndexMarker400"/><span class="koboSpan" id="kobo.386.1"> you want </span><span class="No-Break"><span class="koboSpan" id="kobo.387.1">to track.</span></span></p>
<p><span class="koboSpan" id="kobo.388.1">Now that we have configured the web server for the production environment, we can walk through the Laravel configuration for the </span><span class="No-Break"><span class="koboSpan" id="kobo.389.1">production environment.</span></span></p>
<h1 id="_idParaDest-123"><a id="_idTextAnchor130"/><span class="koboSpan" id="kobo.390.1">Prepping a Laravel application for production</span></h1>
<p><span class="koboSpan" id="kobo.391.1">Now, we will focus on Laravel-specific configurations</span><a id="_idIndexMarker401"/><span class="koboSpan" id="kobo.392.1"> for the production</span><a id="_idIndexMarker402"/><span class="koboSpan" id="kobo.393.1"> environment. </span><span class="koboSpan" id="kobo.393.2">We will see how to install production PHP/Laravel packages, avoiding installing packages for development and debugging. </span><span class="koboSpan" id="kobo.393.3">We will see how to optimize cache configurations, routing settings, and view optimization. </span><span class="koboSpan" id="kobo.393.4">Finally, we will see how to inhibit debugging options. </span><span class="koboSpan" id="kobo.393.5">Debugging options are very useful in development, but can slow down the execution of the Laravel application </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1">in production.</span></span></p>
<h2 id="_idParaDest-124"><a id="_idTextAnchor131"/><span class="koboSpan" id="kobo.395.1">Installing the packages for production</span></h2>
<p><span class="koboSpan" id="kobo.396.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.397.1">composer.json</span></strong><span class="koboSpan" id="kobo.398.1"> file, two types</span><a id="_idIndexMarker403"/><span class="koboSpan" id="kobo.399.1"> of packages are listed: </span><strong class="source-inline"><span class="koboSpan" id="kobo.400.1">require</span></strong><span class="koboSpan" id="kobo.401.1"> defines the packages for running the application in a production environment, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.402.1">require-dev</span></strong><span class="koboSpan" id="kobo.403.1"> defines the packages for running the application in a </span><span class="No-Break"><span class="koboSpan" id="kobo.404.1">development environment.</span></span></p>
<p><span class="koboSpan" id="kobo.405.1">By default, </span><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">composer</span></strong><span class="koboSpan" id="kobo.407.1"> installs all the packages from </span><span class="No-Break"><span class="koboSpan" id="kobo.408.1">both lists.</span></span></p>
<p><span class="koboSpan" id="kobo.409.1">If you only want to install the packages from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.410.1">require</span></strong><span class="koboSpan" id="kobo.411.1"> list (production), you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.412.1">–-no-dev</span></strong><span class="koboSpan" id="kobo.413.1"> option while you are installing the packages for the </span><span class="No-Break"><span class="koboSpan" id="kobo.414.1">production environment:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.415.1">
composer install --optimize-autoloader --no-dev</span></pre>
<p><span class="koboSpan" id="kobo.416.1">Other than the </span><strong class="source-inline"><span class="koboSpan" id="kobo.417.1">--no-dev</span></strong><span class="koboSpan" id="kobo.418.1"> option, we are using </span><strong class="source-inline"><span class="koboSpan" id="kobo.419.1">optimize-autoloader</span></strong><span class="koboSpan" id="kobo.420.1">. </span><span class="koboSpan" id="kobo.420.2">The option generates a data structure (an index) to map the class name, with the name of the file to </span><span class="No-Break"><span class="koboSpan" id="kobo.421.1">be loaded.</span></span></p>
<p><span class="koboSpan" id="kobo.422.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.423.1">optimize-autoloader</span></strong><span class="koboSpan" id="kobo.424.1"> option reduces the </span><span class="No-Break"><span class="koboSpan" id="kobo.425.1">bootstrap time.</span></span></p>
<h2 id="_idParaDest-125"><a id="_idTextAnchor132"/><span class="koboSpan" id="kobo.426.1">Caching config, routing, and views</span></h2>
<p><span class="koboSpan" id="kobo.427.1">To load some critical components</span><a id="_idIndexMarker404"/><span class="koboSpan" id="kobo.428.1"> such as the configuration</span><a id="_idIndexMarker405"/><span class="koboSpan" id="kobo.429.1"> files, the routing</span><a id="_idIndexMarker406"/><span class="koboSpan" id="kobo.430.1"> configuration, and the view blade templates quickly, you can use the </span><span class="No-Break"><span class="koboSpan" id="kobo.431.1">cache commands:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.432.1">
php artisan config:cache
php artisan route:cache
php artisan view:cache</span></pre>
<p><span class="koboSpan" id="kobo.433.1">You have to execute these commands every time you change certain files in your Laravel application in the </span><span class="No-Break"><span class="koboSpan" id="kobo.434.1">production environment.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer063">
<span class="koboSpan" id="kobo.435.1"><img alt="Figure 7.4: Caching configs, routes, and views" src="image/Figure_7.04_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.436.1">Figure 7.4: Caching configs, routes, and views</span></p>
<h2 id="_idParaDest-126"><a id="_idTextAnchor133"/><span class="koboSpan" id="kobo.437.1">Disabling Debug mode</span></h2>
<p><span class="koboSpan" id="kobo.438.1">When developing the Laravel </span><a id="_idIndexMarker407"/><span class="koboSpan" id="kobo.439.1">application, the configuration is typically set to Debug mode. </span><span class="koboSpan" id="kobo.439.2">The parameter that controls the Debug mode is stored in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.440.1">.env</span></strong><span class="koboSpan" id="kobo.441.1"> file, and the parameter is </span><span class="No-Break"><span class="koboSpan" id="kobo.442.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.443.1">
APP_DEBUG=true</span></pre>
<p><span class="koboSpan" id="kobo.444.1">To check the status of your application, you can use the </span><span class="No-Break"><span class="koboSpan" id="kobo.445.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.446.1">
php artisan about</span></pre>
<p><span class="koboSpan" id="kobo.447.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">about</span></strong><span class="koboSpan" id="kobo.449.1"> command shows the information about </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.450.1">Debug Mode</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.451.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer064">
<span class="koboSpan" id="kobo.452.1"><img alt="Figure 7.5: The about command for showing the Debug mode status" src="image/Figure_7.05_B17728.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.453.1">Figure 7.5: The about command for showing the Debug mode status</span></p>
<p><span class="koboSpan" id="kobo.454.1">To change the setting, you can change the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.455.1">APP_DEBUG</span></strong><span class="koboSpan" id="kobo.456.1"> parameter </span><span class="No-Break"><span class="koboSpan" id="kobo.457.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.458.1">false</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.459.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.460.1">
APP_DEBUG=false</span></pre>
<p><span class="koboSpan" id="kobo.461.1">The configuration of </span><strong class="source-inline"><span class="koboSpan" id="kobo.462.1">APP_DEBUG</span></strong><span class="koboSpan" id="kobo.463.1"> set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.464.1">false</span></strong><span class="koboSpan" id="kobo.465.1"> allows you</span><a id="_idIndexMarker408"/><span class="koboSpan" id="kobo.466.1"> to skip all the configurations in the code for debugging purposes (collecting and showing </span><span class="No-Break"><span class="koboSpan" id="kobo.467.1">detailed information).</span></span></p>
<p><span class="koboSpan" id="kobo.468.1">Because you changed the configuration and the configuration is cached, the suggestion is to clear the configuration to see the changes in </span><span class="No-Break"><span class="koboSpan" id="kobo.469.1">the application:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.470.1">
php artisan config:clear</span></pre>
<p><span class="koboSpan" id="kobo.471.1">You should also reduce the number of log messages. </span><span class="koboSpan" id="kobo.471.2">Log messages are very useful for debugging purposes, but tracking the logs could be an expensive operation and could slow down </span><span class="No-Break"><span class="koboSpan" id="kobo.472.1">the application.</span></span></p>
<p><span class="koboSpan" id="kobo.473.1">For example, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.474.1">.env</span></strong><span class="koboSpan" id="kobo.475.1"> configuration file, typically, you can find </span><span class="No-Break"><span class="koboSpan" id="kobo.476.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.477.1">
LOG_LEVEL=debug</span></pre>
<p><span class="koboSpan" id="kobo.478.1">The levels of debugging, from most detailed (with more logs) to just tracking the errors, are as follows: </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">debug</span></strong><span class="koboSpan" id="kobo.480.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">info</span></strong><span class="koboSpan" id="kobo.482.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.483.1">notice</span></strong><span class="koboSpan" id="kobo.484.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.485.1">warning</span></strong><span class="koboSpan" id="kobo.486.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">error</span></strong><span class="koboSpan" id="kobo.488.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.489.1">critical</span></strong><span class="koboSpan" id="kobo.490.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.491.1">alert</span></strong><span class="koboSpan" id="kobo.492.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.493.1">emergency</span></strong><span class="koboSpan" id="kobo.494.1">. </span><span class="koboSpan" id="kobo.494.2">My suggestion is to change the level of logs (</span><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">LOG_LEVEL</span></strong><span class="koboSpan" id="kobo.496.1">) in a production environment to </span><strong class="source-inline"><span class="koboSpan" id="kobo.497.1">error</span></strong><span class="koboSpan" id="kobo.498.1"> in order to only track critical information because reducing the number of log messages makes your application faster and can reduce the amount of </span><span class="No-Break"><span class="koboSpan" id="kobo.499.1">storage needed.</span></span></p>
<p><span class="koboSpan" id="kobo.500.1">The general suggestion</span><a id="_idIndexMarker409"/><span class="koboSpan" id="kobo.501.1"> is to have a specific configuration for the production environment, so the advice is to create a file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.502.1">.env.prod</span></strong><span class="koboSpan" id="kobo.503.1">, where you can store your production configuration. </span><span class="koboSpan" id="kobo.503.2">Then, copy the </span><strong class="source-inline"><span class="koboSpan" id="kobo.504.1">.env.prod</span></strong><span class="koboSpan" id="kobo.505.1"> file on each deployment to your </span><strong class="source-inline"><span class="koboSpan" id="kobo.506.1">.env</span></strong><span class="koboSpan" id="kobo.507.1"> file in the </span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">production environment.</span></span></p>
<h1 id="_idParaDest-127"><a id="_idTextAnchor134"/><span class="koboSpan" id="kobo.509.1">Deployment approaches</span></h1>
<p><span class="koboSpan" id="kobo.510.1">You can choose a deployment</span><a id="_idIndexMarker410"/><span class="koboSpan" id="kobo.511.1"> strategy from the numerous ones </span><span class="No-Break"><span class="koboSpan" id="kobo.512.1">that exist.</span></span></p>
<p><span class="koboSpan" id="kobo.513.1">The rule that I would recommend when choosing a deployment strategy is to avoid installing valuable tools for the build phase in the production environment. </span><span class="koboSpan" id="kobo.513.2">Because the approach is to limit the responsibility of the production environment to the delivery of ready-to-deploy assets, responsibility for executing the build process should not be the responsibility of the production environment. </span><span class="koboSpan" id="kobo.513.3">That’s why it’s possible to avoid installing build tools in the </span><span class="No-Break"><span class="koboSpan" id="kobo.514.1">production environment.</span></span></p>
<p><span class="koboSpan" id="kobo.515.1">For example, I suggest avoiding performing the build of JavaScript and CSS, running tests or “linting” processes, or performing static code analysis in </span><span class="No-Break"><span class="koboSpan" id="kobo.516.1">production environments.</span></span></p>
<p><span class="koboSpan" id="kobo.517.1">In other words, it is necessary to transfer optimized code and ready-made configurations directly to the </span><span class="No-Break"><span class="koboSpan" id="kobo.518.1">production server.</span></span></p>
<p><span class="koboSpan" id="kobo.519.1">This means that if there should be build operations that aim to prepare files and configurations for production, these should be performed in a dedicated environment or a </span><span class="No-Break"><span class="koboSpan" id="kobo.520.1">CI/CD runner.</span></span></p>
<p><span class="koboSpan" id="kobo.521.1">The build mechanism and file transfer commands in the production environment can be complex. </span><span class="koboSpan" id="kobo.521.2">Therefore, the advice is to formalize this list of commands in a </span><span class="No-Break"><span class="koboSpan" id="kobo.522.1">scripting tool.</span></span></p>
<p><span class="koboSpan" id="kobo.523.1">I use </span><strong class="source-inline"><span class="koboSpan" id="kobo.524.1">Makefile</span></strong><span class="koboSpan" id="kobo.525.1"> because this allows me to define the individual steps to be executed but, more importantly, determine the dependencies </span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">between steps.</span></span></p>
<p><span class="koboSpan" id="kobo.527.1">Typically, I define a step for compiling assets, a step for testing, a step for running </span><strong class="source-inline"><span class="koboSpan" id="kobo.528.1">phpcs</span></strong><span class="koboSpan" id="kobo.529.1"> (lint), a step for performing static code analysis, and a step for transferring files to the production environment. </span><span class="koboSpan" id="kobo.529.2">There are also specific steps for executing commands directly on the production server should the need arise. </span><span class="koboSpan" id="kobo.529.3">This number of granular steps allows me to keep each </span><span class="No-Break"><span class="koboSpan" id="kobo.530.1">step simple.</span></span></p>
<p><span class="koboSpan" id="kobo.531.1">There are several methodologies for copying and transferring files to production; the advice is to find</span><a id="_idIndexMarker411"/><span class="koboSpan" id="kobo.532.1"> the one that is most</span><a id="_idIndexMarker412"/><span class="koboSpan" id="kobo.533.1"> suited to you; typically, I use </span><strong class="bold"><span class="koboSpan" id="kobo.534.1">Secure Shell (SSH)</span></strong><span class="koboSpan" id="kobo.535.1"> protocol </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">and tools.</span></span></p>
<p><span class="koboSpan" id="kobo.537.1">Nevertheless, again, the most crucial part is to understand that, irrespective of the way you transfer the files or the tool you are using, you should transfer files and configuration ready to be served by the </span><span class="No-Break"><span class="koboSpan" id="kobo.538.1">production environment.</span></span></p>
<p><span class="No-Break"><span class="koboSpan" id="kobo.539.1">Makefile</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.540.1">Makefile</span></strong><span class="koboSpan" id="kobo.541.1"> is a file used by</span><a id="_idIndexMarker413"/><span class="koboSpan" id="kobo.542.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">make</span></strong><span class="koboSpan" id="kobo.544.1"> tools to execute</span><a id="_idIndexMarker414"/><span class="koboSpan" id="kobo.545.1"> commands. </span><span class="koboSpan" id="kobo.545.2">The format is quite simple; each group of commands is grouped into steps. </span><span class="koboSpan" id="kobo.545.3">You can specify the step to be executed from the command line when you start running the file via the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.546.1">make</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.547.1"> command.</span></span></p>
<p><span class="koboSpan" id="kobo.548.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.549.1">Makefile</span></strong><span class="koboSpan" id="kobo.550.1">, all the commands are listed, and the command to be executed needs a parameter such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.551.1">SSH_USER</span></strong><span class="koboSpan" id="kobo.552.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.553.1">WEB_DIR</span></strong><span class="koboSpan" id="kobo.554.1">. </span><span class="koboSpan" id="kobo.554.2">My suggestion is to define the parameters in an external </span><strong class="source-inline"><span class="koboSpan" id="kobo.555.1">Makefile</span></strong><span class="koboSpan" id="kobo.556.1">. </span><span class="koboSpan" id="kobo.556.2">Then, you can ignore (in the Git repository) the </span><strong class="source-inline"><span class="koboSpan" id="kobo.557.1">Makefile</span></strong><span class="koboSpan" id="kobo.558.1"> used for the parameters and commit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.559.1">Makefile</span></strong><span class="koboSpan" id="kobo.560.1"> with </span><span class="No-Break"><span class="koboSpan" id="kobo.561.1">the steps.</span></span></p>
<p><span class="koboSpan" id="kobo.562.1">In the root directory of your Laravel project, create a file </span><span class="No-Break"><span class="koboSpan" id="kobo.563.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.564.1">Makefile.param</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.565.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.566.1">
SSH_ALIAS=some.vm
SSH_USER=deploy
WEB_DIR=/var/www/mydomain/htdocs
WEB_USER=www-data
WEB_GROUP=www-data
# DRY_RUN=--dry-run
DRY_RUN=</span></pre>
<p><span class="koboSpan" id="kobo.567.1">The meaning of the parameters is quite self-explanatory; you can define the SSH alias and the SSH user to access the remote machine via SSH, and then you can specify the remote directory (on the server) where your Laravel application is stored (</span><strong class="source-inline"><span class="koboSpan" id="kobo.568.1">WEB_DIR</span></strong><span class="koboSpan" id="kobo.569.1">). </span><span class="koboSpan" id="kobo.569.2">Then, you can set the user (</span><strong class="source-inline"><span class="koboSpan" id="kobo.570.1">WEB_USER</span></strong><span class="koboSpan" id="kobo.571.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.572.1">WEB_GROUP</span></strong><span class="koboSpan" id="kobo.573.1">) on the server, used for running the processes on the server. </span><span class="koboSpan" id="kobo.573.2">Then, with </span><strong class="source-inline"><span class="koboSpan" id="kobo.574.1">DRY_RUN</span></strong><span class="koboSpan" id="kobo.575.1">, you can see (and copy) the files to be copied on </span><span class="No-Break"><span class="koboSpan" id="kobo.576.1">the server.</span></span></p>
<p><span class="koboSpan" id="kobo.577.1">For copying the file on the server, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.578.1">rsync</span></strong><span class="koboSpan" id="kobo.579.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.580.1">rsync</span></strong><span class="koboSpan" id="kobo.581.1"> is a great tool for only copying the </span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">changed file.</span></span></p>
<p><span class="koboSpan" id="kobo.583.1">To create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.584.1">Makefile</span></strong><span class="koboSpan" id="kobo.585.1">, create</span><a id="_idIndexMarker415"/><span class="koboSpan" id="kobo.586.1"> a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">Makefile.deploy</span></strong><span class="koboSpan" id="kobo.588.1"> and fill </span><a id="_idIndexMarker416"/><span class="koboSpan" id="kobo.589.1">it with </span><span class="No-Break"><span class="koboSpan" id="kobo.590.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.591.1">
.PHONY: help all remotedu rsynca copyenvprod fixgroupuser newdeploy migratestatus migrate migrateseed migraterefresh buildfrontend optimize composerinstallnodev restartworkers octanestatus installdevdeps deploy
include Makefile.param.prod
all: help
help:
    @grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) |
    sort | awk 'BEGIN {FS = ":.*?## "};
    {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'
remotedu: ## Execute DU command in htdocs dir, just for diagnostic purpose
    ssh ${SSH_ALIAS} "cd ${WEB_DIR}; du -h"
rsynca: ## execute Rsync from current dir and remote htdocs ${WEB_DIR}
    rsync ${DRY_RUN} -rlcgoDvzi -e "ssh" --delete .
</span><span class="koboSpan" id="kobo.591.2">      ${SSH_ALIAS}:${WEB_DIR}  --exclude-from
      'exclude-list.txt'
copyenvprod:
    scp .env.prod ${SSH_ALIAS}:${WEB_DIR}/.env
fixgroupuser: ## Add the right group(www) to the deploy user (ssh user)
    ssh -t ${SSH_ALIAS} "sudo usermod -a -G ${WEB_GROUP}
    ${SSH_USER}"
fixownership: ## fix the ownership for user ${WEB_USER} into ${WEB_DIR}/storage
    ssh -t ${SSH_ALIAS} "sudo chown -R
    ${WEB_USER}:${WEB_GROUP} ${WEB_DIR}/storage; ls -lao
    ${WEB_DIR}/storage"
newdeploy: buildfrontend rsynca copyenvprod fixgroupuser fixownership migrate ##first deploy
migratestatus: ## list the migration status
    ssh ${SSH_ALIAS} "cd ${WEB_DIR}; php artisan
    migrate:status --env=prod"
migrate: ## Execute migrate command for DB schema
    ssh ${SSH_ALIAS} "cd ${WEB_DIR}; php artisan migrate
    --env=prod"
migrateseed: ## Execute migrate command for DB schema
    ssh ${SSH_ALIAS} "cd ${WEB_DIR}; php artisan
    migrate:refresh --seed --env=prod"
migraterefresh: ## Execute migrate command for DB schema
    ssh ${SSH_ALIAS} "cd ${WEB_DIR}; php artisan
    migrate:refresh"
buildfrontend: ## execute npm task to compile frontend assets (js and css...)
    npm run build
optimize: ## Optimize application in production
    ssh ${SSH_ALIAS} "cd ${WEB_DIR}; php artisan
    config:cache; php artisan route:cache; php artisan
    view:cache"
composerinstallnodev:
    composer install --optimize-autoloader  --no-dev
restartworkers:
    ssh ${SSH_ALIAS} "cd ${WEB_DIR}; php artisan octane:reload"
octanestatus:
    ssh ${SSH_ALIAS} "cd ${WEB_DIR}; php artisan octane:status"
installdevdeps:
    composer install
    npm run dev
    php artisan config:clear
deploy: buildfrontend composerinstallnodev rsynca copyenvprod migrate restartworkers installdevdeps</span></pre>
<p><span class="koboSpan" id="kobo.592.1">The last line</span><a id="_idIndexMarker417"/><span class="koboSpan" id="kobo.593.1"> is for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">deploy</span></strong><span class="koboSpan" id="kobo.595.1"> step. </span><span class="koboSpan" id="kobo.595.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">deploy</span></strong><span class="koboSpan" id="kobo.597.1"> step doesn’t include commands</span><a id="_idIndexMarker418"/><span class="koboSpan" id="kobo.598.1"> to execute but consists of a list of steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.599.1">invoke sequentially.</span></span></p>
<p><span class="koboSpan" id="kobo.600.1">The first step executed will be </span><strong class="source-inline"><span class="koboSpan" id="kobo.601.1">buildfrontend</span></strong><span class="koboSpan" id="kobo.602.1">. </span><span class="koboSpan" id="kobo.602.2">This step includes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.603.1">npm run build</span></strong><span class="koboSpan" id="kobo.604.1"> command. </span><span class="koboSpan" id="kobo.604.2">The command will build the </span><span class="No-Break"><span class="koboSpan" id="kobo.605.1">frontend assets.</span></span></p>
<p><span class="koboSpan" id="kobo.606.1">The next step included in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.607.1">deploy</span></strong><span class="koboSpan" id="kobo.608.1"> step is </span><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">composerinstallnodev</span></strong><span class="koboSpan" id="kobo.610.1">. </span><span class="koboSpan" id="kobo.610.2">The command executed by </span><strong class="source-inline"><span class="koboSpan" id="kobo.611.1">composerinstallnodev</span></strong><span class="koboSpan" id="kobo.612.1"> will install the packages for the production (skipping the </span><span class="No-Break"><span class="koboSpan" id="kobo.613.1">dev packages):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.614.1">
composer install --optimize-autoloader  --no-dev</span></pre>
<p><span class="koboSpan" id="kobo.615.1">Then, there is the step for copying the files on the server: </span><strong class="source-inline"><span class="koboSpan" id="kobo.616.1">rsynca</span></strong><span class="koboSpan" id="kobo.617.1">. </span><span class="koboSpan" id="kobo.617.2">The step includes </span><span class="No-Break"><span class="koboSpan" id="kobo.618.1">a command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.619.1">
rsync ${DRY_RUN} -rlcgovzi -e "ssh" --delete . </span><span class="koboSpan" id="kobo.619.2">${SSH_ALIAS}:${WEB_DIR}  --exclude-from 'exclude-list.txt'</span></pre>
<p><span class="koboSpan" id="kobo.620.1">In the command, some variables (replaced with the values loaded from </span><strong class="source-inline"><span class="koboSpan" id="kobo.621.1">Makefile.param.prod</span></strong><span class="koboSpan" id="kobo.622.1"> file) </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">are used.</span></span></p>
<p><span class="koboSpan" id="kobo.624.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.625.1">Makefile.param.prod</span></strong><span class="koboSpan" id="kobo.626.1"> file is loaded at the beginning of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.627.1">Makefile</span></strong><span class="koboSpan" id="kobo.628.1"> thanks to the directive including </span><span class="No-Break"><span class="koboSpan" id="kobo.629.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.630.1">
include Makefile.param.prod</span></pre>
<p><span class="koboSpan" id="kobo.631.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.632.1">rsync</span></strong><span class="koboSpan" id="kobo.633.1"> command uses a list </span><span class="No-Break"><span class="koboSpan" id="kobo.634.1">of options:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.635.1">-r</span></strong><span class="koboSpan" id="kobo.636.1"> : Recursive </span><span class="No-Break"><span class="koboSpan" id="kobo.637.1">into directories.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.638.1">-l</span></strong><span class="koboSpan" id="kobo.639.1">: Copies symlinks </span><span class="No-Break"><span class="koboSpan" id="kobo.640.1">as symlinks.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.641.1">-c</span></strong><span class="koboSpan" id="kobo.642.1">: Copies only the changed files. </span><span class="koboSpan" id="kobo.642.2">The changes are detected with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.643.1">-c</span></strong><span class="koboSpan" id="kobo.644.1"> option by comparing the checksum of the source and the </span><span class="No-Break"><span class="koboSpan" id="kobo.645.1">target file.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.646.1">-g</span></strong><span class="koboSpan" id="kobo.647.1">: Preserves the group</span><a id="_idIndexMarker419"/><span class="koboSpan" id="kobo.648.1"> during the</span><a id="_idIndexMarker420"/> <span class="No-Break"><span class="koboSpan" id="kobo.649.1">copy (owner).</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">-o</span></strong><span class="koboSpan" id="kobo.651.1">: Preserves the user during the </span><span class="No-Break"><span class="koboSpan" id="kobo.652.1">copy (owner).</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.653.1">-v</span></strong><span class="koboSpan" id="kobo.654.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.655.1">Verbose output.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.656.1">-z</span></strong><span class="koboSpan" id="kobo.657.1">: Compresses files during </span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">network transfer.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.659.1">-i</span></strong><span class="koboSpan" id="kobo.660.1">: Displays </span><span class="No-Break"><span class="koboSpan" id="kobo.661.1">a summary.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.662.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.663.1">--exclude-from 'exclude-list.txt'</span></strong><span class="koboSpan" id="kobo.664.1"> option excludes from the copy all the files listed in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.665.1">exclude-list.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.666.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.667.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.668.1">exclude</span></strong><span class="koboSpan" id="kobo.669.1"> file contains </span><span class="No-Break"><span class="koboSpan" id="kobo.670.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.671.1">
.git
.sass-cache/
Makefile*
exclude-list.txt
nohup.out
composer.phar
node_modules
.env*
.idea
.editorconfig
.babelrc
.gitattributes
logs
*.log
npm-debug.log*
node_modules
storage/framework/cache/*
storage/framework/sessions/*
storage/framework/views/*
storage/logs/*
storage/app/*
storage/testing/*
exports/*
app/config/prod/*
app/config/stage/*
resources/assets
public/files
public/chunks
public/storage
bootstrap/cache/config.php
.phpunit.result.cache</span></pre>
<p><span class="koboSpan" id="kobo.672.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.673.1">exclude-list.txt</span></strong><span class="koboSpan" id="kobo.674.1"> file lists</span><a id="_idIndexMarker421"/><span class="koboSpan" id="kobo.675.1"> all the files</span><a id="_idIndexMarker422"/><span class="koboSpan" id="kobo.676.1"> and directories that are not useful in the production environment. </span><span class="koboSpan" id="kobo.676.2">Typically, the excluded files/directories are package directories, storage directories, cache files, and </span><span class="No-Break"><span class="koboSpan" id="kobo.677.1">so on.</span></span></p>
<p><span class="koboSpan" id="kobo.678.1">Feel free to add the files in your application that you want to exclude and don’t want to add to the </span><span class="No-Break"><span class="koboSpan" id="kobo.679.1">production environment.</span></span></p>
<p><span class="koboSpan" id="kobo.680.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.681.1">copyenvprod</span></strong><span class="koboSpan" id="kobo.682.1"> step will copy the local </span><strong class="source-inline"><span class="koboSpan" id="kobo.683.1">.env.prod</span></strong><span class="koboSpan" id="kobo.684.1"> (where you can store your specific configuration for production) to the </span><span class="No-Break"><span class="koboSpan" id="kobo.685.1">remote </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.686.1">.env</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.687.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.688.1">
scp .env.prod ${SSH_ALIAS}:${WEB_DIR}/.env</span></pre>
<p><span class="koboSpan" id="kobo.689.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.690.1">scp</span></strong><span class="koboSpan" id="kobo.691.1"> command allows you to copy files via </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">SSH protocol.</span></span></p>
<p><span class="koboSpan" id="kobo.693.1">Remember to include the </span><strong class="source-inline"><span class="koboSpan" id="kobo.694.1">.env.prod</span></strong><span class="koboSpan" id="kobo.695.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.696.1">.gitignore</span></strong><span class="koboSpan" id="kobo.697.1"> file (to exclude it from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.698.1">git</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.699.1"> commit).</span></span></p>
<p><span class="koboSpan" id="kobo.700.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.701.1">migrate</span></strong><span class="koboSpan" id="kobo.702.1"> step executes the migrations on the remote server (thanks to the </span><span class="No-Break"><span class="koboSpan" id="kobo.703.1">SSH command):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.704.1">
ssh ${SSH_ALIAS} "cd ${WEB_DIR}; php artisan migrate --env=prod"</span></pre>
<p><span class="koboSpan" id="kobo.705.1">Then, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.706.1">optimize</span></strong><span class="koboSpan" id="kobo.707.1"> step is executed. </span><span class="koboSpan" id="kobo.707.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.708.1">optimize</span></strong><span class="koboSpan" id="kobo.709.1"> step will launch the caching Laravel command for routing, views, and configuration on the </span><span class="No-Break"><span class="koboSpan" id="kobo.710.1">target machine:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.711.1">
ssh ${SSH_ALIAS} "cd ${WEB_DIR}; php artisan config:cache; php artisan route:cache; php artisan view:cache"</span></pre>
<p><span class="koboSpan" id="kobo.712.1">Then, if you remember, every time you change the files in the production environment, you should restart the workers to apply the changes to the up-and-running Laravel Octane application, so the </span><strong class="source-inline"><span class="koboSpan" id="kobo.713.1">restartworkers</span></strong><span class="koboSpan" id="kobo.714.1"> step </span><span class="No-Break"><span class="koboSpan" id="kobo.715.1">will launch:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.716.1">
ssh ${SSH_ALIAS} "cd ${WEB_DIR}; php artisan octane:reload"</span></pre>
<p><span class="koboSpan" id="kobo.717.1">Executing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.718.1">Makefile</span></strong><span class="koboSpan" id="kobo.719.1"> from the local development environment is not suggested. </span><span class="koboSpan" id="kobo.719.2">Typically, you can launch the </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">Makefile</span></strong><span class="koboSpan" id="kobo.721.1"> from the CI/CD pipeline. </span><span class="koboSpan" id="kobo.721.2">We execute the </span><strong class="source-inline"><span class="koboSpan" id="kobo.722.1">Makefile</span></strong><span class="koboSpan" id="kobo.723.1"> from a dedicated environment (CI/CD) for separation of concerns; the local environment is for development, the CI/CD environment is for building and executing code quality tools programmatically, and the production environment is for delivering assets and </span><span class="No-Break"><span class="koboSpan" id="kobo.724.1">the application.</span></span></p>
<p><span class="koboSpan" id="kobo.725.1">Anyway, if you are not using a CI/CD pipeline and you are launching the </span><strong class="source-inline"><span class="koboSpan" id="kobo.726.1">Makefile</span></strong><span class="koboSpan" id="kobo.727.1"> from the local copy of the sources, you must restore the dev package (for production, deploy the </span><strong class="source-inline"><span class="koboSpan" id="kobo.728.1">composerinstallnodev</span></strong><span class="koboSpan" id="kobo.729.1"> step, which will only install production packages). </span><span class="koboSpan" id="kobo.729.2">For restoring the dev packages, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.730.1">installdevdeps</span></strong><span class="koboSpan" id="kobo.731.1"> step exists, and it will execute a standard </span><strong class="source-inline"><span class="koboSpan" id="kobo.732.1">composer install</span></strong><span class="koboSpan" id="kobo.733.1"> command and then clear </span><span class="No-Break"><span class="koboSpan" id="kobo.734.1">the config:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.735.1">
composer install
php artisan config:clear</span></pre>
<p><span class="koboSpan" id="kobo.736.1">As you can see, the configuration of </span><strong class="source-inline"><span class="koboSpan" id="kobo.737.1">Makefile</span></strong><span class="koboSpan" id="kobo.738.1"> is straightforward. </span><span class="koboSpan" id="kobo.738.2">Because </span><strong class="source-inline"><span class="koboSpan" id="kobo.739.1">Makefile</span></strong><span class="koboSpan" id="kobo.740.1"> has strict rules about the indentation (the indentation is used to understand where a step starts and where it ends), the only recommendation is that the line indentation is done via the tab character. </span><span class="koboSpan" id="kobo.740.2">Once </span><strong class="source-inline"><span class="koboSpan" id="kobo.741.1">Makefile</span></strong><span class="koboSpan" id="kobo.742.1"> is ready, you can </span><span class="No-Break"><span class="koboSpan" id="kobo.743.1">execute it.</span></span></p>
<p><span class="koboSpan" id="kobo.744.1">To run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.745.1">Makefile</span></strong><span class="koboSpan" id="kobo.746.1"> named </span><strong class="source-inline"><span class="koboSpan" id="kobo.747.1">Makefile.deploy</span></strong><span class="koboSpan" id="kobo.748.1">, you can run </span><span class="No-Break"><span class="koboSpan" id="kobo.749.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.750.1">
make -f Makefile.deploy deploy</span></pre>
<p><span class="koboSpan" id="kobo.751.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.752.1">make</span></strong><span class="koboSpan" id="kobo.753.1"> command accepts the name of the step to be executed as input. </span><span class="koboSpan" id="kobo.753.2">Optionally, you can also specify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.754.1">Makefile</span></strong><span class="koboSpan" id="kobo.755.1"> to be parsed via the </span><strong class="source-inline"><span class="koboSpan" id="kobo.756.1">-</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.757.1">f</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.758.1"> parameter.</span></span></p>
<p><span class="koboSpan" id="kobo.759.1">With the </span><strong class="source-inline"><span class="koboSpan" id="kobo.760.1">make deploy</span></strong><span class="koboSpan" id="kobo.761.1"> command, the application</span><a id="_idIndexMarker423"/><span class="koboSpan" id="kobo.762.1"> is fully deployed</span><a id="_idIndexMarker424"/><span class="koboSpan" id="kobo.763.1"> on the server. </span><span class="koboSpan" id="kobo.763.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.764.1">Makefile</span></strong><span class="koboSpan" id="kobo.765.1"> also includes some commands for the fine-tuning of the environment, such as fixing permissions of some directories, clearing the cache, and </span><span class="No-Break"><span class="koboSpan" id="kobo.766.1">so on.</span></span></p>
<h1 id="_idParaDest-128"><a id="_idTextAnchor135"/><span class="koboSpan" id="kobo.767.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.768.1">With this book, we explored some ways to create a reliable and fast Laravel application. </span><span class="koboSpan" id="kobo.768.2">We used features provided by Laravel Octane with the integration with Swoole </span><span class="No-Break"><span class="koboSpan" id="kobo.769.1">and RoadRunner.</span></span></p>
<p><span class="koboSpan" id="kobo.770.1">We involved some special features of Swoole, especially for caching, concurrent task execution, and scheduled </span><span class="No-Break"><span class="koboSpan" id="kobo.771.1">task execution.</span></span></p>
<p><span class="koboSpan" id="kobo.772.1">We explored some practical examples, and we approached the design of the application differently, delegating tasks to the external executor (via </span><span class="No-Break"><span class="koboSpan" id="kobo.773.1">the queue).</span></span></p>
<p><span class="koboSpan" id="kobo.774.1">We progressively improved the performance of the application by applying </span><span class="No-Break"><span class="koboSpan" id="kobo.775.1">multiple techniques.</span></span></p>
<p><span class="koboSpan" id="kobo.776.1">In this chapter, we explained the architecture, the configuration of the tools used in production (nginx), and the implementation of the scripts to deploy a Laravel Octane application into a </span><span class="No-Break"><span class="koboSpan" id="kobo.777.1">production environment.</span></span></p>
<p><span class="koboSpan" id="kobo.778.1">Hope you enjoyed reading </span><span class="No-Break"><span class="koboSpan" id="kobo.779.1">this book.</span></span></p>
</div>
<div>
<div class="Content" id="_idContainer066">
</div>
</div>
</body></html>